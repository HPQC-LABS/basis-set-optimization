created virtual environment CPython3.10.2.final.0-64 in 4552ms
  creator CPython3Posix(dest=/localscratch/nike.35632771.0/ENV, clear=True, no_vcs_ignore=False, global=False)
  seeder FromAppData(download=False, pip=bundle, setuptools=bundle, wheel=bundle, via=copy, app_data_dir=/home/nike/.local/share/virtualenv)
    added seed packages: pip==22.3.1, setuptools==67.3.3, wheel==0.38.4+computecanada
  activators BashActivator,CShellActivator,FishActivator,NushellActivator,PowerShellActivator,PythonActivator
Looking in links: /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx512, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic
Requirement already satisfied: pip in /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages (22.3.1)
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pip-23.0+computecanada-py3-none-any.whl
Installing collected packages: pip
  Attempting uninstall: pip
    Found existing installation: pip 22.3.1
    Uninstalling pip-22.3.1:
      Successfully uninstalled pip-22.3.1
Successfully installed pip-23.0+computecanada
Looking in links: /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx512, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic
Processing /home/nike/pyscf_ad/dist/pyscf-2.1.1+ad-cp310-cp310-linux_x86_64.whl
Processing /home/nike/properties_ad/dist/pyscf_properties-0.1.0+ad-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/absl_py-1.4.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/contourpy-1.0.7+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/cycler-0.11.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/fonttools-4.39.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/h5py-3.8.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/jax-0.4.2+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/jaxlib-0.4.2+cuda11.cudnn82.computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/jaxopt-0.6+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/kiwisolver-1.4.4+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/matplotlib-3.7.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/numpy-1.24.2+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/opt_einsum-3.3.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/packaging-23.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/Pillow-9.4.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pyparsing-3.0.9+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pyscfad-0.1.2+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/python_dateutil-2.8.2+computecanada-py2.py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/scipy-1.10.1+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/six-1.16.0+computecanada-py2.py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/typing_extensions-4.5.0+computecanada-py3-none-any.whl
Installing collected packages: typing_extensions, six, pyparsing, Pillow, packaging, numpy, kiwisolver, fonttools, cycler, absl_py, scipy, python-dateutil, opt-einsum, h5py, contourpy, pyscf, matplotlib, jaxlib, pyscf-properties, jax, jaxopt, pyscfad
Successfully installed Pillow-9.4.0+computecanada absl_py-1.4.0+computecanada contourpy-1.0.7+computecanada cycler-0.11.0+computecanada fonttools-4.39.0+computecanada h5py-3.8.0+computecanada jax-0.4.2+computecanada jaxlib-0.4.2+cuda11.cudnn82.computecanada jaxopt-0.6+computecanada kiwisolver-1.4.4+computecanada matplotlib-3.7.0+computecanada numpy-1.24.2+computecanada opt-einsum-3.3.0+computecanada packaging-23.0+computecanada pyparsing-3.0.9+computecanada pyscf-2.1.1+ad pyscf-properties-0.1.0+ad pyscfad-0.1.2+computecanada python-dateutil-2.8.2+computecanada scipy-1.10.1+computecanada six-1.16.0+computecanada typing_extensions-4.5.0+computecanada
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:33:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814262        1
[INPUT] 0    0    [1    /1   ]  0.396629852181       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210215        1
[INPUT] 0    0    [1    /1   ]  36754.7203149        1
[INPUT] 0    0    [1    /1   ]  7303.49268418        1
[INPUT] 0    0    [1    /1   ]  18375.8107889        1
[INPUT] 0    0    [1    /1   ]  1449.77759225        1
[INPUT] 0    0    [1    /1   ]  373.960610012        1
[INPUT] 0    0    [1    /1   ]  113.326661489        1
[INPUT] 0    0    [1    /1   ]  37.7646602819        1
[INPUT] 0    0    [1    /1   ]  8.0899613623         1
[INPUT] 0    0    [1    /1   ]  3.20486789277        1
[INPUT] 1    0    [1    /1   ]  8.6038733922         1
[INPUT] 1    0    [1    /1   ]  0.493005278333       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426189773, 1.0]], [0, [0.3966298521809672, 1.0]], [0, [1176168.1426189772, 1.0]], [0, [588084.0699931053, 1.0]], [0, [294042.03113500844, 1.0]], [0, [147020.99216003876, 1.0]], [0, [73510.4210214793, 1.0]], [0, [36754.72031488961, 1.0]], [0, [7303.492684179647, 1.0]], [0, [18375.810788940234, 1.0]], [0, [1449.7775922494905, 1.0]], [0, [373.9606100121569, 1.0]], [0, [113.32666148932557, 1.0]], [0, [37.764660281877305, 1.0]], [0, [8.089961362299052, 1.0]], [0, [3.2048678927685397, 1.0]], [1, [8.603873392201061, 1.0]], [1, [0.4930052783328494, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.8142619]
bas 1, expnt(s) = [0.39662985]
bas 2, expnt(s) = [1176168.14261898]
bas 3, expnt(s) = [588084.06999311]
bas 4, expnt(s) = [294042.03113501]
bas 5, expnt(s) = [147020.99216004]
bas 6, expnt(s) = [73510.42102148]
bas 7, expnt(s) = [36754.72031489]
bas 8, expnt(s) = [7303.49268418]
bas 9, expnt(s) = [18375.81078894]
bas 10, expnt(s) = [1449.77759225]
bas 11, expnt(s) = [373.96061001]
bas 12, expnt(s) = [113.32666149]
bas 13, expnt(s) = [37.76466028]
bas 14, expnt(s) = [8.08996136]
bas 15, expnt(s) = [3.20486789]
bas 16, expnt(s) = [8.60387339]
bas 17, expnt(s) = [0.49300528]
CPU time:         1.44
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96629852e-01 1.26271132e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349268e+03 1.99601120e+03 1.83758108e+04 3.98749276e+03
 1.44977759e+03 5.93596131e+02 3.73960610e+02 2.14849535e+02
 1.13326661e+02 8.77534290e+01 3.77646603e+01 3.84883427e+01
 8.08996136e+00 1.21192253e+01 3.20486789e+00 6.05163357e+00
 8.60387339e+00 4.29884619e+01 4.93005278e-01 1.20517150e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32509985029529
cond(S) = 907706.1170365013
E1 = -689.3980740992758  E_coul = 184.91166494962619
init E= -504.48640914965
    CPU time for initialize scf      4.36 sec, wall time      0.63 sec
  HOMO = -0.674713597297563  LUMO = 9.18412126997809
  mo_energy =
[-1.21707201e+02 -1.33875090e+01 -7.62807564e+00 -7.62807564e+00
 -7.62807564e+00 -1.64018635e+00 -6.74713597e-01 -6.74713597e-01
 -6.74713597e-01  9.18412127e+00  1.08652085e+02  6.03214050e+02
  2.74291145e+03  1.22222185e+04  4.08438384e+04  1.04887545e+05
  2.30071027e+05  4.55885992e+05  8.44838269e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.0698206187553  E_coul = 199.1311908301205
cycle= 1 E= -507.938629788635  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.33 sec, wall time      0.34 sec
diis-norm(errvec)=0.60218
diis-c [-0.36262072  1.        ]
  HOMO = -0.233123723563657  LUMO = 10.093288977159
  mo_energy =
[-1.20256497e+02 -1.23512943e+01 -6.64603928e+00 -6.64603928e+00
 -6.64603928e+00 -1.16150339e+00 -2.33123724e-01 -2.33123724e-01
 -2.33123724e-01  1.00932890e+01  1.10001217e+02  6.04650621e+02
  2.74428265e+03  1.22234783e+04  4.08450309e+04  1.04888701e+05
  2.30072159e+05  4.55887106e+05  8.44839370e+05  1.52801664e+06
  2.85028404e+06  5.80817133e+06]
E1 = -706.7157610983746  E_coul = 198.77074207128373
cycle= 2 E= -507.945019027091  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.11 sec, wall time      0.12 sec
diis-norm(errvec)=0.0152553
diis-c [-2.24123516e-04  4.84821884e-03  9.95151781e-01]
  HOMO = -0.237583660360074  LUMO = 10.0823663510768
  mo_energy =
[-1.20314314e+02 -1.23736968e+01 -6.67391263e+00 -6.67391263e+00
 -6.67391263e+00 -1.16377031e+00 -2.37583660e-01 -2.37583660e-01
 -2.37583660e-01  1.00823664e+01  1.09957738e+02  6.04589499e+02
  2.74420869e+03  1.22233961e+04  4.08449457e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839282e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.7010960987324  E_coul = 198.75606498283162
cycle= 3 E= -507.945031115901  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.000739863
diis-c [-1.26601196e-08  3.76684999e-05 -5.00629990e-02  1.05002533e+00]
  HOMO = -0.237810237667505  LUMO = 10.0818236774294
  mo_energy =
[-1.20316914e+02 -1.23748073e+01 -6.67527022e+00 -6.67527022e+00
 -6.67527022e+00 -1.16388086e+00 -2.37810238e-01 -2.37810238e-01
 -2.37810238e-01  1.00818237e+01  1.09955714e+02  6.04586825e+02
  2.74420563e+03  1.22233928e+04  4.08449424e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7003586668533  E_coul = 198.75532752074298
cycle= 4 E= -507.94503114611  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46534e-06
diis-c [-4.71989541e-12 -1.76501892e-06  2.30370943e-03 -4.57786805e-02
  1.04347674e+00]
  HOMO = -0.237810989824342  LUMO = 10.0818229126857
  mo_energy =
[-1.20316912e+02 -1.23748097e+01 -6.67527181e+00 -6.67527181e+00
 -6.67527181e+00 -1.16388129e+00 -2.37810990e-01 -2.37810990e-01
 -2.37810990e-01  1.00818229e+01  1.09955715e+02  6.04586828e+02
  2.74420564e+03  1.22233929e+04  4.08449424e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7003575529488  E_coul = 198.75532640683738
cycle= 5 E= -507.945031146111  delta_E= -1.14e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7003575529488  E_coul = 198.75532640683738
  HOMO = -0.237811023880611  LUMO = 10.0818228429813
  mo_energy =
[-1.20316912e+02 -1.23748099e+01 -6.67527198e+00 -6.67527198e+00
 -6.67527198e+00 -1.16388131e+00 -2.37811024e-01 -2.37811024e-01
 -2.37811024e-01  1.00818228e+01  1.09955715e+02  6.04586827e+02
  2.74420564e+03  1.22233929e+04  4.08449424e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7003574596661  E_coul = 198.7553263135547
Extra cycle  E= -507.945031146111  delta_E= 5.68e-14  |g|= 7.4e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      4.85 sec, wall time      1.14 sec
exp = [1.17616814e+05 3.96629852e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349268e+03 1.83758108e+04 1.44977759e+03 3.73960610e+02
 1.13326661e+02 3.77646603e+01 8.08996136e+00 3.20486789e+00
 8.60387339e+00 4.93005278e-01]
E = -507.9450311461114
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:33:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814262        1
[INPUT] 0    0    [1    /1   ]  0.396629852181       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210215        1
[INPUT] 0    0    [1    /1   ]  36754.7203149        1
[INPUT] 0    0    [1    /1   ]  7303.49268418        1
[INPUT] 0    0    [1    /1   ]  18375.8107889        1
[INPUT] 0    0    [1    /1   ]  1449.77759225        1
[INPUT] 0    0    [1    /1   ]  373.960610012        1
[INPUT] 0    0    [1    /1   ]  113.326661489        1
[INPUT] 0    0    [1    /1   ]  37.7646602819        1
[INPUT] 0    0    [1    /1   ]  8.0899613623         1
[INPUT] 0    0    [1    /1   ]  3.20486789277        1
[INPUT] 1    0    [1    /1   ]  8.6038733922         1
[INPUT] 1    0    [1    /1   ]  0.493005278333       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426189773, 1.0]], [0, [0.3966298521809672, 1.0]], [0, [1176168.1426189772, 1.0]], [0, [588084.0699931053, 1.0]], [0, [294042.03113500844, 1.0]], [0, [147020.99216003876, 1.0]], [0, [73510.4210214793, 1.0]], [0, [36754.72031488961, 1.0]], [0, [7303.492684179647, 1.0]], [0, [18375.810788940234, 1.0]], [0, [1449.7775922494905, 1.0]], [0, [373.9606100121569, 1.0]], [0, [113.32666148932557, 1.0]], [0, [37.764660281877305, 1.0]], [0, [8.089961362299052, 1.0]], [0, [3.2048678927685397, 1.0]], [1, [8.603873392201061, 1.0]], [1, [0.4930052783328494, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.8142619]
bas 1, expnt(s) = [0.39662985]
bas 2, expnt(s) = [1176168.14261898]
bas 3, expnt(s) = [588084.06999311]
bas 4, expnt(s) = [294042.03113501]
bas 5, expnt(s) = [147020.99216004]
bas 6, expnt(s) = [73510.42102148]
bas 7, expnt(s) = [36754.72031489]
bas 8, expnt(s) = [7303.49268418]
bas 9, expnt(s) = [18375.81078894]
bas 10, expnt(s) = [1449.77759225]
bas 11, expnt(s) = [373.96061001]
bas 12, expnt(s) = [113.32666149]
bas 13, expnt(s) = [37.76466028]
bas 14, expnt(s) = [8.08996136]
bas 15, expnt(s) = [3.20486789]
bas 16, expnt(s) = [8.60387339]
bas 17, expnt(s) = [0.49300528]
CPU time:         6.74
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96629852e-01 1.26271132e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349268e+03 1.99601120e+03 1.83758108e+04 3.98749276e+03
 1.44977759e+03 5.93596131e+02 3.73960610e+02 2.14849535e+02
 1.13326661e+02 8.77534290e+01 3.77646603e+01 3.84883427e+01
 8.08996136e+00 1.21192253e+01 3.20486789e+00 6.05163357e+00
 8.60387339e+00 4.29884619e+01 4.93005278e-01 1.20517150e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32509985029529
cond(S) = 907706.1170365013
E1 = -689.3980740992758  E_coul = 184.91166494962619
init E= -504.48640914965
    CPU time for initialize scf      4.62 sec, wall time      0.34 sec
  HOMO = -0.674713597297563  LUMO = 9.18412126997809
  mo_energy =
[-1.21707201e+02 -1.33875090e+01 -7.62807564e+00 -7.62807564e+00
 -7.62807564e+00 -1.64018635e+00 -6.74713597e-01 -6.74713597e-01
 -6.74713597e-01  9.18412127e+00  1.08652085e+02  6.03214050e+02
  2.74291145e+03  1.22222185e+04  4.08438384e+04  1.04887545e+05
  2.30071027e+05  4.55885992e+05  8.44838269e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.0698206187553  E_coul = 199.1311908301205
cycle= 1 E= -507.938629788635  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
diis-norm(errvec)=0.60218
diis-c [-0.36262072  1.        ]
  HOMO = -0.233123723563657  LUMO = 10.093288977159
  mo_energy =
[-1.20256497e+02 -1.23512943e+01 -6.64603928e+00 -6.64603928e+00
 -6.64603928e+00 -1.16150339e+00 -2.33123724e-01 -2.33123724e-01
 -2.33123724e-01  1.00932890e+01  1.10001217e+02  6.04650621e+02
  2.74428265e+03  1.22234783e+04  4.08450309e+04  1.04888701e+05
  2.30072159e+05  4.55887106e+05  8.44839370e+05  1.52801664e+06
  2.85028404e+06  5.80817133e+06]
E1 = -706.7157610983746  E_coul = 198.77074207128373
cycle= 2 E= -507.945019027091  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152553
diis-c [-2.24123516e-04  4.84821884e-03  9.95151781e-01]
  HOMO = -0.237583660360074  LUMO = 10.0823663510768
  mo_energy =
[-1.20314314e+02 -1.23736968e+01 -6.67391263e+00 -6.67391263e+00
 -6.67391263e+00 -1.16377031e+00 -2.37583660e-01 -2.37583660e-01
 -2.37583660e-01  1.00823664e+01  1.09957738e+02  6.04589499e+02
  2.74420869e+03  1.22233961e+04  4.08449457e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839282e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.7010960987324  E_coul = 198.75606498283162
cycle= 3 E= -507.945031115901  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739863
diis-c [-1.26601196e-08  3.76684999e-05 -5.00629990e-02  1.05002533e+00]
  HOMO = -0.237810237667505  LUMO = 10.0818236774294
  mo_energy =
[-1.20316914e+02 -1.23748073e+01 -6.67527022e+00 -6.67527022e+00
 -6.67527022e+00 -1.16388086e+00 -2.37810238e-01 -2.37810238e-01
 -2.37810238e-01  1.00818237e+01  1.09955714e+02  6.04586825e+02
  2.74420563e+03  1.22233928e+04  4.08449424e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7003586668533  E_coul = 198.75532752074298
cycle= 4 E= -507.94503114611  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46534e-06
diis-c [-4.71989541e-12 -1.76501892e-06  2.30370943e-03 -4.57786805e-02
  1.04347674e+00]
  HOMO = -0.237810989824342  LUMO = 10.0818229126857
  mo_energy =
[-1.20316912e+02 -1.23748097e+01 -6.67527181e+00 -6.67527181e+00
 -6.67527181e+00 -1.16388129e+00 -2.37810990e-01 -2.37810990e-01
 -2.37810990e-01  1.00818229e+01  1.09955715e+02  6.04586828e+02
  2.74420564e+03  1.22233929e+04  4.08449424e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7003575529488  E_coul = 198.75532640683738
cycle= 5 E= -507.945031146111  delta_E= -1.14e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7003575529488  E_coul = 198.75532640683738
  HOMO = -0.237811023880611  LUMO = 10.0818228429813
  mo_energy =
[-1.20316912e+02 -1.23748099e+01 -6.67527198e+00 -6.67527198e+00
 -6.67527198e+00 -1.16388131e+00 -2.37811024e-01 -2.37811024e-01
 -2.37811024e-01  1.00818228e+01  1.09955715e+02  6.04586827e+02
  2.74420564e+03  1.22233929e+04  4.08449424e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7003574596661  E_coul = 198.7553263135547
Extra cycle  E= -507.945031146111  delta_E= 5.68e-14  |g|= 7.4e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      4.82 sec, wall time      0.42 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907706.1170365013
E1 = -706.7003574596661  E_coul = 198.7553263135547
init E= -507.945031146111
    CPU time for initialize scf      5.23 sec, wall time      0.48 sec
  HOMO = -0.237811025488005  LUMO = 10.0818228398875
  mo_energy =
[-1.20316912e+02 -1.23748099e+01 -6.67527199e+00 -6.67527199e+00
 -6.67527199e+00 -1.16388131e+00 -2.37811025e-01 -2.37811025e-01
 -2.37811025e-01  1.00818228e+01  1.09955715e+02  6.04586827e+02
  2.74420564e+03  1.22233929e+04  4.08449424e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.700357455459  E_coul = 198.75532630934762
cycle= 1 E= -507.945031146111  delta_E= 5.68e-14  |g|= 1.42e-09  |ddm|= 3.58e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.700357455459  E_coul = 198.75532630934762
  HOMO = -0.237811025566356  LUMO = 10.0818228397453
  mo_energy =
[-1.20316912e+02 -1.23748099e+01 -6.67527199e+00 -6.67527199e+00
 -6.67527199e+00 -1.16388131e+00 -2.37811026e-01 -2.37811026e-01
 -2.37811026e-01  1.00818228e+01  1.09955715e+02  6.04586827e+02
  2.74420564e+03  1.22233929e+04  4.08449424e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7003574552681  E_coul = 198.75532630915615
Extra cycle  E= -507.945031146112  delta_E= -6.25e-13  |g|= 1.01e-09  |ddm|= 1.77e-10
    CPU time for scf_cycle      6.45 sec, wall time      1.59 sec
exp = [1.17616814e+05 3.96629852e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349268e+03 1.83758108e+04 1.44977759e+03 3.73960610e+02
 1.13326661e+02 3.77646603e+01 8.08996136e+00 3.20486789e+00
 8.60387339e+00 4.93005278e-01]
grad_E = [ 4.15754412e-09  1.46178168e-06  1.84640560e-11  1.11968022e-10
  6.46866993e-10  2.53653702e-09  1.05370885e-08  5.67134757e-08
  3.56523945e-06  1.21665194e-07  6.27020656e-06 -1.71224661e-05
  3.46000190e-05 -4.08341175e-05 -6.13900288e-07  1.84832672e-05
 -7.33492634e-07  4.67746287e-06]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:33:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814262        1
[INPUT] 0    0    [1    /1   ]  0.396628390399       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210215        1
[INPUT] 0    0    [1    /1   ]  36754.7203148        1
[INPUT] 0    0    [1    /1   ]  7303.49268061        1
[INPUT] 0    0    [1    /1   ]  18375.8107888        1
[INPUT] 0    0    [1    /1   ]  1449.77758598        1
[INPUT] 0    0    [1    /1   ]  373.960627135        1
[INPUT] 0    0    [1    /1   ]  113.326626889        1
[INPUT] 0    0    [1    /1   ]  37.764701116         1
[INPUT] 0    0    [1    /1   ]  8.0899619762         1
[INPUT] 0    0    [1    /1   ]  3.2048494095         1
[INPUT] 1    0    [1    /1   ]  8.60387412569        1
[INPUT] 1    0    [1    /1   ]  0.49300060087        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426189357, 1.0]], [0, [0.3966283903992884, 1.0]], [0, [1176168.1426189772, 1.0]], [0, [588084.0699931051, 1.0]], [0, [294042.0311350078, 1.0]], [0, [147020.99216003623, 1.0]], [0, [73510.42102146876, 1.0]], [0, [36754.72031483289, 1.0]], [0, [7303.492680614408, 1.0]], [0, [18375.81078881857, 1.0]], [0, [1449.777585979284, 1.0]], [0, [373.960627134623, 1.0]], [0, [113.3266268893066, 1.0]], [0, [37.76470111599485, 1.0]], [0, [8.08996197619934, 1.0]], [0, [3.2048494095013473, 1.0]], [1, [8.603874125693695, 1.0]], [1, [0.4930006008699808, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426189]
bas 1, expnt(s) = [0.39662839]
bas 2, expnt(s) = [1176168.14261898]
bas 3, expnt(s) = [588084.06999311]
bas 4, expnt(s) = [294042.03113501]
bas 5, expnt(s) = [147020.99216004]
bas 6, expnt(s) = [73510.42102147]
bas 7, expnt(s) = [36754.72031483]
bas 8, expnt(s) = [7303.49268061]
bas 9, expnt(s) = [18375.81078882]
bas 10, expnt(s) = [1449.77758598]
bas 11, expnt(s) = [373.96062713]
bas 12, expnt(s) = [113.32662689]
bas 13, expnt(s) = [37.76470112]
bas 14, expnt(s) = [8.08996198]
bas 15, expnt(s) = [3.20484941]
bas 16, expnt(s) = [8.60387413]
bas 17, expnt(s) = [0.4930006]
CPU time:        23.59
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96628390e-01 1.26270783e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349268e+03 1.99601120e+03 1.83758108e+04 3.98749276e+03
 1.44977759e+03 5.93596129e+02 3.73960627e+02 2.14849543e+02
 1.13326627e+02 8.77534089e+01 3.77647011e+01 3.84883739e+01
 8.08996198e+00 1.21192260e+01 3.20484941e+00 6.05160740e+00
 8.60387413e+00 4.29884665e+01 4.93000601e-01 1.20515721e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32510619908906
cond(S) = 907706.116771689
E1 = -689.3978930204686  E_coul = 184.9115049351732
init E= -504.486388085295
    CPU time for initialize scf      0.19 sec, wall time      0.03 sec
  HOMO = -0.674719764868317  LUMO = 9.18405475517667
  mo_energy =
[-1.21707214e+02 -1.33875226e+01 -7.62808536e+00 -7.62808536e+00
 -7.62808536e+00 -1.64019009e+00 -6.74719765e-01 -6.74719765e-01
 -6.74719765e-01  9.18405476e+00  1.08652051e+02  6.03214040e+02
  2.74291144e+03  1.22222185e+04  4.08438384e+04  1.04887545e+05
  2.30071027e+05  4.55885992e+05  8.44838269e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.0695500075101  E_coul = 199.13092025223952
cycle= 1 E= -507.938629755271  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.60218
diis-c [-0.36262078  1.        ]
  HOMO = -0.233135314840003  LUMO = 10.0932153582692
  mo_energy =
[-1.20256518e+02 -1.23513151e+01 -6.64605599e+00 -6.64605599e+00
 -6.64605599e+00 -1.16151159e+00 -2.33135315e-01 -2.33135315e-01
 -2.33135315e-01  1.00932154e+01  1.10001175e+02  6.04650603e+02
  2.74428264e+03  1.22234783e+04  4.08450309e+04  1.04888700e+05
  2.30072159e+05  4.55887106e+05  8.44839370e+05  1.52801664e+06
  2.85028404e+06  5.80817133e+06]
E1 = -706.7154885639869  E_coul = 198.77046953393355
cycle= 2 E= -507.945019030053  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152553
diis-c [-2.24123967e-04  4.84824282e-03  9.95151757e-01]
  HOMO = -0.237595238910691  LUMO = 10.082292680673
  mo_energy =
[-1.20314335e+02 -1.23737178e+01 -6.67392954e+00 -6.67392954e+00
 -6.67392954e+00 -1.16377853e+00 -2.37595239e-01 -2.37595239e-01
 -2.37595239e-01  1.00822927e+01  1.09957696e+02  6.04589481e+02
  2.74420867e+03  1.22233961e+04  4.08449457e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839282e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.7008234666697  E_coul = 198.75579234769833
cycle= 3 E= -507.945031118971  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739864
diis-c [-1.26605229e-08  3.76670770e-05 -5.00630270e-02  1.05002536e+00]
  HOMO = -0.237821816149282  LUMO = 10.0817500035006
  mo_energy =
[-1.20316936e+02 -1.23748282e+01 -6.67528714e+00 -6.67528714e+00
 -6.67528714e+00 -1.16388908e+00 -2.37821816e-01 -2.37821816e-01
 -2.37821816e-01  1.00817500e+01  1.09955673e+02  6.04586807e+02
  2.74420562e+03  1.22233928e+04  4.08449423e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.700086028424  E_coul = 198.75505487924303
cycle= 4 E= -507.945031149181  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46521e-06
diis-c [-4.71797080e-12 -1.76585732e-06  2.30366303e-03 -4.57774398e-02
  1.04347554e+00]
  HOMO = -0.237822568326211  LUMO = 10.0817492387278
  mo_energy =
[-1.20316933e+02 -1.23748307e+01 -6.67528873e+00 -6.67528873e+00
 -6.67528873e+00 -1.16388952e+00 -2.37822568e-01 -2.37822568e-01
 -2.37822568e-01  1.00817492e+01  1.09955673e+02  6.04586810e+02
  2.74420562e+03  1.22233928e+04  4.08449423e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7000849144673  E_coul = 198.75505376528534
cycle= 5 E= -507.945031149182  delta_E= -1.02e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7000849144673  E_coul = 198.75505376528534
  HOMO = -0.237822602381757  LUMO = 10.0817491690264
  mo_energy =
[-1.20316934e+02 -1.23748308e+01 -6.67528890e+00 -6.67528890e+00
 -6.67528890e+00 -1.16388953e+00 -2.37822602e-01 -2.37822602e-01
 -2.37822602e-01  1.00817492e+01  1.09955673e+02  6.04586809e+02
  2.74420562e+03  1.22233928e+04  4.08449423e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7000848212177  E_coul = 198.7550536720359
Extra cycle  E= -507.945031149182  delta_E= 1.71e-13  |g|= 7.32e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [1.17616814e+05 3.96628390e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349268e+03 1.83758108e+04 1.44977759e+03 3.73960627e+02
 1.13326627e+02 3.77647011e+01 8.08996198e+00 3.20484941e+00
 8.60387413e+00 4.93000601e-01]
E = -507.94503114918183
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:33:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814262        1
[INPUT] 0    0    [1    /1   ]  0.396628390399       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210215        1
[INPUT] 0    0    [1    /1   ]  36754.7203148        1
[INPUT] 0    0    [1    /1   ]  7303.49268061        1
[INPUT] 0    0    [1    /1   ]  18375.8107888        1
[INPUT] 0    0    [1    /1   ]  1449.77758598        1
[INPUT] 0    0    [1    /1   ]  373.960627135        1
[INPUT] 0    0    [1    /1   ]  113.326626889        1
[INPUT] 0    0    [1    /1   ]  37.764701116         1
[INPUT] 0    0    [1    /1   ]  8.0899619762         1
[INPUT] 0    0    [1    /1   ]  3.2048494095         1
[INPUT] 1    0    [1    /1   ]  8.60387412569        1
[INPUT] 1    0    [1    /1   ]  0.49300060087        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426189357, 1.0]], [0, [0.3966283903992884, 1.0]], [0, [1176168.1426189772, 1.0]], [0, [588084.0699931051, 1.0]], [0, [294042.0311350078, 1.0]], [0, [147020.99216003623, 1.0]], [0, [73510.42102146876, 1.0]], [0, [36754.72031483289, 1.0]], [0, [7303.492680614408, 1.0]], [0, [18375.81078881857, 1.0]], [0, [1449.777585979284, 1.0]], [0, [373.960627134623, 1.0]], [0, [113.3266268893066, 1.0]], [0, [37.76470111599485, 1.0]], [0, [8.08996197619934, 1.0]], [0, [3.2048494095013473, 1.0]], [1, [8.603874125693695, 1.0]], [1, [0.4930006008699808, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426189]
bas 1, expnt(s) = [0.39662839]
bas 2, expnt(s) = [1176168.14261898]
bas 3, expnt(s) = [588084.06999311]
bas 4, expnt(s) = [294042.03113501]
bas 5, expnt(s) = [147020.99216004]
bas 6, expnt(s) = [73510.42102147]
bas 7, expnt(s) = [36754.72031483]
bas 8, expnt(s) = [7303.49268061]
bas 9, expnt(s) = [18375.81078882]
bas 10, expnt(s) = [1449.77758598]
bas 11, expnt(s) = [373.96062713]
bas 12, expnt(s) = [113.32662689]
bas 13, expnt(s) = [37.76470112]
bas 14, expnt(s) = [8.08996198]
bas 15, expnt(s) = [3.20484941]
bas 16, expnt(s) = [8.60387413]
bas 17, expnt(s) = [0.4930006]
CPU time:        24.09
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96628390e-01 1.26270783e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349268e+03 1.99601120e+03 1.83758108e+04 3.98749276e+03
 1.44977759e+03 5.93596129e+02 3.73960627e+02 2.14849543e+02
 1.13326627e+02 8.77534089e+01 3.77647011e+01 3.84883739e+01
 8.08996198e+00 1.21192260e+01 3.20484941e+00 6.05160740e+00
 8.60387413e+00 4.29884665e+01 4.93000601e-01 1.20515721e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32510619908906
cond(S) = 907706.116771689
E1 = -689.3978930204686  E_coul = 184.9115049351732
init E= -504.486388085295
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674719764868317  LUMO = 9.18405475517667
  mo_energy =
[-1.21707214e+02 -1.33875226e+01 -7.62808536e+00 -7.62808536e+00
 -7.62808536e+00 -1.64019009e+00 -6.74719765e-01 -6.74719765e-01
 -6.74719765e-01  9.18405476e+00  1.08652051e+02  6.03214040e+02
  2.74291144e+03  1.22222185e+04  4.08438384e+04  1.04887545e+05
  2.30071027e+05  4.55885992e+05  8.44838269e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.0695500075101  E_coul = 199.13092025223952
cycle= 1 E= -507.938629755271  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.60218
diis-c [-0.36262078  1.        ]
  HOMO = -0.233135314840003  LUMO = 10.0932153582692
  mo_energy =
[-1.20256518e+02 -1.23513151e+01 -6.64605599e+00 -6.64605599e+00
 -6.64605599e+00 -1.16151159e+00 -2.33135315e-01 -2.33135315e-01
 -2.33135315e-01  1.00932154e+01  1.10001175e+02  6.04650603e+02
  2.74428264e+03  1.22234783e+04  4.08450309e+04  1.04888700e+05
  2.30072159e+05  4.55887106e+05  8.44839370e+05  1.52801664e+06
  2.85028404e+06  5.80817133e+06]
E1 = -706.7154885639869  E_coul = 198.77046953393355
cycle= 2 E= -507.945019030053  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152553
diis-c [-2.24123967e-04  4.84824282e-03  9.95151757e-01]
  HOMO = -0.237595238910691  LUMO = 10.082292680673
  mo_energy =
[-1.20314335e+02 -1.23737178e+01 -6.67392954e+00 -6.67392954e+00
 -6.67392954e+00 -1.16377853e+00 -2.37595239e-01 -2.37595239e-01
 -2.37595239e-01  1.00822927e+01  1.09957696e+02  6.04589481e+02
  2.74420867e+03  1.22233961e+04  4.08449457e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839282e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.7008234666697  E_coul = 198.75579234769833
cycle= 3 E= -507.945031118971  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739864
diis-c [-1.26605229e-08  3.76670770e-05 -5.00630270e-02  1.05002536e+00]
  HOMO = -0.237821816149282  LUMO = 10.0817500035006
  mo_energy =
[-1.20316936e+02 -1.23748282e+01 -6.67528714e+00 -6.67528714e+00
 -6.67528714e+00 -1.16388908e+00 -2.37821816e-01 -2.37821816e-01
 -2.37821816e-01  1.00817500e+01  1.09955673e+02  6.04586807e+02
  2.74420562e+03  1.22233928e+04  4.08449423e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.700086028424  E_coul = 198.75505487924303
cycle= 4 E= -507.945031149181  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46521e-06
diis-c [-4.71797080e-12 -1.76585732e-06  2.30366303e-03 -4.57774398e-02
  1.04347554e+00]
  HOMO = -0.237822568326211  LUMO = 10.0817492387278
  mo_energy =
[-1.20316933e+02 -1.23748307e+01 -6.67528873e+00 -6.67528873e+00
 -6.67528873e+00 -1.16388952e+00 -2.37822568e-01 -2.37822568e-01
 -2.37822568e-01  1.00817492e+01  1.09955673e+02  6.04586810e+02
  2.74420562e+03  1.22233928e+04  4.08449423e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7000849144673  E_coul = 198.75505376528534
cycle= 5 E= -507.945031149182  delta_E= -1.02e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7000849144673  E_coul = 198.75505376528534
  HOMO = -0.237822602381757  LUMO = 10.0817491690264
  mo_energy =
[-1.20316934e+02 -1.23748308e+01 -6.67528890e+00 -6.67528890e+00
 -6.67528890e+00 -1.16388953e+00 -2.37822602e-01 -2.37822602e-01
 -2.37822602e-01  1.00817492e+01  1.09955673e+02  6.04586809e+02
  2.74420562e+03  1.22233928e+04  4.08449423e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7000848212177  E_coul = 198.7550536720359
Extra cycle  E= -507.945031149182  delta_E= 1.71e-13  |g|= 7.32e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907706.116771689
E1 = -706.7000848212177  E_coul = 198.7550536720359
init E= -507.945031149182
    CPU time for initialize scf      1.32 sec, wall time      0.08 sec
  HOMO = -0.237822603988487  LUMO = 10.0817491659332
  mo_energy =
[-1.20316934e+02 -1.23748308e+01 -6.67528891e+00 -6.67528891e+00
 -6.67528891e+00 -1.16388953e+00 -2.37822604e-01 -2.37822604e-01
 -2.37822604e-01  1.00817492e+01  1.09955673e+02  6.04586809e+02
  2.74420562e+03  1.22233928e+04  4.08449423e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7000848170068  E_coul = 198.75505366782457
cycle= 1 E= -507.945031149182  delta_E= -3.98e-13  |g|= 1.21e-09  |ddm|= 3.58e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
E1 = -706.7000848170068  E_coul = 198.75505366782457
  HOMO = -0.237822604066974  LUMO = 10.0817491657908
  mo_energy =
[-1.20316934e+02 -1.23748308e+01 -6.67528891e+00 -6.67528891e+00
 -6.67528891e+00 -1.16388953e+00 -2.37822604e-01 -2.37822604e-01
 -2.37822604e-01  1.00817492e+01  1.09955673e+02  6.04586809e+02
  2.74420562e+03  1.22233928e+04  4.08449423e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7000848168183  E_coul = 198.75505366763636
Extra cycle  E= -507.945031149182  delta_E= 3.41e-13  |g|= 1.63e-09  |ddm|= 1.73e-10
    CPU time for scf_cycle      1.51 sec, wall time      0.15 sec
exp = [1.17616814e+05 3.96628390e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349268e+03 1.83758108e+04 1.44977759e+03 3.73960627e+02
 1.13326627e+02 3.77647011e+01 8.08996198e+00 3.20484941e+00
 8.60387413e+00 4.93000601e-01]
grad_E = [ 4.15757503e-09 -3.18594645e-05  1.84644242e-11  1.11969025e-10
  6.46871781e-10  2.53655613e-09  1.05371690e-08  5.67138731e-08
  3.56526792e-06  1.21666397e-07  6.26857578e-06 -1.70991875e-05
  3.44416196e-05 -4.03676574e-05  7.18991566e-07  1.33652868e-05
  4.26877366e-06 -1.74619126e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:33:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814261        1
[INPUT] 0    0    [1    /1   ]  0.396572264185       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210202        1
[INPUT] 0    0    [1    /1   ]  36754.7203081        1
[INPUT] 0    0    [1    /1   ]  7303.49225635        1
[INPUT] 0    0    [1    /1   ]  18375.8107743        1
[INPUT] 0    0    [1    /1   ]  1449.77683982        1
[INPUT] 0    0    [1    /1   ]  373.962664651        1
[INPUT] 0    0    [1    /1   ]  113.322509996        1
[INPUT] 0    0    [1    /1   ]  37.7695587864        1
[INPUT] 0    0    [1    /1   ]  8.09003031797        1
[INPUT] 0    0    [1    /1   ]  3.2026679714         1
[INPUT] 1    0    [1    /1   ]  8.60394372378        1
[INPUT] 1    0    [1    /1   ]  0.493077990309       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426139882, 1.0]], [0, [0.3965722641846707, 1.0]], [0, [1176168.1426189751, 1.0]], [0, [588084.0699930919, 1.0]], [0, [294042.03113493085, 1.0]], [0, [147020.99215973436, 1.0]], [0, [73510.42102021484, 1.0]], [0, [36754.7203080839, 1.0]], [0, [7303.492256345586, 1.0]], [0, [18375.81077434023, 1.0]], [0, [1449.776839821276, 1.0]], [0, [373.96266465087643, 1.0]], [0, [113.32250999643477, 1.0]], [0, [37.769558786397525, 1.0]], [0, [8.090030317967264, 1.0]], [0, [3.202667971400635, 1.0]], [1, [8.603943723775199, 1.0]], [1, [0.4930779903091085, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.8142614]
bas 1, expnt(s) = [0.39657226]
bas 2, expnt(s) = [1176168.14261898]
bas 3, expnt(s) = [588084.06999309]
bas 4, expnt(s) = [294042.03113493]
bas 5, expnt(s) = [147020.99215973]
bas 6, expnt(s) = [73510.42102021]
bas 7, expnt(s) = [36754.72030808]
bas 8, expnt(s) = [7303.49225635]
bas 9, expnt(s) = [18375.81077434]
bas 10, expnt(s) = [1449.77683982]
bas 11, expnt(s) = [373.96266465]
bas 12, expnt(s) = [113.32251]
bas 13, expnt(s) = [37.76955879]
bas 14, expnt(s) = [8.09003032]
bas 15, expnt(s) = [3.20266797]
bas 16, expnt(s) = [8.60394372]
bas 17, expnt(s) = [0.49307799]
CPU time:        28.84
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96572264e-01 1.26257381e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349226e+03 1.99601111e+03 1.83758108e+04 3.98749275e+03
 1.44977684e+03 5.93595900e+02 3.73962665e+02 2.14850421e+02
 1.13322510e+02 8.77510179e+01 3.77695588e+01 3.84920869e+01
 8.09003032e+00 1.21193028e+01 3.20266797e+00 6.04851778e+00
 8.60394372e+00 4.29889011e+01 4.93077990e-01 1.20539369e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325010400348695
cond(S) = 907706.0857322583
E1 = -689.4001968510416  E_coul = 184.91391636920574
init E= -504.486280481836
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674648770467547  LUMO = 9.17838166891057
  mo_energy =
[-1.21706935e+02 -1.33873455e+01 -7.62794165e+00 -7.62794165e+00
 -7.62794165e+00 -1.64007845e+00 -6.74648770e-01 -6.74648770e-01
 -6.74648770e-01  9.17838167e+00  1.08650375e+02  6.03215169e+02
  2.74291276e+03  1.22222192e+04  4.08438381e+04  1.04887544e+05
  2.30071026e+05  4.55885991e+05  8.44838268e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.0720239466804  E_coul = 199.133402182528
cycle= 1 E= -507.938621764152  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.602219
diis-c [-0.36266766  1.        ]
  HOMO = -0.233004129124435  LUMO = 10.0874584835251
  mo_energy =
[-1.20256284e+02 -1.23511517e+01 -6.64594777e+00 -6.64594777e+00
 -6.64594777e+00 -1.16138567e+00 -2.33004129e-01 -2.33004129e-01
 -2.33004129e-01  1.00874585e+01  1.09999457e+02  6.04651702e+02
  2.74428392e+03  1.22234790e+04  4.08450306e+04  1.04888700e+05
  2.30072157e+05  4.55887104e+05  8.44839369e+05  1.52801664e+06
  2.85028404e+06  5.80817133e+06]
E1 = -706.7176565237112  E_coul = 198.7726379663963
cycle= 2 E= -507.945018557315  delta_E= -0.0064  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.05 sec, wall time      0.02 sec
diis-norm(errvec)=0.0152613
diis-c [-2.24295297e-04  4.85126664e-03  9.95148733e-01]
  HOMO = -0.237469651435501  LUMO = 10.0765279199575
  mo_energy =
[-1.20314144e+02 -1.23735748e+01 -6.67384601e+00 -6.67384601e+00
 -6.67384601e+00 -1.16365506e+00 -2.37469651e-01 -2.37469651e-01
 -2.37469651e-01  1.00765279e+01  1.09955942e+02  6.04590536e+02
  2.74420990e+03  1.22233967e+04  4.08449453e+04  1.04888613e+05
  2.30072070e+05  4.55887017e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7029766915114  E_coul = 198.75794602662828
cycle= 3 E= -507.945030664883  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00874
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000740267
diis-c [-1.27098694e-08  3.76831526e-05 -5.00691741e-02  1.05003149e+00]
  HOMO = -0.237696567402159  LUMO = 10.0759847395694
  mo_energy =
[-1.20316746e+02 -1.23746864e+01 -6.67520506e+00 -6.67520506e+00
 -6.67520506e+00 -1.16376576e+00 -2.37696567e-01 -2.37696567e-01
 -2.37696567e-01  1.00759847e+01  1.09953916e+02  6.04587860e+02
  2.74420685e+03  1.22233935e+04  4.08449420e+04  1.04888610e+05
  2.30072067e+05  4.55887013e+05  8.44839277e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7022383497628  E_coul = 198.7572076546052
cycle= 4 E= -507.945030695158  delta_E= -3.03e-08  |g|= 6.29e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.48094e-06
diis-c [-4.73455043e-12 -1.76794137e-06  2.30733721e-03 -4.58477190e-02
  1.04354215e+00]
  HOMO = -0.237697322592122  LUMO = 10.0759839712428
  mo_energy =
[-1.20316744e+02 -1.23746889e+01 -6.67520666e+00 -6.67520666e+00
 -6.67520666e+00 -1.16376619e+00 -2.37697323e-01 -2.37697323e-01
 -2.37697323e-01  1.00759840e+01  1.09953916e+02  6.04587863e+02
  2.74420685e+03  1.22233935e+04  4.08449420e+04  1.04888610e+05
  2.30072067e+05  4.55887013e+05  8.44839277e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7022372298864  E_coul = 198.75720653472754
cycle= 5 E= -507.945030695159  delta_E= -1.25e-12  |g|= 1.41e-07  |ddm|= 2.18e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7022372298864  E_coul = 198.75720653472754
  HOMO = -0.237697356707327  LUMO = 10.0759839014285
  mo_energy =
[-1.20316744e+02 -1.23746891e+01 -6.67520683e+00 -6.67520683e+00
 -6.67520683e+00 -1.16376621e+00 -2.37697357e-01 -2.37697357e-01
 -2.37697357e-01  1.00759839e+01  1.09953916e+02  6.04587862e+02
  2.74420685e+03  1.22233935e+04  4.08449420e+04  1.04888610e+05
  2.30072067e+05  4.55887013e+05  8.44839277e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7022371364466  E_coul = 198.75720644128808
Extra cycle  E= -507.945030695158  delta_E= 3.41e-13  |g|= 7.27e-09  |ddm|= 7.26e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.12 sec
exp = [1.17616814e+05 3.96572264e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349226e+03 1.83758108e+04 1.44977684e+03 3.73962665e+02
 1.13322510e+02 3.77695588e+01 8.09003032e+00 3.20266797e+00
 8.60394372e+00 4.93077990e-01]
E = -507.9450306951585
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:33:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814262        1
[INPUT] 0    0    [1    /1   ]  0.3966149142         1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210212        1
[INPUT] 0    0    [1    /1   ]  36754.7203132        1
[INPUT] 0    0    [1    /1   ]  7303.49257875        1
[INPUT] 0    0    [1    /1   ]  18375.8107853        1
[INPUT] 0    0    [1    /1   ]  1449.77740682        1
[INPUT] 0    0    [1    /1   ]  373.961116353        1
[INPUT] 0    0    [1    /1   ]  113.325638402        1
[INPUT] 0    0    [1    /1   ]  37.7658674682        1
[INPUT] 0    0    [1    /1   ]  8.08997838542        1
[INPUT] 0    0    [1    /1   ]  3.20432563474        1
[INPUT] 1    0    [1    /1   ]  8.60389083656        1
[INPUT] 1    0    [1    /1   ]  0.493019182481       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426177478, 1.0]], [0, [0.39661491420003936, 1.0]], [0, [1176168.1426189768, 1.0]], [0, [588084.069993102, 1.0]], [0, [294042.0311349893, 1.0]], [0, [147020.99215996376, 1.0]], [0, [73510.42102116768, 1.0]], [0, [36754.72031321243, 1.0]], [0, [7303.492578745232, 1.0]], [0, [18375.810785342244, 1.0]], [0, [1449.7774068228227, 1.0]], [0, [373.961116352989, 1.0]], [0, [113.32563840168089, 1.0]], [0, [37.76586746820083, 1.0]], [0, [8.089978385417169, 1.0]], [0, [3.204325634743066, 1.0]], [1, [8.603890836559021, 1.0]], [1, [0.49301918248123966, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426177]
bas 1, expnt(s) = [0.39661491]
bas 2, expnt(s) = [1176168.14261898]
bas 3, expnt(s) = [588084.0699931]
bas 4, expnt(s) = [294042.03113499]
bas 5, expnt(s) = [147020.99215996]
bas 6, expnt(s) = [73510.42102117]
bas 7, expnt(s) = [36754.72031321]
bas 8, expnt(s) = [7303.49257875]
bas 9, expnt(s) = [18375.81078534]
bas 10, expnt(s) = [1449.77740682]
bas 11, expnt(s) = [373.96111635]
bas 12, expnt(s) = [113.3256384]
bas 13, expnt(s) = [37.76586747]
bas 14, expnt(s) = [8.08997839]
bas 15, expnt(s) = [3.20432563]
bas 16, expnt(s) = [8.60389084]
bas 17, expnt(s) = [0.49301918]
CPU time:        29.37
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96614914e-01 1.26267565e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349258e+03 1.99601118e+03 1.83758108e+04 3.98749275e+03
 1.44977741e+03 5.93596074e+02 3.73961116e+02 2.14849754e+02
 1.13325638e+02 8.77528348e+01 3.77658675e+01 3.84892654e+01
 8.08997839e+00 1.21192444e+01 3.20432563e+00 6.05086561e+00
 8.60389084e+00 4.29885708e+01 4.93019182e-01 1.20521399e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32508321301197
cond(S) = 907706.1092268451
E1 = -689.3984473731783  E_coul = 184.91208409335684
init E= -504.486363279821
    CPU time for initialize scf      0.22 sec, wall time      0.03 sec
  HOMO = -0.674702713616411  LUMO = 9.18269276673647
  mo_energy =
[-1.21707147e+02 -1.33874801e+01 -7.62805084e+00 -7.62805084e+00
 -7.62805084e+00 -1.64016329e+00 -6.74702714e-01 -6.74702714e-01
 -6.74702714e-01  9.18269277e+00  1.08651649e+02  6.03214311e+02
  2.74291176e+03  1.22222187e+04  4.08438383e+04  1.04887545e+05
  2.30071027e+05  4.55885991e+05  8.44838269e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.0701441659647  E_coul = 199.1315161688414
cycle= 1 E= -507.938627997123  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.602189
diis-c [-0.36263203  1.        ]
  HOMO = -0.233103817897463  LUMO = 10.09183324737
  mo_energy =
[-1.20256462e+02 -1.23512759e+01 -6.64603001e+00 -6.64603001e+00
 -6.64603001e+00 -1.16148136e+00 -2.33103818e-01 -2.33103818e-01
 -2.33103818e-01  1.00918332e+01  1.10000763e+02  6.04650867e+02
  2.74428295e+03  1.22234785e+04  4.08450308e+04  1.04888700e+05
  2.30072158e+05  4.55887105e+05  8.44839370e+05  1.52801664e+06
  2.85028404e+06  5.80817133e+06]
E1 = -706.716009297088  E_coul = 198.7709902211509
cycle= 2 E= -507.945019075937  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152568
diis-c [-2.24165083e-04  4.84896888e-03  9.95151031e-01]
  HOMO = -0.237565085225294  LUMO = 10.0809086771992
  mo_energy =
[-1.20314289e+02 -1.23736835e+01 -6.67390948e+00 -6.67390948e+00
 -6.67390948e+00 -1.16374889e+00 -2.37565085e-01 -2.37565085e-01
 -2.37565085e-01  1.00809087e+01  1.09957275e+02  6.04589734e+02
  2.74420897e+03  1.22233963e+04  4.08449456e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839282e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.7013406640175  E_coul = 198.75630949468743
cycle= 3 E= -507.94503116933  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739961
diis-c [-1.26723421e-08  3.76718652e-05 -5.00645140e-02  1.05002684e+00]
  HOMO = -0.237791743730416  LUMO = 10.0803658792711
  mo_energy =
[-1.20316890e+02 -1.23747942e+01 -6.67526743e+00 -6.67526743e+00
 -6.67526743e+00 -1.16385948e+00 -2.37791744e-01 -2.37791744e-01
 -2.37791744e-01  1.00803659e+01  1.09955251e+02  6.04587060e+02
  2.74420591e+03  1.22233930e+04  4.08449422e+04  1.04888610e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7006030090001  E_coul = 198.75557180944526
cycle= 4 E= -507.945031199555  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46912e-06
diis-c [-4.72263685e-12 -1.76632695e-06  2.30458585e-03 -4.57951022e-02
  1.04349228e+00]
  HOMO = -0.23779249663146  LUMO = 10.0803651136437
  mo_energy =
[-1.20316888e+02 -1.23747967e+01 -6.67526902e+00 -6.67526902e+00
 -6.67526902e+00 -1.16385991e+00 -2.37792497e-01 -2.37792497e-01
 -2.37792497e-01  1.00803651e+01  1.09955251e+02  6.04587062e+02
  2.74420592e+03  1.22233930e+04  4.08449422e+04  1.04888610e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7006018936208  E_coul = 198.75557069406455
cycle= 5 E= -507.945031199556  delta_E= -1.42e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7006018936208  E_coul = 198.75557069406455
  HOMO = -0.237792530701724  LUMO = 10.0803650439142
  mo_energy =
[-1.20316888e+02 -1.23747968e+01 -6.67526919e+00 -6.67526919e+00
 -6.67526919e+00 -1.16385993e+00 -2.37792531e-01 -2.37792531e-01
 -2.37792531e-01  1.00803650e+01  1.09955251e+02  6.04587062e+02
  2.74420592e+03  1.22233930e+04  4.08449422e+04  1.04888610e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7006018003142  E_coul = 198.75557060075758
Extra cycle  E= -507.945031199557  delta_E= -3.41e-13  |g|= 7.69e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.46 sec, wall time      0.11 sec
exp = [1.17616814e+05 3.96614914e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349258e+03 1.83758108e+04 1.44977741e+03 3.73961116e+02
 1.13325638e+02 3.77658675e+01 8.08997839e+00 3.20432563e+00
 8.60389084e+00 4.93019182e-01]
E = -507.94503119955664
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:33:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814262        1
[INPUT] 0    0    [1    /1   ]  0.3966149142         1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210212        1
[INPUT] 0    0    [1    /1   ]  36754.7203132        1
[INPUT] 0    0    [1    /1   ]  7303.49257875        1
[INPUT] 0    0    [1    /1   ]  18375.8107853        1
[INPUT] 0    0    [1    /1   ]  1449.77740682        1
[INPUT] 0    0    [1    /1   ]  373.961116353        1
[INPUT] 0    0    [1    /1   ]  113.325638402        1
[INPUT] 0    0    [1    /1   ]  37.7658674682        1
[INPUT] 0    0    [1    /1   ]  8.08997838542        1
[INPUT] 0    0    [1    /1   ]  3.20432563474        1
[INPUT] 1    0    [1    /1   ]  8.60389083656        1
[INPUT] 1    0    [1    /1   ]  0.493019182481       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426177478, 1.0]], [0, [0.39661491420003936, 1.0]], [0, [1176168.1426189768, 1.0]], [0, [588084.069993102, 1.0]], [0, [294042.0311349893, 1.0]], [0, [147020.99215996376, 1.0]], [0, [73510.42102116768, 1.0]], [0, [36754.72031321243, 1.0]], [0, [7303.492578745232, 1.0]], [0, [18375.810785342244, 1.0]], [0, [1449.7774068228227, 1.0]], [0, [373.961116352989, 1.0]], [0, [113.32563840168089, 1.0]], [0, [37.76586746820083, 1.0]], [0, [8.089978385417169, 1.0]], [0, [3.204325634743066, 1.0]], [1, [8.603890836559021, 1.0]], [1, [0.49301918248123966, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426177]
bas 1, expnt(s) = [0.39661491]
bas 2, expnt(s) = [1176168.14261898]
bas 3, expnt(s) = [588084.0699931]
bas 4, expnt(s) = [294042.03113499]
bas 5, expnt(s) = [147020.99215996]
bas 6, expnt(s) = [73510.42102117]
bas 7, expnt(s) = [36754.72031321]
bas 8, expnt(s) = [7303.49257875]
bas 9, expnt(s) = [18375.81078534]
bas 10, expnt(s) = [1449.77740682]
bas 11, expnt(s) = [373.96111635]
bas 12, expnt(s) = [113.3256384]
bas 13, expnt(s) = [37.76586747]
bas 14, expnt(s) = [8.08997839]
bas 15, expnt(s) = [3.20432563]
bas 16, expnt(s) = [8.60389084]
bas 17, expnt(s) = [0.49301918]
CPU time:        29.89
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96614914e-01 1.26267565e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349258e+03 1.99601118e+03 1.83758108e+04 3.98749275e+03
 1.44977741e+03 5.93596074e+02 3.73961116e+02 2.14849754e+02
 1.13325638e+02 8.77528348e+01 3.77658675e+01 3.84892654e+01
 8.08997839e+00 1.21192444e+01 3.20432563e+00 6.05086561e+00
 8.60389084e+00 4.29885708e+01 4.93019182e-01 1.20521399e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32508321301197
cond(S) = 907706.1092268451
E1 = -689.3984473731783  E_coul = 184.91208409335684
init E= -504.486363279821
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674702713616411  LUMO = 9.18269276673647
  mo_energy =
[-1.21707147e+02 -1.33874801e+01 -7.62805084e+00 -7.62805084e+00
 -7.62805084e+00 -1.64016329e+00 -6.74702714e-01 -6.74702714e-01
 -6.74702714e-01  9.18269277e+00  1.08651649e+02  6.03214311e+02
  2.74291176e+03  1.22222187e+04  4.08438383e+04  1.04887545e+05
  2.30071027e+05  4.55885991e+05  8.44838269e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.0701441659647  E_coul = 199.1315161688414
cycle= 1 E= -507.938627997123  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.18 sec, wall time      0.01 sec
diis-norm(errvec)=0.602189
diis-c [-0.36263203  1.        ]
  HOMO = -0.233103817897463  LUMO = 10.09183324737
  mo_energy =
[-1.20256462e+02 -1.23512759e+01 -6.64603001e+00 -6.64603001e+00
 -6.64603001e+00 -1.16148136e+00 -2.33103818e-01 -2.33103818e-01
 -2.33103818e-01  1.00918332e+01  1.10000763e+02  6.04650867e+02
  2.74428295e+03  1.22234785e+04  4.08450308e+04  1.04888700e+05
  2.30072158e+05  4.55887105e+05  8.44839370e+05  1.52801664e+06
  2.85028404e+06  5.80817133e+06]
E1 = -706.716009297088  E_coul = 198.7709902211509
cycle= 2 E= -507.945019075937  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152568
diis-c [-2.24165083e-04  4.84896888e-03  9.95151031e-01]
  HOMO = -0.237565085225294  LUMO = 10.0809086771992
  mo_energy =
[-1.20314289e+02 -1.23736835e+01 -6.67390948e+00 -6.67390948e+00
 -6.67390948e+00 -1.16374889e+00 -2.37565085e-01 -2.37565085e-01
 -2.37565085e-01  1.00809087e+01  1.09957275e+02  6.04589734e+02
  2.74420897e+03  1.22233963e+04  4.08449456e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839282e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.7013406640175  E_coul = 198.75630949468743
cycle= 3 E= -507.94503116933  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739961
diis-c [-1.26723421e-08  3.76718652e-05 -5.00645140e-02  1.05002684e+00]
  HOMO = -0.237791743730416  LUMO = 10.0803658792711
  mo_energy =
[-1.20316890e+02 -1.23747942e+01 -6.67526743e+00 -6.67526743e+00
 -6.67526743e+00 -1.16385948e+00 -2.37791744e-01 -2.37791744e-01
 -2.37791744e-01  1.00803659e+01  1.09955251e+02  6.04587060e+02
  2.74420591e+03  1.22233930e+04  4.08449422e+04  1.04888610e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7006030090001  E_coul = 198.75557180944526
cycle= 4 E= -507.945031199555  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46912e-06
diis-c [-4.72263685e-12 -1.76632695e-06  2.30458585e-03 -4.57951022e-02
  1.04349228e+00]
  HOMO = -0.23779249663146  LUMO = 10.0803651136437
  mo_energy =
[-1.20316888e+02 -1.23747967e+01 -6.67526902e+00 -6.67526902e+00
 -6.67526902e+00 -1.16385991e+00 -2.37792497e-01 -2.37792497e-01
 -2.37792497e-01  1.00803651e+01  1.09955251e+02  6.04587062e+02
  2.74420592e+03  1.22233930e+04  4.08449422e+04  1.04888610e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7006018936208  E_coul = 198.75557069406455
cycle= 5 E= -507.945031199556  delta_E= -1.42e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7006018936208  E_coul = 198.75557069406455
  HOMO = -0.237792530701724  LUMO = 10.0803650439142
  mo_energy =
[-1.20316888e+02 -1.23747968e+01 -6.67526919e+00 -6.67526919e+00
 -6.67526919e+00 -1.16385993e+00 -2.37792531e-01 -2.37792531e-01
 -2.37792531e-01  1.00803650e+01  1.09955251e+02  6.04587062e+02
  2.74420592e+03  1.22233930e+04  4.08449422e+04  1.04888610e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7006018003142  E_coul = 198.75557060075758
Extra cycle  E= -507.945031199557  delta_E= -3.41e-13  |g|= 7.69e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907706.1092268451
E1 = -706.7006018003142  E_coul = 198.75557060075758
init E= -507.945031199557
    CPU time for initialize scf      1.47 sec, wall time      0.09 sec
  HOMO = -0.237792532309434  LUMO = 10.0803650408183
  mo_energy =
[-1.20316888e+02 -1.23747968e+01 -6.67526920e+00 -6.67526920e+00
 -6.67526920e+00 -1.16385993e+00 -2.37792532e-01 -2.37792532e-01
 -2.37792532e-01  1.00803650e+01  1.09955251e+02  6.04587062e+02
  2.74420592e+03  1.22233930e+04  4.08449422e+04  1.04888610e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7006017960975  E_coul = 198.75557059654082
cycle= 1 E= -507.945031199557  delta_E= -1.14e-13  |g|= 1.05e-09  |ddm|= 3.59e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
E1 = -706.7006017960975  E_coul = 198.75557059654082
  HOMO = -0.237792532388038  LUMO = 10.0803650406755
  mo_energy =
[-1.20316888e+02 -1.23747968e+01 -6.67526920e+00 -6.67526920e+00
 -6.67526920e+00 -1.16385993e+00 -2.37792532e-01 -2.37792532e-01
 -2.37792532e-01  1.00803650e+01  1.09955251e+02  6.04587062e+02
  2.74420592e+03  1.22233930e+04  4.08449422e+04  1.04888610e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7006017959058  E_coul = 198.7555705963496
Extra cycle  E= -507.945031199556  delta_E= 5.68e-13  |g|= 1.55e-09  |ddm|= 1.76e-10
    CPU time for scf_cycle      1.65 sec, wall time      0.16 sec
exp = [1.17616814e+05 3.96614914e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349258e+03 1.83758108e+04 1.44977741e+03 3.73961116e+02
 1.13325638e+02 3.77658675e+01 8.08997839e+00 3.20432563e+00
 8.60389084e+00 4.93019182e-01]
grad_E = [ 4.15845204e-09 -2.45050158e-04  1.84748722e-11  1.11997483e-10
  6.47007602e-10  2.53709807e-09  1.05394530e-08  5.67251472e-08
  3.56607560e-06  1.21700536e-07  6.22231086e-06 -1.64395492e-05
  2.99709243e-05 -2.73687416e-05  3.43156854e-05 -1.13686174e-04
 -4.29229063e-06  4.14330891e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:33:54 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814262        1
[INPUT] 0    0    [1    /1   ]  0.396906987539       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210208        1
[INPUT] 0    0    [1    /1   ]  36754.7203111        1
[INPUT] 0    0    [1    /1   ]  7303.49244904        1
[INPUT] 0    0    [1    /1   ]  18375.8107809        1
[INPUT] 0    0    [1    /1   ]  1449.77717876        1
[INPUT] 0    0    [1    /1   ]  373.961738541        1
[INPUT] 0    0    [1    /1   ]  113.324384703        1
[INPUT] 0    0    [1    /1   ]  37.7673382213        1
[INPUT] 0    0    [1    /1   ]  8.08996183309        1
[INPUT] 0    0    [1    /1   ]  3.20380055096        1
[INPUT] 1    0    [1    /1   ]  8.60390626939        1
[INPUT] 1    0    [1    /1   ]  0.492970161154       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426162353, 1.0]], [0, [0.39690698753871395, 1.0]], [0, [1176168.142618976, 1.0]], [0, [588084.0699930979, 1.0]], [0, [294042.0311349658, 1.0]], [0, [147020.99215987147, 1.0]], [0, [73510.42102078433, 1.0]], [0, [36754.720311149096, 1.0]], [0, [7303.492449035789, 1.0]], [0, [18375.81078091585, 1.0]], [0, [1449.777178756458, 1.0]], [0, [373.9617385408003, 1.0]], [0, [113.32438470290627, 1.0]], [0, [37.767338221288085, 1.0]], [0, [8.08996183309188, 1.0]], [0, [3.2038005509608225, 1.0]], [1, [8.603906269391949, 1.0]], [1, [0.49297016115445197, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426162]
bas 1, expnt(s) = [0.39690699]
bas 2, expnt(s) = [1176168.14261898]
bas 3, expnt(s) = [588084.0699931]
bas 4, expnt(s) = [294042.03113497]
bas 5, expnt(s) = [147020.99215987]
bas 6, expnt(s) = [73510.42102078]
bas 7, expnt(s) = [36754.72031115]
bas 8, expnt(s) = [7303.49244904]
bas 9, expnt(s) = [18375.81078092]
bas 10, expnt(s) = [1449.77717876]
bas 11, expnt(s) = [373.96173854]
bas 12, expnt(s) = [113.3243847]
bas 13, expnt(s) = [37.76733822]
bas 14, expnt(s) = [8.08996183]
bas 15, expnt(s) = [3.20380055]
bas 16, expnt(s) = [8.60390627]
bas 17, expnt(s) = [0.49297016]
CPU time:        34.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96906988e-01 1.26337298e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349245e+03 1.99601115e+03 1.83758108e+04 3.98749275e+03
 1.44977718e+03 5.93596004e+02 3.73961739e+02 2.14850022e+02
 1.13324385e+02 8.77521067e+01 3.77673382e+01 3.84903896e+01
 8.08996183e+00 1.21192258e+01 3.20380055e+00 6.05012194e+00
 8.60390627e+00 4.29886672e+01 4.92970161e-01 1.20506420e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32511553308168
cond(S) = 907706.1175561218
E1 = -689.3997099043266  E_coul = 184.9126052522558
init E= -504.487104652071
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674680230646495  LUMO = 9.1829344391337
  mo_energy =
[-1.21707119e+02 -1.33874601e+01 -7.62798904e+00 -7.62798904e+00
 -7.62798904e+00 -1.64023776e+00 -6.74680231e-01 -6.74680231e-01
 -6.74680231e-01  9.18293444e+00  1.08652768e+02  6.03215936e+02
  2.74291323e+03  1.22222198e+04  4.08438391e+04  1.04887545e+05
  2.30071028e+05  4.55885992e+05  8.44838269e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.0723186030388  E_coul = 199.1336875985548
cycle= 1 E= -507.938631004484  delta_E= -3.45  |g|= 0.442  |ddm|= 0.386
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602193
diis-c [-0.36263642  1.        ]
  HOMO = -0.233077627501498  LUMO = 10.0920845639625
  mo_energy =
[-1.20256224e+02 -1.23511305e+01 -6.64582587e+00 -6.64582587e+00
 -6.64582587e+00 -1.16147007e+00 -2.33077628e-01 -2.33077628e-01
 -2.33077628e-01  1.00920846e+01  1.10002059e+02  6.04652709e+02
  2.74428466e+03  1.22234798e+04  4.08450318e+04  1.04888701e+05
  2.30072159e+05  4.55887106e+05  8.44839370e+05  1.52801664e+06
  2.85028404e+06  5.80817133e+06]
E1 = -706.7182468635192  E_coul = 198.77322826316123
cycle= 2 E= -507.945018600358  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152548
diis-c [-2.24094442e-04  4.85141792e-03  9.95148582e-01]
  HOMO = -0.23753680391504  LUMO = 10.0811630296945
  mo_energy =
[-1.20314045e+02 -1.23735328e+01 -6.67370019e+00 -6.67370019e+00
 -6.67370019e+00 -1.16373756e+00 -2.37536804e-01 -2.37536804e-01
 -2.37536804e-01  1.00811630e+01  1.09958577e+02  6.04591583e+02
  2.74421069e+03  1.22233977e+04  4.08449466e+04  1.04888615e+05
  2.30072072e+05  4.55887018e+05  8.44839282e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.7035800801143  E_coul = 198.75854939216757
cycle= 3 E= -507.945030687947  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739905
diis-c [-1.26757919e-08  3.77222061e-05 -5.00665812e-02  1.05002886e+00]
  HOMO = -0.237763385136918  LUMO = 10.0806203228573
  mo_energy =
[-1.20316645e+02 -1.23746434e+01 -6.67505804e+00 -6.67505804e+00
 -6.67505804e+00 -1.16384817e+00 -2.37763385e-01 -2.37763385e-01
 -2.37763385e-01  1.00806203e+01  1.09956553e+02  6.04588909e+02
  2.74420764e+03  1.22233944e+04  4.08449433e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7028424395703  E_coul = 198.75781172140702
cycle= 4 E= -507.945030718163  delta_E= -3.02e-08  |g|= 6.28e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.47044e-06
diis-c [-4.72419279e-12 -1.76654295e-06  2.30515673e-03 -4.58056322e-02
  1.04350224e+00]
  HOMO = -0.237764138869847  LUMO = 10.080619555138
  mo_energy =
[-1.20316643e+02 -1.23746459e+01 -6.67505963e+00 -6.67505963e+00
 -6.67505963e+00 -1.16384860e+00 -2.37764139e-01 -2.37764139e-01
 -2.37764139e-01  1.00806196e+01  1.09956554e+02  6.04588912e+02
  2.74420764e+03  1.22233944e+04  4.08449433e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7028413207896  E_coul = 198.7578106026251
cycle= 5 E= -507.945030718165  delta_E= -1.25e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7028413207896  E_coul = 198.7578106026251
  HOMO = -0.237764172941718  LUMO = 10.0806194853896
  mo_energy =
[-1.20316643e+02 -1.23746460e+01 -6.67505981e+00 -6.67505981e+00
 -6.67505981e+00 -1.16384862e+00 -2.37764173e-01 -2.37764173e-01
 -2.37764173e-01  1.00806195e+01  1.09956553e+02  6.04588911e+02
  2.74420764e+03  1.22233944e+04  4.08449433e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7028412274454  E_coul = 198.7578105092807
Extra cycle  E= -507.945030718165  delta_E= -2.27e-13  |g|= 7.32e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
exp = [1.17616814e+05 3.96906988e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349245e+03 1.83758108e+04 1.44977718e+03 3.73961739e+02
 1.13324385e+02 3.77673382e+01 8.08996183e+00 3.20380055e+00
 8.60390627e+00 4.92970161e-01]
E = -507.94503071816473
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:33:54 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814262        1
[INPUT] 0    0    [1    /1   ]  0.396644588181       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210211        1
[INPUT] 0    0    [1    /1   ]  36754.720313         1
[INPUT] 0    0    [1    /1   ]  7303.49256557        1
[INPUT] 0    0    [1    /1   ]  18375.8107849        1
[INPUT] 0    0    [1    /1   ]  1449.77738365        1
[INPUT] 0    0    [1    /1   ]  373.961179566        1
[INPUT] 0    0    [1    /1   ]  113.325511029        1
[INPUT] 0    0    [1    /1   ]  37.7660168933        1
[INPUT] 0    0    [1    /1   ]  8.08997670374        1
[INPUT] 0    0    [1    /1   ]  3.20427228744        1
[INPUT] 1    0    [1    /1   ]  8.6038924045         1
[INPUT] 1    0    [1    /1   ]  0.493014202027       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426175941, 1.0]], [0, [0.3966445881807369, 1.0]], [0, [1176168.1426189768, 1.0]], [0, [588084.0699931015, 1.0]], [0, [294042.0311349869, 1.0]], [0, [147020.9921599544, 1.0]], [0, [73510.42102112874, 1.0]], [0, [36754.7203130028, 1.0]], [0, [7303.49256556705, 1.0]], [0, [18375.810784892532, 1.0]], [0, [1449.7773836518036, 1.0]], [0, [373.96117956584226, 1.0]], [0, [113.3255110287635, 1.0]], [0, [37.76601689333809, 1.0]], [0, [8.089976703738918, 1.0]], [0, [3.2042722874362233, 1.0]], [1, [8.603892404499417, 1.0]], [1, [0.4930142020269761, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426176]
bas 1, expnt(s) = [0.39664459]
bas 2, expnt(s) = [1176168.14261898]
bas 3, expnt(s) = [588084.0699931]
bas 4, expnt(s) = [294042.03113499]
bas 5, expnt(s) = [147020.99215995]
bas 6, expnt(s) = [73510.42102113]
bas 7, expnt(s) = [36754.720313]
bas 8, expnt(s) = [7303.49256557]
bas 9, expnt(s) = [18375.81078489]
bas 10, expnt(s) = [1449.77738365]
bas 11, expnt(s) = [373.96117957]
bas 12, expnt(s) = [113.32551103]
bas 13, expnt(s) = [37.76601689]
bas 14, expnt(s) = [8.0899767]
bas 15, expnt(s) = [3.20427229]
bas 16, expnt(s) = [8.6038924]
bas 17, expnt(s) = [0.4930142]
CPU time:        35.19
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96644588e-01 1.26274650e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349257e+03 1.99601117e+03 1.83758108e+04 3.98749275e+03
 1.44977738e+03 5.93596067e+02 3.73961180e+02 2.14849781e+02
 1.13325511e+02 8.77527608e+01 3.77660169e+01 3.84893797e+01
 8.08997670e+00 1.21192426e+01 3.20427229e+00 6.05079006e+00
 8.60389240e+00 4.29885806e+01 4.93014202e-01 1.20519877e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325086519669874
cond(S) = 907706.1100953228
E1 = -689.3985763881585  E_coul = 184.91213739934253
init E= -504.486438988816
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674700413240727  LUMO = 9.1827173540068
  mo_energy =
[-1.21707144e+02 -1.33874780e+01 -7.62804454e+00 -7.62804454e+00
 -7.62804454e+00 -1.64017087e+00 -6.74700413e-01 -6.74700413e-01
 -6.74700413e-01  9.18271735e+00  1.08651763e+02  6.03214476e+02
  2.74291191e+03  1.22222188e+04  4.08438384e+04  1.04887545e+05
  2.30071027e+05  4.55885991e+05  8.44838269e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.0703653349129  E_coul = 199.13173697692568
cycle= 1 E= -507.938628357987  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.60219
diis-c [-0.36263247  1.        ]
  HOMO = -0.233101150884961  LUMO = 10.0918587995105
  mo_energy =
[-1.20256438e+02 -1.23512611e+01 -6.64600925e+00 -6.64600925e+00
 -6.64600925e+00 -1.16148024e+00 -2.33101151e-01 -2.33101151e-01
 -2.33101151e-01  1.00918588e+01  1.10000895e+02  6.04651054e+02
  2.74428312e+03  1.22234786e+04  4.08450309e+04  1.04888700e+05
  2.30072158e+05  4.55887105e+05  8.44839370e+05  1.52801664e+06
  2.85028404e+06  5.80817133e+06]
E1 = -706.7162368804143  E_coul = 198.771217797653
cycle= 2 E= -507.945019082761  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152566
diis-c [-2.24157904e-04  4.84921808e-03  9.95150782e-01]
  HOMO = -0.237562205725563  LUMO = 10.0809345378357
  mo_energy =
[-1.20314264e+02 -1.23736682e+01 -6.67388820e+00 -6.67388820e+00
 -6.67388820e+00 -1.16374776e+00 -2.37562206e-01 -2.37562206e-01
 -2.37562206e-01  1.00809345e+01  1.09957407e+02  6.04589922e+02
  2.74420914e+03  1.22233964e+04  4.08449457e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839282e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.7015684352111  E_coul = 198.7565372596477
cycle= 3 E= -507.945031175563  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739955
diis-c [-1.26727340e-08  3.76763004e-05 -5.00647169e-02  1.05002704e+00]
  HOMO = -0.237788856382123  LUMO = 10.080391749155
  mo_energy =
[-1.20316865e+02 -1.23747789e+01 -6.67524614e+00 -6.67524614e+00
 -6.67524614e+00 -1.16385835e+00 -2.37788856e-01 -2.37788856e-01
 -2.37788856e-01  1.00803917e+01  1.09955383e+02  6.04587248e+02
  2.74420609e+03  1.22233931e+04  4.08449423e+04  1.04888610e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7008307816367  E_coul = 198.75579957584873
cycle= 4 E= -507.945031205788  delta_E= -3.02e-08  |g|= 6.28e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46867e-06
diis-c [-4.72056404e-12 -1.76585704e-06  2.30445012e-03 -4.57923419e-02
  1.04348966e+00]
  HOMO = -0.237789609364211  LUMO = 10.0803909833173
  mo_energy =
[-1.20316863e+02 -1.23747813e+01 -6.67524773e+00 -6.67524773e+00
 -6.67524773e+00 -1.16385878e+00 -2.37789609e-01 -2.37789609e-01
 -2.37789609e-01  1.00803910e+01  1.09955384e+02  6.04587250e+02
  2.74420609e+03  1.22233931e+04  4.08449423e+04  1.04888610e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7008296659292  E_coul = 198.75579846013943
cycle= 5 E= -507.94503120579  delta_E= -1.82e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7008296659292  E_coul = 198.75579846013943
  HOMO = -0.237789643436398  LUMO = 10.0803909135849
  mo_energy =
[-1.20316863e+02 -1.23747815e+01 -6.67524790e+00 -6.67524790e+00
 -6.67524790e+00 -1.16385880e+00 -2.37789643e-01 -2.37789643e-01
 -2.37789643e-01  1.00803909e+01  1.09955383e+02  6.04587250e+02
  2.74420609e+03  1.22233931e+04  4.08449423e+04  1.04888610e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7008295726189  E_coul = 198.7557983668295
Extra cycle  E= -507.945031205789  delta_E= 3.41e-13  |g|= 7.41e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
exp = [1.17616814e+05 3.96644588e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349257e+03 1.83758108e+04 1.44977738e+03 3.73961180e+02
 1.13325511e+02 3.77660169e+01 8.08997670e+00 3.20427229e+00
 8.60389240e+00 4.93014202e-01]
E = -507.9450312057894
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:33:54 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814262        1
[INPUT] 0    0    [1    /1   ]  0.396644588181       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210211        1
[INPUT] 0    0    [1    /1   ]  36754.720313         1
[INPUT] 0    0    [1    /1   ]  7303.49256557        1
[INPUT] 0    0    [1    /1   ]  18375.8107849        1
[INPUT] 0    0    [1    /1   ]  1449.77738365        1
[INPUT] 0    0    [1    /1   ]  373.961179566        1
[INPUT] 0    0    [1    /1   ]  113.325511029        1
[INPUT] 0    0    [1    /1   ]  37.7660168933        1
[INPUT] 0    0    [1    /1   ]  8.08997670374        1
[INPUT] 0    0    [1    /1   ]  3.20427228744        1
[INPUT] 1    0    [1    /1   ]  8.6038924045         1
[INPUT] 1    0    [1    /1   ]  0.493014202027       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426175941, 1.0]], [0, [0.3966445881807369, 1.0]], [0, [1176168.1426189768, 1.0]], [0, [588084.0699931015, 1.0]], [0, [294042.0311349869, 1.0]], [0, [147020.9921599544, 1.0]], [0, [73510.42102112874, 1.0]], [0, [36754.7203130028, 1.0]], [0, [7303.49256556705, 1.0]], [0, [18375.810784892532, 1.0]], [0, [1449.7773836518036, 1.0]], [0, [373.96117956584226, 1.0]], [0, [113.3255110287635, 1.0]], [0, [37.76601689333809, 1.0]], [0, [8.089976703738918, 1.0]], [0, [3.2042722874362233, 1.0]], [1, [8.603892404499417, 1.0]], [1, [0.4930142020269761, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426176]
bas 1, expnt(s) = [0.39664459]
bas 2, expnt(s) = [1176168.14261898]
bas 3, expnt(s) = [588084.0699931]
bas 4, expnt(s) = [294042.03113499]
bas 5, expnt(s) = [147020.99215995]
bas 6, expnt(s) = [73510.42102113]
bas 7, expnt(s) = [36754.720313]
bas 8, expnt(s) = [7303.49256557]
bas 9, expnt(s) = [18375.81078489]
bas 10, expnt(s) = [1449.77738365]
bas 11, expnt(s) = [373.96117957]
bas 12, expnt(s) = [113.32551103]
bas 13, expnt(s) = [37.76601689]
bas 14, expnt(s) = [8.0899767]
bas 15, expnt(s) = [3.20427229]
bas 16, expnt(s) = [8.6038924]
bas 17, expnt(s) = [0.4930142]
CPU time:        35.67
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96644588e-01 1.26274650e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349257e+03 1.99601117e+03 1.83758108e+04 3.98749275e+03
 1.44977738e+03 5.93596067e+02 3.73961180e+02 2.14849781e+02
 1.13325511e+02 8.77527608e+01 3.77660169e+01 3.84893797e+01
 8.08997670e+00 1.21192426e+01 3.20427229e+00 6.05079006e+00
 8.60389240e+00 4.29885806e+01 4.93014202e-01 1.20519877e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325086519669874
cond(S) = 907706.1100953228
E1 = -689.3985763881585  E_coul = 184.91213739934253
init E= -504.486438988816
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674700413240727  LUMO = 9.1827173540068
  mo_energy =
[-1.21707144e+02 -1.33874780e+01 -7.62804454e+00 -7.62804454e+00
 -7.62804454e+00 -1.64017087e+00 -6.74700413e-01 -6.74700413e-01
 -6.74700413e-01  9.18271735e+00  1.08651763e+02  6.03214476e+02
  2.74291191e+03  1.22222188e+04  4.08438384e+04  1.04887545e+05
  2.30071027e+05  4.55885991e+05  8.44838269e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.0703653349129  E_coul = 199.13173697692568
cycle= 1 E= -507.938628357987  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.60219
diis-c [-0.36263247  1.        ]
  HOMO = -0.233101150884961  LUMO = 10.0918587995105
  mo_energy =
[-1.20256438e+02 -1.23512611e+01 -6.64600925e+00 -6.64600925e+00
 -6.64600925e+00 -1.16148024e+00 -2.33101151e-01 -2.33101151e-01
 -2.33101151e-01  1.00918588e+01  1.10000895e+02  6.04651054e+02
  2.74428312e+03  1.22234786e+04  4.08450309e+04  1.04888700e+05
  2.30072158e+05  4.55887105e+05  8.44839370e+05  1.52801664e+06
  2.85028404e+06  5.80817133e+06]
E1 = -706.7162368804143  E_coul = 198.771217797653
cycle= 2 E= -507.945019082761  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152566
diis-c [-2.24157904e-04  4.84921808e-03  9.95150782e-01]
  HOMO = -0.237562205725563  LUMO = 10.0809345378357
  mo_energy =
[-1.20314264e+02 -1.23736682e+01 -6.67388820e+00 -6.67388820e+00
 -6.67388820e+00 -1.16374776e+00 -2.37562206e-01 -2.37562206e-01
 -2.37562206e-01  1.00809345e+01  1.09957407e+02  6.04589922e+02
  2.74420914e+03  1.22233964e+04  4.08449457e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839282e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.7015684352111  E_coul = 198.7565372596477
cycle= 3 E= -507.945031175563  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739955
diis-c [-1.26727340e-08  3.76763004e-05 -5.00647169e-02  1.05002704e+00]
  HOMO = -0.237788856382123  LUMO = 10.080391749155
  mo_energy =
[-1.20316865e+02 -1.23747789e+01 -6.67524614e+00 -6.67524614e+00
 -6.67524614e+00 -1.16385835e+00 -2.37788856e-01 -2.37788856e-01
 -2.37788856e-01  1.00803917e+01  1.09955383e+02  6.04587248e+02
  2.74420609e+03  1.22233931e+04  4.08449423e+04  1.04888610e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7008307816367  E_coul = 198.75579957584873
cycle= 4 E= -507.945031205788  delta_E= -3.02e-08  |g|= 6.28e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46867e-06
diis-c [-4.72056404e-12 -1.76585704e-06  2.30445012e-03 -4.57923419e-02
  1.04348966e+00]
  HOMO = -0.237789609364211  LUMO = 10.0803909833173
  mo_energy =
[-1.20316863e+02 -1.23747813e+01 -6.67524773e+00 -6.67524773e+00
 -6.67524773e+00 -1.16385878e+00 -2.37789609e-01 -2.37789609e-01
 -2.37789609e-01  1.00803910e+01  1.09955384e+02  6.04587250e+02
  2.74420609e+03  1.22233931e+04  4.08449423e+04  1.04888610e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7008296659292  E_coul = 198.75579846013943
cycle= 5 E= -507.94503120579  delta_E= -1.82e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7008296659292  E_coul = 198.75579846013943
  HOMO = -0.237789643436398  LUMO = 10.0803909135849
  mo_energy =
[-1.20316863e+02 -1.23747815e+01 -6.67524790e+00 -6.67524790e+00
 -6.67524790e+00 -1.16385880e+00 -2.37789643e-01 -2.37789643e-01
 -2.37789643e-01  1.00803909e+01  1.09955383e+02  6.04587250e+02
  2.74420609e+03  1.22233931e+04  4.08449423e+04  1.04888610e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7008295726189  E_coul = 198.7557983668295
Extra cycle  E= -507.945031205789  delta_E= 3.41e-13  |g|= 7.41e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907706.1100953228
E1 = -706.7008295726189  E_coul = 198.7557983668295
init E= -507.945031205789
    CPU time for initialize scf      1.30 sec, wall time      0.08 sec
  HOMO = -0.237789645044159  LUMO = 10.0803909104905
  mo_energy =
[-1.20316863e+02 -1.23747815e+01 -6.67524791e+00 -6.67524791e+00
 -6.67524791e+00 -1.16385880e+00 -2.37789645e-01 -2.37789645e-01
 -2.37789645e-01  1.00803909e+01  1.09955383e+02  6.04587250e+02
  2.74420609e+03  1.22233931e+04  4.08449423e+04  1.04888610e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7008295684085  E_coul = 198.755798362619
cycle= 1 E= -507.94503120579  delta_E= -1.14e-13  |g|= 2.03e-09  |ddm|= 3.58e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
E1 = -706.7008295684085  E_coul = 198.755798362619
  HOMO = -0.237789645122589  LUMO = 10.0803909103474
  mo_energy =
[-1.20316863e+02 -1.23747815e+01 -6.67524791e+00 -6.67524791e+00
 -6.67524791e+00 -1.16385880e+00 -2.37789645e-01 -2.37789645e-01
 -2.37789645e-01  1.00803909e+01  1.09955383e+02  6.04587250e+02
  2.74420609e+03  1.22233931e+04  4.08449423e+04  1.04888610e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7008295682117  E_coul = 198.7557983624223
Extra cycle  E= -507.945031205789  delta_E= 1.14e-13  |g|= 8.44e-10  |ddm|= 1.81e-10
    CPU time for scf_cycle      1.49 sec, wall time      0.15 sec
exp = [1.17616814e+05 3.96644588e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349257e+03 1.83758108e+04 1.44977738e+03 3.73961180e+02
 1.13325511e+02 3.77660169e+01 8.08997670e+00 3.20427229e+00
 8.60389240e+00 4.93014202e-01]
grad_E = [ 4.15856243e-09  1.28527036e-04  1.84761747e-11  1.12001056e-10
  6.47024698e-10  2.53716627e-09  1.05397404e-08  5.67265675e-08
  3.56617710e-06  1.21704818e-07  6.21659416e-06 -1.63585229e-05
  2.94324609e-05 -2.58885789e-05  3.67592248e-05 -1.22845704e-04
  3.98912029e-06  2.93952490e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:33:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814262        1
[INPUT] 0    0    [1    /1   ]  0.396639368286       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.421021         1
[INPUT] 0    0    [1    /1   ]  36754.7203124        1
[INPUT] 0    0    [1    /1   ]  7303.49252983        1
[INPUT] 0    0    [1    /1   ]  18375.8107837        1
[INPUT] 0    0    [1    /1   ]  1449.77732087        1
[INPUT] 0    0    [1    /1   ]  373.96135022         1
[INPUT] 0    0    [1    /1   ]  113.325170832        1
[INPUT] 0    0    [1    /1   ]  37.7664069991        1
[INPUT] 0    0    [1    /1   ]  8.08993413307        1
[INPUT] 0    0    [1    /1   ]  3.20427146938        1
[INPUT] 1    0    [1    /1   ]  8.60388411532        1
[INPUT] 1    0    [1    /1   ]  0.493003111282       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426171774, 1.0]], [0, [0.3966393682859131, 1.0]], [0, [1176168.1426189765, 1.0]], [0, [588084.0699931004, 1.0]], [0, [294042.03113498044, 1.0]], [0, [147020.99215992895, 1.0]], [0, [73510.42102102311, 1.0]], [0, [36754.72031243429, 1.0]], [0, [7303.492529828375, 1.0]], [0, [18375.810783672925, 1.0]], [0, [1449.777320868822, 1.0]], [0, [373.96135021978495, 1.0]], [0, [113.32517083180493, 1.0]], [0, [37.76640699912187, 1.0]], [0, [8.089934133066908, 1.0]], [0, [3.2042714693832064, 1.0]], [1, [8.603884115318985, 1.0]], [1, [0.49300311128223995, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426172]
bas 1, expnt(s) = [0.39663937]
bas 2, expnt(s) = [1176168.14261898]
bas 3, expnt(s) = [588084.0699931]
bas 4, expnt(s) = [294042.03113498]
bas 5, expnt(s) = [147020.99215993]
bas 6, expnt(s) = [73510.42102102]
bas 7, expnt(s) = [36754.72031243]
bas 8, expnt(s) = [7303.49252983]
bas 9, expnt(s) = [18375.81078367]
bas 10, expnt(s) = [1449.77732087]
bas 11, expnt(s) = [373.96135022]
bas 12, expnt(s) = [113.32517083]
bas 13, expnt(s) = [37.766407]
bas 14, expnt(s) = [8.08993413]
bas 15, expnt(s) = [3.20427147]
bas 16, expnt(s) = [8.60388412]
bas 17, expnt(s) = [0.49300311]
CPU time:        40.32
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96639368e-01 1.26273404e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349253e+03 1.99601117e+03 1.83758108e+04 3.98749275e+03
 1.44977732e+03 5.93596048e+02 3.73961350e+02 2.14849854e+02
 1.13325171e+02 8.77525632e+01 3.77664070e+01 3.84896778e+01
 8.08993413e+00 1.21191947e+01 3.20427147e+00 6.05078890e+00
 8.60388412e+00 4.29885288e+01 4.93003111e-01 1.20516488e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32510178963936
cond(S) = 907706.1129693524
E1 = -689.39807747685  E_coul = 184.9117028144533
init E= -504.486374662397
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.67471526582217  LUMO = 9.18262940946225
  mo_energy =
[-1.21707185e+02 -1.33875143e+01 -7.62807155e+00 -7.62807155e+00
 -7.62807155e+00 -1.64018042e+00 -6.74715266e-01 -6.74715266e-01
 -6.74715266e-01  9.18262941e+00  1.08652133e+02  6.03214951e+02
  2.74291233e+03  1.22222191e+04  4.08438386e+04  1.04887545e+05
  2.30071027e+05  4.55885992e+05  8.44838269e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.0696696819285  E_coul = 199.13104130381654
cycle= 1 E= -507.938628378112  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602189
diis-c [-0.36263213  1.        ]
  HOMO = -0.233129063651827  LUMO = 10.091755654476
  mo_energy =
[-1.20256498e+02 -1.23513144e+01 -6.64605265e+00 -6.64605265e+00
 -6.64605265e+00 -1.16150070e+00 -2.33129064e-01 -2.33129064e-01
 -2.33129064e-01  1.00917557e+01  1.10001248e+02  6.04651511e+02
  2.74428352e+03  1.22234789e+04  4.08450311e+04  1.04888700e+05
  2.30072158e+05  4.55887106e+05  8.44839370e+05  1.52801664e+06
  2.85028404e+06  5.80817133e+06]
E1 = -706.715540580209  E_coul = 198.77052147201744
cycle= 2 E= -507.945019108192  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152565
diis-c [-2.24154966e-04  4.84926860e-03  9.95150731e-01]
  HOMO = -0.237590034295632  LUMO = 10.0808313616449
  mo_energy =
[-1.20314325e+02 -1.23737215e+01 -6.67393174e+00 -6.67393174e+00
 -6.67393174e+00 -1.16376824e+00 -2.37590034e-01 -2.37590034e-01
 -2.37590034e-01  1.00808314e+01  1.09957760e+02  6.04590379e+02
  2.74420954e+03  1.22233967e+04  4.08449459e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839282e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.7008720884021  E_coul = 198.7558408873482
cycle= 3 E= -507.945031201054  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739953
diis-c [-1.26728215e-08  3.76759991e-05 -5.00648226e-02  1.05002715e+00]
  HOMO = -0.237816681494916  LUMO = 10.0802885701266
  mo_energy =
[-1.20316925e+02 -1.23748323e+01 -6.67528969e+00 -6.67528969e+00
 -6.67528969e+00 -1.16387883e+00 -2.37816681e-01 -2.37816681e-01
 -2.37816681e-01  1.00802886e+01  1.09955736e+02  6.04587704e+02
  2.74420649e+03  1.22233934e+04  4.08449425e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7001344305422  E_coul = 198.7551031992637
cycle= 4 E= -507.945031231279  delta_E= -3.02e-08  |g|= 6.28e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46933e-06
diis-c [-4.72359260e-12 -1.76564764e-06  2.30466887e-03 -4.57968156e-02
  1.04349391e+00]
  HOMO = -0.237817434485329  LUMO = 10.0802878042746
  mo_energy =
[-1.20316923e+02 -1.23748347e+01 -6.67529128e+00 -6.67529128e+00
 -6.67529128e+00 -1.16387926e+00 -2.37817434e-01 -2.37817434e-01
 -2.37817434e-01  1.00802878e+01  1.09955737e+02  6.04587707e+02
  2.74420649e+03  1.22233934e+04  4.08449425e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7001333148042  E_coul = 198.75510208352463
cycle= 5 E= -507.94503123128  delta_E= -1.02e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7001333148042  E_coul = 198.75510208352463
  HOMO = -0.237817468556278  LUMO = 10.0802877345402
  mo_energy =
[-1.20316924e+02 -1.23748349e+01 -6.67529146e+00 -6.67529146e+00
 -6.67529146e+00 -1.16387928e+00 -2.37817469e-01 -2.37817469e-01
 -2.37817469e-01  1.00802877e+01  1.09955736e+02  6.04587707e+02
  2.74420649e+03  1.22233934e+04  4.08449425e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7001332215018  E_coul = 198.75510199022236
Extra cycle  E= -507.945031231279  delta_E= 1.14e-13  |g|= 7.51e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
exp = [1.17616814e+05 3.96639368e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349253e+03 1.83758108e+04 1.44977732e+03 3.73961350e+02
 1.13325171e+02 3.77664070e+01 8.08993413e+00 3.20427147e+00
 8.60388412e+00 4.93003111e-01]
E = -507.9450312312795
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:33:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814262        1
[INPUT] 0    0    [1    /1   ]  0.396639368286       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.421021         1
[INPUT] 0    0    [1    /1   ]  36754.7203124        1
[INPUT] 0    0    [1    /1   ]  7303.49252983        1
[INPUT] 0    0    [1    /1   ]  18375.8107837        1
[INPUT] 0    0    [1    /1   ]  1449.77732087        1
[INPUT] 0    0    [1    /1   ]  373.96135022         1
[INPUT] 0    0    [1    /1   ]  113.325170832        1
[INPUT] 0    0    [1    /1   ]  37.7664069991        1
[INPUT] 0    0    [1    /1   ]  8.08993413307        1
[INPUT] 0    0    [1    /1   ]  3.20427146938        1
[INPUT] 1    0    [1    /1   ]  8.60388411532        1
[INPUT] 1    0    [1    /1   ]  0.493003111282       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426171774, 1.0]], [0, [0.3966393682859131, 1.0]], [0, [1176168.1426189765, 1.0]], [0, [588084.0699931004, 1.0]], [0, [294042.03113498044, 1.0]], [0, [147020.99215992895, 1.0]], [0, [73510.42102102311, 1.0]], [0, [36754.72031243429, 1.0]], [0, [7303.492529828375, 1.0]], [0, [18375.810783672925, 1.0]], [0, [1449.777320868822, 1.0]], [0, [373.96135021978495, 1.0]], [0, [113.32517083180493, 1.0]], [0, [37.76640699912187, 1.0]], [0, [8.089934133066908, 1.0]], [0, [3.2042714693832064, 1.0]], [1, [8.603884115318985, 1.0]], [1, [0.49300311128223995, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426172]
bas 1, expnt(s) = [0.39663937]
bas 2, expnt(s) = [1176168.14261898]
bas 3, expnt(s) = [588084.0699931]
bas 4, expnt(s) = [294042.03113498]
bas 5, expnt(s) = [147020.99215993]
bas 6, expnt(s) = [73510.42102102]
bas 7, expnt(s) = [36754.72031243]
bas 8, expnt(s) = [7303.49252983]
bas 9, expnt(s) = [18375.81078367]
bas 10, expnt(s) = [1449.77732087]
bas 11, expnt(s) = [373.96135022]
bas 12, expnt(s) = [113.32517083]
bas 13, expnt(s) = [37.766407]
bas 14, expnt(s) = [8.08993413]
bas 15, expnt(s) = [3.20427147]
bas 16, expnt(s) = [8.60388412]
bas 17, expnt(s) = [0.49300311]
CPU time:        40.81
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96639368e-01 1.26273404e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349253e+03 1.99601117e+03 1.83758108e+04 3.98749275e+03
 1.44977732e+03 5.93596048e+02 3.73961350e+02 2.14849854e+02
 1.13325171e+02 8.77525632e+01 3.77664070e+01 3.84896778e+01
 8.08993413e+00 1.21191947e+01 3.20427147e+00 6.05078890e+00
 8.60388412e+00 4.29885288e+01 4.93003111e-01 1.20516488e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32510178963936
cond(S) = 907706.1129693524
E1 = -689.39807747685  E_coul = 184.9117028144533
init E= -504.486374662397
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.67471526582217  LUMO = 9.18262940946225
  mo_energy =
[-1.21707185e+02 -1.33875143e+01 -7.62807155e+00 -7.62807155e+00
 -7.62807155e+00 -1.64018042e+00 -6.74715266e-01 -6.74715266e-01
 -6.74715266e-01  9.18262941e+00  1.08652133e+02  6.03214951e+02
  2.74291233e+03  1.22222191e+04  4.08438386e+04  1.04887545e+05
  2.30071027e+05  4.55885992e+05  8.44838269e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.0696696819285  E_coul = 199.13104130381654
cycle= 1 E= -507.938628378112  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602189
diis-c [-0.36263213  1.        ]
  HOMO = -0.233129063651827  LUMO = 10.091755654476
  mo_energy =
[-1.20256498e+02 -1.23513144e+01 -6.64605265e+00 -6.64605265e+00
 -6.64605265e+00 -1.16150070e+00 -2.33129064e-01 -2.33129064e-01
 -2.33129064e-01  1.00917557e+01  1.10001248e+02  6.04651511e+02
  2.74428352e+03  1.22234789e+04  4.08450311e+04  1.04888700e+05
  2.30072158e+05  4.55887106e+05  8.44839370e+05  1.52801664e+06
  2.85028404e+06  5.80817133e+06]
E1 = -706.715540580209  E_coul = 198.77052147201744
cycle= 2 E= -507.945019108192  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152565
diis-c [-2.24154966e-04  4.84926860e-03  9.95150731e-01]
  HOMO = -0.237590034295632  LUMO = 10.0808313616449
  mo_energy =
[-1.20314325e+02 -1.23737215e+01 -6.67393174e+00 -6.67393174e+00
 -6.67393174e+00 -1.16376824e+00 -2.37590034e-01 -2.37590034e-01
 -2.37590034e-01  1.00808314e+01  1.09957760e+02  6.04590379e+02
  2.74420954e+03  1.22233967e+04  4.08449459e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839282e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.7008720884021  E_coul = 198.7558408873482
cycle= 3 E= -507.945031201054  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739953
diis-c [-1.26728215e-08  3.76759991e-05 -5.00648226e-02  1.05002715e+00]
  HOMO = -0.237816681494916  LUMO = 10.0802885701266
  mo_energy =
[-1.20316925e+02 -1.23748323e+01 -6.67528969e+00 -6.67528969e+00
 -6.67528969e+00 -1.16387883e+00 -2.37816681e-01 -2.37816681e-01
 -2.37816681e-01  1.00802886e+01  1.09955736e+02  6.04587704e+02
  2.74420649e+03  1.22233934e+04  4.08449425e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7001344305422  E_coul = 198.7551031992637
cycle= 4 E= -507.945031231279  delta_E= -3.02e-08  |g|= 6.28e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46933e-06
diis-c [-4.72359260e-12 -1.76564764e-06  2.30466887e-03 -4.57968156e-02
  1.04349391e+00]
  HOMO = -0.237817434485329  LUMO = 10.0802878042746
  mo_energy =
[-1.20316923e+02 -1.23748347e+01 -6.67529128e+00 -6.67529128e+00
 -6.67529128e+00 -1.16387926e+00 -2.37817434e-01 -2.37817434e-01
 -2.37817434e-01  1.00802878e+01  1.09955737e+02  6.04587707e+02
  2.74420649e+03  1.22233934e+04  4.08449425e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7001333148042  E_coul = 198.75510208352463
cycle= 5 E= -507.94503123128  delta_E= -1.02e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7001333148042  E_coul = 198.75510208352463
  HOMO = -0.237817468556278  LUMO = 10.0802877345402
  mo_energy =
[-1.20316924e+02 -1.23748349e+01 -6.67529146e+00 -6.67529146e+00
 -6.67529146e+00 -1.16387928e+00 -2.37817469e-01 -2.37817469e-01
 -2.37817469e-01  1.00802877e+01  1.09955736e+02  6.04587707e+02
  2.74420649e+03  1.22233934e+04  4.08449425e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7001332215018  E_coul = 198.75510199022236
Extra cycle  E= -507.945031231279  delta_E= 1.14e-13  |g|= 7.51e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907706.1129693524
E1 = -706.7001332215018  E_coul = 198.75510199022236
init E= -507.945031231279
    CPU time for initialize scf      1.39 sec, wall time      0.09 sec
  HOMO = -0.237817470163725  LUMO = 10.0802877314446
  mo_energy =
[-1.20316924e+02 -1.23748349e+01 -6.67529146e+00 -6.67529146e+00
 -6.67529146e+00 -1.16387928e+00 -2.37817470e-01 -2.37817470e-01
 -2.37817470e-01  1.00802877e+01  1.09955736e+02  6.04587707e+02
  2.74420649e+03  1.22233934e+04  4.08449425e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7001332172797  E_coul = 198.75510198600034
cycle= 1 E= -507.945031231279  delta_E= 1.14e-13  |g|= 1.3e-09  |ddm|= 3.59e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
E1 = -706.7001332172797  E_coul = 198.75510198600034
  HOMO = -0.237817470242424  LUMO = 10.0802877313015
  mo_energy =
[-1.20316924e+02 -1.23748349e+01 -6.67529146e+00 -6.67529146e+00
 -6.67529146e+00 -1.16387928e+00 -2.37817470e-01 -2.37817470e-01
 -2.37817470e-01  1.00802877e+01  1.09955736e+02  6.04587707e+02
  2.74420649e+03  1.22233934e+04  4.08449425e+04  1.04888611e+05
  2.30072068e+05  4.55887015e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7001332170794  E_coul = 198.75510198579963
Extra cycle  E= -507.94503123128  delta_E= -3.98e-13  |g|= 1.11e-09  |ddm|= 1.85e-10
    CPU time for scf_cycle      1.58 sec, wall time      0.16 sec
exp = [1.17616814e+05 3.96639368e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349253e+03 1.83758108e+04 1.44977732e+03 3.73961350e+02
 1.13325171e+02 3.77664070e+01 8.08993413e+00 3.20427147e+00
 8.60388412e+00 4.93003111e-01]
grad_E = [ 4.15883398e-09  3.22515119e-05  1.84794006e-11  1.12009869e-10
  6.47066737e-10  2.53733408e-09  1.05404477e-08  5.67300564e-08
  3.56642601e-06  1.21715409e-07  6.20250447e-06 -1.61607890e-05
  2.81860154e-05 -2.28392153e-05  3.68504942e-05 -1.25694323e-04
  7.81671623e-06 -1.21000453e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814261        1
[INPUT] 0    0    [1    /1   ]  0.396624026525       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210204        1
[INPUT] 0    0    [1    /1   ]  36754.7203091        1
[INPUT] 0    0    [1    /1   ]  7303.49231894        1
[INPUT] 0    0    [1    /1   ]  18375.8107765        1
[INPUT] 0    0    [1    /1   ]  1449.77695051        1
[INPUT] 0    0    [1    /1   ]  373.962355672        1
[INPUT] 0    0    [1    /1   ]  113.323173482        1
[INPUT] 0    0    [1    /1   ]  37.7686821821        1
[INPUT] 0    0    [1    /1   ]  8.08964958406        1
[INPUT] 0    0    [1    /1   ]  3.20440288343        1
[INPUT] 1    0    [1    /1   ]  8.60385268833        1
[INPUT] 1    0    [1    /1   ]  0.492975294409       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426147181, 1.0]], [0, [0.39662402652463674, 1.0]], [0, [1176168.1426189754, 1.0]], [0, [588084.0699930937, 1.0]], [0, [294042.0311349422, 1.0]], [0, [147020.99215977892, 1.0]], [0, [73510.42102039982, 1.0]], [0, [36754.720309079596, 1.0]], [0, [7303.492318937492, 1.0]], [0, [18375.81077647612, 1.0]], [0, [1449.7769505050849, 1.0]], [0, [373.9623556722401, 1.0]], [0, [113.32317348185195, 1.0]], [0, [37.76868218206059, 1.0]], [0, [8.089649584063492, 1.0]], [0, [3.2044028834276284, 1.0]], [1, [8.603852688333443, 1.0]], [1, [0.4929752944091076, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426147]
bas 1, expnt(s) = [0.39662403]
bas 2, expnt(s) = [1176168.14261898]
bas 3, expnt(s) = [588084.06999309]
bas 4, expnt(s) = [294042.03113494]
bas 5, expnt(s) = [147020.99215978]
bas 6, expnt(s) = [73510.4210204]
bas 7, expnt(s) = [36754.72030908]
bas 8, expnt(s) = [7303.49231894]
bas 9, expnt(s) = [18375.81077648]
bas 10, expnt(s) = [1449.77695051]
bas 11, expnt(s) = [373.96235567]
bas 12, expnt(s) = [113.32317348]
bas 13, expnt(s) = [37.76868218]
bas 14, expnt(s) = [8.08964958]
bas 15, expnt(s) = [3.20440288]
bas 16, expnt(s) = [8.60385269]
bas 17, expnt(s) = [0.49297529]
CPU time:        45.55
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96624027e-01 1.26269741e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349232e+03 1.99601112e+03 1.83758108e+04 3.98749275e+03
 1.44977695e+03 5.93595934e+02 3.73962356e+02 2.14850288e+02
 1.13323173e+02 8.77514033e+01 3.77686822e+01 3.84914169e+01
 8.08964958e+00 1.21188750e+01 3.20440288e+00 6.05097501e+00
 8.60385269e+00 4.29883326e+01 4.92975294e-01 1.20507988e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325140317974203
cond(S) = 907706.1341078198
E1 = -689.3967222522671  E_coul = 184.91055525343626
init E= -504.486166998831
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674752549224438  LUMO = 9.18262242239939
  mo_energy =
[-1.21707300e+02 -1.33876093e+01 -7.62814339e+00 -7.62814339e+00
 -7.62814339e+00 -1.64020659e+00 -6.74752549e-01 -6.74752549e-01
 -6.74752549e-01  9.18262242e+00  1.08654923e+02  6.03218241e+02
  2.74291523e+03  1.22222214e+04  4.08438402e+04  1.04887546e+05
  2.30071028e+05  4.55885993e+05  8.44838270e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.067915716007  E_coul = 199.1292869786707
cycle= 1 E= -507.938628737336  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602188
diis-c [-0.36263052  1.        ]
  HOMO = -0.233198779081745  LUMO = 10.0917168167316
  mo_energy =
[-1.20256652e+02 -1.23514488e+01 -6.64616166e+00 -6.64616166e+00
 -6.64616166e+00 -1.16155375e+00 -2.33198779e-01 -2.33198779e-01
 -2.33198779e-01  1.00917168e+01  1.10004004e+02  6.04654766e+02
  2.74428639e+03  1.22234811e+04  4.08450327e+04  1.04888702e+05
  2.30072159e+05  4.55887106e+05  8.44839371e+05  1.52801664e+06
  2.85028404e+06  5.80817133e+06]
E1 = -706.7137969318768  E_coul = 198.76877771678897
cycle= 2 E= -507.945019215088  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152558
diis-c [-2.24133921e-04  4.84945546e-03  9.95150545e-01]
  HOMO = -0.237659367387311  LUMO = 10.0807927406558
  mo_energy =
[-1.20314477e+02 -1.23738555e+01 -6.67404012e+00 -6.67404012e+00
 -6.67404012e+00 -1.16382121e+00 -2.37659367e-01 -2.37659367e-01
 -2.37659367e-01  1.00807927e+01  1.09960517e+02  6.04593636e+02
  2.74421242e+03  1.22233989e+04  4.08449475e+04  1.04888615e+05
  2.30072072e+05  4.55887019e+05  8.44839283e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.6991288733377  E_coul = 198.75409756586114
cycle= 3 E= -507.945031307477  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739924
diis-c [-1.26702312e-08  3.76766525e-05 -5.00651555e-02  1.05002748e+00]
  HOMO = -0.237885996156026  LUMO = 10.0802499582389
  mo_energy =
[-1.20317077e+02 -1.23749662e+01 -6.67539804e+00 -6.67539804e+00
 -6.67539804e+00 -1.16393180e+00 -2.37885996e-01 -2.37885996e-01
 -2.37885996e-01  1.00802500e+01  1.09958493e+02  6.04590962e+02
  2.74420936e+03  1.22233957e+04  4.08449441e+04  1.04888612e+05
  2.30072069e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6983912347742  E_coul = 198.75335989707398
cycle= 4 E= -507.9450313377  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46847e-06
diis-c [-4.72062629e-12 -1.76615030e-06  2.30458281e-03 -4.57946374e-02
  1.04349182e+00]
  HOMO = -0.237886749052606  LUMO = 10.0802491924777
  mo_energy =
[-1.20317075e+02 -1.23749687e+01 -6.67539964e+00 -6.67539964e+00
 -6.67539964e+00 -1.16393223e+00 -2.37886749e-01 -2.37886749e-01
 -2.37886749e-01  1.00802492e+01  1.09958493e+02  6.04590964e+02
  2.74420937e+03  1.22233957e+04  4.08449441e+04  1.04888612e+05
  2.30072069e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6983901191884  E_coul = 198.75335878148718
cycle= 5 E= -507.945031337701  delta_E= -9.66e-13  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6983901191884  E_coul = 198.75335878148718
  HOMO = -0.237886783119933  LUMO = 10.0802491227479
  mo_energy =
[-1.20317075e+02 -1.23749688e+01 -6.67539981e+00 -6.67539981e+00
 -6.67539981e+00 -1.16393224e+00 -2.37886783e-01 -2.37886783e-01
 -2.37886783e-01  1.00802491e+01  1.09958493e+02  6.04590964e+02
  2.74420937e+03  1.22233957e+04  4.08449441e+04  1.04888612e+05
  2.30072069e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6983900258857  E_coul = 198.75335868818433
Extra cycle  E= -507.945031337701  delta_E= -1.71e-13  |g|= 7.29e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
exp = [1.17616814e+05 3.96624027e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349232e+03 1.83758108e+04 1.44977695e+03 3.73962356e+02
 1.13323173e+02 3.77686822e+01 8.08964958e+00 3.20440288e+00
 8.60385269e+00 4.92975294e-01]
E = -507.9450313377014
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814261        1
[INPUT] 0    0    [1    /1   ]  0.396624026525       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210204        1
[INPUT] 0    0    [1    /1   ]  36754.7203091        1
[INPUT] 0    0    [1    /1   ]  7303.49231894        1
[INPUT] 0    0    [1    /1   ]  18375.8107765        1
[INPUT] 0    0    [1    /1   ]  1449.77695051        1
[INPUT] 0    0    [1    /1   ]  373.962355672        1
[INPUT] 0    0    [1    /1   ]  113.323173482        1
[INPUT] 0    0    [1    /1   ]  37.7686821821        1
[INPUT] 0    0    [1    /1   ]  8.08964958406        1
[INPUT] 0    0    [1    /1   ]  3.20440288343        1
[INPUT] 1    0    [1    /1   ]  8.60385268833        1
[INPUT] 1    0    [1    /1   ]  0.492975294409       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426147181, 1.0]], [0, [0.39662402652463674, 1.0]], [0, [1176168.1426189754, 1.0]], [0, [588084.0699930937, 1.0]], [0, [294042.0311349422, 1.0]], [0, [147020.99215977892, 1.0]], [0, [73510.42102039982, 1.0]], [0, [36754.720309079596, 1.0]], [0, [7303.492318937492, 1.0]], [0, [18375.81077647612, 1.0]], [0, [1449.7769505050849, 1.0]], [0, [373.9623556722401, 1.0]], [0, [113.32317348185195, 1.0]], [0, [37.76868218206059, 1.0]], [0, [8.089649584063492, 1.0]], [0, [3.2044028834276284, 1.0]], [1, [8.603852688333443, 1.0]], [1, [0.4929752944091076, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426147]
bas 1, expnt(s) = [0.39662403]
bas 2, expnt(s) = [1176168.14261898]
bas 3, expnt(s) = [588084.06999309]
bas 4, expnt(s) = [294042.03113494]
bas 5, expnt(s) = [147020.99215978]
bas 6, expnt(s) = [73510.4210204]
bas 7, expnt(s) = [36754.72030908]
bas 8, expnt(s) = [7303.49231894]
bas 9, expnt(s) = [18375.81077648]
bas 10, expnt(s) = [1449.77695051]
bas 11, expnt(s) = [373.96235567]
bas 12, expnt(s) = [113.32317348]
bas 13, expnt(s) = [37.76868218]
bas 14, expnt(s) = [8.08964958]
bas 15, expnt(s) = [3.20440288]
bas 16, expnt(s) = [8.60385269]
bas 17, expnt(s) = [0.49297529]
CPU time:        46.04
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96624027e-01 1.26269741e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349232e+03 1.99601112e+03 1.83758108e+04 3.98749275e+03
 1.44977695e+03 5.93595934e+02 3.73962356e+02 2.14850288e+02
 1.13323173e+02 8.77514033e+01 3.77686822e+01 3.84914169e+01
 8.08964958e+00 1.21188750e+01 3.20440288e+00 6.05097501e+00
 8.60385269e+00 4.29883326e+01 4.92975294e-01 1.20507988e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325140317974203
cond(S) = 907706.1341078198
E1 = -689.3967222522671  E_coul = 184.91055525343626
init E= -504.486166998831
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674752549224438  LUMO = 9.18262242239939
  mo_energy =
[-1.21707300e+02 -1.33876093e+01 -7.62814339e+00 -7.62814339e+00
 -7.62814339e+00 -1.64020659e+00 -6.74752549e-01 -6.74752549e-01
 -6.74752549e-01  9.18262242e+00  1.08654923e+02  6.03218241e+02
  2.74291523e+03  1.22222214e+04  4.08438402e+04  1.04887546e+05
  2.30071028e+05  4.55885993e+05  8.44838270e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.067915716007  E_coul = 199.1292869786707
cycle= 1 E= -507.938628737336  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602188
diis-c [-0.36263052  1.        ]
  HOMO = -0.233198779081745  LUMO = 10.0917168167316
  mo_energy =
[-1.20256652e+02 -1.23514488e+01 -6.64616166e+00 -6.64616166e+00
 -6.64616166e+00 -1.16155375e+00 -2.33198779e-01 -2.33198779e-01
 -2.33198779e-01  1.00917168e+01  1.10004004e+02  6.04654766e+02
  2.74428639e+03  1.22234811e+04  4.08450327e+04  1.04888702e+05
  2.30072159e+05  4.55887106e+05  8.44839371e+05  1.52801664e+06
  2.85028404e+06  5.80817133e+06]
E1 = -706.7137969318768  E_coul = 198.76877771678897
cycle= 2 E= -507.945019215088  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152558
diis-c [-2.24133921e-04  4.84945546e-03  9.95150545e-01]
  HOMO = -0.237659367387311  LUMO = 10.0807927406558
  mo_energy =
[-1.20314477e+02 -1.23738555e+01 -6.67404012e+00 -6.67404012e+00
 -6.67404012e+00 -1.16382121e+00 -2.37659367e-01 -2.37659367e-01
 -2.37659367e-01  1.00807927e+01  1.09960517e+02  6.04593636e+02
  2.74421242e+03  1.22233989e+04  4.08449475e+04  1.04888615e+05
  2.30072072e+05  4.55887019e+05  8.44839283e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.6991288733377  E_coul = 198.75409756586114
cycle= 3 E= -507.945031307477  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739924
diis-c [-1.26702312e-08  3.76766525e-05 -5.00651555e-02  1.05002748e+00]
  HOMO = -0.237885996156026  LUMO = 10.0802499582389
  mo_energy =
[-1.20317077e+02 -1.23749662e+01 -6.67539804e+00 -6.67539804e+00
 -6.67539804e+00 -1.16393180e+00 -2.37885996e-01 -2.37885996e-01
 -2.37885996e-01  1.00802500e+01  1.09958493e+02  6.04590962e+02
  2.74420936e+03  1.22233957e+04  4.08449441e+04  1.04888612e+05
  2.30072069e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6983912347742  E_coul = 198.75335989707398
cycle= 4 E= -507.9450313377  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46847e-06
diis-c [-4.72062629e-12 -1.76615030e-06  2.30458281e-03 -4.57946374e-02
  1.04349182e+00]
  HOMO = -0.237886749052606  LUMO = 10.0802491924777
  mo_energy =
[-1.20317075e+02 -1.23749687e+01 -6.67539964e+00 -6.67539964e+00
 -6.67539964e+00 -1.16393223e+00 -2.37886749e-01 -2.37886749e-01
 -2.37886749e-01  1.00802492e+01  1.09958493e+02  6.04590964e+02
  2.74420937e+03  1.22233957e+04  4.08449441e+04  1.04888612e+05
  2.30072069e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6983901191884  E_coul = 198.75335878148718
cycle= 5 E= -507.945031337701  delta_E= -9.66e-13  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6983901191884  E_coul = 198.75335878148718
  HOMO = -0.237886783119933  LUMO = 10.0802491227479
  mo_energy =
[-1.20317075e+02 -1.23749688e+01 -6.67539981e+00 -6.67539981e+00
 -6.67539981e+00 -1.16393224e+00 -2.37886783e-01 -2.37886783e-01
 -2.37886783e-01  1.00802491e+01  1.09958493e+02  6.04590964e+02
  2.74420937e+03  1.22233957e+04  4.08449441e+04  1.04888612e+05
  2.30072069e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6983900258857  E_coul = 198.75335868818433
Extra cycle  E= -507.945031337701  delta_E= -1.71e-13  |g|= 7.29e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907706.1341078198
E1 = -706.6983900258857  E_coul = 198.75335868818433
init E= -507.945031337701
    CPU time for initialize scf      1.44 sec, wall time      0.09 sec
  HOMO = -0.237886784727433  LUMO = 10.0802491196527
  mo_energy =
[-1.20317075e+02 -1.23749689e+01 -6.67539982e+00 -6.67539982e+00
 -6.67539982e+00 -1.16393225e+00 -2.37886785e-01 -2.37886785e-01
 -2.37886785e-01  1.00802491e+01  1.09958493e+02  6.04590964e+02
  2.74420937e+03  1.22233957e+04  4.08449441e+04  1.04888612e+05
  2.30072069e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6983900216767  E_coul = 198.75335868397522
cycle= 1 E= -507.945031337701  delta_E= -1.14e-13  |g|= 9.13e-10  |ddm|= 3.58e-09
    CPU time for cycle= 1      0.10 sec, wall time      0.02 sec
E1 = -706.6983900216767  E_coul = 198.75335868397522
  HOMO = -0.237886784805862  LUMO = 10.0802491195097
  mo_energy =
[-1.20317075e+02 -1.23749689e+01 -6.67539982e+00 -6.67539982e+00
 -6.67539982e+00 -1.16393225e+00 -2.37886785e-01 -2.37886785e-01
 -2.37886785e-01  1.00802491e+01  1.09958493e+02  6.04590964e+02
  2.74420937e+03  1.22233957e+04  4.08449441e+04  1.04888612e+05
  2.30072069e+05  4.55887015e+05  8.44839279e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6983900214808  E_coul = 198.75335868377908
Extra cycle  E= -507.945031337702  delta_E= -2.27e-13  |g|= 1.37e-09  |ddm|= 1.81e-10
    CPU time for scf_cycle      1.60 sec, wall time      0.17 sec
exp = [1.17616814e+05 3.96624027e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349232e+03 1.83758108e+04 1.44977695e+03 3.73962356e+02
 1.13323173e+02 3.77686822e+01 8.08964958e+00 3.20440288e+00
 8.60385269e+00 4.92975294e-01]
grad_E = [ 4.16040166e-09 -2.18727358e-04  1.84980169e-11  1.12060751e-10
  6.47309420e-10  2.53830288e-09  1.05445312e-08  5.67501968e-08
  3.56786194e-06  1.21776576e-07  6.12137703e-06 -1.50253974e-05
  2.11192366e-05 -6.16021487e-06  2.70419010e-05 -1.04288290e-04
  1.01312553e-05 -1.14256185e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:03 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814261        1
[INPUT] 0    0    [1    /1   ]  0.396619897151       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210198        1
[INPUT] 0    0    [1    /1   ]  36754.7203058        1
[INPUT] 0    0    [1    /1   ]  7303.4921104         1
[INPUT] 0    0    [1    /1   ]  18375.8107694        1
[INPUT] 0    0    [1    /1   ]  1449.77658446        1
[INPUT] 0    0    [1    /1   ]  373.963347386        1
[INPUT] 0    0    [1    /1   ]  113.321214375        1
[INPUT] 0    0    [1    /1   ]  37.7708918014        1
[INPUT] 0    0    [1    /1   ]  8.0893487909         1
[INPUT] 0    0    [1    /1   ]  3.20463003595        1
[INPUT] 1    0    [1    /1   ]  8.60384356335        1
[INPUT] 1    0    [1    /1   ]  0.492975075374       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426122863, 1.0]], [0, [0.39661989715051554, 1.0]], [0, [1176168.1426189742, 1.0]], [0, [588084.0699930872, 1.0]], [0, [294042.03113490436, 1.0]], [0, [147020.99215963055, 1.0]], [0, [73510.42101978349, 1.0]], [0, [36754.72030576238, 1.0]], [0, [7303.4921104023815, 1.0]], [0, [18375.810769359676, 1.0]], [0, [1449.776584461173, 1.0]], [0, [373.9633473861032, 1.0]], [0, [113.3212143750439, 1.0]], [0, [37.77089180137749, 1.0]], [0, [8.089348790903864, 1.0]], [0, [3.204630035947306, 1.0]], [1, [8.603843563348004, 1.0]], [1, [0.4929750753741682, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426123]
bas 1, expnt(s) = [0.3966199]
bas 2, expnt(s) = [1176168.14261897]
bas 3, expnt(s) = [588084.06999309]
bas 4, expnt(s) = [294042.0311349]
bas 5, expnt(s) = [147020.99215963]
bas 6, expnt(s) = [73510.42101978]
bas 7, expnt(s) = [36754.72030576]
bas 8, expnt(s) = [7303.4921104]
bas 9, expnt(s) = [18375.81076936]
bas 10, expnt(s) = [1449.77658446]
bas 11, expnt(s) = [373.96334739]
bas 12, expnt(s) = [113.32121438]
bas 13, expnt(s) = [37.7708918]
bas 14, expnt(s) = [8.08934879]
bas 15, expnt(s) = [3.20463004]
bas 16, expnt(s) = [8.60384356]
bas 17, expnt(s) = [0.49297508]
CPU time:        50.86
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96619897e-01 1.26268755e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349211e+03 1.99601108e+03 1.83758108e+04 3.98749275e+03
 1.44977658e+03 5.93595821e+02 3.73963347e+02 2.14850715e+02
 1.13321214e+02 8.77502655e+01 3.77708918e+01 3.84931058e+01
 8.08934879e+00 1.21185371e+01 3.20463004e+00 6.05129672e+00
 8.60384356e+00 4.29882756e+01 4.92975075e-01 1.20507921e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325141015208274
cond(S) = 907706.1579642064
E1 = -689.3965740069834  E_coul = 184.91048785149547
init E= -504.486086155488
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674753069240201  LUMO = 9.18298738436646
  mo_energy =
[-1.21707311e+02 -1.33876137e+01 -7.62814813e+00 -7.62814813e+00
 -7.62814813e+00 -1.64021034e+00 -6.74753069e-01 -6.74753069e-01
 -6.74753069e-01  9.18298738e+00  1.08658100e+02  6.03221814e+02
  2.74291839e+03  1.22222239e+04  4.08438421e+04  1.04887548e+05
  2.30071030e+05  4.55885994e+05  8.44838271e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.067927361369  E_coul = 199.12929810964908
cycle= 1 E= -507.93862925172  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602187
diis-c [-0.36262934  1.        ]
  HOMO = -0.23319894165998  LUMO = 10.0920923664188
  mo_energy =
[-1.20256649e+02 -1.23514481e+01 -6.64615983e+00 -6.64615983e+00
 -6.64615983e+00 -1.16155692e+00 -2.33198942e-01 -2.33198942e-01
 -2.33198942e-01  1.00920924e+01  1.10007198e+02  6.04658356e+02
  2.74428957e+03  1.22234837e+04  4.08450345e+04  1.04888703e+05
  2.30072161e+05  4.55887108e+05  8.44839372e+05  1.52801664e+06
  2.85028404e+06  5.80817134e+06]
E1 = -706.7138285844734  E_coul = 198.76880929700368
cycle= 2 E= -507.94501928747  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152551
diis-c [-2.24111179e-04  4.84955672e-03  9.95150443e-01]
  HOMO = -0.237659241084615  LUMO = 10.0811687818801
  mo_energy =
[-1.20314471e+02 -1.23738536e+01 -6.67403664e+00 -6.67403664e+00
 -6.67403664e+00 -1.16382421e+00 -2.37659241e-01 -2.37659241e-01
 -2.37659241e-01  1.00811688e+01  1.09963714e+02  6.04597229e+02
  2.74421560e+03  1.22234015e+04  4.08449493e+04  1.04888617e+05
  2.30072074e+05  4.55887020e+05  8.44839284e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.6991614533584  E_coul = 198.75413007454864
cycle= 3 E= -507.94503137881  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739888
diis-c [-1.26655388e-08  3.76763020e-05 -5.00652339e-02  1.05002756e+00]
  HOMO = -0.237885853288255  LUMO = 10.0806260266948
  mo_energy =
[-1.20317071e+02 -1.23749642e+01 -6.67539448e+00 -6.67539448e+00
 -6.67539448e+00 -1.16393479e+00 -2.37885853e-01 -2.37885853e-01
 -2.37885853e-01  1.00806260e+01  1.09961690e+02  6.04594555e+02
  2.74421254e+03  1.22233982e+04  4.08449460e+04  1.04888613e+05
  2.30072070e+05  4.55887017e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6984238656931  E_coul = 198.7533924566633
cycle= 4 E= -507.94503140903  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46726e-06
diis-c [-4.71957393e-12 -1.76586280e-06  2.30440249e-03 -4.57909010e-02
  1.04348826e+00]
  HOMO = -0.237886605983066  LUMO = 10.0806252611852
  mo_energy =
[-1.20317069e+02 -1.23749667e+01 -6.67539607e+00 -6.67539607e+00
 -6.67539607e+00 -1.16393522e+00 -2.37886606e-01 -2.37886606e-01
 -2.37886606e-01  1.00806253e+01  1.09961690e+02  6.04594558e+02
  2.74421255e+03  1.22233982e+04  4.08449460e+04  1.04888613e+05
  2.30072070e+05  4.55887017e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6984227505478  E_coul = 198.7533913415159
cycle= 5 E= -507.945031409032  delta_E= -2.05e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6984227505478  E_coul = 198.7533913415159
  HOMO = -0.237886640046675  LUMO = 10.0806251914618
  mo_energy =
[-1.20317069e+02 -1.23749668e+01 -6.67539625e+00 -6.67539625e+00
 -6.67539625e+00 -1.16393524e+00 -2.37886640e-01 -2.37886640e-01
 -2.37886640e-01  1.00806252e+01  1.09961690e+02  6.04594557e+02
  2.74421255e+03  1.22233982e+04  4.08449460e+04  1.04888613e+05
  2.30072070e+05  4.55887017e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6984226572507  E_coul = 198.75339124821912
Extra cycle  E= -507.945031409032  delta_E= 3.41e-13  |g|= 7.32e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
exp = [1.17616814e+05 3.96619897e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349211e+03 1.83758108e+04 1.44977658e+03 3.73963347e+02
 1.13321214e+02 3.77708918e+01 8.08934879e+00 3.20463004e+00
 8.60384356e+00 4.92975075e-01]
E = -507.94503140903157
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:03 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814261        1
[INPUT] 0    0    [1    /1   ]  0.396619897151       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210198        1
[INPUT] 0    0    [1    /1   ]  36754.7203058        1
[INPUT] 0    0    [1    /1   ]  7303.4921104         1
[INPUT] 0    0    [1    /1   ]  18375.8107694        1
[INPUT] 0    0    [1    /1   ]  1449.77658446        1
[INPUT] 0    0    [1    /1   ]  373.963347386        1
[INPUT] 0    0    [1    /1   ]  113.321214375        1
[INPUT] 0    0    [1    /1   ]  37.7708918014        1
[INPUT] 0    0    [1    /1   ]  8.0893487909         1
[INPUT] 0    0    [1    /1   ]  3.20463003595        1
[INPUT] 1    0    [1    /1   ]  8.60384356335        1
[INPUT] 1    0    [1    /1   ]  0.492975075374       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426122863, 1.0]], [0, [0.39661989715051554, 1.0]], [0, [1176168.1426189742, 1.0]], [0, [588084.0699930872, 1.0]], [0, [294042.03113490436, 1.0]], [0, [147020.99215963055, 1.0]], [0, [73510.42101978349, 1.0]], [0, [36754.72030576238, 1.0]], [0, [7303.4921104023815, 1.0]], [0, [18375.810769359676, 1.0]], [0, [1449.776584461173, 1.0]], [0, [373.9633473861032, 1.0]], [0, [113.3212143750439, 1.0]], [0, [37.77089180137749, 1.0]], [0, [8.089348790903864, 1.0]], [0, [3.204630035947306, 1.0]], [1, [8.603843563348004, 1.0]], [1, [0.4929750753741682, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426123]
bas 1, expnt(s) = [0.3966199]
bas 2, expnt(s) = [1176168.14261897]
bas 3, expnt(s) = [588084.06999309]
bas 4, expnt(s) = [294042.0311349]
bas 5, expnt(s) = [147020.99215963]
bas 6, expnt(s) = [73510.42101978]
bas 7, expnt(s) = [36754.72030576]
bas 8, expnt(s) = [7303.4921104]
bas 9, expnt(s) = [18375.81076936]
bas 10, expnt(s) = [1449.77658446]
bas 11, expnt(s) = [373.96334739]
bas 12, expnt(s) = [113.32121438]
bas 13, expnt(s) = [37.7708918]
bas 14, expnt(s) = [8.08934879]
bas 15, expnt(s) = [3.20463004]
bas 16, expnt(s) = [8.60384356]
bas 17, expnt(s) = [0.49297508]
CPU time:        51.35
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96619897e-01 1.26268755e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349211e+03 1.99601108e+03 1.83758108e+04 3.98749275e+03
 1.44977658e+03 5.93595821e+02 3.73963347e+02 2.14850715e+02
 1.13321214e+02 8.77502655e+01 3.77708918e+01 3.84931058e+01
 8.08934879e+00 1.21185371e+01 3.20463004e+00 6.05129672e+00
 8.60384356e+00 4.29882756e+01 4.92975075e-01 1.20507921e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325141015208274
cond(S) = 907706.1579642064
E1 = -689.3965740069834  E_coul = 184.91048785149547
init E= -504.486086155488
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674753069240201  LUMO = 9.18298738436646
  mo_energy =
[-1.21707311e+02 -1.33876137e+01 -7.62814813e+00 -7.62814813e+00
 -7.62814813e+00 -1.64021034e+00 -6.74753069e-01 -6.74753069e-01
 -6.74753069e-01  9.18298738e+00  1.08658100e+02  6.03221814e+02
  2.74291839e+03  1.22222239e+04  4.08438421e+04  1.04887548e+05
  2.30071030e+05  4.55885994e+05  8.44838271e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.067927361369  E_coul = 199.12929810964908
cycle= 1 E= -507.93862925172  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602187
diis-c [-0.36262934  1.        ]
  HOMO = -0.23319894165998  LUMO = 10.0920923664188
  mo_energy =
[-1.20256649e+02 -1.23514481e+01 -6.64615983e+00 -6.64615983e+00
 -6.64615983e+00 -1.16155692e+00 -2.33198942e-01 -2.33198942e-01
 -2.33198942e-01  1.00920924e+01  1.10007198e+02  6.04658356e+02
  2.74428957e+03  1.22234837e+04  4.08450345e+04  1.04888703e+05
  2.30072161e+05  4.55887108e+05  8.44839372e+05  1.52801664e+06
  2.85028404e+06  5.80817134e+06]
E1 = -706.7138285844734  E_coul = 198.76880929700368
cycle= 2 E= -507.94501928747  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152551
diis-c [-2.24111179e-04  4.84955672e-03  9.95150443e-01]
  HOMO = -0.237659241084615  LUMO = 10.0811687818801
  mo_energy =
[-1.20314471e+02 -1.23738536e+01 -6.67403664e+00 -6.67403664e+00
 -6.67403664e+00 -1.16382421e+00 -2.37659241e-01 -2.37659241e-01
 -2.37659241e-01  1.00811688e+01  1.09963714e+02  6.04597229e+02
  2.74421560e+03  1.22234015e+04  4.08449493e+04  1.04888617e+05
  2.30072074e+05  4.55887020e+05  8.44839284e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.6991614533584  E_coul = 198.75413007454864
cycle= 3 E= -507.94503137881  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739888
diis-c [-1.26655388e-08  3.76763020e-05 -5.00652339e-02  1.05002756e+00]
  HOMO = -0.237885853288255  LUMO = 10.0806260266948
  mo_energy =
[-1.20317071e+02 -1.23749642e+01 -6.67539448e+00 -6.67539448e+00
 -6.67539448e+00 -1.16393479e+00 -2.37885853e-01 -2.37885853e-01
 -2.37885853e-01  1.00806260e+01  1.09961690e+02  6.04594555e+02
  2.74421254e+03  1.22233982e+04  4.08449460e+04  1.04888613e+05
  2.30072070e+05  4.55887017e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6984238656931  E_coul = 198.7533924566633
cycle= 4 E= -507.94503140903  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46726e-06
diis-c [-4.71957393e-12 -1.76586280e-06  2.30440249e-03 -4.57909010e-02
  1.04348826e+00]
  HOMO = -0.237886605983066  LUMO = 10.0806252611852
  mo_energy =
[-1.20317069e+02 -1.23749667e+01 -6.67539607e+00 -6.67539607e+00
 -6.67539607e+00 -1.16393522e+00 -2.37886606e-01 -2.37886606e-01
 -2.37886606e-01  1.00806253e+01  1.09961690e+02  6.04594558e+02
  2.74421255e+03  1.22233982e+04  4.08449460e+04  1.04888613e+05
  2.30072070e+05  4.55887017e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6984227505478  E_coul = 198.7533913415159
cycle= 5 E= -507.945031409032  delta_E= -2.05e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6984227505478  E_coul = 198.7533913415159
  HOMO = -0.237886640046675  LUMO = 10.0806251914618
  mo_energy =
[-1.20317069e+02 -1.23749668e+01 -6.67539625e+00 -6.67539625e+00
 -6.67539625e+00 -1.16393524e+00 -2.37886640e-01 -2.37886640e-01
 -2.37886640e-01  1.00806252e+01  1.09961690e+02  6.04594557e+02
  2.74421255e+03  1.22233982e+04  4.08449460e+04  1.04888613e+05
  2.30072070e+05  4.55887017e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6984226572507  E_coul = 198.75339124821912
Extra cycle  E= -507.945031409032  delta_E= 3.41e-13  |g|= 7.32e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907706.1579642064
E1 = -706.6984226572507  E_coul = 198.75339124821912
init E= -507.945031409032
    CPU time for initialize scf      1.35 sec, wall time      0.09 sec
  HOMO = -0.23788664165407  LUMO = 10.0806251883674
  mo_energy =
[-1.20317069e+02 -1.23749668e+01 -6.67539625e+00 -6.67539625e+00
 -6.67539625e+00 -1.16393524e+00 -2.37886642e-01 -2.37886642e-01
 -2.37886642e-01  1.00806252e+01  1.09961690e+02  6.04594557e+02
  2.74421255e+03  1.22233982e+04  4.08449460e+04  1.04888613e+05
  2.30072070e+05  4.55887017e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6984226530311  E_coul = 198.75339124399954
cycle= 1 E= -507.945031409032  delta_E=    0  |g|= 1.47e-09  |ddm|= 3.59e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
E1 = -706.6984226530311  E_coul = 198.75339124399954
  HOMO = -0.237886641732689  LUMO = 10.0806251882233
  mo_energy =
[-1.20317069e+02 -1.23749668e+01 -6.67539626e+00 -6.67539626e+00
 -6.67539626e+00 -1.16393524e+00 -2.37886642e-01 -2.37886642e-01
 -2.37886642e-01  1.00806252e+01  1.09961690e+02  6.04594557e+02
  2.74421255e+03  1.22233982e+04  4.08449460e+04  1.04888613e+05
  2.30072070e+05  4.55887017e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6984226528492  E_coul = 198.75339124381765
Extra cycle  E= -507.945031409032  delta_E=    0  |g|= 1.31e-09  |ddm|= 1.71e-10
    CPU time for scf_cycle      1.54 sec, wall time      0.15 sec
exp = [1.17616814e+05 3.96619897e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349211e+03 1.83758108e+04 1.44977658e+03 3.73963347e+02
 1.13321214e+02 3.77708918e+01 8.08934879e+00 3.20463004e+00
 8.60384356e+00 4.92975075e-01]
grad_E = [ 4.16191690e-09 -2.38774460e-04  1.85160053e-11  1.12109934e-10
  6.47543975e-10  2.53923929e-09  1.05484783e-08  5.67696619e-08
  3.56924895e-06  1.21835715e-07  6.04313805e-06 -1.39330527e-05
  1.43909186e-05  9.25818999e-06  1.00065473e-05 -5.58591506e-05
  5.44101881e-06 -1.12756107e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814261        1
[INPUT] 0    0    [1    /1   ]  0.396624920336       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210194        1
[INPUT] 0    0    [1    /1   ]  36754.7203039        1
[INPUT] 0    0    [1    /1   ]  7303.49199123        1
[INPUT] 0    0    [1    /1   ]  18375.8107653        1
[INPUT] 0    0    [1    /1   ]  1449.77637556        1
[INPUT] 0    0    [1    /1   ]  373.963910263        1
[INPUT] 0    0    [1    /1   ]  113.320119149        1
[INPUT] 0    0    [1    /1   ]  37.7720946313        1
[INPUT] 0    0    [1    /1   ]  8.08917129082        1
[INPUT] 0    0    [1    /1   ]  3.20482296287        1
[INPUT] 1    0    [1    /1   ]  8.60385592641        1
[INPUT] 1    0    [1    /1   ]  0.492993226294       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426108966, 1.0]], [0, [0.39662492033571495, 1.0]], [0, [1176168.1426189735, 1.0]], [0, [588084.0699930835, 1.0]], [0, [294042.03113488277, 1.0]], [0, [147020.99215954577, 1.0]], [0, [73510.42101943128, 1.0]], [0, [36754.72030386665, 1.0]], [0, [7303.491991227742, 1.0]], [0, [18375.810765292696, 1.0]], [0, [1449.7763755553706, 1.0]], [0, [373.96391026306037, 1.0]], [0, [113.32011914901929, 1.0]], [0, [37.772094631322254, 1.0]], [0, [8.089171290815157, 1.0]], [0, [3.2048229628687674, 1.0]], [1, [8.603855926408265, 1.0]], [1, [0.4929932262938473, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426109]
bas 1, expnt(s) = [0.39662492]
bas 2, expnt(s) = [1176168.14261897]
bas 3, expnt(s) = [588084.06999308]
bas 4, expnt(s) = [294042.03113488]
bas 5, expnt(s) = [147020.99215955]
bas 6, expnt(s) = [73510.42101943]
bas 7, expnt(s) = [36754.72030387]
bas 8, expnt(s) = [7303.49199123]
bas 9, expnt(s) = [18375.81076529]
bas 10, expnt(s) = [1449.77637556]
bas 11, expnt(s) = [373.96391026]
bas 12, expnt(s) = [113.32011915]
bas 13, expnt(s) = [37.77209463]
bas 14, expnt(s) = [8.08917129]
bas 15, expnt(s) = [3.20482296]
bas 16, expnt(s) = [8.60385593]
bas 17, expnt(s) = [0.49299323]
CPU time:        56.05
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96624920e-01 1.26269954e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349199e+03 1.99601105e+03 1.83758108e+04 3.98749275e+03
 1.44977638e+03 5.93595757e+02 3.73963910e+02 2.14850957e+02
 1.13320119e+02 8.77496294e+01 3.77720946e+01 3.84940252e+01
 8.08917129e+00 1.21183376e+01 3.20482296e+00 6.05156994e+00
 8.60385593e+00 4.29883528e+01 4.92993226e-01 1.20513468e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32511635698551
cond(S) = 907706.1729153811
E1 = -689.3973008613449  E_coul = 184.9111766923245
init E= -504.48612416902
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674729073257421  LUMO = 9.18344642319956
  mo_energy =
[-1.21707246e+02 -1.33875553e+01 -7.62810555e+00 -7.62810555e+00
 -7.62810555e+00 -1.64019757e+00 -6.74729073e-01 -6.74729073e-01
 -6.74729073e-01  9.18344642e+00  1.08660162e+02  6.03224005e+02
  2.74292033e+03  1.22222254e+04  4.08438432e+04  1.04887549e+05
  2.30071030e+05  4.55885995e+05  8.44838272e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.069115451118  E_coul = 199.13048579304524
cycle= 1 E= -507.938629658073  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602187
diis-c [-0.36262899  1.        ]
  HOMO = -0.233153010317148  LUMO = 10.0925856966944
  mo_energy =
[-1.20256541e+02 -1.23513573e+01 -6.64608452e+00 -6.64608452e+00
 -6.64608452e+00 -1.16152563e+00 -2.33153010e-01 -2.33153010e-01
 -2.33153010e-01  1.00925857e+01  1.10009304e+02  6.04660592e+02
  2.74429155e+03  1.22234853e+04  4.08450358e+04  1.04888704e+05
  2.30072162e+05  4.55887108e+05  8.44839373e+05  1.52801664e+06
  2.85028404e+06  5.80817134e+06]
E1 = -706.71503449077  E_coul = 198.77001517314298
cycle= 2 E= -507.945019317627  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152546
diis-c [-2.24097320e-04  4.84955269e-03  9.95150447e-01]
  HOMO = -0.237613206272853  LUMO = 10.0816625719601
  mo_energy =
[-1.20314360e+02 -1.23737615e+01 -6.67395972e+00 -6.67395972e+00
 -6.67395972e+00 -1.16379277e+00 -2.37613206e-01 -2.37613206e-01
 -2.37613206e-01  1.00816626e+01  1.09965821e+02  6.04599467e+02
  2.74421758e+03  1.22234031e+04  4.08449505e+04  1.04888618e+05
  2.30072074e+05  4.55887021e+05  8.44839285e+05  1.52801655e+06
  2.85028396e+06  5.80817125e+06]
E1 = -706.7003682204144  E_coul = 198.75533681243283
cycle= 3 E= -507.945031407982  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739862
diis-c [-1.26613282e-08  3.76755940e-05 -5.00651087e-02  1.05002743e+00]
  HOMO = -0.237839810125174  LUMO = 10.0811198444316
  mo_energy =
[-1.20316960e+02 -1.23748721e+01 -6.67531747e+00 -6.67531747e+00
 -6.67531747e+00 -1.16390334e+00 -2.37839810e-01 -2.37839810e-01
 -2.37839810e-01  1.00811198e+01  1.09963798e+02  6.04596793e+02
  2.74421453e+03  1.22233998e+04  4.08449472e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6996306832706  E_coul = 198.75459924507254
cycle= 4 E= -507.945031438198  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46594e-06
diis-c [-4.71692979e-12 -1.76650716e-06  2.30415045e-03 -4.57856622e-02
  1.04348328e+00]
  HOMO = -0.237840562631319  LUMO = 10.0811190791744
  mo_energy =
[-1.20316958e+02 -1.23748745e+01 -6.67531906e+00 -6.67531906e+00
 -6.67531906e+00 -1.16390377e+00 -2.37840563e-01 -2.37840563e-01
 -2.37840563e-01  1.00811191e+01  1.09963798e+02  6.04596796e+02
  2.74421454e+03  1.22233998e+04  4.08449472e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6996295685511  E_coul = 198.7545981303512
cycle= 5 E= -507.9450314382  delta_E= -1.88e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6996295685511  E_coul = 198.7545981303512
  HOMO = -0.237840596690473  LUMO = 10.081119009464
  mo_energy =
[-1.20316959e+02 -1.23748747e+01 -6.67531923e+00 -6.67531923e+00
 -6.67531923e+00 -1.16390379e+00 -2.37840597e-01 -2.37840597e-01
 -2.37840597e-01  1.00811190e+01  1.09963798e+02  6.04596796e+02
  2.74421454e+03  1.22233998e+04  4.08449472e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6996294752632  E_coul = 198.7545980370636
Extra cycle  E= -507.9450314382  delta_E= 2.84e-13  |g|= 7.54e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
exp = [1.17616814e+05 3.96624920e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349199e+03 1.83758108e+04 1.44977638e+03 3.73963910e+02
 1.13320119e+02 3.77720946e+01 8.08917129e+00 3.20482296e+00
 8.60385593e+00 4.92993226e-01]
E = -507.94503143819963
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814261        1
[INPUT] 0    0    [1    /1   ]  0.396624920336       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210194        1
[INPUT] 0    0    [1    /1   ]  36754.7203039        1
[INPUT] 0    0    [1    /1   ]  7303.49199123        1
[INPUT] 0    0    [1    /1   ]  18375.8107653        1
[INPUT] 0    0    [1    /1   ]  1449.77637556        1
[INPUT] 0    0    [1    /1   ]  373.963910263        1
[INPUT] 0    0    [1    /1   ]  113.320119149        1
[INPUT] 0    0    [1    /1   ]  37.7720946313        1
[INPUT] 0    0    [1    /1   ]  8.08917129082        1
[INPUT] 0    0    [1    /1   ]  3.20482296287        1
[INPUT] 1    0    [1    /1   ]  8.60385592641        1
[INPUT] 1    0    [1    /1   ]  0.492993226294       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426108966, 1.0]], [0, [0.39662492033571495, 1.0]], [0, [1176168.1426189735, 1.0]], [0, [588084.0699930835, 1.0]], [0, [294042.03113488277, 1.0]], [0, [147020.99215954577, 1.0]], [0, [73510.42101943128, 1.0]], [0, [36754.72030386665, 1.0]], [0, [7303.491991227742, 1.0]], [0, [18375.810765292696, 1.0]], [0, [1449.7763755553706, 1.0]], [0, [373.96391026306037, 1.0]], [0, [113.32011914901929, 1.0]], [0, [37.772094631322254, 1.0]], [0, [8.089171290815157, 1.0]], [0, [3.2048229628687674, 1.0]], [1, [8.603855926408265, 1.0]], [1, [0.4929932262938473, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426109]
bas 1, expnt(s) = [0.39662492]
bas 2, expnt(s) = [1176168.14261897]
bas 3, expnt(s) = [588084.06999308]
bas 4, expnt(s) = [294042.03113488]
bas 5, expnt(s) = [147020.99215955]
bas 6, expnt(s) = [73510.42101943]
bas 7, expnt(s) = [36754.72030387]
bas 8, expnt(s) = [7303.49199123]
bas 9, expnt(s) = [18375.81076529]
bas 10, expnt(s) = [1449.77637556]
bas 11, expnt(s) = [373.96391026]
bas 12, expnt(s) = [113.32011915]
bas 13, expnt(s) = [37.77209463]
bas 14, expnt(s) = [8.08917129]
bas 15, expnt(s) = [3.20482296]
bas 16, expnt(s) = [8.60385593]
bas 17, expnt(s) = [0.49299323]
CPU time:        56.54
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96624920e-01 1.26269954e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349199e+03 1.99601105e+03 1.83758108e+04 3.98749275e+03
 1.44977638e+03 5.93595757e+02 3.73963910e+02 2.14850957e+02
 1.13320119e+02 8.77496294e+01 3.77720946e+01 3.84940252e+01
 8.08917129e+00 1.21183376e+01 3.20482296e+00 6.05156994e+00
 8.60385593e+00 4.29883528e+01 4.92993226e-01 1.20513468e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32511635698551
cond(S) = 907706.1729153811
E1 = -689.3973008613449  E_coul = 184.9111766923245
init E= -504.48612416902
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674729073257421  LUMO = 9.18344642319956
  mo_energy =
[-1.21707246e+02 -1.33875553e+01 -7.62810555e+00 -7.62810555e+00
 -7.62810555e+00 -1.64019757e+00 -6.74729073e-01 -6.74729073e-01
 -6.74729073e-01  9.18344642e+00  1.08660162e+02  6.03224005e+02
  2.74292033e+03  1.22222254e+04  4.08438432e+04  1.04887549e+05
  2.30071030e+05  4.55885995e+05  8.44838272e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.069115451118  E_coul = 199.13048579304524
cycle= 1 E= -507.938629658073  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602187
diis-c [-0.36262899  1.        ]
  HOMO = -0.233153010317148  LUMO = 10.0925856966944
  mo_energy =
[-1.20256541e+02 -1.23513573e+01 -6.64608452e+00 -6.64608452e+00
 -6.64608452e+00 -1.16152563e+00 -2.33153010e-01 -2.33153010e-01
 -2.33153010e-01  1.00925857e+01  1.10009304e+02  6.04660592e+02
  2.74429155e+03  1.22234853e+04  4.08450358e+04  1.04888704e+05
  2.30072162e+05  4.55887108e+05  8.44839373e+05  1.52801664e+06
  2.85028404e+06  5.80817134e+06]
E1 = -706.71503449077  E_coul = 198.77001517314298
cycle= 2 E= -507.945019317627  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152546
diis-c [-2.24097320e-04  4.84955269e-03  9.95150447e-01]
  HOMO = -0.237613206272853  LUMO = 10.0816625719601
  mo_energy =
[-1.20314360e+02 -1.23737615e+01 -6.67395972e+00 -6.67395972e+00
 -6.67395972e+00 -1.16379277e+00 -2.37613206e-01 -2.37613206e-01
 -2.37613206e-01  1.00816626e+01  1.09965821e+02  6.04599467e+02
  2.74421758e+03  1.22234031e+04  4.08449505e+04  1.04888618e+05
  2.30072074e+05  4.55887021e+05  8.44839285e+05  1.52801655e+06
  2.85028396e+06  5.80817125e+06]
E1 = -706.7003682204144  E_coul = 198.75533681243283
cycle= 3 E= -507.945031407982  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739862
diis-c [-1.26613282e-08  3.76755940e-05 -5.00651087e-02  1.05002743e+00]
  HOMO = -0.237839810125174  LUMO = 10.0811198444316
  mo_energy =
[-1.20316960e+02 -1.23748721e+01 -6.67531747e+00 -6.67531747e+00
 -6.67531747e+00 -1.16390334e+00 -2.37839810e-01 -2.37839810e-01
 -2.37839810e-01  1.00811198e+01  1.09963798e+02  6.04596793e+02
  2.74421453e+03  1.22233998e+04  4.08449472e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6996306832706  E_coul = 198.75459924507254
cycle= 4 E= -507.945031438198  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46594e-06
diis-c [-4.71692979e-12 -1.76650716e-06  2.30415045e-03 -4.57856622e-02
  1.04348328e+00]
  HOMO = -0.237840562631319  LUMO = 10.0811190791744
  mo_energy =
[-1.20316958e+02 -1.23748745e+01 -6.67531906e+00 -6.67531906e+00
 -6.67531906e+00 -1.16390377e+00 -2.37840563e-01 -2.37840563e-01
 -2.37840563e-01  1.00811191e+01  1.09963798e+02  6.04596796e+02
  2.74421454e+03  1.22233998e+04  4.08449472e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6996295685511  E_coul = 198.7545981303512
cycle= 5 E= -507.9450314382  delta_E= -1.88e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6996295685511  E_coul = 198.7545981303512
  HOMO = -0.237840596690473  LUMO = 10.081119009464
  mo_energy =
[-1.20316959e+02 -1.23748747e+01 -6.67531923e+00 -6.67531923e+00
 -6.67531923e+00 -1.16390379e+00 -2.37840597e-01 -2.37840597e-01
 -2.37840597e-01  1.00811190e+01  1.09963798e+02  6.04596796e+02
  2.74421454e+03  1.22233998e+04  4.08449472e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6996294752632  E_coul = 198.7545980370636
Extra cycle  E= -507.9450314382  delta_E= 2.84e-13  |g|= 7.54e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907706.1729153811
E1 = -706.6996294752632  E_coul = 198.7545980370636
init E= -507.9450314382
    CPU time for initialize scf      1.81 sec, wall time      0.11 sec
  HOMO = -0.237840598297871  LUMO = 10.0811190063696
  mo_energy =
[-1.20316959e+02 -1.23748747e+01 -6.67531924e+00 -6.67531924e+00
 -6.67531924e+00 -1.16390379e+00 -2.37840598e-01 -2.37840598e-01
 -2.37840598e-01  1.00811190e+01  1.09963798e+02  6.04596796e+02
  2.74421454e+03  1.22233998e+04  4.08449472e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.69962947105  E_coul = 198.75459803285042
cycle= 1 E= -507.9450314382  delta_E= 5.68e-14  |g|= 1.75e-09  |ddm|= 3.58e-09
    CPU time for cycle= 1      0.09 sec, wall time      0.01 sec
E1 = -706.69962947105  E_coul = 198.75459803285042
  HOMO = -0.237840598376365  LUMO = 10.0811190062276
  mo_energy =
[-1.20316959e+02 -1.23748747e+01 -6.67531924e+00 -6.67531924e+00
 -6.67531924e+00 -1.16390379e+00 -2.37840598e-01 -2.37840598e-01
 -2.37840598e-01  1.00811190e+01  1.09963798e+02  6.04596796e+02
  2.74421454e+03  1.22233998e+04  4.08449472e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.6996294708609  E_coul = 198.75459803266116
Extra cycle  E= -507.9450314382  delta_E= -1.71e-13  |g|= 2.59e-09  |ddm|= 1.74e-10
    CPU time for scf_cycle      1.97 sec, wall time      0.19 sec
exp = [1.17616814e+05 3.96624920e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349199e+03 1.83758108e+04 1.44977638e+03 3.73963910e+02
 1.13320119e+02 3.77720946e+01 8.08917129e+00 3.20482296e+00
 8.60385593e+00 4.92993226e-01]
grad_E = [ 4.16274346e-09 -9.78018754e-05  1.85258150e-11  1.12136765e-10
  6.47671916e-10  2.53975010e-09  1.05506315e-08  5.67802790e-08
  3.57000495e-06  1.21867986e-07  6.00059259e-06 -1.33415074e-05
  1.08010882e-05  1.71520327e-05 -4.40383214e-06 -1.05373039e-05
  4.55525800e-07 -4.35523760e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:09 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814261        1
[INPUT] 0    0    [1    /1   ]  0.396628960794       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210194        1
[INPUT] 0    0    [1    /1   ]  36754.7203037        1
[INPUT] 0    0    [1    /1   ]  7303.49198242        1
[INPUT] 0    0    [1    /1   ]  18375.810765         1
[INPUT] 0    0    [1    /1   ]  1449.77636045        1
[INPUT] 0    0    [1    /1   ]  373.96394721         1
[INPUT] 0    0    [1    /1   ]  113.320067432        1
[INPUT] 0    0    [1    /1   ]  37.7721124538        1
[INPUT] 0    0    [1    /1   ]  8.08916473717        1
[INPUT] 0    0    [1    /1   ]  3.20486568321        1
[INPUT] 1    0    [1    /1   ]  8.60386626366        1
[INPUT] 1    0    [1    /1   ]  0.493003532755       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426107939, 1.0]], [0, [0.3966289607944854, 1.0]], [0, [1176168.1426189735, 1.0]], [0, [588084.0699930832, 1.0]], [0, [294042.0311348812, 1.0]], [0, [147020.9921595395, 1.0]], [0, [73510.42101940523, 1.0]], [0, [36754.7203037265, 1.0]], [0, [7303.491982416513, 1.0]], [0, [18375.81076499195, 1.0]], [0, [1449.7763604511701, 1.0]], [0, [373.96394720958693, 1.0]], [0, [113.32006743216606, 1.0]], [0, [37.772112453797924, 1.0]], [0, [8.089164737169492, 1.0]], [0, [3.2048656832124416, 1.0]], [1, [8.603866263664363, 1.0]], [1, [0.4930035327553085, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426108]
bas 1, expnt(s) = [0.39662896]
bas 2, expnt(s) = [1176168.14261897]
bas 3, expnt(s) = [588084.06999308]
bas 4, expnt(s) = [294042.03113488]
bas 5, expnt(s) = [147020.99215954]
bas 6, expnt(s) = [73510.42101941]
bas 7, expnt(s) = [36754.72030373]
bas 8, expnt(s) = [7303.49198242]
bas 9, expnt(s) = [18375.81076499]
bas 10, expnt(s) = [1449.77636045]
bas 11, expnt(s) = [373.96394721]
bas 12, expnt(s) = [113.32006743]
bas 13, expnt(s) = [37.77211245]
bas 14, expnt(s) = [8.08916474]
bas 15, expnt(s) = [3.20486568]
bas 16, expnt(s) = [8.60386626]
bas 17, expnt(s) = [0.49300353]
CPU time:        61.72
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96628961e-01 1.26270919e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349198e+03 1.99601105e+03 1.83758108e+04 3.98749275e+03
 1.44977636e+03 5.93595753e+02 3.73963947e+02 2.14850973e+02
 1.13320067e+02 8.77495994e+01 3.77721125e+01 3.84940388e+01
 8.08916474e+00 1.21183303e+01 3.20486568e+00 6.05163044e+00
 8.60386626e+00 4.29884174e+01 4.93003533e-01 1.20516617e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325102233335052
cond(S) = 907706.1739793059
E1 = -689.3977575668953  E_coul = 184.91158803036498
init E= -504.48616953653
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674715394264263  LUMO = 9.18360480222686
  mo_energy =
[-1.21707206e+02 -1.33875209e+01 -7.62807993e+00 -7.62807993e+00
 -7.62807993e+00 -1.64018925e+00 -6.74715394e-01 -6.74715394e-01
 -6.74715394e-01  9.18360480e+00  1.08660390e+02  6.03224156e+02
  2.74292046e+03  1.22222255e+04  4.08438433e+04  1.04887549e+05
  2.30071031e+05  4.55885995e+05  8.44838272e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.0697851568392  E_coul = 199.13115540954232
cycle= 1 E= -507.938629747297  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602187
diis-c [-0.36262914  1.        ]
  HOMO = -0.233127055379095  LUMO = 10.092760486102
  mo_energy =
[-1.20256480e+02 -1.23513061e+01 -6.64604238e+00 -6.64604238e+00
 -6.64604238e+00 -1.16150703e+00 -2.33127055e-01 -2.33127055e-01
 -2.33127055e-01  1.00927605e+01  1.10009551e+02  6.04660763e+02
  2.74429171e+03  1.22234854e+04  4.08450359e+04  1.04888704e+05
  2.30072162e+05  4.55887109e+05  8.44839373e+05  1.52801664e+06
  2.85028404e+06  5.80817134e+06]
E1 = -706.7157085262143  E_coul = 198.77068920455702
cycle= 2 E= -507.945019321657  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152546
diis-c [-2.24096251e-04  4.84952130e-03  9.95150479e-01]
  HOMO = -0.237587274579698  LUMO = 10.0818374778334
  mo_energy =
[-1.20314299e+02 -1.23737099e+01 -6.67391713e+00 -6.67391713e+00
 -6.67391713e+00 -1.16377414e+00 -2.37587275e-01 -2.37587275e-01
 -2.37587275e-01  1.00818375e+01  1.09966069e+02  6.04599640e+02
  2.74421774e+03  1.22234032e+04  4.08449506e+04  1.04888618e+05
  2.30072075e+05  4.55887021e+05  8.44839285e+05  1.52801655e+06
  2.85028396e+06  5.80817125e+06]
E1 = -706.7010424815454  E_coul = 198.75601106979846
cycle= 3 E= -507.945031411747  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739858
diis-c [-1.26603258e-08  3.76745253e-05 -5.00649936e-02  1.05002732e+00]
  HOMO = -0.23781387832716  LUMO = 10.0812947581991
  mo_energy =
[-1.20316899e+02 -1.23748204e+01 -6.67527486e+00 -6.67527486e+00
 -6.67527486e+00 -1.16388471e+00 -2.37813878e-01 -2.37813878e-01
 -2.37813878e-01  1.00812948e+01  1.09964045e+02  6.04596965e+02
  2.74421469e+03  1.22233999e+04  4.08449473e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.700304958892  E_coul = 198.7552735169292
cycle= 4 E= -507.945031441963  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46589e-06
diis-c [-4.71704961e-12 -1.76703989e-06  2.30417806e-03 -4.57862450e-02
  1.04348383e+00]
  HOMO = -0.237814630782272  LUMO = 10.081293993018
  mo_energy =
[-1.20316897e+02 -1.23748229e+01 -6.67527645e+00 -6.67527645e+00
 -6.67527645e+00 -1.16388514e+00 -2.37814631e-01 -2.37814631e-01
 -2.37814631e-01  1.00812940e+01  1.09964046e+02  6.04596968e+02
  2.74421469e+03  1.22233999e+04  4.08449473e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.7003038442815  E_coul = 198.7552724023172
cycle= 5 E= -507.945031441964  delta_E= -1.48e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7003038442815  E_coul = 198.7552724023172
  HOMO = -0.237814664838765  LUMO = 10.0812939233144
  mo_energy =
[-1.20316897e+02 -1.23748231e+01 -6.67527662e+00 -6.67527662e+00
 -6.67527662e+00 -1.16388515e+00 -2.37814665e-01 -2.37814665e-01
 -2.37814665e-01  1.00812939e+01  1.09964046e+02  6.04596968e+02
  2.74421469e+03  1.22233999e+04  4.08449473e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.7003037510264  E_coul = 198.75527230906206
Extra cycle  E= -507.945031441964  delta_E= 5.68e-14  |g|= 7.45e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
exp = [1.17616814e+05 3.96628961e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349198e+03 1.83758108e+04 1.44977636e+03 3.73963947e+02
 1.13320067e+02 3.77721125e+01 8.08916474e+00 3.20486568e+00
 8.60386626e+00 4.93003533e-01]
E = -507.94503144196426
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:09 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814261        1
[INPUT] 0    0    [1    /1   ]  0.396628960794       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210194        1
[INPUT] 0    0    [1    /1   ]  36754.7203037        1
[INPUT] 0    0    [1    /1   ]  7303.49198242        1
[INPUT] 0    0    [1    /1   ]  18375.810765         1
[INPUT] 0    0    [1    /1   ]  1449.77636045        1
[INPUT] 0    0    [1    /1   ]  373.96394721         1
[INPUT] 0    0    [1    /1   ]  113.320067432        1
[INPUT] 0    0    [1    /1   ]  37.7721124538        1
[INPUT] 0    0    [1    /1   ]  8.08916473717        1
[INPUT] 0    0    [1    /1   ]  3.20486568321        1
[INPUT] 1    0    [1    /1   ]  8.60386626366        1
[INPUT] 1    0    [1    /1   ]  0.493003532755       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426107939, 1.0]], [0, [0.3966289607944854, 1.0]], [0, [1176168.1426189735, 1.0]], [0, [588084.0699930832, 1.0]], [0, [294042.0311348812, 1.0]], [0, [147020.9921595395, 1.0]], [0, [73510.42101940523, 1.0]], [0, [36754.7203037265, 1.0]], [0, [7303.491982416513, 1.0]], [0, [18375.81076499195, 1.0]], [0, [1449.7763604511701, 1.0]], [0, [373.96394720958693, 1.0]], [0, [113.32006743216606, 1.0]], [0, [37.772112453797924, 1.0]], [0, [8.089164737169492, 1.0]], [0, [3.2048656832124416, 1.0]], [1, [8.603866263664363, 1.0]], [1, [0.4930035327553085, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426108]
bas 1, expnt(s) = [0.39662896]
bas 2, expnt(s) = [1176168.14261897]
bas 3, expnt(s) = [588084.06999308]
bas 4, expnt(s) = [294042.03113488]
bas 5, expnt(s) = [147020.99215954]
bas 6, expnt(s) = [73510.42101941]
bas 7, expnt(s) = [36754.72030373]
bas 8, expnt(s) = [7303.49198242]
bas 9, expnt(s) = [18375.81076499]
bas 10, expnt(s) = [1449.77636045]
bas 11, expnt(s) = [373.96394721]
bas 12, expnt(s) = [113.32006743]
bas 13, expnt(s) = [37.77211245]
bas 14, expnt(s) = [8.08916474]
bas 15, expnt(s) = [3.20486568]
bas 16, expnt(s) = [8.60386626]
bas 17, expnt(s) = [0.49300353]
CPU time:        62.21
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96628961e-01 1.26270919e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349198e+03 1.99601105e+03 1.83758108e+04 3.98749275e+03
 1.44977636e+03 5.93595753e+02 3.73963947e+02 2.14850973e+02
 1.13320067e+02 8.77495994e+01 3.77721125e+01 3.84940388e+01
 8.08916474e+00 1.21183303e+01 3.20486568e+00 6.05163044e+00
 8.60386626e+00 4.29884174e+01 4.93003533e-01 1.20516617e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325102233335052
cond(S) = 907706.1739793059
E1 = -689.3977575668953  E_coul = 184.91158803036498
init E= -504.48616953653
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674715394264263  LUMO = 9.18360480222686
  mo_energy =
[-1.21707206e+02 -1.33875209e+01 -7.62807993e+00 -7.62807993e+00
 -7.62807993e+00 -1.64018925e+00 -6.74715394e-01 -6.74715394e-01
 -6.74715394e-01  9.18360480e+00  1.08660390e+02  6.03224156e+02
  2.74292046e+03  1.22222255e+04  4.08438433e+04  1.04887549e+05
  2.30071031e+05  4.55885995e+05  8.44838272e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.0697851568392  E_coul = 199.13115540954232
cycle= 1 E= -507.938629747297  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602187
diis-c [-0.36262914  1.        ]
  HOMO = -0.233127055379095  LUMO = 10.092760486102
  mo_energy =
[-1.20256480e+02 -1.23513061e+01 -6.64604238e+00 -6.64604238e+00
 -6.64604238e+00 -1.16150703e+00 -2.33127055e-01 -2.33127055e-01
 -2.33127055e-01  1.00927605e+01  1.10009551e+02  6.04660763e+02
  2.74429171e+03  1.22234854e+04  4.08450359e+04  1.04888704e+05
  2.30072162e+05  4.55887109e+05  8.44839373e+05  1.52801664e+06
  2.85028404e+06  5.80817134e+06]
E1 = -706.7157085262143  E_coul = 198.77068920455702
cycle= 2 E= -507.945019321657  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152546
diis-c [-2.24096251e-04  4.84952130e-03  9.95150479e-01]
  HOMO = -0.237587274579698  LUMO = 10.0818374778334
  mo_energy =
[-1.20314299e+02 -1.23737099e+01 -6.67391713e+00 -6.67391713e+00
 -6.67391713e+00 -1.16377414e+00 -2.37587275e-01 -2.37587275e-01
 -2.37587275e-01  1.00818375e+01  1.09966069e+02  6.04599640e+02
  2.74421774e+03  1.22234032e+04  4.08449506e+04  1.04888618e+05
  2.30072075e+05  4.55887021e+05  8.44839285e+05  1.52801655e+06
  2.85028396e+06  5.80817125e+06]
E1 = -706.7010424815454  E_coul = 198.75601106979846
cycle= 3 E= -507.945031411747  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739858
diis-c [-1.26603258e-08  3.76745253e-05 -5.00649936e-02  1.05002732e+00]
  HOMO = -0.23781387832716  LUMO = 10.0812947581991
  mo_energy =
[-1.20316899e+02 -1.23748204e+01 -6.67527486e+00 -6.67527486e+00
 -6.67527486e+00 -1.16388471e+00 -2.37813878e-01 -2.37813878e-01
 -2.37813878e-01  1.00812948e+01  1.09964045e+02  6.04596965e+02
  2.74421469e+03  1.22233999e+04  4.08449473e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.700304958892  E_coul = 198.7552735169292
cycle= 4 E= -507.945031441963  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46589e-06
diis-c [-4.71704961e-12 -1.76703989e-06  2.30417806e-03 -4.57862450e-02
  1.04348383e+00]
  HOMO = -0.237814630782272  LUMO = 10.081293993018
  mo_energy =
[-1.20316897e+02 -1.23748229e+01 -6.67527645e+00 -6.67527645e+00
 -6.67527645e+00 -1.16388514e+00 -2.37814631e-01 -2.37814631e-01
 -2.37814631e-01  1.00812940e+01  1.09964046e+02  6.04596968e+02
  2.74421469e+03  1.22233999e+04  4.08449473e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.7003038442815  E_coul = 198.7552724023172
cycle= 5 E= -507.945031441964  delta_E= -1.48e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7003038442815  E_coul = 198.7552724023172
  HOMO = -0.237814664838765  LUMO = 10.0812939233144
  mo_energy =
[-1.20316897e+02 -1.23748231e+01 -6.67527662e+00 -6.67527662e+00
 -6.67527662e+00 -1.16388515e+00 -2.37814665e-01 -2.37814665e-01
 -2.37814665e-01  1.00812939e+01  1.09964046e+02  6.04596968e+02
  2.74421469e+03  1.22233999e+04  4.08449473e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.7003037510264  E_coul = 198.75527230906206
Extra cycle  E= -507.945031441964  delta_E= 5.68e-14  |g|= 7.45e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907706.1739793059
E1 = -706.7003037510264  E_coul = 198.75527230906206
init E= -507.945031441964
    CPU time for initialize scf      1.37 sec, wall time      0.09 sec
  HOMO = -0.237814666445497  LUMO = 10.0812939202206
  mo_energy =
[-1.20316897e+02 -1.23748231e+01 -6.67527663e+00 -6.67527663e+00
 -6.67527663e+00 -1.16388516e+00 -2.37814666e-01 -2.37814666e-01
 -2.37814666e-01  1.00812939e+01  1.09964046e+02  6.04596968e+02
  2.74421469e+03  1.22233999e+04  4.08449473e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.7003037468118  E_coul = 198.7552723048478
cycle= 1 E= -507.945031441964  delta_E= 3.41e-13  |g|= 1.2e-09  |ddm|= 3.58e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
E1 = -706.7003037468118  E_coul = 198.7552723048478
  HOMO = -0.23781466652404  LUMO = 10.0812939200783
  mo_energy =
[-1.20316897e+02 -1.23748231e+01 -6.67527663e+00 -6.67527663e+00
 -6.67527663e+00 -1.16388516e+00 -2.37814667e-01 -2.37814667e-01
 -2.37814667e-01  1.00812939e+01  1.09964046e+02  6.04596968e+02
  2.74421469e+03  1.22233999e+04  4.08449473e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.7003037466163  E_coul = 198.75527230465198
Extra cycle  E= -507.945031441964  delta_E= -4.55e-13  |g|= 1.97e-09  |ddm|= 1.81e-10
    CPU time for scf_cycle      1.56 sec, wall time      0.15 sec
exp = [1.17616814e+05 3.96628961e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349198e+03 1.83758108e+04 1.44977636e+03 3.73963947e+02
 1.13320067e+02 3.77721125e+01 8.08916474e+00 3.20486568e+00
 8.60386626e+00 4.93003533e-01]
grad_E = [ 4.16276507e-09 -1.24747003e-05  1.85260703e-11  1.12137467e-10
  6.47675259e-10  2.53976346e-09  1.05506878e-08  5.67805561e-08
  3.57002437e-06  1.21868835e-07  5.99957340e-06 -1.33294853e-05
  1.07642945e-05  1.70337155e-05 -7.46618182e-06  7.02685178e-07
 -4.16556894e-07 -5.01739700e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814261        1
[INPUT] 0    0    [1    /1   ]  0.39663037276        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210194        1
[INPUT] 0    0    [1    /1   ]  36754.7203037        1
[INPUT] 0    0    [1    /1   ]  7303.4919837         1
[INPUT] 0    0    [1    /1   ]  18375.810765         1
[INPUT] 0    0    [1    /1   ]  1449.77636311        1
[INPUT] 0    0    [1    /1   ]  373.963935606        1
[INPUT] 0    0    [1    /1   ]  113.32011378         1
[INPUT] 0    0    [1    /1   ]  37.7720160604        1
[INPUT] 0    0    [1    /1   ]  8.08918175887        1
[INPUT] 0    0    [1    /1   ]  3.20487086903        1
[INPUT] 1    0    [1    /1   ]  8.60387008659        1
[INPUT] 1    0    [1    /1   ]  0.493006718749       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426108089, 1.0]], [0, [0.3966303727600875, 1.0]], [0, [1176168.1426189735, 1.0]], [0, [588084.0699930832, 1.0]], [0, [294042.0311348814, 1.0]], [0, [147020.99215954042, 1.0]], [0, [73510.42101940904, 1.0]], [0, [36754.720303746995, 1.0]], [0, [7303.491983704017, 1.0]], [0, [18375.81076503583, 1.0]], [0, [1449.7763631120226, 1.0]], [0, [373.96393560617463, 1.0]], [0, [113.32011378000794, 1.0]], [0, [37.77201606036999, 1.0]], [0, [8.08918175886887, 1.0]], [0, [3.2048708690330048, 1.0]], [1, [8.60387008658889, 1.0]], [1, [0.49300671874857105, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426108]
bas 1, expnt(s) = [0.39663037]
bas 2, expnt(s) = [1176168.14261897]
bas 3, expnt(s) = [588084.06999308]
bas 4, expnt(s) = [294042.03113488]
bas 5, expnt(s) = [147020.99215954]
bas 6, expnt(s) = [73510.42101941]
bas 7, expnt(s) = [36754.72030375]
bas 8, expnt(s) = [7303.4919837]
bas 9, expnt(s) = [18375.81076504]
bas 10, expnt(s) = [1449.77636311]
bas 11, expnt(s) = [373.96393561]
bas 12, expnt(s) = [113.32011378]
bas 13, expnt(s) = [37.77201606]
bas 14, expnt(s) = [8.08918176]
bas 15, expnt(s) = [3.20487087]
bas 16, expnt(s) = [8.60387009]
bas 17, expnt(s) = [0.49300672]
CPU time:        66.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96630373e-01 1.26271256e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349198e+03 1.99601105e+03 1.83758108e+04 3.98749275e+03
 1.44977636e+03 5.93595753e+02 3.73963936e+02 2.14850968e+02
 1.13320114e+02 8.77496263e+01 3.77720161e+01 3.84939651e+01
 8.08918176e+00 1.21183494e+01 3.20487087e+00 6.05163779e+00
 8.60387009e+00 4.29884412e+01 4.93006719e-01 1.20517590e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325097848893357
cond(S) = 907706.1728218927
E1 = -689.3979055164863  E_coul = 184.9117186380654
init E= -504.486186878421
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674711163076517  LUMO = 9.1836486846879
  mo_energy =
[-1.21707193e+02 -1.33875100e+01 -7.62807176e+00 -7.62807176e+00
 -7.62807176e+00 -1.64018652e+00 -6.74711163e-01 -6.74711163e-01
 -6.74711163e-01  9.18364868e+00  1.08660334e+02  6.03224014e+02
  2.74292034e+03  1.22222254e+04  4.08438432e+04  1.04887549e+05
  2.30071030e+05  4.55885994e+05  8.44838272e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.0699919677177  E_coul = 199.1313622055048
cycle= 1 E= -507.938629762213  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602187
diis-c [-0.36262924  1.        ]
  HOMO = -0.233119055680241  LUMO = 10.0928092436762
  mo_energy =
[-1.20256461e+02 -1.23512902e+01 -6.64602940e+00 -6.64602940e+00
 -6.64602940e+00 -1.16150117e+00 -2.33119056e-01 -2.33119056e-01
 -2.33119056e-01  1.00928092e+01  1.10009500e+02  6.04660627e+02
  2.74429159e+03  1.22234853e+04  4.08450358e+04  1.04888704e+05
  2.30072162e+05  4.55887108e+05  8.44839373e+05  1.52801664e+06
  2.85028404e+06  5.80817134e+06]
E1 = -706.7159161387109  E_coul = 198.77089681596746
cycle= 2 E= -507.945019322743  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152546
diis-c [-2.24096842e-04  4.84950224e-03  9.95150498e-01]
  HOMO = -0.237579288331688  LUMO = 10.081886254884
  mo_energy =
[-1.20314280e+02 -1.23736940e+01 -6.67390407e+00 -6.67390407e+00
 -6.67390407e+00 -1.16376826e+00 -2.37579288e-01 -2.37579288e-01
 -2.37579288e-01  1.00818863e+01  1.09966018e+02  6.04599503e+02
  2.74421762e+03  1.22234031e+04  4.08449506e+04  1.04888618e+05
  2.30072075e+05  4.55887021e+05  8.44839285e+05  1.52801655e+06
  2.85028396e+06  5.80817125e+06]
E1 = -706.7012501460383  E_coul = 198.75621873326978
cycle= 3 E= -507.945031412769  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739858
diis-c [-1.26600353e-08  3.76758611e-05 -5.00649573e-02  1.05002728e+00]
  HOMO = -0.237805892274442  LUMO = 10.081343537147
  mo_energy =
[-1.20316880e+02 -1.23748045e+01 -6.67526178e+00 -6.67526178e+00
 -6.67526178e+00 -1.16387883e+00 -2.37805892e-01 -2.37805892e-01
 -2.37805892e-01  1.00813435e+01  1.09963995e+02  6.04596829e+02
  2.74421457e+03  1.22233998e+04  4.08449472e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7005126273215  E_coul = 198.75548118433755
cycle= 4 E= -507.945031442984  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46564e-06
diis-c [-4.71704151e-12 -1.76646203e-06  2.30409507e-03 -4.57847341e-02
  1.04348241e+00]
  HOMO = -0.237806644717294  LUMO = 10.0813427719842
  mo_energy =
[-1.20316878e+02 -1.23748070e+01 -6.67526338e+00 -6.67526338e+00
 -6.67526338e+00 -1.16387926e+00 -2.37806645e-01 -2.37806645e-01
 -2.37806645e-01  1.00813428e+01  1.09963995e+02  6.04596832e+02
  2.74421457e+03  1.22233998e+04  4.08449472e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7005115127438  E_coul = 198.75548006975842
cycle= 5 E= -507.945031442985  delta_E= -1.48e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7005115127438  E_coul = 198.75548006975842
  HOMO = -0.23780667877526  LUMO = 10.0813427022773
  mo_energy =
[-1.20316879e+02 -1.23748071e+01 -6.67526355e+00 -6.67526355e+00
 -6.67526355e+00 -1.16387928e+00 -2.37806679e-01 -2.37806679e-01
 -2.37806679e-01  1.00813427e+01  1.09963995e+02  6.04596832e+02
  2.74421457e+03  1.22233998e+04  4.08449472e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7005114194915  E_coul = 198.75547997650642
Extra cycle  E= -507.945031442985  delta_E= 3.41e-13  |g|= 7.48e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
exp = [1.17616814e+05 3.96630373e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349198e+03 1.83758108e+04 1.44977636e+03 3.73963936e+02
 1.13320114e+02 3.77720161e+01 8.08918176e+00 3.20487087e+00
 8.60387009e+00 4.93006719e-01]
E = -507.94503144298506
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814261        1
[INPUT] 0    0    [1    /1   ]  0.39663037276        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210194        1
[INPUT] 0    0    [1    /1   ]  36754.7203037        1
[INPUT] 0    0    [1    /1   ]  7303.4919837         1
[INPUT] 0    0    [1    /1   ]  18375.810765         1
[INPUT] 0    0    [1    /1   ]  1449.77636311        1
[INPUT] 0    0    [1    /1   ]  373.963935606        1
[INPUT] 0    0    [1    /1   ]  113.32011378         1
[INPUT] 0    0    [1    /1   ]  37.7720160604        1
[INPUT] 0    0    [1    /1   ]  8.08918175887        1
[INPUT] 0    0    [1    /1   ]  3.20487086903        1
[INPUT] 1    0    [1    /1   ]  8.60387008659        1
[INPUT] 1    0    [1    /1   ]  0.493006718749       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426108089, 1.0]], [0, [0.3966303727600875, 1.0]], [0, [1176168.1426189735, 1.0]], [0, [588084.0699930832, 1.0]], [0, [294042.0311348814, 1.0]], [0, [147020.99215954042, 1.0]], [0, [73510.42101940904, 1.0]], [0, [36754.720303746995, 1.0]], [0, [7303.491983704017, 1.0]], [0, [18375.81076503583, 1.0]], [0, [1449.7763631120226, 1.0]], [0, [373.96393560617463, 1.0]], [0, [113.32011378000794, 1.0]], [0, [37.77201606036999, 1.0]], [0, [8.08918175886887, 1.0]], [0, [3.2048708690330048, 1.0]], [1, [8.60387008658889, 1.0]], [1, [0.49300671874857105, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426108]
bas 1, expnt(s) = [0.39663037]
bas 2, expnt(s) = [1176168.14261897]
bas 3, expnt(s) = [588084.06999308]
bas 4, expnt(s) = [294042.03113488]
bas 5, expnt(s) = [147020.99215954]
bas 6, expnt(s) = [73510.42101941]
bas 7, expnt(s) = [36754.72030375]
bas 8, expnt(s) = [7303.4919837]
bas 9, expnt(s) = [18375.81076504]
bas 10, expnt(s) = [1449.77636311]
bas 11, expnt(s) = [373.96393561]
bas 12, expnt(s) = [113.32011378]
bas 13, expnt(s) = [37.77201606]
bas 14, expnt(s) = [8.08918176]
bas 15, expnt(s) = [3.20487087]
bas 16, expnt(s) = [8.60387009]
bas 17, expnt(s) = [0.49300672]
CPU time:        67.48
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96630373e-01 1.26271256e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349198e+03 1.99601105e+03 1.83758108e+04 3.98749275e+03
 1.44977636e+03 5.93595753e+02 3.73963936e+02 2.14850968e+02
 1.13320114e+02 8.77496263e+01 3.77720161e+01 3.84939651e+01
 8.08918176e+00 1.21183494e+01 3.20487087e+00 6.05163779e+00
 8.60387009e+00 4.29884412e+01 4.93006719e-01 1.20517590e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325097848893357
cond(S) = 907706.1728218927
E1 = -689.3979055164863  E_coul = 184.9117186380654
init E= -504.486186878421
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674711163076517  LUMO = 9.1836486846879
  mo_energy =
[-1.21707193e+02 -1.33875100e+01 -7.62807176e+00 -7.62807176e+00
 -7.62807176e+00 -1.64018652e+00 -6.74711163e-01 -6.74711163e-01
 -6.74711163e-01  9.18364868e+00  1.08660334e+02  6.03224014e+02
  2.74292034e+03  1.22222254e+04  4.08438432e+04  1.04887549e+05
  2.30071030e+05  4.55885994e+05  8.44838272e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.0699919677177  E_coul = 199.1313622055048
cycle= 1 E= -507.938629762213  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602187
diis-c [-0.36262924  1.        ]
  HOMO = -0.233119055680241  LUMO = 10.0928092436762
  mo_energy =
[-1.20256461e+02 -1.23512902e+01 -6.64602940e+00 -6.64602940e+00
 -6.64602940e+00 -1.16150117e+00 -2.33119056e-01 -2.33119056e-01
 -2.33119056e-01  1.00928092e+01  1.10009500e+02  6.04660627e+02
  2.74429159e+03  1.22234853e+04  4.08450358e+04  1.04888704e+05
  2.30072162e+05  4.55887108e+05  8.44839373e+05  1.52801664e+06
  2.85028404e+06  5.80817134e+06]
E1 = -706.7159161387109  E_coul = 198.77089681596746
cycle= 2 E= -507.945019322743  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.07 sec, wall time      0.02 sec
diis-norm(errvec)=0.0152546
diis-c [-2.24096842e-04  4.84950224e-03  9.95150498e-01]
  HOMO = -0.237579288331688  LUMO = 10.081886254884
  mo_energy =
[-1.20314280e+02 -1.23736940e+01 -6.67390407e+00 -6.67390407e+00
 -6.67390407e+00 -1.16376826e+00 -2.37579288e-01 -2.37579288e-01
 -2.37579288e-01  1.00818863e+01  1.09966018e+02  6.04599503e+02
  2.74421762e+03  1.22234031e+04  4.08449506e+04  1.04888618e+05
  2.30072075e+05  4.55887021e+05  8.44839285e+05  1.52801655e+06
  2.85028396e+06  5.80817125e+06]
E1 = -706.7012501460383  E_coul = 198.75621873326978
cycle= 3 E= -507.945031412769  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739858
diis-c [-1.26600353e-08  3.76758611e-05 -5.00649573e-02  1.05002728e+00]
  HOMO = -0.237805892274442  LUMO = 10.081343537147
  mo_energy =
[-1.20316880e+02 -1.23748045e+01 -6.67526178e+00 -6.67526178e+00
 -6.67526178e+00 -1.16387883e+00 -2.37805892e-01 -2.37805892e-01
 -2.37805892e-01  1.00813435e+01  1.09963995e+02  6.04596829e+02
  2.74421457e+03  1.22233998e+04  4.08449472e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7005126273215  E_coul = 198.75548118433755
cycle= 4 E= -507.945031442984  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46564e-06
diis-c [-4.71704151e-12 -1.76646203e-06  2.30409507e-03 -4.57847341e-02
  1.04348241e+00]
  HOMO = -0.237806644717294  LUMO = 10.0813427719842
  mo_energy =
[-1.20316878e+02 -1.23748070e+01 -6.67526338e+00 -6.67526338e+00
 -6.67526338e+00 -1.16387926e+00 -2.37806645e-01 -2.37806645e-01
 -2.37806645e-01  1.00813428e+01  1.09963995e+02  6.04596832e+02
  2.74421457e+03  1.22233998e+04  4.08449472e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7005115127438  E_coul = 198.75548006975842
cycle= 5 E= -507.945031442985  delta_E= -1.48e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7005115127438  E_coul = 198.75548006975842
  HOMO = -0.23780667877526  LUMO = 10.0813427022773
  mo_energy =
[-1.20316879e+02 -1.23748071e+01 -6.67526355e+00 -6.67526355e+00
 -6.67526355e+00 -1.16387928e+00 -2.37806679e-01 -2.37806679e-01
 -2.37806679e-01  1.00813427e+01  1.09963995e+02  6.04596832e+02
  2.74421457e+03  1.22233998e+04  4.08449472e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7005114194915  E_coul = 198.75547997650642
Extra cycle  E= -507.945031442985  delta_E= 3.41e-13  |g|= 7.48e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907706.1728218927
E1 = -706.7005114194915  E_coul = 198.75547997650642
init E= -507.945031442985
    CPU time for initialize scf      1.56 sec, wall time      0.10 sec
  HOMO = -0.237806680381965  LUMO = 10.0813426991848
  mo_energy =
[-1.20316879e+02 -1.23748071e+01 -6.67526356e+00 -6.67526356e+00
 -6.67526356e+00 -1.16387928e+00 -2.37806680e-01 -2.37806680e-01
 -2.37806680e-01  1.00813427e+01  1.09963995e+02  6.04596832e+02
  2.74421457e+03  1.22233998e+04  4.08449472e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7005114152587  E_coul = 198.75547997227343
cycle= 1 E= -507.945031442985  delta_E= -2.27e-13  |g|= 1.08e-09  |ddm|= 3.6e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.7005114152587  E_coul = 198.75547997227343
  HOMO = -0.237806680460864  LUMO = 10.081342699041
  mo_energy =
[-1.20316879e+02 -1.23748071e+01 -6.67526356e+00 -6.67526356e+00
 -6.67526356e+00 -1.16387928e+00 -2.37806680e-01 -2.37806680e-01
 -2.37806680e-01  1.00813427e+01  1.09963995e+02  6.04596832e+02
  2.74421457e+03  1.22233998e+04  4.08449472e+04  1.04888614e+05
  2.30072071e+05  4.55887018e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7005114150753  E_coul = 198.75547997209003
Extra cycle  E= -507.945031442985  delta_E=    0  |g|= 2.07e-09  |ddm|= 1.69e-10
    CPU time for scf_cycle      1.74 sec, wall time      0.17 sec
exp = [1.17616814e+05 3.96630373e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349198e+03 1.83758108e+04 1.44977636e+03 3.73963936e+02
 1.13320114e+02 3.77720161e+01 8.08918176e+00 3.20487087e+00
 8.60387009e+00 4.93006719e-01]
grad_E = [ 4.16271392e-09  1.46115182e-05  1.85254629e-11  1.12135807e-10
  6.47667340e-10  2.53973185e-09  1.05505546e-08  5.67798988e-08
  3.56997736e-06  1.21866840e-07  6.00228032e-06 -1.33690915e-05
  1.10298675e-05  1.63412949e-05 -7.65806389e-06  2.12804551e-06
 -2.75036079e-07  6.77221547e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814261        1
[INPUT] 0    0    [1    /1   ]  0.396632535043       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210194        1
[INPUT] 0    0    [1    /1   ]  36754.7203036        1
[INPUT] 0    0    [1    /1   ]  7303.49197582        1
[INPUT] 0    0    [1    /1   ]  18375.8107648        1
[INPUT] 0    0    [1    /1   ]  1449.77635063        1
[INPUT] 0    0    [1    /1   ]  373.963954588        1
[INPUT] 0    0    [1    /1   ]  113.320155309        1
[INPUT] 0    0    [1    /1   ]  37.7718207848        1
[INPUT] 0    0    [1    /1   ]  8.08922756595        1
[INPUT] 0    0    [1    /1   ]  3.20487989988        1
[INPUT] 1    0    [1    /1   ]  8.60387608245        1
[INPUT] 1    0    [1    /1   ]  0.493011496698       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426107169, 1.0]], [0, [0.3966325350433999, 1.0]], [0, [1176168.1426189735, 1.0]], [0, [588084.069993083, 1.0]], [0, [294042.03113488, 1.0]], [0, [147020.9921595348, 1.0]], [0, [73510.42101938574, 1.0]], [0, [36754.72030362163, 1.0]], [0, [7303.491975820145, 1.0]], [0, [18375.81076476659, 1.0]], [0, [1449.7763506278345, 1.0]], [0, [373.9639545880143, 1.0]], [0, [113.32015530857173, 1.0]], [0, [37.77182078476426, 1.0]], [0, [8.089227565948073, 1.0]], [0, [3.204879899877695, 1.0]], [1, [8.603876082447748, 1.0]], [1, [0.4930114966975626, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426107]
bas 1, expnt(s) = [0.39663254]
bas 2, expnt(s) = [1176168.14261897]
bas 3, expnt(s) = [588084.06999308]
bas 4, expnt(s) = [294042.03113488]
bas 5, expnt(s) = [147020.99215953]
bas 6, expnt(s) = [73510.42101939]
bas 7, expnt(s) = [36754.72030362]
bas 8, expnt(s) = [7303.49197582]
bas 9, expnt(s) = [18375.81076477]
bas 10, expnt(s) = [1449.77635063]
bas 11, expnt(s) = [373.96395459]
bas 12, expnt(s) = [113.32015531]
bas 13, expnt(s) = [37.77182078]
bas 14, expnt(s) = [8.08922757]
bas 15, expnt(s) = [3.2048799]
bas 16, expnt(s) = [8.60387608]
bas 17, expnt(s) = [0.4930115]
CPU time:        72.48
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96632535e-01 1.26271772e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349198e+03 1.99601105e+03 1.83758108e+04 3.98749275e+03
 1.44977635e+03 5.93595750e+02 3.73963955e+02 2.14850977e+02
 1.13320155e+02 8.77496504e+01 3.77718208e+01 3.84938159e+01
 8.08922757e+00 1.21184009e+01 3.20487990e+00 6.05165058e+00
 8.60387608e+00 4.29884787e+01 4.93011497e-01 1.20519050e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325091265091828
cond(S) = 907706.1694199438
E1 = -689.3981294544786  E_coul = 184.9119156687779
init E= -504.486213785701
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674704822675936  LUMO = 9.18373689187986
  mo_energy =
[-1.21707173e+02 -1.33874935e+01 -7.62805944e+00 -7.62805944e+00
 -7.62805944e+00 -1.64018238e+00 -6.74704823e-01 -6.74704823e-01
 -6.74704823e-01  9.18373689e+00  1.08660228e+02  6.03223657e+02
  2.74292003e+03  1.22222252e+04  4.08438429e+04  1.04887548e+05
  2.30071030e+05  4.55885994e+05  8.44838272e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.070301829366  E_coul = 199.13167203269063
cycle= 1 E= -507.938629796675  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602187
diis-c [-0.36262937  1.        ]
  HOMO = -0.233107076141494  LUMO = 10.0929052970449
  mo_energy =
[-1.20256433e+02 -1.23512664e+01 -6.64600999e+00 -6.64600999e+00
 -6.64600999e+00 -1.16149235e+00 -2.33107076e-01 -2.33107076e-01
 -2.33107076e-01  1.00929053e+01  1.10009402e+02  6.04660277e+02
  2.74429129e+03  1.22234850e+04  4.08450355e+04  1.04888704e+05
  2.30072161e+05  4.55887108e+05  8.44839372e+05  1.52801664e+06
  2.85028404e+06  5.80817134e+06]
E1 = -706.7162277735521  E_coul = 198.7712084481884
cycle= 2 E= -507.945019325364  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152546
diis-c [-2.24097899e-04  4.84946449e-03  9.95150536e-01]
  HOMO = -0.237567317009889  LUMO = 10.0819823430015
  mo_energy =
[-1.20314252e+02 -1.23736701e+01 -6.67388447e+00 -6.67388447e+00
 -6.67388447e+00 -1.16375943e+00 -2.37567317e-01 -2.37567317e-01
 -2.37567317e-01  1.00819823e+01  1.09965920e+02  6.04599154e+02
  2.74421732e+03  1.22234028e+04  4.08449503e+04  1.04888617e+05
  2.30072074e+05  4.55887021e+05  8.44839284e+05  1.52801655e+06
  2.85028396e+06  5.80817125e+06]
E1 = -706.7015619037037  E_coul = 198.75653048847124
cycle= 3 E= -507.945031415232  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739857
diis-c [-1.26596355e-08  3.76755842e-05 -5.00648427e-02  1.05002717e+00]
  HOMO = -0.237793920262623  LUMO = 10.081439629277
  mo_energy =
[-1.20316852e+02 -1.23747806e+01 -6.67524217e+00 -6.67524217e+00
 -6.67524217e+00 -1.16386999e+00 -2.37793920e-01 -2.37793920e-01
 -2.37793920e-01  1.00814396e+01  1.09963897e+02  6.04596480e+02
  2.74421426e+03  1.22233996e+04  4.08449469e+04  1.04888614e+05
  2.30072071e+05  4.55887017e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7008243943143  E_coul = 198.7557929488671
cycle= 4 E= -507.945031445447  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46554e-06
diis-c [-4.71843222e-12 -1.76538022e-06  2.30402601e-03 -4.57834964e-02
  1.04348124e+00]
  HOMO = -0.237794672665132  LUMO = 10.0814388641861
  mo_energy =
[-1.20316850e+02 -1.23747830e+01 -6.67524376e+00 -6.67524376e+00
 -6.67524376e+00 -1.16387043e+00 -2.37794673e-01 -2.37794673e-01
 -2.37794673e-01  1.00814389e+01  1.09963897e+02  6.04596483e+02
  2.74421427e+03  1.22233996e+04  4.08449469e+04  1.04888614e+05
  2.30072071e+05  4.55887017e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7008232798493  E_coul = 198.75579183440064
cycle= 5 E= -507.945031445449  delta_E= -1.48e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7008232798493  E_coul = 198.75579183440064
  HOMO = -0.237794706726782  LUMO = 10.0814387944707
  mo_energy =
[-1.20316850e+02 -1.23747832e+01 -6.67524394e+00 -6.67524394e+00
 -6.67524394e+00 -1.16387044e+00 -2.37794707e-01 -2.37794707e-01
 -2.37794707e-01  1.00814388e+01  1.09963897e+02  6.04596482e+02
  2.74421427e+03  1.22233996e+04  4.08449469e+04  1.04888614e+05
  2.30072071e+05  4.55887017e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7008231865906  E_coul = 198.75579174114182
Extra cycle  E= -507.945031445449  delta_E= -1.14e-13  |g|= 7.55e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
exp = [1.17616814e+05 3.96632535e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349198e+03 1.83758108e+04 1.44977635e+03 3.73963955e+02
 1.13320155e+02 3.77718208e+01 8.08922757e+00 3.20487990e+00
 8.60387608e+00 4.93011497e-01]
E = -507.94503144544876
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814261        1
[INPUT] 0    0    [1    /1   ]  0.396632535043       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210194        1
[INPUT] 0    0    [1    /1   ]  36754.7203036        1
[INPUT] 0    0    [1    /1   ]  7303.49197582        1
[INPUT] 0    0    [1    /1   ]  18375.8107648        1
[INPUT] 0    0    [1    /1   ]  1449.77635063        1
[INPUT] 0    0    [1    /1   ]  373.963954588        1
[INPUT] 0    0    [1    /1   ]  113.320155309        1
[INPUT] 0    0    [1    /1   ]  37.7718207848        1
[INPUT] 0    0    [1    /1   ]  8.08922756595        1
[INPUT] 0    0    [1    /1   ]  3.20487989988        1
[INPUT] 1    0    [1    /1   ]  8.60387608245        1
[INPUT] 1    0    [1    /1   ]  0.493011496698       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426107169, 1.0]], [0, [0.3966325350433999, 1.0]], [0, [1176168.1426189735, 1.0]], [0, [588084.069993083, 1.0]], [0, [294042.03113488, 1.0]], [0, [147020.9921595348, 1.0]], [0, [73510.42101938574, 1.0]], [0, [36754.72030362163, 1.0]], [0, [7303.491975820145, 1.0]], [0, [18375.81076476659, 1.0]], [0, [1449.7763506278345, 1.0]], [0, [373.9639545880143, 1.0]], [0, [113.32015530857173, 1.0]], [0, [37.77182078476426, 1.0]], [0, [8.089227565948073, 1.0]], [0, [3.204879899877695, 1.0]], [1, [8.603876082447748, 1.0]], [1, [0.4930114966975626, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426107]
bas 1, expnt(s) = [0.39663254]
bas 2, expnt(s) = [1176168.14261897]
bas 3, expnt(s) = [588084.06999308]
bas 4, expnt(s) = [294042.03113488]
bas 5, expnt(s) = [147020.99215953]
bas 6, expnt(s) = [73510.42101939]
bas 7, expnt(s) = [36754.72030362]
bas 8, expnt(s) = [7303.49197582]
bas 9, expnt(s) = [18375.81076477]
bas 10, expnt(s) = [1449.77635063]
bas 11, expnt(s) = [373.96395459]
bas 12, expnt(s) = [113.32015531]
bas 13, expnt(s) = [37.77182078]
bas 14, expnt(s) = [8.08922757]
bas 15, expnt(s) = [3.2048799]
bas 16, expnt(s) = [8.60387608]
bas 17, expnt(s) = [0.4930115]
CPU time:        72.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96632535e-01 1.26271772e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349198e+03 1.99601105e+03 1.83758108e+04 3.98749275e+03
 1.44977635e+03 5.93595750e+02 3.73963955e+02 2.14850977e+02
 1.13320155e+02 8.77496504e+01 3.77718208e+01 3.84938159e+01
 8.08922757e+00 1.21184009e+01 3.20487990e+00 6.05165058e+00
 8.60387608e+00 4.29884787e+01 4.93011497e-01 1.20519050e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325091265091828
cond(S) = 907706.1694199438
E1 = -689.3981294544786  E_coul = 184.9119156687779
init E= -504.486213785701
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674704822675936  LUMO = 9.18373689187986
  mo_energy =
[-1.21707173e+02 -1.33874935e+01 -7.62805944e+00 -7.62805944e+00
 -7.62805944e+00 -1.64018238e+00 -6.74704823e-01 -6.74704823e-01
 -6.74704823e-01  9.18373689e+00  1.08660228e+02  6.03223657e+02
  2.74292003e+03  1.22222252e+04  4.08438429e+04  1.04887548e+05
  2.30071030e+05  4.55885994e+05  8.44838272e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.070301829366  E_coul = 199.13167203269063
cycle= 1 E= -507.938629796675  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602187
diis-c [-0.36262937  1.        ]
  HOMO = -0.233107076141494  LUMO = 10.0929052970449
  mo_energy =
[-1.20256433e+02 -1.23512664e+01 -6.64600999e+00 -6.64600999e+00
 -6.64600999e+00 -1.16149235e+00 -2.33107076e-01 -2.33107076e-01
 -2.33107076e-01  1.00929053e+01  1.10009402e+02  6.04660277e+02
  2.74429129e+03  1.22234850e+04  4.08450355e+04  1.04888704e+05
  2.30072161e+05  4.55887108e+05  8.44839372e+05  1.52801664e+06
  2.85028404e+06  5.80817134e+06]
E1 = -706.7162277735521  E_coul = 198.7712084481884
cycle= 2 E= -507.945019325364  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152546
diis-c [-2.24097899e-04  4.84946449e-03  9.95150536e-01]
  HOMO = -0.237567317009889  LUMO = 10.0819823430015
  mo_energy =
[-1.20314252e+02 -1.23736701e+01 -6.67388447e+00 -6.67388447e+00
 -6.67388447e+00 -1.16375943e+00 -2.37567317e-01 -2.37567317e-01
 -2.37567317e-01  1.00819823e+01  1.09965920e+02  6.04599154e+02
  2.74421732e+03  1.22234028e+04  4.08449503e+04  1.04888617e+05
  2.30072074e+05  4.55887021e+05  8.44839284e+05  1.52801655e+06
  2.85028396e+06  5.80817125e+06]
E1 = -706.7015619037037  E_coul = 198.75653048847124
cycle= 3 E= -507.945031415232  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739857
diis-c [-1.26596355e-08  3.76755842e-05 -5.00648427e-02  1.05002717e+00]
  HOMO = -0.237793920262623  LUMO = 10.081439629277
  mo_energy =
[-1.20316852e+02 -1.23747806e+01 -6.67524217e+00 -6.67524217e+00
 -6.67524217e+00 -1.16386999e+00 -2.37793920e-01 -2.37793920e-01
 -2.37793920e-01  1.00814396e+01  1.09963897e+02  6.04596480e+02
  2.74421426e+03  1.22233996e+04  4.08449469e+04  1.04888614e+05
  2.30072071e+05  4.55887017e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7008243943143  E_coul = 198.7557929488671
cycle= 4 E= -507.945031445447  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46554e-06
diis-c [-4.71843222e-12 -1.76538022e-06  2.30402601e-03 -4.57834964e-02
  1.04348124e+00]
  HOMO = -0.237794672665132  LUMO = 10.0814388641861
  mo_energy =
[-1.20316850e+02 -1.23747830e+01 -6.67524376e+00 -6.67524376e+00
 -6.67524376e+00 -1.16387043e+00 -2.37794673e-01 -2.37794673e-01
 -2.37794673e-01  1.00814389e+01  1.09963897e+02  6.04596483e+02
  2.74421427e+03  1.22233996e+04  4.08449469e+04  1.04888614e+05
  2.30072071e+05  4.55887017e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7008232798493  E_coul = 198.75579183440064
cycle= 5 E= -507.945031445449  delta_E= -1.48e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7008232798493  E_coul = 198.75579183440064
  HOMO = -0.237794706726782  LUMO = 10.0814387944707
  mo_energy =
[-1.20316850e+02 -1.23747832e+01 -6.67524394e+00 -6.67524394e+00
 -6.67524394e+00 -1.16387044e+00 -2.37794707e-01 -2.37794707e-01
 -2.37794707e-01  1.00814388e+01  1.09963897e+02  6.04596482e+02
  2.74421427e+03  1.22233996e+04  4.08449469e+04  1.04888614e+05
  2.30072071e+05  4.55887017e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7008231865906  E_coul = 198.75579174114182
Extra cycle  E= -507.945031445449  delta_E= -1.14e-13  |g|= 7.55e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907706.1694199438
E1 = -706.7008231865906  E_coul = 198.75579174114182
init E= -507.945031445449
    CPU time for initialize scf      1.37 sec, wall time      0.09 sec
  HOMO = -0.237794708333563  LUMO = 10.081438791379
  mo_energy =
[-1.20316850e+02 -1.23747832e+01 -6.67524394e+00 -6.67524394e+00
 -6.67524394e+00 -1.16387044e+00 -2.37794708e-01 -2.37794708e-01
 -2.37794708e-01  1.00814388e+01  1.09963897e+02  6.04596482e+02
  2.74421427e+03  1.22233996e+04  4.08449469e+04  1.04888614e+05
  2.30072071e+05  4.55887017e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7008231823502  E_coul = 198.75579173690164
cycle= 1 E= -507.945031445449  delta_E= 2.27e-13  |g|= 1.42e-09  |ddm|= 3.6e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
E1 = -706.7008231823502  E_coul = 198.75579173690164
  HOMO = -0.237794708412591  LUMO = 10.081438791235
  mo_energy =
[-1.20316850e+02 -1.23747832e+01 -6.67524394e+00 -6.67524394e+00
 -6.67524394e+00 -1.16387044e+00 -2.37794708e-01 -2.37794708e-01
 -2.37794708e-01  1.00814388e+01  1.09963897e+02  6.04596482e+02
  2.74421427e+03  1.22233996e+04  4.08449469e+04  1.04888614e+05
  2.30072071e+05  4.55887017e+05  8.44839281e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7008231821575  E_coul = 198.75579173670909
Extra cycle  E= -507.945031445448  delta_E= 1.14e-13  |g|= 1.53e-09  |ddm|= 1.8e-10
    CPU time for scf_cycle      1.56 sec, wall time      0.15 sec
exp = [1.17616814e+05 3.96632535e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349198e+03 1.83758108e+04 1.44977635e+03 3.73963955e+02
 1.13320155e+02 3.77718208e+01 8.08922757e+00 3.20487990e+00
 8.60387608e+00 4.93011497e-01]
grad_E = [ 4.16263381e-09  5.54434812e-05  1.85245120e-11  1.12133207e-10
  6.47654939e-10  2.53968234e-09  1.05503459e-08  5.67788693e-08
  3.56990354e-06  1.21863715e-07  6.00661128e-06 -1.34352118e-05
  1.14960571e-05  1.50915231e-05 -7.64211440e-06  3.65500790e-06
  1.27649287e-07  2.44123726e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:19 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814261        1
[INPUT] 0    0    [1    /1   ]  0.396635808318       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210193        1
[INPUT] 0    0    [1    /1   ]  36754.7203029        1
[INPUT] 0    0    [1    /1   ]  7303.49193327        1
[INPUT] 0    0    [1    /1   ]  18375.8107633        1
[INPUT] 0    0    [1    /1   ]  1449.77627988        1
[INPUT] 0    0    [1    /1   ]  373.96410311         1
[INPUT] 0    0    [1    /1   ]  113.320091462        1
[INPUT] 0    0    [1    /1   ]  37.7714621694        1
[INPUT] 0    0    [1    /1   ]  8.08933877031        1
[INPUT] 0    0    [1    /1   ]  3.20490325214        1
[INPUT] 1    0    [1    /1   ]  8.60388524268        1
[INPUT] 1    0    [1    /1   ]  0.49301872288        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426102208, 1.0]], [0, [0.39663580831834105, 1.0]], [0, [1176168.1426189733, 1.0]], [0, [588084.0699930817, 1.0]], [0, [294042.03113487223, 1.0]], [0, [147020.99215950453, 1.0]], [0, [73510.42101926, 1.0]], [0, [36754.72030294497, 1.0]], [0, [7303.49193327397, 1.0]], [0, [18375.810763314093, 1.0]], [0, [1449.7762798845351, 1.0]], [0, [373.964103110459, 1.0]], [0, [113.32009146184193, 1.0]], [0, [37.771462169407776, 1.0]], [0, [8.089338770313391, 1.0]], [0, [3.204903252135528, 1.0]], [1, [8.603885242677759, 1.0]], [1, [0.493018722880408, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426102]
bas 1, expnt(s) = [0.39663581]
bas 2, expnt(s) = [1176168.14261897]
bas 3, expnt(s) = [588084.06999308]
bas 4, expnt(s) = [294042.03113487]
bas 5, expnt(s) = [147020.9921595]
bas 6, expnt(s) = [73510.42101926]
bas 7, expnt(s) = [36754.72030294]
bas 8, expnt(s) = [7303.49193327]
bas 9, expnt(s) = [18375.81076331]
bas 10, expnt(s) = [1449.77627988]
bas 11, expnt(s) = [373.96410311]
bas 12, expnt(s) = [113.32009146]
bas 13, expnt(s) = [37.77146217]
bas 14, expnt(s) = [8.08933877]
bas 15, expnt(s) = [3.20490325]
bas 16, expnt(s) = [8.60388524]
bas 17, expnt(s) = [0.49301872]
CPU time:        77.72
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96635808e-01 1.26272554e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349193e+03 1.99601104e+03 1.83758108e+04 3.98749275e+03
 1.44977628e+03 5.93595728e+02 3.73964103e+02 2.14851041e+02
 1.13320091e+02 8.77496134e+01 3.77714622e+01 3.84935418e+01
 8.08933877e+00 1.21185258e+01 3.20490325e+00 6.05168365e+00
 8.60388524e+00 4.29885359e+01 4.93018723e-01 1.20521259e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32508129807033
cond(S) = 907706.1611750497
E1 = -689.3984680149574  E_coul = 184.91221356851986
init E= -504.486254446438
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674695246360904  LUMO = 9.18393674195554
  mo_energy =
[-1.21707143e+02 -1.33874686e+01 -7.62804081e+00 -7.62804081e+00
 -7.62804081e+00 -1.64017611e+00 -6.74695246e-01 -6.74695246e-01
 -6.74695246e-01  9.18393674e+00  1.08660105e+02  6.03222856e+02
  2.74291932e+03  1.22222245e+04  4.08438422e+04  1.04887548e+05
  2.30071029e+05  4.55885993e+05  8.44838271e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.0707691237614  E_coul = 199.13213923155465
cycle= 1 E= -507.938629892207  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602187
diis-c [-0.36262953  1.        ]
  HOMO = -0.233088986628708  LUMO = 10.0931186575923
  mo_energy =
[-1.20256391e+02 -1.23512306e+01 -6.64598075e+00 -6.64598075e+00
 -6.64598075e+00 -1.16147904e+00 -2.33088987e-01 -2.33088987e-01
 -2.33088987e-01  1.00931187e+01  1.10009290e+02  6.04659488e+02
  2.74429059e+03  1.22234844e+04  4.08450348e+04  1.04888703e+05
  2.30072161e+05  4.55887107e+05  8.44839372e+05  1.52801664e+06
  2.85028404e+06  5.80817134e+06]
E1 = -706.7166997650712  E_coul = 198.7716804331902
cycle= 2 E= -507.945019331881  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152547
diis-c [-2.24099254e-04  4.84938779e-03  9.95150612e-01]
  HOMO = -0.237549201616688  LUMO = 10.0821957845219
  mo_energy =
[-1.20314209e+02 -1.23736338e+01 -6.67385478e+00 -6.67385478e+00
 -6.67385478e+00 -1.16374606e+00 -2.37549202e-01 -2.37549202e-01
 -2.37549202e-01  1.00821958e+01  1.09965809e+02  6.04598365e+02
  2.74421663e+03  1.22234022e+04  4.08449496e+04  1.04888617e+05
  2.30072073e+05  4.55887020e+05  8.44839284e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.70203422006  E_coul = 198.75700279872518
cycle= 3 E= -507.945031421335  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739855
diis-c [-1.26586763e-08  3.76741837e-05 -5.00645744e-02  1.05002690e+00]
  HOMO = -0.237775800880871  LUMO = 10.0816530806016
  mo_energy =
[-1.20316809e+02 -1.23747443e+01 -6.67521245e+00 -6.67521245e+00
 -6.67521245e+00 -1.16385663e+00 -2.37775801e-01 -2.37775801e-01
 -2.37775801e-01  1.00816531e+01  1.09963785e+02  6.04595691e+02
  2.74421357e+03  1.22233989e+04  4.08449462e+04  1.04888613e+05
  2.30072070e+05  4.55887017e+05  8.44839280e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7012967348649  E_coul = 198.75626528331762
cycle= 4 E= -507.945031451547  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46561e-06
diis-c [-4.71903935e-12 -1.76622560e-06  2.30407867e-03 -4.57847089e-02
  1.04348240e+00]
  HOMO = -0.23777655318822  LUMO = 10.0816523156766
  mo_energy =
[-1.20316807e+02 -1.23747467e+01 -6.67521404e+00 -6.67521404e+00
 -6.67521404e+00 -1.16385706e+00 -2.37776553e-01 -2.37776553e-01
 -2.37776553e-01  1.00816523e+01  1.09963786e+02  6.04595694e+02
  2.74421358e+03  1.22233989e+04  4.08449462e+04  1.04888613e+05
  2.30072070e+05  4.55887017e+05  8.44839280e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7012956206481  E_coul = 198.75626416909924
cycle= 5 E= -507.945031451549  delta_E= -1.59e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7012956206481  E_coul = 198.75626416909924
  HOMO = -0.237776587244583  LUMO = 10.0816522459725
  mo_energy =
[-1.20316807e+02 -1.23747469e+01 -6.67521422e+00 -6.67521422e+00
 -6.67521422e+00 -1.16385708e+00 -2.37776587e-01 -2.37776587e-01
 -2.37776587e-01  1.00816522e+01  1.09963785e+02  6.04595693e+02
  2.74421358e+03  1.22233989e+04  4.08449462e+04  1.04888613e+05
  2.30072070e+05  4.55887017e+05  8.44839280e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7012955273818  E_coul = 198.75626407583252
Extra cycle  E= -507.945031451549  delta_E= -4.55e-13  |g|= 7.39e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
exp = [1.17616814e+05 3.96635808e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349193e+03 1.83758108e+04 1.44977628e+03 3.73964103e+02
 1.13320091e+02 3.77714622e+01 8.08933877e+00 3.20490325e+00
 8.60388524e+00 4.93018723e-01]
E = -507.9450314515493
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:19 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814261        1
[INPUT] 0    0    [1    /1   ]  0.396635808318       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210193        1
[INPUT] 0    0    [1    /1   ]  36754.7203029        1
[INPUT] 0    0    [1    /1   ]  7303.49193327        1
[INPUT] 0    0    [1    /1   ]  18375.8107633        1
[INPUT] 0    0    [1    /1   ]  1449.77627988        1
[INPUT] 0    0    [1    /1   ]  373.96410311         1
[INPUT] 0    0    [1    /1   ]  113.320091462        1
[INPUT] 0    0    [1    /1   ]  37.7714621694        1
[INPUT] 0    0    [1    /1   ]  8.08933877031        1
[INPUT] 0    0    [1    /1   ]  3.20490325214        1
[INPUT] 1    0    [1    /1   ]  8.60388524268        1
[INPUT] 1    0    [1    /1   ]  0.49301872288        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426102208, 1.0]], [0, [0.39663580831834105, 1.0]], [0, [1176168.1426189733, 1.0]], [0, [588084.0699930817, 1.0]], [0, [294042.03113487223, 1.0]], [0, [147020.99215950453, 1.0]], [0, [73510.42101926, 1.0]], [0, [36754.72030294497, 1.0]], [0, [7303.49193327397, 1.0]], [0, [18375.810763314093, 1.0]], [0, [1449.7762798845351, 1.0]], [0, [373.964103110459, 1.0]], [0, [113.32009146184193, 1.0]], [0, [37.771462169407776, 1.0]], [0, [8.089338770313391, 1.0]], [0, [3.204903252135528, 1.0]], [1, [8.603885242677759, 1.0]], [1, [0.493018722880408, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426102]
bas 1, expnt(s) = [0.39663581]
bas 2, expnt(s) = [1176168.14261897]
bas 3, expnt(s) = [588084.06999308]
bas 4, expnt(s) = [294042.03113487]
bas 5, expnt(s) = [147020.9921595]
bas 6, expnt(s) = [73510.42101926]
bas 7, expnt(s) = [36754.72030294]
bas 8, expnt(s) = [7303.49193327]
bas 9, expnt(s) = [18375.81076331]
bas 10, expnt(s) = [1449.77627988]
bas 11, expnt(s) = [373.96410311]
bas 12, expnt(s) = [113.32009146]
bas 13, expnt(s) = [37.77146217]
bas 14, expnt(s) = [8.08933877]
bas 15, expnt(s) = [3.20490325]
bas 16, expnt(s) = [8.60388524]
bas 17, expnt(s) = [0.49301872]
CPU time:        78.23
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96635808e-01 1.26272554e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349193e+03 1.99601104e+03 1.83758108e+04 3.98749275e+03
 1.44977628e+03 5.93595728e+02 3.73964103e+02 2.14851041e+02
 1.13320091e+02 8.77496134e+01 3.77714622e+01 3.84935418e+01
 8.08933877e+00 1.21185258e+01 3.20490325e+00 6.05168365e+00
 8.60388524e+00 4.29885359e+01 4.93018723e-01 1.20521259e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32508129807033
cond(S) = 907706.1611750497
E1 = -689.3984680149574  E_coul = 184.91221356851986
init E= -504.486254446438
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674695246360904  LUMO = 9.18393674195554
  mo_energy =
[-1.21707143e+02 -1.33874686e+01 -7.62804081e+00 -7.62804081e+00
 -7.62804081e+00 -1.64017611e+00 -6.74695246e-01 -6.74695246e-01
 -6.74695246e-01  9.18393674e+00  1.08660105e+02  6.03222856e+02
  2.74291932e+03  1.22222245e+04  4.08438422e+04  1.04887548e+05
  2.30071029e+05  4.55885993e+05  8.44838271e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.0707691237614  E_coul = 199.13213923155465
cycle= 1 E= -507.938629892207  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.18 sec, wall time      0.01 sec
diis-norm(errvec)=0.602187
diis-c [-0.36262953  1.        ]
  HOMO = -0.233088986628708  LUMO = 10.0931186575923
  mo_energy =
[-1.20256391e+02 -1.23512306e+01 -6.64598075e+00 -6.64598075e+00
 -6.64598075e+00 -1.16147904e+00 -2.33088987e-01 -2.33088987e-01
 -2.33088987e-01  1.00931187e+01  1.10009290e+02  6.04659488e+02
  2.74429059e+03  1.22234844e+04  4.08450348e+04  1.04888703e+05
  2.30072161e+05  4.55887107e+05  8.44839372e+05  1.52801664e+06
  2.85028404e+06  5.80817134e+06]
E1 = -706.7166997650712  E_coul = 198.7716804331902
cycle= 2 E= -507.945019331881  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152547
diis-c [-2.24099254e-04  4.84938779e-03  9.95150612e-01]
  HOMO = -0.237549201616688  LUMO = 10.0821957845219
  mo_energy =
[-1.20314209e+02 -1.23736338e+01 -6.67385478e+00 -6.67385478e+00
 -6.67385478e+00 -1.16374606e+00 -2.37549202e-01 -2.37549202e-01
 -2.37549202e-01  1.00821958e+01  1.09965809e+02  6.04598365e+02
  2.74421663e+03  1.22234022e+04  4.08449496e+04  1.04888617e+05
  2.30072073e+05  4.55887020e+05  8.44839284e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.70203422006  E_coul = 198.75700279872518
cycle= 3 E= -507.945031421335  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739855
diis-c [-1.26586763e-08  3.76741837e-05 -5.00645744e-02  1.05002690e+00]
  HOMO = -0.237775800880871  LUMO = 10.0816530806016
  mo_energy =
[-1.20316809e+02 -1.23747443e+01 -6.67521245e+00 -6.67521245e+00
 -6.67521245e+00 -1.16385663e+00 -2.37775801e-01 -2.37775801e-01
 -2.37775801e-01  1.00816531e+01  1.09963785e+02  6.04595691e+02
  2.74421357e+03  1.22233989e+04  4.08449462e+04  1.04888613e+05
  2.30072070e+05  4.55887017e+05  8.44839280e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7012967348649  E_coul = 198.75626528331762
cycle= 4 E= -507.945031451547  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46561e-06
diis-c [-4.71903935e-12 -1.76622560e-06  2.30407867e-03 -4.57847089e-02
  1.04348240e+00]
  HOMO = -0.23777655318822  LUMO = 10.0816523156766
  mo_energy =
[-1.20316807e+02 -1.23747467e+01 -6.67521404e+00 -6.67521404e+00
 -6.67521404e+00 -1.16385706e+00 -2.37776553e-01 -2.37776553e-01
 -2.37776553e-01  1.00816523e+01  1.09963786e+02  6.04595694e+02
  2.74421358e+03  1.22233989e+04  4.08449462e+04  1.04888613e+05
  2.30072070e+05  4.55887017e+05  8.44839280e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7012956206481  E_coul = 198.75626416909924
cycle= 5 E= -507.945031451549  delta_E= -1.59e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7012956206481  E_coul = 198.75626416909924
  HOMO = -0.237776587244583  LUMO = 10.0816522459725
  mo_energy =
[-1.20316807e+02 -1.23747469e+01 -6.67521422e+00 -6.67521422e+00
 -6.67521422e+00 -1.16385708e+00 -2.37776587e-01 -2.37776587e-01
 -2.37776587e-01  1.00816522e+01  1.09963785e+02  6.04595693e+02
  2.74421358e+03  1.22233989e+04  4.08449462e+04  1.04888613e+05
  2.30072070e+05  4.55887017e+05  8.44839280e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7012955273818  E_coul = 198.75626407583252
Extra cycle  E= -507.945031451549  delta_E= -4.55e-13  |g|= 7.39e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907706.1611750497
E1 = -706.7012955273818  E_coul = 198.75626407583252
init E= -507.945031451549
    CPU time for initialize scf      1.34 sec, wall time      0.09 sec
  HOMO = -0.237776588851577  LUMO = 10.0816522428792
  mo_energy =
[-1.20316807e+02 -1.23747469e+01 -6.67521422e+00 -6.67521422e+00
 -6.67521422e+00 -1.16385708e+00 -2.37776589e-01 -2.37776589e-01
 -2.37776589e-01  1.00816522e+01  1.09963785e+02  6.04595693e+02
  2.74421358e+03  1.22233989e+04  4.08449462e+04  1.04888613e+05
  2.30072070e+05  4.55887017e+05  8.44839280e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7012955231635  E_coul = 198.75626407161437
cycle= 1 E= -507.945031451549  delta_E= 2.27e-13  |g|= 2.01e-09  |ddm|= 3.58e-09
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
E1 = -706.7012955231635  E_coul = 198.75626407161437
  HOMO = -0.237776588930147  LUMO = 10.0816522427367
  mo_energy =
[-1.20316807e+02 -1.23747469e+01 -6.67521422e+00 -6.67521422e+00
 -6.67521422e+00 -1.16385708e+00 -2.37776589e-01 -2.37776589e-01
 -2.37776589e-01  1.00816522e+01  1.09963785e+02  6.04595693e+02
  2.74421358e+03  1.22233989e+04  4.08449462e+04  1.04888613e+05
  2.30072070e+05  4.55887017e+05  8.44839280e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7012955229999  E_coul = 198.7562640714508
Extra cycle  E= -507.945031451549  delta_E=    0  |g|= 1.52e-09  |ddm|= 1.51e-10
    CPU time for scf_cycle      1.53 sec, wall time      0.15 sec
exp = [1.17616814e+05 3.96635808e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349193e+03 1.83758108e+04 1.44977628e+03 3.73964103e+02
 1.13320091e+02 3.77714622e+01 8.08933877e+00 3.20490325e+00
 8.60388524e+00 4.93018723e-01]
grad_E = [ 4.16254788e-09  1.17279007e-04  1.85234932e-11  1.12130419e-10
  6.47641638e-10  2.53962924e-09  1.05501221e-08  5.67777646e-08
  3.56982362e-06  1.21860361e-07  6.01158333e-06 -1.35205286e-05
  1.21771494e-05  1.31164900e-05 -7.35291921e-06  5.84283817e-06
  8.19763159e-07  5.10895586e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814261        1
[INPUT] 0    0    [1    /1   ]  0.396640971896       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.992159        1
[INPUT] 0    0    [1    /1   ]  73510.4210188        1
[INPUT] 0    0    [1    /1   ]  36754.7203006        1
[INPUT] 0    0    [1    /1   ]  7303.49178385        1
[INPUT] 0    0    [1    /1   ]  18375.8107582        1
[INPUT] 0    0    [1    /1   ]  1449.7760288         1
[INPUT] 0    0    [1    /1   ]  373.964660686        1
[INPUT] 0    0    [1    /1   ]  113.319642397        1
[INPUT] 0    0    [1    /1   ]  37.7707458188        1
[INPUT] 0    0    [1    /1   ]  8.08962199931        1
[INPUT] 0    0    [1    /1   ]  3.20496736954        1
[INPUT] 1    0    [1    /1   ]  8.60389975616        1
[INPUT] 1    0    [1    /1   ]  0.493030167344       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426084785, 1.0]], [0, [0.3966409718956414, 1.0]], [0, [1176168.1426189726, 1.0]], [0, [588084.0699930771, 1.0]], [0, [294042.0311348451, 1.0]], [0, [147020.9921593982, 1.0]], [0, [73510.4210188184, 1.0]], [0, [36754.72030056839, 1.0]], [0, [7303.491783849098, 1.0]], [0, [18375.810758213218, 1.0]], [0, [1449.7760288008592, 1.0]], [0, [373.9646606860444, 1.0]], [0, [113.31964239653254, 1.0]], [0, [37.770745818782, 1.0]], [0, [8.089621999313954, 1.0]], [0, [3.2049673695421435, 1.0]], [1, [8.603899756162507, 1.0]], [1, [0.4930301673442868, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426085]
bas 1, expnt(s) = [0.39664097]
bas 2, expnt(s) = [1176168.14261897]
bas 3, expnt(s) = [588084.06999308]
bas 4, expnt(s) = [294042.03113485]
bas 5, expnt(s) = [147020.9921594]
bas 6, expnt(s) = [73510.42101882]
bas 7, expnt(s) = [36754.72030057]
bas 8, expnt(s) = [7303.49178385]
bas 9, expnt(s) = [18375.81075821]
bas 10, expnt(s) = [1449.7760288]
bas 11, expnt(s) = [373.96466069]
bas 12, expnt(s) = [113.3196424]
bas 13, expnt(s) = [37.77074582]
bas 14, expnt(s) = [8.089622]
bas 15, expnt(s) = [3.20496737]
bas 16, expnt(s) = [8.60389976]
bas 17, expnt(s) = [0.49303017]
CPU time:        83.00
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96640972e-01 1.26273787e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349178e+03 1.99601101e+03 1.83758108e+04 3.98749275e+03
 1.44977603e+03 5.93595651e+02 3.73964661e+02 2.14851281e+02
 1.13319642e+02 8.77493525e+01 3.77707458e+01 3.84929942e+01
 8.08962200e+00 1.21188440e+01 3.20496737e+00 6.05177445e+00
 8.60389976e+00 4.29886265e+01 4.93030167e-01 1.20524756e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32506549100634
cond(S) = 907706.1392994012
E1 = -689.3990020977576  E_coul = 184.912683972728
init E= -504.48631812503
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674680112191993  LUMO = 9.18442969664889
  mo_energy =
[-1.21707095e+02 -1.33874291e+01 -7.62801144e+00 -7.62801144e+00
 -7.62801144e+00 -1.64016622e+00 -6.74680112e-01 -6.74680112e-01
 -6.74680112e-01  9.18442970e+00  1.08660031e+02  6.03220929e+02
  2.74291764e+03  1.22222228e+04  4.08438404e+04  1.04887546e+05
  2.30071027e+05  4.55885991e+05  8.44838269e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.071505174365  E_coul = 199.132875013782
cycle= 1 E= -507.938630160583  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.22 sec, wall time      0.02 sec
diis-norm(errvec)=0.602187
diis-c [-0.36262965  1.        ]
  HOMO = -0.233060406414931  LUMO = 10.0936373860211
  mo_energy =
[-1.20256324e+02 -1.23511739e+01 -6.64593480e+00 -6.64593480e+00
 -6.64593480e+00 -1.16145806e+00 -2.33060406e-01 -2.33060406e-01
 -2.33060406e-01  1.00936374e+01  1.10009232e+02  6.04657579e+02
  2.74428893e+03  1.22234827e+04  4.08450329e+04  1.04888701e+05
  2.30072159e+05  4.55887105e+05  8.44839369e+05  1.52801664e+06
  2.85028404e+06  5.80817133e+06]
E1 = -706.7174486842349  E_coul = 198.772429335381
cycle= 2 E= -507.945019348854  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0152547
diis-c [-2.24100555e-04  4.84920972e-03  9.95150790e-01]
  HOMO = -0.237520478016379  LUMO = 10.0827147194794
  mo_energy =
[-1.20314141e+02 -1.23735761e+01 -6.67380768e+00 -6.67380768e+00
 -6.67380768e+00 -1.16372493e+00 -2.37520478e-01 -2.37520478e-01
 -2.37520478e-01  1.00827147e+01  1.09965753e+02  6.04596458e+02
  2.74421496e+03  1.22234005e+04  4.08449477e+04  1.04888615e+05
  2.30072071e+05  4.55887018e+05  8.44839282e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.7027840244467  E_coul = 198.7577525872701
cycle= 3 E= -507.945031437177  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739844
diis-c [-1.26558664e-08  3.76701362e-05 -5.00639119e-02  1.05002624e+00]
  HOMO = -0.237747063109154  LUMO = 10.0821720411381
  mo_energy =
[-1.20316741e+02 -1.23746865e+01 -6.67516526e+00 -6.67516526e+00
 -6.67516526e+00 -1.16383549e+00 -2.37747063e-01 -2.37747063e-01
 -2.37747063e-01  1.00821720e+01  1.09963729e+02  6.04593784e+02
  2.74421191e+03  1.22233973e+04  4.08449444e+04  1.04888611e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7020466044437  E_coul = 198.7570151370591
cycle= 4 E= -507.945031467385  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46435e-06
diis-c [-4.71584182e-12 -1.76647808e-06  2.30371850e-03 -4.57774910e-02
  1.04347554e+00]
  HOMO = -0.237747815137184  LUMO = 10.0821712766994
  mo_energy =
[-1.20316739e+02 -1.23746890e+01 -6.67516685e+00 -6.67516685e+00
 -6.67516685e+00 -1.16383592e+00 -2.37747815e-01 -2.37747815e-01
 -2.37747815e-01  1.00821713e+01  1.09963730e+02  6.04593786e+02
  2.74421191e+03  1.22233973e+04  4.08449444e+04  1.04888611e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7020454909654  E_coul = 198.75701402357902
cycle= 5 E= -507.945031467386  delta_E= -1.76e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7020454909654  E_coul = 198.75701402357902
  HOMO = -0.237747849191849  LUMO = 10.0821712070004
  mo_energy =
[-1.20316739e+02 -1.23746891e+01 -6.67516702e+00 -6.67516702e+00
 -6.67516702e+00 -1.16383593e+00 -2.37747849e-01 -2.37747849e-01
 -2.37747849e-01  1.00821712e+01  1.09963729e+02  6.04593786e+02
  2.74421191e+03  1.22233973e+04  4.08449444e+04  1.04888611e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7020453977183  E_coul = 198.75701393033177
Extra cycle  E= -507.945031467387  delta_E= -1.71e-13  |g|= 7.66e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.47 sec, wall time      0.12 sec
exp = [1.17616814e+05 3.96640972e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349178e+03 1.83758108e+04 1.44977603e+03 3.73964661e+02
 1.13319642e+02 3.77707458e+01 8.08962200e+00 3.20496737e+00
 8.60389976e+00 4.93030167e-01]
E = -507.9450314673865
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814261        1
[INPUT] 0    0    [1    /1   ]  0.396640971896       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.992159        1
[INPUT] 0    0    [1    /1   ]  73510.4210188        1
[INPUT] 0    0    [1    /1   ]  36754.7203006        1
[INPUT] 0    0    [1    /1   ]  7303.49178385        1
[INPUT] 0    0    [1    /1   ]  18375.8107582        1
[INPUT] 0    0    [1    /1   ]  1449.7760288         1
[INPUT] 0    0    [1    /1   ]  373.964660686        1
[INPUT] 0    0    [1    /1   ]  113.319642397        1
[INPUT] 0    0    [1    /1   ]  37.7707458188        1
[INPUT] 0    0    [1    /1   ]  8.08962199931        1
[INPUT] 0    0    [1    /1   ]  3.20496736954        1
[INPUT] 1    0    [1    /1   ]  8.60389975616        1
[INPUT] 1    0    [1    /1   ]  0.493030167344       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426084785, 1.0]], [0, [0.3966409718956414, 1.0]], [0, [1176168.1426189726, 1.0]], [0, [588084.0699930771, 1.0]], [0, [294042.0311348451, 1.0]], [0, [147020.9921593982, 1.0]], [0, [73510.4210188184, 1.0]], [0, [36754.72030056839, 1.0]], [0, [7303.491783849098, 1.0]], [0, [18375.810758213218, 1.0]], [0, [1449.7760288008592, 1.0]], [0, [373.9646606860444, 1.0]], [0, [113.31964239653254, 1.0]], [0, [37.770745818782, 1.0]], [0, [8.089621999313954, 1.0]], [0, [3.2049673695421435, 1.0]], [1, [8.603899756162507, 1.0]], [1, [0.4930301673442868, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426085]
bas 1, expnt(s) = [0.39664097]
bas 2, expnt(s) = [1176168.14261897]
bas 3, expnt(s) = [588084.06999308]
bas 4, expnt(s) = [294042.03113485]
bas 5, expnt(s) = [147020.9921594]
bas 6, expnt(s) = [73510.42101882]
bas 7, expnt(s) = [36754.72030057]
bas 8, expnt(s) = [7303.49178385]
bas 9, expnt(s) = [18375.81075821]
bas 10, expnt(s) = [1449.7760288]
bas 11, expnt(s) = [373.96466069]
bas 12, expnt(s) = [113.3196424]
bas 13, expnt(s) = [37.77074582]
bas 14, expnt(s) = [8.089622]
bas 15, expnt(s) = [3.20496737]
bas 16, expnt(s) = [8.60389976]
bas 17, expnt(s) = [0.49303017]
CPU time:        83.57
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96640972e-01 1.26273787e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656080e+03
 7.30349178e+03 1.99601101e+03 1.83758108e+04 3.98749275e+03
 1.44977603e+03 5.93595651e+02 3.73964661e+02 2.14851281e+02
 1.13319642e+02 8.77493525e+01 3.77707458e+01 3.84929942e+01
 8.08962200e+00 1.21188440e+01 3.20496737e+00 6.05177445e+00
 8.60389976e+00 4.29886265e+01 4.93030167e-01 1.20524756e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32506549100634
cond(S) = 907706.1392994012
E1 = -689.3990020977576  E_coul = 184.912683972728
init E= -504.48631812503
    CPU time for initialize scf      0.19 sec, wall time      0.03 sec
  HOMO = -0.674680112191993  LUMO = 9.18442969664889
  mo_energy =
[-1.21707095e+02 -1.33874291e+01 -7.62801144e+00 -7.62801144e+00
 -7.62801144e+00 -1.64016622e+00 -6.74680112e-01 -6.74680112e-01
 -6.74680112e-01  9.18442970e+00  1.08660031e+02  6.03220929e+02
  2.74291764e+03  1.22222228e+04  4.08438404e+04  1.04887546e+05
  2.30071027e+05  4.55885991e+05  8.44838269e+05  1.52801555e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.071505174365  E_coul = 199.132875013782
cycle= 1 E= -507.938630160583  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.19 sec, wall time      0.01 sec
diis-norm(errvec)=0.602187
diis-c [-0.36262965  1.        ]
  HOMO = -0.233060406414931  LUMO = 10.0936373860211
  mo_energy =
[-1.20256324e+02 -1.23511739e+01 -6.64593480e+00 -6.64593480e+00
 -6.64593480e+00 -1.16145806e+00 -2.33060406e-01 -2.33060406e-01
 -2.33060406e-01  1.00936374e+01  1.10009232e+02  6.04657579e+02
  2.74428893e+03  1.22234827e+04  4.08450329e+04  1.04888701e+05
  2.30072159e+05  4.55887105e+05  8.44839369e+05  1.52801664e+06
  2.85028404e+06  5.80817133e+06]
E1 = -706.7174486842349  E_coul = 198.772429335381
cycle= 2 E= -507.945019348854  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152547
diis-c [-2.24100555e-04  4.84920972e-03  9.95150790e-01]
  HOMO = -0.237520478016379  LUMO = 10.0827147194794
  mo_energy =
[-1.20314141e+02 -1.23735761e+01 -6.67380768e+00 -6.67380768e+00
 -6.67380768e+00 -1.16372493e+00 -2.37520478e-01 -2.37520478e-01
 -2.37520478e-01  1.00827147e+01  1.09965753e+02  6.04596458e+02
  2.74421496e+03  1.22234005e+04  4.08449477e+04  1.04888615e+05
  2.30072071e+05  4.55887018e+05  8.44839282e+05  1.52801655e+06
  2.85028395e+06  5.80817125e+06]
E1 = -706.7027840244467  E_coul = 198.7577525872701
cycle= 3 E= -507.945031437177  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739844
diis-c [-1.26558664e-08  3.76701362e-05 -5.00639119e-02  1.05002624e+00]
  HOMO = -0.237747063109154  LUMO = 10.0821720411381
  mo_energy =
[-1.20316741e+02 -1.23746865e+01 -6.67516526e+00 -6.67516526e+00
 -6.67516526e+00 -1.16383549e+00 -2.37747063e-01 -2.37747063e-01
 -2.37747063e-01  1.00821720e+01  1.09963729e+02  6.04593784e+02
  2.74421191e+03  1.22233973e+04  4.08449444e+04  1.04888611e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7020466044437  E_coul = 198.7570151370591
cycle= 4 E= -507.945031467385  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46435e-06
diis-c [-4.71584182e-12 -1.76647808e-06  2.30371850e-03 -4.57774910e-02
  1.04347554e+00]
  HOMO = -0.237747815137184  LUMO = 10.0821712766994
  mo_energy =
[-1.20316739e+02 -1.23746890e+01 -6.67516685e+00 -6.67516685e+00
 -6.67516685e+00 -1.16383592e+00 -2.37747815e-01 -2.37747815e-01
 -2.37747815e-01  1.00821713e+01  1.09963730e+02  6.04593786e+02
  2.74421191e+03  1.22233973e+04  4.08449444e+04  1.04888611e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7020454909654  E_coul = 198.75701402357902
cycle= 5 E= -507.945031467386  delta_E= -1.76e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7020454909654  E_coul = 198.75701402357902
  HOMO = -0.237747849191849  LUMO = 10.0821712070004
  mo_energy =
[-1.20316739e+02 -1.23746891e+01 -6.67516702e+00 -6.67516702e+00
 -6.67516702e+00 -1.16383593e+00 -2.37747849e-01 -2.37747849e-01
 -2.37747849e-01  1.00821712e+01  1.09963729e+02  6.04593786e+02
  2.74421191e+03  1.22233973e+04  4.08449444e+04  1.04888611e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7020453977183  E_coul = 198.75701393033177
Extra cycle  E= -507.945031467387  delta_E= -1.71e-13  |g|= 7.66e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907706.1392994012
E1 = -706.7020453977183  E_coul = 198.75701393033177
init E= -507.945031467387
    CPU time for initialize scf      4.00 sec, wall time      0.27 sec
  HOMO = -0.237747850798589  LUMO = 10.0821712039079
  mo_energy =
[-1.20316739e+02 -1.23746891e+01 -6.67516703e+00 -6.67516703e+00
 -6.67516703e+00 -1.16383594e+00 -2.37747851e-01 -2.37747851e-01
 -2.37747851e-01  1.00821712e+01  1.09963729e+02  6.04593786e+02
  2.74421191e+03  1.22233973e+04  4.08449444e+04  1.04888611e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.702045393486  E_coul = 198.75701392609975
cycle= 1 E= -507.945031467386  delta_E= 2.84e-13  |g|= 1.63e-09  |ddm|= 3.6e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.702045393486  E_coul = 198.75701392609975
  HOMO = -0.237747850877478  LUMO = 10.0821712037645
  mo_energy =
[-1.20316739e+02 -1.23746891e+01 -6.67516703e+00 -6.67516703e+00
 -6.67516703e+00 -1.16383594e+00 -2.37747851e-01 -2.37747851e-01
 -2.37747851e-01  1.00821712e+01  1.09963729e+02  6.04593786e+02
  2.74421191e+03  1.22233973e+04  4.08449444e+04  1.04888611e+05
  2.30072068e+05  4.55887014e+05  8.44839278e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7020453933048  E_coul = 198.75701392591867
Extra cycle  E= -507.945031467386  delta_E= 5.68e-14  |g|= 1.27e-09  |ddm|= 1.67e-10
    CPU time for scf_cycle      4.18 sec, wall time      0.34 sec
exp = [1.17616814e+05 3.96640972e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349178e+03 1.83758108e+04 1.44977603e+03 3.73964661e+02
 1.13319642e+02 3.77707458e+01 8.08962200e+00 3.20496737e+00
 8.60389976e+00 4.93030167e-01]
grad_E = [ 4.16251635e-09  2.15317589e-04  1.85231235e-11  1.12129397e-10
  6.47636763e-10  2.53960976e-09  1.05500399e-08  5.67773577e-08
  3.56979137e-06  1.21859125e-07  6.01469142e-06 -1.36083856e-05
  1.31391524e-05  9.88919127e-06 -6.33940627e-06  9.38017352e-06
  1.95873456e-06  9.33704222e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.81426         1
[INPUT] 0    0    [1    /1   ]  0.39664840577        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.992159        1
[INPUT] 0    0    [1    /1   ]  73510.4210175        1
[INPUT] 0    0    [1    /1   ]  36754.7202937        1
[INPUT] 0    0    [1    /1   ]  7303.4913542         1
[INPUT] 0    0    [1    /1   ]  18375.8107435        1
[INPUT] 0    0    [1    /1   ]  1449.77530376        1
[INPUT] 0    0    [1    /1   ]  373.966306185        1
[INPUT] 0    0    [1    /1   ]  113.318086398        1
[INPUT] 0    0    [1    /1   ]  37.7693266351        1
[INPUT] 0    0    [1    /1   ]  8.09030836463        1
[INPUT] 0    0    [1    /1   ]  3.20513075514        1
[INPUT] 1    0    [1    /1   ]  8.60392073458        1
[INPUT] 1    0    [1    /1   ]  0.493046775074       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426034686, 1.0]], [0, [0.39664840576962673, 1.0]], [0, [1176168.1426189702, 1.0]], [0, [588084.0699930636, 1.0]], [0, [294042.03113476717, 1.0]], [0, [147020.99215909257, 1.0]], [0, [73510.42101754862, 1.0]], [0, [36754.7202937348, 1.0]], [0, [7303.491354199461, 1.0]], [0, [18375.81074354683, 1.0]], [0, [1449.7753037592029, 1.0]], [0, [373.96630618485386, 1.0]], [0, [113.31808639818986, 1.0]], [0, [37.76932663509194, 1.0]], [0, [8.090308364628283, 1.0]], [0, [3.2051307551415, 1.0]], [1, [8.603920734576517, 1.0]], [1, [0.4930467750742175, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426035]
bas 1, expnt(s) = [0.39664841]
bas 2, expnt(s) = [1176168.14261897]
bas 3, expnt(s) = [588084.06999306]
bas 4, expnt(s) = [294042.03113477]
bas 5, expnt(s) = [147020.99215909]
bas 6, expnt(s) = [73510.42101755]
bas 7, expnt(s) = [36754.72029373]
bas 8, expnt(s) = [7303.4913542]
bas 9, expnt(s) = [18375.81074355]
bas 10, expnt(s) = [1449.77530376]
bas 11, expnt(s) = [373.96630618]
bas 12, expnt(s) = [113.3180864]
bas 13, expnt(s) = [37.76932664]
bas 14, expnt(s) = [8.09030836]
bas 15, expnt(s) = [3.20513076]
bas 16, expnt(s) = [8.60392073]
bas 17, expnt(s) = [0.49304678]
CPU time:        90.92
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96648406e-01 1.26275562e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656079e+03
 7.30349135e+03 1.99601092e+03 1.83758107e+04 3.98749275e+03
 1.44977530e+03 5.93595428e+02 3.73966306e+02 2.14851990e+02
 1.13318086e+02 8.77484489e+01 3.77693266e+01 3.84919095e+01
 8.09030836e+00 1.21196152e+01 3.20513076e+00 6.05200583e+00
 8.60392073e+00 4.29887575e+01 4.93046775e-01 1.20529830e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325042497983908
cond(S) = 907706.085643772
E1 = -689.399771083695  E_coul = 184.9133625670962
init E= -504.486408516599
    CPU time for initialize scf      4.53 sec, wall time      0.34 sec
  HOMO = -0.674658232016884  LUMO = 9.18560026894628
  mo_energy =
[-1.21707027e+02 -1.33873717e+01 -7.62796915e+00 -7.62796915e+00
 -7.62796915e+00 -1.64015193e+00 -6.74658232e-01 -6.74658232e-01
 -6.74658232e-01  9.18560027e+00  1.08660234e+02  6.03216433e+02
  2.74291370e+03  1.22222189e+04  4.08438357e+04  1.04887540e+05
  2.30071022e+05  4.55885986e+05  8.44838264e+05  1.52801554e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.0725626312027  E_coul = 199.13393177879493
cycle= 1 E= -507.938630852408  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
diis-norm(errvec)=0.602187
diis-c [-0.36262947  1.        ]
  HOMO = -0.233019108205307  LUMO = 10.0948566506699
  mo_energy =
[-1.20256229e+02 -1.23510922e+01 -6.64586904e+00 -6.64586904e+00
 -6.64586904e+00 -1.16142784e+00 -2.33019108e-01 -2.33019108e-01
 -2.33019108e-01  1.00948567e+01  1.10009458e+02  6.04653107e+02
  2.74428502e+03  1.22234788e+04  4.08450283e+04  1.04888696e+05
  2.30072153e+05  4.55887100e+05  8.44839364e+05  1.52801663e+06
  2.85028404e+06  5.80817133e+06]
E1 = -706.7185388427052  E_coul = 198.77351945225428
cycle= 2 E= -507.945019390451  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152546
diis-c [-2.24100230e-04  4.84880892e-03  9.95151191e-01]
  HOMO = -0.237478707382744  LUMO = 10.0839344866765
  mo_energy =
[-1.20314042e+02 -1.23734918e+01 -6.67373909e+00 -6.67373909e+00
 -6.67373909e+00 -1.16369435e+00 -2.37478707e-01 -2.37478707e-01
 -2.37478707e-01  1.00839345e+01  1.09965981e+02  6.04591990e+02
  2.74421105e+03  1.22233966e+04  4.08449431e+04  1.04888610e+05
  2.30072066e+05  4.55887013e+05  8.44839276e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7038764242341  E_coul = 198.7588449483265
cycle= 3 E= -507.945031475908  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739814
diis-c [-1.26485961e-08  3.76638377e-05 -5.00623591e-02  1.05002470e+00]
  HOMO = -0.237705251648691  LUMO = 10.0833918714103
  mo_energy =
[-1.20316642e+02 -1.23746020e+01 -6.67509645e+00 -6.67509645e+00
 -6.67509645e+00 -1.16380488e+00 -2.37705252e-01 -2.37705252e-01
 -2.37705252e-01  1.00833919e+01  1.09963958e+02  6.04589316e+02
  2.74420800e+03  1.22233933e+04  4.08449397e+04  1.04888606e+05
  2.30072063e+05  4.55887009e+05  8.44839273e+05  1.52801654e+06
  2.85028394e+06  5.80817124e+06]
E1 = -706.7031391681212  E_coul = 198.75810766201704
cycle= 4 E= -507.945031506104  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46246e-06
diis-c [-4.71649880e-12 -1.76525849e-06  2.30321297e-03 -4.57682134e-02
  1.04346677e+00]
  HOMO = -0.237706002979179  LUMO = 10.0833911081778
  mo_energy =
[-1.20316639e+02 -1.23746045e+01 -6.67509803e+00 -6.67509803e+00
 -6.67509803e+00 -1.16380531e+00 -2.37706003e-01 -2.37706003e-01
 -2.37706003e-01  1.00833911e+01  1.09963958e+02  6.04589319e+02
  2.74420801e+03  1.22233933e+04  4.08449397e+04  1.04888606e+05
  2.30072063e+05  4.55887009e+05  8.44839273e+05  1.52801654e+06
  2.85028394e+06  5.80817124e+06]
E1 = -706.7031380564282  E_coul = 198.75810655032333
cycle= 5 E= -507.945031506105  delta_E= -7.39e-13  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7031380564282  E_coul = 198.75810655032333
  HOMO = -0.237706037029435  LUMO = 10.0833910384846
  mo_energy =
[-1.20316640e+02 -1.23746046e+01 -6.67509820e+00 -6.67509820e+00
 -6.67509820e+00 -1.16380533e+00 -2.37706037e-01 -2.37706037e-01
 -2.37706037e-01  1.00833910e+01  1.09963958e+02  6.04589319e+02
  2.74420800e+03  1.22233933e+04  4.08449397e+04  1.04888606e+05
  2.30072063e+05  4.55887009e+05  8.44839273e+05  1.52801654e+06
  2.85028394e+06  5.80817124e+06]
E1 = -706.703137963206  E_coul = 198.75810645710092
Extra cycle  E= -507.945031506105  delta_E= -2.27e-13  |g|= 7.66e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      4.73 sec, wall time      0.42 sec
exp = [1.17616814e+05 3.96648406e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349135e+03 1.83758107e+04 1.44977530e+03 3.73966306e+02
 1.13318086e+02 3.77693266e+01 8.09030836e+00 3.20513076e+00
 8.60392073e+00 4.93046775e-01]
E = -507.9450315061051
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.81426         1
[INPUT] 0    0    [1    /1   ]  0.39664840577        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.992159        1
[INPUT] 0    0    [1    /1   ]  73510.4210175        1
[INPUT] 0    0    [1    /1   ]  36754.7202937        1
[INPUT] 0    0    [1    /1   ]  7303.4913542         1
[INPUT] 0    0    [1    /1   ]  18375.8107435        1
[INPUT] 0    0    [1    /1   ]  1449.77530376        1
[INPUT] 0    0    [1    /1   ]  373.966306185        1
[INPUT] 0    0    [1    /1   ]  113.318086398        1
[INPUT] 0    0    [1    /1   ]  37.7693266351        1
[INPUT] 0    0    [1    /1   ]  8.09030836463        1
[INPUT] 0    0    [1    /1   ]  3.20513075514        1
[INPUT] 1    0    [1    /1   ]  8.60392073458        1
[INPUT] 1    0    [1    /1   ]  0.493046775074       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81426034686, 1.0]], [0, [0.39664840576962673, 1.0]], [0, [1176168.1426189702, 1.0]], [0, [588084.0699930636, 1.0]], [0, [294042.03113476717, 1.0]], [0, [147020.99215909257, 1.0]], [0, [73510.42101754862, 1.0]], [0, [36754.7202937348, 1.0]], [0, [7303.491354199461, 1.0]], [0, [18375.81074354683, 1.0]], [0, [1449.7753037592029, 1.0]], [0, [373.96630618485386, 1.0]], [0, [113.31808639818986, 1.0]], [0, [37.76932663509194, 1.0]], [0, [8.090308364628283, 1.0]], [0, [3.2051307551415, 1.0]], [1, [8.603920734576517, 1.0]], [1, [0.4930467750742175, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81426035]
bas 1, expnt(s) = [0.39664841]
bas 2, expnt(s) = [1176168.14261897]
bas 3, expnt(s) = [588084.06999306]
bas 4, expnt(s) = [294042.03113477]
bas 5, expnt(s) = [147020.99215909]
bas 6, expnt(s) = [73510.42101755]
bas 7, expnt(s) = [36754.72029373]
bas 8, expnt(s) = [7303.4913542]
bas 9, expnt(s) = [18375.81074355]
bas 10, expnt(s) = [1449.77530376]
bas 11, expnt(s) = [373.96630618]
bas 12, expnt(s) = [113.3180864]
bas 13, expnt(s) = [37.76932664]
bas 14, expnt(s) = [8.09030836]
bas 15, expnt(s) = [3.20513076]
bas 16, expnt(s) = [8.60392073]
bas 17, expnt(s) = [0.49304678]
CPU time:        95.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96648406e-01 1.26275562e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656079e+03
 7.30349135e+03 1.99601092e+03 1.83758107e+04 3.98749275e+03
 1.44977530e+03 5.93595428e+02 3.73966306e+02 2.14851990e+02
 1.13318086e+02 8.77484489e+01 3.77693266e+01 3.84919095e+01
 8.09030836e+00 1.21196152e+01 3.20513076e+00 6.05200583e+00
 8.60392073e+00 4.29887575e+01 4.93046775e-01 1.20529830e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325042497983908
cond(S) = 907706.085643772
E1 = -689.399771083695  E_coul = 184.9133625670962
init E= -504.486408516599
    CPU time for initialize scf      4.47 sec, wall time      0.34 sec
  HOMO = -0.674658232016884  LUMO = 9.18560026894628
  mo_energy =
[-1.21707027e+02 -1.33873717e+01 -7.62796915e+00 -7.62796915e+00
 -7.62796915e+00 -1.64015193e+00 -6.74658232e-01 -6.74658232e-01
 -6.74658232e-01  9.18560027e+00  1.08660234e+02  6.03216433e+02
  2.74291370e+03  1.22222189e+04  4.08438357e+04  1.04887540e+05
  2.30071022e+05  4.55885986e+05  8.44838264e+05  1.52801554e+06
  2.85028296e+06  5.80817026e+06]
E1 = -707.0725626312027  E_coul = 199.13393177879493
cycle= 1 E= -507.938630852408  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.602187
diis-c [-0.36262947  1.        ]
  HOMO = -0.233019108205307  LUMO = 10.0948566506699
  mo_energy =
[-1.20256229e+02 -1.23510922e+01 -6.64586904e+00 -6.64586904e+00
 -6.64586904e+00 -1.16142784e+00 -2.33019108e-01 -2.33019108e-01
 -2.33019108e-01  1.00948567e+01  1.10009458e+02  6.04653107e+02
  2.74428502e+03  1.22234788e+04  4.08450283e+04  1.04888696e+05
  2.30072153e+05  4.55887100e+05  8.44839364e+05  1.52801663e+06
  2.85028404e+06  5.80817133e+06]
E1 = -706.7185388427052  E_coul = 198.77351945225428
cycle= 2 E= -507.945019390451  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152546
diis-c [-2.24100230e-04  4.84880892e-03  9.95151191e-01]
  HOMO = -0.237478707382744  LUMO = 10.0839344866765
  mo_energy =
[-1.20314042e+02 -1.23734918e+01 -6.67373909e+00 -6.67373909e+00
 -6.67373909e+00 -1.16369435e+00 -2.37478707e-01 -2.37478707e-01
 -2.37478707e-01  1.00839345e+01  1.09965981e+02  6.04591990e+02
  2.74421105e+03  1.22233966e+04  4.08449431e+04  1.04888610e+05
  2.30072066e+05  4.55887013e+05  8.44839276e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7038764242341  E_coul = 198.7588449483265
cycle= 3 E= -507.945031475908  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739814
diis-c [-1.26485961e-08  3.76638377e-05 -5.00623591e-02  1.05002470e+00]
  HOMO = -0.237705251648691  LUMO = 10.0833918714103
  mo_energy =
[-1.20316642e+02 -1.23746020e+01 -6.67509645e+00 -6.67509645e+00
 -6.67509645e+00 -1.16380488e+00 -2.37705252e-01 -2.37705252e-01
 -2.37705252e-01  1.00833919e+01  1.09963958e+02  6.04589316e+02
  2.74420800e+03  1.22233933e+04  4.08449397e+04  1.04888606e+05
  2.30072063e+05  4.55887009e+05  8.44839273e+05  1.52801654e+06
  2.85028394e+06  5.80817124e+06]
E1 = -706.7031391681212  E_coul = 198.75810766201704
cycle= 4 E= -507.945031506104  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46246e-06
diis-c [-4.71649880e-12 -1.76525849e-06  2.30321297e-03 -4.57682134e-02
  1.04346677e+00]
  HOMO = -0.237706002979179  LUMO = 10.0833911081778
  mo_energy =
[-1.20316639e+02 -1.23746045e+01 -6.67509803e+00 -6.67509803e+00
 -6.67509803e+00 -1.16380531e+00 -2.37706003e-01 -2.37706003e-01
 -2.37706003e-01  1.00833911e+01  1.09963958e+02  6.04589319e+02
  2.74420801e+03  1.22233933e+04  4.08449397e+04  1.04888606e+05
  2.30072063e+05  4.55887009e+05  8.44839273e+05  1.52801654e+06
  2.85028394e+06  5.80817124e+06]
E1 = -706.7031380564282  E_coul = 198.75810655032333
cycle= 5 E= -507.945031506105  delta_E= -7.39e-13  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7031380564282  E_coul = 198.75810655032333
  HOMO = -0.237706037029435  LUMO = 10.0833910384846
  mo_energy =
[-1.20316640e+02 -1.23746046e+01 -6.67509820e+00 -6.67509820e+00
 -6.67509820e+00 -1.16380533e+00 -2.37706037e-01 -2.37706037e-01
 -2.37706037e-01  1.00833910e+01  1.09963958e+02  6.04589319e+02
  2.74420800e+03  1.22233933e+04  4.08449397e+04  1.04888606e+05
  2.30072063e+05  4.55887009e+05  8.44839273e+05  1.52801654e+06
  2.85028394e+06  5.80817124e+06]
E1 = -706.703137963206  E_coul = 198.75810645710092
Extra cycle  E= -507.945031506105  delta_E= -2.27e-13  |g|= 7.66e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      4.72 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907706.085643772
E1 = -706.703137963206  E_coul = 198.75810645710092
init E= -507.945031506105
    CPU time for initialize scf      9.55 sec, wall time      0.69 sec
  HOMO = -0.237706038635683  LUMO = 10.0833910353913
  mo_energy =
[-1.20316640e+02 -1.23746046e+01 -6.67509821e+00 -6.67509821e+00
 -6.67509821e+00 -1.16380533e+00 -2.37706039e-01 -2.37706039e-01
 -2.37706039e-01  1.00833910e+01  1.09963958e+02  6.04589319e+02
  2.74420800e+03  1.22233933e+04  4.08449397e+04  1.04888606e+05
  2.30072063e+05  4.55887009e+05  8.44839273e+05  1.52801654e+06
  2.85028394e+06  5.80817124e+06]
E1 = -706.7031379589939  E_coul = 198.7581064528886
cycle= 1 E= -507.945031506105  delta_E= -2.27e-13  |g|= 1.59e-09  |ddm|= 3.58e-09
    CPU time for cycle= 1      0.07 sec, wall time      0.01 sec
E1 = -706.7031379589939  E_coul = 198.7581064528886
  HOMO = -0.237706038714197  LUMO = 10.0833910352491
  mo_energy =
[-1.20316640e+02 -1.23746046e+01 -6.67509821e+00 -6.67509821e+00
 -6.67509821e+00 -1.16380533e+00 -2.37706039e-01 -2.37706039e-01
 -2.37706039e-01  1.00833910e+01  1.09963958e+02  6.04589319e+02
  2.74420800e+03  1.22233933e+04  4.08449397e+04  1.04888606e+05
  2.30072063e+05  4.55887009e+05  8.44839273e+05  1.52801654e+06
  2.85028394e+06  5.80817124e+06]
E1 = -706.7031379587928  E_coul = 198.7581064526873
Extra cycle  E= -507.945031506106  delta_E= -1.71e-13  |g|= 9.61e-10  |ddm|= 1.85e-10
    CPU time for scf_cycle      9.69 sec, wall time      0.76 sec
exp = [1.17616814e+05 3.96648406e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349135e+03 1.83758107e+04 1.44977530e+03 3.73966306e+02
 1.13318086e+02 3.77693266e+01 8.09030836e+00 3.20513076e+00
 8.60392073e+00 4.93046775e-01]
grad_E = [ 4.16274429e-09  3.57846634e-04  1.85258432e-11  1.12136799e-10
  6.47672065e-10  2.53975063e-09  1.05506335e-08  5.67802815e-08
  3.56999155e-06  1.21868002e-07  6.00670668e-06 -1.36113339e-05
  1.42195190e-05  4.98073035e-06 -3.47397136e-06  1.48037828e-05
  3.64522082e-06  1.54819811e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814259        1
[INPUT] 0    0    [1    /1   ]  0.396657312155       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.992158        1
[INPUT] 0    0    [1    /1   ]  73510.4210144        1
[INPUT] 0    0    [1    /1   ]  36754.7202766        1
[INPUT] 0    0    [1    /1   ]  7303.49027747        1
[INPUT] 0    0    [1    /1   ]  18375.8107068        1
[INPUT] 0    0    [1    /1   ]  1449.77348274        1
[INPUT] 0    0    [1    /1   ]  373.970485075        1
[INPUT] 0    0    [1    /1   ]  113.313840302        1
[INPUT] 0    0    [1    /1   ]  37.7666111731        1
[INPUT] 0    0    [1    /1   ]  8.09185709916        1
[INPUT] 0    0    [1    /1   ]  3.20551183067        1
[INPUT] 1    0    [1    /1   ]  8.60394604969        1
[INPUT] 1    0    [1    /1   ]  0.49306701866        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81425909133, 1.0]], [0, [0.3966573121551628, 1.0]], [0, [1176168.1426189647, 1.0]], [0, [588084.0699930297, 1.0]], [0, [294042.0311345718, 1.0]], [0, [147020.99215832655, 1.0]], [0, [73510.42101436648, 1.0]], [0, [36754.72027660923, 1.0]], [0, [7303.490277468972, 1.0]], [0, [18375.810706792472, 1.0]], [0, [1449.7734827377803, 1.0]], [0, [373.97048507455816, 1.0]], [0, [113.31384030245223, 1.0]], [0, [37.76661117309009, 1.0]], [0, [8.091857099161183, 1.0]], [0, [3.205511830671643, 1.0]], [1, [8.603946049685034, 1.0]], [1, [0.493067018659856, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81425909]
bas 1, expnt(s) = [0.39665731]
bas 2, expnt(s) = [1176168.14261896]
bas 3, expnt(s) = [588084.06999303]
bas 4, expnt(s) = [294042.03113457]
bas 5, expnt(s) = [147020.99215833]
bas 6, expnt(s) = [73510.42101437]
bas 7, expnt(s) = [36754.72027661]
bas 8, expnt(s) = [7303.49027747]
bas 9, expnt(s) = [18375.81070679]
bas 10, expnt(s) = [1449.77348274]
bas 11, expnt(s) = [373.97048507]
bas 12, expnt(s) = [113.3138403]
bas 13, expnt(s) = [37.76661117]
bas 14, expnt(s) = [8.0918571]
bas 15, expnt(s) = [3.20551183]
bas 16, expnt(s) = [8.60394605]
bas 17, expnt(s) = [0.49306702]
CPU time:       112.92
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96657312e-01 1.26277688e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656079e+03
 7.30349028e+03 1.99601070e+03 1.83758107e+04 3.98749274e+03
 1.44977348e+03 5.93594869e+02 3.73970485e+02 2.14853790e+02
 1.13313840e+02 8.77459829e+01 3.77666112e+01 3.84898339e+01
 8.09185710e+00 1.21213552e+01 3.20551183e+00 6.05254549e+00
 8.60394605e+00 4.29889157e+01 4.93067019e-01 1.20536016e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325014334750232
cond(S) = 907705.962945196
E1 = -689.4006925985489  E_coul = 184.91417917451832
init E= -504.486513424031
    CPU time for initialize scf      4.47 sec, wall time      0.34 sec
  HOMO = -0.674631771809922  LUMO = 9.18820433371337
  mo_energy =
[-1.21706946e+02 -1.33873016e+01 -7.62791850e+00 -7.62791850e+00
 -7.62791850e+00 -1.64013468e+00 -6.74631772e-01 -6.74631772e-01
 -6.74631772e-01  9.18820433e+00  1.08661272e+02  6.03206520e+02
  2.74290504e+03  1.22222099e+04  4.08438249e+04  1.04887529e+05
  2.30071010e+05  4.55885974e+05  8.44838251e+05  1.52801553e+06
  2.85028294e+06  5.80817025e+06]
E1 = -707.073823896907  E_coul = 199.13519142044967
cycle= 1 E= -507.938632476457  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.602186
diis-c [-0.36262833  1.        ]
  HOMO = -0.232969224399806  LUMO = 10.0975492519843
  mo_energy =
[-1.20256116e+02 -1.23509938e+01 -6.64579130e+00 -6.64579130e+00
 -6.64579130e+00 -1.16139164e+00 -2.32969224e-01 -2.32969224e-01
 -2.32969224e-01  1.00975493e+01  1.10010518e+02  6.04643222e+02
  2.74427638e+03  1.22234699e+04  4.08450176e+04  1.04888684e+05
  2.30072141e+05  4.55887088e+05  8.44839352e+05  1.52801662e+06
  2.85028402e+06  5.80817132e+06]
E1 = -706.7198762382612  E_coul = 198.77485675431123
cycle= 2 E= -507.94501948395  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152543
diis-c [-2.24094086e-04  4.84795049e-03  9.95152050e-01]
  HOMO = -0.237427564405802  LUMO = 10.0866282254148
  mo_energy =
[-1.20313921e+02 -1.23733876e+01 -6.67365491e+00 -6.67365491e+00
 -6.67365491e+00 -1.16365730e+00 -2.37427564e-01 -2.37427564e-01
 -2.37427564e-01  1.00866282e+01  1.09967050e+02  6.04582113e+02
  2.74420242e+03  1.22233877e+04  4.08449324e+04  1.04888598e+05
  2.30072054e+05  4.55887000e+05  8.44839264e+05  1.52801653e+06
  2.85028394e+06  5.80817123e+06]
E1 = -706.7052190245257  E_coul = 198.76018746177448
cycle= 3 E= -507.945031562751  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00873
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739737
diis-c [-1.26320655e-08  3.76430830e-05 -5.00588059e-02  1.05002116e+00]
  HOMO = -0.237654006567253  LUMO = 10.0860857540821
  mo_energy =
[-1.20316520e+02 -1.23744974e+01 -6.67501175e+00 -6.67501175e+00
 -6.67501175e+00 -1.16376777e+00 -2.37654007e-01 -2.37654007e-01
 -2.37654007e-01  1.00860858e+01  1.09965028e+02  6.04579440e+02
  2.74419937e+03  1.22233844e+04  4.08449290e+04  1.04888594e+05
  2.30072051e+05  4.55886997e+05  8.44839261e+05  1.52801653e+06
  2.85028393e+06  5.80817123e+06]
E1 = -706.704482147053  E_coul = 198.75945055413345
cycle= 4 E= -507.94503159292  delta_E= -3.02e-08  |g|= 6.26e-06  |ddm|= 0.000462
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.45745e-06
diis-c [-4.71247367e-12 -1.76361586e-06  2.30184631e-03 -4.57417968e-02
  1.04344171e+00]
  HOMO = -0.237654756259054  LUMO = 10.0860849936813
  mo_energy =
[-1.20316518e+02 -1.23744998e+01 -6.67501333e+00 -6.67501333e+00
 -6.67501333e+00 -1.16376820e+00 -2.37654756e-01 -2.37654756e-01
 -2.37654756e-01  1.00860850e+01  1.09965028e+02  6.04579443e+02
  2.74419938e+03  1.22233844e+04  4.08449290e+04  1.04888594e+05
  2.30072051e+05  4.55886997e+05  8.44839261e+05  1.52801653e+06
  2.85028393e+06  5.80817123e+06]
E1 = -706.704481039628  E_coul = 198.7594494467069
cycle= 5 E= -507.945031592921  delta_E= -1.59e-12  |g|= 1.41e-07  |ddm|= 2.16e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.704481039628  E_coul = 198.7594494467069
  HOMO = -0.237654790299954  LUMO = 10.0860849240005
  mo_energy =
[-1.20316518e+02 -1.23745000e+01 -6.67501350e+00 -6.67501350e+00
 -6.67501350e+00 -1.16376822e+00 -2.37654790e-01 -2.37654790e-01
 -2.37654790e-01  1.00860849e+01  1.09965028e+02  6.04579443e+02
  2.74419938e+03  1.22233844e+04  4.08449290e+04  1.04888594e+05
  2.30072051e+05  4.55886997e+05  8.44839261e+05  1.52801653e+06
  2.85028393e+06  5.80817123e+06]
E1 = -706.7044809464238  E_coul = 198.7594493535027
Extra cycle  E= -507.945031592921  delta_E= 5.68e-14  |g|= 7.43e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      4.72 sec, wall time      0.40 sec
exp = [1.17616814e+05 3.96657312e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349028e+03 1.83758107e+04 1.44977348e+03 3.73970485e+02
 1.13313840e+02 3.77666112e+01 8.09185710e+00 3.20551183e+00
 8.60394605e+00 4.93067019e-01]
E = -507.9450315929211
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814259        1
[INPUT] 0    0    [1    /1   ]  0.396657312155       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.992158        1
[INPUT] 0    0    [1    /1   ]  73510.4210144        1
[INPUT] 0    0    [1    /1   ]  36754.7202766        1
[INPUT] 0    0    [1    /1   ]  7303.49027747        1
[INPUT] 0    0    [1    /1   ]  18375.8107068        1
[INPUT] 0    0    [1    /1   ]  1449.77348274        1
[INPUT] 0    0    [1    /1   ]  373.970485075        1
[INPUT] 0    0    [1    /1   ]  113.313840302        1
[INPUT] 0    0    [1    /1   ]  37.7666111731        1
[INPUT] 0    0    [1    /1   ]  8.09185709916        1
[INPUT] 0    0    [1    /1   ]  3.20551183067        1
[INPUT] 1    0    [1    /1   ]  8.60394604969        1
[INPUT] 1    0    [1    /1   ]  0.49306701866        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81425909133, 1.0]], [0, [0.3966573121551628, 1.0]], [0, [1176168.1426189647, 1.0]], [0, [588084.0699930297, 1.0]], [0, [294042.0311345718, 1.0]], [0, [147020.99215832655, 1.0]], [0, [73510.42101436648, 1.0]], [0, [36754.72027660923, 1.0]], [0, [7303.490277468972, 1.0]], [0, [18375.810706792472, 1.0]], [0, [1449.7734827377803, 1.0]], [0, [373.97048507455816, 1.0]], [0, [113.31384030245223, 1.0]], [0, [37.76661117309009, 1.0]], [0, [8.091857099161183, 1.0]], [0, [3.205511830671643, 1.0]], [1, [8.603946049685034, 1.0]], [1, [0.493067018659856, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81425909]
bas 1, expnt(s) = [0.39665731]
bas 2, expnt(s) = [1176168.14261896]
bas 3, expnt(s) = [588084.06999303]
bas 4, expnt(s) = [294042.03113457]
bas 5, expnt(s) = [147020.99215833]
bas 6, expnt(s) = [73510.42101437]
bas 7, expnt(s) = [36754.72027661]
bas 8, expnt(s) = [7303.49027747]
bas 9, expnt(s) = [18375.81070679]
bas 10, expnt(s) = [1449.77348274]
bas 11, expnt(s) = [373.97048507]
bas 12, expnt(s) = [113.3138403]
bas 13, expnt(s) = [37.76661117]
bas 14, expnt(s) = [8.0918571]
bas 15, expnt(s) = [3.20551183]
bas 16, expnt(s) = [8.60394605]
bas 17, expnt(s) = [0.49306702]
CPU time:       117.72
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96657312e-01 1.26277688e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547203e+04 6.70656079e+03
 7.30349028e+03 1.99601070e+03 1.83758107e+04 3.98749274e+03
 1.44977348e+03 5.93594869e+02 3.73970485e+02 2.14853790e+02
 1.13313840e+02 8.77459829e+01 3.77666112e+01 3.84898339e+01
 8.09185710e+00 1.21213552e+01 3.20551183e+00 6.05254549e+00
 8.60394605e+00 4.29889157e+01 4.93067019e-01 1.20536016e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325014334750232
cond(S) = 907705.962945196
E1 = -689.4006925985489  E_coul = 184.91417917451832
init E= -504.486513424031
    CPU time for initialize scf      4.64 sec, wall time      0.35 sec
  HOMO = -0.674631771809922  LUMO = 9.18820433371337
  mo_energy =
[-1.21706946e+02 -1.33873016e+01 -7.62791850e+00 -7.62791850e+00
 -7.62791850e+00 -1.64013468e+00 -6.74631772e-01 -6.74631772e-01
 -6.74631772e-01  9.18820433e+00  1.08661272e+02  6.03206520e+02
  2.74290504e+03  1.22222099e+04  4.08438249e+04  1.04887529e+05
  2.30071010e+05  4.55885974e+05  8.44838251e+05  1.52801553e+06
  2.85028294e+06  5.80817025e+06]
E1 = -707.073823896907  E_coul = 199.13519142044967
cycle= 1 E= -507.938632476457  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
diis-norm(errvec)=0.602186
diis-c [-0.36262833  1.        ]
  HOMO = -0.232969224399806  LUMO = 10.0975492519843
  mo_energy =
[-1.20256116e+02 -1.23509938e+01 -6.64579130e+00 -6.64579130e+00
 -6.64579130e+00 -1.16139164e+00 -2.32969224e-01 -2.32969224e-01
 -2.32969224e-01  1.00975493e+01  1.10010518e+02  6.04643222e+02
  2.74427638e+03  1.22234699e+04  4.08450176e+04  1.04888684e+05
  2.30072141e+05  4.55887088e+05  8.44839352e+05  1.52801662e+06
  2.85028402e+06  5.80817132e+06]
E1 = -706.7198762382612  E_coul = 198.77485675431123
cycle= 2 E= -507.94501948395  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152543
diis-c [-2.24094086e-04  4.84795049e-03  9.95152050e-01]
  HOMO = -0.237427564405802  LUMO = 10.0866282254148
  mo_energy =
[-1.20313921e+02 -1.23733876e+01 -6.67365491e+00 -6.67365491e+00
 -6.67365491e+00 -1.16365730e+00 -2.37427564e-01 -2.37427564e-01
 -2.37427564e-01  1.00866282e+01  1.09967050e+02  6.04582113e+02
  2.74420242e+03  1.22233877e+04  4.08449324e+04  1.04888598e+05
  2.30072054e+05  4.55887000e+05  8.44839264e+05  1.52801653e+06
  2.85028394e+06  5.80817123e+06]
E1 = -706.7052190245257  E_coul = 198.76018746177448
cycle= 3 E= -507.945031562751  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739737
diis-c [-1.26320655e-08  3.76430830e-05 -5.00588059e-02  1.05002116e+00]
  HOMO = -0.237654006567253  LUMO = 10.0860857540821
  mo_energy =
[-1.20316520e+02 -1.23744974e+01 -6.67501175e+00 -6.67501175e+00
 -6.67501175e+00 -1.16376777e+00 -2.37654007e-01 -2.37654007e-01
 -2.37654007e-01  1.00860858e+01  1.09965028e+02  6.04579440e+02
  2.74419937e+03  1.22233844e+04  4.08449290e+04  1.04888594e+05
  2.30072051e+05  4.55886997e+05  8.44839261e+05  1.52801653e+06
  2.85028393e+06  5.80817123e+06]
E1 = -706.704482147053  E_coul = 198.75945055413345
cycle= 4 E= -507.94503159292  delta_E= -3.02e-08  |g|= 6.26e-06  |ddm|= 0.000462
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.45745e-06
diis-c [-4.71247367e-12 -1.76361586e-06  2.30184631e-03 -4.57417968e-02
  1.04344171e+00]
  HOMO = -0.237654756259054  LUMO = 10.0860849936813
  mo_energy =
[-1.20316518e+02 -1.23744998e+01 -6.67501333e+00 -6.67501333e+00
 -6.67501333e+00 -1.16376820e+00 -2.37654756e-01 -2.37654756e-01
 -2.37654756e-01  1.00860850e+01  1.09965028e+02  6.04579443e+02
  2.74419938e+03  1.22233844e+04  4.08449290e+04  1.04888594e+05
  2.30072051e+05  4.55886997e+05  8.44839261e+05  1.52801653e+06
  2.85028393e+06  5.80817123e+06]
E1 = -706.704481039628  E_coul = 198.7594494467069
cycle= 5 E= -507.945031592921  delta_E= -1.59e-12  |g|= 1.41e-07  |ddm|= 2.16e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.704481039628  E_coul = 198.7594494467069
  HOMO = -0.237654790299954  LUMO = 10.0860849240005
  mo_energy =
[-1.20316518e+02 -1.23745000e+01 -6.67501350e+00 -6.67501350e+00
 -6.67501350e+00 -1.16376822e+00 -2.37654790e-01 -2.37654790e-01
 -2.37654790e-01  1.00860849e+01  1.09965028e+02  6.04579443e+02
  2.74419938e+03  1.22233844e+04  4.08449290e+04  1.04888594e+05
  2.30072051e+05  4.55886997e+05  8.44839261e+05  1.52801653e+06
  2.85028393e+06  5.80817123e+06]
E1 = -706.7044809464238  E_coul = 198.7594493535027
Extra cycle  E= -507.945031592921  delta_E= 5.68e-14  |g|= 7.43e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      4.86 sec, wall time      0.42 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907705.962945196
E1 = -706.7044809464238  E_coul = 198.7594493535027
init E= -507.945031592921
    CPU time for initialize scf      9.42 sec, wall time      0.68 sec
  HOMO = -0.237654791905925  LUMO = 10.0860849209078
  mo_energy =
[-1.20316518e+02 -1.23745000e+01 -6.67501351e+00 -6.67501351e+00
 -6.67501351e+00 -1.16376822e+00 -2.37654792e-01 -2.37654792e-01
 -2.37654792e-01  1.00860849e+01  1.09965028e+02  6.04579443e+02
  2.74419938e+03  1.22233844e+04  4.08449290e+04  1.04888594e+05
  2.30072051e+05  4.55886997e+05  8.44839261e+05  1.52801653e+06
  2.85028393e+06  5.80817123e+06]
E1 = -706.7044809422065  E_coul = 198.75944934928577
cycle= 1 E= -507.945031592921  delta_E= 3.98e-13  |g|= 9.74e-10  |ddm|= 3.59e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.7044809422065  E_coul = 198.75944934928577
  HOMO = -0.237654791984549  LUMO = 10.0860849207648
  mo_energy =
[-1.20316518e+02 -1.23745000e+01 -6.67501351e+00 -6.67501351e+00
 -6.67501351e+00 -1.16376822e+00 -2.37654792e-01 -2.37654792e-01
 -2.37654792e-01  1.00860849e+01  1.09965028e+02  6.04579443e+02
  2.74419938e+03  1.22233844e+04  4.08449290e+04  1.04888594e+05
  2.30072051e+05  4.55886997e+05  8.44839261e+05  1.52801653e+06
  2.85028393e+06  5.80817123e+06]
E1 = -706.7044809420321  E_coul = 198.7594493491111
Extra cycle  E= -507.945031592921  delta_E= -2.84e-13  |g|= 2.7e-09  |ddm|= 1.63e-10
    CPU time for scf_cycle      9.62 sec, wall time      0.75 sec
exp = [1.17616814e+05 3.96657312e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547203e+04
 7.30349028e+03 1.83758107e+04 1.44977348e+03 3.73970485e+02
 1.13313840e+02 3.77666112e+01 8.09185710e+00 3.20551183e+00
 8.60394605e+00 4.93067019e-01]
grad_E = [ 4.16373386e-09  5.32264259e-04  1.85376249e-11  1.12168924e-10
  6.47825292e-10  2.54036218e-09  1.05532109e-08  5.67929841e-08
  3.57087772e-06  1.21906569e-07  5.96448357e-06 -1.32909130e-05
  1.47135158e-05 -1.57912017e-06  3.61055856e-06  2.22039435e-05
  5.75433560e-06  2.29970507e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814257        1
[INPUT] 0    0    [1    /1   ]  0.39666253231        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031134        1
[INPUT] 0    0    [1    /1   ]  147020.992157        1
[INPUT] 0    0    [1    /1   ]  73510.421008         1
[INPUT] 0    0    [1    /1   ]  36754.7202425        1
[INPUT] 0    0    [1    /1   ]  7303.4881332         1
[INPUT] 0    0    [1    /1   ]  18375.8106336        1
[INPUT] 0    0    [1    /1   ]  1449.76985114        1
[INPUT] 0    0    [1    /1   ]  373.978877345        1
[INPUT] 0    0    [1    /1   ]  113.304940794        1
[INPUT] 0    0    [1    /1   ]  37.762285259         1
[INPUT] 0    0    [1    /1   ]  8.09471357566        1
[INPUT] 0    0    [1    /1   ]  3.20623189384        1
[INPUT] 1    0    [1    /1   ]  8.60396136249        1
[INPUT] 1    0    [1    /1   ]  0.493079815196       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81425659101, 1.0]], [0, [0.396662532309866, 1.0]], [0, [1176168.1426189535, 1.0]], [0, [588084.0699929623, 1.0]], [0, [294042.0311341828, 1.0]], [0, [147020.99215680108, 1.0]], [0, [73510.42100802934, 1.0]], [0, [36754.720242504074, 1.0]], [0, [7303.488133196219, 1.0]], [0, [18375.810633598132, 1.0]], [0, [1449.7698511447527, 1.0]], [0, [373.97887734488535, 1.0]], [0, [113.30494079427935, 1.0]], [0, [37.762285258990545, 1.0]], [0, [8.094713575664207, 1.0]], [0, [3.2062318938406116, 1.0]], [1, [8.603961362490974, 1.0]], [1, [0.4930798151962607, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81425659]
bas 1, expnt(s) = [0.39666253]
bas 2, expnt(s) = [1176168.14261895]
bas 3, expnt(s) = [588084.06999296]
bas 4, expnt(s) = [294042.03113418]
bas 5, expnt(s) = [147020.9921568]
bas 6, expnt(s) = [73510.42100803]
bas 7, expnt(s) = [36754.7202425]
bas 8, expnt(s) = [7303.4881332]
bas 9, expnt(s) = [18375.8106336]
bas 10, expnt(s) = [1449.76985114]
bas 11, expnt(s) = [373.97887734]
bas 12, expnt(s) = [113.30494079]
bas 13, expnt(s) = [37.76228526]
bas 14, expnt(s) = [8.09471358]
bas 15, expnt(s) = [3.20623189]
bas 16, expnt(s) = [8.60396136]
bas 17, expnt(s) = [0.49307982]
CPU time:       134.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96662532e-01 1.26278935e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547202e+04 6.70656079e+03
 7.30348813e+03 1.99601026e+03 1.83758106e+04 3.98749273e+03
 1.44976985e+03 5.93593754e+02 3.73978877e+02 2.14857407e+02
 1.13304941e+02 8.77408142e+01 3.77622853e+01 3.84865273e+01
 8.09471358e+00 1.21245642e+01 3.20623189e+00 6.05356516e+00
 8.60396136e+00 4.29890113e+01 4.93079815e-01 1.20539927e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32499618625513
cond(S) = 907705.733070714
E1 = -689.401233480911  E_coul = 184.9146677278576
init E= -504.486565753053
    CPU time for initialize scf      4.52 sec, wall time      0.34 sec
  HOMO = -0.674615596580255  LUMO = 9.19295288811568
  mo_energy =
[-1.21706900e+02 -1.33872569e+01 -7.62788881e+00 -7.62788881e+00
 -7.62788881e+00 -1.64012425e+00 -6.74615597e-01 -6.74615597e-01
 -6.74615597e-01  9.19295289e+00  1.08663983e+02  6.03188490e+02
  2.74288929e+03  1.22221934e+04  4.08438047e+04  1.04887506e+05
  2.30070986e+05  4.55885950e+05  8.44838228e+05  1.52801551e+06
  2.85028292e+06  5.80817022e+06]
E1 = -707.0745482000942  E_coul = 199.13591264413503
cycle= 1 E= -507.938635555959  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.602184
diis-c [-0.36262516  1.        ]
  HOMO = -0.232938895653478  LUMO = 10.1024306374904
  mo_energy =
[-1.20256056e+02 -1.23509349e+01 -6.64574850e+00 -6.64574850e+00
 -6.64574850e+00 -1.16137041e+00 -2.32938896e-01 -2.32938896e-01
 -2.32938896e-01  1.01024306e+01  1.10013231e+02  6.04625201e+02
  2.74426063e+03  1.22234534e+04  4.08449974e+04  1.04888662e+05
  2.30072118e+05  4.55887064e+05  8.44839328e+05  1.52801660e+06
  2.85028400e+06  5.80817129e+06]
E1 = -706.7207442065991  E_coul = 198.7757245546288
cycle= 2 E= -507.94501965197  delta_E= -0.00638  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152535
diis-c [-2.24075105e-04  4.84643228e-03  9.95153568e-01]
  HOMO = -0.237394640123589  LUMO = 10.091511713323
  mo_energy =
[-1.20313843e+02 -1.23733179e+01 -6.67360014e+00 -6.67360014e+00
 -6.67360014e+00 -1.16363447e+00 -2.37394640e-01 -2.37394640e-01
 -2.37394640e-01  1.00915117e+01  1.09969778e+02  6.04564110e+02
  2.74418670e+03  1.22233712e+04  4.08449122e+04  1.04888575e+05
  2.30072031e+05  4.55886977e+05  8.44839241e+05  1.52801651e+06
  2.85028391e+06  5.80817121e+06]
E1 = -706.706096794511  E_coul = 198.76106507627193
cycle= 3 E= -507.945031718239  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00872
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739585
diis-c [-1.26008349e-08  3.76078919e-05 -5.00523411e-02  1.05001473e+00]
  HOMO = -0.23762087990664  LUMO = 10.090969509641
  mo_energy =
[-1.20316441e+02 -1.23744268e+01 -6.67495603e+00 -6.67495603e+00
 -6.67495603e+00 -1.16374482e+00 -2.37620880e-01 -2.37620880e-01
 -2.37620880e-01  1.00909695e+01  1.09967756e+02  6.04561438e+02
  2.74418365e+03  1.22233680e+04  4.08449088e+04  1.04888572e+05
  2.30072027e+05  4.55886973e+05  8.44839237e+05  1.52801651e+06
  2.85028391e+06  5.80817120e+06]
E1 = -706.7053606275059  E_coul = 198.7603288791489
cycle= 4 E= -507.945031748357  delta_E= -3.01e-08  |g|= 6.25e-06  |ddm|= 0.000462
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.44923e-06
diis-c [-4.70748513e-12 -1.76317892e-06  2.29978312e-03 -4.57023760e-02
  1.04340436e+00]
  HOMO = -0.237621626534063  LUMO = 10.0909687545216
  mo_energy =
[-1.20316439e+02 -1.23744292e+01 -6.67495760e+00 -6.67495760e+00
 -6.67495760e+00 -1.16374525e+00 -2.37621627e-01 -2.37621627e-01
 -2.37621627e-01  1.00909688e+01  1.09967757e+02  6.04561441e+02
  2.74418365e+03  1.22233680e+04  4.08449088e+04  1.04888572e+05
  2.30072027e+05  4.55886973e+05  8.44839237e+05  1.52801651e+06
  2.85028391e+06  5.80817120e+06]
E1 = -706.7053595279541  E_coul = 198.76032777959657
cycle= 5 E= -507.945031748358  delta_E= -5.68e-13  |g|= 1.41e-07  |ddm|= 2.16e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7053595279541  E_coul = 198.76032777959657
  HOMO = -0.237621660543176  LUMO = 10.0909686848843
  mo_energy =
[-1.20316439e+02 -1.23744294e+01 -6.67495777e+00 -6.67495777e+00
 -6.67495777e+00 -1.16374527e+00 -2.37621661e-01 -2.37621661e-01
 -2.37621661e-01  1.00909687e+01  1.09967757e+02  6.04561440e+02
  2.74418365e+03  1.22233680e+04  4.08449088e+04  1.04888572e+05
  2.30072027e+05  4.55886973e+05  8.44839237e+05  1.52801651e+06
  2.85028391e+06  5.80817120e+06]
E1 = -706.7053594348688  E_coul = 198.76032768651098
Extra cycle  E= -507.945031748358  delta_E= -2.27e-13  |g|= 7.33e-09  |ddm|= 7.24e-08
    CPU time for scf_cycle      4.79 sec, wall time      0.41 sec
exp = [1.17616814e+05 3.96662532e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547202e+04
 7.30348813e+03 1.83758106e+04 1.44976985e+03 3.73978877e+02
 1.13304941e+02 3.77622853e+01 8.09471358e+00 3.20623189e+00
 8.60396136e+00 4.93079815e-01]
E = -507.9450317483578
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814257        1
[INPUT] 0    0    [1    /1   ]  0.39666253231        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031134        1
[INPUT] 0    0    [1    /1   ]  147020.992157        1
[INPUT] 0    0    [1    /1   ]  73510.421008         1
[INPUT] 0    0    [1    /1   ]  36754.7202425        1
[INPUT] 0    0    [1    /1   ]  7303.4881332         1
[INPUT] 0    0    [1    /1   ]  18375.8106336        1
[INPUT] 0    0    [1    /1   ]  1449.76985114        1
[INPUT] 0    0    [1    /1   ]  373.978877345        1
[INPUT] 0    0    [1    /1   ]  113.304940794        1
[INPUT] 0    0    [1    /1   ]  37.762285259         1
[INPUT] 0    0    [1    /1   ]  8.09471357566        1
[INPUT] 0    0    [1    /1   ]  3.20623189384        1
[INPUT] 1    0    [1    /1   ]  8.60396136249        1
[INPUT] 1    0    [1    /1   ]  0.493079815196       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81425659101, 1.0]], [0, [0.396662532309866, 1.0]], [0, [1176168.1426189535, 1.0]], [0, [588084.0699929623, 1.0]], [0, [294042.0311341828, 1.0]], [0, [147020.99215680108, 1.0]], [0, [73510.42100802934, 1.0]], [0, [36754.720242504074, 1.0]], [0, [7303.488133196219, 1.0]], [0, [18375.810633598132, 1.0]], [0, [1449.7698511447527, 1.0]], [0, [373.97887734488535, 1.0]], [0, [113.30494079427935, 1.0]], [0, [37.762285258990545, 1.0]], [0, [8.094713575664207, 1.0]], [0, [3.2062318938406116, 1.0]], [1, [8.603961362490974, 1.0]], [1, [0.4930798151962607, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81425659]
bas 1, expnt(s) = [0.39666253]
bas 2, expnt(s) = [1176168.14261895]
bas 3, expnt(s) = [588084.06999296]
bas 4, expnt(s) = [294042.03113418]
bas 5, expnt(s) = [147020.9921568]
bas 6, expnt(s) = [73510.42100803]
bas 7, expnt(s) = [36754.7202425]
bas 8, expnt(s) = [7303.4881332]
bas 9, expnt(s) = [18375.8106336]
bas 10, expnt(s) = [1449.76985114]
bas 11, expnt(s) = [373.97887734]
bas 12, expnt(s) = [113.30494079]
bas 13, expnt(s) = [37.76228526]
bas 14, expnt(s) = [8.09471358]
bas 15, expnt(s) = [3.20623189]
bas 16, expnt(s) = [8.60396136]
bas 17, expnt(s) = [0.49307982]
CPU time:       139.85
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96662532e-01 1.26278935e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547202e+04 6.70656079e+03
 7.30348813e+03 1.99601026e+03 1.83758106e+04 3.98749273e+03
 1.44976985e+03 5.93593754e+02 3.73978877e+02 2.14857407e+02
 1.13304941e+02 8.77408142e+01 3.77622853e+01 3.84865273e+01
 8.09471358e+00 1.21245642e+01 3.20623189e+00 6.05356516e+00
 8.60396136e+00 4.29890113e+01 4.93079815e-01 1.20539927e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32499618625513
cond(S) = 907705.733070714
E1 = -689.401233480911  E_coul = 184.9146677278576
init E= -504.486565753053
    CPU time for initialize scf      4.44 sec, wall time      0.33 sec
  HOMO = -0.674615596580255  LUMO = 9.19295288811568
  mo_energy =
[-1.21706900e+02 -1.33872569e+01 -7.62788881e+00 -7.62788881e+00
 -7.62788881e+00 -1.64012425e+00 -6.74615597e-01 -6.74615597e-01
 -6.74615597e-01  9.19295289e+00  1.08663983e+02  6.03188490e+02
  2.74288929e+03  1.22221934e+04  4.08438047e+04  1.04887506e+05
  2.30070986e+05  4.55885950e+05  8.44838228e+05  1.52801551e+06
  2.85028292e+06  5.80817022e+06]
E1 = -707.0745482000942  E_coul = 199.13591264413503
cycle= 1 E= -507.938635555959  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.602184
diis-c [-0.36262516  1.        ]
  HOMO = -0.232938895653478  LUMO = 10.1024306374904
  mo_energy =
[-1.20256056e+02 -1.23509349e+01 -6.64574850e+00 -6.64574850e+00
 -6.64574850e+00 -1.16137041e+00 -2.32938896e-01 -2.32938896e-01
 -2.32938896e-01  1.01024306e+01  1.10013231e+02  6.04625201e+02
  2.74426063e+03  1.22234534e+04  4.08449974e+04  1.04888662e+05
  2.30072118e+05  4.55887064e+05  8.44839328e+05  1.52801660e+06
  2.85028400e+06  5.80817129e+06]
E1 = -706.7207442065991  E_coul = 198.7757245546288
cycle= 2 E= -507.94501965197  delta_E= -0.00638  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152535
diis-c [-2.24075105e-04  4.84643228e-03  9.95153568e-01]
  HOMO = -0.237394640123589  LUMO = 10.091511713323
  mo_energy =
[-1.20313843e+02 -1.23733179e+01 -6.67360014e+00 -6.67360014e+00
 -6.67360014e+00 -1.16363447e+00 -2.37394640e-01 -2.37394640e-01
 -2.37394640e-01  1.00915117e+01  1.09969778e+02  6.04564110e+02
  2.74418670e+03  1.22233712e+04  4.08449122e+04  1.04888575e+05
  2.30072031e+05  4.55886977e+05  8.44839241e+05  1.52801651e+06
  2.85028391e+06  5.80817121e+06]
E1 = -706.706096794511  E_coul = 198.76106507627193
cycle= 3 E= -507.945031718239  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00872
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739585
diis-c [-1.26008349e-08  3.76078919e-05 -5.00523411e-02  1.05001473e+00]
  HOMO = -0.23762087990664  LUMO = 10.090969509641
  mo_energy =
[-1.20316441e+02 -1.23744268e+01 -6.67495603e+00 -6.67495603e+00
 -6.67495603e+00 -1.16374482e+00 -2.37620880e-01 -2.37620880e-01
 -2.37620880e-01  1.00909695e+01  1.09967756e+02  6.04561438e+02
  2.74418365e+03  1.22233680e+04  4.08449088e+04  1.04888572e+05
  2.30072027e+05  4.55886973e+05  8.44839237e+05  1.52801651e+06
  2.85028391e+06  5.80817120e+06]
E1 = -706.7053606275059  E_coul = 198.7603288791489
cycle= 4 E= -507.945031748357  delta_E= -3.01e-08  |g|= 6.25e-06  |ddm|= 0.000462
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.44923e-06
diis-c [-4.70748513e-12 -1.76317892e-06  2.29978312e-03 -4.57023760e-02
  1.04340436e+00]
  HOMO = -0.237621626534063  LUMO = 10.0909687545216
  mo_energy =
[-1.20316439e+02 -1.23744292e+01 -6.67495760e+00 -6.67495760e+00
 -6.67495760e+00 -1.16374525e+00 -2.37621627e-01 -2.37621627e-01
 -2.37621627e-01  1.00909688e+01  1.09967757e+02  6.04561441e+02
  2.74418365e+03  1.22233680e+04  4.08449088e+04  1.04888572e+05
  2.30072027e+05  4.55886973e+05  8.44839237e+05  1.52801651e+06
  2.85028391e+06  5.80817120e+06]
E1 = -706.7053595279541  E_coul = 198.76032777959657
cycle= 5 E= -507.945031748358  delta_E= -5.68e-13  |g|= 1.41e-07  |ddm|= 2.16e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7053595279541  E_coul = 198.76032777959657
  HOMO = -0.237621660543176  LUMO = 10.0909686848843
  mo_energy =
[-1.20316439e+02 -1.23744294e+01 -6.67495777e+00 -6.67495777e+00
 -6.67495777e+00 -1.16374527e+00 -2.37621661e-01 -2.37621661e-01
 -2.37621661e-01  1.00909687e+01  1.09967757e+02  6.04561440e+02
  2.74418365e+03  1.22233680e+04  4.08449088e+04  1.04888572e+05
  2.30072027e+05  4.55886973e+05  8.44839237e+05  1.52801651e+06
  2.85028391e+06  5.80817120e+06]
E1 = -706.7053594348688  E_coul = 198.76032768651098
Extra cycle  E= -507.945031748358  delta_E= -2.27e-13  |g|= 7.33e-09  |ddm|= 7.24e-08
    CPU time for scf_cycle      4.72 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907705.733070714
E1 = -706.7053594348688  E_coul = 198.76032768651098
init E= -507.945031748358
    CPU time for initialize scf      9.53 sec, wall time      0.68 sec
  HOMO = -0.237621662146966  LUMO = 10.0909686817969
  mo_energy =
[-1.20316439e+02 -1.23744294e+01 -6.67495778e+00 -6.67495778e+00
 -6.67495778e+00 -1.16374527e+00 -2.37621662e-01 -2.37621662e-01
 -2.37621662e-01  1.00909687e+01  1.09967757e+02  6.04561440e+02
  2.74418365e+03  1.22233680e+04  4.08449088e+04  1.04888572e+05
  2.30072027e+05  4.55886973e+05  8.44839237e+05  1.52801651e+06
  2.85028391e+06  5.80817120e+06]
E1 = -706.7053594306559  E_coul = 198.76032768229823
cycle= 1 E= -507.945031748358  delta_E= 1.14e-13  |g|= 1.93e-09  |ddm|= 3.58e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.7053594306559  E_coul = 198.76032768229823
  HOMO = -0.237621662225451  LUMO = 10.0909686816545
  mo_energy =
[-1.20316439e+02 -1.23744294e+01 -6.67495778e+00 -6.67495778e+00
 -6.67495778e+00 -1.16374527e+00 -2.37621662e-01 -2.37621662e-01
 -2.37621662e-01  1.00909687e+01  1.09967757e+02  6.04561440e+02
  2.74418365e+03  1.22233680e+04  4.08449088e+04  1.04888572e+05
  2.30072027e+05  4.55886973e+05  8.44839237e+05  1.52801651e+06
  2.85028391e+06  5.80817120e+06]
E1 = -706.7053594304764  E_coul = 198.76032768211837
Extra cycle  E= -507.945031748358  delta_E= -3.41e-13  |g|= 1.05e-09  |ddm|= 1.66e-10
    CPU time for scf_cycle      9.72 sec, wall time      0.75 sec
exp = [1.17616814e+05 3.96662532e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547202e+04
 7.30348813e+03 1.83758106e+04 1.44976985e+03 3.73978877e+02
 1.13304941e+02 3.77622853e+01 8.09471358e+00 3.20623189e+00
 8.60396136e+00 4.93079815e-01]
grad_E = [ 4.16624306e-09  6.44342662e-04  1.85674788e-11  1.12250379e-10
  6.48213797e-10  2.54191285e-09  1.05597463e-08  5.68251997e-08
  3.57313722e-06  1.22004390e-07  5.85183553e-06 -1.22310141e-05
  1.28486121e-05 -7.25215400e-06  1.75387461e-05  2.89882787e-05
  7.21443335e-06  2.78139187e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814253        1
[INPUT] 0    0    [1    /1   ]  0.396655089633       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031134        1
[INPUT] 0    0    [1    /1   ]  147020.992155        1
[INPUT] 0    0    [1    /1   ]  73510.4209999        1
[INPUT] 0    0    [1    /1   ]  36754.7201986        1
[INPUT] 0    0    [1    /1   ]  7303.48537184        1
[INPUT] 0    0    [1    /1   ]  18375.8105393        1
[INPUT] 0    0    [1    /1   ]  1449.76516887        1
[INPUT] 0    0    [1    /1   ]  373.989762344        1
[INPUT] 0    0    [1    /1   ]  113.292984038        1
[INPUT] 0    0    [1    /1   ]  37.7579360787        1
[INPUT] 0    0    [1    /1   ]  8.0981200283         1
[INPUT] 0    0    [1    /1   ]  3.20711035914        1
[INPUT] 1    0    [1    /1   ]  8.60394135641        1
[INPUT] 1    0    [1    /1   ]  0.493065146139       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81425337114, 1.0]], [0, [0.39665508963330376, 1.0]], [0, [1176168.142618939, 1.0]], [0, [588084.0699928756, 1.0]], [0, [294042.0311336818, 1.0]], [0, [147020.9921548366, 1.0]], [0, [73510.42099986848, 1.0]], [0, [36754.72019858395, 1.0]], [0, [7303.485371844326, 1.0]], [0, [18375.810539340713, 1.0]], [0, [1449.7651688650087, 1.0]], [0, [373.98976234351113, 1.0]], [0, [113.29298403801538, 1.0]], [0, [37.75793607866251, 1.0]], [0, [8.098120028298567, 1.0]], [0, [3.2071103591408052, 1.0]], [1, [8.603941356413578, 1.0]], [1, [0.4930651461390613, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81425337]
bas 1, expnt(s) = [0.39665509]
bas 2, expnt(s) = [1176168.14261894]
bas 3, expnt(s) = [588084.06999288]
bas 4, expnt(s) = [294042.03113368]
bas 5, expnt(s) = [147020.99215484]
bas 6, expnt(s) = [73510.42099987]
bas 7, expnt(s) = [36754.72019858]
bas 8, expnt(s) = [7303.48537184]
bas 9, expnt(s) = [18375.81053934]
bas 10, expnt(s) = [1449.76516887]
bas 11, expnt(s) = [373.98976234]
bas 12, expnt(s) = [113.29298404]
bas 13, expnt(s) = [37.75793608]
bas 14, expnt(s) = [8.09812003]
bas 15, expnt(s) = [3.20711036]
bas 16, expnt(s) = [8.60394136]
bas 17, expnt(s) = [0.49306515]
CPU time:       157.09
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96655090e-01 1.26277158e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547202e+04 6.70656078e+03
 7.30348537e+03 1.99600970e+03 1.83758105e+04 3.98749271e+03
 1.44976517e+03 5.93592316e+02 3.73989762e+02 2.14862097e+02
 1.13292984e+02 8.77338699e+01 3.77579361e+01 3.84832028e+01
 8.09812003e+00 1.21283908e+01 3.20711036e+00 6.05480907e+00
 8.60394136e+00 4.29888863e+01 4.93065146e-01 1.20535444e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32501577379938
cond(S) = 907705.4528142178
E1 = -689.4004652111978  E_coul = 184.91400942700082
init E= -504.486455784197
    CPU time for initialize scf      4.63 sec, wall time      0.32 sec
  HOMO = -0.674636100717295  LUMO = 9.19854569238113
  mo_energy =
[-1.21706971e+02 -1.33873066e+01 -7.62793114e+00 -7.62793114e+00
 -7.62793114e+00 -1.64013784e+00 -6.74636101e-01 -6.74636101e-01
 -6.74636101e-01  9.19854569e+00  1.08668119e+02  6.03167135e+02
  2.74287065e+03  1.22221736e+04  4.08437800e+04  1.04887478e+05
  2.30070957e+05  4.55885921e+05  8.44838198e+05  1.52801548e+06
  2.85028289e+06  5.80817019e+06]
E1 = -707.0734578869774  E_coul = 199.134818562389
cycle= 1 E= -507.938639324588  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.602179
diis-c [-0.36262009  1.        ]
  HOMO = -0.232977957755486  LUMO = 10.1081445413821
  mo_energy =
[-1.20256161e+02 -1.23510141e+01 -6.64582015e+00 -6.64582015e+00
 -6.64582015e+00 -1.16140062e+00 -2.32977958e-01 -2.32977958e-01
 -2.32977958e-01  1.01081445e+01  1.10017321e+02  6.04603808e+02
  2.74424196e+03  1.22234335e+04  4.08449726e+04  1.04888634e+05
  2.30072089e+05  4.55887035e+05  8.44839299e+05  1.52801657e+06
  2.85028397e+06  5.80817127e+06]
E1 = -706.7198290172191  E_coul = 198.77480917297152
cycle= 2 E= -507.945019844248  delta_E= -0.00638  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152523
diis-c [-2.24043227e-04  4.84469774e-03  9.95155302e-01]
  HOMO = -0.237430277501137  LUMO = 10.0972281279205
  mo_energy =
[-1.20313928e+02 -1.23733841e+01 -6.67365746e+00 -6.67365746e+00
 -6.67365746e+00 -1.16366274e+00 -2.37430278e-01 -2.37430278e-01
 -2.37430278e-01  1.00972281e+01  1.09973886e+02  6.04542738e+02
  2.74416805e+03  1.22233514e+04  4.08448874e+04  1.04888548e+05
  2.30072002e+05  4.55886947e+05  8.44839211e+05  1.52801648e+06
  2.85028388e+06  5.80817118e+06]
E1 = -706.7051935279551  E_coul = 198.76016163267923
cycle= 3 E= -507.945031895276  delta_E= -1.21e-05  |g|= 0.000876  |ddm|= 0.00871
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.00073939
diis-c [-1.25627916e-08  3.75655181e-05 -5.00447014e-02  1.05000714e+00]
  HOMO = -0.237656259087798  LUMO = 10.0966862458166
  mo_energy =
[-1.20316524e+02 -1.23744920e+01 -6.67501221e+00 -6.67501221e+00
 -6.67501221e+00 -1.16377296e+00 -2.37656259e-01 -2.37656259e-01
 -2.37656259e-01  1.00966862e+01  1.09971866e+02  6.04540068e+02
  2.74416500e+03  1.22233481e+04  4.08448841e+04  1.04888544e+05
  2.30071998e+05  4.55886944e+05  8.44839208e+05  1.52801648e+06
  2.85028388e+06  5.80817118e+06]
E1 = -706.7044582220105  E_coul = 198.75942629667892
cycle= 4 E= -507.945031925332  delta_E= -3.01e-08  |g|= 6.23e-06  |ddm|= 0.000461
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.43866e-06
diis-c [-4.69823898e-12 -1.76226484e-06  2.29713492e-03 -4.56511756e-02
  1.04335580e+00]
  HOMO = -0.237657001979855  LUMO = 10.0966854971233
  mo_energy =
[-1.20316522e+02 -1.23744944e+01 -6.67501376e+00 -6.67501376e+00
 -6.67501376e+00 -1.16377338e+00 -2.37657002e-01 -2.37657002e-01
 -2.37657002e-01  1.00966855e+01  1.09971867e+02  6.04540071e+02
  2.74416500e+03  1.22233481e+04  4.08448841e+04  1.04888544e+05
  2.30071998e+05  4.55886944e+05  8.44839208e+05  1.52801648e+06
  2.85028388e+06  5.80817118e+06]
E1 = -706.7044571320679  E_coul = 198.7594252067355
cycle= 5 E= -507.945031925332  delta_E= -7.96e-13  |g|= 1.41e-07  |ddm|= 2.15e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7044571320679  E_coul = 198.7594252067355
  HOMO = -0.237657035952994  LUMO = 10.0966854275352
  mo_energy =
[-1.20316523e+02 -1.23744946e+01 -6.67501393e+00 -6.67501393e+00
 -6.67501393e+00 -1.16377340e+00 -2.37657036e-01 -2.37657036e-01
 -2.37657036e-01  1.00966854e+01  1.09971866e+02  6.04540070e+02
  2.74416500e+03  1.22233481e+04  4.08448841e+04  1.04888544e+05
  2.30071998e+05  4.55886944e+05  8.44839208e+05  1.52801648e+06
  2.85028388e+06  5.80817118e+06]
E1 = -706.7044570390871  E_coul = 198.75942511375462
Extra cycle  E= -507.945031925332  delta_E= -5.68e-14  |g|= 7.55e-09  |ddm|= 7.23e-08
    CPU time for scf_cycle      4.90 sec, wall time      0.39 sec
exp = [1.17616814e+05 3.96655090e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547202e+04
 7.30348537e+03 1.83758105e+04 1.44976517e+03 3.73989762e+02
 1.13292984e+02 3.77579361e+01 8.09812003e+00 3.20711036e+00
 8.60394136e+00 4.93065146e-01]
E = -507.94503192533244
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:39 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814253        1
[INPUT] 0    0    [1    /1   ]  0.396655089633       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031134        1
[INPUT] 0    0    [1    /1   ]  147020.992155        1
[INPUT] 0    0    [1    /1   ]  73510.4209999        1
[INPUT] 0    0    [1    /1   ]  36754.7201986        1
[INPUT] 0    0    [1    /1   ]  7303.48537184        1
[INPUT] 0    0    [1    /1   ]  18375.8105393        1
[INPUT] 0    0    [1    /1   ]  1449.76516887        1
[INPUT] 0    0    [1    /1   ]  373.989762344        1
[INPUT] 0    0    [1    /1   ]  113.292984038        1
[INPUT] 0    0    [1    /1   ]  37.7579360787        1
[INPUT] 0    0    [1    /1   ]  8.0981200283         1
[INPUT] 0    0    [1    /1   ]  3.20711035914        1
[INPUT] 1    0    [1    /1   ]  8.60394135641        1
[INPUT] 1    0    [1    /1   ]  0.493065146139       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81425337114, 1.0]], [0, [0.39665508963330376, 1.0]], [0, [1176168.142618939, 1.0]], [0, [588084.0699928756, 1.0]], [0, [294042.0311336818, 1.0]], [0, [147020.9921548366, 1.0]], [0, [73510.42099986848, 1.0]], [0, [36754.72019858395, 1.0]], [0, [7303.485371844326, 1.0]], [0, [18375.810539340713, 1.0]], [0, [1449.7651688650087, 1.0]], [0, [373.98976234351113, 1.0]], [0, [113.29298403801538, 1.0]], [0, [37.75793607866251, 1.0]], [0, [8.098120028298567, 1.0]], [0, [3.2071103591408052, 1.0]], [1, [8.603941356413578, 1.0]], [1, [0.4930651461390613, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81425337]
bas 1, expnt(s) = [0.39665509]
bas 2, expnt(s) = [1176168.14261894]
bas 3, expnt(s) = [588084.06999288]
bas 4, expnt(s) = [294042.03113368]
bas 5, expnt(s) = [147020.99215484]
bas 6, expnt(s) = [73510.42099987]
bas 7, expnt(s) = [36754.72019858]
bas 8, expnt(s) = [7303.48537184]
bas 9, expnt(s) = [18375.81053934]
bas 10, expnt(s) = [1449.76516887]
bas 11, expnt(s) = [373.98976234]
bas 12, expnt(s) = [113.29298404]
bas 13, expnt(s) = [37.75793608]
bas 14, expnt(s) = [8.09812003]
bas 15, expnt(s) = [3.20711036]
bas 16, expnt(s) = [8.60394136]
bas 17, expnt(s) = [0.49306515]
CPU time:       162.06
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96655090e-01 1.26277158e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547202e+04 6.70656078e+03
 7.30348537e+03 1.99600970e+03 1.83758105e+04 3.98749271e+03
 1.44976517e+03 5.93592316e+02 3.73989762e+02 2.14862097e+02
 1.13292984e+02 8.77338699e+01 3.77579361e+01 3.84832028e+01
 8.09812003e+00 1.21283908e+01 3.20711036e+00 6.05480907e+00
 8.60394136e+00 4.29888863e+01 4.93065146e-01 1.20535444e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32501577379938
cond(S) = 907705.4528142178
E1 = -689.4004652111978  E_coul = 184.91400942700082
init E= -504.486455784197
    CPU time for initialize scf      4.15 sec, wall time      0.29 sec
  HOMO = -0.674636100717295  LUMO = 9.19854569238113
  mo_energy =
[-1.21706971e+02 -1.33873066e+01 -7.62793114e+00 -7.62793114e+00
 -7.62793114e+00 -1.64013784e+00 -6.74636101e-01 -6.74636101e-01
 -6.74636101e-01  9.19854569e+00  1.08668119e+02  6.03167135e+02
  2.74287065e+03  1.22221736e+04  4.08437800e+04  1.04887478e+05
  2.30070957e+05  4.55885921e+05  8.44838198e+05  1.52801548e+06
  2.85028289e+06  5.80817019e+06]
E1 = -707.0734578869774  E_coul = 199.134818562389
cycle= 1 E= -507.938639324588  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602179
diis-c [-0.36262009  1.        ]
  HOMO = -0.232977957755486  LUMO = 10.1081445413821
  mo_energy =
[-1.20256161e+02 -1.23510141e+01 -6.64582015e+00 -6.64582015e+00
 -6.64582015e+00 -1.16140062e+00 -2.32977958e-01 -2.32977958e-01
 -2.32977958e-01  1.01081445e+01  1.10017321e+02  6.04603808e+02
  2.74424196e+03  1.22234335e+04  4.08449726e+04  1.04888634e+05
  2.30072089e+05  4.55887035e+05  8.44839299e+05  1.52801657e+06
  2.85028397e+06  5.80817127e+06]
E1 = -706.7198290172191  E_coul = 198.77480917297152
cycle= 2 E= -507.945019844248  delta_E= -0.00638  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152523
diis-c [-2.24043227e-04  4.84469774e-03  9.95155302e-01]
  HOMO = -0.237430277501137  LUMO = 10.0972281279205
  mo_energy =
[-1.20313928e+02 -1.23733841e+01 -6.67365746e+00 -6.67365746e+00
 -6.67365746e+00 -1.16366274e+00 -2.37430278e-01 -2.37430278e-01
 -2.37430278e-01  1.00972281e+01  1.09973886e+02  6.04542738e+02
  2.74416805e+03  1.22233514e+04  4.08448874e+04  1.04888548e+05
  2.30072002e+05  4.55886947e+05  8.44839211e+05  1.52801648e+06
  2.85028388e+06  5.80817118e+06]
E1 = -706.7051935279551  E_coul = 198.76016163267923
cycle= 3 E= -507.945031895276  delta_E= -1.21e-05  |g|= 0.000876  |ddm|= 0.00871
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00073939
diis-c [-1.25627916e-08  3.75655181e-05 -5.00447014e-02  1.05000714e+00]
  HOMO = -0.237656259087798  LUMO = 10.0966862458166
  mo_energy =
[-1.20316524e+02 -1.23744920e+01 -6.67501221e+00 -6.67501221e+00
 -6.67501221e+00 -1.16377296e+00 -2.37656259e-01 -2.37656259e-01
 -2.37656259e-01  1.00966862e+01  1.09971866e+02  6.04540068e+02
  2.74416500e+03  1.22233481e+04  4.08448841e+04  1.04888544e+05
  2.30071998e+05  4.55886944e+05  8.44839208e+05  1.52801648e+06
  2.85028388e+06  5.80817118e+06]
E1 = -706.7044582220105  E_coul = 198.75942629667892
cycle= 4 E= -507.945031925332  delta_E= -3.01e-08  |g|= 6.23e-06  |ddm|= 0.000461
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.43866e-06
diis-c [-4.69823898e-12 -1.76226484e-06  2.29713492e-03 -4.56511756e-02
  1.04335580e+00]
  HOMO = -0.237657001979855  LUMO = 10.0966854971233
  mo_energy =
[-1.20316522e+02 -1.23744944e+01 -6.67501376e+00 -6.67501376e+00
 -6.67501376e+00 -1.16377338e+00 -2.37657002e-01 -2.37657002e-01
 -2.37657002e-01  1.00966855e+01  1.09971867e+02  6.04540071e+02
  2.74416500e+03  1.22233481e+04  4.08448841e+04  1.04888544e+05
  2.30071998e+05  4.55886944e+05  8.44839208e+05  1.52801648e+06
  2.85028388e+06  5.80817118e+06]
E1 = -706.7044571320679  E_coul = 198.7594252067355
cycle= 5 E= -507.945031925332  delta_E= -7.96e-13  |g|= 1.41e-07  |ddm|= 2.15e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7044571320679  E_coul = 198.7594252067355
  HOMO = -0.237657035952994  LUMO = 10.0966854275352
  mo_energy =
[-1.20316523e+02 -1.23744946e+01 -6.67501393e+00 -6.67501393e+00
 -6.67501393e+00 -1.16377340e+00 -2.37657036e-01 -2.37657036e-01
 -2.37657036e-01  1.00966854e+01  1.09971866e+02  6.04540070e+02
  2.74416500e+03  1.22233481e+04  4.08448841e+04  1.04888544e+05
  2.30071998e+05  4.55886944e+05  8.44839208e+05  1.52801648e+06
  2.85028388e+06  5.80817118e+06]
E1 = -706.7044570390871  E_coul = 198.75942511375462
Extra cycle  E= -507.945031925332  delta_E= -5.68e-14  |g|= 7.55e-09  |ddm|= 7.23e-08
    CPU time for scf_cycle      4.42 sec, wall time      0.36 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907705.4528142178
E1 = -706.7044570390871  E_coul = 198.75942511375462
init E= -507.945031925332
    CPU time for initialize scf      1.27 sec, wall time      0.08 sec
  HOMO = -0.237657037554756  LUMO = 10.0966854244483
  mo_energy =
[-1.20316523e+02 -1.23744946e+01 -6.67501394e+00 -6.67501394e+00
 -6.67501394e+00 -1.16377340e+00 -2.37657038e-01 -2.37657038e-01
 -2.37657038e-01  1.00966854e+01  1.09971866e+02  6.04540070e+02
  2.74416500e+03  1.22233481e+04  4.08448841e+04  1.04888544e+05
  2.30071998e+05  4.55886944e+05  8.44839208e+05  1.52801648e+06
  2.85028388e+06  5.80817118e+06]
E1 = -706.7044570348831  E_coul = 198.75942510955056
cycle= 1 E= -507.945031925333  delta_E= -1.71e-13  |g|= 2.35e-09  |ddm|= 3.58e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
E1 = -706.7044570348831  E_coul = 198.75942510955056
  HOMO = -0.23765703763313  LUMO = 10.0966854243055
  mo_energy =
[-1.20316523e+02 -1.23744946e+01 -6.67501394e+00 -6.67501394e+00
 -6.67501394e+00 -1.16377340e+00 -2.37657038e-01 -2.37657038e-01
 -2.37657038e-01  1.00966854e+01  1.09971866e+02  6.04540070e+02
  2.74416500e+03  1.22233481e+04  4.08448841e+04  1.04888544e+05
  2.30071998e+05  4.55886944e+05  8.44839208e+05  1.52801648e+06
  2.85028388e+06  5.80817118e+06]
E1 = -706.7044570347153  E_coul = 198.75942510938256
Extra cycle  E= -507.945031925333  delta_E= -1.71e-13  |g|= 1.97e-09  |ddm|= 1.56e-10
    CPU time for scf_cycle      1.46 sec, wall time      0.15 sec
exp = [1.17616814e+05 3.96655090e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547202e+04
 7.30348537e+03 1.83758105e+04 1.44976517e+03 3.73989762e+02
 1.13292984e+02 3.77579361e+01 8.09812003e+00 3.20711036e+00
 8.60394136e+00 4.93065146e-01]
grad_E = [ 4.17008279e-09  5.22229334e-04  1.86131410e-11  1.12375024e-10
  6.48808281e-10  2.54428580e-09  1.05697475e-08  5.68745029e-08
  3.57660541e-06  1.22154123e-07  5.67456206e-06 -1.03898448e-05
  7.22811105e-06 -6.20479801e-06  3.52226609e-05  2.85991502e-05
  5.98225178e-06  2.25283106e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814252        1
[INPUT] 0    0    [1    /1   ]  0.396638076142       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031133        1
[INPUT] 0    0    [1    /1   ]  147020.992154        1
[INPUT] 0    0    [1    /1   ]  73510.4209953        1
[INPUT] 0    0    [1    /1   ]  36754.7201739        1
[INPUT] 0    0    [1    /1   ]  7303.48382129        1
[INPUT] 0    0    [1    /1   ]  18375.8104864        1
[INPUT] 0    0    [1    /1   ]  1449.76253489        1
[INPUT] 0    0    [1    /1   ]  373.995942009        1
[INPUT] 0    0    [1    /1   ]  113.285829007        1
[INPUT] 0    0    [1    /1   ]  37.756599342         1
[INPUT] 0    0    [1    /1   ]  8.09976184118        1
[INPUT] 0    0    [1    /1   ]  3.20755194716        1
[INPUT] 1    0    [1    /1   ]  8.60389411097        1
[INPUT] 1    0    [1    /1   ]  0.493028657302       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.8142515631, 1.0]], [0, [0.39663807614249924, 1.0]], [0, [1176168.142618931, 1.0]], [0, [588084.0699928269, 1.0]], [0, [294042.0311334005, 1.0]], [0, [147020.9921537335, 1.0]], [0, [73510.420995286, 1.0]], [0, [36754.72017392178, 1.0]], [0, [7303.483821290599, 1.0]], [0, [18375.810486413982, 1.0]], [0, [1449.7625348858082, 1.0]], [0, [373.9959420092411, 1.0]], [0, [113.28582900742173, 1.0]], [0, [37.75659934201927, 1.0]], [0, [8.099761841183119, 1.0]], [0, [3.2075519471614222, 1.0]], [1, [8.603894110972707, 1.0]], [1, [0.49302865730170703, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81425156]
bas 1, expnt(s) = [0.39663808]
bas 2, expnt(s) = [1176168.14261893]
bas 3, expnt(s) = [588084.06999283]
bas 4, expnt(s) = [294042.0311334]
bas 5, expnt(s) = [147020.99215373]
bas 6, expnt(s) = [73510.42099529]
bas 7, expnt(s) = [36754.72017392]
bas 8, expnt(s) = [7303.48382129]
bas 9, expnt(s) = [18375.81048641]
bas 10, expnt(s) = [1449.76253489]
bas 11, expnt(s) = [373.99594201]
bas 12, expnt(s) = [113.28582901]
bas 13, expnt(s) = [37.75659934]
bas 14, expnt(s) = [8.09976184]
bas 15, expnt(s) = [3.20755195]
bas 16, expnt(s) = [8.60389411]
bas 17, expnt(s) = [0.49302866]
CPU time:       170.65
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96638076e-01 1.26273095e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547202e+04 6.70656078e+03
 7.30348382e+03 1.99600938e+03 1.83758105e+04 3.98749271e+03
 1.44976253e+03 5.93591507e+02 3.73995942e+02 2.14864760e+02
 1.13285829e+02 8.77297142e+01 3.77565993e+01 3.84821810e+01
 8.09976184e+00 1.21302349e+01 3.20755195e+00 6.05543432e+00
 8.60389411e+00 4.29885913e+01 4.93028657e-01 1.20524294e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325065724806798
cond(S) = 907705.3088794466
E1 = -689.3987051858766  E_coul = 184.9124720704178
init E= -504.486233115459
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674685105455005  LUMO = 9.2011676247167
  mo_energy =
[-1.21707130e+02 -1.33874319e+01 -7.62802797e+00 -7.62802797e+00
 -7.62802797e+00 -1.64016997e+00 -6.74685105e-01 -6.74685105e-01
 -6.74685105e-01  9.20116762e+00  1.08670898e+02  6.03156725e+02
  2.74286159e+03  1.22221637e+04  4.08437672e+04  1.04887464e+05
  2.30070942e+05  4.55885905e+05  8.44838183e+05  1.52801546e+06
  2.85028288e+06  5.80817018e+06]
E1 = -707.0710108424369  E_coul = 199.13236959159178
cycle= 1 E= -507.938641250845  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602176
diis-c [-0.36261633  1.        ]
  HOMO = -0.233070738614055  LUMO = 10.1107880743251
  mo_energy =
[-1.20256387e+02 -1.23511993e+01 -6.64597536e+00 -6.64597536e+00
 -6.64597536e+00 -1.16146976e+00 -2.33070739e-01 -2.33070739e-01
 -2.33070739e-01  1.01107881e+01  1.10020029e+02  6.04593329e+02
  2.74423283e+03  1.22234236e+04  4.08449598e+04  1.04888619e+05
  2.30072073e+05  4.55887019e+05  8.44839284e+05  1.52801655e+06
  2.85028396e+06  5.80817125e+06]
E1 = -706.717470002178  E_coul = 198.7724500553286
cycle= 2 E= -507.945019946849  delta_E= -0.00638  |g|= 0.0181  |ddm|= 0.194
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152514
diis-c [-2.24018965e-04  4.84393378e-03  9.95156066e-01]
  HOMO = -0.237521085287348  LUMO = 10.0998728718733
  mo_energy =
[-1.20314144e+02 -1.23735629e+01 -6.67380569e+00 -6.67380569e+00
 -6.67380569e+00 -1.16373090e+00 -2.37521085e-01 -2.37521085e-01
 -2.37521085e-01  1.00998729e+01  1.09976603e+02  6.04532270e+02
  2.74415893e+03  1.22233415e+04  4.08448746e+04  1.04888533e+05
  2.30071986e+05  4.55886932e+05  8.44839196e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7028404869384  E_coul = 198.75780849669778
cycle= 3 E= -507.945031990241  delta_E= -1.2e-05  |g|= 0.000876  |ddm|= 0.00871
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739283
diis-c [-1.25438378e-08  3.75455134e-05 -5.00410812e-02  1.05000354e+00]
  HOMO = -0.237746925873051  LUMO = 10.0993311470661
  mo_energy =
[-1.20316739e+02 -1.23746703e+01 -6.67515988e+00 -6.67515988e+00
 -6.67515988e+00 -1.16384105e+00 -2.37746926e-01 -2.37746926e-01
 -2.37746926e-01  1.00993311e+01  1.09974584e+02  6.04529601e+02
  2.74415588e+03  1.22233382e+04  4.08448713e+04  1.04888530e+05
  2.30071983e+05  4.55886929e+05  8.44839193e+05  1.52801646e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7021056096922  E_coul = 198.75707358942617
cycle= 4 E= -507.945032020266  delta_E= -3e-08  |g|= 6.22e-06  |ddm|= 0.000461
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.43382e-06
diis-c [-4.69507475e-12 -1.76178516e-06  2.29598730e-03 -4.56290239e-02
  1.04333480e+00]
  HOMO = -0.237747666893659  LUMO = 10.0993304015836
  mo_energy =
[-1.20316737e+02 -1.23746727e+01 -6.67516142e+00 -6.67516142e+00
 -6.67516142e+00 -1.16384148e+00 -2.37747667e-01 -2.37747667e-01
 -2.37747667e-01  1.00993304e+01  1.09974585e+02  6.04529604e+02
  2.74415589e+03  1.22233382e+04  4.08448713e+04  1.04888530e+05
  2.30071983e+05  4.55886929e+05  8.44839193e+05  1.52801646e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7021045245316  E_coul = 198.75707250426478
cycle= 5 E= -507.945032020267  delta_E= -7.39e-13  |g|= 1.41e-07  |ddm|= 2.14e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7021045245316  E_coul = 198.75707250426478
  HOMO = -0.237747700847118  LUMO = 10.0993303320152
  mo_energy =
[-1.20316738e+02 -1.23746729e+01 -6.67516159e+00 -6.67516159e+00
 -6.67516159e+00 -1.16384150e+00 -2.37747701e-01 -2.37747701e-01
 -2.37747701e-01  1.00993303e+01  1.09974584e+02  6.04529604e+02
  2.74415589e+03  1.22233382e+04  4.08448713e+04  1.04888530e+05
  2.30071983e+05  4.55886929e+05  8.44839193e+05  1.52801646e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7021044316147  E_coul = 198.75707241134734
Extra cycle  E= -507.945032020267  delta_E= -5.12e-13  |g|= 7.35e-09  |ddm|= 7.22e-08
    CPU time for scf_cycle      0.42 sec, wall time      0.09 sec
exp = [1.17616814e+05 3.96638076e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547202e+04
 7.30348382e+03 1.83758105e+04 1.44976253e+03 3.73995942e+02
 1.13285829e+02 3.77565993e+01 8.09976184e+00 3.20755195e+00
 8.60389411e+00 4.93028657e-01]
E = -507.9450320202673
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814252        1
[INPUT] 0    0    [1    /1   ]  0.396638076142       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031133        1
[INPUT] 0    0    [1    /1   ]  147020.992154        1
[INPUT] 0    0    [1    /1   ]  73510.4209953        1
[INPUT] 0    0    [1    /1   ]  36754.7201739        1
[INPUT] 0    0    [1    /1   ]  7303.48382129        1
[INPUT] 0    0    [1    /1   ]  18375.8104864        1
[INPUT] 0    0    [1    /1   ]  1449.76253489        1
[INPUT] 0    0    [1    /1   ]  373.995942009        1
[INPUT] 0    0    [1    /1   ]  113.285829007        1
[INPUT] 0    0    [1    /1   ]  37.756599342         1
[INPUT] 0    0    [1    /1   ]  8.09976184118        1
[INPUT] 0    0    [1    /1   ]  3.20755194716        1
[INPUT] 1    0    [1    /1   ]  8.60389411097        1
[INPUT] 1    0    [1    /1   ]  0.493028657302       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.8142515631, 1.0]], [0, [0.39663807614249924, 1.0]], [0, [1176168.142618931, 1.0]], [0, [588084.0699928269, 1.0]], [0, [294042.0311334005, 1.0]], [0, [147020.9921537335, 1.0]], [0, [73510.420995286, 1.0]], [0, [36754.72017392178, 1.0]], [0, [7303.483821290599, 1.0]], [0, [18375.810486413982, 1.0]], [0, [1449.7625348858082, 1.0]], [0, [373.9959420092411, 1.0]], [0, [113.28582900742173, 1.0]], [0, [37.75659934201927, 1.0]], [0, [8.099761841183119, 1.0]], [0, [3.2075519471614222, 1.0]], [1, [8.603894110972707, 1.0]], [1, [0.49302865730170703, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81425156]
bas 1, expnt(s) = [0.39663808]
bas 2, expnt(s) = [1176168.14261893]
bas 3, expnt(s) = [588084.06999283]
bas 4, expnt(s) = [294042.0311334]
bas 5, expnt(s) = [147020.99215373]
bas 6, expnt(s) = [73510.42099529]
bas 7, expnt(s) = [36754.72017392]
bas 8, expnt(s) = [7303.48382129]
bas 9, expnt(s) = [18375.81048641]
bas 10, expnt(s) = [1449.76253489]
bas 11, expnt(s) = [373.99594201]
bas 12, expnt(s) = [113.28582901]
bas 13, expnt(s) = [37.75659934]
bas 14, expnt(s) = [8.09976184]
bas 15, expnt(s) = [3.20755195]
bas 16, expnt(s) = [8.60389411]
bas 17, expnt(s) = [0.49302866]
CPU time:       171.15
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96638076e-01 1.26273095e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547202e+04 6.70656078e+03
 7.30348382e+03 1.99600938e+03 1.83758105e+04 3.98749271e+03
 1.44976253e+03 5.93591507e+02 3.73995942e+02 2.14864760e+02
 1.13285829e+02 8.77297142e+01 3.77565993e+01 3.84821810e+01
 8.09976184e+00 1.21302349e+01 3.20755195e+00 6.05543432e+00
 8.60389411e+00 4.29885913e+01 4.93028657e-01 1.20524294e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325065724806798
cond(S) = 907705.3088794466
E1 = -689.3987051858766  E_coul = 184.9124720704178
init E= -504.486233115459
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674685105455005  LUMO = 9.2011676247167
  mo_energy =
[-1.21707130e+02 -1.33874319e+01 -7.62802797e+00 -7.62802797e+00
 -7.62802797e+00 -1.64016997e+00 -6.74685105e-01 -6.74685105e-01
 -6.74685105e-01  9.20116762e+00  1.08670898e+02  6.03156725e+02
  2.74286159e+03  1.22221637e+04  4.08437672e+04  1.04887464e+05
  2.30070942e+05  4.55885905e+05  8.44838183e+05  1.52801546e+06
  2.85028288e+06  5.80817018e+06]
E1 = -707.0710108424369  E_coul = 199.13236959159178
cycle= 1 E= -507.938641250845  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602176
diis-c [-0.36261633  1.        ]
  HOMO = -0.233070738614055  LUMO = 10.1107880743251
  mo_energy =
[-1.20256387e+02 -1.23511993e+01 -6.64597536e+00 -6.64597536e+00
 -6.64597536e+00 -1.16146976e+00 -2.33070739e-01 -2.33070739e-01
 -2.33070739e-01  1.01107881e+01  1.10020029e+02  6.04593329e+02
  2.74423283e+03  1.22234236e+04  4.08449598e+04  1.04888619e+05
  2.30072073e+05  4.55887019e+05  8.44839284e+05  1.52801655e+06
  2.85028396e+06  5.80817125e+06]
E1 = -706.717470002178  E_coul = 198.7724500553286
cycle= 2 E= -507.945019946849  delta_E= -0.00638  |g|= 0.0181  |ddm|= 0.194
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152514
diis-c [-2.24018965e-04  4.84393378e-03  9.95156066e-01]
  HOMO = -0.237521085287348  LUMO = 10.0998728718733
  mo_energy =
[-1.20314144e+02 -1.23735629e+01 -6.67380569e+00 -6.67380569e+00
 -6.67380569e+00 -1.16373090e+00 -2.37521085e-01 -2.37521085e-01
 -2.37521085e-01  1.00998729e+01  1.09976603e+02  6.04532270e+02
  2.74415893e+03  1.22233415e+04  4.08448746e+04  1.04888533e+05
  2.30071986e+05  4.55886932e+05  8.44839196e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7028404869384  E_coul = 198.75780849669778
cycle= 3 E= -507.945031990241  delta_E= -1.2e-05  |g|= 0.000876  |ddm|= 0.00871
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739283
diis-c [-1.25438378e-08  3.75455134e-05 -5.00410812e-02  1.05000354e+00]
  HOMO = -0.237746925873051  LUMO = 10.0993311470661
  mo_energy =
[-1.20316739e+02 -1.23746703e+01 -6.67515988e+00 -6.67515988e+00
 -6.67515988e+00 -1.16384105e+00 -2.37746926e-01 -2.37746926e-01
 -2.37746926e-01  1.00993311e+01  1.09974584e+02  6.04529601e+02
  2.74415588e+03  1.22233382e+04  4.08448713e+04  1.04888530e+05
  2.30071983e+05  4.55886929e+05  8.44839193e+05  1.52801646e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7021056096922  E_coul = 198.75707358942617
cycle= 4 E= -507.945032020266  delta_E= -3e-08  |g|= 6.22e-06  |ddm|= 0.000461
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.43382e-06
diis-c [-4.69507475e-12 -1.76178516e-06  2.29598730e-03 -4.56290239e-02
  1.04333480e+00]
  HOMO = -0.237747666893659  LUMO = 10.0993304015836
  mo_energy =
[-1.20316737e+02 -1.23746727e+01 -6.67516142e+00 -6.67516142e+00
 -6.67516142e+00 -1.16384148e+00 -2.37747667e-01 -2.37747667e-01
 -2.37747667e-01  1.00993304e+01  1.09974585e+02  6.04529604e+02
  2.74415589e+03  1.22233382e+04  4.08448713e+04  1.04888530e+05
  2.30071983e+05  4.55886929e+05  8.44839193e+05  1.52801646e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7021045245316  E_coul = 198.75707250426478
cycle= 5 E= -507.945032020267  delta_E= -7.39e-13  |g|= 1.41e-07  |ddm|= 2.14e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7021045245316  E_coul = 198.75707250426478
  HOMO = -0.237747700847118  LUMO = 10.0993303320152
  mo_energy =
[-1.20316738e+02 -1.23746729e+01 -6.67516159e+00 -6.67516159e+00
 -6.67516159e+00 -1.16384150e+00 -2.37747701e-01 -2.37747701e-01
 -2.37747701e-01  1.00993303e+01  1.09974584e+02  6.04529604e+02
  2.74415589e+03  1.22233382e+04  4.08448713e+04  1.04888530e+05
  2.30071983e+05  4.55886929e+05  8.44839193e+05  1.52801646e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7021044316147  E_coul = 198.75707241134734
Extra cycle  E= -507.945032020267  delta_E= -5.12e-13  |g|= 7.35e-09  |ddm|= 7.22e-08
    CPU time for scf_cycle      0.42 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907705.3088794466
E1 = -706.7021044316147  E_coul = 198.75707241134734
init E= -507.945032020267
    CPU time for initialize scf      1.28 sec, wall time      0.08 sec
  HOMO = -0.237747702447526  LUMO = 10.0993303289314
  mo_energy =
[-1.20316738e+02 -1.23746729e+01 -6.67516160e+00 -6.67516160e+00
 -6.67516160e+00 -1.16384150e+00 -2.37747702e-01 -2.37747702e-01
 -2.37747702e-01  1.00993303e+01  1.09974584e+02  6.04529604e+02
  2.74415589e+03  1.22233382e+04  4.08448713e+04  1.04888530e+05
  2.30071983e+05  4.55886929e+05  8.44839193e+05  1.52801646e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7021044274231  E_coul = 198.75707240715585
cycle= 1 E= -507.945032020267  delta_E= 5.68e-14  |g|= 9.3e-10  |ddm|= 3.56e-09
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
E1 = -706.7021044274231  E_coul = 198.75707240715585
  HOMO = -0.237747702525612  LUMO = 10.0993303287883
  mo_energy =
[-1.20316738e+02 -1.23746729e+01 -6.67516160e+00 -6.67516160e+00
 -6.67516160e+00 -1.16384150e+00 -2.37747703e-01 -2.37747703e-01
 -2.37747703e-01  1.00993303e+01  1.09974584e+02  6.04529604e+02
  2.74415589e+03  1.22233382e+04  4.08448713e+04  1.04888530e+05
  2.30071983e+05  4.55886929e+05  8.44839193e+05  1.52801646e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7021044272328  E_coul = 198.75707240696562
Extra cycle  E= -507.945032020267  delta_E= 5.68e-14  |g|= 2.52e-09  |ddm|= 1.79e-10
    CPU time for scf_cycle      1.47 sec, wall time      0.15 sec
exp = [1.17616814e+05 3.96638076e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547202e+04
 7.30348382e+03 1.83758105e+04 1.44976253e+03 3.73995942e+02
 1.13285829e+02 3.77565993e+01 8.09976184e+00 3.20755195e+00
 8.60389411e+00 4.93028657e-01]
grad_E = [ 4.17278683e-09  2.11774227e-04  1.86452808e-11  1.12462801e-10
  6.49226907e-10  2.54595688e-09  1.05767909e-08  5.69092268e-08
  3.57905581e-06  1.22259600e-07  5.54600596e-06 -8.92656572e-06
  1.16474679e-06  1.94072279e-06  4.49101854e-05  1.98205881e-05
  2.45715842e-06  9.13669337e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814252        1
[INPUT] 0    0    [1    /1   ]  0.396627958626       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031133        1
[INPUT] 0    0    [1    /1   ]  147020.992154        1
[INPUT] 0    0    [1    /1   ]  73510.4209952        1
[INPUT] 0    0    [1    /1   ]  36754.7201737        1
[INPUT] 0    0    [1    /1   ]  7303.48380425        1
[INPUT] 0    0    [1    /1   ]  18375.8104858        1
[INPUT] 0    0    [1    /1   ]  1449.7625026         1
[INPUT] 0    0    [1    /1   ]  373.9960586          1
[INPUT] 0    0    [1    /1   ]  113.285418991        1
[INPUT] 0    0    [1    /1   ]  37.757442287         1
[INPUT] 0    0    [1    /1   ]  8.09953519893        1
[INPUT] 0    0    [1    /1   ]  3.2075078719         1
[INPUT] 1    0    [1    /1   ]  8.60386569799        1
[INPUT] 1    0    [1    /1   ]  0.493006353498       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81425154323, 1.0]], [0, [0.39662795862595523, 1.0]], [0, [1176168.142618931, 1.0]], [0, [588084.0699928263, 1.0]], [0, [294042.0311333974, 1.0]], [0, [147020.99215372137, 1.0]], [0, [73510.42099523563, 1.0]], [0, [36754.72017365066, 1.0]], [0, [7303.483804252017, 1.0]], [0, [18375.810485832848, 1.0]], [0, [1449.7625025973816, 1.0]], [0, [373.9960585999227, 1.0]], [0, [113.28541899092264, 1.0]], [0, [37.75744228700724, 1.0]], [0, [8.09953519893239, 1.0]], [0, [3.207507871900543, 1.0]], [1, [8.60386569798734, 1.0]], [1, [0.49300635349791866, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81425154]
bas 1, expnt(s) = [0.39662796]
bas 2, expnt(s) = [1176168.14261893]
bas 3, expnt(s) = [588084.06999283]
bas 4, expnt(s) = [294042.0311334]
bas 5, expnt(s) = [147020.99215372]
bas 6, expnt(s) = [73510.42099524]
bas 7, expnt(s) = [36754.72017365]
bas 8, expnt(s) = [7303.48380425]
bas 9, expnt(s) = [18375.81048583]
bas 10, expnt(s) = [1449.7625026]
bas 11, expnt(s) = [373.9960586]
bas 12, expnt(s) = [113.28541899]
bas 13, expnt(s) = [37.75744229]
bas 14, expnt(s) = [8.0995352]
bas 15, expnt(s) = [3.20750787]
bas 16, expnt(s) = [8.6038657]
bas 17, expnt(s) = [0.49300635]
CPU time:       175.76
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96627959e-01 1.26270680e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547202e+04 6.70656078e+03
 7.30348380e+03 1.99600938e+03 1.83758105e+04 3.98749271e+03
 1.44976250e+03 5.93591497e+02 3.73996059e+02 2.14864810e+02
 1.13285419e+02 8.77294761e+01 3.77574423e+01 3.84828253e+01
 8.09953520e+00 1.21299803e+01 3.20750787e+00 6.05537192e+00
 8.60386570e+00 4.29884138e+01 4.93006353e-01 1.20517479e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32509646956762
cond(S) = 907705.316032636
E1 = -689.3976562965207  E_coul = 184.91155037911753
init E= -504.486105917403
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674714697341942  LUMO = 9.20073540256086
  mo_energy =
[-1.21707224e+02 -1.33875088e+01 -7.62808564e+00 -7.62808564e+00
 -7.62808564e+00 -1.64018931e+00 -6.74714697e-01 -6.74714697e-01
 -6.74714697e-01  9.20073540e+00  1.08671110e+02  6.03157694e+02
  2.74286247e+03  1.22221645e+04  4.08437679e+04  1.04887464e+05
  2.30070943e+05  4.55885906e+05  8.44838184e+05  1.52801547e+06
  2.85028288e+06  5.80817018e+06]
E1 = -707.0695629737492  E_coul = 199.13092186164795
cycle= 1 E= -507.938641112101  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602176
diis-c [-0.36261556  1.        ]
  HOMO = -0.233126653444476  LUMO = 10.1103186693082
  mo_energy =
[-1.20256519e+02 -1.23513104e+01 -6.64606607e+00 -6.64606607e+00
 -6.64606607e+00 -1.16151093e+00 -2.33126653e-01 -2.33126653e-01
 -2.33126653e-01  1.01103187e+01  1.10020206e+02  6.04594262e+02
  2.74423366e+03  1.22234243e+04  4.08449604e+04  1.04888620e+05
  2.30072074e+05  4.55887020e+05  8.44839284e+05  1.52801655e+06
  2.85028396e+06  5.80817125e+06]
E1 = -706.7160133684883  E_coul = 198.77099340200914
cycle= 2 E= -507.945019966479  delta_E= -0.00638  |g|= 0.0181  |ddm|= 0.194
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152513
diis-c [-2.24014142e-04  4.84410069e-03  9.95155899e-01]
  HOMO = -0.237576972270699  LUMO = 10.099403301946
  mo_energy =
[-1.20314277e+02 -1.23736748e+01 -6.67389730e+00 -6.67389730e+00
 -6.67389730e+00 -1.16377218e+00 -2.37576972e-01 -2.37576972e-01
 -2.37576972e-01  1.00994033e+01  1.09976779e+02  6.04533202e+02
  2.74415976e+03  1.22233422e+04  4.08448752e+04  1.04888534e+05
  2.30071987e+05  4.55886932e+05  8.44839196e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7013832418506  E_coul = 198.75635123120014
cycle= 3 E= -507.94503201065  delta_E= -1.2e-05  |g|= 0.000876  |ddm|= 0.00871
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739286
diis-c [-1.25458488e-08  3.75467033e-05 -5.00416212e-02  1.05000407e+00]
  HOMO = -0.237802816850603  LUMO = 10.0988615576916
  mo_energy =
[-1.20316872e+02 -1.23747822e+01 -6.67525156e+00 -6.67525156e+00
 -6.67525156e+00 -1.16388234e+00 -2.37802817e-01 -2.37802817e-01
 -2.37802817e-01  1.00988616e+01  1.09974760e+02  6.04530533e+02
  2.74415672e+03  1.22233389e+04  4.08448719e+04  1.04888530e+05
  2.30071983e+05  4.55886929e+05  8.44839193e+05  1.52801646e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7006483184584  E_coul = 198.75561627777932
cycle= 4 E= -507.945032040679  delta_E= -3e-08  |g|= 6.23e-06  |ddm|= 0.000461
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.43429e-06
diis-c [-4.69444463e-12 -1.76206087e-06  2.29613110e-03 -4.56315252e-02
  1.04333716e+00]
  HOMO = -0.237803558052922  LUMO = 10.0988608118899
  mo_energy =
[-1.20316870e+02 -1.23747846e+01 -6.67525310e+00 -6.67525310e+00
 -6.67525310e+00 -1.16388276e+00 -2.37803558e-01 -2.37803558e-01
 -2.37803558e-01  1.00988608e+01  1.09974761e+02  6.04530536e+02
  2.74415672e+03  1.22233389e+04  4.08448719e+04  1.04888530e+05
  2.30071984e+05  4.55886929e+05  8.44839193e+05  1.52801646e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7006472328023  E_coul = 198.7556151921224
cycle= 5 E= -507.94503204068  delta_E= -8.53e-13  |g|= 1.41e-07  |ddm|= 2.14e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7006472328023  E_coul = 198.7556151921224
  HOMO = -0.237803592008042  LUMO = 10.0988607423155
  mo_energy =
[-1.20316870e+02 -1.23747847e+01 -6.67525327e+00 -6.67525327e+00
 -6.67525327e+00 -1.16388278e+00 -2.37803592e-01 -2.37803592e-01
 -2.37803592e-01  1.00988607e+01  1.09974760e+02  6.04530535e+02
  2.74415672e+03  1.22233389e+04  4.08448719e+04  1.04888530e+05
  2.30071984e+05  4.55886929e+05  8.44839193e+05  1.52801646e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7006471398956  E_coul = 198.75561509921573
Extra cycle  E= -507.94503204068  delta_E= 5.68e-14  |g|= 7.34e-09  |ddm|= 7.22e-08
    CPU time for scf_cycle      0.42 sec, wall time      0.09 sec
exp = [1.17616814e+05 3.96627959e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547202e+04
 7.30348380e+03 1.83758105e+04 1.44976250e+03 3.73996059e+02
 1.13285419e+02 3.77574423e+01 8.09953520e+00 3.20750787e+00
 8.60386570e+00 4.93006353e-01]
E = -507.9450320406799
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814252        1
[INPUT] 0    0    [1    /1   ]  0.396627958626       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031133        1
[INPUT] 0    0    [1    /1   ]  147020.992154        1
[INPUT] 0    0    [1    /1   ]  73510.4209952        1
[INPUT] 0    0    [1    /1   ]  36754.7201737        1
[INPUT] 0    0    [1    /1   ]  7303.48380425        1
[INPUT] 0    0    [1    /1   ]  18375.8104858        1
[INPUT] 0    0    [1    /1   ]  1449.7625026         1
[INPUT] 0    0    [1    /1   ]  373.9960586          1
[INPUT] 0    0    [1    /1   ]  113.285418991        1
[INPUT] 0    0    [1    /1   ]  37.757442287         1
[INPUT] 0    0    [1    /1   ]  8.09953519893        1
[INPUT] 0    0    [1    /1   ]  3.2075078719         1
[INPUT] 1    0    [1    /1   ]  8.60386569799        1
[INPUT] 1    0    [1    /1   ]  0.493006353498       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81425154323, 1.0]], [0, [0.39662795862595523, 1.0]], [0, [1176168.142618931, 1.0]], [0, [588084.0699928263, 1.0]], [0, [294042.0311333974, 1.0]], [0, [147020.99215372137, 1.0]], [0, [73510.42099523563, 1.0]], [0, [36754.72017365066, 1.0]], [0, [7303.483804252017, 1.0]], [0, [18375.810485832848, 1.0]], [0, [1449.7625025973816, 1.0]], [0, [373.9960585999227, 1.0]], [0, [113.28541899092264, 1.0]], [0, [37.75744228700724, 1.0]], [0, [8.09953519893239, 1.0]], [0, [3.207507871900543, 1.0]], [1, [8.60386569798734, 1.0]], [1, [0.49300635349791866, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81425154]
bas 1, expnt(s) = [0.39662796]
bas 2, expnt(s) = [1176168.14261893]
bas 3, expnt(s) = [588084.06999283]
bas 4, expnt(s) = [294042.0311334]
bas 5, expnt(s) = [147020.99215372]
bas 6, expnt(s) = [73510.42099524]
bas 7, expnt(s) = [36754.72017365]
bas 8, expnt(s) = [7303.48380425]
bas 9, expnt(s) = [18375.81048583]
bas 10, expnt(s) = [1449.7625026]
bas 11, expnt(s) = [373.9960586]
bas 12, expnt(s) = [113.28541899]
bas 13, expnt(s) = [37.75744229]
bas 14, expnt(s) = [8.0995352]
bas 15, expnt(s) = [3.20750787]
bas 16, expnt(s) = [8.6038657]
bas 17, expnt(s) = [0.49300635]
CPU time:       176.27
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96627959e-01 1.26270680e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547202e+04 6.70656078e+03
 7.30348380e+03 1.99600938e+03 1.83758105e+04 3.98749271e+03
 1.44976250e+03 5.93591497e+02 3.73996059e+02 2.14864810e+02
 1.13285419e+02 8.77294761e+01 3.77574423e+01 3.84828253e+01
 8.09953520e+00 1.21299803e+01 3.20750787e+00 6.05537192e+00
 8.60386570e+00 4.29884138e+01 4.93006353e-01 1.20517479e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32509646956762
cond(S) = 907705.316032636
E1 = -689.3976562965207  E_coul = 184.91155037911753
init E= -504.486105917403
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674714697341942  LUMO = 9.20073540256086
  mo_energy =
[-1.21707224e+02 -1.33875088e+01 -7.62808564e+00 -7.62808564e+00
 -7.62808564e+00 -1.64018931e+00 -6.74714697e-01 -6.74714697e-01
 -6.74714697e-01  9.20073540e+00  1.08671110e+02  6.03157694e+02
  2.74286247e+03  1.22221645e+04  4.08437679e+04  1.04887464e+05
  2.30070943e+05  4.55885906e+05  8.44838184e+05  1.52801547e+06
  2.85028288e+06  5.80817018e+06]
E1 = -707.0695629737492  E_coul = 199.13092186164795
cycle= 1 E= -507.938641112101  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602176
diis-c [-0.36261556  1.        ]
  HOMO = -0.233126653444476  LUMO = 10.1103186693082
  mo_energy =
[-1.20256519e+02 -1.23513104e+01 -6.64606607e+00 -6.64606607e+00
 -6.64606607e+00 -1.16151093e+00 -2.33126653e-01 -2.33126653e-01
 -2.33126653e-01  1.01103187e+01  1.10020206e+02  6.04594262e+02
  2.74423366e+03  1.22234243e+04  4.08449604e+04  1.04888620e+05
  2.30072074e+05  4.55887020e+05  8.44839284e+05  1.52801655e+06
  2.85028396e+06  5.80817125e+06]
E1 = -706.7160133684883  E_coul = 198.77099340200914
cycle= 2 E= -507.945019966479  delta_E= -0.00638  |g|= 0.0181  |ddm|= 0.194
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152513
diis-c [-2.24014142e-04  4.84410069e-03  9.95155899e-01]
  HOMO = -0.237576972270699  LUMO = 10.099403301946
  mo_energy =
[-1.20314277e+02 -1.23736748e+01 -6.67389730e+00 -6.67389730e+00
 -6.67389730e+00 -1.16377218e+00 -2.37576972e-01 -2.37576972e-01
 -2.37576972e-01  1.00994033e+01  1.09976779e+02  6.04533202e+02
  2.74415976e+03  1.22233422e+04  4.08448752e+04  1.04888534e+05
  2.30071987e+05  4.55886932e+05  8.44839196e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7013832418506  E_coul = 198.75635123120014
cycle= 3 E= -507.94503201065  delta_E= -1.2e-05  |g|= 0.000876  |ddm|= 0.00871
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739286
diis-c [-1.25458488e-08  3.75467033e-05 -5.00416212e-02  1.05000407e+00]
  HOMO = -0.237802816850603  LUMO = 10.0988615576916
  mo_energy =
[-1.20316872e+02 -1.23747822e+01 -6.67525156e+00 -6.67525156e+00
 -6.67525156e+00 -1.16388234e+00 -2.37802817e-01 -2.37802817e-01
 -2.37802817e-01  1.00988616e+01  1.09974760e+02  6.04530533e+02
  2.74415672e+03  1.22233389e+04  4.08448719e+04  1.04888530e+05
  2.30071983e+05  4.55886929e+05  8.44839193e+05  1.52801646e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7006483184584  E_coul = 198.75561627777932
cycle= 4 E= -507.945032040679  delta_E= -3e-08  |g|= 6.23e-06  |ddm|= 0.000461
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.43429e-06
diis-c [-4.69444463e-12 -1.76206087e-06  2.29613110e-03 -4.56315252e-02
  1.04333716e+00]
  HOMO = -0.237803558052922  LUMO = 10.0988608118899
  mo_energy =
[-1.20316870e+02 -1.23747846e+01 -6.67525310e+00 -6.67525310e+00
 -6.67525310e+00 -1.16388276e+00 -2.37803558e-01 -2.37803558e-01
 -2.37803558e-01  1.00988608e+01  1.09974761e+02  6.04530536e+02
  2.74415672e+03  1.22233389e+04  4.08448719e+04  1.04888530e+05
  2.30071984e+05  4.55886929e+05  8.44839193e+05  1.52801646e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7006472328023  E_coul = 198.7556151921224
cycle= 5 E= -507.94503204068  delta_E= -8.53e-13  |g|= 1.41e-07  |ddm|= 2.14e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7006472328023  E_coul = 198.7556151921224
  HOMO = -0.237803592008042  LUMO = 10.0988607423155
  mo_energy =
[-1.20316870e+02 -1.23747847e+01 -6.67525327e+00 -6.67525327e+00
 -6.67525327e+00 -1.16388278e+00 -2.37803592e-01 -2.37803592e-01
 -2.37803592e-01  1.00988607e+01  1.09974760e+02  6.04530535e+02
  2.74415672e+03  1.22233389e+04  4.08448719e+04  1.04888530e+05
  2.30071984e+05  4.55886929e+05  8.44839193e+05  1.52801646e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7006471398956  E_coul = 198.75561509921573
Extra cycle  E= -507.94503204068  delta_E= 5.68e-14  |g|= 7.34e-09  |ddm|= 7.22e-08
    CPU time for scf_cycle      0.42 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907705.316032636
E1 = -706.7006471398956  E_coul = 198.75561509921573
init E= -507.94503204068
    CPU time for initialize scf      1.31 sec, wall time      0.08 sec
  HOMO = -0.237803593608222  LUMO = 10.0988607392321
  mo_energy =
[-1.20316870e+02 -1.23747848e+01 -6.67525328e+00 -6.67525328e+00
 -6.67525328e+00 -1.16388278e+00 -2.37803594e-01 -2.37803594e-01
 -2.37803594e-01  1.00988607e+01  1.09974760e+02  6.04530535e+02
  2.74415672e+03  1.22233389e+04  4.08448719e+04  1.04888530e+05
  2.30071984e+05  4.55886929e+05  8.44839193e+05  1.52801646e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7006471357  E_coul = 198.7556150950205
cycle= 1 E= -507.94503204068  delta_E= 3.98e-13  |g|= 1.53e-09  |ddm|= 3.57e-09
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
E1 = -706.7006471357  E_coul = 198.7556150950205
  HOMO = -0.237803593686358  LUMO = 10.0988607390911
  mo_energy =
[-1.20316870e+02 -1.23747848e+01 -6.67525328e+00 -6.67525328e+00
 -6.67525328e+00 -1.16388278e+00 -2.37803594e-01 -2.37803594e-01
 -2.37803594e-01  1.00988607e+01  1.09974760e+02  6.04530535e+02
  2.74415672e+03  1.22233389e+04  4.08448719e+04  1.04888530e+05
  2.30071984e+05  4.55886929e+05  8.44839193e+05  1.52801646e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7006471355  E_coul = 198.75561509482023
Extra cycle  E= -507.94503204068  delta_E= -3.41e-13  |g|= 1.65e-09  |ddm|= 1.85e-10
    CPU time for scf_cycle      1.50 sec, wall time      0.15 sec
exp = [1.17616814e+05 3.96627959e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547202e+04
 7.30348380e+03 1.83758105e+04 1.44976250e+03 3.73996059e+02
 1.13285419e+02 3.77574423e+01 8.09953520e+00 3.20750787e+00
 8.60386570e+00 4.93006353e-01]
grad_E = [ 4.17323794e-09  2.09634846e-05  1.86506341e-11  1.12477443e-10
  6.49296735e-10  2.54623566e-09  1.05779660e-08  5.69150224e-08
  3.57946978e-06  1.22277209e-07  5.52223776e-06 -8.57931741e-06
 -1.14868470e-06  7.89142457e-06  4.46623444e-05  1.31418079e-05
  2.25165010e-07  9.06872203e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814252        1
[INPUT] 0    0    [1    /1   ]  0.396625520991       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031133        1
[INPUT] 0    0    [1    /1   ]  147020.992154        1
[INPUT] 0    0    [1    /1   ]  73510.4209958        1
[INPUT] 0    0    [1    /1   ]  36754.7201768        1
[INPUT] 0    0    [1    /1   ]  7303.48400153        1
[INPUT] 0    0    [1    /1   ]  18375.8104926        1
[INPUT] 0    0    [1    /1   ]  1449.76283665        1
[INPUT] 0    0    [1    /1   ]  373.995290189        1
[INPUT] 0    0    [1    /1   ]  113.286189344        1
[INPUT] 0    0    [1    /1   ]  37.7580106655        1
[INPUT] 0    0    [1    /1   ]  8.09916868973        1
[INPUT] 0    0    [1    /1   ]  3.20741719173        1
[INPUT] 1    0    [1    /1   ]  8.60385877611        1
[INPUT] 1    0    [1    /1   ]  0.493000816376       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81425177326, 1.0]], [0, [0.3966255209914223, 1.0]], [0, [1176168.1426189318, 1.0]], [0, [588084.0699928325, 1.0]], [0, [294042.0311334332, 1.0]], [0, [147020.9921538617, 1.0]], [0, [73510.42099581867, 1.0]], [0, [36754.720176788476, 1.0]], [0, [7303.48400153425, 1.0]], [0, [18375.81049256703, 1.0]], [0, [1449.7628366488589, 1.0]], [0, [373.99529018919765, 1.0]], [0, [113.28618934428235, 1.0]], [0, [37.75801066552617, 1.0]], [0, [8.099168689731131, 1.0]], [0, [3.2074171917337235, 1.0]], [1, [8.60385877611439, 1.0]], [1, [0.4930008163762416, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81425177]
bas 1, expnt(s) = [0.39662552]
bas 2, expnt(s) = [1176168.14261893]
bas 3, expnt(s) = [588084.06999283]
bas 4, expnt(s) = [294042.03113343]
bas 5, expnt(s) = [147020.99215386]
bas 6, expnt(s) = [73510.42099582]
bas 7, expnt(s) = [36754.72017679]
bas 8, expnt(s) = [7303.48400153]
bas 9, expnt(s) = [18375.81049257]
bas 10, expnt(s) = [1449.76283665]
bas 11, expnt(s) = [373.99529019]
bas 12, expnt(s) = [113.28618934]
bas 13, expnt(s) = [37.75801067]
bas 14, expnt(s) = [8.09916869]
bas 15, expnt(s) = [3.20741719]
bas 16, expnt(s) = [8.60385878]
bas 17, expnt(s) = [0.49300082]
CPU time:       180.92
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96625521e-01 1.26270098e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547202e+04 6.70656078e+03
 7.30348400e+03 1.99600942e+03 1.83758105e+04 3.98749271e+03
 1.44976284e+03 5.93591600e+02 3.73995290e+02 2.14864479e+02
 1.13286189e+02 8.77299235e+01 3.77580107e+01 3.84832598e+01
 8.09916869e+00 1.21295687e+01 3.20741719e+00 6.05524352e+00
 8.60385878e+00 4.29883706e+01 4.93000816e-01 1.20515787e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325104158254753
cond(S) = 907705.3365143538
E1 = -689.3974023993375  E_coul = 184.91132621504528
init E= -504.486076184292
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674721950359213  LUMO = 9.2001115119542
  mo_energy =
[-1.21707246e+02 -1.33875280e+01 -7.62809956e+00 -7.62809956e+00
 -7.62809956e+00 -1.64019404e+00 -6.74721950e-01 -6.74721950e-01
 -6.74721950e-01  9.20011151e+00  1.08670619e+02  6.03159338e+02
  2.74286392e+03  1.22221660e+04  4.08437697e+04  1.04887466e+05
  2.30070945e+05  4.55885908e+05  8.44838186e+05  1.52801547e+06
  2.85028288e+06  5.80817018e+06]
E1 = -707.0692157092052  E_coul = 199.13057495665956
cycle= 1 E= -507.938640752546  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602176
diis-c [-0.36261568  1.        ]
  HOMO = -0.233140331547646  LUMO = 10.1096727224005
  mo_energy =
[-1.20256550e+02 -1.23513374e+01 -6.64608752e+00 -6.64608752e+00
 -6.64608752e+00 -1.16152088e+00 -2.33140332e-01 -2.33140332e-01
 -2.33140332e-01  1.01096727e+01  1.10019708e+02  6.04595897e+02
  2.74423511e+03  1.22234258e+04  4.08449622e+04  1.04888622e+05
  2.30072076e+05  4.55887022e+05  8.44839286e+05  1.52801656e+06
  2.85028396e+06  5.80817125e+06]
E1 = -706.7156480705796  E_coul = 198.7706281017169
cycle= 2 E= -507.945019968863  delta_E= -0.00638  |g|= 0.0181  |ddm|= 0.194
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152513
diis-c [-2.24015605e-04  4.84429491e-03  9.95155705e-01]
  HOMO = -0.237590942312444  LUMO = 10.0987570865642
  mo_energy =
[-1.20314310e+02 -1.23737032e+01 -6.67392029e+00 -6.67392029e+00
 -6.67392029e+00 -1.16378232e+00 -2.37590942e-01 -2.37590942e-01
 -2.37590942e-01  1.00987571e+01  1.09976279e+02  6.04534835e+02
  2.74416121e+03  1.22233437e+04  4.08448771e+04  1.04888536e+05
  2.30071989e+05  4.55886935e+05  8.44839199e+05  1.52801647e+06
  2.85028387e+06  5.80817117e+06]
E1 = -706.7010167103135  E_coul = 198.7559846957037
cycle= 3 E= -507.94503201461  delta_E= -1.2e-05  |g|= 0.000876  |ddm|= 0.00871
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739304
diis-c [-1.25497307e-08  3.75516899e-05 -5.00424549e-02  1.05000490e+00]
  HOMO = -0.237816810730581  LUMO = 10.098215308317
  mo_energy =
[-1.20316905e+02 -1.23748107e+01 -6.67527467e+00 -6.67527467e+00
 -6.67527467e+00 -1.16389250e+00 -2.37816811e-01 -2.37816811e-01
 -2.37816811e-01  1.00982153e+01  1.09974260e+02  6.04532166e+02
  2.74415816e+03  1.22233404e+04  4.08448737e+04  1.04888532e+05
  2.30071986e+05  4.55886931e+05  8.44839195e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.700281697357  E_coul = 198.75524965271205
cycle= 4 E= -507.945032044645  delta_E= -3e-08  |g|= 6.23e-06  |ddm|= 0.000461
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.43576e-06
diis-c [-4.69790788e-12 -1.76178215e-06  2.29652769e-03 -4.56395854e-02
  1.04334482e+00]
  HOMO = -0.237817552321051  LUMO = 10.0982145618424
  mo_energy =
[-1.20316903e+02 -1.23748131e+01 -6.67527621e+00 -6.67527621e+00
 -6.67527621e+00 -1.16389292e+00 -2.37817552e-01 -2.37817552e-01
 -2.37817552e-01  1.00982146e+01  1.09974261e+02  6.04532169e+02
  2.74415817e+03  1.22233404e+04  4.08448737e+04  1.04888532e+05
  2.30071986e+05  4.55886931e+05  8.44839195e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7002806107164  E_coul = 198.75524856606998
cycle= 5 E= -507.945032044646  delta_E= -1.42e-12  |g|= 1.41e-07  |ddm|= 2.14e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7002806107164  E_coul = 198.75524856606998
  HOMO = -0.237817586277618  LUMO = 10.0982144922642
  mo_energy =
[-1.20316904e+02 -1.23748132e+01 -6.67527638e+00 -6.67527638e+00
 -6.67527638e+00 -1.16389294e+00 -2.37817586e-01 -2.37817586e-01
 -2.37817586e-01  1.00982145e+01  1.09974260e+02  6.04532168e+02
  2.74415816e+03  1.22233404e+04  4.08448737e+04  1.04888532e+05
  2.30071986e+05  4.55886931e+05  8.44839195e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7002805177905  E_coul = 198.75524847314378
Extra cycle  E= -507.945032044647  delta_E= -3.41e-13  |g|= 7.3e-09  |ddm|= 7.22e-08
    CPU time for scf_cycle      0.42 sec, wall time      0.09 sec
exp = [1.17616814e+05 3.96625521e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547202e+04
 7.30348400e+03 1.83758105e+04 1.44976284e+03 3.73995290e+02
 1.13286189e+02 3.77580107e+01 8.09916869e+00 3.20741719e+00
 8.60385878e+00 4.93000816e-01]
E = -507.9450320446467
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814252        1
[INPUT] 0    0    [1    /1   ]  0.396625520991       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031133        1
[INPUT] 0    0    [1    /1   ]  147020.992154        1
[INPUT] 0    0    [1    /1   ]  73510.4209958        1
[INPUT] 0    0    [1    /1   ]  36754.7201768        1
[INPUT] 0    0    [1    /1   ]  7303.48400153        1
[INPUT] 0    0    [1    /1   ]  18375.8104926        1
[INPUT] 0    0    [1    /1   ]  1449.76283665        1
[INPUT] 0    0    [1    /1   ]  373.995290189        1
[INPUT] 0    0    [1    /1   ]  113.286189344        1
[INPUT] 0    0    [1    /1   ]  37.7580106655        1
[INPUT] 0    0    [1    /1   ]  8.09916868973        1
[INPUT] 0    0    [1    /1   ]  3.20741719173        1
[INPUT] 1    0    [1    /1   ]  8.60385877611        1
[INPUT] 1    0    [1    /1   ]  0.493000816376       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81425177326, 1.0]], [0, [0.3966255209914223, 1.0]], [0, [1176168.1426189318, 1.0]], [0, [588084.0699928325, 1.0]], [0, [294042.0311334332, 1.0]], [0, [147020.9921538617, 1.0]], [0, [73510.42099581867, 1.0]], [0, [36754.720176788476, 1.0]], [0, [7303.48400153425, 1.0]], [0, [18375.81049256703, 1.0]], [0, [1449.7628366488589, 1.0]], [0, [373.99529018919765, 1.0]], [0, [113.28618934428235, 1.0]], [0, [37.75801066552617, 1.0]], [0, [8.099168689731131, 1.0]], [0, [3.2074171917337235, 1.0]], [1, [8.60385877611439, 1.0]], [1, [0.4930008163762416, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81425177]
bas 1, expnt(s) = [0.39662552]
bas 2, expnt(s) = [1176168.14261893]
bas 3, expnt(s) = [588084.06999283]
bas 4, expnt(s) = [294042.03113343]
bas 5, expnt(s) = [147020.99215386]
bas 6, expnt(s) = [73510.42099582]
bas 7, expnt(s) = [36754.72017679]
bas 8, expnt(s) = [7303.48400153]
bas 9, expnt(s) = [18375.81049257]
bas 10, expnt(s) = [1449.76283665]
bas 11, expnt(s) = [373.99529019]
bas 12, expnt(s) = [113.28618934]
bas 13, expnt(s) = [37.75801067]
bas 14, expnt(s) = [8.09916869]
bas 15, expnt(s) = [3.20741719]
bas 16, expnt(s) = [8.60385878]
bas 17, expnt(s) = [0.49300082]
CPU time:       181.42
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96625521e-01 1.26270098e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547202e+04 6.70656078e+03
 7.30348400e+03 1.99600942e+03 1.83758105e+04 3.98749271e+03
 1.44976284e+03 5.93591600e+02 3.73995290e+02 2.14864479e+02
 1.13286189e+02 8.77299235e+01 3.77580107e+01 3.84832598e+01
 8.09916869e+00 1.21295687e+01 3.20741719e+00 6.05524352e+00
 8.60385878e+00 4.29883706e+01 4.93000816e-01 1.20515787e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325104158254753
cond(S) = 907705.3365143538
E1 = -689.3974023993375  E_coul = 184.91132621504528
init E= -504.486076184292
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674721950359213  LUMO = 9.2001115119542
  mo_energy =
[-1.21707246e+02 -1.33875280e+01 -7.62809956e+00 -7.62809956e+00
 -7.62809956e+00 -1.64019404e+00 -6.74721950e-01 -6.74721950e-01
 -6.74721950e-01  9.20011151e+00  1.08670619e+02  6.03159338e+02
  2.74286392e+03  1.22221660e+04  4.08437697e+04  1.04887466e+05
  2.30070945e+05  4.55885908e+05  8.44838186e+05  1.52801547e+06
  2.85028288e+06  5.80817018e+06]
E1 = -707.0692157092052  E_coul = 199.13057495665956
cycle= 1 E= -507.938640752546  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602176
diis-c [-0.36261568  1.        ]
  HOMO = -0.233140331547646  LUMO = 10.1096727224005
  mo_energy =
[-1.20256550e+02 -1.23513374e+01 -6.64608752e+00 -6.64608752e+00
 -6.64608752e+00 -1.16152088e+00 -2.33140332e-01 -2.33140332e-01
 -2.33140332e-01  1.01096727e+01  1.10019708e+02  6.04595897e+02
  2.74423511e+03  1.22234258e+04  4.08449622e+04  1.04888622e+05
  2.30072076e+05  4.55887022e+05  8.44839286e+05  1.52801656e+06
  2.85028396e+06  5.80817125e+06]
E1 = -706.7156480705796  E_coul = 198.7706281017169
cycle= 2 E= -507.945019968863  delta_E= -0.00638  |g|= 0.0181  |ddm|= 0.194
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152513
diis-c [-2.24015605e-04  4.84429491e-03  9.95155705e-01]
  HOMO = -0.237590942312444  LUMO = 10.0987570865642
  mo_energy =
[-1.20314310e+02 -1.23737032e+01 -6.67392029e+00 -6.67392029e+00
 -6.67392029e+00 -1.16378232e+00 -2.37590942e-01 -2.37590942e-01
 -2.37590942e-01  1.00987571e+01  1.09976279e+02  6.04534835e+02
  2.74416121e+03  1.22233437e+04  4.08448771e+04  1.04888536e+05
  2.30071989e+05  4.55886935e+05  8.44839199e+05  1.52801647e+06
  2.85028387e+06  5.80817117e+06]
E1 = -706.7010167103135  E_coul = 198.7559846957037
cycle= 3 E= -507.94503201461  delta_E= -1.2e-05  |g|= 0.000876  |ddm|= 0.00871
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739304
diis-c [-1.25497307e-08  3.75516899e-05 -5.00424549e-02  1.05000490e+00]
  HOMO = -0.237816810730581  LUMO = 10.098215308317
  mo_energy =
[-1.20316905e+02 -1.23748107e+01 -6.67527467e+00 -6.67527467e+00
 -6.67527467e+00 -1.16389250e+00 -2.37816811e-01 -2.37816811e-01
 -2.37816811e-01  1.00982153e+01  1.09974260e+02  6.04532166e+02
  2.74415816e+03  1.22233404e+04  4.08448737e+04  1.04888532e+05
  2.30071986e+05  4.55886931e+05  8.44839195e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.700281697357  E_coul = 198.75524965271205
cycle= 4 E= -507.945032044645  delta_E= -3e-08  |g|= 6.23e-06  |ddm|= 0.000461
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.43576e-06
diis-c [-4.69790788e-12 -1.76178215e-06  2.29652769e-03 -4.56395854e-02
  1.04334482e+00]
  HOMO = -0.237817552321051  LUMO = 10.0982145618424
  mo_energy =
[-1.20316903e+02 -1.23748131e+01 -6.67527621e+00 -6.67527621e+00
 -6.67527621e+00 -1.16389292e+00 -2.37817552e-01 -2.37817552e-01
 -2.37817552e-01  1.00982146e+01  1.09974261e+02  6.04532169e+02
  2.74415817e+03  1.22233404e+04  4.08448737e+04  1.04888532e+05
  2.30071986e+05  4.55886931e+05  8.44839195e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7002806107164  E_coul = 198.75524856606998
cycle= 5 E= -507.945032044646  delta_E= -1.42e-12  |g|= 1.41e-07  |ddm|= 2.14e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7002806107164  E_coul = 198.75524856606998
  HOMO = -0.237817586277618  LUMO = 10.0982144922642
  mo_energy =
[-1.20316904e+02 -1.23748132e+01 -6.67527638e+00 -6.67527638e+00
 -6.67527638e+00 -1.16389294e+00 -2.37817586e-01 -2.37817586e-01
 -2.37817586e-01  1.00982145e+01  1.09974260e+02  6.04532168e+02
  2.74415816e+03  1.22233404e+04  4.08448737e+04  1.04888532e+05
  2.30071986e+05  4.55886931e+05  8.44839195e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7002805177905  E_coul = 198.75524847314378
Extra cycle  E= -507.945032044647  delta_E= -3.41e-13  |g|= 7.3e-09  |ddm|= 7.22e-08
    CPU time for scf_cycle      0.42 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907705.3365143538
E1 = -706.7002805177905  E_coul = 198.75524847314378
init E= -507.945032044647
    CPU time for initialize scf      1.28 sec, wall time      0.08 sec
  HOMO = -0.237817587878111  LUMO = 10.0982144891812
  mo_energy =
[-1.20316904e+02 -1.23748133e+01 -6.67527639e+00 -6.67527639e+00
 -6.67527639e+00 -1.16389294e+00 -2.37817588e-01 -2.37817588e-01
 -2.37817588e-01  1.00982145e+01  1.09974260e+02  6.04532168e+02
  2.74415816e+03  1.22233404e+04  4.08448737e+04  1.04888532e+05
  2.30071986e+05  4.55886931e+05  8.44839195e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7002805135875  E_coul = 198.75524846894186
cycle= 1 E= -507.945032044646  delta_E= 1.14e-12  |g|= 1.43e-09  |ddm|= 3.57e-09
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
E1 = -706.7002805135875  E_coul = 198.75524846894186
  HOMO = -0.237817587956407  LUMO = 10.098214489039
  mo_energy =
[-1.20316904e+02 -1.23748133e+01 -6.67527639e+00 -6.67527639e+00
 -6.67527639e+00 -1.16389294e+00 -2.37817588e-01 -2.37817588e-01
 -2.37817588e-01  1.00982145e+01  1.09974260e+02  6.04532168e+02
  2.74415816e+03  1.22233404e+04  4.08448737e+04  1.04888532e+05
  2.30071986e+05  4.55886931e+05  8.44839195e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.7002805133843  E_coul = 198.75524846873807
Extra cycle  E= -507.945032044646  delta_E= -6.82e-13  |g|= 1.94e-09  |ddm|= 1.88e-10
    CPU time for scf_cycle      1.47 sec, wall time      0.15 sec
exp = [1.17616814e+05 3.96625521e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547202e+04
 7.30348400e+03 1.83758105e+04 1.44976284e+03 3.73995290e+02
 1.13286189e+02 3.77580107e+01 8.09916869e+00 3.20741719e+00
 8.60385878e+00 4.93000816e-01]
grad_E = [ 4.17308615e-09 -2.66025344e-05  1.86488259e-11  1.12472515e-10
  6.49273231e-10  2.54614186e-09  1.05775707e-08  5.69130743e-08
  3.57933459e-06  1.22271295e-07  5.52838487e-06 -8.61363669e-06
 -1.41309825e-06  9.58145091e-06  4.30342969e-05  1.12639876e-05
 -3.43918700e-07 -1.14737852e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814252        1
[INPUT] 0    0    [1    /1   ]  0.396623679536       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031133        1
[INPUT] 0    0    [1    /1   ]  147020.992154        1
[INPUT] 0    0    [1    /1   ]  73510.4209964        1
[INPUT] 0    0    [1    /1   ]  36754.7201799        1
[INPUT] 0    0    [1    /1   ]  7303.48419455        1
[INPUT] 0    0    [1    /1   ]  18375.8104992        1
[INPUT] 0    0    [1    /1   ]  1449.76316464        1
[INPUT] 0    0    [1    /1   ]  373.994525822        1
[INPUT] 0    0    [1    /1   ]  113.286990343        1
[INPUT] 0    0    [1    /1   ]  37.7585187436        1
[INPUT] 0    0    [1    /1   ]  8.09873339373        1
[INPUT] 0    0    [1    /1   ]  3.20730603383        1
[INPUT] 1    0    [1    /1   ]  8.60385352534        1
[INPUT] 1    0    [1    /1   ]  0.492996541234       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81425199832, 1.0]], [0, [0.39662367953617467, 1.0]], [0, [1176168.1426189328, 1.0]], [0, [588084.0699928385, 1.0]], [0, [294042.03113346826, 1.0]], [0, [147020.99215399902, 1.0]], [0, [73510.4209963891, 1.0]], [0, [36754.720179858465, 1.0]], [0, [7303.484194549483, 1.0]], [0, [18375.810499155363, 1.0]], [0, [1449.7631646443363, 1.0]], [0, [373.9945258221361, 1.0]], [0, [113.28699034315854, 1.0]], [0, [37.75851874358737, 1.0]], [0, [8.098733393734104, 1.0]], [0, [3.2073060338275035, 1.0]], [1, [8.603853525344743, 1.0]], [1, [0.49299654123403547, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.814252]
bas 1, expnt(s) = [0.39662368]
bas 2, expnt(s) = [1176168.14261893]
bas 3, expnt(s) = [588084.06999284]
bas 4, expnt(s) = [294042.03113347]
bas 5, expnt(s) = [147020.992154]
bas 6, expnt(s) = [73510.42099639]
bas 7, expnt(s) = [36754.72017986]
bas 8, expnt(s) = [7303.48419455]
bas 9, expnt(s) = [18375.81049916]
bas 10, expnt(s) = [1449.76316464]
bas 11, expnt(s) = [373.99452582]
bas 12, expnt(s) = [113.28699034]
bas 13, expnt(s) = [37.75851874]
bas 14, expnt(s) = [8.09873339]
bas 15, expnt(s) = [3.20730603]
bas 16, expnt(s) = [8.60385353]
bas 17, expnt(s) = [0.49299654]
CPU time:       186.09
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96623680e-01 1.26269658e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547202e+04 6.70656078e+03
 7.30348419e+03 1.99600946e+03 1.83758105e+04 3.98749271e+03
 1.44976316e+03 5.93591700e+02 3.73994526e+02 2.14864149e+02
 1.13286990e+02 8.77303887e+01 3.77585187e+01 3.84836482e+01
 8.09873339e+00 1.21290797e+01 3.20730603e+00 6.05508613e+00
 8.60385353e+00 4.29883378e+01 4.92996541e-01 1.20514481e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325110124511273
cond(S) = 907705.3520626469
E1 = -689.3972089967452  E_coul = 184.9111555587811
init E= -504.486053437964
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674727504501961  LUMO = 9.19936737433405
  mo_energy =
[-1.21707263e+02 -1.33875428e+01 -7.62811011e+00 -7.62811011e+00
 -7.62811011e+00 -1.64019764e+00 -6.74727505e-01 -6.74727505e-01
 -6.74727505e-01  9.19936737e+00  1.08669667e+02  6.03160502e+02
  2.74286498e+03  1.22221672e+04  4.08437713e+04  1.04887468e+05
  2.30070947e+05  4.55885910e+05  8.44838188e+05  1.52801547e+06
  2.85028288e+06  5.80817018e+06]
E1 = -707.0689533025211  E_coul = 199.13031298993513
cycle= 1 E= -507.938640312586  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.602176
diis-c [-0.36261581  1.        ]
  HOMO = -0.233150796256028  LUMO = 10.1089049705231
  mo_energy =
[-1.20256574e+02 -1.23513580e+01 -6.64610357e+00 -6.64610357e+00
 -6.64610357e+00 -1.16152841e+00 -2.33150796e-01 -2.33150796e-01
 -2.33150796e-01  1.01089050e+01  1.10018751e+02  6.04597056e+02
  2.74423616e+03  1.22234269e+04  4.08449637e+04  1.04888624e+05
  2.30072078e+05  4.55887024e+05  8.44839288e+05  1.52801656e+06
  2.85028396e+06  5.80817126e+06]
E1 = -706.7153636924813  E_coul = 198.77034372014032
cycle= 2 E= -507.945019972341  delta_E= -0.00638  |g|= 0.0181  |ddm|= 0.194
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152514
diis-c [-2.24018363e-04  4.84450947e-03  9.95155491e-01]
  HOMO = -0.237601784301959  LUMO = 10.0979890142091
  mo_energy =
[-1.20314336e+02 -1.23737254e+01 -6.67393819e+00 -6.67393819e+00
 -6.67393819e+00 -1.16379010e+00 -2.37601784e-01 -2.37601784e-01
 -2.37601784e-01  1.00979890e+01  1.09975320e+02  6.04535991e+02
  2.74416226e+03  1.22233448e+04  4.08448786e+04  1.04888537e+05
  2.30071991e+05  4.55886936e+05  8.44839200e+05  1.52801647e+06
  2.85028387e+06  5.80817117e+06]
E1 = -706.7007308298714  E_coul = 198.7556988098624
cycle= 3 E= -507.945032020009  delta_E= -1.2e-05  |g|= 0.000876  |ddm|= 0.00871
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739327
diis-c [-1.25545886e-08  3.75571433e-05 -5.00434279e-02  1.05000587e+00]
  HOMO = -0.237827682682298  LUMO = 10.097447195127
  mo_energy =
[-1.20316932e+02 -1.23748330e+01 -6.67529271e+00 -6.67529271e+00
 -6.67529271e+00 -1.16390029e+00 -2.37827683e-01 -2.37827683e-01
 -2.37827683e-01  1.00974472e+01  1.09973301e+02  6.04533321e+02
  2.74415921e+03  1.22233416e+04  4.08448752e+04  1.04888534e+05
  2.30071987e+05  4.55886933e+05  8.44839197e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.6999957082254  E_coul = 198.75496365817347
cycle= 4 E= -507.945032050052  delta_E= -3e-08  |g|= 6.23e-06  |ddm|= 0.000461
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.43712e-06
diis-c [-4.69667273e-12 -1.76374955e-06  2.29692344e-03 -4.56469309e-02
  1.04335177e+00]
  HOMO = -0.237828424749095  LUMO = 10.0974464478244
  mo_energy =
[-1.20316929e+02 -1.23748355e+01 -6.67529426e+00 -6.67529426e+00
 -6.67529426e+00 -1.16390072e+00 -2.37828425e-01 -2.37828425e-01
 -2.37828425e-01  1.00974464e+01  1.09973301e+02  6.04533324e+02
  2.74415921e+03  1.22233416e+04  4.08448752e+04  1.04888534e+05
  2.30071987e+05  4.55886933e+05  8.44839197e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.6999946203425  E_coul = 198.75496257028945
cycle= 5 E= -507.945032050053  delta_E= -1.14e-12  |g|= 1.41e-07  |ddm|= 2.15e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6999946203425  E_coul = 198.75496257028945
  HOMO = -0.237828458705163  LUMO = 10.0974463782517
  mo_energy =
[-1.20316930e+02 -1.23748356e+01 -6.67529443e+00 -6.67529443e+00
 -6.67529443e+00 -1.16390074e+00 -2.37828459e-01 -2.37828459e-01
 -2.37828459e-01  1.00974464e+01  1.09973301e+02  6.04533324e+02
  2.74415921e+03  1.22233416e+04  4.08448752e+04  1.04888534e+05
  2.30071987e+05  4.55886933e+05  8.44839197e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.6999945274262  E_coul = 198.7549624773733
Extra cycle  E= -507.945032050053  delta_E= 2.27e-13  |g|= 7.27e-09  |ddm|= 7.22e-08
    CPU time for scf_cycle      0.42 sec, wall time      0.09 sec
exp = [1.17616814e+05 3.96623680e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547202e+04
 7.30348419e+03 1.83758105e+04 1.44976316e+03 3.73994526e+02
 1.13286990e+02 3.77585187e+01 8.09873339e+00 3.20730603e+00
 8.60385353e+00 4.92996541e-01]
E = -507.9450320500529
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814252        1
[INPUT] 0    0    [1    /1   ]  0.396623679536       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031133        1
[INPUT] 0    0    [1    /1   ]  147020.992154        1
[INPUT] 0    0    [1    /1   ]  73510.4209964        1
[INPUT] 0    0    [1    /1   ]  36754.7201799        1
[INPUT] 0    0    [1    /1   ]  7303.48419455        1
[INPUT] 0    0    [1    /1   ]  18375.8104992        1
[INPUT] 0    0    [1    /1   ]  1449.76316464        1
[INPUT] 0    0    [1    /1   ]  373.994525822        1
[INPUT] 0    0    [1    /1   ]  113.286990343        1
[INPUT] 0    0    [1    /1   ]  37.7585187436        1
[INPUT] 0    0    [1    /1   ]  8.09873339373        1
[INPUT] 0    0    [1    /1   ]  3.20730603383        1
[INPUT] 1    0    [1    /1   ]  8.60385352534        1
[INPUT] 1    0    [1    /1   ]  0.492996541234       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81425199832, 1.0]], [0, [0.39662367953617467, 1.0]], [0, [1176168.1426189328, 1.0]], [0, [588084.0699928385, 1.0]], [0, [294042.03113346826, 1.0]], [0, [147020.99215399902, 1.0]], [0, [73510.4209963891, 1.0]], [0, [36754.720179858465, 1.0]], [0, [7303.484194549483, 1.0]], [0, [18375.810499155363, 1.0]], [0, [1449.7631646443363, 1.0]], [0, [373.9945258221361, 1.0]], [0, [113.28699034315854, 1.0]], [0, [37.75851874358737, 1.0]], [0, [8.098733393734104, 1.0]], [0, [3.2073060338275035, 1.0]], [1, [8.603853525344743, 1.0]], [1, [0.49299654123403547, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.814252]
bas 1, expnt(s) = [0.39662368]
bas 2, expnt(s) = [1176168.14261893]
bas 3, expnt(s) = [588084.06999284]
bas 4, expnt(s) = [294042.03113347]
bas 5, expnt(s) = [147020.992154]
bas 6, expnt(s) = [73510.42099639]
bas 7, expnt(s) = [36754.72017986]
bas 8, expnt(s) = [7303.48419455]
bas 9, expnt(s) = [18375.81049916]
bas 10, expnt(s) = [1449.76316464]
bas 11, expnt(s) = [373.99452582]
bas 12, expnt(s) = [113.28699034]
bas 13, expnt(s) = [37.75851874]
bas 14, expnt(s) = [8.09873339]
bas 15, expnt(s) = [3.20730603]
bas 16, expnt(s) = [8.60385353]
bas 17, expnt(s) = [0.49299654]
CPU time:       186.60
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96623680e-01 1.26269658e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547202e+04 6.70656078e+03
 7.30348419e+03 1.99600946e+03 1.83758105e+04 3.98749271e+03
 1.44976316e+03 5.93591700e+02 3.73994526e+02 2.14864149e+02
 1.13286990e+02 8.77303887e+01 3.77585187e+01 3.84836482e+01
 8.09873339e+00 1.21290797e+01 3.20730603e+00 6.05508613e+00
 8.60385353e+00 4.29883378e+01 4.92996541e-01 1.20514481e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325110124511273
cond(S) = 907705.3520626469
E1 = -689.3972089967452  E_coul = 184.9111555587811
init E= -504.486053437964
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674727504501961  LUMO = 9.19936737433405
  mo_energy =
[-1.21707263e+02 -1.33875428e+01 -7.62811011e+00 -7.62811011e+00
 -7.62811011e+00 -1.64019764e+00 -6.74727505e-01 -6.74727505e-01
 -6.74727505e-01  9.19936737e+00  1.08669667e+02  6.03160502e+02
  2.74286498e+03  1.22221672e+04  4.08437713e+04  1.04887468e+05
  2.30070947e+05  4.55885910e+05  8.44838188e+05  1.52801547e+06
  2.85028288e+06  5.80817018e+06]
E1 = -707.0689533025211  E_coul = 199.13031298993513
cycle= 1 E= -507.938640312586  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602176
diis-c [-0.36261581  1.        ]
  HOMO = -0.233150796256028  LUMO = 10.1089049705231
  mo_energy =
[-1.20256574e+02 -1.23513580e+01 -6.64610357e+00 -6.64610357e+00
 -6.64610357e+00 -1.16152841e+00 -2.33150796e-01 -2.33150796e-01
 -2.33150796e-01  1.01089050e+01  1.10018751e+02  6.04597056e+02
  2.74423616e+03  1.22234269e+04  4.08449637e+04  1.04888624e+05
  2.30072078e+05  4.55887024e+05  8.44839288e+05  1.52801656e+06
  2.85028396e+06  5.80817126e+06]
E1 = -706.7153636924813  E_coul = 198.77034372014032
cycle= 2 E= -507.945019972341  delta_E= -0.00638  |g|= 0.0181  |ddm|= 0.194
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152514
diis-c [-2.24018363e-04  4.84450947e-03  9.95155491e-01]
  HOMO = -0.237601784301959  LUMO = 10.0979890142091
  mo_energy =
[-1.20314336e+02 -1.23737254e+01 -6.67393819e+00 -6.67393819e+00
 -6.67393819e+00 -1.16379010e+00 -2.37601784e-01 -2.37601784e-01
 -2.37601784e-01  1.00979890e+01  1.09975320e+02  6.04535991e+02
  2.74416226e+03  1.22233448e+04  4.08448786e+04  1.04888537e+05
  2.30071991e+05  4.55886936e+05  8.44839200e+05  1.52801647e+06
  2.85028387e+06  5.80817117e+06]
E1 = -706.7007308298714  E_coul = 198.7556988098624
cycle= 3 E= -507.945032020009  delta_E= -1.2e-05  |g|= 0.000876  |ddm|= 0.00871
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739327
diis-c [-1.25545886e-08  3.75571433e-05 -5.00434279e-02  1.05000587e+00]
  HOMO = -0.237827682682298  LUMO = 10.097447195127
  mo_energy =
[-1.20316932e+02 -1.23748330e+01 -6.67529271e+00 -6.67529271e+00
 -6.67529271e+00 -1.16390029e+00 -2.37827683e-01 -2.37827683e-01
 -2.37827683e-01  1.00974472e+01  1.09973301e+02  6.04533321e+02
  2.74415921e+03  1.22233416e+04  4.08448752e+04  1.04888534e+05
  2.30071987e+05  4.55886933e+05  8.44839197e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.6999957082254  E_coul = 198.75496365817347
cycle= 4 E= -507.945032050052  delta_E= -3e-08  |g|= 6.23e-06  |ddm|= 0.000461
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.43712e-06
diis-c [-4.69667273e-12 -1.76374955e-06  2.29692344e-03 -4.56469309e-02
  1.04335177e+00]
  HOMO = -0.237828424749095  LUMO = 10.0974464478244
  mo_energy =
[-1.20316929e+02 -1.23748355e+01 -6.67529426e+00 -6.67529426e+00
 -6.67529426e+00 -1.16390072e+00 -2.37828425e-01 -2.37828425e-01
 -2.37828425e-01  1.00974464e+01  1.09973301e+02  6.04533324e+02
  2.74415921e+03  1.22233416e+04  4.08448752e+04  1.04888534e+05
  2.30071987e+05  4.55886933e+05  8.44839197e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.6999946203425  E_coul = 198.75496257028945
cycle= 5 E= -507.945032050053  delta_E= -1.14e-12  |g|= 1.41e-07  |ddm|= 2.15e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6999946203425  E_coul = 198.75496257028945
  HOMO = -0.237828458705163  LUMO = 10.0974463782517
  mo_energy =
[-1.20316930e+02 -1.23748356e+01 -6.67529443e+00 -6.67529443e+00
 -6.67529443e+00 -1.16390074e+00 -2.37828459e-01 -2.37828459e-01
 -2.37828459e-01  1.00974464e+01  1.09973301e+02  6.04533324e+02
  2.74415921e+03  1.22233416e+04  4.08448752e+04  1.04888534e+05
  2.30071987e+05  4.55886933e+05  8.44839197e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.6999945274262  E_coul = 198.7549624773733
Extra cycle  E= -507.945032050053  delta_E= 2.27e-13  |g|= 7.27e-09  |ddm|= 7.22e-08
    CPU time for scf_cycle      0.42 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907705.3520626469
E1 = -706.6999945274262  E_coul = 198.7549624773733
init E= -507.945032050053
    CPU time for initialize scf      1.34 sec, wall time      0.08 sec
  HOMO = -0.237828460305518  LUMO = 10.0974463751689
  mo_energy =
[-1.20316930e+02 -1.23748356e+01 -6.67529444e+00 -6.67529444e+00
 -6.67529444e+00 -1.16390074e+00 -2.37828460e-01 -2.37828460e-01
 -2.37828460e-01  1.00974464e+01  1.09973301e+02  6.04533324e+02
  2.74415921e+03  1.22233416e+04  4.08448752e+04  1.04888534e+05
  2.30071987e+05  4.55886933e+05  8.44839197e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.6999945232109  E_coul = 198.7549624731578
cycle= 1 E= -507.945032050053  delta_E= -2.27e-13  |g|= 2.8e-09  |ddm|= 3.58e-09
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
E1 = -706.6999945232109  E_coul = 198.7549624731578
  HOMO = -0.237828460384059  LUMO = 10.0974463750261
  mo_energy =
[-1.20316930e+02 -1.23748356e+01 -6.67529444e+00 -6.67529444e+00
 -6.67529444e+00 -1.16390074e+00 -2.37828460e-01 -2.37828460e-01
 -2.37828460e-01  1.00974464e+01  1.09973301e+02  6.04533324e+02
  2.74415921e+03  1.22233416e+04  4.08448752e+04  1.04888534e+05
  2.30071987e+05  4.55886933e+05  8.44839197e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.699994523023  E_coul = 198.7549624729703
Extra cycle  E= -507.945032050053  delta_E= 4.55e-13  |g|= 1.26e-09  |ddm|= 1.75e-10
    CPU time for scf_cycle      1.53 sec, wall time      0.15 sec
exp = [1.17616814e+05 3.96623680e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547202e+04
 7.30348419e+03 1.83758105e+04 1.44976316e+03 3.73994526e+02
 1.13286990e+02 3.77585187e+01 8.09873339e+00 3.20730603e+00
 8.60385353e+00 4.92996541e-01]
grad_E = [ 4.17290723e-09 -6.34653600e-05  1.86466950e-11  1.12466707e-10
  6.49245524e-10  2.54603129e-09  1.05771047e-08  5.69107774e-08
  3.57917431e-06  1.22264326e-07  5.53600069e-06 -8.66959144e-06
 -1.53199927e-06  1.09221876e-05  4.10447040e-05  9.70136188e-06
 -7.88502817e-07 -2.73994973e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:54 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814252        1
[INPUT] 0    0    [1    /1   ]  0.396620747896       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031134        1
[INPUT] 0    0    [1    /1   ]  147020.992154        1
[INPUT] 0    0    [1    /1   ]  73510.4209971        1
[INPUT] 0    0    [1    /1   ]  36754.7201838        1
[INPUT] 0    0    [1    /1   ]  7303.48444108        1
[INPUT] 0    0    [1    /1   ]  18375.8105076        1
[INPUT] 0    0    [1    /1   ]  1449.76358682        1
[INPUT] 0    0    [1    /1   ]  373.993517821        1
[INPUT] 0    0    [1    /1   ]  113.288095946        1
[INPUT] 0    0    [1    /1   ]  37.7592132107        1
[INPUT] 0    0    [1    /1   ]  8.09785053383        1
[INPUT] 0    0    [1    /1   ]  3.2070738525         1
[INPUT] 1    0    [1    /1   ]  8.603845163          1
[INPUT] 1    0    [1    /1   ]  0.492989598354       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.8142522858, 1.0]], [0, [0.3966207478960805, 1.0]], [0, [1176168.142618934, 1.0]], [0, [588084.0699928463, 1.0]], [0, [294042.03113351297, 1.0]], [0, [147020.9921541744, 1.0]], [0, [73510.42099711769, 1.0]], [0, [36754.72018377968, 1.0]], [0, [7303.484441076428, 1.0]], [0, [18375.810507569688, 1.0]], [0, [1449.7635868156376, 1.0]], [0, [373.99351782135386, 1.0]], [0, [113.288095946159, 1.0]], [0, [37.75921321066802, 1.0]], [0, [8.097850533828348, 1.0]], [0, [3.207073852501494, 1.0]], [1, [8.603845163000143, 1.0]], [1, [0.492989598354331, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81425229]
bas 1, expnt(s) = [0.39662075]
bas 2, expnt(s) = [1176168.14261893]
bas 3, expnt(s) = [588084.06999285]
bas 4, expnt(s) = [294042.03113351]
bas 5, expnt(s) = [147020.99215417]
bas 6, expnt(s) = [73510.42099712]
bas 7, expnt(s) = [36754.72018378]
bas 8, expnt(s) = [7303.48444108]
bas 9, expnt(s) = [18375.81050757]
bas 10, expnt(s) = [1449.76358682]
bas 11, expnt(s) = [373.99351782]
bas 12, expnt(s) = [113.28809595]
bas 13, expnt(s) = [37.75921321]
bas 14, expnt(s) = [8.09785053]
bas 15, expnt(s) = [3.20707385]
bas 16, expnt(s) = [8.60384516]
bas 17, expnt(s) = [0.4929896]
CPU time:       191.32
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96620748e-01 1.26268958e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547202e+04 6.70656078e+03
 7.30348444e+03 1.99600951e+03 1.83758105e+04 3.98749271e+03
 1.44976359e+03 5.93591830e+02 3.73993518e+02 2.14863715e+02
 1.13288096e+02 8.77310309e+01 3.77592132e+01 3.84841790e+01
 8.09785053e+00 1.21280881e+01 3.20707385e+00 6.05475738e+00
 8.60384516e+00 4.29882856e+01 4.92989598e-01 1.20512359e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32511985188748
cond(S) = 907705.3588398898
E1 = -689.3968968939097  E_coul = 184.91088147743034
init E= -504.486015416479
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674736471268741  LUMO = 9.19783789509053
  mo_energy =
[-1.21707290e+02 -1.33875668e+01 -7.62812700e+00 -7.62812700e+00
 -7.62812700e+00 -1.64020339e+00 -6.74736471e-01 -6.74736471e-01
 -6.74736471e-01  9.19783790e+00  1.08666859e+02  6.03160716e+02
  2.74286529e+03  1.22221678e+04  4.08437724e+04  1.04887470e+05
  2.30070948e+05  4.55885912e+05  8.44838189e+05  1.52801547e+06
  2.85028288e+06  5.80817019e+06]
E1 = -707.0685331958183  E_coul = 199.1298937934716
cycle= 1 E= -507.938639402347  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602176
diis-c [-0.36261583  1.        ]
  HOMO = -0.233167687038138  LUMO = 10.107328955009
  mo_energy =
[-1.20256611e+02 -1.23513911e+01 -6.64612907e+00 -6.64612907e+00
 -6.64612907e+00 -1.16154046e+00 -2.33167687e-01 -2.33167687e-01
 -2.33167687e-01  1.01073290e+01  1.10015934e+02  6.04597261e+02
  2.74423647e+03  1.22234275e+04  4.08449649e+04  1.04888625e+05
  2.30072079e+05  4.55887026e+05  8.44839290e+05  1.52801656e+06
  2.85028396e+06  5.80817126e+06]
E1 = -706.7148980670169  E_coul = 198.7698780838361
cycle= 2 E= -507.945019983181  delta_E= -0.00638  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152517
diis-c [-2.24025341e-04  4.84490688e-03  9.95155093e-01]
  HOMO = -0.237619473780744  LUMO = 10.0964123440153
  mo_energy =
[-1.20314378e+02 -1.23737620e+01 -6.67396750e+00 -6.67396750e+00
 -6.67396750e+00 -1.16380266e+00 -2.37619474e-01 -2.37619474e-01
 -2.37619474e-01  1.00964123e+01  1.09972499e+02  6.04536191e+02
  2.74416256e+03  1.22233454e+04  4.08448797e+04  1.04888539e+05
  2.30071992e+05  4.55886938e+05  8.44839202e+05  1.52801647e+06
  2.85028387e+06  5.80817117e+06]
E1 = -706.7002620909503  E_coul = 198.75523005611964
cycle= 3 E= -507.945032034831  delta_E= -1.21e-05  |g|= 0.000876  |ddm|= 0.00871
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739375
diis-c [-1.25646559e-08  3.75690680e-05 -5.00453957e-02  1.05000783e+00]
  HOMO = -0.237845434842164  LUMO = 10.0958704412582
  mo_energy =
[-1.20316974e+02 -1.23748699e+01 -6.67532232e+00 -6.67532232e+00
 -6.67532232e+00 -1.16391289e+00 -2.37845435e-01 -2.37845435e-01
 -2.37845435e-01  1.00958704e+01  1.09970479e+02  6.04533521e+02
  2.74415951e+03  1.22233421e+04  4.08448764e+04  1.04888535e+05
  2.30071989e+05  4.55886935e+05  8.44839199e+05  1.52801647e+06
  2.85028387e+06  5.80817117e+06]
E1 = -706.6995267448352  E_coul = 198.7544946799452
cycle= 4 E= -507.94503206489  delta_E= -3.01e-08  |g|= 6.23e-06  |ddm|= 0.000461
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.43959e-06
diis-c [-4.70065832e-12 -1.76134620e-06  2.29745589e-03 -4.56574683e-02
  1.04336177e+00]
  HOMO = -0.237846177877892  LUMO = 10.0958696922775
  mo_energy =
[-1.20316972e+02 -1.23748723e+01 -6.67532388e+00 -6.67532388e+00
 -6.67532388e+00 -1.16391331e+00 -2.37846178e-01 -2.37846178e-01
 -2.37846178e-01  1.00958697e+01  1.09970479e+02  6.04533524e+02
  2.74415952e+03  1.22233421e+04  4.08448764e+04  1.04888535e+05
  2.30071989e+05  4.55886935e+05  8.44839199e+05  1.52801647e+06
  2.85028387e+06  5.80817117e+06]
E1 = -706.6995256544643  E_coul = 198.75449358957314
cycle= 5 E= -507.945032064891  delta_E= -1.14e-12  |g|= 1.41e-07  |ddm|= 2.15e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6995256544643  E_coul = 198.75449358957314
  HOMO = -0.237846211851662  LUMO = 10.0958696226737
  mo_energy =
[-1.20316973e+02 -1.23748725e+01 -6.67532405e+00 -6.67532405e+00
 -6.67532405e+00 -1.16391333e+00 -2.37846212e-01 -2.37846212e-01
 -2.37846212e-01  1.00958696e+01  1.09970479e+02  6.04533524e+02
  2.74415952e+03  1.22233421e+04  4.08448764e+04  1.04888535e+05
  2.30071989e+05  4.55886935e+05  8.44839199e+05  1.52801647e+06
  2.85028387e+06  5.80817117e+06]
E1 = -706.6995255614713  E_coul = 198.75449349658035
Extra cycle  E= -507.945032064891  delta_E= 2.27e-13  |g|= 7.31e-09  |ddm|= 7.23e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
exp = [1.17616814e+05 3.96620748e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547202e+04
 7.30348444e+03 1.83758105e+04 1.44976359e+03 3.73993518e+02
 1.13288096e+02 3.77592132e+01 8.09785053e+00 3.20707385e+00
 8.60384516e+00 4.92989598e-01]
E = -507.94503206489094
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:55 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814252        1
[INPUT] 0    0    [1    /1   ]  0.396620747896       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031134        1
[INPUT] 0    0    [1    /1   ]  147020.992154        1
[INPUT] 0    0    [1    /1   ]  73510.4209971        1
[INPUT] 0    0    [1    /1   ]  36754.7201838        1
[INPUT] 0    0    [1    /1   ]  7303.48444108        1
[INPUT] 0    0    [1    /1   ]  18375.8105076        1
[INPUT] 0    0    [1    /1   ]  1449.76358682        1
[INPUT] 0    0    [1    /1   ]  373.993517821        1
[INPUT] 0    0    [1    /1   ]  113.288095946        1
[INPUT] 0    0    [1    /1   ]  37.7592132107        1
[INPUT] 0    0    [1    /1   ]  8.09785053383        1
[INPUT] 0    0    [1    /1   ]  3.2070738525         1
[INPUT] 1    0    [1    /1   ]  8.603845163          1
[INPUT] 1    0    [1    /1   ]  0.492989598354       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.8142522858, 1.0]], [0, [0.3966207478960805, 1.0]], [0, [1176168.142618934, 1.0]], [0, [588084.0699928463, 1.0]], [0, [294042.03113351297, 1.0]], [0, [147020.9921541744, 1.0]], [0, [73510.42099711769, 1.0]], [0, [36754.72018377968, 1.0]], [0, [7303.484441076428, 1.0]], [0, [18375.810507569688, 1.0]], [0, [1449.7635868156376, 1.0]], [0, [373.99351782135386, 1.0]], [0, [113.288095946159, 1.0]], [0, [37.75921321066802, 1.0]], [0, [8.097850533828348, 1.0]], [0, [3.207073852501494, 1.0]], [1, [8.603845163000143, 1.0]], [1, [0.492989598354331, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81425229]
bas 1, expnt(s) = [0.39662075]
bas 2, expnt(s) = [1176168.14261893]
bas 3, expnt(s) = [588084.06999285]
bas 4, expnt(s) = [294042.03113351]
bas 5, expnt(s) = [147020.99215417]
bas 6, expnt(s) = [73510.42099712]
bas 7, expnt(s) = [36754.72018378]
bas 8, expnt(s) = [7303.48444108]
bas 9, expnt(s) = [18375.81050757]
bas 10, expnt(s) = [1449.76358682]
bas 11, expnt(s) = [373.99351782]
bas 12, expnt(s) = [113.28809595]
bas 13, expnt(s) = [37.75921321]
bas 14, expnt(s) = [8.09785053]
bas 15, expnt(s) = [3.20707385]
bas 16, expnt(s) = [8.60384516]
bas 17, expnt(s) = [0.4929896]
CPU time:       191.84
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96620748e-01 1.26268958e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547202e+04 6.70656078e+03
 7.30348444e+03 1.99600951e+03 1.83758105e+04 3.98749271e+03
 1.44976359e+03 5.93591830e+02 3.73993518e+02 2.14863715e+02
 1.13288096e+02 8.77310309e+01 3.77592132e+01 3.84841790e+01
 8.09785053e+00 1.21280881e+01 3.20707385e+00 6.05475738e+00
 8.60384516e+00 4.29882856e+01 4.92989598e-01 1.20512359e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32511985188748
cond(S) = 907705.3588398898
E1 = -689.3968968939097  E_coul = 184.91088147743034
init E= -504.486015416479
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674736471268741  LUMO = 9.19783789509053
  mo_energy =
[-1.21707290e+02 -1.33875668e+01 -7.62812700e+00 -7.62812700e+00
 -7.62812700e+00 -1.64020339e+00 -6.74736471e-01 -6.74736471e-01
 -6.74736471e-01  9.19783790e+00  1.08666859e+02  6.03160716e+02
  2.74286529e+03  1.22221678e+04  4.08437724e+04  1.04887470e+05
  2.30070948e+05  4.55885912e+05  8.44838189e+05  1.52801547e+06
  2.85028288e+06  5.80817019e+06]
E1 = -707.0685331958183  E_coul = 199.1298937934716
cycle= 1 E= -507.938639402347  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602176
diis-c [-0.36261583  1.        ]
  HOMO = -0.233167687038138  LUMO = 10.107328955009
  mo_energy =
[-1.20256611e+02 -1.23513911e+01 -6.64612907e+00 -6.64612907e+00
 -6.64612907e+00 -1.16154046e+00 -2.33167687e-01 -2.33167687e-01
 -2.33167687e-01  1.01073290e+01  1.10015934e+02  6.04597261e+02
  2.74423647e+03  1.22234275e+04  4.08449649e+04  1.04888625e+05
  2.30072079e+05  4.55887026e+05  8.44839290e+05  1.52801656e+06
  2.85028396e+06  5.80817126e+06]
E1 = -706.7148980670169  E_coul = 198.7698780838361
cycle= 2 E= -507.945019983181  delta_E= -0.00638  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152517
diis-c [-2.24025341e-04  4.84490688e-03  9.95155093e-01]
  HOMO = -0.237619473780744  LUMO = 10.0964123440153
  mo_energy =
[-1.20314378e+02 -1.23737620e+01 -6.67396750e+00 -6.67396750e+00
 -6.67396750e+00 -1.16380266e+00 -2.37619474e-01 -2.37619474e-01
 -2.37619474e-01  1.00964123e+01  1.09972499e+02  6.04536191e+02
  2.74416256e+03  1.22233454e+04  4.08448797e+04  1.04888539e+05
  2.30071992e+05  4.55886938e+05  8.44839202e+05  1.52801647e+06
  2.85028387e+06  5.80817117e+06]
E1 = -706.7002620909503  E_coul = 198.75523005611964
cycle= 3 E= -507.945032034831  delta_E= -1.21e-05  |g|= 0.000876  |ddm|= 0.00871
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739375
diis-c [-1.25646559e-08  3.75690680e-05 -5.00453957e-02  1.05000783e+00]
  HOMO = -0.237845434842164  LUMO = 10.0958704412582
  mo_energy =
[-1.20316974e+02 -1.23748699e+01 -6.67532232e+00 -6.67532232e+00
 -6.67532232e+00 -1.16391289e+00 -2.37845435e-01 -2.37845435e-01
 -2.37845435e-01  1.00958704e+01  1.09970479e+02  6.04533521e+02
  2.74415951e+03  1.22233421e+04  4.08448764e+04  1.04888535e+05
  2.30071989e+05  4.55886935e+05  8.44839199e+05  1.52801647e+06
  2.85028387e+06  5.80817117e+06]
E1 = -706.6995267448352  E_coul = 198.7544946799452
cycle= 4 E= -507.94503206489  delta_E= -3.01e-08  |g|= 6.23e-06  |ddm|= 0.000461
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.43959e-06
diis-c [-4.70065832e-12 -1.76134620e-06  2.29745589e-03 -4.56574683e-02
  1.04336177e+00]
  HOMO = -0.237846177877892  LUMO = 10.0958696922775
  mo_energy =
[-1.20316972e+02 -1.23748723e+01 -6.67532388e+00 -6.67532388e+00
 -6.67532388e+00 -1.16391331e+00 -2.37846178e-01 -2.37846178e-01
 -2.37846178e-01  1.00958697e+01  1.09970479e+02  6.04533524e+02
  2.74415952e+03  1.22233421e+04  4.08448764e+04  1.04888535e+05
  2.30071989e+05  4.55886935e+05  8.44839199e+05  1.52801647e+06
  2.85028387e+06  5.80817117e+06]
E1 = -706.6995256544643  E_coul = 198.75449358957314
cycle= 5 E= -507.945032064891  delta_E= -1.14e-12  |g|= 1.41e-07  |ddm|= 2.15e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6995256544643  E_coul = 198.75449358957314
  HOMO = -0.237846211851662  LUMO = 10.0958696226737
  mo_energy =
[-1.20316973e+02 -1.23748725e+01 -6.67532405e+00 -6.67532405e+00
 -6.67532405e+00 -1.16391333e+00 -2.37846212e-01 -2.37846212e-01
 -2.37846212e-01  1.00958696e+01  1.09970479e+02  6.04533524e+02
  2.74415952e+03  1.22233421e+04  4.08448764e+04  1.04888535e+05
  2.30071989e+05  4.55886935e+05  8.44839199e+05  1.52801647e+06
  2.85028387e+06  5.80817117e+06]
E1 = -706.6995255614713  E_coul = 198.75449349658035
Extra cycle  E= -507.945032064891  delta_E= 2.27e-13  |g|= 7.31e-09  |ddm|= 7.23e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907705.3588398898
E1 = -706.6995255614713  E_coul = 198.75449349658035
init E= -507.945032064891
    CPU time for initialize scf      1.32 sec, wall time      0.08 sec
  HOMO = -0.237846213453393  LUMO = 10.0958696195888
  mo_energy =
[-1.20316973e+02 -1.23748725e+01 -6.67532406e+00 -6.67532406e+00
 -6.67532406e+00 -1.16391333e+00 -2.37846213e-01 -2.37846213e-01
 -2.37846213e-01  1.00958696e+01  1.09970479e+02  6.04533524e+02
  2.74415952e+03  1.22233421e+04  4.08448764e+04  1.04888535e+05
  2.30071989e+05  4.55886935e+05  8.44839199e+05  1.52801647e+06
  2.85028387e+06  5.80817117e+06]
E1 = -706.6995255572772  E_coul = 198.7544934923861
cycle= 1 E= -507.945032064891  delta_E= -1.14e-13  |g|= 3.33e-09  |ddm|= 3.56e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
E1 = -706.6995255572772  E_coul = 198.7544934923861
  HOMO = -0.237846213531471  LUMO = 10.0958696194462
  mo_energy =
[-1.20316973e+02 -1.23748725e+01 -6.67532406e+00 -6.67532406e+00
 -6.67532406e+00 -1.16391333e+00 -2.37846214e-01 -2.37846214e-01
 -2.37846214e-01  1.00958696e+01  1.09970479e+02  6.04533524e+02
  2.74415952e+03  1.22233421e+04  4.08448764e+04  1.04888535e+05
  2.30071989e+05  4.55886935e+05  8.44839199e+05  1.52801647e+06
  2.85028387e+06  5.80817117e+06]
E1 = -706.6995255570793  E_coul = 198.75449349218766
Extra cycle  E= -507.945032064892  delta_E= -5.68e-13  |g|= 1.25e-09  |ddm|= 1.82e-10
    CPU time for scf_cycle      1.51 sec, wall time      0.15 sec
exp = [1.17616814e+05 3.96620748e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547202e+04
 7.30348444e+03 1.83758105e+04 1.44976359e+03 3.73993518e+02
 1.13288096e+02 3.77592132e+01 8.09785053e+00 3.20707385e+00
 8.60384516e+00 4.92989598e-01]
grad_E = [ 4.17267729e-09 -1.23549719e-04  1.86439529e-11  1.12459245e-10
  6.49209907e-10  2.54588920e-09  1.05765060e-08  5.69078243e-08
  3.57896799e-06  1.22255384e-07  5.54576166e-06 -8.73686307e-06
 -1.75431161e-06  1.29996851e-05  3.70498623e-05  6.98624967e-06
 -1.51355346e-06 -5.33601569e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814252        1
[INPUT] 0    0    [1    /1   ]  0.39661683578        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031134        1
[INPUT] 0    0    [1    /1   ]  147020.992154        1
[INPUT] 0    0    [1    /1   ]  73510.4209974        1
[INPUT] 0    0    [1    /1   ]  36754.7201856        1
[INPUT] 0    0    [1    /1   ]  7303.48455351        1
[INPUT] 0    0    [1    /1   ]  18375.8105114        1
[INPUT] 0    0    [1    /1   ]  1449.7637907         1
[INPUT] 0    0    [1    /1   ]  373.992947935        1
[INPUT] 0    0    [1    /1   ]  113.288876189        1
[INPUT] 0    0    [1    /1   ]  37.7597360787        1
[INPUT] 0    0    [1    /1   ]  8.09627641794        1
[INPUT] 0    0    [1    /1   ]  3.20664554212        1
[INPUT] 1    0    [1    /1   ]  8.60383401367        1
[INPUT] 1    0    [1    /1   ]  0.492980026397       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81425241691, 1.0]], [0, [0.39661683577971374, 1.0]], [0, [1176168.1426189344, 1.0]], [0, [588084.0699928498, 1.0]], [0, [294042.03113353334, 1.0]], [0, [147020.9921542544, 1.0]], [0, [73510.42099745, 1.0]], [0, [36754.7201855684, 1.0]], [0, [7303.484553510754, 1.0]], [0, [18375.81051140526, 1.0]], [0, [1449.7637907012977, 1.0]], [0, [373.99294793451617, 1.0]], [0, [113.28887618884521, 1.0]], [0, [37.759736078745746, 1.0]], [0, [8.096276417941711, 1.0]], [0, [3.206645542118578, 1.0]], [1, [8.603834013672813, 1.0]], [1, [0.4929800263967101, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81425242]
bas 1, expnt(s) = [0.39661684]
bas 2, expnt(s) = [1176168.14261893]
bas 3, expnt(s) = [588084.06999285]
bas 4, expnt(s) = [294042.03113353]
bas 5, expnt(s) = [147020.99215425]
bas 6, expnt(s) = [73510.42099745]
bas 7, expnt(s) = [36754.72018557]
bas 8, expnt(s) = [7303.48455351]
bas 9, expnt(s) = [18375.81051141]
bas 10, expnt(s) = [1449.7637907]
bas 11, expnt(s) = [373.99294793]
bas 12, expnt(s) = [113.28887619]
bas 13, expnt(s) = [37.75973608]
bas 14, expnt(s) = [8.09627642]
bas 15, expnt(s) = [3.20664554]
bas 16, expnt(s) = [8.60383401]
bas 17, expnt(s) = [0.49298003]
CPU time:       196.54
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96616836e-01 1.26268024e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547202e+04 6.70656078e+03
 7.30348455e+03 1.99600953e+03 1.83758105e+04 3.98749271e+03
 1.44976379e+03 5.93591893e+02 3.73992948e+02 2.14863469e+02
 1.13288876e+02 8.77314840e+01 3.77597361e+01 3.84845787e+01
 8.09627642e+00 1.21263199e+01 3.20664554e+00 6.05415090e+00
 8.60383401e+00 4.29882159e+01 4.92980026e-01 1.20509434e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32513334306715
cond(S) = 907705.3150780068
E1 = -689.3964698083208  E_coul = 184.91051005962055
init E= -504.4859597487
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.67474872496085  LUMO = 9.19506353100523
  mo_energy =
[-1.21707325e+02 -1.33876000e+01 -7.62814974e+00 -7.62814974e+00
 -7.62814974e+00 -1.64021110e+00 -6.74748725e-01 -6.74748725e-01
 -6.74748725e-01  9.19506353e+00  1.08659942e+02  6.03156361e+02
  2.74286184e+03  1.22221649e+04  4.08437700e+04  1.04887468e+05
  2.30070946e+05  4.55885910e+05  8.44838187e+05  1.52801547e+06
  2.85028288e+06  5.80817018e+06]
E1 = -707.0679658444362  E_coul = 199.12932810146668
cycle= 1 E= -507.93863774297  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.602175
diis-c [-0.36261529  1.        ]
  HOMO = -0.233190767765559  LUMO = 10.1044733485499
  mo_energy =
[-1.20256661e+02 -1.23514362e+01 -6.64616307e+00 -6.64616307e+00
 -6.64616307e+00 -1.16155668e+00 -2.33190768e-01 -2.33190768e-01
 -2.33190768e-01  1.01044733e+01  1.10009004e+02  6.04592894e+02
  2.74423300e+03  1.22234247e+04  4.08449625e+04  1.04888623e+05
  2.30072078e+05  4.55887024e+05  8.44839288e+05  1.52801656e+06
  2.85028396e+06  5.80817126e+06]
E1 = -706.7142475538068  E_coul = 198.76922754293855
cycle= 2 E= -507.945020010868  delta_E= -0.00638  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152523
diis-c [-2.24040588e-04  4.84554387e-03  9.95154456e-01]
  HOMO = -0.237644041754576  LUMO = 10.0935555598195
  mo_energy =
[-1.20314438e+02 -1.23738133e+01 -6.67400846e+00 -6.67400846e+00
 -6.67400846e+00 -1.16381980e+00 -2.37644042e-01 -2.37644042e-01
 -2.37644042e-01  1.00935556e+01  1.09965561e+02  6.04531814e+02
  2.74415908e+03  1.22233425e+04  4.08448773e+04  1.04888537e+05
  2.30071990e+05  4.55886936e+05  8.44839200e+05  1.52801647e+06
  2.85028387e+06  5.80817117e+06]
E1 = -706.6996058867601  E_coul = 198.75457381695816
cycle= 3 E= -507.945032069802  delta_E= -1.21e-05  |g|= 0.000876  |ddm|= 0.00872
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739465
diis-c [-1.25832432e-08  3.75896524e-05 -5.00488742e-02  1.05001128e+00]
  HOMO = -0.237870118301235  LUMO = 10.0930135059242
  mo_energy =
[-1.20317035e+02 -1.23749217e+01 -6.67536383e+00 -6.67536383e+00
 -6.67536383e+00 -1.16393009e+00 -2.37870118e-01 -2.37870118e-01
 -2.37870118e-01  1.00930135e+01  1.09963540e+02  6.04529143e+02
  2.74415603e+03  1.22233393e+04  4.08448739e+04  1.04888533e+05
  2.30071987e+05  4.55886933e+05  8.44839197e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.6988701317293  E_coul = 198.7538380318393
cycle= 4 E= -507.94503209989  delta_E= -3.01e-08  |g|= 6.24e-06  |ddm|= 0.000461
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.4447e-06
diis-c [-4.70228909e-12 -1.76359532e-06  2.29878904e-03 -4.56831430e-02
  1.04338612e+00]
  HOMO = -0.237870863129448  LUMO = 10.0930127538331
  mo_energy =
[-1.20317033e+02 -1.23749242e+01 -6.67536539e+00 -6.67536539e+00
 -6.67536539e+00 -1.16393052e+00 -2.37870863e-01 -2.37870863e-01
 -2.37870863e-01  1.00930128e+01  1.09963540e+02  6.04529146e+02
  2.74415603e+03  1.22233393e+04  4.08448740e+04  1.04888533e+05
  2.30071987e+05  4.55886933e+05  8.44839197e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.6988690367076  E_coul = 198.7538369368163
cycle= 5 E= -507.945032099891  delta_E= -1.31e-12  |g|= 1.41e-07  |ddm|= 2.15e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6988690367076  E_coul = 198.7538369368163
  HOMO = -0.237870897114811  LUMO = 10.0930126842179
  mo_energy =
[-1.20317033e+02 -1.23749243e+01 -6.67536556e+00 -6.67536556e+00
 -6.67536556e+00 -1.16393054e+00 -2.37870897e-01 -2.37870897e-01
 -2.37870897e-01  1.00930127e+01  1.09963540e+02  6.04529146e+02
  2.74415603e+03  1.22233393e+04  4.08448740e+04  1.04888533e+05
  2.30071987e+05  4.55886933e+05  8.44839197e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.6988689436816  E_coul = 198.75383684379022
Extra cycle  E= -507.945032099891  delta_E= -1.14e-13  |g|= 7.35e-09  |ddm|= 7.23e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.10 sec
exp = [1.17616814e+05 3.96616836e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547202e+04
 7.30348455e+03 1.83758105e+04 1.44976379e+03 3.73992948e+02
 1.13288876e+02 3.77597361e+01 8.09627642e+00 3.20664554e+00
 8.60383401e+00 4.92980026e-01]
E = -507.9450320998914
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:34:58 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814252        1
[INPUT] 0    0    [1    /1   ]  0.39661683578        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031134        1
[INPUT] 0    0    [1    /1   ]  147020.992154        1
[INPUT] 0    0    [1    /1   ]  73510.4209974        1
[INPUT] 0    0    [1    /1   ]  36754.7201856        1
[INPUT] 0    0    [1    /1   ]  7303.48455351        1
[INPUT] 0    0    [1    /1   ]  18375.8105114        1
[INPUT] 0    0    [1    /1   ]  1449.7637907         1
[INPUT] 0    0    [1    /1   ]  373.992947935        1
[INPUT] 0    0    [1    /1   ]  113.288876189        1
[INPUT] 0    0    [1    /1   ]  37.7597360787        1
[INPUT] 0    0    [1    /1   ]  8.09627641794        1
[INPUT] 0    0    [1    /1   ]  3.20664554212        1
[INPUT] 1    0    [1    /1   ]  8.60383401367        1
[INPUT] 1    0    [1    /1   ]  0.492980026397       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81425241691, 1.0]], [0, [0.39661683577971374, 1.0]], [0, [1176168.1426189344, 1.0]], [0, [588084.0699928498, 1.0]], [0, [294042.03113353334, 1.0]], [0, [147020.9921542544, 1.0]], [0, [73510.42099745, 1.0]], [0, [36754.7201855684, 1.0]], [0, [7303.484553510754, 1.0]], [0, [18375.81051140526, 1.0]], [0, [1449.7637907012977, 1.0]], [0, [373.99294793451617, 1.0]], [0, [113.28887618884521, 1.0]], [0, [37.759736078745746, 1.0]], [0, [8.096276417941711, 1.0]], [0, [3.206645542118578, 1.0]], [1, [8.603834013672813, 1.0]], [1, [0.4929800263967101, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81425242]
bas 1, expnt(s) = [0.39661684]
bas 2, expnt(s) = [1176168.14261893]
bas 3, expnt(s) = [588084.06999285]
bas 4, expnt(s) = [294042.03113353]
bas 5, expnt(s) = [147020.99215425]
bas 6, expnt(s) = [73510.42099745]
bas 7, expnt(s) = [36754.72018557]
bas 8, expnt(s) = [7303.48455351]
bas 9, expnt(s) = [18375.81051141]
bas 10, expnt(s) = [1449.7637907]
bas 11, expnt(s) = [373.99294793]
bas 12, expnt(s) = [113.28887619]
bas 13, expnt(s) = [37.75973608]
bas 14, expnt(s) = [8.09627642]
bas 15, expnt(s) = [3.20664554]
bas 16, expnt(s) = [8.60383401]
bas 17, expnt(s) = [0.49298003]
CPU time:       197.07
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96616836e-01 1.26268024e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547202e+04 6.70656078e+03
 7.30348455e+03 1.99600953e+03 1.83758105e+04 3.98749271e+03
 1.44976379e+03 5.93591893e+02 3.73992948e+02 2.14863469e+02
 1.13288876e+02 8.77314840e+01 3.77597361e+01 3.84845787e+01
 8.09627642e+00 1.21263199e+01 3.20664554e+00 6.05415090e+00
 8.60383401e+00 4.29882159e+01 4.92980026e-01 1.20509434e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32513334306715
cond(S) = 907705.3150780068
E1 = -689.3964698083208  E_coul = 184.91051005962055
init E= -504.4859597487
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.67474872496085  LUMO = 9.19506353100523
  mo_energy =
[-1.21707325e+02 -1.33876000e+01 -7.62814974e+00 -7.62814974e+00
 -7.62814974e+00 -1.64021110e+00 -6.74748725e-01 -6.74748725e-01
 -6.74748725e-01  9.19506353e+00  1.08659942e+02  6.03156361e+02
  2.74286184e+03  1.22221649e+04  4.08437700e+04  1.04887468e+05
  2.30070946e+05  4.55885910e+05  8.44838187e+05  1.52801547e+06
  2.85028288e+06  5.80817018e+06]
E1 = -707.0679658444362  E_coul = 199.12932810146668
cycle= 1 E= -507.93863774297  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.602175
diis-c [-0.36261529  1.        ]
  HOMO = -0.233190767765559  LUMO = 10.1044733485499
  mo_energy =
[-1.20256661e+02 -1.23514362e+01 -6.64616307e+00 -6.64616307e+00
 -6.64616307e+00 -1.16155668e+00 -2.33190768e-01 -2.33190768e-01
 -2.33190768e-01  1.01044733e+01  1.10009004e+02  6.04592894e+02
  2.74423300e+03  1.22234247e+04  4.08449625e+04  1.04888623e+05
  2.30072078e+05  4.55887024e+05  8.44839288e+05  1.52801656e+06
  2.85028396e+06  5.80817126e+06]
E1 = -706.7142475538068  E_coul = 198.76922754293855
cycle= 2 E= -507.945020010868  delta_E= -0.00638  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152523
diis-c [-2.24040588e-04  4.84554387e-03  9.95154456e-01]
  HOMO = -0.237644041754576  LUMO = 10.0935555598195
  mo_energy =
[-1.20314438e+02 -1.23738133e+01 -6.67400846e+00 -6.67400846e+00
 -6.67400846e+00 -1.16381980e+00 -2.37644042e-01 -2.37644042e-01
 -2.37644042e-01  1.00935556e+01  1.09965561e+02  6.04531814e+02
  2.74415908e+03  1.22233425e+04  4.08448773e+04  1.04888537e+05
  2.30071990e+05  4.55886936e+05  8.44839200e+05  1.52801647e+06
  2.85028387e+06  5.80817117e+06]
E1 = -706.6996058867601  E_coul = 198.75457381695816
cycle= 3 E= -507.945032069802  delta_E= -1.21e-05  |g|= 0.000876  |ddm|= 0.00872
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739465
diis-c [-1.25832432e-08  3.75896524e-05 -5.00488742e-02  1.05001128e+00]
  HOMO = -0.237870118301235  LUMO = 10.0930135059242
  mo_energy =
[-1.20317035e+02 -1.23749217e+01 -6.67536383e+00 -6.67536383e+00
 -6.67536383e+00 -1.16393009e+00 -2.37870118e-01 -2.37870118e-01
 -2.37870118e-01  1.00930135e+01  1.09963540e+02  6.04529143e+02
  2.74415603e+03  1.22233393e+04  4.08448739e+04  1.04888533e+05
  2.30071987e+05  4.55886933e+05  8.44839197e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.6988701317293  E_coul = 198.7538380318393
cycle= 4 E= -507.94503209989  delta_E= -3.01e-08  |g|= 6.24e-06  |ddm|= 0.000461
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.4447e-06
diis-c [-4.70228909e-12 -1.76359532e-06  2.29878904e-03 -4.56831430e-02
  1.04338612e+00]
  HOMO = -0.237870863129448  LUMO = 10.0930127538331
  mo_energy =
[-1.20317033e+02 -1.23749242e+01 -6.67536539e+00 -6.67536539e+00
 -6.67536539e+00 -1.16393052e+00 -2.37870863e-01 -2.37870863e-01
 -2.37870863e-01  1.00930128e+01  1.09963540e+02  6.04529146e+02
  2.74415603e+03  1.22233393e+04  4.08448740e+04  1.04888533e+05
  2.30071987e+05  4.55886933e+05  8.44839197e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.6988690367076  E_coul = 198.7538369368163
cycle= 5 E= -507.945032099891  delta_E= -1.31e-12  |g|= 1.41e-07  |ddm|= 2.15e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6988690367076  E_coul = 198.7538369368163
  HOMO = -0.237870897114811  LUMO = 10.0930126842179
  mo_energy =
[-1.20317033e+02 -1.23749243e+01 -6.67536556e+00 -6.67536556e+00
 -6.67536556e+00 -1.16393054e+00 -2.37870897e-01 -2.37870897e-01
 -2.37870897e-01  1.00930127e+01  1.09963540e+02  6.04529146e+02
  2.74415603e+03  1.22233393e+04  4.08448740e+04  1.04888533e+05
  2.30071987e+05  4.55886933e+05  8.44839197e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.6988689436816  E_coul = 198.75383684379022
Extra cycle  E= -507.945032099891  delta_E= -1.14e-13  |g|= 7.35e-09  |ddm|= 7.23e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907705.3150780068
E1 = -706.6988689436816  E_coul = 198.75383684379022
init E= -507.945032099891
    CPU time for initialize scf      4.24 sec, wall time      0.28 sec
  HOMO = -0.237870898717174  LUMO = 10.0930126811313
  mo_energy =
[-1.20317033e+02 -1.23749243e+01 -6.67536557e+00 -6.67536557e+00
 -6.67536557e+00 -1.16393054e+00 -2.37870899e-01 -2.37870899e-01
 -2.37870899e-01  1.00930127e+01  1.09963540e+02  6.04529146e+02
  2.74415603e+03  1.22233393e+04  4.08448740e+04  1.04888533e+05
  2.30071987e+05  4.55886933e+05  8.44839197e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.6988689394825  E_coul = 198.75383683959106
cycle= 1 E= -507.945032099891  delta_E= -5.68e-14  |g|= 2.35e-09  |ddm|= 3.57e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
E1 = -706.6988689394825  E_coul = 198.75383683959106
  HOMO = -0.23787089879539  LUMO = 10.0930126809905
  mo_energy =
[-1.20317033e+02 -1.23749243e+01 -6.67536557e+00 -6.67536557e+00
 -6.67536557e+00 -1.16393054e+00 -2.37870899e-01 -2.37870899e-01
 -2.37870899e-01  1.00930127e+01  1.09963540e+02  6.04529146e+02
  2.74415603e+03  1.22233393e+04  4.08448740e+04  1.04888533e+05
  2.30071987e+05  4.55886933e+05  8.44839197e+05  1.52801647e+06
  2.85028387e+06  5.80817116e+06]
E1 = -706.6988689392762  E_coul = 198.75383683938455
Extra cycle  E= -507.945032099892  delta_E= -1.14e-13  |g|= 1.82e-09  |ddm|= 1.89e-10
    CPU time for scf_cycle      4.44 sec, wall time      0.35 sec
exp = [1.17616814e+05 3.96616836e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547202e+04
 7.30348455e+03 1.83758105e+04 1.44976379e+03 3.73992948e+02
 1.13288876e+02 3.77597361e+01 8.09627642e+00 3.20664554e+00
 8.60383401e+00 4.92980026e-01]
grad_E = [ 4.17258904e-09 -2.06867451e-04  1.86428876e-11  1.12456390e-10
  6.49196206e-10  2.54583469e-09  1.05762765e-08  5.69066874e-08
  3.57888817e-06  1.22252006e-07  5.54918125e-06 -8.73558611e-06
 -2.22170155e-06  1.55453700e-05  3.00573868e-05  2.84568150e-06
 -2.51792071e-06 -8.93656731e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:35:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814252        1
[INPUT] 0    0    [1    /1   ]  0.396612523551       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031133        1
[INPUT] 0    0    [1    /1   ]  147020.992154        1
[INPUT] 0    0    [1    /1   ]  73510.420996         1
[INPUT] 0    0    [1    /1   ]  36754.720178         1
[INPUT] 0    0    [1    /1   ]  7303.48407573        1
[INPUT] 0    0    [1    /1   ]  18375.8104951        1
[INPUT] 0    0    [1    /1   ]  1449.76301593        1
[INPUT] 0    0    [1    /1   ]  373.994480076        1
[INPUT] 0    0    [1    /1   ]  113.287786354        1
[INPUT] 0    0    [1    /1   ]  37.759191608         1
[INPUT] 0    0    [1    /1   ]  8.09350201313        1
[INPUT] 0    0    [1    /1   ]  3.20586107599        1
[INPUT] 1    0    [1    /1   ]  8.60382175696        1
[INPUT] 1    0    [1    /1   ]  0.49296866284        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81425185983, 1.0]], [0, [0.39661252355115556, 1.0]], [0, [1176168.1426189318, 1.0]], [0, [588084.0699928348, 1.0]], [0, [294042.03113344667, 1.0]], [0, [147020.99215391453, 1.0]], [0, [73510.42099603801, 1.0]], [0, [36754.72017797023, 1.0]], [0, [7303.484075726367, 1.0]], [0, [18375.810495090212, 1.0]], [0, [1449.7630159288803, 1.0]], [0, [373.99448007637307, 1.0]], [0, [113.28778635414366, 1.0]], [0, [37.75919160799064, 1.0]], [0, [8.093502013132387, 1.0]], [0, [3.2058610759914954, 1.0]], [1, [8.603821756957638, 1.0]], [1, [0.492968662840452, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81425186]
bas 1, expnt(s) = [0.39661252]
bas 2, expnt(s) = [1176168.14261893]
bas 3, expnt(s) = [588084.06999283]
bas 4, expnt(s) = [294042.03113345]
bas 5, expnt(s) = [147020.99215391]
bas 6, expnt(s) = [73510.42099604]
bas 7, expnt(s) = [36754.72017797]
bas 8, expnt(s) = [7303.48407573]
bas 9, expnt(s) = [18375.81049509]
bas 10, expnt(s) = [1449.76301593]
bas 11, expnt(s) = [373.99448008]
bas 12, expnt(s) = [113.28778635]
bas 13, expnt(s) = [37.75919161]
bas 14, expnt(s) = [8.09350201]
bas 15, expnt(s) = [3.20586108]
bas 16, expnt(s) = [8.60382176]
bas 17, expnt(s) = [0.49296866]
CPU time:       204.76
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96612524e-01 1.26266994e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547202e+04 6.70656078e+03
 7.30348408e+03 1.99600943e+03 1.83758105e+04 3.98749271e+03
 1.44976302e+03 5.93591655e+02 3.73994480e+02 2.14864130e+02
 1.13287786e+02 8.77308510e+01 3.77591916e+01 3.84841625e+01
 8.09350201e+00 1.21232032e+01 3.20586108e+00 6.05304006e+00
 8.60382176e+00 4.29881394e+01 4.92968663e-01 1.20505962e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325149565703676
cond(S) = 907705.1238004807
E1 = -689.3959706313225  E_coul = 184.91008560745024
init E= -504.485885023872
    CPU time for initialize scf      3.02 sec, wall time      0.22 sec
  HOMO = -0.674762996157015  LUMO = 9.19007528612857
  mo_energy =
[-1.21707365e+02 -1.33876392e+01 -7.62817540e+00 -7.62817540e+00
 -7.62817540e+00 -1.64021971e+00 -6.74762996e-01 -6.74762996e-01
 -6.74762996e-01  9.19007529e+00  1.08643826e+02  6.03138932e+02
  2.74284745e+03  1.22221518e+04  4.08437568e+04  1.04887454e+05
  2.30070933e+05  4.55885897e+05  8.44838174e+05  1.52801546e+06
  2.85028287e+06  5.80817017e+06]
E1 = -707.0673222288897  E_coul = 199.1286874867472
cycle= 1 E= -507.938634742142  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.602174
diis-c [-0.36261313  1.        ]
  HOMO = -0.233217646702546  LUMO = 10.0993451100939
  mo_energy =
[-1.20256718e+02 -1.23514881e+01 -6.64620053e+00 -6.64620053e+00
 -6.64620053e+00 -1.16157491e+00 -2.33217647e-01 -2.33217647e-01
 -2.33217647e-01  1.00993451e+01  1.09992867e+02  6.04575448e+02
  2.74421860e+03  1.22234115e+04  4.08449492e+04  1.04888610e+05
  2.30072064e+05  4.55887010e+05  8.44839275e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7134532324516  E_coul = 198.76843315675387
cycle= 2 E= -507.945020075698  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152535
diis-c [-2.24073114e-04  4.84651078e-03  9.95153489e-01]
  HOMO = -0.237673670158865  LUMO = 10.0884252236044
  mo_energy =
[-1.20314513e+02 -1.23738767e+01 -6.67405848e+00 -6.67405848e+00
 -6.67405848e+00 -1.16383972e+00 -2.37673670e-01 -2.37673670e-01
 -2.37673670e-01  1.00884252e+01  1.09949410e+02  6.04514351e+02
  2.74414466e+03  1.22233294e+04  4.08448640e+04  1.04888523e+05
  2.30071977e+05  4.55886923e+05  8.44839187e+05  1.52801646e+06
  2.85028386e+06  5.80817116e+06]
E1 = -706.6988012451241  E_coul = 198.7537690972748
cycle= 3 E= -507.945032147849  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00872
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739631
diis-c [-1.26174081e-08  3.76291416e-05 -5.00549713e-02  1.05001734e+00]
  HOMO = -0.237899957811702  LUMO = 10.0878828993855
  mo_energy =
[-1.20317111e+02 -1.23749860e+01 -6.67541484e+00 -6.67541484e+00
 -6.67541484e+00 -1.16395012e+00 -2.37899958e-01 -2.37899958e-01
 -2.37899958e-01  1.00878829e+01  1.09947388e+02  6.04511679e+02
  2.74414161e+03  1.22233261e+04  4.08448607e+04  1.04888520e+05
  2.30071974e+05  4.55886920e+05  8.44839184e+05  1.52801645e+06
  2.85028386e+06  5.80817115e+06]
E1 = -706.6980647513305  E_coul = 198.75303257333965
cycle= 4 E= -507.945032177991  delta_E= -3.01e-08  |g|= 6.25e-06  |ddm|= 0.000462
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.45382e-06
diis-c [-4.70906992e-12 -1.76472815e-06  2.30097478e-03 -4.57255209e-02
  1.04342631e+00]
  HOMO = -0.237900705894301  LUMO = 10.0878821416414
  mo_energy =
[-1.20317109e+02 -1.23749884e+01 -6.67541641e+00 -6.67541641e+00
 -6.67541641e+00 -1.16395055e+00 -2.37900706e-01 -2.37900706e-01
 -2.37900706e-01  1.00878821e+01  1.09947388e+02  6.04511681e+02
  2.74414161e+03  1.22233261e+04  4.08448607e+04  1.04888520e+05
  2.30071974e+05  4.55886920e+05  8.44839184e+05  1.52801645e+06
  2.85028386e+06  5.80817115e+06]
E1 = -706.698063647914  E_coul = 198.75303146992186
cycle= 5 E= -507.945032177992  delta_E= -1.14e-12  |g|= 1.41e-07  |ddm|= 2.16e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.698063647914  E_coul = 198.75303146992186
  HOMO = -0.237900739910593  LUMO = 10.0878820719856
  mo_energy =
[-1.20317109e+02 -1.23749886e+01 -6.67541658e+00 -6.67541658e+00
 -6.67541658e+00 -1.16395057e+00 -2.37900740e-01 -2.37900740e-01
 -2.37900740e-01  1.00878821e+01  1.09947388e+02  6.04511681e+02
  2.74414161e+03  1.22233261e+04  4.08448607e+04  1.04888520e+05
  2.30071974e+05  4.55886920e+05  8.44839184e+05  1.52801645e+06
  2.85028386e+06  5.80817115e+06]
E1 = -706.698063554792  E_coul = 198.7530313768002
Extra cycle  E= -507.945032177992  delta_E= 2.27e-13  |g|= 7.46e-09  |ddm|= 7.24e-08
    CPU time for scf_cycle      3.29 sec, wall time      0.29 sec
exp = [1.17616814e+05 3.96612524e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547202e+04
 7.30348408e+03 1.83758105e+04 1.44976302e+03 3.73994480e+02
 1.13287786e+02 3.77591916e+01 8.09350201e+00 3.20586108e+00
 8.60382176e+00 4.92968663e-01]
E = -507.94503217799183
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:35:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814252        1
[INPUT] 0    0    [1    /1   ]  0.396612523551       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031133        1
[INPUT] 0    0    [1    /1   ]  147020.992154        1
[INPUT] 0    0    [1    /1   ]  73510.420996         1
[INPUT] 0    0    [1    /1   ]  36754.720178         1
[INPUT] 0    0    [1    /1   ]  7303.48407573        1
[INPUT] 0    0    [1    /1   ]  18375.8104951        1
[INPUT] 0    0    [1    /1   ]  1449.76301593        1
[INPUT] 0    0    [1    /1   ]  373.994480076        1
[INPUT] 0    0    [1    /1   ]  113.287786354        1
[INPUT] 0    0    [1    /1   ]  37.759191608         1
[INPUT] 0    0    [1    /1   ]  8.09350201313        1
[INPUT] 0    0    [1    /1   ]  3.20586107599        1
[INPUT] 1    0    [1    /1   ]  8.60382175696        1
[INPUT] 1    0    [1    /1   ]  0.49296866284        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81425185983, 1.0]], [0, [0.39661252355115556, 1.0]], [0, [1176168.1426189318, 1.0]], [0, [588084.0699928348, 1.0]], [0, [294042.03113344667, 1.0]], [0, [147020.99215391453, 1.0]], [0, [73510.42099603801, 1.0]], [0, [36754.72017797023, 1.0]], [0, [7303.484075726367, 1.0]], [0, [18375.810495090212, 1.0]], [0, [1449.7630159288803, 1.0]], [0, [373.99448007637307, 1.0]], [0, [113.28778635414366, 1.0]], [0, [37.75919160799064, 1.0]], [0, [8.093502013132387, 1.0]], [0, [3.2058610759914954, 1.0]], [1, [8.603821756957638, 1.0]], [1, [0.492968662840452, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81425186]
bas 1, expnt(s) = [0.39661252]
bas 2, expnt(s) = [1176168.14261893]
bas 3, expnt(s) = [588084.06999283]
bas 4, expnt(s) = [294042.03113345]
bas 5, expnt(s) = [147020.99215391]
bas 6, expnt(s) = [73510.42099604]
bas 7, expnt(s) = [36754.72017797]
bas 8, expnt(s) = [7303.48407573]
bas 9, expnt(s) = [18375.81049509]
bas 10, expnt(s) = [1449.76301593]
bas 11, expnt(s) = [373.99448008]
bas 12, expnt(s) = [113.28778635]
bas 13, expnt(s) = [37.75919161]
bas 14, expnt(s) = [8.09350201]
bas 15, expnt(s) = [3.20586108]
bas 16, expnt(s) = [8.60382176]
bas 17, expnt(s) = [0.49296866]
CPU time:       208.14
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96612524e-01 1.26266994e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547202e+04 6.70656078e+03
 7.30348408e+03 1.99600943e+03 1.83758105e+04 3.98749271e+03
 1.44976302e+03 5.93591655e+02 3.73994480e+02 2.14864130e+02
 1.13287786e+02 8.77308510e+01 3.77591916e+01 3.84841625e+01
 8.09350201e+00 1.21232032e+01 3.20586108e+00 6.05304006e+00
 8.60382176e+00 4.29881394e+01 4.92968663e-01 1.20505962e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325149565703676
cond(S) = 907705.1238004807
E1 = -689.3959706313225  E_coul = 184.91008560745024
init E= -504.485885023872
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674762996157015  LUMO = 9.19007528612857
  mo_energy =
[-1.21707365e+02 -1.33876392e+01 -7.62817540e+00 -7.62817540e+00
 -7.62817540e+00 -1.64021971e+00 -6.74762996e-01 -6.74762996e-01
 -6.74762996e-01  9.19007529e+00  1.08643826e+02  6.03138932e+02
  2.74284745e+03  1.22221518e+04  4.08437568e+04  1.04887454e+05
  2.30070933e+05  4.55885897e+05  8.44838174e+05  1.52801546e+06
  2.85028287e+06  5.80817017e+06]
E1 = -707.0673222288897  E_coul = 199.1286874867472
cycle= 1 E= -507.938634742142  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.602174
diis-c [-0.36261313  1.        ]
  HOMO = -0.233217646702546  LUMO = 10.0993451100939
  mo_energy =
[-1.20256718e+02 -1.23514881e+01 -6.64620053e+00 -6.64620053e+00
 -6.64620053e+00 -1.16157491e+00 -2.33217647e-01 -2.33217647e-01
 -2.33217647e-01  1.00993451e+01  1.09992867e+02  6.04575448e+02
  2.74421860e+03  1.22234115e+04  4.08449492e+04  1.04888610e+05
  2.30072064e+05  4.55887010e+05  8.44839275e+05  1.52801655e+06
  2.85028395e+06  5.80817124e+06]
E1 = -706.7134532324516  E_coul = 198.76843315675387
cycle= 2 E= -507.945020075698  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152535
diis-c [-2.24073114e-04  4.84651078e-03  9.95153489e-01]
  HOMO = -0.237673670158865  LUMO = 10.0884252236044
  mo_energy =
[-1.20314513e+02 -1.23738767e+01 -6.67405848e+00 -6.67405848e+00
 -6.67405848e+00 -1.16383972e+00 -2.37673670e-01 -2.37673670e-01
 -2.37673670e-01  1.00884252e+01  1.09949410e+02  6.04514351e+02
  2.74414466e+03  1.22233294e+04  4.08448640e+04  1.04888523e+05
  2.30071977e+05  4.55886923e+05  8.44839187e+05  1.52801646e+06
  2.85028386e+06  5.80817116e+06]
E1 = -706.6988012451241  E_coul = 198.7537690972748
cycle= 3 E= -507.945032147849  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00872
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739631
diis-c [-1.26174081e-08  3.76291416e-05 -5.00549713e-02  1.05001734e+00]
  HOMO = -0.237899957811702  LUMO = 10.0878828993855
  mo_energy =
[-1.20317111e+02 -1.23749860e+01 -6.67541484e+00 -6.67541484e+00
 -6.67541484e+00 -1.16395012e+00 -2.37899958e-01 -2.37899958e-01
 -2.37899958e-01  1.00878829e+01  1.09947388e+02  6.04511679e+02
  2.74414161e+03  1.22233261e+04  4.08448607e+04  1.04888520e+05
  2.30071974e+05  4.55886920e+05  8.44839184e+05  1.52801645e+06
  2.85028386e+06  5.80817115e+06]
E1 = -706.6980647513305  E_coul = 198.75303257333965
cycle= 4 E= -507.945032177991  delta_E= -3.01e-08  |g|= 6.25e-06  |ddm|= 0.000462
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.45382e-06
diis-c [-4.70906992e-12 -1.76472815e-06  2.30097478e-03 -4.57255209e-02
  1.04342631e+00]
  HOMO = -0.237900705894301  LUMO = 10.0878821416414
  mo_energy =
[-1.20317109e+02 -1.23749884e+01 -6.67541641e+00 -6.67541641e+00
 -6.67541641e+00 -1.16395055e+00 -2.37900706e-01 -2.37900706e-01
 -2.37900706e-01  1.00878821e+01  1.09947388e+02  6.04511681e+02
  2.74414161e+03  1.22233261e+04  4.08448607e+04  1.04888520e+05
  2.30071974e+05  4.55886920e+05  8.44839184e+05  1.52801645e+06
  2.85028386e+06  5.80817115e+06]
E1 = -706.698063647914  E_coul = 198.75303146992186
cycle= 5 E= -507.945032177992  delta_E= -1.14e-12  |g|= 1.41e-07  |ddm|= 2.16e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.698063647914  E_coul = 198.75303146992186
  HOMO = -0.237900739910593  LUMO = 10.0878820719856
  mo_energy =
[-1.20317109e+02 -1.23749886e+01 -6.67541658e+00 -6.67541658e+00
 -6.67541658e+00 -1.16395057e+00 -2.37900740e-01 -2.37900740e-01
 -2.37900740e-01  1.00878821e+01  1.09947388e+02  6.04511681e+02
  2.74414161e+03  1.22233261e+04  4.08448607e+04  1.04888520e+05
  2.30071974e+05  4.55886920e+05  8.44839184e+05  1.52801645e+06
  2.85028386e+06  5.80817115e+06]
E1 = -706.698063554792  E_coul = 198.7530313768002
Extra cycle  E= -507.945032177992  delta_E= 2.27e-13  |g|= 7.46e-09  |ddm|= 7.24e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907705.1238004807
E1 = -706.698063554792  E_coul = 198.7530313768002
init E= -507.945032177992
    CPU time for initialize scf      1.39 sec, wall time      0.09 sec
  HOMO = -0.237900741514721  LUMO = 10.0878820688963
  mo_energy =
[-1.20317109e+02 -1.23749886e+01 -6.67541659e+00 -6.67541659e+00
 -6.67541659e+00 -1.16395057e+00 -2.37900742e-01 -2.37900742e-01
 -2.37900742e-01  1.00878821e+01  1.09947388e+02  6.04511681e+02
  2.74414161e+03  1.22233261e+04  4.08448607e+04  1.04888520e+05
  2.30071974e+05  4.55886920e+05  8.44839184e+05  1.52801645e+06
  2.85028386e+06  5.80817115e+06]
E1 = -706.6980635505608  E_coul = 198.75303137256878
cycle= 1 E= -507.945032177992  delta_E= -2.27e-13  |g|= 2.83e-09  |ddm|= 3.6e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.6980635505608  E_coul = 198.75303137256878
  HOMO = -0.237900741593625  LUMO = 10.0878820687533
  mo_energy =
[-1.20317109e+02 -1.23749886e+01 -6.67541659e+00 -6.67541659e+00
 -6.67541659e+00 -1.16395057e+00 -2.37900742e-01 -2.37900742e-01
 -2.37900742e-01  1.00878821e+01  1.09947388e+02  6.04511681e+02
  2.74414161e+03  1.22233261e+04  4.08448607e+04  1.04888520e+05
  2.30071974e+05  4.55886920e+05  8.44839184e+05  1.52801645e+06
  2.85028386e+06  5.80817115e+06]
E1 = -706.6980635503719  E_coul = 198.75303137237995
Extra cycle  E= -507.945032177992  delta_E= 1.14e-13  |g|= 1.57e-09  |ddm|= 1.74e-10
    CPU time for scf_cycle      1.57 sec, wall time      0.16 sec
exp = [1.17616814e+05 3.96612524e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547202e+04
 7.30348408e+03 1.83758105e+04 1.44976302e+03 3.73994480e+02
 1.13287786e+02 3.77591916e+01 8.09350201e+00 3.20586108e+00
 8.60382176e+00 4.92968663e-01]
grad_E = [ 4.17310379e-09 -3.07007246e-04  1.86489760e-11  1.12473126e-10
  6.49275812e-10  2.54615290e-09  1.05776183e-08  5.69132845e-08
  3.57934768e-06  1.22272229e-07  5.52602178e-06 -8.47852926e-06
 -3.22184049e-06  1.77145013e-05  1.80050431e-05 -3.08548283e-06
 -3.72252098e-06 -1.32659219e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:35:04 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.81425         1
[INPUT] 0    0    [1    /1   ]  0.396611162271       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031133        1
[INPUT] 0    0    [1    /1   ]  147020.992153        1
[INPUT] 0    0    [1    /1   ]  73510.4209905        1
[INPUT] 0    0    [1    /1   ]  36754.720148         1
[INPUT] 0    0    [1    /1   ]  7303.48219414        1
[INPUT] 0    0    [1    /1   ]  18375.8104309        1
[INPUT] 0    0    [1    /1   ]  1449.75989633        1
[INPUT] 0    0    [1    /1   ]  374.001178319        1
[INPUT] 0    0    [1    /1   ]  113.281830915        1
[INPUT] 0    0    [1    /1   ]  37.7557979757        1
[INPUT] 0    0    [1    /1   ]  8.08965619108        1
[INPUT] 0    0    [1    /1   ]  3.20471992849        1
[INPUT] 1    0    [1    /1   ]  8.60381798917        1
[INPUT] 1    0    [1    /1   ]  0.492962754392       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81424966588, 1.0]], [0, [0.3966111622713437, 1.0]], [0, [1176168.142618922, 1.0]], [0, [588084.0699927757, 1.0]], [0, [294042.03113310534, 1.0]], [0, [147020.99215257596, 1.0]], [0, [73510.4209904773, 1.0]], [0, [36754.72014804533, 1.0]], [0, [7303.482194141551, 1.0]], [0, [18375.81043085109, 1.0]], [0, [1449.7598963285825, 1.0]], [0, [374.00117831883233, 1.0]], [0, [113.28183091473647, 1.0]], [0, [37.755797975651475, 1.0]], [0, [8.08965619107787, 1.0]], [0, [3.2047199284854937, 1.0]], [1, [8.603817989172835, 1.0]], [1, [0.49296275439236004, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81424967]
bas 1, expnt(s) = [0.39661116]
bas 2, expnt(s) = [1176168.14261892]
bas 3, expnt(s) = [588084.06999278]
bas 4, expnt(s) = [294042.03113311]
bas 5, expnt(s) = [147020.99215258]
bas 6, expnt(s) = [73510.42099048]
bas 7, expnt(s) = [36754.72014805]
bas 8, expnt(s) = [7303.48219414]
bas 9, expnt(s) = [18375.81043085]
bas 10, expnt(s) = [1449.75989633]
bas 11, expnt(s) = [374.00117832]
bas 12, expnt(s) = [113.28183091]
bas 13, expnt(s) = [37.75579798]
bas 14, expnt(s) = [8.08965619]
bas 15, expnt(s) = [3.20471993]
bas 16, expnt(s) = [8.60381799]
bas 17, expnt(s) = [0.49296275]
CPU time:       212.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96611162e-01 1.26266669e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547201e+04 6.70656077e+03
 7.30348219e+03 1.99600905e+03 1.83758104e+04 3.98749270e+03
 1.44975990e+03 5.93590697e+02 3.74001178e+02 2.14867016e+02
 1.13281831e+02 8.77273921e+01 3.77557980e+01 3.84815684e+01
 8.08965619e+00 1.21188824e+01 3.20471993e+00 6.05142402e+00
 8.60381799e+00 4.29881159e+01 4.92962754e-01 1.20504156e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325158553015296
cond(S) = 907704.6525891133
E1 = -689.3957318343569  E_coul = 184.9099087347653
init E= -504.485823099592
    CPU time for initialize scf      4.59 sec, wall time      0.32 sec
  HOMO = -0.674769684826408  LUMO = 9.18298245025805
  mo_energy =
[-1.21707378e+02 -1.33876595e+01 -7.62818516e+00 -7.62818516e+00
 -7.62818516e+00 -1.64022273e+00 -6.74769685e-01 -6.74769685e-01
 -6.74769685e-01  9.18298245e+00  1.08614414e+02  6.03097196e+02
  2.74281259e+03  1.22221191e+04  4.08437222e+04  1.04887418e+05
  2.30070897e+05  4.55885860e+05  8.44838139e+05  1.52801542e+06
  2.85028283e+06  5.80817014e+06]
E1 = -707.0670668254166  E_coul = 199.12843638547955
cycle= 1 E= -507.938630439937  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602169
diis-c [-0.362608  1.      ]
  HOMO = -0.233230242185418  LUMO = 10.0920638299087
  mo_energy =
[-1.20256741e+02 -1.23515111e+01 -6.64621231e+00 -6.64621231e+00
 -6.64621231e+00 -1.16158169e+00 -2.33230242e-01 -2.33230242e-01
 -2.33230242e-01  1.00920638e+01  1.09963433e+02  6.04533704e+02
  2.74418373e+03  1.22233788e+04  4.08449146e+04  1.04888574e+05
  2.30072028e+05  4.55886974e+05  8.44839239e+05  1.52801651e+06
  2.85028391e+06  5.80817121e+06]
E1 = -706.7129814087459  E_coul = 198.7679612181319
cycle= 2 E= -507.945020190614  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152554
diis-c [-2.24128438e-04  4.84757847e-03  9.95152422e-01]
  HOMO = -0.237690308703865  LUMO = 10.0811409947826
  mo_energy =
[-1.20314560e+02 -1.23739159e+01 -6.67408823e+00 -6.67408823e+00
 -6.67408823e+00 -1.16384891e+00 -2.37690309e-01 -2.37690309e-01
 -2.37690309e-01  1.00811410e+01  1.09919956e+02  6.04472581e+02
  2.74410976e+03  1.22232966e+04  4.08448294e+04  1.04888487e+05
  2.30071941e+05  4.55886887e+05  8.44839151e+05  1.52801642e+06
  2.85028383e+06  5.80817112e+06]
E1 = -706.6983145877763  E_coul = 198.7532823059918
cycle= 3 E= -507.945032281785  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739877
diis-c [-1.26670043e-08  3.76878895e-05 -5.00633422e-02  1.05002565e+00]
  HOMO = -0.237916902758462  LUMO = 10.0805982885094
  mo_energy =
[-1.20317161e+02 -1.23750265e+01 -6.67544599e+00 -6.67544599e+00
 -6.67544599e+00 -1.16395948e+00 -2.37916903e-01 -2.37916903e-01
 -2.37916903e-01  1.00805983e+01  1.09917932e+02  6.04469906e+02
  2.74410670e+03  1.22232933e+04  4.08448260e+04  1.04888484e+05
  2.30071937e+05  4.55886883e+05  8.44839148e+05  1.52801642e+06
  2.85028382e+06  5.80817112e+06]
E1 = -706.697577036929  E_coul = 198.75254472492682
cycle= 4 E= -507.945032312002  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46742e-06
diis-c [-4.72071337e-12 -1.76651735e-06  2.30424172e-03 -4.57895584e-02
  1.04348708e+00]
  HOMO = -0.237917655545354  LUMO = 10.080597522583
  mo_energy =
[-1.20317159e+02 -1.23750289e+01 -6.67544758e+00 -6.67544758e+00
 -6.67544758e+00 -1.16395992e+00 -2.37917656e-01 -2.37917656e-01
 -2.37917656e-01  1.00805975e+01  1.09917933e+02  6.04469909e+02
  2.74410671e+03  1.22232933e+04  4.08448260e+04  1.04888484e+05
  2.30071937e+05  4.55886883e+05  8.44839148e+05  1.52801642e+06
  2.85028382e+06  5.80817112e+06]
E1 = -706.697575921327  E_coul = 198.75254360932342
cycle= 5 E= -507.945032312004  delta_E= -1.36e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.697575921327  E_coul = 198.75254360932342
  HOMO = -0.237917689603542  LUMO = 10.0805974528733
  mo_energy =
[-1.20317159e+02 -1.23750291e+01 -6.67544775e+00 -6.67544775e+00
 -6.67544775e+00 -1.16395993e+00 -2.37917690e-01 -2.37917690e-01
 -2.37917690e-01  1.00805975e+01  1.09917932e+02  6.04469909e+02
  2.74410671e+03  1.22232933e+04  4.08448260e+04  1.04888484e+05
  2.30071937e+05  4.55886883e+05  8.44839148e+05  1.52801642e+06
  2.85028382e+06  5.80817112e+06]
E1 = -706.6975758280461  E_coul = 198.75254351604238
Extra cycle  E= -507.945032312004  delta_E= -1.14e-13  |g|= 7.35e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      4.86 sec, wall time      0.40 sec
exp = [1.17616814e+05 3.96611162e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547201e+04
 7.30348219e+03 1.83758104e+04 1.44975990e+03 3.74001178e+02
 1.13281831e+02 3.77557980e+01 8.08965619e+00 3.20471993e+00
 8.60381799e+00 4.92962754e-01]
E = -507.9450323120037
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:35:05 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.81425         1
[INPUT] 0    0    [1    /1   ]  0.396611162271       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031133        1
[INPUT] 0    0    [1    /1   ]  147020.992153        1
[INPUT] 0    0    [1    /1   ]  73510.4209905        1
[INPUT] 0    0    [1    /1   ]  36754.720148         1
[INPUT] 0    0    [1    /1   ]  7303.48219414        1
[INPUT] 0    0    [1    /1   ]  18375.8104309        1
[INPUT] 0    0    [1    /1   ]  1449.75989633        1
[INPUT] 0    0    [1    /1   ]  374.001178319        1
[INPUT] 0    0    [1    /1   ]  113.281830915        1
[INPUT] 0    0    [1    /1   ]  37.7557979757        1
[INPUT] 0    0    [1    /1   ]  8.08965619108        1
[INPUT] 0    0    [1    /1   ]  3.20471992849        1
[INPUT] 1    0    [1    /1   ]  8.60381798917        1
[INPUT] 1    0    [1    /1   ]  0.492962754392       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81424966588, 1.0]], [0, [0.3966111622713437, 1.0]], [0, [1176168.142618922, 1.0]], [0, [588084.0699927757, 1.0]], [0, [294042.03113310534, 1.0]], [0, [147020.99215257596, 1.0]], [0, [73510.4209904773, 1.0]], [0, [36754.72014804533, 1.0]], [0, [7303.482194141551, 1.0]], [0, [18375.81043085109, 1.0]], [0, [1449.7598963285825, 1.0]], [0, [374.00117831883233, 1.0]], [0, [113.28183091473647, 1.0]], [0, [37.755797975651475, 1.0]], [0, [8.08965619107787, 1.0]], [0, [3.2047199284854937, 1.0]], [1, [8.603817989172835, 1.0]], [1, [0.49296275439236004, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81424967]
bas 1, expnt(s) = [0.39661116]
bas 2, expnt(s) = [1176168.14261892]
bas 3, expnt(s) = [588084.06999278]
bas 4, expnt(s) = [294042.03113311]
bas 5, expnt(s) = [147020.99215258]
bas 6, expnt(s) = [73510.42099048]
bas 7, expnt(s) = [36754.72014805]
bas 8, expnt(s) = [7303.48219414]
bas 9, expnt(s) = [18375.81043085]
bas 10, expnt(s) = [1449.75989633]
bas 11, expnt(s) = [374.00117832]
bas 12, expnt(s) = [113.28183091]
bas 13, expnt(s) = [37.75579798]
bas 14, expnt(s) = [8.08965619]
bas 15, expnt(s) = [3.20471993]
bas 16, expnt(s) = [8.60381799]
bas 17, expnt(s) = [0.49296275]
CPU time:       217.94
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96611162e-01 1.26266669e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547201e+04 6.70656077e+03
 7.30348219e+03 1.99600905e+03 1.83758104e+04 3.98749270e+03
 1.44975990e+03 5.93590697e+02 3.74001178e+02 2.14867016e+02
 1.13281831e+02 8.77273921e+01 3.77557980e+01 3.84815684e+01
 8.08965619e+00 1.21188824e+01 3.20471993e+00 6.05142402e+00
 8.60381799e+00 4.29881159e+01 4.92962754e-01 1.20504156e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325158553015296
cond(S) = 907704.6525891133
E1 = -689.3957318343569  E_coul = 184.9099087347653
init E= -504.485823099592
    CPU time for initialize scf      4.76 sec, wall time      0.33 sec
  HOMO = -0.674769684826408  LUMO = 9.18298245025805
  mo_energy =
[-1.21707378e+02 -1.33876595e+01 -7.62818516e+00 -7.62818516e+00
 -7.62818516e+00 -1.64022273e+00 -6.74769685e-01 -6.74769685e-01
 -6.74769685e-01  9.18298245e+00  1.08614414e+02  6.03097196e+02
  2.74281259e+03  1.22221191e+04  4.08437222e+04  1.04887418e+05
  2.30070897e+05  4.55885860e+05  8.44838139e+05  1.52801542e+06
  2.85028283e+06  5.80817014e+06]
E1 = -707.0670668254166  E_coul = 199.12843638547955
cycle= 1 E= -507.938630439937  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602169
diis-c [-0.362608  1.      ]
  HOMO = -0.233230242185418  LUMO = 10.0920638299087
  mo_energy =
[-1.20256741e+02 -1.23515111e+01 -6.64621231e+00 -6.64621231e+00
 -6.64621231e+00 -1.16158169e+00 -2.33230242e-01 -2.33230242e-01
 -2.33230242e-01  1.00920638e+01  1.09963433e+02  6.04533704e+02
  2.74418373e+03  1.22233788e+04  4.08449146e+04  1.04888574e+05
  2.30072028e+05  4.55886974e+05  8.44839239e+05  1.52801651e+06
  2.85028391e+06  5.80817121e+06]
E1 = -706.7129814087459  E_coul = 198.7679612181319
cycle= 2 E= -507.945020190614  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152554
diis-c [-2.24128438e-04  4.84757847e-03  9.95152422e-01]
  HOMO = -0.237690308703865  LUMO = 10.0811409947826
  mo_energy =
[-1.20314560e+02 -1.23739159e+01 -6.67408823e+00 -6.67408823e+00
 -6.67408823e+00 -1.16384891e+00 -2.37690309e-01 -2.37690309e-01
 -2.37690309e-01  1.00811410e+01  1.09919956e+02  6.04472581e+02
  2.74410976e+03  1.22232966e+04  4.08448294e+04  1.04888487e+05
  2.30071941e+05  4.55886887e+05  8.44839151e+05  1.52801642e+06
  2.85028383e+06  5.80817112e+06]
E1 = -706.6983145877763  E_coul = 198.7532823059918
cycle= 3 E= -507.945032281785  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00873
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739877
diis-c [-1.26670043e-08  3.76878895e-05 -5.00633422e-02  1.05002565e+00]
  HOMO = -0.237916902758462  LUMO = 10.0805982885094
  mo_energy =
[-1.20317161e+02 -1.23750265e+01 -6.67544599e+00 -6.67544599e+00
 -6.67544599e+00 -1.16395948e+00 -2.37916903e-01 -2.37916903e-01
 -2.37916903e-01  1.00805983e+01  1.09917932e+02  6.04469906e+02
  2.74410670e+03  1.22232933e+04  4.08448260e+04  1.04888484e+05
  2.30071937e+05  4.55886883e+05  8.44839148e+05  1.52801642e+06
  2.85028382e+06  5.80817112e+06]
E1 = -706.697577036929  E_coul = 198.75254472492682
cycle= 4 E= -507.945032312002  delta_E= -3.02e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46742e-06
diis-c [-4.72071337e-12 -1.76651735e-06  2.30424172e-03 -4.57895584e-02
  1.04348708e+00]
  HOMO = -0.237917655545354  LUMO = 10.080597522583
  mo_energy =
[-1.20317159e+02 -1.23750289e+01 -6.67544758e+00 -6.67544758e+00
 -6.67544758e+00 -1.16395992e+00 -2.37917656e-01 -2.37917656e-01
 -2.37917656e-01  1.00805975e+01  1.09917933e+02  6.04469909e+02
  2.74410671e+03  1.22232933e+04  4.08448260e+04  1.04888484e+05
  2.30071937e+05  4.55886883e+05  8.44839148e+05  1.52801642e+06
  2.85028382e+06  5.80817112e+06]
E1 = -706.697575921327  E_coul = 198.75254360932342
cycle= 5 E= -507.945032312004  delta_E= -1.36e-12  |g|= 1.41e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.697575921327  E_coul = 198.75254360932342
  HOMO = -0.237917689603542  LUMO = 10.0805974528733
  mo_energy =
[-1.20317159e+02 -1.23750291e+01 -6.67544775e+00 -6.67544775e+00
 -6.67544775e+00 -1.16395993e+00 -2.37917690e-01 -2.37917690e-01
 -2.37917690e-01  1.00805975e+01  1.09917932e+02  6.04469909e+02
  2.74410671e+03  1.22232933e+04  4.08448260e+04  1.04888484e+05
  2.30071937e+05  4.55886883e+05  8.44839148e+05  1.52801642e+06
  2.85028382e+06  5.80817112e+06]
E1 = -706.6975758280461  E_coul = 198.75254351604238
Extra cycle  E= -507.945032312004  delta_E= -1.14e-13  |g|= 7.35e-09  |ddm|= 7.25e-08
    CPU time for scf_cycle      5.03 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907704.6525891133
E1 = -706.6975758280461  E_coul = 198.75254351604238
init E= -507.945032312004
    CPU time for initialize scf     10.15 sec, wall time      0.68 sec
  HOMO = -0.237917691210675  LUMO = 10.0805974497786
  mo_energy =
[-1.20317159e+02 -1.23750291e+01 -6.67544776e+00 -6.67544776e+00
 -6.67544776e+00 -1.16395994e+00 -2.37917691e-01 -2.37917691e-01
 -2.37917691e-01  1.00805974e+01  1.09917932e+02  6.04469909e+02
  2.74410671e+03  1.22232933e+04  4.08448260e+04  1.04888484e+05
  2.30071937e+05  4.55886883e+05  8.44839148e+05  1.52801642e+06
  2.85028382e+06  5.80817112e+06]
E1 = -706.6975758238342  E_coul = 198.75254351183045
cycle= 1 E= -507.945032312004  delta_E=    0  |g|= 1.44e-09  |ddm|= 3.58e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.6975758238342  E_coul = 198.75254351183045
  HOMO = -0.237917691289169  LUMO = 10.0805974496365
  mo_energy =
[-1.20317159e+02 -1.23750291e+01 -6.67544776e+00 -6.67544776e+00
 -6.67544776e+00 -1.16395994e+00 -2.37917691e-01 -2.37917691e-01
 -2.37917691e-01  1.00805974e+01  1.09917932e+02  6.04469909e+02
  2.74410671e+03  1.22232933e+04  4.08448260e+04  1.04888484e+05
  2.30071937e+05  4.55886883e+05  8.44839148e+05  1.52801642e+06
  2.85028382e+06  5.80817112e+06]
E1 = -706.6975758236415  E_coul = 198.75254351163792
Extra cycle  E= -507.945032312004  delta_E= 1.14e-13  |g|= 9.12e-10  |ddm|= 1.78e-10
    CPU time for scf_cycle     10.35 sec, wall time      0.75 sec
exp = [1.17616814e+05 3.96611162e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547201e+04
 7.30348219e+03 1.83758104e+04 1.44975990e+03 3.74001178e+02
 1.13281831e+02 3.77557980e+01 8.08965619e+00 3.20471993e+00
 8.60381799e+00 4.92962754e-01]
grad_E = [ 4.17502799e-09 -3.62401447e-04  1.86718024e-11  1.12535642e-10
  6.49573559e-10  2.54734223e-09  1.05826321e-08  5.69379639e-08
  3.58106863e-06  1.22347548e-07  5.44120268e-06 -7.66135270e-06
 -4.93553655e-06  1.65635016e-05  1.80423768e-06 -8.93734789e-06
 -4.38402544e-06 -1.56628788e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:35:09 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814246        1
[INPUT] 0    0    [1    /1   ]  0.396617172429       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031133        1
[INPUT] 0    0    [1    /1   ]  147020.99215         1
[INPUT] 0    0    [1    /1   ]  73510.4209806        1
[INPUT] 0    0    [1    /1   ]  36754.7200951        1
[INPUT] 0    0    [1    /1   ]  7303.47886517        1
[INPUT] 0    0    [1    /1   ]  18375.8103172        1
[INPUT] 0    0    [1    /1   ]  1449.75434035        1
[INPUT] 0    0    [1    /1   ]  374.013385129        1
[INPUT] 0    0    [1    /1   ]  113.270402338        1
[INPUT] 0    0    [1    /1   ]  37.7491250988        1
[INPUT] 0    0    [1    /1   ]  8.0866736187         1
[INPUT] 0    0    [1    /1   ]  3.20375217689        1
[INPUT] 1    0    [1    /1   ]  8.60383530544        1
[INPUT] 1    0    [1    /1   ]  0.49297323625        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81424578423, 1.0]], [0, [0.39661717242933303, 1.0]], [0, [1176168.1426189048, 1.0]], [0, [588084.0699926711, 1.0]], [0, [294042.0311325014, 1.0]], [0, [147020.9921502077, 1.0]], [0, [73510.42098063903, 1.0]], [0, [36754.72009509987, 1.0]], [0, [7303.4788651688505, 1.0]], [0, [18375.81031720313, 1.0]], [0, [1449.7543403485997, 1.0]], [0, [374.01338512893585, 1.0]], [0, [113.27040233796627, 1.0]], [0, [37.74912509881214, 1.0]], [0, [8.08667361870412, 1.0]], [0, [3.203752176887865, 1.0]], [1, [8.603835305437185, 1.0]], [1, [0.492973236250276, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81424578]
bas 1, expnt(s) = [0.39661717]
bas 2, expnt(s) = [1176168.1426189]
bas 3, expnt(s) = [588084.06999267]
bas 4, expnt(s) = [294042.0311325]
bas 5, expnt(s) = [147020.99215021]
bas 6, expnt(s) = [73510.42098064]
bas 7, expnt(s) = [36754.7200951]
bas 8, expnt(s) = [7303.47886517]
bas 9, expnt(s) = [18375.8103172]
bas 10, expnt(s) = [1449.75434035]
bas 11, expnt(s) = [374.01338513]
bas 12, expnt(s) = [113.27040234]
bas 13, expnt(s) = [37.7491251]
bas 14, expnt(s) = [8.08667362]
bas 15, expnt(s) = [3.20375218]
bas 16, expnt(s) = [8.60383531]
bas 17, expnt(s) = [0.49297324]
CPU time:       236.23
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96617172e-01 1.26268104e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547201e+04 6.70656077e+03
 7.30347887e+03 1.99600836e+03 1.83758103e+04 3.98749268e+03
 1.44975434e+03 5.93588991e+02 3.74013385e+02 2.14872275e+02
 1.13270402e+02 8.77207541e+01 3.77491251e+01 3.84764674e+01
 8.08667362e+00 1.21155312e+01 3.20375218e+00 6.05005343e+00
 8.60383531e+00 4.29882240e+01 4.92973236e-01 1.20507359e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32514486629589
cond(S) = 907703.9716056895
E1 = -689.3962399380357  E_coul = 184.91040119456954
init E= -504.485838743466
    CPU time for initialize scf      4.43 sec, wall time      0.31 sec
  HOMO = -0.674754840647709  LUMO = 9.17720680858189
  mo_energy =
[-1.21707323e+02 -1.33876228e+01 -7.62815325e+00 -7.62815325e+00
 -7.62815325e+00 -1.64021140e+00 -6.74754841e-01 -6.74754841e-01
 -6.74754841e-01  9.17720681e+00  1.08580773e+02  6.03037909e+02
  2.74276270e+03  1.22220714e+04  4.08436704e+04  1.04887364e+05
  2.30070841e+05  4.55885805e+05  8.44838084e+05  1.52801537e+06
  2.85028278e+06  5.80817009e+06]
E1 = -707.0678423352351  E_coul = 199.12921545176494
cycle= 1 E= -507.93862688347  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.18 sec, wall time      0.02 sec
diis-norm(errvec)=0.602163
diis-c [-0.36260072  1.        ]
  HOMO = -0.233202285977054  LUMO = 10.0861506255866
  mo_energy =
[-1.20256672e+02 -1.23514538e+01 -6.64616008e+00 -6.64616008e+00
 -6.64616008e+00 -1.16155865e+00 -2.33202286e-01 -2.33202286e-01
 -2.33202286e-01  1.00861506e+01  1.09929782e+02  6.04474428e+02
  2.74413384e+03  1.22233311e+04  4.08448628e+04  1.04888519e+05
  2.30071973e+05  4.55886919e+05  8.44839184e+05  1.52801646e+06
  2.85028386e+06  5.80817116e+06]
E1 = -706.7135775783548  E_coul = 198.7685572618375
cycle= 2 E= -507.945020316517  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152574
diis-c [-2.24187069e-04  4.84798245e-03  9.95152018e-01]
  HOMO = -0.237665841704817  LUMO = 10.0752254390382
  mo_energy =
[-1.20314513e+02 -1.23738721e+01 -6.67405079e+00 -6.67405079e+00
 -6.67405079e+00 -1.16382787e+00 -2.37665842e-01 -2.37665842e-01
 -2.37665842e-01  1.00752254e+01  1.09886290e+02  6.04413284e+02
  2.74405985e+03  1.22232489e+04  4.08447775e+04  1.04888433e+05
  2.30071885e+05  4.55886831e+05  8.44839096e+05  1.52801637e+06
  2.85028377e+06  5.80817107e+06]
E1 = -706.6988984526764  E_coul = 198.7538660291881
cycle= 3 E= -507.945032423488  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00874
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00074009
diis-c [-1.27091398e-08  3.77374354e-05 -5.00696851e-02  1.05003195e+00]
  HOMO = -0.237892694240921  LUMO = 10.0746824254101
  mo_energy =
[-1.20317115e+02 -1.23749837e+01 -6.67540969e+00 -6.67540969e+00
 -6.67540969e+00 -1.16393858e+00 -2.37892694e-01 -2.37892694e-01
 -2.37892694e-01  1.00746824e+01  1.09884266e+02  6.04410608e+02
  2.74405679e+03  1.22232456e+04  4.08447742e+04  1.04888429e+05
  2.30071882e+05  4.55886828e+05  8.44839093e+05  1.52801636e+06
  2.85028377e+06  5.80817107e+06]
E1 = -706.6981600324008  E_coul = 198.75312757863128
cycle= 4 E= -507.945032453769  delta_E= -3.03e-08  |g|= 6.29e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.47807e-06
diis-c [-4.72832810e-12 -1.76684072e-06  2.30660360e-03 -4.58361133e-02
  1.04353128e+00]
  HOMO = -0.237893450947841  LUMO = 10.0746816526485
  mo_energy =
[-1.20317112e+02 -1.23749862e+01 -6.67541130e+00 -6.67541130e+00
 -6.67541130e+00 -1.16393901e+00 -2.37893451e-01 -2.37893451e-01
 -2.37893451e-01  1.00746817e+01  1.09884266e+02  6.04410611e+02
  2.74405680e+03  1.22232456e+04  4.08447742e+04  1.04888429e+05
  2.30071882e+05  4.55886828e+05  8.44839093e+05  1.52801636e+06
  2.85028377e+06  5.80817107e+06]
E1 = -706.6981589066513  E_coul = 198.75312645288002
cycle= 5 E= -507.945032453771  delta_E= -1.82e-12  |g|= 1.41e-07  |ddm|= 2.18e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6981589066513  E_coul = 198.75312645288002
  HOMO = -0.237893485047376  LUMO = 10.0746815828864
  mo_energy =
[-1.20317113e+02 -1.23749863e+01 -6.67541147e+00 -6.67541147e+00
 -6.67541147e+00 -1.16393903e+00 -2.37893485e-01 -2.37893485e-01
 -2.37893485e-01  1.00746816e+01  1.09884266e+02  6.04410610e+02
  2.74405680e+03  1.22232456e+04  4.08447742e+04  1.04888429e+05
  2.30071882e+05  4.55886828e+05  8.44839093e+05  1.52801636e+06
  2.85028377e+06  5.80817107e+06]
E1 = -706.6981588132534  E_coul = 198.75312635948194
Extra cycle  E= -507.945032453771  delta_E= -1.14e-13  |g|= 7.32e-09  |ddm|= 7.26e-08
    CPU time for scf_cycle      4.68 sec, wall time      0.39 sec
exp = [1.17616814e+05 3.96617172e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547201e+04
 7.30347887e+03 1.83758103e+04 1.44975434e+03 3.74013385e+02
 1.13270402e+02 3.77491251e+01 8.08667362e+00 3.20375218e+00
 8.60383531e+00 4.92973236e-01]
E = -507.94503245377143
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:35:09 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814246        1
[INPUT] 0    0    [1    /1   ]  0.396617172429       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031133        1
[INPUT] 0    0    [1    /1   ]  147020.99215         1
[INPUT] 0    0    [1    /1   ]  73510.4209806        1
[INPUT] 0    0    [1    /1   ]  36754.7200951        1
[INPUT] 0    0    [1    /1   ]  7303.47886517        1
[INPUT] 0    0    [1    /1   ]  18375.8103172        1
[INPUT] 0    0    [1    /1   ]  1449.75434035        1
[INPUT] 0    0    [1    /1   ]  374.013385129        1
[INPUT] 0    0    [1    /1   ]  113.270402338        1
[INPUT] 0    0    [1    /1   ]  37.7491250988        1
[INPUT] 0    0    [1    /1   ]  8.0866736187         1
[INPUT] 0    0    [1    /1   ]  3.20375217689        1
[INPUT] 1    0    [1    /1   ]  8.60383530544        1
[INPUT] 1    0    [1    /1   ]  0.49297323625        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81424578423, 1.0]], [0, [0.39661717242933303, 1.0]], [0, [1176168.1426189048, 1.0]], [0, [588084.0699926711, 1.0]], [0, [294042.0311325014, 1.0]], [0, [147020.9921502077, 1.0]], [0, [73510.42098063903, 1.0]], [0, [36754.72009509987, 1.0]], [0, [7303.4788651688505, 1.0]], [0, [18375.81031720313, 1.0]], [0, [1449.7543403485997, 1.0]], [0, [374.01338512893585, 1.0]], [0, [113.27040233796627, 1.0]], [0, [37.74912509881214, 1.0]], [0, [8.08667361870412, 1.0]], [0, [3.203752176887865, 1.0]], [1, [8.603835305437185, 1.0]], [1, [0.492973236250276, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81424578]
bas 1, expnt(s) = [0.39661717]
bas 2, expnt(s) = [1176168.1426189]
bas 3, expnt(s) = [588084.06999267]
bas 4, expnt(s) = [294042.0311325]
bas 5, expnt(s) = [147020.99215021]
bas 6, expnt(s) = [73510.42098064]
bas 7, expnt(s) = [36754.7200951]
bas 8, expnt(s) = [7303.47886517]
bas 9, expnt(s) = [18375.8103172]
bas 10, expnt(s) = [1449.75434035]
bas 11, expnt(s) = [374.01338513]
bas 12, expnt(s) = [113.27040234]
bas 13, expnt(s) = [37.7491251]
bas 14, expnt(s) = [8.08667362]
bas 15, expnt(s) = [3.20375218]
bas 16, expnt(s) = [8.60383531]
bas 17, expnt(s) = [0.49297324]
CPU time:       241.03
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96617172e-01 1.26268104e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547201e+04 6.70656077e+03
 7.30347887e+03 1.99600836e+03 1.83758103e+04 3.98749268e+03
 1.44975434e+03 5.93588991e+02 3.74013385e+02 2.14872275e+02
 1.13270402e+02 8.77207541e+01 3.77491251e+01 3.84764674e+01
 8.08667362e+00 1.21155312e+01 3.20375218e+00 6.05005343e+00
 8.60383531e+00 4.29882240e+01 4.92973236e-01 1.20507359e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32514486629589
cond(S) = 907703.9716056895
E1 = -689.3962399380357  E_coul = 184.91040119456954
init E= -504.485838743466
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674754840647709  LUMO = 9.17720680858189
  mo_energy =
[-1.21707323e+02 -1.33876228e+01 -7.62815325e+00 -7.62815325e+00
 -7.62815325e+00 -1.64021140e+00 -6.74754841e-01 -6.74754841e-01
 -6.74754841e-01  9.17720681e+00  1.08580773e+02  6.03037909e+02
  2.74276270e+03  1.22220714e+04  4.08436704e+04  1.04887364e+05
  2.30070841e+05  4.55885805e+05  8.44838084e+05  1.52801537e+06
  2.85028278e+06  5.80817009e+06]
E1 = -707.0678423352351  E_coul = 199.12921545176494
cycle= 1 E= -507.93862688347  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602163
diis-c [-0.36260072  1.        ]
  HOMO = -0.233202285977054  LUMO = 10.0861506255866
  mo_energy =
[-1.20256672e+02 -1.23514538e+01 -6.64616008e+00 -6.64616008e+00
 -6.64616008e+00 -1.16155865e+00 -2.33202286e-01 -2.33202286e-01
 -2.33202286e-01  1.00861506e+01  1.09929782e+02  6.04474428e+02
  2.74413384e+03  1.22233311e+04  4.08448628e+04  1.04888519e+05
  2.30071973e+05  4.55886919e+05  8.44839184e+05  1.52801646e+06
  2.85028386e+06  5.80817116e+06]
E1 = -706.7135775783548  E_coul = 198.7685572618375
cycle= 2 E= -507.945020316517  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152574
diis-c [-2.24187069e-04  4.84798245e-03  9.95152018e-01]
  HOMO = -0.237665841704817  LUMO = 10.0752254390382
  mo_energy =
[-1.20314513e+02 -1.23738721e+01 -6.67405079e+00 -6.67405079e+00
 -6.67405079e+00 -1.16382787e+00 -2.37665842e-01 -2.37665842e-01
 -2.37665842e-01  1.00752254e+01  1.09886290e+02  6.04413284e+02
  2.74405985e+03  1.22232489e+04  4.08447775e+04  1.04888433e+05
  2.30071885e+05  4.55886831e+05  8.44839096e+05  1.52801637e+06
  2.85028377e+06  5.80817107e+06]
E1 = -706.6988984526764  E_coul = 198.7538660291881
cycle= 3 E= -507.945032423488  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00874
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00074009
diis-c [-1.27091398e-08  3.77374354e-05 -5.00696851e-02  1.05003195e+00]
  HOMO = -0.237892694240921  LUMO = 10.0746824254101
  mo_energy =
[-1.20317115e+02 -1.23749837e+01 -6.67540969e+00 -6.67540969e+00
 -6.67540969e+00 -1.16393858e+00 -2.37892694e-01 -2.37892694e-01
 -2.37892694e-01  1.00746824e+01  1.09884266e+02  6.04410608e+02
  2.74405679e+03  1.22232456e+04  4.08447742e+04  1.04888429e+05
  2.30071882e+05  4.55886828e+05  8.44839093e+05  1.52801636e+06
  2.85028377e+06  5.80817107e+06]
E1 = -706.6981600324008  E_coul = 198.75312757863128
cycle= 4 E= -507.945032453769  delta_E= -3.03e-08  |g|= 6.29e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.47807e-06
diis-c [-4.72832810e-12 -1.76684072e-06  2.30660360e-03 -4.58361133e-02
  1.04353128e+00]
  HOMO = -0.237893450947841  LUMO = 10.0746816526485
  mo_energy =
[-1.20317112e+02 -1.23749862e+01 -6.67541130e+00 -6.67541130e+00
 -6.67541130e+00 -1.16393901e+00 -2.37893451e-01 -2.37893451e-01
 -2.37893451e-01  1.00746817e+01  1.09884266e+02  6.04410611e+02
  2.74405680e+03  1.22232456e+04  4.08447742e+04  1.04888429e+05
  2.30071882e+05  4.55886828e+05  8.44839093e+05  1.52801636e+06
  2.85028377e+06  5.80817107e+06]
E1 = -706.6981589066513  E_coul = 198.75312645288002
cycle= 5 E= -507.945032453771  delta_E= -1.82e-12  |g|= 1.41e-07  |ddm|= 2.18e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6981589066513  E_coul = 198.75312645288002
  HOMO = -0.237893485047376  LUMO = 10.0746815828864
  mo_energy =
[-1.20317113e+02 -1.23749863e+01 -6.67541147e+00 -6.67541147e+00
 -6.67541147e+00 -1.16393903e+00 -2.37893485e-01 -2.37893485e-01
 -2.37893485e-01  1.00746816e+01  1.09884266e+02  6.04410610e+02
  2.74405680e+03  1.22232456e+04  4.08447742e+04  1.04888429e+05
  2.30071882e+05  4.55886828e+05  8.44839093e+05  1.52801636e+06
  2.85028377e+06  5.80817107e+06]
E1 = -706.6981588132534  E_coul = 198.75312635948194
Extra cycle  E= -507.945032453771  delta_E= -1.14e-13  |g|= 7.32e-09  |ddm|= 7.26e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907703.9716056895
E1 = -706.6981588132534  E_coul = 198.75312635948194
init E= -507.945032453771
    CPU time for initialize scf      1.29 sec, wall time      0.08 sec
  HOMO = -0.237893486656765  LUMO = 10.0746815797892
  mo_energy =
[-1.20317113e+02 -1.23749863e+01 -6.67541148e+00 -6.67541148e+00
 -6.67541148e+00 -1.16393903e+00 -2.37893487e-01 -2.37893487e-01
 -2.37893487e-01  1.00746816e+01  1.09884266e+02  6.04410610e+02
  2.74405680e+03  1.22232456e+04  4.08447742e+04  1.04888429e+05
  2.30071882e+05  4.55886828e+05  8.44839093e+05  1.52801636e+06
  2.85028377e+06  5.80817107e+06]
E1 = -706.6981588090216  E_coul = 198.75312635525046
cycle= 1 E= -507.945032453771  delta_E= 2.84e-13  |g|= 3.12e-09  |ddm|= 3.6e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
E1 = -706.6981588090216  E_coul = 198.75312635525046
  HOMO = -0.237893486735621  LUMO = 10.0746815796453
  mo_energy =
[-1.20317113e+02 -1.23749863e+01 -6.67541148e+00 -6.67541148e+00
 -6.67541148e+00 -1.16393903e+00 -2.37893487e-01 -2.37893487e-01
 -2.37893487e-01  1.00746816e+01  1.09884266e+02  6.04410610e+02
  2.74405680e+03  1.22232456e+04  4.08447742e+04  1.04888429e+05
  2.30071882e+05  4.55886828e+05  8.44839093e+05  1.52801636e+06
  2.85028377e+06  5.80817107e+06]
E1 = -706.6981588088228  E_coul = 198.75312635505176
Extra cycle  E= -507.945032453771  delta_E= 1.71e-13  |g|= 1.48e-09  |ddm|= 1.85e-10
    CPU time for scf_cycle      1.48 sec, wall time      0.15 sec
exp = [1.17616814e+05 3.96617172e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547201e+04
 7.30347887e+03 1.83758103e+04 1.44975434e+03 3.74013385e+02
 1.13270402e+02 3.77491251e+01 8.08667362e+00 3.20375218e+00
 8.60383531e+00 4.92973236e-01]
grad_E = [ 4.17837835e-09 -2.77984894e-04  1.87115824e-11  1.12644470e-10
  6.50092079e-10  2.54941297e-09  1.05913610e-08  5.69809447e-08
  3.58406655e-06  1.22478543e-07  5.29455134e-06 -6.31990534e-06
 -6.77450095e-06  9.31678919e-06 -9.87092258e-06 -1.01711817e-05
 -3.36144358e-06 -1.20073733e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:35:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814243        1
[INPUT] 0    0    [1    /1   ]  0.396626823487       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209731        1
[INPUT] 0    0    [1    /1   ]  36754.7200548        1
[INPUT] 0    0    [1    /1   ]  7303.47632998        1
[INPUT] 0    0    [1    /1   ]  18375.8102307        1
[INPUT] 0    0    [1    /1   ]  1449.75008767        1
[INPUT] 0    0    [1    /1   ]  374.022890151        1
[INPUT] 0    0    [1    /1   ]  113.261175558        1
[INPUT] 0    0    [1    /1   ]  37.7436470847        1
[INPUT] 0    0    [1    /1   ]  8.08669370774        1
[INPUT] 0    0    [1    /1   ]  3.20364713959        1
[INPUT] 1    0    [1    /1   ]  8.60386291277        1
[INPUT] 1    0    [1    /1   ]  0.492993804265       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81424282813, 1.0]], [0, [0.3966268234871615, 1.0]], [0, [1176168.1426188916, 1.0]], [0, [588084.0699925915, 1.0]], [0, [294042.0311320414, 1.0]], [0, [147020.99214840413, 1.0]], [0, [73510.42097314664, 1.0]], [0, [36754.72005477845, 1.0]], [0, [7303.476329982907, 1.0]], [0, [18375.81023065804, 1.0]], [0, [1449.7500876681918, 1.0]], [0, [374.0228901509408, 1.0]], [0, [113.2611755580707, 1.0]], [0, [37.74364708469744, 1.0]], [0, [8.086693707736355, 1.0]], [0, [3.2036471395901818, 1.0]], [1, [8.603862912772117, 1.0]], [1, [0.49299380426461364, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81424283]
bas 1, expnt(s) = [0.39662682]
bas 2, expnt(s) = [1176168.14261889]
bas 3, expnt(s) = [588084.06999259]
bas 4, expnt(s) = [294042.03113204]
bas 5, expnt(s) = [147020.9921484]
bas 6, expnt(s) = [73510.42097315]
bas 7, expnt(s) = [36754.72005478]
bas 8, expnt(s) = [7303.47632998]
bas 9, expnt(s) = [18375.81023066]
bas 10, expnt(s) = [1449.75008767]
bas 11, expnt(s) = [374.02289015]
bas 12, expnt(s) = [113.26117556]
bas 13, expnt(s) = [37.74364708]
bas 14, expnt(s) = [8.08669371]
bas 15, expnt(s) = [3.20364714]
bas 16, expnt(s) = [8.60386291]
bas 17, expnt(s) = [0.4929938]
CPU time:       245.63
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96626823e-01 1.26270409e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547201e+04 6.70656076e+03
 7.30347633e+03 1.99600784e+03 1.83758102e+04 3.98749266e+03
 1.44975009e+03 5.93587685e+02 3.74022890e+02 2.14876371e+02
 1.13261176e+02 8.77153949e+01 3.77436471e+01 3.84722797e+01
 8.08669371e+00 1.21155538e+01 3.20364714e+00 6.04990466e+00
 8.60386291e+00 4.29883964e+01 4.92993804e-01 1.20513644e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325116650674985
cond(S) = 907703.5450662993
E1 = -689.3971863179991  E_coul = 184.91126033436777
init E= -504.485925983631
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674727496891496  LUMO = 9.17687237916226
  mo_energy =
[-1.21707235e+02 -1.33875514e+01 -7.62809940e+00 -7.62809940e+00
 -7.62809940e+00 -1.64019274e+00 -6.74727497e-01 -6.74727497e-01
 -6.74727497e-01  9.17687238e+00  1.08566206e+02  6.03001533e+02
  2.74273182e+03  1.22220413e+04  4.08436366e+04  1.04887328e+05
  2.30070805e+05  4.55885768e+05  8.44838047e+05  1.52801533e+06
  2.85028275e+06  5.80817005e+06]
E1 = -707.0691708459353  E_coul = 199.13054421682818
cycle= 1 E= -507.938626629107  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.60216
diis-c [-0.36259624  1.        ]
  HOMO = -0.233150790805359  LUMO = 10.0858291007907
  mo_energy =
[-1.20256554e+02 -1.23513515e+01 -6.64607637e+00 -6.64607637e+00
 -6.64607637e+00 -1.16152003e+00 -2.33150791e-01 -2.33150791e-01
 -2.33150791e-01  1.00858291e+01  1.09915227e+02  6.04438077e+02
  2.74410298e+03  1.22233010e+04  4.08448291e+04  1.04888483e+05
  2.30071936e+05  4.55886882e+05  8.44839148e+05  1.52801642e+06
  2.85028382e+06  5.80817112e+06]
E1 = -706.714891877074  E_coul = 198.7698714950042
cycle= 2 E= -507.94502038207  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.015258
diis-c [-2.24208128e-04  4.84740360e-03  9.95152596e-01]
  HOMO = -0.237614799848342  LUMO = 10.0749038448768
  mo_energy =
[-1.20314396e+02 -1.23737707e+01 -6.67396813e+00 -6.67396813e+00
 -6.67396813e+00 -1.16378941e+00 -2.37614800e-01 -2.37614800e-01
 -2.37614800e-01  1.00749038e+01  1.09871735e+02  6.04376931e+02
  2.74402899e+03  1.22232188e+04  4.08447438e+04  1.04888397e+05
  2.30071849e+05  4.55886795e+05  8.44839060e+05  1.52801633e+06
  2.85028374e+06  5.80817104e+06]
E1 = -706.7002117676547  E_coul = 198.75517927732966
cycle= 3 E= -507.945032490325  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00874
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000740119
diis-c [-1.27136813e-08  3.77433013e-05 -5.00694461e-02  1.05003170e+00]
  HOMO = -0.237841678524883  LUMO = 10.074360818799
  mo_energy =
[-1.20316999e+02 -1.23748824e+01 -6.67532710e+00 -6.67532710e+00
 -6.67532710e+00 -1.16390013e+00 -2.37841679e-01 -2.37841679e-01
 -2.37841679e-01  1.00743608e+01  1.09869711e+02  6.04374255e+02
  2.74402593e+03  1.22232155e+04  4.08447405e+04  1.04888393e+05
  2.30071845e+05  4.55886791e+05  8.44839056e+05  1.52801633e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.699473287863  E_coul = 198.75444076725262
cycle= 4 E= -507.94503252061  delta_E= -3.03e-08  |g|= 6.29e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.47947e-06
diis-c [-4.73067359e-12 -1.76750549e-06  2.30685263e-03 -4.58417045e-02
  1.04353662e+00]
  HOMO = -0.237842435571754  LUMO = 10.0743600454213
  mo_energy =
[-1.20316996e+02 -1.23748849e+01 -6.67532871e+00 -6.67532871e+00
 -6.67532871e+00 -1.16390056e+00 -2.37842436e-01 -2.37842436e-01
 -2.37842436e-01  1.00743600e+01  1.09869711e+02  6.04374258e+02
  2.74402594e+03  1.22232155e+04  4.08447405e+04  1.04888393e+05
  2.30071845e+05  4.55886791e+05  8.44839056e+05  1.52801633e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.6994721612084  E_coul = 198.75443964059622
cycle= 5 E= -507.945032520612  delta_E= -1.76e-12  |g|= 1.41e-07  |ddm|= 2.18e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6994721612084  E_coul = 198.75443964059622
  HOMO = -0.237842469672626  LUMO = 10.0743599756605
  mo_energy =
[-1.20316997e+02 -1.23748850e+01 -6.67532888e+00 -6.67532888e+00
 -6.67532888e+00 -1.16390058e+00 -2.37842470e-01 -2.37842470e-01
 -2.37842470e-01  1.00743600e+01  1.09869711e+02  6.04374258e+02
  2.74402594e+03  1.22232155e+04  4.08447405e+04  1.04888393e+05
  2.30071845e+05  4.55886791e+05  8.44839056e+05  1.52801633e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.6994720678023  E_coul = 198.75443954719054
Extra cycle  E= -507.945032520612  delta_E= 4.55e-13  |g|= 7.33e-09  |ddm|= 7.26e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.10 sec
exp = [1.17616814e+05 3.96626823e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547201e+04
 7.30347633e+03 1.83758102e+04 1.44975009e+03 3.74022890e+02
 1.13261176e+02 3.77436471e+01 8.08669371e+00 3.20364714e+00
 8.60386291e+00 4.92993804e-01]
E = -507.94503252061173
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:35:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814243        1
[INPUT] 0    0    [1    /1   ]  0.396626823487       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209731        1
[INPUT] 0    0    [1    /1   ]  36754.7200548        1
[INPUT] 0    0    [1    /1   ]  7303.47632998        1
[INPUT] 0    0    [1    /1   ]  18375.8102307        1
[INPUT] 0    0    [1    /1   ]  1449.75008767        1
[INPUT] 0    0    [1    /1   ]  374.022890151        1
[INPUT] 0    0    [1    /1   ]  113.261175558        1
[INPUT] 0    0    [1    /1   ]  37.7436470847        1
[INPUT] 0    0    [1    /1   ]  8.08669370774        1
[INPUT] 0    0    [1    /1   ]  3.20364713959        1
[INPUT] 1    0    [1    /1   ]  8.60386291277        1
[INPUT] 1    0    [1    /1   ]  0.492993804265       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81424282813, 1.0]], [0, [0.3966268234871615, 1.0]], [0, [1176168.1426188916, 1.0]], [0, [588084.0699925915, 1.0]], [0, [294042.0311320414, 1.0]], [0, [147020.99214840413, 1.0]], [0, [73510.42097314664, 1.0]], [0, [36754.72005477845, 1.0]], [0, [7303.476329982907, 1.0]], [0, [18375.81023065804, 1.0]], [0, [1449.7500876681918, 1.0]], [0, [374.0228901509408, 1.0]], [0, [113.2611755580707, 1.0]], [0, [37.74364708469744, 1.0]], [0, [8.086693707736355, 1.0]], [0, [3.2036471395901818, 1.0]], [1, [8.603862912772117, 1.0]], [1, [0.49299380426461364, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81424283]
bas 1, expnt(s) = [0.39662682]
bas 2, expnt(s) = [1176168.14261889]
bas 3, expnt(s) = [588084.06999259]
bas 4, expnt(s) = [294042.03113204]
bas 5, expnt(s) = [147020.9921484]
bas 6, expnt(s) = [73510.42097315]
bas 7, expnt(s) = [36754.72005478]
bas 8, expnt(s) = [7303.47632998]
bas 9, expnt(s) = [18375.81023066]
bas 10, expnt(s) = [1449.75008767]
bas 11, expnt(s) = [374.02289015]
bas 12, expnt(s) = [113.26117556]
bas 13, expnt(s) = [37.74364708]
bas 14, expnt(s) = [8.08669371]
bas 15, expnt(s) = [3.20364714]
bas 16, expnt(s) = [8.60386291]
bas 17, expnt(s) = [0.4929938]
CPU time:       246.17
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96626823e-01 1.26270409e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547201e+04 6.70656076e+03
 7.30347633e+03 1.99600784e+03 1.83758102e+04 3.98749266e+03
 1.44975009e+03 5.93587685e+02 3.74022890e+02 2.14876371e+02
 1.13261176e+02 8.77153949e+01 3.77436471e+01 3.84722797e+01
 8.08669371e+00 1.21155538e+01 3.20364714e+00 6.04990466e+00
 8.60386291e+00 4.29883964e+01 4.92993804e-01 1.20513644e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325116650674985
cond(S) = 907703.5450662993
E1 = -689.3971863179991  E_coul = 184.91126033436777
init E= -504.485925983631
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674727496891496  LUMO = 9.17687237916226
  mo_energy =
[-1.21707235e+02 -1.33875514e+01 -7.62809940e+00 -7.62809940e+00
 -7.62809940e+00 -1.64019274e+00 -6.74727497e-01 -6.74727497e-01
 -6.74727497e-01  9.17687238e+00  1.08566206e+02  6.03001533e+02
  2.74273182e+03  1.22220413e+04  4.08436366e+04  1.04887328e+05
  2.30070805e+05  4.55885768e+05  8.44838047e+05  1.52801533e+06
  2.85028275e+06  5.80817005e+06]
E1 = -707.0691708459353  E_coul = 199.13054421682818
cycle= 1 E= -507.938626629107  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.60216
diis-c [-0.36259624  1.        ]
  HOMO = -0.233150790805359  LUMO = 10.0858291007907
  mo_energy =
[-1.20256554e+02 -1.23513515e+01 -6.64607637e+00 -6.64607637e+00
 -6.64607637e+00 -1.16152003e+00 -2.33150791e-01 -2.33150791e-01
 -2.33150791e-01  1.00858291e+01  1.09915227e+02  6.04438077e+02
  2.74410298e+03  1.22233010e+04  4.08448291e+04  1.04888483e+05
  2.30071936e+05  4.55886882e+05  8.44839148e+05  1.52801642e+06
  2.85028382e+06  5.80817112e+06]
E1 = -706.714891877074  E_coul = 198.7698714950042
cycle= 2 E= -507.94502038207  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.015258
diis-c [-2.24208128e-04  4.84740360e-03  9.95152596e-01]
  HOMO = -0.237614799848342  LUMO = 10.0749038448768
  mo_energy =
[-1.20314396e+02 -1.23737707e+01 -6.67396813e+00 -6.67396813e+00
 -6.67396813e+00 -1.16378941e+00 -2.37614800e-01 -2.37614800e-01
 -2.37614800e-01  1.00749038e+01  1.09871735e+02  6.04376931e+02
  2.74402899e+03  1.22232188e+04  4.08447438e+04  1.04888397e+05
  2.30071849e+05  4.55886795e+05  8.44839060e+05  1.52801633e+06
  2.85028374e+06  5.80817104e+06]
E1 = -706.7002117676547  E_coul = 198.75517927732966
cycle= 3 E= -507.945032490325  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00874
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000740119
diis-c [-1.27136813e-08  3.77433013e-05 -5.00694461e-02  1.05003170e+00]
  HOMO = -0.237841678524883  LUMO = 10.074360818799
  mo_energy =
[-1.20316999e+02 -1.23748824e+01 -6.67532710e+00 -6.67532710e+00
 -6.67532710e+00 -1.16390013e+00 -2.37841679e-01 -2.37841679e-01
 -2.37841679e-01  1.00743608e+01  1.09869711e+02  6.04374255e+02
  2.74402593e+03  1.22232155e+04  4.08447405e+04  1.04888393e+05
  2.30071845e+05  4.55886791e+05  8.44839056e+05  1.52801633e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.699473287863  E_coul = 198.75444076725262
cycle= 4 E= -507.94503252061  delta_E= -3.03e-08  |g|= 6.29e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.47947e-06
diis-c [-4.73067359e-12 -1.76750549e-06  2.30685263e-03 -4.58417045e-02
  1.04353662e+00]
  HOMO = -0.237842435571754  LUMO = 10.0743600454213
  mo_energy =
[-1.20316996e+02 -1.23748849e+01 -6.67532871e+00 -6.67532871e+00
 -6.67532871e+00 -1.16390056e+00 -2.37842436e-01 -2.37842436e-01
 -2.37842436e-01  1.00743600e+01  1.09869711e+02  6.04374258e+02
  2.74402594e+03  1.22232155e+04  4.08447405e+04  1.04888393e+05
  2.30071845e+05  4.55886791e+05  8.44839056e+05  1.52801633e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.6994721612084  E_coul = 198.75443964059622
cycle= 5 E= -507.945032520612  delta_E= -1.76e-12  |g|= 1.41e-07  |ddm|= 2.18e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6994721612084  E_coul = 198.75443964059622
  HOMO = -0.237842469672626  LUMO = 10.0743599756605
  mo_energy =
[-1.20316997e+02 -1.23748850e+01 -6.67532888e+00 -6.67532888e+00
 -6.67532888e+00 -1.16390058e+00 -2.37842470e-01 -2.37842470e-01
 -2.37842470e-01  1.00743600e+01  1.09869711e+02  6.04374258e+02
  2.74402594e+03  1.22232155e+04  4.08447405e+04  1.04888393e+05
  2.30071845e+05  4.55886791e+05  8.44839056e+05  1.52801633e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.6994720678023  E_coul = 198.75443954719054
Extra cycle  E= -507.945032520612  delta_E= 4.55e-13  |g|= 7.33e-09  |ddm|= 7.26e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907703.5450662993
E1 = -706.6994720678023  E_coul = 198.75443954719054
init E= -507.945032520612
    CPU time for initialize scf      1.39 sec, wall time      0.09 sec
  HOMO = -0.237842471282231  LUMO = 10.0743599725631
  mo_energy =
[-1.20316997e+02 -1.23748850e+01 -6.67532889e+00 -6.67532889e+00
 -6.67532889e+00 -1.16390058e+00 -2.37842471e-01 -2.37842471e-01
 -2.37842471e-01  1.00743600e+01  1.09869711e+02  6.04374258e+02
  2.74402594e+03  1.22232155e+04  4.08447405e+04  1.04888393e+05
  2.30071845e+05  4.55886791e+05  8.44839056e+05  1.52801633e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.6994720635804  E_coul = 198.75443954296836
cycle= 1 E= -507.945032520612  delta_E= -2.84e-13  |g|= 1.64e-09  |ddm|= 3.59e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.6994720635804  E_coul = 198.75443954296836
  HOMO = -0.237842471360897  LUMO = 10.0743599724211
  mo_energy =
[-1.20316997e+02 -1.23748850e+01 -6.67532889e+00 -6.67532889e+00
 -6.67532889e+00 -1.16390058e+00 -2.37842471e-01 -2.37842471e-01
 -2.37842471e-01  1.00743600e+01  1.09869711e+02  6.04374258e+02
  2.74402594e+03  1.22232155e+04  4.08447405e+04  1.04888393e+05
  2.30071845e+05  4.55886791e+05  8.44839056e+05  1.52801633e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.6994720633872  E_coul = 198.7544395427753
Extra cycle  E= -507.945032520612  delta_E= 5.68e-14  |g|= 1.94e-09  |ddm|= 1.77e-10
    CPU time for scf_cycle      1.57 sec, wall time      0.16 sec
exp = [1.17616814e+05 3.96626823e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547201e+04
 7.30347633e+03 1.83758102e+04 1.44975009e+03 3.74022890e+02
 1.13261176e+02 3.77436471e+01 8.08669371e+00 3.20364714e+00
 8.60386291e+00 4.92993804e-01]
grad_E = [ 4.18089575e-09 -1.03970830e-04  1.87414927e-11  1.12726227e-10
  6.50481736e-10  2.55096884e-09  1.05979192e-08  5.70132452e-08
  3.58631990e-06  1.22576883e-07  5.18500676e-06 -5.36170806e-06
 -7.45850525e-06  6.81541522e-07 -8.53923448e-06 -5.62662921e-06
 -1.26013053e-06 -4.47704518e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:35:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.396631390333       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209716        1
[INPUT] 0    0    [1    /1   ]  36754.7200463        1
[INPUT] 0    0    [1    /1   ]  7303.4757965         1
[INPUT] 0    0    [1    /1   ]  18375.8102124        1
[INPUT] 0    0    [1    /1   ]  1449.74918274        1
[INPUT] 0    0    [1    /1   ]  374.024987601        1
[INPUT] 0    0    [1    /1   ]  113.258990685        1
[INPUT] 0    0    [1    /1   ]  37.7423028801        1
[INPUT] 0    0    [1    /1   ]  8.0878334711         1
[INPUT] 0    0    [1    /1   ]  3.20394036952        1
[INPUT] 1    0    [1    /1   ]  8.60387590146        1
[INPUT] 1    0    [1    /1   ]  0.49300439993        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81424220605, 1.0]], [0, [0.39663139033263906, 1.0]], [0, [1176168.1426188888, 1.0]], [0, [588084.0699925747, 1.0]], [0, [294042.0311319446, 1.0]], [0, [147020.99214802458, 1.0]], [0, [73510.42097156998, 1.0]], [0, [36754.72004629316, 1.0]], [0, [7303.475796495015, 1.0]], [0, [18375.810212447803, 1.0]], [0, [1449.7491827414703, 1.0]], [0, [374.02498760080744, 1.0]], [0, [113.25899068525139, 1.0]], [0, [37.74230288014117, 1.0]], [0, [8.087833471100874, 1.0]], [0, [3.203940369521719, 1.0]], [1, [8.603875901455677, 1.0]], [1, [0.4930043999300832, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81424221]
bas 1, expnt(s) = [0.39663139]
bas 2, expnt(s) = [1176168.14261889]
bas 3, expnt(s) = [588084.06999257]
bas 4, expnt(s) = [294042.03113194]
bas 5, expnt(s) = [147020.99214802]
bas 6, expnt(s) = [73510.42097157]
bas 7, expnt(s) = [36754.72004629]
bas 8, expnt(s) = [7303.4757965]
bas 9, expnt(s) = [18375.81021245]
bas 10, expnt(s) = [1449.74918274]
bas 11, expnt(s) = [374.0249876]
bas 12, expnt(s) = [113.25899069]
bas 13, expnt(s) = [37.74230288]
bas 14, expnt(s) = [8.08783347]
bas 15, expnt(s) = [3.20394037]
bas 16, expnt(s) = [8.6038759]
bas 17, expnt(s) = [0.4930044]
CPU time:       250.99
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96631390e-01 1.26271499e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547200e+04 6.70656076e+03
 7.30347580e+03 1.99600774e+03 1.83758102e+04 3.98749266e+03
 1.44974918e+03 5.93587407e+02 3.74024988e+02 2.14877275e+02
 1.13258991e+02 8.77141258e+01 3.77423029e+01 3.84712521e+01
 8.08783347e+00 1.21168345e+01 3.20394037e+00 6.05031997e+00
 8.60387590e+00 4.29884775e+01 4.93004400e-01 1.20516882e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32510185065949
cond(S) = 907703.5014384832
E1 = -689.3976643105568  E_coul = 184.91168233665482
init E= -504.485981973902
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674713746148399  LUMO = 9.17882167758427
  mo_energy =
[-1.21707194e+02 -1.33875147e+01 -7.62807333e+00 -7.62807333e+00
 -7.62807333e+00 -1.64018386e+00 -6.74713746e-01 -6.74713746e-01
 -6.74713746e-01  9.17882168e+00  1.08568643e+02  6.02998289e+02
  2.74272892e+03  1.22220380e+04  4.08436324e+04  1.04887323e+05
  2.30070800e+05  4.55885763e+05  8.44838042e+05  1.52801533e+06
  2.85028274e+06  5.80817005e+06]
E1 = -707.0698190477624  E_coul = 199.1311912325594
cycle= 1 E= -507.938627815203  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.602159
diis-c [-0.36259581  1.        ]
  HOMO = -0.233124888948389  LUMO = 10.0878396407282
  mo_energy =
[-1.20256497e+02 -1.23513006e+01 -6.64603678e+00 -6.64603678e+00
 -6.64603678e+00 -1.16150142e+00 -2.33124889e-01 -2.33124889e-01
 -2.33124889e-01  1.00878396e+01  1.09917676e+02  6.04434847e+02
  2.74410009e+03  1.22232978e+04  4.08448249e+04  1.04888479e+05
  2.30071931e+05  4.55886877e+05  8.44839142e+05  1.52801641e+06
  2.85028382e+06  5.80817112e+06]
E1 = -706.7155980032824  E_coul = 198.77057760512983
cycle= 2 E= -507.945020398153  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152577
diis-c [-2.24200711e-04  4.84683903e-03  9.95153161e-01]
  HOMO = -0.237587896778829  LUMO = 10.0769152292386
  mo_energy =
[-1.20314332e+02 -1.23737154e+01 -6.67392367e+00 -6.67392367e+00
 -6.67392367e+00 -1.16377015e+00 -2.37587897e-01 -2.37587897e-01
 -2.37587897e-01  1.00769152e+01  1.09874190e+02  6.04373708e+02
  2.74402610e+03  1.22232156e+04  4.08447396e+04  1.04888392e+05
  2.30071844e+05  4.55886790e+05  8.44839055e+05  1.52801633e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.7009218586103  E_coul = 198.75588935727924
cycle= 3 E= -507.945032501331  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00874
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000740058
diis-c [-1.27007852e-08  3.77291217e-05 -5.00668727e-02  1.05002914e+00]
  HOMO = -0.237814696034631  LUMO = 10.0763723108505
  mo_energy =
[-1.20316934e+02 -1.23748267e+01 -6.67528226e+00 -6.67528226e+00
 -6.67528226e+00 -1.16388083e+00 -2.37814696e-01 -2.37814696e-01
 -2.37814696e-01  1.00763723e+01  1.09872166e+02  6.04371032e+02
  2.74402305e+03  1.22232123e+04  4.08447363e+04  1.04888389e+05
  2.30071840e+05  4.55886786e+05  8.44839051e+05  1.52801632e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.7001836660029  E_coul = 198.7551511344073
cycle= 4 E= -507.945032531596  delta_E= -3.03e-08  |g|= 6.28e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.47598e-06
diis-c [-4.72866764e-12 -1.76702897e-06  2.30596510e-03 -4.58246649e-02
  1.04352047e+00]
  HOMO = -0.237815451835732  LUMO = 10.0763715396222
  mo_energy =
[-1.20316932e+02 -1.23748292e+01 -6.67528386e+00 -6.67528386e+00
 -6.67528386e+00 -1.16388126e+00 -2.37815452e-01 -2.37815452e-01
 -2.37815452e-01  1.00763715e+01  1.09872167e+02  6.04371035e+02
  2.74402306e+03  1.22232123e+04  4.08447363e+04  1.04888389e+05
  2.30071840e+05  4.55886786e+05  8.44839051e+05  1.52801632e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.7001825425812  E_coul = 198.7551500109842
cycle= 5 E= -507.945032531597  delta_E= -1.36e-12  |g|= 1.41e-07  |ddm|= 2.18e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7001825425812  E_coul = 198.7551500109842
  HOMO = -0.237815485925161  LUMO = 10.0763714698794
  mo_energy =
[-1.20316932e+02 -1.23748294e+01 -6.67528403e+00 -6.67528403e+00
 -6.67528403e+00 -1.16388128e+00 -2.37815486e-01 -2.37815486e-01
 -2.37815486e-01  1.00763715e+01  1.09872166e+02  6.04371035e+02
  2.74402306e+03  1.22232123e+04  4.08447363e+04  1.04888389e+05
  2.30071840e+05  4.55886786e+05  8.44839051e+05  1.52801632e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.7001824492086  E_coul = 198.75514991761187
Extra cycle  E= -507.945032531597  delta_E= 2.84e-13  |g|= 7.27e-09  |ddm|= 7.26e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.09 sec
exp = [1.17616814e+05 3.96631390e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547200e+04
 7.30347580e+03 1.83758102e+04 1.44974918e+03 3.74024988e+02
 1.13258991e+02 3.77423029e+01 8.08783347e+00 3.20394037e+00
 8.60387590e+00 4.93004400e-01]
E = -507.94503253159667
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:35:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.396631390333       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209716        1
[INPUT] 0    0    [1    /1   ]  36754.7200463        1
[INPUT] 0    0    [1    /1   ]  7303.4757965         1
[INPUT] 0    0    [1    /1   ]  18375.8102124        1
[INPUT] 0    0    [1    /1   ]  1449.74918274        1
[INPUT] 0    0    [1    /1   ]  374.024987601        1
[INPUT] 0    0    [1    /1   ]  113.258990685        1
[INPUT] 0    0    [1    /1   ]  37.7423028801        1
[INPUT] 0    0    [1    /1   ]  8.0878334711         1
[INPUT] 0    0    [1    /1   ]  3.20394036952        1
[INPUT] 1    0    [1    /1   ]  8.60387590146        1
[INPUT] 1    0    [1    /1   ]  0.49300439993        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81424220605, 1.0]], [0, [0.39663139033263906, 1.0]], [0, [1176168.1426188888, 1.0]], [0, [588084.0699925747, 1.0]], [0, [294042.0311319446, 1.0]], [0, [147020.99214802458, 1.0]], [0, [73510.42097156998, 1.0]], [0, [36754.72004629316, 1.0]], [0, [7303.475796495015, 1.0]], [0, [18375.810212447803, 1.0]], [0, [1449.7491827414703, 1.0]], [0, [374.02498760080744, 1.0]], [0, [113.25899068525139, 1.0]], [0, [37.74230288014117, 1.0]], [0, [8.087833471100874, 1.0]], [0, [3.203940369521719, 1.0]], [1, [8.603875901455677, 1.0]], [1, [0.4930043999300832, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.81424221]
bas 1, expnt(s) = [0.39663139]
bas 2, expnt(s) = [1176168.14261889]
bas 3, expnt(s) = [588084.06999257]
bas 4, expnt(s) = [294042.03113194]
bas 5, expnt(s) = [147020.99214802]
bas 6, expnt(s) = [73510.42097157]
bas 7, expnt(s) = [36754.72004629]
bas 8, expnt(s) = [7303.4757965]
bas 9, expnt(s) = [18375.81021245]
bas 10, expnt(s) = [1449.74918274]
bas 11, expnt(s) = [374.0249876]
bas 12, expnt(s) = [113.25899069]
bas 13, expnt(s) = [37.74230288]
bas 14, expnt(s) = [8.08783347]
bas 15, expnt(s) = [3.20394037]
bas 16, expnt(s) = [8.6038759]
bas 17, expnt(s) = [0.4930044]
CPU time:       251.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96631390e-01 1.26271499e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547200e+04 6.70656076e+03
 7.30347580e+03 1.99600774e+03 1.83758102e+04 3.98749266e+03
 1.44974918e+03 5.93587407e+02 3.74024988e+02 2.14877275e+02
 1.13258991e+02 8.77141258e+01 3.77423029e+01 3.84712521e+01
 8.08783347e+00 1.21168345e+01 3.20394037e+00 6.05031997e+00
 8.60387590e+00 4.29884775e+01 4.93004400e-01 1.20516882e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32510185065949
cond(S) = 907703.5014384832
E1 = -689.3976643105568  E_coul = 184.91168233665482
init E= -504.485981973902
    CPU time for initialize scf      4.77 sec, wall time      0.33 sec
  HOMO = -0.674713746148399  LUMO = 9.17882167758427
  mo_energy =
[-1.21707194e+02 -1.33875147e+01 -7.62807333e+00 -7.62807333e+00
 -7.62807333e+00 -1.64018386e+00 -6.74713746e-01 -6.74713746e-01
 -6.74713746e-01  9.17882168e+00  1.08568643e+02  6.02998289e+02
  2.74272892e+03  1.22220380e+04  4.08436324e+04  1.04887323e+05
  2.30070800e+05  4.55885763e+05  8.44838042e+05  1.52801533e+06
  2.85028274e+06  5.80817005e+06]
E1 = -707.0698190477624  E_coul = 199.1311912325594
cycle= 1 E= -507.938627815203  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.602159
diis-c [-0.36259581  1.        ]
  HOMO = -0.233124888948389  LUMO = 10.0878396407282
  mo_energy =
[-1.20256497e+02 -1.23513006e+01 -6.64603678e+00 -6.64603678e+00
 -6.64603678e+00 -1.16150142e+00 -2.33124889e-01 -2.33124889e-01
 -2.33124889e-01  1.00878396e+01  1.09917676e+02  6.04434847e+02
  2.74410009e+03  1.22232978e+04  4.08448249e+04  1.04888479e+05
  2.30071931e+05  4.55886877e+05  8.44839142e+05  1.52801641e+06
  2.85028382e+06  5.80817112e+06]
E1 = -706.7155980032824  E_coul = 198.77057760512983
cycle= 2 E= -507.945020398153  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152577
diis-c [-2.24200711e-04  4.84683903e-03  9.95153161e-01]
  HOMO = -0.237587896778829  LUMO = 10.0769152292386
  mo_energy =
[-1.20314332e+02 -1.23737154e+01 -6.67392367e+00 -6.67392367e+00
 -6.67392367e+00 -1.16377015e+00 -2.37587897e-01 -2.37587897e-01
 -2.37587897e-01  1.00769152e+01  1.09874190e+02  6.04373708e+02
  2.74402610e+03  1.22232156e+04  4.08447396e+04  1.04888392e+05
  2.30071844e+05  4.55886790e+05  8.44839055e+05  1.52801633e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.7009218586103  E_coul = 198.75588935727924
cycle= 3 E= -507.945032501331  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00874
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000740058
diis-c [-1.27007852e-08  3.77291217e-05 -5.00668727e-02  1.05002914e+00]
  HOMO = -0.237814696034631  LUMO = 10.0763723108505
  mo_energy =
[-1.20316934e+02 -1.23748267e+01 -6.67528226e+00 -6.67528226e+00
 -6.67528226e+00 -1.16388083e+00 -2.37814696e-01 -2.37814696e-01
 -2.37814696e-01  1.00763723e+01  1.09872166e+02  6.04371032e+02
  2.74402305e+03  1.22232123e+04  4.08447363e+04  1.04888389e+05
  2.30071840e+05  4.55886786e+05  8.44839051e+05  1.52801632e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.7001836660029  E_coul = 198.7551511344073
cycle= 4 E= -507.945032531596  delta_E= -3.03e-08  |g|= 6.28e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.47598e-06
diis-c [-4.72866764e-12 -1.76702897e-06  2.30596510e-03 -4.58246649e-02
  1.04352047e+00]
  HOMO = -0.237815451835732  LUMO = 10.0763715396222
  mo_energy =
[-1.20316932e+02 -1.23748292e+01 -6.67528386e+00 -6.67528386e+00
 -6.67528386e+00 -1.16388126e+00 -2.37815452e-01 -2.37815452e-01
 -2.37815452e-01  1.00763715e+01  1.09872167e+02  6.04371035e+02
  2.74402306e+03  1.22232123e+04  4.08447363e+04  1.04888389e+05
  2.30071840e+05  4.55886786e+05  8.44839051e+05  1.52801632e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.7001825425812  E_coul = 198.7551500109842
cycle= 5 E= -507.945032531597  delta_E= -1.36e-12  |g|= 1.41e-07  |ddm|= 2.18e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7001825425812  E_coul = 198.7551500109842
  HOMO = -0.237815485925161  LUMO = 10.0763714698794
  mo_energy =
[-1.20316932e+02 -1.23748294e+01 -6.67528403e+00 -6.67528403e+00
 -6.67528403e+00 -1.16388128e+00 -2.37815486e-01 -2.37815486e-01
 -2.37815486e-01  1.00763715e+01  1.09872166e+02  6.04371035e+02
  2.74402306e+03  1.22232123e+04  4.08447363e+04  1.04888389e+05
  2.30071840e+05  4.55886786e+05  8.44839051e+05  1.52801632e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.7001824492086  E_coul = 198.75514991761187
Extra cycle  E= -507.945032531597  delta_E= 2.84e-13  |g|= 7.27e-09  |ddm|= 7.26e-08
    CPU time for scf_cycle      5.04 sec, wall time      0.40 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907703.5014384832
E1 = -706.7001824492086  E_coul = 198.75514991761187
init E= -507.945032531597
    CPU time for initialize scf      9.85 sec, wall time      0.66 sec
  HOMO = -0.237815487534137  LUMO = 10.076371466783
  mo_energy =
[-1.20316932e+02 -1.23748294e+01 -6.67528404e+00 -6.67528404e+00
 -6.67528404e+00 -1.16388128e+00 -2.37815488e-01 -2.37815488e-01
 -2.37815488e-01  1.00763715e+01  1.09872166e+02  6.04371035e+02
  2.74402306e+03  1.22232123e+04  4.08447363e+04  1.04888389e+05
  2.30071840e+05  4.55886786e+05  8.44839051e+05  1.52801632e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.7001824449906  E_coul = 198.75514991339358
cycle= 1 E= -507.945032531597  delta_E= -3.41e-13  |g|= 1.6e-09  |ddm|= 3.59e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
E1 = -706.7001824449906  E_coul = 198.75514991339358
  HOMO = -0.237815487612719  LUMO = 10.0763714666406
  mo_energy =
[-1.20316932e+02 -1.23748294e+01 -6.67528404e+00 -6.67528404e+00
 -6.67528404e+00 -1.16388128e+00 -2.37815488e-01 -2.37815488e-01
 -2.37815488e-01  1.00763715e+01  1.09872166e+02  6.04371035e+02
  2.74402306e+03  1.22232123e+04  4.08447363e+04  1.04888389e+05
  2.30071840e+05  4.55886786e+05  8.44839051e+05  1.52801632e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.700182444793  E_coul = 198.75514991319608
Extra cycle  E= -507.945032531597  delta_E= 1.14e-13  |g|= 9.7e-10  |ddm|= 1.83e-10
    CPU time for scf_cycle     10.05 sec, wall time      0.73 sec
exp = [1.17616814e+05 3.96631390e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547200e+04
 7.30347580e+03 1.83758102e+04 1.44974918e+03 3.74024988e+02
 1.13258991e+02 3.77423029e+01 8.08783347e+00 3.20394037e+00
 8.60387590e+00 4.93004400e-01]
grad_E = [ 4.18140363e-09 -1.23209749e-05  1.87475387e-11  1.12742714e-10
  6.50560379e-10  2.55128271e-09  1.05992419e-08  5.70197650e-08
  3.58677500e-06  1.22596674e-07  5.16323824e-06 -5.19425849e-06
 -7.23587925e-06 -2.69836730e-06 -3.31106164e-06 -1.50561574e-06
 -1.48164844e-07 -5.26957647e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:35:19 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.396631974108       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209718        1
[INPUT] 0    0    [1    /1   ]  36754.7200476        1
[INPUT] 0    0    [1    /1   ]  7303.47587861        1
[INPUT] 0    0    [1    /1   ]  18375.8102153        1
[INPUT] 0    0    [1    /1   ]  1449.74931763        1
[INPUT] 0    0    [1    /1   ]  374.024707475        1
[INPUT] 0    0    [1    /1   ]  113.259219932        1
[INPUT] 0    0    [1    /1   ]  37.7424207264        1
[INPUT] 0    0    [1    /1   ]  8.08823972185        1
[INPUT] 0    0    [1    /1   ]  3.20405714575        1
[INPUT] 1    0    [1    /1   ]  8.60387754696        1
[INPUT] 1    0    [1    /1   ]  0.493005957038       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81424230179, 1.0]], [0, [0.39663197410767775, 1.0]], [0, [1176168.1426188892, 1.0]], [0, [588084.0699925773, 1.0]], [0, [294042.0311319595, 1.0]], [0, [147020.992148083, 1.0]], [0, [73510.42097181265, 1.0]], [0, [36754.72004759903, 1.0]], [0, [7303.475878606781, 1.0]], [0, [18375.810215251393, 1.0]], [0, [1449.7493176266319, 1.0]], [0, [374.0247074754365, 1.0]], [0, [113.25921993227522, 1.0]], [0, [37.74242072635985, 1.0]], [0, [8.088239721852286, 1.0]], [0, [3.20405714574995, 1.0]], [1, [8.60387754696007, 1.0]], [1, [0.49300595703824823, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.8142423]
bas 1, expnt(s) = [0.39663197]
bas 2, expnt(s) = [1176168.14261889]
bas 3, expnt(s) = [588084.06999258]
bas 4, expnt(s) = [294042.03113196]
bas 5, expnt(s) = [147020.99214808]
bas 6, expnt(s) = [73510.42097181]
bas 7, expnt(s) = [36754.7200476]
bas 8, expnt(s) = [7303.47587861]
bas 9, expnt(s) = [18375.81021525]
bas 10, expnt(s) = [1449.74931763]
bas 11, expnt(s) = [374.02470748]
bas 12, expnt(s) = [113.25921993]
bas 13, expnt(s) = [37.74242073]
bas 14, expnt(s) = [8.08823972]
bas 15, expnt(s) = [3.20405715]
bas 16, expnt(s) = [8.60387755]
bas 17, expnt(s) = [0.49300596]
CPU time:       269.32
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96631974e-01 1.26271638e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547200e+04 6.70656076e+03
 7.30347588e+03 1.99600775e+03 1.83758102e+04 3.98749266e+03
 1.44974932e+03 5.93587448e+02 3.74024707e+02 2.14877154e+02
 1.13259220e+02 8.77142590e+01 3.77424207e+01 3.84713422e+01
 8.08823972e+00 1.21172909e+01 3.20405715e+00 6.05048536e+00
 8.60387755e+00 4.29884878e+01 4.93005957e-01 1.20517358e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325099620247602
cond(S) = 907703.5325409832
E1 = -689.3977325385955  E_coul = 184.9117399928179
init E= -504.485992545778
    CPU time for initialize scf      4.83 sec, wall time      0.34 sec
  HOMO = -0.674711795929827  LUMO = 9.17955745156788
  mo_energy =
[-1.21707189e+02 -1.33875094e+01 -7.62806986e+00 -7.62806986e+00
 -7.62806986e+00 -1.64018271e+00 -6.74711796e-01 -6.74711796e-01
 -6.74711796e-01  9.17955745e+00  1.08571113e+02  6.03001121e+02
  2.74273128e+03  1.22220402e+04  4.08436346e+04  1.04887325e+05
  2.30070802e+05  4.55885765e+05  8.44838044e+05  1.52801533e+06
  2.85028274e+06  5.80817005e+06]
E1 = -707.0699067427846  E_coul = 199.13127847017648
cycle= 1 E= -507.938628272608  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.60216
diis-c [-0.36259614  1.        ]
  HOMO = -0.233121213518593  LUMO = 10.0885959764113
  mo_energy =
[-1.20256489e+02 -1.23512935e+01 -6.64603171e+00 -6.64603171e+00
 -6.64603171e+00 -1.16149895e+00 -2.33121214e-01 -2.33121214e-01
 -2.33121214e-01  1.00885960e+01  1.09920149e+02  6.04437681e+02
  2.74410246e+03  1.22233000e+04  4.08448271e+04  1.04888481e+05
  2.30071933e+05  4.55886879e+05  8.44839145e+05  1.52801642e+06
  2.85028382e+06  5.80817112e+06]
E1 = -706.7157080326261  E_coul = 198.77068763183163
cycle= 2 E= -507.945020400795  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152575
diis-c [-2.24195741e-04  4.84670036e-03  9.95153300e-01]
  HOMO = -0.23758381275375  LUMO = 10.077671875715
  mo_energy =
[-1.20314322e+02 -1.23737066e+01 -6.67391674e+00 -6.67391674e+00
 -6.67391674e+00 -1.16376744e+00 -2.37583813e-01 -2.37583813e-01
 -2.37583813e-01  1.00776719e+01  1.09876665e+02  6.04376544e+02
  2.74402848e+03  1.22232178e+04  4.08447418e+04  1.04888394e+05
  2.30071846e+05  4.55886792e+05  8.44839057e+05  1.52801633e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.7010334172404  E_coul = 198.7560009152284
cycle= 3 E= -507.945032502012  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00874
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000740033
diis-c [-1.26956865e-08  3.77229657e-05 -5.00659714e-02  1.05002825e+00]
  HOMO = -0.237810580681431  LUMO = 10.0771289973045
  mo_energy =
[-1.20316923e+02 -1.23748178e+01 -6.67527517e+00 -6.67527517e+00
 -6.67527517e+00 -1.16387810e+00 -2.37810581e-01 -2.37810581e-01
 -2.37810581e-01  1.00771290e+01  1.09874641e+02  6.04373869e+02
  2.74402542e+03  1.22232145e+04  4.08447385e+04  1.04888391e+05
  2.30071842e+05  4.55886788e+05  8.44839053e+05  1.52801633e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.7002953340939  E_coul = 198.75526280182515
cycle= 4 E= -507.945032532269  delta_E= -3.03e-08  |g|= 6.28e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.4747e-06
diis-c [-4.72753373e-12 -1.76716040e-06  2.30567548e-03 -4.58189470e-02
  1.04351504e+00]
  HOMO = -0.237811335998494  LUMO = 10.0771282269192
  mo_energy =
[-1.20316921e+02 -1.23748203e+01 -6.67527677e+00 -6.67527677e+00
 -6.67527677e+00 -1.16387853e+00 -2.37811336e-01 -2.37811336e-01
 -2.37811336e-01  1.00771282e+01  1.09874641e+02  6.04373872e+02
  2.74402543e+03  1.22232145e+04  4.08447385e+04  1.04888391e+05
  2.30071842e+05  4.55886788e+05  8.44839053e+05  1.52801633e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.7002942119142  E_coul = 198.7552616796446
cycle= 5 E= -507.94503253227  delta_E= -8.53e-13  |g|= 1.41e-07  |ddm|= 2.18e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7002942119142  E_coul = 198.7552616796446
  HOMO = -0.237811370083256  LUMO = 10.0771281571808
  mo_energy =
[-1.20316921e+02 -1.23748205e+01 -6.67527695e+00 -6.67527695e+00
 -6.67527695e+00 -1.16387855e+00 -2.37811370e-01 -2.37811370e-01
 -2.37811370e-01  1.00771282e+01  1.09874641e+02  6.04373872e+02
  2.74402543e+03  1.22232145e+04  4.08447385e+04  1.04888391e+05
  2.30071842e+05  4.55886788e+05  8.44839053e+05  1.52801633e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.7002941185599  E_coul = 198.75526158628963
Extra cycle  E= -507.94503253227  delta_E= -6.82e-13  |g|= 7.42e-09  |ddm|= 7.26e-08
    CPU time for scf_cycle      5.10 sec, wall time      0.41 sec
exp = [1.17616814e+05 3.96631974e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547200e+04
 7.30347588e+03 1.83758102e+04 1.44974932e+03 3.74024707e+02
 1.13259220e+02 3.77424207e+01 8.08823972e+00 3.20405715e+00
 8.60387755e+00 4.93005957e-01]
E = -507.94503253227026
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -507.94503253227026
       x: [ 1.176e+05  3.966e-01 ...  8.604e+00  4.930e-01]
     nit: 28
     jac: [ 4.181e-09 -1.232e-05 ... -1.482e-07 -5.270e-05]
    nfev: 31
    njev: 28
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((18, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 0.0000001
exps[0, 0] = np.max(exps_old) * 0.1

basis = "16s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11253.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:35:20 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632771.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.396631974108       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209718        1
[INPUT] 0    0    [1    /1   ]  36754.7200476        1
[INPUT] 0    0    [1    /1   ]  7303.47587861        1
[INPUT] 0    0    [1    /1   ]  18375.8102153        1
[INPUT] 0    0    [1    /1   ]  1449.74931763        1
[INPUT] 0    0    [1    /1   ]  374.024707475        1
[INPUT] 0    0    [1    /1   ]  113.259219932        1
[INPUT] 0    0    [1    /1   ]  37.7424207264        1
[INPUT] 0    0    [1    /1   ]  8.08823972185        1
[INPUT] 0    0    [1    /1   ]  3.20405714575        1
[INPUT] 1    0    [1    /1   ]  8.60387754696        1
[INPUT] 1    0    [1    /1   ]  0.493005957038       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 22
number of NR cGTOs = 22
basis = {'Ar': [[0, [117616.81424230179, 1.0]], [0, [0.39663197410767775, 1.0]], [0, [1176168.1426188892, 1.0]], [0, [588084.0699925773, 1.0]], [0, [294042.0311319595, 1.0]], [0, [147020.992148083, 1.0]], [0, [73510.42097181265, 1.0]], [0, [36754.72004759903, 1.0]], [0, [7303.475878606781, 1.0]], [0, [18375.810215251393, 1.0]], [0, [1449.7493176266319, 1.0]], [0, [374.0247074754365, 1.0]], [0, [113.25921993227522, 1.0]], [0, [37.74242072635985, 1.0]], [0, [8.088239721852286, 1.0]], [0, [3.20405714574995, 1.0]], [1, [8.60387754696007, 1.0]], [1, [0.49300595703824823, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [117616.8142423]
bas 1, expnt(s) = [0.39663197]
bas 2, expnt(s) = [1176168.14261889]
bas 3, expnt(s) = [588084.06999258]
bas 4, expnt(s) = [294042.03113196]
bas 5, expnt(s) = [147020.99214808]
bas 6, expnt(s) = [73510.42097181]
bas 7, expnt(s) = [36754.7200476]
bas 8, expnt(s) = [7303.47587861]
bas 9, expnt(s) = [18375.81021525]
bas 10, expnt(s) = [1449.74931763]
bas 11, expnt(s) = [374.02470748]
bas 12, expnt(s) = [113.25921993]
bas 13, expnt(s) = [37.74242073]
bas 14, expnt(s) = [8.08823972]
bas 15, expnt(s) = [3.20405715]
bas 16, expnt(s) = [8.60387755]
bas 17, expnt(s) = [0.49300596]
CPU time:       274.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e+05 1.60460109e+04 3.96631974e-01 1.26271638e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104210e+04 1.12791587e+04 3.67547200e+04 6.70656076e+03
 7.30347588e+03 1.99600775e+03 1.83758102e+04 3.98749266e+03
 1.44974932e+03 5.93587448e+02 3.74024707e+02 2.14877154e+02
 1.13259220e+02 8.77142590e+01 3.77424207e+01 3.84713422e+01
 8.08823972e+00 1.21172909e+01 3.20405715e+00 6.05048536e+00
 8.60387755e+00 4.29884878e+01 4.93005957e-01 1.20517358e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325099620247602
cond(S) = 907703.5325409832
E1 = -689.3977325385955  E_coul = 184.9117399928179
init E= -504.485992545778
    CPU time for initialize scf      4.59 sec, wall time      0.32 sec
  HOMO = -0.674711795929827  LUMO = 9.17955745156788
  mo_energy =
[-1.21707189e+02 -1.33875094e+01 -7.62806986e+00 -7.62806986e+00
 -7.62806986e+00 -1.64018271e+00 -6.74711796e-01 -6.74711796e-01
 -6.74711796e-01  9.17955745e+00  1.08571113e+02  6.03001121e+02
  2.74273128e+03  1.22220402e+04  4.08436346e+04  1.04887325e+05
  2.30070802e+05  4.55885765e+05  8.44838044e+05  1.52801533e+06
  2.85028274e+06  5.80817005e+06]
E1 = -707.0699067427846  E_coul = 199.13127847017648
cycle= 1 E= -507.938628272608  delta_E= -3.45  |g|= 0.442  |ddm|= 0.387
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.60216
diis-c [-0.36259614  1.        ]
  HOMO = -0.233121213518593  LUMO = 10.0885959764113
  mo_energy =
[-1.20256489e+02 -1.23512935e+01 -6.64603171e+00 -6.64603171e+00
 -6.64603171e+00 -1.16149895e+00 -2.33121214e-01 -2.33121214e-01
 -2.33121214e-01  1.00885960e+01  1.09920149e+02  6.04437681e+02
  2.74410246e+03  1.22233000e+04  4.08448271e+04  1.04888481e+05
  2.30071933e+05  4.55886879e+05  8.44839145e+05  1.52801642e+06
  2.85028382e+06  5.80817112e+06]
E1 = -706.7157080326261  E_coul = 198.77068763183163
cycle= 2 E= -507.945020400795  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152575
diis-c [-2.24195741e-04  4.84670036e-03  9.95153300e-01]
  HOMO = -0.23758381275375  LUMO = 10.077671875715
  mo_energy =
[-1.20314322e+02 -1.23737066e+01 -6.67391674e+00 -6.67391674e+00
 -6.67391674e+00 -1.16376744e+00 -2.37583813e-01 -2.37583813e-01
 -2.37583813e-01  1.00776719e+01  1.09876665e+02  6.04376544e+02
  2.74402848e+03  1.22232178e+04  4.08447418e+04  1.04888394e+05
  2.30071846e+05  4.55886792e+05  8.44839057e+05  1.52801633e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.7010334172404  E_coul = 198.7560009152284
cycle= 3 E= -507.945032502012  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00874
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000740033
diis-c [-1.26956865e-08  3.77229657e-05 -5.00659714e-02  1.05002825e+00]
  HOMO = -0.237810580681431  LUMO = 10.0771289973045
  mo_energy =
[-1.20316923e+02 -1.23748178e+01 -6.67527517e+00 -6.67527517e+00
 -6.67527517e+00 -1.16387810e+00 -2.37810581e-01 -2.37810581e-01
 -2.37810581e-01  1.00771290e+01  1.09874641e+02  6.04373869e+02
  2.74402542e+03  1.22232145e+04  4.08447385e+04  1.04888391e+05
  2.30071842e+05  4.55886788e+05  8.44839053e+05  1.52801633e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.7002953340939  E_coul = 198.75526280182515
cycle= 4 E= -507.945032532269  delta_E= -3.03e-08  |g|= 6.28e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.4747e-06
diis-c [-4.72753373e-12 -1.76716040e-06  2.30567548e-03 -4.58189470e-02
  1.04351504e+00]
  HOMO = -0.237811335998494  LUMO = 10.0771282269192
  mo_energy =
[-1.20316921e+02 -1.23748203e+01 -6.67527677e+00 -6.67527677e+00
 -6.67527677e+00 -1.16387853e+00 -2.37811336e-01 -2.37811336e-01
 -2.37811336e-01  1.00771282e+01  1.09874641e+02  6.04373872e+02
  2.74402543e+03  1.22232145e+04  4.08447385e+04  1.04888391e+05
  2.30071842e+05  4.55886788e+05  8.44839053e+05  1.52801633e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.7002942119142  E_coul = 198.7552616796446
cycle= 5 E= -507.94503253227  delta_E= -8.53e-13  |g|= 1.41e-07  |ddm|= 2.18e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7002942119142  E_coul = 198.7552616796446
  HOMO = -0.237811370083256  LUMO = 10.0771281571808
  mo_energy =
[-1.20316921e+02 -1.23748205e+01 -6.67527695e+00 -6.67527695e+00
 -6.67527695e+00 -1.16387855e+00 -2.37811370e-01 -2.37811370e-01
 -2.37811370e-01  1.00771282e+01  1.09874641e+02  6.04373872e+02
  2.74402543e+03  1.22232145e+04  4.08447385e+04  1.04888391e+05
  2.30071842e+05  4.55886788e+05  8.44839053e+05  1.52801633e+06
  2.85028373e+06  5.80817103e+06]
E1 = -706.7002941185599  E_coul = 198.75526158628963
Extra cycle  E= -507.94503253227  delta_E= -6.82e-13  |g|= 7.42e-09  |ddm|= 7.26e-08
    CPU time for scf_cycle      4.86 sec, wall time      0.39 sec
exp = [1.17616814e+05 3.96631974e-01 1.17616814e+06 5.88084070e+05
 2.94042031e+05 1.47020992e+05 7.35104210e+04 3.67547200e+04
 7.30347588e+03 1.83758102e+04 1.44974932e+03 3.74024707e+02
 1.13259220e+02 3.77424207e+01 8.08823972e+00 3.20405715e+00
 8.60387755e+00 4.93005957e-01]
E = -507.94503253227026
E = -507.94503253227026
exp = [1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01]
