created virtual environment CPython3.10.2.final.0-64 in 538ms
  creator CPython3Posix(dest=/localscratch/nike.35633237.0/ENV, clear=True, no_vcs_ignore=False, global=False)
  seeder FromAppData(download=False, pip=bundle, setuptools=bundle, wheel=bundle, via=copy, app_data_dir=/home/nike/.local/share/virtualenv)
    added seed packages: pip==22.3.1, setuptools==67.3.3, wheel==0.38.4+computecanada
  activators BashActivator,CShellActivator,FishActivator,NushellActivator,PowerShellActivator,PythonActivator
Looking in links: /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx512, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic
Requirement already satisfied: pip in /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages (22.3.1)
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pip-23.0+computecanada-py3-none-any.whl
Installing collected packages: pip
  Attempting uninstall: pip
    Found existing installation: pip 22.3.1
    Uninstalling pip-22.3.1:
      Successfully uninstalled pip-22.3.1
Successfully installed pip-23.0+computecanada
Looking in links: /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx512, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic
Processing /home/nike/pyscf_ad/dist/pyscf-2.1.1+ad-cp310-cp310-linux_x86_64.whl
Processing /home/nike/properties_ad/dist/pyscf_properties-0.1.0+ad-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/absl_py-1.4.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/contourpy-1.0.7+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/cycler-0.11.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/fonttools-4.39.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/h5py-3.8.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/jax-0.4.2+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/jaxlib-0.4.2+cuda11.cudnn82.computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/jaxopt-0.6+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/kiwisolver-1.4.4+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/matplotlib-3.7.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/numpy-1.24.2+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/opt_einsum-3.3.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/packaging-23.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/Pillow-9.4.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pyparsing-3.0.9+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pyscfad-0.1.2+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/python_dateutil-2.8.2+computecanada-py2.py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/scipy-1.10.1+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/six-1.16.0+computecanada-py2.py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/typing_extensions-4.5.0+computecanada-py3-none-any.whl
Installing collected packages: typing_extensions, six, pyparsing, Pillow, packaging, numpy, kiwisolver, fonttools, cycler, absl_py, scipy, python-dateutil, opt-einsum, h5py, contourpy, pyscf, matplotlib, jaxlib, pyscf-properties, jax, jaxopt, pyscfad
Successfully installed Pillow-9.4.0+computecanada absl_py-1.4.0+computecanada contourpy-1.0.7+computecanada cycler-0.11.0+computecanada fonttools-4.39.0+computecanada h5py-3.8.0+computecanada jax-0.4.2+computecanada jaxlib-0.4.2+cuda11.cudnn82.computecanada jaxopt-0.6+computecanada kiwisolver-1.4.4+computecanada matplotlib-3.7.0+computecanada numpy-1.24.2+computecanada opt-einsum-3.3.0+computecanada packaging-23.0+computecanada pyparsing-3.0.9+computecanada pyscf-2.1.1+ad pyscf-properties-0.1.0+ad pyscfad-0.1.2+computecanada python-dateutil-2.8.2+computecanada scipy-1.10.1+computecanada six-1.16.0+computecanada typing_extensions-4.5.0+computecanada
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.0396631974108      1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.396631974108       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209718        1
[INPUT] 0    0    [1    /1   ]  36754.7200476        1
[INPUT] 0    0    [1    /1   ]  7303.47587861        1
[INPUT] 0    0    [1    /1   ]  18375.8102153        1
[INPUT] 0    0    [1    /1   ]  1449.74931763        1
[INPUT] 0    0    [1    /1   ]  374.024707475        1
[INPUT] 0    0    [1    /1   ]  113.259219932        1
[INPUT] 0    0    [1    /1   ]  37.7424207264        1
[INPUT] 0    0    [1    /1   ]  8.08823972185        1
[INPUT] 0    0    [1    /1   ]  3.20405714575        1
[INPUT] 1    0    [1    /1   ]  8.60387754696        1
[INPUT] 1    0    [1    /1   ]  0.493005957038       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.03966319741076778, 1.0]], [0, [117616.81424230179, 1.0]], [0, [0.39663197410767775, 1.0]], [0, [1176168.1426188892, 1.0]], [0, [588084.0699925773, 1.0]], [0, [294042.0311319595, 1.0]], [0, [147020.992148083, 1.0]], [0, [73510.42097181265, 1.0]], [0, [36754.72004759903, 1.0]], [0, [7303.475878606781, 1.0]], [0, [18375.810215251393, 1.0]], [0, [1449.7493176266319, 1.0]], [0, [374.0247074754365, 1.0]], [0, [113.25921993227522, 1.0]], [0, [37.74242072635985, 1.0]], [0, [8.088239721852286, 1.0]], [0, [3.20405714574995, 1.0]], [1, [8.60387754696007, 1.0]], [1, [0.49300595703824823, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.0396632]
bas 1, expnt(s) = [117616.8142423]
bas 2, expnt(s) = [0.39663197]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113196]
bas 6, expnt(s) = [147020.99214808]
bas 7, expnt(s) = [73510.42097181]
bas 8, expnt(s) = [36754.7200476]
bas 9, expnt(s) = [7303.47587861]
bas 10, expnt(s) = [18375.81021525]
bas 11, expnt(s) = [1449.74931763]
bas 12, expnt(s) = [374.02470748]
bas 13, expnt(s) = [113.25921993]
bas 14, expnt(s) = [37.74242073]
bas 15, expnt(s) = [8.08823972]
bas 16, expnt(s) = [3.20405715]
bas 17, expnt(s) = [8.60387755]
bas 18, expnt(s) = [0.49300596]
CPU time:         1.36
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96631974e-02 2.24546255e-01 1.17616814e+05 1.60460109e+04
 3.96631974e-01 1.26271638e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347588e+03 1.99600775e+03
 1.83758102e+04 3.98749266e+03 1.44974932e+03 5.93587448e+02
 3.74024707e+02 2.14877154e+02 1.13259220e+02 8.77142590e+01
 3.77424207e+01 3.84713422e+01 8.08823972e+00 1.21172909e+01
 3.20405715e+00 6.05048536e+00 8.60387755e+00 4.29884878e+01
 4.93005957e-01 1.20517358e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32989590326157
cond(S) = 907704.5424149107
E1 = -689.2784312055323  E_coul = 184.81549592707955
init E= -504.462935278453
    CPU time for initialize scf      0.79 sec, wall time      0.19 sec
  HOMO = -0.678599575783965  LUMO = -0.0444446729796001
  mo_energy =
[-1.21714066e+02 -1.33950320e+01 -7.63523356e+00 -7.63523356e+00
 -7.63523356e+00 -1.64277395e+00 -6.78599576e-01 -6.78599576e-01
 -6.78599576e-01 -4.44446730e-02  9.30975177e+00  1.08657719e+02
  6.03067896e+02  2.74278663e+03  1.22220871e+04  4.08436774e+04
  1.04887366e+05  2.30070841e+05  4.55885804e+05  8.44838082e+05
  1.52801536e+06  2.85028278e+06  5.80817008e+06]
E1 = -706.9932095321524  E_coul = 199.05082841832206
cycle= 1 E= -507.94238111383  delta_E= -3.48  |g|= 0.447  |ddm|= 0.445
    CPU time for cycle= 1      0.28 sec, wall time      0.29 sec
diis-norm(errvec)=0.619115
diis-c [-0.38330347  1.        ]
  HOMO = -0.235689207305888  LUMO = 0.132401004299217
  mo_energy =
[-1.20263620e+02 -1.23572719e+01 -6.65203900e+00 -6.65203900e+00
 -6.65203900e+00 -1.16600024e+00 -2.35689207e-01 -2.35689207e-01
 -2.35689207e-01  1.32401004e-01  1.02188151e+01  1.10006645e+02
  6.04504137e+02  2.74415708e+03  1.22233460e+04  4.08448689e+04
  1.04888520e+05  2.30071971e+05  4.55886917e+05  8.44839181e+05
  1.52801645e+06  2.85028386e+06  5.80817115e+06]
E1 = -706.4802735368021  E_coul = 198.52859600420308
cycle= 2 E= -507.951677532599  delta_E= -0.0093  |g|= 0.0225  |ddm|= 0.217
    CPU time for cycle= 2      0.09 sec, wall time      0.10 sec
diis-norm(errvec)=0.023322
diis-c [-5.43476692e-04  1.07132937e-03  9.98928671e-01]
  HOMO = -0.24543761088451  LUMO = 0.132328615959513
  mo_energy =
[-1.20335824e+02 -1.23913953e+01 -6.69200443e+00 -6.69200443e+00
 -6.69200443e+00 -1.17175798e+00 -2.45437611e-01 -2.45437611e-01
 -2.45437611e-01  1.32328616e-01  1.01979577e+01  1.09949835e+02
  6.04428461e+02  2.74406780e+03  1.22232480e+04  4.08447677e+04
  1.04888418e+05  2.30071868e+05  4.55886813e+05  8.44839077e+05
  1.52801635e+06  2.85028375e+06  5.80817105e+06]
E1 = -706.4344253589605  E_coul = 198.48264860094824
cycle= 3 E= -507.951776758012  delta_E= -9.92e-05  |g|= 0.00251  |ddm|= 0.0245
    CPU time for cycle= 3      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.00292683
diis-c [-2.41615563e-06 -3.80511899e-04 -1.18745463e-01  1.11912598e+00]
  HOMO = -0.246833582621101  LUMO = 0.132264987646584
  mo_energy =
[-1.20341419e+02 -1.23950361e+01 -6.69595125e+00 -6.69595125e+00
 -6.69595125e+00 -1.17259292e+00 -2.46833583e-01 -2.46833583e-01
 -2.46833583e-01  1.32264988e-01  1.01952863e+01  1.09944999e+02
  6.04422772e+02  2.74406162e+03  1.22232415e+04  4.08447612e+04
  1.04888411e+05  2.30071861e+05  4.55886806e+05  8.44839071e+05
  1.52801634e+06  2.85028375e+06  5.80817104e+06]
E1 = -706.427534689628  E_coul = 198.4757552627822
cycle= 4 E= -507.951779426846  delta_E= -2.67e-06  |g|= 0.000183  |ddm|= 0.0047
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000199171
diis-c [-3.34508463e-10 -8.36503200e-06  9.83753942e-03 -1.34860810e-01
  1.12503164e+00]
  HOMO = -0.24691347648518  LUMO = 0.132258259313935
  mo_energy =
[-1.20341474e+02 -1.23951648e+01 -6.69606579e+00 -6.69606579e+00
 -6.69606579e+00 -1.17264299e+00 -2.46913476e-01 -2.46913476e-01
 -2.46913476e-01  1.32258259e-01  1.01951535e+01  1.09944916e+02
  6.04422721e+02  2.74406159e+03  1.22232415e+04  4.08447612e+04
  1.04888411e+05  2.30071861e+05  4.55886806e+05  8.44839071e+05
  1.52801634e+06  2.85028375e+06  5.80817104e+06]
E1 = -706.4271150061838  E_coul = 198.47533556589278
cycle= 5 E= -507.951779440291  delta_E= -1.34e-08  |g|= 1.1e-06  |ddm|= 0.000369
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.05971e-06
diis-c [-1.49756353e-13  3.78089079e-07 -3.79634572e-04  4.86255565e-03
 -4.19467004e-02  1.03746340e+00]
  HOMO = -0.246913635228204  LUMO = 0.13225831244963
  mo_energy =
[-1.20341475e+02 -1.23951651e+01 -6.69606627e+00 -6.69606627e+00
 -6.69606627e+00 -1.17264316e+00 -2.46913635e-01 -2.46913635e-01
 -2.46913635e-01  1.32258312e-01  1.01951531e+01  1.09944915e+02
  6.04422720e+02  2.74406159e+03  1.22232415e+04  4.08447612e+04
  1.04888411e+05  2.30071861e+05  4.55886806e+05  8.44839071e+05
  1.52801634e+06  2.85028375e+06  5.80817104e+06]
E1 = -706.4271130847376  E_coul = 198.47533364444627
cycle= 6 E= -507.951779440291  delta_E= -2.84e-13  |g|= 2.49e-08  |ddm|= 1.61e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.4271130847376  E_coul = 198.47533364444627
  HOMO = -0.246913637270955  LUMO = 0.13225830997163
  mo_energy =
[-1.20341475e+02 -1.23951651e+01 -6.69606626e+00 -6.69606626e+00
 -6.69606626e+00 -1.17264315e+00 -2.46913637e-01 -2.46913637e-01
 -2.46913637e-01  1.32258310e-01  1.01951531e+01  1.09944915e+02
  6.04422720e+02  2.74406159e+03  1.22232415e+04  4.08447612e+04
  1.04888411e+05  2.30071861e+05  4.55886806e+05  8.44839071e+05
  1.52801634e+06  2.85028375e+06  5.80817104e+06]
E1 = -706.4271130885256  E_coul = 198.4753336482342
Extra cycle  E= -507.951779440291  delta_E= -1.14e-13  |g|= 1.72e-09  |ddm|= 1.57e-08
    CPU time for scf_cycle      1.23 sec, wall time      0.63 sec
exp = [3.96631974e-02 1.17616814e+05 3.96631974e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347588e+03 1.83758102e+04 1.44974932e+03
 3.74024707e+02 1.13259220e+02 3.77424207e+01 8.08823972e+00
 3.20405715e+00 8.60387755e+00 4.93005957e-01]
E = -507.95177944029143
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.0396631974108      1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.396631974108       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209718        1
[INPUT] 0    0    [1    /1   ]  36754.7200476        1
[INPUT] 0    0    [1    /1   ]  7303.47587861        1
[INPUT] 0    0    [1    /1   ]  18375.8102153        1
[INPUT] 0    0    [1    /1   ]  1449.74931763        1
[INPUT] 0    0    [1    /1   ]  374.024707475        1
[INPUT] 0    0    [1    /1   ]  113.259219932        1
[INPUT] 0    0    [1    /1   ]  37.7424207264        1
[INPUT] 0    0    [1    /1   ]  8.08823972185        1
[INPUT] 0    0    [1    /1   ]  3.20405714575        1
[INPUT] 1    0    [1    /1   ]  8.60387754696        1
[INPUT] 1    0    [1    /1   ]  0.493005957038       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.03966319741076778, 1.0]], [0, [117616.81424230179, 1.0]], [0, [0.39663197410767775, 1.0]], [0, [1176168.1426188892, 1.0]], [0, [588084.0699925773, 1.0]], [0, [294042.0311319595, 1.0]], [0, [147020.992148083, 1.0]], [0, [73510.42097181265, 1.0]], [0, [36754.72004759903, 1.0]], [0, [7303.475878606781, 1.0]], [0, [18375.810215251393, 1.0]], [0, [1449.7493176266319, 1.0]], [0, [374.0247074754365, 1.0]], [0, [113.25921993227522, 1.0]], [0, [37.74242072635985, 1.0]], [0, [8.088239721852286, 1.0]], [0, [3.20405714574995, 1.0]], [1, [8.60387754696007, 1.0]], [1, [0.49300595703824823, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.0396632]
bas 1, expnt(s) = [117616.8142423]
bas 2, expnt(s) = [0.39663197]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113196]
bas 6, expnt(s) = [147020.99214808]
bas 7, expnt(s) = [73510.42097181]
bas 8, expnt(s) = [36754.7200476]
bas 9, expnt(s) = [7303.47587861]
bas 10, expnt(s) = [18375.81021525]
bas 11, expnt(s) = [1449.74931763]
bas 12, expnt(s) = [374.02470748]
bas 13, expnt(s) = [113.25921993]
bas 14, expnt(s) = [37.74242073]
bas 15, expnt(s) = [8.08823972]
bas 16, expnt(s) = [3.20405715]
bas 17, expnt(s) = [8.60387755]
bas 18, expnt(s) = [0.49300596]
CPU time:         2.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96631974e-02 2.24546255e-01 1.17616814e+05 1.60460109e+04
 3.96631974e-01 1.26271638e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347588e+03 1.99600775e+03
 1.83758102e+04 3.98749266e+03 1.44974932e+03 5.93587448e+02
 3.74024707e+02 2.14877154e+02 1.13259220e+02 8.77142590e+01
 3.77424207e+01 3.84713422e+01 8.08823972e+00 1.21172909e+01
 3.20405715e+00 6.05048536e+00 8.60387755e+00 4.29884878e+01
 4.93005957e-01 1.20517358e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32989590326157
cond(S) = 907704.5424149107
E1 = -689.2784312055323  E_coul = 184.81549592707955
init E= -504.462935278453
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.678599575783965  LUMO = -0.0444446729796001
  mo_energy =
[-1.21714066e+02 -1.33950320e+01 -7.63523356e+00 -7.63523356e+00
 -7.63523356e+00 -1.64277395e+00 -6.78599576e-01 -6.78599576e-01
 -6.78599576e-01 -4.44446730e-02  9.30975177e+00  1.08657719e+02
  6.03067896e+02  2.74278663e+03  1.22220871e+04  4.08436774e+04
  1.04887366e+05  2.30070841e+05  4.55885804e+05  8.44838082e+05
  1.52801536e+06  2.85028278e+06  5.80817008e+06]
E1 = -706.9932095321524  E_coul = 199.05082841832206
cycle= 1 E= -507.94238111383  delta_E= -3.48  |g|= 0.447  |ddm|= 0.445
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.619115
diis-c [-0.38330347  1.        ]
  HOMO = -0.235689207305888  LUMO = 0.132401004299217
  mo_energy =
[-1.20263620e+02 -1.23572719e+01 -6.65203900e+00 -6.65203900e+00
 -6.65203900e+00 -1.16600024e+00 -2.35689207e-01 -2.35689207e-01
 -2.35689207e-01  1.32401004e-01  1.02188151e+01  1.10006645e+02
  6.04504137e+02  2.74415708e+03  1.22233460e+04  4.08448689e+04
  1.04888520e+05  2.30071971e+05  4.55886917e+05  8.44839181e+05
  1.52801645e+06  2.85028386e+06  5.80817115e+06]
E1 = -706.4802735368021  E_coul = 198.52859600420308
cycle= 2 E= -507.951677532599  delta_E= -0.0093  |g|= 0.0225  |ddm|= 0.217
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.023322
diis-c [-5.43476692e-04  1.07132937e-03  9.98928671e-01]
  HOMO = -0.24543761088451  LUMO = 0.132328615959513
  mo_energy =
[-1.20335824e+02 -1.23913953e+01 -6.69200443e+00 -6.69200443e+00
 -6.69200443e+00 -1.17175798e+00 -2.45437611e-01 -2.45437611e-01
 -2.45437611e-01  1.32328616e-01  1.01979577e+01  1.09949835e+02
  6.04428461e+02  2.74406780e+03  1.22232480e+04  4.08447677e+04
  1.04888418e+05  2.30071868e+05  4.55886813e+05  8.44839077e+05
  1.52801635e+06  2.85028375e+06  5.80817105e+06]
E1 = -706.4344253589605  E_coul = 198.48264860094824
cycle= 3 E= -507.951776758012  delta_E= -9.92e-05  |g|= 0.00251  |ddm|= 0.0245
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292683
diis-c [-2.41615563e-06 -3.80511899e-04 -1.18745463e-01  1.11912598e+00]
  HOMO = -0.246833582621101  LUMO = 0.132264987646584
  mo_energy =
[-1.20341419e+02 -1.23950361e+01 -6.69595125e+00 -6.69595125e+00
 -6.69595125e+00 -1.17259292e+00 -2.46833583e-01 -2.46833583e-01
 -2.46833583e-01  1.32264988e-01  1.01952863e+01  1.09944999e+02
  6.04422772e+02  2.74406162e+03  1.22232415e+04  4.08447612e+04
  1.04888411e+05  2.30071861e+05  4.55886806e+05  8.44839071e+05
  1.52801634e+06  2.85028375e+06  5.80817104e+06]
E1 = -706.427534689628  E_coul = 198.4757552627822
cycle= 4 E= -507.951779426846  delta_E= -2.67e-06  |g|= 0.000183  |ddm|= 0.0047
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000199171
diis-c [-3.34508463e-10 -8.36503200e-06  9.83753942e-03 -1.34860810e-01
  1.12503164e+00]
  HOMO = -0.24691347648518  LUMO = 0.132258259313935
  mo_energy =
[-1.20341474e+02 -1.23951648e+01 -6.69606579e+00 -6.69606579e+00
 -6.69606579e+00 -1.17264299e+00 -2.46913476e-01 -2.46913476e-01
 -2.46913476e-01  1.32258259e-01  1.01951535e+01  1.09944916e+02
  6.04422721e+02  2.74406159e+03  1.22232415e+04  4.08447612e+04
  1.04888411e+05  2.30071861e+05  4.55886806e+05  8.44839071e+05
  1.52801634e+06  2.85028375e+06  5.80817104e+06]
E1 = -706.4271150061838  E_coul = 198.47533556589278
cycle= 5 E= -507.951779440291  delta_E= -1.34e-08  |g|= 1.1e-06  |ddm|= 0.000369
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.05971e-06
diis-c [-1.49756353e-13  3.78089079e-07 -3.79634572e-04  4.86255565e-03
 -4.19467004e-02  1.03746340e+00]
  HOMO = -0.246913635228204  LUMO = 0.13225831244963
  mo_energy =
[-1.20341475e+02 -1.23951651e+01 -6.69606627e+00 -6.69606627e+00
 -6.69606627e+00 -1.17264316e+00 -2.46913635e-01 -2.46913635e-01
 -2.46913635e-01  1.32258312e-01  1.01951531e+01  1.09944915e+02
  6.04422720e+02  2.74406159e+03  1.22232415e+04  4.08447612e+04
  1.04888411e+05  2.30071861e+05  4.55886806e+05  8.44839071e+05
  1.52801634e+06  2.85028375e+06  5.80817104e+06]
E1 = -706.4271130847376  E_coul = 198.47533364444627
cycle= 6 E= -507.951779440291  delta_E= -2.84e-13  |g|= 2.49e-08  |ddm|= 1.61e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.4271130847376  E_coul = 198.47533364444627
  HOMO = -0.246913637270955  LUMO = 0.13225830997163
  mo_energy =
[-1.20341475e+02 -1.23951651e+01 -6.69606626e+00 -6.69606626e+00
 -6.69606626e+00 -1.17264315e+00 -2.46913637e-01 -2.46913637e-01
 -2.46913637e-01  1.32258310e-01  1.01951531e+01  1.09944915e+02
  6.04422720e+02  2.74406159e+03  1.22232415e+04  4.08447612e+04
  1.04888411e+05  2.30071861e+05  4.55886806e+05  8.44839071e+05
  1.52801634e+06  2.85028375e+06  5.80817104e+06]
E1 = -706.4271130885256  E_coul = 198.4753336482342
Extra cycle  E= -507.951779440291  delta_E= -1.14e-13  |g|= 1.72e-09  |ddm|= 1.57e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907704.5424149107
E1 = -706.4271130885256  E_coul = 198.4753336482342
init E= -507.951779440291
    CPU time for initialize scf      3.55 sec, wall time      0.34 sec
  HOMO = -0.246913637362699  LUMO = 0.132258309725954
  mo_energy =
[-1.20341475e+02 -1.23951651e+01 -6.69606626e+00 -6.69606626e+00
 -6.69606626e+00 -1.17264315e+00 -2.46913637e-01 -2.46913637e-01
 -2.46913637e-01  1.32258310e-01  1.01951531e+01  1.09944915e+02
  6.04422720e+02  2.74406159e+03  1.22232415e+04  4.08447612e+04
  1.04888411e+05  2.30071861e+05  4.55886806e+05  8.44839071e+05
  1.52801634e+06  2.85028375e+06  5.80817104e+06]
E1 = -706.4271130893563  E_coul = 198.47533364906533
cycle= 1 E= -507.951779440291  delta_E= 3.98e-13  |g|= 1.16e-09  |ddm|= 6.16e-10
    CPU time for cycle= 1      0.10 sec, wall time      0.01 sec
E1 = -706.4271130893563  E_coul = 198.47533364906533
  HOMO = -0.246913637347784  LUMO = 0.132258310480077
  mo_energy =
[-1.20341475e+02 -1.23951651e+01 -6.69606626e+00 -6.69606626e+00
 -6.69606626e+00 -1.17264315e+00 -2.46913637e-01 -2.46913637e-01
 -2.46913637e-01  1.32258310e-01  1.01951531e+01  1.09944915e+02
  6.04422720e+02  2.74406159e+03  1.22232415e+04  4.08447612e+04
  1.04888411e+05  2.30071861e+05  4.55886806e+05  8.44839071e+05
  1.52801634e+06  2.85028375e+06  5.80817104e+06]
E1 = -706.4271130828346  E_coul = 198.47533364254363
Extra cycle  E= -507.951779440291  delta_E= 1.14e-13  |g|= 3e-09  |ddm|= 4.91e-09
    CPU time for scf_cycle      4.59 sec, wall time      1.30 sec
exp = [3.96631974e-02 1.17616814e+05 3.96631974e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347588e+03 1.83758102e+04 1.44974932e+03
 3.74024707e+02 1.13259220e+02 3.77424207e+01 8.08823972e+00
 3.20405715e+00 8.60387755e+00 4.93005957e-01]
grad_E = [-1.29724232e-01  4.18070566e-09 -1.84843667e-01  1.87446956e-11
  1.12723909e-10  6.50452121e-10  2.55085665e-09  1.05974701e-08
  5.70102807e-08  3.58620204e-06  1.22575816e-07  5.15731050e-06
 -5.09286143e-06 -9.32214275e-06  1.38311023e-05  5.21042452e-04
 -2.91428778e-03 -1.23300965e-03 -3.71852595e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:28 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.169387429705       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.581475641304       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209718        1
[INPUT] 0    0    [1    /1   ]  36754.7200475        1
[INPUT] 0    0    [1    /1   ]  7303.47587502        1
[INPUT] 0    0    [1    /1   ]  18375.8102151        1
[INPUT] 0    0    [1    /1   ]  1449.74931247        1
[INPUT] 0    0    [1    /1   ]  374.024712568        1
[INPUT] 0    0    [1    /1   ]  113.259229254        1
[INPUT] 0    0    [1    /1   ]  37.7424068953        1
[INPUT] 0    0    [1    /1   ]  8.0877186794         1
[INPUT] 0    0    [1    /1   ]  3.20697143353        1
[INPUT] 1    0    [1    /1   ]  8.60511055661        1
[INPUT] 1    0    [1    /1   ]  0.530191216528       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.16938742970452308, 1.0]], [0, [117616.81424229761, 1.0]], [0, [0.5814756413037547, 1.0]], [0, [1176168.1426188892, 1.0]], [0, [588084.0699925772, 1.0]], [0, [294042.0311319589, 1.0]], [0, [147020.99214808043, 1.0]], [0, [73510.42097180206, 1.0]], [0, [36754.720047542025, 1.0]], [0, [7303.475875020579, 1.0]], [0, [18375.81021512882, 1.0]], [0, [1449.7493124693215, 1.0]], [0, [374.02471256829796, 1.0]], [0, [113.25922925441796, 1.0]], [0, [37.742406895257574, 1.0]], [0, [8.087718679400364, 1.0]], [0, [3.2069714335329285, 1.0]], [1, [8.605110556608103, 1.0]], [1, [0.5301912165284776, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.16938743]
bas 1, expnt(s) = [117616.8142423]
bas 2, expnt(s) = [0.58147564]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113196]
bas 6, expnt(s) = [147020.99214808]
bas 7, expnt(s) = [73510.4209718]
bas 8, expnt(s) = [36754.72004754]
bas 9, expnt(s) = [7303.47587502]
bas 10, expnt(s) = [18375.81021513]
bas 11, expnt(s) = [1449.74931247]
bas 12, expnt(s) = [374.02471257]
bas 13, expnt(s) = [113.25922925]
bas 14, expnt(s) = [37.7424069]
bas 15, expnt(s) = [8.08771868]
bas 16, expnt(s) = [3.20697143]
bas 17, expnt(s) = [8.60511056]
bas 18, expnt(s) = [0.53019122]
CPU time:        13.08
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.69387430e-01 6.67076909e-01 1.17616814e+05 1.60460109e+04
 5.81475641e-01 1.68233960e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347588e+03 1.99600775e+03
 1.83758102e+04 3.98749266e+03 1.44974931e+03 5.93587447e+02
 3.74024713e+02 2.14877156e+02 1.13259229e+02 8.77142644e+01
 3.77424069e+01 3.84713316e+01 8.08771868e+00 1.21167055e+01
 3.20697143e+00 6.05461236e+00 8.60511056e+00 4.29961887e+01
 5.30191217e-01 1.31985145e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.27460565998284
cond(S) = 907719.3139106121
E1 = -690.7395345648812  E_coul = 186.05746195163402
init E= -504.682072613247
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.627037065870956  LUMO = 0.389731045171086
  mo_energy =
[-1.21606748e+02 -1.32908400e+01 -7.56019391e+00 -7.56019391e+00
 -7.56019391e+00 -1.62745887e+00 -6.27037066e-01 -6.27037066e-01
 -6.27037066e-01  3.89731045e-01  1.09801861e+01  1.09993827e+02
  6.04159151e+02  2.74372621e+03  1.22229146e+04  4.08444500e+04
  1.04888111e+05  2.30071568e+05  4.55886518e+05  8.44838786e+05
  1.52801606e+06  2.85028346e+06  5.80817075e+06]
E1 = -709.5798223976996  E_coul = 201.6588778805759
cycle= 1 E= -507.920944517124  delta_E= -3.24  |g|= 0.461  |ddm|= 0.465
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.64331
diis-c [-0.41384749  1.        ]
  HOMO = -0.127959031045402  LUMO = 0.755565567747853
  mo_energy =
[-1.20042530e+02 -1.21600382e+01 -6.48458874e+00 -6.48458874e+00
 -6.48458874e+00 -1.09994247e+00 -1.27959031e-01 -1.27959031e-01
 -1.27959031e-01  7.55565568e-01  1.19546937e+01  1.11446966e+02
  6.05709363e+02  2.74521533e+03  1.22242944e+04  4.08457633e+04
  1.04889387e+05  2.30072821e+05  4.55887753e+05  8.44840008e+05
  1.52801727e+06  2.85028466e+06  5.80817194e+06]
E1 = -708.5432718875095  E_coul = 200.60179731082235
cycle= 2 E= -507.941474576687  delta_E= -0.0205  |g|= 0.0372  |ddm|= 0.453
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0323394
diis-c [-0.00104453 -0.00178155  1.00178155]
  HOMO = -0.154749807029381  LUMO = 0.750753824371818
  mo_energy =
[-1.20163426e+02 -1.22330330e+01 -6.56449449e+00 -6.56449449e+00
 -6.56449449e+00 -1.11675169e+00 -1.54749807e-01 -1.54749807e-01
 -1.54749807e-01  7.50753824e-01  1.18996332e+01  1.11345362e+02
  6.05584363e+02  2.74507388e+03  1.22241426e+04  4.08456076e+04
  1.04889230e+05  2.30072662e+05  4.55887595e+05  8.44839849e+05
  1.52801711e+06  2.85028450e+06  5.80817178e+06]
E1 = -708.4119446820415  E_coul = 200.47010071414053
cycle= 3 E= -507.941843967901  delta_E= -0.000369  |g|= 0.00511  |ddm|= 0.0682
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00415671
diis-c [-2.63432153e-06 -3.08282047e-04 -1.33691579e-01  1.13399986e+00]
  HOMO = -0.15908604752665  LUMO = 0.749645251590887
  mo_energy =
[-1.20177674e+02 -1.22436957e+01 -6.57564496e+00 -6.57564496e+00
 -6.57564496e+00 -1.11930359e+00 -1.59086048e-01 -1.59086048e-01
 -1.59086048e-01  7.49645252e-01  1.18910750e+01  1.11332517e+02
  6.05569937e+02  2.74505854e+03  1.22241267e+04  4.08455916e+04
  1.04889214e+05  2.30072646e+05  4.55887578e+05  8.44839833e+05
  1.52801709e+06  2.85028449e+06  5.80817177e+06]
E1 = -708.3911058630385  E_coul = 200.44925382014344
cycle= 4 E= -507.941852042895  delta_E= -8.07e-06  |g|= 0.000178  |ddm|= 0.0116
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000139128
diis-c [-1.12516488e-10 -7.45514374e-06  7.89191692e-03 -8.64070527e-02
  1.07852259e+00]
  HOMO = -0.159217245027293  LUMO = 0.74960111065006
  mo_energy =
[-1.20177894e+02 -1.22439677e+01 -6.57590366e+00 -6.57590366e+00
 -6.57590366e+00 -1.11937741e+00 -1.59217245e-01 -1.59217245e-01
 -1.59217245e-01  7.49601111e-01  1.18908337e+01  1.11332279e+02
  6.05569720e+02  2.74505834e+03  1.22241265e+04  4.08455914e+04
  1.04889214e+05  2.30072646e+05  4.55887578e+05  8.44839833e+05
  1.52801709e+06  2.85028449e+06  5.80817177e+06]
E1 = -708.390485710022  E_coul = 200.44863365888386
cycle= 5 E= -507.941852051138  delta_E= -8.24e-09  |g|= 7.79e-07  |ddm|= 0.000391
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.78791e-07
diis-c [-1.79150650e-14  1.90143223e-07 -1.38792215e-04  1.34869088e-03
 -1.73655288e-02  1.01615544e+00]
  HOMO = -0.1592176929876  LUMO = 0.749601269993055
  mo_energy =
[-1.20177896e+02 -1.22439688e+01 -6.57590487e+00 -6.57590487e+00
 -6.57590487e+00 -1.11937792e+00 -1.59217693e-01 -1.59217693e-01
 -1.59217693e-01  7.49601270e-01  1.18908328e+01  1.11332277e+02
  6.05569718e+02  2.74505833e+03  1.22241265e+04  4.08455914e+04
  1.04889214e+05  2.30072646e+05  4.55887578e+05  8.44839833e+05
  1.52801709e+06  2.85028449e+06  5.80817177e+06]
E1 = -708.3904825779988  E_coul = 200.44863052686011
cycle= 6 E= -507.941852051139  delta_E= -5.68e-13  |g|= 1.5e-08  |ddm|= 1.78e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -708.3904825779988  E_coul = 200.44863052686011
  HOMO = -0.159217703473884  LUMO = 0.749601261961261
  mo_energy =
[-1.20177896e+02 -1.22439689e+01 -6.57590489e+00 -6.57590489e+00
 -6.57590489e+00 -1.11937792e+00 -1.59217703e-01 -1.59217703e-01
 -1.59217703e-01  7.49601262e-01  1.18908328e+01  1.11332277e+02
  6.05569718e+02  2.74505833e+03  1.22241265e+04  4.08455914e+04
  1.04889214e+05  2.30072646e+05  4.55887578e+05  8.44839833e+05
  1.52801709e+06  2.85028449e+06  5.80817177e+06]
E1 = -708.3904825412764  E_coul = 200.44863049013773
Extra cycle  E= -507.941852051139  delta_E=    0  |g|= 2.1e-09  |ddm|= 2.55e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [1.69387430e-01 1.17616814e+05 5.81475641e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347588e+03 1.83758102e+04 1.44974931e+03
 3.74024713e+02 1.13259229e+02 3.77424069e+01 8.08771868e+00
 3.20697143e+00 8.60511056e+00 5.30191217e-01]
E = -507.94185205113865
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:28 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.0941923056624      1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.474330335932       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209718        1
[INPUT] 0    0    [1    /1   ]  36754.7200476        1
[INPUT] 0    0    [1    /1   ]  7303.4758771         1
[INPUT] 0    0    [1    /1   ]  18375.8102152        1
[INPUT] 0    0    [1    /1   ]  1449.74931546        1
[INPUT] 0    0    [1    /1   ]  374.024709616        1
[INPUT] 0    0    [1    /1   ]  113.259223851        1
[INPUT] 0    0    [1    /1   ]  37.7424149125        1
[INPUT] 0    0    [1    /1   ]  8.08802070356        1
[INPUT] 0    0    [1    /1   ]  3.205282156          1
[INPUT] 1    0    [1    /1   ]  8.60439583807        1
[INPUT] 1    0    [1    /1   ]  0.50863664534        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.0941923056624338, 1.0]], [0, [117616.81424230002, 1.0]], [0, [0.4743303359322095, 1.0]], [0, [1176168.1426188892, 1.0]], [0, [588084.0699925773, 1.0]], [0, [294042.03113195923, 1.0]], [0, [147020.99214808192, 1.0]], [0, [73510.4209718082, 1.0]], [0, [36754.720047575065, 1.0]], [0, [7303.475877099335, 1.0]], [0, [18375.81021519987, 1.0]], [0, [1449.7493154587753, 1.0]], [0, [374.02470961620224, 1.0]], [0, [113.25922385080395, 1.0]], [0, [37.74241491250642, 1.0]], [0, [8.088020703556612, 1.0]], [0, [3.20528215599811, 1.0]], [1, [8.604395838071794, 1.0]], [1, [0.5086366453395473, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.09419231]
bas 1, expnt(s) = [117616.8142423]
bas 2, expnt(s) = [0.47433034]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113196]
bas 6, expnt(s) = [147020.99214808]
bas 7, expnt(s) = [73510.42097181]
bas 8, expnt(s) = [36754.72004758]
bas 9, expnt(s) = [7303.4758771]
bas 10, expnt(s) = [18375.8102152]
bas 11, expnt(s) = [1449.74931546]
bas 12, expnt(s) = [374.02470962]
bas 13, expnt(s) = [113.25922385]
bas 14, expnt(s) = [37.74241491]
bas 15, expnt(s) = [8.0880207]
bas 16, expnt(s) = [3.20528216]
bas 17, expnt(s) = [8.60439584]
bas 18, expnt(s) = [0.50863665]
CPU time:        13.56
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 9.41923057e-02 4.29562731e-01 1.17616814e+05 1.60460109e+04
 4.74330336e-01 1.44402828e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347588e+03 1.99600775e+03
 1.83758102e+04 3.98749266e+03 1.44974932e+03 5.93587448e+02
 3.74024710e+02 2.14877155e+02 1.13259224e+02 8.77142613e+01
 3.77424149e+01 3.84713377e+01 8.08802070e+00 1.21170448e+01
 3.20528216e+00 6.05222024e+00 8.60439584e+00 4.29917248e+01
 5.08636645e-01 1.25312372e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.309692473742913
cond(S) = 907710.3329552445
E1 = -690.1060925711735  E_coul = 185.48321171240346
init E= -504.62288085877
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.652290401902666  LUMO = 0.10404167954944
  mo_energy =
[-1.21658561e+02 -1.33404045e+01 -7.59281640e+00 -7.59281640e+00
 -7.59281640e+00 -1.63844969e+00 -6.52290402e-01 -6.52290402e-01
 -6.52290402e-01  1.04041680e-01  1.00221882e+01  1.09213638e+02
  6.03523099e+02  2.74317995e+03  1.22224349e+04  4.08440029e+04
  1.04887680e+05  2.30071148e+05  4.55886106e+05  8.44838379e+05
  1.52801566e+06  2.85028307e+06  5.80817037e+06]
E1 = -708.3992013178956  E_coul = 200.4570976796917
cycle= 1 E= -507.942103638204  delta_E= -3.32  |g|= 0.447  |ddm|= 0.429
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.637564
diis-c [-0.40648786  1.        ]
  HOMO = -0.182698231612767  LUMO = 0.369098650130617
  mo_energy =
[-1.20142581e+02 -1.22514611e+01 -6.55773555e+00 -6.55773555e+00
 -6.55773555e+00 -1.13370046e+00 -1.82698232e-01 -1.82698232e-01
 -1.82698232e-01  3.69098650e-01  1.09642510e+01  1.10622086e+02
  6.05025209e+02  2.74461982e+03  1.22237650e+04  4.08452663e+04
  1.04888907e+05  2.30072351e+05  4.55887291e+05  8.44839551e+05
  1.52801682e+06  2.85028422e+06  5.80817151e+06]
E1 = -707.6085742822105  E_coul = 199.6517851627715
cycle= 2 E= -507.956789119439  delta_E= -0.0147  |g|= 0.0311  |ddm|= 0.327
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0314258
diis-c [-9.85382990e-04 -2.33401342e-03  1.00233401e+00]
  HOMO = -0.201848669534811  LUMO = 0.367741898992816
  mo_energy =
[-1.20239909e+02 -1.23060909e+01 -6.61871322e+00 -6.61871322e+00
 -6.61871322e+00 -1.14588219e+00 -2.01848670e-01 -2.01848670e-01
 -2.01848670e-01  3.67741899e-01  1.09253580e+01  1.10542005e+02
  6.04924102e+02  2.74450374e+03  1.22236394e+04  4.08451373e+04
  1.04888776e+05  2.30072219e+05  4.55887159e+05  8.44839419e+05
  1.52801669e+06  2.85028409e+06  5.80817138e+06]
E1 = -707.5062093022863  E_coul = 199.54913180307864
cycle= 3 E= -507.957077499208  delta_E= -0.000288  |g|= 0.00458  |ddm|= 0.0551
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0045085
diis-c [-3.68145494e-06 -4.25062091e-04 -1.48336369e-01  1.14876143e+00]
  HOMO = -0.205319080892951  LUMO = 0.367273519868329
  mo_energy =
[-1.20251111e+02 -1.23144013e+01 -6.62743761e+00 -6.62743761e+00
 -6.62743761e+00 -1.14800545e+00 -2.05319081e-01 -2.05319081e-01
 -2.05319081e-01  3.67273520e-01  1.09187454e+01  1.10531932e+02
  6.04912759e+02  2.74449167e+03  1.22236269e+04  4.08451246e+04
  1.04888764e+05  2.30072207e+05  4.55887146e+05  8.44839407e+05
  1.52801667e+06  2.85028407e+06  5.80817136e+06]
E1 = -707.4879258306879  E_coul = 199.53084009968256
cycle= 4 E= -507.957085731005  delta_E= -8.23e-06  |g|= 0.000222  |ddm|= 0.0109
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000197705
diis-c [-2.84013378e-10 -9.25651560e-06  9.36445007e-03 -1.01301617e-01
  1.09194642e+00]
  HOMO = -0.205461301717416  LUMO = 0.367244685276431
  mo_energy =
[-1.20251294e+02 -1.23146653e+01 -6.62768444e+00 -6.62768444e+00
 -6.62768444e+00 -1.14809056e+00 -2.05461302e-01 -2.05461302e-01
 -2.05461302e-01  3.67244685e-01  1.09184962e+01  1.10531719e+02
  6.04912579e+02  2.74449151e+03  1.22236268e+04  4.08451245e+04
  1.04888764e+05  2.30072206e+05  4.55887146e+05  8.44839406e+05
  1.52801667e+06  2.85028407e+06  5.80817136e+06]
E1 = -707.4871832219694  E_coul = 199.5300974749748
cycle= 5 E= -507.957085746995  delta_E= -1.6e-08  |g|= 1.37e-06  |ddm|= 0.000516
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.15494e-06
diis-c [-1.07242120e-13  3.32879431e-07 -3.18605738e-04  3.17522198e-03
 -3.57829229e-02  1.03292597e+00]
  HOMO = -0.205461823086679  LUMO = 0.367244855731999
  mo_energy =
[-1.20251296e+02 -1.23146664e+01 -6.62768576e+00 -6.62768576e+00
 -6.62768576e+00 -1.14809111e+00 -2.05461823e-01 -2.05461823e-01
 -2.05461823e-01  3.67244856e-01  1.09184951e+01  1.10531717e+02
  6.04912577e+02  2.74449151e+03  1.22236268e+04  4.08451245e+04
  1.04888764e+05  2.30072206e+05  4.55887146e+05  8.44839406e+05
  1.52801667e+06  2.85028407e+06  5.80817136e+06]
E1 = -707.4871783622111  E_coul = 199.530092615216
cycle= 6 E= -507.957085746995  delta_E= -5.12e-13  |g|= 2.23e-08  |ddm|= 3.12e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -707.4871783622111  E_coul = 199.530092615216
  HOMO = -0.205461836264413  LUMO = 0.367244844107402
  mo_energy =
[-1.20251296e+02 -1.23146664e+01 -6.62768578e+00 -6.62768578e+00
 -6.62768578e+00 -1.14809111e+00 -2.05461836e-01 -2.05461836e-01
 -2.05461836e-01  3.67244844e-01  1.09184951e+01  1.10531717e+02
  6.04912577e+02  2.74449151e+03  1.22236268e+04  4.08451245e+04
  1.04888764e+05  2.30072206e+05  4.55887146e+05  8.44839406e+05
  1.52801667e+06  2.85028407e+06  5.80817136e+06]
E1 = -707.4871783512998  E_coul = 199.5300926043043
Extra cycle  E= -507.957085746996  delta_E= -3.98e-13  |g|= 2.55e-09  |ddm|= 1.96e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [9.41923057e-02 1.17616814e+05 4.74330336e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347588e+03 1.83758102e+04 1.44974932e+03
 3.74024710e+02 1.13259224e+02 3.77424149e+01 8.08802070e+00
 3.20528216e+00 8.60439584e+00 5.08636645e-01]
E = -507.9570857469955
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:28 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.0941923056624      1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.474330335932       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209718        1
[INPUT] 0    0    [1    /1   ]  36754.7200476        1
[INPUT] 0    0    [1    /1   ]  7303.4758771         1
[INPUT] 0    0    [1    /1   ]  18375.8102152        1
[INPUT] 0    0    [1    /1   ]  1449.74931546        1
[INPUT] 0    0    [1    /1   ]  374.024709616        1
[INPUT] 0    0    [1    /1   ]  113.259223851        1
[INPUT] 0    0    [1    /1   ]  37.7424149125        1
[INPUT] 0    0    [1    /1   ]  8.08802070356        1
[INPUT] 0    0    [1    /1   ]  3.205282156          1
[INPUT] 1    0    [1    /1   ]  8.60439583807        1
[INPUT] 1    0    [1    /1   ]  0.50863664534        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.0941923056624338, 1.0]], [0, [117616.81424230002, 1.0]], [0, [0.4743303359322095, 1.0]], [0, [1176168.1426188892, 1.0]], [0, [588084.0699925773, 1.0]], [0, [294042.03113195923, 1.0]], [0, [147020.99214808192, 1.0]], [0, [73510.4209718082, 1.0]], [0, [36754.720047575065, 1.0]], [0, [7303.475877099335, 1.0]], [0, [18375.81021519987, 1.0]], [0, [1449.7493154587753, 1.0]], [0, [374.02470961620224, 1.0]], [0, [113.25922385080395, 1.0]], [0, [37.74241491250642, 1.0]], [0, [8.088020703556612, 1.0]], [0, [3.20528215599811, 1.0]], [1, [8.604395838071794, 1.0]], [1, [0.5086366453395473, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.09419231]
bas 1, expnt(s) = [117616.8142423]
bas 2, expnt(s) = [0.47433034]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113196]
bas 6, expnt(s) = [147020.99214808]
bas 7, expnt(s) = [73510.42097181]
bas 8, expnt(s) = [36754.72004758]
bas 9, expnt(s) = [7303.4758771]
bas 10, expnt(s) = [18375.8102152]
bas 11, expnt(s) = [1449.74931546]
bas 12, expnt(s) = [374.02470962]
bas 13, expnt(s) = [113.25922385]
bas 14, expnt(s) = [37.74241491]
bas 15, expnt(s) = [8.0880207]
bas 16, expnt(s) = [3.20528216]
bas 17, expnt(s) = [8.60439584]
bas 18, expnt(s) = [0.50863665]
CPU time:        14.05
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 9.41923057e-02 4.29562731e-01 1.17616814e+05 1.60460109e+04
 4.74330336e-01 1.44402828e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347588e+03 1.99600775e+03
 1.83758102e+04 3.98749266e+03 1.44974932e+03 5.93587448e+02
 3.74024710e+02 2.14877155e+02 1.13259224e+02 8.77142613e+01
 3.77424149e+01 3.84713377e+01 8.08802070e+00 1.21170448e+01
 3.20528216e+00 6.05222024e+00 8.60439584e+00 4.29917248e+01
 5.08636645e-01 1.25312372e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.309692473742913
cond(S) = 907710.3329552445
E1 = -690.1060925711735  E_coul = 185.48321171240346
init E= -504.62288085877
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.652290401902666  LUMO = 0.10404167954944
  mo_energy =
[-1.21658561e+02 -1.33404045e+01 -7.59281640e+00 -7.59281640e+00
 -7.59281640e+00 -1.63844969e+00 -6.52290402e-01 -6.52290402e-01
 -6.52290402e-01  1.04041680e-01  1.00221882e+01  1.09213638e+02
  6.03523099e+02  2.74317995e+03  1.22224349e+04  4.08440029e+04
  1.04887680e+05  2.30071148e+05  4.55886106e+05  8.44838379e+05
  1.52801566e+06  2.85028307e+06  5.80817037e+06]
E1 = -708.3992013178956  E_coul = 200.4570976796917
cycle= 1 E= -507.942103638204  delta_E= -3.32  |g|= 0.447  |ddm|= 0.429
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.637564
diis-c [-0.40648786  1.        ]
  HOMO = -0.182698231612767  LUMO = 0.369098650130617
  mo_energy =
[-1.20142581e+02 -1.22514611e+01 -6.55773555e+00 -6.55773555e+00
 -6.55773555e+00 -1.13370046e+00 -1.82698232e-01 -1.82698232e-01
 -1.82698232e-01  3.69098650e-01  1.09642510e+01  1.10622086e+02
  6.05025209e+02  2.74461982e+03  1.22237650e+04  4.08452663e+04
  1.04888907e+05  2.30072351e+05  4.55887291e+05  8.44839551e+05
  1.52801682e+06  2.85028422e+06  5.80817151e+06]
E1 = -707.6085742822105  E_coul = 199.6517851627715
cycle= 2 E= -507.956789119439  delta_E= -0.0147  |g|= 0.0311  |ddm|= 0.327
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0314258
diis-c [-9.85382990e-04 -2.33401342e-03  1.00233401e+00]
  HOMO = -0.201848669534811  LUMO = 0.367741898992816
  mo_energy =
[-1.20239909e+02 -1.23060909e+01 -6.61871322e+00 -6.61871322e+00
 -6.61871322e+00 -1.14588219e+00 -2.01848670e-01 -2.01848670e-01
 -2.01848670e-01  3.67741899e-01  1.09253580e+01  1.10542005e+02
  6.04924102e+02  2.74450374e+03  1.22236394e+04  4.08451373e+04
  1.04888776e+05  2.30072219e+05  4.55887159e+05  8.44839419e+05
  1.52801669e+06  2.85028409e+06  5.80817138e+06]
E1 = -707.5062093022863  E_coul = 199.54913180307864
cycle= 3 E= -507.957077499208  delta_E= -0.000288  |g|= 0.00458  |ddm|= 0.0551
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0045085
diis-c [-3.68145494e-06 -4.25062091e-04 -1.48336369e-01  1.14876143e+00]
  HOMO = -0.205319080892951  LUMO = 0.367273519868329
  mo_energy =
[-1.20251111e+02 -1.23144013e+01 -6.62743761e+00 -6.62743761e+00
 -6.62743761e+00 -1.14800545e+00 -2.05319081e-01 -2.05319081e-01
 -2.05319081e-01  3.67273520e-01  1.09187454e+01  1.10531932e+02
  6.04912759e+02  2.74449167e+03  1.22236269e+04  4.08451246e+04
  1.04888764e+05  2.30072207e+05  4.55887146e+05  8.44839407e+05
  1.52801667e+06  2.85028407e+06  5.80817136e+06]
E1 = -707.4879258306879  E_coul = 199.53084009968256
cycle= 4 E= -507.957085731005  delta_E= -8.23e-06  |g|= 0.000222  |ddm|= 0.0109
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000197705
diis-c [-2.84013378e-10 -9.25651560e-06  9.36445007e-03 -1.01301617e-01
  1.09194642e+00]
  HOMO = -0.205461301717416  LUMO = 0.367244685276431
  mo_energy =
[-1.20251294e+02 -1.23146653e+01 -6.62768444e+00 -6.62768444e+00
 -6.62768444e+00 -1.14809056e+00 -2.05461302e-01 -2.05461302e-01
 -2.05461302e-01  3.67244685e-01  1.09184962e+01  1.10531719e+02
  6.04912579e+02  2.74449151e+03  1.22236268e+04  4.08451245e+04
  1.04888764e+05  2.30072206e+05  4.55887146e+05  8.44839406e+05
  1.52801667e+06  2.85028407e+06  5.80817136e+06]
E1 = -707.4871832219694  E_coul = 199.5300974749748
cycle= 5 E= -507.957085746995  delta_E= -1.6e-08  |g|= 1.37e-06  |ddm|= 0.000516
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.15494e-06
diis-c [-1.07242120e-13  3.32879431e-07 -3.18605738e-04  3.17522198e-03
 -3.57829229e-02  1.03292597e+00]
  HOMO = -0.205461823086679  LUMO = 0.367244855731999
  mo_energy =
[-1.20251296e+02 -1.23146664e+01 -6.62768576e+00 -6.62768576e+00
 -6.62768576e+00 -1.14809111e+00 -2.05461823e-01 -2.05461823e-01
 -2.05461823e-01  3.67244856e-01  1.09184951e+01  1.10531717e+02
  6.04912577e+02  2.74449151e+03  1.22236268e+04  4.08451245e+04
  1.04888764e+05  2.30072206e+05  4.55887146e+05  8.44839406e+05
  1.52801667e+06  2.85028407e+06  5.80817136e+06]
E1 = -707.4871783622111  E_coul = 199.530092615216
cycle= 6 E= -507.957085746995  delta_E= -5.12e-13  |g|= 2.23e-08  |ddm|= 3.12e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -707.4871783622111  E_coul = 199.530092615216
  HOMO = -0.205461836264413  LUMO = 0.367244844107402
  mo_energy =
[-1.20251296e+02 -1.23146664e+01 -6.62768578e+00 -6.62768578e+00
 -6.62768578e+00 -1.14809111e+00 -2.05461836e-01 -2.05461836e-01
 -2.05461836e-01  3.67244844e-01  1.09184951e+01  1.10531717e+02
  6.04912577e+02  2.74449151e+03  1.22236268e+04  4.08451245e+04
  1.04888764e+05  2.30072206e+05  4.55887146e+05  8.44839406e+05
  1.52801667e+06  2.85028407e+06  5.80817136e+06]
E1 = -707.4871783512998  E_coul = 199.5300926043043
Extra cycle  E= -507.957085746996  delta_E= -3.98e-13  |g|= 2.55e-09  |ddm|= 1.96e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907710.3329552445
E1 = -707.4871783512998  E_coul = 199.5300926043043
init E= -507.957085746996
    CPU time for initialize scf      1.40 sec, wall time      0.09 sec
  HOMO = -0.205461836786929  LUMO = 0.367244843310381
  mo_energy =
[-1.20251296e+02 -1.23146664e+01 -6.62768578e+00 -6.62768578e+00
 -6.62768578e+00 -1.14809111e+00 -2.05461837e-01 -2.05461837e-01
 -2.05461837e-01  3.67244843e-01  1.09184951e+01  1.10531717e+02
  6.04912577e+02  2.74449151e+03  1.22236268e+04  4.08451245e+04
  1.04888764e+05  2.30072206e+05  4.55887146e+05  8.44839406e+05
  1.52801667e+06  2.85028407e+06  5.80817136e+06]
E1 = -707.487178352872  E_coul = 199.53009260587615
cycle= 1 E= -507.957085746996  delta_E= -3.41e-13  |g|= 1.86e-09  |ddm|= 6.74e-10
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -707.487178352872  E_coul = 199.53009260587615
  HOMO = -0.205461836746353  LUMO = 0.367244843825789
  mo_energy =
[-1.20251296e+02 -1.23146664e+01 -6.62768578e+00 -6.62768578e+00
 -6.62768578e+00 -1.14809111e+00 -2.05461837e-01 -2.05461837e-01
 -2.05461837e-01  3.67244844e-01  1.09184951e+01  1.10531717e+02
  6.04912577e+02  2.74449151e+03  1.22236268e+04  4.08451245e+04
  1.04888764e+05  2.30072206e+05  4.55887146e+05  8.44839406e+05
  1.52801667e+06  2.85028407e+06  5.80817136e+06]
E1 = -707.4871783506792  E_coul = 199.53009260368427
Extra cycle  E= -507.957085746995  delta_E= 9.09e-13  |g|= 1.82e-09  |ddm|= 1.4e-09
    CPU time for scf_cycle      1.57 sec, wall time      0.16 sec
exp = [9.41923057e-02 1.17616814e+05 4.74330336e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347588e+03 1.83758102e+04 1.44974932e+03
 3.74024710e+02 1.13259224e+02 3.77424149e+01 8.08802070e+00
 3.20528216e+00 8.60439584e+00 5.08636645e-01]
grad_E = [-2.50362963e-01  4.17714992e-09  1.27825635e-01  1.86967316e-11
  1.12603519e-10  6.49903621e-10  2.54865140e-09  1.05881344e-08
  5.69654214e-08  3.58294469e-06  1.22426749e-07  5.38960280e-06
 -8.97435089e-06  2.46421288e-05 -1.63587253e-04 -7.42702328e-04
  2.51701879e-03 -1.48397006e-02  5.71419909e-01]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.963528554983       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  1.32114403049        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209717        1
[INPUT] 0    0    [1    /1   ]  36754.7200472        1
[INPUT] 0    0    [1    /1   ]  7303.47585577        1
[INPUT] 0    0    [1    /1   ]  18375.8102145        1
[INPUT] 0    0    [1    /1   ]  1449.74928459        1
[INPUT] 0    0    [1    /1   ]  374.024743054        1
[INPUT] 0    0    [1    /1   ]  113.259251842        1
[INPUT] 0    0    [1    /1   ]  37.7424761169        1
[INPUT] 0    0    [1    /1   ]  8.08594294037        1
[INPUT] 0    0    [1    /1   ]  3.21822746585        1
[INPUT] 1    0    [1    /1   ]  8.62273599347        1
[INPUT] 1    0    [1    /1   ]  0.237644176219       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.9635285549832795, 1.0]], [0, [117616.81424227516, 1.0]], [0, [1.3211440304870985, 1.0]], [0, [1176168.1426188892, 1.0]], [0, [588084.0699925766, 1.0]], [0, [294042.0311319554, 1.0]], [0, [147020.99214806675, 1.0]], [0, [73510.42097174516, 1.0]], [0, [36754.72004723593, 1.0]], [0, [7303.475855766592, 1.0]], [0, [18375.810214470748, 1.0]], [0, [1449.7492845885386, 1.0]], [0, [374.02474305435555, 1.0]], [0, [113.25925184187528, 1.0]], [0, [37.74247611694805, 1.0]], [0, [8.085942940365912, 1.0]], [0, [3.218227465848775, 1.0]], [1, [8.622735993467574, 1.0]], [1, [0.2376441762187076, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.96352855]
bas 1, expnt(s) = [117616.81424228]
bas 2, expnt(s) = [1.32114403]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113196]
bas 6, expnt(s) = [147020.99214807]
bas 7, expnt(s) = [73510.42097175]
bas 8, expnt(s) = [36754.72004724]
bas 9, expnt(s) = [7303.47585577]
bas 10, expnt(s) = [18375.81021447]
bas 11, expnt(s) = [1449.74928459]
bas 12, expnt(s) = [374.02474305]
bas 13, expnt(s) = [113.25925184]
bas 14, expnt(s) = [37.74247612]
bas 15, expnt(s) = [8.08594294]
bas 16, expnt(s) = [3.21822747]
bas 17, expnt(s) = [8.62273599]
bas 18, expnt(s) = [0.23764418]
CPU time:        18.74
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 9.63528555e-01 2.45704701e+00 1.17616814e+05 1.60460109e+04
 1.32114403e+00 3.11334787e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347586e+03 1.99600775e+03
 1.83758102e+04 3.98749266e+03 1.44974928e+03 5.93587438e+02
 3.74024743e+02 2.14877169e+02 1.13259252e+02 8.77142775e+01
 3.77424761e+01 3.84713845e+01 8.08594294e+00 1.21147102e+01
 3.21822747e+00 6.07054352e+00 8.62273599e+00 4.31063007e+01
 2.37644176e-01 4.84053497e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 16.441096494571322
cond(S) = 907818.8915044621
E1 = -663.198267762027  E_coul = 163.8184445482401
init E= -499.379823213787
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -1.16098092598096  LUMO = 2.57817387963484
  mo_energy =
[-1.23316655e+02 -1.49893316e+01 -9.07956797e+00 -9.07956797e+00
 -9.07956797e+00 -2.52681339e+00 -1.16098093e+00 -1.16098093e+00
 -1.16098093e+00  2.57817388e+00  1.65265095e+01  1.14901390e+02
  6.07839751e+02  2.74659276e+03  1.22251672e+04  4.08464014e+04
  1.04889910e+05  2.30073269e+05  4.55888147e+05  8.44840360e+05
  1.52801758e+06  2.85028492e+06  5.80817212e+06]
E1 = -692.3320710725235  E_coul = 186.12755761017095
cycle= 1 E= -506.204513462353  delta_E= -6.82  |g|= 0.418  |ddm|= 71.5
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.615954
diis-c [-0.3793994  1.       ]
  HOMO = -0.524461805112106  LUMO = 3.63967666610414
  mo_energy =
[-1.21188553e+02 -1.33387257e+01 -7.45044804e+00 -7.45044804e+00
 -7.45044804e+00 -1.58947863e+00 -5.24461805e-01 -5.24461805e-01
 -5.24461805e-01  3.63967667e+00  1.80051322e+01  1.16886978e+02
  6.09958472e+02  2.74867092e+03  1.22271497e+04  4.08483223e+04
  1.04891796e+05  2.30075132e+05  4.55889993e+05  8.44842194e+05
  1.52801940e+06  2.85028673e+06  5.80817393e+06]
E1 = -691.9104635135043  E_coul = 185.6995451368297
cycle= 2 E= -506.210918376675  delta_E= -0.0064  |g|= 0.0212  |ddm|= 3.09
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0144736
diis-c [-1.92499380e-04  6.64821458e-03  9.93351785e-01]
  HOMO = -0.526768164597015  LUMO = 3.63522542132832
  mo_energy =
[-1.21253968e+02 -1.33677463e+01 -7.48611059e+00 -7.48611059e+00
 -7.48611059e+00 -1.59392695e+00 -5.26768165e-01 -5.26768165e-01
 -5.26768165e-01  3.63522542e+00  1.79842362e+01  1.16836668e+02
  6.09889738e+02  2.74858877e+03  1.22270590e+04  4.08482284e+04
  1.04891701e+05  2.30075036e+05  4.55889897e+05  8.44842097e+05
  1.52801931e+06  2.85028663e+06  5.80817383e+06]
E1 = -691.8814737941422  E_coul = 185.67052229091465
cycle= 3 E= -506.210951503228  delta_E= -3.31e-05  |g|= 0.00179  |ddm|= 0.356
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000851269
diis-c [-1.17434410e-07  2.75687452e-04 -5.24318887e-02  1.05215620e+00]
  HOMO = -0.527005109872277  LUMO = 3.63476387956149
  mo_energy =
[-1.21258426e+02 -1.33702091e+01 -7.48897223e+00 -7.48897223e+00
 -7.48897223e+00 -1.59434539e+00 -5.27005110e-01 -5.27005110e-01
 -5.27005110e-01  3.63476388e+00  1.79824087e+01  1.16833009e+02
  6.09885178e+02  2.74858368e+03  1.22270536e+04  4.08482229e+04
  1.04891695e+05  2.30075030e+05  4.55889891e+05  8.44842092e+05
  1.52801930e+06  2.85028663e+06  5.80817383e+06]
E1 = -691.8787804019822  E_coul = 185.66782859311337
cycle= 4 E= -506.210951808869  delta_E= -3.06e-07  |g|= 9.1e-05  |ddm|= 0.0401
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.57841e-05
diis-c [-2.25110781e-11 -1.89864865e-06  5.12116737e-03 -1.07382463e-01
  1.10226319e+00]
  HOMO = -0.527018122251758  LUMO = 3.63473904207325
  mo_energy =
[-1.21258589e+02 -1.33703240e+01 -7.48909688e+00 -7.48909688e+00
 -7.48909688e+00 -1.59436757e+00 -5.27018122e-01 -5.27018122e-01
 -5.27018122e-01  3.63473904e+00  1.79823218e+01  1.16832867e+02
  6.09885013e+02  2.74858350e+03  1.22270534e+04  4.08482227e+04
  1.04891695e+05  2.30075030e+05  4.55889891e+05  8.44842091e+05
  1.52801930e+06  2.85028663e+06  5.80817383e+06]
E1 = -691.8786457486221  E_coul = 185.66769393890604
cycle= 5 E= -506.210951809716  delta_E= -8.47e-10  |g|= 4.09e-07  |ddm|= 0.00232
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -691.8786457486221  E_coul = 185.66769393890604
  HOMO = -0.52701816053805  LUMO = 3.63473897776538
  mo_energy =
[-1.21258590e+02 -1.33703245e+01 -7.48909746e+00 -7.48909746e+00
 -7.48909746e+00 -1.59436765e+00 -5.27018161e-01 -5.27018161e-01
 -5.27018161e-01  3.63473898e+00  1.79823215e+01  1.16832866e+02
  6.09885012e+02  2.74858350e+03  1.22270534e+04  4.08482227e+04
  1.04891695e+05  2.30075030e+05  4.55889891e+05  8.44842091e+05
  1.52801930e+06  2.85028663e+06  5.80817383e+06]
E1 = -691.8786452655088  E_coul = 185.66769345579274
Extra cycle  E= -506.210951809716  delta_E= 5.68e-14  |g|= 3.14e-08  |ddm|= 5.83e-06
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
exp = [9.63528555e-01 1.17616814e+05 1.32114403e+00 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347586e+03 1.83758102e+04 1.44974928e+03
 3.74024743e+02 1.13259252e+02 3.77424761e+01 8.08594294e+00
 3.21822747e+00 8.62273599e+00 2.37644176e-01]
E = -506.21095180971605
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.181125930595       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.559011705388       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209718        1
[INPUT] 0    0    [1    /1   ]  36754.7200475        1
[INPUT] 0    0    [1    /1   ]  7303.47587497        1
[INPUT] 0    0    [1    /1   ]  18375.8102151        1
[INPUT] 0    0    [1    /1   ]  1449.74931237        1
[INPUT] 0    0    [1    /1   ]  374.02471296         1
[INPUT] 0    0    [1    /1   ]  113.25922665         1
[INPUT] 0    0    [1    /1   ]  37.742421033         1
[INPUT] 0    0    [1    /1   ]  8.08781292724        1
[INPUT] 0    0    [1    /1   ]  3.20657668698        1
[INPUT] 1    0    [1    /1   ]  8.60622985361        1
[INPUT] 1    0    [1    /1   ]  0.481537398427       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.18112593059451837, 1.0]], [0, [117616.81424229754, 1.0]], [0, [0.5590117053876984, 1.0]], [0, [1176168.1426188892, 1.0]], [0, [588084.0699925772, 1.0]], [0, [294042.0311319588, 1.0]], [0, [147020.9921480804, 1.0]], [0, [73510.4209718019, 1.0]], [0, [36754.72004754115, 1.0]], [0, [7303.4758749660605, 1.0]], [0, [18375.810215126956, 1.0]], [0, [1449.7493123717516, 1.0]], [0, [374.02471296001755, 1.0]], [0, [113.25922664991108, 1.0]], [0, [37.74242103295058, 1.0]], [0, [8.087812927237543, 1.0]], [0, [3.2065766869831767, 1.0]], [1, [8.60622985361137, 1.0]], [1, [0.48153739842746335, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.18112593]
bas 1, expnt(s) = [117616.8142423]
bas 2, expnt(s) = [0.55901171]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113196]
bas 6, expnt(s) = [147020.99214808]
bas 7, expnt(s) = [73510.4209718]
bas 8, expnt(s) = [36754.72004754]
bas 9, expnt(s) = [7303.47587497]
bas 10, expnt(s) = [18375.81021513]
bas 11, expnt(s) = [1449.74931237]
bas 12, expnt(s) = [374.02471296]
bas 13, expnt(s) = [113.25922665]
bas 14, expnt(s) = [37.74242103]
bas 15, expnt(s) = [8.08781293]
bas 16, expnt(s) = [3.20657669]
bas 17, expnt(s) = [8.60622985]
bas 18, expnt(s) = [0.4815374]
CPU time:        19.21
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.81125931e-01 7.01456101e-01 1.17616814e+05 1.60460109e+04
 5.59011705e-01 1.63335543e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347587e+03 1.99600775e+03
 1.83758102e+04 3.98749266e+03 1.44974931e+03 5.93587447e+02
 3.74024713e+02 2.14877156e+02 1.13259227e+02 8.77142629e+01
 3.77424210e+01 3.84713424e+01 8.08781293e+00 1.21168114e+01
 3.20657669e+00 6.05405340e+00 8.60622985e+00 4.30031797e+01
 4.81537398e-01 1.17023187e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.349354309270353
cond(S) = 907718.8191212042
E1 = -689.167823408481  E_coul = 184.60809634980944
init E= -504.559727058672
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.685636752415886  LUMO = 0.40450039773882
  mo_energy =
[-1.21733241e+02 -1.34144399e+01 -7.64531551e+00 -7.64531551e+00
 -7.64531551e+00 -1.66735557e+00 -6.85636752e-01 -6.85636752e-01
 -6.85636752e-01  4.04500398e-01  1.08250456e+01  1.09820003e+02
  6.03992836e+02  2.74356583e+03  1.22227587e+04  4.08442964e+04
  1.04887958e+05  2.30071416e+05  4.55886367e+05  8.44838635e+05
  1.52801591e+06  2.85028331e+06  5.80817060e+06]
E1 = -707.1400439510844  E_coul = 199.18897962947395
cycle= 1 E= -507.95106432161  delta_E= -3.39  |g|= 0.444  |ddm|= 0.48
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.632674
diis-c [-0.40027632  1.        ]
  HOMO = -0.243140249600122  LUMO = 0.736545316989184
  mo_energy =
[-1.20239873e+02 -1.23480393e+01 -6.62994853e+00 -6.62994853e+00
 -6.62994853e+00 -1.18123302e+00 -2.43140250e-01 -2.43140250e-01
 -2.43140250e-01  7.36545317e-01  1.17399350e+01  1.11204485e+02
  6.05472448e+02  2.74498426e+03  1.22240681e+04  4.08455393e+04
  1.04889165e+05  2.30072599e+05  4.55887532e+05  8.44839787e+05
  1.52801705e+06  2.85028444e+06  5.80817172e+06]
E1 = -706.2371818496684  E_coul = 198.2696192343692
cycle= 2 E= -507.967562615299  delta_E= -0.0165  |g|= 0.0335  |ddm|= 0.414
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0284102
diis-c [-8.07133154e-04  1.36777316e-04  9.99863223e-01]
  HOMO = -0.264423653651123  LUMO = 0.732573881978958
  mo_energy =
[-1.20348266e+02 -1.24114179e+01 -6.70026989e+00 -6.70026989e+00
 -6.70026989e+00 -1.19526667e+00 -2.64423654e-01 -2.64423654e-01
 -2.64423654e-01  7.32573882e-01  1.16930460e+01  1.11114255e+02
  6.05360160e+02  2.74485639e+03  1.22239303e+04  4.08453980e+04
  1.04889022e+05  2.30072455e+05  4.55887387e+05  8.44839642e+05
  1.52801690e+06  2.85028430e+06  5.80817158e+06]
E1 = -706.1272726067306  E_coul = 198.1594296862848
cycle= 3 E= -507.967842920446  delta_E= -0.00028  |g|= 0.00458  |ddm|= 0.0621
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0035596
diis-c [-2.22417855e-06 -2.75702592e-04 -1.28149936e-01  1.12842564e+00]
  HOMO = -0.267851913075358  LUMO = 0.731690725521945
  mo_energy =
[-1.20360578e+02 -1.24204578e+01 -6.70980704e+00 -6.70980704e+00
 -6.70980704e+00 -1.19740234e+00 -2.67851913e-01 -2.67851913e-01
 -2.67851913e-01  7.31690726e-01  1.16858847e+01  1.11103225e+02
  6.05347683e+02  2.74484307e+03  1.22239165e+04  4.08453840e+04
  1.04889008e+05  2.30072441e+05  4.55887373e+05  8.44839628e+05
  1.52801689e+06  2.85028428e+06  5.80817157e+06]
E1 = -706.1098664290028  E_coul = 198.1420172418658
cycle= 4 E= -507.967849187137  delta_E= -6.27e-06  |g|= 0.000189  |ddm|= 0.0107
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000139322
diis-c [-1.08335706e-10 -7.22869813e-06  8.05063293e-03 -9.43615144e-02
  1.08631811e+00]
  HOMO = -0.267979492008919  LUMO = 0.731649670720998
  mo_energy =
[-1.20360826e+02 -1.24207412e+01 -6.71008077e+00 -6.71008077e+00
 -6.71008077e+00 -1.19747930e+00 -2.67979492e-01 -2.67979492e-01
 -2.67979492e-01  7.31649671e-01  1.16856377e+01  1.11102965e+02
  6.05347437e+02  2.74484283e+03  1.22239163e+04  4.08453837e+04
  1.04889008e+05  2.30072441e+05  4.55887373e+05  8.44839628e+05
  1.52801689e+06  2.85028428e+06  5.80817157e+06]
E1 = -706.1092278610543  E_coul = 198.14137866443852
cycle= 5 E= -507.967849196616  delta_E= -9.48e-09  |g|= 8.41e-07  |ddm|= 0.00044
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.87368e-07
diis-c [-2.40127328e-14  2.00508580e-07 -1.52310059e-04  1.58589615e-03
 -1.90102001e-02  1.01757641e+00]
  HOMO = -0.26797996580474  LUMO = 0.731649747001653
  mo_energy =
[-1.20360828e+02 -1.24207424e+01 -6.71008212e+00 -6.71008212e+00
 -6.71008212e+00 -1.19747978e+00 -2.67979966e-01 -2.67979966e-01
 -2.67979966e-01  7.31649747e-01  1.16856367e+01  1.11102963e+02
  6.05347435e+02  2.74484283e+03  1.22239163e+04  4.08453837e+04
  1.04889008e+05  2.30072441e+05  4.55887373e+05  8.44839628e+05
  1.52801689e+06  2.85028428e+06  5.80817157e+06]
E1 = -706.1092247343211  E_coul = 198.14137553770487
cycle= 6 E= -507.967849196616  delta_E= -4.55e-13  |g|= 1.83e-08  |ddm|= 1.98e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.1092247343211  E_coul = 198.14137553770487
  HOMO = -0.26797997615393  LUMO = 0.731649741269714
  mo_energy =
[-1.20360828e+02 -1.24207424e+01 -6.71008214e+00 -6.71008214e+00
 -6.71008214e+00 -1.19747978e+00 -2.67979976e-01 -2.67979976e-01
 -2.67979976e-01  7.31649741e-01  1.16856367e+01  1.11102963e+02
  6.05347435e+02  2.74484283e+03  1.22239163e+04  4.08453837e+04
  1.04889008e+05  2.30072441e+05  4.55887373e+05  8.44839628e+05
  1.52801689e+06  2.85028428e+06  5.80817157e+06]
E1 = -706.1092246886221  E_coul = 198.14137549200618
Extra cycle  E= -507.967849196616  delta_E= 2.27e-13  |g|= 2.07e-09  |ddm|= 3.44e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [1.81125931e-01 1.17616814e+05 5.59011705e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347587e+03 1.83758102e+04 1.44974931e+03
 3.74024713e+02 1.13259227e+02 3.77424210e+01 8.08781293e+00
 3.20657669e+00 8.60622985e+00 4.81537398e-01]
E = -507.96784919661593
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.181125930595       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.559011705388       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209718        1
[INPUT] 0    0    [1    /1   ]  36754.7200475        1
[INPUT] 0    0    [1    /1   ]  7303.47587497        1
[INPUT] 0    0    [1    /1   ]  18375.8102151        1
[INPUT] 0    0    [1    /1   ]  1449.74931237        1
[INPUT] 0    0    [1    /1   ]  374.02471296         1
[INPUT] 0    0    [1    /1   ]  113.25922665         1
[INPUT] 0    0    [1    /1   ]  37.742421033         1
[INPUT] 0    0    [1    /1   ]  8.08781292724        1
[INPUT] 0    0    [1    /1   ]  3.20657668698        1
[INPUT] 1    0    [1    /1   ]  8.60622985361        1
[INPUT] 1    0    [1    /1   ]  0.481537398427       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.18112593059451837, 1.0]], [0, [117616.81424229754, 1.0]], [0, [0.5590117053876984, 1.0]], [0, [1176168.1426188892, 1.0]], [0, [588084.0699925772, 1.0]], [0, [294042.0311319588, 1.0]], [0, [147020.9921480804, 1.0]], [0, [73510.4209718019, 1.0]], [0, [36754.72004754115, 1.0]], [0, [7303.4758749660605, 1.0]], [0, [18375.810215126956, 1.0]], [0, [1449.7493123717516, 1.0]], [0, [374.02471296001755, 1.0]], [0, [113.25922664991108, 1.0]], [0, [37.74242103295058, 1.0]], [0, [8.087812927237543, 1.0]], [0, [3.2065766869831767, 1.0]], [1, [8.60622985361137, 1.0]], [1, [0.48153739842746335, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.18112593]
bas 1, expnt(s) = [117616.8142423]
bas 2, expnt(s) = [0.55901171]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113196]
bas 6, expnt(s) = [147020.99214808]
bas 7, expnt(s) = [73510.4209718]
bas 8, expnt(s) = [36754.72004754]
bas 9, expnt(s) = [7303.47587497]
bas 10, expnt(s) = [18375.81021513]
bas 11, expnt(s) = [1449.74931237]
bas 12, expnt(s) = [374.02471296]
bas 13, expnt(s) = [113.25922665]
bas 14, expnt(s) = [37.74242103]
bas 15, expnt(s) = [8.08781293]
bas 16, expnt(s) = [3.20657669]
bas 17, expnt(s) = [8.60622985]
bas 18, expnt(s) = [0.4815374]
CPU time:        19.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.81125931e-01 7.01456101e-01 1.17616814e+05 1.60460109e+04
 5.59011705e-01 1.63335543e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347587e+03 1.99600775e+03
 1.83758102e+04 3.98749266e+03 1.44974931e+03 5.93587447e+02
 3.74024713e+02 2.14877156e+02 1.13259227e+02 8.77142629e+01
 3.77424210e+01 3.84713424e+01 8.08781293e+00 1.21168114e+01
 3.20657669e+00 6.05405340e+00 8.60622985e+00 4.30031797e+01
 4.81537398e-01 1.17023187e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.349354309270353
cond(S) = 907718.8191212042
E1 = -689.167823408481  E_coul = 184.60809634980944
init E= -504.559727058672
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.685636752415886  LUMO = 0.40450039773882
  mo_energy =
[-1.21733241e+02 -1.34144399e+01 -7.64531551e+00 -7.64531551e+00
 -7.64531551e+00 -1.66735557e+00 -6.85636752e-01 -6.85636752e-01
 -6.85636752e-01  4.04500398e-01  1.08250456e+01  1.09820003e+02
  6.03992836e+02  2.74356583e+03  1.22227587e+04  4.08442964e+04
  1.04887958e+05  2.30071416e+05  4.55886367e+05  8.44838635e+05
  1.52801591e+06  2.85028331e+06  5.80817060e+06]
E1 = -707.1400439510844  E_coul = 199.18897962947395
cycle= 1 E= -507.95106432161  delta_E= -3.39  |g|= 0.444  |ddm|= 0.48
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.632674
diis-c [-0.40027632  1.        ]
  HOMO = -0.243140249600122  LUMO = 0.736545316989184
  mo_energy =
[-1.20239873e+02 -1.23480393e+01 -6.62994853e+00 -6.62994853e+00
 -6.62994853e+00 -1.18123302e+00 -2.43140250e-01 -2.43140250e-01
 -2.43140250e-01  7.36545317e-01  1.17399350e+01  1.11204485e+02
  6.05472448e+02  2.74498426e+03  1.22240681e+04  4.08455393e+04
  1.04889165e+05  2.30072599e+05  4.55887532e+05  8.44839787e+05
  1.52801705e+06  2.85028444e+06  5.80817172e+06]
E1 = -706.2371818496684  E_coul = 198.2696192343692
cycle= 2 E= -507.967562615299  delta_E= -0.0165  |g|= 0.0335  |ddm|= 0.414
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0284102
diis-c [-8.07133154e-04  1.36777316e-04  9.99863223e-01]
  HOMO = -0.264423653651123  LUMO = 0.732573881978958
  mo_energy =
[-1.20348266e+02 -1.24114179e+01 -6.70026989e+00 -6.70026989e+00
 -6.70026989e+00 -1.19526667e+00 -2.64423654e-01 -2.64423654e-01
 -2.64423654e-01  7.32573882e-01  1.16930460e+01  1.11114255e+02
  6.05360160e+02  2.74485639e+03  1.22239303e+04  4.08453980e+04
  1.04889022e+05  2.30072455e+05  4.55887387e+05  8.44839642e+05
  1.52801690e+06  2.85028430e+06  5.80817158e+06]
E1 = -706.1272726067306  E_coul = 198.1594296862848
cycle= 3 E= -507.967842920446  delta_E= -0.00028  |g|= 0.00458  |ddm|= 0.0621
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0035596
diis-c [-2.22417855e-06 -2.75702592e-04 -1.28149936e-01  1.12842564e+00]
  HOMO = -0.267851913075358  LUMO = 0.731690725521945
  mo_energy =
[-1.20360578e+02 -1.24204578e+01 -6.70980704e+00 -6.70980704e+00
 -6.70980704e+00 -1.19740234e+00 -2.67851913e-01 -2.67851913e-01
 -2.67851913e-01  7.31690726e-01  1.16858847e+01  1.11103225e+02
  6.05347683e+02  2.74484307e+03  1.22239165e+04  4.08453840e+04
  1.04889008e+05  2.30072441e+05  4.55887373e+05  8.44839628e+05
  1.52801689e+06  2.85028428e+06  5.80817157e+06]
E1 = -706.1098664290028  E_coul = 198.1420172418658
cycle= 4 E= -507.967849187137  delta_E= -6.27e-06  |g|= 0.000189  |ddm|= 0.0107
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000139322
diis-c [-1.08335706e-10 -7.22869813e-06  8.05063293e-03 -9.43615144e-02
  1.08631811e+00]
  HOMO = -0.267979492008919  LUMO = 0.731649670720998
  mo_energy =
[-1.20360826e+02 -1.24207412e+01 -6.71008077e+00 -6.71008077e+00
 -6.71008077e+00 -1.19747930e+00 -2.67979492e-01 -2.67979492e-01
 -2.67979492e-01  7.31649671e-01  1.16856377e+01  1.11102965e+02
  6.05347437e+02  2.74484283e+03  1.22239163e+04  4.08453837e+04
  1.04889008e+05  2.30072441e+05  4.55887373e+05  8.44839628e+05
  1.52801689e+06  2.85028428e+06  5.80817157e+06]
E1 = -706.1092278610543  E_coul = 198.14137866443852
cycle= 5 E= -507.967849196616  delta_E= -9.48e-09  |g|= 8.41e-07  |ddm|= 0.00044
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.87368e-07
diis-c [-2.40127328e-14  2.00508580e-07 -1.52310059e-04  1.58589615e-03
 -1.90102001e-02  1.01757641e+00]
  HOMO = -0.26797996580474  LUMO = 0.731649747001653
  mo_energy =
[-1.20360828e+02 -1.24207424e+01 -6.71008212e+00 -6.71008212e+00
 -6.71008212e+00 -1.19747978e+00 -2.67979966e-01 -2.67979966e-01
 -2.67979966e-01  7.31649747e-01  1.16856367e+01  1.11102963e+02
  6.05347435e+02  2.74484283e+03  1.22239163e+04  4.08453837e+04
  1.04889008e+05  2.30072441e+05  4.55887373e+05  8.44839628e+05
  1.52801689e+06  2.85028428e+06  5.80817157e+06]
E1 = -706.1092247343211  E_coul = 198.14137553770487
cycle= 6 E= -507.967849196616  delta_E= -4.55e-13  |g|= 1.83e-08  |ddm|= 1.98e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.1092247343211  E_coul = 198.14137553770487
  HOMO = -0.26797997615393  LUMO = 0.731649741269714
  mo_energy =
[-1.20360828e+02 -1.24207424e+01 -6.71008214e+00 -6.71008214e+00
 -6.71008214e+00 -1.19747978e+00 -2.67979976e-01 -2.67979976e-01
 -2.67979976e-01  7.31649741e-01  1.16856367e+01  1.11102963e+02
  6.05347435e+02  2.74484283e+03  1.22239163e+04  4.08453837e+04
  1.04889008e+05  2.30072441e+05  4.55887373e+05  8.44839628e+05
  1.52801689e+06  2.85028428e+06  5.80817157e+06]
E1 = -706.1092246886221  E_coul = 198.14137549200618
Extra cycle  E= -507.967849196616  delta_E= 2.27e-13  |g|= 2.07e-09  |ddm|= 3.44e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907718.8191212042
E1 = -706.1092246886221  E_coul = 198.14137549200618
init E= -507.967849196616
    CPU time for initialize scf      1.40 sec, wall time      0.09 sec
  HOMO = -0.267979977559125  LUMO = 0.731649740474661
  mo_energy =
[-1.20360828e+02 -1.24207424e+01 -6.71008215e+00 -6.71008215e+00
 -6.71008215e+00 -1.19747978e+00 -2.67979978e-01 -2.67979978e-01
 -2.67979978e-01  7.31649740e-01  1.16856367e+01  1.11102963e+02
  6.05347435e+02  2.74484283e+03  1.22239163e+04  4.08453837e+04
  1.04889008e+05  2.30072441e+05  4.55887373e+05  8.44839628e+05
  1.52801689e+06  2.85028428e+06  5.80817157e+06]
E1 = -706.1092246812817  E_coul = 198.1413754846655
cycle= 1 E= -507.967849196616  delta_E= -2.84e-13  |g|= 1.72e-09  |ddm|= 4.84e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.1092246812817  E_coul = 198.1413754846655
  HOMO = -0.267979977771473  LUMO = 0.731649738411865
  mo_energy =
[-1.20360828e+02 -1.24207424e+01 -6.71008215e+00 -6.71008215e+00
 -6.71008215e+00 -1.19747978e+00 -2.67979978e-01 -2.67979978e-01
 -2.67979978e-01  7.31649738e-01  1.16856367e+01  1.11102963e+02
  6.05347435e+02  2.74484283e+03  1.22239163e+04  4.08453837e+04
  1.04889008e+05  2.30072441e+05  4.55887373e+05  8.44839628e+05
  1.52801689e+06  2.85028428e+06  5.80817157e+06]
E1 = -706.1092246873455  E_coul = 198.14137549072933
Extra cycle  E= -507.967849196616  delta_E=    0  |g|= 1.94e-09  |ddm|= 3.68e-09
    CPU time for scf_cycle      1.57 sec, wall time      0.16 sec
exp = [1.81125931e-01 1.17616814e+05 5.59011705e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347587e+03 1.83758102e+04 1.44974931e+03
 3.74024713e+02 1.13259227e+02 3.77424210e+01 8.08781293e+00
 3.20657669e+00 8.60622985e+00 4.81537398e-01]
grad_E = [-1.07083496e-01  4.17450780e-09  3.90110300e-02  1.86637370e-11
  1.12515678e-10  6.49496421e-10  2.54701471e-09  1.05812132e-08
  5.69319190e-08  3.58058654e-06  1.22318094e-07  5.53777504e-06
 -1.14261488e-05  4.26542120e-05 -2.27057607e-04  3.40932169e-04
 -2.76460118e-03  1.32054920e-02 -4.16105232e-01]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.52603683322        1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.612446604091       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209718        1
[INPUT] 0    0    [1    /1   ]  36754.7200474        1
[INPUT] 0    0    [1    /1   ]  7303.47586683        1
[INPUT] 0    0    [1    /1   ]  18375.8102148        1
[INPUT] 0    0    [1    /1   ]  1449.74930021        1
[INPUT] 0    0    [1    /1   ]  374.024732028        1
[INPUT] 0    0    [1    /1   ]  113.259184987        1
[INPUT] 0    0    [1    /1   ]  37.742692292         1
[INPUT] 0    0    [1    /1   ]  8.08750623972        1
[INPUT] 0    0    [1    /1   ]  3.20994722162        1
[INPUT] 1    0    [1    /1   ]  8.6048138557         1
[INPUT] 1    0    [1    /1   ]  0.532073878017       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.5260368332204248, 1.0]], [0, [117616.81424228805, 1.0]], [0, [0.6124466040905956, 1.0]], [0, [1176168.1426188892, 1.0]], [0, [588084.069992577, 1.0]], [0, [294042.03113195737, 1.0]], [0, [147020.9921480746, 1.0]], [0, [73510.42097177786, 1.0]], [0, [36754.72004741183, 1.0]], [0, [7303.475866831947, 1.0]], [0, [18375.81021484901, 1.0]], [0, [1449.7493002141894, 1.0]], [0, [374.02473202815554, 1.0]], [0, [113.25918498748261, 1.0]], [0, [37.74269229200427, 1.0]], [0, [8.087506239716669, 1.0]], [0, [3.2099472216235454, 1.0]], [1, [8.604813855695705, 1.0]], [1, [0.5320738780167144, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.52603683]
bas 1, expnt(s) = [117616.81424229]
bas 2, expnt(s) = [0.6124466]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113196]
bas 6, expnt(s) = [147020.99214807]
bas 7, expnt(s) = [73510.42097178]
bas 8, expnt(s) = [36754.72004741]
bas 9, expnt(s) = [7303.47586683]
bas 10, expnt(s) = [18375.81021485]
bas 11, expnt(s) = [1449.74930021]
bas 12, expnt(s) = [374.02473203]
bas 13, expnt(s) = [113.25918499]
bas 14, expnt(s) = [37.74269229]
bas 15, expnt(s) = [8.08750624]
bas 16, expnt(s) = [3.20994722]
bas 17, expnt(s) = [8.60481386]
bas 18, expnt(s) = [0.53207388]
CPU time:        24.34
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.26036833e-01 1.56054803e+00 1.17616814e+05 1.60460109e+04
 6.12446604e-01 1.74910627e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347587e+03 1.99600775e+03
 1.83758102e+04 3.98749266e+03 1.44974930e+03 5.93587443e+02
 3.74024732e+02 2.14877165e+02 1.13259185e+02 8.77142387e+01
 3.77426923e+01 3.84715498e+01 8.08750624e+00 1.21164668e+01
 3.20994722e+00 6.05882548e+00 8.60481386e+00 4.29943356e+01
 5.32073878e-01 1.32571239e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.25160609655477
cond(S) = 907742.1812670797
E1 = -690.3831052993824  E_coul = 185.92163624834632
init E= -504.461469051036
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.633122955641385  LUMO = 1.38086755636285
  mo_energy =
[-1.21613855e+02 -1.33015185e+01 -7.57103447e+00 -7.57103447e+00
 -7.57103447e+00 -1.61460097e+00 -6.33122956e-01 -6.33122956e-01
 -6.33122956e-01  1.38086756e+00  1.29145528e+01  1.11591067e+02
  6.05442398e+02  2.74481244e+03  1.22238536e+04  4.08453170e+04
  1.04888941e+05  2.30072375e+05  4.55887308e+05  8.44839563e+05
  1.52801682e+06  2.85028421e+06  5.80817148e+06]
E1 = -709.8586437845631  E_coul = 201.9786569786247
cycle= 1 E= -507.879986805938  delta_E= -3.42  |g|= 0.459  |ddm|= 19.9
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.604495
diis-c [-0.36541463  1.        ]
  HOMO = -0.111964581747447  LUMO = 1.90018612502276
  mo_energy =
[-1.20020544e+02 -1.21387759e+01 -6.46497362e+00 -6.46497362e+00
 -6.46497362e+00 -1.06727160e+00 -1.11964582e-01 -1.11964582e-01
 -1.11964582e-01  1.90018613e+00  1.39185192e+01  1.13069824e+02
  6.07021703e+02  2.74633064e+03  1.22252628e+04  4.08466597e+04
  1.04890247e+05  2.30073657e+05  4.55888572e+05  8.44840814e+05
  1.52801806e+06  2.85028544e+06  5.80817270e+06]
E1 = -709.0616344270586  E_coul = 201.16682947328962
cycle= 2 E= -507.894804953769  delta_E= -0.0148  |g|= 0.0329  |ddm|= 8.33
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0186353
diis-c [-3.22215939e-04  8.21650689e-03  9.91783493e-01]
  HOMO = -0.1292559648466  LUMO = 1.89360386642869
  mo_energy =
[-1.20121035e+02 -1.21938893e+01 -6.52681860e+00 -6.52681860e+00
 -6.52681860e+00 -1.07757473e+00 -1.29255965e-01 -1.29255965e-01
 -1.29255965e-01  1.89360387e+00  1.38777355e+01  1.12987619e+02
  6.06917311e+02  2.74621057e+03  1.22251328e+04  4.08465261e+04
  1.04890112e+05  2.30073521e+05  4.55888436e+05  8.44840677e+05
  1.52801793e+06  2.85028530e+06  5.80817256e+06]
E1 = -708.9826227679899  E_coul = 201.08764668406616
cycle= 3 E= -507.894976083924  delta_E= -0.000171  |g|= 0.00397  |ddm|= 1.23
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00165707
diis-c [-6.34518652e-07  1.66189043e-04 -8.30551899e-02  1.08288900e+00]
  HOMO = -0.131541032286831  LUMO = 1.89257512788783
  mo_energy =
[-1.20130962e+02 -1.22005499e+01 -6.53395720e+00 -6.53395720e+00
 -6.53395720e+00 -1.07887485e+00 -1.31541032e-01 -1.31541032e-01
 -1.31541032e-01  1.89257513e+00  1.38726023e+01  1.12978974e+02
  6.06907211e+02  2.74619961e+03  1.22251213e+04  4.08465144e+04
  1.04890101e+05  2.30073509e+05  4.55888424e+05  8.44840666e+05
  1.52801791e+06  2.85028529e+06  5.80817255e+06]
E1 = -708.9721277086811  E_coul = 201.0771487167366
cycle= 4 E= -507.894978991945  delta_E= -2.91e-06  |g|= 0.000227  |ddm|= 0.181
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.72214e-05
diis-c [-5.69683325e-11 -4.17001034e-06  7.32940907e-03 -1.19386088e-01
  1.11206085e+00]
  HOMO = -0.131672651046534  LUMO = 1.89251127398828
  mo_energy =
[-1.20131389e+02 -1.22009041e+01 -6.53431815e+00 -6.53431815e+00
 -6.53431815e+00 -1.07894948e+00 -1.31672651e-01 -1.31672651e-01
 -1.31672651e-01  1.89251127e+00  1.38723211e+01  1.12978578e+02
  6.06906780e+02  2.74619915e+03  1.22251209e+04  4.08465139e+04
  1.04890100e+05  2.30073509e+05  4.55888424e+05  8.44840665e+05
  1.52801791e+06  2.85028529e+06  5.80817255e+06]
E1 = -708.971526165139  E_coul = 201.07654716364303
cycle= 5 E= -507.894979001496  delta_E= -9.55e-09  |g|= 2.78e-07  |ddm|= 0.0112
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.31094e-07
diis-c [-4.68522752e-15  1.29610528e-07 -8.37620123e-05  1.19617724e-03
 -1.10929502e-02  1.00998041e+00]
  HOMO = -0.131672659073177  LUMO = 1.89251137159631
  mo_energy =
[-1.20131390e+02 -1.22009042e+01 -6.53431833e+00 -6.53431833e+00
 -6.53431833e+00 -1.07894955e+00 -1.31672659e-01 -1.31672659e-01
 -1.31672659e-01  1.89251137e+00  1.38723210e+01  1.12978577e+02
  6.06906779e+02  2.74619915e+03  1.22251209e+04  4.08465139e+04
  1.04890100e+05  2.30073509e+05  4.55888424e+05  8.44840665e+05
  1.52801791e+06  2.85028529e+06  5.80817255e+06]
E1 = -708.971526133752  E_coul = 201.07654713225608
cycle= 6 E= -507.894979001496  delta_E= 1.14e-13  |g|= 4.27e-08  |ddm|= 2.46e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -708.971526133752  E_coul = 201.07654713225608
  HOMO = -0.131672637197258  LUMO = 1.89251138128767
  mo_energy =
[-1.20131390e+02 -1.22009042e+01 -6.53431827e+00 -6.53431827e+00
 -6.53431827e+00 -1.07894954e+00 -1.31672637e-01 -1.31672637e-01
 -1.31672637e-01  1.89251138e+00  1.38723211e+01  1.12978577e+02
  6.06906779e+02  2.74619915e+03  1.22251209e+04  4.08465139e+04
  1.04890100e+05  2.30073509e+05  4.55888424e+05  8.44840665e+05
  1.52801791e+06  2.85028529e+06  5.80817255e+06]
E1 = -708.9715262349574  E_coul = 201.07654723346127
Extra cycle  E= -507.894979001496  delta_E= -2.27e-13  |g|= 5.76e-09  |ddm|= 1.86e-06
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [5.26036833e-01 1.17616814e+05 6.12446604e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347587e+03 1.83758102e+04 1.44974930e+03
 3.74024732e+02 1.13259185e+02 3.77426923e+01 8.08750624e+00
 3.20994722e+00 8.60481386e+00 5.32073878e-01]
E = -507.89497900149615
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.255994836958       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.570610678911       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209718        1
[INPUT] 0    0    [1    /1   ]  36754.7200475        1
[INPUT] 0    0    [1    /1   ]  7303.4758732         1
[INPUT] 0    0    [1    /1   ]  18375.8102151        1
[INPUT] 0    0    [1    /1   ]  1449.74930973        1
[INPUT] 0    0    [1    /1   ]  374.024717099        1
[INPUT] 0    0    [1    /1   ]  113.259217606        1
[INPUT] 0    0    [1    /1   ]  37.7424799144        1
[INPUT] 0    0    [1    /1   ]  8.08774635538        1
[INPUT] 0    0    [1    /1   ]  3.20730832011        1
[INPUT] 1    0    [1    /1   ]  8.60592248665        1
[INPUT] 1    0    [1    /1   ]  0.492507219705       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2559948369581926, 1.0]], [0, [117616.81424229548, 1.0]], [0, [0.5706106789112426, 1.0]], [0, [1176168.1426188892, 1.0]], [0, [588084.0699925772, 1.0]], [0, [294042.0311319585, 1.0]], [0, [147020.99214807915, 1.0]], [0, [73510.42097179667, 1.0]], [0, [36754.72004751308, 1.0]], [0, [7303.47587320041, 1.0]], [0, [18375.810215066624, 1.0]], [0, [1449.7493097327415, 1.0]], [0, [374.0247170990883, 1.0]], [0, [113.25921760635684, 1.0]], [0, [37.74247991444298, 1.0]], [0, [8.087746355380554, 1.0]], [0, [3.2073083201106427, 1.0]], [1, [8.605922486652101, 1.0]], [1, [0.4925072197045284, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25599484]
bas 1, expnt(s) = [117616.8142423]
bas 2, expnt(s) = [0.57061068]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113196]
bas 6, expnt(s) = [147020.99214808]
bas 7, expnt(s) = [73510.4209718]
bas 8, expnt(s) = [36754.72004751]
bas 9, expnt(s) = [7303.4758732]
bas 10, expnt(s) = [18375.81021507]
bas 11, expnt(s) = [1449.74930973]
bas 12, expnt(s) = [374.0247171]
bas 13, expnt(s) = [113.25921761]
bas 14, expnt(s) = [37.74247991]
bas 15, expnt(s) = [8.08774636]
bas 16, expnt(s) = [3.20730832]
bas 17, expnt(s) = [8.60592249]
bas 18, expnt(s) = [0.49250722]
CPU time:        24.83
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.55994837e-01 9.09260718e-01 1.17616814e+05 1.60460109e+04
 5.70610679e-01 1.65870802e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347587e+03 1.99600775e+03
 1.83758102e+04 3.98749266e+03 1.44974931e+03 5.93587446e+02
 3.74024717e+02 2.14877158e+02 1.13259218e+02 8.77142576e+01
 3.77424799e+01 3.84713874e+01 8.08774636e+00 1.21167366e+01
 3.20730832e+00 6.05508937e+00 8.60592249e+00 4.30012599e+01
 4.92507220e-01 1.20364979e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335164598654586
cond(S) = 907723.6033742784
E1 = -689.5070839428818  E_coul = 184.9271432806462
init E= -504.579940662236
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.67414394321683  LUMO = 0.631872230424686
  mo_energy =
[-1.21705126e+02 -1.33880474e+01 -7.62692563e+00 -7.62692563e+00
 -7.62692563e+00 -1.65682109e+00 -6.74143943e-01 -6.74143943e-01
 -6.74143943e-01  6.31872230e-01  1.12882494e+01  1.10195724e+02
  6.04299438e+02  2.74382977e+03  1.22229908e+04  4.08445130e+04
  1.04888167e+05  2.30071620e+05  4.55886567e+05  8.44838832e+05
  1.52801610e+06  2.85028350e+06  5.80817079e+06]
E1 = -707.6609764642452  E_coul = 199.7069523652853
cycle= 1 E= -507.95402409896  delta_E= -3.37  |g|= 0.449  |ddm|= 0.62
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.62288
diis-c [-0.38797975  1.        ]
  HOMO = -0.218714812941239  LUMO = 1.01039335707827
  mo_energy =
[-1.20200994e+02 -1.23091012e+01 -6.60062449e+00 -6.60062449e+00
 -6.60062449e+00 -1.16276030e+00 -2.18714813e-01 -2.18714813e-01
 -2.18714813e-01  1.01039336e+00  1.22149435e+01  1.11590558e+02
  6.05789642e+02  2.74525814e+03  1.22243098e+04  4.08457654e+04
  1.04889383e+05  2.30072812e+05  4.55887741e+05  8.44839993e+05
  1.52801725e+06  2.85028464e+06  5.80817192e+06]
E1 = -706.7714588465483  E_coul = 198.80108528217266
cycle= 2 E= -507.970373564376  delta_E= -0.0163  |g|= 0.0338  |ddm|= 0.477
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0248161
diis-c [-6.12552780e-04  2.90379972e-03  9.97096200e-01]
  HOMO = -0.239170039149267  LUMO = 1.0054288406797
  mo_energy =
[-1.20308834e+02 -1.23714264e+01 -6.66992947e+00 -6.66992947e+00
 -6.66992947e+00 -1.17587710e+00 -2.39170039e-01 -2.39170039e-01
 -2.39170039e-01  1.00542884e+00  1.21688422e+01  1.11501061e+02
  6.05677884e+02  2.74513067e+03  1.22241724e+04  4.08456243e+04
  1.04889240e+05  2.30072668e+05  4.55887597e+05  8.44839849e+05
  1.52801711e+06  2.85028450e+06  5.80817178e+06]
E1 = -706.6688001898079  E_coul = 198.6981744445193
cycle= 3 E= -507.970625745289  delta_E= -0.000252  |g|= 0.0045  |ddm|= 0.0679
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00284441
diis-c [-1.57117699e-06 -1.85946061e-04 -1.14944043e-01  1.11512999e+00]
  HOMO = -0.242294467491444  LUMO = 1.00444739888115
  mo_energy =
[-1.20320719e+02 -1.23799592e+01 -6.67896841e+00 -6.67896841e+00
 -6.67896841e+00 -1.17777229e+00 -2.42294467e-01 -2.42294467e-01
 -2.42294467e-01  1.00444740e+00  1.21621496e+01  1.11490491e+02
  6.05665828e+02  2.74511775e+03  1.22241590e+04  4.08456107e+04
  1.04889227e+05  2.30072654e+05  4.55887583e+05  8.44839835e+05
  1.52801709e+06  2.85028448e+06  5.80817176e+06]
E1 = -706.6532204569501  E_coul = 198.68258942902688
cycle= 4 E= -507.970631027923  delta_E= -5.28e-06  |g|= 0.000208  |ddm|= 0.0111
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00012393
diis-c [-7.95675737e-11 -5.91751727e-06  7.87845368e-03 -1.01938438e-01
  1.09406590e+00]
  HOMO = -0.242430831106691  LUMO = 1.00439732710237
  mo_energy =
[-1.20321046e+02 -1.23802861e+01 -6.67929111e+00 -6.67929111e+00
 -6.67929111e+00 -1.17785316e+00 -2.42430831e-01 -2.42430831e-01
 -2.42430831e-01  1.00439733e+00  1.21618756e+01  1.11490166e+02
  6.05665501e+02  2.74511742e+03  1.22241586e+04  4.08456104e+04
  1.04889226e+05  2.30072654e+05  4.55887583e+05  8.44839835e+05
  1.52801709e+06  2.85028448e+06  5.80817176e+06]
E1 = -706.6525455193938  E_coul = 198.6819144808708
cycle= 5 E= -507.970631038523  delta_E= -1.06e-08  |g|= 6.42e-07  |ddm|= 0.00053
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.16911e-07
diis-c [-6.78369755e-15  1.67337317e-07 -9.99774862e-05  1.10406865e-03
 -1.22881733e-02  1.01128391e+00]
  HOMO = -0.242431220057049  LUMO = 1.00439737341623
  mo_energy =
[-1.20321048e+02 -1.23802872e+01 -6.67929231e+00 -6.67929231e+00
 -6.67929231e+00 -1.17785353e+00 -2.42431220e-01 -2.42431220e-01
 -2.42431220e-01  1.00439737e+00  1.21618748e+01  1.11490165e+02
  6.05665499e+02  2.74511742e+03  1.22241586e+04  4.08456104e+04
  1.04889226e+05  2.30072654e+05  4.55887583e+05  8.44839835e+05
  1.52801709e+06  2.85028448e+06  5.80817176e+06]
E1 = -706.652543244424  E_coul = 198.68191220590077
cycle= 6 E= -507.970631038523  delta_E= -2.27e-13  |g|= 1.07e-08  |ddm|= 1.63e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.652543244424  E_coul = 198.68191220590077
  HOMO = -0.242431226254447  LUMO = 1.00439736753638
  mo_energy =
[-1.20321048e+02 -1.23802872e+01 -6.67929232e+00 -6.67929232e+00
 -6.67929232e+00 -1.17785354e+00 -2.42431226e-01 -2.42431226e-01
 -2.42431226e-01  1.00439737e+00  1.21618748e+01  1.11490164e+02
  6.05665499e+02  2.74511742e+03  1.22241586e+04  4.08456104e+04
  1.04889226e+05  2.30072654e+05  4.55887583e+05  8.44839835e+05
  1.52801709e+06  2.85028448e+06  5.80817176e+06]
E1 = -706.6525432184142  E_coul = 198.68191217989101
Extra cycle  E= -507.970631038523  delta_E= 1.14e-13  |g|= 1.88e-09  |ddm|= 2.21e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.55994837e-01 1.17616814e+05 5.70610679e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347587e+03 1.83758102e+04 1.44974931e+03
 3.74024717e+02 1.13259218e+02 3.77424799e+01 8.08774636e+00
 3.20730832e+00 8.60592249e+00 4.92507220e-01]
E = -507.97063103852315
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.255994836958       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.570610678911       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209718        1
[INPUT] 0    0    [1    /1   ]  36754.7200475        1
[INPUT] 0    0    [1    /1   ]  7303.4758732         1
[INPUT] 0    0    [1    /1   ]  18375.8102151        1
[INPUT] 0    0    [1    /1   ]  1449.74930973        1
[INPUT] 0    0    [1    /1   ]  374.024717099        1
[INPUT] 0    0    [1    /1   ]  113.259217606        1
[INPUT] 0    0    [1    /1   ]  37.7424799144        1
[INPUT] 0    0    [1    /1   ]  8.08774635538        1
[INPUT] 0    0    [1    /1   ]  3.20730832011        1
[INPUT] 1    0    [1    /1   ]  8.60592248665        1
[INPUT] 1    0    [1    /1   ]  0.492507219705       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2559948369581926, 1.0]], [0, [117616.81424229548, 1.0]], [0, [0.5706106789112426, 1.0]], [0, [1176168.1426188892, 1.0]], [0, [588084.0699925772, 1.0]], [0, [294042.0311319585, 1.0]], [0, [147020.99214807915, 1.0]], [0, [73510.42097179667, 1.0]], [0, [36754.72004751308, 1.0]], [0, [7303.47587320041, 1.0]], [0, [18375.810215066624, 1.0]], [0, [1449.7493097327415, 1.0]], [0, [374.0247170990883, 1.0]], [0, [113.25921760635684, 1.0]], [0, [37.74247991444298, 1.0]], [0, [8.087746355380554, 1.0]], [0, [3.2073083201106427, 1.0]], [1, [8.605922486652101, 1.0]], [1, [0.4925072197045284, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25599484]
bas 1, expnt(s) = [117616.8142423]
bas 2, expnt(s) = [0.57061068]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113196]
bas 6, expnt(s) = [147020.99214808]
bas 7, expnt(s) = [73510.4209718]
bas 8, expnt(s) = [36754.72004751]
bas 9, expnt(s) = [7303.4758732]
bas 10, expnt(s) = [18375.81021507]
bas 11, expnt(s) = [1449.74930973]
bas 12, expnt(s) = [374.0247171]
bas 13, expnt(s) = [113.25921761]
bas 14, expnt(s) = [37.74247991]
bas 15, expnt(s) = [8.08774636]
bas 16, expnt(s) = [3.20730832]
bas 17, expnt(s) = [8.60592249]
bas 18, expnt(s) = [0.49250722]
CPU time:        25.32
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.55994837e-01 9.09260718e-01 1.17616814e+05 1.60460109e+04
 5.70610679e-01 1.65870802e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347587e+03 1.99600775e+03
 1.83758102e+04 3.98749266e+03 1.44974931e+03 5.93587446e+02
 3.74024717e+02 2.14877158e+02 1.13259218e+02 8.77142576e+01
 3.77424799e+01 3.84713874e+01 8.08774636e+00 1.21167366e+01
 3.20730832e+00 6.05508937e+00 8.60592249e+00 4.30012599e+01
 4.92507220e-01 1.20364979e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335164598654586
cond(S) = 907723.6033742784
E1 = -689.5070839428818  E_coul = 184.9271432806462
init E= -504.579940662236
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.67414394321683  LUMO = 0.631872230424686
  mo_energy =
[-1.21705126e+02 -1.33880474e+01 -7.62692563e+00 -7.62692563e+00
 -7.62692563e+00 -1.65682109e+00 -6.74143943e-01 -6.74143943e-01
 -6.74143943e-01  6.31872230e-01  1.12882494e+01  1.10195724e+02
  6.04299438e+02  2.74382977e+03  1.22229908e+04  4.08445130e+04
  1.04888167e+05  2.30071620e+05  4.55886567e+05  8.44838832e+05
  1.52801610e+06  2.85028350e+06  5.80817079e+06]
E1 = -707.6609764642452  E_coul = 199.7069523652853
cycle= 1 E= -507.95402409896  delta_E= -3.37  |g|= 0.449  |ddm|= 0.62
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.62288
diis-c [-0.38797975  1.        ]
  HOMO = -0.218714812941239  LUMO = 1.01039335707827
  mo_energy =
[-1.20200994e+02 -1.23091012e+01 -6.60062449e+00 -6.60062449e+00
 -6.60062449e+00 -1.16276030e+00 -2.18714813e-01 -2.18714813e-01
 -2.18714813e-01  1.01039336e+00  1.22149435e+01  1.11590558e+02
  6.05789642e+02  2.74525814e+03  1.22243098e+04  4.08457654e+04
  1.04889383e+05  2.30072812e+05  4.55887741e+05  8.44839993e+05
  1.52801725e+06  2.85028464e+06  5.80817192e+06]
E1 = -706.7714588465483  E_coul = 198.80108528217266
cycle= 2 E= -507.970373564376  delta_E= -0.0163  |g|= 0.0338  |ddm|= 0.477
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0248161
diis-c [-6.12552780e-04  2.90379972e-03  9.97096200e-01]
  HOMO = -0.239170039149267  LUMO = 1.0054288406797
  mo_energy =
[-1.20308834e+02 -1.23714264e+01 -6.66992947e+00 -6.66992947e+00
 -6.66992947e+00 -1.17587710e+00 -2.39170039e-01 -2.39170039e-01
 -2.39170039e-01  1.00542884e+00  1.21688422e+01  1.11501061e+02
  6.05677884e+02  2.74513067e+03  1.22241724e+04  4.08456243e+04
  1.04889240e+05  2.30072668e+05  4.55887597e+05  8.44839849e+05
  1.52801711e+06  2.85028450e+06  5.80817178e+06]
E1 = -706.6688001898079  E_coul = 198.6981744445193
cycle= 3 E= -507.970625745289  delta_E= -0.000252  |g|= 0.0045  |ddm|= 0.0679
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00284441
diis-c [-1.57117699e-06 -1.85946061e-04 -1.14944043e-01  1.11512999e+00]
  HOMO = -0.242294467491444  LUMO = 1.00444739888115
  mo_energy =
[-1.20320719e+02 -1.23799592e+01 -6.67896841e+00 -6.67896841e+00
 -6.67896841e+00 -1.17777229e+00 -2.42294467e-01 -2.42294467e-01
 -2.42294467e-01  1.00444740e+00  1.21621496e+01  1.11490491e+02
  6.05665828e+02  2.74511775e+03  1.22241590e+04  4.08456107e+04
  1.04889227e+05  2.30072654e+05  4.55887583e+05  8.44839835e+05
  1.52801709e+06  2.85028448e+06  5.80817176e+06]
E1 = -706.6532204569501  E_coul = 198.68258942902688
cycle= 4 E= -507.970631027923  delta_E= -5.28e-06  |g|= 0.000208  |ddm|= 0.0111
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00012393
diis-c [-7.95675737e-11 -5.91751727e-06  7.87845368e-03 -1.01938438e-01
  1.09406590e+00]
  HOMO = -0.242430831106691  LUMO = 1.00439732710237
  mo_energy =
[-1.20321046e+02 -1.23802861e+01 -6.67929111e+00 -6.67929111e+00
 -6.67929111e+00 -1.17785316e+00 -2.42430831e-01 -2.42430831e-01
 -2.42430831e-01  1.00439733e+00  1.21618756e+01  1.11490166e+02
  6.05665501e+02  2.74511742e+03  1.22241586e+04  4.08456104e+04
  1.04889226e+05  2.30072654e+05  4.55887583e+05  8.44839835e+05
  1.52801709e+06  2.85028448e+06  5.80817176e+06]
E1 = -706.6525455193938  E_coul = 198.6819144808708
cycle= 5 E= -507.970631038523  delta_E= -1.06e-08  |g|= 6.42e-07  |ddm|= 0.00053
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.16911e-07
diis-c [-6.78369755e-15  1.67337317e-07 -9.99774862e-05  1.10406865e-03
 -1.22881733e-02  1.01128391e+00]
  HOMO = -0.242431220057049  LUMO = 1.00439737341623
  mo_energy =
[-1.20321048e+02 -1.23802872e+01 -6.67929231e+00 -6.67929231e+00
 -6.67929231e+00 -1.17785353e+00 -2.42431220e-01 -2.42431220e-01
 -2.42431220e-01  1.00439737e+00  1.21618748e+01  1.11490165e+02
  6.05665499e+02  2.74511742e+03  1.22241586e+04  4.08456104e+04
  1.04889226e+05  2.30072654e+05  4.55887583e+05  8.44839835e+05
  1.52801709e+06  2.85028448e+06  5.80817176e+06]
E1 = -706.652543244424  E_coul = 198.68191220590077
cycle= 6 E= -507.970631038523  delta_E= -2.27e-13  |g|= 1.07e-08  |ddm|= 1.63e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.652543244424  E_coul = 198.68191220590077
  HOMO = -0.242431226254447  LUMO = 1.00439736753638
  mo_energy =
[-1.20321048e+02 -1.23802872e+01 -6.67929232e+00 -6.67929232e+00
 -6.67929232e+00 -1.17785354e+00 -2.42431226e-01 -2.42431226e-01
 -2.42431226e-01  1.00439737e+00  1.21618748e+01  1.11490164e+02
  6.05665499e+02  2.74511742e+03  1.22241586e+04  4.08456104e+04
  1.04889226e+05  2.30072654e+05  4.55887583e+05  8.44839835e+05
  1.52801709e+06  2.85028448e+06  5.80817176e+06]
E1 = -706.6525432184142  E_coul = 198.68191217989101
Extra cycle  E= -507.970631038523  delta_E= 1.14e-13  |g|= 1.88e-09  |ddm|= 2.21e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907723.6033742784
E1 = -706.6525432184142  E_coul = 198.68191217989101
init E= -507.970631038523
    CPU time for initialize scf      1.47 sec, wall time      0.09 sec
  HOMO = -0.242431227020072  LUMO = 1.00439736742581
  mo_energy =
[-1.20321048e+02 -1.23802872e+01 -6.67929232e+00 -6.67929232e+00
 -6.67929232e+00 -1.17785354e+00 -2.42431227e-01 -2.42431227e-01
 -2.42431227e-01  1.00439737e+00  1.21618748e+01  1.11490164e+02
  6.05665499e+02  2.74511742e+03  1.22241586e+04  4.08456104e+04
  1.04889226e+05  2.30072654e+05  4.55887583e+05  8.44839835e+05
  1.52801709e+06  2.85028448e+06  5.80817176e+06]
E1 = -706.6525432166742  E_coul = 198.68191217815107
cycle= 1 E= -507.970631038523  delta_E=    0  |g|= 1.68e-09  |ddm|= 1.62e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.6525432166742  E_coul = 198.68191217815107
  HOMO = -0.242431227082608  LUMO = 1.00439736981888
  mo_energy =
[-1.20321048e+02 -1.23802872e+01 -6.67929232e+00 -6.67929232e+00
 -6.67929232e+00 -1.17785354e+00 -2.42431227e-01 -2.42431227e-01
 -2.42431227e-01  1.00439737e+00  1.21618748e+01  1.11490164e+02
  6.05665499e+02  2.74511742e+03  1.22241586e+04  4.08456104e+04
  1.04889226e+05  2.30072654e+05  4.55887583e+05  8.44839835e+05
  1.52801709e+06  2.85028448e+06  5.80817176e+06]
E1 = -706.6525432136718  E_coul = 198.68191217514894
Extra cycle  E= -507.970631038523  delta_E= 2.27e-13  |g|= 2.51e-09  |ddm|= 2.27e-09
    CPU time for scf_cycle      1.64 sec, wall time      0.16 sec
exp = [2.55994837e-01 1.17616814e+05 5.70610679e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347587e+03 1.83758102e+04 1.44974931e+03
 3.74024717e+02 1.13259218e+02 3.77424799e+01 8.08774636e+00
 3.20730832e+00 8.60592249e+00 4.92507220e-01]
grad_E = [ 7.59774613e-02  4.17368055e-09 -4.79306316e-02  1.86582651e-11
  1.12491375e-10  6.49369172e-10  2.54650638e-09  1.05790813e-08
  5.69210431e-08  3.57993490e-06  1.22288853e-07  5.54306101e-06
 -1.15432208e-05  4.03726840e-05 -1.95521516e-04  1.78845504e-03
 -1.09397378e-02  1.52950738e-03 -1.43621801e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.22544746753        1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.561413318346       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209718        1
[INPUT] 0    0    [1    /1   ]  36754.7200475        1
[INPUT] 0    0    [1    /1   ]  7303.47587029        1
[INPUT] 0    0    [1    /1   ]  18375.810215         1
[INPUT] 0    0    [1    /1   ]  1449.74930518        1
[INPUT] 0    0    [1    /1   ]  374.024727069        1
[INPUT] 0    0    [1    /1   ]  113.25917949         1
[INPUT] 0    0    [1    /1   ]  37.7426677293        1
[INPUT] 0    0    [1    /1   ]  8.08658005053        1
[INPUT] 0    0    [1    /1   ]  3.21478248208        1
[INPUT] 1    0    [1    /1   ]  8.60450174665        1
[INPUT] 1    0    [1    /1   ]  0.492189467169       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.22544746752959677, 1.0]], [0, [117616.81424229208, 1.0]], [0, [0.5614133183458128, 1.0]], [0, [1176168.1426188892, 1.0]], [0, [588084.0699925771, 1.0]], [0, [294042.03113195795, 1.0]], [0, [147020.9921480771, 1.0]], [0, [73510.42097178806, 1.0]], [0, [36754.72004746673, 1.0]], [0, [7303.475870285363, 1.0]], [0, [18375.810214967052, 1.0]], [0, [1449.7493051842062, 1.0]], [0, [374.0247270693425, 1.0]], [0, [113.25917949020457, 1.0]], [0, [37.74266772926192, 1.0]], [0, [8.086580050530822, 1.0]], [0, [3.214782482077651, 1.0]], [1, [8.604501746650774, 1.0]], [1, [0.49218946716944395, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22544747]
bas 1, expnt(s) = [117616.81424229]
bas 2, expnt(s) = [0.56141332]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113196]
bas 6, expnt(s) = [147020.99214808]
bas 7, expnt(s) = [73510.42097179]
bas 8, expnt(s) = [36754.72004747]
bas 9, expnt(s) = [7303.47587029]
bas 10, expnt(s) = [18375.81021497]
bas 11, expnt(s) = [1449.74930518]
bas 12, expnt(s) = [374.02472707]
bas 13, expnt(s) = [113.25917949]
bas 14, expnt(s) = [37.74266773]
bas 15, expnt(s) = [8.08658005]
bas 16, expnt(s) = [3.21478248]
bas 17, expnt(s) = [8.60450175]
bas 18, expnt(s) = [0.49218947]
CPU time:        30.04
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.25447468e-01 8.26606936e-01 1.17616814e+05 1.60460109e+04
 5.61413318e-01 1.63861550e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347587e+03 1.99600775e+03
 1.83758102e+04 3.98749266e+03 1.44974931e+03 5.93587444e+02
 3.74024727e+02 2.14877162e+02 1.13259179e+02 8.77142355e+01
 3.77426677e+01 3.84715310e+01 8.08658005e+00 1.21154261e+01
 3.21478248e+00 6.06566916e+00 8.60450175e+00 4.29923863e+01
 4.92189467e-01 1.20267916e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33644742881573
cond(S) = 907721.6912790139
E1 = -689.516607596143  E_coul = 184.92741843532426
init E= -504.589189160819
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.673823290579771  LUMO = 0.53777414296114
  mo_energy =
[-1.21706294e+02 -1.33879427e+01 -7.62669375e+00 -7.62669375e+00
 -7.62669375e+00 -1.65732245e+00 -6.73823291e-01 -6.73823291e-01
 -6.73823291e-01  5.37774143e-01  1.11059007e+01  1.10062681e+02
  6.04193843e+02  2.74374031e+03  1.22229133e+04  4.08444413e+04
  1.04888098e+05  2.30071553e+05  4.55886501e+05  8.44838768e+05
  1.52801604e+06  2.85028344e+06  5.80817073e+06]
E1 = -707.6353201166928  E_coul = 199.68033168385483
cycle= 1 E= -507.954988432838  delta_E= -3.37  |g|= 0.448  |ddm|= 0.553
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.62701
diis-c [-0.39314139  1.        ]
  HOMO = -0.219896315139535  LUMO = 0.899854966208642
  mo_energy =
[-1.20203528e+02 -1.23109015e+01 -6.60210284e+00 -6.60210284e+00
 -6.60210284e+00 -1.16433640e+00 -2.19896315e-01 -2.19896315e-01
 -2.19896315e-01  8.99854966e-01  1.20314084e+01  1.11456435e+02
  6.05682690e+02  2.74516741e+03  1.22242310e+04  4.08456924e+04
  1.04889313e+05  2.30072743e+05  4.55887674e+05  8.44839927e+05
  1.52801719e+06  2.85028458e+06  5.80817186e+06]
E1 = -706.7345254538816  E_coul = 198.76293180337814
cycle= 2 E= -507.971593650503  delta_E= -0.0166  |g|= 0.0339  |ddm|= 0.455
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0262527
diis-c [-6.87939142e-04  1.79172596e-03  9.98208274e-01]
  HOMO = -0.240938901342335  LUMO = 0.89526226548384
  mo_energy =
[-1.20312163e+02 -1.23740721e+01 -6.67222424e+00 -6.67222424e+00
 -6.67222424e+00 -1.17790000e+00 -2.40938901e-01 -2.40938901e-01
 -2.40938901e-01  8.95262265e-01  1.19846445e+01  1.11366129e+02
  6.05570137e+02  2.74503915e+03  1.22240928e+04  4.08455505e+04
  1.04889169e+05  2.30072599e+05  4.55887529e+05  8.44839783e+05
  1.52801704e+06  2.85028443e+06  5.80817171e+06]
E1 = -706.6279411699554  E_coul = 198.656079296629
cycle= 3 E= -507.971861873326  delta_E= -0.000268  |g|= 0.00458  |ddm|= 0.0661
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00312769
diis-c [-1.82852424e-06 -2.26716498e-04 -1.20434075e-01  1.12066079e+00]
  HOMO = -0.244228692347834  LUMO = 0.894308702423912
  mo_energy =
[-1.20324326e+02 -1.23828919e+01 -6.68154602e+00 -6.68154602e+00
 -6.68154602e+00 -1.17990478e+00 -2.44228692e-01 -2.44228692e-01
 -2.44228692e-01  8.94308702e-01  1.19776958e+01  1.11355277e+02
  6.05557803e+02  2.74502595e+03  1.22240791e+04  4.08455366e+04
  1.04889155e+05  2.30072585e+05  4.55887515e+05  8.44839769e+05
  1.52801703e+06  2.85028442e+06  5.80817170e+06]
E1 = -706.6114312956496  E_coul = 198.63956362162565
cycle= 4 E= -507.971867674024  delta_E= -5.8e-06  |g|= 0.000203  |ddm|= 0.0111
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000131375
diis-c [-8.92667102e-11 -6.36839375e-06  7.96846755e-03 -9.91585346e-02
  1.09119644e+00]
  HOMO = -0.244364535830283  LUMO = 0.894261539815878
  mo_energy =
[-1.20324629e+02 -1.23832077e+01 -6.68185546e+00 -6.68185546e+00
 -6.68185546e+00 -1.17998544e+00 -2.44364536e-01 -2.44364536e-01
 -2.44364536e-01  8.94261540e-01  1.19774274e+01  1.11354971e+02
  6.05557501e+02  2.74502566e+03  1.22240788e+04  4.08455363e+04
  1.04889155e+05  2.30072585e+05  4.55887515e+05  8.44839768e+05
  1.52801703e+06  2.85028442e+06  5.80817170e+06]
E1 = -706.6107553341079  E_coul = 198.63888764952515
cycle= 5 E= -507.971867684583  delta_E= -1.06e-08  |g|= 7.3e-07  |ddm|= 0.000501
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.78287e-07
diis-c [-1.19939434e-14  1.75207089e-07 -1.15724919e-04  1.24666482e-03
 -1.42857753e-02  1.01315466e+00]
  HOMO = -0.244364970153381  LUMO = 0.89426159840009
  mo_energy =
[-1.20324631e+02 -1.23832089e+01 -6.68185675e+00 -6.68185675e+00
 -6.68185675e+00 -1.17998586e+00 -2.44364970e-01 -2.44364970e-01
 -2.44364970e-01  8.94261598e-01  1.19774265e+01  1.11354970e+02
  6.05557499e+02  2.74502565e+03  1.22240788e+04  4.08455363e+04
  1.04889155e+05  2.30072585e+05  4.55887515e+05  8.44839768e+05
  1.52801703e+06  2.85028442e+06  5.80817170e+06]
E1 = -706.6107526834984  E_coul = 198.63888499891567
cycle= 6 E= -507.971867684583  delta_E= 5.68e-14  |g|= 1.5e-08  |ddm|= 1.8e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6107526834984  E_coul = 198.63888499891567
  HOMO = -0.244364978603249  LUMO = 0.894261592604916
  mo_energy =
[-1.20324631e+02 -1.23832089e+01 -6.68185676e+00 -6.68185676e+00
 -6.68185676e+00 -1.17998587e+00 -2.44364979e-01 -2.44364979e-01
 -2.44364979e-01  8.94261593e-01  1.19774265e+01  1.11354970e+02
  6.05557499e+02  2.74502565e+03  1.22240788e+04  4.08455363e+04
  1.04889155e+05  2.30072585e+05  4.55887515e+05  8.44839768e+05
  1.52801703e+06  2.85028442e+06  5.80817170e+06]
E1 = -706.6107526466295  E_coul = 198.63888496204706
Extra cycle  E= -507.971867684582  delta_E= 2.84e-13  |g|= 2.15e-09  |ddm|= 2.95e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.25447468e-01 1.17616814e+05 5.61413318e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347587e+03 1.83758102e+04 1.44974931e+03
 3.74024727e+02 1.13259179e+02 3.77426677e+01 8.08658005e+00
 3.21478248e+00 8.60450175e+00 4.92189467e-01]
E = -507.97186768458243
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.22544746753        1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.561413318346       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209718        1
[INPUT] 0    0    [1    /1   ]  36754.7200475        1
[INPUT] 0    0    [1    /1   ]  7303.47587029        1
[INPUT] 0    0    [1    /1   ]  18375.810215         1
[INPUT] 0    0    [1    /1   ]  1449.74930518        1
[INPUT] 0    0    [1    /1   ]  374.024727069        1
[INPUT] 0    0    [1    /1   ]  113.25917949         1
[INPUT] 0    0    [1    /1   ]  37.7426677293        1
[INPUT] 0    0    [1    /1   ]  8.08658005053        1
[INPUT] 0    0    [1    /1   ]  3.21478248208        1
[INPUT] 1    0    [1    /1   ]  8.60450174665        1
[INPUT] 1    0    [1    /1   ]  0.492189467169       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.22544746752959677, 1.0]], [0, [117616.81424229208, 1.0]], [0, [0.5614133183458128, 1.0]], [0, [1176168.1426188892, 1.0]], [0, [588084.0699925771, 1.0]], [0, [294042.03113195795, 1.0]], [0, [147020.9921480771, 1.0]], [0, [73510.42097178806, 1.0]], [0, [36754.72004746673, 1.0]], [0, [7303.475870285363, 1.0]], [0, [18375.810214967052, 1.0]], [0, [1449.7493051842062, 1.0]], [0, [374.0247270693425, 1.0]], [0, [113.25917949020457, 1.0]], [0, [37.74266772926192, 1.0]], [0, [8.086580050530822, 1.0]], [0, [3.214782482077651, 1.0]], [1, [8.604501746650774, 1.0]], [1, [0.49218946716944395, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22544747]
bas 1, expnt(s) = [117616.81424229]
bas 2, expnt(s) = [0.56141332]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113196]
bas 6, expnt(s) = [147020.99214808]
bas 7, expnt(s) = [73510.42097179]
bas 8, expnt(s) = [36754.72004747]
bas 9, expnt(s) = [7303.47587029]
bas 10, expnt(s) = [18375.81021497]
bas 11, expnt(s) = [1449.74930518]
bas 12, expnt(s) = [374.02472707]
bas 13, expnt(s) = [113.25917949]
bas 14, expnt(s) = [37.74266773]
bas 15, expnt(s) = [8.08658005]
bas 16, expnt(s) = [3.21478248]
bas 17, expnt(s) = [8.60450175]
bas 18, expnt(s) = [0.49218947]
CPU time:        30.53
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.25447468e-01 8.26606936e-01 1.17616814e+05 1.60460109e+04
 5.61413318e-01 1.63861550e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347587e+03 1.99600775e+03
 1.83758102e+04 3.98749266e+03 1.44974931e+03 5.93587444e+02
 3.74024727e+02 2.14877162e+02 1.13259179e+02 8.77142355e+01
 3.77426677e+01 3.84715310e+01 8.08658005e+00 1.21154261e+01
 3.21478248e+00 6.06566916e+00 8.60450175e+00 4.29923863e+01
 4.92189467e-01 1.20267916e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33644742881573
cond(S) = 907721.6912790139
E1 = -689.516607596143  E_coul = 184.92741843532426
init E= -504.589189160819
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.673823290579771  LUMO = 0.53777414296114
  mo_energy =
[-1.21706294e+02 -1.33879427e+01 -7.62669375e+00 -7.62669375e+00
 -7.62669375e+00 -1.65732245e+00 -6.73823291e-01 -6.73823291e-01
 -6.73823291e-01  5.37774143e-01  1.11059007e+01  1.10062681e+02
  6.04193843e+02  2.74374031e+03  1.22229133e+04  4.08444413e+04
  1.04888098e+05  2.30071553e+05  4.55886501e+05  8.44838768e+05
  1.52801604e+06  2.85028344e+06  5.80817073e+06]
E1 = -707.6353201166928  E_coul = 199.68033168385483
cycle= 1 E= -507.954988432838  delta_E= -3.37  |g|= 0.448  |ddm|= 0.553
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.62701
diis-c [-0.39314139  1.        ]
  HOMO = -0.219896315139535  LUMO = 0.899854966208642
  mo_energy =
[-1.20203528e+02 -1.23109015e+01 -6.60210284e+00 -6.60210284e+00
 -6.60210284e+00 -1.16433640e+00 -2.19896315e-01 -2.19896315e-01
 -2.19896315e-01  8.99854966e-01  1.20314084e+01  1.11456435e+02
  6.05682690e+02  2.74516741e+03  1.22242310e+04  4.08456924e+04
  1.04889313e+05  2.30072743e+05  4.55887674e+05  8.44839927e+05
  1.52801719e+06  2.85028458e+06  5.80817186e+06]
E1 = -706.7345254538816  E_coul = 198.76293180337814
cycle= 2 E= -507.971593650503  delta_E= -0.0166  |g|= 0.0339  |ddm|= 0.455
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0262527
diis-c [-6.87939142e-04  1.79172596e-03  9.98208274e-01]
  HOMO = -0.240938901342335  LUMO = 0.89526226548384
  mo_energy =
[-1.20312163e+02 -1.23740721e+01 -6.67222424e+00 -6.67222424e+00
 -6.67222424e+00 -1.17790000e+00 -2.40938901e-01 -2.40938901e-01
 -2.40938901e-01  8.95262265e-01  1.19846445e+01  1.11366129e+02
  6.05570137e+02  2.74503915e+03  1.22240928e+04  4.08455505e+04
  1.04889169e+05  2.30072599e+05  4.55887529e+05  8.44839783e+05
  1.52801704e+06  2.85028443e+06  5.80817171e+06]
E1 = -706.6279411699554  E_coul = 198.656079296629
cycle= 3 E= -507.971861873326  delta_E= -0.000268  |g|= 0.00458  |ddm|= 0.0661
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00312769
diis-c [-1.82852424e-06 -2.26716498e-04 -1.20434075e-01  1.12066079e+00]
  HOMO = -0.244228692347834  LUMO = 0.894308702423912
  mo_energy =
[-1.20324326e+02 -1.23828919e+01 -6.68154602e+00 -6.68154602e+00
 -6.68154602e+00 -1.17990478e+00 -2.44228692e-01 -2.44228692e-01
 -2.44228692e-01  8.94308702e-01  1.19776958e+01  1.11355277e+02
  6.05557803e+02  2.74502595e+03  1.22240791e+04  4.08455366e+04
  1.04889155e+05  2.30072585e+05  4.55887515e+05  8.44839769e+05
  1.52801703e+06  2.85028442e+06  5.80817170e+06]
E1 = -706.6114312956496  E_coul = 198.63956362162565
cycle= 4 E= -507.971867674024  delta_E= -5.8e-06  |g|= 0.000203  |ddm|= 0.0111
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000131375
diis-c [-8.92667102e-11 -6.36839375e-06  7.96846755e-03 -9.91585346e-02
  1.09119644e+00]
  HOMO = -0.244364535830283  LUMO = 0.894261539815878
  mo_energy =
[-1.20324629e+02 -1.23832077e+01 -6.68185546e+00 -6.68185546e+00
 -6.68185546e+00 -1.17998544e+00 -2.44364536e-01 -2.44364536e-01
 -2.44364536e-01  8.94261540e-01  1.19774274e+01  1.11354971e+02
  6.05557501e+02  2.74502566e+03  1.22240788e+04  4.08455363e+04
  1.04889155e+05  2.30072585e+05  4.55887515e+05  8.44839768e+05
  1.52801703e+06  2.85028442e+06  5.80817170e+06]
E1 = -706.6107553341079  E_coul = 198.63888764952515
cycle= 5 E= -507.971867684583  delta_E= -1.06e-08  |g|= 7.3e-07  |ddm|= 0.000501
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.78287e-07
diis-c [-1.19939434e-14  1.75207089e-07 -1.15724919e-04  1.24666482e-03
 -1.42857753e-02  1.01315466e+00]
  HOMO = -0.244364970153381  LUMO = 0.89426159840009
  mo_energy =
[-1.20324631e+02 -1.23832089e+01 -6.68185675e+00 -6.68185675e+00
 -6.68185675e+00 -1.17998586e+00 -2.44364970e-01 -2.44364970e-01
 -2.44364970e-01  8.94261598e-01  1.19774265e+01  1.11354970e+02
  6.05557499e+02  2.74502565e+03  1.22240788e+04  4.08455363e+04
  1.04889155e+05  2.30072585e+05  4.55887515e+05  8.44839768e+05
  1.52801703e+06  2.85028442e+06  5.80817170e+06]
E1 = -706.6107526834984  E_coul = 198.63888499891567
cycle= 6 E= -507.971867684583  delta_E= 5.68e-14  |g|= 1.5e-08  |ddm|= 1.8e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6107526834984  E_coul = 198.63888499891567
  HOMO = -0.244364978603249  LUMO = 0.894261592604916
  mo_energy =
[-1.20324631e+02 -1.23832089e+01 -6.68185676e+00 -6.68185676e+00
 -6.68185676e+00 -1.17998587e+00 -2.44364979e-01 -2.44364979e-01
 -2.44364979e-01  8.94261593e-01  1.19774265e+01  1.11354970e+02
  6.05557499e+02  2.74502565e+03  1.22240788e+04  4.08455363e+04
  1.04889155e+05  2.30072585e+05  4.55887515e+05  8.44839768e+05
  1.52801703e+06  2.85028442e+06  5.80817170e+06]
E1 = -706.6107526466295  E_coul = 198.63888496204706
Extra cycle  E= -507.971867684582  delta_E= 2.84e-13  |g|= 2.15e-09  |ddm|= 2.95e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907721.6912790139
E1 = -706.6107526466295  E_coul = 198.63888496204706
init E= -507.971867684582
    CPU time for initialize scf      1.48 sec, wall time      0.09 sec
  HOMO = -0.244364979709156  LUMO = 0.894261593483514
  mo_energy =
[-1.20324631e+02 -1.23832089e+01 -6.68185677e+00 -6.68185677e+00
 -6.68185677e+00 -1.17998587e+00 -2.44364980e-01 -2.44364980e-01
 -2.44364980e-01  8.94261593e-01  1.19774265e+01  1.11354970e+02
  6.05557499e+02  2.74502565e+03  1.22240788e+04  4.08455363e+04
  1.04889155e+05  2.30072585e+05  4.55887515e+05  8.44839768e+05
  1.52801703e+06  2.85028442e+06  5.80817170e+06]
E1 = -706.6107526397602  E_coul = 198.63888495517762
cycle= 1 E= -507.971867684583  delta_E= -1.71e-13  |g|= 1.76e-09  |ddm|= 4.99e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6107526397602  E_coul = 198.63888495517762
  HOMO = -0.244364979915075  LUMO = 0.894261592335342
  mo_energy =
[-1.20324631e+02 -1.23832089e+01 -6.68185677e+00 -6.68185677e+00
 -6.68185677e+00 -1.17998587e+00 -2.44364980e-01 -2.44364980e-01
 -2.44364980e-01  8.94261592e-01  1.19774265e+01  1.11354970e+02
  6.05557499e+02  2.74502565e+03  1.22240788e+04  4.08455363e+04
  1.04889155e+05  2.30072585e+05  4.55887515e+05  8.44839768e+05
  1.52801703e+06  2.85028442e+06  5.80817170e+06]
E1 = -706.6107526389223  E_coul = 198.63888495433994
Extra cycle  E= -507.971867684582  delta_E= 1.71e-13  |g|= 1.33e-09  |ddm|= 6.14e-10
    CPU time for scf_cycle      1.65 sec, wall time      0.16 sec
exp = [2.25447468e-01 1.17616814e+05 5.61413318e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347587e+03 1.83758102e+04 1.44974931e+03
 3.74024727e+02 1.13259179e+02 3.77426677e+01 8.08658005e+00
 3.21478248e+00 8.60450175e+00 4.92189467e-01]
grad_E = [ 2.26233427e-02  4.17304577e-09 -2.98702769e-02  1.86499418e-11
  1.12470776e-10  6.49269905e-10  2.54611473e-09  1.05774359e-08
  5.69127833e-08  3.57927956e-06  1.22265333e-07  5.58984398e-06
 -1.22896541e-05  4.97923578e-05 -2.53082606e-04  8.08730028e-04
 -6.64596314e-03  7.49106540e-04 -2.57317150e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.220269057477       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.569003244348       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209718        1
[INPUT] 0    0    [1    /1   ]  36754.7200474        1
[INPUT] 0    0    [1    /1   ]  7303.47586522        1
[INPUT] 0    0    [1    /1   ]  18375.8102148        1
[INPUT] 0    0    [1    /1   ]  1449.74929727        1
[INPUT] 0    0    [1    /1   ]  374.024744607        1
[INPUT] 0    0    [1    /1   ]  113.259107613        1
[INPUT] 0    0    [1    /1   ]  37.7430352535        1
[INPUT] 0    0    [1    /1   ]  8.08561088313        1
[INPUT] 0    0    [1    /1   ]  3.22322352056        1
[INPUT] 1    0    [1    /1   ]  8.60405526254        1
[INPUT] 1    0    [1    /1   ]  0.491395819809       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.22026905747678432, 1.0]], [0, [117616.81424228617, 1.0]], [0, [0.5690032443480065, 1.0]], [0, [1176168.1426188892, 1.0]], [0, [588084.069992577, 1.0]], [0, [294042.031131957, 1.0]], [0, [147020.99214807348, 1.0]], [0, [73510.4209717731, 1.0]], [0, [36754.72004738621, 1.0]], [0, [7303.475865221186, 1.0]], [0, [18375.810214794066, 1.0]], [0, [1449.7492972664572, 1.0]], [0, [374.0247446065732, 1.0]], [0, [113.25910761254534, 1.0]], [0, [37.74303525350857, 1.0]], [0, [8.085610883127325, 1.0]], [0, [3.2232235205626325, 1.0]], [1, [8.604055262539571, 1.0]], [1, [0.49139581980868996, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22026906]
bas 1, expnt(s) = [117616.81424229]
bas 2, expnt(s) = [0.56900324]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113196]
bas 6, expnt(s) = [147020.99214807]
bas 7, expnt(s) = [73510.42097177]
bas 8, expnt(s) = [36754.72004739]
bas 9, expnt(s) = [7303.47586522]
bas 10, expnt(s) = [18375.81021479]
bas 11, expnt(s) = [1449.74929727]
bas 12, expnt(s) = [374.02474461]
bas 13, expnt(s) = [113.25910761]
bas 14, expnt(s) = [37.74303525]
bas 15, expnt(s) = [8.08561088]
bas 16, expnt(s) = [3.22322352]
bas 17, expnt(s) = [8.60405526]
bas 18, expnt(s) = [0.49139582]
CPU time:        35.34
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.20269057e-01 8.12325608e-01 1.17616814e+05 1.60460109e+04
 5.69003244e-01 1.65520230e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347587e+03 1.99600775e+03
 1.83758102e+04 3.98749266e+03 1.44974930e+03 5.93587442e+02
 3.74024745e+02 2.14877170e+02 1.13259108e+02 8.77141938e+01
 3.77430353e+01 3.84718120e+01 8.08561088e+00 1.21143370e+01
 3.22322352e+00 6.07761019e+00 8.60405526e+00 4.29895977e+01
 4.91395820e-01 1.20025553e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.337647748401835
cond(S) = 907722.1244018187
E1 = -689.4996066375198  E_coul = 184.90882617579754
init E= -504.590780461722
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.674416666898975  LUMO = 0.530349395678515
  mo_energy =
[-1.21708368e+02 -1.33894907e+01 -7.62766951e+00 -7.62766951e+00
 -7.62766951e+00 -1.65820127e+00 -6.74416667e-01 -6.74416667e-01
 -6.74416667e-01  5.30349396e-01  1.11364859e+01  1.10105462e+02
  6.04229992e+02  2.74377089e+03  1.22229395e+04  4.08444653e+04
  1.04888121e+05  2.30071575e+05  4.55886523e+05  8.44838789e+05
  1.52801606e+06  2.85028346e+06  5.80817075e+06]
E1 = -707.6078777707785  E_coul = 199.6528042987135
cycle= 1 E= -507.955073472065  delta_E= -3.36  |g|= 0.447  |ddm|= 0.531
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.627953
diis-c [-0.39432519  1.        ]
  HOMO = -0.221508537815276  LUMO = 0.891266032211616
  mo_energy =
[-1.20205530e+02 -1.23129102e+01 -6.60332459e+00 -6.60332459e+00
 -6.60332459e+00 -1.16570126e+00 -2.21508538e-01 -2.21508538e-01
 -2.21508538e-01  8.91266032e-01  1.20616946e+01  1.11499199e+02
  6.05718903e+02  2.74519819e+03  1.22242575e+04  4.08457167e+04
  1.04889336e+05  2.30072766e+05  4.55887696e+05  8.44839949e+05
  1.52801721e+06  2.85028460e+06  5.80817188e+06]
E1 = -706.6991026566222  E_coul = 198.72726065531725
cycle= 2 E= -507.971842001305  delta_E= -0.0168  |g|= 0.034  |ddm|= 0.447
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0266585
diis-c [-7.09727230e-04  1.54800462e-03  9.98451995e-01]
  HOMO = -0.242822083964974  LUMO = 0.886598885802627
  mo_energy =
[-1.20314840e+02 -1.23766956e+01 -6.67406963e+00 -6.67406963e+00
 -6.67406963e+00 -1.17948032e+00 -2.42822084e-01 -2.42822084e-01
 -2.42822084e-01  8.86598886e-01  1.20143297e+01  1.11408245e+02
  6.05605670e+02  2.74506924e+03  1.22241186e+04  4.08455742e+04
  1.04889192e+05  2.30072621e+05  4.55887551e+05  8.44839804e+05
  1.52801706e+06  2.85028445e+06  5.80817173e+06]
E1 = -706.5913581273767  E_coul = 198.6192448517689
cycle= 3 E= -507.972113275608  delta_E= -0.000271  |g|= 0.00458  |ddm|= 0.0649
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00319593
diis-c [-1.87258126e-06 -2.33201098e-04 -1.21535029e-01  1.12176823e+00]
  HOMO = -0.246151476678525  LUMO = 0.885630744734085
  mo_energy =
[-1.20327101e+02 -1.23856058e+01 -6.68348299e+00 -6.68348299e+00
 -6.68348299e+00 -1.18151350e+00 -2.46151477e-01 -2.46151477e-01
 -2.46151477e-01  8.85630745e-01  1.20072945e+01  1.11397298e+02
  6.05593239e+02  2.74505594e+03  1.22241048e+04  4.08455602e+04
  1.04889178e+05  2.30072607e+05  4.55887537e+05  8.44839789e+05
  1.52801705e+06  2.85028444e+06  5.80817172e+06]
E1 = -706.5747050128881  E_coul = 198.60258591759626
cycle= 4 E= -507.972119095292  delta_E= -5.82e-06  |g|= 0.000197  |ddm|= 0.0108
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000130477
diis-c [-8.84911490e-11 -6.45036088e-06  7.92101125e-03 -9.72652885e-02
  1.08935073e+00]
  HOMO = -0.246283432229605  LUMO = 0.885584568629988
  mo_energy =
[-1.20327390e+02 -1.23859110e+01 -6.68378118e+00 -6.68378118e+00
 -6.68378118e+00 -1.18159188e+00 -2.46283432e-01 -2.46283432e-01
 -2.46283432e-01  8.85584569e-01  1.20070342e+01  1.11397005e+02
  6.05592951e+02  2.74505566e+03  1.22241045e+04  4.08455599e+04
  1.04889178e+05  2.30072607e+05  4.55887536e+05  8.44839789e+05
  1.52801705e+06  2.85028444e+06  5.80817172e+06]
E1 = -706.5740514409981  E_coul = 198.6019323359001
cycle= 5 E= -507.972119105098  delta_E= -9.81e-09  |g|= 6.95e-07  |ddm|= 0.000471
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.69052e-07
diis-c [-1.07887182e-14  1.81351627e-07 -1.15518974e-04  1.23156288e-03
 -1.42872464e-02  1.01317102e+00]
  HOMO = -0.246283844447335  LUMO = 0.885584633434797
  mo_energy =
[-1.20327391e+02 -1.23859121e+01 -6.68378240e+00 -6.68378240e+00
 -6.68378240e+00 -1.18159229e+00 -2.46283844e-01 -2.46283844e-01
 -2.46283844e-01  8.85584633e-01  1.20070333e+01  1.11397004e+02
  6.05592949e+02  2.74505566e+03  1.22241045e+04  4.08455599e+04
  1.04889178e+05  2.30072607e+05  4.55887536e+05  8.44839789e+05
  1.52801705e+06  2.85028444e+06  5.80817172e+06]
E1 = -706.5740489027146  E_coul = 198.60192979761678
cycle= 6 E= -507.972119105098  delta_E= 2.27e-13  |g|= 1.46e-08  |ddm|= 1.67e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.5740489027146  E_coul = 198.60192979761678
  HOMO = -0.246283852320371  LUMO = 0.885584627867984
  mo_energy =
[-1.20327391e+02 -1.23859121e+01 -6.68378242e+00 -6.68378242e+00
 -6.68378242e+00 -1.18159230e+00 -2.46283852e-01 -2.46283852e-01
 -2.46283852e-01  8.85584628e-01  1.20070333e+01  1.11397004e+02
  6.05592949e+02  2.74505566e+03  1.22241045e+04  4.08455599e+04
  1.04889178e+05  2.30072607e+05  4.55887536e+05  8.44839789e+05
  1.52801705e+06  2.85028444e+06  5.80817172e+06]
E1 = -706.5740488654162  E_coul = 198.60192976031848
Extra cycle  E= -507.972119105098  delta_E= 1.14e-13  |g|= 2.41e-09  |ddm|= 2.85e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.20269057e-01 1.17616814e+05 5.69003244e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347587e+03 1.83758102e+04 1.44974930e+03
 3.74024745e+02 1.13259108e+02 3.77430353e+01 8.08561088e+00
 3.22322352e+00 8.60405526e+00 4.91395820e-01]
E = -507.9721191050977
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.220269057477       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.569003244348       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209718        1
[INPUT] 0    0    [1    /1   ]  36754.7200474        1
[INPUT] 0    0    [1    /1   ]  7303.47586522        1
[INPUT] 0    0    [1    /1   ]  18375.8102148        1
[INPUT] 0    0    [1    /1   ]  1449.74929727        1
[INPUT] 0    0    [1    /1   ]  374.024744607        1
[INPUT] 0    0    [1    /1   ]  113.259107613        1
[INPUT] 0    0    [1    /1   ]  37.7430352535        1
[INPUT] 0    0    [1    /1   ]  8.08561088313        1
[INPUT] 0    0    [1    /1   ]  3.22322352056        1
[INPUT] 1    0    [1    /1   ]  8.60405526254        1
[INPUT] 1    0    [1    /1   ]  0.491395819809       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.22026905747678432, 1.0]], [0, [117616.81424228617, 1.0]], [0, [0.5690032443480065, 1.0]], [0, [1176168.1426188892, 1.0]], [0, [588084.069992577, 1.0]], [0, [294042.031131957, 1.0]], [0, [147020.99214807348, 1.0]], [0, [73510.4209717731, 1.0]], [0, [36754.72004738621, 1.0]], [0, [7303.475865221186, 1.0]], [0, [18375.810214794066, 1.0]], [0, [1449.7492972664572, 1.0]], [0, [374.0247446065732, 1.0]], [0, [113.25910761254534, 1.0]], [0, [37.74303525350857, 1.0]], [0, [8.085610883127325, 1.0]], [0, [3.2232235205626325, 1.0]], [1, [8.604055262539571, 1.0]], [1, [0.49139581980868996, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22026906]
bas 1, expnt(s) = [117616.81424229]
bas 2, expnt(s) = [0.56900324]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113196]
bas 6, expnt(s) = [147020.99214807]
bas 7, expnt(s) = [73510.42097177]
bas 8, expnt(s) = [36754.72004739]
bas 9, expnt(s) = [7303.47586522]
bas 10, expnt(s) = [18375.81021479]
bas 11, expnt(s) = [1449.74929727]
bas 12, expnt(s) = [374.02474461]
bas 13, expnt(s) = [113.25910761]
bas 14, expnt(s) = [37.74303525]
bas 15, expnt(s) = [8.08561088]
bas 16, expnt(s) = [3.22322352]
bas 17, expnt(s) = [8.60405526]
bas 18, expnt(s) = [0.49139582]
CPU time:        35.84
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.20269057e-01 8.12325608e-01 1.17616814e+05 1.60460109e+04
 5.69003244e-01 1.65520230e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347587e+03 1.99600775e+03
 1.83758102e+04 3.98749266e+03 1.44974930e+03 5.93587442e+02
 3.74024745e+02 2.14877170e+02 1.13259108e+02 8.77141938e+01
 3.77430353e+01 3.84718120e+01 8.08561088e+00 1.21143370e+01
 3.22322352e+00 6.07761019e+00 8.60405526e+00 4.29895977e+01
 4.91395820e-01 1.20025553e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.337647748401835
cond(S) = 907722.1244018187
E1 = -689.4996066375198  E_coul = 184.90882617579754
init E= -504.590780461722
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674416666898975  LUMO = 0.530349395678515
  mo_energy =
[-1.21708368e+02 -1.33894907e+01 -7.62766951e+00 -7.62766951e+00
 -7.62766951e+00 -1.65820127e+00 -6.74416667e-01 -6.74416667e-01
 -6.74416667e-01  5.30349396e-01  1.11364859e+01  1.10105462e+02
  6.04229992e+02  2.74377089e+03  1.22229395e+04  4.08444653e+04
  1.04888121e+05  2.30071575e+05  4.55886523e+05  8.44838789e+05
  1.52801606e+06  2.85028346e+06  5.80817075e+06]
E1 = -707.6078777707785  E_coul = 199.6528042987135
cycle= 1 E= -507.955073472065  delta_E= -3.36  |g|= 0.447  |ddm|= 0.531
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.627953
diis-c [-0.39432519  1.        ]
  HOMO = -0.221508537815276  LUMO = 0.891266032211616
  mo_energy =
[-1.20205530e+02 -1.23129102e+01 -6.60332459e+00 -6.60332459e+00
 -6.60332459e+00 -1.16570126e+00 -2.21508538e-01 -2.21508538e-01
 -2.21508538e-01  8.91266032e-01  1.20616946e+01  1.11499199e+02
  6.05718903e+02  2.74519819e+03  1.22242575e+04  4.08457167e+04
  1.04889336e+05  2.30072766e+05  4.55887696e+05  8.44839949e+05
  1.52801721e+06  2.85028460e+06  5.80817188e+06]
E1 = -706.6991026566222  E_coul = 198.72726065531725
cycle= 2 E= -507.971842001305  delta_E= -0.0168  |g|= 0.034  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0266585
diis-c [-7.09727230e-04  1.54800462e-03  9.98451995e-01]
  HOMO = -0.242822083964974  LUMO = 0.886598885802627
  mo_energy =
[-1.20314840e+02 -1.23766956e+01 -6.67406963e+00 -6.67406963e+00
 -6.67406963e+00 -1.17948032e+00 -2.42822084e-01 -2.42822084e-01
 -2.42822084e-01  8.86598886e-01  1.20143297e+01  1.11408245e+02
  6.05605670e+02  2.74506924e+03  1.22241186e+04  4.08455742e+04
  1.04889192e+05  2.30072621e+05  4.55887551e+05  8.44839804e+05
  1.52801706e+06  2.85028445e+06  5.80817173e+06]
E1 = -706.5913581273767  E_coul = 198.6192448517689
cycle= 3 E= -507.972113275608  delta_E= -0.000271  |g|= 0.00458  |ddm|= 0.0649
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00319593
diis-c [-1.87258126e-06 -2.33201098e-04 -1.21535029e-01  1.12176823e+00]
  HOMO = -0.246151476678525  LUMO = 0.885630744734085
  mo_energy =
[-1.20327101e+02 -1.23856058e+01 -6.68348299e+00 -6.68348299e+00
 -6.68348299e+00 -1.18151350e+00 -2.46151477e-01 -2.46151477e-01
 -2.46151477e-01  8.85630745e-01  1.20072945e+01  1.11397298e+02
  6.05593239e+02  2.74505594e+03  1.22241048e+04  4.08455602e+04
  1.04889178e+05  2.30072607e+05  4.55887537e+05  8.44839789e+05
  1.52801705e+06  2.85028444e+06  5.80817172e+06]
E1 = -706.5747050128881  E_coul = 198.60258591759626
cycle= 4 E= -507.972119095292  delta_E= -5.82e-06  |g|= 0.000197  |ddm|= 0.0108
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000130477
diis-c [-8.84911490e-11 -6.45036088e-06  7.92101125e-03 -9.72652885e-02
  1.08935073e+00]
  HOMO = -0.246283432229605  LUMO = 0.885584568629988
  mo_energy =
[-1.20327390e+02 -1.23859110e+01 -6.68378118e+00 -6.68378118e+00
 -6.68378118e+00 -1.18159188e+00 -2.46283432e-01 -2.46283432e-01
 -2.46283432e-01  8.85584569e-01  1.20070342e+01  1.11397005e+02
  6.05592951e+02  2.74505566e+03  1.22241045e+04  4.08455599e+04
  1.04889178e+05  2.30072607e+05  4.55887536e+05  8.44839789e+05
  1.52801705e+06  2.85028444e+06  5.80817172e+06]
E1 = -706.5740514409981  E_coul = 198.6019323359001
cycle= 5 E= -507.972119105098  delta_E= -9.81e-09  |g|= 6.95e-07  |ddm|= 0.000471
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.69052e-07
diis-c [-1.07887182e-14  1.81351627e-07 -1.15518974e-04  1.23156288e-03
 -1.42872464e-02  1.01317102e+00]
  HOMO = -0.246283844447335  LUMO = 0.885584633434797
  mo_energy =
[-1.20327391e+02 -1.23859121e+01 -6.68378240e+00 -6.68378240e+00
 -6.68378240e+00 -1.18159229e+00 -2.46283844e-01 -2.46283844e-01
 -2.46283844e-01  8.85584633e-01  1.20070333e+01  1.11397004e+02
  6.05592949e+02  2.74505566e+03  1.22241045e+04  4.08455599e+04
  1.04889178e+05  2.30072607e+05  4.55887536e+05  8.44839789e+05
  1.52801705e+06  2.85028444e+06  5.80817172e+06]
E1 = -706.5740489027146  E_coul = 198.60192979761678
cycle= 6 E= -507.972119105098  delta_E= 2.27e-13  |g|= 1.46e-08  |ddm|= 1.67e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.5740489027146  E_coul = 198.60192979761678
  HOMO = -0.246283852320371  LUMO = 0.885584627867984
  mo_energy =
[-1.20327391e+02 -1.23859121e+01 -6.68378242e+00 -6.68378242e+00
 -6.68378242e+00 -1.18159230e+00 -2.46283852e-01 -2.46283852e-01
 -2.46283852e-01  8.85584628e-01  1.20070333e+01  1.11397004e+02
  6.05592949e+02  2.74505566e+03  1.22241045e+04  4.08455599e+04
  1.04889178e+05  2.30072607e+05  4.55887536e+05  8.44839789e+05
  1.52801705e+06  2.85028444e+06  5.80817172e+06]
E1 = -706.5740488654162  E_coul = 198.60192976031848
Extra cycle  E= -507.972119105098  delta_E= 1.14e-13  |g|= 2.41e-09  |ddm|= 2.85e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907722.1244018187
E1 = -706.5740488654162  E_coul = 198.60192976031848
init E= -507.972119105098
    CPU time for initialize scf      1.47 sec, wall time      0.09 sec
  HOMO = -0.246283853419662  LUMO = 0.885584626812429
  mo_energy =
[-1.20327391e+02 -1.23859121e+01 -6.68378242e+00 -6.68378242e+00
 -6.68378242e+00 -1.18159230e+00 -2.46283853e-01 -2.46283853e-01
 -2.46283853e-01  8.85584627e-01  1.20070333e+01  1.11397004e+02
  6.05592949e+02  2.74505566e+03  1.22241045e+04  4.08455599e+04
  1.04889178e+05  2.30072607e+05  4.55887536e+05  8.44839789e+05
  1.52801705e+06  2.85028444e+06  5.80817172e+06]
E1 = -706.5740488619524  E_coul = 198.60192975685484
cycle= 1 E= -507.972119105098  delta_E= 1.14e-13  |g|= 1.77e-09  |ddm|= 2.54e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.5740488619524  E_coul = 198.60192975685484
  HOMO = -0.246283853524459  LUMO = 0.885584628526817
  mo_energy =
[-1.20327391e+02 -1.23859121e+01 -6.68378242e+00 -6.68378242e+00
 -6.68378242e+00 -1.18159230e+00 -2.46283854e-01 -2.46283854e-01
 -2.46283854e-01  8.85584629e-01  1.20070333e+01  1.11397004e+02
  6.05592949e+02  2.74505566e+03  1.22241045e+04  4.08455599e+04
  1.04889178e+05  2.30072607e+05  4.55887536e+05  8.44839789e+05
  1.52801705e+06  2.85028444e+06  5.80817172e+06]
E1 = -706.5740488609074  E_coul = 198.60192975580958
Extra cycle  E= -507.972119105098  delta_E= -2.27e-13  |g|= 1.52e-09  |ddm|= 1.05e-09
    CPU time for scf_cycle      1.64 sec, wall time      0.16 sec
exp = [2.20269057e-01 1.17616814e+05 5.69003244e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347587e+03 1.83758102e+04 1.44974930e+03
 3.74024745e+02 1.13259108e+02 3.77430353e+01 8.08561088e+00
 3.22322352e+00 8.60405526e+00 4.91395820e-01]
grad_E = [-2.52456941e-04  4.17186454e-09 -1.63262404e-02  1.86351797e-11
  1.12432275e-10  6.49086418e-10  2.54538493e-09  1.05743622e-08
  5.68975600e-08  3.57814195e-06  1.22219769e-07  5.66418160e-06
 -1.34952227e-05  6.23765626e-05 -3.19031038e-04  2.21706229e-04
 -4.26520488e-03  1.26045596e-03 -5.27308357e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.224564681577       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.582967335143       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209717        1
[INPUT] 0    0    [1    /1   ]  36754.7200473        1
[INPUT] 0    0    [1    /1   ]  7303.47585682        1
[INPUT] 0    0    [1    /1   ]  18375.8102145        1
[INPUT] 0    0    [1    /1   ]  1449.74928404        1
[INPUT] 0    0    [1    /1   ]  374.024775141        1
[INPUT] 0    0    [1    /1   ]  113.25897323         1
[INPUT] 0    0    [1    /1   ]  37.7437231512        1
[INPUT] 0    0    [1    /1   ]  8.08463663377        1
[INPUT] 0    0    [1    /1   ]  3.23486156548        1
[INPUT] 1    0    [1    /1   ]  8.60377219021        1
[INPUT] 1    0    [1    /1   ]  0.49144365004        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.22456468157717716, 1.0]], [0, [117616.81424227638, 1.0]], [0, [0.5829673351433902, 1.0]], [0, [1176168.1426188892, 1.0]], [0, [588084.0699925767, 1.0]], [0, [294042.0311319555, 1.0]], [0, [147020.9921480675, 1.0]], [0, [73510.42097174826, 1.0]], [0, [36754.72004725259, 1.0]], [0, [7303.475856818023, 1.0]], [0, [18375.81021450703, 1.0]], [0, [1449.7492840376585, 1.0]], [0, [374.0247751413326, 1.0]], [0, [113.25897323000675, 1.0]], [0, [37.74372315121753, 1.0]], [0, [8.084636633767477, 1.0]], [0, [3.2348615654782797, 1.0]], [1, [8.603772190214315, 1.0]], [1, [0.491443650040485, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22456468]
bas 1, expnt(s) = [117616.81424228]
bas 2, expnt(s) = [0.58296734]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113196]
bas 6, expnt(s) = [147020.99214807]
bas 7, expnt(s) = [73510.42097175]
bas 8, expnt(s) = [36754.72004725]
bas 9, expnt(s) = [7303.47585682]
bas 10, expnt(s) = [18375.81021451]
bas 11, expnt(s) = [1449.74928404]
bas 12, expnt(s) = [374.02477514]
bas 13, expnt(s) = [113.25897323]
bas 14, expnt(s) = [37.74372315]
bas 15, expnt(s) = [8.08463663]
bas 16, expnt(s) = [3.23486157]
bas 17, expnt(s) = [8.60377219]
bas 18, expnt(s) = [0.49144365]
CPU time:        40.58
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.24564682e-01 8.24178184e-01 1.17616814e+05 1.60460109e+04
 5.82967335e-01 1.68557542e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347586e+03 1.99600775e+03
 1.83758102e+04 3.98749266e+03 1.44974928e+03 5.93587438e+02
 3.74024775e+02 2.14877183e+02 1.13258973e+02 8.77141157e+01
 3.77437232e+01 3.84723378e+01 8.08463663e+00 1.21132423e+01
 3.23486157e+00 6.09406103e+00 8.60377219e+00 4.29878298e+01
 4.91443650e-01 1.20040156e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33761518658027
cond(S) = 907723.5610462838
E1 = -689.5074350749702  E_coul = 184.91425018435382
init E= -504.593184890616
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674156578542243  LUMO = 0.556470324733325
  mo_energy =
[-1.21708213e+02 -1.33890462e+01 -7.62726743e+00 -7.62726743e+00
 -7.62726743e+00 -1.65832523e+00 -6.74156579e-01 -6.74156579e-01
 -6.74156579e-01  5.56470325e-01  1.12564731e+01  1.10229202e+02
  6.04332975e+02  2.74385863e+03  1.22230156e+04  4.08445356e+04
  1.04888189e+05  2.30071641e+05  4.55886587e+05  8.44838852e+05
  1.52801612e+06  2.85028352e+06  5.80817081e+06]
E1 = -707.6250013326274  E_coul = 199.6698828905196
cycle= 1 E= -507.955118442108  delta_E= -3.36  |g|= 0.448  |ddm|= 0.522
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.627765
diis-c [-0.39408859  1.        ]
  HOMO = -0.221142164394991  LUMO = 0.92291835835613
  mo_energy =
[-1.20203973e+02 -1.23115596e+01 -6.60190199e+00 -6.60190199e+00
 -6.60190199e+00 -1.16554724e+00 -2.21142164e-01 -2.21142164e-01
 -2.21142164e-01  9.22918358e-01  1.21826994e+01  1.11624135e+02
  6.05823254e+02  2.74528742e+03  1.22243351e+04  4.08457885e+04
  1.04889405e+05  2.30072833e+05  4.55887762e+05  8.44840014e+05
  1.52801727e+06  2.85028466e+06  5.80817194e+06]
E1 = -706.707583230588  E_coul = 198.73550596984342
cycle= 2 E= -507.972077260745  delta_E= -0.017  |g|= 0.0342  |ddm|= 0.446
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0266682
diis-c [-7.10137107e-04  1.63656346e-03  9.98363437e-01]
  HOMO = -0.242677735495004  LUMO = 0.917978493707753
  mo_energy =
[-1.20314105e+02 -1.23760122e+01 -6.67333661e+00 -6.67333661e+00
 -6.67333661e+00 -1.17947710e+00 -2.42677735e-01 -2.42677735e-01
 -2.42677735e-01  9.17978494e-01  1.21346318e+01  1.11532423e+02
  6.05709191e+02  2.74515759e+03  1.22241953e+04  4.08456451e+04
  1.04889260e+05  2.30072687e+05  4.55887616e+05  8.44839867e+05
  1.52801713e+06  2.85028451e+06  5.80817179e+06]
E1 = -706.5995244084737  E_coul = 198.6271768796943
cycle= 3 E= -507.972347528779  delta_E= -0.00027  |g|= 0.00456  |ddm|= 0.0639
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00317887
diis-c [-1.83146896e-06 -2.27573480e-04 -1.20945410e-01  1.12117298e+00]
  HOMO = -0.246006974953135  LUMO = 0.916974715763267
  mo_energy =
[-1.20326418e+02 -1.23849551e+01 -6.68278569e+00 -6.68278569e+00
 -6.68278569e+00 -1.18150912e+00 -2.46006975e-01 -2.46006975e-01
 -2.46006975e-01  9.16974716e-01  1.21275601e+01  1.11521432e+02
  6.05696707e+02  2.74514424e+03  1.22241814e+04  4.08456310e+04
  1.04889246e+05  2.30072673e+05  4.55887601e+05  8.44839853e+05
  1.52801711e+06  2.85028450e+06  5.80817178e+06]
E1 = -706.583001570799  E_coul = 198.61064837740787
cycle= 4 E= -507.972353193391  delta_E= -5.66e-06  |g|= 0.000189  |ddm|= 0.0105
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000126626
diis-c [-8.35253161e-11 -6.36181898e-06  7.82176045e-03 -9.57330729e-02
  1.08791767e+00]
  HOMO = -0.246134310732316  LUMO = 0.916928674120456
  mo_energy =
[-1.20326696e+02 -1.23852510e+01 -6.68307453e+00 -6.68307453e+00
 -6.68307453e+00 -1.18158464e+00 -2.46134311e-01 -2.46134311e-01
 -2.46134311e-01  9.16928674e-01  1.21273079e+01  1.11521149e+02
  6.05696430e+02  2.74514397e+03  1.22241811e+04  4.08456308e+04
  1.04889246e+05  2.30072673e+05  4.55887601e+05  8.44839853e+05
  1.52801711e+06  2.85028450e+06  5.80817178e+06]
E1 = -706.5823764210691  E_coul = 198.61002321877584
cycle= 5 E= -507.972353202293  delta_E= -8.9e-09  |g|= 6.14e-07  |ddm|= 0.000442
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.28795e-07
diis-c [-7.71072747e-15  1.72422929e-07 -1.04658367e-04  1.10629111e-03
 -1.29368883e-02  1.01193508e+00]
  HOMO = -0.246134676224644  LUMO = 0.916928748366707
  mo_energy =
[-1.20326698e+02 -1.23852520e+01 -6.68307564e+00 -6.68307564e+00
 -6.68307564e+00 -1.18158502e+00 -2.46134676e-01 -2.46134676e-01
 -2.46134676e-01  9.16928748e-01  1.21273072e+01  1.11521148e+02
  6.05696428e+02  2.74514396e+03  1.22241811e+04  4.08456308e+04
  1.04889246e+05  2.30072673e+05  4.55887601e+05  8.44839853e+05
  1.52801711e+06  2.85028450e+06  5.80817178e+06]
E1 = -706.5823741747166  E_coul = 198.6100209724232
cycle= 6 E= -507.972353202293  delta_E= -2.27e-13  |g|= 1.14e-08  |ddm|= 1.44e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.5823741747166  E_coul = 198.6100209724232
  HOMO = -0.246134682460882  LUMO = 0.916928741916598
  mo_energy =
[-1.20326698e+02 -1.23852520e+01 -6.68307565e+00 -6.68307565e+00
 -6.68307565e+00 -1.18158503e+00 -2.46134682e-01 -2.46134682e-01
 -2.46134682e-01  9.16928742e-01  1.21273071e+01  1.11521148e+02
  6.05696428e+02  2.74514396e+03  1.22241811e+04  4.08456308e+04
  1.04889246e+05  2.30072673e+05  4.55887601e+05  8.44839853e+05
  1.52801711e+06  2.85028450e+06  5.80817178e+06]
E1 = -706.5823741511552  E_coul = 198.610020948862
Extra cycle  E= -507.972353202293  delta_E= 2.27e-13  |g|= 3.19e-09  |ddm|= 1.85e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.24564682e-01 1.17616814e+05 5.82967335e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347586e+03 1.83758102e+04 1.44974928e+03
 3.74024775e+02 1.13258973e+02 3.77437232e+01 8.08463663e+00
 3.23486157e+00 8.60377219e+00 4.91443650e-01]
E = -507.9723532022932
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.224564681577       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.582967335143       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209717        1
[INPUT] 0    0    [1    /1   ]  36754.7200473        1
[INPUT] 0    0    [1    /1   ]  7303.47585682        1
[INPUT] 0    0    [1    /1   ]  18375.8102145        1
[INPUT] 0    0    [1    /1   ]  1449.74928404        1
[INPUT] 0    0    [1    /1   ]  374.024775141        1
[INPUT] 0    0    [1    /1   ]  113.25897323         1
[INPUT] 0    0    [1    /1   ]  37.7437231512        1
[INPUT] 0    0    [1    /1   ]  8.08463663377        1
[INPUT] 0    0    [1    /1   ]  3.23486156548        1
[INPUT] 1    0    [1    /1   ]  8.60377219021        1
[INPUT] 1    0    [1    /1   ]  0.49144365004        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.22456468157717716, 1.0]], [0, [117616.81424227638, 1.0]], [0, [0.5829673351433902, 1.0]], [0, [1176168.1426188892, 1.0]], [0, [588084.0699925767, 1.0]], [0, [294042.0311319555, 1.0]], [0, [147020.9921480675, 1.0]], [0, [73510.42097174826, 1.0]], [0, [36754.72004725259, 1.0]], [0, [7303.475856818023, 1.0]], [0, [18375.81021450703, 1.0]], [0, [1449.7492840376585, 1.0]], [0, [374.0247751413326, 1.0]], [0, [113.25897323000675, 1.0]], [0, [37.74372315121753, 1.0]], [0, [8.084636633767477, 1.0]], [0, [3.2348615654782797, 1.0]], [1, [8.603772190214315, 1.0]], [1, [0.491443650040485, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22456468]
bas 1, expnt(s) = [117616.81424228]
bas 2, expnt(s) = [0.58296734]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113196]
bas 6, expnt(s) = [147020.99214807]
bas 7, expnt(s) = [73510.42097175]
bas 8, expnt(s) = [36754.72004725]
bas 9, expnt(s) = [7303.47585682]
bas 10, expnt(s) = [18375.81021451]
bas 11, expnt(s) = [1449.74928404]
bas 12, expnt(s) = [374.02477514]
bas 13, expnt(s) = [113.25897323]
bas 14, expnt(s) = [37.74372315]
bas 15, expnt(s) = [8.08463663]
bas 16, expnt(s) = [3.23486157]
bas 17, expnt(s) = [8.60377219]
bas 18, expnt(s) = [0.49144365]
CPU time:        41.08
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.24564682e-01 8.24178184e-01 1.17616814e+05 1.60460109e+04
 5.82967335e-01 1.68557542e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347586e+03 1.99600775e+03
 1.83758102e+04 3.98749266e+03 1.44974928e+03 5.93587438e+02
 3.74024775e+02 2.14877183e+02 1.13258973e+02 8.77141157e+01
 3.77437232e+01 3.84723378e+01 8.08463663e+00 1.21132423e+01
 3.23486157e+00 6.09406103e+00 8.60377219e+00 4.29878298e+01
 4.91443650e-01 1.20040156e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33761518658027
cond(S) = 907723.5610462838
E1 = -689.5074350749702  E_coul = 184.91425018435382
init E= -504.593184890616
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674156578542243  LUMO = 0.556470324733325
  mo_energy =
[-1.21708213e+02 -1.33890462e+01 -7.62726743e+00 -7.62726743e+00
 -7.62726743e+00 -1.65832523e+00 -6.74156579e-01 -6.74156579e-01
 -6.74156579e-01  5.56470325e-01  1.12564731e+01  1.10229202e+02
  6.04332975e+02  2.74385863e+03  1.22230156e+04  4.08445356e+04
  1.04888189e+05  2.30071641e+05  4.55886587e+05  8.44838852e+05
  1.52801612e+06  2.85028352e+06  5.80817081e+06]
E1 = -707.6250013326274  E_coul = 199.6698828905196
cycle= 1 E= -507.955118442108  delta_E= -3.36  |g|= 0.448  |ddm|= 0.522
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.627765
diis-c [-0.39408859  1.        ]
  HOMO = -0.221142164394991  LUMO = 0.92291835835613
  mo_energy =
[-1.20203973e+02 -1.23115596e+01 -6.60190199e+00 -6.60190199e+00
 -6.60190199e+00 -1.16554724e+00 -2.21142164e-01 -2.21142164e-01
 -2.21142164e-01  9.22918358e-01  1.21826994e+01  1.11624135e+02
  6.05823254e+02  2.74528742e+03  1.22243351e+04  4.08457885e+04
  1.04889405e+05  2.30072833e+05  4.55887762e+05  8.44840014e+05
  1.52801727e+06  2.85028466e+06  5.80817194e+06]
E1 = -706.707583230588  E_coul = 198.73550596984342
cycle= 2 E= -507.972077260745  delta_E= -0.017  |g|= 0.0342  |ddm|= 0.446
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0266682
diis-c [-7.10137107e-04  1.63656346e-03  9.98363437e-01]
  HOMO = -0.242677735495004  LUMO = 0.917978493707753
  mo_energy =
[-1.20314105e+02 -1.23760122e+01 -6.67333661e+00 -6.67333661e+00
 -6.67333661e+00 -1.17947710e+00 -2.42677735e-01 -2.42677735e-01
 -2.42677735e-01  9.17978494e-01  1.21346318e+01  1.11532423e+02
  6.05709191e+02  2.74515759e+03  1.22241953e+04  4.08456451e+04
  1.04889260e+05  2.30072687e+05  4.55887616e+05  8.44839867e+05
  1.52801713e+06  2.85028451e+06  5.80817179e+06]
E1 = -706.5995244084737  E_coul = 198.6271768796943
cycle= 3 E= -507.972347528779  delta_E= -0.00027  |g|= 0.00456  |ddm|= 0.0639
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00317887
diis-c [-1.83146896e-06 -2.27573480e-04 -1.20945410e-01  1.12117298e+00]
  HOMO = -0.246006974953135  LUMO = 0.916974715763267
  mo_energy =
[-1.20326418e+02 -1.23849551e+01 -6.68278569e+00 -6.68278569e+00
 -6.68278569e+00 -1.18150912e+00 -2.46006975e-01 -2.46006975e-01
 -2.46006975e-01  9.16974716e-01  1.21275601e+01  1.11521432e+02
  6.05696707e+02  2.74514424e+03  1.22241814e+04  4.08456310e+04
  1.04889246e+05  2.30072673e+05  4.55887601e+05  8.44839853e+05
  1.52801711e+06  2.85028450e+06  5.80817178e+06]
E1 = -706.583001570799  E_coul = 198.61064837740787
cycle= 4 E= -507.972353193391  delta_E= -5.66e-06  |g|= 0.000189  |ddm|= 0.0105
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000126626
diis-c [-8.35253161e-11 -6.36181898e-06  7.82176045e-03 -9.57330729e-02
  1.08791767e+00]
  HOMO = -0.246134310732316  LUMO = 0.916928674120456
  mo_energy =
[-1.20326696e+02 -1.23852510e+01 -6.68307453e+00 -6.68307453e+00
 -6.68307453e+00 -1.18158464e+00 -2.46134311e-01 -2.46134311e-01
 -2.46134311e-01  9.16928674e-01  1.21273079e+01  1.11521149e+02
  6.05696430e+02  2.74514397e+03  1.22241811e+04  4.08456308e+04
  1.04889246e+05  2.30072673e+05  4.55887601e+05  8.44839853e+05
  1.52801711e+06  2.85028450e+06  5.80817178e+06]
E1 = -706.5823764210691  E_coul = 198.61002321877584
cycle= 5 E= -507.972353202293  delta_E= -8.9e-09  |g|= 6.14e-07  |ddm|= 0.000442
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.28795e-07
diis-c [-7.71072747e-15  1.72422929e-07 -1.04658367e-04  1.10629111e-03
 -1.29368883e-02  1.01193508e+00]
  HOMO = -0.246134676224644  LUMO = 0.916928748366707
  mo_energy =
[-1.20326698e+02 -1.23852520e+01 -6.68307564e+00 -6.68307564e+00
 -6.68307564e+00 -1.18158502e+00 -2.46134676e-01 -2.46134676e-01
 -2.46134676e-01  9.16928748e-01  1.21273072e+01  1.11521148e+02
  6.05696428e+02  2.74514396e+03  1.22241811e+04  4.08456308e+04
  1.04889246e+05  2.30072673e+05  4.55887601e+05  8.44839853e+05
  1.52801711e+06  2.85028450e+06  5.80817178e+06]
E1 = -706.5823741747166  E_coul = 198.6100209724232
cycle= 6 E= -507.972353202293  delta_E= -2.27e-13  |g|= 1.14e-08  |ddm|= 1.44e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.5823741747166  E_coul = 198.6100209724232
  HOMO = -0.246134682460882  LUMO = 0.916928741916598
  mo_energy =
[-1.20326698e+02 -1.23852520e+01 -6.68307565e+00 -6.68307565e+00
 -6.68307565e+00 -1.18158503e+00 -2.46134682e-01 -2.46134682e-01
 -2.46134682e-01  9.16928742e-01  1.21273071e+01  1.11521148e+02
  6.05696428e+02  2.74514396e+03  1.22241811e+04  4.08456308e+04
  1.04889246e+05  2.30072673e+05  4.55887601e+05  8.44839853e+05
  1.52801711e+06  2.85028450e+06  5.80817178e+06]
E1 = -706.5823741511552  E_coul = 198.610020948862
Extra cycle  E= -507.972353202293  delta_E= 2.27e-13  |g|= 3.19e-09  |ddm|= 1.85e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907723.5610462838
E1 = -706.5823741511552  E_coul = 198.610020948862
init E= -507.972353202293
    CPU time for initialize scf      1.48 sec, wall time      0.09 sec
  HOMO = -0.246134683167675  LUMO = 0.916928743318996
  mo_energy =
[-1.20326698e+02 -1.23852520e+01 -6.68307566e+00 -6.68307566e+00
 -6.68307566e+00 -1.18158503e+00 -2.46134683e-01 -2.46134683e-01
 -2.46134683e-01  9.16928743e-01  1.21273071e+01  1.11521148e+02
  6.05696428e+02  2.74514396e+03  1.22241811e+04  4.08456308e+04
  1.04889246e+05  2.30072673e+05  4.55887601e+05  8.44839853e+05
  1.52801711e+06  2.85028450e+06  5.80817178e+06]
E1 = -706.5823741456524  E_coul = 198.61002094335885
cycle= 1 E= -507.972353202294  delta_E= -2.84e-13  |g|= 1.67e-09  |ddm|= 3.79e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.5823741456524  E_coul = 198.61002094335885
  HOMO = -0.246134683333265  LUMO = 0.916928744173664
  mo_energy =
[-1.20326698e+02 -1.23852520e+01 -6.68307566e+00 -6.68307566e+00
 -6.68307566e+00 -1.18158503e+00 -2.46134683e-01 -2.46134683e-01
 -2.46134683e-01  9.16928744e-01  1.21273071e+01  1.11521148e+02
  6.05696428e+02  2.74514396e+03  1.22241811e+04  4.08456308e+04
  1.04889246e+05  2.30072673e+05  4.55887601e+05  8.44839853e+05
  1.52801711e+06  2.85028450e+06  5.80817178e+06]
E1 = -706.5823741429235  E_coul = 198.61002094063045
Extra cycle  E= -507.972353202293  delta_E= 3.98e-13  |g|= 1.46e-09  |ddm|= 1.79e-09
    CPU time for scf_cycle      1.65 sec, wall time      0.16 sec
exp = [2.24564682e-01 1.17616814e+05 5.82967335e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347586e+03 1.83758102e+04 1.44974928e+03
 3.74024775e+02 1.13258973e+02 3.77437232e+01 8.08463663e+00
 3.23486157e+00 8.60377219e+00 4.91443650e-01]
grad_E = [-8.20769427e-03  4.17019625e-09 -8.95629478e-03  1.86149110e-11
  1.12378199e-10  6.48827451e-10  2.54435450e-09  1.05700231e-08
  5.68760390e-08  3.57655416e-06  1.22155670e-07  5.76351336e-06
 -1.51149896e-05  7.88673819e-05 -4.02939566e-04 -3.33516965e-04
 -2.28467461e-03  1.03639826e-03 -4.88126632e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.245324106562       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.622955894989       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209717        1
[INPUT] 0    0    [1    /1   ]  36754.7200469        1
[INPUT] 0    0    [1    /1   ]  7303.47583215        1
[INPUT] 0    0    [1    /1   ]  18375.8102137        1
[INPUT] 0    0    [1    /1   ]  1449.7492449         1
[INPUT] 0    0    [1    /1   ]  374.024869647        1
[INPUT] 0    0    [1    /1   ]  113.258529172        1
[INPUT] 0    0    [1    /1   ]  37.7459933927        1
[INPUT] 0    0    [1    /1   ]  8.08336346828        1
[INPUT] 0    0    [1    /1   ]  3.26358415062        1
[INPUT] 1    0    [1    /1   ]  8.60351607858        1
[INPUT] 1    0    [1    /1   ]  0.49207780581        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.24532410656212714, 1.0]], [0, [117616.81424224762, 1.0]], [0, [0.6229558949889854, 1.0]], [0, [1176168.142618889, 1.0]], [0, [588084.0699925759, 1.0]], [0, [294042.031131951, 1.0]], [0, [147020.99214804996, 1.0]], [0, [73510.42097167535, 1.0]], [0, [36754.72004686032, 1.0]], [0, [7303.475832149564, 1.0]], [0, [18375.810213664434, 1.0]], [0, [1449.7492448977468, 1.0]], [0, [374.0248696472053, 1.0]], [0, [113.25852917174615, 1.0]], [0, [37.74599339273331, 1.0]], [0, [8.083363468284782, 1.0]], [0, [3.26358415061751, 1.0]], [1, [8.603516078581556, 1.0]], [1, [0.49207780580982197, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24532411]
bas 1, expnt(s) = [117616.81424225]
bas 2, expnt(s) = [0.62295589]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113195]
bas 6, expnt(s) = [147020.99214805]
bas 7, expnt(s) = [73510.42097168]
bas 8, expnt(s) = [36754.72004686]
bas 9, expnt(s) = [7303.47583215]
bas 10, expnt(s) = [18375.81021366]
bas 11, expnt(s) = [1449.7492449]
bas 12, expnt(s) = [374.02486965]
bas 13, expnt(s) = [113.25852917]
bas 14, expnt(s) = [37.74599339]
bas 15, expnt(s) = [8.08336347]
bas 16, expnt(s) = [3.26358415]
bas 17, expnt(s) = [8.60351608]
bas 18, expnt(s) = [0.49207781]
CPU time:        45.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.45324107e-01 8.80684177e-01 1.17616814e+05 1.60460109e+04
 6.22955895e-01 1.77156870e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347583e+03 1.99600774e+03
 1.83758102e+04 3.98749266e+03 1.44974924e+03 5.93587426e+02
 3.74024870e+02 2.14877224e+02 1.13258529e+02 8.77138578e+01
 3.77459934e+01 3.84740734e+01 8.08336347e+00 1.21118115e+01
 3.26358415e+00 6.13459838e+00 8.60351608e+00 4.29862303e+01
 4.92077806e-01 1.20233811e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33665022242441
cond(S) = 907728.0705272022
E1 = -689.534460514001  E_coul = 184.93724097626273
init E= -504.597219537738
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.673245312591807  LUMO = 0.659451766131302
  mo_energy =
[-1.21706576e+02 -1.33871703e+01 -7.62584310e+00 -7.62584310e+00
 -7.62584310e+00 -1.65805873e+00 -6.73245313e-01 -6.73245313e-01
 -6.73245313e-01  6.59451766e-01  1.16313879e+01  1.10605827e+02
  6.04646693e+02  2.74412619e+03  1.22232476e+04  4.08447501e+04
  1.04888394e+05  2.30071841e+05  4.55886783e+05  8.44839045e+05
  1.52801631e+06  2.85028371e+06  5.80817099e+06]
E1 = -707.6823175975857  E_coul = 199.72705788938487
cycle= 1 E= -507.955259708201  delta_E= -3.36  |g|= 0.448  |ddm|= 0.518
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625957
diis-c [-0.39182219  1.        ]
  HOMO = -0.219265539329843  LUMO = 1.04553141042429
  mo_energy =
[-1.20199104e+02 -1.23071518e+01 -6.59783022e+00 -6.59783022e+00
 -6.59783022e+00 -1.16429290e+00 -2.19265539e-01 -2.19265539e-01
 -2.19265539e-01  1.04553141e+00  1.25606969e+01  1.12003496e+02
  6.06140096e+02  2.74555826e+03  1.22245704e+04  4.08460064e+04
  1.04889614e+05  2.30073036e+05  4.55887961e+05  8.44840210e+05
  1.52801747e+06  2.85028485e+06  5.80817212e+06]
E1 = -706.7532690783124  E_coul = 198.78077411879607
cycle= 2 E= -507.972494959516  delta_E= -0.0172  |g|= 0.0344  |ddm|= 0.446
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0261508
diis-c [-6.81917518e-04  2.22738566e-03  9.97772614e-01]
  HOMO = -0.240955071927747  LUMO = 1.03979721130006
  mo_energy =
[-1.20310495e+02 -1.23725300e+01 -6.67024593e+00 -6.67024593e+00
 -6.67024593e+00 -1.17829064e+00 -2.40955072e-01 -2.40955072e-01
 -2.40955072e-01  1.03979721e+00  1.25114763e+01  1.11910660e+02
  6.06024760e+02  2.74542707e+03  1.22244292e+04  4.08458615e+04
  1.04889467e+05  2.30072889e+05  4.55887813e+05  8.44840062e+05
  1.52801732e+06  2.85028470e+06  5.80817198e+06]
E1 = -706.6467681026605  E_coul = 198.6740134504644
cycle= 3 E= -507.972754652196  delta_E= -0.00026  |g|= 0.00446  |ddm|= 0.0618
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00303701
diis-c [-1.66435818e-06 -1.99544861e-04 -1.17625289e-01  1.11782483e+00]
  HOMO = -0.244194063674228  LUMO = 1.03870576763381
  mo_energy =
[-1.20322740e+02 -1.23813731e+01 -6.67960161e+00 -6.67960161e+00
 -6.67960161e+00 -1.18025943e+00 -2.44194064e-01 -2.44194064e-01
 -2.44194064e-01  1.03870577e+00  1.25044695e+01  1.11899749e+02
  6.06012342e+02  2.74541377e+03  1.22244154e+04  4.08458475e+04
  1.04889453e+05  2.30072875e+05  4.55887799e+05  8.44840047e+05
  1.52801730e+06  2.85028469e+06  5.80817196e+06]
E1 = -706.6310210394231  E_coul = 198.65826129665106
cycle= 4 E= -507.972759742772  delta_E= -5.09e-06  |g|= 0.000174  |ddm|= 0.00982
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000116388
diis-c [-7.23343229e-11 -5.92970805e-06  7.57017809e-03 -9.33404110e-02
  1.08577616e+00]
  HOMO = -0.244310305784788  LUMO = 1.03865958199171
  mo_energy =
[-1.20323001e+02 -1.23816493e+01 -6.67987137e+00 -6.67987137e+00
 -6.67987137e+00 -1.18032805e+00 -2.44310306e-01 -2.44310306e-01
 -2.44310306e-01  1.03865958e+00  1.25042356e+01  1.11899484e+02
  6.06012081e+02  2.74541351e+03  1.22244151e+04  4.08458472e+04
  1.04889453e+05  2.30072875e+05  4.55887799e+05  8.44840047e+05
  1.52801730e+06  2.85028469e+06  5.80817196e+06]
E1 = -706.6304628034383  E_coul = 198.65770305362003
cycle= 5 E= -507.972759749818  delta_E= -7.05e-09  |g|= 4.06e-07  |ddm|= 0.000386
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.26535e-07
diis-c [-4.25007446e-15  1.56447791e-07 -8.53089782e-05  9.07973907e-04
 -1.05658585e-02  1.00974304e+00]
  HOMO = -0.2443105421216  LUMO = 1.03865967765347
  mo_energy =
[-1.20323003e+02 -1.23816500e+01 -6.67987215e+00 -6.67987215e+00
 -6.67987215e+00 -1.18032833e+00 -2.44310542e-01 -2.44310542e-01
 -2.44310542e-01  1.03865968e+00  1.25042351e+01  1.11899483e+02
  6.06012080e+02  2.74541351e+03  1.22244151e+04  4.08458472e+04
  1.04889453e+05  2.30072875e+05  4.55887799e+05  8.44840047e+05
  1.52801730e+06  2.85028469e+06  5.80817196e+06]
E1 = -706.6304613616073  E_coul = 198.65770161178932
cycle= 6 E= -507.972759749818  delta_E= 2.27e-13  |g|= 3.45e-09  |ddm|= 8.62e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6304613616073  E_coul = 198.65770161178932
  HOMO = -0.244310543105613  LUMO = 1.03865967698651
  mo_energy =
[-1.20323003e+02 -1.23816500e+01 -6.67987216e+00 -6.67987216e+00
 -6.67987216e+00 -1.18032833e+00 -2.44310543e-01 -2.44310543e-01
 -2.44310543e-01  1.03865968e+00  1.25042351e+01  1.11899483e+02
  6.06012080e+02  2.74541351e+03  1.22244151e+04  4.08458472e+04
  1.04889453e+05  2.30072875e+05  4.55887799e+05  8.44840047e+05
  1.52801730e+06  2.85028469e+06  5.80817196e+06]
E1 = -706.6304613606163  E_coul = 198.65770161079777
Extra cycle  E= -507.972759749819  delta_E= -5.68e-13  |g|= 3.12e-09  |ddm|= 1.91e-09
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.45324107e-01 1.17616814e+05 6.22955895e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347583e+03 1.83758102e+04 1.44974924e+03
 3.74024870e+02 1.13258529e+02 3.77459934e+01 8.08336347e+00
 3.26358415e+00 8.60351608e+00 4.92077806e-01]
E = -507.9727597498186
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.245324106562       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.622955894989       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209717        1
[INPUT] 0    0    [1    /1   ]  36754.7200469        1
[INPUT] 0    0    [1    /1   ]  7303.47583215        1
[INPUT] 0    0    [1    /1   ]  18375.8102137        1
[INPUT] 0    0    [1    /1   ]  1449.7492449         1
[INPUT] 0    0    [1    /1   ]  374.024869647        1
[INPUT] 0    0    [1    /1   ]  113.258529172        1
[INPUT] 0    0    [1    /1   ]  37.7459933927        1
[INPUT] 0    0    [1    /1   ]  8.08336346828        1
[INPUT] 0    0    [1    /1   ]  3.26358415062        1
[INPUT] 1    0    [1    /1   ]  8.60351607858        1
[INPUT] 1    0    [1    /1   ]  0.49207780581        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.24532410656212714, 1.0]], [0, [117616.81424224762, 1.0]], [0, [0.6229558949889854, 1.0]], [0, [1176168.142618889, 1.0]], [0, [588084.0699925759, 1.0]], [0, [294042.031131951, 1.0]], [0, [147020.99214804996, 1.0]], [0, [73510.42097167535, 1.0]], [0, [36754.72004686032, 1.0]], [0, [7303.475832149564, 1.0]], [0, [18375.810213664434, 1.0]], [0, [1449.7492448977468, 1.0]], [0, [374.0248696472053, 1.0]], [0, [113.25852917174615, 1.0]], [0, [37.74599339273331, 1.0]], [0, [8.083363468284782, 1.0]], [0, [3.26358415061751, 1.0]], [1, [8.603516078581556, 1.0]], [1, [0.49207780580982197, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24532411]
bas 1, expnt(s) = [117616.81424225]
bas 2, expnt(s) = [0.62295589]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113195]
bas 6, expnt(s) = [147020.99214805]
bas 7, expnt(s) = [73510.42097168]
bas 8, expnt(s) = [36754.72004686]
bas 9, expnt(s) = [7303.47583215]
bas 10, expnt(s) = [18375.81021366]
bas 11, expnt(s) = [1449.7492449]
bas 12, expnt(s) = [374.02486965]
bas 13, expnt(s) = [113.25852917]
bas 14, expnt(s) = [37.74599339]
bas 15, expnt(s) = [8.08336347]
bas 16, expnt(s) = [3.26358415]
bas 17, expnt(s) = [8.60351608]
bas 18, expnt(s) = [0.49207781]
CPU time:        46.37
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.45324107e-01 8.80684177e-01 1.17616814e+05 1.60460109e+04
 6.22955895e-01 1.77156870e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347583e+03 1.99600774e+03
 1.83758102e+04 3.98749266e+03 1.44974924e+03 5.93587426e+02
 3.74024870e+02 2.14877224e+02 1.13258529e+02 8.77138578e+01
 3.77459934e+01 3.84740734e+01 8.08336347e+00 1.21118115e+01
 3.26358415e+00 6.13459838e+00 8.60351608e+00 4.29862303e+01
 4.92077806e-01 1.20233811e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33665022242441
cond(S) = 907728.0705272022
E1 = -689.534460514001  E_coul = 184.93724097626273
init E= -504.597219537738
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.673245312591807  LUMO = 0.659451766131302
  mo_energy =
[-1.21706576e+02 -1.33871703e+01 -7.62584310e+00 -7.62584310e+00
 -7.62584310e+00 -1.65805873e+00 -6.73245313e-01 -6.73245313e-01
 -6.73245313e-01  6.59451766e-01  1.16313879e+01  1.10605827e+02
  6.04646693e+02  2.74412619e+03  1.22232476e+04  4.08447501e+04
  1.04888394e+05  2.30071841e+05  4.55886783e+05  8.44839045e+05
  1.52801631e+06  2.85028371e+06  5.80817099e+06]
E1 = -707.6823175975857  E_coul = 199.72705788938487
cycle= 1 E= -507.955259708201  delta_E= -3.36  |g|= 0.448  |ddm|= 0.518
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625957
diis-c [-0.39182219  1.        ]
  HOMO = -0.219265539329843  LUMO = 1.04553141042429
  mo_energy =
[-1.20199104e+02 -1.23071518e+01 -6.59783022e+00 -6.59783022e+00
 -6.59783022e+00 -1.16429290e+00 -2.19265539e-01 -2.19265539e-01
 -2.19265539e-01  1.04553141e+00  1.25606969e+01  1.12003496e+02
  6.06140096e+02  2.74555826e+03  1.22245704e+04  4.08460064e+04
  1.04889614e+05  2.30073036e+05  4.55887961e+05  8.44840210e+05
  1.52801747e+06  2.85028485e+06  5.80817212e+06]
E1 = -706.7532690783124  E_coul = 198.78077411879607
cycle= 2 E= -507.972494959516  delta_E= -0.0172  |g|= 0.0344  |ddm|= 0.446
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0261508
diis-c [-6.81917518e-04  2.22738566e-03  9.97772614e-01]
  HOMO = -0.240955071927747  LUMO = 1.03979721130006
  mo_energy =
[-1.20310495e+02 -1.23725300e+01 -6.67024593e+00 -6.67024593e+00
 -6.67024593e+00 -1.17829064e+00 -2.40955072e-01 -2.40955072e-01
 -2.40955072e-01  1.03979721e+00  1.25114763e+01  1.11910660e+02
  6.06024760e+02  2.74542707e+03  1.22244292e+04  4.08458615e+04
  1.04889467e+05  2.30072889e+05  4.55887813e+05  8.44840062e+05
  1.52801732e+06  2.85028470e+06  5.80817198e+06]
E1 = -706.6467681026605  E_coul = 198.6740134504644
cycle= 3 E= -507.972754652196  delta_E= -0.00026  |g|= 0.00446  |ddm|= 0.0618
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00303701
diis-c [-1.66435818e-06 -1.99544861e-04 -1.17625289e-01  1.11782483e+00]
  HOMO = -0.244194063674228  LUMO = 1.03870576763381
  mo_energy =
[-1.20322740e+02 -1.23813731e+01 -6.67960161e+00 -6.67960161e+00
 -6.67960161e+00 -1.18025943e+00 -2.44194064e-01 -2.44194064e-01
 -2.44194064e-01  1.03870577e+00  1.25044695e+01  1.11899749e+02
  6.06012342e+02  2.74541377e+03  1.22244154e+04  4.08458475e+04
  1.04889453e+05  2.30072875e+05  4.55887799e+05  8.44840047e+05
  1.52801730e+06  2.85028469e+06  5.80817196e+06]
E1 = -706.6310210394231  E_coul = 198.65826129665106
cycle= 4 E= -507.972759742772  delta_E= -5.09e-06  |g|= 0.000174  |ddm|= 0.00982
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000116388
diis-c [-7.23343229e-11 -5.92970805e-06  7.57017809e-03 -9.33404110e-02
  1.08577616e+00]
  HOMO = -0.244310305784788  LUMO = 1.03865958199171
  mo_energy =
[-1.20323001e+02 -1.23816493e+01 -6.67987137e+00 -6.67987137e+00
 -6.67987137e+00 -1.18032805e+00 -2.44310306e-01 -2.44310306e-01
 -2.44310306e-01  1.03865958e+00  1.25042356e+01  1.11899484e+02
  6.06012081e+02  2.74541351e+03  1.22244151e+04  4.08458472e+04
  1.04889453e+05  2.30072875e+05  4.55887799e+05  8.44840047e+05
  1.52801730e+06  2.85028469e+06  5.80817196e+06]
E1 = -706.6304628034383  E_coul = 198.65770305362003
cycle= 5 E= -507.972759749818  delta_E= -7.05e-09  |g|= 4.06e-07  |ddm|= 0.000386
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.26535e-07
diis-c [-4.25007446e-15  1.56447791e-07 -8.53089782e-05  9.07973907e-04
 -1.05658585e-02  1.00974304e+00]
  HOMO = -0.2443105421216  LUMO = 1.03865967765347
  mo_energy =
[-1.20323003e+02 -1.23816500e+01 -6.67987215e+00 -6.67987215e+00
 -6.67987215e+00 -1.18032833e+00 -2.44310542e-01 -2.44310542e-01
 -2.44310542e-01  1.03865968e+00  1.25042351e+01  1.11899483e+02
  6.06012080e+02  2.74541351e+03  1.22244151e+04  4.08458472e+04
  1.04889453e+05  2.30072875e+05  4.55887799e+05  8.44840047e+05
  1.52801730e+06  2.85028469e+06  5.80817196e+06]
E1 = -706.6304613616073  E_coul = 198.65770161178932
cycle= 6 E= -507.972759749818  delta_E= 2.27e-13  |g|= 3.45e-09  |ddm|= 8.62e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6304613616073  E_coul = 198.65770161178932
  HOMO = -0.244310543105613  LUMO = 1.03865967698651
  mo_energy =
[-1.20323003e+02 -1.23816500e+01 -6.67987216e+00 -6.67987216e+00
 -6.67987216e+00 -1.18032833e+00 -2.44310543e-01 -2.44310543e-01
 -2.44310543e-01  1.03865968e+00  1.25042351e+01  1.11899483e+02
  6.06012080e+02  2.74541351e+03  1.22244151e+04  4.08458472e+04
  1.04889453e+05  2.30072875e+05  4.55887799e+05  8.44840047e+05
  1.52801730e+06  2.85028469e+06  5.80817196e+06]
E1 = -706.6304613606163  E_coul = 198.65770161079777
Extra cycle  E= -507.972759749819  delta_E= -5.68e-13  |g|= 3.12e-09  |ddm|= 1.91e-09
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907728.0705272022
E1 = -706.6304613606163  E_coul = 198.65770161079777
init E= -507.972759749819
    CPU time for initialize scf      1.47 sec, wall time      0.09 sec
  HOMO = -0.244310543163878  LUMO = 1.03865967353036
  mo_energy =
[-1.20323003e+02 -1.23816500e+01 -6.67987216e+00 -6.67987216e+00
 -6.67987216e+00 -1.18032833e+00 -2.44310543e-01 -2.44310543e-01
 -2.44310543e-01  1.03865967e+00  1.25042351e+01  1.11899483e+02
  6.06012080e+02  2.74541351e+03  1.22244151e+04  4.08458472e+04
  1.04889453e+05  2.30072875e+05  4.55887799e+05  8.44840047e+05
  1.52801730e+06  2.85028469e+06  5.80817196e+06]
E1 = -706.630461363053  E_coul = 198.65770161323488
cycle= 1 E= -507.972759749818  delta_E= 4.55e-13  |g|= 1.35e-09  |ddm|= 1.73e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.630461363053  E_coul = 198.65770161323488
  HOMO = -0.244310543082348  LUMO = 1.03865967489725
  mo_energy =
[-1.20323003e+02 -1.23816500e+01 -6.67987216e+00 -6.67987216e+00
 -6.67987216e+00 -1.18032833e+00 -2.44310543e-01 -2.44310543e-01
 -2.44310543e-01  1.03865967e+00  1.25042351e+01  1.11899483e+02
  6.06012080e+02  2.74541351e+03  1.22244151e+04  4.08458472e+04
  1.04889453e+05  2.30072875e+05  4.55887799e+05  8.44840047e+05
  1.52801730e+06  2.85028469e+06  5.80817196e+06]
E1 = -706.6304613625936  E_coul = 198.65770161277536
Extra cycle  E= -507.972759749818  delta_E= -1.14e-13  |g|= 1.91e-09  |ddm|= 4.21e-10
    CPU time for scf_cycle      1.63 sec, wall time      0.16 sec
exp = [2.45324107e-01 1.17616814e+05 6.22955895e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347583e+03 1.83758102e+04 1.44974924e+03
 3.74024870e+02 1.13258529e+02 3.77459934e+01 8.08336347e+00
 3.26358415e+00 8.60351608e+00 4.92077806e-01]
grad_E = [ 1.12023114e-05  4.16633792e-09 -5.26022000e-03  1.85685552e-11
  1.12253419e-10  6.48228667e-10  2.54197168e-09  1.05599900e-08
  5.68262438e-08  3.57289698e-06  1.22007706e-07  5.98855744e-06
 -1.88046295e-05  1.16292648e-04 -5.91469344e-04 -1.31665437e-03
  7.43725963e-04  2.49103359e-04 -2.15158139e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.254808197037       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.643326519717       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209716        1
[INPUT] 0    0    [1    /1   ]  36754.7200466        1
[INPUT] 0    0    [1    /1   ]  7303.47581587        1
[INPUT] 0    0    [1    /1   ]  18375.8102131        1
[INPUT] 0    0    [1    /1   ]  1449.74921864        1
[INPUT] 0    0    [1    /1   ]  374.024938965        1
[INPUT] 0    0    [1    /1   ]  113.258165545        1
[INPUT] 0    0    [1    /1   ]  37.7478482772        1
[INPUT] 0    0    [1    /1   ]  8.0845355034         1
[INPUT] 0    0    [1    /1   ]  3.27601240693        1
[INPUT] 1    0    [1    /1   ]  8.60372971054        1
[INPUT] 1    0    [1    /1   ]  0.492553644499       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.25480819703693003, 1.0]], [0, [117616.81424222865, 1.0]], [0, [0.6433265197171038, 1.0]], [0, [1176168.142618889, 1.0]], [0, [588084.0699925754, 1.0]], [0, [294042.03113194805, 1.0]], [0, [147020.99214803838, 1.0]], [0, [73510.42097162725, 1.0]], [0, [36754.72004660146, 1.0]], [0, [7303.475815871743, 1.0]], [0, [18375.810213108478, 1.0]], [0, [1449.7492186363793, 1.0]], [0, [374.0249389653035, 1.0]], [0, [113.25816554529602, 1.0]], [0, [37.747848277177454, 1.0]], [0, [8.084535503398747, 1.0]], [0, [3.276012406933862, 1.0]], [1, [8.603729710536895, 1.0]], [1, [0.4925536444988916, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2548082]
bas 1, expnt(s) = [117616.81424223]
bas 2, expnt(s) = [0.64332652]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113195]
bas 6, expnt(s) = [147020.99214804]
bas 7, expnt(s) = [73510.42097163]
bas 8, expnt(s) = [36754.7200466]
bas 9, expnt(s) = [7303.47581587]
bas 10, expnt(s) = [18375.81021311]
bas 11, expnt(s) = [1449.74921864]
bas 12, expnt(s) = [374.02493897]
bas 13, expnt(s) = [113.25816555]
bas 14, expnt(s) = [37.74784828]
bas 15, expnt(s) = [8.0845355]
bas 16, expnt(s) = [3.27601241]
bas 17, expnt(s) = [8.60372971]
bas 18, expnt(s) = [0.49255364]
CPU time:        51.16
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.54808197e-01 9.06097788e-01 1.17616814e+05 1.60460109e+04
 6.43326520e-01 1.81484114e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347582e+03 1.99600774e+03
 1.83758102e+04 3.98749266e+03 1.44974922e+03 5.93587418e+02
 3.74024939e+02 2.14877254e+02 1.13258166e+02 8.77136466e+01
 3.77478483e+01 3.84754914e+01 8.08453550e+00 1.21131286e+01
 3.27601241e+00 6.15211121e+00 8.60372971e+00 4.29875645e+01
 4.92553644e-01 1.20379161e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335912566202623
cond(S) = 907730.329714764
E1 = -689.5538542205696  E_coul = 184.95465602347977
init E= -504.59919819709
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.672633226913606  LUMO = 0.71068645980033
  mo_energy =
[-1.21705022e+02 -1.33857457e+01 -7.62477200e+00 -7.62477200e+00
 -7.62477200e+00 -1.65767606e+00 -6.72633227e-01 -6.72633227e-01
 -6.72633227e-01  7.10686460e-01  1.18123762e+01  1.10793480e+02
  6.04805416e+02  2.74426207e+03  1.22233656e+04  4.08448592e+04
  1.04888499e+05  2.30071943e+05  4.55886882e+05  8.44839143e+05
  1.52801641e+06  2.85028380e+06  5.80817108e+06]
E1 = -707.7159729927798  E_coul = 199.7607203142647
cycle= 1 E= -507.955252678515  delta_E= -3.36  |g|= 0.448  |ddm|= 0.517
    CPU time for cycle= 1      0.19 sec, wall time      0.01 sec
diis-norm(errvec)=0.625277
diis-c [-0.39097082  1.        ]
  HOMO = -0.218055659899836  LUMO = 1.10600118497362
  mo_energy =
[-1.20196154e+02 -1.23045725e+01 -6.59558804e+00 -6.59558804e+00
 -6.59558804e+00 -1.16338751e+00 -2.18055660e-01 -2.18055660e-01
 -2.18055660e-01  1.10600118e+00  1.27432394e+01  1.12192327e+02
  6.06300162e+02  2.74569553e+03  1.22246898e+04  4.08461169e+04
  1.04889720e+05  2.30073139e+05  4.55888062e+05  8.44840309e+05
  1.52801756e+06  2.85028495e+06  5.80817222e+06]
E1 = -706.7841478768935  E_coul = 198.81157959331443
cycle= 2 E= -507.972568283579  delta_E= -0.0173  |g|= 0.0344  |ddm|= 0.445
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0259232
diis-c [-6.69610574e-04  2.47405081e-03  9.97525949e-01]
  HOMO = -0.239735786824456  LUMO = 1.09990806592895
  mo_energy =
[-1.20307905e+02 -1.23701841e+01 -6.66825921e+00 -6.66825921e+00
 -6.66825921e+00 -1.17735546e+00 -2.39735787e-01 -2.39735787e-01
 -2.39735787e-01  1.09990807e+00  1.26936465e+01  1.12099180e+02
  6.06184462e+02  2.74556394e+03  1.22245482e+04  4.08459716e+04
  1.04889573e+05  2.30072992e+05  4.55887914e+05  8.44840161e+05
  1.52801741e+06  2.85028480e+06  5.80817207e+06]
E1 = -706.6787629518676  E_coul = 198.70594082076406
cycle= 3 E= -507.972822131104  delta_E= -0.000254  |g|= 0.00441  |ddm|= 0.0609
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00297537
diis-c [-1.60098643e-06 -1.85633654e-04 -1.16095054e-01  1.11628069e+00]
  HOMO = -0.242920483041454  LUMO = 1.0987814718248
  mo_energy =
[-1.20320075e+02 -1.23789460e+01 -6.67753537e+00 -6.67753537e+00
 -6.67753537e+00 -1.17928671e+00 -2.42920483e-01 -2.42920483e-01
 -2.42920483e-01  1.09878147e+00  1.26866980e+01  1.12088347e+02
  6.06172119e+02  2.74555072e+03  1.22245344e+04  4.08459576e+04
  1.04889559e+05  2.30072978e+05  4.55887900e+05  8.44840147e+05
  1.52801740e+06  2.85028478e+06  5.80817205e+06]
E1 = -706.6634247733572  E_coul = 198.69059781732022
cycle= 4 E= -507.972826956037  delta_E= -4.82e-06  |g|= 0.000167  |ddm|= 0.00953
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000112383
diis-c [-6.89434296e-11 -5.72846211e-06  7.46191069e-03 -9.23900608e-02
  1.08493388e+00]
  HOMO = -0.243031586790904  LUMO = 1.09873546655134
  mo_energy =
[-1.20320328e+02 -1.23792127e+01 -6.67779581e+00 -6.67779581e+00
 -6.67779581e+00 -1.17935214e+00 -2.43031587e-01 -2.43031587e-01
 -2.43031587e-01  1.09873547e+00  1.26864728e+01  1.12088090e+02
  6.06171867e+02  2.74555047e+03  1.22245342e+04  4.08459574e+04
  1.04889559e+05  2.30072977e+05  4.55887899e+05  8.44840146e+05
  1.52801740e+06  2.85028478e+06  5.80817205e+06]
E1 = -706.6628965034199  E_coul = 198.6900695410663
cycle= 5 E= -507.972826962354  delta_E= -6.32e-09  |g|= 3.29e-07  |ddm|= 0.000364
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.91142e-07
diis-c [-4.94949625e-15  1.55438344e-07 -8.13089940e-05  8.76048551e-04
 -1.01328543e-02  1.00933796e+00]
  HOMO = -0.243031766160191  LUMO = 1.09873557448452
  mo_energy =
[-1.20320329e+02 -1.23792133e+01 -6.67779645e+00 -6.67779645e+00
 -6.67779645e+00 -1.17935239e+00 -2.43031766e-01 -2.43031766e-01
 -2.43031766e-01  1.09873557e+00  1.26864724e+01  1.12088090e+02
  6.06171865e+02  2.74555047e+03  1.22245342e+04  4.08459574e+04
  1.04889559e+05  2.30072977e+05  4.55887899e+05  8.44840146e+05
  1.52801740e+06  2.85028478e+06  5.80817205e+06]
E1 = -706.6628954012504  E_coul = 198.69006843889696
cycle= 6 E= -507.972826962353  delta_E= 2.27e-13  |g|= 5.3e-09  |ddm|= 6.31e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6628954012504  E_coul = 198.69006843889696
  HOMO = -0.243031764672048  LUMO = 1.09873557057273
  mo_energy =
[-1.20320329e+02 -1.23792132e+01 -6.67779644e+00 -6.67779644e+00
 -6.67779644e+00 -1.17935239e+00 -2.43031765e-01 -2.43031765e-01
 -2.43031765e-01  1.09873557e+00  1.26864724e+01  1.12088090e+02
  6.06171865e+02  2.74555047e+03  1.22245342e+04  4.08459574e+04
  1.04889559e+05  2.30072977e+05  4.55887899e+05  8.44840146e+05
  1.52801740e+06  2.85028478e+06  5.80817205e+06]
E1 = -706.662895415581  E_coul = 198.690068453228
Extra cycle  E= -507.972826962353  delta_E= 3.98e-13  |g|= 1.66e-09  |ddm|= 8.93e-09
    CPU time for scf_cycle      0.45 sec, wall time      0.12 sec
exp = [2.54808197e-01 1.17616814e+05 6.43326520e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347582e+03 1.83758102e+04 1.44974922e+03
 3.74024939e+02 1.13258166e+02 3.77478483e+01 8.08453550e+00
 3.27601241e+00 8.60372971e+00 4.92553644e-01]
E = -507.972826962353
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.254808197037       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.643326519717       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209716        1
[INPUT] 0    0    [1    /1   ]  36754.7200466        1
[INPUT] 0    0    [1    /1   ]  7303.47581587        1
[INPUT] 0    0    [1    /1   ]  18375.8102131        1
[INPUT] 0    0    [1    /1   ]  1449.74921864        1
[INPUT] 0    0    [1    /1   ]  374.024938965        1
[INPUT] 0    0    [1    /1   ]  113.258165545        1
[INPUT] 0    0    [1    /1   ]  37.7478482772        1
[INPUT] 0    0    [1    /1   ]  8.0845355034         1
[INPUT] 0    0    [1    /1   ]  3.27601240693        1
[INPUT] 1    0    [1    /1   ]  8.60372971054        1
[INPUT] 1    0    [1    /1   ]  0.492553644499       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.25480819703693003, 1.0]], [0, [117616.81424222865, 1.0]], [0, [0.6433265197171038, 1.0]], [0, [1176168.142618889, 1.0]], [0, [588084.0699925754, 1.0]], [0, [294042.03113194805, 1.0]], [0, [147020.99214803838, 1.0]], [0, [73510.42097162725, 1.0]], [0, [36754.72004660146, 1.0]], [0, [7303.475815871743, 1.0]], [0, [18375.810213108478, 1.0]], [0, [1449.7492186363793, 1.0]], [0, [374.0249389653035, 1.0]], [0, [113.25816554529602, 1.0]], [0, [37.747848277177454, 1.0]], [0, [8.084535503398747, 1.0]], [0, [3.276012406933862, 1.0]], [1, [8.603729710536895, 1.0]], [1, [0.4925536444988916, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2548082]
bas 1, expnt(s) = [117616.81424223]
bas 2, expnt(s) = [0.64332652]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113195]
bas 6, expnt(s) = [147020.99214804]
bas 7, expnt(s) = [73510.42097163]
bas 8, expnt(s) = [36754.7200466]
bas 9, expnt(s) = [7303.47581587]
bas 10, expnt(s) = [18375.81021311]
bas 11, expnt(s) = [1449.74921864]
bas 12, expnt(s) = [374.02493897]
bas 13, expnt(s) = [113.25816555]
bas 14, expnt(s) = [37.74784828]
bas 15, expnt(s) = [8.0845355]
bas 16, expnt(s) = [3.27601241]
bas 17, expnt(s) = [8.60372971]
bas 18, expnt(s) = [0.49255364]
CPU time:        51.69
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.54808197e-01 9.06097788e-01 1.17616814e+05 1.60460109e+04
 6.43326520e-01 1.81484114e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347582e+03 1.99600774e+03
 1.83758102e+04 3.98749266e+03 1.44974922e+03 5.93587418e+02
 3.74024939e+02 2.14877254e+02 1.13258166e+02 8.77136466e+01
 3.77478483e+01 3.84754914e+01 8.08453550e+00 1.21131286e+01
 3.27601241e+00 6.15211121e+00 8.60372971e+00 4.29875645e+01
 4.92553644e-01 1.20379161e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335912566202623
cond(S) = 907730.329714764
E1 = -689.5538542205696  E_coul = 184.95465602347977
init E= -504.59919819709
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672633226913606  LUMO = 0.71068645980033
  mo_energy =
[-1.21705022e+02 -1.33857457e+01 -7.62477200e+00 -7.62477200e+00
 -7.62477200e+00 -1.65767606e+00 -6.72633227e-01 -6.72633227e-01
 -6.72633227e-01  7.10686460e-01  1.18123762e+01  1.10793480e+02
  6.04805416e+02  2.74426207e+03  1.22233656e+04  4.08448592e+04
  1.04888499e+05  2.30071943e+05  4.55886882e+05  8.44839143e+05
  1.52801641e+06  2.85028380e+06  5.80817108e+06]
E1 = -707.7159729927798  E_coul = 199.7607203142647
cycle= 1 E= -507.955252678515  delta_E= -3.36  |g|= 0.448  |ddm|= 0.517
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625277
diis-c [-0.39097082  1.        ]
  HOMO = -0.218055659899836  LUMO = 1.10600118497362
  mo_energy =
[-1.20196154e+02 -1.23045725e+01 -6.59558804e+00 -6.59558804e+00
 -6.59558804e+00 -1.16338751e+00 -2.18055660e-01 -2.18055660e-01
 -2.18055660e-01  1.10600118e+00  1.27432394e+01  1.12192327e+02
  6.06300162e+02  2.74569553e+03  1.22246898e+04  4.08461169e+04
  1.04889720e+05  2.30073139e+05  4.55888062e+05  8.44840309e+05
  1.52801756e+06  2.85028495e+06  5.80817222e+06]
E1 = -706.7841478768935  E_coul = 198.81157959331443
cycle= 2 E= -507.972568283579  delta_E= -0.0173  |g|= 0.0344  |ddm|= 0.445
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0259232
diis-c [-6.69610574e-04  2.47405081e-03  9.97525949e-01]
  HOMO = -0.239735786824456  LUMO = 1.09990806592895
  mo_energy =
[-1.20307905e+02 -1.23701841e+01 -6.66825921e+00 -6.66825921e+00
 -6.66825921e+00 -1.17735546e+00 -2.39735787e-01 -2.39735787e-01
 -2.39735787e-01  1.09990807e+00  1.26936465e+01  1.12099180e+02
  6.06184462e+02  2.74556394e+03  1.22245482e+04  4.08459716e+04
  1.04889573e+05  2.30072992e+05  4.55887914e+05  8.44840161e+05
  1.52801741e+06  2.85028480e+06  5.80817207e+06]
E1 = -706.6787629518676  E_coul = 198.70594082076406
cycle= 3 E= -507.972822131104  delta_E= -0.000254  |g|= 0.00441  |ddm|= 0.0609
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00297537
diis-c [-1.60098643e-06 -1.85633654e-04 -1.16095054e-01  1.11628069e+00]
  HOMO = -0.242920483041454  LUMO = 1.0987814718248
  mo_energy =
[-1.20320075e+02 -1.23789460e+01 -6.67753537e+00 -6.67753537e+00
 -6.67753537e+00 -1.17928671e+00 -2.42920483e-01 -2.42920483e-01
 -2.42920483e-01  1.09878147e+00  1.26866980e+01  1.12088347e+02
  6.06172119e+02  2.74555072e+03  1.22245344e+04  4.08459576e+04
  1.04889559e+05  2.30072978e+05  4.55887900e+05  8.44840147e+05
  1.52801740e+06  2.85028478e+06  5.80817205e+06]
E1 = -706.6634247733572  E_coul = 198.69059781732022
cycle= 4 E= -507.972826956037  delta_E= -4.82e-06  |g|= 0.000167  |ddm|= 0.00953
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000112383
diis-c [-6.89434296e-11 -5.72846211e-06  7.46191069e-03 -9.23900608e-02
  1.08493388e+00]
  HOMO = -0.243031586790904  LUMO = 1.09873546655134
  mo_energy =
[-1.20320328e+02 -1.23792127e+01 -6.67779581e+00 -6.67779581e+00
 -6.67779581e+00 -1.17935214e+00 -2.43031587e-01 -2.43031587e-01
 -2.43031587e-01  1.09873547e+00  1.26864728e+01  1.12088090e+02
  6.06171867e+02  2.74555047e+03  1.22245342e+04  4.08459574e+04
  1.04889559e+05  2.30072977e+05  4.55887899e+05  8.44840146e+05
  1.52801740e+06  2.85028478e+06  5.80817205e+06]
E1 = -706.6628965034199  E_coul = 198.6900695410663
cycle= 5 E= -507.972826962354  delta_E= -6.32e-09  |g|= 3.29e-07  |ddm|= 0.000364
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.91142e-07
diis-c [-4.94949625e-15  1.55438344e-07 -8.13089940e-05  8.76048551e-04
 -1.01328543e-02  1.00933796e+00]
  HOMO = -0.243031766160191  LUMO = 1.09873557448452
  mo_energy =
[-1.20320329e+02 -1.23792133e+01 -6.67779645e+00 -6.67779645e+00
 -6.67779645e+00 -1.17935239e+00 -2.43031766e-01 -2.43031766e-01
 -2.43031766e-01  1.09873557e+00  1.26864724e+01  1.12088090e+02
  6.06171865e+02  2.74555047e+03  1.22245342e+04  4.08459574e+04
  1.04889559e+05  2.30072977e+05  4.55887899e+05  8.44840146e+05
  1.52801740e+06  2.85028478e+06  5.80817205e+06]
E1 = -706.6628954012504  E_coul = 198.69006843889696
cycle= 6 E= -507.972826962353  delta_E= 2.27e-13  |g|= 5.3e-09  |ddm|= 6.31e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6628954012504  E_coul = 198.69006843889696
  HOMO = -0.243031764672048  LUMO = 1.09873557057273
  mo_energy =
[-1.20320329e+02 -1.23792132e+01 -6.67779644e+00 -6.67779644e+00
 -6.67779644e+00 -1.17935239e+00 -2.43031765e-01 -2.43031765e-01
 -2.43031765e-01  1.09873557e+00  1.26864724e+01  1.12088090e+02
  6.06171865e+02  2.74555047e+03  1.22245342e+04  4.08459574e+04
  1.04889559e+05  2.30072977e+05  4.55887899e+05  8.44840146e+05
  1.52801740e+06  2.85028478e+06  5.80817205e+06]
E1 = -706.662895415581  E_coul = 198.690068453228
Extra cycle  E= -507.972826962353  delta_E= 3.98e-13  |g|= 1.66e-09  |ddm|= 8.93e-09
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907730.329714764
E1 = -706.662895415581  E_coul = 198.690068453228
init E= -507.972826962353
    CPU time for initialize scf      1.49 sec, wall time      0.10 sec
  HOMO = -0.243031764278459  LUMO = 1.09873557114066
  mo_energy =
[-1.20320329e+02 -1.23792132e+01 -6.67779644e+00 -6.67779644e+00
 -6.67779644e+00 -1.17935239e+00 -2.43031764e-01 -2.43031764e-01
 -2.43031764e-01  1.09873557e+00  1.26864724e+01  1.12088090e+02
  6.06171865e+02  2.74555047e+03  1.22245342e+04  4.08459574e+04
  1.04889559e+05  2.30072977e+05  4.55887899e+05  8.44840146e+05
  1.52801740e+06  2.85028478e+06  5.80817205e+06]
E1 = -706.6628954168926  E_coul = 198.69006845453904
cycle= 1 E= -507.972826962354  delta_E= -5.68e-13  |g|= 1.06e-09  |ddm|= 8.32e-10
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6628954168926  E_coul = 198.69006845453904
  HOMO = -0.243031764241726  LUMO = 1.09873557158835
  mo_energy =
[-1.20320329e+02 -1.23792132e+01 -6.67779644e+00 -6.67779644e+00
 -6.67779644e+00 -1.17935239e+00 -2.43031764e-01 -2.43031764e-01
 -2.43031764e-01  1.09873557e+00  1.26864724e+01  1.12088090e+02
  6.06171865e+02  2.74555047e+03  1.22245342e+04  4.08459574e+04
  1.04889559e+05  2.30072977e+05  4.55887899e+05  8.44840146e+05
  1.52801740e+06  2.85028478e+06  5.80817205e+06]
E1 = -706.6628954164863  E_coul = 198.69006845413273
Extra cycle  E= -507.972826962354  delta_E=    0  |g|= 1.09e-09  |ddm|= 2.65e-10
    CPU time for scf_cycle      1.66 sec, wall time      0.16 sec
exp = [2.54808197e-01 1.17616814e+05 6.43326520e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347582e+03 1.83758102e+04 1.44974922e+03
 3.74024939e+02 1.13258166e+02 3.77478483e+01 8.08453550e+00
 3.27601241e+00 8.60372971e+00 4.92553644e-01]
grad_E = [ 5.40388301e-03  4.16503992e-09 -4.49952332e-03  1.85530370e-11
  1.12211504e-10  6.48027208e-10  2.54117016e-09  1.05566155e-08
  5.68094812e-08  3.57166547e-06  1.21958052e-07  6.06433373e-06
 -2.00771931e-05  1.29816499e-04 -6.63053609e-04 -1.63521076e-03
  1.67335311e-03 -3.19361299e-05 -2.80028816e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.257151919468       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.652147952147       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209716        1
[INPUT] 0    0    [1    /1   ]  36754.7200464        1
[INPUT] 0    0    [1    /1   ]  7303.47580507        1
[INPUT] 0    0    [1    /1   ]  18375.8102127        1
[INPUT] 0    0    [1    /1   ]  1449.74920088        1
[INPUT] 0    0    [1    /1   ]  374.024990207        1
[INPUT] 0    0    [1    /1   ]  113.257870238        1
[INPUT] 0    0    [1    /1   ]  37.7493567108        1
[INPUT] 0    0    [1    /1   ]  8.08682683205        1
[INPUT] 0    0    [1    /1   ]  3.27935496081        1
[INPUT] 1    0    [1    /1   ]  8.60386722417        1
[INPUT] 1    0    [1    /1   ]  0.492690897016       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.25715191946809157, 1.0]], [0, [117616.81424221605, 1.0]], [0, [0.6521479521473232, 1.0]], [0, [1176168.142618889, 1.0]], [0, [588084.0699925751, 1.0]], [0, [294042.0311319461, 1.0]], [0, [147020.9921480307, 1.0]], [0, [73510.42097159532, 1.0]], [0, [36754.72004642967, 1.0]], [0, [7303.4758050696255, 1.0]], [0, [18375.810212739572, 1.0]], [0, [1449.7492008841775, 1.0]], [0, [374.0249902068562, 1.0]], [0, [113.25787023820513, 1.0]], [0, [37.749356710760665, 1.0]], [0, [8.08682683204861, 1.0]], [0, [3.2793549608100188, 1.0]], [1, [8.603867224172026, 1.0]], [1, [0.49269089701588903, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25715192]
bas 1, expnt(s) = [117616.81424222]
bas 2, expnt(s) = [0.65214795]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113195]
bas 6, expnt(s) = [147020.99214803]
bas 7, expnt(s) = [73510.4209716]
bas 8, expnt(s) = [36754.72004643]
bas 9, expnt(s) = [7303.47580507]
bas 10, expnt(s) = [18375.81021274]
bas 11, expnt(s) = [1449.74920088]
bas 12, expnt(s) = [374.02499021]
bas 13, expnt(s) = [113.25787024]
bas 14, expnt(s) = [37.74935671]
bas 15, expnt(s) = [8.08682683]
bas 16, expnt(s) = [3.27935496]
bas 17, expnt(s) = [8.60386722]
bas 18, expnt(s) = [0.4926909]
CPU time:        56.57
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.57151919e-01 9.12341336e-01 1.17616814e+05 1.60460109e+04
 6.52147952e-01 1.83347345e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347581e+03 1.99600774e+03
 1.83758102e+04 3.98749266e+03 1.44974920e+03 5.93587412e+02
 3.74024990e+02 2.14877276e+02 1.13257870e+02 8.77134750e+01
 3.77493567e+01 3.84766445e+01 8.08682683e+00 1.21157034e+01
 3.27935496e+00 6.15681842e+00 8.60386722e+00 4.29884233e+01
 4.92690897e-01 1.20421093e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33571428802244
cond(S) = 907731.2114491261
E1 = -689.5611641201119  E_coul = 184.9611020832375
init E= -504.600062036874
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.672421963746353  LUMO = 0.727754389521587
  mo_energy =
[-1.21704421e+02 -1.33852223e+01 -7.62435123e+00 -7.62435123e+00
 -7.62435123e+00 -1.65753587e+00 -6.72421964e-01 -6.72421964e-01
 -6.72421964e-01  7.27754390e-01  1.18781251e+01  1.10867173e+02
  6.04870029e+02  2.74431776e+03  1.22234140e+04  4.08449040e+04
  1.04888542e+05  2.30071984e+05  4.55886923e+05  8.44839183e+05
  1.52801645e+06  2.85028384e+06  5.80817112e+06]
E1 = -707.7264975501757  E_coul = 199.7712792622181
cycle= 1 E= -507.955218287958  delta_E= -3.36  |g|= 0.449  |ddm|= 0.514
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625305
diis-c [-0.39100575  1.        ]
  HOMO = -0.217731185013894  LUMO = 1.12615935093391
  mo_energy =
[-1.20195127e+02 -1.23037544e+01 -6.59485562e+00 -6.59485562e+00
 -6.59485562e+00 -1.16313539e+00 -2.17731185e-01 -2.17731185e-01
 -2.17731185e-01  1.12615935e+00  1.28094401e+01  1.12266356e+02
  6.06365186e+02  2.74575167e+03  1.22247387e+04  4.08461621e+04
  1.04889763e+05  2.30073181e+05  4.55888103e+05  8.44840350e+05
  1.52801760e+06  2.85028499e+06  5.80817226e+06]
E1 = -706.7925193971768  E_coul = 198.81992873730147
cycle= 2 E= -507.972590659875  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.445
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0259167
diis-c [-6.69208300e-04  2.50893581e-03  9.97491064e-01]
  HOMO = -0.239447328733457  LUMO = 1.11992640906706
  mo_energy =
[-1.20307115e+02 -1.23695380e+01 -6.66771003e+00 -6.66771003e+00
 -6.66771003e+00 -1.17712076e+00 -2.39447329e-01 -2.39447329e-01
 -2.39447329e-01  1.11992641e+00  1.27596338e+01  1.12172995e+02
  6.06249245e+02  2.74561982e+03  1.22245968e+04  4.08460165e+04
  1.04889616e+05  2.30073034e+05  4.55887955e+05  8.44840201e+05
  1.52801745e+06  2.85028484e+06  5.80817211e+06]
E1 = -706.6873814413199  E_coul = 198.71453856274528
cycle= 3 E= -507.972842878575  delta_E= -0.000252  |g|= 0.00439  |ddm|= 0.0605
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0029647
diis-c [-1.58755119e-06 -1.81438166e-04 -1.15684783e-01  1.11586622e+00]
  HOMO = -0.242617750546494  LUMO = 1.11878571542829
  mo_energy =
[-1.20319268e+02 -1.23782811e+01 -6.67696792e+00 -6.67696792e+00
 -6.67696792e+00 -1.17904193e+00 -2.42617751e-01 -2.42617751e-01
 -2.42617751e-01  1.11878572e+00  1.27526965e+01  1.12162180e+02
  6.06236918e+02  2.74560661e+03  1.22245831e+04  4.08460026e+04
  1.04889602e+05  2.30073020e+05  4.55887941e+05  8.44840187e+05
  1.52801744e+06  2.85028482e+06  5.80817209e+06]
E1 = -706.6721709587283  E_coul = 198.69932334381164
cycle= 4 E= -507.972847614917  delta_E= -4.74e-06  |g|= 0.000164  |ddm|= 0.0094
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000111027
diis-c [-6.79574989e-11 -5.66130708e-06  7.41794124e-03 -9.18356265e-02
  1.08442335e+00]
  HOMO = -0.242726616748175  LUMO = 1.11873995293281
  mo_energy =
[-1.20319517e+02 -1.23785431e+01 -6.67722366e+00 -6.67722366e+00
 -6.67722366e+00 -1.17910598e+00 -2.42726617e-01 -2.42726617e-01
 -2.42726617e-01  1.11873995e+00  1.27524754e+01  1.12161928e+02
  6.06236671e+02  2.74560637e+03  1.22245828e+04  4.08460024e+04
  1.04889602e+05  2.30073019e+05  4.55887941e+05  8.44840187e+05
  1.52801744e+06  2.85028482e+06  5.80817209e+06]
E1 = -706.6716555040246  E_coul = 198.69880788309274
cycle= 5 E= -507.972847620932  delta_E= -6.02e-09  |g|= 3.04e-07  |ddm|= 0.000353
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.83367e-07
diis-c [-5.35572975e-15  1.64612750e-07 -8.20876941e-05  8.89407787e-04
 -1.02727335e-02  1.00946525e+00]
  HOMO = -0.242726775316632  LUMO = 1.11874006408135
  mo_energy =
[-1.20319518e+02 -1.23785436e+01 -6.67722424e+00 -6.67722424e+00
 -6.67722424e+00 -1.17910621e+00 -2.42726775e-01 -2.42726775e-01
 -2.42726775e-01  1.11874006e+00  1.27524750e+01  1.12161927e+02
  6.06236670e+02  2.74560637e+03  1.22245828e+04  4.08460024e+04
  1.04889602e+05  2.30073019e+05  4.55887941e+05  8.44840187e+05
  1.52801744e+06  2.85028482e+06  5.80817209e+06]
E1 = -706.6716545246777  E_coul = 198.6988069037461
cycle= 6 E= -507.972847620932  delta_E= 2.27e-13  |g|= 6.04e-09  |ddm|= 5.46e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6716545246777  E_coul = 198.6988069037461
  HOMO = -0.24272677291526  LUMO = 1.11874006370854
  mo_energy =
[-1.20319518e+02 -1.23785436e+01 -6.67722423e+00 -6.67722423e+00
 -6.67722423e+00 -1.17910621e+00 -2.42726773e-01 -2.42726773e-01
 -2.42726773e-01  1.11874006e+00  1.27524750e+01  1.12161927e+02
  6.06236670e+02  2.74560637e+03  1.22245828e+04  4.08460024e+04
  1.04889602e+05  2.30073019e+05  4.55887941e+05  8.44840187e+05
  1.52801744e+06  2.85028482e+06  5.80817209e+06]
E1 = -706.6716545364709  E_coul = 198.69880691553936
Extra cycle  E= -507.972847620932  delta_E= 5.68e-14  |g|= 1.85e-09  |ddm|= 7.66e-09
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
exp = [2.57151919e-01 1.17616814e+05 6.52147952e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347581e+03 1.83758102e+04 1.44974920e+03
 3.74024990e+02 1.13257870e+02 3.77493567e+01 8.08682683e+00
 3.27935496e+00 8.60386722e+00 4.92690897e-01]
E = -507.97284762093153
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.257151919468       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.652147952147       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209716        1
[INPUT] 0    0    [1    /1   ]  36754.7200464        1
[INPUT] 0    0    [1    /1   ]  7303.47580507        1
[INPUT] 0    0    [1    /1   ]  18375.8102127        1
[INPUT] 0    0    [1    /1   ]  1449.74920088        1
[INPUT] 0    0    [1    /1   ]  374.024990207        1
[INPUT] 0    0    [1    /1   ]  113.257870238        1
[INPUT] 0    0    [1    /1   ]  37.7493567108        1
[INPUT] 0    0    [1    /1   ]  8.08682683205        1
[INPUT] 0    0    [1    /1   ]  3.27935496081        1
[INPUT] 1    0    [1    /1   ]  8.60386722417        1
[INPUT] 1    0    [1    /1   ]  0.492690897016       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.25715191946809157, 1.0]], [0, [117616.81424221605, 1.0]], [0, [0.6521479521473232, 1.0]], [0, [1176168.142618889, 1.0]], [0, [588084.0699925751, 1.0]], [0, [294042.0311319461, 1.0]], [0, [147020.9921480307, 1.0]], [0, [73510.42097159532, 1.0]], [0, [36754.72004642967, 1.0]], [0, [7303.4758050696255, 1.0]], [0, [18375.810212739572, 1.0]], [0, [1449.7492008841775, 1.0]], [0, [374.0249902068562, 1.0]], [0, [113.25787023820513, 1.0]], [0, [37.749356710760665, 1.0]], [0, [8.08682683204861, 1.0]], [0, [3.2793549608100188, 1.0]], [1, [8.603867224172026, 1.0]], [1, [0.49269089701588903, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25715192]
bas 1, expnt(s) = [117616.81424222]
bas 2, expnt(s) = [0.65214795]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999258]
bas 5, expnt(s) = [294042.03113195]
bas 6, expnt(s) = [147020.99214803]
bas 7, expnt(s) = [73510.4209716]
bas 8, expnt(s) = [36754.72004643]
bas 9, expnt(s) = [7303.47580507]
bas 10, expnt(s) = [18375.81021274]
bas 11, expnt(s) = [1449.74920088]
bas 12, expnt(s) = [374.02499021]
bas 13, expnt(s) = [113.25787024]
bas 14, expnt(s) = [37.74935671]
bas 15, expnt(s) = [8.08682683]
bas 16, expnt(s) = [3.27935496]
bas 17, expnt(s) = [8.60386722]
bas 18, expnt(s) = [0.4926909]
CPU time:        57.08
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.57151919e-01 9.12341336e-01 1.17616814e+05 1.60460109e+04
 6.52147952e-01 1.83347345e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347581e+03 1.99600774e+03
 1.83758102e+04 3.98749266e+03 1.44974920e+03 5.93587412e+02
 3.74024990e+02 2.14877276e+02 1.13257870e+02 8.77134750e+01
 3.77493567e+01 3.84766445e+01 8.08682683e+00 1.21157034e+01
 3.27935496e+00 6.15681842e+00 8.60386722e+00 4.29884233e+01
 4.92690897e-01 1.20421093e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33571428802244
cond(S) = 907731.2114491261
E1 = -689.5611641201119  E_coul = 184.9611020832375
init E= -504.600062036874
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672421963746353  LUMO = 0.727754389521587
  mo_energy =
[-1.21704421e+02 -1.33852223e+01 -7.62435123e+00 -7.62435123e+00
 -7.62435123e+00 -1.65753587e+00 -6.72421964e-01 -6.72421964e-01
 -6.72421964e-01  7.27754390e-01  1.18781251e+01  1.10867173e+02
  6.04870029e+02  2.74431776e+03  1.22234140e+04  4.08449040e+04
  1.04888542e+05  2.30071984e+05  4.55886923e+05  8.44839183e+05
  1.52801645e+06  2.85028384e+06  5.80817112e+06]
E1 = -707.7264975501757  E_coul = 199.7712792622181
cycle= 1 E= -507.955218287958  delta_E= -3.36  |g|= 0.449  |ddm|= 0.514
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625305
diis-c [-0.39100575  1.        ]
  HOMO = -0.217731185013894  LUMO = 1.12615935093391
  mo_energy =
[-1.20195127e+02 -1.23037544e+01 -6.59485562e+00 -6.59485562e+00
 -6.59485562e+00 -1.16313539e+00 -2.17731185e-01 -2.17731185e-01
 -2.17731185e-01  1.12615935e+00  1.28094401e+01  1.12266356e+02
  6.06365186e+02  2.74575167e+03  1.22247387e+04  4.08461621e+04
  1.04889763e+05  2.30073181e+05  4.55888103e+05  8.44840350e+05
  1.52801760e+06  2.85028499e+06  5.80817226e+06]
E1 = -706.7925193971768  E_coul = 198.81992873730147
cycle= 2 E= -507.972590659875  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.445
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0259167
diis-c [-6.69208300e-04  2.50893581e-03  9.97491064e-01]
  HOMO = -0.239447328733457  LUMO = 1.11992640906706
  mo_energy =
[-1.20307115e+02 -1.23695380e+01 -6.66771003e+00 -6.66771003e+00
 -6.66771003e+00 -1.17712076e+00 -2.39447329e-01 -2.39447329e-01
 -2.39447329e-01  1.11992641e+00  1.27596338e+01  1.12172995e+02
  6.06249245e+02  2.74561982e+03  1.22245968e+04  4.08460165e+04
  1.04889616e+05  2.30073034e+05  4.55887955e+05  8.44840201e+05
  1.52801745e+06  2.85028484e+06  5.80817211e+06]
E1 = -706.6873814413199  E_coul = 198.71453856274528
cycle= 3 E= -507.972842878575  delta_E= -0.000252  |g|= 0.00439  |ddm|= 0.0605
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0029647
diis-c [-1.58755119e-06 -1.81438166e-04 -1.15684783e-01  1.11586622e+00]
  HOMO = -0.242617750546494  LUMO = 1.11878571542829
  mo_energy =
[-1.20319268e+02 -1.23782811e+01 -6.67696792e+00 -6.67696792e+00
 -6.67696792e+00 -1.17904193e+00 -2.42617751e-01 -2.42617751e-01
 -2.42617751e-01  1.11878572e+00  1.27526965e+01  1.12162180e+02
  6.06236918e+02  2.74560661e+03  1.22245831e+04  4.08460026e+04
  1.04889602e+05  2.30073020e+05  4.55887941e+05  8.44840187e+05
  1.52801744e+06  2.85028482e+06  5.80817209e+06]
E1 = -706.6721709587283  E_coul = 198.69932334381164
cycle= 4 E= -507.972847614917  delta_E= -4.74e-06  |g|= 0.000164  |ddm|= 0.0094
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000111027
diis-c [-6.79574989e-11 -5.66130708e-06  7.41794124e-03 -9.18356265e-02
  1.08442335e+00]
  HOMO = -0.242726616748175  LUMO = 1.11873995293281
  mo_energy =
[-1.20319517e+02 -1.23785431e+01 -6.67722366e+00 -6.67722366e+00
 -6.67722366e+00 -1.17910598e+00 -2.42726617e-01 -2.42726617e-01
 -2.42726617e-01  1.11873995e+00  1.27524754e+01  1.12161928e+02
  6.06236671e+02  2.74560637e+03  1.22245828e+04  4.08460024e+04
  1.04889602e+05  2.30073019e+05  4.55887941e+05  8.44840187e+05
  1.52801744e+06  2.85028482e+06  5.80817209e+06]
E1 = -706.6716555040246  E_coul = 198.69880788309274
cycle= 5 E= -507.972847620932  delta_E= -6.02e-09  |g|= 3.04e-07  |ddm|= 0.000353
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.83367e-07
diis-c [-5.35572975e-15  1.64612750e-07 -8.20876941e-05  8.89407787e-04
 -1.02727335e-02  1.00946525e+00]
  HOMO = -0.242726775316632  LUMO = 1.11874006408135
  mo_energy =
[-1.20319518e+02 -1.23785436e+01 -6.67722424e+00 -6.67722424e+00
 -6.67722424e+00 -1.17910621e+00 -2.42726775e-01 -2.42726775e-01
 -2.42726775e-01  1.11874006e+00  1.27524750e+01  1.12161927e+02
  6.06236670e+02  2.74560637e+03  1.22245828e+04  4.08460024e+04
  1.04889602e+05  2.30073019e+05  4.55887941e+05  8.44840187e+05
  1.52801744e+06  2.85028482e+06  5.80817209e+06]
E1 = -706.6716545246777  E_coul = 198.6988069037461
cycle= 6 E= -507.972847620932  delta_E= 2.27e-13  |g|= 6.04e-09  |ddm|= 5.46e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6716545246777  E_coul = 198.6988069037461
  HOMO = -0.24272677291526  LUMO = 1.11874006370854
  mo_energy =
[-1.20319518e+02 -1.23785436e+01 -6.67722423e+00 -6.67722423e+00
 -6.67722423e+00 -1.17910621e+00 -2.42726773e-01 -2.42726773e-01
 -2.42726773e-01  1.11874006e+00  1.27524750e+01  1.12161927e+02
  6.06236670e+02  2.74560637e+03  1.22245828e+04  4.08460024e+04
  1.04889602e+05  2.30073019e+05  4.55887941e+05  8.44840187e+05
  1.52801744e+06  2.85028482e+06  5.80817209e+06]
E1 = -706.6716545364709  E_coul = 198.69880691553936
Extra cycle  E= -507.972847620932  delta_E= 5.68e-14  |g|= 1.85e-09  |ddm|= 7.66e-09
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907731.2114491261
E1 = -706.6716545364709  E_coul = 198.69880691553936
init E= -507.972847620932
    CPU time for initialize scf      1.49 sec, wall time      0.09 sec
  HOMO = -0.24272677258063  LUMO = 1.11874006369193
  mo_energy =
[-1.20319518e+02 -1.23785436e+01 -6.67722423e+00 -6.67722423e+00
 -6.67722423e+00 -1.17910621e+00 -2.42726773e-01 -2.42726773e-01
 -2.42726773e-01  1.11874006e+00  1.27524750e+01  1.12161927e+02
  6.06236670e+02  2.74560637e+03  1.22245828e+04  4.08460024e+04
  1.04889602e+05  2.30073019e+05  4.55887941e+05  8.44840187e+05
  1.52801744e+06  2.85028482e+06  5.80817209e+06]
E1 = -706.6716545405098  E_coul = 198.69880691957826
cycle= 1 E= -507.972847620932  delta_E= -5.68e-14  |g|= 1.63e-09  |ddm|= 2.49e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6716545405098  E_coul = 198.69880691957826
  HOMO = -0.242726772478886  LUMO = 1.118740062406
  mo_energy =
[-1.20319518e+02 -1.23785436e+01 -6.67722423e+00 -6.67722423e+00
 -6.67722423e+00 -1.17910621e+00 -2.42726772e-01 -2.42726772e-01
 -2.42726772e-01  1.11874006e+00  1.27524750e+01  1.12161927e+02
  6.06236670e+02  2.74560637e+03  1.22245828e+04  4.08460024e+04
  1.04889602e+05  2.30073019e+05  4.55887941e+05  8.44840187e+05
  1.52801744e+06  2.85028482e+06  5.80817209e+06]
E1 = -706.6716545407505  E_coul = 198.69880691981922
Extra cycle  E= -507.972847620931  delta_E= 2.84e-13  |g|= 1.31e-09  |ddm|= 4.78e-10
    CPU time for scf_cycle      1.66 sec, wall time      0.16 sec
exp = [2.57151919e-01 1.17616814e+05 6.52147952e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347581e+03 1.83758102e+04 1.44974920e+03
 3.74024990e+02 1.13257870e+02 3.77493567e+01 8.08682683e+00
 3.27935496e+00 8.60386722e+00 4.92690897e-01]
grad_E = [ 3.29012121e-03  4.16503564e-09 -2.77854529e-03  1.85529741e-11
  1.12211377e-10  6.48026511e-10  2.54116756e-09  1.05566048e-08
  5.68094203e-08  3.57165756e-06  1.21957946e-07  6.06569948e-06
 -2.01420196e-05  1.31407443e-04 -6.76902573e-04 -1.68729033e-03
  1.91839749e-03 -4.89431816e-05  2.54109644e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.260071197796       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.664696918123       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209715        1
[INPUT] 0    0    [1    /1   ]  36754.7200461        1
[INPUT] 0    0    [1    /1   ]  7303.47578521        1
[INPUT] 0    0    [1    /1   ]  18375.8102121        1
[INPUT] 0    0    [1    /1   ]  1449.74916794        1
[INPUT] 0    0    [1    /1   ]  374.02508951         1
[INPUT] 0    0    [1    /1   ]  113.257272879        1
[INPUT] 0    0    [1    /1   ]  37.7524209561        1
[INPUT] 0    0    [1    /1   ]  8.09257542726        1
[INPUT] 0    0    [1    /1   ]  3.28037922831        1
[INPUT] 1    0    [1    /1   ]  8.60395316142        1
[INPUT] 1    0    [1    /1   ]  0.492623466215       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2600711977962675, 1.0]], [0, [117616.8142421929, 1.0]], [0, [0.6646969181231298, 1.0]], [0, [1176168.142618889, 1.0]], [0, [588084.0699925745, 1.0]], [0, [294042.03113194247, 1.0]], [0, [147020.99214801658, 1.0]], [0, [73510.42097153663, 1.0]], [0, [36754.72004611386, 1.0]], [0, [7303.475785212563, 1.0]], [0, [18375.810212061457, 1.0]], [0, [1449.7491679396417, 1.0]], [0, [374.02508951044314, 1.0]], [0, [113.25727287876394, 1.0]], [0, [37.75242095613603, 1.0]], [0, [8.092575427255024, 1.0]], [0, [3.2803792283052458, 1.0]], [1, [8.60395316142056, 1.0]], [1, [0.4926234662148799, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2600712]
bas 1, expnt(s) = [117616.81424219]
bas 2, expnt(s) = [0.66469692]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999257]
bas 5, expnt(s) = [294042.03113194]
bas 6, expnt(s) = [147020.99214802]
bas 7, expnt(s) = [73510.42097154]
bas 8, expnt(s) = [36754.72004611]
bas 9, expnt(s) = [7303.47578521]
bas 10, expnt(s) = [18375.81021206]
bas 11, expnt(s) = [1449.74916794]
bas 12, expnt(s) = [374.02508951]
bas 13, expnt(s) = [113.25727288]
bas 14, expnt(s) = [37.75242096]
bas 15, expnt(s) = [8.09257543]
bas 16, expnt(s) = [3.28037923]
bas 17, expnt(s) = [8.60395316]
bas 18, expnt(s) = [0.49262347]
CPU time:        61.90
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.60071198e-01 9.20098277e-01 1.17616814e+05 1.60460109e+04
 6.64696918e-01 1.85987079e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347579e+03 1.99600773e+03
 1.83758102e+04 3.98749266e+03 1.44974917e+03 5.93587402e+02
 3.74025090e+02 2.14877319e+02 1.13257273e+02 8.77131281e+01
 3.77524210e+01 3.84789869e+01 8.09257543e+00 1.21221622e+01
 3.28037923e+00 6.15826062e+00 8.60395316e+00 4.29889601e+01
 4.92623466e-01 1.20400492e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335783014022415
cond(S) = 907732.4073069406
E1 = -689.5618326903857  E_coul = 184.96122706507975
init E= -504.600605625306
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.67244435707469  LUMO = 0.750690396902397
  mo_energy =
[-1.21704384e+02 -1.33852443e+01 -7.62429950e+00 -7.62429950e+00
 -7.62429950e+00 -1.65756562e+00 -6.72444357e-01 -6.72444357e-01
 -6.72444357e-01  7.50690397e-01  1.19616882e+01  1.10964969e+02
  6.04958466e+02  2.74439435e+03  1.22234806e+04  4.08449655e+04
  1.04888601e+05  2.30072042e+05  4.55886979e+05  8.44839238e+05
  1.52801650e+06  2.85028389e+06  5.80817117e+06]
E1 = -707.7264278960575  E_coul = 199.77124528270863
cycle= 1 E= -507.955182613349  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625439
diis-c [-0.3911741  1.       ]
  HOMO = -0.217891366399906  LUMO = 1.15302238313752
  mo_energy =
[-1.20194925e+02 -1.23037491e+01 -6.59474507e+00 -6.59474507e+00
 -6.59474507e+00 -1.16322534e+00 -2.17891366e-01 -2.17891366e-01
 -2.17891366e-01  1.15302238e+00  1.28931942e+01  1.12364189e+02
  6.06453780e+02  2.74582847e+03  1.22248055e+04  4.08462239e+04
  1.04889822e+05  2.30073239e+05  4.55888160e+05  8.44840405e+05
  1.52801766e+06  2.85028504e+06  5.80817231e+06]
E1 = -706.7900301941268  E_coul = 198.81741233065912
cycle= 2 E= -507.972617863468  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.443
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0259183
diis-c [-6.69223070e-04  2.54216802e-03  9.97457832e-01]
  HOMO = -0.239634662937806  LUMO = 1.14660519498972
  mo_energy =
[-1.20307197e+02 -1.23697298e+01 -6.66781426e+00 -6.66781426e+00
 -6.66781426e+00 -1.17722433e+00 -2.39634663e-01 -2.39634663e-01
 -2.39634663e-01  1.14660519e+00  1.28431383e+01  1.12270576e+02
  6.06337552e+02  2.74569631e+03  1.22246632e+04  4.08460779e+04
  1.04889675e+05  2.30073091e+05  4.55888011e+05  8.44840256e+05
  1.52801751e+06  2.85028489e+06  5.80817216e+06]
E1 = -706.6853006602544  E_coul = 198.7124330420122
cycle= 3 E= -507.972867618242  delta_E= -0.00025  |g|= 0.00436  |ddm|= 0.0599
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00295153
diis-c [-1.57195991e-06 -1.75607600e-04 -1.15121947e-01  1.11529755e+00]
  HOMO = -0.242782459307667  LUMO = 1.14544686288493
  mo_energy =
[-1.20319318e+02 -1.23784403e+01 -6.67704030e+00 -6.67704030e+00
 -6.67704030e+00 -1.17913047e+00 -2.42782459e-01 -2.42782459e-01
 -2.42782459e-01  1.14544686e+00  1.28362227e+01  1.12259792e+02
  6.06325257e+02  2.74568313e+03  1.22246495e+04  4.08460641e+04
  1.04889661e+05  2.30073077e+05  4.55887997e+05  8.44840242e+05
  1.52801749e+06  2.85028488e+06  5.80817214e+06]
E1 = -706.6702737224562  E_coul = 198.69740149048855
cycle= 4 E= -507.972872231968  delta_E= -4.61e-06  |g|= 0.00016  |ddm|= 0.00923
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000109324
diis-c [-6.67786725e-11 -5.58523072e-06  7.35977510e-03 -9.11132607e-02
  1.08375907e+00]
  HOMO = -0.242888273439622  LUMO = 1.14540148282374
  mo_energy =
[-1.20319559e+02 -1.23786959e+01 -6.67728955e+00 -6.67728955e+00
 -6.67728955e+00 -1.17919266e+00 -2.42888273e-01 -2.42888273e-01
 -2.42888273e-01  1.14540148e+00  1.28360072e+01  1.12259547e+02
  6.06325017e+02  2.74568290e+03  1.22246493e+04  4.08460638e+04
  1.04889661e+05  2.30073076e+05  4.55887997e+05  8.44840242e+05
  1.52801749e+06  2.85028488e+06  5.80817214e+06]
E1 = -706.669775466408  E_coul = 198.69690322881485
cycle= 5 E= -507.972872237593  delta_E= -5.63e-09  |g|= 2.77e-07  |ddm|= 0.000339
    CPU time for cycle= 5      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=2.69729e-07
diis-c [-6.13109305e-15  1.65026515e-07 -8.13794418e-05  8.87623717e-04
 -1.02582478e-02  1.00945184e+00]
  HOMO = -0.242888405618994  LUMO = 1.1454015999003
  mo_energy =
[-1.20319560e+02 -1.23786963e+01 -6.67729006e+00 -6.67729006e+00
 -6.67729006e+00 -1.17919287e+00 -2.42888406e-01 -2.42888406e-01
 -2.42888406e-01  1.14540160e+00  1.28360069e+01  1.12259547e+02
  6.06325016e+02  2.74568289e+03  1.22246493e+04  4.08460638e+04
  1.04889661e+05  2.30073076e+05  4.55887997e+05  8.44840242e+05
  1.52801749e+06  2.85028488e+06  5.80817214e+06]
E1 = -706.6697746386392  E_coul = 198.69690240104552
cycle= 6 E= -507.972872237594  delta_E= -4.55e-13  |g|= 7.38e-09  |ddm|= 4.43e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6697746386392  E_coul = 198.69690240104552
  HOMO = -0.242888402089222  LUMO = 1.14540159901035
  mo_energy =
[-1.20319560e+02 -1.23786963e+01 -6.67729005e+00 -6.67729005e+00
 -6.67729005e+00 -1.17919287e+00 -2.42888402e-01 -2.42888402e-01
 -2.42888402e-01  1.14540160e+00  1.28360069e+01  1.12259547e+02
  6.06325016e+02  2.74568289e+03  1.22246493e+04  4.08460638e+04
  1.04889661e+05  2.30073076e+05  4.55887997e+05  8.44840242e+05
  1.52801749e+06  2.85028488e+06  5.80817214e+06]
E1 = -706.6697746591436  E_coul = 198.69690242155073
Extra cycle  E= -507.972872237593  delta_E= 7.39e-13  |g|= 2.18e-09  |ddm|= 1.34e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.12 sec
exp = [2.60071198e-01 1.17616814e+05 6.64696918e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347579e+03 1.83758102e+04 1.44974917e+03
 3.74025090e+02 1.13257273e+02 3.77524210e+01 8.09257543e+00
 3.28037923e+00 8.60395316e+00 4.92623466e-01]
E = -507.9728722375929
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.260071197796       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.664696918123       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209715        1
[INPUT] 0    0    [1    /1   ]  36754.7200461        1
[INPUT] 0    0    [1    /1   ]  7303.47578521        1
[INPUT] 0    0    [1    /1   ]  18375.8102121        1
[INPUT] 0    0    [1    /1   ]  1449.74916794        1
[INPUT] 0    0    [1    /1   ]  374.02508951         1
[INPUT] 0    0    [1    /1   ]  113.257272879        1
[INPUT] 0    0    [1    /1   ]  37.7524209561        1
[INPUT] 0    0    [1    /1   ]  8.09257542726        1
[INPUT] 0    0    [1    /1   ]  3.28037922831        1
[INPUT] 1    0    [1    /1   ]  8.60395316142        1
[INPUT] 1    0    [1    /1   ]  0.492623466215       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2600711977962675, 1.0]], [0, [117616.8142421929, 1.0]], [0, [0.6646969181231298, 1.0]], [0, [1176168.142618889, 1.0]], [0, [588084.0699925745, 1.0]], [0, [294042.03113194247, 1.0]], [0, [147020.99214801658, 1.0]], [0, [73510.42097153663, 1.0]], [0, [36754.72004611386, 1.0]], [0, [7303.475785212563, 1.0]], [0, [18375.810212061457, 1.0]], [0, [1449.7491679396417, 1.0]], [0, [374.02508951044314, 1.0]], [0, [113.25727287876394, 1.0]], [0, [37.75242095613603, 1.0]], [0, [8.092575427255024, 1.0]], [0, [3.2803792283052458, 1.0]], [1, [8.60395316142056, 1.0]], [1, [0.4926234662148799, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2600712]
bas 1, expnt(s) = [117616.81424219]
bas 2, expnt(s) = [0.66469692]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999257]
bas 5, expnt(s) = [294042.03113194]
bas 6, expnt(s) = [147020.99214802]
bas 7, expnt(s) = [73510.42097154]
bas 8, expnt(s) = [36754.72004611]
bas 9, expnt(s) = [7303.47578521]
bas 10, expnt(s) = [18375.81021206]
bas 11, expnt(s) = [1449.74916794]
bas 12, expnt(s) = [374.02508951]
bas 13, expnt(s) = [113.25727288]
bas 14, expnt(s) = [37.75242096]
bas 15, expnt(s) = [8.09257543]
bas 16, expnt(s) = [3.28037923]
bas 17, expnt(s) = [8.60395316]
bas 18, expnt(s) = [0.49262347]
CPU time:        62.42
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.60071198e-01 9.20098277e-01 1.17616814e+05 1.60460109e+04
 6.64696918e-01 1.85987079e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347579e+03 1.99600773e+03
 1.83758102e+04 3.98749266e+03 1.44974917e+03 5.93587402e+02
 3.74025090e+02 2.14877319e+02 1.13257273e+02 8.77131281e+01
 3.77524210e+01 3.84789869e+01 8.09257543e+00 1.21221622e+01
 3.28037923e+00 6.15826062e+00 8.60395316e+00 4.29889601e+01
 4.92623466e-01 1.20400492e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335783014022415
cond(S) = 907732.4073069406
E1 = -689.5618326903857  E_coul = 184.96122706507975
init E= -504.600605625306
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.67244435707469  LUMO = 0.750690396902397
  mo_energy =
[-1.21704384e+02 -1.33852443e+01 -7.62429950e+00 -7.62429950e+00
 -7.62429950e+00 -1.65756562e+00 -6.72444357e-01 -6.72444357e-01
 -6.72444357e-01  7.50690397e-01  1.19616882e+01  1.10964969e+02
  6.04958466e+02  2.74439435e+03  1.22234806e+04  4.08449655e+04
  1.04888601e+05  2.30072042e+05  4.55886979e+05  8.44839238e+05
  1.52801650e+06  2.85028389e+06  5.80817117e+06]
E1 = -707.7264278960575  E_coul = 199.77124528270863
cycle= 1 E= -507.955182613349  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625439
diis-c [-0.3911741  1.       ]
  HOMO = -0.217891366399906  LUMO = 1.15302238313752
  mo_energy =
[-1.20194925e+02 -1.23037491e+01 -6.59474507e+00 -6.59474507e+00
 -6.59474507e+00 -1.16322534e+00 -2.17891366e-01 -2.17891366e-01
 -2.17891366e-01  1.15302238e+00  1.28931942e+01  1.12364189e+02
  6.06453780e+02  2.74582847e+03  1.22248055e+04  4.08462239e+04
  1.04889822e+05  2.30073239e+05  4.55888160e+05  8.44840405e+05
  1.52801766e+06  2.85028504e+06  5.80817231e+06]
E1 = -706.7900301941268  E_coul = 198.81741233065912
cycle= 2 E= -507.972617863468  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.443
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0259183
diis-c [-6.69223070e-04  2.54216802e-03  9.97457832e-01]
  HOMO = -0.239634662937806  LUMO = 1.14660519498972
  mo_energy =
[-1.20307197e+02 -1.23697298e+01 -6.66781426e+00 -6.66781426e+00
 -6.66781426e+00 -1.17722433e+00 -2.39634663e-01 -2.39634663e-01
 -2.39634663e-01  1.14660519e+00  1.28431383e+01  1.12270576e+02
  6.06337552e+02  2.74569631e+03  1.22246632e+04  4.08460779e+04
  1.04889675e+05  2.30073091e+05  4.55888011e+05  8.44840256e+05
  1.52801751e+06  2.85028489e+06  5.80817216e+06]
E1 = -706.6853006602544  E_coul = 198.7124330420122
cycle= 3 E= -507.972867618242  delta_E= -0.00025  |g|= 0.00436  |ddm|= 0.0599
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00295153
diis-c [-1.57195991e-06 -1.75607600e-04 -1.15121947e-01  1.11529755e+00]
  HOMO = -0.242782459307667  LUMO = 1.14544686288493
  mo_energy =
[-1.20319318e+02 -1.23784403e+01 -6.67704030e+00 -6.67704030e+00
 -6.67704030e+00 -1.17913047e+00 -2.42782459e-01 -2.42782459e-01
 -2.42782459e-01  1.14544686e+00  1.28362227e+01  1.12259792e+02
  6.06325257e+02  2.74568313e+03  1.22246495e+04  4.08460641e+04
  1.04889661e+05  2.30073077e+05  4.55887997e+05  8.44840242e+05
  1.52801749e+06  2.85028488e+06  5.80817214e+06]
E1 = -706.6702737224562  E_coul = 198.69740149048855
cycle= 4 E= -507.972872231968  delta_E= -4.61e-06  |g|= 0.00016  |ddm|= 0.00923
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000109324
diis-c [-6.67786725e-11 -5.58523072e-06  7.35977510e-03 -9.11132607e-02
  1.08375907e+00]
  HOMO = -0.242888273439622  LUMO = 1.14540148282374
  mo_energy =
[-1.20319559e+02 -1.23786959e+01 -6.67728955e+00 -6.67728955e+00
 -6.67728955e+00 -1.17919266e+00 -2.42888273e-01 -2.42888273e-01
 -2.42888273e-01  1.14540148e+00  1.28360072e+01  1.12259547e+02
  6.06325017e+02  2.74568290e+03  1.22246493e+04  4.08460638e+04
  1.04889661e+05  2.30073076e+05  4.55887997e+05  8.44840242e+05
  1.52801749e+06  2.85028488e+06  5.80817214e+06]
E1 = -706.669775466408  E_coul = 198.69690322881485
cycle= 5 E= -507.972872237593  delta_E= -5.63e-09  |g|= 2.77e-07  |ddm|= 0.000339
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.69729e-07
diis-c [-6.13109305e-15  1.65026515e-07 -8.13794418e-05  8.87623717e-04
 -1.02582478e-02  1.00945184e+00]
  HOMO = -0.242888405618994  LUMO = 1.1454015999003
  mo_energy =
[-1.20319560e+02 -1.23786963e+01 -6.67729006e+00 -6.67729006e+00
 -6.67729006e+00 -1.17919287e+00 -2.42888406e-01 -2.42888406e-01
 -2.42888406e-01  1.14540160e+00  1.28360069e+01  1.12259547e+02
  6.06325016e+02  2.74568289e+03  1.22246493e+04  4.08460638e+04
  1.04889661e+05  2.30073076e+05  4.55887997e+05  8.44840242e+05
  1.52801749e+06  2.85028488e+06  5.80817214e+06]
E1 = -706.6697746386392  E_coul = 198.69690240104552
cycle= 6 E= -507.972872237594  delta_E= -4.55e-13  |g|= 7.38e-09  |ddm|= 4.43e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6697746386392  E_coul = 198.69690240104552
  HOMO = -0.242888402089222  LUMO = 1.14540159901035
  mo_energy =
[-1.20319560e+02 -1.23786963e+01 -6.67729005e+00 -6.67729005e+00
 -6.67729005e+00 -1.17919287e+00 -2.42888402e-01 -2.42888402e-01
 -2.42888402e-01  1.14540160e+00  1.28360069e+01  1.12259547e+02
  6.06325016e+02  2.74568289e+03  1.22246493e+04  4.08460638e+04
  1.04889661e+05  2.30073076e+05  4.55887997e+05  8.44840242e+05
  1.52801749e+06  2.85028488e+06  5.80817214e+06]
E1 = -706.6697746591436  E_coul = 198.69690242155073
Extra cycle  E= -507.972872237593  delta_E= 7.39e-13  |g|= 2.18e-09  |ddm|= 1.34e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907732.4073069406
E1 = -706.6697746591436  E_coul = 198.69690242155073
init E= -507.972872237593
    CPU time for initialize scf      1.49 sec, wall time      0.09 sec
  HOMO = -0.24288840151899  LUMO = 1.14540159849803
  mo_energy =
[-1.20319560e+02 -1.23786963e+01 -6.67729005e+00 -6.67729005e+00
 -6.67729005e+00 -1.17919287e+00 -2.42888402e-01 -2.42888402e-01
 -2.42888402e-01  1.14540160e+00  1.28360069e+01  1.12259547e+02
  6.06325016e+02  2.74568289e+03  1.22246493e+04  4.08460638e+04
  1.04889661e+05  2.30073076e+05  4.55887997e+05  8.44840242e+05
  1.52801749e+06  2.85028488e+06  5.80817214e+06]
E1 = -706.6697746612114  E_coul = 198.69690242361781
cycle= 1 E= -507.972872237594  delta_E= -6.25e-13  |g|= 1.85e-09  |ddm|= 1.44e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6697746612114  E_coul = 198.69690242361781
  HOMO = -0.24288840145263  LUMO = 1.14540159895041
  mo_energy =
[-1.20319560e+02 -1.23786963e+01 -6.67729005e+00 -6.67729005e+00
 -6.67729005e+00 -1.17919287e+00 -2.42888401e-01 -2.42888401e-01
 -2.42888401e-01  1.14540160e+00  1.28360069e+01  1.12259547e+02
  6.06325016e+02  2.74568289e+03  1.22246493e+04  4.08460638e+04
  1.04889661e+05  2.30073076e+05  4.55887997e+05  8.44840242e+05
  1.52801749e+06  2.85028488e+06  5.80817214e+06]
E1 = -706.6697746633714  E_coul = 198.69690242577838
Extra cycle  E= -507.972872237593  delta_E= 5.12e-13  |g|= 1.24e-09  |ddm|= 1.35e-09
    CPU time for scf_cycle      1.66 sec, wall time      0.16 sec
exp = [2.60071198e-01 1.17616814e+05 6.64696918e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347579e+03 1.83758102e+04 1.44974917e+03
 3.74025090e+02 1.13257273e+02 3.77524210e+01 8.09257543e+00
 3.28037923e+00 8.60395316e+00 4.92623466e-01]
grad_E = [-2.42252447e-05  4.16588735e-09 -4.04332699e-04  1.85631440e-11
  1.12238884e-10  6.48158681e-10  2.54169351e-09  1.05588192e-08
  5.68204139e-08  3.57245924e-06  1.21990560e-07  6.01858297e-06
 -1.94721772e-05  1.26695549e-04 -6.66805276e-04 -1.56816978e-03
  1.68787211e-03  8.90181982e-05  5.06025677e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.26172183473        1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.672483554523       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209715        1
[INPUT] 0    0    [1    /1   ]  36754.7200458        1
[INPUT] 0    0    [1    /1   ]  7303.4757667         1
[INPUT] 0    0    [1    /1   ]  18375.8102114        1
[INPUT] 0    0    [1    /1   ]  1449.74913702        1
[INPUT] 0    0    [1    /1   ]  374.025185471        1
[INPUT] 0    0    [1    /1   ]  113.256677132        1
[INPUT] 0    0    [1    /1   ]  37.7555030688        1
[INPUT] 0    0    [1    /1   ]  8.09902124199        1
[INPUT] 0    0    [1    /1   ]  3.27758928939        1
[INPUT] 1    0    [1    /1   ]  8.60391589322        1
[INPUT] 1    0    [1    /1   ]  0.492563492747       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26172183473039323, 1.0]], [0, [117616.8142421713, 1.0]], [0, [0.672483554523461, 1.0]], [0, [1176168.142618889, 1.0]], [0, [588084.0699925739, 1.0]], [0, [294042.0311319391, 1.0]], [0, [147020.9921480034, 1.0]], [0, [73510.4209714819, 1.0]], [0, [36754.72004581935, 1.0]], [0, [7303.475766695516, 1.0]], [0, [18375.81021142912, 1.0]], [0, [1449.7491370224432, 1.0]], [0, [374.0251854708879, 1.0]], [0, [113.25667713225631, 1.0]], [0, [37.755503068802305, 1.0]], [0, [8.09902124198778, 1.0]], [0, [3.277589289392498, 1.0]], [1, [8.603915893221, 1.0]], [1, [0.4925634927470295, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26172183]
bas 1, expnt(s) = [117616.81424217]
bas 2, expnt(s) = [0.67248355]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999257]
bas 5, expnt(s) = [294042.03113194]
bas 6, expnt(s) = [147020.992148]
bas 7, expnt(s) = [73510.42097148]
bas 8, expnt(s) = [36754.72004582]
bas 9, expnt(s) = [7303.4757667]
bas 10, expnt(s) = [18375.81021143]
bas 11, expnt(s) = [1449.74913702]
bas 12, expnt(s) = [374.02518547]
bas 13, expnt(s) = [113.25667713]
bas 14, expnt(s) = [37.75550307]
bas 15, expnt(s) = [8.09902124]
bas 16, expnt(s) = [3.27758929]
bas 17, expnt(s) = [8.60391589]
bas 18, expnt(s) = [0.49256349]
CPU time:        67.21
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61721835e-01 9.24474617e-01 1.17616814e+05 1.60460109e+04
 6.72483555e-01 1.87618766e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347577e+03 1.99600773e+03
 1.83758102e+04 3.98749266e+03 1.44974914e+03 5.93587393e+02
 3.74025185e+02 2.14877360e+02 1.13256677e+02 8.77127820e+01
 3.77555031e+01 3.84813430e+01 8.09902124e+00 1.21294031e+01
 3.27758929e+00 6.15433203e+00 8.60391589e+00 4.29887273e+01
 4.92563493e-01 1.20382170e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335851644899577
cond(S) = 907733.1407556928
E1 = -689.561398331302  E_coul = 184.9603307944339
init E= -504.601067536868
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672482744979025  LUMO = 0.764362489609251
  mo_energy =
[-1.21704471e+02 -1.33853470e+01 -7.62432938e+00 -7.62432938e+00
 -7.62432938e+00 -1.65759000e+00 -6.72482745e-01 -6.72482745e-01
 -6.72482745e-01  7.64362490e-01  1.20066917e+01  1.11023664e+02
  6.05014865e+02  2.74444372e+03  1.22235235e+04  4.08450052e+04
  1.04888639e+05  2.30072078e+05  4.55887015e+05  8.44839274e+05
  1.52801654e+06  2.85028393e+06  5.80817120e+06]
E1 = -707.7241013491764  E_coul = 199.76893560161966
cycle= 1 E= -507.955165747557  delta_E= -3.35  |g|= 0.449  |ddm|= 0.506
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625595
diis-c [-0.39136972  1.        ]
  HOMO = -0.218045235052061  LUMO = 1.16896808065054
  mo_energy =
[-1.20195036e+02 -1.23039325e+01 -6.59485044e+00 -6.59485044e+00
 -6.59485044e+00 -1.16331748e+00 -2.18045235e-01 -2.18045235e-01
 -2.18045235e-01  1.16896808e+00  1.29381626e+01  1.12422776e+02
  6.06510164e+02  2.74587787e+03  1.22248485e+04  4.08462636e+04
  1.04889861e+05  2.30073276e+05  4.55888196e+05  8.44840441e+05
  1.52801769e+06  2.85028507e+06  5.80817234e+06]
E1 = -706.7864863571273  E_coul = 198.8138524769219
cycle= 2 E= -507.972633880205  delta_E= -0.0175  |g|= 0.0345  |ddm|= 0.442
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0259274
diis-c [-6.69667242e-04  2.55425567e-03  9.97445744e-01]
  HOMO = -0.239796168729448  LUMO = 1.1624449883692
  mo_energy =
[-1.20307464e+02 -1.23700126e+01 -6.66803127e+00 -6.66803127e+00
 -6.66803127e+00 -1.17731868e+00 -2.39796169e-01 -2.39796169e-01
 -2.39796169e-01  1.16244499e+00  1.28879819e+01  1.12329024e+02
  6.06393776e+02  2.74574553e+03  1.22247061e+04  4.08461175e+04
  1.04889713e+05  2.30073128e+05  4.55888047e+05  8.44840291e+05
  1.52801754e+06  2.85028492e+06  5.80817219e+06]
E1 = -706.6820317097342  E_coul = 198.70914961270472
cycle= 3 E= -507.97288209703  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0595
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00294465
diis-c [-1.56464958e-06 -1.72087963e-04 -1.14779271e-01  1.11495136e+00]
  HOMO = -0.242929336692938  LUMO = 1.16127698118033
  mo_energy =
[-1.20319562e+02 -1.23787004e+01 -6.67723491e+00 -6.67723491e+00
 -6.67723491e+00 -1.17921518e+00 -2.42929337e-01 -2.42929337e-01
 -2.42929337e-01  1.16127698e+00  1.28810828e+01  1.12318263e+02
  6.06381505e+02  2.74573238e+03  1.22246924e+04  4.08461036e+04
  1.04889699e+05  2.30073114e+05  4.55888033e+05  8.44840277e+05
  1.52801753e+06  2.85028491e+06  5.80817218e+06]
E1 = -706.6671175353725  E_coul = 198.69423089697776
cycle= 4 E= -507.972886638395  delta_E= -4.54e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108423
diis-c [-6.61850909e-11 -5.53418812e-06  7.32643174e-03 -9.07156756e-02
  1.08339478e+00]
  HOMO = -0.243033391166923  LUMO = 1.16123184262919
  mo_energy =
[-1.20319799e+02 -1.23789522e+01 -6.67748039e+00 -6.67748039e+00
 -6.67748039e+00 -1.17927631e+00 -2.43033391e-01 -2.43033391e-01
 -2.43033391e-01  1.16123184e+00  1.28808706e+01  1.12318022e+02
  6.06381268e+02  2.74573214e+03  1.22246922e+04  4.08461034e+04
  1.04889699e+05  2.30073113e+05  4.55888033e+05  8.44840277e+05
  1.52801753e+06  2.85028491e+06  5.80817218e+06]
E1 = -706.6666291224803  E_coul = 198.69374247867486
cycle= 5 E= -507.972886643806  delta_E= -5.41e-09  |g|= 2.64e-07  |ddm|= 0.000332
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.64873e-07
diis-c [-6.65599723e-15  1.68910458e-07 -8.19838300e-05  8.98095115e-04
 -1.03670596e-02  1.00955078e+00]
  HOMO = -0.243033508760653  LUMO = 1.16123196223527
  mo_energy =
[-1.20319800e+02 -1.23789526e+01 -6.67748087e+00 -6.67748087e+00
 -6.67748087e+00 -1.17927651e+00 -2.43033509e-01 -2.43033509e-01
 -2.43033509e-01  1.16123196e+00  1.28808703e+01  1.12318022e+02
  6.06381267e+02  2.74573214e+03  1.22246922e+04  4.08461034e+04
  1.04889699e+05  2.30073113e+05  4.55888033e+05  8.44840277e+05
  1.52801753e+06  2.85028491e+06  5.80817218e+06]
E1 = -706.6666283777183  E_coul = 198.6937417339124
cycle= 6 E= -507.972886643806  delta_E= -4.55e-13  |g|= 8.43e-09  |ddm|= 3.87e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6666283777183  E_coul = 198.6937417339124
  HOMO = -0.243033504684006  LUMO = 1.16123196309323
  mo_energy =
[-1.20319800e+02 -1.23789526e+01 -6.67748085e+00 -6.67748085e+00
 -6.67748085e+00 -1.17927651e+00 -2.43033505e-01 -2.43033505e-01
 -2.43033505e-01  1.16123196e+00  1.28808703e+01  1.12318022e+02
  6.06381267e+02  2.74573214e+03  1.22246922e+04  4.08461034e+04
  1.04889699e+05  2.30073113e+05  4.55888033e+05  8.44840277e+05
  1.52801753e+06  2.85028491e+06  5.80817218e+06]
E1 = -706.6666284001194  E_coul = 198.69374175631356
Extra cycle  E= -507.972886643806  delta_E= 1.14e-13  |g|= 2.16e-09  |ddm|= 1.46e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
exp = [2.61721835e-01 1.17616814e+05 6.72483555e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347577e+03 1.83758102e+04 1.44974914e+03
 3.74025185e+02 1.13256677e+02 3.77555031e+01 8.09902124e+00
 3.27758929e+00 8.60391589e+00 4.92563493e-01]
E = -507.97288664380585
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:52:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.26172183473        1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.672483554523       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209715        1
[INPUT] 0    0    [1    /1   ]  36754.7200458        1
[INPUT] 0    0    [1    /1   ]  7303.4757667         1
[INPUT] 0    0    [1    /1   ]  18375.8102114        1
[INPUT] 0    0    [1    /1   ]  1449.74913702        1
[INPUT] 0    0    [1    /1   ]  374.025185471        1
[INPUT] 0    0    [1    /1   ]  113.256677132        1
[INPUT] 0    0    [1    /1   ]  37.7555030688        1
[INPUT] 0    0    [1    /1   ]  8.09902124199        1
[INPUT] 0    0    [1    /1   ]  3.27758928939        1
[INPUT] 1    0    [1    /1   ]  8.60391589322        1
[INPUT] 1    0    [1    /1   ]  0.492563492747       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26172183473039323, 1.0]], [0, [117616.8142421713, 1.0]], [0, [0.672483554523461, 1.0]], [0, [1176168.142618889, 1.0]], [0, [588084.0699925739, 1.0]], [0, [294042.0311319391, 1.0]], [0, [147020.9921480034, 1.0]], [0, [73510.4209714819, 1.0]], [0, [36754.72004581935, 1.0]], [0, [7303.475766695516, 1.0]], [0, [18375.81021142912, 1.0]], [0, [1449.7491370224432, 1.0]], [0, [374.0251854708879, 1.0]], [0, [113.25667713225631, 1.0]], [0, [37.755503068802305, 1.0]], [0, [8.09902124198778, 1.0]], [0, [3.277589289392498, 1.0]], [1, [8.603915893221, 1.0]], [1, [0.4925634927470295, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26172183]
bas 1, expnt(s) = [117616.81424217]
bas 2, expnt(s) = [0.67248355]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999257]
bas 5, expnt(s) = [294042.03113194]
bas 6, expnt(s) = [147020.992148]
bas 7, expnt(s) = [73510.42097148]
bas 8, expnt(s) = [36754.72004582]
bas 9, expnt(s) = [7303.4757667]
bas 10, expnt(s) = [18375.81021143]
bas 11, expnt(s) = [1449.74913702]
bas 12, expnt(s) = [374.02518547]
bas 13, expnt(s) = [113.25667713]
bas 14, expnt(s) = [37.75550307]
bas 15, expnt(s) = [8.09902124]
bas 16, expnt(s) = [3.27758929]
bas 17, expnt(s) = [8.60391589]
bas 18, expnt(s) = [0.49256349]
CPU time:        67.73
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61721835e-01 9.24474617e-01 1.17616814e+05 1.60460109e+04
 6.72483555e-01 1.87618766e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347577e+03 1.99600773e+03
 1.83758102e+04 3.98749266e+03 1.44974914e+03 5.93587393e+02
 3.74025185e+02 2.14877360e+02 1.13256677e+02 8.77127820e+01
 3.77555031e+01 3.84813430e+01 8.09902124e+00 1.21294031e+01
 3.27758929e+00 6.15433203e+00 8.60391589e+00 4.29887273e+01
 4.92563493e-01 1.20382170e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335851644899577
cond(S) = 907733.1407556928
E1 = -689.561398331302  E_coul = 184.9603307944339
init E= -504.601067536868
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672482744979025  LUMO = 0.764362489609251
  mo_energy =
[-1.21704471e+02 -1.33853470e+01 -7.62432938e+00 -7.62432938e+00
 -7.62432938e+00 -1.65759000e+00 -6.72482745e-01 -6.72482745e-01
 -6.72482745e-01  7.64362490e-01  1.20066917e+01  1.11023664e+02
  6.05014865e+02  2.74444372e+03  1.22235235e+04  4.08450052e+04
  1.04888639e+05  2.30072078e+05  4.55887015e+05  8.44839274e+05
  1.52801654e+06  2.85028393e+06  5.80817120e+06]
E1 = -707.7241013491764  E_coul = 199.76893560161966
cycle= 1 E= -507.955165747557  delta_E= -3.35  |g|= 0.449  |ddm|= 0.506
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625595
diis-c [-0.39136972  1.        ]
  HOMO = -0.218045235052061  LUMO = 1.16896808065054
  mo_energy =
[-1.20195036e+02 -1.23039325e+01 -6.59485044e+00 -6.59485044e+00
 -6.59485044e+00 -1.16331748e+00 -2.18045235e-01 -2.18045235e-01
 -2.18045235e-01  1.16896808e+00  1.29381626e+01  1.12422776e+02
  6.06510164e+02  2.74587787e+03  1.22248485e+04  4.08462636e+04
  1.04889861e+05  2.30073276e+05  4.55888196e+05  8.44840441e+05
  1.52801769e+06  2.85028507e+06  5.80817234e+06]
E1 = -706.7864863571273  E_coul = 198.8138524769219
cycle= 2 E= -507.972633880205  delta_E= -0.0175  |g|= 0.0345  |ddm|= 0.442
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0259274
diis-c [-6.69667242e-04  2.55425567e-03  9.97445744e-01]
  HOMO = -0.239796168729448  LUMO = 1.1624449883692
  mo_energy =
[-1.20307464e+02 -1.23700126e+01 -6.66803127e+00 -6.66803127e+00
 -6.66803127e+00 -1.17731868e+00 -2.39796169e-01 -2.39796169e-01
 -2.39796169e-01  1.16244499e+00  1.28879819e+01  1.12329024e+02
  6.06393776e+02  2.74574553e+03  1.22247061e+04  4.08461175e+04
  1.04889713e+05  2.30073128e+05  4.55888047e+05  8.44840291e+05
  1.52801754e+06  2.85028492e+06  5.80817219e+06]
E1 = -706.6820317097342  E_coul = 198.70914961270472
cycle= 3 E= -507.97288209703  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0595
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00294465
diis-c [-1.56464958e-06 -1.72087963e-04 -1.14779271e-01  1.11495136e+00]
  HOMO = -0.242929336692938  LUMO = 1.16127698118033
  mo_energy =
[-1.20319562e+02 -1.23787004e+01 -6.67723491e+00 -6.67723491e+00
 -6.67723491e+00 -1.17921518e+00 -2.42929337e-01 -2.42929337e-01
 -2.42929337e-01  1.16127698e+00  1.28810828e+01  1.12318263e+02
  6.06381505e+02  2.74573238e+03  1.22246924e+04  4.08461036e+04
  1.04889699e+05  2.30073114e+05  4.55888033e+05  8.44840277e+05
  1.52801753e+06  2.85028491e+06  5.80817218e+06]
E1 = -706.6671175353725  E_coul = 198.69423089697776
cycle= 4 E= -507.972886638395  delta_E= -4.54e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108423
diis-c [-6.61850909e-11 -5.53418812e-06  7.32643174e-03 -9.07156756e-02
  1.08339478e+00]
  HOMO = -0.243033391166923  LUMO = 1.16123184262919
  mo_energy =
[-1.20319799e+02 -1.23789522e+01 -6.67748039e+00 -6.67748039e+00
 -6.67748039e+00 -1.17927631e+00 -2.43033391e-01 -2.43033391e-01
 -2.43033391e-01  1.16123184e+00  1.28808706e+01  1.12318022e+02
  6.06381268e+02  2.74573214e+03  1.22246922e+04  4.08461034e+04
  1.04889699e+05  2.30073113e+05  4.55888033e+05  8.44840277e+05
  1.52801753e+06  2.85028491e+06  5.80817218e+06]
E1 = -706.6666291224803  E_coul = 198.69374247867486
cycle= 5 E= -507.972886643806  delta_E= -5.41e-09  |g|= 2.64e-07  |ddm|= 0.000332
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.64873e-07
diis-c [-6.65599723e-15  1.68910458e-07 -8.19838300e-05  8.98095115e-04
 -1.03670596e-02  1.00955078e+00]
  HOMO = -0.243033508760653  LUMO = 1.16123196223527
  mo_energy =
[-1.20319800e+02 -1.23789526e+01 -6.67748087e+00 -6.67748087e+00
 -6.67748087e+00 -1.17927651e+00 -2.43033509e-01 -2.43033509e-01
 -2.43033509e-01  1.16123196e+00  1.28808703e+01  1.12318022e+02
  6.06381267e+02  2.74573214e+03  1.22246922e+04  4.08461034e+04
  1.04889699e+05  2.30073113e+05  4.55888033e+05  8.44840277e+05
  1.52801753e+06  2.85028491e+06  5.80817218e+06]
E1 = -706.6666283777183  E_coul = 198.6937417339124
cycle= 6 E= -507.972886643806  delta_E= -4.55e-13  |g|= 8.43e-09  |ddm|= 3.87e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6666283777183  E_coul = 198.6937417339124
  HOMO = -0.243033504684006  LUMO = 1.16123196309323
  mo_energy =
[-1.20319800e+02 -1.23789526e+01 -6.67748085e+00 -6.67748085e+00
 -6.67748085e+00 -1.17927651e+00 -2.43033505e-01 -2.43033505e-01
 -2.43033505e-01  1.16123196e+00  1.28808703e+01  1.12318022e+02
  6.06381267e+02  2.74573214e+03  1.22246922e+04  4.08461034e+04
  1.04889699e+05  2.30073113e+05  4.55888033e+05  8.44840277e+05
  1.52801753e+06  2.85028491e+06  5.80817218e+06]
E1 = -706.6666284001194  E_coul = 198.69374175631356
Extra cycle  E= -507.972886643806  delta_E= 1.14e-13  |g|= 2.16e-09  |ddm|= 1.46e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907733.1407556928
E1 = -706.6666284001194  E_coul = 198.69374175631356
init E= -507.972886643806
    CPU time for initialize scf      1.41 sec, wall time      0.09 sec
  HOMO = -0.243033504068073  LUMO = 1.16123196368117
  mo_energy =
[-1.20319800e+02 -1.23789526e+01 -6.67748085e+00 -6.67748085e+00
 -6.67748085e+00 -1.17927651e+00 -2.43033504e-01 -2.43033504e-01
 -2.43033504e-01  1.16123196e+00  1.28808704e+01  1.12318022e+02
  6.06381267e+02  2.74573214e+03  1.22246922e+04  4.08461034e+04
  1.04889699e+05  2.30073113e+05  4.55888033e+05  8.44840277e+05
  1.52801753e+06  2.85028491e+06  5.80817218e+06]
E1 = -706.666628402808  E_coul = 198.69374175900225
cycle= 1 E= -507.972886643806  delta_E= 1.14e-13  |g|= 2.17e-09  |ddm|= 1.7e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.666628402808  E_coul = 198.69374175900225
  HOMO = -0.243033503994723  LUMO = 1.16123196319311
  mo_energy =
[-1.20319800e+02 -1.23789526e+01 -6.67748085e+00 -6.67748085e+00
 -6.67748085e+00 -1.17927651e+00 -2.43033504e-01 -2.43033504e-01
 -2.43033504e-01  1.16123196e+00  1.28808703e+01  1.12318022e+02
  6.06381267e+02  2.74573214e+03  1.22246922e+04  4.08461034e+04
  1.04889699e+05  2.30073113e+05  4.55888033e+05  8.44840277e+05
  1.52801753e+06  2.85028491e+06  5.80817218e+06]
E1 = -706.666628403057  E_coul = 198.6937417592511
Extra cycle  E= -507.972886643806  delta_E= -1.14e-13  |g|= 1.69e-09  |ddm|= 2.57e-10
    CPU time for scf_cycle      1.58 sec, wall time      0.16 sec
exp = [2.61721835e-01 1.17616814e+05 6.72483555e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347577e+03 1.83758102e+04 1.44974914e+03
 3.74025185e+02 1.13256677e+02 3.77555031e+01 8.09902124e+00
 3.27758929e+00 8.60391589e+00 4.92563493e-01]
grad_E = [-1.79578856e-03  4.16733336e-09  9.35164789e-04  1.85804600e-11
  1.12285610e-10  6.48383092e-10  2.54258649e-09  1.05625789e-08
  5.68390784e-08  3.57382441e-06  1.22045953e-07  5.93691063e-06
 -1.82466953e-05  1.16545866e-04 -6.30791562e-04 -1.30712820e-03
  9.84192369e-04  1.09023178e-04 -1.45302438e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.262508703254       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.676194203363       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209714        1
[INPUT] 0    0    [1    /1   ]  36754.7200455        1
[INPUT] 0    0    [1    /1   ]  7303.4757492         1
[INPUT] 0    0    [1    /1   ]  18375.8102108        1
[INPUT] 0    0    [1    /1   ]  1449.74910776        1
[INPUT] 0    0    [1    /1   ]  374.025277288        1
[INPUT] 0    0    [1    /1   ]  113.256095492        1
[INPUT] 0    0    [1    /1   ]  37.7585549339        1
[INPUT] 0    0    [1    /1   ]  8.10566466313        1
[INPUT] 0    0    [1    /1   ]  3.27281094772        1
[INPUT] 1    0    [1    /1   ]  8.60386094418        1
[INPUT] 1    0    [1    /1   ]  0.492564311451       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2625087032538913, 1.0]], [0, [117616.8142421509, 1.0]], [0, [0.6761942033633074, 1.0]], [0, [1176168.142618889, 1.0]], [0, [588084.0699925733, 1.0]], [0, [294042.0311319359, 1.0]], [0, [147020.99214799094, 1.0]], [0, [73510.4209714302, 1.0]], [0, [36754.72004554114, 1.0]], [0, [7303.4757492033605, 1.0]], [0, [18375.810210831787, 1.0]], [0, [1449.749107764569, 1.0]], [0, [374.0252772884819, 1.0]], [0, [113.25609549194515, 1.0]], [0, [37.75855493390393, 1.0]], [0, [8.105664663128255, 1.0]], [0, [3.2728109477244343, 1.0]], [1, [8.603860944179134, 1.0]], [1, [0.49256431145087115, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2625087]
bas 1, expnt(s) = [117616.81424215]
bas 2, expnt(s) = [0.6761942]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999257]
bas 5, expnt(s) = [294042.03113194]
bas 6, expnt(s) = [147020.99214799]
bas 7, expnt(s) = [73510.42097143]
bas 8, expnt(s) = [36754.72004554]
bas 9, expnt(s) = [7303.4757492]
bas 10, expnt(s) = [18375.81021083]
bas 11, expnt(s) = [1449.74910776]
bas 12, expnt(s) = [374.02527729]
bas 13, expnt(s) = [113.25609549]
bas 14, expnt(s) = [37.75855493]
bas 15, expnt(s) = [8.10566466]
bas 16, expnt(s) = [3.27281095]
bas 17, expnt(s) = [8.60386094]
bas 18, expnt(s) = [0.49256431]
CPU time:        72.47
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.62508703e-01 9.26558414e-01 1.17616814e+05 1.60460109e+04
 6.76194203e-01 1.88394668e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347575e+03 1.99600773e+03
 1.83758102e+04 3.98749266e+03 1.44974911e+03 5.93587384e+02
 3.74025277e+02 2.14877400e+02 1.13256095e+02 8.77124442e+01
 3.77585549e+01 3.84836759e+01 8.10566466e+00 1.21368644e+01
 3.27281095e+00 6.14760158e+00 8.60386094e+00 4.29883841e+01
 4.92564311e-01 1.20382420e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335846590465987
cond(S) = 907733.5281894873
E1 = -689.5623659973293  E_coul = 184.9607592998105
init E= -504.601606697519
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672466525295345  LUMO = 0.770749883463527
  mo_energy =
[-1.21704436e+02 -1.33853327e+01 -7.62429298e+00 -7.62429298e+00
 -7.62429298e+00 -1.65756797e+00 -6.72466525e-01 -6.72466525e-01
 -6.72466525e-01  7.70749883e-01  1.20229539e+01  1.11053841e+02
  6.05047855e+02  2.74447322e+03  1.22235493e+04  4.08450290e+04
  1.04888662e+05  2.30072101e+05  4.55887037e+05  8.44839295e+05
  1.52801656e+06  2.85028395e+06  5.80817122e+06]
E1 = -707.7236474175515  E_coul = 199.768483842047
cycle= 1 E= -507.955163575505  delta_E= -3.35  |g|= 0.449  |ddm|= 0.505
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625721
diis-c [-0.39152671  1.        ]
  HOMO = -0.218055195314878  LUMO = 1.17639671030913
  mo_energy =
[-1.20195056e+02 -1.23039833e+01 -6.59489534e+00 -6.59489534e+00
 -6.59489534e+00 -1.16331321e+00 -2.18055195e-01 -2.18055195e-01
 -2.18055195e-01  1.17639671e+00  1.29543343e+01  1.12452845e+02
  6.06543113e+02  2.74590735e+03  1.22248743e+04  4.08462875e+04
  1.04889883e+05  2.30073298e+05  4.55888217e+05  8.44840462e+05
  1.52801771e+06  2.85028509e+06  5.80817236e+06]
E1 = -706.7856455274934  E_coul = 198.8130018166549
cycle= 2 E= -507.972643710839  delta_E= -0.0175  |g|= 0.0345  |ddm|= 0.442
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0259359
diis-c [-6.70100569e-04  2.55782293e-03  9.97442177e-01]
  HOMO = -0.239803255498237  LUMO = 1.16982879940469
  mo_energy =
[-1.20307550e+02 -1.23700939e+01 -6.66811403e+00 -6.66811403e+00
 -6.66811403e+00 -1.17731003e+00 -2.39803255e-01 -2.39803255e-01
 -2.39803255e-01  1.16982880e+00  1.29041175e+01  1.12359037e+02
  6.06426658e+02  2.74577494e+03  1.22247318e+04  4.08461412e+04
  1.04889736e+05  2.30073150e+05  4.55888068e+05  8.44840313e+05
  1.52801756e+06  2.85028494e+06  5.80817221e+06]
E1 = -706.681342073658  E_coul = 198.70845090070685
cycle= 3 E= -507.972891172951  delta_E= -0.000247  |g|= 0.00434  |ddm|= 0.0594
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00294191
diis-c [-1.56259552e-06 -1.70480913e-04 -1.14610813e-01  1.11478129e+00]
  HOMO = -0.242928928267998  LUMO = 1.16865696165352
  mo_energy =
[-1.20319634e+02 -1.23787688e+01 -6.67730489e+00 -6.67730489e+00
 -6.67730489e+00 -1.17920152e+00 -2.42928928e-01 -2.42928928e-01
 -2.42928928e-01  1.16865696e+00  1.28972290e+01  1.12348289e+02
  6.06414400e+02  2.74576180e+03  1.22247181e+04  4.08461274e+04
  1.04889722e+05  2.30073136e+05  4.55888054e+05  8.44840299e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6664822183604  E_coul = 198.69358653685208
cycle= 4 E= -507.972895681508  delta_E= -4.51e-06  |g|= 0.000157  |ddm|= 0.00909
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108097
diis-c [-6.60202901e-11 -5.49795635e-06  7.31259903e-03 -9.05692675e-02
  1.08326217e+00]
  HOMO = -0.243032241511426  LUMO = 1.16861191893414
  mo_energy =
[-1.20319870e+02 -1.23790190e+01 -6.67754877e+00 -6.67754877e+00
 -6.67754877e+00 -1.17926220e+00 -2.43032242e-01 -2.43032242e-01
 -2.43032242e-01  1.16861192e+00  1.28970182e+01  1.12348050e+02
  6.06414166e+02  2.74576157e+03  1.22247179e+04  4.08461272e+04
  1.04889721e+05  2.30073135e+05  4.55888054e+05  8.44840299e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6659979582823  E_coul = 198.69310227144996
cycle= 5 E= -507.972895686832  delta_E= -5.32e-09  |g|= 2.6e-07  |ddm|= 0.000329
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.61468e-07
diis-c [-6.91919772e-15  1.65457844e-07 -8.10618253e-05  8.88647645e-04
 -1.02583745e-02  1.00945062e+00]
  HOMO = -0.243032353248469  LUMO = 1.16861204253956
  mo_energy =
[-1.20319871e+02 -1.23790194e+01 -6.67754923e+00 -6.67754923e+00
 -6.67754923e+00 -1.17926240e+00 -2.43032353e-01 -2.43032353e-01
 -2.43032353e-01  1.16861204e+00  1.28970179e+01  1.12348049e+02
  6.06414165e+02  2.74576157e+03  1.22247179e+04  4.08461272e+04
  1.04889721e+05  2.30073135e+05  4.55888054e+05  8.44840299e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6659972452536  E_coul = 198.69310155842143
cycle= 6 E= -507.972895686832  delta_E= 1.71e-13  |g|= 9.09e-09  |ddm|= 3.65e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6659972452536  E_coul = 198.69310155842143
  HOMO = -0.243032348896329  LUMO = 1.16861203976151
  mo_energy =
[-1.20319871e+02 -1.23790194e+01 -6.67754922e+00 -6.67754922e+00
 -6.67754922e+00 -1.17926240e+00 -2.43032349e-01 -2.43032349e-01
 -2.43032349e-01  1.16861204e+00  1.28970179e+01  1.12348049e+02
  6.06414165e+02  2.74576157e+03  1.22247179e+04  4.08461272e+04
  1.04889721e+05  2.30073135e+05  4.55888054e+05  8.44840299e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6659972697847  E_coul = 198.69310158295232
Extra cycle  E= -507.972895686832  delta_E= -2.27e-13  |g|= 2.21e-09  |ddm|= 1.62e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.62508703e-01 1.17616814e+05 6.76194203e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347575e+03 1.83758102e+04 1.44974911e+03
 3.74025277e+02 1.13256095e+02 3.77585549e+01 8.10566466e+00
 3.27281095e+00 8.60386094e+00 4.92564311e-01]
E = -507.97289568683243
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:03 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.262508703254       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.676194203363       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209714        1
[INPUT] 0    0    [1    /1   ]  36754.7200455        1
[INPUT] 0    0    [1    /1   ]  7303.4757492         1
[INPUT] 0    0    [1    /1   ]  18375.8102108        1
[INPUT] 0    0    [1    /1   ]  1449.74910776        1
[INPUT] 0    0    [1    /1   ]  374.025277288        1
[INPUT] 0    0    [1    /1   ]  113.256095492        1
[INPUT] 0    0    [1    /1   ]  37.7585549339        1
[INPUT] 0    0    [1    /1   ]  8.10566466313        1
[INPUT] 0    0    [1    /1   ]  3.27281094772        1
[INPUT] 1    0    [1    /1   ]  8.60386094418        1
[INPUT] 1    0    [1    /1   ]  0.492564311451       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2625087032538913, 1.0]], [0, [117616.8142421509, 1.0]], [0, [0.6761942033633074, 1.0]], [0, [1176168.142618889, 1.0]], [0, [588084.0699925733, 1.0]], [0, [294042.0311319359, 1.0]], [0, [147020.99214799094, 1.0]], [0, [73510.4209714302, 1.0]], [0, [36754.72004554114, 1.0]], [0, [7303.4757492033605, 1.0]], [0, [18375.810210831787, 1.0]], [0, [1449.749107764569, 1.0]], [0, [374.0252772884819, 1.0]], [0, [113.25609549194515, 1.0]], [0, [37.75855493390393, 1.0]], [0, [8.105664663128255, 1.0]], [0, [3.2728109477244343, 1.0]], [1, [8.603860944179134, 1.0]], [1, [0.49256431145087115, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2625087]
bas 1, expnt(s) = [117616.81424215]
bas 2, expnt(s) = [0.6761942]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999257]
bas 5, expnt(s) = [294042.03113194]
bas 6, expnt(s) = [147020.99214799]
bas 7, expnt(s) = [73510.42097143]
bas 8, expnt(s) = [36754.72004554]
bas 9, expnt(s) = [7303.4757492]
bas 10, expnt(s) = [18375.81021083]
bas 11, expnt(s) = [1449.74910776]
bas 12, expnt(s) = [374.02527729]
bas 13, expnt(s) = [113.25609549]
bas 14, expnt(s) = [37.75855493]
bas 15, expnt(s) = [8.10566466]
bas 16, expnt(s) = [3.27281095]
bas 17, expnt(s) = [8.60386094]
bas 18, expnt(s) = [0.49256431]
CPU time:        72.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.62508703e-01 9.26558414e-01 1.17616814e+05 1.60460109e+04
 6.76194203e-01 1.88394668e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347575e+03 1.99600773e+03
 1.83758102e+04 3.98749266e+03 1.44974911e+03 5.93587384e+02
 3.74025277e+02 2.14877400e+02 1.13256095e+02 8.77124442e+01
 3.77585549e+01 3.84836759e+01 8.10566466e+00 1.21368644e+01
 3.27281095e+00 6.14760158e+00 8.60386094e+00 4.29883841e+01
 4.92564311e-01 1.20382420e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335846590465987
cond(S) = 907733.5281894873
E1 = -689.5623659973293  E_coul = 184.9607592998105
init E= -504.601606697519
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672466525295345  LUMO = 0.770749883463527
  mo_energy =
[-1.21704436e+02 -1.33853327e+01 -7.62429298e+00 -7.62429298e+00
 -7.62429298e+00 -1.65756797e+00 -6.72466525e-01 -6.72466525e-01
 -6.72466525e-01  7.70749883e-01  1.20229539e+01  1.11053841e+02
  6.05047855e+02  2.74447322e+03  1.22235493e+04  4.08450290e+04
  1.04888662e+05  2.30072101e+05  4.55887037e+05  8.44839295e+05
  1.52801656e+06  2.85028395e+06  5.80817122e+06]
E1 = -707.7236474175515  E_coul = 199.768483842047
cycle= 1 E= -507.955163575505  delta_E= -3.35  |g|= 0.449  |ddm|= 0.505
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625721
diis-c [-0.39152671  1.        ]
  HOMO = -0.218055195314878  LUMO = 1.17639671030913
  mo_energy =
[-1.20195056e+02 -1.23039833e+01 -6.59489534e+00 -6.59489534e+00
 -6.59489534e+00 -1.16331321e+00 -2.18055195e-01 -2.18055195e-01
 -2.18055195e-01  1.17639671e+00  1.29543343e+01  1.12452845e+02
  6.06543113e+02  2.74590735e+03  1.22248743e+04  4.08462875e+04
  1.04889883e+05  2.30073298e+05  4.55888217e+05  8.44840462e+05
  1.52801771e+06  2.85028509e+06  5.80817236e+06]
E1 = -706.7856455274934  E_coul = 198.8130018166549
cycle= 2 E= -507.972643710839  delta_E= -0.0175  |g|= 0.0345  |ddm|= 0.442
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0259359
diis-c [-6.70100569e-04  2.55782293e-03  9.97442177e-01]
  HOMO = -0.239803255498237  LUMO = 1.16982879940469
  mo_energy =
[-1.20307550e+02 -1.23700939e+01 -6.66811403e+00 -6.66811403e+00
 -6.66811403e+00 -1.17731003e+00 -2.39803255e-01 -2.39803255e-01
 -2.39803255e-01  1.16982880e+00  1.29041175e+01  1.12359037e+02
  6.06426658e+02  2.74577494e+03  1.22247318e+04  4.08461412e+04
  1.04889736e+05  2.30073150e+05  4.55888068e+05  8.44840313e+05
  1.52801756e+06  2.85028494e+06  5.80817221e+06]
E1 = -706.681342073658  E_coul = 198.70845090070685
cycle= 3 E= -507.972891172951  delta_E= -0.000247  |g|= 0.00434  |ddm|= 0.0594
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00294191
diis-c [-1.56259552e-06 -1.70480913e-04 -1.14610813e-01  1.11478129e+00]
  HOMO = -0.242928928267998  LUMO = 1.16865696165352
  mo_energy =
[-1.20319634e+02 -1.23787688e+01 -6.67730489e+00 -6.67730489e+00
 -6.67730489e+00 -1.17920152e+00 -2.42928928e-01 -2.42928928e-01
 -2.42928928e-01  1.16865696e+00  1.28972290e+01  1.12348289e+02
  6.06414400e+02  2.74576180e+03  1.22247181e+04  4.08461274e+04
  1.04889722e+05  2.30073136e+05  4.55888054e+05  8.44840299e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6664822183604  E_coul = 198.69358653685208
cycle= 4 E= -507.972895681508  delta_E= -4.51e-06  |g|= 0.000157  |ddm|= 0.00909
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108097
diis-c [-6.60202901e-11 -5.49795635e-06  7.31259903e-03 -9.05692675e-02
  1.08326217e+00]
  HOMO = -0.243032241511426  LUMO = 1.16861191893414
  mo_energy =
[-1.20319870e+02 -1.23790190e+01 -6.67754877e+00 -6.67754877e+00
 -6.67754877e+00 -1.17926220e+00 -2.43032242e-01 -2.43032242e-01
 -2.43032242e-01  1.16861192e+00  1.28970182e+01  1.12348050e+02
  6.06414166e+02  2.74576157e+03  1.22247179e+04  4.08461272e+04
  1.04889721e+05  2.30073135e+05  4.55888054e+05  8.44840299e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6659979582823  E_coul = 198.69310227144996
cycle= 5 E= -507.972895686832  delta_E= -5.32e-09  |g|= 2.6e-07  |ddm|= 0.000329
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.61468e-07
diis-c [-6.91919772e-15  1.65457844e-07 -8.10618253e-05  8.88647645e-04
 -1.02583745e-02  1.00945062e+00]
  HOMO = -0.243032353248469  LUMO = 1.16861204253956
  mo_energy =
[-1.20319871e+02 -1.23790194e+01 -6.67754923e+00 -6.67754923e+00
 -6.67754923e+00 -1.17926240e+00 -2.43032353e-01 -2.43032353e-01
 -2.43032353e-01  1.16861204e+00  1.28970179e+01  1.12348049e+02
  6.06414165e+02  2.74576157e+03  1.22247179e+04  4.08461272e+04
  1.04889721e+05  2.30073135e+05  4.55888054e+05  8.44840299e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6659972452536  E_coul = 198.69310155842143
cycle= 6 E= -507.972895686832  delta_E= 1.71e-13  |g|= 9.09e-09  |ddm|= 3.65e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6659972452536  E_coul = 198.69310155842143
  HOMO = -0.243032348896329  LUMO = 1.16861203976151
  mo_energy =
[-1.20319871e+02 -1.23790194e+01 -6.67754922e+00 -6.67754922e+00
 -6.67754922e+00 -1.17926240e+00 -2.43032349e-01 -2.43032349e-01
 -2.43032349e-01  1.16861204e+00  1.28970179e+01  1.12348049e+02
  6.06414165e+02  2.74576157e+03  1.22247179e+04  4.08461272e+04
  1.04889721e+05  2.30073135e+05  4.55888054e+05  8.44840299e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6659972697847  E_coul = 198.69310158295232
Extra cycle  E= -507.972895686832  delta_E= -2.27e-13  |g|= 2.21e-09  |ddm|= 1.62e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907733.5281894873
E1 = -706.6659972697847  E_coul = 198.69310158295232
init E= -507.972895686832
    CPU time for initialize scf      1.50 sec, wall time      0.10 sec
  HOMO = -0.243032348201187  LUMO = 1.1686120425453
  mo_energy =
[-1.20319871e+02 -1.23790194e+01 -6.67754922e+00 -6.67754922e+00
 -6.67754922e+00 -1.17926239e+00 -2.43032348e-01 -2.43032348e-01
 -2.43032348e-01  1.16861204e+00  1.28970179e+01  1.12348050e+02
  6.06414165e+02  2.74576157e+03  1.22247179e+04  4.08461272e+04
  1.04889721e+05  2.30073135e+05  4.55888054e+05  8.44840299e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6659972715319  E_coul = 198.69310158469978
cycle= 1 E= -507.972895686832  delta_E= 3.41e-13  |g|= 1.36e-09  |ddm|= 1.09e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6659972715319  E_coul = 198.69310158469978
  HOMO = -0.24303234816079  LUMO = 1.16861204130537
  mo_energy =
[-1.20319871e+02 -1.23790194e+01 -6.67754922e+00 -6.67754922e+00
 -6.67754922e+00 -1.17926239e+00 -2.43032348e-01 -2.43032348e-01
 -2.43032348e-01  1.16861204e+00  1.28970179e+01  1.12348050e+02
  6.06414165e+02  2.74576157e+03  1.22247179e+04  4.08461272e+04
  1.04889721e+05  2.30073135e+05  4.55888054e+05  8.44840299e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6659972724466  E_coul = 198.69310158561453
Extra cycle  E= -507.972895686832  delta_E=    0  |g|= 1.46e-09  |ddm|= 6.5e-10
    CPU time for scf_cycle      1.67 sec, wall time      0.16 sec
exp = [2.62508703e-01 1.17616814e+05 6.76194203e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347575e+03 1.83758102e+04 1.44974911e+03
 3.74025277e+02 1.13256095e+02 3.77585549e+01 8.10566466e+00
 3.27281095e+00 8.60386094e+00 4.92564311e-01]
grad_E = [-1.95799563e-03  4.16910920e-09  1.42877204e-03  1.86017440e-11
  1.12343023e-10  6.48658660e-10  2.54368321e-09  1.05671967e-08
  5.68619939e-08  3.57550038e-06  1.22114064e-07  5.83620037e-06
 -1.67124707e-05  1.03412848e-04 -5.80536187e-04 -9.79289109e-04
  3.88799049e-05  5.05557740e-05 -1.36884876e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:05 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.262193430637       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.675184005547       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209714        1
[INPUT] 0    0    [1    /1   ]  36754.7200454        1
[INPUT] 0    0    [1    /1   ]  7303.47573783        1
[INPUT] 0    0    [1    /1   ]  18375.8102104        1
[INPUT] 0    0    [1    /1   ]  1449.74908881        1
[INPUT] 0    0    [1    /1   ]  374.025336188        1
[INPUT] 0    0    [1    /1   ]  113.255716349        1
[INPUT] 0    0    [1    /1   ]  37.7606029221        1
[INPUT] 0    0    [1    /1   ]  8.11008344891        1
[INPUT] 0    0    [1    /1   ]  3.26894547646        1
[INPUT] 1    0    [1    /1   ]  8.60384338601        1
[INPUT] 1    0    [1    /1   ]  0.492610775015       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2621934306370067, 1.0]], [0, [117616.81424213763, 1.0]], [0, [0.6751840055468521, 1.0]], [0, [1176168.142618889, 1.0]], [0, [588084.069992573, 1.0]], [0, [294042.03113193385, 1.0]], [0, [147020.99214798285, 1.0]], [0, [73510.42097139657, 1.0]], [0, [36754.720045360205, 1.0]], [0, [7303.475737827253, 1.0]], [0, [18375.8102104433, 1.0]], [0, [1449.7490888144648, 1.0]], [0, [374.0253361878882, 1.0]], [0, [113.25571634856593, 1.0]], [0, [37.760602922104965, 1.0]], [0, [8.110083448908911, 1.0]], [0, [3.268945476463572, 1.0]], [1, [8.603843386010793, 1.0]], [1, [0.49261077501463585, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26219343]
bas 1, expnt(s) = [117616.81424214]
bas 2, expnt(s) = [0.67518401]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999257]
bas 5, expnt(s) = [294042.03113193]
bas 6, expnt(s) = [147020.99214798]
bas 7, expnt(s) = [73510.4209714]
bas 8, expnt(s) = [36754.72004536]
bas 9, expnt(s) = [7303.47573783]
bas 10, expnt(s) = [18375.81021044]
bas 11, expnt(s) = [1449.74908881]
bas 12, expnt(s) = [374.02533619]
bas 13, expnt(s) = [113.25571635]
bas 14, expnt(s) = [37.76060292]
bas 15, expnt(s) = [8.11008345]
bas 16, expnt(s) = [3.26894548]
bas 17, expnt(s) = [8.60384339]
bas 18, expnt(s) = [0.49261078]
CPU time:        77.85
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.62193431e-01 9.25723692e-01 1.17616814e+05 1.60460109e+04
 6.75184006e-01 1.88183540e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347574e+03 1.99600772e+03
 1.83758102e+04 3.98749266e+03 1.44974909e+03 5.93587378e+02
 3.74025336e+02 2.14877425e+02 1.13255716e+02 8.77122240e+01
 3.77606029e+01 3.84852413e+01 8.11008345e+00 1.21418263e+01
 3.26894548e+00 6.14215514e+00 8.60384339e+00 4.29882745e+01
 4.92610775e-01 1.20396615e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335791578960457
cond(S) = 907733.5228111276
E1 = -689.5642393424621  E_coul = 184.96224968619583
init E= -504.601989656266
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672411903100477  LUMO = 0.768467723286027
  mo_energy =
[-1.21704290e+02 -1.33852161e+01 -7.62420357e+00 -7.62420357e+00
 -7.62420357e+00 -1.65751894e+00 -6.72411903e-01 -6.72411903e-01
 -6.72411903e-01  7.68467723e-01  1.20112310e+01  1.11052970e+02
  6.05052782e+02  2.74447844e+03  1.22235540e+04  4.08450333e+04
  1.04888666e+05  2.30072105e+05  4.55887041e+05  8.44839299e+05
  1.52801656e+06  2.85028395e+06  5.80817123e+06]
E1 = -707.7251010373484  E_coul = 199.76992946716095
cycle= 1 E= -507.955171570187  delta_E= -3.35  |g|= 0.449  |ddm|= 0.505
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625784
diis-c [-0.39160513  1.        ]
  HOMO = -0.217951826770306  LUMO = 1.17373801637523
  mo_energy =
[-1.20194951e+02 -1.23038882e+01 -6.59485006e+00 -6.59485006e+00
 -6.59485006e+00 -1.16323808e+00 -2.17951827e-01 -2.17951827e-01
 -2.17951827e-01  1.17373802e+00  1.29425485e+01  1.12451928e+02
  6.06548013e+02  2.74591255e+03  1.22248789e+04  4.08462918e+04
  1.04889888e+05  2.30073302e+05  4.55888221e+05  8.44840466e+05
  1.52801772e+06  2.85028510e+06  5.80817236e+06]
E1 = -706.7872627413501  E_coul = 198.81461460948026
cycle= 2 E= -507.97264813187  delta_E= -0.0175  |g|= 0.0345  |ddm|= 0.442
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0259477
diis-c [-6.70728855e-04  2.54994666e-03  9.97450053e-01]
  HOMO = -0.239698686896619  LUMO = 1.16718951534485
  mo_energy =
[-1.20307435e+02 -1.23699823e+01 -6.66805311e+00 -6.66805311e+00
 -6.66805311e+00 -1.17723332e+00 -2.39698687e-01 -2.39698687e-01
 -2.39698687e-01  1.16718952e+00  1.28923604e+01  1.12358130e+02
  6.06431568e+02  2.74578015e+03  1.22247364e+04  4.08461456e+04
  1.04889740e+05  2.30073154e+05  4.55888072e+05  8.44840317e+05
  1.52801757e+06  2.85028495e+06  5.80817221e+06]
E1 = -706.682915474079  E_coul = 198.71001961187497
cycle= 3 E= -507.972895862204  delta_E= -0.000248  |g|= 0.00434  |ddm|= 0.0595
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00294467
diis-c [-1.56599166e-06 -1.71233440e-04 -1.14667303e-01  1.11483854e+00]
  HOMO = -0.242826781879171  LUMO = 1.16601951207753
  mo_energy =
[-1.20319522e+02 -1.23786602e+01 -6.67724697e+00 -6.67724697e+00
 -6.67724697e+00 -1.17912628e+00 -2.42826782e-01 -2.42826782e-01
 -2.42826782e-01  1.16601951e+00  1.28854704e+01  1.12347379e+02
  6.06419307e+02  2.74576700e+03  1.22247228e+04  4.08461318e+04
  1.04889726e+05  2.30073140e+05  4.55888058e+05  8.44840303e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6680372403553  E_coul = 198.69513685710967
cycle= 4 E= -507.972900383246  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00911
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108334
diis-c [-6.61722190e-11 -5.51639881e-06  7.31949171e-03 -9.06501136e-02
  1.08333614e+00]
  HOMO = -0.242930403788901  LUMO = 1.16597442779331
  mo_energy =
[-1.20319758e+02 -1.23789110e+01 -6.67749145e+00 -6.67749145e+00
 -6.67749145e+00 -1.17918714e+00 -2.42930404e-01 -2.42930404e-01
 -2.42930404e-01  1.16597443e+00  1.28852591e+01  1.12347139e+02
  6.06419072e+02  2.74576677e+03  1.22247226e+04  4.08461315e+04
  1.04889726e+05  2.30073139e+05  4.55888058e+05  8.44840302e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6675512803344  E_coul = 198.69465089172687
cycle= 5 E= -507.972900388608  delta_E= -5.36e-09  |g|= 2.62e-07  |ddm|= 0.00033
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.63556e-07
diis-c [-6.72669449e-15  1.68090354e-07 -8.17898121e-05  8.96603242e-04
 -1.03465672e-02  1.00953159e+00]
  HOMO = -0.24293051828951  LUMO = 1.16597454749932
  mo_energy =
[-1.20319759e+02 -1.23789114e+01 -6.67749192e+00 -6.67749192e+00
 -6.67749192e+00 -1.17918734e+00 -2.42930518e-01 -2.42930518e-01
 -2.42930518e-01  1.16597455e+00  1.28852588e+01  1.12347138e+02
  6.06419071e+02  2.74576677e+03  1.22247225e+04  4.08461315e+04
  1.04889726e+05  2.30073139e+05  4.55888058e+05  8.44840302e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6675505551534  E_coul = 198.69465016654573
cycle= 6 E= -507.972900388608  delta_E= -1.71e-13  |g|= 8.25e-09  |ddm|= 3.73e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6675505551534  E_coul = 198.69465016654573
  HOMO = -0.242930513998855  LUMO = 1.16597454905532
  mo_energy =
[-1.20319759e+02 -1.23789114e+01 -6.67749191e+00 -6.67749191e+00
 -6.67749191e+00 -1.17918734e+00 -2.42930514e-01 -2.42930514e-01
 -2.42930514e-01  1.16597455e+00  1.28852588e+01  1.12347138e+02
  6.06419071e+02  2.74576677e+03  1.22247225e+04  4.08461315e+04
  1.04889726e+05  2.30073139e+05  4.55888058e+05  8.44840302e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6675505778646  E_coul = 198.69465018925706
Extra cycle  E= -507.972900388608  delta_E= 1.14e-13  |g|= 1.95e-09  |ddm|= 1.48e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
exp = [2.62193431e-01 1.17616814e+05 6.75184006e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347574e+03 1.83758102e+04 1.44974909e+03
 3.74025336e+02 1.13255716e+02 3.77606029e+01 8.11008345e+00
 3.26894548e+00 8.60384339e+00 4.92610775e-01]
E = -507.97290038860757
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.262193430637       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.675184005547       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209714        1
[INPUT] 0    0    [1    /1   ]  36754.7200454        1
[INPUT] 0    0    [1    /1   ]  7303.47573783        1
[INPUT] 0    0    [1    /1   ]  18375.8102104        1
[INPUT] 0    0    [1    /1   ]  1449.74908881        1
[INPUT] 0    0    [1    /1   ]  374.025336188        1
[INPUT] 0    0    [1    /1   ]  113.255716349        1
[INPUT] 0    0    [1    /1   ]  37.7606029221        1
[INPUT] 0    0    [1    /1   ]  8.11008344891        1
[INPUT] 0    0    [1    /1   ]  3.26894547646        1
[INPUT] 1    0    [1    /1   ]  8.60384338601        1
[INPUT] 1    0    [1    /1   ]  0.492610775015       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2621934306370067, 1.0]], [0, [117616.81424213763, 1.0]], [0, [0.6751840055468521, 1.0]], [0, [1176168.142618889, 1.0]], [0, [588084.069992573, 1.0]], [0, [294042.03113193385, 1.0]], [0, [147020.99214798285, 1.0]], [0, [73510.42097139657, 1.0]], [0, [36754.720045360205, 1.0]], [0, [7303.475737827253, 1.0]], [0, [18375.8102104433, 1.0]], [0, [1449.7490888144648, 1.0]], [0, [374.0253361878882, 1.0]], [0, [113.25571634856593, 1.0]], [0, [37.760602922104965, 1.0]], [0, [8.110083448908911, 1.0]], [0, [3.268945476463572, 1.0]], [1, [8.603843386010793, 1.0]], [1, [0.49261077501463585, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26219343]
bas 1, expnt(s) = [117616.81424214]
bas 2, expnt(s) = [0.67518401]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999257]
bas 5, expnt(s) = [294042.03113193]
bas 6, expnt(s) = [147020.99214798]
bas 7, expnt(s) = [73510.4209714]
bas 8, expnt(s) = [36754.72004536]
bas 9, expnt(s) = [7303.47573783]
bas 10, expnt(s) = [18375.81021044]
bas 11, expnt(s) = [1449.74908881]
bas 12, expnt(s) = [374.02533619]
bas 13, expnt(s) = [113.25571635]
bas 14, expnt(s) = [37.76060292]
bas 15, expnt(s) = [8.11008345]
bas 16, expnt(s) = [3.26894548]
bas 17, expnt(s) = [8.60384339]
bas 18, expnt(s) = [0.49261078]
CPU time:        78.37
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.62193431e-01 9.25723692e-01 1.17616814e+05 1.60460109e+04
 6.75184006e-01 1.88183540e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347574e+03 1.99600772e+03
 1.83758102e+04 3.98749266e+03 1.44974909e+03 5.93587378e+02
 3.74025336e+02 2.14877425e+02 1.13255716e+02 8.77122240e+01
 3.77606029e+01 3.84852413e+01 8.11008345e+00 1.21418263e+01
 3.26894548e+00 6.14215514e+00 8.60384339e+00 4.29882745e+01
 4.92610775e-01 1.20396615e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335791578960457
cond(S) = 907733.5228111276
E1 = -689.5642393424621  E_coul = 184.96224968619583
init E= -504.601989656266
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672411903100477  LUMO = 0.768467723286027
  mo_energy =
[-1.21704290e+02 -1.33852161e+01 -7.62420357e+00 -7.62420357e+00
 -7.62420357e+00 -1.65751894e+00 -6.72411903e-01 -6.72411903e-01
 -6.72411903e-01  7.68467723e-01  1.20112310e+01  1.11052970e+02
  6.05052782e+02  2.74447844e+03  1.22235540e+04  4.08450333e+04
  1.04888666e+05  2.30072105e+05  4.55887041e+05  8.44839299e+05
  1.52801656e+06  2.85028395e+06  5.80817123e+06]
E1 = -707.7251010373484  E_coul = 199.76992946716095
cycle= 1 E= -507.955171570187  delta_E= -3.35  |g|= 0.449  |ddm|= 0.505
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625784
diis-c [-0.39160513  1.        ]
  HOMO = -0.217951826770306  LUMO = 1.17373801637523
  mo_energy =
[-1.20194951e+02 -1.23038882e+01 -6.59485006e+00 -6.59485006e+00
 -6.59485006e+00 -1.16323808e+00 -2.17951827e-01 -2.17951827e-01
 -2.17951827e-01  1.17373802e+00  1.29425485e+01  1.12451928e+02
  6.06548013e+02  2.74591255e+03  1.22248789e+04  4.08462918e+04
  1.04889888e+05  2.30073302e+05  4.55888221e+05  8.44840466e+05
  1.52801772e+06  2.85028510e+06  5.80817236e+06]
E1 = -706.7872627413501  E_coul = 198.81461460948026
cycle= 2 E= -507.97264813187  delta_E= -0.0175  |g|= 0.0345  |ddm|= 0.442
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0259477
diis-c [-6.70728855e-04  2.54994666e-03  9.97450053e-01]
  HOMO = -0.239698686896619  LUMO = 1.16718951534485
  mo_energy =
[-1.20307435e+02 -1.23699823e+01 -6.66805311e+00 -6.66805311e+00
 -6.66805311e+00 -1.17723332e+00 -2.39698687e-01 -2.39698687e-01
 -2.39698687e-01  1.16718952e+00  1.28923604e+01  1.12358130e+02
  6.06431568e+02  2.74578015e+03  1.22247364e+04  4.08461456e+04
  1.04889740e+05  2.30073154e+05  4.55888072e+05  8.44840317e+05
  1.52801757e+06  2.85028495e+06  5.80817221e+06]
E1 = -706.682915474079  E_coul = 198.71001961187497
cycle= 3 E= -507.972895862204  delta_E= -0.000248  |g|= 0.00434  |ddm|= 0.0595
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00294467
diis-c [-1.56599166e-06 -1.71233440e-04 -1.14667303e-01  1.11483854e+00]
  HOMO = -0.242826781879171  LUMO = 1.16601951207753
  mo_energy =
[-1.20319522e+02 -1.23786602e+01 -6.67724697e+00 -6.67724697e+00
 -6.67724697e+00 -1.17912628e+00 -2.42826782e-01 -2.42826782e-01
 -2.42826782e-01  1.16601951e+00  1.28854704e+01  1.12347379e+02
  6.06419307e+02  2.74576700e+03  1.22247228e+04  4.08461318e+04
  1.04889726e+05  2.30073140e+05  4.55888058e+05  8.44840303e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6680372403553  E_coul = 198.69513685710967
cycle= 4 E= -507.972900383246  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00911
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108334
diis-c [-6.61722190e-11 -5.51639881e-06  7.31949171e-03 -9.06501136e-02
  1.08333614e+00]
  HOMO = -0.242930403788901  LUMO = 1.16597442779331
  mo_energy =
[-1.20319758e+02 -1.23789110e+01 -6.67749145e+00 -6.67749145e+00
 -6.67749145e+00 -1.17918714e+00 -2.42930404e-01 -2.42930404e-01
 -2.42930404e-01  1.16597443e+00  1.28852591e+01  1.12347139e+02
  6.06419072e+02  2.74576677e+03  1.22247226e+04  4.08461315e+04
  1.04889726e+05  2.30073139e+05  4.55888058e+05  8.44840302e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6675512803344  E_coul = 198.69465089172687
cycle= 5 E= -507.972900388608  delta_E= -5.36e-09  |g|= 2.62e-07  |ddm|= 0.00033
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.63556e-07
diis-c [-6.72669449e-15  1.68090354e-07 -8.17898121e-05  8.96603242e-04
 -1.03465672e-02  1.00953159e+00]
  HOMO = -0.24293051828951  LUMO = 1.16597454749932
  mo_energy =
[-1.20319759e+02 -1.23789114e+01 -6.67749192e+00 -6.67749192e+00
 -6.67749192e+00 -1.17918734e+00 -2.42930518e-01 -2.42930518e-01
 -2.42930518e-01  1.16597455e+00  1.28852588e+01  1.12347138e+02
  6.06419071e+02  2.74576677e+03  1.22247225e+04  4.08461315e+04
  1.04889726e+05  2.30073139e+05  4.55888058e+05  8.44840302e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6675505551534  E_coul = 198.69465016654573
cycle= 6 E= -507.972900388608  delta_E= -1.71e-13  |g|= 8.25e-09  |ddm|= 3.73e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6675505551534  E_coul = 198.69465016654573
  HOMO = -0.242930513998855  LUMO = 1.16597454905532
  mo_energy =
[-1.20319759e+02 -1.23789114e+01 -6.67749191e+00 -6.67749191e+00
 -6.67749191e+00 -1.17918734e+00 -2.42930514e-01 -2.42930514e-01
 -2.42930514e-01  1.16597455e+00  1.28852588e+01  1.12347138e+02
  6.06419071e+02  2.74576677e+03  1.22247225e+04  4.08461315e+04
  1.04889726e+05  2.30073139e+05  4.55888058e+05  8.44840302e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6675505778646  E_coul = 198.69465018925706
Extra cycle  E= -507.972900388608  delta_E= 1.14e-13  |g|= 1.95e-09  |ddm|= 1.48e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907733.5228111276
E1 = -706.6675505778646  E_coul = 198.69465018925706
init E= -507.972900388608
    CPU time for initialize scf      1.44 sec, wall time      0.09 sec
  HOMO = -0.242930513374874  LUMO = 1.16597455005159
  mo_energy =
[-1.20319759e+02 -1.23789114e+01 -6.67749191e+00 -6.67749191e+00
 -6.67749191e+00 -1.17918734e+00 -2.42930513e-01 -2.42930513e-01
 -2.42930513e-01  1.16597455e+00  1.28852588e+01  1.12347138e+02
  6.06419071e+02  2.74576677e+03  1.22247225e+04  4.08461315e+04
  1.04889726e+05  2.30073139e+05  4.55888058e+05  8.44840302e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6675505797756  E_coul = 198.69465019116814
cycle= 1 E= -507.972900388607  delta_E= 1.14e-13  |g|= 1.72e-09  |ddm|= 1.24e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6675505797756  E_coul = 198.69465019116814
  HOMO = -0.2429305133214  LUMO = 1.16597454907401
  mo_energy =
[-1.20319759e+02 -1.23789114e+01 -6.67749191e+00 -6.67749191e+00
 -6.67749191e+00 -1.17918734e+00 -2.42930513e-01 -2.42930513e-01
 -2.42930513e-01  1.16597455e+00  1.28852588e+01  1.12347138e+02
  6.06419071e+02  2.74576677e+03  1.22247225e+04  4.08461315e+04
  1.04889726e+05  2.30073139e+05  4.55888058e+05  8.44840302e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6675505785138  E_coul = 198.69465018990599
Extra cycle  E= -507.972900388608  delta_E= -3.41e-13  |g|= 1.71e-09  |ddm|= 8.83e-10
    CPU time for scf_cycle      1.61 sec, wall time      0.16 sec
exp = [2.62193431e-01 1.17616814e+05 6.75184006e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347574e+03 1.83758102e+04 1.44974909e+03
 3.74025336e+02 1.13255716e+02 3.77606029e+01 8.11008345e+00
 3.26894548e+00 8.60384339e+00 4.92610775e-01]
grad_E = [-1.32122603e-03  4.17046513e-09  1.25573457e-03  1.86179950e-11
  1.12386890e-10  6.48869013e-10  2.54452068e-09  1.05707235e-08
  5.68794817e-08  3.57677725e-06  1.22166186e-07  5.75942978e-06
 -1.55327826e-05  9.32438697e-05 -5.40695698e-04 -7.49186472e-04
 -6.45900055e-04 -1.85064464e-05  1.99131462e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:09 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.261424582337       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.671955569355       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209714        1
[INPUT] 0    0    [1    /1   ]  36754.7200452        1
[INPUT] 0    0    [1    /1   ]  7303.47572707        1
[INPUT] 0    0    [1    /1   ]  18375.8102101        1
[INPUT] 0    0    [1    /1   ]  1449.74907113        1
[INPUT] 0    0    [1    /1   ]  374.025388594        1
[INPUT] 0    0    [1    /1   ]  113.255380807        1
[INPUT] 0    0    [1    /1   ]  37.7624904145        1
[INPUT] 0    0    [1    /1   ]  8.1137670329         1
[INPUT] 0    0    [1    /1   ]  3.26641846053        1
[INPUT] 1    0    [1    /1   ]  8.60384948744        1
[INPUT] 1    0    [1    /1   ]  0.492658347705       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2614245823369051, 1.0]], [0, [117616.81424212508, 1.0]], [0, [0.6719555693545095, 1.0]], [0, [1176168.142618889, 1.0]], [0, [588084.0699925727, 1.0]], [0, [294042.0311319319, 1.0]], [0, [147020.9921479752, 1.0]], [0, [73510.42097136477, 1.0]], [0, [36754.72004518908, 1.0]], [0, [7303.475727067274, 1.0]], [0, [18375.810210075822, 1.0]], [0, [1449.7490711269713, 1.0]], [0, [374.025388593841, 1.0]], [0, [113.25538080653165, 1.0]], [0, [37.762490414514765, 1.0]], [0, [8.113767032901801, 1.0]], [0, [3.2664184605288193, 1.0]], [1, [8.603849487439955, 1.0]], [1, [0.4926583477047588, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26142458]
bas 1, expnt(s) = [117616.81424213]
bas 2, expnt(s) = [0.67195557]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999257]
bas 5, expnt(s) = [294042.03113193]
bas 6, expnt(s) = [147020.99214798]
bas 7, expnt(s) = [73510.42097136]
bas 8, expnt(s) = [36754.72004519]
bas 9, expnt(s) = [7303.47572707]
bas 10, expnt(s) = [18375.81021008]
bas 11, expnt(s) = [1449.74907113]
bas 12, expnt(s) = [374.02538859]
bas 13, expnt(s) = [113.25538081]
bas 14, expnt(s) = [37.76249041]
bas 15, expnt(s) = [8.11376703]
bas 16, expnt(s) = [3.26641846]
bas 17, expnt(s) = [8.60384949]
bas 18, expnt(s) = [0.49265835]
CPU time:        83.14
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61424582e-01 9.23687021e-01 1.17616814e+05 1.60460109e+04
 6.71955569e-01 1.87508277e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347573e+03 1.99600772e+03
 1.83758102e+04 3.98749266e+03 1.44974907e+03 5.93587373e+02
 3.74025389e+02 2.14877447e+02 1.13255381e+02 8.77120291e+01
 3.77624904e+01 3.84866841e+01 8.11376703e+00 1.21459622e+01
 3.26641846e+00 6.13859371e+00 8.60384949e+00 4.29883126e+01
 4.92658348e-01 1.20411149e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33573769268945
cond(S) = 907733.3983144822
E1 = -689.5657265185376  E_coul = 184.96353888060955
init E= -504.602187637928
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.672365720977988  LUMO = 0.76235421585747
  mo_energy =
[-1.21704152e+02 -1.33851097e+01 -7.62413218e+00 -7.62413218e+00
 -7.62413218e+00 -1.65747798e+00 -6.72365721e-01 -6.72365721e-01
 -6.72365721e-01  7.62354216e-01  1.19893303e+01  1.11043489e+02
  6.05050325e+02  2.74447733e+03  1.22235532e+04  4.08450326e+04
  1.04888665e+05  2.30072104e+05  4.55887040e+05  8.44839298e+05
  1.52801656e+06  2.85028395e+06  5.80817123e+06]
E1 = -707.7265360896996  E_coul = 199.77134809166844
cycle= 1 E= -507.955187998031  delta_E= -3.35  |g|= 0.449  |ddm|= 0.506
    CPU time for cycle= 1      0.18 sec, wall time      0.01 sec
diis-norm(errvec)=0.625798
diis-c [-0.39162309  1.        ]
  HOMO = -0.217840204663073  LUMO = 1.1666082740045
  mo_energy =
[-1.20194859e+02 -1.23037942e+01 -6.59481291e+00 -6.59481291e+00
 -6.59481291e+00 -1.16316219e+00 -2.17840205e-01 -2.17840205e-01
 -2.17840205e-01  1.16660827e+00  1.29206431e+01  1.12442424e+02
  6.06545523e+02  2.74591140e+03  1.22248781e+04  4.08462910e+04
  1.04889887e+05  2.30073302e+05  4.55888221e+05  8.44840465e+05
  1.52801772e+06  2.85028510e+06  5.80817236e+06]
E1 = -706.7892124756941  E_coul = 198.8165612441336
cycle= 2 E= -507.97265123156  delta_E= -0.0175  |g|= 0.0345  |ddm|= 0.442
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0259559
diis-c [-6.71171823e-04  2.53999664e-03  9.97460003e-01]
  HOMO = -0.239583194487759  LUMO = 1.1601084662559
  mo_energy =
[-1.20307287e+02 -1.23698431e+01 -6.66796831e+00 -6.66796831e+00
 -6.66796831e+00 -1.17715525e+00 -2.39583194e-01 -2.39583194e-01
 -2.39583194e-01  1.16010847e+00  1.28705144e+01  1.12348675e+02
  6.06429134e+02  2.74577906e+03  1.22247357e+04  4.08461449e+04
  1.04889739e+05  2.30073153e+05  4.55888072e+05  8.44840316e+05
  1.52801757e+06  2.85028495e+06  5.80817221e+06]
E1 = -706.6847457957494  E_coul = 198.71184614475854
cycle= 3 E= -507.972899650991  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0596
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00294921
diis-c [-1.57126695e-06 -1.73010446e-04 -1.14818773e-01  1.11499178e+00]
  HOMO = -0.242717733771041  LUMO = 1.15894295265964
  mo_energy =
[-1.20319384e+02 -1.23785305e+01 -6.67717145e+00 -6.67717145e+00
 -6.67717145e+00 -1.17905237e+00 -2.42717734e-01 -2.42717734e-01
 -2.42717734e-01  1.15894295e+00  1.28636179e+01  1.12337914e+02
  6.06416864e+02  2.74576591e+03  1.22247220e+04  4.08461310e+04
  1.04889725e+05  2.30073139e+05  4.55888058e+05  8.44840302e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.669817841135  E_coul = 198.6969136366597
cycle= 4 E= -507.972904204475  delta_E= -4.55e-06  |g|= 0.000158  |ddm|= 0.00915
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108816
diis-c [-6.65247720e-11 -5.53082720e-06  7.33542024e-03 -9.08410082e-02
  1.08351112e+00]
  HOMO = -0.242822152005532  LUMO = 1.15889775905361
  mo_energy =
[-1.20319622e+02 -1.23787830e+01 -6.67741760e+00 -6.67741760e+00
 -6.67741760e+00 -1.17911371e+00 -2.42822152e-01 -2.42822152e-01
 -2.42822152e-01  1.15889776e+00  1.28634051e+01  1.12337673e+02
  6.06416627e+02  2.74576567e+03  1.22247218e+04  4.08461308e+04
  1.04889725e+05  2.30073139e+05  4.55888058e+05  8.44840302e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6693274509541  E_coul = 198.69642324102006
cycle= 5 E= -507.972904209934  delta_E= -5.46e-09  |g|= 2.67e-07  |ddm|= 0.000334
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.65889e-07
diis-c [-6.45993890e-15  1.66231221e-07 -8.18840263e-05  8.96144693e-04
 -1.03347859e-02  1.00952036e+00]
  HOMO = -0.242822272974349  LUMO = 1.15889787712554
  mo_energy =
[-1.20319623e+02 -1.23787834e+01 -6.67741809e+00 -6.67741809e+00
 -6.67741809e+00 -1.17911392e+00 -2.42822273e-01 -2.42822273e-01
 -2.42822273e-01  1.15889788e+00  1.28634048e+01  1.12337672e+02
  6.06416626e+02  2.74576567e+03  1.22247218e+04  4.08461308e+04
  1.04889725e+05  2.30073139e+05  4.55888058e+05  8.44840302e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6693266872538  E_coul = 198.69642247731957
cycle= 6 E= -507.972904209934  delta_E= -1.71e-13  |g|= 7.96e-09  |ddm|= 3.99e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6693266872538  E_coul = 198.69642247731957
  HOMO = -0.242822269035455  LUMO = 1.15889787705915
  mo_energy =
[-1.20319623e+02 -1.23787834e+01 -6.67741808e+00 -6.67741808e+00
 -6.67741808e+00 -1.17911391e+00 -2.42822269e-01 -2.42822269e-01
 -2.42822269e-01  1.15889788e+00  1.28634048e+01  1.12337672e+02
  6.06416626e+02  2.74576567e+03  1.22247218e+04  4.08461308e+04
  1.04889725e+05  2.30073139e+05  4.55888058e+05  8.44840302e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6693267084851  E_coul = 198.69642249855107
Extra cycle  E= -507.972904209934  delta_E= 2.84e-13  |g|= 1.66e-09  |ddm|= 1.39e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.12 sec
exp = [2.61424582e-01 1.17616814e+05 6.71955569e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347573e+03 1.83758102e+04 1.44974907e+03
 3.74025389e+02 1.13255381e+02 3.77624904e+01 8.11376703e+00
 3.26641846e+00 8.60384949e+00 4.92658348e-01]
E = -507.972904209934
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:09 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.261424582337       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.671955569355       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209714        1
[INPUT] 0    0    [1    /1   ]  36754.7200452        1
[INPUT] 0    0    [1    /1   ]  7303.47572707        1
[INPUT] 0    0    [1    /1   ]  18375.8102101        1
[INPUT] 0    0    [1    /1   ]  1449.74907113        1
[INPUT] 0    0    [1    /1   ]  374.025388594        1
[INPUT] 0    0    [1    /1   ]  113.255380807        1
[INPUT] 0    0    [1    /1   ]  37.7624904145        1
[INPUT] 0    0    [1    /1   ]  8.1137670329         1
[INPUT] 0    0    [1    /1   ]  3.26641846053        1
[INPUT] 1    0    [1    /1   ]  8.60384948744        1
[INPUT] 1    0    [1    /1   ]  0.492658347705       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2614245823369051, 1.0]], [0, [117616.81424212508, 1.0]], [0, [0.6719555693545095, 1.0]], [0, [1176168.142618889, 1.0]], [0, [588084.0699925727, 1.0]], [0, [294042.0311319319, 1.0]], [0, [147020.9921479752, 1.0]], [0, [73510.42097136477, 1.0]], [0, [36754.72004518908, 1.0]], [0, [7303.475727067274, 1.0]], [0, [18375.810210075822, 1.0]], [0, [1449.7490711269713, 1.0]], [0, [374.025388593841, 1.0]], [0, [113.25538080653165, 1.0]], [0, [37.762490414514765, 1.0]], [0, [8.113767032901801, 1.0]], [0, [3.2664184605288193, 1.0]], [1, [8.603849487439955, 1.0]], [1, [0.4926583477047588, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26142458]
bas 1, expnt(s) = [117616.81424213]
bas 2, expnt(s) = [0.67195557]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999257]
bas 5, expnt(s) = [294042.03113193]
bas 6, expnt(s) = [147020.99214798]
bas 7, expnt(s) = [73510.42097136]
bas 8, expnt(s) = [36754.72004519]
bas 9, expnt(s) = [7303.47572707]
bas 10, expnt(s) = [18375.81021008]
bas 11, expnt(s) = [1449.74907113]
bas 12, expnt(s) = [374.02538859]
bas 13, expnt(s) = [113.25538081]
bas 14, expnt(s) = [37.76249041]
bas 15, expnt(s) = [8.11376703]
bas 16, expnt(s) = [3.26641846]
bas 17, expnt(s) = [8.60384949]
bas 18, expnt(s) = [0.49265835]
CPU time:        83.67
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61424582e-01 9.23687021e-01 1.17616814e+05 1.60460109e+04
 6.71955569e-01 1.87508277e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347573e+03 1.99600772e+03
 1.83758102e+04 3.98749266e+03 1.44974907e+03 5.93587373e+02
 3.74025389e+02 2.14877447e+02 1.13255381e+02 8.77120291e+01
 3.77624904e+01 3.84866841e+01 8.11376703e+00 1.21459622e+01
 3.26641846e+00 6.13859371e+00 8.60384949e+00 4.29883126e+01
 4.92658348e-01 1.20411149e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33573769268945
cond(S) = 907733.3983144822
E1 = -689.5657265185376  E_coul = 184.96353888060955
init E= -504.602187637928
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672365720977988  LUMO = 0.76235421585747
  mo_energy =
[-1.21704152e+02 -1.33851097e+01 -7.62413218e+00 -7.62413218e+00
 -7.62413218e+00 -1.65747798e+00 -6.72365721e-01 -6.72365721e-01
 -6.72365721e-01  7.62354216e-01  1.19893303e+01  1.11043489e+02
  6.05050325e+02  2.74447733e+03  1.22235532e+04  4.08450326e+04
  1.04888665e+05  2.30072104e+05  4.55887040e+05  8.44839298e+05
  1.52801656e+06  2.85028395e+06  5.80817123e+06]
E1 = -707.7265360896996  E_coul = 199.77134809166844
cycle= 1 E= -507.955187998031  delta_E= -3.35  |g|= 0.449  |ddm|= 0.506
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625798
diis-c [-0.39162309  1.        ]
  HOMO = -0.217840204663073  LUMO = 1.1666082740045
  mo_energy =
[-1.20194859e+02 -1.23037942e+01 -6.59481291e+00 -6.59481291e+00
 -6.59481291e+00 -1.16316219e+00 -2.17840205e-01 -2.17840205e-01
 -2.17840205e-01  1.16660827e+00  1.29206431e+01  1.12442424e+02
  6.06545523e+02  2.74591140e+03  1.22248781e+04  4.08462910e+04
  1.04889887e+05  2.30073302e+05  4.55888221e+05  8.44840465e+05
  1.52801772e+06  2.85028510e+06  5.80817236e+06]
E1 = -706.7892124756941  E_coul = 198.8165612441336
cycle= 2 E= -507.97265123156  delta_E= -0.0175  |g|= 0.0345  |ddm|= 0.442
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0259559
diis-c [-6.71171823e-04  2.53999664e-03  9.97460003e-01]
  HOMO = -0.239583194487759  LUMO = 1.1601084662559
  mo_energy =
[-1.20307287e+02 -1.23698431e+01 -6.66796831e+00 -6.66796831e+00
 -6.66796831e+00 -1.17715525e+00 -2.39583194e-01 -2.39583194e-01
 -2.39583194e-01  1.16010847e+00  1.28705144e+01  1.12348675e+02
  6.06429134e+02  2.74577906e+03  1.22247357e+04  4.08461449e+04
  1.04889739e+05  2.30073153e+05  4.55888072e+05  8.44840316e+05
  1.52801757e+06  2.85028495e+06  5.80817221e+06]
E1 = -706.6847457957494  E_coul = 198.71184614475854
cycle= 3 E= -507.972899650991  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0596
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00294921
diis-c [-1.57126695e-06 -1.73010446e-04 -1.14818773e-01  1.11499178e+00]
  HOMO = -0.242717733771041  LUMO = 1.15894295265964
  mo_energy =
[-1.20319384e+02 -1.23785305e+01 -6.67717145e+00 -6.67717145e+00
 -6.67717145e+00 -1.17905237e+00 -2.42717734e-01 -2.42717734e-01
 -2.42717734e-01  1.15894295e+00  1.28636179e+01  1.12337914e+02
  6.06416864e+02  2.74576591e+03  1.22247220e+04  4.08461310e+04
  1.04889725e+05  2.30073139e+05  4.55888058e+05  8.44840302e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.669817841135  E_coul = 198.6969136366597
cycle= 4 E= -507.972904204475  delta_E= -4.55e-06  |g|= 0.000158  |ddm|= 0.00915
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108816
diis-c [-6.65247720e-11 -5.53082720e-06  7.33542024e-03 -9.08410082e-02
  1.08351112e+00]
  HOMO = -0.242822152005532  LUMO = 1.15889775905361
  mo_energy =
[-1.20319622e+02 -1.23787830e+01 -6.67741760e+00 -6.67741760e+00
 -6.67741760e+00 -1.17911371e+00 -2.42822152e-01 -2.42822152e-01
 -2.42822152e-01  1.15889776e+00  1.28634051e+01  1.12337673e+02
  6.06416627e+02  2.74576567e+03  1.22247218e+04  4.08461308e+04
  1.04889725e+05  2.30073139e+05  4.55888058e+05  8.44840302e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6693274509541  E_coul = 198.69642324102006
cycle= 5 E= -507.972904209934  delta_E= -5.46e-09  |g|= 2.67e-07  |ddm|= 0.000334
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.65889e-07
diis-c [-6.45993890e-15  1.66231221e-07 -8.18840263e-05  8.96144693e-04
 -1.03347859e-02  1.00952036e+00]
  HOMO = -0.242822272974349  LUMO = 1.15889787712554
  mo_energy =
[-1.20319623e+02 -1.23787834e+01 -6.67741809e+00 -6.67741809e+00
 -6.67741809e+00 -1.17911392e+00 -2.42822273e-01 -2.42822273e-01
 -2.42822273e-01  1.15889788e+00  1.28634048e+01  1.12337672e+02
  6.06416626e+02  2.74576567e+03  1.22247218e+04  4.08461308e+04
  1.04889725e+05  2.30073139e+05  4.55888058e+05  8.44840302e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6693266872538  E_coul = 198.69642247731957
cycle= 6 E= -507.972904209934  delta_E= -1.71e-13  |g|= 7.96e-09  |ddm|= 3.99e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6693266872538  E_coul = 198.69642247731957
  HOMO = -0.242822269035455  LUMO = 1.15889787705915
  mo_energy =
[-1.20319623e+02 -1.23787834e+01 -6.67741808e+00 -6.67741808e+00
 -6.67741808e+00 -1.17911391e+00 -2.42822269e-01 -2.42822269e-01
 -2.42822269e-01  1.15889788e+00  1.28634048e+01  1.12337672e+02
  6.06416626e+02  2.74576567e+03  1.22247218e+04  4.08461308e+04
  1.04889725e+05  2.30073139e+05  4.55888058e+05  8.44840302e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6693267084851  E_coul = 198.69642249855107
Extra cycle  E= -507.972904209934  delta_E= 2.84e-13  |g|= 1.66e-09  |ddm|= 1.39e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907733.3983144822
E1 = -706.6693267084851  E_coul = 198.69642249855107
init E= -507.972904209934
    CPU time for initialize scf      1.49 sec, wall time      0.09 sec
  HOMO = -0.242822268444089  LUMO = 1.15889787636412
  mo_energy =
[-1.20319623e+02 -1.23787834e+01 -6.67741807e+00 -6.67741807e+00
 -6.67741807e+00 -1.17911391e+00 -2.42822268e-01 -2.42822268e-01
 -2.42822268e-01  1.15889788e+00  1.28634048e+01  1.12337672e+02
  6.06416626e+02  2.74576567e+03  1.22247218e+04  4.08461308e+04
  1.04889725e+05  2.30073139e+05  4.55888058e+05  8.44840302e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.669326711502  E_coul = 198.69642250156784
cycle= 1 E= -507.972904209934  delta_E= -1.71e-13  |g|= 1.75e-09  |ddm|= 1.99e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.669326711502  E_coul = 198.69642250156784
  HOMO = -0.242822268354578  LUMO = 1.15889787640993
  mo_energy =
[-1.20319623e+02 -1.23787834e+01 -6.67741807e+00 -6.67741807e+00
 -6.67741807e+00 -1.17911391e+00 -2.42822268e-01 -2.42822268e-01
 -2.42822268e-01  1.15889788e+00  1.28634048e+01  1.12337672e+02
  6.06416626e+02  2.74576567e+03  1.22247218e+04  4.08461308e+04
  1.04889725e+05  2.30073139e+05  4.55888058e+05  8.44840302e+05
  1.52801755e+06  2.85028493e+06  5.80817220e+06]
E1 = -706.6693267133081  E_coul = 198.69642250337438
Extra cycle  E= -507.972904209934  delta_E= 3.98e-13  |g|= 1.17e-09  |ddm|= 1.16e-09
    CPU time for scf_cycle      1.66 sec, wall time      0.16 sec
exp = [2.61424582e-01 1.17616814e+05 6.71955569e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347573e+03 1.83758102e+04 1.44974907e+03
 3.74025389e+02 1.13255381e+02 3.77624904e+01 8.11376703e+00
 3.26641846e+00 8.60384949e+00 4.92658348e-01]
grad_E = [-2.06284695e-04  4.17163973e-09  7.14657785e-04  1.86320580e-11
  1.12424923e-10  6.49051156e-10  2.54524624e-09  1.05737796e-08
  5.68946186e-08  3.57787854e-06  1.22211486e-07  5.69351149e-06
 -1.45206719e-05  8.47526747e-05 -5.08688138e-04 -5.93989856e-04
 -1.11819243e-03 -6.55107416e-05  1.73647438e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.260491731946       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.667946048914       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209713        1
[INPUT] 0    0    [1    /1   ]  36754.7200449        1
[INPUT] 0    0    [1    /1   ]  7303.47571041        1
[INPUT] 0    0    [1    /1   ]  18375.8102095        1
[INPUT] 0    0    [1    /1   ]  1449.74904406        1
[INPUT] 0    0    [1    /1   ]  374.025464935        1
[INPUT] 0    0    [1    /1   ]  113.254904426        1
[INPUT] 0    0    [1    /1   ]  37.7652296009        1
[INPUT] 0    0    [1    /1   ]  8.11846511297        1
[INPUT] 0    0    [1    /1   ]  3.26557336369        1
[INPUT] 1    0    [1    /1   ]  8.60386591544        1
[INPUT] 1    0    [1    /1   ]  0.492703588527       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2604917319460716, 1.0]], [0, [117616.81424210565, 1.0]], [0, [0.6679460489135552, 1.0]], [0, [1176168.142618889, 1.0]], [0, [588084.0699925722, 1.0]], [0, [294042.03113192884, 1.0]], [0, [147020.99214796335, 1.0]], [0, [73510.42097131554, 1.0]], [0, [36754.72004492414, 1.0]], [0, [7303.47571040772, 1.0]], [0, [18375.81020950683, 1.0]], [0, [1449.7490440553804, 1.0]], [0, [374.0254649346107, 1.0]], [0, [113.25490442566266, 1.0]], [0, [37.765229600909926, 1.0]], [0, [8.118465112974723, 1.0]], [0, [3.2655733636873707, 1.0]], [1, [8.603865915442576, 1.0]], [1, [0.492703588526701, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26049173]
bas 1, expnt(s) = [117616.81424211]
bas 2, expnt(s) = [0.66794605]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999257]
bas 5, expnt(s) = [294042.03113193]
bas 6, expnt(s) = [147020.99214796]
bas 7, expnt(s) = [73510.42097132]
bas 8, expnt(s) = [36754.72004492]
bas 9, expnt(s) = [7303.47571041]
bas 10, expnt(s) = [18375.81020951]
bas 11, expnt(s) = [1449.74904406]
bas 12, expnt(s) = [374.02546493]
bas 13, expnt(s) = [113.25490443]
bas 14, expnt(s) = [37.7652296]
bas 15, expnt(s) = [8.11846511]
bas 16, expnt(s) = [3.26557336]
bas 17, expnt(s) = [8.60386592]
bas 18, expnt(s) = [0.49270359]
CPU time:        88.51
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.60491732e-01 9.21213899e-01 1.17616814e+05 1.60460109e+04
 6.67946049e-01 1.86668511e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347571e+03 1.99600772e+03
 1.83758102e+04 3.98749266e+03 1.44974904e+03 5.93587364e+02
 3.74025465e+02 2.14877480e+02 1.13254904e+02 8.77117524e+01
 3.77652296e+01 3.84887779e+01 8.11846511e+00 1.21512364e+01
 3.26557336e+00 6.13740253e+00 8.60386592e+00 4.29884152e+01
 4.92703589e-01 1.20424971e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33568683821972
cond(S) = 907733.3625665737
E1 = -689.5669096653605  E_coul = 184.96464679128175
init E= -504.602262874079
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672326594771439  LUMO = 0.754947371384491
  mo_energy =
[-1.21704032e+02 -1.33850145e+01 -7.62407396e+00 -7.62407396e+00
 -7.62407396e+00 -1.65744247e+00 -6.72326595e-01 -6.72326595e-01
 -6.72326595e-01  7.54947371e-01  1.19683053e+01  1.11042984e+02
  6.05057725e+02  2.74448504e+03  1.22235601e+04  4.08450390e+04
  1.04888671e+05  2.30072110e+05  4.55887046e+05  8.44839304e+05
  1.52801657e+06  2.85028396e+06  5.80817123e+06]
E1 = -707.7278953507841  E_coul = 199.77268659577746
cycle= 1 E= -507.955208755007  delta_E= -3.35  |g|= 0.449  |ddm|= 0.508
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625793
diis-c [-0.39161639  1.        ]
  HOMO = -0.217733027352717  LUMO = 1.15797138807782
  mo_energy =
[-1.20194775e+02 -1.23037049e+01 -6.59477920e+00 -6.59477920e+00
 -6.59477920e+00 -1.16309091e+00 -2.17733027e-01 -2.17733027e-01
 -2.17733027e-01  1.15797139e+00  1.28997396e+01  1.12441920e+02
  6.06552897e+02  2.74591908e+03  1.22248850e+04  4.08462974e+04
  1.04889893e+05  2.30073307e+05  4.55888226e+05  8.44840471e+05
  1.52801772e+06  2.85028510e+06  5.80817237e+06]
E1 = -706.7912214170134  E_coul = 198.81856641577264
cycle= 2 E= -507.972655001241  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.443
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0259615
diis-c [-6.71482471e-04  2.52990627e-03  9.97470094e-01]
  HOMO = -0.239471285741906  LUMO = 1.15152947509564
  mo_energy =
[-1.20307127e+02 -1.23696980e+01 -6.66787463e+00 -6.66787463e+00
 -6.66787463e+00 -1.17708177e+00 -2.39471286e-01 -2.39471286e-01
 -2.39471286e-01  1.15152948e+00  1.28496734e+01  1.12348236e+02
  6.06436584e+02  2.74578682e+03  1.22247426e+04  4.08461513e+04
  1.04889745e+05  2.30073159e+05  4.55888078e+05  8.44840322e+05
  1.52801757e+06  2.85028495e+06  5.80817222e+06]
E1 = -706.6866092722069  E_coul = 198.71370501541864
cycle= 3 E= -507.972904256788  delta_E= -0.000249  |g|= 0.00436  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00295418
diis-c [-1.57700308e-06 -1.75132050e-04 -1.15002090e-01  1.11517722e+00]
  HOMO = -0.242613673076675  LUMO = 1.15036927631527
  mo_energy =
[-1.20319236e+02 -1.23783971e+01 -6.67708926e+00 -6.67708926e+00
 -6.67708926e+00 -1.17898400e+00 -2.42613673e-01 -2.42613673e-01
 -2.42613673e-01  1.15036928e+00  1.28427676e+01  1.12337463e+02
  6.06424301e+02  2.74577365e+03  1.22247289e+04  4.08461375e+04
  1.04889731e+05  2.30073145e+05  4.55888064e+05  8.44840308e+05
  1.52801756e+06  2.85028494e+06  5.80817221e+06]
E1 = -706.6716206300642  E_coul = 198.69871178031184
cycle= 4 E= -507.972908849752  delta_E= -4.59e-06  |g|= 0.000159  |ddm|= 0.00921
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000109379
diis-c [-6.69043697e-11 -5.55752532e-06  7.35463525e-03 -9.10716246e-02
  1.08372255e+00]
  HOMO = -0.24271905920078  LUMO = 1.15032394871085
  mo_energy =
[-1.20319476e+02 -1.23786516e+01 -6.67733745e+00 -6.67733745e+00
 -6.67733745e+00 -1.17904593e+00 -2.42719059e-01 -2.42719059e-01
 -2.42719059e-01  1.15032395e+00  1.28425530e+01  1.12337220e+02
  6.06424062e+02  2.74577342e+03  1.22247287e+04  4.08461372e+04
  1.04889731e+05  2.30073145e+05  4.55888063e+05  8.44840308e+05
  1.52801756e+06  2.85028494e+06  5.80817221e+06]
E1 = -706.6711248353064  E_coul = 198.69821597997753
cycle= 5 E= -507.972908855329  delta_E= -5.58e-09  |g|= 2.74e-07  |ddm|= 0.000338
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.69226e-07
diis-c [-6.36356064e-15  1.63483866e-07 -8.09583410e-05  8.82619149e-04
 -1.01725684e-02  1.00937074e+00]
  HOMO = -0.242719187474451  LUMO = 1.1503240663201
  mo_energy =
[-1.20319477e+02 -1.23786520e+01 -6.67733796e+00 -6.67733796e+00
 -6.67733796e+00 -1.17904614e+00 -2.42719187e-01 -2.42719187e-01
 -2.42719187e-01  1.15032407e+00  1.28425527e+01  1.12337219e+02
  6.06424061e+02  2.74577342e+03  1.22247287e+04  4.08461372e+04
  1.04889731e+05  2.30073145e+05  4.55888063e+05  8.44840308e+05
  1.52801756e+06  2.85028494e+06  5.80817221e+06]
E1 = -706.67112402985  E_coul = 198.69821517452078
cycle= 6 E= -507.972908855329  delta_E= -3.98e-13  |g|= 7.38e-09  |ddm|= 4.26e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.67112402985  E_coul = 198.69821517452078
  HOMO = -0.242719183751755  LUMO = 1.15032406787062
  mo_energy =
[-1.20319477e+02 -1.23786520e+01 -6.67733795e+00 -6.67733795e+00
 -6.67733795e+00 -1.17904614e+00 -2.42719184e-01 -2.42719184e-01
 -2.42719184e-01  1.15032407e+00  1.28425527e+01  1.12337219e+02
  6.06424061e+02  2.74577342e+03  1.22247287e+04  4.08461372e+04
  1.04889731e+05  2.30073145e+05  4.55888063e+05  8.44840308e+05
  1.52801756e+06  2.85028494e+06  5.80817221e+06]
E1 = -706.67112404803  E_coul = 198.69821519270096
Extra cycle  E= -507.972908855329  delta_E= 1.71e-13  |g|= 1.69e-09  |ddm|= 1.19e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.60491732e-01 1.17616814e+05 6.67946049e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347571e+03 1.83758102e+04 1.44974904e+03
 3.74025465e+02 1.13254904e+02 3.77652296e+01 8.11846511e+00
 3.26557336e+00 8.60386592e+00 4.92703589e-01]
E = -507.9729088553291
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.260491731946       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.667946048914       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209713        1
[INPUT] 0    0    [1    /1   ]  36754.7200449        1
[INPUT] 0    0    [1    /1   ]  7303.47571041        1
[INPUT] 0    0    [1    /1   ]  18375.8102095        1
[INPUT] 0    0    [1    /1   ]  1449.74904406        1
[INPUT] 0    0    [1    /1   ]  374.025464935        1
[INPUT] 0    0    [1    /1   ]  113.254904426        1
[INPUT] 0    0    [1    /1   ]  37.7652296009        1
[INPUT] 0    0    [1    /1   ]  8.11846511297        1
[INPUT] 0    0    [1    /1   ]  3.26557336369        1
[INPUT] 1    0    [1    /1   ]  8.60386591544        1
[INPUT] 1    0    [1    /1   ]  0.492703588527       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2604917319460716, 1.0]], [0, [117616.81424210565, 1.0]], [0, [0.6679460489135552, 1.0]], [0, [1176168.142618889, 1.0]], [0, [588084.0699925722, 1.0]], [0, [294042.03113192884, 1.0]], [0, [147020.99214796335, 1.0]], [0, [73510.42097131554, 1.0]], [0, [36754.72004492414, 1.0]], [0, [7303.47571040772, 1.0]], [0, [18375.81020950683, 1.0]], [0, [1449.7490440553804, 1.0]], [0, [374.0254649346107, 1.0]], [0, [113.25490442566266, 1.0]], [0, [37.765229600909926, 1.0]], [0, [8.118465112974723, 1.0]], [0, [3.2655733636873707, 1.0]], [1, [8.603865915442576, 1.0]], [1, [0.492703588526701, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26049173]
bas 1, expnt(s) = [117616.81424211]
bas 2, expnt(s) = [0.66794605]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999257]
bas 5, expnt(s) = [294042.03113193]
bas 6, expnt(s) = [147020.99214796]
bas 7, expnt(s) = [73510.42097132]
bas 8, expnt(s) = [36754.72004492]
bas 9, expnt(s) = [7303.47571041]
bas 10, expnt(s) = [18375.81020951]
bas 11, expnt(s) = [1449.74904406]
bas 12, expnt(s) = [374.02546493]
bas 13, expnt(s) = [113.25490443]
bas 14, expnt(s) = [37.7652296]
bas 15, expnt(s) = [8.11846511]
bas 16, expnt(s) = [3.26557336]
bas 17, expnt(s) = [8.60386592]
bas 18, expnt(s) = [0.49270359]
CPU time:        89.03
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.60491732e-01 9.21213899e-01 1.17616814e+05 1.60460109e+04
 6.67946049e-01 1.86668511e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347571e+03 1.99600772e+03
 1.83758102e+04 3.98749266e+03 1.44974904e+03 5.93587364e+02
 3.74025465e+02 2.14877480e+02 1.13254904e+02 8.77117524e+01
 3.77652296e+01 3.84887779e+01 8.11846511e+00 1.21512364e+01
 3.26557336e+00 6.13740253e+00 8.60386592e+00 4.29884152e+01
 4.92703589e-01 1.20424971e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33568683821972
cond(S) = 907733.3625665737
E1 = -689.5669096653605  E_coul = 184.96464679128175
init E= -504.602262874079
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672326594771439  LUMO = 0.754947371384491
  mo_energy =
[-1.21704032e+02 -1.33850145e+01 -7.62407396e+00 -7.62407396e+00
 -7.62407396e+00 -1.65744247e+00 -6.72326595e-01 -6.72326595e-01
 -6.72326595e-01  7.54947371e-01  1.19683053e+01  1.11042984e+02
  6.05057725e+02  2.74448504e+03  1.22235601e+04  4.08450390e+04
  1.04888671e+05  2.30072110e+05  4.55887046e+05  8.44839304e+05
  1.52801657e+06  2.85028396e+06  5.80817123e+06]
E1 = -707.7278953507841  E_coul = 199.77268659577746
cycle= 1 E= -507.955208755007  delta_E= -3.35  |g|= 0.449  |ddm|= 0.508
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625793
diis-c [-0.39161639  1.        ]
  HOMO = -0.217733027352717  LUMO = 1.15797138807782
  mo_energy =
[-1.20194775e+02 -1.23037049e+01 -6.59477920e+00 -6.59477920e+00
 -6.59477920e+00 -1.16309091e+00 -2.17733027e-01 -2.17733027e-01
 -2.17733027e-01  1.15797139e+00  1.28997396e+01  1.12441920e+02
  6.06552897e+02  2.74591908e+03  1.22248850e+04  4.08462974e+04
  1.04889893e+05  2.30073307e+05  4.55888226e+05  8.44840471e+05
  1.52801772e+06  2.85028510e+06  5.80817237e+06]
E1 = -706.7912214170134  E_coul = 198.81856641577264
cycle= 2 E= -507.972655001241  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.443
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0259615
diis-c [-6.71482471e-04  2.52990627e-03  9.97470094e-01]
  HOMO = -0.239471285741906  LUMO = 1.15152947509564
  mo_energy =
[-1.20307127e+02 -1.23696980e+01 -6.66787463e+00 -6.66787463e+00
 -6.66787463e+00 -1.17708177e+00 -2.39471286e-01 -2.39471286e-01
 -2.39471286e-01  1.15152948e+00  1.28496734e+01  1.12348236e+02
  6.06436584e+02  2.74578682e+03  1.22247426e+04  4.08461513e+04
  1.04889745e+05  2.30073159e+05  4.55888078e+05  8.44840322e+05
  1.52801757e+06  2.85028495e+06  5.80817222e+06]
E1 = -706.6866092722069  E_coul = 198.71370501541864
cycle= 3 E= -507.972904256788  delta_E= -0.000249  |g|= 0.00436  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00295418
diis-c [-1.57700308e-06 -1.75132050e-04 -1.15002090e-01  1.11517722e+00]
  HOMO = -0.242613673076675  LUMO = 1.15036927631527
  mo_energy =
[-1.20319236e+02 -1.23783971e+01 -6.67708926e+00 -6.67708926e+00
 -6.67708926e+00 -1.17898400e+00 -2.42613673e-01 -2.42613673e-01
 -2.42613673e-01  1.15036928e+00  1.28427676e+01  1.12337463e+02
  6.06424301e+02  2.74577365e+03  1.22247289e+04  4.08461375e+04
  1.04889731e+05  2.30073145e+05  4.55888064e+05  8.44840308e+05
  1.52801756e+06  2.85028494e+06  5.80817221e+06]
E1 = -706.6716206300642  E_coul = 198.69871178031184
cycle= 4 E= -507.972908849752  delta_E= -4.59e-06  |g|= 0.000159  |ddm|= 0.00921
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000109379
diis-c [-6.69043697e-11 -5.55752532e-06  7.35463525e-03 -9.10716246e-02
  1.08372255e+00]
  HOMO = -0.24271905920078  LUMO = 1.15032394871085
  mo_energy =
[-1.20319476e+02 -1.23786516e+01 -6.67733745e+00 -6.67733745e+00
 -6.67733745e+00 -1.17904593e+00 -2.42719059e-01 -2.42719059e-01
 -2.42719059e-01  1.15032395e+00  1.28425530e+01  1.12337220e+02
  6.06424062e+02  2.74577342e+03  1.22247287e+04  4.08461372e+04
  1.04889731e+05  2.30073145e+05  4.55888063e+05  8.44840308e+05
  1.52801756e+06  2.85028494e+06  5.80817221e+06]
E1 = -706.6711248353064  E_coul = 198.69821597997753
cycle= 5 E= -507.972908855329  delta_E= -5.58e-09  |g|= 2.74e-07  |ddm|= 0.000338
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.69226e-07
diis-c [-6.36356064e-15  1.63483866e-07 -8.09583410e-05  8.82619149e-04
 -1.01725684e-02  1.00937074e+00]
  HOMO = -0.242719187474451  LUMO = 1.1503240663201
  mo_energy =
[-1.20319477e+02 -1.23786520e+01 -6.67733796e+00 -6.67733796e+00
 -6.67733796e+00 -1.17904614e+00 -2.42719187e-01 -2.42719187e-01
 -2.42719187e-01  1.15032407e+00  1.28425527e+01  1.12337219e+02
  6.06424061e+02  2.74577342e+03  1.22247287e+04  4.08461372e+04
  1.04889731e+05  2.30073145e+05  4.55888063e+05  8.44840308e+05
  1.52801756e+06  2.85028494e+06  5.80817221e+06]
E1 = -706.67112402985  E_coul = 198.69821517452078
cycle= 6 E= -507.972908855329  delta_E= -3.98e-13  |g|= 7.38e-09  |ddm|= 4.26e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.67112402985  E_coul = 198.69821517452078
  HOMO = -0.242719183751755  LUMO = 1.15032406787062
  mo_energy =
[-1.20319477e+02 -1.23786520e+01 -6.67733795e+00 -6.67733795e+00
 -6.67733795e+00 -1.17904614e+00 -2.42719184e-01 -2.42719184e-01
 -2.42719184e-01  1.15032407e+00  1.28425527e+01  1.12337219e+02
  6.06424061e+02  2.74577342e+03  1.22247287e+04  4.08461372e+04
  1.04889731e+05  2.30073145e+05  4.55888063e+05  8.44840308e+05
  1.52801756e+06  2.85028494e+06  5.80817221e+06]
E1 = -706.67112404803  E_coul = 198.69821519270096
Extra cycle  E= -507.972908855329  delta_E= 1.71e-13  |g|= 1.69e-09  |ddm|= 1.19e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907733.3625665737
E1 = -706.67112404803  E_coul = 198.69821519270096
init E= -507.972908855329
    CPU time for initialize scf      1.47 sec, wall time      0.09 sec
  HOMO = -0.242719183247557  LUMO = 1.15032406744256
  mo_energy =
[-1.20319477e+02 -1.23786520e+01 -6.67733795e+00 -6.67733795e+00
 -6.67733795e+00 -1.17904614e+00 -2.42719183e-01 -2.42719183e-01
 -2.42719183e-01  1.15032407e+00  1.28425527e+01  1.12337219e+02
  6.06424061e+02  2.74577342e+03  1.22247287e+04  4.08461372e+04
  1.04889731e+05  2.30073145e+05  4.55888063e+05  8.44840308e+05
  1.52801756e+06  2.85028494e+06  5.80817221e+06]
E1 = -706.6711240523474  E_coul = 198.69821519701867
cycle= 1 E= -507.972908855329  delta_E= 3.41e-13  |g|= 1.56e-09  |ddm|= 2.77e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6711240523474  E_coul = 198.69821519701867
  HOMO = -0.242719183131041  LUMO = 1.15032406749593
  mo_energy =
[-1.20319477e+02 -1.23786520e+01 -6.67733795e+00 -6.67733795e+00
 -6.67733795e+00 -1.17904614e+00 -2.42719183e-01 -2.42719183e-01
 -2.42719183e-01  1.15032407e+00  1.28425527e+01  1.12337219e+02
  6.06424061e+02  2.74577342e+03  1.22247287e+04  4.08461372e+04
  1.04889731e+05  2.30073145e+05  4.55888063e+05  8.44840308e+05
  1.52801756e+06  2.85028494e+06  5.80817221e+06]
E1 = -706.671124050833  E_coul = 198.69821519550385
Extra cycle  E= -507.972908855329  delta_E= -3.98e-13  |g|= 1.97e-09  |ddm|= 9.98e-10
    CPU time for scf_cycle      1.64 sec, wall time      0.16 sec
exp = [2.60491732e-01 1.17616814e+05 6.67946049e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347571e+03 1.83758102e+04 1.44974904e+03
 3.74025465e+02 1.13254904e+02 3.77652296e+01 8.11846511e+00
 3.26557336e+00 8.60386592e+00 4.92703589e-01]
grad_E = [ 9.53149816e-04  4.17297208e-09  4.44577509e-05  1.86479786e-11
  1.12468102e-10  6.49257652e-10  2.54606937e-09  1.05772474e-08
  5.69117721e-08  3.57912039e-06  1.22263064e-07  5.61988561e-06
 -1.34044110e-05  7.60005516e-05 -4.79743993e-04 -4.92116377e-04
 -1.41524601e-03 -9.80514573e-05  3.17424710e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.259255021402       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.662257691881       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209712        1
[INPUT] 0    0    [1    /1   ]  36754.7200442        1
[INPUT] 0    0    [1    /1   ]  7303.47566528        1
[INPUT] 0    0    [1    /1   ]  18375.810208         1
[INPUT] 0    0    [1    /1   ]  1449.748971          1
[INPUT] 0    0    [1    /1   ]  374.025667184        1
[INPUT] 0    0    [1    /1   ]  113.253662912        1
[INPUT] 0    0    [1    /1   ]  37.7723810023        1
[INPUT] 0    0    [1    /1   ]  8.13008926522        1
[INPUT] 0    0    [1    /1   ]  3.2671526727         1
[INPUT] 1    0    [1    /1   ]  8.60389145415        1
[INPUT] 1    0    [1    /1   ]  0.492760742005       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2592550214018789, 1.0]], [0, [117616.81424205303, 1.0]], [0, [0.6622576918811137, 1.0]], [0, [1176168.1426188888, 1.0]], [0, [588084.0699925708, 1.0]], [0, [294042.03113192064, 1.0]], [0, [147020.99214793125, 1.0]], [0, [73510.42097118219, 1.0]], [0, [36754.72004420656, 1.0]], [0, [7303.475665284555, 1.0]], [0, [18375.810207965667, 1.0]], [0, [1449.7489709999882, 1.0]], [0, [374.0256671844714, 1.0]], [0, [113.25366291191176, 1.0]], [0, [37.77238100230098, 1.0]], [0, [8.130089265220697, 1.0]], [0, [3.2671526726957585, 1.0]], [1, [8.603891454153299, 1.0]], [1, [0.49276074200493625, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25925502]
bas 1, expnt(s) = [117616.81424205]
bas 2, expnt(s) = [0.66225769]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999257]
bas 5, expnt(s) = [294042.03113192]
bas 6, expnt(s) = [147020.99214793]
bas 7, expnt(s) = [73510.42097118]
bas 8, expnt(s) = [36754.72004421]
bas 9, expnt(s) = [7303.47566528]
bas 10, expnt(s) = [18375.81020797]
bas 11, expnt(s) = [1449.748971]
bas 12, expnt(s) = [374.02566718]
bas 13, expnt(s) = [113.25366291]
bas 14, expnt(s) = [37.772381]
bas 15, expnt(s) = [8.13008927]
bas 16, expnt(s) = [3.26715267]
bas 17, expnt(s) = [8.60389145]
bas 18, expnt(s) = [0.49276074]
CPU time:        93.86
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.59255021e-01 9.17931782e-01 1.17616814e+05 1.60460109e+04
 6.62257692e-01 1.85474959e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347567e+03 1.99600771e+03
 1.83758102e+04 3.98749266e+03 1.44974897e+03 5.93587342e+02
 3.74025667e+02 2.14877567e+02 1.13253663e+02 8.77110312e+01
 3.77723810e+01 3.84942441e+01 8.13008927e+00 1.21642828e+01
 3.26715267e+00 6.13962854e+00 8.60389145e+00 4.29885747e+01
 4.92760742e-01 1.20442433e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33561974218879
cond(S) = 907733.7336513308
E1 = -689.5681531324716  E_coul = 184.96589584360615
init E= -504.602257288865
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672283100038285  LUMO = 0.744847163457314
  mo_energy =
[-1.21703897e+02 -1.33849033e+01 -7.62401203e+00 -7.62401203e+00
 -7.62401203e+00 -1.65740043e+00 -6.72283100e-01 -6.72283100e-01
 -6.72283100e-01  7.44847163e-01  1.19513510e+01  1.11080501e+02
  6.05108890e+02  2.74453221e+03  1.22236015e+04  4.08450773e+04
  1.04888708e+05  2.30072145e+05  4.55887081e+05  8.44839338e+05
  1.52801660e+06  2.85028399e+06  5.80817126e+06]
E1 = -707.7295807863164  E_coul = 199.77433562294337
cycle= 1 E= -507.955245163373  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625772
diis-c [-0.39159086  1.        ]
  HOMO = -0.217597120100151  LUMO = 1.14619340722319
  mo_energy =
[-1.20194669e+02 -1.23035972e+01 -6.59474297e+00 -6.59474297e+00
 -6.59474297e+00 -1.16300047e+00 -2.17597120e-01 -2.17597120e-01
 -2.17597120e-01  1.14619341e+00  1.28832651e+01  1.12479473e+02
  6.06604045e+02  2.74596622e+03  1.22249263e+04  4.08463356e+04
  1.04889929e+05  2.30073343e+05  4.55888261e+05  8.44840505e+05
  1.52801776e+06  2.85028514e+06  5.80817240e+06]
E1 = -706.7939765126954  E_coul = 198.82131252446592
cycle= 2 E= -507.972663988229  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.444
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0259619
diis-c [-6.71521167e-04  2.52094309e-03  9.97479057e-01]
  HOMO = -0.239324464121269  LUMO = 1.13983105615538
  mo_energy =
[-1.20306899e+02 -1.23695003e+01 -6.66774138e+00 -6.66774138e+00
 -6.66774138e+00 -1.17698555e+00 -2.39324464e-01 -2.39324464e-01
 -2.39324464e-01  1.13983106e+00  1.28332731e+01  1.12385892e+02
  6.06487855e+02  2.74583409e+03  1.22247841e+04  4.08461897e+04
  1.04889782e+05  2.30073195e+05  4.55888113e+05  8.44840356e+05
  1.52801761e+06  2.85028499e+06  5.80817225e+06]
E1 = -706.6891794463937  E_coul = 198.71626508387416
cycle= 3 E= -507.97291436252  delta_E= -0.00025  |g|= 0.00437  |ddm|= 0.0601
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00296003
diis-c [-1.58421473e-06 -1.78081096e-04 -1.15243810e-01  1.11542189e+00]
  HOMO = -0.242477235538571  LUMO = 1.13867823727576
  mo_energy =
[-1.20319023e+02 -1.23782144e+01 -6.67697075e+00 -6.67697075e+00
 -6.67697075e+00 -1.17889460e+00 -2.42477236e-01 -2.42477236e-01
 -2.42477236e-01  1.13867824e+00  1.28263530e+01  1.12375103e+02
  6.06475558e+02  2.74582091e+03  1.22247704e+04  4.08461758e+04
  1.04889768e+05  2.30073181e+05  4.55888099e+05  8.44840342e+05
  1.52801759e+06  2.85028497e+06  5.80817224e+06]
E1 = -706.6741080250365  E_coul = 198.7011890148043
cycle= 4 E= -507.972919010232  delta_E= -4.65e-06  |g|= 0.000161  |ddm|= 0.00928
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000110164
diis-c [-6.74887293e-11 -5.58812009e-06  7.38183461e-03 -9.14138328e-02
  1.08403759e+00]
  HOMO = -0.24258400788117  LUMO = 1.13863271278056
  mo_energy =
[-1.20319266e+02 -1.23784719e+01 -6.67722196e+00 -6.67722196e+00
 -6.67722196e+00 -1.17895737e+00 -2.42584008e-01 -2.42584008e-01
 -2.42584008e-01  1.13863271e+00  1.28261358e+01  1.12374857e+02
  6.06475316e+02  2.74582067e+03  1.22247702e+04  4.08461756e+04
  1.04889768e+05  2.30073181e+05  4.55888098e+05  8.44840342e+05
  1.52801759e+06  2.85028497e+06  5.80817224e+06]
E1 = -706.6736044613275  E_coul = 198.70068544534743
cycle= 5 E= -507.97291901598  delta_E= -5.75e-09  |g|= 2.83e-07  |ddm|= 0.000344
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.72886e-07
diis-c [-6.10807886e-15  1.59612170e-07 -8.06890710e-05  8.76918711e-04
 -1.00870156e-02  1.00929063e+00]
  HOMO = -0.242584144925559  LUMO = 1.13863283182725
  mo_energy =
[-1.20319267e+02 -1.23784723e+01 -6.67722249e+00 -6.67722249e+00
 -6.67722249e+00 -1.17895758e+00 -2.42584145e-01 -2.42584145e-01
 -2.42584145e-01  1.13863283e+00  1.28261355e+01  1.12374856e+02
  6.06475314e+02  2.74582067e+03  1.22247702e+04  4.08461756e+04
  1.04889768e+05  2.30073181e+05  4.55888098e+05  8.44840342e+05
  1.52801759e+06  2.85028497e+06  5.80817224e+06]
E1 = -706.6736036020352  E_coul = 198.70068458605505
cycle= 6 E= -507.97291901598  delta_E= -5.68e-14  |g|= 8.23e-09  |ddm|= 4.63e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6736036020352  E_coul = 198.70068458605505
  HOMO = -0.242584141654546  LUMO = 1.13863282974867
  mo_energy =
[-1.20319267e+02 -1.23784723e+01 -6.67722249e+00 -6.67722249e+00
 -6.67722249e+00 -1.17895758e+00 -2.42584142e-01 -2.42584142e-01
 -2.42584142e-01  1.13863283e+00  1.28261355e+01  1.12374856e+02
  6.06475314e+02  2.74582067e+03  1.22247702e+04  4.08461756e+04
  1.04889768e+05  2.30073181e+05  4.55888098e+05  8.44840342e+05
  1.52801759e+06  2.85028497e+06  5.80817224e+06]
E1 = -706.673603620337  E_coul = 198.70068460435672
Extra cycle  E= -507.97291901598  delta_E= -5.68e-14  |g|= 2.28e-09  |ddm|= 1.2e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.59255021e-01 1.17616814e+05 6.62257692e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347567e+03 1.83758102e+04 1.44974897e+03
 3.74025667e+02 1.13253663e+02 3.77723810e+01 8.13008927e+00
 3.26715267e+00 8.60389145e+00 4.92760742e-01]
E = -507.9729190159802
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.259255021402       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.662257691881       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209712        1
[INPUT] 0    0    [1    /1   ]  36754.7200442        1
[INPUT] 0    0    [1    /1   ]  7303.47566528        1
[INPUT] 0    0    [1    /1   ]  18375.810208         1
[INPUT] 0    0    [1    /1   ]  1449.748971          1
[INPUT] 0    0    [1    /1   ]  374.025667184        1
[INPUT] 0    0    [1    /1   ]  113.253662912        1
[INPUT] 0    0    [1    /1   ]  37.7723810023        1
[INPUT] 0    0    [1    /1   ]  8.13008926522        1
[INPUT] 0    0    [1    /1   ]  3.2671526727         1
[INPUT] 1    0    [1    /1   ]  8.60389145415        1
[INPUT] 1    0    [1    /1   ]  0.492760742005       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2592550214018789, 1.0]], [0, [117616.81424205303, 1.0]], [0, [0.6622576918811137, 1.0]], [0, [1176168.1426188888, 1.0]], [0, [588084.0699925708, 1.0]], [0, [294042.03113192064, 1.0]], [0, [147020.99214793125, 1.0]], [0, [73510.42097118219, 1.0]], [0, [36754.72004420656, 1.0]], [0, [7303.475665284555, 1.0]], [0, [18375.810207965667, 1.0]], [0, [1449.7489709999882, 1.0]], [0, [374.0256671844714, 1.0]], [0, [113.25366291191176, 1.0]], [0, [37.77238100230098, 1.0]], [0, [8.130089265220697, 1.0]], [0, [3.2671526726957585, 1.0]], [1, [8.603891454153299, 1.0]], [1, [0.49276074200493625, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25925502]
bas 1, expnt(s) = [117616.81424205]
bas 2, expnt(s) = [0.66225769]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999257]
bas 5, expnt(s) = [294042.03113192]
bas 6, expnt(s) = [147020.99214793]
bas 7, expnt(s) = [73510.42097118]
bas 8, expnt(s) = [36754.72004421]
bas 9, expnt(s) = [7303.47566528]
bas 10, expnt(s) = [18375.81020797]
bas 11, expnt(s) = [1449.748971]
bas 12, expnt(s) = [374.02566718]
bas 13, expnt(s) = [113.25366291]
bas 14, expnt(s) = [37.772381]
bas 15, expnt(s) = [8.13008927]
bas 16, expnt(s) = [3.26715267]
bas 17, expnt(s) = [8.60389145]
bas 18, expnt(s) = [0.49276074]
CPU time:        94.39
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.59255021e-01 9.17931782e-01 1.17616814e+05 1.60460109e+04
 6.62257692e-01 1.85474959e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347567e+03 1.99600771e+03
 1.83758102e+04 3.98749266e+03 1.44974897e+03 5.93587342e+02
 3.74025667e+02 2.14877567e+02 1.13253663e+02 8.77110312e+01
 3.77723810e+01 3.84942441e+01 8.13008927e+00 1.21642828e+01
 3.26715267e+00 6.13962854e+00 8.60389145e+00 4.29885747e+01
 4.92760742e-01 1.20442433e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33561974218879
cond(S) = 907733.7336513308
E1 = -689.5681531324716  E_coul = 184.96589584360615
init E= -504.602257288865
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672283100038285  LUMO = 0.744847163457314
  mo_energy =
[-1.21703897e+02 -1.33849033e+01 -7.62401203e+00 -7.62401203e+00
 -7.62401203e+00 -1.65740043e+00 -6.72283100e-01 -6.72283100e-01
 -6.72283100e-01  7.44847163e-01  1.19513510e+01  1.11080501e+02
  6.05108890e+02  2.74453221e+03  1.22236015e+04  4.08450773e+04
  1.04888708e+05  2.30072145e+05  4.55887081e+05  8.44839338e+05
  1.52801660e+06  2.85028399e+06  5.80817126e+06]
E1 = -707.7295807863164  E_coul = 199.77433562294337
cycle= 1 E= -507.955245163373  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625772
diis-c [-0.39159086  1.        ]
  HOMO = -0.217597120100151  LUMO = 1.14619340722319
  mo_energy =
[-1.20194669e+02 -1.23035972e+01 -6.59474297e+00 -6.59474297e+00
 -6.59474297e+00 -1.16300047e+00 -2.17597120e-01 -2.17597120e-01
 -2.17597120e-01  1.14619341e+00  1.28832651e+01  1.12479473e+02
  6.06604045e+02  2.74596622e+03  1.22249263e+04  4.08463356e+04
  1.04889929e+05  2.30073343e+05  4.55888261e+05  8.44840505e+05
  1.52801776e+06  2.85028514e+06  5.80817240e+06]
E1 = -706.7939765126954  E_coul = 198.82131252446592
cycle= 2 E= -507.972663988229  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.444
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0259619
diis-c [-6.71521167e-04  2.52094309e-03  9.97479057e-01]
  HOMO = -0.239324464121269  LUMO = 1.13983105615538
  mo_energy =
[-1.20306899e+02 -1.23695003e+01 -6.66774138e+00 -6.66774138e+00
 -6.66774138e+00 -1.17698555e+00 -2.39324464e-01 -2.39324464e-01
 -2.39324464e-01  1.13983106e+00  1.28332731e+01  1.12385892e+02
  6.06487855e+02  2.74583409e+03  1.22247841e+04  4.08461897e+04
  1.04889782e+05  2.30073195e+05  4.55888113e+05  8.44840356e+05
  1.52801761e+06  2.85028499e+06  5.80817225e+06]
E1 = -706.6891794463937  E_coul = 198.71626508387416
cycle= 3 E= -507.97291436252  delta_E= -0.00025  |g|= 0.00437  |ddm|= 0.0601
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00296003
diis-c [-1.58421473e-06 -1.78081096e-04 -1.15243810e-01  1.11542189e+00]
  HOMO = -0.242477235538571  LUMO = 1.13867823727576
  mo_energy =
[-1.20319023e+02 -1.23782144e+01 -6.67697075e+00 -6.67697075e+00
 -6.67697075e+00 -1.17889460e+00 -2.42477236e-01 -2.42477236e-01
 -2.42477236e-01  1.13867824e+00  1.28263530e+01  1.12375103e+02
  6.06475558e+02  2.74582091e+03  1.22247704e+04  4.08461758e+04
  1.04889768e+05  2.30073181e+05  4.55888099e+05  8.44840342e+05
  1.52801759e+06  2.85028497e+06  5.80817224e+06]
E1 = -706.6741080250365  E_coul = 198.7011890148043
cycle= 4 E= -507.972919010232  delta_E= -4.65e-06  |g|= 0.000161  |ddm|= 0.00928
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000110164
diis-c [-6.74887293e-11 -5.58812009e-06  7.38183461e-03 -9.14138328e-02
  1.08403759e+00]
  HOMO = -0.24258400788117  LUMO = 1.13863271278056
  mo_energy =
[-1.20319266e+02 -1.23784719e+01 -6.67722196e+00 -6.67722196e+00
 -6.67722196e+00 -1.17895737e+00 -2.42584008e-01 -2.42584008e-01
 -2.42584008e-01  1.13863271e+00  1.28261358e+01  1.12374857e+02
  6.06475316e+02  2.74582067e+03  1.22247702e+04  4.08461756e+04
  1.04889768e+05  2.30073181e+05  4.55888098e+05  8.44840342e+05
  1.52801759e+06  2.85028497e+06  5.80817224e+06]
E1 = -706.6736044613275  E_coul = 198.70068544534743
cycle= 5 E= -507.97291901598  delta_E= -5.75e-09  |g|= 2.83e-07  |ddm|= 0.000344
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.72886e-07
diis-c [-6.10807886e-15  1.59612170e-07 -8.06890710e-05  8.76918711e-04
 -1.00870156e-02  1.00929063e+00]
  HOMO = -0.242584144925559  LUMO = 1.13863283182725
  mo_energy =
[-1.20319267e+02 -1.23784723e+01 -6.67722249e+00 -6.67722249e+00
 -6.67722249e+00 -1.17895758e+00 -2.42584145e-01 -2.42584145e-01
 -2.42584145e-01  1.13863283e+00  1.28261355e+01  1.12374856e+02
  6.06475314e+02  2.74582067e+03  1.22247702e+04  4.08461756e+04
  1.04889768e+05  2.30073181e+05  4.55888098e+05  8.44840342e+05
  1.52801759e+06  2.85028497e+06  5.80817224e+06]
E1 = -706.6736036020352  E_coul = 198.70068458605505
cycle= 6 E= -507.97291901598  delta_E= -5.68e-14  |g|= 8.23e-09  |ddm|= 4.63e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6736036020352  E_coul = 198.70068458605505
  HOMO = -0.242584141654546  LUMO = 1.13863282974867
  mo_energy =
[-1.20319267e+02 -1.23784723e+01 -6.67722249e+00 -6.67722249e+00
 -6.67722249e+00 -1.17895758e+00 -2.42584142e-01 -2.42584142e-01
 -2.42584142e-01  1.13863283e+00  1.28261355e+01  1.12374856e+02
  6.06475314e+02  2.74582067e+03  1.22247702e+04  4.08461756e+04
  1.04889768e+05  2.30073181e+05  4.55888098e+05  8.44840342e+05
  1.52801759e+06  2.85028497e+06  5.80817224e+06]
E1 = -706.673603620337  E_coul = 198.70068460435672
Extra cycle  E= -507.97291901598  delta_E= -5.68e-14  |g|= 2.28e-09  |ddm|= 1.2e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907733.7336513308
E1 = -706.673603620337  E_coul = 198.70068460435672
init E= -507.97291901598
    CPU time for initialize scf      1.60 sec, wall time      0.10 sec
  HOMO = -0.242584141134542  LUMO = 1.13863282908148
  mo_energy =
[-1.20319267e+02 -1.23784723e+01 -6.67722248e+00 -6.67722248e+00
 -6.67722248e+00 -1.17895758e+00 -2.42584141e-01 -2.42584141e-01
 -2.42584141e-01  1.13863283e+00  1.28261355e+01  1.12374856e+02
  6.06475314e+02  2.74582067e+03  1.22247702e+04  4.08461756e+04
  1.04889768e+05  2.30073181e+05  4.55888098e+05  8.44840342e+05
  1.52801759e+06  2.85028497e+06  5.80817224e+06]
E1 = -706.6736036241908  E_coul = 198.70068460821076
cycle= 1 E= -507.97291901598  delta_E= 1.14e-13  |g|= 1.24e-09  |ddm|= 2.49e-09
    CPU time for cycle= 1      0.09 sec, wall time      0.01 sec
E1 = -706.6736036241908  E_coul = 198.70068460821076
  HOMO = -0.24258414102619  LUMO = 1.13863282756446
  mo_energy =
[-1.20319267e+02 -1.23784723e+01 -6.67722248e+00 -6.67722248e+00
 -6.67722248e+00 -1.17895758e+00 -2.42584141e-01 -2.42584141e-01
 -2.42584141e-01  1.13863283e+00  1.28261355e+01  1.12374856e+02
  6.06475314e+02  2.74582067e+03  1.22247702e+04  4.08461756e+04
  1.04889768e+05  2.30073181e+05  4.55888098e+05  8.44840342e+05
  1.52801759e+06  2.85028497e+06  5.80817224e+06]
E1 = -706.6736036255498  E_coul = 198.70068460956972
Extra cycle  E= -507.97291901598  delta_E=    0  |g|= 1.66e-09  |ddm|= 9.59e-10
    CPU time for scf_cycle      1.75 sec, wall time      0.17 sec
exp = [2.59255021e-01 1.17616814e+05 6.62257692e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347567e+03 1.83758102e+04 1.44974897e+03
 3.74025667e+02 1.13253663e+02 3.77723810e+01 8.13008927e+00
 3.26715267e+00 8.60389145e+00 4.92760742e-01]
grad_E = [ 2.67828995e-03  4.17585467e-09 -9.99351461e-04  1.86823699e-11
  1.12561556e-10  6.49704283e-10  2.54785037e-09  1.05847518e-08
  5.69488657e-08  3.58179735e-06  1.22374881e-07  5.46239522e-06
 -1.10484564e-05  5.86220349e-05 -4.30315855e-04 -3.72294141e-04
 -1.70811880e-03 -1.30101576e-04  4.98738131e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:18 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.257842674442       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.654986114918       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209708        1
[INPUT] 0    0    [1    /1   ]  36754.7200423        1
[INPUT] 0    0    [1    /1   ]  7303.47554278        1
[INPUT] 0    0    [1    /1   ]  18375.8102038        1
[INPUT] 0    0    [1    /1   ]  1449.74877298        1
[INPUT] 0    0    [1    /1   ]  374.026210817        1
[INPUT] 0    0    [1    /1   ]  113.2503517          1
[INPUT] 0    0    [1    /1   ]  37.7914627976        1
[INPUT] 0    0    [1    /1   ]  8.16059812065        1
[INPUT] 0    0    [1    /1   ]  3.27542336402        1
[INPUT] 1    0    [1    /1   ]  8.60391883165        1
[INPUT] 1    0    [1    /1   ]  0.492835688954       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2578426744419392, 1.0]], [0, [117616.8142419102, 1.0]], [0, [0.6549861149182133, 1.0]], [0, [1176168.142618888, 1.0]], [0, [588084.069992567, 1.0]], [0, [294042.0311318984, 1.0]], [0, [147020.9921478441, 1.0]], [0, [73510.42097082014, 1.0]], [0, [36754.72004225842, 1.0]], [0, [7303.475542781004, 1.0]], [0, [18375.81020378157, 1.0]], [0, [1449.7487729814584, 1.0]], [0, [374.0262108170273, 1.0]], [0, [113.25035169962813, 1.0]], [0, [37.7914627976141, 1.0]], [0, [8.160598120645652, 1.0]], [0, [3.2754233640159347, 1.0]], [1, [8.603918831648146, 1.0]], [1, [0.49283568895415564, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25784267]
bas 1, expnt(s) = [117616.81424191]
bas 2, expnt(s) = [0.65498611]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999257]
bas 5, expnt(s) = [294042.0311319]
bas 6, expnt(s) = [147020.99214784]
bas 7, expnt(s) = [73510.42097082]
bas 8, expnt(s) = [36754.72004226]
bas 9, expnt(s) = [7303.47554278]
bas 10, expnt(s) = [18375.81020378]
bas 11, expnt(s) = [1449.74877298]
bas 12, expnt(s) = [374.02621082]
bas 13, expnt(s) = [113.2503517]
bas 14, expnt(s) = [37.7914628]
bas 15, expnt(s) = [8.16059812]
bas 16, expnt(s) = [3.27542336]
bas 17, expnt(s) = [8.60391883]
bas 18, expnt(s) = [0.49283569]
CPU time:        99.40
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.57842674e-01 9.14178750e-01 1.17616814e+05 1.60460109e+04
 6.54986115e-01 1.83945469e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347554e+03 1.99600768e+03
 1.83758102e+04 3.98749266e+03 1.44974877e+03 5.93587281e+02
 3.74026211e+02 2.14877802e+02 1.13250352e+02 8.77091079e+01
 3.77914628e+01 3.85088280e+01 8.16059812e+00 1.21985024e+01
 3.27542336e+00 6.15128156e+00 8.60391883e+00 4.29887457e+01
 4.92835689e-01 1.20465331e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335523483060392
cond(S) = 907735.4109672664
E1 = -689.5695127912904  E_coul = 184.9673835497772
init E= -504.602129241513
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.672231248821054  LUMO = 0.732723346211875
  mo_energy =
[-1.21703753e+02 -1.33847629e+01 -7.62394091e+00 -7.62394091e+00
 -7.62394091e+00 -1.65734803e+00 -6.72231249e-01 -6.72231249e-01
 -6.72231249e-01  7.32723346e-01  1.19633748e+01  1.11237068e+02
  6.05291700e+02  2.74469734e+03  1.22237459e+04  4.08452108e+04
  1.04888836e+05  2.30072270e+05  4.55887203e+05  8.44839458e+05
  1.52801672e+06  2.85028411e+06  5.80817138e+06]
E1 = -707.7319839425897  E_coul = 199.77667572222902
cycle= 1 E= -507.955308220361  delta_E= -3.35  |g|= 0.449  |ddm|= 0.513
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625745
diis-c [-0.39155668  1.        ]
  HOMO = -0.21741929673191  LUMO = 1.13207992488603
  mo_energy =
[-1.20194498e+02 -1.23034437e+01 -6.59468268e+00 -6.59468268e+00
 -6.59468268e+00 -1.16287995e+00 -2.17419297e-01 -2.17419297e-01
 -2.17419297e-01  1.13207992e+00  1.28967416e+01  1.12636182e+02
  6.06786894e+02  2.74613140e+03  1.22250709e+04  4.08464692e+04
  1.04890057e+05  2.30073467e+05  4.55888383e+05  8.44840625e+05
  1.52801787e+06  2.85028525e+06  5.80817251e+06]
E1 = -706.7980128052043  E_coul = 198.82532648243784
cycle= 2 E= -507.972686322766  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.445
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0259495
diis-c [-6.70878490e-04  2.52061045e-03  9.97479390e-01]
  HOMO = -0.239126146927129  LUMO = 1.12581309776894
  mo_energy =
[-1.20306542e+02 -1.23692115e+01 -6.66753464e+00 -6.66753464e+00
 -6.66753464e+00 -1.17685340e+00 -2.39126147e-01 -2.39126147e-01
 -2.39126147e-01  1.12581310e+00  1.28467995e+01  1.12542749e+02
  6.06670894e+02  2.74599947e+03  1.22249289e+04  4.08463235e+04
  1.04889910e+05  2.30073319e+05  4.55888234e+05  8.44840476e+05
  1.52801772e+06  2.85028510e+06  5.80817236e+06]
E1 = -706.6930151356285  E_coul = 198.72007711425348
cycle= 3 E= -507.972938021375  delta_E= -0.000252  |g|= 0.00439  |ddm|= 0.0605
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00296529
diis-c [-1.59181575e-06 -1.81813558e-04 -1.15516226e-01  1.11569804e+00]
  HOMO = -0.242291029022626  LUMO = 1.12466915568802
  mo_energy =
[-1.20318683e+02 -1.23779424e+01 -6.67678035e+00 -6.67678035e+00
 -6.67678035e+00 -1.17877043e+00 -2.42291029e-01 -2.42291029e-01
 -2.42291029e-01  1.12466916e+00  1.28398563e+01  1.12531942e+02
  6.06658580e+02  2.74598627e+03  1.22249152e+04  4.08463096e+04
  1.04889896e+05  2.30073305e+05  4.55888220e+05  8.44840462e+05
  1.52801771e+06  2.85028509e+06  5.80817235e+06]
E1 = -706.6778432833828  E_coul = 198.70490054646535
cycle= 4 E= -507.972942736917  delta_E= -4.72e-06  |g|= 0.000164  |ddm|= 0.00939
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000111155
diis-c [-6.82623669e-11 -5.61490392e-06  7.41690727e-03 -9.18866099e-02
  1.08447532e+00]
  HOMO = -0.242399607678041  LUMO = 1.12462335622217
  mo_energy =
[-1.20318931e+02 -1.23782040e+01 -6.67703566e+00 -6.67703566e+00
 -6.67703566e+00 -1.17883429e+00 -2.42399608e-01 -2.42399608e-01
 -2.42399608e-01  1.12462336e+00  1.28396354e+01  1.12531691e+02
  6.06658333e+02  2.74598603e+03  1.22249149e+04  4.08463094e+04
  1.04889896e+05  2.30073305e+05  4.55888220e+05  8.44840462e+05
  1.52801771e+06  2.85028509e+06  5.80817235e+06]
E1 = -706.6773295612189  E_coul = 198.70438681832957
cycle= 5 E= -507.972942742889  delta_E= -5.97e-09  |g|= 2.91e-07  |ddm|= 0.000352
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.76649e-07
diis-c [-5.90339983e-15  1.57206416e-07 -8.09552304e-05  8.78388173e-04
 -1.00760384e-02  1.00927845e+00]
  HOMO = -0.242399751230714  LUMO = 1.1246234754475
  mo_energy =
[-1.20318932e+02 -1.23782044e+01 -6.67703621e+00 -6.67703621e+00
 -6.67703621e+00 -1.17883451e+00 -2.42399751e-01 -2.42399751e-01
 -2.42399751e-01  1.12462348e+00  1.28396351e+01  1.12531690e+02
  6.06658332e+02  2.74598603e+03  1.22249149e+04  4.08463094e+04
  1.04889896e+05  2.30073305e+05  4.55888220e+05  8.44840462e+05
  1.52801771e+06  2.85028509e+06  5.80817235e+06]
E1 = -706.6773286575243  E_coul = 198.7043859146348
cycle= 6 E= -507.972942742889  delta_E= -1.14e-13  |g|= 7.31e-09  |ddm|= 4.92e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6773286575243  E_coul = 198.7043859146348
  HOMO = -0.242399748159936  LUMO = 1.12462347327307
  mo_energy =
[-1.20318932e+02 -1.23782044e+01 -6.67703620e+00 -6.67703620e+00
 -6.67703620e+00 -1.17883451e+00 -2.42399748e-01 -2.42399748e-01
 -2.42399748e-01  1.12462347e+00  1.28396351e+01  1.12531690e+02
  6.06658332e+02  2.74598603e+03  1.22249149e+04  4.08463094e+04
  1.04889896e+05  2.30073305e+05  4.55888220e+05  8.44840462e+05
  1.52801771e+06  2.85028509e+06  5.80817235e+06]
E1 = -706.6773286767199  E_coul = 198.7043859338304
Extra cycle  E= -507.972942742889  delta_E=    0  |g|= 1.24e-09  |ddm|= 1.25e-08
    CPU time for scf_cycle      0.46 sec, wall time      0.12 sec
exp = [2.57842674e-01 1.17616814e+05 6.54986115e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347554e+03 1.83758102e+04 1.44974877e+03
 3.74026211e+02 1.13250352e+02 3.77914628e+01 8.16059812e+00
 3.27542336e+00 8.60391883e+00 4.92835689e-01]
E = -507.9729427428895
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:18 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.257842674442       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.654986114918       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209708        1
[INPUT] 0    0    [1    /1   ]  36754.7200423        1
[INPUT] 0    0    [1    /1   ]  7303.47554278        1
[INPUT] 0    0    [1    /1   ]  18375.8102038        1
[INPUT] 0    0    [1    /1   ]  1449.74877298        1
[INPUT] 0    0    [1    /1   ]  374.026210817        1
[INPUT] 0    0    [1    /1   ]  113.2503517          1
[INPUT] 0    0    [1    /1   ]  37.7914627976        1
[INPUT] 0    0    [1    /1   ]  8.16059812065        1
[INPUT] 0    0    [1    /1   ]  3.27542336402        1
[INPUT] 1    0    [1    /1   ]  8.60391883165        1
[INPUT] 1    0    [1    /1   ]  0.492835688954       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2578426744419392, 1.0]], [0, [117616.8142419102, 1.0]], [0, [0.6549861149182133, 1.0]], [0, [1176168.142618888, 1.0]], [0, [588084.069992567, 1.0]], [0, [294042.0311318984, 1.0]], [0, [147020.9921478441, 1.0]], [0, [73510.42097082014, 1.0]], [0, [36754.72004225842, 1.0]], [0, [7303.475542781004, 1.0]], [0, [18375.81020378157, 1.0]], [0, [1449.7487729814584, 1.0]], [0, [374.0262108170273, 1.0]], [0, [113.25035169962813, 1.0]], [0, [37.7914627976141, 1.0]], [0, [8.160598120645652, 1.0]], [0, [3.2754233640159347, 1.0]], [1, [8.603918831648146, 1.0]], [1, [0.49283568895415564, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25784267]
bas 1, expnt(s) = [117616.81424191]
bas 2, expnt(s) = [0.65498611]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999257]
bas 5, expnt(s) = [294042.0311319]
bas 6, expnt(s) = [147020.99214784]
bas 7, expnt(s) = [73510.42097082]
bas 8, expnt(s) = [36754.72004226]
bas 9, expnt(s) = [7303.47554278]
bas 10, expnt(s) = [18375.81020378]
bas 11, expnt(s) = [1449.74877298]
bas 12, expnt(s) = [374.02621082]
bas 13, expnt(s) = [113.2503517]
bas 14, expnt(s) = [37.7914628]
bas 15, expnt(s) = [8.16059812]
bas 16, expnt(s) = [3.27542336]
bas 17, expnt(s) = [8.60391883]
bas 18, expnt(s) = [0.49283569]
CPU time:        99.94
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.57842674e-01 9.14178750e-01 1.17616814e+05 1.60460109e+04
 6.54986115e-01 1.83945469e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347554e+03 1.99600768e+03
 1.83758102e+04 3.98749266e+03 1.44974877e+03 5.93587281e+02
 3.74026211e+02 2.14877802e+02 1.13250352e+02 8.77091079e+01
 3.77914628e+01 3.85088280e+01 8.16059812e+00 1.21985024e+01
 3.27542336e+00 6.15128156e+00 8.60391883e+00 4.29887457e+01
 4.92835689e-01 1.20465331e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335523483060392
cond(S) = 907735.4109672664
E1 = -689.5695127912904  E_coul = 184.9673835497772
init E= -504.602129241513
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672231248821054  LUMO = 0.732723346211875
  mo_energy =
[-1.21703753e+02 -1.33847629e+01 -7.62394091e+00 -7.62394091e+00
 -7.62394091e+00 -1.65734803e+00 -6.72231249e-01 -6.72231249e-01
 -6.72231249e-01  7.32723346e-01  1.19633748e+01  1.11237068e+02
  6.05291700e+02  2.74469734e+03  1.22237459e+04  4.08452108e+04
  1.04888836e+05  2.30072270e+05  4.55887203e+05  8.44839458e+05
  1.52801672e+06  2.85028411e+06  5.80817138e+06]
E1 = -707.7319839425897  E_coul = 199.77667572222902
cycle= 1 E= -507.955308220361  delta_E= -3.35  |g|= 0.449  |ddm|= 0.513
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625745
diis-c [-0.39155668  1.        ]
  HOMO = -0.21741929673191  LUMO = 1.13207992488603
  mo_energy =
[-1.20194498e+02 -1.23034437e+01 -6.59468268e+00 -6.59468268e+00
 -6.59468268e+00 -1.16287995e+00 -2.17419297e-01 -2.17419297e-01
 -2.17419297e-01  1.13207992e+00  1.28967416e+01  1.12636182e+02
  6.06786894e+02  2.74613140e+03  1.22250709e+04  4.08464692e+04
  1.04890057e+05  2.30073467e+05  4.55888383e+05  8.44840625e+05
  1.52801787e+06  2.85028525e+06  5.80817251e+06]
E1 = -706.7980128052043  E_coul = 198.82532648243784
cycle= 2 E= -507.972686322766  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.445
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0259495
diis-c [-6.70878490e-04  2.52061045e-03  9.97479390e-01]
  HOMO = -0.239126146927129  LUMO = 1.12581309776894
  mo_energy =
[-1.20306542e+02 -1.23692115e+01 -6.66753464e+00 -6.66753464e+00
 -6.66753464e+00 -1.17685340e+00 -2.39126147e-01 -2.39126147e-01
 -2.39126147e-01  1.12581310e+00  1.28467995e+01  1.12542749e+02
  6.06670894e+02  2.74599947e+03  1.22249289e+04  4.08463235e+04
  1.04889910e+05  2.30073319e+05  4.55888234e+05  8.44840476e+05
  1.52801772e+06  2.85028510e+06  5.80817236e+06]
E1 = -706.6930151356285  E_coul = 198.72007711425348
cycle= 3 E= -507.972938021375  delta_E= -0.000252  |g|= 0.00439  |ddm|= 0.0605
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00296529
diis-c [-1.59181575e-06 -1.81813558e-04 -1.15516226e-01  1.11569804e+00]
  HOMO = -0.242291029022626  LUMO = 1.12466915568802
  mo_energy =
[-1.20318683e+02 -1.23779424e+01 -6.67678035e+00 -6.67678035e+00
 -6.67678035e+00 -1.17877043e+00 -2.42291029e-01 -2.42291029e-01
 -2.42291029e-01  1.12466916e+00  1.28398563e+01  1.12531942e+02
  6.06658580e+02  2.74598627e+03  1.22249152e+04  4.08463096e+04
  1.04889896e+05  2.30073305e+05  4.55888220e+05  8.44840462e+05
  1.52801771e+06  2.85028509e+06  5.80817235e+06]
E1 = -706.6778432833828  E_coul = 198.70490054646535
cycle= 4 E= -507.972942736917  delta_E= -4.72e-06  |g|= 0.000164  |ddm|= 0.00939
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000111155
diis-c [-6.82623669e-11 -5.61490392e-06  7.41690727e-03 -9.18866099e-02
  1.08447532e+00]
  HOMO = -0.242399607678041  LUMO = 1.12462335622217
  mo_energy =
[-1.20318931e+02 -1.23782040e+01 -6.67703566e+00 -6.67703566e+00
 -6.67703566e+00 -1.17883429e+00 -2.42399608e-01 -2.42399608e-01
 -2.42399608e-01  1.12462336e+00  1.28396354e+01  1.12531691e+02
  6.06658333e+02  2.74598603e+03  1.22249149e+04  4.08463094e+04
  1.04889896e+05  2.30073305e+05  4.55888220e+05  8.44840462e+05
  1.52801771e+06  2.85028509e+06  5.80817235e+06]
E1 = -706.6773295612189  E_coul = 198.70438681832957
cycle= 5 E= -507.972942742889  delta_E= -5.97e-09  |g|= 2.91e-07  |ddm|= 0.000352
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.76649e-07
diis-c [-5.90339983e-15  1.57206416e-07 -8.09552304e-05  8.78388173e-04
 -1.00760384e-02  1.00927845e+00]
  HOMO = -0.242399751230714  LUMO = 1.1246234754475
  mo_energy =
[-1.20318932e+02 -1.23782044e+01 -6.67703621e+00 -6.67703621e+00
 -6.67703621e+00 -1.17883451e+00 -2.42399751e-01 -2.42399751e-01
 -2.42399751e-01  1.12462348e+00  1.28396351e+01  1.12531690e+02
  6.06658332e+02  2.74598603e+03  1.22249149e+04  4.08463094e+04
  1.04889896e+05  2.30073305e+05  4.55888220e+05  8.44840462e+05
  1.52801771e+06  2.85028509e+06  5.80817235e+06]
E1 = -706.6773286575243  E_coul = 198.7043859146348
cycle= 6 E= -507.972942742889  delta_E= -1.14e-13  |g|= 7.31e-09  |ddm|= 4.92e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6773286575243  E_coul = 198.7043859146348
  HOMO = -0.242399748159936  LUMO = 1.12462347327307
  mo_energy =
[-1.20318932e+02 -1.23782044e+01 -6.67703620e+00 -6.67703620e+00
 -6.67703620e+00 -1.17883451e+00 -2.42399748e-01 -2.42399748e-01
 -2.42399748e-01  1.12462347e+00  1.28396351e+01  1.12531690e+02
  6.06658332e+02  2.74598603e+03  1.22249149e+04  4.08463094e+04
  1.04889896e+05  2.30073305e+05  4.55888220e+05  8.44840462e+05
  1.52801771e+06  2.85028509e+06  5.80817235e+06]
E1 = -706.6773286767199  E_coul = 198.7043859338304
Extra cycle  E= -507.972942742889  delta_E=    0  |g|= 1.24e-09  |ddm|= 1.25e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907735.4109672664
E1 = -706.6773286767199  E_coul = 198.7043859338304
init E= -507.972942742889
    CPU time for initialize scf      1.50 sec, wall time      0.10 sec
  HOMO = -0.242399747621531  LUMO = 1.12462347397221
  mo_energy =
[-1.20318932e+02 -1.23782044e+01 -6.67703620e+00 -6.67703620e+00
 -6.67703620e+00 -1.17883451e+00 -2.42399748e-01 -2.42399748e-01
 -2.42399748e-01  1.12462347e+00  1.28396351e+01  1.12531690e+02
  6.06658332e+02  2.74598603e+03  1.22249149e+04  4.08463094e+04
  1.04889896e+05  2.30073305e+05  4.55888220e+05  8.44840462e+05
  1.52801771e+06  2.85028509e+06  5.80817235e+06]
E1 = -706.6773286794144  E_coul = 198.70438593652514
cycle= 1 E= -507.972942742889  delta_E= 2.27e-13  |g|= 1.12e-09  |ddm|= 1.71e-09
    CPU time for cycle= 1      0.10 sec, wall time      0.01 sec
E1 = -706.6773286794144  E_coul = 198.70438593652514
  HOMO = -0.242399747549437  LUMO = 1.12462347301258
  mo_energy =
[-1.20318932e+02 -1.23782044e+01 -6.67703620e+00 -6.67703620e+00
 -6.67703620e+00 -1.17883451e+00 -2.42399748e-01 -2.42399748e-01
 -2.42399748e-01  1.12462347e+00  1.28396351e+01  1.12531690e+02
  6.06658332e+02  2.74598603e+03  1.22249149e+04  4.08463094e+04
  1.04889896e+05  2.30073305e+05  4.55888220e+05  8.44840462e+05
  1.52801771e+06  2.85028509e+06  5.80817235e+06]
E1 = -706.677328679894  E_coul = 198.70438593700487
Extra cycle  E= -507.972942742889  delta_E= 1.14e-13  |g|= 1.13e-09  |ddm|= 4.21e-10
    CPU time for scf_cycle      1.65 sec, wall time      0.17 sec
exp = [2.57842674e-01 1.17616814e+05 6.54986115e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347554e+03 1.83758102e+04 1.44974877e+03
 3.74026211e+02 1.13250352e+02 3.77914628e+01 8.16059812e+00
 3.27542336e+00 8.60391883e+00 4.92835689e-01]
grad_E = [ 5.02058197e-03  4.18281667e-09 -2.48850191e-03  1.87653423e-11
  1.12787304e-10  6.50782798e-10  2.55215199e-09  1.06028780e-08
  5.70384293e-08  3.58824903e-06  1.22645224e-07  5.08465914e-06
 -5.44433112e-06  1.88541301e-05 -3.29378572e-04 -2.03428365e-04
 -1.97009722e-03 -1.65419727e-04  7.43708505e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.257247169508       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.649366603953       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.42097          1
[INPUT] 0    0    [1    /1   ]  36754.7200378        1
[INPUT] 0    0    [1    /1   ]  7303.47526221        1
[INPUT] 0    0    [1    /1   ]  18375.8101942        1
[INPUT] 0    0    [1    /1   ]  1449.74832016        1
[INPUT] 0    0    [1    /1   ]  374.027444699        1
[INPUT] 0    0    [1    /1   ]  113.242871436        1
[INPUT] 0    0    [1    /1   ]  37.8346879634        1
[INPUT] 0    0    [1    /1   ]  8.22930260907        1
[INPUT] 0    0    [1    /1   ]  3.29868257758        1
[INPUT] 1    0    [1    /1   ]  8.60391507876        1
[INPUT] 1    0    [1    /1   ]  0.492895050759       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.25724716950773885, 1.0]], [0, [117616.81424158305, 1.0]], [0, [0.6493666039530488, 1.0]], [0, [1176168.1426188867, 1.0]], [0, [588084.0699925581, 1.0]], [0, [294042.0311318475, 1.0]], [0, [147020.99214764452, 1.0]], [0, [73510.42096999093, 1.0]], [0, [36754.72003779658, 1.0]], [0, [7303.475262207703, 1.0]], [0, [18375.81019419853, 1.0]], [0, [1449.7483201555747, 1.0]], [0, [374.02744469937215, 1.0]], [0, [113.24287143611616, 1.0]], [0, [37.83468796335538, 1.0]], [0, [8.229302609069439, 1.0]], [0, [3.2986825775767747, 1.0]], [1, [8.603915078757502, 1.0]], [1, [0.49289505075946194, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25724717]
bas 1, expnt(s) = [117616.81424158]
bas 2, expnt(s) = [0.6493666]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999256]
bas 5, expnt(s) = [294042.03113185]
bas 6, expnt(s) = [147020.99214764]
bas 7, expnt(s) = [73510.42096999]
bas 8, expnt(s) = [36754.7200378]
bas 9, expnt(s) = [7303.47526221]
bas 10, expnt(s) = [18375.8101942]
bas 11, expnt(s) = [1449.74832016]
bas 12, expnt(s) = [374.0274447]
bas 13, expnt(s) = [113.24287144]
bas 14, expnt(s) = [37.83468796]
bas 15, expnt(s) = [8.22930261]
bas 16, expnt(s) = [3.29868258]
bas 17, expnt(s) = [8.60391508]
bas 18, expnt(s) = [0.49289505]
CPU time:       104.81
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.57247170e-01 9.12594775e-01 1.17616814e+05 1.60460109e+04
 6.49366604e-01 1.82760563e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347526e+03 1.99600763e+03
 1.83758102e+04 3.98749266e+03 1.44974832e+03 5.93587142e+02
 3.74027445e+02 2.14878333e+02 1.13242871e+02 8.77047629e+01
 3.78346880e+01 3.85418575e+01 8.22930261e+00 1.22754465e+01
 3.29868258e+00 6.18401336e+00 8.60391508e+00 4.29887222e+01
 4.92895051e-01 1.20483469e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335428665313476
cond(S) = 907740.1230941078
E1 = -689.5700664308497  E_coul = 184.96826549957717
init E= -504.601800931273
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672199098416478  LUMO = 0.725447689193723
  mo_energy =
[-1.21703724e+02 -1.33846530e+01 -7.62390314e+00 -7.62390314e+00
 -7.62390314e+00 -1.65732251e+00 -6.72199098e-01 -6.72199098e-01
 -6.72199098e-01  7.25447689e-01  1.20673446e+01  1.11665600e+02
  6.05766640e+02  2.74512317e+03  1.22241180e+04  4.08455546e+04
  1.04889165e+05  2.30072590e+05  4.55887516e+05  8.44839766e+05
  1.52801702e+06  2.85028440e+06  5.80817166e+06]
E1 = -707.734749606098  E_coul = 199.77935283288957
cycle= 1 E= -507.955396773208  delta_E= -3.35  |g|= 0.449  |ddm|= 0.516
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625721
diis-c [-0.39152652  1.        ]
  HOMO = -0.217267829609317  LUMO = 1.12372805625575
  mo_energy =
[-1.20194243e+02 -1.23032598e+01 -6.59457640e+00 -6.59457640e+00
 -6.59457640e+00 -1.16277725e+00 -2.17267830e-01 -2.17267830e-01
 -2.17267830e-01  1.12372806e+00  1.30041724e+01  1.13065114e+02
  6.07262070e+02  2.74655750e+03  1.22254432e+04  4.08468134e+04
  1.04890387e+05  2.30073787e+05  4.55888696e+05  8.44840933e+05
  1.52801818e+06  2.85028555e+06  5.80817280e+06]
E1 = -706.802503623759  E_coul = 198.8297704107349
cycle= 2 E= -507.972733213024  delta_E= -0.0173  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0259084
diis-c [-6.68687665e-04  2.55271660e-03  9.97447283e-01]
  HOMO = -0.238948961093165  LUMO = 1.11751521255481
  mo_energy =
[-1.20306087e+02 -1.23688871e+01 -6.66727390e+00 -6.66727390e+00
 -6.66727390e+00 -1.17673583e+00 -2.38948961e-01 -2.38948961e-01
 -2.38948961e-01  1.11751521e+00  1.29541263e+01  1.12971817e+02
  6.07146275e+02  2.74642579e+03  1.22253014e+04  4.08466679e+04
  1.04890240e+05  2.30073640e+05  4.55888548e+05  8.44840785e+05
  1.52801803e+06  2.85028540e+06  5.80817265e+06]
E1 = -706.697419130403  E_coul = 198.72443342990476
cycle= 3 E= -507.972985700498  delta_E= -0.000252  |g|= 0.0044  |ddm|= 0.0608
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00296383
diis-c [-1.59295665e-06 -1.84853651e-04 -1.15636242e-01  1.11582110e+00]
  HOMO = -0.242120961418562  LUMO = 1.11637589815371
  mo_energy =
[-1.20318236e+02 -1.23776271e+01 -6.67652825e+00 -6.67652825e+00
 -6.67652825e+00 -1.17865767e+00 -2.42120961e-01 -2.42120961e-01
 -2.42120961e-01  1.11637590e+00  1.29471500e+01  1.12960999e+02
  6.07133952e+02  2.74641258e+03  1.22252877e+04  4.08466540e+04
  1.04890226e+05  2.30073626e+05  4.55888534e+05  8.44840771e+05
  1.52801801e+06  2.85028539e+06  5.80817264e+06]
E1 = -706.682182235293  E_coul = 198.7091917743361
cycle= 4 E= -507.972990460957  delta_E= -4.76e-06  |g|= 0.000165  |ddm|= 0.00946
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000111809
diis-c [-6.90161969e-11 -5.58955577e-06  7.44303837e-03 -9.23055694e-02
  1.08486812e+00]
  HOMO = -0.242230934020733  LUMO = 1.11632982258116
  mo_energy =
[-1.20318488e+02 -1.23778922e+01 -6.67678719e+00 -6.67678719e+00
 -6.67678719e+00 -1.17872236e+00 -2.42230934e-01 -2.42230934e-01
 -2.42230934e-01  1.11632982e+00  1.29469257e+01  1.12960744e+02
  6.07133701e+02  2.74641233e+03  1.22252875e+04  4.08466537e+04
  1.04890226e+05  2.30073625e+05  4.55888534e+05  8.44840770e+05
  1.52801801e+06  2.85028539e+06  5.80817264e+06]
E1 = -706.6816606507689  E_coul = 198.70867018367403
cycle= 5 E= -507.972990467095  delta_E= -6.14e-09  |g|= 2.89e-07  |ddm|= 0.000358
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.81431e-07
diis-c [-6.28022071e-15  1.68509183e-07 -8.38666287e-05  9.12656574e-04
 -1.03546558e-02  1.00952570e+00]
  HOMO = -0.242231068785959  LUMO = 1.11632994427941
  mo_energy =
[-1.20318489e+02 -1.23778927e+01 -6.67678772e+00 -6.67678772e+00
 -6.67678772e+00 -1.17872257e+00 -2.42231069e-01 -2.42231069e-01
 -2.42231069e-01  1.11632994e+00  1.29469254e+01  1.12960744e+02
  6.07133700e+02  2.74641233e+03  1.22252875e+04  4.08466537e+04
  1.04890226e+05  2.30073625e+05  4.55888534e+05  8.44840770e+05
  1.52801801e+06  2.85028539e+06  5.80817264e+06]
E1 = -706.6816597824795  E_coul = 198.7086693153844
cycle= 6 E= -507.972990467095  delta_E= -2.27e-13  |g|= 7.32e-09  |ddm|= 4.66e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6816597824795  E_coul = 198.7086693153844
  HOMO = -0.242231065405961  LUMO = 1.11632994538388
  mo_energy =
[-1.20318489e+02 -1.23778926e+01 -6.67678771e+00 -6.67678771e+00
 -6.67678771e+00 -1.17872257e+00 -2.42231065e-01 -2.42231065e-01
 -2.42231065e-01  1.11632995e+00  1.29469254e+01  1.12960744e+02
  6.07133700e+02  2.74641233e+03  1.22252875e+04  4.08466537e+04
  1.04890226e+05  2.30073625e+05  4.55888534e+05  8.44840770e+05
  1.52801801e+06  2.85028539e+06  5.80817264e+06]
E1 = -706.681659801306  E_coul = 198.7086693342114
Extra cycle  E= -507.972990467095  delta_E= 5.68e-13  |g|= 2.05e-09  |ddm|= 1.23e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.57247170e-01 1.17616814e+05 6.49366604e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347526e+03 1.83758102e+04 1.44974832e+03
 3.74027445e+02 1.13242871e+02 3.78346880e+01 8.22930261e+00
 3.29868258e+00 8.60391508e+00 4.92895051e-01]
E = -507.9729904670945
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.257247169508       1
[INPUT] 0    0    [1    /1   ]  117616.814242        1
[INPUT] 0    0    [1    /1   ]  0.649366603953       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.42097          1
[INPUT] 0    0    [1    /1   ]  36754.7200378        1
[INPUT] 0    0    [1    /1   ]  7303.47526221        1
[INPUT] 0    0    [1    /1   ]  18375.8101942        1
[INPUT] 0    0    [1    /1   ]  1449.74832016        1
[INPUT] 0    0    [1    /1   ]  374.027444699        1
[INPUT] 0    0    [1    /1   ]  113.242871436        1
[INPUT] 0    0    [1    /1   ]  37.8346879634        1
[INPUT] 0    0    [1    /1   ]  8.22930260907        1
[INPUT] 0    0    [1    /1   ]  3.29868257758        1
[INPUT] 1    0    [1    /1   ]  8.60391507876        1
[INPUT] 1    0    [1    /1   ]  0.492895050759       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.25724716950773885, 1.0]], [0, [117616.81424158305, 1.0]], [0, [0.6493666039530488, 1.0]], [0, [1176168.1426188867, 1.0]], [0, [588084.0699925581, 1.0]], [0, [294042.0311318475, 1.0]], [0, [147020.99214764452, 1.0]], [0, [73510.42096999093, 1.0]], [0, [36754.72003779658, 1.0]], [0, [7303.475262207703, 1.0]], [0, [18375.81019419853, 1.0]], [0, [1449.7483201555747, 1.0]], [0, [374.02744469937215, 1.0]], [0, [113.24287143611616, 1.0]], [0, [37.83468796335538, 1.0]], [0, [8.229302609069439, 1.0]], [0, [3.2986825775767747, 1.0]], [1, [8.603915078757502, 1.0]], [1, [0.49289505075946194, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25724717]
bas 1, expnt(s) = [117616.81424158]
bas 2, expnt(s) = [0.6493666]
bas 3, expnt(s) = [1176168.14261889]
bas 4, expnt(s) = [588084.06999256]
bas 5, expnt(s) = [294042.03113185]
bas 6, expnt(s) = [147020.99214764]
bas 7, expnt(s) = [73510.42096999]
bas 8, expnt(s) = [36754.7200378]
bas 9, expnt(s) = [7303.47526221]
bas 10, expnt(s) = [18375.8101942]
bas 11, expnt(s) = [1449.74832016]
bas 12, expnt(s) = [374.0274447]
bas 13, expnt(s) = [113.24287144]
bas 14, expnt(s) = [37.83468796]
bas 15, expnt(s) = [8.22930261]
bas 16, expnt(s) = [3.29868258]
bas 17, expnt(s) = [8.60391508]
bas 18, expnt(s) = [0.49289505]
CPU time:       105.34
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.57247170e-01 9.12594775e-01 1.17616814e+05 1.60460109e+04
 6.49366604e-01 1.82760563e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347526e+03 1.99600763e+03
 1.83758102e+04 3.98749266e+03 1.44974832e+03 5.93587142e+02
 3.74027445e+02 2.14878333e+02 1.13242871e+02 8.77047629e+01
 3.78346880e+01 3.85418575e+01 8.22930261e+00 1.22754465e+01
 3.29868258e+00 6.18401336e+00 8.60391508e+00 4.29887222e+01
 4.92895051e-01 1.20483469e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335428665313476
cond(S) = 907740.1230941078
E1 = -689.5700664308497  E_coul = 184.96826549957717
init E= -504.601800931273
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672199098416478  LUMO = 0.725447689193723
  mo_energy =
[-1.21703724e+02 -1.33846530e+01 -7.62390314e+00 -7.62390314e+00
 -7.62390314e+00 -1.65732251e+00 -6.72199098e-01 -6.72199098e-01
 -6.72199098e-01  7.25447689e-01  1.20673446e+01  1.11665600e+02
  6.05766640e+02  2.74512317e+03  1.22241180e+04  4.08455546e+04
  1.04889165e+05  2.30072590e+05  4.55887516e+05  8.44839766e+05
  1.52801702e+06  2.85028440e+06  5.80817166e+06]
E1 = -707.734749606098  E_coul = 199.77935283288957
cycle= 1 E= -507.955396773208  delta_E= -3.35  |g|= 0.449  |ddm|= 0.516
    CPU time for cycle= 1      0.18 sec, wall time      0.01 sec
diis-norm(errvec)=0.625721
diis-c [-0.39152652  1.        ]
  HOMO = -0.217267829609317  LUMO = 1.12372805625575
  mo_energy =
[-1.20194243e+02 -1.23032598e+01 -6.59457640e+00 -6.59457640e+00
 -6.59457640e+00 -1.16277725e+00 -2.17267830e-01 -2.17267830e-01
 -2.17267830e-01  1.12372806e+00  1.30041724e+01  1.13065114e+02
  6.07262070e+02  2.74655750e+03  1.22254432e+04  4.08468134e+04
  1.04890387e+05  2.30073787e+05  4.55888696e+05  8.44840933e+05
  1.52801818e+06  2.85028555e+06  5.80817280e+06]
E1 = -706.802503623759  E_coul = 198.8297704107349
cycle= 2 E= -507.972733213024  delta_E= -0.0173  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0259084
diis-c [-6.68687665e-04  2.55271660e-03  9.97447283e-01]
  HOMO = -0.238948961093165  LUMO = 1.11751521255481
  mo_energy =
[-1.20306087e+02 -1.23688871e+01 -6.66727390e+00 -6.66727390e+00
 -6.66727390e+00 -1.17673583e+00 -2.38948961e-01 -2.38948961e-01
 -2.38948961e-01  1.11751521e+00  1.29541263e+01  1.12971817e+02
  6.07146275e+02  2.74642579e+03  1.22253014e+04  4.08466679e+04
  1.04890240e+05  2.30073640e+05  4.55888548e+05  8.44840785e+05
  1.52801803e+06  2.85028540e+06  5.80817265e+06]
E1 = -706.697419130403  E_coul = 198.72443342990476
cycle= 3 E= -507.972985700498  delta_E= -0.000252  |g|= 0.0044  |ddm|= 0.0608
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00296383
diis-c [-1.59295665e-06 -1.84853651e-04 -1.15636242e-01  1.11582110e+00]
  HOMO = -0.242120961418562  LUMO = 1.11637589815371
  mo_energy =
[-1.20318236e+02 -1.23776271e+01 -6.67652825e+00 -6.67652825e+00
 -6.67652825e+00 -1.17865767e+00 -2.42120961e-01 -2.42120961e-01
 -2.42120961e-01  1.11637590e+00  1.29471500e+01  1.12960999e+02
  6.07133952e+02  2.74641258e+03  1.22252877e+04  4.08466540e+04
  1.04890226e+05  2.30073626e+05  4.55888534e+05  8.44840771e+05
  1.52801801e+06  2.85028539e+06  5.80817264e+06]
E1 = -706.682182235293  E_coul = 198.7091917743361
cycle= 4 E= -507.972990460957  delta_E= -4.76e-06  |g|= 0.000165  |ddm|= 0.00946
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000111809
diis-c [-6.90161969e-11 -5.58955577e-06  7.44303837e-03 -9.23055694e-02
  1.08486812e+00]
  HOMO = -0.242230934020733  LUMO = 1.11632982258116
  mo_energy =
[-1.20318488e+02 -1.23778922e+01 -6.67678719e+00 -6.67678719e+00
 -6.67678719e+00 -1.17872236e+00 -2.42230934e-01 -2.42230934e-01
 -2.42230934e-01  1.11632982e+00  1.29469257e+01  1.12960744e+02
  6.07133701e+02  2.74641233e+03  1.22252875e+04  4.08466537e+04
  1.04890226e+05  2.30073625e+05  4.55888534e+05  8.44840770e+05
  1.52801801e+06  2.85028539e+06  5.80817264e+06]
E1 = -706.6816606507689  E_coul = 198.70867018367403
cycle= 5 E= -507.972990467095  delta_E= -6.14e-09  |g|= 2.89e-07  |ddm|= 0.000358
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.81431e-07
diis-c [-6.28022071e-15  1.68509183e-07 -8.38666287e-05  9.12656574e-04
 -1.03546558e-02  1.00952570e+00]
  HOMO = -0.242231068785959  LUMO = 1.11632994427941
  mo_energy =
[-1.20318489e+02 -1.23778927e+01 -6.67678772e+00 -6.67678772e+00
 -6.67678772e+00 -1.17872257e+00 -2.42231069e-01 -2.42231069e-01
 -2.42231069e-01  1.11632994e+00  1.29469254e+01  1.12960744e+02
  6.07133700e+02  2.74641233e+03  1.22252875e+04  4.08466537e+04
  1.04890226e+05  2.30073625e+05  4.55888534e+05  8.44840770e+05
  1.52801801e+06  2.85028539e+06  5.80817264e+06]
E1 = -706.6816597824795  E_coul = 198.7086693153844
cycle= 6 E= -507.972990467095  delta_E= -2.27e-13  |g|= 7.32e-09  |ddm|= 4.66e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6816597824795  E_coul = 198.7086693153844
  HOMO = -0.242231065405961  LUMO = 1.11632994538388
  mo_energy =
[-1.20318489e+02 -1.23778926e+01 -6.67678771e+00 -6.67678771e+00
 -6.67678771e+00 -1.17872257e+00 -2.42231065e-01 -2.42231065e-01
 -2.42231065e-01  1.11632995e+00  1.29469254e+01  1.12960744e+02
  6.07133700e+02  2.74641233e+03  1.22252875e+04  4.08466537e+04
  1.04890226e+05  2.30073625e+05  4.55888534e+05  8.44840770e+05
  1.52801801e+06  2.85028539e+06  5.80817264e+06]
E1 = -706.681659801306  E_coul = 198.7086693342114
Extra cycle  E= -507.972990467095  delta_E= 5.68e-13  |g|= 2.05e-09  |ddm|= 1.23e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907740.1230941078
E1 = -706.681659801306  E_coul = 198.7086693342114
init E= -507.972990467095
    CPU time for initialize scf      1.48 sec, wall time      0.09 sec
  HOMO = -0.242231064887437  LUMO = 1.1163299428808
  mo_energy =
[-1.20318489e+02 -1.23778926e+01 -6.67678771e+00 -6.67678771e+00
 -6.67678771e+00 -1.17872257e+00 -2.42231065e-01 -2.42231065e-01
 -2.42231065e-01  1.11632994e+00  1.29469254e+01  1.12960744e+02
  6.07133700e+02  2.74641233e+03  1.22252875e+04  4.08466537e+04
  1.04890226e+05  2.30073625e+05  4.55888534e+05  8.44840770e+05
  1.52801801e+06  2.85028539e+06  5.80817264e+06]
E1 = -706.6816598059833  E_coul = 198.70866933888834
cycle= 1 E= -507.972990467095  delta_E= -3.98e-13  |g|= 1.14e-09  |ddm|= 3.07e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6816598059833  E_coul = 198.70866933888834
  HOMO = -0.242231064748951  LUMO = 1.1163299467378
  mo_energy =
[-1.20318489e+02 -1.23778926e+01 -6.67678771e+00 -6.67678771e+00
 -6.67678771e+00 -1.17872257e+00 -2.42231065e-01 -2.42231065e-01
 -2.42231065e-01  1.11632995e+00  1.29469254e+01  1.12960744e+02
  6.07133700e+02  2.74641233e+03  1.22252875e+04  4.08466537e+04
  1.04890226e+05  2.30073625e+05  4.55888534e+05  8.44840770e+05
  1.52801801e+06  2.85028539e+06  5.80817264e+06]
E1 = -706.6816598035007  E_coul = 198.70866933640607
Extra cycle  E= -507.972990467095  delta_E= 2.84e-13  |g|= 2.29e-09  |ddm|= 1.74e-09
    CPU time for scf_cycle      1.65 sec, wall time      0.16 sec
exp = [2.57247170e-01 1.17616814e+05 6.49366604e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347526e+03 1.83758102e+04 1.44974832e+03
 3.74027445e+02 1.13242871e+02 3.78346880e+01 8.22930261e+00
 3.29868258e+00 8.60391508e+00 4.92895051e-01]
grad_E = [ 7.08373578e-03  4.19761775e-09 -3.86257699e-03  1.89415397e-11
  1.13267311e-10  6.53075313e-10  2.56129749e-09  1.06414180e-08
  5.72287899e-08  3.60193736e-06  1.23220563e-07  4.28656265e-06
  6.33613070e-06 -6.23296710e-05 -1.41286361e-04 -5.11764349e-06
 -1.92785906e-03 -1.80902842e-04  9.60821216e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.259013360295       1
[INPUT] 0    0    [1    /1   ]  117616.814241        1
[INPUT] 0    0    [1    /1   ]  0.65273852396        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992147        1
[INPUT] 0    0    [1    /1   ]  73510.4209688        1
[INPUT] 0    0    [1    /1   ]  36754.7200313        1
[INPUT] 0    0    [1    /1   ]  7303.47485238        1
[INPUT] 0    0    [1    /1   ]  18375.8101802        1
[INPUT] 0    0    [1    /1   ]  1449.74766043        1
[INPUT] 0    0    [1    /1   ]  374.029221327        1
[INPUT] 0    0    [1    /1   ]  113.232147575        1
[INPUT] 0    0    [1    /1   ]  37.8971203131        1
[INPUT] 0    0    [1    /1   ]  8.32833246064        1
[INPUT] 0    0    [1    /1   ]  3.33661254404        1
[INPUT] 1    0    [1    /1   ]  8.60381618799        1
[INPUT] 1    0    [1    /1   ]  0.492840529241       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2590133602950375, 1.0]], [0, [117616.8142411052, 1.0]], [0, [0.6527385239596666, 1.0]], [0, [1176168.1426188846, 1.0]], [0, [588084.0699925452, 1.0]], [0, [294042.0311317732, 1.0]], [0, [147020.99214735295, 1.0]], [0, [73510.42096877973, 1.0]], [0, [36754.720031279336, 1.0]], [0, [7303.474852381589, 1.0]], [0, [18375.810180200613, 1.0]], [0, [1449.7476604271706, 1.0]], [0, [374.0292213266155, 1.0]], [0, [113.23214757547, 1.0]], [0, [37.89712031305115, 1.0]], [0, [8.32833246064115, 1.0]], [0, [3.3366125440435943, 1.0]], [1, [8.60381618798574, 1.0]], [1, [0.49284052924136984, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25901336]
bas 1, expnt(s) = [117616.81424111]
bas 2, expnt(s) = [0.65273852]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999255]
bas 5, expnt(s) = [294042.03113177]
bas 6, expnt(s) = [147020.99214735]
bas 7, expnt(s) = [73510.42096878]
bas 8, expnt(s) = [36754.72003128]
bas 9, expnt(s) = [7303.47485238]
bas 10, expnt(s) = [18375.8101802]
bas 11, expnt(s) = [1449.74766043]
bas 12, expnt(s) = [374.02922133]
bas 13, expnt(s) = [113.23214758]
bas 14, expnt(s) = [37.89712031]
bas 15, expnt(s) = [8.32833246]
bas 16, expnt(s) = [3.33661254]
bas 17, expnt(s) = [8.60381619]
bas 18, expnt(s) = [0.49284053]
CPU time:       110.22
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.59013360e-01 9.17289979e-01 1.17616814e+05 1.60460109e+04
 6.52738524e-01 1.83471858e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347485e+03 1.99600754e+03
 1.83758102e+04 3.98749266e+03 1.44974766e+03 5.93586939e+02
 3.74029221e+02 2.14879099e+02 1.13232148e+02 8.76985338e+01
 3.78971203e+01 3.85895471e+01 8.32833246e+00 1.23860710e+01
 3.33661254e+00 6.23726732e+00 8.60381619e+00 4.29881046e+01
 4.92840529e-01 1.20466810e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335460695420547
cond(S) = 907747.8868083067
E1 = -689.5678244473249  E_coul = 184.96646707715888
init E= -504.601357370166
    CPU time for initialize scf      0.19 sec, wall time      0.03 sec
  HOMO = -0.672257747455496  LUMO = 0.735848413215218
  mo_energy =
[-1.21704049e+02 -1.33847460e+01 -7.62399734e+00 -7.62399734e+00
 -7.62399734e+00 -1.65741136e+00 -6.72257747e-01 -6.72257747e-01
 -6.72257747e-01  7.35848413e-01  1.22980711e+01  1.12360519e+02
  6.06515942e+02  2.74579232e+03  1.22247022e+04  4.08460944e+04
  1.04889682e+05  2.30073092e+05  4.55888007e+05  8.44840249e+05
  1.52801750e+06  2.85028487e+06  5.80817212e+06]
E1 = -707.7353383523864  E_coul = 199.7798891835158
cycle= 1 E= -507.955449168871  delta_E= -3.35  |g|= 0.449  |ddm|= 0.516
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625741
diis-c [-0.39155181  1.        ]
  HOMO = -0.217357148550157  LUMO = 1.1361798363114
  mo_energy =
[-1.20194048e+02 -1.23032022e+01 -6.59446906e+00 -6.59446906e+00
 -6.59446906e+00 -1.16284495e+00 -2.17357149e-01 -2.17357149e-01
 -2.17357149e-01  1.13617984e+00  1.32399848e+01  1.13760705e+02
  6.08011882e+02  2.74722726e+03  1.22260281e+04  4.08473539e+04
  1.04890905e+05  2.30074290e+05  4.55889189e+05  8.44841417e+05
  1.52801865e+06  2.85028602e+06  5.80817326e+06]
E1 = -706.8029304488481  E_coul = 198.83013978462847
cycle= 2 E= -507.97279066422  delta_E= -0.0173  |g|= 0.0344  |ddm|= 0.448
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258511
diis-c [-6.65562186e-04  2.63060132e-03  9.97369399e-01]
  HOMO = -0.239039171418701  LUMO = 1.12986901006908
  mo_energy =
[-1.20305890e+02 -1.23688443e+01 -6.66717553e+00 -6.66717553e+00
 -6.66717553e+00 -1.17680605e+00 -2.39039171e-01 -2.39039171e-01
 -2.39039171e-01  1.12986901e+00  1.31895282e+01  1.13667348e+02
  6.07896093e+02  2.74709555e+03  1.22258864e+04  4.08472084e+04
  1.04890758e+05  2.30074143e+05  4.55889041e+05  8.44841269e+05
  1.52801850e+06  2.85028587e+06  5.80817311e+06]
E1 = -706.6980450616999  E_coul = 198.7250029645127
cycle= 3 E= -507.973042097187  delta_E= -0.000251  |g|= 0.00439  |ddm|= 0.0607
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00295008
diis-c [-1.57861408e-06 -1.83944082e-04 -1.15328824e-01  1.11551277e+00]
  HOMO = -0.242202053965375  LUMO = 1.12871903697094
  mo_energy =
[-1.20318028e+02 -1.23775727e+01 -6.67641815e+00 -6.67641815e+00
 -6.67641815e+00 -1.17872215e+00 -2.42202054e-01 -2.42202054e-01
 -2.42202054e-01  1.12871904e+00  1.31825204e+01  1.13656538e+02
  6.07883781e+02  2.74708236e+03  1.22258727e+04  4.08471945e+04
  1.04890744e+05  2.30074129e+05  4.55889027e+05  8.44841255e+05
  1.52801849e+06  2.85028585e+06  5.80817309e+06]
E1 = -706.6828792384521  E_coul = 198.70983243115853
cycle= 4 E= -507.973046807294  delta_E= -4.71e-06  |g|= 0.000164  |ddm|= 0.0094
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000111
diis-c [-6.91331879e-11 -5.48391260e-06  7.42366091e-03 -9.21459649e-02
  1.08472779e+00]
  HOMO = -0.242311001904934  LUMO = 1.12867295825222
  mo_energy =
[-1.20318279e+02 -1.23778363e+01 -6.67667581e+00 -6.67667581e+00
 -6.67667581e+00 -1.17878619e+00 -2.42311002e-01 -2.42311002e-01
 -2.42311002e-01  1.12867296e+00  1.31822967e+01  1.13656283e+02
  6.07883531e+02  2.74708211e+03  1.22258724e+04  4.08471943e+04
  1.04890744e+05  2.30074128e+05  4.55889026e+05  8.44841255e+05
  1.52801849e+06  2.85028585e+06  5.80817309e+06]
E1 = -706.6823634075753  E_coul = 198.70931659430175
cycle= 5 E= -507.973046813274  delta_E= -5.98e-09  |g|= 2.68e-07  |ddm|= 0.000352
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.71445e-07
diis-c [-8.01944392e-15  1.69841404e-07 -8.65294980e-05  9.51835773e-04
 -1.06835996e-02  1.00981812e+00]
  HOMO = -0.242311100342117  LUMO = 1.12867309141538
  mo_energy =
[-1.20318280e+02 -1.23778367e+01 -6.67667625e+00 -6.67667625e+00
 -6.67667625e+00 -1.17878638e+00 -2.42311100e-01 -2.42311100e-01
 -2.42311100e-01  1.12867309e+00  1.31822965e+01  1.13656283e+02
  6.07883530e+02  2.74708211e+03  1.22258724e+04  4.08471943e+04
  1.04890744e+05  2.30074128e+05  4.55889026e+05  8.44841255e+05
  1.52801849e+06  2.85028585e+06  5.80817309e+06]
E1 = -706.6823627261965  E_coul = 198.70931591292356
cycle= 6 E= -507.973046813273  delta_E= 5.68e-13  |g|= 9.33e-09  |ddm|= 3.39e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6823627261965  E_coul = 198.70931591292356
  HOMO = -0.242311095489519  LUMO = 1.1286730918063
  mo_energy =
[-1.20318280e+02 -1.23778367e+01 -6.67667624e+00 -6.67667624e+00
 -6.67667624e+00 -1.17878638e+00 -2.42311095e-01 -2.42311095e-01
 -2.42311095e-01  1.12867309e+00  1.31822965e+01  1.13656283e+02
  6.07883530e+02  2.74708211e+03  1.22258724e+04  4.08471943e+04
  1.04890744e+05  2.30074128e+05  4.55889026e+05  8.44841255e+05
  1.52801849e+06  2.85028585e+06  5.80817309e+06]
E1 = -706.6823627528252  E_coul = 198.7093159395519
Extra cycle  E= -507.973046813273  delta_E= -2.84e-13  |g|= 1.26e-09  |ddm|= 1.77e-08
    CPU time for scf_cycle      0.47 sec, wall time      0.12 sec
exp = [2.59013360e-01 1.17616814e+05 6.52738524e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347485e+03 1.83758102e+04 1.44974766e+03
 3.74029221e+02 1.13232148e+02 3.78971203e+01 8.32833246e+00
 3.33661254e+00 8.60381619e+00 4.92840529e-01]
E = -507.97304681327324
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.259013360295       1
[INPUT] 0    0    [1    /1   ]  117616.814241        1
[INPUT] 0    0    [1    /1   ]  0.65273852396        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992147        1
[INPUT] 0    0    [1    /1   ]  73510.4209688        1
[INPUT] 0    0    [1    /1   ]  36754.7200313        1
[INPUT] 0    0    [1    /1   ]  7303.47485238        1
[INPUT] 0    0    [1    /1   ]  18375.8101802        1
[INPUT] 0    0    [1    /1   ]  1449.74766043        1
[INPUT] 0    0    [1    /1   ]  374.029221327        1
[INPUT] 0    0    [1    /1   ]  113.232147575        1
[INPUT] 0    0    [1    /1   ]  37.8971203131        1
[INPUT] 0    0    [1    /1   ]  8.32833246064        1
[INPUT] 0    0    [1    /1   ]  3.33661254404        1
[INPUT] 1    0    [1    /1   ]  8.60381618799        1
[INPUT] 1    0    [1    /1   ]  0.492840529241       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2590133602950375, 1.0]], [0, [117616.8142411052, 1.0]], [0, [0.6527385239596666, 1.0]], [0, [1176168.1426188846, 1.0]], [0, [588084.0699925452, 1.0]], [0, [294042.0311317732, 1.0]], [0, [147020.99214735295, 1.0]], [0, [73510.42096877973, 1.0]], [0, [36754.720031279336, 1.0]], [0, [7303.474852381589, 1.0]], [0, [18375.810180200613, 1.0]], [0, [1449.7476604271706, 1.0]], [0, [374.0292213266155, 1.0]], [0, [113.23214757547, 1.0]], [0, [37.89712031305115, 1.0]], [0, [8.32833246064115, 1.0]], [0, [3.3366125440435943, 1.0]], [1, [8.60381618798574, 1.0]], [1, [0.49284052924136984, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25901336]
bas 1, expnt(s) = [117616.81424111]
bas 2, expnt(s) = [0.65273852]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999255]
bas 5, expnt(s) = [294042.03113177]
bas 6, expnt(s) = [147020.99214735]
bas 7, expnt(s) = [73510.42096878]
bas 8, expnt(s) = [36754.72003128]
bas 9, expnt(s) = [7303.47485238]
bas 10, expnt(s) = [18375.8101802]
bas 11, expnt(s) = [1449.74766043]
bas 12, expnt(s) = [374.02922133]
bas 13, expnt(s) = [113.23214758]
bas 14, expnt(s) = [37.89712031]
bas 15, expnt(s) = [8.32833246]
bas 16, expnt(s) = [3.33661254]
bas 17, expnt(s) = [8.60381619]
bas 18, expnt(s) = [0.49284053]
CPU time:       110.80
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.59013360e-01 9.17289979e-01 1.17616814e+05 1.60460109e+04
 6.52738524e-01 1.83471858e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347485e+03 1.99600754e+03
 1.83758102e+04 3.98749266e+03 1.44974766e+03 5.93586939e+02
 3.74029221e+02 2.14879099e+02 1.13232148e+02 8.76985338e+01
 3.78971203e+01 3.85895471e+01 8.32833246e+00 1.23860710e+01
 3.33661254e+00 6.23726732e+00 8.60381619e+00 4.29881046e+01
 4.92840529e-01 1.20466810e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335460695420547
cond(S) = 907747.8868083067
E1 = -689.5678244473249  E_coul = 184.96646707715888
init E= -504.601357370166
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.672257747455496  LUMO = 0.735848413215218
  mo_energy =
[-1.21704049e+02 -1.33847460e+01 -7.62399734e+00 -7.62399734e+00
 -7.62399734e+00 -1.65741136e+00 -6.72257747e-01 -6.72257747e-01
 -6.72257747e-01  7.35848413e-01  1.22980711e+01  1.12360519e+02
  6.06515942e+02  2.74579232e+03  1.22247022e+04  4.08460944e+04
  1.04889682e+05  2.30073092e+05  4.55888007e+05  8.44840249e+05
  1.52801750e+06  2.85028487e+06  5.80817212e+06]
E1 = -707.7353383523864  E_coul = 199.7798891835158
cycle= 1 E= -507.955449168871  delta_E= -3.35  |g|= 0.449  |ddm|= 0.516
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625741
diis-c [-0.39155181  1.        ]
  HOMO = -0.217357148550157  LUMO = 1.1361798363114
  mo_energy =
[-1.20194048e+02 -1.23032022e+01 -6.59446906e+00 -6.59446906e+00
 -6.59446906e+00 -1.16284495e+00 -2.17357149e-01 -2.17357149e-01
 -2.17357149e-01  1.13617984e+00  1.32399848e+01  1.13760705e+02
  6.08011882e+02  2.74722726e+03  1.22260281e+04  4.08473539e+04
  1.04890905e+05  2.30074290e+05  4.55889189e+05  8.44841417e+05
  1.52801865e+06  2.85028602e+06  5.80817326e+06]
E1 = -706.8029304488481  E_coul = 198.83013978462847
cycle= 2 E= -507.97279066422  delta_E= -0.0173  |g|= 0.0344  |ddm|= 0.448
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258511
diis-c [-6.65562186e-04  2.63060132e-03  9.97369399e-01]
  HOMO = -0.239039171418701  LUMO = 1.12986901006908
  mo_energy =
[-1.20305890e+02 -1.23688443e+01 -6.66717553e+00 -6.66717553e+00
 -6.66717553e+00 -1.17680605e+00 -2.39039171e-01 -2.39039171e-01
 -2.39039171e-01  1.12986901e+00  1.31895282e+01  1.13667348e+02
  6.07896093e+02  2.74709555e+03  1.22258864e+04  4.08472084e+04
  1.04890758e+05  2.30074143e+05  4.55889041e+05  8.44841269e+05
  1.52801850e+06  2.85028587e+06  5.80817311e+06]
E1 = -706.6980450616999  E_coul = 198.7250029645127
cycle= 3 E= -507.973042097187  delta_E= -0.000251  |g|= 0.00439  |ddm|= 0.0607
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00295008
diis-c [-1.57861408e-06 -1.83944082e-04 -1.15328824e-01  1.11551277e+00]
  HOMO = -0.242202053965375  LUMO = 1.12871903697094
  mo_energy =
[-1.20318028e+02 -1.23775727e+01 -6.67641815e+00 -6.67641815e+00
 -6.67641815e+00 -1.17872215e+00 -2.42202054e-01 -2.42202054e-01
 -2.42202054e-01  1.12871904e+00  1.31825204e+01  1.13656538e+02
  6.07883781e+02  2.74708236e+03  1.22258727e+04  4.08471945e+04
  1.04890744e+05  2.30074129e+05  4.55889027e+05  8.44841255e+05
  1.52801849e+06  2.85028585e+06  5.80817309e+06]
E1 = -706.6828792384521  E_coul = 198.70983243115853
cycle= 4 E= -507.973046807294  delta_E= -4.71e-06  |g|= 0.000164  |ddm|= 0.0094
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000111
diis-c [-6.91331879e-11 -5.48391260e-06  7.42366091e-03 -9.21459649e-02
  1.08472779e+00]
  HOMO = -0.242311001904934  LUMO = 1.12867295825222
  mo_energy =
[-1.20318279e+02 -1.23778363e+01 -6.67667581e+00 -6.67667581e+00
 -6.67667581e+00 -1.17878619e+00 -2.42311002e-01 -2.42311002e-01
 -2.42311002e-01  1.12867296e+00  1.31822967e+01  1.13656283e+02
  6.07883531e+02  2.74708211e+03  1.22258724e+04  4.08471943e+04
  1.04890744e+05  2.30074128e+05  4.55889026e+05  8.44841255e+05
  1.52801849e+06  2.85028585e+06  5.80817309e+06]
E1 = -706.6823634075753  E_coul = 198.70931659430175
cycle= 5 E= -507.973046813274  delta_E= -5.98e-09  |g|= 2.68e-07  |ddm|= 0.000352
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.71445e-07
diis-c [-8.01944392e-15  1.69841404e-07 -8.65294980e-05  9.51835773e-04
 -1.06835996e-02  1.00981812e+00]
  HOMO = -0.242311100342117  LUMO = 1.12867309141538
  mo_energy =
[-1.20318280e+02 -1.23778367e+01 -6.67667625e+00 -6.67667625e+00
 -6.67667625e+00 -1.17878638e+00 -2.42311100e-01 -2.42311100e-01
 -2.42311100e-01  1.12867309e+00  1.31822965e+01  1.13656283e+02
  6.07883530e+02  2.74708211e+03  1.22258724e+04  4.08471943e+04
  1.04890744e+05  2.30074128e+05  4.55889026e+05  8.44841255e+05
  1.52801849e+06  2.85028585e+06  5.80817309e+06]
E1 = -706.6823627261965  E_coul = 198.70931591292356
cycle= 6 E= -507.973046813273  delta_E= 5.68e-13  |g|= 9.33e-09  |ddm|= 3.39e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6823627261965  E_coul = 198.70931591292356
  HOMO = -0.242311095489519  LUMO = 1.1286730918063
  mo_energy =
[-1.20318280e+02 -1.23778367e+01 -6.67667624e+00 -6.67667624e+00
 -6.67667624e+00 -1.17878638e+00 -2.42311095e-01 -2.42311095e-01
 -2.42311095e-01  1.12867309e+00  1.31822965e+01  1.13656283e+02
  6.07883530e+02  2.74708211e+03  1.22258724e+04  4.08471943e+04
  1.04890744e+05  2.30074128e+05  4.55889026e+05  8.44841255e+05
  1.52801849e+06  2.85028585e+06  5.80817309e+06]
E1 = -706.6823627528252  E_coul = 198.7093159395519
Extra cycle  E= -507.973046813273  delta_E= -2.84e-13  |g|= 1.26e-09  |ddm|= 1.77e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907747.8868083067
E1 = -706.6823627528252  E_coul = 198.7093159395519
init E= -507.973046813273
    CPU time for initialize scf      1.48 sec, wall time      0.09 sec
  HOMO = -0.242311094745362  LUMO = 1.12867309286277
  mo_energy =
[-1.20318280e+02 -1.23778367e+01 -6.67667624e+00 -6.67667624e+00
 -6.67667624e+00 -1.17878638e+00 -2.42311095e-01 -2.42311095e-01
 -2.42311095e-01  1.12867309e+00  1.31822965e+01  1.13656283e+02
  6.07883530e+02  2.74708211e+03  1.22258724e+04  4.08471943e+04
  1.04890744e+05  2.30074128e+05  4.55889026e+05  8.44841255e+05
  1.52801849e+06  2.85028585e+06  5.80817309e+06]
E1 = -706.6823627543955  E_coul = 198.70931594112213
cycle= 1 E= -507.973046813273  delta_E= -1.71e-13  |g|= 1.38e-09  |ddm|= 1.1e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6823627543955  E_coul = 198.70931594112213
  HOMO = -0.242311094696429  LUMO = 1.12867309174386
  mo_energy =
[-1.20318280e+02 -1.23778367e+01 -6.67667624e+00 -6.67667624e+00
 -6.67667624e+00 -1.17878638e+00 -2.42311095e-01 -2.42311095e-01
 -2.42311095e-01  1.12867309e+00  1.31822965e+01  1.13656283e+02
  6.07883530e+02  2.74708211e+03  1.22258724e+04  4.08471943e+04
  1.04890744e+05  2.30074128e+05  4.55889026e+05  8.44841255e+05
  1.52801849e+06  2.85028585e+06  5.80817309e+06]
E1 = -706.6823627553756  E_coul = 198.70931594210225
Extra cycle  E= -507.973046813273  delta_E= 5.68e-14  |g|= 1.83e-09  |ddm|= 6.72e-10
    CPU time for scf_cycle      1.65 sec, wall time      0.16 sec
exp = [2.59013360e-01 1.17616814e+05 6.52738524e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347485e+03 1.83758102e+04 1.44974766e+03
 3.74029221e+02 1.13232148e+02 3.78971203e+01 8.32833246e+00
 3.33661254e+00 8.60381619e+00 4.92840529e-01]
grad_E = [ 5.94142028e-03  4.21784475e-09 -3.31062365e-03  1.91819809e-11
  1.13923407e-10  6.56207574e-10  2.57379623e-09  1.06940933e-08
  5.74888495e-08  3.62059717e-06  1.24007843e-07  3.20371730e-06
  2.22566487e-05 -1.68859095e-04  8.32627126e-05  8.10213951e-05
 -1.16223895e-03 -1.29696985e-04  8.37784371e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:28 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.261430644152       1
[INPUT] 0    0    [1    /1   ]  117616.814241        1
[INPUT] 0    0    [1    /1   ]  0.661927584526       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992147        1
[INPUT] 0    0    [1    /1   ]  73510.4209682        1
[INPUT] 0    0    [1    /1   ]  36754.720028         1
[INPUT] 0    0    [1    /1   ]  7303.47464866        1
[INPUT] 0    0    [1    /1   ]  18375.8101732        1
[INPUT] 0    0    [1    /1   ]  1449.74733548        1
[INPUT] 0    0    [1    /1   ]  374.030060388        1
[INPUT] 0    0    [1    /1   ]  113.227135206        1
[INPUT] 0    0    [1    /1   ]  37.9272712882        1
[INPUT] 0    0    [1    /1   ]  8.37624507015        1
[INPUT] 0    0    [1    /1   ]  3.35775217018        1
[INPUT] 1    0    [1    /1   ]  8.60367540634        1
[INPUT] 1    0    [1    /1   ]  0.49268205308        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26143064415167844, 1.0]], [0, [117616.81424086766, 1.0]], [0, [0.6619275845263408, 1.0]], [0, [1176168.1426188834, 1.0]], [0, [588084.0699925388, 1.0]], [0, [294042.03113173624, 1.0]], [0, [147020.99214720802, 1.0]], [0, [73510.42096817764, 1.0]], [0, [36754.72002803971, 1.0]], [0, [7303.474648656817, 1.0]], [0, [18375.810173241847, 1.0]], [0, [1449.7473354833012, 1.0]], [0, [374.0300603877657, 1.0]], [0, [113.22713520592296, 1.0]], [0, [37.927271288166445, 1.0]], [0, [8.37624507014647, 1.0]], [0, [3.357752170179416, 1.0]], [1, [8.603675406344333, 1.0]], [1, [0.49268205308008556, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26143064]
bas 1, expnt(s) = [117616.81424087]
bas 2, expnt(s) = [0.66192758]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999254]
bas 5, expnt(s) = [294042.03113174]
bas 6, expnt(s) = [147020.99214721]
bas 7, expnt(s) = [73510.42096818]
bas 8, expnt(s) = [36754.72002804]
bas 9, expnt(s) = [7303.47464866]
bas 10, expnt(s) = [18375.81017324]
bas 11, expnt(s) = [1449.74733548]
bas 12, expnt(s) = [374.03006039]
bas 13, expnt(s) = [113.22713521]
bas 14, expnt(s) = [37.92727129]
bas 15, expnt(s) = [8.37624507]
bas 16, expnt(s) = [3.35775217]
bas 17, expnt(s) = [8.60367541]
bas 18, expnt(s) = [0.49268205]
CPU time:       115.67
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61430644e-01 9.23703085e-01 1.17616814e+05 1.60460109e+04
 6.61927585e-01 1.85405616e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347465e+03 1.99600750e+03
 1.83758102e+04 3.98749266e+03 1.44974734e+03 5.93586840e+02
 3.74030060e+02 2.14879460e+02 1.13227135e+02 8.76956222e+01
 3.79272713e+01 3.86125713e+01 8.37624507e+00 1.24394751e+01
 3.35775217e+00 6.26688179e+00 8.60367541e+00 4.29872254e+01
 4.92682053e-01 1.20418391e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335640716027395
cond(S) = 907752.2684323956
E1 = -689.5631967041813  E_coul = 184.96217605650702
init E= -504.601020647674
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.672404669656124  LUMO = 0.754321707953953
  mo_energy =
[-1.21704581e+02 -1.33850802e+01 -7.62422396e+00 -7.62422396e+00
 -7.62422396e+00 -1.65756270e+00 -6.72404670e-01 -6.72404670e-01
 -6.72404670e-01  7.54321708e-01  1.24615443e+01  1.12746256e+02
  6.06919834e+02  2.74615147e+03  1.22250155e+04  4.08463839e+04
  1.04889959e+05  2.30073361e+05  4.55888271e+05  8.44840509e+05
  1.52801775e+06  2.85028512e+06  5.80817236e+06]
E1 = -707.7308450111511  E_coul = 199.77541642758484
cycle= 1 E= -507.955428583566  delta_E= -3.35  |g|= 0.449  |ddm|= 0.513
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625816
diis-c [-0.39164556  1.        ]
  HOMO = -0.217705972905839  LUMO = 1.1579167073703
  mo_energy =
[-1.20194284e+02 -1.23035124e+01 -6.59460676e+00 -6.59460676e+00
 -6.59460676e+00 -1.16308807e+00 -2.17705973e-01 -2.17705973e-01
 -2.17705973e-01  1.15791671e+00  1.34059106e+01  1.14146747e+02
  6.08416053e+02  2.74758677e+03  1.22263419e+04  4.08476438e+04
  1.04891182e+05  2.30074560e+05  4.55889453e+05  8.44841677e+05
  1.52801891e+06  2.85028627e+06  5.80817350e+06]
E1 = -706.7966564705958  E_coul = 198.82384215463625
cycle= 2 E= -507.97281431596  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258315
diis-c [-6.64432701e-04  2.68397952e-03  9.97316020e-01]
  HOMO = -0.239410451808009  LUMO = 1.1514444992007
  mo_energy =
[-1.20306314e+02 -1.23693019e+01 -6.66746804e+00 -6.66746804e+00
 -6.66746804e+00 -1.17706474e+00 -2.39410452e-01 -2.39410452e-01
 -2.39410452e-01  1.15144450e+00  1.33550879e+01  1.14053192e+02
  6.08300076e+02  2.74745486e+03  1.22261999e+04  4.08474981e+04
  1.04891035e+05  2.30074412e+05  4.55889304e+05  8.44841528e+05
  1.52801876e+06  2.85028612e+06  5.80817335e+06]
E1 = -706.6920873903944  E_coul = 198.71902359954817
cycle= 3 E= -507.973063790846  delta_E= -0.000249  |g|= 0.00437  |ddm|= 0.0602
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00293694
diis-c [-1.56278533e-06 -1.80149309e-04 -1.14876353e-01  1.11505650e+00]
  HOMO = -0.242555914940561  LUMO = 1.15027845046272
  mo_energy =
[-1.20318430e+02 -1.23780075e+01 -6.67668828e+00 -6.67668828e+00
 -6.67668828e+00 -1.17896967e+00 -2.42555915e-01 -2.42555915e-01
 -2.42555915e-01  1.15027845e+00  1.33480763e+01  1.14042401e+02
  6.08287786e+02  2.74744169e+03  1.22261862e+04  4.08474842e+04
  1.04891021e+05  2.30074398e+05  4.55889290e+05  8.44841514e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6770637349689  E_coul = 198.70399533206177
cycle= 4 E= -507.973068402907  delta_E= -4.61e-06  |g|= 0.00016  |ddm|= 0.00926
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000109537
diis-c [-6.86778163e-11 -5.38806460e-06  7.37837985e-03 -9.15799027e-02
  1.08420691e+00]
  HOMO = -0.242662397219256  LUMO = 1.15023265121584
  mo_energy =
[-1.20318677e+02 -1.23782662e+01 -6.67694102e+00 -6.67694102e+00
 -6.67694102e+00 -1.17903221e+00 -2.42662397e-01 -2.42662397e-01
 -2.42662397e-01  1.15023265e+00  1.33478567e+01  1.14042152e+02
  6.08287541e+02  2.74744145e+03  1.22261859e+04  4.08474840e+04
  1.04891021e+05  2.30074398e+05  4.55889290e+05  8.44841514e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6765616758776  E_coul = 198.70349326731343
cycle= 5 E= -507.973068408564  delta_E= -5.66e-09  |g|= 2.58e-07  |ddm|= 0.000341
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.63791e-07
diis-c [-9.70795917e-15  1.73190967e-07 -8.81470390e-05  9.77680445e-04
 -1.09389631e-02  1.01004926e+00]
  HOMO = -0.242662464885407  LUMO = 1.15023279475976
  mo_energy =
[-1.20318677e+02 -1.23782665e+01 -6.67694139e+00 -6.67694139e+00
 -6.67694139e+00 -1.17903238e+00 -2.42662465e-01 -2.42662465e-01
 -2.42662465e-01  1.15023279e+00  1.33478565e+01  1.14042152e+02
  6.08287540e+02  2.74744145e+03  1.22261859e+04  4.08474840e+04
  1.04891021e+05  2.30074398e+05  4.55889290e+05  8.44841514e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6765611587963  E_coul = 198.70349275023185
cycle= 6 E= -507.973068408564  delta_E= -3.41e-13  |g|= 1.14e-08  |ddm|= 2.33e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6765611587963  E_coul = 198.70349275023185
  HOMO = -0.2426624588062  LUMO = 1.15023279784092
  mo_energy =
[-1.20318677e+02 -1.23782665e+01 -6.67694138e+00 -6.67694138e+00
 -6.67694138e+00 -1.17903238e+00 -2.42662459e-01 -2.42662459e-01
 -2.42662459e-01  1.15023280e+00  1.33478565e+01  1.14042152e+02
  6.08287540e+02  2.74744145e+03  1.22261859e+04  4.08474840e+04
  1.04891021e+05  2.30074398e+05  4.55889290e+05  8.44841514e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6765611909851  E_coul = 198.70349278242074
Extra cycle  E= -507.973068408564  delta_E= 1.14e-13  |g|= 2.43e-09  |ddm|= 2.12e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.61430644e-01 1.17616814e+05 6.61927585e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347465e+03 1.83758102e+04 1.44974734e+03
 3.74030060e+02 1.13227135e+02 3.79272713e+01 8.37624507e+00
 3.35775217e+00 8.60367541e+00 4.92682053e-01]
E = -507.97306840856436
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:28 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.261430644152       1
[INPUT] 0    0    [1    /1   ]  117616.814241        1
[INPUT] 0    0    [1    /1   ]  0.661927584526       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992147        1
[INPUT] 0    0    [1    /1   ]  73510.4209682        1
[INPUT] 0    0    [1    /1   ]  36754.720028         1
[INPUT] 0    0    [1    /1   ]  7303.47464866        1
[INPUT] 0    0    [1    /1   ]  18375.8101732        1
[INPUT] 0    0    [1    /1   ]  1449.74733548        1
[INPUT] 0    0    [1    /1   ]  374.030060388        1
[INPUT] 0    0    [1    /1   ]  113.227135206        1
[INPUT] 0    0    [1    /1   ]  37.9272712882        1
[INPUT] 0    0    [1    /1   ]  8.37624507015        1
[INPUT] 0    0    [1    /1   ]  3.35775217018        1
[INPUT] 1    0    [1    /1   ]  8.60367540634        1
[INPUT] 1    0    [1    /1   ]  0.49268205308        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26143064415167844, 1.0]], [0, [117616.81424086766, 1.0]], [0, [0.6619275845263408, 1.0]], [0, [1176168.1426188834, 1.0]], [0, [588084.0699925388, 1.0]], [0, [294042.03113173624, 1.0]], [0, [147020.99214720802, 1.0]], [0, [73510.42096817764, 1.0]], [0, [36754.72002803971, 1.0]], [0, [7303.474648656817, 1.0]], [0, [18375.810173241847, 1.0]], [0, [1449.7473354833012, 1.0]], [0, [374.0300603877657, 1.0]], [0, [113.22713520592296, 1.0]], [0, [37.927271288166445, 1.0]], [0, [8.37624507014647, 1.0]], [0, [3.357752170179416, 1.0]], [1, [8.603675406344333, 1.0]], [1, [0.49268205308008556, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26143064]
bas 1, expnt(s) = [117616.81424087]
bas 2, expnt(s) = [0.66192758]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999254]
bas 5, expnt(s) = [294042.03113174]
bas 6, expnt(s) = [147020.99214721]
bas 7, expnt(s) = [73510.42096818]
bas 8, expnt(s) = [36754.72002804]
bas 9, expnt(s) = [7303.47464866]
bas 10, expnt(s) = [18375.81017324]
bas 11, expnt(s) = [1449.74733548]
bas 12, expnt(s) = [374.03006039]
bas 13, expnt(s) = [113.22713521]
bas 14, expnt(s) = [37.92727129]
bas 15, expnt(s) = [8.37624507]
bas 16, expnt(s) = [3.35775217]
bas 17, expnt(s) = [8.60367541]
bas 18, expnt(s) = [0.49268205]
CPU time:       116.19
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61430644e-01 9.23703085e-01 1.17616814e+05 1.60460109e+04
 6.61927585e-01 1.85405616e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347465e+03 1.99600750e+03
 1.83758102e+04 3.98749266e+03 1.44974734e+03 5.93586840e+02
 3.74030060e+02 2.14879460e+02 1.13227135e+02 8.76956222e+01
 3.79272713e+01 3.86125713e+01 8.37624507e+00 1.24394751e+01
 3.35775217e+00 6.26688179e+00 8.60367541e+00 4.29872254e+01
 4.92682053e-01 1.20418391e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335640716027395
cond(S) = 907752.2684323956
E1 = -689.5631967041813  E_coul = 184.96217605650702
init E= -504.601020647674
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672404669656124  LUMO = 0.754321707953953
  mo_energy =
[-1.21704581e+02 -1.33850802e+01 -7.62422396e+00 -7.62422396e+00
 -7.62422396e+00 -1.65756270e+00 -6.72404670e-01 -6.72404670e-01
 -6.72404670e-01  7.54321708e-01  1.24615443e+01  1.12746256e+02
  6.06919834e+02  2.74615147e+03  1.22250155e+04  4.08463839e+04
  1.04889959e+05  2.30073361e+05  4.55888271e+05  8.44840509e+05
  1.52801775e+06  2.85028512e+06  5.80817236e+06]
E1 = -707.7308450111511  E_coul = 199.77541642758484
cycle= 1 E= -507.955428583566  delta_E= -3.35  |g|= 0.449  |ddm|= 0.513
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625816
diis-c [-0.39164556  1.        ]
  HOMO = -0.217705972905839  LUMO = 1.1579167073703
  mo_energy =
[-1.20194284e+02 -1.23035124e+01 -6.59460676e+00 -6.59460676e+00
 -6.59460676e+00 -1.16308807e+00 -2.17705973e-01 -2.17705973e-01
 -2.17705973e-01  1.15791671e+00  1.34059106e+01  1.14146747e+02
  6.08416053e+02  2.74758677e+03  1.22263419e+04  4.08476438e+04
  1.04891182e+05  2.30074560e+05  4.55889453e+05  8.44841677e+05
  1.52801891e+06  2.85028627e+06  5.80817350e+06]
E1 = -706.7966564705958  E_coul = 198.82384215463625
cycle= 2 E= -507.97281431596  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258315
diis-c [-6.64432701e-04  2.68397952e-03  9.97316020e-01]
  HOMO = -0.239410451808009  LUMO = 1.1514444992007
  mo_energy =
[-1.20306314e+02 -1.23693019e+01 -6.66746804e+00 -6.66746804e+00
 -6.66746804e+00 -1.17706474e+00 -2.39410452e-01 -2.39410452e-01
 -2.39410452e-01  1.15144450e+00  1.33550879e+01  1.14053192e+02
  6.08300076e+02  2.74745486e+03  1.22261999e+04  4.08474981e+04
  1.04891035e+05  2.30074412e+05  4.55889304e+05  8.44841528e+05
  1.52801876e+06  2.85028612e+06  5.80817335e+06]
E1 = -706.6920873903944  E_coul = 198.71902359954817
cycle= 3 E= -507.973063790846  delta_E= -0.000249  |g|= 0.00437  |ddm|= 0.0602
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00293694
diis-c [-1.56278533e-06 -1.80149309e-04 -1.14876353e-01  1.11505650e+00]
  HOMO = -0.242555914940561  LUMO = 1.15027845046272
  mo_energy =
[-1.20318430e+02 -1.23780075e+01 -6.67668828e+00 -6.67668828e+00
 -6.67668828e+00 -1.17896967e+00 -2.42555915e-01 -2.42555915e-01
 -2.42555915e-01  1.15027845e+00  1.33480763e+01  1.14042401e+02
  6.08287786e+02  2.74744169e+03  1.22261862e+04  4.08474842e+04
  1.04891021e+05  2.30074398e+05  4.55889290e+05  8.44841514e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6770637349689  E_coul = 198.70399533206177
cycle= 4 E= -507.973068402907  delta_E= -4.61e-06  |g|= 0.00016  |ddm|= 0.00926
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000109537
diis-c [-6.86778163e-11 -5.38806460e-06  7.37837985e-03 -9.15799027e-02
  1.08420691e+00]
  HOMO = -0.242662397219256  LUMO = 1.15023265121584
  mo_energy =
[-1.20318677e+02 -1.23782662e+01 -6.67694102e+00 -6.67694102e+00
 -6.67694102e+00 -1.17903221e+00 -2.42662397e-01 -2.42662397e-01
 -2.42662397e-01  1.15023265e+00  1.33478567e+01  1.14042152e+02
  6.08287541e+02  2.74744145e+03  1.22261859e+04  4.08474840e+04
  1.04891021e+05  2.30074398e+05  4.55889290e+05  8.44841514e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6765616758776  E_coul = 198.70349326731343
cycle= 5 E= -507.973068408564  delta_E= -5.66e-09  |g|= 2.58e-07  |ddm|= 0.000341
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.63791e-07
diis-c [-9.70795917e-15  1.73190967e-07 -8.81470390e-05  9.77680445e-04
 -1.09389631e-02  1.01004926e+00]
  HOMO = -0.242662464885407  LUMO = 1.15023279475976
  mo_energy =
[-1.20318677e+02 -1.23782665e+01 -6.67694139e+00 -6.67694139e+00
 -6.67694139e+00 -1.17903238e+00 -2.42662465e-01 -2.42662465e-01
 -2.42662465e-01  1.15023279e+00  1.33478565e+01  1.14042152e+02
  6.08287540e+02  2.74744145e+03  1.22261859e+04  4.08474840e+04
  1.04891021e+05  2.30074398e+05  4.55889290e+05  8.44841514e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6765611587963  E_coul = 198.70349275023185
cycle= 6 E= -507.973068408564  delta_E= -3.41e-13  |g|= 1.14e-08  |ddm|= 2.33e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6765611587963  E_coul = 198.70349275023185
  HOMO = -0.2426624588062  LUMO = 1.15023279784092
  mo_energy =
[-1.20318677e+02 -1.23782665e+01 -6.67694138e+00 -6.67694138e+00
 -6.67694138e+00 -1.17903238e+00 -2.42662459e-01 -2.42662459e-01
 -2.42662459e-01  1.15023280e+00  1.33478565e+01  1.14042152e+02
  6.08287540e+02  2.74744145e+03  1.22261859e+04  4.08474840e+04
  1.04891021e+05  2.30074398e+05  4.55889290e+05  8.44841514e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6765611909851  E_coul = 198.70349278242074
Extra cycle  E= -507.973068408564  delta_E= 1.14e-13  |g|= 2.43e-09  |ddm|= 2.12e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907752.2684323956
E1 = -706.6765611909851  E_coul = 198.70349278242074
init E= -507.973068408564
    CPU time for initialize scf      1.47 sec, wall time      0.09 sec
  HOMO = -0.242662457920998  LUMO = 1.15023279662619
  mo_energy =
[-1.20318677e+02 -1.23782665e+01 -6.67694137e+00 -6.67694137e+00
 -6.67694137e+00 -1.17903238e+00 -2.42662458e-01 -2.42662458e-01
 -2.42662458e-01  1.15023280e+00  1.33478565e+01  1.14042152e+02
  6.08287540e+02  2.74744145e+03  1.22261859e+04  4.08474840e+04
  1.04891021e+05  2.30074398e+05  4.55889290e+05  8.44841514e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6765611953911  E_coul = 198.7034927868268
cycle= 1 E= -507.973068408564  delta_E= 1.14e-13  |g|= 1.41e-09  |ddm|= 2.96e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6765611953911  E_coul = 198.7034927868268
  HOMO = -0.242662457788481  LUMO = 1.15023279795262
  mo_energy =
[-1.20318677e+02 -1.23782665e+01 -6.67694137e+00 -6.67694137e+00
 -6.67694137e+00 -1.17903238e+00 -2.42662458e-01 -2.42662458e-01
 -2.42662458e-01  1.15023280e+00  1.33478565e+01  1.14042152e+02
  6.08287540e+02  2.74744145e+03  1.22261859e+04  4.08474840e+04
  1.04891021e+05  2.30074398e+05  4.55889290e+05  8.44841514e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6765611942088  E_coul = 198.7034927856444
Extra cycle  E= -507.973068408564  delta_E= -1.71e-13  |g|= 1.27e-09  |ddm|= 7.42e-10
    CPU time for scf_cycle      1.64 sec, wall time      0.16 sec
exp = [2.61430644e-01 1.17616814e+05 6.61927585e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347465e+03 1.83758102e+04 1.44974734e+03
 3.74030060e+02 1.13227135e+02 3.79272713e+01 8.37624507e+00
 3.35775217e+00 8.60367541e+00 4.92682053e-01]
grad_E = [ 2.37460926e-03  4.22690003e-09 -1.38528419e-03  1.92894555e-11
  1.14217159e-10  6.57609569e-10  2.57939190e-09  1.07176775e-08
  5.76052422e-08  3.62893143e-06  1.24360667e-07  2.72258309e-06
  2.92875605e-05 -2.14156604e-04  1.64928176e-04  2.48253711e-05
 -4.07430250e-04 -4.48738268e-05  3.42152548e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.26272155147        1
[INPUT] 0    0    [1    /1   ]  117616.814241        1
[INPUT] 0    0    [1    /1   ]  0.667612759385       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992147        1
[INPUT] 0    0    [1    /1   ]  73510.4209681        1
[INPUT] 0    0    [1    /1   ]  36754.7200279        1
[INPUT] 0    0    [1    /1   ]  7303.47463792        1
[INPUT] 0    0    [1    /1   ]  18375.8101729        1
[INPUT] 0    0    [1    /1   ]  1449.74732257        1
[INPUT] 0    0    [1    /1   ]  374.030043371        1
[INPUT] 0    0    [1    /1   ]  113.227302099        1
[INPUT] 0    0    [1    /1   ]  37.9277609187        1
[INPUT] 0    0    [1    /1   ]  8.37720862073        1
[INPUT] 0    0    [1    /1   ]  3.36054358552        1
[INPUT] 1    0    [1    /1   ]  8.60360796363        1
[INPUT] 1    0    [1    /1   ]  0.492589500669       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26272155147003884, 1.0]], [0, [117616.81424085515, 1.0]], [0, [0.6676127593850044, 1.0]], [0, [1176168.1426188834, 1.0]], [0, [588084.0699925384, 1.0]], [0, [294042.0311317343, 1.0]], [0, [147020.9921472004, 1.0]], [0, [73510.42096814593, 1.0]], [0, [36754.720027869145, 1.0]], [0, [7303.474637922142, 1.0]], [0, [18375.810172874622, 1.0]], [0, [1449.7473225710226, 1.0]], [0, [374.0300433713944, 1.0]], [0, [113.22730209944335, 1.0]], [0, [37.92776091871617, 1.0]], [0, [8.37720862072542, 1.0]], [0, [3.3605435855206, 1.0]], [1, [8.603607963632706, 1.0]], [1, [0.49258950066862683, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26272155]
bas 1, expnt(s) = [117616.81424086]
bas 2, expnt(s) = [0.66761276]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999254]
bas 5, expnt(s) = [294042.03113173]
bas 6, expnt(s) = [147020.9921472]
bas 7, expnt(s) = [73510.42096815]
bas 8, expnt(s) = [36754.72002787]
bas 9, expnt(s) = [7303.47463792]
bas 10, expnt(s) = [18375.81017287]
bas 11, expnt(s) = [1449.74732257]
bas 12, expnt(s) = [374.03004337]
bas 13, expnt(s) = [113.2273021]
bas 14, expnt(s) = [37.92776092]
bas 15, expnt(s) = [8.37720862]
bas 16, expnt(s) = [3.36054359]
bas 17, expnt(s) = [8.60360796]
bas 18, expnt(s) = [0.4925895]
CPU time:       121.09
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.62721551e-01 9.27121813e-01 1.17616814e+05 1.60460109e+04
 6.67612759e-01 1.86598649e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347464e+03 1.99600750e+03
 1.83758102e+04 3.98749266e+03 1.44974732e+03 5.93586836e+02
 3.74030043e+02 2.14879453e+02 1.13227302e+02 8.76957191e+01
 3.79277609e+01 3.86129451e+01 8.37720862e+00 1.24405483e+01
 3.36054359e+00 6.27078879e+00 8.60360796e+00 4.29868041e+01
 4.92589501e-01 1.20390115e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335751152592874
cond(S) = 907752.8300954454
E1 = -689.5605893416024  E_coul = 184.95967136652868
init E= -504.600917975074
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.67249085416629  LUMO = 0.764848503960881
  mo_energy =
[-1.21704857e+02 -1.33852958e+01 -7.62435938e+00 -7.62435938e+00
 -7.62435938e+00 -1.65763760e+00 -6.72490854e-01 -6.72490854e-01
 -6.72490854e-01  7.64848504e-01  1.25035763e+01  1.12792138e+02
  6.06959684e+02  2.74618588e+03  1.22250454e+04  4.08464115e+04
  1.04889986e+05  2.30073387e+05  4.55888296e+05  8.44840533e+05
  1.52801778e+06  2.85028514e+06  5.80817238e+06]
E1 = -707.727439918315  E_coul = 199.77203261057548
cycle= 1 E= -507.95540730774  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625847
diis-c [-0.39168501  1.        ]
  HOMO = -0.217921755878871  LUMO = 1.17020479538131
  mo_energy =
[-1.20194524e+02 -1.23037593e+01 -6.59474520e+00 -6.59474520e+00
 -6.59474520e+00 -1.16323428e+00 -2.17921756e-01 -2.17921756e-01
 -2.17921756e-01  1.17020480e+00  1.34480334e+01  1.14192618e+02
  6.08455930e+02  2.74762123e+03  1.22263718e+04  4.08476714e+04
  1.04891209e+05  2.30074586e+05  4.55889478e+05  8.44841702e+05
  1.52801893e+06  2.85028629e+06  5.80817352e+06]
E1 = -706.7922071925002  E_coul = 198.81938779561648
cycle= 2 E= -507.972819396884  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.446
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258288
diis-c [-6.64258476e-04  2.70046025e-03  9.97299540e-01]
  HOMO = -0.239635249044212  LUMO = 1.16364711569787
  mo_energy =
[-1.20306674e+02 -1.23696364e+01 -6.66770118e+00 -6.66770118e+00
 -6.66770118e+00 -1.17721628e+00 -2.39635249e-01 -2.39635249e-01
 -2.39635249e-01  1.16364712e+00  1.33970933e+01  1.14098954e+02
  6.08339831e+02  2.74748919e+03  1.22262296e+04  4.08475256e+04
  1.04891062e+05  2.30074438e+05  4.55889329e+05  8.44841553e+05
  1.52801878e+06  2.85028614e+06  5.80817337e+06]
E1 = -706.6878372380082  E_coul = 198.71476954884042
cycle= 3 E= -507.973067689168  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0599
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00293062
diis-c [-1.55530131e-06 -1.77435512e-04 -1.14622769e-01  1.11480020e+00]
  HOMO = -0.242769770232694  LUMO = 1.16247310200149
  mo_energy =
[-1.20318775e+02 -1.23783263e+01 -6.67690610e+00 -6.67690610e+00
 -6.67690610e+00 -1.17911415e+00 -2.42769770e-01 -2.42769770e-01
 -2.42769770e-01  1.16247310e+00  1.33900920e+01  1.14088180e+02
  6.08327557e+02  2.74747604e+03  1.22262160e+04  4.08475117e+04
  1.04891048e+05  2.30074424e+05  4.55889315e+05  8.44841539e+05
  1.52801877e+06  2.85028613e+06  5.80817336e+06]
E1 = -706.6728992608786  E_coul = 198.69982701613702
cycle= 4 E= -507.973072244742  delta_E= -4.56e-06  |g|= 0.000158  |ddm|= 0.00917
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108743
diis-c [-6.82811921e-11 -5.34129623e-06  7.35160523e-03 -9.12437459e-02
  1.08389748e+00]
  HOMO = -0.242874827158435  LUMO = 1.16242749857492
  mo_energy =
[-1.20319018e+02 -1.23785820e+01 -6.67715580e+00 -6.67715580e+00
 -6.67715580e+00 -1.17917583e+00 -2.42874827e-01 -2.42874827e-01
 -2.42874827e-01  1.16242750e+00  1.33898749e+01  1.14087934e+02
  6.08327315e+02  2.74747580e+03  1.22262157e+04  4.08475115e+04
  1.04891047e+05  2.30074424e+05  4.55889315e+05  8.44841539e+05
  1.52801877e+06  2.85028613e+06  5.80817336e+06]
E1 = -706.6724051351409  E_coul = 198.6993328849165
cycle= 5 E= -507.973072250224  delta_E= -5.48e-09  |g|= 2.55e-07  |ddm|= 0.000334
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.60695e-07
diis-c [-1.01334921e-14  1.75793346e-07 -8.92648685e-05  9.94176367e-04
 -1.11343000e-02  1.01022921e+00]
  HOMO = -0.242874884308872  LUMO = 1.16242764381131
  mo_energy =
[-1.20319019e+02 -1.23785823e+01 -6.67715614e+00 -6.67715614e+00
 -6.67715614e+00 -1.17917600e+00 -2.42874884e-01 -2.42874884e-01
 -2.42874884e-01  1.16242764e+00  1.33898748e+01  1.14087933e+02
  6.08327314e+02  2.74747580e+03  1.22262157e+04  4.08475115e+04
  1.04891047e+05  2.30074424e+05  4.55889315e+05  8.44841539e+05
  1.52801877e+06  2.85028613e+06  5.80817336e+06]
E1 = -706.672404677139  E_coul = 198.69933242691434
cycle= 6 E= -507.973072250225  delta_E= -1.71e-13  |g|= 1.2e-08  |ddm|= 1.97e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.672404677139  E_coul = 198.69933242691434
  HOMO = -0.242874877908621  LUMO = 1.16242764517771
  mo_energy =
[-1.20319019e+02 -1.23785823e+01 -6.67715612e+00 -6.67715612e+00
 -6.67715612e+00 -1.17917599e+00 -2.42874878e-01 -2.42874878e-01
 -2.42874878e-01  1.16242765e+00  1.33898748e+01  1.14087933e+02
  6.08327314e+02  2.74747580e+03  1.22262157e+04  4.08475115e+04
  1.04891047e+05  2.30074424e+05  4.55889315e+05  8.44841539e+05
  1.52801877e+06  2.85028613e+06  5.80817336e+06]
E1 = -706.6724047111381  E_coul = 198.69933246091378
Extra cycle  E= -507.973072250224  delta_E= 2.27e-13  |g|= 1.84e-09  |ddm|= 2.25e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.62721551e-01 1.17616814e+05 6.67612759e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347464e+03 1.83758102e+04 1.44974732e+03
 3.74030043e+02 1.13227302e+02 3.79277609e+01 8.37720862e+00
 3.36054359e+00 8.60360796e+00 4.92589501e-01]
E = -507.9730722502244
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.26272155147        1
[INPUT] 0    0    [1    /1   ]  117616.814241        1
[INPUT] 0    0    [1    /1   ]  0.667612759385       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992147        1
[INPUT] 0    0    [1    /1   ]  73510.4209681        1
[INPUT] 0    0    [1    /1   ]  36754.7200279        1
[INPUT] 0    0    [1    /1   ]  7303.47463792        1
[INPUT] 0    0    [1    /1   ]  18375.8101729        1
[INPUT] 0    0    [1    /1   ]  1449.74732257        1
[INPUT] 0    0    [1    /1   ]  374.030043371        1
[INPUT] 0    0    [1    /1   ]  113.227302099        1
[INPUT] 0    0    [1    /1   ]  37.9277609187        1
[INPUT] 0    0    [1    /1   ]  8.37720862073        1
[INPUT] 0    0    [1    /1   ]  3.36054358552        1
[INPUT] 1    0    [1    /1   ]  8.60360796363        1
[INPUT] 1    0    [1    /1   ]  0.492589500669       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26272155147003884, 1.0]], [0, [117616.81424085515, 1.0]], [0, [0.6676127593850044, 1.0]], [0, [1176168.1426188834, 1.0]], [0, [588084.0699925384, 1.0]], [0, [294042.0311317343, 1.0]], [0, [147020.9921472004, 1.0]], [0, [73510.42096814593, 1.0]], [0, [36754.720027869145, 1.0]], [0, [7303.474637922142, 1.0]], [0, [18375.810172874622, 1.0]], [0, [1449.7473225710226, 1.0]], [0, [374.0300433713944, 1.0]], [0, [113.22730209944335, 1.0]], [0, [37.92776091871617, 1.0]], [0, [8.37720862072542, 1.0]], [0, [3.3605435855206, 1.0]], [1, [8.603607963632706, 1.0]], [1, [0.49258950066862683, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26272155]
bas 1, expnt(s) = [117616.81424086]
bas 2, expnt(s) = [0.66761276]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999254]
bas 5, expnt(s) = [294042.03113173]
bas 6, expnt(s) = [147020.9921472]
bas 7, expnt(s) = [73510.42096815]
bas 8, expnt(s) = [36754.72002787]
bas 9, expnt(s) = [7303.47463792]
bas 10, expnt(s) = [18375.81017287]
bas 11, expnt(s) = [1449.74732257]
bas 12, expnt(s) = [374.03004337]
bas 13, expnt(s) = [113.2273021]
bas 14, expnt(s) = [37.92776092]
bas 15, expnt(s) = [8.37720862]
bas 16, expnt(s) = [3.36054359]
bas 17, expnt(s) = [8.60360796]
bas 18, expnt(s) = [0.4925895]
CPU time:       121.63
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.62721551e-01 9.27121813e-01 1.17616814e+05 1.60460109e+04
 6.67612759e-01 1.86598649e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347464e+03 1.99600750e+03
 1.83758102e+04 3.98749266e+03 1.44974732e+03 5.93586836e+02
 3.74030043e+02 2.14879453e+02 1.13227302e+02 8.76957191e+01
 3.79277609e+01 3.86129451e+01 8.37720862e+00 1.24405483e+01
 3.36054359e+00 6.27078879e+00 8.60360796e+00 4.29868041e+01
 4.92589501e-01 1.20390115e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335751152592874
cond(S) = 907752.8300954454
E1 = -689.5605893416024  E_coul = 184.95967136652868
init E= -504.600917975074
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.67249085416629  LUMO = 0.764848503960881
  mo_energy =
[-1.21704857e+02 -1.33852958e+01 -7.62435938e+00 -7.62435938e+00
 -7.62435938e+00 -1.65763760e+00 -6.72490854e-01 -6.72490854e-01
 -6.72490854e-01  7.64848504e-01  1.25035763e+01  1.12792138e+02
  6.06959684e+02  2.74618588e+03  1.22250454e+04  4.08464115e+04
  1.04889986e+05  2.30073387e+05  4.55888296e+05  8.44840533e+05
  1.52801778e+06  2.85028514e+06  5.80817238e+06]
E1 = -707.727439918315  E_coul = 199.77203261057548
cycle= 1 E= -507.95540730774  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625847
diis-c [-0.39168501  1.        ]
  HOMO = -0.217921755878871  LUMO = 1.17020479538131
  mo_energy =
[-1.20194524e+02 -1.23037593e+01 -6.59474520e+00 -6.59474520e+00
 -6.59474520e+00 -1.16323428e+00 -2.17921756e-01 -2.17921756e-01
 -2.17921756e-01  1.17020480e+00  1.34480334e+01  1.14192618e+02
  6.08455930e+02  2.74762123e+03  1.22263718e+04  4.08476714e+04
  1.04891209e+05  2.30074586e+05  4.55889478e+05  8.44841702e+05
  1.52801893e+06  2.85028629e+06  5.80817352e+06]
E1 = -706.7922071925002  E_coul = 198.81938779561648
cycle= 2 E= -507.972819396884  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.446
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258288
diis-c [-6.64258476e-04  2.70046025e-03  9.97299540e-01]
  HOMO = -0.239635249044212  LUMO = 1.16364711569787
  mo_energy =
[-1.20306674e+02 -1.23696364e+01 -6.66770118e+00 -6.66770118e+00
 -6.66770118e+00 -1.17721628e+00 -2.39635249e-01 -2.39635249e-01
 -2.39635249e-01  1.16364712e+00  1.33970933e+01  1.14098954e+02
  6.08339831e+02  2.74748919e+03  1.22262296e+04  4.08475256e+04
  1.04891062e+05  2.30074438e+05  4.55889329e+05  8.44841553e+05
  1.52801878e+06  2.85028614e+06  5.80817337e+06]
E1 = -706.6878372380082  E_coul = 198.71476954884042
cycle= 3 E= -507.973067689168  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0599
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00293062
diis-c [-1.55530131e-06 -1.77435512e-04 -1.14622769e-01  1.11480020e+00]
  HOMO = -0.242769770232694  LUMO = 1.16247310200149
  mo_energy =
[-1.20318775e+02 -1.23783263e+01 -6.67690610e+00 -6.67690610e+00
 -6.67690610e+00 -1.17911415e+00 -2.42769770e-01 -2.42769770e-01
 -2.42769770e-01  1.16247310e+00  1.33900920e+01  1.14088180e+02
  6.08327557e+02  2.74747604e+03  1.22262160e+04  4.08475117e+04
  1.04891048e+05  2.30074424e+05  4.55889315e+05  8.44841539e+05
  1.52801877e+06  2.85028613e+06  5.80817336e+06]
E1 = -706.6728992608786  E_coul = 198.69982701613702
cycle= 4 E= -507.973072244742  delta_E= -4.56e-06  |g|= 0.000158  |ddm|= 0.00917
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108743
diis-c [-6.82811921e-11 -5.34129623e-06  7.35160523e-03 -9.12437459e-02
  1.08389748e+00]
  HOMO = -0.242874827158435  LUMO = 1.16242749857492
  mo_energy =
[-1.20319018e+02 -1.23785820e+01 -6.67715580e+00 -6.67715580e+00
 -6.67715580e+00 -1.17917583e+00 -2.42874827e-01 -2.42874827e-01
 -2.42874827e-01  1.16242750e+00  1.33898749e+01  1.14087934e+02
  6.08327315e+02  2.74747580e+03  1.22262157e+04  4.08475115e+04
  1.04891047e+05  2.30074424e+05  4.55889315e+05  8.44841539e+05
  1.52801877e+06  2.85028613e+06  5.80817336e+06]
E1 = -706.6724051351409  E_coul = 198.6993328849165
cycle= 5 E= -507.973072250224  delta_E= -5.48e-09  |g|= 2.55e-07  |ddm|= 0.000334
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.60695e-07
diis-c [-1.01334921e-14  1.75793346e-07 -8.92648685e-05  9.94176367e-04
 -1.11343000e-02  1.01022921e+00]
  HOMO = -0.242874884308872  LUMO = 1.16242764381131
  mo_energy =
[-1.20319019e+02 -1.23785823e+01 -6.67715614e+00 -6.67715614e+00
 -6.67715614e+00 -1.17917600e+00 -2.42874884e-01 -2.42874884e-01
 -2.42874884e-01  1.16242764e+00  1.33898748e+01  1.14087933e+02
  6.08327314e+02  2.74747580e+03  1.22262157e+04  4.08475115e+04
  1.04891047e+05  2.30074424e+05  4.55889315e+05  8.44841539e+05
  1.52801877e+06  2.85028613e+06  5.80817336e+06]
E1 = -706.672404677139  E_coul = 198.69933242691434
cycle= 6 E= -507.973072250225  delta_E= -1.71e-13  |g|= 1.2e-08  |ddm|= 1.97e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.672404677139  E_coul = 198.69933242691434
  HOMO = -0.242874877908621  LUMO = 1.16242764517771
  mo_energy =
[-1.20319019e+02 -1.23785823e+01 -6.67715612e+00 -6.67715612e+00
 -6.67715612e+00 -1.17917599e+00 -2.42874878e-01 -2.42874878e-01
 -2.42874878e-01  1.16242765e+00  1.33898748e+01  1.14087933e+02
  6.08327314e+02  2.74747580e+03  1.22262157e+04  4.08475115e+04
  1.04891047e+05  2.30074424e+05  4.55889315e+05  8.44841539e+05
  1.52801877e+06  2.85028613e+06  5.80817336e+06]
E1 = -706.6724047111381  E_coul = 198.69933246091378
Extra cycle  E= -507.973072250224  delta_E= 2.27e-13  |g|= 1.84e-09  |ddm|= 2.25e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907752.8300954454
E1 = -706.6724047111381  E_coul = 198.69933246091378
init E= -507.973072250224
    CPU time for initialize scf      1.47 sec, wall time      0.09 sec
  HOMO = -0.242874876962913  LUMO = 1.16242764340991
  mo_energy =
[-1.20319019e+02 -1.23785822e+01 -6.67715612e+00 -6.67715612e+00
 -6.67715612e+00 -1.17917599e+00 -2.42874877e-01 -2.42874877e-01
 -2.42874877e-01  1.16242764e+00  1.33898748e+01  1.14087933e+02
  6.08327314e+02  2.74747580e+03  1.22262157e+04  4.08475115e+04
  1.04891047e+05  2.30074424e+05  4.55889315e+05  8.44841539e+05
  1.52801877e+06  2.85028613e+06  5.80817336e+06]
E1 = -706.6724047152543  E_coul = 198.69933246503007
cycle= 1 E= -507.973072250224  delta_E= 1.71e-13  |g|= 2.85e-09  |ddm|= 2.87e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6724047152543  E_coul = 198.69933246503007
  HOMO = -0.24287487683149  LUMO = 1.1624276468535
  mo_energy =
[-1.20319019e+02 -1.23785822e+01 -6.67715612e+00 -6.67715612e+00
 -6.67715612e+00 -1.17917599e+00 -2.42874877e-01 -2.42874877e-01
 -2.42874877e-01  1.16242765e+00  1.33898748e+01  1.14087933e+02
  6.08327314e+02  2.74747580e+03  1.22262157e+04  4.08475115e+04
  1.04891047e+05  2.30074424e+05  4.55889315e+05  8.44841539e+05
  1.52801877e+06  2.85028613e+06  5.80817336e+06]
E1 = -706.672404716011  E_coul = 198.69933246578628
Extra cycle  E= -507.973072250225  delta_E= -5.12e-13  |g|= 1.84e-09  |ddm|= 9.03e-10
    CPU time for scf_cycle      1.64 sec, wall time      0.16 sec
exp = [2.62721551e-01 1.17616814e+05 6.67612759e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347464e+03 1.83758102e+04 1.44974732e+03
 3.74030043e+02 1.13227302e+02 3.79277609e+01 8.37720862e+00
 3.36054359e+00 8.60360796e+00 4.92589501e-01]
grad_E = [ 5.22571827e-04  4.22652317e-09 -3.21240614e-04  1.92849250e-11
  1.14204922e-10  6.57551171e-10  2.57915904e-09  1.07166963e-08
  5.76003940e-08  3.62857951e-06  1.24346027e-07  2.74398407e-06
  2.89395362e-05 -2.10823256e-04  1.48210171e-04 -4.14505936e-05
 -1.31341889e-04 -4.18342436e-06  3.85152007e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263145823679       1
[INPUT] 0    0    [1    /1   ]  117616.814241        1
[INPUT] 0    0    [1    /1   ]  0.669579817874       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992147        1
[INPUT] 0    0    [1    /1   ]  73510.4209682        1
[INPUT] 0    0    [1    /1   ]  36754.7200281        1
[INPUT] 0    0    [1    /1   ]  7303.47465456        1
[INPUT] 0    0    [1    /1   ]  18375.8101734        1
[INPUT] 0    0    [1    /1   ]  1449.74735392        1
[INPUT] 0    0    [1    /1   ]  374.029905056        1
[INPUT] 0    0    [1    /1   ]  113.228196023        1
[INPUT] 0    0    [1    /1   ]  37.9241259315        1
[INPUT] 0    0    [1    /1   ]  8.37170868541        1
[INPUT] 0    0    [1    /1   ]  3.3597116591         1
[INPUT] 1    0    [1    /1   ]  8.60359579738        1
[INPUT] 1    0    [1    /1   ]  0.492572560861       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26314582367938766, 1.0]], [0, [117616.81424087455, 1.0]], [0, [0.669579817873659, 1.0]], [0, [1176168.1426188834, 1.0]], [0, [588084.0699925389, 1.0]], [0, [294042.03113173734, 1.0]], [0, [147020.99214721224, 1.0]], [0, [73510.4209681951, 1.0]], [0, [36754.72002813382, 1.0]], [0, [7303.474654556319, 1.0]], [0, [18375.810173442173, 1.0]], [0, [1449.747353923548, 1.0]], [0, [374.0299050557481, 1.0]], [0, [113.2281960225734, 1.0]], [0, [37.92412593154903, 1.0]], [0, [8.371708685408386, 1.0]], [0, [3.359711659101265, 1.0]], [1, [8.603595797378254, 1.0]], [1, [0.4925725608608029, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26314582]
bas 1, expnt(s) = [117616.81424087]
bas 2, expnt(s) = [0.66957982]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999254]
bas 5, expnt(s) = [294042.03113174]
bas 6, expnt(s) = [147020.99214721]
bas 7, expnt(s) = [73510.4209682]
bas 8, expnt(s) = [36754.72002813]
bas 9, expnt(s) = [7303.47465456]
bas 10, expnt(s) = [18375.81017344]
bas 11, expnt(s) = [1449.74735392]
bas 12, expnt(s) = [374.02990506]
bas 13, expnt(s) = [113.22819602]
bas 14, expnt(s) = [37.92412593]
bas 15, expnt(s) = [8.37170869]
bas 16, expnt(s) = [3.35971166]
bas 17, expnt(s) = [8.6035958]
bas 18, expnt(s) = [0.49257256]
CPU time:       126.39
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63145824e-01 9.28244502e-01 1.17616814e+05 1.60460109e+04
 6.69579818e-01 1.87010844e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347465e+03 1.99600750e+03
 1.83758102e+04 3.98749266e+03 1.44974735e+03 5.93586845e+02
 3.74029905e+02 2.14879393e+02 1.13228196e+02 8.76962384e+01
 3.79241259e+01 3.86101696e+01 8.37170869e+00 1.24344221e+01
 3.35971166e+00 6.26962447e+00 8.60359580e+00 4.29867282e+01
 4.92572561e-01 1.20384940e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335770331678482
cond(S) = 907752.6019118684
E1 = -689.5602548994274  E_coul = 184.95930996738798
init E= -504.600944932039
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.672502925016684  LUMO = 0.768377385281208
  mo_energy =
[-1.21704898e+02 -1.33853321e+01 -7.62437674e+00 -7.62437674e+00
 -7.62437674e+00 -1.65764746e+00 -6.72502925e-01 -6.72502925e-01
 -6.72502925e-01  7.68377385e-01  1.25069732e+01  1.12770087e+02
  6.06931974e+02  2.74616078e+03  1.22250234e+04  4.08463911e+04
  1.04889966e+05  2.30073368e+05  4.55888277e+05  8.44840515e+05
  1.52801776e+06  2.85028512e+06  5.80817237e+06]
E1 = -707.7269255528986  E_coul = 199.77152676110333
cycle= 1 E= -507.955398791795  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625851
diis-c [-0.39168917  1.        ]
  HOMO = -0.217963817510189  LUMO = 1.17431293926186
  mo_energy =
[-1.20194559e+02 -1.23037953e+01 -6.59475519e+00 -6.59475519e+00
 -6.59475519e+00 -1.16326046e+00 -2.17963818e-01 -2.17963818e-01
 -2.17963818e-01  1.17431294e+00  1.34512065e+01  1.14170546e+02
  6.08428222e+02  2.74759613e+03  1.22263498e+04  4.08476511e+04
  1.04891189e+05  2.30074567e+05  4.55889460e+05  8.44841684e+05
  1.52801892e+06  2.85028627e+06  5.80817351e+06]
E1 = -706.7913306259984  E_coul = 198.8185103364295
cycle= 2 E= -507.972820289569  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.446
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258289
diis-c [-6.64258699e-04  2.70345808e-03  9.97296542e-01]
  HOMO = -0.239680211965215  LUMO = 1.16772801953787
  mo_energy =
[-1.20306753e+02 -1.23697029e+01 -6.66774444e+00 -6.66774444e+00
 -6.66774444e+00 -1.17724369e+00 -2.39680212e-01 -2.39680212e-01
 -2.39680212e-01  1.16772802e+00  1.34002456e+01  1.14076847e+02
  6.08312078e+02  2.74746405e+03  1.22262076e+04  4.08475052e+04
  1.04891042e+05  2.30074419e+05  4.55889311e+05  8.44841535e+05
  1.52801877e+06  2.85028612e+06  5.80817336e+06]
E1 = -706.687028913396  E_coul = 198.71396072959922
cycle= 3 E= -507.973068183797  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292865
diis-c [-1.55300188e-06 -1.76404976e-04 -1.14538703e-01  1.11471511e+00]
  HOMO = -0.242810988087933  LUMO = 1.16655156569605
  mo_energy =
[-1.20318848e+02 -1.23783872e+01 -6.67694388e+00 -6.67694388e+00
 -6.67694388e+00 -1.17913910e+00 -2.42810988e-01 -2.42810988e-01
 -2.42810988e-01  1.16655157e+00  1.33932500e+01  1.14066078e+02
  6.08299810e+02  2.74745090e+03  1.22261939e+04  4.08474914e+04
  1.04891028e+05  2.30074405e+05  4.55889297e+05  8.44841521e+05
  1.52801875e+06  2.85028611e+06  5.80817334e+06]
E1 = -706.6721200973624  E_coul = 198.69904737677385
cycle= 4 E= -507.973072720589  delta_E= -4.54e-06  |g|= 0.000158  |ddm|= 0.00915
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108483
diis-c [-6.80921231e-11 -5.33098741e-06  7.34252986e-03 -9.11296493e-02
  1.08379245e+00]
  HOMO = -0.24291557127171  LUMO = 1.16650603057341
  mo_energy =
[-1.20319090e+02 -1.23786418e+01 -6.67719253e+00 -6.67719253e+00
 -6.67719253e+00 -1.17920049e+00 -2.42915571e-01 -2.42915571e-01
 -2.42915571e-01  1.16650603e+00  1.33930340e+01  1.14065833e+02
  6.08299570e+02  2.74745066e+03  1.22261937e+04  4.08474911e+04
  1.04891028e+05  2.30074405e+05  4.55889297e+05  8.44841520e+05
  1.52801875e+06  2.85028611e+06  5.80817334e+06]
E1 = -706.671628613903  E_coul = 198.69855588788792
cycle= 5 E= -507.973072726015  delta_E= -5.43e-09  |g|= 2.54e-07  |ddm|= 0.000332
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.60647e-07
diis-c [-1.03043038e-14  1.78028370e-07 -8.90834736e-05  9.92406763e-04
 -1.11232080e-02  1.01021971e+00]
  HOMO = -0.242915626335382  LUMO = 1.16650617858556
  mo_energy =
[-1.20319091e+02 -1.23786421e+01 -6.67719287e+00 -6.67719287e+00
 -6.67719287e+00 -1.17920065e+00 -2.42915626e-01 -2.42915626e-01
 -2.42915626e-01  1.16650618e+00  1.33930338e+01  1.14065833e+02
  6.08299569e+02  2.74745066e+03  1.22261937e+04  4.08474911e+04
  1.04891028e+05  2.30074405e+05  4.55889297e+05  8.44841520e+05
  1.52801875e+06  2.85028611e+06  5.80817334e+06]
E1 = -706.6716281683335  E_coul = 198.69855544231876
cycle= 6 E= -507.973072726015  delta_E= 2.84e-13  |g|= 1.28e-08  |ddm|= 1.9e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6716281683335  E_coul = 198.69855544231876
  HOMO = -0.242915619847528  LUMO = 1.16650617948147
  mo_energy =
[-1.20319090e+02 -1.23786421e+01 -6.67719285e+00 -6.67719285e+00
 -6.67719285e+00 -1.17920065e+00 -2.42915620e-01 -2.42915620e-01
 -2.42915620e-01  1.16650618e+00  1.33930338e+01  1.14065833e+02
  6.08299569e+02  2.74745066e+03  1.22261937e+04  4.08474911e+04
  1.04891028e+05  2.30074405e+05  4.55889297e+05  8.44841520e+05
  1.52801875e+06  2.85028611e+06  5.80817334e+06]
E1 = -706.6716282037896  E_coul = 198.69855547777493
Extra cycle  E= -507.973072726015  delta_E= 5.68e-14  |g|= 2.47e-09  |ddm|= 2.34e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.63145824e-01 1.17616814e+05 6.69579818e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347465e+03 1.83758102e+04 1.44974735e+03
 3.74029905e+02 1.13228196e+02 3.79241259e+01 8.37170869e+00
 3.35971166e+00 8.60359580e+00 4.92572561e-01]
E = -507.9730727260147
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263145823679       1
[INPUT] 0    0    [1    /1   ]  117616.814241        1
[INPUT] 0    0    [1    /1   ]  0.669579817874       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992147        1
[INPUT] 0    0    [1    /1   ]  73510.4209682        1
[INPUT] 0    0    [1    /1   ]  36754.7200281        1
[INPUT] 0    0    [1    /1   ]  7303.47465456        1
[INPUT] 0    0    [1    /1   ]  18375.8101734        1
[INPUT] 0    0    [1    /1   ]  1449.74735392        1
[INPUT] 0    0    [1    /1   ]  374.029905056        1
[INPUT] 0    0    [1    /1   ]  113.228196023        1
[INPUT] 0    0    [1    /1   ]  37.9241259315        1
[INPUT] 0    0    [1    /1   ]  8.37170868541        1
[INPUT] 0    0    [1    /1   ]  3.3597116591         1
[INPUT] 1    0    [1    /1   ]  8.60359579738        1
[INPUT] 1    0    [1    /1   ]  0.492572560861       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26314582367938766, 1.0]], [0, [117616.81424087455, 1.0]], [0, [0.669579817873659, 1.0]], [0, [1176168.1426188834, 1.0]], [0, [588084.0699925389, 1.0]], [0, [294042.03113173734, 1.0]], [0, [147020.99214721224, 1.0]], [0, [73510.4209681951, 1.0]], [0, [36754.72002813382, 1.0]], [0, [7303.474654556319, 1.0]], [0, [18375.810173442173, 1.0]], [0, [1449.747353923548, 1.0]], [0, [374.0299050557481, 1.0]], [0, [113.2281960225734, 1.0]], [0, [37.92412593154903, 1.0]], [0, [8.371708685408386, 1.0]], [0, [3.359711659101265, 1.0]], [1, [8.603595797378254, 1.0]], [1, [0.4925725608608029, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26314582]
bas 1, expnt(s) = [117616.81424087]
bas 2, expnt(s) = [0.66957982]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999254]
bas 5, expnt(s) = [294042.03113174]
bas 6, expnt(s) = [147020.99214721]
bas 7, expnt(s) = [73510.4209682]
bas 8, expnt(s) = [36754.72002813]
bas 9, expnt(s) = [7303.47465456]
bas 10, expnt(s) = [18375.81017344]
bas 11, expnt(s) = [1449.74735392]
bas 12, expnt(s) = [374.02990506]
bas 13, expnt(s) = [113.22819602]
bas 14, expnt(s) = [37.92412593]
bas 15, expnt(s) = [8.37170869]
bas 16, expnt(s) = [3.35971166]
bas 17, expnt(s) = [8.6035958]
bas 18, expnt(s) = [0.49257256]
CPU time:       126.93
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63145824e-01 9.28244502e-01 1.17616814e+05 1.60460109e+04
 6.69579818e-01 1.87010844e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347465e+03 1.99600750e+03
 1.83758102e+04 3.98749266e+03 1.44974735e+03 5.93586845e+02
 3.74029905e+02 2.14879393e+02 1.13228196e+02 8.76962384e+01
 3.79241259e+01 3.86101696e+01 8.37170869e+00 1.24344221e+01
 3.35971166e+00 6.26962447e+00 8.60359580e+00 4.29867282e+01
 4.92572561e-01 1.20384940e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335770331678482
cond(S) = 907752.6019118684
E1 = -689.5602548994274  E_coul = 184.95930996738798
init E= -504.600944932039
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.672502925016684  LUMO = 0.768377385281208
  mo_energy =
[-1.21704898e+02 -1.33853321e+01 -7.62437674e+00 -7.62437674e+00
 -7.62437674e+00 -1.65764746e+00 -6.72502925e-01 -6.72502925e-01
 -6.72502925e-01  7.68377385e-01  1.25069732e+01  1.12770087e+02
  6.06931974e+02  2.74616078e+03  1.22250234e+04  4.08463911e+04
  1.04889966e+05  2.30073368e+05  4.55888277e+05  8.44840515e+05
  1.52801776e+06  2.85028512e+06  5.80817237e+06]
E1 = -707.7269255528986  E_coul = 199.77152676110333
cycle= 1 E= -507.955398791795  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625851
diis-c [-0.39168917  1.        ]
  HOMO = -0.217963817510189  LUMO = 1.17431293926186
  mo_energy =
[-1.20194559e+02 -1.23037953e+01 -6.59475519e+00 -6.59475519e+00
 -6.59475519e+00 -1.16326046e+00 -2.17963818e-01 -2.17963818e-01
 -2.17963818e-01  1.17431294e+00  1.34512065e+01  1.14170546e+02
  6.08428222e+02  2.74759613e+03  1.22263498e+04  4.08476511e+04
  1.04891189e+05  2.30074567e+05  4.55889460e+05  8.44841684e+05
  1.52801892e+06  2.85028627e+06  5.80817351e+06]
E1 = -706.7913306259984  E_coul = 198.8185103364295
cycle= 2 E= -507.972820289569  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.446
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258289
diis-c [-6.64258699e-04  2.70345808e-03  9.97296542e-01]
  HOMO = -0.239680211965215  LUMO = 1.16772801953787
  mo_energy =
[-1.20306753e+02 -1.23697029e+01 -6.66774444e+00 -6.66774444e+00
 -6.66774444e+00 -1.17724369e+00 -2.39680212e-01 -2.39680212e-01
 -2.39680212e-01  1.16772802e+00  1.34002456e+01  1.14076847e+02
  6.08312078e+02  2.74746405e+03  1.22262076e+04  4.08475052e+04
  1.04891042e+05  2.30074419e+05  4.55889311e+05  8.44841535e+05
  1.52801877e+06  2.85028612e+06  5.80817336e+06]
E1 = -706.687028913396  E_coul = 198.71396072959922
cycle= 3 E= -507.973068183797  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292865
diis-c [-1.55300188e-06 -1.76404976e-04 -1.14538703e-01  1.11471511e+00]
  HOMO = -0.242810988087933  LUMO = 1.16655156569605
  mo_energy =
[-1.20318848e+02 -1.23783872e+01 -6.67694388e+00 -6.67694388e+00
 -6.67694388e+00 -1.17913910e+00 -2.42810988e-01 -2.42810988e-01
 -2.42810988e-01  1.16655157e+00  1.33932500e+01  1.14066078e+02
  6.08299810e+02  2.74745090e+03  1.22261939e+04  4.08474914e+04
  1.04891028e+05  2.30074405e+05  4.55889297e+05  8.44841521e+05
  1.52801875e+06  2.85028611e+06  5.80817334e+06]
E1 = -706.6721200973624  E_coul = 198.69904737677385
cycle= 4 E= -507.973072720589  delta_E= -4.54e-06  |g|= 0.000158  |ddm|= 0.00915
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108483
diis-c [-6.80921231e-11 -5.33098741e-06  7.34252986e-03 -9.11296493e-02
  1.08379245e+00]
  HOMO = -0.24291557127171  LUMO = 1.16650603057341
  mo_energy =
[-1.20319090e+02 -1.23786418e+01 -6.67719253e+00 -6.67719253e+00
 -6.67719253e+00 -1.17920049e+00 -2.42915571e-01 -2.42915571e-01
 -2.42915571e-01  1.16650603e+00  1.33930340e+01  1.14065833e+02
  6.08299570e+02  2.74745066e+03  1.22261937e+04  4.08474911e+04
  1.04891028e+05  2.30074405e+05  4.55889297e+05  8.44841520e+05
  1.52801875e+06  2.85028611e+06  5.80817334e+06]
E1 = -706.671628613903  E_coul = 198.69855588788792
cycle= 5 E= -507.973072726015  delta_E= -5.43e-09  |g|= 2.54e-07  |ddm|= 0.000332
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.60647e-07
diis-c [-1.03043038e-14  1.78028370e-07 -8.90834736e-05  9.92406763e-04
 -1.11232080e-02  1.01021971e+00]
  HOMO = -0.242915626335382  LUMO = 1.16650617858556
  mo_energy =
[-1.20319091e+02 -1.23786421e+01 -6.67719287e+00 -6.67719287e+00
 -6.67719287e+00 -1.17920065e+00 -2.42915626e-01 -2.42915626e-01
 -2.42915626e-01  1.16650618e+00  1.33930338e+01  1.14065833e+02
  6.08299569e+02  2.74745066e+03  1.22261937e+04  4.08474911e+04
  1.04891028e+05  2.30074405e+05  4.55889297e+05  8.44841520e+05
  1.52801875e+06  2.85028611e+06  5.80817334e+06]
E1 = -706.6716281683335  E_coul = 198.69855544231876
cycle= 6 E= -507.973072726015  delta_E= 2.84e-13  |g|= 1.28e-08  |ddm|= 1.9e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6716281683335  E_coul = 198.69855544231876
  HOMO = -0.242915619847528  LUMO = 1.16650617948147
  mo_energy =
[-1.20319090e+02 -1.23786421e+01 -6.67719285e+00 -6.67719285e+00
 -6.67719285e+00 -1.17920065e+00 -2.42915620e-01 -2.42915620e-01
 -2.42915620e-01  1.16650618e+00  1.33930338e+01  1.14065833e+02
  6.08299569e+02  2.74745066e+03  1.22261937e+04  4.08474911e+04
  1.04891028e+05  2.30074405e+05  4.55889297e+05  8.44841520e+05
  1.52801875e+06  2.85028611e+06  5.80817334e+06]
E1 = -706.6716282037896  E_coul = 198.69855547777493
Extra cycle  E= -507.973072726015  delta_E= 5.68e-14  |g|= 2.47e-09  |ddm|= 2.34e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907752.6019118684
E1 = -706.6716282037896  E_coul = 198.69855547777493
init E= -507.973072726015
    CPU time for initialize scf      1.47 sec, wall time      0.09 sec
  HOMO = -0.24291561886453  LUMO = 1.16650617653414
  mo_energy =
[-1.20319090e+02 -1.23786421e+01 -6.67719285e+00 -6.67719285e+00
 -6.67719285e+00 -1.17920065e+00 -2.42915619e-01 -2.42915619e-01
 -2.42915619e-01  1.16650618e+00  1.33930338e+01  1.14065833e+02
  6.08299569e+02  2.74745066e+03  1.22261937e+04  4.08474911e+04
  1.04891028e+05  2.30074405e+05  4.55889297e+05  8.44841520e+05
  1.52801875e+06  2.85028611e+06  5.80817334e+06]
E1 = -706.6716282088587  E_coul = 198.6985554828438
cycle= 1 E= -507.973072726015  delta_E= -1.71e-13  |g|= 2.51e-09  |ddm|= 3.51e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6716282088587  E_coul = 198.6985554828438
  HOMO = -0.2429156187028  LUMO = 1.16650617977707
  mo_energy =
[-1.20319090e+02 -1.23786421e+01 -6.67719285e+00 -6.67719285e+00
 -6.67719285e+00 -1.17920065e+00 -2.42915619e-01 -2.42915619e-01
 -2.42915619e-01  1.16650618e+00  1.33930338e+01  1.14065833e+02
  6.08299569e+02  2.74745066e+03  1.22261937e+04  4.08474911e+04
  1.04891028e+05  2.30074405e+05  4.55889297e+05  8.44841520e+05
  1.52801875e+06  2.85028611e+06  5.80817334e+06]
E1 = -706.671628208406  E_coul = 198.69855548239119
Extra cycle  E= -507.973072726015  delta_E= 5.68e-14  |g|= 1.09e-09  |ddm|= 7.01e-10
    CPU time for scf_cycle      1.64 sec, wall time      0.16 sec
exp = [2.63145824e-01 1.17616814e+05 6.69579818e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347465e+03 1.83758102e+04 1.44974735e+03
 3.74029905e+02 1.13228196e+02 3.79241259e+01 8.37170869e+00
 3.35971166e+00 8.60359580e+00 4.92572561e-01]
grad_E = [-2.69274537e-05  4.22504864e-09  1.44567973e-05  1.92673948e-11
  1.14157083e-10  6.57322846e-10  2.57824787e-09  1.07128560e-08
  5.75814382e-08  3.62721961e-06  1.24288602e-07  2.82307129e-06
  2.77634745e-05 -2.02566778e-04  1.26197927e-04 -8.21258748e-05
 -3.48003228e-05  2.17459778e-07 -1.48381931e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263215774154       1
[INPUT] 0    0    [1    /1   ]  117616.814241        1
[INPUT] 0    0    [1    /1   ]  0.669897527126       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992147        1
[INPUT] 0    0    [1    /1   ]  73510.4209682        1
[INPUT] 0    0    [1    /1   ]  36754.7200282        1
[INPUT] 0    0    [1    /1   ]  7303.47465716        1
[INPUT] 0    0    [1    /1   ]  18375.8101735        1
[INPUT] 0    0    [1    /1   ]  1449.74736237        1
[INPUT] 0    0    [1    /1   ]  374.029832288        1
[INPUT] 0    0    [1    /1   ]  113.228686089        1
[INPUT] 0    0    [1    /1   ]  37.9227543284        1
[INPUT] 0    0    [1    /1   ]  8.36987351814        1
[INPUT] 0    0    [1    /1   ]  3.35936542365        1
[INPUT] 1    0    [1    /1   ]  8.60359821172        1
[INPUT] 1    0    [1    /1   ]  0.492573376707       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2632157741542219, 1.0]], [0, [117616.81424087759, 1.0]], [0, [0.6698975271258244, 1.0]], [0, [1176168.1426188834, 1.0]], [0, [588084.069992539, 1.0]], [0, [294042.0311317378, 1.0]], [0, [147020.9921472141, 1.0]], [0, [73510.4209682028, 1.0]], [0, [36754.72002817536, 1.0]], [0, [7303.474657159464, 1.0]], [0, [18375.810173530524, 1.0]], [0, [1449.7473623746146, 1.0]], [0, [374.0298322875711, 1.0]], [0, [113.22868608890978, 1.0]], [0, [37.92275432844636, 1.0]], [0, [8.369873518140118, 1.0]], [0, [3.3593654236516466, 1.0]], [1, [8.603598211720964, 1.0]], [1, [0.49257337670671303, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26321577]
bas 1, expnt(s) = [117616.81424088]
bas 2, expnt(s) = [0.66989753]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999254]
bas 5, expnt(s) = [294042.03113174]
bas 6, expnt(s) = [147020.99214721]
bas 7, expnt(s) = [73510.4209682]
bas 8, expnt(s) = [36754.72002818]
bas 9, expnt(s) = [7303.47465716]
bas 10, expnt(s) = [18375.81017353]
bas 11, expnt(s) = [1449.74736237]
bas 12, expnt(s) = [374.02983229]
bas 13, expnt(s) = [113.22868609]
bas 14, expnt(s) = [37.92275433]
bas 15, expnt(s) = [8.36987352]
bas 16, expnt(s) = [3.35936542]
bas 17, expnt(s) = [8.60359821]
bas 18, expnt(s) = [0.49257338]
CPU time:       131.69
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63215774e-01 9.28429558e-01 1.17616814e+05 1.60460109e+04
 6.69897527e-01 1.87077391e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347466e+03 1.99600750e+03
 1.83758102e+04 3.98749266e+03 1.44974736e+03 5.93586848e+02
 3.74029832e+02 2.14879362e+02 1.13228686e+02 8.76965231e+01
 3.79227543e+01 3.86091223e+01 8.36987352e+00 1.24323777e+01
 3.35936542e+00 6.26913988e+00 8.60359821e+00 4.29867432e+01
 4.92573377e-01 1.20385190e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335768760912533
cond(S) = 907752.5001020457
E1 = -689.5603443090519  E_coul = 184.95937861183913
init E= -504.600965697213
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672500701790494  LUMO = 0.768947426189257
  mo_energy =
[-1.21704891e+02 -1.33853278e+01 -7.62437198e+00 -7.62437198e+00
 -7.62437198e+00 -1.65764561e+00 -6.72500702e-01 -6.72500702e-01
 -6.72500702e-01  7.68947426e-01  1.25059457e+01  1.12760510e+02
  6.06920979e+02  2.74615105e+03  1.22250149e+04  4.08463833e+04
  1.04889959e+05  2.30073361e+05  4.55888270e+05  8.44840508e+05
  1.52801775e+06  2.85028512e+06  5.80817236e+06]
E1 = -707.727034786307  E_coul = 199.77163746497197
cycle= 1 E= -507.955397321335  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625848
diis-c [-0.39168623  1.        ]
  HOMO = -0.217962564567924  LUMO = 1.17497616219859
  mo_energy =
[-1.20194549e+02 -1.23037863e+01 -6.59474488e+00 -6.59474488e+00
 -6.59474488e+00 -1.16325872e+00 -2.17962565e-01 -2.17962565e-01
 -2.17962565e-01  1.17497616e+00  1.34501073e+01  1.14160966e+02
  6.08417228e+02  2.74758641e+03  1.22263413e+04  4.08476432e+04
  1.04891182e+05  2.30074560e+05  4.55889452e+05  8.44841677e+05
  1.52801891e+06  2.85028626e+06  5.80817350e+06]
E1 = -706.7913789740367  E_coul = 198.81855852735148
cycle= 2 E= -507.972820446685  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.446
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258288
diis-c [-6.64255343e-04  2.70371041e-03  9.97296290e-01]
  HOMO = -0.239679482011721  LUMO = 1.1683870531696
  mo_energy =
[-1.20306750e+02 -1.23696990e+01 -6.66773973e+00 -6.66773973e+00
 -6.66773973e+00 -1.17724209e+00 -2.39679482e-01 -2.39679482e-01
 -2.39679482e-01  1.16838705e+00  1.33991458e+01  1.14067262e+02
  6.08301077e+02  2.74745432e+03  1.22261991e+04  4.08474974e+04
  1.04891034e+05  2.30074411e+05  4.55889304e+05  8.44841528e+05
  1.52801876e+06  2.85028612e+06  5.80817335e+06]
E1 = -706.6870882250007  E_coul = 198.71401994749536
cycle= 3 E= -507.973068277505  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292833
diis-c [-1.55262370e-06 -1.76221723e-04 -1.14525219e-01  1.11470144e+00]
  HOMO = -0.242809656478348  LUMO = 1.16721023423328
  mo_energy =
[-1.20318844e+02 -1.23783825e+01 -6.67693828e+00 -6.67693828e+00
 -6.67693828e+00 -1.17913709e+00 -2.42809656e-01 -2.42809656e-01
 -2.42809656e-01  1.16721023e+00  1.33921515e+01  1.14056494e+02
  6.08288810e+02  2.74744117e+03  1.22261854e+04  4.08474835e+04
  1.04891021e+05  2.30074398e+05  4.55889290e+05  8.44841514e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.672184124965  E_coul = 198.69911131365825
cycle= 4 E= -507.973072811307  delta_E= -4.53e-06  |g|= 0.000158  |ddm|= 0.00914
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108442
diis-c [-6.80389889e-11 -5.33536241e-06  7.34117209e-03 -9.11119262e-02
  1.08377609e+00]
  HOMO = -0.242914164620807  LUMO = 1.16716470944529
  mo_energy =
[-1.20319086e+02 -1.23786369e+01 -6.67718676e+00 -6.67718676e+00
 -6.67718676e+00 -1.17919844e+00 -2.42914165e-01 -2.42914165e-01
 -2.42914165e-01  1.16716471e+00  1.33919356e+01  1.14056250e+02
  6.08288569e+02  2.74744093e+03  1.22261852e+04  4.08474833e+04
  1.04891020e+05  2.30074397e+05  4.55889289e+05  8.44841513e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6716930628464  E_coul = 198.6986202461212
cycle= 5 E= -507.973072816725  delta_E= -5.42e-09  |g|= 2.54e-07  |ddm|= 0.000332
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58211e-07
diis-c [-1.04038970e-14  1.71498514e-07 -8.77496663e-05  9.76653075e-04
 -1.09495090e-02  1.01006043e+00]
  HOMO = -0.242914219571206  LUMO = 1.16716485924974
  mo_energy =
[-1.20319087e+02 -1.23786372e+01 -6.67718709e+00 -6.67718709e+00
 -6.67718709e+00 -1.17919860e+00 -2.42914220e-01 -2.42914220e-01
 -2.42914220e-01  1.16716486e+00  1.33919354e+01  1.14056249e+02
  6.08288568e+02  2.74744093e+03  1.22261852e+04  4.08474833e+04
  1.04891020e+05  2.30074397e+05  4.55889289e+05  8.44841513e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6716926161316  E_coul = 198.6986197994066
cycle= 6 E= -507.973072816725  delta_E= 2.27e-13  |g|= 1.28e-08  |ddm|= 1.9e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6716926161316  E_coul = 198.6986197994066
  HOMO = -0.242914213026153  LUMO = 1.1671648588252
  mo_energy =
[-1.20319087e+02 -1.23786372e+01 -6.67718708e+00 -6.67718708e+00
 -6.67718708e+00 -1.17919860e+00 -2.42914213e-01 -2.42914213e-01
 -2.42914213e-01  1.16716486e+00  1.33919354e+01  1.14056249e+02
  6.08288568e+02  2.74744093e+03  1.22261852e+04  4.08474833e+04
  1.04891020e+05  2.30074397e+05  4.55889289e+05  8.44841513e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6716926518168  E_coul = 198.6986198350917
Extra cycle  E= -507.973072816725  delta_E= -1.14e-13  |g|= 2.07e-09  |ddm|= 2.36e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
exp = [2.63215774e-01 1.17616814e+05 6.69897527e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347466e+03 1.83758102e+04 1.44974736e+03
 3.74029832e+02 1.13228686e+02 3.79227543e+01 8.36987352e+00
 3.35936542e+00 8.60359821e+00 4.92573377e-01]
E = -507.9730728167251
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263215774154       1
[INPUT] 0    0    [1    /1   ]  117616.814241        1
[INPUT] 0    0    [1    /1   ]  0.669897527126       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992147        1
[INPUT] 0    0    [1    /1   ]  73510.4209682        1
[INPUT] 0    0    [1    /1   ]  36754.7200282        1
[INPUT] 0    0    [1    /1   ]  7303.47465716        1
[INPUT] 0    0    [1    /1   ]  18375.8101735        1
[INPUT] 0    0    [1    /1   ]  1449.74736237        1
[INPUT] 0    0    [1    /1   ]  374.029832288        1
[INPUT] 0    0    [1    /1   ]  113.228686089        1
[INPUT] 0    0    [1    /1   ]  37.9227543284        1
[INPUT] 0    0    [1    /1   ]  8.36987351814        1
[INPUT] 0    0    [1    /1   ]  3.35936542365        1
[INPUT] 1    0    [1    /1   ]  8.60359821172        1
[INPUT] 1    0    [1    /1   ]  0.492573376707       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2632157741542219, 1.0]], [0, [117616.81424087759, 1.0]], [0, [0.6698975271258244, 1.0]], [0, [1176168.1426188834, 1.0]], [0, [588084.069992539, 1.0]], [0, [294042.0311317378, 1.0]], [0, [147020.9921472141, 1.0]], [0, [73510.4209682028, 1.0]], [0, [36754.72002817536, 1.0]], [0, [7303.474657159464, 1.0]], [0, [18375.810173530524, 1.0]], [0, [1449.7473623746146, 1.0]], [0, [374.0298322875711, 1.0]], [0, [113.22868608890978, 1.0]], [0, [37.92275432844636, 1.0]], [0, [8.369873518140118, 1.0]], [0, [3.3593654236516466, 1.0]], [1, [8.603598211720964, 1.0]], [1, [0.49257337670671303, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26321577]
bas 1, expnt(s) = [117616.81424088]
bas 2, expnt(s) = [0.66989753]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999254]
bas 5, expnt(s) = [294042.03113174]
bas 6, expnt(s) = [147020.99214721]
bas 7, expnt(s) = [73510.4209682]
bas 8, expnt(s) = [36754.72002818]
bas 9, expnt(s) = [7303.47465716]
bas 10, expnt(s) = [18375.81017353]
bas 11, expnt(s) = [1449.74736237]
bas 12, expnt(s) = [374.02983229]
bas 13, expnt(s) = [113.22868609]
bas 14, expnt(s) = [37.92275433]
bas 15, expnt(s) = [8.36987352]
bas 16, expnt(s) = [3.35936542]
bas 17, expnt(s) = [8.60359821]
bas 18, expnt(s) = [0.49257338]
CPU time:       132.24
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63215774e-01 9.28429558e-01 1.17616814e+05 1.60460109e+04
 6.69897527e-01 1.87077391e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347466e+03 1.99600750e+03
 1.83758102e+04 3.98749266e+03 1.44974736e+03 5.93586848e+02
 3.74029832e+02 2.14879362e+02 1.13228686e+02 8.76965231e+01
 3.79227543e+01 3.86091223e+01 8.36987352e+00 1.24323777e+01
 3.35936542e+00 6.26913988e+00 8.60359821e+00 4.29867432e+01
 4.92573377e-01 1.20385190e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335768760912533
cond(S) = 907752.5001020457
E1 = -689.5603443090519  E_coul = 184.95937861183913
init E= -504.600965697213
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672500701790494  LUMO = 0.768947426189257
  mo_energy =
[-1.21704891e+02 -1.33853278e+01 -7.62437198e+00 -7.62437198e+00
 -7.62437198e+00 -1.65764561e+00 -6.72500702e-01 -6.72500702e-01
 -6.72500702e-01  7.68947426e-01  1.25059457e+01  1.12760510e+02
  6.06920979e+02  2.74615105e+03  1.22250149e+04  4.08463833e+04
  1.04889959e+05  2.30073361e+05  4.55888270e+05  8.44840508e+05
  1.52801775e+06  2.85028512e+06  5.80817236e+06]
E1 = -707.727034786307  E_coul = 199.77163746497197
cycle= 1 E= -507.955397321335  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625848
diis-c [-0.39168623  1.        ]
  HOMO = -0.217962564567924  LUMO = 1.17497616219859
  mo_energy =
[-1.20194549e+02 -1.23037863e+01 -6.59474488e+00 -6.59474488e+00
 -6.59474488e+00 -1.16325872e+00 -2.17962565e-01 -2.17962565e-01
 -2.17962565e-01  1.17497616e+00  1.34501073e+01  1.14160966e+02
  6.08417228e+02  2.74758641e+03  1.22263413e+04  4.08476432e+04
  1.04891182e+05  2.30074560e+05  4.55889452e+05  8.44841677e+05
  1.52801891e+06  2.85028626e+06  5.80817350e+06]
E1 = -706.7913789740367  E_coul = 198.81855852735148
cycle= 2 E= -507.972820446685  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.446
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258288
diis-c [-6.64255343e-04  2.70371041e-03  9.97296290e-01]
  HOMO = -0.239679482011721  LUMO = 1.1683870531696
  mo_energy =
[-1.20306750e+02 -1.23696990e+01 -6.66773973e+00 -6.66773973e+00
 -6.66773973e+00 -1.17724209e+00 -2.39679482e-01 -2.39679482e-01
 -2.39679482e-01  1.16838705e+00  1.33991458e+01  1.14067262e+02
  6.08301077e+02  2.74745432e+03  1.22261991e+04  4.08474974e+04
  1.04891034e+05  2.30074411e+05  4.55889304e+05  8.44841528e+05
  1.52801876e+06  2.85028612e+06  5.80817335e+06]
E1 = -706.6870882250007  E_coul = 198.71401994749536
cycle= 3 E= -507.973068277505  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292833
diis-c [-1.55262370e-06 -1.76221723e-04 -1.14525219e-01  1.11470144e+00]
  HOMO = -0.242809656478348  LUMO = 1.16721023423328
  mo_energy =
[-1.20318844e+02 -1.23783825e+01 -6.67693828e+00 -6.67693828e+00
 -6.67693828e+00 -1.17913709e+00 -2.42809656e-01 -2.42809656e-01
 -2.42809656e-01  1.16721023e+00  1.33921515e+01  1.14056494e+02
  6.08288810e+02  2.74744117e+03  1.22261854e+04  4.08474835e+04
  1.04891021e+05  2.30074398e+05  4.55889290e+05  8.44841514e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.672184124965  E_coul = 198.69911131365825
cycle= 4 E= -507.973072811307  delta_E= -4.53e-06  |g|= 0.000158  |ddm|= 0.00914
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108442
diis-c [-6.80389889e-11 -5.33536241e-06  7.34117209e-03 -9.11119262e-02
  1.08377609e+00]
  HOMO = -0.242914164620807  LUMO = 1.16716470944529
  mo_energy =
[-1.20319086e+02 -1.23786369e+01 -6.67718676e+00 -6.67718676e+00
 -6.67718676e+00 -1.17919844e+00 -2.42914165e-01 -2.42914165e-01
 -2.42914165e-01  1.16716471e+00  1.33919356e+01  1.14056250e+02
  6.08288569e+02  2.74744093e+03  1.22261852e+04  4.08474833e+04
  1.04891020e+05  2.30074397e+05  4.55889289e+05  8.44841513e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6716930628464  E_coul = 198.6986202461212
cycle= 5 E= -507.973072816725  delta_E= -5.42e-09  |g|= 2.54e-07  |ddm|= 0.000332
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58211e-07
diis-c [-1.04038970e-14  1.71498514e-07 -8.77496663e-05  9.76653075e-04
 -1.09495090e-02  1.01006043e+00]
  HOMO = -0.242914219571206  LUMO = 1.16716485924974
  mo_energy =
[-1.20319087e+02 -1.23786372e+01 -6.67718709e+00 -6.67718709e+00
 -6.67718709e+00 -1.17919860e+00 -2.42914220e-01 -2.42914220e-01
 -2.42914220e-01  1.16716486e+00  1.33919354e+01  1.14056249e+02
  6.08288568e+02  2.74744093e+03  1.22261852e+04  4.08474833e+04
  1.04891020e+05  2.30074397e+05  4.55889289e+05  8.44841513e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6716926161316  E_coul = 198.6986197994066
cycle= 6 E= -507.973072816725  delta_E= 2.27e-13  |g|= 1.28e-08  |ddm|= 1.9e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6716926161316  E_coul = 198.6986197994066
  HOMO = -0.242914213026153  LUMO = 1.1671648588252
  mo_energy =
[-1.20319087e+02 -1.23786372e+01 -6.67718708e+00 -6.67718708e+00
 -6.67718708e+00 -1.17919860e+00 -2.42914213e-01 -2.42914213e-01
 -2.42914213e-01  1.16716486e+00  1.33919354e+01  1.14056249e+02
  6.08288568e+02  2.74744093e+03  1.22261852e+04  4.08474833e+04
  1.04891020e+05  2.30074397e+05  4.55889289e+05  8.44841513e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6716926518168  E_coul = 198.6986198350917
Extra cycle  E= -507.973072816725  delta_E= -1.14e-13  |g|= 2.07e-09  |ddm|= 2.36e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907752.5001020457
E1 = -706.6716926518168  E_coul = 198.6986198350917
init E= -507.973072816725
    CPU time for initialize scf      1.44 sec, wall time      0.09 sec
  HOMO = -0.242914212027953  LUMO = 1.16716485980679
  mo_energy =
[-1.20319087e+02 -1.23786372e+01 -6.67718707e+00 -6.67718707e+00
 -6.67718707e+00 -1.17919860e+00 -2.42914212e-01 -2.42914212e-01
 -2.42914212e-01  1.16716486e+00  1.33919354e+01  1.14056249e+02
  6.08288568e+02  2.74744093e+03  1.22261852e+04  4.08474833e+04
  1.04891020e+05  2.30074397e+05  4.55889289e+05  8.44841513e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6716926561731  E_coul = 198.6986198394486
cycle= 1 E= -507.973072816725  delta_E= 5.68e-13  |g|= 1.56e-09  |ddm|= 2.82e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6716926561731  E_coul = 198.6986198394486
  HOMO = -0.242914211907143  LUMO = 1.16716485956185
  mo_energy =
[-1.20319087e+02 -1.23786372e+01 -6.67718707e+00 -6.67718707e+00
 -6.67718707e+00 -1.17919860e+00 -2.42914212e-01 -2.42914212e-01
 -2.42914212e-01  1.16716486e+00  1.33919354e+01  1.14056249e+02
  6.08288568e+02  2.74744093e+03  1.22261852e+04  4.08474833e+04
  1.04891020e+05  2.30074397e+05  4.55889289e+05  8.44841513e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6716926562533  E_coul = 198.6986198395285
Extra cycle  E= -507.973072816725  delta_E= -2.27e-13  |g|= 1.5e-09  |ddm|= 1.92e-10
    CPU time for scf_cycle      1.60 sec, wall time      0.16 sec
exp = [2.63215774e-01 1.17616814e+05 6.69897527e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347466e+03 1.83758102e+04 1.44974736e+03
 3.74029832e+02 1.13228686e+02 3.79227543e+01 8.36987352e+00
 3.35936542e+00 8.60359821e+00 4.92573377e-01]
grad_E = [-9.88227774e-05  4.22445607e-09  6.24958064e-05  1.92603564e-11
  1.14137858e-10  6.57231100e-10  2.57788169e-09  1.07113127e-08
  5.75738218e-08  3.62667404e-06  1.24265511e-07  2.85463013e-06
  2.72993356e-05 -1.99410455e-04  1.18188783e-04 -9.48724130e-05
 -6.93711772e-06  5.25046154e-07 -1.10410061e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263329178823       1
[INPUT] 0    0    [1    /1   ]  117616.814241        1
[INPUT] 0    0    [1    /1   ]  0.670407320234       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992147        1
[INPUT] 0    0    [1    /1   ]  73510.4209682        1
[INPUT] 0    0    [1    /1   ]  36754.7200281        1
[INPUT] 0    0    [1    /1   ]  7303.47465112        1
[INPUT] 0    0    [1    /1   ]  18375.8101733        1
[INPUT] 0    0    [1    /1   ]  1449.74737031        1
[INPUT] 0    0    [1    /1   ]  374.029603612        1
[INPUT] 0    0    [1    /1   ]  113.230274236        1
[INPUT] 0    0    [1    /1   ]  37.9196684299        1
[INPUT] 0    0    [1    /1   ]  8.36650925502        1
[INPUT] 0    0    [1    /1   ]  3.35876362008        1
[INPUT] 1    0    [1    /1   ]  8.6036062532         1
[INPUT] 1    0    [1    /1   ]  0.492576921239       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26332917882300416, 1.0]], [0, [117616.81424087056, 1.0]], [0, [0.6704073202339501, 1.0]], [0, [1176168.1426188834, 1.0]], [0, [588084.0699925388, 1.0]], [0, [294042.0311317367, 1.0]], [0, [147020.99214720982, 1.0]], [0, [73510.42096818498, 1.0]], [0, [36754.72002807983, 1.0]], [0, [7303.474651115015, 1.0]], [0, [18375.81017332174, 1.0]], [0, [1449.7473703138908, 1.0]], [0, [374.0296036119638, 1.0]], [0, [113.23027423582315, 1.0]], [0, [37.91966842986704, 1.0]], [0, [8.36650925501994, 1.0]], [0, [3.3587636200826774, 1.0]], [1, [8.603606253204465, 1.0]], [1, [0.4925769212392952, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26332918]
bas 1, expnt(s) = [117616.81424087]
bas 2, expnt(s) = [0.67040732]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999254]
bas 5, expnt(s) = [294042.03113174]
bas 6, expnt(s) = [147020.99214721]
bas 7, expnt(s) = [73510.42096818]
bas 8, expnt(s) = [36754.72002808]
bas 9, expnt(s) = [7303.47465112]
bas 10, expnt(s) = [18375.81017332]
bas 11, expnt(s) = [1449.74737031]
bas 12, expnt(s) = [374.02960361]
bas 13, expnt(s) = [113.23027424]
bas 14, expnt(s) = [37.91966843]
bas 15, expnt(s) = [8.36650926]
bas 16, expnt(s) = [3.35876362]
bas 17, expnt(s) = [8.60360625]
bas 18, expnt(s) = [0.49257692]
CPU time:       136.96
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63329179e-01 9.28729548e-01 1.17616814e+05 1.60460109e+04
 6.70407320e-01 1.87184156e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347465e+03 1.99600750e+03
 1.83758102e+04 3.98749266e+03 1.44974737e+03 5.93586850e+02
 3.74029604e+02 2.14879264e+02 1.13230274e+02 8.76974456e+01
 3.79196684e+01 3.86067659e+01 8.36650926e+00 1.24286296e+01
 3.35876362e+00 6.26829756e+00 8.60360625e+00 4.29867935e+01
 4.92576921e-01 1.20386272e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335763259148912
cond(S) = 907752.3093199764
E1 = -689.5605972378723  E_coul = 184.95957473229052
init E= -504.601022505582
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672494518346051  LUMO = 0.769866533763383
  mo_energy =
[-1.21704871e+02 -1.33853135e+01 -7.62435917e+00 -7.62435917e+00
 -7.62435917e+00 -1.65764051e+00 -6.72494518e-01 -6.72494518e-01
 -6.72494518e-01  7.69866534e-01  1.25037036e+01  1.12741936e+02
  6.06900223e+02  2.74613321e+03  1.22249994e+04  4.08463689e+04
  1.04889945e+05  2.30073347e+05  4.55888257e+05  8.44840495e+05
  1.52801774e+06  2.85028510e+06  5.80817235e+06]
E1 = -707.7273440488716  E_coul = 199.77194907833072
cycle= 1 E= -507.955394970541  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625842
diis-c [-0.39167866  1.        ]
  HOMO = -0.217955475847565  LUMO = 1.17604611858943
  mo_energy =
[-1.20194523e+02 -1.23037609e+01 -6.59471954e+00 -6.59471954e+00
 -6.59471954e+00 -1.16325211e+00 -2.17955476e-01 -2.17955476e-01
 -2.17955476e-01  1.17604612e+00  1.34477370e+01  1.14142388e+02
  6.08396475e+02  2.74756857e+03  1.22263258e+04  4.08476289e+04
  1.04891168e+05  2.30074546e+05  4.55889439e+05  8.44841664e+05
  1.52801890e+06  2.85028625e+06  5.80817349e+06]
E1 = -706.7915870038794  E_coul = 198.81876618168258
cycle= 2 E= -507.972820822197  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.446
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258287
diis-c [-6.64247831e-04  2.70391134e-03  9.97296089e-01]
  HOMO = -0.239673369998029  LUMO = 1.1694503031487
  mo_energy =
[-1.20306736e+02 -1.23696823e+01 -6.66772369e+00 -6.66772369e+00
 -6.66772369e+00 -1.17723575e+00 -2.39673370e-01 -2.39673370e-01
 -2.39673370e-01  1.16945030e+00  1.33967753e+01  1.14048675e+02
  6.08280311e+02  2.74743646e+03  1.22261836e+04  4.08474830e+04
  1.04891021e+05  2.30074398e+05  4.55889291e+05  8.44841515e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6873135006989  E_coul = 198.71424494824655
cycle= 3 E= -507.973068552452  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0029278
diis-c [-1.55201168e-06 -1.75905405e-04 -1.14503335e-01  1.11467924e+00]
  HOMO = -0.24280258785778  LUMO = 1.16827290254168
  mo_energy =
[-1.20318829e+02 -1.23783642e+01 -6.67692080e+00 -6.67692080e+00
 -6.67692080e+00 -1.17913009e+00 -2.42802588e-01 -2.42802588e-01
 -2.42802588e-01  1.16827290e+00  1.33897832e+01  1.14037909e+02
  6.08268046e+02  2.74742331e+03  1.22261699e+04  4.08474691e+04
  1.04891007e+05  2.30074384e+05  4.55889277e+05  8.44841501e+05
  1.52801873e+06  2.85028609e+06  5.80817332e+06]
E1 = -706.6724169721537  E_coul = 198.699343890695
cycle= 4 E= -507.973073081459  delta_E= -4.53e-06  |g|= 0.000157  |ddm|= 0.00914
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108373
diis-c [-6.79537517e-11 -5.33939267e-06  7.33877371e-03 -9.10819850e-02
  1.08374855e+00]
  HOMO = -0.24290697604185  LUMO = 1.1682273984552
  mo_energy =
[-1.20319070e+02 -1.23786184e+01 -6.67716901e+00 -6.67716901e+00
 -6.67716901e+00 -1.17919137e+00 -2.42906976e-01 -2.42906976e-01
 -2.42906976e-01  1.16822740e+00  1.33895675e+01  1.14037664e+02
  6.08267805e+02  2.74742307e+03  1.22261697e+04  4.08474689e+04
  1.04891007e+05  2.30074384e+05  4.55889276e+05  8.44841501e+05
  1.52801873e+06  2.85028609e+06  5.80817332e+06]
E1 = -706.671926582565  E_coul = 198.69885349570225
cycle= 5 E= -507.973073086863  delta_E= -5.4e-09  |g|= 2.54e-07  |ddm|= 0.000332
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.59622e-07
diis-c [-1.03344303e-14  1.76938015e-07 -8.91455662e-05  9.93736053e-04
 -1.11489538e-02  1.01024419e+00]
  HOMO = -0.24290703070665  LUMO = 1.16822754618258
  mo_energy =
[-1.20319071e+02 -1.23786187e+01 -6.67716935e+00 -6.67716935e+00
 -6.67716935e+00 -1.17919153e+00 -2.42907031e-01 -2.42907031e-01
 -2.42907031e-01  1.16822755e+00  1.33895673e+01  1.14037664e+02
  6.08267804e+02  2.74742307e+03  1.22261697e+04  4.08474689e+04
  1.04891007e+05  2.30074384e+05  4.55889276e+05  8.44841501e+05
  1.52801873e+06  2.85028609e+06  5.80817332e+06]
E1 = -706.671926139392  E_coul = 198.69885305252947
cycle= 6 E= -507.973073086863  delta_E= 2.27e-13  |g|= 1.27e-08  |ddm|= 1.88e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.671926139392  E_coul = 198.69885305252947
  HOMO = -0.242907024203047  LUMO = 1.16822754517698
  mo_energy =
[-1.20319071e+02 -1.23786187e+01 -6.67716933e+00 -6.67716933e+00
 -6.67716933e+00 -1.17919152e+00 -2.42907024e-01 -2.42907024e-01
 -2.42907024e-01  1.16822755e+00  1.33895673e+01  1.14037664e+02
  6.08267804e+02  2.74742307e+03  1.22261697e+04  4.08474689e+04
  1.04891007e+05  2.30074384e+05  4.55889276e+05  8.44841501e+05
  1.52801873e+06  2.85028609e+06  5.80817332e+06]
E1 = -706.6719261737923  E_coul = 198.6988530869295
Extra cycle  E= -507.973073086863  delta_E= -2.27e-13  |g|= 2.95e-09  |ddm|= 2.29e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
exp = [2.63329179e-01 1.17616814e+05 6.70407320e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347465e+03 1.83758102e+04 1.44974737e+03
 3.74029604e+02 1.13230274e+02 3.79196684e+01 8.36650926e+00
 3.35876362e+00 8.60360625e+00 4.92576921e-01]
E = -507.97307308686277
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263329178823       1
[INPUT] 0    0    [1    /1   ]  117616.814241        1
[INPUT] 0    0    [1    /1   ]  0.670407320234       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992147        1
[INPUT] 0    0    [1    /1   ]  73510.4209682        1
[INPUT] 0    0    [1    /1   ]  36754.7200281        1
[INPUT] 0    0    [1    /1   ]  7303.47465112        1
[INPUT] 0    0    [1    /1   ]  18375.8101733        1
[INPUT] 0    0    [1    /1   ]  1449.74737031        1
[INPUT] 0    0    [1    /1   ]  374.029603612        1
[INPUT] 0    0    [1    /1   ]  113.230274236        1
[INPUT] 0    0    [1    /1   ]  37.9196684299        1
[INPUT] 0    0    [1    /1   ]  8.36650925502        1
[INPUT] 0    0    [1    /1   ]  3.35876362008        1
[INPUT] 1    0    [1    /1   ]  8.6036062532         1
[INPUT] 1    0    [1    /1   ]  0.492576921239       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26332917882300416, 1.0]], [0, [117616.81424087056, 1.0]], [0, [0.6704073202339501, 1.0]], [0, [1176168.1426188834, 1.0]], [0, [588084.0699925388, 1.0]], [0, [294042.0311317367, 1.0]], [0, [147020.99214720982, 1.0]], [0, [73510.42096818498, 1.0]], [0, [36754.72002807983, 1.0]], [0, [7303.474651115015, 1.0]], [0, [18375.81017332174, 1.0]], [0, [1449.7473703138908, 1.0]], [0, [374.0296036119638, 1.0]], [0, [113.23027423582315, 1.0]], [0, [37.91966842986704, 1.0]], [0, [8.36650925501994, 1.0]], [0, [3.3587636200826774, 1.0]], [1, [8.603606253204465, 1.0]], [1, [0.4925769212392952, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26332918]
bas 1, expnt(s) = [117616.81424087]
bas 2, expnt(s) = [0.67040732]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999254]
bas 5, expnt(s) = [294042.03113174]
bas 6, expnt(s) = [147020.99214721]
bas 7, expnt(s) = [73510.42096818]
bas 8, expnt(s) = [36754.72002808]
bas 9, expnt(s) = [7303.47465112]
bas 10, expnt(s) = [18375.81017332]
bas 11, expnt(s) = [1449.74737031]
bas 12, expnt(s) = [374.02960361]
bas 13, expnt(s) = [113.23027424]
bas 14, expnt(s) = [37.91966843]
bas 15, expnt(s) = [8.36650926]
bas 16, expnt(s) = [3.35876362]
bas 17, expnt(s) = [8.60360625]
bas 18, expnt(s) = [0.49257692]
CPU time:       137.51
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63329179e-01 9.28729548e-01 1.17616814e+05 1.60460109e+04
 6.70407320e-01 1.87184156e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347465e+03 1.99600750e+03
 1.83758102e+04 3.98749266e+03 1.44974737e+03 5.93586850e+02
 3.74029604e+02 2.14879264e+02 1.13230274e+02 8.76974456e+01
 3.79196684e+01 3.86067659e+01 8.36650926e+00 1.24286296e+01
 3.35876362e+00 6.26829756e+00 8.60360625e+00 4.29867935e+01
 4.92576921e-01 1.20386272e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335763259148912
cond(S) = 907752.3093199764
E1 = -689.5605972378723  E_coul = 184.95957473229052
init E= -504.601022505582
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672494518346051  LUMO = 0.769866533763383
  mo_energy =
[-1.21704871e+02 -1.33853135e+01 -7.62435917e+00 -7.62435917e+00
 -7.62435917e+00 -1.65764051e+00 -6.72494518e-01 -6.72494518e-01
 -6.72494518e-01  7.69866534e-01  1.25037036e+01  1.12741936e+02
  6.06900223e+02  2.74613321e+03  1.22249994e+04  4.08463689e+04
  1.04889945e+05  2.30073347e+05  4.55888257e+05  8.44840495e+05
  1.52801774e+06  2.85028510e+06  5.80817235e+06]
E1 = -707.7273440488716  E_coul = 199.77194907833072
cycle= 1 E= -507.955394970541  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625842
diis-c [-0.39167866  1.        ]
  HOMO = -0.217955475847565  LUMO = 1.17604611858943
  mo_energy =
[-1.20194523e+02 -1.23037609e+01 -6.59471954e+00 -6.59471954e+00
 -6.59471954e+00 -1.16325211e+00 -2.17955476e-01 -2.17955476e-01
 -2.17955476e-01  1.17604612e+00  1.34477370e+01  1.14142388e+02
  6.08396475e+02  2.74756857e+03  1.22263258e+04  4.08476289e+04
  1.04891168e+05  2.30074546e+05  4.55889439e+05  8.44841664e+05
  1.52801890e+06  2.85028625e+06  5.80817349e+06]
E1 = -706.7915870038794  E_coul = 198.81876618168258
cycle= 2 E= -507.972820822197  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.446
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258287
diis-c [-6.64247831e-04  2.70391134e-03  9.97296089e-01]
  HOMO = -0.239673369998029  LUMO = 1.1694503031487
  mo_energy =
[-1.20306736e+02 -1.23696823e+01 -6.66772369e+00 -6.66772369e+00
 -6.66772369e+00 -1.17723575e+00 -2.39673370e-01 -2.39673370e-01
 -2.39673370e-01  1.16945030e+00  1.33967753e+01  1.14048675e+02
  6.08280311e+02  2.74743646e+03  1.22261836e+04  4.08474830e+04
  1.04891021e+05  2.30074398e+05  4.55889291e+05  8.44841515e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6873135006989  E_coul = 198.71424494824655
cycle= 3 E= -507.973068552452  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0029278
diis-c [-1.55201168e-06 -1.75905405e-04 -1.14503335e-01  1.11467924e+00]
  HOMO = -0.24280258785778  LUMO = 1.16827290254168
  mo_energy =
[-1.20318829e+02 -1.23783642e+01 -6.67692080e+00 -6.67692080e+00
 -6.67692080e+00 -1.17913009e+00 -2.42802588e-01 -2.42802588e-01
 -2.42802588e-01  1.16827290e+00  1.33897832e+01  1.14037909e+02
  6.08268046e+02  2.74742331e+03  1.22261699e+04  4.08474691e+04
  1.04891007e+05  2.30074384e+05  4.55889277e+05  8.44841501e+05
  1.52801873e+06  2.85028609e+06  5.80817332e+06]
E1 = -706.6724169721537  E_coul = 198.699343890695
cycle= 4 E= -507.973073081459  delta_E= -4.53e-06  |g|= 0.000157  |ddm|= 0.00914
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108373
diis-c [-6.79537517e-11 -5.33939267e-06  7.33877371e-03 -9.10819850e-02
  1.08374855e+00]
  HOMO = -0.24290697604185  LUMO = 1.1682273984552
  mo_energy =
[-1.20319070e+02 -1.23786184e+01 -6.67716901e+00 -6.67716901e+00
 -6.67716901e+00 -1.17919137e+00 -2.42906976e-01 -2.42906976e-01
 -2.42906976e-01  1.16822740e+00  1.33895675e+01  1.14037664e+02
  6.08267805e+02  2.74742307e+03  1.22261697e+04  4.08474689e+04
  1.04891007e+05  2.30074384e+05  4.55889276e+05  8.44841501e+05
  1.52801873e+06  2.85028609e+06  5.80817332e+06]
E1 = -706.671926582565  E_coul = 198.69885349570225
cycle= 5 E= -507.973073086863  delta_E= -5.4e-09  |g|= 2.54e-07  |ddm|= 0.000332
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.59622e-07
diis-c [-1.03344303e-14  1.76938015e-07 -8.91455662e-05  9.93736053e-04
 -1.11489538e-02  1.01024419e+00]
  HOMO = -0.24290703070665  LUMO = 1.16822754618258
  mo_energy =
[-1.20319071e+02 -1.23786187e+01 -6.67716935e+00 -6.67716935e+00
 -6.67716935e+00 -1.17919153e+00 -2.42907031e-01 -2.42907031e-01
 -2.42907031e-01  1.16822755e+00  1.33895673e+01  1.14037664e+02
  6.08267804e+02  2.74742307e+03  1.22261697e+04  4.08474689e+04
  1.04891007e+05  2.30074384e+05  4.55889276e+05  8.44841501e+05
  1.52801873e+06  2.85028609e+06  5.80817332e+06]
E1 = -706.671926139392  E_coul = 198.69885305252947
cycle= 6 E= -507.973073086863  delta_E= 2.27e-13  |g|= 1.27e-08  |ddm|= 1.88e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.671926139392  E_coul = 198.69885305252947
  HOMO = -0.242907024203047  LUMO = 1.16822754517698
  mo_energy =
[-1.20319071e+02 -1.23786187e+01 -6.67716933e+00 -6.67716933e+00
 -6.67716933e+00 -1.17919152e+00 -2.42907024e-01 -2.42907024e-01
 -2.42907024e-01  1.16822755e+00  1.33895673e+01  1.14037664e+02
  6.08267804e+02  2.74742307e+03  1.22261697e+04  4.08474689e+04
  1.04891007e+05  2.30074384e+05  4.55889276e+05  8.44841501e+05
  1.52801873e+06  2.85028609e+06  5.80817332e+06]
E1 = -706.6719261737923  E_coul = 198.6988530869295
Extra cycle  E= -507.973073086863  delta_E= -2.27e-13  |g|= 2.95e-09  |ddm|= 2.29e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907752.3093199764
E1 = -706.6719261737923  E_coul = 198.6988530869295
init E= -507.973073086863
    CPU time for initialize scf      1.44 sec, wall time      0.09 sec
  HOMO = -0.242907023231605  LUMO = 1.16822754807284
  mo_energy =
[-1.20319071e+02 -1.23786187e+01 -6.67716933e+00 -6.67716933e+00
 -6.67716933e+00 -1.17919152e+00 -2.42907023e-01 -2.42907023e-01
 -2.42907023e-01  1.16822755e+00  1.33895673e+01  1.14037664e+02
  6.08267804e+02  2.74742307e+03  1.22261697e+04  4.08474689e+04
  1.04891007e+05  2.30074384e+05  4.55889276e+05  8.44841501e+05
  1.52801873e+06  2.85028609e+06  5.80817332e+06]
E1 = -706.6719261775851  E_coul = 198.6988530907227
cycle= 1 E= -507.973073086862  delta_E= 3.98e-13  |g|= 1.54e-09  |ddm|= 2.43e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6719261775851  E_coul = 198.6988530907227
  HOMO = -0.242907023136357  LUMO = 1.16822754599769
  mo_energy =
[-1.20319071e+02 -1.23786187e+01 -6.67716933e+00 -6.67716933e+00
 -6.67716933e+00 -1.17919152e+00 -2.42907023e-01 -2.42907023e-01
 -2.42907023e-01  1.16822755e+00  1.33895674e+01  1.14037664e+02
  6.08267804e+02  2.74742307e+03  1.22261697e+04  4.08474689e+04
  1.04891007e+05  2.30074384e+05  4.55889276e+05  8.44841501e+05
  1.52801873e+06  2.85028609e+06  5.80817332e+06]
E1 = -706.6719261798946  E_coul = 198.6988530930323
Extra cycle  E= -507.973073086862  delta_E= 5.68e-14  |g|= 1.24e-09  |ddm|= 1.48e-09
    CPU time for scf_cycle      1.61 sec, wall time      0.16 sec
exp = [2.63329179e-01 1.17616814e+05 6.70407320e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347465e+03 1.83758102e+04 1.44974737e+03
 3.74029604e+02 1.13230274e+02 3.79196684e+01 8.36650926e+00
 3.35876362e+00 8.60360625e+00 4.92576921e-01]
grad_E = [-2.12908729e-04  4.22294660e-09  1.37746798e-04  1.92424375e-11
  1.14088875e-10  6.56997418e-10  2.57694888e-09  1.07073809e-08
  5.75544244e-08  3.62528660e-06  1.24206640e-07  2.93454282e-06
  2.61341589e-05 -1.91671072e-04  9.88319920e-05 -1.20495709e-04
  5.38908455e-05  1.88286562e-06  2.85216245e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263462138588       1
[INPUT] 0    0    [1    /1   ]  117616.814241        1
[INPUT] 0    0    [1    /1   ]  0.670979009654       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992147        1
[INPUT] 0    0    [1    /1   ]  73510.4209681        1
[INPUT] 0    0    [1    /1   ]  36754.7200275        1
[INPUT] 0    0    [1    /1   ]  7303.47461563        1
[INPUT] 0    0    [1    /1   ]  18375.8101721        1
[INPUT] 0    0    [1    /1   ]  1449.74735718        1
[INPUT] 0    0    [1    /1   ]  374.029123065        1
[INPUT] 0    0    [1    /1   ]  113.233689458        1
[INPUT] 0    0    [1    /1   ]  37.9151392617        1
[INPUT] 0    0    [1    /1   ]  8.36328405522        1
[INPUT] 0    0    [1    /1   ]  3.35827668939        1
[INPUT] 1    0    [1    /1   ]  8.60361801434        1
[INPUT] 1    0    [1    /1   ]  0.492581754665       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26346213858807327, 1.0]], [0, [117616.81424082925, 1.0]], [0, [0.6709790096544564, 1.0]], [0, [1176168.1426188832, 1.0]], [0, [588084.0699925376, 1.0]], [0, [294042.0311317303, 1.0]], [0, [147020.99214718462, 1.0]], [0, [73510.4209680802, 1.0]], [0, [36754.720027516996, 1.0]], [0, [7303.474615630253, 1.0]], [0, [18375.810172103927, 1.0]], [0, [1449.7473571751723, 1.0]], [0, [374.0291230649071, 1.0]], [0, [113.23368945846016, 1.0]], [0, [37.91513926172856, 1.0]], [0, [8.363284055217749, 1.0]], [0, [3.358276689390367, 1.0]], [1, [8.603618014335956, 1.0]], [1, [0.49258175466485093, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26346214]
bas 1, expnt(s) = [117616.81424083]
bas 2, expnt(s) = [0.67097901]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999254]
bas 5, expnt(s) = [294042.03113173]
bas 6, expnt(s) = [147020.99214718]
bas 7, expnt(s) = [73510.42096808]
bas 8, expnt(s) = [36754.72002752]
bas 9, expnt(s) = [7303.47461563]
bas 10, expnt(s) = [18375.8101721]
bas 11, expnt(s) = [1449.74735718]
bas 12, expnt(s) = [374.02912306]
bas 13, expnt(s) = [113.23368946]
bas 14, expnt(s) = [37.91513926]
bas 15, expnt(s) = [8.36328406]
bas 16, expnt(s) = [3.35827669]
bas 17, expnt(s) = [8.60361801]
bas 18, expnt(s) = [0.49258175]
CPU time:       142.24
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63462139e-01 9.29081225e-01 1.17616814e+05 1.60460109e+04
 6.70979010e-01 1.87303859e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347462e+03 1.99600749e+03
 1.83758102e+04 3.98749266e+03 1.44974736e+03 5.93586846e+02
 3.74029123e+02 2.14879057e+02 1.13233689e+02 8.76994294e+01
 3.79151393e+01 3.86033075e+01 8.36328406e+00 1.24250361e+01
 3.35827669e+00 6.26761600e+00 8.60361801e+00 4.29868669e+01
 4.92581755e-01 1.20387749e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33575573605064
cond(S) = 907752.1330888452
E1 = -689.5609589692443  E_coul = 184.95983135449697
init E= -504.601127614747
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672486686095193  LUMO = 0.770923532422426
  mo_energy =
[-1.21704846e+02 -1.33852932e+01 -7.62434255e+00 -7.62434255e+00
 -7.62434255e+00 -1.65763399e+00 -6.72486686e-01 -6.72486686e-01
 -6.72486686e-01  7.70923532e-01  1.25022407e+01  1.12722769e+02
  6.06879832e+02  2.74611702e+03  1.22249854e+04  4.08463560e+04
  1.04889932e+05  2.30073335e+05  4.55888245e+05  8.44840483e+05
  1.52801773e+06  2.85028509e+06  5.80817234e+06]
E1 = -707.7277515857049  E_coul = 199.7723589369069
cycle= 1 E= -507.955392648798  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625834
diis-c [-0.39166855  1.        ]
  HOMO = -0.217945494020348  LUMO = 1.17727842286719
  mo_energy =
[-1.20194490e+02 -1.23037262e+01 -6.59468679e+00 -6.59468679e+00
 -6.59468679e+00 -1.16324302e+00 -2.17945494e-01 -2.17945494e-01
 -2.17945494e-01  1.17727842e+00  1.34461555e+01  1.14123216e+02
  6.08376084e+02  2.74755237e+03  1.22263118e+04  4.08476159e+04
  1.04891156e+05  2.30074534e+05  4.55889427e+05  8.44841652e+05
  1.52801888e+06  2.85028624e+06  5.80817348e+06]
E1 = -706.791884032992  E_coul = 198.81906252563564
cycle= 2 E= -507.972821507356  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.446
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258283
diis-c [-6.64228585e-04  2.70420588e-03  9.97295794e-01]
  HOMO = -0.23966446682094  LUMO = 1.17067482300039
  mo_energy =
[-1.20306717e+02 -1.23696570e+01 -6.66770110e+00 -6.66770110e+00
 -6.66770110e+00 -1.17722693e+00 -2.39664467e-01 -2.39664467e-01
 -2.39664467e-01  1.17067482e+00  1.33951919e+01  1.14029494e+02
  6.08259908e+02  2.74742025e+03  1.22261696e+04  4.08474700e+04
  1.04891008e+05  2.30074386e+05  4.55889279e+05  8.44841503e+05
  1.52801874e+06  2.85028609e+06  5.80817333e+06]
E1 = -706.6876303674351  E_coul = 198.71456124446993
cycle= 3 E= -507.973069122965  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0597
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292715
diis-c [-1.55129035e-06 -1.75542074e-04 -1.14477174e-01  1.11465272e+00]
  HOMO = -0.242792588242358  LUMO = 1.16949674151433
  mo_energy =
[-1.20318807e+02 -1.23783373e+01 -6.67689656e+00 -6.67689656e+00
 -6.67689656e+00 -1.17912052e+00 -2.42792588e-01 -2.42792588e-01
 -2.42792588e-01  1.16949674e+00  1.33882021e+01  1.14018729e+02
  6.08247644e+02  2.74740710e+03  1.22261559e+04  4.08474562e+04
  1.04890994e+05  2.30074372e+05  4.55889265e+05  8.44841489e+05
  1.52801872e+06  2.85028608e+06  5.80817331e+06]
E1 = -706.6727424813021  E_coul = 198.69966883480237
cycle= 4 E= -507.9730736465  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108296
diis-c [-6.79198557e-11 -5.32698872e-06  7.33576788e-03 -9.10477982e-02
  1.08371736e+00]
  HOMO = -0.24289684263532  LUMO = 1.16945125630118
  mo_energy =
[-1.20319048e+02 -1.23785912e+01 -6.67714447e+00 -6.67714447e+00
 -6.67714447e+00 -1.17918172e+00 -2.42896843e-01 -2.42896843e-01
 -2.42896843e-01  1.16945126e+00  1.33879867e+01  1.14018485e+02
  6.08247404e+02  2.74740687e+03  1.22261557e+04  4.08474559e+04
  1.04890994e+05  2.30074372e+05  4.55889264e+05  8.44841489e+05
  1.52801872e+06  2.85028608e+06  5.80817331e+06]
E1 = -706.6722528458033  E_coul = 198.69917919391563
cycle= 5 E= -507.973073651888  delta_E= -5.39e-09  |g|= 2.53e-07  |ddm|= 0.000331
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.57858e-07
diis-c [-1.04664814e-14  1.72619998e-07 -8.77045759e-05  9.76561930e-04
 -1.09569200e-02  1.01006789e+00]
  HOMO = -0.242896897042564  LUMO = 1.16945140583628
  mo_energy =
[-1.20319049e+02 -1.23785914e+01 -6.67714480e+00 -6.67714480e+00
 -6.67714480e+00 -1.17918188e+00 -2.42896897e-01 -2.42896897e-01
 -2.42896897e-01  1.16945141e+00  1.33879865e+01  1.14018485e+02
  6.08247403e+02  2.74740686e+03  1.22261557e+04  4.08474559e+04
  1.04890994e+05  2.30074372e+05  4.55889264e+05  8.44841489e+05
  1.52801872e+06  2.85028608e+06  5.80817331e+06]
E1 = -706.672252402699  E_coul = 198.699178750811
cycle= 6 E= -507.973073651888  delta_E= -2.27e-13  |g|= 1.33e-08  |ddm|= 1.88e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.672252402699  E_coul = 198.699178750811
  HOMO = -0.242896890523135  LUMO = 1.16945140537981
  mo_energy =
[-1.20319049e+02 -1.23785914e+01 -6.67714478e+00 -6.67714478e+00
 -6.67714478e+00 -1.17918187e+00 -2.42896891e-01 -2.42896891e-01
 -2.42896891e-01  1.16945141e+00  1.33879865e+01  1.14018485e+02
  6.08247403e+02  2.74740686e+03  1.22261557e+04  4.08474559e+04
  1.04890994e+05  2.30074372e+05  4.55889264e+05  8.44841489e+05
  1.52801872e+06  2.85028608e+06  5.80817331e+06]
E1 = -706.6722524396845  E_coul = 198.69917878779674
Extra cycle  E= -507.973073651888  delta_E= 2.27e-13  |g|= 1.86e-09  |ddm|= 2.44e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.63462139e-01 1.17616814e+05 6.70979010e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347462e+03 1.83758102e+04 1.44974736e+03
 3.74029123e+02 1.13233689e+02 3.79151393e+01 8.36328406e+00
 3.35827669e+00 8.60361801e+00 4.92581755e-01]
E = -507.9730736518877
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263462138588       1
[INPUT] 0    0    [1    /1   ]  117616.814241        1
[INPUT] 0    0    [1    /1   ]  0.670979009654       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992147        1
[INPUT] 0    0    [1    /1   ]  73510.4209681        1
[INPUT] 0    0    [1    /1   ]  36754.7200275        1
[INPUT] 0    0    [1    /1   ]  7303.47461563        1
[INPUT] 0    0    [1    /1   ]  18375.8101721        1
[INPUT] 0    0    [1    /1   ]  1449.74735718        1
[INPUT] 0    0    [1    /1   ]  374.029123065        1
[INPUT] 0    0    [1    /1   ]  113.233689458        1
[INPUT] 0    0    [1    /1   ]  37.9151392617        1
[INPUT] 0    0    [1    /1   ]  8.36328405522        1
[INPUT] 0    0    [1    /1   ]  3.35827668939        1
[INPUT] 1    0    [1    /1   ]  8.60361801434        1
[INPUT] 1    0    [1    /1   ]  0.492581754665       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26346213858807327, 1.0]], [0, [117616.81424082925, 1.0]], [0, [0.6709790096544564, 1.0]], [0, [1176168.1426188832, 1.0]], [0, [588084.0699925376, 1.0]], [0, [294042.0311317303, 1.0]], [0, [147020.99214718462, 1.0]], [0, [73510.4209680802, 1.0]], [0, [36754.720027516996, 1.0]], [0, [7303.474615630253, 1.0]], [0, [18375.810172103927, 1.0]], [0, [1449.7473571751723, 1.0]], [0, [374.0291230649071, 1.0]], [0, [113.23368945846016, 1.0]], [0, [37.91513926172856, 1.0]], [0, [8.363284055217749, 1.0]], [0, [3.358276689390367, 1.0]], [1, [8.603618014335956, 1.0]], [1, [0.49258175466485093, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26346214]
bas 1, expnt(s) = [117616.81424083]
bas 2, expnt(s) = [0.67097901]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999254]
bas 5, expnt(s) = [294042.03113173]
bas 6, expnt(s) = [147020.99214718]
bas 7, expnt(s) = [73510.42096808]
bas 8, expnt(s) = [36754.72002752]
bas 9, expnt(s) = [7303.47461563]
bas 10, expnt(s) = [18375.8101721]
bas 11, expnt(s) = [1449.74735718]
bas 12, expnt(s) = [374.02912306]
bas 13, expnt(s) = [113.23368946]
bas 14, expnt(s) = [37.91513926]
bas 15, expnt(s) = [8.36328406]
bas 16, expnt(s) = [3.35827669]
bas 17, expnt(s) = [8.60361801]
bas 18, expnt(s) = [0.49258175]
CPU time:       142.78
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63462139e-01 9.29081225e-01 1.17616814e+05 1.60460109e+04
 6.70979010e-01 1.87303859e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347462e+03 1.99600749e+03
 1.83758102e+04 3.98749266e+03 1.44974736e+03 5.93586846e+02
 3.74029123e+02 2.14879057e+02 1.13233689e+02 8.76994294e+01
 3.79151393e+01 3.86033075e+01 8.36328406e+00 1.24250361e+01
 3.35827669e+00 6.26761600e+00 8.60361801e+00 4.29868669e+01
 4.92581755e-01 1.20387749e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33575573605064
cond(S) = 907752.1330888452
E1 = -689.5609589692443  E_coul = 184.95983135449697
init E= -504.601127614747
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672486686095193  LUMO = 0.770923532422426
  mo_energy =
[-1.21704846e+02 -1.33852932e+01 -7.62434255e+00 -7.62434255e+00
 -7.62434255e+00 -1.65763399e+00 -6.72486686e-01 -6.72486686e-01
 -6.72486686e-01  7.70923532e-01  1.25022407e+01  1.12722769e+02
  6.06879832e+02  2.74611702e+03  1.22249854e+04  4.08463560e+04
  1.04889932e+05  2.30073335e+05  4.55888245e+05  8.44840483e+05
  1.52801773e+06  2.85028509e+06  5.80817234e+06]
E1 = -707.7277515857049  E_coul = 199.7723589369069
cycle= 1 E= -507.955392648798  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625834
diis-c [-0.39166855  1.        ]
  HOMO = -0.217945494020348  LUMO = 1.17727842286719
  mo_energy =
[-1.20194490e+02 -1.23037262e+01 -6.59468679e+00 -6.59468679e+00
 -6.59468679e+00 -1.16324302e+00 -2.17945494e-01 -2.17945494e-01
 -2.17945494e-01  1.17727842e+00  1.34461555e+01  1.14123216e+02
  6.08376084e+02  2.74755237e+03  1.22263118e+04  4.08476159e+04
  1.04891156e+05  2.30074534e+05  4.55889427e+05  8.44841652e+05
  1.52801888e+06  2.85028624e+06  5.80817348e+06]
E1 = -706.791884032992  E_coul = 198.81906252563564
cycle= 2 E= -507.972821507356  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.446
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258283
diis-c [-6.64228585e-04  2.70420588e-03  9.97295794e-01]
  HOMO = -0.23966446682094  LUMO = 1.17067482300039
  mo_energy =
[-1.20306717e+02 -1.23696570e+01 -6.66770110e+00 -6.66770110e+00
 -6.66770110e+00 -1.17722693e+00 -2.39664467e-01 -2.39664467e-01
 -2.39664467e-01  1.17067482e+00  1.33951919e+01  1.14029494e+02
  6.08259908e+02  2.74742025e+03  1.22261696e+04  4.08474700e+04
  1.04891008e+05  2.30074386e+05  4.55889279e+05  8.44841503e+05
  1.52801874e+06  2.85028609e+06  5.80817333e+06]
E1 = -706.6876303674351  E_coul = 198.71456124446993
cycle= 3 E= -507.973069122965  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0597
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292715
diis-c [-1.55129035e-06 -1.75542074e-04 -1.14477174e-01  1.11465272e+00]
  HOMO = -0.242792588242358  LUMO = 1.16949674151433
  mo_energy =
[-1.20318807e+02 -1.23783373e+01 -6.67689656e+00 -6.67689656e+00
 -6.67689656e+00 -1.17912052e+00 -2.42792588e-01 -2.42792588e-01
 -2.42792588e-01  1.16949674e+00  1.33882021e+01  1.14018729e+02
  6.08247644e+02  2.74740710e+03  1.22261559e+04  4.08474562e+04
  1.04890994e+05  2.30074372e+05  4.55889265e+05  8.44841489e+05
  1.52801872e+06  2.85028608e+06  5.80817331e+06]
E1 = -706.6727424813021  E_coul = 198.69966883480237
cycle= 4 E= -507.9730736465  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108296
diis-c [-6.79198557e-11 -5.32698872e-06  7.33576788e-03 -9.10477982e-02
  1.08371736e+00]
  HOMO = -0.24289684263532  LUMO = 1.16945125630118
  mo_energy =
[-1.20319048e+02 -1.23785912e+01 -6.67714447e+00 -6.67714447e+00
 -6.67714447e+00 -1.17918172e+00 -2.42896843e-01 -2.42896843e-01
 -2.42896843e-01  1.16945126e+00  1.33879867e+01  1.14018485e+02
  6.08247404e+02  2.74740687e+03  1.22261557e+04  4.08474559e+04
  1.04890994e+05  2.30074372e+05  4.55889264e+05  8.44841489e+05
  1.52801872e+06  2.85028608e+06  5.80817331e+06]
E1 = -706.6722528458033  E_coul = 198.69917919391563
cycle= 5 E= -507.973073651888  delta_E= -5.39e-09  |g|= 2.53e-07  |ddm|= 0.000331
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.57858e-07
diis-c [-1.04664814e-14  1.72619998e-07 -8.77045759e-05  9.76561930e-04
 -1.09569200e-02  1.01006789e+00]
  HOMO = -0.242896897042564  LUMO = 1.16945140583628
  mo_energy =
[-1.20319049e+02 -1.23785914e+01 -6.67714480e+00 -6.67714480e+00
 -6.67714480e+00 -1.17918188e+00 -2.42896897e-01 -2.42896897e-01
 -2.42896897e-01  1.16945141e+00  1.33879865e+01  1.14018485e+02
  6.08247403e+02  2.74740686e+03  1.22261557e+04  4.08474559e+04
  1.04890994e+05  2.30074372e+05  4.55889264e+05  8.44841489e+05
  1.52801872e+06  2.85028608e+06  5.80817331e+06]
E1 = -706.672252402699  E_coul = 198.699178750811
cycle= 6 E= -507.973073651888  delta_E= -2.27e-13  |g|= 1.33e-08  |ddm|= 1.88e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.672252402699  E_coul = 198.699178750811
  HOMO = -0.242896890523135  LUMO = 1.16945140537981
  mo_energy =
[-1.20319049e+02 -1.23785914e+01 -6.67714478e+00 -6.67714478e+00
 -6.67714478e+00 -1.17918187e+00 -2.42896891e-01 -2.42896891e-01
 -2.42896891e-01  1.16945141e+00  1.33879865e+01  1.14018485e+02
  6.08247403e+02  2.74740686e+03  1.22261557e+04  4.08474559e+04
  1.04890994e+05  2.30074372e+05  4.55889264e+05  8.44841489e+05
  1.52801872e+06  2.85028608e+06  5.80817331e+06]
E1 = -706.6722524396845  E_coul = 198.69917878779674
Extra cycle  E= -507.973073651888  delta_E= 2.27e-13  |g|= 1.86e-09  |ddm|= 2.44e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907752.1330888452
E1 = -706.6722524396845  E_coul = 198.69917878779674
init E= -507.973073651888
    CPU time for initialize scf      1.44 sec, wall time      0.09 sec
  HOMO = -0.242896889494944  LUMO = 1.1694514051168
  mo_energy =
[-1.20319049e+02 -1.23785914e+01 -6.67714478e+00 -6.67714478e+00
 -6.67714478e+00 -1.17918187e+00 -2.42896889e-01 -2.42896889e-01
 -2.42896889e-01  1.16945141e+00  1.33879865e+01  1.14018485e+02
  6.08247403e+02  2.74740686e+03  1.22261557e+04  4.08474559e+04
  1.04890994e+05  2.30074372e+05  4.55889264e+05  8.44841489e+05
  1.52801872e+06  2.85028608e+06  5.80817331e+06]
E1 = -706.672252445529  E_coul = 198.6991787936408
cycle= 1 E= -507.973073651888  delta_E= -4.55e-13  |g|= 9.16e-10  |ddm|= 3.74e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.672252445529  E_coul = 198.6991787936408
  HOMO = -0.242896889332262  LUMO = 1.16945140585322
  mo_energy =
[-1.20319049e+02 -1.23785914e+01 -6.67714478e+00 -6.67714478e+00
 -6.67714478e+00 -1.17918187e+00 -2.42896889e-01 -2.42896889e-01
 -2.42896889e-01  1.16945141e+00  1.33879865e+01  1.14018485e+02
  6.08247403e+02  2.74740686e+03  1.22261557e+04  4.08474559e+04
  1.04890994e+05  2.30074372e+05  4.55889264e+05  8.44841489e+05
  1.52801872e+06  2.85028608e+06  5.80817331e+06]
E1 = -706.6722524459963  E_coul = 198.69917879410858
Extra cycle  E= -507.973073651888  delta_E= 4.55e-13  |g|= 7.92e-10  |ddm|= 2.83e-10
    CPU time for scf_cycle      1.61 sec, wall time      0.16 sec
exp = [2.63462139e-01 1.17616814e+05 6.70979010e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347462e+03 1.83758102e+04 1.44974736e+03
 3.74029123e+02 1.13233689e+02 3.79151393e+01 8.36328406e+00
 3.35827669e+00 8.60361801e+00 4.92581755e-01]
grad_E = [-3.38838587e-04  4.22033178e-09  2.20741420e-04  1.92114154e-11
  1.14004005e-10  6.56592674e-10  2.57533294e-09  1.07005694e-08
  5.75208315e-08  3.62288773e-06  1.24104560e-07  3.07204929e-06
  2.41488487e-05 -1.78847476e-04  6.72975829e-05 -1.49630877e-04
  1.34521479e-04  4.48991266e-06  2.15309002e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263631345608       1
[INPUT] 0    0    [1    /1   ]  117616.814241        1
[INPUT] 0    0    [1    /1   ]  0.67164885983        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992147        1
[INPUT] 0    0    [1    /1   ]  73510.4209677        1
[INPUT] 0    0    [1    /1   ]  36754.7200256        1
[INPUT] 0    0    [1    /1   ]  7303.47449494        1
[INPUT] 0    0    [1    /1   ]  18375.810168         1
[INPUT] 0    0    [1    /1   ]  1449.74727782        1
[INPUT] 0    0    [1    /1   ]  374.027988805        1
[INPUT] 0    0    [1    /1   ]  113.241878056        1
[INPUT] 0    0    [1    /1   ]  37.9076147756        1
[INPUT] 0    0    [1    /1   ]  8.3618783349         1
[INPUT] 0    0    [1    /1   ]  3.35836349333        1
[INPUT] 1    0    [1    /1   ]  8.60363472025        1
[INPUT] 1    0    [1    /1   ]  0.492588408408       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2636313456080298, 1.0]], [0, [117616.81424068869, 1.0]], [0, [0.6716488598300887, 1.0]], [0, [1176168.1426188825, 1.0]], [0, [588084.0699925338, 1.0]], [0, [294042.0311317084, 1.0]], [0, [147020.99214709885, 1.0]], [0, [73510.4209677238, 1.0]], [0, [36754.72002560162, 1.0]], [0, [7303.4744949446185, 1.0]], [0, [18375.810167966658, 1.0]], [0, [1449.747277817843, 1.0]], [0, [374.02798880454174, 1.0]], [0, [113.24187805635482, 1.0]], [0, [37.90761477558088, 1.0]], [0, [8.36187833489519, 1.0]], [0, [3.3583634933335724, 1.0]], [1, [8.603634720247582, 1.0]], [1, [0.4925884084077211, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26363135]
bas 1, expnt(s) = [117616.81424069]
bas 2, expnt(s) = [0.67164886]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999253]
bas 5, expnt(s) = [294042.03113171]
bas 6, expnt(s) = [147020.9921471]
bas 7, expnt(s) = [73510.42096772]
bas 8, expnt(s) = [36754.7200256]
bas 9, expnt(s) = [7303.47449494]
bas 10, expnt(s) = [18375.81016797]
bas 11, expnt(s) = [1449.74727782]
bas 12, expnt(s) = [374.0279888]
bas 13, expnt(s) = [113.24187806]
bas 14, expnt(s) = [37.90761478]
bas 15, expnt(s) = [8.36187833]
bas 16, expnt(s) = [3.35836349]
bas 17, expnt(s) = [8.60363472]
bas 18, expnt(s) = [0.49258841]
CPU time:       147.50
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63631346e-01 9.29528712e-01 1.17616814e+05 1.60460109e+04
 6.71648860e-01 1.87444083e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347449e+03 1.99600747e+03
 1.83758102e+04 3.98749265e+03 1.44974728e+03 5.93586822e+02
 3.74027989e+02 2.14878568e+02 1.13241878e+02 8.77041859e+01
 3.79076148e+01 3.85975615e+01 8.36187833e+00 1.24234698e+01
 3.35836349e+00 6.26773750e+00 8.60363472e+00 4.29869712e+01
 4.92588408e-01 1.20389782e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335745064890492
cond(S) = 907752.0880517316
E1 = -689.5615348987884  E_coul = 184.96017750435877
init E= -504.60135739443
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672476525496877  LUMO = 0.772229354899216
  mo_energy =
[-1.21704814e+02 -1.33852620e+01 -7.62432017e+00 -7.62432017e+00
 -7.62432017e+00 -1.65762546e+00 -6.72476525e-01 -6.72476525e-01
 -6.72476525e-01  7.72229355e-01  1.25047166e+01  1.12710171e+02
  6.06869678e+02  2.74611361e+03  1.22249830e+04  4.08463536e+04
  1.04889930e+05  2.30073333e+05  4.55888243e+05  8.44840481e+05
  1.52801772e+06  2.85028509e+06  5.80817234e+06]
E1 = -707.7283035662632  E_coul = 199.77291284062684
cycle= 1 E= -507.955390725636  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625825
diis-c [-0.39165663  1.        ]
  HOMO = -0.217931367134523  LUMO = 1.17880696313454
  mo_energy =
[-1.20194452e+02 -1.23036756e+01 -6.59464292e+00 -6.59464292e+00
 -6.59464292e+00 -1.16323010e+00 -2.17931367e-01 -2.17931367e-01
 -2.17931367e-01  1.17880696e+00  1.34485929e+01  1.14110611e+02
  6.08365924e+02  2.74754896e+03  1.22263094e+04  4.08476135e+04
  1.04891153e+05  2.30074532e+05  4.55889425e+05  8.44841650e+05
  1.52801888e+06  2.85028624e+06  5.80817348e+06]
E1 = -706.7923142808125  E_coul = 198.81949131612703
cycle= 2 E= -507.972822964686  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.446
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258276
diis-c [-6.64189279e-04  2.70485514e-03  9.97295145e-01]
  HOMO = -0.239651614607606  LUMO = 1.17219337586435
  mo_energy =
[-1.20306692e+02 -1.23696168e+01 -6.66766833e+00 -6.66766833e+00
 -6.66766833e+00 -1.17721437e+00 -2.39651615e-01 -2.39651615e-01
 -2.39651615e-01  1.17219338e+00  1.33976204e+01  1.14016879e+02
  6.08249733e+02  2.74741682e+03  1.22261671e+04  4.08474676e+04
  1.04891006e+05  2.30074383e+05  4.55889276e+05  8.44841501e+05
  1.52801873e+06  2.85028609e+06  5.80817333e+06]
E1 = -706.6880848556344  E_coul = 198.715014413553
cycle= 3 E= -507.973070442081  delta_E= -0.000247  |g|= 0.00434  |ddm|= 0.0597
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292627
diis-c [-1.55040251e-06 -1.75108496e-04 -1.14442208e-01  1.11461732e+00]
  HOMO = -0.242778403725184  LUMO = 1.17101439812068
  mo_energy =
[-1.20318781e+02 -1.23782951e+01 -6.67686175e+00 -6.67686175e+00
 -6.67686175e+00 -1.17910704e+00 -2.42778404e-01 -2.42778404e-01
 -2.42778404e-01  1.17101440e+00  1.33906324e+01  1.14006117e+02
  6.08237471e+02  2.74740368e+03  1.22261535e+04  4.08474537e+04
  1.04890992e+05  2.30074369e+05  4.55889262e+05  8.44841487e+05
  1.52801872e+06  2.85028608e+06  5.80817331e+06]
E1 = -706.6732074401255  E_coul = 198.70013248116697
cycle= 4 E= -507.973074958958  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00912
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108207
diis-c [-6.78615733e-11 -5.32931885e-06  7.33238052e-03 -9.10107748e-02
  1.08368372e+00]
  HOMO = -0.242882503059507  LUMO = 1.17096893602871
  mo_energy =
[-1.20319021e+02 -1.23785486e+01 -6.67710933e+00 -6.67710933e+00
 -6.67710933e+00 -1.17916815e+00 -2.42882503e-01 -2.42882503e-01
 -2.42882503e-01  1.17096894e+00  1.33904173e+01  1.14005873e+02
  6.08237231e+02  2.74740344e+03  1.22261532e+04  4.08474535e+04
  1.04890992e+05  2.30074369e+05  4.55889262e+05  8.44841486e+05
  1.52801872e+06  2.85028608e+06  5.80817331e+06]
E1 = -706.672718676928  E_coul = 198.69964371260008
cycle= 5 E= -507.973074964328  delta_E= -5.37e-09  |g|= 2.53e-07  |ddm|= 0.00033
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58153e-07
diis-c [-1.03009058e-14  1.76082660e-07 -8.91765288e-05  9.94992665e-04
 -1.11679224e-02  1.01026193e+00]
  HOMO = -0.242882556454429  LUMO = 1.17096908123116
  mo_energy =
[-1.20319022e+02 -1.23785489e+01 -6.67710966e+00 -6.67710966e+00
 -6.67710966e+00 -1.17916831e+00 -2.42882556e-01 -2.42882556e-01
 -2.42882556e-01  1.17096908e+00  1.33904172e+01  1.14005873e+02
  6.08237230e+02  2.74740344e+03  1.22261532e+04  4.08474535e+04
  1.04890992e+05  2.30074369e+05  4.55889262e+05  8.44841486e+05
  1.52801872e+06  2.85028608e+06  5.80817331e+06]
E1 = -706.6727182454017  E_coul = 198.69964328107363
cycle= 6 E= -507.973074964328  delta_E= -1.71e-13  |g|= 1.22e-08  |ddm|= 1.82e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6727182454017  E_coul = 198.69964328107363
  HOMO = -0.242882549876364  LUMO = 1.17096908231832
  mo_energy =
[-1.20319022e+02 -1.23785489e+01 -6.67710965e+00 -6.67710965e+00
 -6.67710965e+00 -1.17916830e+00 -2.42882550e-01 -2.42882550e-01
 -2.42882550e-01  1.17096908e+00  1.33904172e+01  1.14005873e+02
  6.08237230e+02  2.74740344e+03  1.22261532e+04  4.08474535e+04
  1.04890992e+05  2.30074369e+05  4.55889262e+05  8.44841486e+05
  1.52801872e+06  2.85028608e+06  5.80817331e+06]
E1 = -706.6727182793128  E_coul = 198.69964331498463
Extra cycle  E= -507.973074964328  delta_E= -5.68e-14  |g|= 2.07e-09  |ddm|= 2.25e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
exp = [2.63631346e-01 1.17616814e+05 6.71648860e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347449e+03 1.83758102e+04 1.44974728e+03
 3.74027989e+02 1.13241878e+02 3.79076148e+01 8.36187833e+00
 3.35836349e+00 8.60363472e+00 4.92588408e-01]
E = -507.97307496432813
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263631345608       1
[INPUT] 0    0    [1    /1   ]  117616.814241        1
[INPUT] 0    0    [1    /1   ]  0.67164885983        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992147        1
[INPUT] 0    0    [1    /1   ]  73510.4209677        1
[INPUT] 0    0    [1    /1   ]  36754.7200256        1
[INPUT] 0    0    [1    /1   ]  7303.47449494        1
[INPUT] 0    0    [1    /1   ]  18375.810168         1
[INPUT] 0    0    [1    /1   ]  1449.74727782        1
[INPUT] 0    0    [1    /1   ]  374.027988805        1
[INPUT] 0    0    [1    /1   ]  113.241878056        1
[INPUT] 0    0    [1    /1   ]  37.9076147756        1
[INPUT] 0    0    [1    /1   ]  8.3618783349         1
[INPUT] 0    0    [1    /1   ]  3.35836349333        1
[INPUT] 1    0    [1    /1   ]  8.60363472025        1
[INPUT] 1    0    [1    /1   ]  0.492588408408       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2636313456080298, 1.0]], [0, [117616.81424068869, 1.0]], [0, [0.6716488598300887, 1.0]], [0, [1176168.1426188825, 1.0]], [0, [588084.0699925338, 1.0]], [0, [294042.0311317084, 1.0]], [0, [147020.99214709885, 1.0]], [0, [73510.4209677238, 1.0]], [0, [36754.72002560162, 1.0]], [0, [7303.4744949446185, 1.0]], [0, [18375.810167966658, 1.0]], [0, [1449.747277817843, 1.0]], [0, [374.02798880454174, 1.0]], [0, [113.24187805635482, 1.0]], [0, [37.90761477558088, 1.0]], [0, [8.36187833489519, 1.0]], [0, [3.3583634933335724, 1.0]], [1, [8.603634720247582, 1.0]], [1, [0.4925884084077211, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26363135]
bas 1, expnt(s) = [117616.81424069]
bas 2, expnt(s) = [0.67164886]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999253]
bas 5, expnt(s) = [294042.03113171]
bas 6, expnt(s) = [147020.9921471]
bas 7, expnt(s) = [73510.42096772]
bas 8, expnt(s) = [36754.7200256]
bas 9, expnt(s) = [7303.47449494]
bas 10, expnt(s) = [18375.81016797]
bas 11, expnt(s) = [1449.74727782]
bas 12, expnt(s) = [374.0279888]
bas 13, expnt(s) = [113.24187806]
bas 14, expnt(s) = [37.90761478]
bas 15, expnt(s) = [8.36187833]
bas 16, expnt(s) = [3.35836349]
bas 17, expnt(s) = [8.60363472]
bas 18, expnt(s) = [0.49258841]
CPU time:       148.08
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63631346e-01 9.29528712e-01 1.17616814e+05 1.60460109e+04
 6.71648860e-01 1.87444083e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347449e+03 1.99600747e+03
 1.83758102e+04 3.98749265e+03 1.44974728e+03 5.93586822e+02
 3.74027989e+02 2.14878568e+02 1.13241878e+02 8.77041859e+01
 3.79076148e+01 3.85975615e+01 8.36187833e+00 1.24234698e+01
 3.35836349e+00 6.26773750e+00 8.60363472e+00 4.29869712e+01
 4.92588408e-01 1.20389782e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335745064890492
cond(S) = 907752.0880517316
E1 = -689.5615348987884  E_coul = 184.96017750435877
init E= -504.60135739443
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.672476525496877  LUMO = 0.772229354899216
  mo_energy =
[-1.21704814e+02 -1.33852620e+01 -7.62432017e+00 -7.62432017e+00
 -7.62432017e+00 -1.65762546e+00 -6.72476525e-01 -6.72476525e-01
 -6.72476525e-01  7.72229355e-01  1.25047166e+01  1.12710171e+02
  6.06869678e+02  2.74611361e+03  1.22249830e+04  4.08463536e+04
  1.04889930e+05  2.30073333e+05  4.55888243e+05  8.44840481e+05
  1.52801772e+06  2.85028509e+06  5.80817234e+06]
E1 = -707.7283035662632  E_coul = 199.77291284062684
cycle= 1 E= -507.955390725636  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.18 sec, wall time      0.01 sec
diis-norm(errvec)=0.625825
diis-c [-0.39165663  1.        ]
  HOMO = -0.217931367134523  LUMO = 1.17880696313454
  mo_energy =
[-1.20194452e+02 -1.23036756e+01 -6.59464292e+00 -6.59464292e+00
 -6.59464292e+00 -1.16323010e+00 -2.17931367e-01 -2.17931367e-01
 -2.17931367e-01  1.17880696e+00  1.34485929e+01  1.14110611e+02
  6.08365924e+02  2.74754896e+03  1.22263094e+04  4.08476135e+04
  1.04891153e+05  2.30074532e+05  4.55889425e+05  8.44841650e+05
  1.52801888e+06  2.85028624e+06  5.80817348e+06]
E1 = -706.7923142808125  E_coul = 198.81949131612703
cycle= 2 E= -507.972822964686  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.446
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258276
diis-c [-6.64189279e-04  2.70485514e-03  9.97295145e-01]
  HOMO = -0.239651614607606  LUMO = 1.17219337586435
  mo_energy =
[-1.20306692e+02 -1.23696168e+01 -6.66766833e+00 -6.66766833e+00
 -6.66766833e+00 -1.17721437e+00 -2.39651615e-01 -2.39651615e-01
 -2.39651615e-01  1.17219338e+00  1.33976204e+01  1.14016879e+02
  6.08249733e+02  2.74741682e+03  1.22261671e+04  4.08474676e+04
  1.04891006e+05  2.30074383e+05  4.55889276e+05  8.44841501e+05
  1.52801873e+06  2.85028609e+06  5.80817333e+06]
E1 = -706.6880848556344  E_coul = 198.715014413553
cycle= 3 E= -507.973070442081  delta_E= -0.000247  |g|= 0.00434  |ddm|= 0.0597
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292627
diis-c [-1.55040251e-06 -1.75108496e-04 -1.14442208e-01  1.11461732e+00]
  HOMO = -0.242778403725184  LUMO = 1.17101439812068
  mo_energy =
[-1.20318781e+02 -1.23782951e+01 -6.67686175e+00 -6.67686175e+00
 -6.67686175e+00 -1.17910704e+00 -2.42778404e-01 -2.42778404e-01
 -2.42778404e-01  1.17101440e+00  1.33906324e+01  1.14006117e+02
  6.08237471e+02  2.74740368e+03  1.22261535e+04  4.08474537e+04
  1.04890992e+05  2.30074369e+05  4.55889262e+05  8.44841487e+05
  1.52801872e+06  2.85028608e+06  5.80817331e+06]
E1 = -706.6732074401255  E_coul = 198.70013248116697
cycle= 4 E= -507.973074958958  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00912
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108207
diis-c [-6.78615733e-11 -5.32931885e-06  7.33238052e-03 -9.10107748e-02
  1.08368372e+00]
  HOMO = -0.242882503059507  LUMO = 1.17096893602871
  mo_energy =
[-1.20319021e+02 -1.23785486e+01 -6.67710933e+00 -6.67710933e+00
 -6.67710933e+00 -1.17916815e+00 -2.42882503e-01 -2.42882503e-01
 -2.42882503e-01  1.17096894e+00  1.33904173e+01  1.14005873e+02
  6.08237231e+02  2.74740344e+03  1.22261532e+04  4.08474535e+04
  1.04890992e+05  2.30074369e+05  4.55889262e+05  8.44841486e+05
  1.52801872e+06  2.85028608e+06  5.80817331e+06]
E1 = -706.672718676928  E_coul = 198.69964371260008
cycle= 5 E= -507.973074964328  delta_E= -5.37e-09  |g|= 2.53e-07  |ddm|= 0.00033
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58153e-07
diis-c [-1.03009058e-14  1.76082660e-07 -8.91765288e-05  9.94992665e-04
 -1.11679224e-02  1.01026193e+00]
  HOMO = -0.242882556454429  LUMO = 1.17096908123116
  mo_energy =
[-1.20319022e+02 -1.23785489e+01 -6.67710966e+00 -6.67710966e+00
 -6.67710966e+00 -1.17916831e+00 -2.42882556e-01 -2.42882556e-01
 -2.42882556e-01  1.17096908e+00  1.33904172e+01  1.14005873e+02
  6.08237230e+02  2.74740344e+03  1.22261532e+04  4.08474535e+04
  1.04890992e+05  2.30074369e+05  4.55889262e+05  8.44841486e+05
  1.52801872e+06  2.85028608e+06  5.80817331e+06]
E1 = -706.6727182454017  E_coul = 198.69964328107363
cycle= 6 E= -507.973074964328  delta_E= -1.71e-13  |g|= 1.22e-08  |ddm|= 1.82e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6727182454017  E_coul = 198.69964328107363
  HOMO = -0.242882549876364  LUMO = 1.17096908231832
  mo_energy =
[-1.20319022e+02 -1.23785489e+01 -6.67710965e+00 -6.67710965e+00
 -6.67710965e+00 -1.17916830e+00 -2.42882550e-01 -2.42882550e-01
 -2.42882550e-01  1.17096908e+00  1.33904172e+01  1.14005873e+02
  6.08237230e+02  2.74740344e+03  1.22261532e+04  4.08474535e+04
  1.04890992e+05  2.30074369e+05  4.55889262e+05  8.44841486e+05
  1.52801872e+06  2.85028608e+06  5.80817331e+06]
E1 = -706.6727182793128  E_coul = 198.69964331498463
Extra cycle  E= -507.973074964328  delta_E= -5.68e-14  |g|= 2.07e-09  |ddm|= 2.25e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907752.0880517316
E1 = -706.6727182793128  E_coul = 198.69964331498463
init E= -507.973074964328
    CPU time for initialize scf      1.44 sec, wall time      0.09 sec
  HOMO = -0.242882548928269  LUMO = 1.17096908214725
  mo_energy =
[-1.20319022e+02 -1.23785489e+01 -6.67710964e+00 -6.67710964e+00
 -6.67710964e+00 -1.17916830e+00 -2.42882549e-01 -2.42882549e-01
 -2.42882549e-01  1.17096908e+00  1.33904172e+01  1.14005873e+02
  6.08237230e+02  2.74740344e+03  1.22261532e+04  4.08474535e+04
  1.04890992e+05  2.30074369e+05  4.55889262e+05  8.44841486e+05
  1.52801872e+06  2.85028608e+06  5.80817331e+06]
E1 = -706.6727182830873  E_coul = 198.69964331875954
cycle= 1 E= -507.973074964328  delta_E= 3.41e-13  |g|= 1.06e-09  |ddm|= 2.52e-09
    CPU time for cycle= 1      0.10 sec, wall time      0.01 sec
E1 = -706.6727182830873  E_coul = 198.69964331875954
  HOMO = -0.242882548815014  LUMO = 1.17096908430005
  mo_energy =
[-1.20319022e+02 -1.23785489e+01 -6.67710964e+00 -6.67710964e+00
 -6.67710964e+00 -1.17916830e+00 -2.42882549e-01 -2.42882549e-01
 -2.42882549e-01  1.17096908e+00  1.33904172e+01  1.14005873e+02
  6.08237230e+02  2.74740344e+03  1.22261532e+04  4.08474535e+04
  1.04890992e+05  2.30074369e+05  4.55889262e+05  8.44841486e+05
  1.52801872e+06  2.85028608e+06  5.80817331e+06]
E1 = -706.672718283365  E_coul = 198.69964331903702
Extra cycle  E= -507.973074964328  delta_E= -2.27e-13  |g|= 2e-09  |ddm|= 4.95e-10
    CPU time for scf_cycle      1.59 sec, wall time      0.16 sec
exp = [2.63631346e-01 1.17616814e+05 6.71648860e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347449e+03 1.83758102e+04 1.44974728e+03
 3.74027989e+02 1.13241878e+02 3.79076148e+01 8.36187833e+00
 3.35836349e+00 8.60363472e+00 4.92588408e-01]
grad_E = [-4.91941018e-04  4.21506387e-09  3.20099062e-04  1.91489485e-11
  1.13832990e-10  6.55777365e-10  2.57207729e-09  1.06868454e-08
  5.74531699e-08  3.61806337e-06  1.23898723e-07  3.34732236e-06
  2.02140772e-05 -1.54162331e-04  7.74812254e-06 -1.76893632e-04
  2.44297390e-04  8.37340938e-06  4.73497293e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263740403149       1
[INPUT] 0    0    [1    /1   ]  117616.81424         1
[INPUT] 0    0    [1    /1   ]  0.67193167581        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992147        1
[INPUT] 0    0    [1    /1   ]  73510.4209669        1
[INPUT] 0    0    [1    /1   ]  36754.7200214        1
[INPUT] 0    0    [1    /1   ]  7303.47423101        1
[INPUT] 0    0    [1    /1   ]  18375.8101589        1
[INPUT] 0    0    [1    /1   ]  1449.74707056        1
[INPUT] 0    0    [1    /1   ]  374.025994349        1
[INPUT] 0    0    [1    /1   ]  113.256457978        1
[INPUT] 0    0    [1    /1   ]  37.8988120522        1
[INPUT] 0    0    [1    /1   ]  8.36802675328        1
[INPUT] 0    0    [1    /1   ]  3.36021304039        1
[INPUT] 1    0    [1    /1   ]  8.60364750531        1
[INPUT] 1    0    [1    /1   ]  0.492593074267       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26374040314911956, 1.0]], [0, [117616.81424038125, 1.0]], [0, [0.6719316758099739, 1.0]], [0, [1176168.142618881, 1.0]], [0, [588084.0699925255, 1.0]], [0, [294042.03113166057, 1.0]], [0, [147020.99214691125, 1.0]], [0, [73510.42096694428, 1.0]], [0, [36754.72002141168, 1.0]], [0, [7303.474231012168, 1.0]], [0, [18375.810158923145, 1.0]], [0, [1449.7470705560054, 1.0]], [0, [374.02599434947217, 1.0]], [0, [113.25645797819207, 1.0]], [0, [37.898812052163485, 1.0]], [0, [8.368026753282496, 1.0]], [0, [3.3602130403860317, 1.0]], [1, [8.603647505306325, 1.0]], [1, [0.4925930742666364, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2637404]
bas 1, expnt(s) = [117616.81424038]
bas 2, expnt(s) = [0.67193168]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999253]
bas 5, expnt(s) = [294042.03113166]
bas 6, expnt(s) = [147020.99214691]
bas 7, expnt(s) = [73510.42096694]
bas 8, expnt(s) = [36754.72002141]
bas 9, expnt(s) = [7303.47423101]
bas 10, expnt(s) = [18375.81015892]
bas 11, expnt(s) = [1449.74707056]
bas 12, expnt(s) = [374.02599435]
bas 13, expnt(s) = [113.25645798]
bas 14, expnt(s) = [37.89881205]
bas 15, expnt(s) = [8.36802675]
bas 16, expnt(s) = [3.36021304]
bas 17, expnt(s) = [8.60364751]
bas 18, expnt(s) = [0.49259307]
CPU time:       152.80
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63740403e-01 9.29817088e-01 1.17616814e+05 1.60460109e+04
 6.71931676e-01 1.87503276e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347423e+03 1.99600741e+03
 1.83758102e+04 3.98749265e+03 1.44974707e+03 5.93586758e+02
 3.74025994e+02 2.14877708e+02 1.13256458e+02 8.77126547e+01
 3.78988121e+01 3.85908391e+01 8.36802675e+00 1.24303203e+01
 3.36021304e+00 6.27032619e+00 8.60364751e+00 4.29870511e+01
 4.92593074e-01 1.20391207e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335736631798273
cond(S) = 907752.5273855382
E1 = -689.5621517394403  E_coul = 184.96041466317723
init E= -504.601737076263
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672470490008045  LUMO = 0.772966110075266
  mo_energy =
[-1.21704800e+02 -1.33852316e+01 -7.62430474e+00 -7.62430474e+00
 -7.62430474e+00 -1.65762029e+00 -6.72470490e-01 -6.72470490e-01
 -6.72470490e-01  7.72966110e-01  1.25175486e+01  1.12733579e+02
  6.06904818e+02  2.74615621e+03  1.22250213e+04  4.08463887e+04
  1.04889963e+05  2.30073365e+05  4.55888274e+05  8.44840512e+05
  1.52801776e+06  2.85028512e+06  5.80817236e+06]
E1 = -707.7286893678872  E_coul = 199.77329737459186
cycle= 1 E= -507.955391993295  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625822
diis-c [-0.39165278  1.        ]
  HOMO = -0.217920571461743  LUMO = 1.17968555323439
  mo_energy =
[-1.20194438e+02 -1.23036315e+01 -6.59461277e+00 -6.59461277e+00
 -6.59461277e+00 -1.16321990e+00 -2.17920571e-01 -2.17920571e-01
 -2.17920571e-01  1.17968555e+00  1.34616911e+01  1.14134017e+02
  6.08401042e+02  2.74759154e+03  1.22263476e+04  4.08476485e+04
  1.04891186e+05  2.30074564e+05  4.55889456e+05  8.44841681e+05
  1.52801891e+06  2.85028627e+06  5.80817350e+06]
E1 = -706.7926698663235  E_coul = 198.8198446158127
cycle= 2 E= -507.972825250511  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.446
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258265
diis-c [-6.64127803e-04  2.70613340e-03  9.97293867e-01]
  HOMO = -0.239641352999031  LUMO = 1.17306532879794
  mo_energy =
[-1.20306681e+02 -1.23695755e+01 -6.66764071e+00 -6.66764071e+00
 -6.66764071e+00 -1.17720438e+00 -2.39641353e-01 -2.39641353e-01
 -2.39641353e-01  1.17306533e+00  1.34106954e+01  1.14040281e+02
  6.08284848e+02  2.74745939e+03  1.22262054e+04  4.08475026e+04
  1.04891039e+05  2.30074416e+05  4.55889308e+05  8.44841531e+05
  1.52801876e+06  2.85028612e+06  5.80817335e+06]
E1 = -706.6884535347114  E_coul = 198.71538087658567
cycle= 3 E= -507.973072658126  delta_E= -0.000247  |g|= 0.00434  |ddm|= 0.0597
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292558
diis-c [-1.54991233e-06 -1.74927720e-04 -1.14415469e-01  1.11459040e+00]
  HOMO = -0.242767445246121  LUMO = 1.1718856936579
  mo_energy =
[-1.20318768e+02 -1.23782527e+01 -6.67683303e+00 -6.67683303e+00
 -6.67683303e+00 -1.17909658e+00 -2.42767445e-01 -2.42767445e-01
 -2.42767445e-01  1.17188569e+00  1.34037062e+01  1.14029520e+02
  6.08272587e+02  2.74744625e+03  1.22261917e+04  4.08474888e+04
  1.04891025e+05  2.30074402e+05  4.55889294e+05  8.44841517e+05
  1.52801875e+06  2.85028611e+06  5.80817334e+06]
E1 = -706.6735814876268  E_coul = 198.70050431613384
cycle= 4 E= -507.973077171493  delta_E= -4.51e-06  |g|= 0.000157  |ddm|= 0.00912
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00010817
diis-c [-6.79686007e-11 -5.31330162e-06  7.33043245e-03 -9.09996737e-02
  1.08367455e+00]
  HOMO = -0.242871483211861  LUMO = 1.17184022716355
  mo_energy =
[-1.20319009e+02 -1.23785062e+01 -6.67708053e+00 -6.67708053e+00
 -6.67708053e+00 -1.17915764e+00 -2.42871483e-01 -2.42871483e-01
 -2.42871483e-01  1.17184023e+00  1.34034911e+01  1.14029276e+02
  6.08272347e+02  2.74744601e+03  1.22261915e+04  4.08474885e+04
  1.04891025e+05  2.30074401e+05  4.55889293e+05  8.44841517e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.673093079476  E_coul = 198.7000159026222
cycle= 5 E= -507.973077176854  delta_E= -5.36e-09  |g|= 2.53e-07  |ddm|= 0.00033
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.57316e-07
diis-c [-1.04388961e-14  1.75286268e-07 -8.90259376e-05  9.94001111e-04
 -1.11643515e-02  1.01025920e+00]
  HOMO = -0.24287153485036  LUMO = 1.17184037540907
  mo_energy =
[-1.20319010e+02 -1.23785064e+01 -6.67708085e+00 -6.67708085e+00
 -6.67708085e+00 -1.17915780e+00 -2.42871535e-01 -2.42871535e-01
 -2.42871535e-01  1.17184038e+00  1.34034910e+01  1.14029276e+02
  6.08272347e+02  2.74744601e+03  1.22261915e+04  4.08474885e+04
  1.04891025e+05  2.30074401e+05  4.55889293e+05  8.44841517e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6730926544973  E_coul = 198.70001547764397
cycle= 6 E= -507.973077176853  delta_E= 4.55e-13  |g|= 1.29e-08  |ddm|= 1.78e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6730926544973  E_coul = 198.70001547764397
  HOMO = -0.242871528177895  LUMO = 1.17184037714648
  mo_energy =
[-1.20319010e+02 -1.23785064e+01 -6.67708083e+00 -6.67708083e+00
 -6.67708083e+00 -1.17915780e+00 -2.42871528e-01 -2.42871528e-01
 -2.42871528e-01  1.17184038e+00  1.34034910e+01  1.14029276e+02
  6.08272347e+02  2.74744601e+03  1.22261915e+04  4.08474885e+04
  1.04891025e+05  2.30074401e+05  4.55889293e+05  8.44841517e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6730926886959  E_coul = 198.70001551184248
Extra cycle  E= -507.973077176853  delta_E= -1.14e-13  |g|= 2.29e-09  |ddm|= 2.27e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.63740403e-01 1.17616814e+05 6.71931676e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347423e+03 1.83758102e+04 1.44974707e+03
 3.74025994e+02 1.13256458e+02 3.78988121e+01 8.36802675e+00
 3.36021304e+00 8.60364751e+00 4.92593074e-01]
E = -507.9730771768534
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263740403149       1
[INPUT] 0    0    [1    /1   ]  117616.81424         1
[INPUT] 0    0    [1    /1   ]  0.67193167581        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992147        1
[INPUT] 0    0    [1    /1   ]  73510.4209669        1
[INPUT] 0    0    [1    /1   ]  36754.7200214        1
[INPUT] 0    0    [1    /1   ]  7303.47423101        1
[INPUT] 0    0    [1    /1   ]  18375.8101589        1
[INPUT] 0    0    [1    /1   ]  1449.74707056        1
[INPUT] 0    0    [1    /1   ]  374.025994349        1
[INPUT] 0    0    [1    /1   ]  113.256457978        1
[INPUT] 0    0    [1    /1   ]  37.8988120522        1
[INPUT] 0    0    [1    /1   ]  8.36802675328        1
[INPUT] 0    0    [1    /1   ]  3.36021304039        1
[INPUT] 1    0    [1    /1   ]  8.60364750531        1
[INPUT] 1    0    [1    /1   ]  0.492593074267       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26374040314911956, 1.0]], [0, [117616.81424038125, 1.0]], [0, [0.6719316758099739, 1.0]], [0, [1176168.142618881, 1.0]], [0, [588084.0699925255, 1.0]], [0, [294042.03113166057, 1.0]], [0, [147020.99214691125, 1.0]], [0, [73510.42096694428, 1.0]], [0, [36754.72002141168, 1.0]], [0, [7303.474231012168, 1.0]], [0, [18375.810158923145, 1.0]], [0, [1449.7470705560054, 1.0]], [0, [374.02599434947217, 1.0]], [0, [113.25645797819207, 1.0]], [0, [37.898812052163485, 1.0]], [0, [8.368026753282496, 1.0]], [0, [3.3602130403860317, 1.0]], [1, [8.603647505306325, 1.0]], [1, [0.4925930742666364, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2637404]
bas 1, expnt(s) = [117616.81424038]
bas 2, expnt(s) = [0.67193168]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999253]
bas 5, expnt(s) = [294042.03113166]
bas 6, expnt(s) = [147020.99214691]
bas 7, expnt(s) = [73510.42096694]
bas 8, expnt(s) = [36754.72002141]
bas 9, expnt(s) = [7303.47423101]
bas 10, expnt(s) = [18375.81015892]
bas 11, expnt(s) = [1449.74707056]
bas 12, expnt(s) = [374.02599435]
bas 13, expnt(s) = [113.25645798]
bas 14, expnt(s) = [37.89881205]
bas 15, expnt(s) = [8.36802675]
bas 16, expnt(s) = [3.36021304]
bas 17, expnt(s) = [8.60364751]
bas 18, expnt(s) = [0.49259307]
CPU time:       153.35
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63740403e-01 9.29817088e-01 1.17616814e+05 1.60460109e+04
 6.71931676e-01 1.87503276e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347423e+03 1.99600741e+03
 1.83758102e+04 3.98749265e+03 1.44974707e+03 5.93586758e+02
 3.74025994e+02 2.14877708e+02 1.13256458e+02 8.77126547e+01
 3.78988121e+01 3.85908391e+01 8.36802675e+00 1.24303203e+01
 3.36021304e+00 6.27032619e+00 8.60364751e+00 4.29870511e+01
 4.92593074e-01 1.20391207e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335736631798273
cond(S) = 907752.5273855382
E1 = -689.5621517394403  E_coul = 184.96041466317723
init E= -504.601737076263
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.672470490008045  LUMO = 0.772966110075266
  mo_energy =
[-1.21704800e+02 -1.33852316e+01 -7.62430474e+00 -7.62430474e+00
 -7.62430474e+00 -1.65762029e+00 -6.72470490e-01 -6.72470490e-01
 -6.72470490e-01  7.72966110e-01  1.25175486e+01  1.12733579e+02
  6.06904818e+02  2.74615621e+03  1.22250213e+04  4.08463887e+04
  1.04889963e+05  2.30073365e+05  4.55888274e+05  8.44840512e+05
  1.52801776e+06  2.85028512e+06  5.80817236e+06]
E1 = -707.7286893678872  E_coul = 199.77329737459186
cycle= 1 E= -507.955391993295  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625822
diis-c [-0.39165278  1.        ]
  HOMO = -0.217920571461743  LUMO = 1.17968555323439
  mo_energy =
[-1.20194438e+02 -1.23036315e+01 -6.59461277e+00 -6.59461277e+00
 -6.59461277e+00 -1.16321990e+00 -2.17920571e-01 -2.17920571e-01
 -2.17920571e-01  1.17968555e+00  1.34616911e+01  1.14134017e+02
  6.08401042e+02  2.74759154e+03  1.22263476e+04  4.08476485e+04
  1.04891186e+05  2.30074564e+05  4.55889456e+05  8.44841681e+05
  1.52801891e+06  2.85028627e+06  5.80817350e+06]
E1 = -706.7926698663235  E_coul = 198.8198446158127
cycle= 2 E= -507.972825250511  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.446
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258265
diis-c [-6.64127803e-04  2.70613340e-03  9.97293867e-01]
  HOMO = -0.239641352999031  LUMO = 1.17306532879794
  mo_energy =
[-1.20306681e+02 -1.23695755e+01 -6.66764071e+00 -6.66764071e+00
 -6.66764071e+00 -1.17720438e+00 -2.39641353e-01 -2.39641353e-01
 -2.39641353e-01  1.17306533e+00  1.34106954e+01  1.14040281e+02
  6.08284848e+02  2.74745939e+03  1.22262054e+04  4.08475026e+04
  1.04891039e+05  2.30074416e+05  4.55889308e+05  8.44841531e+05
  1.52801876e+06  2.85028612e+06  5.80817335e+06]
E1 = -706.6884535347114  E_coul = 198.71538087658567
cycle= 3 E= -507.973072658126  delta_E= -0.000247  |g|= 0.00434  |ddm|= 0.0597
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292558
diis-c [-1.54991233e-06 -1.74927720e-04 -1.14415469e-01  1.11459040e+00]
  HOMO = -0.242767445246121  LUMO = 1.1718856936579
  mo_energy =
[-1.20318768e+02 -1.23782527e+01 -6.67683303e+00 -6.67683303e+00
 -6.67683303e+00 -1.17909658e+00 -2.42767445e-01 -2.42767445e-01
 -2.42767445e-01  1.17188569e+00  1.34037062e+01  1.14029520e+02
  6.08272587e+02  2.74744625e+03  1.22261917e+04  4.08474888e+04
  1.04891025e+05  2.30074402e+05  4.55889294e+05  8.44841517e+05
  1.52801875e+06  2.85028611e+06  5.80817334e+06]
E1 = -706.6735814876268  E_coul = 198.70050431613384
cycle= 4 E= -507.973077171493  delta_E= -4.51e-06  |g|= 0.000157  |ddm|= 0.00912
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00010817
diis-c [-6.79686007e-11 -5.31330162e-06  7.33043245e-03 -9.09996737e-02
  1.08367455e+00]
  HOMO = -0.242871483211861  LUMO = 1.17184022716355
  mo_energy =
[-1.20319009e+02 -1.23785062e+01 -6.67708053e+00 -6.67708053e+00
 -6.67708053e+00 -1.17915764e+00 -2.42871483e-01 -2.42871483e-01
 -2.42871483e-01  1.17184023e+00  1.34034911e+01  1.14029276e+02
  6.08272347e+02  2.74744601e+03  1.22261915e+04  4.08474885e+04
  1.04891025e+05  2.30074401e+05  4.55889293e+05  8.44841517e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.673093079476  E_coul = 198.7000159026222
cycle= 5 E= -507.973077176854  delta_E= -5.36e-09  |g|= 2.53e-07  |ddm|= 0.00033
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.57316e-07
diis-c [-1.04388961e-14  1.75286268e-07 -8.90259376e-05  9.94001111e-04
 -1.11643515e-02  1.01025920e+00]
  HOMO = -0.24287153485036  LUMO = 1.17184037540907
  mo_energy =
[-1.20319010e+02 -1.23785064e+01 -6.67708085e+00 -6.67708085e+00
 -6.67708085e+00 -1.17915780e+00 -2.42871535e-01 -2.42871535e-01
 -2.42871535e-01  1.17184038e+00  1.34034910e+01  1.14029276e+02
  6.08272347e+02  2.74744601e+03  1.22261915e+04  4.08474885e+04
  1.04891025e+05  2.30074401e+05  4.55889293e+05  8.44841517e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6730926544973  E_coul = 198.70001547764397
cycle= 6 E= -507.973077176853  delta_E= 4.55e-13  |g|= 1.29e-08  |ddm|= 1.78e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6730926544973  E_coul = 198.70001547764397
  HOMO = -0.242871528177895  LUMO = 1.17184037714648
  mo_energy =
[-1.20319010e+02 -1.23785064e+01 -6.67708083e+00 -6.67708083e+00
 -6.67708083e+00 -1.17915780e+00 -2.42871528e-01 -2.42871528e-01
 -2.42871528e-01  1.17184038e+00  1.34034910e+01  1.14029276e+02
  6.08272347e+02  2.74744601e+03  1.22261915e+04  4.08474885e+04
  1.04891025e+05  2.30074401e+05  4.55889293e+05  8.44841517e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6730926886959  E_coul = 198.70001551184248
Extra cycle  E= -507.973077176853  delta_E= -1.14e-13  |g|= 2.29e-09  |ddm|= 2.27e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907752.5273855382
E1 = -706.6730926886959  E_coul = 198.70001551184248
init E= -507.973077176853
    CPU time for initialize scf      1.47 sec, wall time      0.09 sec
  HOMO = -0.242871527224086  LUMO = 1.17184037657566
  mo_energy =
[-1.20319010e+02 -1.23785064e+01 -6.67708083e+00 -6.67708083e+00
 -6.67708083e+00 -1.17915780e+00 -2.42871527e-01 -2.42871527e-01
 -2.42871527e-01  1.17184038e+00  1.34034910e+01  1.14029276e+02
  6.08272347e+02  2.74744601e+03  1.22261915e+04  4.08474885e+04
  1.04891025e+05  2.30074401e+05  4.55889293e+05  8.44841517e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6730926940114  E_coul = 198.70001551715754
cycle= 1 E= -507.973077176854  delta_E= -4.55e-13  |g|= 1.45e-09  |ddm|= 3.41e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.6730926940114  E_coul = 198.70001551715754
  HOMO = -0.242871527073806  LUMO = 1.17184037568539
  mo_energy =
[-1.20319010e+02 -1.23785064e+01 -6.67708083e+00 -6.67708083e+00
 -6.67708083e+00 -1.17915780e+00 -2.42871527e-01 -2.42871527e-01
 -2.42871527e-01  1.17184038e+00  1.34034910e+01  1.14029276e+02
  6.08272347e+02  2.74744601e+03  1.22261915e+04  4.08474885e+04
  1.04891025e+05  2.30074401e+05  4.55889293e+05  8.44841517e+05
  1.52801875e+06  2.85028610e+06  5.80817334e+06]
E1 = -706.6730926975248  E_coul = 198.70001552067106
Extra cycle  E= -507.973077176854  delta_E= 1.14e-13  |g|= 1.57e-09  |ddm|= 2.19e-09
    CPU time for scf_cycle      1.64 sec, wall time      0.16 sec
exp = [2.63740403e-01 1.17616814e+05 6.71931676e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347423e+03 1.83758102e+04 1.44974707e+03
 3.74025994e+02 1.13256458e+02 3.78988121e+01 8.36802675e+00
 3.36021304e+00 8.60364751e+00 4.92593074e-01]
grad_E = [-5.68265867e-04  4.20707334e-09  3.69199589e-04  1.90542397e-11
  1.13573534e-10  6.54540829e-10  2.56713886e-09  1.06660265e-08
  5.73505628e-08  3.61075852e-06  1.23586225e-07  3.76211622e-06
  1.43524164e-05 -1.18619303e-04 -7.59247483e-05 -1.66009781e-04
  3.22087370e-04  1.14363068e-05  6.61122809e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263635544486       1
[INPUT] 0    0    [1    /1   ]  117616.81424         1
[INPUT] 0    0    [1    /1   ]  0.671181611231       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992147        1
[INPUT] 0    0    [1    /1   ]  73510.4209659        1
[INPUT] 0    0    [1    /1   ]  36754.7200157        1
[INPUT] 0    0    [1    /1   ]  7303.47387099        1
[INPUT] 0    0    [1    /1   ]  18375.8101466        1
[INPUT] 0    0    [1    /1   ]  1449.74675554        1
[INPUT] 0    0    [1    /1   ]  374.023739074        1
[INPUT] 0    0    [1    /1   ]  113.273165841        1
[INPUT] 0    0    [1    /1   ]  37.8941194346        1
[INPUT] 0    0    [1    /1   ]  8.38509001509        1
[INPUT] 0    0    [1    /1   ]  3.3642607466         1
[INPUT] 1    0    [1    /1   ]  8.60364180464        1
[INPUT] 1    0    [1    /1   ]  0.492590181831       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26363554448558846, 1.0]], [0, [117616.81423996184, 1.0]], [0, [0.6711816112313306, 1.0]], [0, [1176168.1426188792, 1.0]], [0, [588084.0699925142, 1.0]], [0, [294042.0311315953, 1.0]], [0, [147020.9921466553, 1.0]], [0, [73510.42096588088, 1.0]], [0, [36754.72001569522, 1.0]], [0, [7303.473870988154, 1.0]], [0, [18375.81014659137, 1.0]], [0, [1449.7467555436688, 1.0]], [0, [374.0237390741982, 1.0]], [0, [113.27316584083657, 1.0]], [0, [37.89411943458532, 1.0]], [0, [8.385090015090706, 1.0]], [0, [3.3642607465998364, 1.0]], [1, [8.603641804640693, 1.0]], [1, [0.49259018183073183, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26363554]
bas 1, expnt(s) = [117616.81423996]
bas 2, expnt(s) = [0.67118161]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999251]
bas 5, expnt(s) = [294042.0311316]
bas 6, expnt(s) = [147020.99214666]
bas 7, expnt(s) = [73510.42096588]
bas 8, expnt(s) = [36754.7200157]
bas 9, expnt(s) = [7303.47387099]
bas 10, expnt(s) = [18375.81014659]
bas 11, expnt(s) = [1449.74675554]
bas 12, expnt(s) = [374.02373907]
bas 13, expnt(s) = [113.27316584]
bas 14, expnt(s) = [37.89411943]
bas 15, expnt(s) = [8.38509002]
bas 16, expnt(s) = [3.36426075]
bas 17, expnt(s) = [8.6036418]
bas 18, expnt(s) = [0.49259018]
CPU time:       158.11
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63635544e-01 9.29539815e-01 1.17616814e+05 1.60460109e+04
 6.71181611e-01 1.87346274e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347387e+03 1.99600734e+03
 1.83758101e+04 3.98749265e+03 1.44974676e+03 5.93586662e+02
 3.74023739e+02 2.14876737e+02 1.13273166e+02 8.77223592e+01
 3.78941194e+01 3.85872553e+01 8.38509002e+00 1.24493255e+01
 3.36426075e+00 6.27599025e+00 8.60364180e+00 4.29870155e+01
 4.92590182e-01 1.20390324e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33573924232847
cond(S) = 907753.6324755306
E1 = -689.5623847992052  E_coul = 184.9602463388354
init E= -504.60213846037
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672477434405608  LUMO = 0.77192191665672
  mo_energy =
[-1.21704833e+02 -1.33852259e+01 -7.62431546e+00 -7.62431546e+00
 -7.62431546e+00 -1.65762599e+00 -6.72477434e-01 -6.72477434e-01
 -6.72477434e-01  7.71921917e-01  1.25417979e+01  1.12813340e+02
  6.07006764e+02  2.74626147e+03  1.22251146e+04  4.08464745e+04
  1.04890045e+05  2.30073444e+05  4.55888352e+05  8.44840588e+05
  1.52801783e+06  2.85028519e+06  5.80817244e+06]
E1 = -707.728437366484  E_coul = 199.7730385163082
cycle= 1 E= -507.955398850176  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625835
diis-c [-0.39166923  1.        ]
  HOMO = -0.21792461343623  LUMO = 1.17850094703368
  mo_energy =
[-1.20194486e+02 -1.23036347e+01 -6.59463415e+00 -6.59463415e+00
 -6.59463415e+00 -1.16322299e+00 -2.17924613e-01 -2.17924613e-01
 -2.17924613e-01  1.17850095e+00  1.34866301e+01  1.14213786e+02
  6.08502953e+02  2.74769676e+03  1.22264409e+04  4.08477344e+04
  1.04891268e+05  2.30074643e+05  4.55889534e+05  8.44841757e+05
  1.52801899e+06  2.85028634e+06  5.80817358e+06]
E1 = -706.7925989220088  E_coul = 198.81977144745892
cycle= 2 E= -507.97282747455  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.446
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258255
diis-c [-6.64076163e-04  2.70756344e-03  9.97292437e-01]
  HOMO = -0.239644114803973  LUMO = 1.17188635381023
  mo_energy =
[-1.20306706e+02 -1.23695634e+01 -6.66764497e+00 -6.66764497e+00
 -6.66764497e+00 -1.17720734e+00 -2.39644115e-01 -2.39644115e-01
 -2.39644115e-01  1.17188635e+00  1.34355999e+01  1.14120064e+02
  6.08386780e+02  2.74756464e+03  1.22262987e+04  4.08475885e+04
  1.04891121e+05  2.30074495e+05  4.55889385e+05  8.44841608e+05
  1.52801884e+06  2.85028619e+06  5.80817343e+06]
E1 = -706.6883613188289  E_coul = 198.71528630601568
cycle= 3 E= -507.973075012813  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0597
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292584
diis-c [-1.55064194e-06 -1.75387299e-04 -1.14427873e-01  1.11460326e+00]
  HOMO = -0.242771414139531  LUMO = 1.17070707580611
  mo_energy =
[-1.20318795e+02 -1.23782424e+01 -6.67683905e+00 -6.67683905e+00
 -6.67683905e+00 -1.17910038e+00 -2.42771414e-01 -2.42771414e-01
 -2.42771414e-01  1.17070708e+00  1.34286039e+01  1.14109301e+02
  6.08374518e+02  2.74755150e+03  1.22262850e+04  4.08475746e+04
  1.04891107e+05  2.30074481e+05  4.55889371e+05  8.44841594e+05
  1.52801882e+06  2.85028618e+06  5.80817341e+06]
E1 = -706.6734796385363  E_coul = 198.70040010648293
cycle= 4 E= -507.973079532053  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108274
diis-c [-6.82032216e-11 -5.30974601e-06  7.33349711e-03 -9.10532439e-02
  1.08372506e+00]
  HOMO = -0.24287563439784  LUMO = 1.17066156716094
  mo_energy =
[-1.20319037e+02 -1.23784963e+01 -6.67708705e+00 -6.67708705e+00
 -6.67708705e+00 -1.17916155e+00 -2.42875634e-01 -2.42875634e-01
 -2.42875634e-01  1.17066157e+00  1.34283883e+01  1.14109056e+02
  6.08374278e+02  2.74755126e+03  1.22262848e+04  4.08475744e+04
  1.04891107e+05  2.30074481e+05  4.55889371e+05  8.44841594e+05
  1.52801882e+06  2.85028618e+06  5.80817341e+06]
E1 = -706.6729902154608  E_coul = 198.69991067802758
cycle= 5 E= -507.973079537433  delta_E= -5.38e-09  |g|= 2.54e-07  |ddm|= 0.000331
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58838e-07
diis-c [-1.07296254e-14  1.76910848e-07 -8.93177387e-05  9.97233932e-04
 -1.11777674e-02  1.01026967e+00]
  HOMO = -0.242875683605787  LUMO = 1.17066171500958
  mo_energy =
[-1.20319037e+02 -1.23784966e+01 -6.67708737e+00 -6.67708737e+00
 -6.67708737e+00 -1.17916171e+00 -2.42875684e-01 -2.42875684e-01
 -2.42875684e-01  1.17066172e+00  1.34283882e+01  1.14109056e+02
  6.08374277e+02  2.74755126e+03  1.22262848e+04  4.08475744e+04
  1.04891107e+05  2.30074481e+05  4.55889371e+05  8.44841594e+05
  1.52801882e+06  2.85028618e+06  5.80817341e+06]
E1 = -706.6729898025284  E_coul = 198.69991026509533
cycle= 6 E= -507.973079537433  delta_E= 2.27e-13  |g|= 1.27e-08  |ddm|= 1.71e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6729898025284  E_coul = 198.69991026509533
  HOMO = -0.242875676766554  LUMO = 1.17066171846487
  mo_energy =
[-1.20319037e+02 -1.23784966e+01 -6.67708735e+00 -6.67708735e+00
 -6.67708735e+00 -1.17916171e+00 -2.42875677e-01 -2.42875677e-01
 -2.42875677e-01  1.17066172e+00  1.34283882e+01  1.14109056e+02
  6.08374277e+02  2.74755126e+03  1.22262848e+04  4.08475744e+04
  1.04891107e+05  2.30074481e+05  4.55889371e+05  8.44841594e+05
  1.52801882e+06  2.85028618e+06  5.80817341e+06]
E1 = -706.6729898379276  E_coul = 198.69991030049454
Extra cycle  E= -507.973079537433  delta_E= -5.68e-14  |g|= 1.83e-09  |ddm|= 2.34e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
exp = [2.63635544e-01 1.17616814e+05 6.71181611e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347387e+03 1.83758101e+04 1.44974676e+03
 3.74023739e+02 1.13273166e+02 3.78941194e+01 8.38509002e+00
 3.36426075e+00 8.60364180e+00 4.92590182e-01]
E = -507.9730795374331
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263635544486       1
[INPUT] 0    0    [1    /1   ]  117616.81424         1
[INPUT] 0    0    [1    /1   ]  0.671181611231       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992147        1
[INPUT] 0    0    [1    /1   ]  73510.4209659        1
[INPUT] 0    0    [1    /1   ]  36754.7200157        1
[INPUT] 0    0    [1    /1   ]  7303.47387099        1
[INPUT] 0    0    [1    /1   ]  18375.8101466        1
[INPUT] 0    0    [1    /1   ]  1449.74675554        1
[INPUT] 0    0    [1    /1   ]  374.023739074        1
[INPUT] 0    0    [1    /1   ]  113.273165841        1
[INPUT] 0    0    [1    /1   ]  37.8941194346        1
[INPUT] 0    0    [1    /1   ]  8.38509001509        1
[INPUT] 0    0    [1    /1   ]  3.3642607466         1
[INPUT] 1    0    [1    /1   ]  8.60364180464        1
[INPUT] 1    0    [1    /1   ]  0.492590181831       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26363554448558846, 1.0]], [0, [117616.81423996184, 1.0]], [0, [0.6711816112313306, 1.0]], [0, [1176168.1426188792, 1.0]], [0, [588084.0699925142, 1.0]], [0, [294042.0311315953, 1.0]], [0, [147020.9921466553, 1.0]], [0, [73510.42096588088, 1.0]], [0, [36754.72001569522, 1.0]], [0, [7303.473870988154, 1.0]], [0, [18375.81014659137, 1.0]], [0, [1449.7467555436688, 1.0]], [0, [374.0237390741982, 1.0]], [0, [113.27316584083657, 1.0]], [0, [37.89411943458532, 1.0]], [0, [8.385090015090706, 1.0]], [0, [3.3642607465998364, 1.0]], [1, [8.603641804640693, 1.0]], [1, [0.49259018183073183, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26363554]
bas 1, expnt(s) = [117616.81423996]
bas 2, expnt(s) = [0.67118161]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999251]
bas 5, expnt(s) = [294042.0311316]
bas 6, expnt(s) = [147020.99214666]
bas 7, expnt(s) = [73510.42096588]
bas 8, expnt(s) = [36754.7200157]
bas 9, expnt(s) = [7303.47387099]
bas 10, expnt(s) = [18375.81014659]
bas 11, expnt(s) = [1449.74675554]
bas 12, expnt(s) = [374.02373907]
bas 13, expnt(s) = [113.27316584]
bas 14, expnt(s) = [37.89411943]
bas 15, expnt(s) = [8.38509002]
bas 16, expnt(s) = [3.36426075]
bas 17, expnt(s) = [8.6036418]
bas 18, expnt(s) = [0.49259018]
CPU time:       158.69
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63635544e-01 9.29539815e-01 1.17616814e+05 1.60460109e+04
 6.71181611e-01 1.87346274e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347387e+03 1.99600734e+03
 1.83758101e+04 3.98749265e+03 1.44974676e+03 5.93586662e+02
 3.74023739e+02 2.14876737e+02 1.13273166e+02 8.77223592e+01
 3.78941194e+01 3.85872553e+01 8.38509002e+00 1.24493255e+01
 3.36426075e+00 6.27599025e+00 8.60364180e+00 4.29870155e+01
 4.92590182e-01 1.20390324e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33573924232847
cond(S) = 907753.6324755306
E1 = -689.5623847992052  E_coul = 184.9602463388354
init E= -504.60213846037
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672477434405608  LUMO = 0.77192191665672
  mo_energy =
[-1.21704833e+02 -1.33852259e+01 -7.62431546e+00 -7.62431546e+00
 -7.62431546e+00 -1.65762599e+00 -6.72477434e-01 -6.72477434e-01
 -6.72477434e-01  7.71921917e-01  1.25417979e+01  1.12813340e+02
  6.07006764e+02  2.74626147e+03  1.22251146e+04  4.08464745e+04
  1.04890045e+05  2.30073444e+05  4.55888352e+05  8.44840588e+05
  1.52801783e+06  2.85028519e+06  5.80817244e+06]
E1 = -707.728437366484  E_coul = 199.7730385163082
cycle= 1 E= -507.955398850176  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625835
diis-c [-0.39166923  1.        ]
  HOMO = -0.21792461343623  LUMO = 1.17850094703368
  mo_energy =
[-1.20194486e+02 -1.23036347e+01 -6.59463415e+00 -6.59463415e+00
 -6.59463415e+00 -1.16322299e+00 -2.17924613e-01 -2.17924613e-01
 -2.17924613e-01  1.17850095e+00  1.34866301e+01  1.14213786e+02
  6.08502953e+02  2.74769676e+03  1.22264409e+04  4.08477344e+04
  1.04891268e+05  2.30074643e+05  4.55889534e+05  8.44841757e+05
  1.52801899e+06  2.85028634e+06  5.80817358e+06]
E1 = -706.7925989220088  E_coul = 198.81977144745892
cycle= 2 E= -507.97282747455  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.446
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258255
diis-c [-6.64076163e-04  2.70756344e-03  9.97292437e-01]
  HOMO = -0.239644114803973  LUMO = 1.17188635381023
  mo_energy =
[-1.20306706e+02 -1.23695634e+01 -6.66764497e+00 -6.66764497e+00
 -6.66764497e+00 -1.17720734e+00 -2.39644115e-01 -2.39644115e-01
 -2.39644115e-01  1.17188635e+00  1.34355999e+01  1.14120064e+02
  6.08386780e+02  2.74756464e+03  1.22262987e+04  4.08475885e+04
  1.04891121e+05  2.30074495e+05  4.55889385e+05  8.44841608e+05
  1.52801884e+06  2.85028619e+06  5.80817343e+06]
E1 = -706.6883613188289  E_coul = 198.71528630601568
cycle= 3 E= -507.973075012813  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0597
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292584
diis-c [-1.55064194e-06 -1.75387299e-04 -1.14427873e-01  1.11460326e+00]
  HOMO = -0.242771414139531  LUMO = 1.17070707580611
  mo_energy =
[-1.20318795e+02 -1.23782424e+01 -6.67683905e+00 -6.67683905e+00
 -6.67683905e+00 -1.17910038e+00 -2.42771414e-01 -2.42771414e-01
 -2.42771414e-01  1.17070708e+00  1.34286039e+01  1.14109301e+02
  6.08374518e+02  2.74755150e+03  1.22262850e+04  4.08475746e+04
  1.04891107e+05  2.30074481e+05  4.55889371e+05  8.44841594e+05
  1.52801882e+06  2.85028618e+06  5.80817341e+06]
E1 = -706.6734796385363  E_coul = 198.70040010648293
cycle= 4 E= -507.973079532053  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108274
diis-c [-6.82032216e-11 -5.30974601e-06  7.33349711e-03 -9.10532439e-02
  1.08372506e+00]
  HOMO = -0.24287563439784  LUMO = 1.17066156716094
  mo_energy =
[-1.20319037e+02 -1.23784963e+01 -6.67708705e+00 -6.67708705e+00
 -6.67708705e+00 -1.17916155e+00 -2.42875634e-01 -2.42875634e-01
 -2.42875634e-01  1.17066157e+00  1.34283883e+01  1.14109056e+02
  6.08374278e+02  2.74755126e+03  1.22262848e+04  4.08475744e+04
  1.04891107e+05  2.30074481e+05  4.55889371e+05  8.44841594e+05
  1.52801882e+06  2.85028618e+06  5.80817341e+06]
E1 = -706.6729902154608  E_coul = 198.69991067802758
cycle= 5 E= -507.973079537433  delta_E= -5.38e-09  |g|= 2.54e-07  |ddm|= 0.000331
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58838e-07
diis-c [-1.07296254e-14  1.76910848e-07 -8.93177387e-05  9.97233932e-04
 -1.11777674e-02  1.01026967e+00]
  HOMO = -0.242875683605787  LUMO = 1.17066171500958
  mo_energy =
[-1.20319037e+02 -1.23784966e+01 -6.67708737e+00 -6.67708737e+00
 -6.67708737e+00 -1.17916171e+00 -2.42875684e-01 -2.42875684e-01
 -2.42875684e-01  1.17066172e+00  1.34283882e+01  1.14109056e+02
  6.08374277e+02  2.74755126e+03  1.22262848e+04  4.08475744e+04
  1.04891107e+05  2.30074481e+05  4.55889371e+05  8.44841594e+05
  1.52801882e+06  2.85028618e+06  5.80817341e+06]
E1 = -706.6729898025284  E_coul = 198.69991026509533
cycle= 6 E= -507.973079537433  delta_E= 2.27e-13  |g|= 1.27e-08  |ddm|= 1.71e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6729898025284  E_coul = 198.69991026509533
  HOMO = -0.242875676766554  LUMO = 1.17066171846487
  mo_energy =
[-1.20319037e+02 -1.23784966e+01 -6.67708735e+00 -6.67708735e+00
 -6.67708735e+00 -1.17916171e+00 -2.42875677e-01 -2.42875677e-01
 -2.42875677e-01  1.17066172e+00  1.34283882e+01  1.14109056e+02
  6.08374277e+02  2.74755126e+03  1.22262848e+04  4.08475744e+04
  1.04891107e+05  2.30074481e+05  4.55889371e+05  8.44841594e+05
  1.52801882e+06  2.85028618e+06  5.80817341e+06]
E1 = -706.6729898379276  E_coul = 198.69991030049454
Extra cycle  E= -507.973079537433  delta_E= -5.68e-14  |g|= 1.83e-09  |ddm|= 2.34e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907753.6324755306
E1 = -706.6729898379276  E_coul = 198.69991030049454
init E= -507.973079537433
    CPU time for initialize scf      1.50 sec, wall time      0.10 sec
  HOMO = -0.242875675791915  LUMO = 1.17066171898377
  mo_energy =
[-1.20319037e+02 -1.23784966e+01 -6.67708735e+00 -6.67708735e+00
 -6.67708735e+00 -1.17916171e+00 -2.42875676e-01 -2.42875676e-01
 -2.42875676e-01  1.17066172e+00  1.34283882e+01  1.14109056e+02
  6.08374277e+02  2.74755126e+03  1.22262848e+04  4.08475744e+04
  1.04891107e+05  2.30074481e+05  4.55889371e+05  8.44841594e+05
  1.52801882e+06  2.85028618e+06  5.80817341e+06]
E1 = -706.6729898408763  E_coul = 198.69991030344343
cycle= 1 E= -507.973079537433  delta_E= 1.71e-13  |g|= 1.32e-09  |ddm|= 2e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6729898408763  E_coul = 198.69991030344343
  HOMO = -0.242875675702516  LUMO = 1.17066171816083
  mo_energy =
[-1.20319037e+02 -1.23784966e+01 -6.67708735e+00 -6.67708735e+00
 -6.67708735e+00 -1.17916171e+00 -2.42875676e-01 -2.42875676e-01
 -2.42875676e-01  1.17066172e+00  1.34283882e+01  1.14109056e+02
  6.08374277e+02  2.74755126e+03  1.22262848e+04  4.08475744e+04
  1.04891107e+05  2.30074481e+05  4.55889371e+05  8.44841594e+05
  1.52801882e+06  2.85028618e+06  5.80817341e+06]
E1 = -706.672989842266  E_coul = 198.69991030483305
Extra cycle  E= -507.973079537433  delta_E= -5.68e-14  |g|= 1.35e-09  |ddm|= 8.89e-10
    CPU time for scf_cycle      1.67 sec, wall time      0.16 sec
exp = [2.63635544e-01 1.17616814e+05 6.71181611e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347387e+03 1.83758101e+04 1.44974676e+03
 3.74023739e+02 1.13273166e+02 3.78941194e+01 8.38509002e+00
 3.36426075e+00 8.60364180e+00 4.92590182e-01]
grad_E = [-4.31244329e-04  4.19955883e-09  2.77237422e-04  1.89652373e-11
  1.13329459e-10  6.53378177e-10  2.56249437e-09  1.06464453e-08
  5.72541030e-08  3.60390729e-06  1.23291947e-07  4.14829901e-06
  8.98934328e-06 -8.78598017e-05 -1.45193443e-04 -8.49424388e-05
  2.73642977e-04  9.83472356e-06  5.63676365e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263377194219       1
[INPUT] 0    0    [1    /1   ]  117616.81424         1
[INPUT] 0    0    [1    /1   ]  0.669853205852       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992147        1
[INPUT] 0    0    [1    /1   ]  73510.4209652        1
[INPUT] 0    0    [1    /1   ]  36754.7200123        1
[INPUT] 0    0    [1    /1   ]  7303.47365461        1
[INPUT] 0    0    [1    /1   ]  18375.8101392        1
[INPUT] 0    0    [1    /1   ]  1449.74654051        1
[INPUT] 0    0    [1    /1   ]  374.02275362         1
[INPUT] 0    0    [1    /1   ]  113.280687516        1
[INPUT] 0    0    [1    /1   ]  37.8970967935        1
[INPUT] 0    0    [1    /1   ]  8.40199657375        1
[INPUT] 0    0    [1    /1   ]  3.36782990959        1
[INPUT] 1    0    [1    /1   ]  8.6036201904         1
[INPUT] 1    0    [1    /1   ]  0.492581125493       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26337719421880984, 1.0]], [0, [117616.81423970974, 1.0]], [0, [0.6698532058523475, 1.0]], [0, [1176168.142618878, 1.0]], [0, [588084.0699925075, 1.0]], [0, [294042.0311315561, 1.0]], [0, [147020.99214650146, 1.0]], [0, [73510.42096524172, 1.0]], [0, [36754.72001225876, 1.0]], [0, [7303.473654613481, 1.0]], [0, [18375.81013918338, 1.0]], [0, [1449.746540512008, 1.0]], [0, [374.0227536195721, 1.0]], [0, [113.28068751639523, 1.0]], [0, [37.89709679348946, 1.0]], [0, [8.401996573749209, 1.0]], [0, [3.3678299095850117, 1.0]], [1, [8.603620190403703, 1.0]], [1, [0.49258112549303634, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26337719]
bas 1, expnt(s) = [117616.81423971]
bas 2, expnt(s) = [0.66985321]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999251]
bas 5, expnt(s) = [294042.03113156]
bas 6, expnt(s) = [147020.9921465]
bas 7, expnt(s) = [73510.42096524]
bas 8, expnt(s) = [36754.72001226]
bas 9, expnt(s) = [7303.47365461]
bas 10, expnt(s) = [18375.81013918]
bas 11, expnt(s) = [1449.74654051]
bas 12, expnt(s) = [374.02275362]
bas 13, expnt(s) = [113.28068752]
bas 14, expnt(s) = [37.89709679]
bas 15, expnt(s) = [8.40199657]
bas 16, expnt(s) = [3.36782991]
bas 17, expnt(s) = [8.60362019]
bas 18, expnt(s) = [0.49258113]
CPU time:       163.49
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63377194e-01 9.28856553e-01 1.17616814e+05 1.60460109e+04
 6.69853206e-01 1.87068108e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347365e+03 1.99600730e+03
 1.83758101e+04 3.98749265e+03 1.44974654e+03 5.93586595e+02
 3.74022754e+02 2.14876312e+02 1.13280688e+02 8.77267280e+01
 3.78970968e+01 3.85895292e+01 8.40199657e+00 1.24681466e+01
 3.36782991e+00 6.28098327e+00 8.60362019e+00 4.29868805e+01
 4.92581125e-01 1.20387557e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335751869165478
cond(S) = 907754.6870293432
E1 = -689.5620411679735  E_coul = 184.959753395302
init E= -504.602287772672
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672493667736566  LUMO = 0.769711388210606
  mo_energy =
[-1.21704895e+02 -1.33852510e+01 -7.62434728e+00 -7.62434728e+00
 -7.62434728e+00 -1.65763938e+00 -6.72493668e-01 -6.72493668e-01
 -6.72493668e-01  7.69711388e-01  1.25614406e+01  1.12898087e+02
  6.07109799e+02  2.74636119e+03  1.22252025e+04  4.08465555e+04
  1.04890123e+05  2.30073519e+05  4.55888426e+05  8.44840660e+05
  1.52801790e+06  2.85028526e+06  5.80817250e+06]
E1 = -707.7276622495766  E_coul = 199.7722548813973
cycle= 1 E= -507.955407368179  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625856
diis-c [-0.39169621  1.        ]
  HOMO = -0.217942037377908  LUMO = 1.17594667450679
  mo_energy =
[-1.20194570e+02 -1.23036868e+01 -6.59469702e+00 -6.59469702e+00
 -6.59469702e+00 -1.16323833e+00 -2.17942037e-01 -2.17942037e-01
 -2.17942037e-01  1.17594667e+00  1.35069352e+01  1.14298546e+02
  6.08605959e+02  2.74779647e+03  1.22265287e+04  4.08478154e+04
  1.04891346e+05  2.30074718e+05  4.55889607e+05  8.44841829e+05
  1.52801906e+06  2.85028641e+06  5.80817364e+06]
E1 = -706.7921129261158  E_coul = 198.81928455642446
cycle= 2 E= -507.972828369691  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.446
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258253
diis-c [-6.64061722e-04  2.70816163e-03  9.97291838e-01]
  HOMO = -0.23965897600158  LUMO = 1.16934694797145
  mo_energy =
[-1.20306755e+02 -1.23695910e+01 -6.66768100e+00 -6.66768100e+00
 -6.66768100e+00 -1.17722211e+00 -2.39658976e-01 -2.39658976e-01
 -2.39658976e-01  1.16934695e+00  1.34558829e+01  1.14204847e+02
  6.08489822e+02  2.74766438e+03  1.22263866e+04  4.08476695e+04
  1.04891198e+05  2.30074570e+05  4.55889459e+05  8.44841680e+05
  1.52801891e+06  2.85028626e+06  5.80817349e+06]
E1 = -706.6878331238266  E_coul = 198.7147569646018
cycle= 3 E= -507.973076159225  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292692
diis-c [-1.55215954e-06 -1.76221888e-04 -1.14472681e-01  1.11464890e+00]
  HOMO = -0.242788641968234  LUMO = 1.16816887770931
  mo_energy =
[-1.20318848e+02 -1.23782737e+01 -6.67687858e+00 -6.67687858e+00
 -6.67687858e+00 -1.17911678e+00 -2.42788642e-01 -2.42788642e-01
 -2.42788642e-01  1.16816888e+00  1.34488789e+01  1.14194079e+02
  6.08477557e+02  2.74765124e+03  1.22263729e+04  4.08476556e+04
  1.04891184e+05  2.30074556e+05  4.55889445e+05  8.44841666e+05
  1.52801890e+06  2.85028625e+06  5.80817348e+06]
E1 = -706.672932616075  E_coul = 198.6998519258284
cycle= 4 E= -507.973080690247  delta_E= -4.53e-06  |g|= 0.000158  |ddm|= 0.00914
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108456
diis-c [-6.84662136e-11 -5.31411984e-06  7.33967547e-03 -9.11383665e-02
  1.08380401e+00]
  HOMO = -0.242893179264557  LUMO = 1.16812331097327
  mo_energy =
[-1.20319090e+02 -1.23785284e+01 -6.67712736e+00 -6.67712736e+00
 -6.67712736e+00 -1.17917814e+00 -2.42893179e-01 -2.42893179e-01
 -2.42893179e-01  1.16812331e+00  1.34486626e+01  1.14193834e+02
  6.08477315e+02  2.74765100e+03  1.22263727e+04  4.08476554e+04
  1.04891184e+05  2.30074556e+05  4.55889444e+05  8.44841666e+05
  1.52801890e+06  2.85028625e+06  5.80817348e+06]
E1 = -706.6724414140373  E_coul = 198.69936071837557
cycle= 5 E= -507.973080695662  delta_E= -5.42e-09  |g|= 2.55e-07  |ddm|= 0.000332
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.59629e-07
diis-c [-1.07184381e-14  1.78907489e-07 -9.00363353e-05  1.00599351e-03
 -1.12628482e-02  1.01034671e+00]
  HOMO = -0.242893227215438  LUMO = 1.1681234619687
  mo_energy =
[-1.20319091e+02 -1.23785286e+01 -6.67712768e+00 -6.67712768e+00
 -6.67712768e+00 -1.17917830e+00 -2.42893227e-01 -2.42893227e-01
 -2.42893227e-01  1.16812346e+00  1.34486624e+01  1.14193834e+02
  6.08477314e+02  2.74765100e+03  1.22263727e+04  4.08476554e+04
  1.04891184e+05  2.30074556e+05  4.55889444e+05  8.44841666e+05
  1.52801890e+06  2.85028625e+06  5.80817348e+06]
E1 = -706.6724410054011  E_coul = 198.6993603097391
cycle= 6 E= -507.973080695662  delta_E= -3.41e-13  |g|= 1.31e-08  |ddm|= 1.68e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6724410054011  E_coul = 198.6993603097391
  HOMO = -0.242893220375049  LUMO = 1.16812346358547
  mo_energy =
[-1.20319091e+02 -1.23785286e+01 -6.67712766e+00 -6.67712766e+00
 -6.67712766e+00 -1.17917829e+00 -2.42893220e-01 -2.42893220e-01
 -2.42893220e-01  1.16812346e+00  1.34486625e+01  1.14193834e+02
  6.08477315e+02  2.74765100e+03  1.22263727e+04  4.08476554e+04
  1.04891184e+05  2.30074556e+05  4.55889444e+05  8.44841666e+05
  1.52801890e+06  2.85028625e+06  5.80817348e+06]
E1 = -706.6724410402621  E_coul = 198.69936034460042
Extra cycle  E= -507.973080695662  delta_E= 3.41e-13  |g|= 2.3e-09  |ddm|= 2.32e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.63377194e-01 1.17616814e+05 6.69853206e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347365e+03 1.83758101e+04 1.44974654e+03
 3.74022754e+02 1.13280688e+02 3.78970968e+01 8.40199657e+00
 3.36782991e+00 8.60362019e+00 4.92581125e-01]
E = -507.9730806956617
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263377194219       1
[INPUT] 0    0    [1    /1   ]  117616.81424         1
[INPUT] 0    0    [1    /1   ]  0.669853205852       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992147        1
[INPUT] 0    0    [1    /1   ]  73510.4209652        1
[INPUT] 0    0    [1    /1   ]  36754.7200123        1
[INPUT] 0    0    [1    /1   ]  7303.47365461        1
[INPUT] 0    0    [1    /1   ]  18375.8101392        1
[INPUT] 0    0    [1    /1   ]  1449.74654051        1
[INPUT] 0    0    [1    /1   ]  374.02275362         1
[INPUT] 0    0    [1    /1   ]  113.280687516        1
[INPUT] 0    0    [1    /1   ]  37.8970967935        1
[INPUT] 0    0    [1    /1   ]  8.40199657375        1
[INPUT] 0    0    [1    /1   ]  3.36782990959        1
[INPUT] 1    0    [1    /1   ]  8.6036201904         1
[INPUT] 1    0    [1    /1   ]  0.492581125493       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26337719421880984, 1.0]], [0, [117616.81423970974, 1.0]], [0, [0.6698532058523475, 1.0]], [0, [1176168.142618878, 1.0]], [0, [588084.0699925075, 1.0]], [0, [294042.0311315561, 1.0]], [0, [147020.99214650146, 1.0]], [0, [73510.42096524172, 1.0]], [0, [36754.72001225876, 1.0]], [0, [7303.473654613481, 1.0]], [0, [18375.81013918338, 1.0]], [0, [1449.746540512008, 1.0]], [0, [374.0227536195721, 1.0]], [0, [113.28068751639523, 1.0]], [0, [37.89709679348946, 1.0]], [0, [8.401996573749209, 1.0]], [0, [3.3678299095850117, 1.0]], [1, [8.603620190403703, 1.0]], [1, [0.49258112549303634, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26337719]
bas 1, expnt(s) = [117616.81423971]
bas 2, expnt(s) = [0.66985321]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999251]
bas 5, expnt(s) = [294042.03113156]
bas 6, expnt(s) = [147020.9921465]
bas 7, expnt(s) = [73510.42096524]
bas 8, expnt(s) = [36754.72001226]
bas 9, expnt(s) = [7303.47365461]
bas 10, expnt(s) = [18375.81013918]
bas 11, expnt(s) = [1449.74654051]
bas 12, expnt(s) = [374.02275362]
bas 13, expnt(s) = [113.28068752]
bas 14, expnt(s) = [37.89709679]
bas 15, expnt(s) = [8.40199657]
bas 16, expnt(s) = [3.36782991]
bas 17, expnt(s) = [8.60362019]
bas 18, expnt(s) = [0.49258113]
CPU time:       164.06
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63377194e-01 9.28856553e-01 1.17616814e+05 1.60460109e+04
 6.69853206e-01 1.87068108e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347365e+03 1.99600730e+03
 1.83758101e+04 3.98749265e+03 1.44974654e+03 5.93586595e+02
 3.74022754e+02 2.14876312e+02 1.13280688e+02 8.77267280e+01
 3.78970968e+01 3.85895292e+01 8.40199657e+00 1.24681466e+01
 3.36782991e+00 6.28098327e+00 8.60362019e+00 4.29868805e+01
 4.92581125e-01 1.20387557e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335751869165478
cond(S) = 907754.6870293432
E1 = -689.5620411679735  E_coul = 184.959753395302
init E= -504.602287772672
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672493667736566  LUMO = 0.769711388210606
  mo_energy =
[-1.21704895e+02 -1.33852510e+01 -7.62434728e+00 -7.62434728e+00
 -7.62434728e+00 -1.65763938e+00 -6.72493668e-01 -6.72493668e-01
 -6.72493668e-01  7.69711388e-01  1.25614406e+01  1.12898087e+02
  6.07109799e+02  2.74636119e+03  1.22252025e+04  4.08465555e+04
  1.04890123e+05  2.30073519e+05  4.55888426e+05  8.44840660e+05
  1.52801790e+06  2.85028526e+06  5.80817250e+06]
E1 = -707.7276622495766  E_coul = 199.7722548813973
cycle= 1 E= -507.955407368179  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625856
diis-c [-0.39169621  1.        ]
  HOMO = -0.217942037377908  LUMO = 1.17594667450679
  mo_energy =
[-1.20194570e+02 -1.23036868e+01 -6.59469702e+00 -6.59469702e+00
 -6.59469702e+00 -1.16323833e+00 -2.17942037e-01 -2.17942037e-01
 -2.17942037e-01  1.17594667e+00  1.35069352e+01  1.14298546e+02
  6.08605959e+02  2.74779647e+03  1.22265287e+04  4.08478154e+04
  1.04891346e+05  2.30074718e+05  4.55889607e+05  8.44841829e+05
  1.52801906e+06  2.85028641e+06  5.80817364e+06]
E1 = -706.7921129261158  E_coul = 198.81928455642446
cycle= 2 E= -507.972828369691  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.446
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258253
diis-c [-6.64061722e-04  2.70816163e-03  9.97291838e-01]
  HOMO = -0.23965897600158  LUMO = 1.16934694797145
  mo_energy =
[-1.20306755e+02 -1.23695910e+01 -6.66768100e+00 -6.66768100e+00
 -6.66768100e+00 -1.17722211e+00 -2.39658976e-01 -2.39658976e-01
 -2.39658976e-01  1.16934695e+00  1.34558829e+01  1.14204847e+02
  6.08489822e+02  2.74766438e+03  1.22263866e+04  4.08476695e+04
  1.04891198e+05  2.30074570e+05  4.55889459e+05  8.44841680e+05
  1.52801891e+06  2.85028626e+06  5.80817349e+06]
E1 = -706.6878331238266  E_coul = 198.7147569646018
cycle= 3 E= -507.973076159225  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292692
diis-c [-1.55215954e-06 -1.76221888e-04 -1.14472681e-01  1.11464890e+00]
  HOMO = -0.242788641968234  LUMO = 1.16816887770931
  mo_energy =
[-1.20318848e+02 -1.23782737e+01 -6.67687858e+00 -6.67687858e+00
 -6.67687858e+00 -1.17911678e+00 -2.42788642e-01 -2.42788642e-01
 -2.42788642e-01  1.16816888e+00  1.34488789e+01  1.14194079e+02
  6.08477557e+02  2.74765124e+03  1.22263729e+04  4.08476556e+04
  1.04891184e+05  2.30074556e+05  4.55889445e+05  8.44841666e+05
  1.52801890e+06  2.85028625e+06  5.80817348e+06]
E1 = -706.672932616075  E_coul = 198.6998519258284
cycle= 4 E= -507.973080690247  delta_E= -4.53e-06  |g|= 0.000158  |ddm|= 0.00914
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108456
diis-c [-6.84662136e-11 -5.31411984e-06  7.33967547e-03 -9.11383665e-02
  1.08380401e+00]
  HOMO = -0.242893179264557  LUMO = 1.16812331097327
  mo_energy =
[-1.20319090e+02 -1.23785284e+01 -6.67712736e+00 -6.67712736e+00
 -6.67712736e+00 -1.17917814e+00 -2.42893179e-01 -2.42893179e-01
 -2.42893179e-01  1.16812331e+00  1.34486626e+01  1.14193834e+02
  6.08477315e+02  2.74765100e+03  1.22263727e+04  4.08476554e+04
  1.04891184e+05  2.30074556e+05  4.55889444e+05  8.44841666e+05
  1.52801890e+06  2.85028625e+06  5.80817348e+06]
E1 = -706.6724414140373  E_coul = 198.69936071837557
cycle= 5 E= -507.973080695662  delta_E= -5.42e-09  |g|= 2.55e-07  |ddm|= 0.000332
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.59629e-07
diis-c [-1.07184381e-14  1.78907489e-07 -9.00363353e-05  1.00599351e-03
 -1.12628482e-02  1.01034671e+00]
  HOMO = -0.242893227215438  LUMO = 1.1681234619687
  mo_energy =
[-1.20319091e+02 -1.23785286e+01 -6.67712768e+00 -6.67712768e+00
 -6.67712768e+00 -1.17917830e+00 -2.42893227e-01 -2.42893227e-01
 -2.42893227e-01  1.16812346e+00  1.34486624e+01  1.14193834e+02
  6.08477314e+02  2.74765100e+03  1.22263727e+04  4.08476554e+04
  1.04891184e+05  2.30074556e+05  4.55889444e+05  8.44841666e+05
  1.52801890e+06  2.85028625e+06  5.80817348e+06]
E1 = -706.6724410054011  E_coul = 198.6993603097391
cycle= 6 E= -507.973080695662  delta_E= -3.41e-13  |g|= 1.31e-08  |ddm|= 1.68e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6724410054011  E_coul = 198.6993603097391
  HOMO = -0.242893220375049  LUMO = 1.16812346358547
  mo_energy =
[-1.20319091e+02 -1.23785286e+01 -6.67712766e+00 -6.67712766e+00
 -6.67712766e+00 -1.17917829e+00 -2.42893220e-01 -2.42893220e-01
 -2.42893220e-01  1.16812346e+00  1.34486625e+01  1.14193834e+02
  6.08477315e+02  2.74765100e+03  1.22263727e+04  4.08476554e+04
  1.04891184e+05  2.30074556e+05  4.55889444e+05  8.44841666e+05
  1.52801890e+06  2.85028625e+06  5.80817348e+06]
E1 = -706.6724410402621  E_coul = 198.69936034460042
Extra cycle  E= -507.973080695662  delta_E= 3.41e-13  |g|= 2.3e-09  |ddm|= 2.32e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907754.6870293432
E1 = -706.6724410402621  E_coul = 198.69936034460042
init E= -507.973080695662
    CPU time for initialize scf      1.48 sec, wall time      0.09 sec
  HOMO = -0.24289321940088  LUMO = 1.16812346184206
  mo_energy =
[-1.20319091e+02 -1.23785286e+01 -6.67712766e+00 -6.67712766e+00
 -6.67712766e+00 -1.17917829e+00 -2.42893219e-01 -2.42893219e-01
 -2.42893219e-01  1.16812346e+00  1.34486625e+01  1.14193834e+02
  6.08477315e+02  2.74765100e+03  1.22263727e+04  4.08476554e+04
  1.04891184e+05  2.30074556e+05  4.55889444e+05  8.44841666e+05
  1.52801890e+06  2.85028625e+06  5.80817348e+06]
E1 = -706.6724410476226  E_coul = 198.69936035196045
cycle= 1 E= -507.973080695662  delta_E= -4.55e-13  |g|= 1.18e-09  |ddm|= 4.72e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.6724410476226  E_coul = 198.69936035196045
  HOMO = -0.242893219194739  LUMO = 1.16812346289003
  mo_energy =
[-1.20319091e+02 -1.23785286e+01 -6.67712766e+00 -6.67712766e+00
 -6.67712766e+00 -1.17917829e+00 -2.42893219e-01 -2.42893219e-01
 -2.42893219e-01  1.16812346e+00  1.34486625e+01  1.14193834e+02
  6.08477315e+02  2.74765100e+03  1.22263727e+04  4.08476554e+04
  1.04891184e+05  2.30074556e+05  4.55889444e+05  8.44841666e+05
  1.52801890e+06  2.85028625e+06  5.80817348e+06]
E1 = -706.6724410484593  E_coul = 198.6993603527978
Extra cycle  E= -507.973080695661  delta_E= 6.82e-13  |g|= 1.34e-09  |ddm|= 5.2e-10
    CPU time for scf_cycle      1.65 sec, wall time      0.16 sec
exp = [2.63377194e-01 1.17616814e+05 6.69853206e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347365e+03 1.83758101e+04 1.44974654e+03
 3.74022754e+02 1.13280688e+02 3.78970968e+01 8.40199657e+00
 3.36782991e+00 8.60362019e+00 4.92581125e-01]
grad_E = [-1.52338650e-04  4.19772507e-09  9.42331912e-05  1.89436150e-11
  1.13269801e-10  6.53094755e-10  2.56136066e-09  1.06416633e-08
  5.72306098e-08  3.60225957e-06  1.23219605e-07  4.23766029e-06
  7.85474800e-06 -8.34511374e-05 -1.51140937e-04  1.44448037e-05
  1.22286313e-04  4.22578832e-06  2.25653257e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263235786491       1
[INPUT] 0    0    [1    /1   ]  117616.81424         1
[INPUT] 0    0    [1    /1   ]  0.66919269769        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992146        1
[INPUT] 0    0    [1    /1   ]  73510.4209652        1
[INPUT] 0    0    [1    /1   ]  36754.7200118        1
[INPUT] 0    0    [1    /1   ]  7303.47362824        1
[INPUT] 0    0    [1    /1   ]  18375.8101383        1
[INPUT] 0    0    [1    /1   ]  1449.74649715        1
[INPUT] 0    0    [1    /1   ]  374.022879755        1
[INPUT] 0    0    [1    /1   ]  113.279938949        1
[INPUT] 0    0    [1    /1   ]  37.9012919306        1
[INPUT] 0    0    [1    /1   ]  8.40815165318        1
[INPUT] 0    0    [1    /1   ]  3.36896847771        1
[INPUT] 1    0    [1    /1   ]  8.60360620674        1
[INPUT] 1    0    [1    /1   ]  0.492575539384       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2632357864910776, 1.0]], [0, [117616.81423967899, 1.0]], [0, [0.6691926976903555, 1.0]], [0, [1176168.1426188778, 1.0]], [0, [588084.0699925066, 1.0]], [0, [294042.0311315513, 1.0]], [0, [147020.9921464827, 1.0]], [0, [73510.42096516378, 1.0]], [0, [36754.72001183936, 1.0]], [0, [7303.473628241932, 1.0]], [0, [18375.810138282795, 1.0]], [0, [1449.7464971475529, 1.0]], [0, [374.02287975463497, 1.0]], [0, [113.27993894941496, 1.0]], [0, [37.90129193063898, 1.0]], [0, [8.408151653175633, 1.0]], [0, [3.368968477714236, 1.0]], [1, [8.6036062067371, 1.0]], [1, [0.4925755393839876, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26323579]
bas 1, expnt(s) = [117616.81423968]
bas 2, expnt(s) = [0.6691927]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999251]
bas 5, expnt(s) = [294042.03113155]
bas 6, expnt(s) = [147020.99214648]
bas 7, expnt(s) = [73510.42096516]
bas 8, expnt(s) = [36754.72001184]
bas 9, expnt(s) = [7303.47362824]
bas 10, expnt(s) = [18375.81013828]
bas 11, expnt(s) = [1449.74649715]
bas 12, expnt(s) = [374.02287975]
bas 13, expnt(s) = [113.27993895]
bas 14, expnt(s) = [37.90129193]
bas 15, expnt(s) = [8.40815165]
bas 16, expnt(s) = [3.36896848]
bas 17, expnt(s) = [8.60360621]
bas 18, expnt(s) = [0.49257554]
CPU time:       168.83
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63235786e-01 9.28482499e-01 1.17616814e+05 1.60460109e+04
 6.69192698e-01 1.86929747e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347363e+03 1.99600729e+03
 1.83758101e+04 3.98749265e+03 1.44974650e+03 5.93586582e+02
 3.74022880e+02 2.14876366e+02 1.13279939e+02 8.77262932e+01
 3.79012919e+01 3.85927330e+01 8.40815165e+00 1.24749963e+01
 3.36896848e+00 6.28257577e+00 8.60360621e+00 4.29867932e+01
 4.92575539e-01 1.20385850e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335760061306736
cond(S) = 907755.0649121198
E1 = -689.5617032161372  E_coul = 184.95945679583738
init E= -504.6022464203
    CPU time for initialize scf      0.19 sec, wall time      0.03 sec
  HOMO = -0.672502915290495  LUMO = 0.768547863479075
  mo_energy =
[-1.21704928e+02 -1.33852713e+01 -7.62436640e+00 -7.62436640e+00
 -7.62436640e+00 -1.65764695e+00 -6.72502915e-01 -6.72502915e-01
 -6.72502915e-01  7.68547863e-01  1.25672272e+01  1.12931770e+02
  6.07148949e+02  2.74639656e+03  1.22252334e+04  4.08465841e+04
  1.04890150e+05  2.30073546e+05  4.55888452e+05  8.44840686e+05
  1.52801793e+06  2.85028529e+06  5.80817253e+06]
E1 = -707.7271896741554  E_coul = 199.77177844117722
cycle= 1 E= -507.955411232978  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625868
diis-c [-0.39171071  1.        ]
  HOMO = -0.217953441022915  LUMO = 1.17459488290375
  mo_energy =
[-1.20194613e+02 -1.23037238e+01 -6.59473499e+00 -6.59473499e+00
 -6.59473499e+00 -1.16324838e+00 -2.17953441e-01 -2.17953441e-01
 -2.17953441e-01  1.17459488e+00  1.35129559e+01  1.14332236e+02
  6.08645103e+02  2.74783183e+03  1.22265597e+04  4.08478439e+04
  1.04891373e+05  2.30074745e+05  4.55889633e+05  8.44841855e+05
  1.52801908e+06  2.85028644e+06  5.80817367e+06]
E1 = -706.7917819957224  E_coul = 198.81895352821013
cycle= 2 E= -507.972828467512  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258254
diis-c [-6.64065812e-04  2.70825371e-03  9.97291746e-01]
  HOMO = -0.239668935125104  LUMO = 1.16800345508119
  mo_energy =
[-1.20306781e+02 -1.23696160e+01 -6.66770597e+00 -6.66770597e+00
 -6.66770597e+00 -1.17723174e+00 -2.39668935e-01 -2.39668935e-01
 -2.39668935e-01  1.16800346e+00  1.34618996e+01  1.14238548e+02
  6.08528983e+02  2.74769977e+03  1.22264175e+04  4.08476981e+04
  1.04891226e+05  2.30074597e+05  4.55889485e+05  8.44841706e+05
  1.52801893e+06  2.85028629e+06  5.80817352e+06]
E1 = -706.6874807945675  E_coul = 198.71440440987936
cycle= 3 E= -507.973076384688  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292756
diis-c [-1.55296005e-06 -1.76643880e-04 -1.14499189e-01  1.11467583e+00]
  HOMO = -0.242799810042601  LUMO = 1.16682609074053
  mo_energy =
[-1.20318876e+02 -1.23783005e+01 -6.67690533e+00 -6.67690533e+00
 -6.67690533e+00 -1.17912725e+00 -2.42799810e-01 -2.42799810e-01
 -2.42799810e-01  1.16682609e+00  1.34548922e+01  1.14227779e+02
  6.08516715e+02  2.74768662e+03  1.22264039e+04  4.08476842e+04
  1.04891212e+05  2.30074583e+05  4.55889471e+05  8.44841692e+05
  1.52801892e+06  2.85028627e+06  5.80817350e+06]
E1 = -706.6725706279238  E_coul = 198.69948970609792
cycle= 4 E= -507.973080921826  delta_E= -4.54e-06  |g|= 0.000158  |ddm|= 0.00915
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108546
diis-c [-6.85762846e-11 -5.31105765e-06  7.34273547e-03 -9.11785813e-02
  1.08384116e+00]
  HOMO = -0.242904504340261  LUMO = 1.16678050077733
  mo_energy =
[-1.20319118e+02 -1.23785556e+01 -6.67715448e+00 -6.67715448e+00
 -6.67715448e+00 -1.17918870e+00 -2.42904504e-01 -2.42904504e-01
 -2.42904504e-01  1.16678050e+00  1.34546756e+01  1.14227533e+02
  6.08516474e+02  2.74768638e+03  1.22264036e+04  4.08476840e+04
  1.04891212e+05  2.30074583e+05  4.55889471e+05  8.44841691e+05
  1.52801892e+06  2.85028627e+06  5.80817350e+06]
E1 = -706.6720785417131  E_coul = 198.69899761445393
cycle= 5 E= -507.973080927259  delta_E= -5.43e-09  |g|= 2.56e-07  |ddm|= 0.000332
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.61763e-07
diis-c [-1.05985509e-14  1.83760621e-07 -9.13968638e-05  1.02208233e-03
 -1.14353452e-02  1.01050448e+00]
  HOMO = -0.242904552055475  LUMO = 1.16678065124794
  mo_energy =
[-1.20319119e+02 -1.23785558e+01 -6.67715480e+00 -6.67715480e+00
 -6.67715480e+00 -1.17918886e+00 -2.42904552e-01 -2.42904552e-01
 -2.42904552e-01  1.16678065e+00  1.34546755e+01  1.14227533e+02
  6.08516473e+02  2.74768638e+03  1.22264036e+04  4.08476840e+04
  1.04891212e+05  2.30074583e+05  4.55889471e+05  8.44841691e+05
  1.52801892e+06  2.85028627e+06  5.80817350e+06]
E1 = -706.6720781320623  E_coul = 198.6989972048034
cycle= 6 E= -507.973080927259  delta_E= 2.27e-13  |g|= 1.31e-08  |ddm|= 1.69e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6720781320623  E_coul = 198.6989972048034
  HOMO = -0.242904545313073  LUMO = 1.16678065141885
  mo_energy =
[-1.20319119e+02 -1.23785558e+01 -6.67715478e+00 -6.67715478e+00
 -6.67715478e+00 -1.17918886e+00 -2.42904545e-01 -2.42904545e-01
 -2.42904545e-01  1.16678065e+00  1.34546755e+01  1.14227533e+02
  6.08516473e+02  2.74768638e+03  1.22264036e+04  4.08476840e+04
  1.04891212e+05  2.30074583e+05  4.55889471e+05  8.44841691e+05
  1.52801892e+06  2.85028627e+06  5.80817350e+06]
E1 = -706.672078168185  E_coul = 198.6989972409259
Extra cycle  E= -507.973080927259  delta_E= -1.14e-13  |g|= 1.82e-09  |ddm|= 2.4e-08
    CPU time for scf_cycle      0.47 sec, wall time      0.11 sec
exp = [2.63235786e-01 1.17616814e+05 6.69192698e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347363e+03 1.83758101e+04 1.44974650e+03
 3.74022880e+02 1.13279939e+02 3.79012919e+01 8.40815165e+00
 3.36896848e+00 8.60360621e+00 4.92575539e-01]
E = -507.97308092725905
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:53:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263235786491       1
[INPUT] 0    0    [1    /1   ]  117616.81424         1
[INPUT] 0    0    [1    /1   ]  0.66919269769        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992146        1
[INPUT] 0    0    [1    /1   ]  73510.4209652        1
[INPUT] 0    0    [1    /1   ]  36754.7200118        1
[INPUT] 0    0    [1    /1   ]  7303.47362824        1
[INPUT] 0    0    [1    /1   ]  18375.8101383        1
[INPUT] 0    0    [1    /1   ]  1449.74649715        1
[INPUT] 0    0    [1    /1   ]  374.022879755        1
[INPUT] 0    0    [1    /1   ]  113.279938949        1
[INPUT] 0    0    [1    /1   ]  37.9012919306        1
[INPUT] 0    0    [1    /1   ]  8.40815165318        1
[INPUT] 0    0    [1    /1   ]  3.36896847771        1
[INPUT] 1    0    [1    /1   ]  8.60360620674        1
[INPUT] 1    0    [1    /1   ]  0.492575539384       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2632357864910776, 1.0]], [0, [117616.81423967899, 1.0]], [0, [0.6691926976903555, 1.0]], [0, [1176168.1426188778, 1.0]], [0, [588084.0699925066, 1.0]], [0, [294042.0311315513, 1.0]], [0, [147020.9921464827, 1.0]], [0, [73510.42096516378, 1.0]], [0, [36754.72001183936, 1.0]], [0, [7303.473628241932, 1.0]], [0, [18375.810138282795, 1.0]], [0, [1449.7464971475529, 1.0]], [0, [374.02287975463497, 1.0]], [0, [113.27993894941496, 1.0]], [0, [37.90129193063898, 1.0]], [0, [8.408151653175633, 1.0]], [0, [3.368968477714236, 1.0]], [1, [8.6036062067371, 1.0]], [1, [0.4925755393839876, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26323579]
bas 1, expnt(s) = [117616.81423968]
bas 2, expnt(s) = [0.6691927]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999251]
bas 5, expnt(s) = [294042.03113155]
bas 6, expnt(s) = [147020.99214648]
bas 7, expnt(s) = [73510.42096516]
bas 8, expnt(s) = [36754.72001184]
bas 9, expnt(s) = [7303.47362824]
bas 10, expnt(s) = [18375.81013828]
bas 11, expnt(s) = [1449.74649715]
bas 12, expnt(s) = [374.02287975]
bas 13, expnt(s) = [113.27993895]
bas 14, expnt(s) = [37.90129193]
bas 15, expnt(s) = [8.40815165]
bas 16, expnt(s) = [3.36896848]
bas 17, expnt(s) = [8.60360621]
bas 18, expnt(s) = [0.49257554]
CPU time:       169.41
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63235786e-01 9.28482499e-01 1.17616814e+05 1.60460109e+04
 6.69192698e-01 1.86929747e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347363e+03 1.99600729e+03
 1.83758101e+04 3.98749265e+03 1.44974650e+03 5.93586582e+02
 3.74022880e+02 2.14876366e+02 1.13279939e+02 8.77262932e+01
 3.79012919e+01 3.85927330e+01 8.40815165e+00 1.24749963e+01
 3.36896848e+00 6.28257577e+00 8.60360621e+00 4.29867932e+01
 4.92575539e-01 1.20385850e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335760061306736
cond(S) = 907755.0649121198
E1 = -689.5617032161372  E_coul = 184.95945679583738
init E= -504.6022464203
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672502915290495  LUMO = 0.768547863479075
  mo_energy =
[-1.21704928e+02 -1.33852713e+01 -7.62436640e+00 -7.62436640e+00
 -7.62436640e+00 -1.65764695e+00 -6.72502915e-01 -6.72502915e-01
 -6.72502915e-01  7.68547863e-01  1.25672272e+01  1.12931770e+02
  6.07148949e+02  2.74639656e+03  1.22252334e+04  4.08465841e+04
  1.04890150e+05  2.30073546e+05  4.55888452e+05  8.44840686e+05
  1.52801793e+06  2.85028529e+06  5.80817253e+06]
E1 = -707.7271896741554  E_coul = 199.77177844117722
cycle= 1 E= -507.955411232978  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625868
diis-c [-0.39171071  1.        ]
  HOMO = -0.217953441022915  LUMO = 1.17459488290375
  mo_energy =
[-1.20194613e+02 -1.23037238e+01 -6.59473499e+00 -6.59473499e+00
 -6.59473499e+00 -1.16324838e+00 -2.17953441e-01 -2.17953441e-01
 -2.17953441e-01  1.17459488e+00  1.35129559e+01  1.14332236e+02
  6.08645103e+02  2.74783183e+03  1.22265597e+04  4.08478439e+04
  1.04891373e+05  2.30074745e+05  4.55889633e+05  8.44841855e+05
  1.52801908e+06  2.85028644e+06  5.80817367e+06]
E1 = -706.7917819957224  E_coul = 198.81895352821013
cycle= 2 E= -507.972828467512  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.447
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258254
diis-c [-6.64065812e-04  2.70825371e-03  9.97291746e-01]
  HOMO = -0.239668935125104  LUMO = 1.16800345508119
  mo_energy =
[-1.20306781e+02 -1.23696160e+01 -6.66770597e+00 -6.66770597e+00
 -6.66770597e+00 -1.17723174e+00 -2.39668935e-01 -2.39668935e-01
 -2.39668935e-01  1.16800346e+00  1.34618996e+01  1.14238548e+02
  6.08528983e+02  2.74769977e+03  1.22264175e+04  4.08476981e+04
  1.04891226e+05  2.30074597e+05  4.55889485e+05  8.44841706e+05
  1.52801893e+06  2.85028629e+06  5.80817352e+06]
E1 = -706.6874807945675  E_coul = 198.71440440987936
cycle= 3 E= -507.973076384688  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292756
diis-c [-1.55296005e-06 -1.76643880e-04 -1.14499189e-01  1.11467583e+00]
  HOMO = -0.242799810042601  LUMO = 1.16682609074053
  mo_energy =
[-1.20318876e+02 -1.23783005e+01 -6.67690533e+00 -6.67690533e+00
 -6.67690533e+00 -1.17912725e+00 -2.42799810e-01 -2.42799810e-01
 -2.42799810e-01  1.16682609e+00  1.34548922e+01  1.14227779e+02
  6.08516715e+02  2.74768662e+03  1.22264039e+04  4.08476842e+04
  1.04891212e+05  2.30074583e+05  4.55889471e+05  8.44841692e+05
  1.52801892e+06  2.85028627e+06  5.80817350e+06]
E1 = -706.6725706279238  E_coul = 198.69948970609792
cycle= 4 E= -507.973080921826  delta_E= -4.54e-06  |g|= 0.000158  |ddm|= 0.00915
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108546
diis-c [-6.85762846e-11 -5.31105765e-06  7.34273547e-03 -9.11785813e-02
  1.08384116e+00]
  HOMO = -0.242904504340261  LUMO = 1.16678050077733
  mo_energy =
[-1.20319118e+02 -1.23785556e+01 -6.67715448e+00 -6.67715448e+00
 -6.67715448e+00 -1.17918870e+00 -2.42904504e-01 -2.42904504e-01
 -2.42904504e-01  1.16678050e+00  1.34546756e+01  1.14227533e+02
  6.08516474e+02  2.74768638e+03  1.22264036e+04  4.08476840e+04
  1.04891212e+05  2.30074583e+05  4.55889471e+05  8.44841691e+05
  1.52801892e+06  2.85028627e+06  5.80817350e+06]
E1 = -706.6720785417131  E_coul = 198.69899761445393
cycle= 5 E= -507.973080927259  delta_E= -5.43e-09  |g|= 2.56e-07  |ddm|= 0.000332
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.61763e-07
diis-c [-1.05985509e-14  1.83760621e-07 -9.13968638e-05  1.02208233e-03
 -1.14353452e-02  1.01050448e+00]
  HOMO = -0.242904552055475  LUMO = 1.16678065124794
  mo_energy =
[-1.20319119e+02 -1.23785558e+01 -6.67715480e+00 -6.67715480e+00
 -6.67715480e+00 -1.17918886e+00 -2.42904552e-01 -2.42904552e-01
 -2.42904552e-01  1.16678065e+00  1.34546755e+01  1.14227533e+02
  6.08516473e+02  2.74768638e+03  1.22264036e+04  4.08476840e+04
  1.04891212e+05  2.30074583e+05  4.55889471e+05  8.44841691e+05
  1.52801892e+06  2.85028627e+06  5.80817350e+06]
E1 = -706.6720781320623  E_coul = 198.6989972048034
cycle= 6 E= -507.973080927259  delta_E= 2.27e-13  |g|= 1.31e-08  |ddm|= 1.69e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6720781320623  E_coul = 198.6989972048034
  HOMO = -0.242904545313073  LUMO = 1.16678065141885
  mo_energy =
[-1.20319119e+02 -1.23785558e+01 -6.67715478e+00 -6.67715478e+00
 -6.67715478e+00 -1.17918886e+00 -2.42904545e-01 -2.42904545e-01
 -2.42904545e-01  1.16678065e+00  1.34546755e+01  1.14227533e+02
  6.08516473e+02  2.74768638e+03  1.22264036e+04  4.08476840e+04
  1.04891212e+05  2.30074583e+05  4.55889471e+05  8.44841691e+05
  1.52801892e+06  2.85028627e+06  5.80817350e+06]
E1 = -706.672078168185  E_coul = 198.6989972409259
Extra cycle  E= -507.973080927259  delta_E= -1.14e-13  |g|= 1.82e-09  |ddm|= 2.4e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907755.0649121198
E1 = -706.672078168185  E_coul = 198.6989972409259
init E= -507.973080927259
    CPU time for initialize scf      1.48 sec, wall time      0.09 sec
  HOMO = -0.242904544302354  LUMO = 1.16678065438267
  mo_energy =
[-1.20319119e+02 -1.23785558e+01 -6.67715478e+00 -6.67715478e+00
 -6.67715478e+00 -1.17918886e+00 -2.42904544e-01 -2.42904544e-01
 -2.42904544e-01  1.16678065e+00  1.34546755e+01  1.14227533e+02
  6.08516473e+02  2.74768638e+03  1.22264036e+04  4.08476840e+04
  1.04891212e+05  2.30074583e+05  4.55889471e+05  8.44841691e+05
  1.52801892e+06  2.85028627e+06  5.80817350e+06]
E1 = -706.672078171503  E_coul = 198.69899724424423
cycle= 1 E= -507.973080927259  delta_E= 2.27e-13  |g|= 1.9e-09  |ddm|= 2.1e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.672078171503  E_coul = 198.69899724424423
  HOMO = -0.242904544218758  LUMO = 1.16678065130687
  mo_energy =
[-1.20319119e+02 -1.23785558e+01 -6.67715478e+00 -6.67715478e+00
 -6.67715478e+00 -1.17918886e+00 -2.42904544e-01 -2.42904544e-01
 -2.42904544e-01  1.16678065e+00  1.34546755e+01  1.14227533e+02
  6.08516473e+02  2.74768638e+03  1.22264036e+04  4.08476840e+04
  1.04891212e+05  2.30074583e+05  4.55889471e+05  8.44841691e+05
  1.52801892e+06  2.85028627e+06  5.80817350e+06]
E1 = -706.6720781763763  E_coul = 198.69899724911735
Extra cycle  E= -507.973080927259  delta_E= -1.14e-13  |g|= 1.96e-09  |ddm|= 3.08e-09
    CPU time for scf_cycle      1.65 sec, wall time      0.16 sec
exp = [2.63235786e-01 1.17616814e+05 6.69192698e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347363e+03 1.83758101e+04 1.44974650e+03
 3.74022880e+02 1.13279939e+02 3.79012919e+01 8.40815165e+00
 3.36896848e+00 8.60360621e+00 4.92575539e-01]
grad_E = [-2.68376954e-06  4.19927567e-09 -1.81997471e-06  1.89620599e-11
  1.13320089e-10  6.53334905e-10  2.56231878e-09  1.06457010e-08
  5.72505505e-08  3.60369264e-06  1.23279903e-07  4.15410056e-06
  9.09768023e-06 -9.22118630e-05 -1.28346730e-04  5.83194772e-05
  2.58700403e-05  5.85832119e-07  1.46213513e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263208219235       1
[INPUT] 0    0    [1    /1   ]  117616.81424         1
[INPUT] 0    0    [1    /1   ]  0.669074812372       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992146        1
[INPUT] 0    0    [1    /1   ]  73510.4209652        1
[INPUT] 0    0    [1    /1   ]  36754.720012         1
[INPUT] 0    0    [1    /1   ]  7303.47363853        1
[INPUT] 0    0    [1    /1   ]  18375.8101386        1
[INPUT] 0    0    [1    /1   ]  1449.74649914        1
[INPUT] 0    0    [1    /1   ]  374.023043991        1
[INPUT] 0    0    [1    /1   ]  113.278802236        1
[INPUT] 0    0    [1    /1   ]  37.9029445402        1
[INPUT] 0    0    [1    /1   ]  8.40888231687        1
[INPUT] 0    0    [1    /1   ]  3.36905937759        1
[INPUT] 1    0    [1    /1   ]  8.60360257666        1
[INPUT] 1    0    [1    /1   ]  0.492574170178       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26320821923500715, 1.0]], [0, [117616.81423969097, 1.0]], [0, [0.6690748123719323, 1.0]], [0, [1176168.1426188778, 1.0]], [0, [588084.069992507, 1.0]], [0, [294042.0311315532, 1.0]], [0, [147020.99214649, 1.0]], [0, [73510.42096519416, 1.0]], [0, [36754.72001200252, 1.0]], [0, [7303.473638532619, 1.0]], [0, [18375.810138636236, 1.0]], [0, [1449.746499140122, 1.0]], [0, [374.02304399133055, 1.0]], [0, [113.27880223581826, 1.0]], [0, [37.902944540218925, 1.0]], [0, [8.408882316874752, 1.0]], [0, [3.369059377586153, 1.0]], [1, [8.603602576655183, 1.0]], [1, [0.49257417017828464, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26320822]
bas 1, expnt(s) = [117616.81423969]
bas 2, expnt(s) = [0.66907481]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999251]
bas 5, expnt(s) = [294042.03113155]
bas 6, expnt(s) = [147020.99214649]
bas 7, expnt(s) = [73510.42096519]
bas 8, expnt(s) = [36754.720012]
bas 9, expnt(s) = [7303.47363853]
bas 10, expnt(s) = [18375.81013864]
bas 11, expnt(s) = [1449.74649914]
bas 12, expnt(s) = [374.02304399]
bas 13, expnt(s) = [113.27880224]
bas 14, expnt(s) = [37.90294454]
bas 15, expnt(s) = [8.40888232]
bas 16, expnt(s) = [3.36905938]
bas 17, expnt(s) = [8.60360258]
bas 18, expnt(s) = [0.49257417]
CPU time:       174.22
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63208219e-01 9.28409572e-01 1.17616814e+05 1.60460109e+04
 6.69074812e-01 1.86905050e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347364e+03 1.99600729e+03
 1.83758101e+04 3.98749265e+03 1.44974650e+03 5.93586583e+02
 3.74023044e+02 2.14876437e+02 1.13278802e+02 8.77256330e+01
 3.79029445e+01 3.85939950e+01 8.40888232e+00 1.24758094e+01
 3.36905938e+00 6.28270290e+00 8.60360258e+00 4.29867705e+01
 4.92574170e-01 1.20385432e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33576210340027
cond(S) = 907755.1168817776
E1 = -689.5615970910801  E_coul = 184.9593874292805
init E= -504.6022096618
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672504978147047  LUMO = 0.768328363272683
  mo_energy =
[-1.21704935e+02 -1.33852771e+01 -7.62437082e+00 -7.62437082e+00
 -7.62437082e+00 -1.65764865e+00 -6.72504978e-01 -6.72504978e-01
 -6.72504978e-01  7.68328363e-01  1.25676067e+01  1.12937129e+02
  6.07154967e+02  2.74640135e+03  1.22252375e+04  4.08465880e+04
  1.04890154e+05  2.30073550e+05  4.55888455e+05  8.44840689e+05
  1.52801793e+06  2.85028529e+06  5.80817253e+06]
E1 = -707.7270789622255  E_coul = 199.77166702794443
cycle= 1 E= -507.955411934281  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625871
diis-c [-0.39171417  1.        ]
  HOMO = -0.217956361101758  LUMO = 1.17433858245107
  mo_energy =
[-1.20194621e+02 -1.23037337e+01 -6.59474382e+00 -6.59474382e+00
 -6.59474382e+00 -1.16325093e+00 -2.17956361e-01 -2.17956361e-01
 -2.17956361e-01  1.17433858e+00  1.35133618e+01  1.14337597e+02
  6.08651123e+02  2.74783662e+03  1.22265638e+04  4.08478478e+04
  1.04891377e+05  2.30074749e+05  4.55889637e+05  8.44841858e+05
  1.52801909e+06  2.85028644e+06  5.80817367e+06]
E1 = -706.7916965703929  E_coul = 198.81886808102428
cycle= 2 E= -507.972828489369  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258254
diis-c [-6.64067727e-04  2.70832221e-03  9.97291678e-01]
  HOMO = -0.239671544630472  LUMO = 1.16774880065001
  mo_energy =
[-1.20306787e+02 -1.23696237e+01 -6.66771250e+00 -6.66771250e+00
 -6.66771250e+00 -1.17723418e+00 -2.39671545e-01 -2.39671545e-01
 -2.39671545e-01  1.16774880e+00  1.34623059e+01  1.14243911e+02
  6.08535006e+02  2.74770456e+03  1.22264217e+04  4.08477019e+04
  1.04891229e+05  2.30074600e+05  4.55889488e+05  8.44841709e+05
  1.52801894e+06  2.85028629e+06  5.80817352e+06]
E1 = -706.6873915524556  E_coul = 198.71431512284772
cycle= 3 E= -507.973076429608  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0599
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0029277
diis-c [-1.55310589e-06 -1.76729078e-04 -1.14504822e-01  1.11468155e+00]
  HOMO = -0.242802640930295  LUMO = 1.16657158239817
  mo_energy =
[-1.20318881e+02 -1.23783085e+01 -6.67691219e+00 -6.67691219e+00
 -6.67691219e+00 -1.17912984e+00 -2.42802641e-01 -2.42802641e-01
 -2.42802641e-01  1.16657158e+00  1.34552981e+01  1.14233141e+02
  6.08522738e+02  2.74769141e+03  1.22264080e+04  4.08476881e+04
  1.04891215e+05  2.30074586e+05  4.55889474e+05  8.44841695e+05
  1.52801892e+06  2.85028628e+06  5.80817351e+06]
E1 = -706.6724795987831  E_coul = 198.6993986308947
cycle= 4 E= -507.973080967888  delta_E= -4.54e-06  |g|= 0.000158  |ddm|= 0.00915
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108562
diis-c [-6.85849381e-11 -5.31367137e-06  7.34341972e-03 -9.11859788e-02
  1.08384787e+00]
  HOMO = -0.242907362933389  LUMO = 1.16652598808951
  mo_energy =
[-1.20319124e+02 -1.23785636e+01 -6.67716140e+00 -6.67716140e+00
 -6.67716140e+00 -1.17919131e+00 -2.42907363e-01 -2.42907363e-01
 -2.42907363e-01  1.16652599e+00  1.34550814e+01  1.14232895e+02
  6.08522496e+02  2.74769117e+03  1.22264078e+04  4.08476878e+04
  1.04891215e+05  2.30074586e+05  4.55889474e+05  8.44841695e+05
  1.52801892e+06  2.85028628e+06  5.80817351e+06]
E1 = -706.6719873591575  E_coul = 198.69890638583288
cycle= 5 E= -507.973080973325  delta_E= -5.44e-09  |g|= 2.56e-07  |ddm|= 0.000333
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.61519e-07
diis-c [-1.06889407e-14  1.81216598e-07 -9.11465820e-05  1.01871822e-03
 -1.13824165e-02  1.01045466e+00]
  HOMO = -0.242907410594187  LUMO = 1.16652613821889
  mo_energy =
[-1.20319125e+02 -1.23785639e+01 -6.67716172e+00 -6.67716172e+00
 -6.67716172e+00 -1.17919147e+00 -2.42907411e-01 -2.42907411e-01
 -2.42907411e-01  1.16652614e+00  1.34550813e+01  1.14232895e+02
  6.08522495e+02  2.74769117e+03  1.22264078e+04  4.08476878e+04
  1.04891215e+05  2.30074586e+05  4.55889474e+05  8.44841695e+05
  1.52801892e+06  2.85028628e+06  5.80817351e+06]
E1 = -706.6719869479807  E_coul = 198.6989059746562
cycle= 6 E= -507.973080973324  delta_E= 1.14e-13  |g|= 1.3e-08  |ddm|= 1.69e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6719869479807  E_coul = 198.6989059746562
  HOMO = -0.242907403936901  LUMO = 1.16652613777849
  mo_energy =
[-1.20319125e+02 -1.23785639e+01 -6.67716170e+00 -6.67716170e+00
 -6.67716170e+00 -1.17919146e+00 -2.42907404e-01 -2.42907404e-01
 -2.42907404e-01  1.16652614e+00  1.34550813e+01  1.14232895e+02
  6.08522495e+02  2.74769117e+03  1.22264078e+04  4.08476878e+04
  1.04891215e+05  2.30074586e+05  4.55889474e+05  8.44841695e+05
  1.52801892e+06  2.85028628e+06  5.80817351e+06]
E1 = -706.671986985182  E_coul = 198.69890601185742
Extra cycle  E= -507.973080973325  delta_E= -1.14e-13  |g|= 1.78e-09  |ddm|= 2.46e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.63208219e-01 1.17616814e+05 6.69074812e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347364e+03 1.83758101e+04 1.44974650e+03
 3.74023044e+02 1.13278802e+02 3.79029445e+01 8.40888232e+00
 3.36905938e+00 8.60360258e+00 4.92574170e-01]
E = -507.9730809733246
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263208219235       1
[INPUT] 0    0    [1    /1   ]  117616.81424         1
[INPUT] 0    0    [1    /1   ]  0.669074812372       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992146        1
[INPUT] 0    0    [1    /1   ]  73510.4209652        1
[INPUT] 0    0    [1    /1   ]  36754.720012         1
[INPUT] 0    0    [1    /1   ]  7303.47363853        1
[INPUT] 0    0    [1    /1   ]  18375.8101386        1
[INPUT] 0    0    [1    /1   ]  1449.74649914        1
[INPUT] 0    0    [1    /1   ]  374.023043991        1
[INPUT] 0    0    [1    /1   ]  113.278802236        1
[INPUT] 0    0    [1    /1   ]  37.9029445402        1
[INPUT] 0    0    [1    /1   ]  8.40888231687        1
[INPUT] 0    0    [1    /1   ]  3.36905937759        1
[INPUT] 1    0    [1    /1   ]  8.60360257666        1
[INPUT] 1    0    [1    /1   ]  0.492574170178       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26320821923500715, 1.0]], [0, [117616.81423969097, 1.0]], [0, [0.6690748123719323, 1.0]], [0, [1176168.1426188778, 1.0]], [0, [588084.069992507, 1.0]], [0, [294042.0311315532, 1.0]], [0, [147020.99214649, 1.0]], [0, [73510.42096519416, 1.0]], [0, [36754.72001200252, 1.0]], [0, [7303.473638532619, 1.0]], [0, [18375.810138636236, 1.0]], [0, [1449.746499140122, 1.0]], [0, [374.02304399133055, 1.0]], [0, [113.27880223581826, 1.0]], [0, [37.902944540218925, 1.0]], [0, [8.408882316874752, 1.0]], [0, [3.369059377586153, 1.0]], [1, [8.603602576655183, 1.0]], [1, [0.49257417017828464, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26320822]
bas 1, expnt(s) = [117616.81423969]
bas 2, expnt(s) = [0.66907481]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999251]
bas 5, expnt(s) = [294042.03113155]
bas 6, expnt(s) = [147020.99214649]
bas 7, expnt(s) = [73510.42096519]
bas 8, expnt(s) = [36754.720012]
bas 9, expnt(s) = [7303.47363853]
bas 10, expnt(s) = [18375.81013864]
bas 11, expnt(s) = [1449.74649914]
bas 12, expnt(s) = [374.02304399]
bas 13, expnt(s) = [113.27880224]
bas 14, expnt(s) = [37.90294454]
bas 15, expnt(s) = [8.40888232]
bas 16, expnt(s) = [3.36905938]
bas 17, expnt(s) = [8.60360258]
bas 18, expnt(s) = [0.49257417]
CPU time:       174.78
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63208219e-01 9.28409572e-01 1.17616814e+05 1.60460109e+04
 6.69074812e-01 1.86905050e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347364e+03 1.99600729e+03
 1.83758101e+04 3.98749265e+03 1.44974650e+03 5.93586583e+02
 3.74023044e+02 2.14876437e+02 1.13278802e+02 8.77256330e+01
 3.79029445e+01 3.85939950e+01 8.40888232e+00 1.24758094e+01
 3.36905938e+00 6.28270290e+00 8.60360258e+00 4.29867705e+01
 4.92574170e-01 1.20385432e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33576210340027
cond(S) = 907755.1168817776
E1 = -689.5615970910801  E_coul = 184.9593874292805
init E= -504.6022096618
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.672504978147047  LUMO = 0.768328363272683
  mo_energy =
[-1.21704935e+02 -1.33852771e+01 -7.62437082e+00 -7.62437082e+00
 -7.62437082e+00 -1.65764865e+00 -6.72504978e-01 -6.72504978e-01
 -6.72504978e-01  7.68328363e-01  1.25676067e+01  1.12937129e+02
  6.07154967e+02  2.74640135e+03  1.22252375e+04  4.08465880e+04
  1.04890154e+05  2.30073550e+05  4.55888455e+05  8.44840689e+05
  1.52801793e+06  2.85028529e+06  5.80817253e+06]
E1 = -707.7270789622255  E_coul = 199.77166702794443
cycle= 1 E= -507.955411934281  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.18 sec, wall time      0.01 sec
diis-norm(errvec)=0.625871
diis-c [-0.39171417  1.        ]
  HOMO = -0.217956361101758  LUMO = 1.17433858245107
  mo_energy =
[-1.20194621e+02 -1.23037337e+01 -6.59474382e+00 -6.59474382e+00
 -6.59474382e+00 -1.16325093e+00 -2.17956361e-01 -2.17956361e-01
 -2.17956361e-01  1.17433858e+00  1.35133618e+01  1.14337597e+02
  6.08651123e+02  2.74783662e+03  1.22265638e+04  4.08478478e+04
  1.04891377e+05  2.30074749e+05  4.55889637e+05  8.44841858e+05
  1.52801909e+06  2.85028644e+06  5.80817367e+06]
E1 = -706.7916965703929  E_coul = 198.81886808102428
cycle= 2 E= -507.972828489369  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.447
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258254
diis-c [-6.64067727e-04  2.70832221e-03  9.97291678e-01]
  HOMO = -0.239671544630472  LUMO = 1.16774880065001
  mo_energy =
[-1.20306787e+02 -1.23696237e+01 -6.66771250e+00 -6.66771250e+00
 -6.66771250e+00 -1.17723418e+00 -2.39671545e-01 -2.39671545e-01
 -2.39671545e-01  1.16774880e+00  1.34623059e+01  1.14243911e+02
  6.08535006e+02  2.74770456e+03  1.22264217e+04  4.08477019e+04
  1.04891229e+05  2.30074600e+05  4.55889488e+05  8.44841709e+05
  1.52801894e+06  2.85028629e+06  5.80817352e+06]
E1 = -706.6873915524556  E_coul = 198.71431512284772
cycle= 3 E= -507.973076429608  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0599
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0029277
diis-c [-1.55310589e-06 -1.76729078e-04 -1.14504822e-01  1.11468155e+00]
  HOMO = -0.242802640930295  LUMO = 1.16657158239817
  mo_energy =
[-1.20318881e+02 -1.23783085e+01 -6.67691219e+00 -6.67691219e+00
 -6.67691219e+00 -1.17912984e+00 -2.42802641e-01 -2.42802641e-01
 -2.42802641e-01  1.16657158e+00  1.34552981e+01  1.14233141e+02
  6.08522738e+02  2.74769141e+03  1.22264080e+04  4.08476881e+04
  1.04891215e+05  2.30074586e+05  4.55889474e+05  8.44841695e+05
  1.52801892e+06  2.85028628e+06  5.80817351e+06]
E1 = -706.6724795987831  E_coul = 198.6993986308947
cycle= 4 E= -507.973080967888  delta_E= -4.54e-06  |g|= 0.000158  |ddm|= 0.00915
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108562
diis-c [-6.85849381e-11 -5.31367137e-06  7.34341972e-03 -9.11859788e-02
  1.08384787e+00]
  HOMO = -0.242907362933389  LUMO = 1.16652598808951
  mo_energy =
[-1.20319124e+02 -1.23785636e+01 -6.67716140e+00 -6.67716140e+00
 -6.67716140e+00 -1.17919131e+00 -2.42907363e-01 -2.42907363e-01
 -2.42907363e-01  1.16652599e+00  1.34550814e+01  1.14232895e+02
  6.08522496e+02  2.74769117e+03  1.22264078e+04  4.08476878e+04
  1.04891215e+05  2.30074586e+05  4.55889474e+05  8.44841695e+05
  1.52801892e+06  2.85028628e+06  5.80817351e+06]
E1 = -706.6719873591575  E_coul = 198.69890638583288
cycle= 5 E= -507.973080973325  delta_E= -5.44e-09  |g|= 2.56e-07  |ddm|= 0.000333
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.61519e-07
diis-c [-1.06889407e-14  1.81216598e-07 -9.11465820e-05  1.01871822e-03
 -1.13824165e-02  1.01045466e+00]
  HOMO = -0.242907410594187  LUMO = 1.16652613821889
  mo_energy =
[-1.20319125e+02 -1.23785639e+01 -6.67716172e+00 -6.67716172e+00
 -6.67716172e+00 -1.17919147e+00 -2.42907411e-01 -2.42907411e-01
 -2.42907411e-01  1.16652614e+00  1.34550813e+01  1.14232895e+02
  6.08522495e+02  2.74769117e+03  1.22264078e+04  4.08476878e+04
  1.04891215e+05  2.30074586e+05  4.55889474e+05  8.44841695e+05
  1.52801892e+06  2.85028628e+06  5.80817351e+06]
E1 = -706.6719869479807  E_coul = 198.6989059746562
cycle= 6 E= -507.973080973324  delta_E= 1.14e-13  |g|= 1.3e-08  |ddm|= 1.69e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6719869479807  E_coul = 198.6989059746562
  HOMO = -0.242907403936901  LUMO = 1.16652613777849
  mo_energy =
[-1.20319125e+02 -1.23785639e+01 -6.67716170e+00 -6.67716170e+00
 -6.67716170e+00 -1.17919146e+00 -2.42907404e-01 -2.42907404e-01
 -2.42907404e-01  1.16652614e+00  1.34550813e+01  1.14232895e+02
  6.08522495e+02  2.74769117e+03  1.22264078e+04  4.08476878e+04
  1.04891215e+05  2.30074586e+05  4.55889474e+05  8.44841695e+05
  1.52801892e+06  2.85028628e+06  5.80817351e+06]
E1 = -706.671986985182  E_coul = 198.69890601185742
Extra cycle  E= -507.973080973325  delta_E= -1.14e-13  |g|= 1.78e-09  |ddm|= 2.46e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907755.1168817776
E1 = -706.671986985182  E_coul = 198.69890601185742
init E= -507.973080973325
    CPU time for initialize scf      1.50 sec, wall time      0.10 sec
  HOMO = -0.242907402899922  LUMO = 1.16652613814865
  mo_energy =
[-1.20319125e+02 -1.23785638e+01 -6.67716170e+00 -6.67716170e+00
 -6.67716170e+00 -1.17919146e+00 -2.42907403e-01 -2.42907403e-01
 -2.42907403e-01  1.16652614e+00  1.34550813e+01  1.14232895e+02
  6.08522495e+02  2.74769117e+03  1.22264078e+04  4.08476878e+04
  1.04891215e+05  2.30074586e+05  4.55889474e+05  8.44841695e+05
  1.52801892e+06  2.85028628e+06  5.80817351e+06]
E1 = -706.6719869892514  E_coul = 198.6989060159273
cycle= 1 E= -507.973080973324  delta_E= 4.55e-13  |g|= 1.11e-09  |ddm|= 2.68e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6719869892514  E_coul = 198.6989060159273
  HOMO = -0.242907402781354  LUMO = 1.16652613968622
  mo_energy =
[-1.20319125e+02 -1.23785638e+01 -6.67716170e+00 -6.67716170e+00
 -6.67716170e+00 -1.17919146e+00 -2.42907403e-01 -2.42907403e-01
 -2.42907403e-01  1.16652614e+00  1.34550813e+01  1.14232895e+02
  6.08522495e+02  2.74769117e+03  1.22264078e+04  4.08476878e+04
  1.04891215e+05  2.30074586e+05  4.55889474e+05  8.44841695e+05
  1.52801892e+06  2.85028628e+06  5.80817351e+06]
E1 = -706.6719869885667  E_coul = 198.69890601524213
Extra cycle  E= -507.973080973325  delta_E= -3.98e-13  |g|= 1.24e-09  |ddm|= 5e-10
    CPU time for scf_cycle      1.66 sec, wall time      0.16 sec
exp = [2.63208219e-01 1.17616814e+05 6.69074812e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347364e+03 1.83758101e+04 1.44974650e+03
 3.74023044e+02 1.13278802e+02 3.79029445e+01 8.40888232e+00
 3.36905938e+00 8.60360258e+00 4.92574170e-01]
grad_E = [ 2.69586352e-05  4.20020192e-09 -2.00033222e-05  1.89730540e-11
  1.13350150e-10  6.53478288e-10  2.56289119e-09  1.06481138e-08
  5.72624515e-08  3.60454311e-06  1.23316049e-07  4.10525633e-06
  9.80454180e-06 -9.68066840e-05 -1.16983752e-04  6.60755228e-05
  8.01435162e-07 -3.36808107e-07 -3.68753415e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:05 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263185075802       1
[INPUT] 0    0    [1    /1   ]  117616.81424         1
[INPUT] 0    0    [1    /1   ]  0.668979525851       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992146        1
[INPUT] 0    0    [1    /1   ]  73510.4209652        1
[INPUT] 0    0    [1    /1   ]  36754.7200121        1
[INPUT] 0    0    [1    /1   ]  7303.47364466        1
[INPUT] 0    0    [1    /1   ]  18375.8101388        1
[INPUT] 0    0    [1    /1   ]  1449.74649527        1
[INPUT] 0    0    [1    /1   ]  374.023212086        1
[INPUT] 0    0    [1    /1   ]  113.277691976        1
[INPUT] 0    0    [1    /1   ]  37.9049311337        1
[INPUT] 0    0    [1    /1   ]  8.40930394627        1
[INPUT] 0    0    [1    /1   ]  3.36908202102        1
[INPUT] 1    0    [1    /1   ]  8.60359903196        1
[INPUT] 1    0    [1    /1   ]  0.492572879848       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2631850758022542, 1.0]], [0, [117616.8142396981, 1.0]], [0, [0.6689795258512407, 1.0]], [0, [1176168.1426188778, 1.0]], [0, [588084.0699925072, 1.0]], [0, [294042.0311315543, 1.0]], [0, [147020.99214649433, 1.0]], [0, [73510.42096521225, 1.0]], [0, [36754.72001209953, 1.0]], [0, [7303.473644661119, 1.0]], [0, [18375.810138847457, 1.0]], [0, [1449.7464952680414, 1.0]], [0, [374.02321208621083, 1.0]], [0, [113.27769197637866, 1.0]], [0, [37.90493113370734, 1.0]], [0, [8.40930394627111, 1.0]], [0, [3.369082021017014, 1.0]], [1, [8.603599031961387, 1.0]], [1, [0.4925728798479951, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26318508]
bas 1, expnt(s) = [117616.8142397]
bas 2, expnt(s) = [0.66897953]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999251]
bas 5, expnt(s) = [294042.03113155]
bas 6, expnt(s) = [147020.99214649]
bas 7, expnt(s) = [73510.42096521]
bas 8, expnt(s) = [36754.7200121]
bas 9, expnt(s) = [7303.47364466]
bas 10, expnt(s) = [18375.81013885]
bas 11, expnt(s) = [1449.74649527]
bas 12, expnt(s) = [374.02321209]
bas 13, expnt(s) = [113.27769198]
bas 14, expnt(s) = [37.90493113]
bas 15, expnt(s) = [8.40930395]
bas 16, expnt(s) = [3.36908202]
bas 17, expnt(s) = [8.60359903]
bas 18, expnt(s) = [0.49257288]
CPU time:       179.62
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63185076e-01 9.28348346e-01 1.17616814e+05 1.60460109e+04
 6.68979526e-01 1.86885086e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347364e+03 1.99600729e+03
 1.83758101e+04 3.98749265e+03 1.44974650e+03 5.93586582e+02
 3.74023212e+02 2.14876510e+02 1.13277692e+02 8.77249881e+01
 3.79049311e+01 3.85955121e+01 8.40930395e+00 1.24762785e+01
 3.36908202e+00 6.28273457e+00 8.60359903e+00 4.29867484e+01
 4.92572880e-01 1.20385038e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.3357640301333
cond(S) = 907755.1675645724
E1 = -689.5614880197454  E_coul = 184.95932311686053
init E= -504.602164902885
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.67250685267335  LUMO = 0.768146121214604
  mo_energy =
[-1.21704941e+02 -1.33852830e+01 -7.62437490e+00 -7.62437490e+00
 -7.62437490e+00 -1.65765019e+00 -6.72506853e-01 -6.72506853e-01
 -6.72506853e-01  7.68146121e-01  1.25676264e+01  1.12941725e+02
  6.07160903e+02  2.74640626e+03  1.22252418e+04  4.08465919e+04
  1.04890157e+05  2.30073553e+05  4.55888459e+05  8.44840693e+05
  1.52801793e+06  2.85028530e+06  5.80817253e+06]
E1 = -707.7269768548372  E_coul = 199.7715643054064
cycle= 1 E= -507.955412549431  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625873
diis-c [-0.39171756  1.        ]
  HOMO = -0.217959148323774  LUMO = 1.17412521382054
  mo_energy =
[-1.20194627e+02 -1.23037432e+01 -6.59475199e+00 -6.59475199e+00
 -6.59475199e+00 -1.16325335e+00 -2.17959148e-01 -2.17959148e-01
 -2.17959148e-01  1.17412521e+00  1.35133961e+01  1.14342197e+02
  6.08657061e+02  2.74784154e+03  1.22265681e+04  4.08478517e+04
  1.04891381e+05  2.30074752e+05  4.55889641e+05  8.44841862e+05
  1.52801909e+06  2.85028644e+06  5.80817367e+06]
E1 = -706.7916151596472  E_coul = 198.81878661347787
cycle= 2 E= -507.972828546169  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.447
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258254
diis-c [-6.64068668e-04  2.70845301e-03  9.97291547e-01]
  HOMO = -0.239674044490723  LUMO = 1.16753684173539
  mo_energy =
[-1.20306791e+02 -1.23696315e+01 -6.66771880e+00 -6.66771880e+00
 -6.66771880e+00 -1.17723648e+00 -2.39674044e-01 -2.39674044e-01
 -2.39674044e-01  1.16753684e+00  1.34623410e+01  1.14248512e+02
  6.08540947e+02  2.74770948e+03  1.22264259e+04  4.08477059e+04
  1.04891233e+05  2.30074604e+05  4.55889492e+05  8.44841713e+05
  1.52801894e+06  2.85028629e+06  5.80817352e+06]
E1 = -706.6873071093345  E_coul = 198.7142306043092
cycle= 3 E= -507.973076505025  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0599
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292781
diis-c [-1.55322301e-06 -1.76798149e-04 -1.14509875e-01  1.11468667e+00]
  HOMO = -0.24280532163726  LUMO = 1.16635974761409
  mo_energy =
[-1.20318886e+02 -1.23783165e+01 -6.67691876e+00 -6.67691876e+00
 -6.67691876e+00 -1.17913227e+00 -2.42805322e-01 -2.42805322e-01
 -2.42805322e-01  1.16635975e+00  1.34553329e+01  1.14237742e+02
  6.08528679e+02  2.74769633e+03  1.22264123e+04  4.08476921e+04
  1.04891219e+05  2.30074590e+05  4.55889478e+05  8.44841699e+05
  1.52801893e+06  2.85028628e+06  5.80817351e+06]
E1 = -706.6723936900588  E_coul = 198.6993126458088
cycle= 4 E= -507.97308104425  delta_E= -4.54e-06  |g|= 0.000158  |ddm|= 0.00915
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108575
diis-c [-6.85964804e-11 -5.31310799e-06  7.34393278e-03 -9.11915994e-02
  1.08385298e+00]
  HOMO = -0.242910065730217  LUMO = 1.16631414826422
  mo_energy =
[-1.20319129e+02 -1.23785717e+01 -6.67716802e+00 -6.67716802e+00
 -6.67716802e+00 -1.17919376e+00 -2.42910066e-01 -2.42910066e-01
 -2.42910066e-01  1.16631415e+00  1.34551162e+01  1.14237496e+02
  6.08528437e+02  2.74769610e+03  1.22264120e+04  4.08476918e+04
  1.04891219e+05  2.30074590e+05  4.55889478e+05  8.44841698e+05
  1.52801893e+06  2.85028628e+06  5.80817351e+06]
E1 = -706.6719013241221  E_coul = 198.69882027443327
cycle= 5 E= -507.973081049689  delta_E= -5.44e-09  |g|= 2.55e-07  |ddm|= 0.000333
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.5737e-07
diis-c [-1.08623664e-14  1.71135211e-07 -8.88564900e-05  9.91800305e-04
 -1.10885563e-02  1.01018544e+00]
  HOMO = -0.242910113654549  LUMO = 1.16631429951097
  mo_energy =
[-1.20319130e+02 -1.23785720e+01 -6.67716833e+00 -6.67716833e+00
 -6.67716833e+00 -1.17919392e+00 -2.42910114e-01 -2.42910114e-01
 -2.42910114e-01  1.16631430e+00  1.34551160e+01  1.14237496e+02
  6.08528436e+02  2.74769609e+03  1.22264120e+04  4.08476918e+04
  1.04891219e+05  2.30074590e+05  4.55889478e+05  8.44841698e+05
  1.52801893e+06  2.85028628e+06  5.80817351e+06]
E1 = -706.6719009136808  E_coul = 198.69881986399184
cycle= 6 E= -507.973081049689  delta_E= -1.14e-13  |g|= 1.28e-08  |ddm|= 1.69e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6719009136808  E_coul = 198.69881986399184
  HOMO = -0.242910106799273  LUMO = 1.16631430083763
  mo_energy =
[-1.20319129e+02 -1.23785719e+01 -6.67716832e+00 -6.67716832e+00
 -6.67716832e+00 -1.17919391e+00 -2.42910107e-01 -2.42910107e-01
 -2.42910107e-01  1.16631430e+00  1.34551160e+01  1.14237496e+02
  6.08528436e+02  2.74769609e+03  1.22264120e+04  4.08476918e+04
  1.04891219e+05  2.30074590e+05  4.55889478e+05  8.44841698e+05
  1.52801893e+06  2.85028628e+06  5.80817351e+06]
E1 = -706.6719009487773  E_coul = 198.69881989908873
Extra cycle  E= -507.973081049689  delta_E= 3.98e-13  |g|= 2.05e-09  |ddm|= 2.33e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
exp = [2.63185076e-01 1.17616814e+05 6.68979526e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347364e+03 1.83758101e+04 1.44974650e+03
 3.74023212e+02 1.13277692e+02 3.79049311e+01 8.40930395e+00
 3.36908202e+00 8.60359903e+00 4.92572880e-01]
E = -507.9730810496886
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:05 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263185075802       1
[INPUT] 0    0    [1    /1   ]  117616.81424         1
[INPUT] 0    0    [1    /1   ]  0.668979525851       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992146        1
[INPUT] 0    0    [1    /1   ]  73510.4209652        1
[INPUT] 0    0    [1    /1   ]  36754.7200121        1
[INPUT] 0    0    [1    /1   ]  7303.47364466        1
[INPUT] 0    0    [1    /1   ]  18375.8101388        1
[INPUT] 0    0    [1    /1   ]  1449.74649527        1
[INPUT] 0    0    [1    /1   ]  374.023212086        1
[INPUT] 0    0    [1    /1   ]  113.277691976        1
[INPUT] 0    0    [1    /1   ]  37.9049311337        1
[INPUT] 0    0    [1    /1   ]  8.40930394627        1
[INPUT] 0    0    [1    /1   ]  3.36908202102        1
[INPUT] 1    0    [1    /1   ]  8.60359903196        1
[INPUT] 1    0    [1    /1   ]  0.492572879848       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2631850758022542, 1.0]], [0, [117616.8142396981, 1.0]], [0, [0.6689795258512407, 1.0]], [0, [1176168.1426188778, 1.0]], [0, [588084.0699925072, 1.0]], [0, [294042.0311315543, 1.0]], [0, [147020.99214649433, 1.0]], [0, [73510.42096521225, 1.0]], [0, [36754.72001209953, 1.0]], [0, [7303.473644661119, 1.0]], [0, [18375.810138847457, 1.0]], [0, [1449.7464952680414, 1.0]], [0, [374.02321208621083, 1.0]], [0, [113.27769197637866, 1.0]], [0, [37.90493113370734, 1.0]], [0, [8.40930394627111, 1.0]], [0, [3.369082021017014, 1.0]], [1, [8.603599031961387, 1.0]], [1, [0.4925728798479951, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26318508]
bas 1, expnt(s) = [117616.8142397]
bas 2, expnt(s) = [0.66897953]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999251]
bas 5, expnt(s) = [294042.03113155]
bas 6, expnt(s) = [147020.99214649]
bas 7, expnt(s) = [73510.42096521]
bas 8, expnt(s) = [36754.7200121]
bas 9, expnt(s) = [7303.47364466]
bas 10, expnt(s) = [18375.81013885]
bas 11, expnt(s) = [1449.74649527]
bas 12, expnt(s) = [374.02321209]
bas 13, expnt(s) = [113.27769198]
bas 14, expnt(s) = [37.90493113]
bas 15, expnt(s) = [8.40930395]
bas 16, expnt(s) = [3.36908202]
bas 17, expnt(s) = [8.60359903]
bas 18, expnt(s) = [0.49257288]
CPU time:       180.19
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63185076e-01 9.28348346e-01 1.17616814e+05 1.60460109e+04
 6.68979526e-01 1.86885086e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347364e+03 1.99600729e+03
 1.83758101e+04 3.98749265e+03 1.44974650e+03 5.93586582e+02
 3.74023212e+02 2.14876510e+02 1.13277692e+02 8.77249881e+01
 3.79049311e+01 3.85955121e+01 8.40930395e+00 1.24762785e+01
 3.36908202e+00 6.28273457e+00 8.60359903e+00 4.29867484e+01
 4.92572880e-01 1.20385038e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.3357640301333
cond(S) = 907755.1675645724
E1 = -689.5614880197454  E_coul = 184.95932311686053
init E= -504.602164902885
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.67250685267335  LUMO = 0.768146121214604
  mo_energy =
[-1.21704941e+02 -1.33852830e+01 -7.62437490e+00 -7.62437490e+00
 -7.62437490e+00 -1.65765019e+00 -6.72506853e-01 -6.72506853e-01
 -6.72506853e-01  7.68146121e-01  1.25676264e+01  1.12941725e+02
  6.07160903e+02  2.74640626e+03  1.22252418e+04  4.08465919e+04
  1.04890157e+05  2.30073553e+05  4.55888459e+05  8.44840693e+05
  1.52801793e+06  2.85028530e+06  5.80817253e+06]
E1 = -707.7269768548372  E_coul = 199.7715643054064
cycle= 1 E= -507.955412549431  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625873
diis-c [-0.39171756  1.        ]
  HOMO = -0.217959148323774  LUMO = 1.17412521382054
  mo_energy =
[-1.20194627e+02 -1.23037432e+01 -6.59475199e+00 -6.59475199e+00
 -6.59475199e+00 -1.16325335e+00 -2.17959148e-01 -2.17959148e-01
 -2.17959148e-01  1.17412521e+00  1.35133961e+01  1.14342197e+02
  6.08657061e+02  2.74784154e+03  1.22265681e+04  4.08478517e+04
  1.04891381e+05  2.30074752e+05  4.55889641e+05  8.44841862e+05
  1.52801909e+06  2.85028644e+06  5.80817367e+06]
E1 = -706.7916151596472  E_coul = 198.81878661347787
cycle= 2 E= -507.972828546169  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258254
diis-c [-6.64068668e-04  2.70845301e-03  9.97291547e-01]
  HOMO = -0.239674044490723  LUMO = 1.16753684173539
  mo_energy =
[-1.20306791e+02 -1.23696315e+01 -6.66771880e+00 -6.66771880e+00
 -6.66771880e+00 -1.17723648e+00 -2.39674044e-01 -2.39674044e-01
 -2.39674044e-01  1.16753684e+00  1.34623410e+01  1.14248512e+02
  6.08540947e+02  2.74770948e+03  1.22264259e+04  4.08477059e+04
  1.04891233e+05  2.30074604e+05  4.55889492e+05  8.44841713e+05
  1.52801894e+06  2.85028629e+06  5.80817352e+06]
E1 = -706.6873071093345  E_coul = 198.7142306043092
cycle= 3 E= -507.973076505025  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0599
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292781
diis-c [-1.55322301e-06 -1.76798149e-04 -1.14509875e-01  1.11468667e+00]
  HOMO = -0.24280532163726  LUMO = 1.16635974761409
  mo_energy =
[-1.20318886e+02 -1.23783165e+01 -6.67691876e+00 -6.67691876e+00
 -6.67691876e+00 -1.17913227e+00 -2.42805322e-01 -2.42805322e-01
 -2.42805322e-01  1.16635975e+00  1.34553329e+01  1.14237742e+02
  6.08528679e+02  2.74769633e+03  1.22264123e+04  4.08476921e+04
  1.04891219e+05  2.30074590e+05  4.55889478e+05  8.44841699e+05
  1.52801893e+06  2.85028628e+06  5.80817351e+06]
E1 = -706.6723936900588  E_coul = 198.6993126458088
cycle= 4 E= -507.97308104425  delta_E= -4.54e-06  |g|= 0.000158  |ddm|= 0.00915
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108575
diis-c [-6.85964804e-11 -5.31310799e-06  7.34393278e-03 -9.11915994e-02
  1.08385298e+00]
  HOMO = -0.242910065730217  LUMO = 1.16631414826422
  mo_energy =
[-1.20319129e+02 -1.23785717e+01 -6.67716802e+00 -6.67716802e+00
 -6.67716802e+00 -1.17919376e+00 -2.42910066e-01 -2.42910066e-01
 -2.42910066e-01  1.16631415e+00  1.34551162e+01  1.14237496e+02
  6.08528437e+02  2.74769610e+03  1.22264120e+04  4.08476918e+04
  1.04891219e+05  2.30074590e+05  4.55889478e+05  8.44841698e+05
  1.52801893e+06  2.85028628e+06  5.80817351e+06]
E1 = -706.6719013241221  E_coul = 198.69882027443327
cycle= 5 E= -507.973081049689  delta_E= -5.44e-09  |g|= 2.55e-07  |ddm|= 0.000333
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.5737e-07
diis-c [-1.08623664e-14  1.71135211e-07 -8.88564900e-05  9.91800305e-04
 -1.10885563e-02  1.01018544e+00]
  HOMO = -0.242910113654549  LUMO = 1.16631429951097
  mo_energy =
[-1.20319130e+02 -1.23785720e+01 -6.67716833e+00 -6.67716833e+00
 -6.67716833e+00 -1.17919392e+00 -2.42910114e-01 -2.42910114e-01
 -2.42910114e-01  1.16631430e+00  1.34551160e+01  1.14237496e+02
  6.08528436e+02  2.74769609e+03  1.22264120e+04  4.08476918e+04
  1.04891219e+05  2.30074590e+05  4.55889478e+05  8.44841698e+05
  1.52801893e+06  2.85028628e+06  5.80817351e+06]
E1 = -706.6719009136808  E_coul = 198.69881986399184
cycle= 6 E= -507.973081049689  delta_E= -1.14e-13  |g|= 1.28e-08  |ddm|= 1.69e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6719009136808  E_coul = 198.69881986399184
  HOMO = -0.242910106799273  LUMO = 1.16631430083763
  mo_energy =
[-1.20319129e+02 -1.23785719e+01 -6.67716832e+00 -6.67716832e+00
 -6.67716832e+00 -1.17919391e+00 -2.42910107e-01 -2.42910107e-01
 -2.42910107e-01  1.16631430e+00  1.34551160e+01  1.14237496e+02
  6.08528436e+02  2.74769609e+03  1.22264120e+04  4.08476918e+04
  1.04891219e+05  2.30074590e+05  4.55889478e+05  8.44841698e+05
  1.52801893e+06  2.85028628e+06  5.80817351e+06]
E1 = -706.6719009487773  E_coul = 198.69881989908873
Extra cycle  E= -507.973081049689  delta_E= 3.98e-13  |g|= 2.05e-09  |ddm|= 2.33e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907755.1675645724
E1 = -706.6719009487773  E_coul = 198.69881989908873
init E= -507.973081049689
    CPU time for initialize scf      1.46 sec, wall time      0.09 sec
  HOMO = -0.242910105818208  LUMO = 1.16631429957034
  mo_energy =
[-1.20319129e+02 -1.23785719e+01 -6.67716831e+00 -6.67716831e+00
 -6.67716831e+00 -1.17919391e+00 -2.42910106e-01 -2.42910106e-01
 -2.42910106e-01  1.16631430e+00  1.34551160e+01  1.14237496e+02
  6.08528436e+02  2.74769609e+03  1.22264120e+04  4.08476918e+04
  1.04891219e+05  2.30074590e+05  4.55889478e+05  8.44841698e+05
  1.52801893e+06  2.85028628e+06  5.80817351e+06]
E1 = -706.6719009534478  E_coul = 198.69881990375885
cycle= 1 E= -507.973081049689  delta_E= -3.98e-13  |g|= 1.76e-09  |ddm|= 3.15e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6719009534478  E_coul = 198.69881990375885
  HOMO = -0.242910105676009  LUMO = 1.1663142999547
  mo_energy =
[-1.20319129e+02 -1.23785719e+01 -6.67716831e+00 -6.67716831e+00
 -6.67716831e+00 -1.17919391e+00 -2.42910106e-01 -2.42910106e-01
 -2.42910106e-01  1.16631430e+00  1.34551160e+01  1.14237496e+02
  6.08528436e+02  2.74769609e+03  1.22264120e+04  4.08476918e+04
  1.04891219e+05  2.30074590e+05  4.55889478e+05  8.44841698e+05
  1.52801893e+06  2.85028628e+06  5.80817351e+06]
E1 = -706.6719009552502  E_coul = 198.6988199055614
Extra cycle  E= -507.973081049689  delta_E= 2.27e-13  |g|= 1.75e-09  |ddm|= 1.17e-09
    CPU time for scf_cycle      1.63 sec, wall time      0.16 sec
exp = [2.63185076e-01 1.17616814e+05 6.68979526e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347364e+03 1.83758101e+04 1.44974650e+03
 3.74023212e+02 1.13277692e+02 3.79049311e+01 8.40930395e+00
 3.36908202e+00 8.60359903e+00 4.92572880e-01]
grad_E = [ 5.30649685e-05  4.20124471e-09 -3.54785422e-05  1.89854274e-11
  1.13383997e-10  6.53639702e-10  2.56353563e-09  1.06508303e-08
  5.72758487e-08  3.60550028e-06  1.23356757e-07  4.05021570e-06
  1.06074633e-05 -1.02093617e-04 -1.03739358e-04  7.24605265e-05
 -2.40973475e-05 -1.21545439e-06 -8.52401175e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263150704298       1
[INPUT] 0    0    [1    /1   ]  117616.81424         1
[INPUT] 0    0    [1    /1   ]  0.668837178599       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992146        1
[INPUT] 0    0    [1    /1   ]  73510.4209652        1
[INPUT] 0    0    [1    /1   ]  36754.7200118        1
[INPUT] 0    0    [1    /1   ]  7303.47362649        1
[INPUT] 0    0    [1    /1   ]  18375.8101382        1
[INPUT] 0    0    [1    /1   ]  1449.74645921        1
[INPUT] 0    0    [1    /1   ]  374.023377902        1
[INPUT] 0    0    [1    /1   ]  113.27682            1
[INPUT] 0    0    [1    /1   ]  37.9086634752        1
[INPUT] 0    0    [1    /1   ]  8.40987736392        1
[INPUT] 0    0    [1    /1   ]  3.3691050388         1
[INPUT] 1    0    [1    /1   ]  8.60359329903        1
[INPUT] 1    0    [1    /1   ]  0.492570836168       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2631507042978416, 1.0]], [0, [117616.8142396769, 1.0]], [0, [0.668837178599066, 1.0]], [0, [1176168.1426188778, 1.0]], [0, [588084.0699925066, 1.0]], [0, [294042.03113155096, 1.0]], [0, [147020.9921464814, 1.0]], [0, [73510.42096515854, 1.0]], [0, [36754.720011810336, 1.0]], [0, [7303.473626488146, 1.0]], [0, [18375.810138227924, 1.0]], [0, [1449.746459205127, 1.0]], [0, [374.02337790234566, 1.0]], [0, [113.27681999974348, 1.0]], [0, [37.90866347515239, 1.0]], [0, [8.409877363920714, 1.0]], [0, [3.3691050388020285, 1.0]], [1, [8.603593299025095, 1.0]], [1, [0.492570836167709, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2631507]
bas 1, expnt(s) = [117616.81423968]
bas 2, expnt(s) = [0.66883718]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999251]
bas 5, expnt(s) = [294042.03113155]
bas 6, expnt(s) = [147020.99214648]
bas 7, expnt(s) = [73510.42096516]
bas 8, expnt(s) = [36754.72001181]
bas 9, expnt(s) = [7303.47362649]
bas 10, expnt(s) = [18375.81013823]
bas 11, expnt(s) = [1449.74645921]
bas 12, expnt(s) = [374.0233779]
bas 13, expnt(s) = [113.27682]
bas 14, expnt(s) = [37.90866348]
bas 15, expnt(s) = [8.40987736]
bas 16, expnt(s) = [3.36910504]
bas 17, expnt(s) = [8.6035933]
bas 18, expnt(s) = [0.49257084]
CPU time:       184.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63150704e-01 9.28257414e-01 1.17616814e+05 1.60460109e+04
 6.68837179e-01 1.86855260e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347363e+03 1.99600729e+03
 1.83758101e+04 3.98749265e+03 1.44974646e+03 5.93586571e+02
 3.74023378e+02 2.14876581e+02 1.13276820e+02 8.77244817e+01
 3.79086635e+01 3.85983624e+01 8.40987736e+00 1.24769166e+01
 3.36910504e+00 6.28276676e+00 8.60359330e+00 4.29867126e+01
 4.92570836e-01 1.20384413e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335767052392306
cond(S) = 907755.2893749401
E1 = -689.5613126688748  E_coul = 184.95922150946484
init E= -504.60209115941
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672509797388261  LUMO = 0.76787393440605
  mo_energy =
[-1.21704951e+02 -1.33852924e+01 -7.62438132e+00 -7.62438132e+00
 -7.62438132e+00 -1.65765264e+00 -6.72509797e-01 -6.72509797e-01
 -6.72509797e-01  7.67873934e-01  1.25676008e+01  1.12950107e+02
  6.07174209e+02  2.74641875e+03  1.22252528e+04  4.08466021e+04
  1.04890167e+05  2.30073563e+05  4.55888468e+05  8.44840702e+05
  1.52801794e+06  2.85028530e+06  5.80817254e+06]
E1 = -707.7268177389557  E_coul = 199.77140416374368
cycle= 1 E= -507.955413575212  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625878
diis-c [-0.39172324  1.        ]
  HOMO = -0.217963562743535  LUMO = 1.17380632276874
  mo_energy =
[-1.20194637e+02 -1.23037584e+01 -6.59476477e+00 -6.59476477e+00
 -6.59476477e+00 -1.16325718e+00 -2.17963563e-01 -2.17963563e-01
 -2.17963563e-01  1.17380632e+00  1.35133914e+01  1.14350586e+02
  6.08670373e+02  2.74785404e+03  1.22265791e+04  4.08478619e+04
  1.04891390e+05  2.30074762e+05  4.55889650e+05  8.44841871e+05
  1.52801910e+06  2.85028645e+06  5.80817368e+06]
E1 = -706.7914876477746  E_coul = 198.81865892709058
cycle= 2 E= -507.972828720684  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258254
diis-c [-6.64066527e-04  2.70877066e-03  9.97291229e-01]
  HOMO = -0.239677991955366  LUMO = 1.16722007160048
  mo_energy =
[-1.20306797e+02 -1.23696439e+01 -6.66772873e+00 -6.66772873e+00
 -6.66772873e+00 -1.17724012e+00 -2.39677992e-01 -2.39677992e-01
 -2.39677992e-01  1.16722007e+00  1.34623377e+01  1.14256903e+02
  6.08554262e+02  2.74772199e+03  1.22264370e+04  4.08477161e+04
  1.04891243e+05  2.30074614e+05  4.55889501e+05  8.44841722e+05
  1.52801895e+06  2.85028630e+06  5.80817353e+06]
E1 = -706.687175205497  E_coul = 198.7140984985376
cycle= 3 E= -507.973076706959  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0599
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292799
diis-c [-1.55339090e-06 -1.76907032e-04 -1.14517725e-01  1.11469463e+00]
  HOMO = -0.242809537853206  LUMO = 1.16604316651602
  mo_energy =
[-1.20318893e+02 -1.23783294e+01 -6.67692909e+00 -6.67692909e+00
 -6.67692909e+00 -1.17913609e+00 -2.42809538e-01 -2.42809538e-01
 -2.42809538e-01  1.16604317e+00  1.34553291e+01  1.14246132e+02
  6.08541993e+02  2.74770883e+03  1.22264233e+04  4.08477022e+04
  1.04891229e+05  2.30074600e+05  4.55889487e+05  8.44841708e+05
  1.52801894e+06  2.85028629e+06  5.80817352e+06]
E1 = -706.6722595978288  E_coul = 198.69917835022758
cycle= 4 E= -507.973081247601  delta_E= -4.54e-06  |g|= 0.000158  |ddm|= 0.00916
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108594
diis-c [-6.86022745e-11 -5.31243070e-06  7.34476809e-03 -9.12004413e-02
  1.08386099e+00]
  HOMO = -0.242914314447477  LUMO = 1.16599756426537
  mo_energy =
[-1.20319135e+02 -1.23785846e+01 -6.67717842e+00 -6.67717842e+00
 -6.67717842e+00 -1.17919760e+00 -2.42914314e-01 -2.42914314e-01
 -2.42914314e-01  1.16599756e+00  1.34551123e+01  1.14245887e+02
  6.08541751e+02  2.74770860e+03  1.22264231e+04  4.08477020e+04
  1.04891229e+05  2.30074599e+05  4.55889487e+05  8.44841708e+05
  1.52801894e+06  2.85028629e+06  5.80817352e+06]
E1 = -706.6717670477769  E_coul = 198.69868579473314
cycle= 5 E= -507.973081253044  delta_E= -5.44e-09  |g|= 2.56e-07  |ddm|= 0.000333
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.59589e-07
diis-c [-1.08777776e-14  1.74550625e-07 -8.93987343e-05  9.97525335e-04
 -1.11424564e-02  1.01023416e+00]
  HOMO = -0.242914362386436  LUMO = 1.16599771497559
  mo_energy =
[-1.20319136e+02 -1.23785849e+01 -6.67717874e+00 -6.67717874e+00
 -6.67717874e+00 -1.17919776e+00 -2.42914362e-01 -2.42914362e-01
 -2.42914362e-01  1.16599771e+00  1.34551122e+01  1.14245886e+02
  6.08541750e+02  2.74770859e+03  1.22264231e+04  4.08477020e+04
  1.04891229e+05  2.30074599e+05  4.55889487e+05  8.44841708e+05
  1.52801894e+06  2.85028629e+06  5.80817352e+06]
E1 = -706.671766635366  E_coul = 198.69868538232262
cycle= 6 E= -507.973081253043  delta_E= 4.55e-13  |g|= 1.24e-08  |ddm|= 1.7e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.671766635366  E_coul = 198.69868538232262
  HOMO = -0.242914355582886  LUMO = 1.16599771645543
  mo_energy =
[-1.20319136e+02 -1.23785849e+01 -6.67717872e+00 -6.67717872e+00
 -6.67717872e+00 -1.17919775e+00 -2.42914356e-01 -2.42914356e-01
 -2.42914356e-01  1.16599772e+00  1.34551122e+01  1.14245886e+02
  6.08541750e+02  2.74770859e+03  1.22264231e+04  4.08477020e+04
  1.04891229e+05  2.30074599e+05  4.55889487e+05  8.44841708e+05
  1.52801894e+06  2.85028629e+06  5.80817352e+06]
E1 = -706.6717666704241  E_coul = 198.6986854173805
Extra cycle  E= -507.973081253044  delta_E= -2.27e-13  |g|= 2.06e-09  |ddm|= 2.32e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.63150704e-01 1.17616814e+05 6.68837179e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347363e+03 1.83758101e+04 1.44974646e+03
 3.74023378e+02 1.13276820e+02 3.79086635e+01 8.40987736e+00
 3.36910504e+00 8.60359330e+00 4.92570836e-01]
E = -507.9730812530436
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:09 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263150704298       1
[INPUT] 0    0    [1    /1   ]  117616.81424         1
[INPUT] 0    0    [1    /1   ]  0.668837178599       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992146        1
[INPUT] 0    0    [1    /1   ]  73510.4209652        1
[INPUT] 0    0    [1    /1   ]  36754.7200118        1
[INPUT] 0    0    [1    /1   ]  7303.47362649        1
[INPUT] 0    0    [1    /1   ]  18375.8101382        1
[INPUT] 0    0    [1    /1   ]  1449.74645921        1
[INPUT] 0    0    [1    /1   ]  374.023377902        1
[INPUT] 0    0    [1    /1   ]  113.27682            1
[INPUT] 0    0    [1    /1   ]  37.9086634752        1
[INPUT] 0    0    [1    /1   ]  8.40987736392        1
[INPUT] 0    0    [1    /1   ]  3.3691050388         1
[INPUT] 1    0    [1    /1   ]  8.60359329903        1
[INPUT] 1    0    [1    /1   ]  0.492570836168       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2631507042978416, 1.0]], [0, [117616.8142396769, 1.0]], [0, [0.668837178599066, 1.0]], [0, [1176168.1426188778, 1.0]], [0, [588084.0699925066, 1.0]], [0, [294042.03113155096, 1.0]], [0, [147020.9921464814, 1.0]], [0, [73510.42096515854, 1.0]], [0, [36754.720011810336, 1.0]], [0, [7303.473626488146, 1.0]], [0, [18375.810138227924, 1.0]], [0, [1449.746459205127, 1.0]], [0, [374.02337790234566, 1.0]], [0, [113.27681999974348, 1.0]], [0, [37.90866347515239, 1.0]], [0, [8.409877363920714, 1.0]], [0, [3.3691050388020285, 1.0]], [1, [8.603593299025095, 1.0]], [1, [0.492570836167709, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2631507]
bas 1, expnt(s) = [117616.81423968]
bas 2, expnt(s) = [0.66883718]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999251]
bas 5, expnt(s) = [294042.03113155]
bas 6, expnt(s) = [147020.99214648]
bas 7, expnt(s) = [73510.42096516]
bas 8, expnt(s) = [36754.72001181]
bas 9, expnt(s) = [7303.47362649]
bas 10, expnt(s) = [18375.81013823]
bas 11, expnt(s) = [1449.74645921]
bas 12, expnt(s) = [374.0233779]
bas 13, expnt(s) = [113.27682]
bas 14, expnt(s) = [37.90866348]
bas 15, expnt(s) = [8.40987736]
bas 16, expnt(s) = [3.36910504]
bas 17, expnt(s) = [8.6035933]
bas 18, expnt(s) = [0.49257084]
CPU time:       185.56
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63150704e-01 9.28257414e-01 1.17616814e+05 1.60460109e+04
 6.68837179e-01 1.86855260e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347363e+03 1.99600729e+03
 1.83758101e+04 3.98749265e+03 1.44974646e+03 5.93586571e+02
 3.74023378e+02 2.14876581e+02 1.13276820e+02 8.77244817e+01
 3.79086635e+01 3.85983624e+01 8.40987736e+00 1.24769166e+01
 3.36910504e+00 6.28276676e+00 8.60359330e+00 4.29867126e+01
 4.92570836e-01 1.20384413e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335767052392306
cond(S) = 907755.2893749401
E1 = -689.5613126688748  E_coul = 184.95922150946484
init E= -504.60209115941
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.672509797388261  LUMO = 0.76787393440605
  mo_energy =
[-1.21704951e+02 -1.33852924e+01 -7.62438132e+00 -7.62438132e+00
 -7.62438132e+00 -1.65765264e+00 -6.72509797e-01 -6.72509797e-01
 -6.72509797e-01  7.67873934e-01  1.25676008e+01  1.12950107e+02
  6.07174209e+02  2.74641875e+03  1.22252528e+04  4.08466021e+04
  1.04890167e+05  2.30073563e+05  4.55888468e+05  8.44840702e+05
  1.52801794e+06  2.85028530e+06  5.80817254e+06]
E1 = -707.7268177389557  E_coul = 199.77140416374368
cycle= 1 E= -507.955413575212  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.18 sec, wall time      0.01 sec
diis-norm(errvec)=0.625878
diis-c [-0.39172324  1.        ]
  HOMO = -0.217963562743535  LUMO = 1.17380632276874
  mo_energy =
[-1.20194637e+02 -1.23037584e+01 -6.59476477e+00 -6.59476477e+00
 -6.59476477e+00 -1.16325718e+00 -2.17963563e-01 -2.17963563e-01
 -2.17963563e-01  1.17380632e+00  1.35133914e+01  1.14350586e+02
  6.08670373e+02  2.74785404e+03  1.22265791e+04  4.08478619e+04
  1.04891390e+05  2.30074762e+05  4.55889650e+05  8.44841871e+05
  1.52801910e+06  2.85028645e+06  5.80817368e+06]
E1 = -706.7914876477746  E_coul = 198.81865892709058
cycle= 2 E= -507.972828720684  delta_E= -0.0174  |g|= 0.0345  |ddm|= 0.447
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258254
diis-c [-6.64066527e-04  2.70877066e-03  9.97291229e-01]
  HOMO = -0.239677991955366  LUMO = 1.16722007160048
  mo_energy =
[-1.20306797e+02 -1.23696439e+01 -6.66772873e+00 -6.66772873e+00
 -6.66772873e+00 -1.17724012e+00 -2.39677992e-01 -2.39677992e-01
 -2.39677992e-01  1.16722007e+00  1.34623377e+01  1.14256903e+02
  6.08554262e+02  2.74772199e+03  1.22264370e+04  4.08477161e+04
  1.04891243e+05  2.30074614e+05  4.55889501e+05  8.44841722e+05
  1.52801895e+06  2.85028630e+06  5.80817353e+06]
E1 = -706.687175205497  E_coul = 198.7140984985376
cycle= 3 E= -507.973076706959  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0599
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292799
diis-c [-1.55339090e-06 -1.76907032e-04 -1.14517725e-01  1.11469463e+00]
  HOMO = -0.242809537853206  LUMO = 1.16604316651602
  mo_energy =
[-1.20318893e+02 -1.23783294e+01 -6.67692909e+00 -6.67692909e+00
 -6.67692909e+00 -1.17913609e+00 -2.42809538e-01 -2.42809538e-01
 -2.42809538e-01  1.16604317e+00  1.34553291e+01  1.14246132e+02
  6.08541993e+02  2.74770883e+03  1.22264233e+04  4.08477022e+04
  1.04891229e+05  2.30074600e+05  4.55889487e+05  8.44841708e+05
  1.52801894e+06  2.85028629e+06  5.80817352e+06]
E1 = -706.6722595978288  E_coul = 198.69917835022758
cycle= 4 E= -507.973081247601  delta_E= -4.54e-06  |g|= 0.000158  |ddm|= 0.00916
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108594
diis-c [-6.86022745e-11 -5.31243070e-06  7.34476809e-03 -9.12004413e-02
  1.08386099e+00]
  HOMO = -0.242914314447477  LUMO = 1.16599756426537
  mo_energy =
[-1.20319135e+02 -1.23785846e+01 -6.67717842e+00 -6.67717842e+00
 -6.67717842e+00 -1.17919760e+00 -2.42914314e-01 -2.42914314e-01
 -2.42914314e-01  1.16599756e+00  1.34551123e+01  1.14245887e+02
  6.08541751e+02  2.74770860e+03  1.22264231e+04  4.08477020e+04
  1.04891229e+05  2.30074599e+05  4.55889487e+05  8.44841708e+05
  1.52801894e+06  2.85028629e+06  5.80817352e+06]
E1 = -706.6717670477769  E_coul = 198.69868579473314
cycle= 5 E= -507.973081253044  delta_E= -5.44e-09  |g|= 2.56e-07  |ddm|= 0.000333
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.59589e-07
diis-c [-1.08777776e-14  1.74550625e-07 -8.93987343e-05  9.97525335e-04
 -1.11424564e-02  1.01023416e+00]
  HOMO = -0.242914362386436  LUMO = 1.16599771497559
  mo_energy =
[-1.20319136e+02 -1.23785849e+01 -6.67717874e+00 -6.67717874e+00
 -6.67717874e+00 -1.17919776e+00 -2.42914362e-01 -2.42914362e-01
 -2.42914362e-01  1.16599771e+00  1.34551122e+01  1.14245886e+02
  6.08541750e+02  2.74770859e+03  1.22264231e+04  4.08477020e+04
  1.04891229e+05  2.30074599e+05  4.55889487e+05  8.44841708e+05
  1.52801894e+06  2.85028629e+06  5.80817352e+06]
E1 = -706.671766635366  E_coul = 198.69868538232262
cycle= 6 E= -507.973081253043  delta_E= 4.55e-13  |g|= 1.24e-08  |ddm|= 1.7e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.671766635366  E_coul = 198.69868538232262
  HOMO = -0.242914355582886  LUMO = 1.16599771645543
  mo_energy =
[-1.20319136e+02 -1.23785849e+01 -6.67717872e+00 -6.67717872e+00
 -6.67717872e+00 -1.17919775e+00 -2.42914356e-01 -2.42914356e-01
 -2.42914356e-01  1.16599772e+00  1.34551122e+01  1.14245886e+02
  6.08541750e+02  2.74770859e+03  1.22264231e+04  4.08477020e+04
  1.04891229e+05  2.30074599e+05  4.55889487e+05  8.44841708e+05
  1.52801894e+06  2.85028629e+06  5.80817352e+06]
E1 = -706.6717666704241  E_coul = 198.6986854173805
Extra cycle  E= -507.973081253044  delta_E= -2.27e-13  |g|= 2.06e-09  |ddm|= 2.32e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907755.2893749401
E1 = -706.6717666704241  E_coul = 198.6986854173805
init E= -507.973081253044
    CPU time for initialize scf      1.40 sec, wall time      0.09 sec
  HOMO = -0.242914354604269  LUMO = 1.1659977184291
  mo_energy =
[-1.20319136e+02 -1.23785849e+01 -6.67717872e+00 -6.67717872e+00
 -6.67717872e+00 -1.17919775e+00 -2.42914355e-01 -2.42914355e-01
 -2.42914355e-01  1.16599772e+00  1.34551122e+01  1.14245886e+02
  6.08541750e+02  2.74770859e+03  1.22264231e+04  4.08477020e+04
  1.04891229e+05  2.30074599e+05  4.55889487e+05  8.44841708e+05
  1.52801894e+06  2.85028629e+06  5.80817352e+06]
E1 = -706.6717666731221  E_coul = 198.698685420078
cycle= 1 E= -507.973081253044  delta_E= -5.12e-13  |g|= 1.25e-09  |ddm|= 1.78e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6717666731221  E_coul = 198.698685420078
  HOMO = -0.242914354528757  LUMO = 1.16599771706514
  mo_energy =
[-1.20319136e+02 -1.23785849e+01 -6.67717872e+00 -6.67717872e+00
 -6.67717872e+00 -1.17919775e+00 -2.42914355e-01 -2.42914355e-01
 -2.42914355e-01  1.16599772e+00  1.34551122e+01  1.14245886e+02
  6.08541750e+02  2.74770859e+03  1.22264231e+04  4.08477020e+04
  1.04891229e+05  2.30074599e+05  4.55889487e+05  8.44841708e+05
  1.52801894e+06  2.85028629e+06  5.80817352e+06]
E1 = -706.6717666764754  E_coul = 198.69868542343158
Extra cycle  E= -507.973081253044  delta_E= 2.84e-13  |g|= 2.29e-09  |ddm|= 2.1e-09
    CPU time for scf_cycle      1.57 sec, wall time      0.16 sec
exp = [2.63150704e-01 1.17616814e+05 6.68837179e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347363e+03 1.83758101e+04 1.44974646e+03
 3.74023378e+02 1.13276820e+02 3.79086635e+01 8.40987736e+00
 3.36910504e+00 8.60359330e+00 4.92570836e-01]
grad_E = [ 9.40050213e-05  4.20281830e-09 -5.95222581e-05  1.90040962e-11
  1.13435070e-10  6.53883277e-10  2.56450809e-09  1.06549294e-08
  5.72960663e-08  3.60694597e-06  1.23418182e-07  3.96656705e-06
  1.18555110e-05 -1.10681647e-04 -8.14462646e-05  8.21600076e-05
 -6.42978916e-05 -2.60268170e-06 -1.61451122e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263102308066       1
[INPUT] 0    0    [1    /1   ]  117616.81424         1
[INPUT] 0    0    [1    /1   ]  0.668629809252       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992146        1
[INPUT] 0    0    [1    /1   ]  73510.4209648        1
[INPUT] 0    0    [1    /1   ]  36754.7200101        1
[INPUT] 0    0    [1    /1   ]  7303.47352064        1
[INPUT] 0    0    [1    /1   ]  18375.8101346        1
[INPUT] 0    0    [1    /1   ]  1449.74632204        1
[INPUT] 0    0    [1    /1   ]  374.023326059        1
[INPUT] 0    0    [1    /1   ]  113.278110147        1
[INPUT] 0    0    [1    /1   ]  37.9156805025        1
[INPUT] 0    0    [1    /1   ]  8.4107422072         1
[INPUT] 0    0    [1    /1   ]  3.36916595377        1
[INPUT] 1    0    [1    /1   ]  8.60358419057        1
[INPUT] 1    0    [1    /1   ]  0.492567651304       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26310230806613627, 1.0]], [0, [117616.81423955354, 1.0]], [0, [0.6686298092523192, 1.0]], [0, [1176168.1426188773, 1.0]], [0, [588084.0699925033, 1.0]], [0, [294042.03113153175, 1.0]], [0, [147020.99214640615, 1.0]], [0, [73510.42096484583, 1.0]], [0, [36754.72001012832, 1.0]], [0, [7303.4735206437435, 1.0]], [0, [18375.81013460913, 1.0]], [0, [1449.7463220381549, 1.0]], [0, [374.0233260589298, 1.0]], [0, [113.2781101471678, 1.0]], [0, [37.91568050252745, 1.0]], [0, [8.410742207195868, 1.0]], [0, [3.369165953769063, 1.0]], [1, [8.60358419056613, 1.0]], [1, [0.492567651303918, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26310231]
bas 1, expnt(s) = [117616.81423955]
bas 2, expnt(s) = [0.66862981]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.0699925]
bas 5, expnt(s) = [294042.03113153]
bas 6, expnt(s) = [147020.99214641]
bas 7, expnt(s) = [73510.42096485]
bas 8, expnt(s) = [36754.72001013]
bas 9, expnt(s) = [7303.47352064]
bas 10, expnt(s) = [18375.81013461]
bas 11, expnt(s) = [1449.74632204]
bas 12, expnt(s) = [374.02332606]
bas 13, expnt(s) = [113.27811015]
bas 14, expnt(s) = [37.9156805]
bas 15, expnt(s) = [8.41074221]
bas 16, expnt(s) = [3.36916595]
bas 17, expnt(s) = [8.60358419]
bas 18, expnt(s) = [0.49256765]
CPU time:       190.29
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63102308e-01 9.28129374e-01 1.17616814e+05 1.60460109e+04
 6.68629809e-01 1.86811809e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347352e+03 1.99600727e+03
 1.83758101e+04 3.98749265e+03 1.44974632e+03 5.93586528e+02
 3.74023326e+02 2.14876559e+02 1.13278110e+02 8.77252310e+01
 3.79156805e+01 3.86037208e+01 8.41074221e+00 1.24778789e+01
 3.36916595e+00 6.28285196e+00 8.60358419e+00 4.29866557e+01
 4.92567651e-01 1.20383440e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33577166006922
cond(S) = 907755.5959675014
E1 = -689.5610429344398  E_coul = 184.95906343443963
init E= -504.6019795
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672514367712595  LUMO = 0.767483385944171
  mo_energy =
[-1.21704967e+02 -1.33853071e+01 -7.62439128e+00 -7.62439128e+00
 -7.62439128e+00 -1.65765648e+00 -6.72514368e-01 -6.72514368e-01
 -6.72514368e-01  7.67483386e-01  1.25677394e+01  1.12966636e+02
  6.07205776e+02  2.74645126e+03  1.22252817e+04  4.08466287e+04
  1.04890192e+05  2.30073587e+05  4.55888492e+05  8.44840726e+05
  1.52801797e+06  2.85028533e+06  5.80817256e+06]
E1 = -707.7265766717419  E_coul = 199.7711613332362
cycle= 1 E= -507.955415338506  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625886
diis-c [-0.39173267  1.        ]
  HOMO = -0.217970411315627  LUMO = 1.1733486950211
  mo_energy =
[-1.20194650e+02 -1.23037817e+01 -6.59478420e+00 -6.59478420e+00
 -6.59478420e+00 -1.16326309e+00 -2.17970411e-01 -2.17970411e-01
 -2.17970411e-01  1.17334870e+00  1.35135652e+01  1.14367134e+02
  6.08701951e+02  2.74788656e+03  1.22266080e+04  4.08478886e+04
  1.04891416e+05  2.30074786e+05  4.55889674e+05  8.44841894e+05
  1.52801912e+06  2.85028647e+06  5.80817370e+06]
E1 = -706.791294575748  E_coul = 198.81846537870783
cycle= 2 E= -507.97282919704  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258252
diis-c [-6.64053381e-04  2.70954802e-03  9.97290452e-01]
  HOMO = -0.239684080550091  LUMO = 1.16676550869327
  mo_energy =
[-1.20306805e+02 -1.23696631e+01 -6.66774383e+00 -6.66774383e+00
 -6.66774383e+00 -1.17724569e+00 -2.39684081e-01 -2.39684081e-01
 -2.39684081e-01  1.16676551e+00  1.34625133e+01  1.14273453e+02
  6.08585845e+02  2.74775451e+03  1.22264659e+04  4.08477427e+04
  1.04891268e+05  2.30074638e+05  4.55889525e+05  8.44841745e+05
  1.52801897e+06  2.85028633e+06  5.80817356e+06]
E1 = -706.6869761287331  E_coul = 198.71389890674115
cycle= 3 E= -507.973077221992  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0599
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292822
diis-c [-1.55360504e-06 -1.77083655e-04 -1.14529383e-01  1.11470647e+00]
  HOMO = -0.242816010609945  LUMO = 1.16558887831293
  mo_energy =
[-1.20318902e+02 -1.23783491e+01 -6.67694477e+00 -6.67694477e+00
 -6.67694477e+00 -1.17914193e+00 -2.42816011e-01 -2.42816011e-01
 -2.42816011e-01  1.16558888e+00  1.34555040e+01  1.14262681e+02
  6.08573576e+02  2.74774136e+03  1.22264522e+04  4.08477289e+04
  1.04891254e+05  2.30074624e+05  4.55889511e+05  8.44841731e+05
  1.52801896e+06  2.85028631e+06  5.80817354e+06]
E1 = -706.6720573609177  E_coul = 198.69897559623442
cycle= 4 E= -507.973081764683  delta_E= -4.54e-06  |g|= 0.000158  |ddm|= 0.00916
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108621
diis-c [-6.86070485e-11 -5.31434282e-06  7.34606891e-03 -9.12131340e-02
  1.08387238e+00]
  HOMO = -0.242920833453839  LUMO = 1.1655432702426
  mo_energy =
[-1.20319144e+02 -1.23786045e+01 -6.67719420e+00 -6.67719420e+00
 -6.67719420e+00 -1.17920347e+00 -2.42920833e-01 -2.42920833e-01
 -2.42920833e-01  1.16554327e+00  1.34552871e+01  1.14262436e+02
  6.08573334e+02  2.74774112e+03  1.22264520e+04  4.08477286e+04
  1.04891254e+05  2.30074624e+05  4.55889511e+05  8.44841731e+05
  1.52801896e+06  2.85028631e+06  5.80817354e+06]
E1 = -706.6715645431714  E_coul = 198.69848277303973
cycle= 5 E= -507.973081770132  delta_E= -5.45e-09  |g|= 2.56e-07  |ddm|= 0.000333
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.61358e-07
diis-c [-1.07772423e-14  1.80156684e-07 -9.03124114e-05  1.00841828e-03
 -1.12736722e-02  1.01035539e+00]
  HOMO = -0.242920881671518  LUMO = 1.16554341997858
  mo_energy =
[-1.20319145e+02 -1.23786047e+01 -6.67719452e+00 -6.67719452e+00
 -6.67719452e+00 -1.17920363e+00 -2.42920882e-01 -2.42920882e-01
 -2.42920882e-01  1.16554342e+00  1.34552870e+01  1.14262435e+02
  6.08573333e+02  2.74774112e+03  1.22264520e+04  4.08477286e+04
  1.04891254e+05  2.30074624e+05  4.55889511e+05  8.44841731e+05
  1.52801896e+06  2.85028631e+06  5.80817354e+06]
E1 = -706.6715641320455  E_coul = 198.69848236191407
cycle= 6 E= -507.973081770131  delta_E= 2.27e-13  |g|= 1.26e-08  |ddm|= 1.69e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6715641320455  E_coul = 198.69848236191407
  HOMO = -0.24292087480496  LUMO = 1.16554342141235
  mo_energy =
[-1.20319145e+02 -1.23786047e+01 -6.67719450e+00 -6.67719450e+00
 -6.67719450e+00 -1.17920362e+00 -2.42920875e-01 -2.42920875e-01
 -2.42920875e-01  1.16554342e+00  1.34552870e+01  1.14262435e+02
  6.08573333e+02  2.74774112e+03  1.22264520e+04  4.08477286e+04
  1.04891254e+05  2.30074624e+05  4.55889511e+05  8.44841731e+05
  1.52801896e+06  2.85028631e+06  5.80817354e+06]
E1 = -706.6715641676011  E_coul = 198.698482397469
Extra cycle  E= -507.973081770132  delta_E= -6.82e-13  |g|= 1.83e-09  |ddm|= 2.36e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.63102308e-01 1.17616814e+05 6.68629809e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347352e+03 1.83758101e+04 1.44974632e+03
 3.74023326e+02 1.13278110e+02 3.79156805e+01 8.41074221e+00
 3.36916595e+00 8.60358419e+00 4.92567651e-01]
E = -507.9730817701321
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263102308066       1
[INPUT] 0    0    [1    /1   ]  117616.81424         1
[INPUT] 0    0    [1    /1   ]  0.668629809252       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031132        1
[INPUT] 0    0    [1    /1   ]  147020.992146        1
[INPUT] 0    0    [1    /1   ]  73510.4209648        1
[INPUT] 0    0    [1    /1   ]  36754.7200101        1
[INPUT] 0    0    [1    /1   ]  7303.47352064        1
[INPUT] 0    0    [1    /1   ]  18375.8101346        1
[INPUT] 0    0    [1    /1   ]  1449.74632204        1
[INPUT] 0    0    [1    /1   ]  374.023326059        1
[INPUT] 0    0    [1    /1   ]  113.278110147        1
[INPUT] 0    0    [1    /1   ]  37.9156805025        1
[INPUT] 0    0    [1    /1   ]  8.4107422072         1
[INPUT] 0    0    [1    /1   ]  3.36916595377        1
[INPUT] 1    0    [1    /1   ]  8.60358419057        1
[INPUT] 1    0    [1    /1   ]  0.492567651304       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26310230806613627, 1.0]], [0, [117616.81423955354, 1.0]], [0, [0.6686298092523192, 1.0]], [0, [1176168.1426188773, 1.0]], [0, [588084.0699925033, 1.0]], [0, [294042.03113153175, 1.0]], [0, [147020.99214640615, 1.0]], [0, [73510.42096484583, 1.0]], [0, [36754.72001012832, 1.0]], [0, [7303.4735206437435, 1.0]], [0, [18375.81013460913, 1.0]], [0, [1449.7463220381549, 1.0]], [0, [374.0233260589298, 1.0]], [0, [113.2781101471678, 1.0]], [0, [37.91568050252745, 1.0]], [0, [8.410742207195868, 1.0]], [0, [3.369165953769063, 1.0]], [1, [8.60358419056613, 1.0]], [1, [0.492567651303918, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26310231]
bas 1, expnt(s) = [117616.81423955]
bas 2, expnt(s) = [0.66862981]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.0699925]
bas 5, expnt(s) = [294042.03113153]
bas 6, expnt(s) = [147020.99214641]
bas 7, expnt(s) = [73510.42096485]
bas 8, expnt(s) = [36754.72001013]
bas 9, expnt(s) = [7303.47352064]
bas 10, expnt(s) = [18375.81013461]
bas 11, expnt(s) = [1449.74632204]
bas 12, expnt(s) = [374.02332606]
bas 13, expnt(s) = [113.27811015]
bas 14, expnt(s) = [37.9156805]
bas 15, expnt(s) = [8.41074221]
bas 16, expnt(s) = [3.36916595]
bas 17, expnt(s) = [8.60358419]
bas 18, expnt(s) = [0.49256765]
CPU time:       190.86
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63102308e-01 9.28129374e-01 1.17616814e+05 1.60460109e+04
 6.68629809e-01 1.86811809e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347352e+03 1.99600727e+03
 1.83758101e+04 3.98749265e+03 1.44974632e+03 5.93586528e+02
 3.74023326e+02 2.14876559e+02 1.13278110e+02 8.77252310e+01
 3.79156805e+01 3.86037208e+01 8.41074221e+00 1.24778789e+01
 3.36916595e+00 6.28285196e+00 8.60358419e+00 4.29866557e+01
 4.92567651e-01 1.20383440e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33577166006922
cond(S) = 907755.5959675014
E1 = -689.5610429344398  E_coul = 184.95906343443963
init E= -504.6019795
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672514367712595  LUMO = 0.767483385944171
  mo_energy =
[-1.21704967e+02 -1.33853071e+01 -7.62439128e+00 -7.62439128e+00
 -7.62439128e+00 -1.65765648e+00 -6.72514368e-01 -6.72514368e-01
 -6.72514368e-01  7.67483386e-01  1.25677394e+01  1.12966636e+02
  6.07205776e+02  2.74645126e+03  1.22252817e+04  4.08466287e+04
  1.04890192e+05  2.30073587e+05  4.55888492e+05  8.44840726e+05
  1.52801797e+06  2.85028533e+06  5.80817256e+06]
E1 = -707.7265766717419  E_coul = 199.7711613332362
cycle= 1 E= -507.955415338506  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625886
diis-c [-0.39173267  1.        ]
  HOMO = -0.217970411315627  LUMO = 1.1733486950211
  mo_energy =
[-1.20194650e+02 -1.23037817e+01 -6.59478420e+00 -6.59478420e+00
 -6.59478420e+00 -1.16326309e+00 -2.17970411e-01 -2.17970411e-01
 -2.17970411e-01  1.17334870e+00  1.35135652e+01  1.14367134e+02
  6.08701951e+02  2.74788656e+03  1.22266080e+04  4.08478886e+04
  1.04891416e+05  2.30074786e+05  4.55889674e+05  8.44841894e+05
  1.52801912e+06  2.85028647e+06  5.80817370e+06]
E1 = -706.791294575748  E_coul = 198.81846537870783
cycle= 2 E= -507.97282919704  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258252
diis-c [-6.64053381e-04  2.70954802e-03  9.97290452e-01]
  HOMO = -0.239684080550091  LUMO = 1.16676550869327
  mo_energy =
[-1.20306805e+02 -1.23696631e+01 -6.66774383e+00 -6.66774383e+00
 -6.66774383e+00 -1.17724569e+00 -2.39684081e-01 -2.39684081e-01
 -2.39684081e-01  1.16676551e+00  1.34625133e+01  1.14273453e+02
  6.08585845e+02  2.74775451e+03  1.22264659e+04  4.08477427e+04
  1.04891268e+05  2.30074638e+05  4.55889525e+05  8.44841745e+05
  1.52801897e+06  2.85028633e+06  5.80817356e+06]
E1 = -706.6869761287331  E_coul = 198.71389890674115
cycle= 3 E= -507.973077221992  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0599
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292822
diis-c [-1.55360504e-06 -1.77083655e-04 -1.14529383e-01  1.11470647e+00]
  HOMO = -0.242816010609945  LUMO = 1.16558887831293
  mo_energy =
[-1.20318902e+02 -1.23783491e+01 -6.67694477e+00 -6.67694477e+00
 -6.67694477e+00 -1.17914193e+00 -2.42816011e-01 -2.42816011e-01
 -2.42816011e-01  1.16558888e+00  1.34555040e+01  1.14262681e+02
  6.08573576e+02  2.74774136e+03  1.22264522e+04  4.08477289e+04
  1.04891254e+05  2.30074624e+05  4.55889511e+05  8.44841731e+05
  1.52801896e+06  2.85028631e+06  5.80817354e+06]
E1 = -706.6720573609177  E_coul = 198.69897559623442
cycle= 4 E= -507.973081764683  delta_E= -4.54e-06  |g|= 0.000158  |ddm|= 0.00916
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108621
diis-c [-6.86070485e-11 -5.31434282e-06  7.34606891e-03 -9.12131340e-02
  1.08387238e+00]
  HOMO = -0.242920833453839  LUMO = 1.1655432702426
  mo_energy =
[-1.20319144e+02 -1.23786045e+01 -6.67719420e+00 -6.67719420e+00
 -6.67719420e+00 -1.17920347e+00 -2.42920833e-01 -2.42920833e-01
 -2.42920833e-01  1.16554327e+00  1.34552871e+01  1.14262436e+02
  6.08573334e+02  2.74774112e+03  1.22264520e+04  4.08477286e+04
  1.04891254e+05  2.30074624e+05  4.55889511e+05  8.44841731e+05
  1.52801896e+06  2.85028631e+06  5.80817354e+06]
E1 = -706.6715645431714  E_coul = 198.69848277303973
cycle= 5 E= -507.973081770132  delta_E= -5.45e-09  |g|= 2.56e-07  |ddm|= 0.000333
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.61358e-07
diis-c [-1.07772423e-14  1.80156684e-07 -9.03124114e-05  1.00841828e-03
 -1.12736722e-02  1.01035539e+00]
  HOMO = -0.242920881671518  LUMO = 1.16554341997858
  mo_energy =
[-1.20319145e+02 -1.23786047e+01 -6.67719452e+00 -6.67719452e+00
 -6.67719452e+00 -1.17920363e+00 -2.42920882e-01 -2.42920882e-01
 -2.42920882e-01  1.16554342e+00  1.34552870e+01  1.14262435e+02
  6.08573333e+02  2.74774112e+03  1.22264520e+04  4.08477286e+04
  1.04891254e+05  2.30074624e+05  4.55889511e+05  8.44841731e+05
  1.52801896e+06  2.85028631e+06  5.80817354e+06]
E1 = -706.6715641320455  E_coul = 198.69848236191407
cycle= 6 E= -507.973081770131  delta_E= 2.27e-13  |g|= 1.26e-08  |ddm|= 1.69e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6715641320455  E_coul = 198.69848236191407
  HOMO = -0.24292087480496  LUMO = 1.16554342141235
  mo_energy =
[-1.20319145e+02 -1.23786047e+01 -6.67719450e+00 -6.67719450e+00
 -6.67719450e+00 -1.17920362e+00 -2.42920875e-01 -2.42920875e-01
 -2.42920875e-01  1.16554342e+00  1.34552870e+01  1.14262435e+02
  6.08573333e+02  2.74774112e+03  1.22264520e+04  4.08477286e+04
  1.04891254e+05  2.30074624e+05  4.55889511e+05  8.44841731e+05
  1.52801896e+06  2.85028631e+06  5.80817354e+06]
E1 = -706.6715641676011  E_coul = 198.698482397469
Extra cycle  E= -507.973081770132  delta_E= -6.82e-13  |g|= 1.83e-09  |ddm|= 2.36e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907755.5959675014
E1 = -706.6715641676011  E_coul = 198.698482397469
init E= -507.973081770132
    CPU time for initialize scf      1.46 sec, wall time      0.09 sec
  HOMO = -0.242920873811842  LUMO = 1.16554342236074
  mo_energy =
[-1.20319145e+02 -1.23786047e+01 -6.67719450e+00 -6.67719450e+00
 -6.67719450e+00 -1.17920362e+00 -2.42920874e-01 -2.42920874e-01
 -2.42920874e-01  1.16554342e+00  1.34552870e+01  1.14262435e+02
  6.08573333e+02  2.74774112e+03  1.22264520e+04  4.08477286e+04
  1.04891254e+05  2.30074624e+05  4.55889511e+05  8.44841731e+05
  1.52801896e+06  2.85028631e+06  5.80817354e+06]
E1 = -706.6715641710397  E_coul = 198.69848240090832
cycle= 1 E= -507.973081770131  delta_E= 7.96e-13  |g|= 2.28e-09  |ddm|= 2.22e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6715641710397  E_coul = 198.69848240090832
  HOMO = -0.242920873713876  LUMO = 1.16554342303822
  mo_energy =
[-1.20319145e+02 -1.23786047e+01 -6.67719450e+00 -6.67719450e+00
 -6.67719450e+00 -1.17920362e+00 -2.42920874e-01 -2.42920874e-01
 -2.42920874e-01  1.16554342e+00  1.34552870e+01  1.14262435e+02
  6.08573333e+02  2.74774112e+03  1.22264520e+04  4.08477286e+04
  1.04891254e+05  2.30074624e+05  4.55889511e+05  8.44841731e+05
  1.52801896e+06  2.85028631e+06  5.80817354e+06]
E1 = -706.6715641718313  E_coul = 198.69848240169955
Extra cycle  E= -507.973081770132  delta_E= -3.98e-13  |g|= 1.04e-09  |ddm|= 5.38e-10
    CPU time for scf_cycle      1.63 sec, wall time      0.16 sec
exp = [2.63102308e-01 1.17616814e+05 6.68629809e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347352e+03 1.83758101e+04 1.44974632e+03
 3.74023326e+02 1.13278110e+02 3.79156805e+01 8.41074221e+00
 3.36916595e+00 8.60358419e+00 4.92567651e-01]
grad_E = [ 1.57175267e-04  4.20483771e-09 -9.65048236e-05  1.90280491e-11
  1.13500603e-10  6.54195870e-10  2.56575605e-09  1.06601898e-08
  5.73220160e-08  3.60880573e-06  1.23496983e-07  3.85737176e-06
  1.35668303e-05 -1.23542422e-04 -4.58950926e-05  9.66792870e-05
 -1.26770077e-04 -4.72978360e-06 -2.79010205e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263040091733       1
[INPUT] 0    0    [1    /1   ]  117616.814239        1
[INPUT] 0    0    [1    /1   ]  0.668342066516       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031131        1
[INPUT] 0    0    [1    /1   ]  147020.992146        1
[INPUT] 0    0    [1    /1   ]  73510.4209638        1
[INPUT] 0    0    [1    /1   ]  36754.7200043        1
[INPUT] 0    0    [1    /1   ]  7303.47315383        1
[INPUT] 0    0    [1    /1   ]  18375.8101221        1
[INPUT] 0    0    [1    /1   ]  1449.74589812        1
[INPUT] 0    0    [1    /1   ]  374.022428083        1
[INPUT] 0    0    [1    /1   ]  113.287075871        1
[INPUT] 0    0    [1    /1   ]  37.9296036696        1
[INPUT] 0    0    [1    /1   ]  8.41208739675        1
[INPUT] 0    0    [1    /1   ]  3.36934558031        1
[INPUT] 1    0    [1    /1   ]  8.60356955532        1
[INPUT] 1    0    [1    /1   ]  0.492562690977       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2630400917328782, 1.0]], [0, [117616.8142391261, 1.0]], [0, [0.668342066516279, 1.0]], [0, [1176168.1426188755, 1.0]], [0, [588084.0699924917, 1.0]], [0, [294042.0311314653, 1.0]], [0, [147020.99214614532, 1.0]], [0, [73510.42096376223, 1.0]], [0, [36754.72000430088, 1.0]], [0, [7303.47315383386, 1.0]], [0, [18375.810122060622, 1.0]], [0, [1449.7458981187028, 1.0]], [0, [374.02242808259973, 1.0]], [0, [113.28707587101783, 1.0]], [0, [37.92960366961022, 1.0]], [0, [8.412087396750033, 1.0]], [0, [3.3693455803101164, 1.0]], [1, [8.603569555323064, 1.0]], [1, [0.49256269097749594, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26304009]
bas 1, expnt(s) = [117616.81423913]
bas 2, expnt(s) = [0.66834207]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999249]
bas 5, expnt(s) = [294042.03113147]
bas 6, expnt(s) = [147020.99214615]
bas 7, expnt(s) = [73510.42096376]
bas 8, expnt(s) = [36754.7200043]
bas 9, expnt(s) = [7303.47315383]
bas 10, expnt(s) = [18375.81012206]
bas 11, expnt(s) = [1449.74589812]
bas 12, expnt(s) = [374.02242808]
bas 13, expnt(s) = [113.28707587]
bas 14, expnt(s) = [37.92960367]
bas 15, expnt(s) = [8.4120874]
bas 16, expnt(s) = [3.36934558]
bas 17, expnt(s) = [8.60356956]
bas 18, expnt(s) = [0.49256269]
CPU time:       195.66
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63040092e-01 9.27964762e-01 1.17616814e+05 1.60460109e+04
 6.68342067e-01 1.86751510e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347315e+03 1.99600719e+03
 1.83758101e+04 3.98749265e+03 1.44974590e+03 5.93586398e+02
 3.74022428e+02 2.14876172e+02 1.13287076e+02 8.77304384e+01
 3.79296037e+01 3.86143521e+01 8.41208740e+00 1.24793756e+01
 3.36934558e+00 6.28310319e+00 8.60356956e+00 4.29865643e+01
 4.92562691e-01 1.20381925e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335778564780547
cond(S) = 907756.3783238879
E1 = -689.560635681055  E_coul = 184.95881775812694
init E= -504.601817922928
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.672521447065981  LUMO = 0.766959644748199
  mo_energy =
[-1.21704991e+02 -1.33853301e+01 -7.62440670e+00 -7.62440670e+00
 -7.62440670e+00 -1.65766251e+00 -6.72521447e-01 -6.72521447e-01
 -6.72521447e-01  7.66959645e-01  1.25685292e+01  1.13001549e+02
  6.07283153e+02  2.74653586e+03  1.22253573e+04  4.08466982e+04
  1.04890259e+05  2.30073651e+05  4.55888555e+05  8.44840787e+05
  1.52801803e+06  2.85028539e+06  5.80817262e+06]
E1 = -707.7262192049737  E_coul = 199.77080069492132
cycle= 1 E= -507.955418510052  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.19 sec, wall time      0.01 sec
diis-norm(errvec)=0.625898
diis-c [-0.39174879  1.        ]
  HOMO = -0.217980986849271  LUMO = 1.17273500788711
  mo_energy =
[-1.20194668e+02 -1.23038170e+01 -6.59481316e+00 -6.59481316e+00
 -6.59481316e+00 -1.16327213e+00 -2.17980987e-01 -2.17980987e-01
 -2.17980987e-01  1.17273501e+00  1.35144198e+01  1.14402089e+02
  6.08779351e+02  2.74797119e+03  1.22266837e+04  4.08479581e+04
  1.04891482e+05  2.30074851e+05  4.55889737e+05  8.44841956e+05
  1.52801918e+06  2.85028653e+06  5.80817376e+06]
E1 = -706.791008975582  E_coul = 198.81817851873816
cycle= 2 E= -507.972830456844  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258244
diis-c [-6.64007888e-04  2.71150094e-03  9.97288499e-01]
  HOMO = -0.239693394328597  LUMO = 1.16615598212306
  mo_energy =
[-1.20306816e+02 -1.23696922e+01 -6.66776632e+00 -6.66776632e+00
 -6.66776632e+00 -1.17725415e+00 -2.39693394e-01 -2.39693394e-01
 -2.39693394e-01  1.16615598e+00  1.34633697e+01  1.14308409e+02
  6.08663253e+02  2.74783915e+03  1.22265416e+04  4.08478123e+04
  1.04891335e+05  2.30074702e+05  4.55889588e+05  8.44841807e+05
  1.52801903e+06  2.85028638e+06  5.80817361e+06]
E1 = -706.6866832489794  E_coul = 198.71360471698915
cycle= 3 E= -507.97307853199  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0599
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0029285
diis-c [-1.55381461e-06 -1.77339412e-04 -1.14546407e-01  1.11472375e+00]
  HOMO = -0.242825837681822  LUMO = 1.16497971942311
  mo_energy =
[-1.20318913e+02 -1.23783790e+01 -6.67696805e+00 -6.67696805e+00
 -6.67696805e+00 -1.17915075e+00 -2.42825838e-01 -2.42825838e-01
 -2.42825838e-01  1.16497972e+00  1.34563592e+01  1.14297637e+02
  6.08650982e+02  2.74782600e+03  1.22265279e+04  4.08477985e+04
  1.04891321e+05  2.30074688e+05  4.55889574e+05  8.44841793e+05
  1.52801902e+06  2.85028637e+06  5.80817360e+06]
E1 = -706.6717601919441  E_coul = 198.6986771144657
cycle= 4 E= -507.973083077478  delta_E= -4.55e-06  |g|= 0.000158  |ddm|= 0.00916
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108653
diis-c [-6.86330784e-11 -5.31230174e-06  7.34781535e-03 -9.12296707e-02
  1.08388717e+00]
  HOMO = -0.242930721565331  LUMO = 1.16493410303439
  mo_energy =
[-1.20319156e+02 -1.23786345e+01 -6.67721761e+00 -6.67721761e+00
 -6.67721761e+00 -1.17921232e+00 -2.42930722e-01 -2.42930722e-01
 -2.42930722e-01  1.16493410e+00  1.34561422e+01  1.14297391e+02
  6.08650740e+02  2.74782576e+03  1.22265277e+04  4.08477982e+04
  1.04891321e+05  2.30074688e+05  4.55889574e+05  8.44841793e+05
  1.52801902e+06  2.85028637e+06  5.80817360e+06]
E1 = -706.6712670241376  E_coul = 198.69818394120313
cycle= 5 E= -507.973083082934  delta_E= -5.46e-09  |g|= 2.56e-07  |ddm|= 0.000333
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.59535e-07
diis-c [-1.07101182e-14  1.75741274e-07 -9.02760442e-05  1.00841041e-03
 -1.12700944e-02  1.01035178e+00]
  HOMO = -0.2429307698924  LUMO = 1.16493425514002
  mo_energy =
[-1.20319157e+02 -1.23786347e+01 -6.67721793e+00 -6.67721793e+00
 -6.67721793e+00 -1.17921248e+00 -2.42930770e-01 -2.42930770e-01
 -2.42930770e-01  1.16493426e+00  1.34561421e+01  1.14297390e+02
  6.08650740e+02  2.74782576e+03  1.22265277e+04  4.08477982e+04
  1.04891321e+05  2.30074688e+05  4.55889574e+05  8.44841793e+05
  1.52801902e+06  2.85028637e+06  5.80817360e+06]
E1 = -706.6712666085531  E_coul = 198.69818352561876
cycle= 6 E= -507.973083082934  delta_E= 1.71e-13  |g|= 1.31e-08  |ddm|= 1.72e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6712666085531  E_coul = 198.69818352561876
  HOMO = -0.242930763186399  LUMO = 1.16493425509928
  mo_energy =
[-1.20319157e+02 -1.23786347e+01 -6.67721791e+00 -6.67721791e+00
 -6.67721791e+00 -1.17921248e+00 -2.42930763e-01 -2.42930763e-01
 -2.42930763e-01  1.16493426e+00  1.34561421e+01  1.14297390e+02
  6.08650740e+02  2.74782576e+03  1.22265277e+04  4.08477982e+04
  1.04891321e+05  2.30074688e+05  4.55889574e+05  8.44841793e+05
  1.52801902e+06  2.85028637e+06  5.80817360e+06]
E1 = -706.6712666437656  E_coul = 198.6981835608311
Extra cycle  E= -507.973083082935  delta_E= -2.27e-13  |g|= 2.29e-09  |ddm|= 2.34e-08
    CPU time for scf_cycle      0.46 sec, wall time      0.12 sec
exp = [2.63040092e-01 1.17616814e+05 6.68342067e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347315e+03 1.83758101e+04 1.44974590e+03
 3.74022428e+02 1.13287076e+02 3.79296037e+01 8.41208740e+00
 3.36934558e+00 8.60356956e+00 4.92562691e-01]
E = -507.9730830829345
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263040091733       1
[INPUT] 0    0    [1    /1   ]  117616.814239        1
[INPUT] 0    0    [1    /1   ]  0.668342066516       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031131        1
[INPUT] 0    0    [1    /1   ]  147020.992146        1
[INPUT] 0    0    [1    /1   ]  73510.4209638        1
[INPUT] 0    0    [1    /1   ]  36754.7200043        1
[INPUT] 0    0    [1    /1   ]  7303.47315383        1
[INPUT] 0    0    [1    /1   ]  18375.8101221        1
[INPUT] 0    0    [1    /1   ]  1449.74589812        1
[INPUT] 0    0    [1    /1   ]  374.022428083        1
[INPUT] 0    0    [1    /1   ]  113.287075871        1
[INPUT] 0    0    [1    /1   ]  37.9296036696        1
[INPUT] 0    0    [1    /1   ]  8.41208739675        1
[INPUT] 0    0    [1    /1   ]  3.36934558031        1
[INPUT] 1    0    [1    /1   ]  8.60356955532        1
[INPUT] 1    0    [1    /1   ]  0.492562690977       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2630400917328782, 1.0]], [0, [117616.8142391261, 1.0]], [0, [0.668342066516279, 1.0]], [0, [1176168.1426188755, 1.0]], [0, [588084.0699924917, 1.0]], [0, [294042.0311314653, 1.0]], [0, [147020.99214614532, 1.0]], [0, [73510.42096376223, 1.0]], [0, [36754.72000430088, 1.0]], [0, [7303.47315383386, 1.0]], [0, [18375.810122060622, 1.0]], [0, [1449.7458981187028, 1.0]], [0, [374.02242808259973, 1.0]], [0, [113.28707587101783, 1.0]], [0, [37.92960366961022, 1.0]], [0, [8.412087396750033, 1.0]], [0, [3.3693455803101164, 1.0]], [1, [8.603569555323064, 1.0]], [1, [0.49256269097749594, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26304009]
bas 1, expnt(s) = [117616.81423913]
bas 2, expnt(s) = [0.66834207]
bas 3, expnt(s) = [1176168.14261888]
bas 4, expnt(s) = [588084.06999249]
bas 5, expnt(s) = [294042.03113147]
bas 6, expnt(s) = [147020.99214615]
bas 7, expnt(s) = [73510.42096376]
bas 8, expnt(s) = [36754.7200043]
bas 9, expnt(s) = [7303.47315383]
bas 10, expnt(s) = [18375.81012206]
bas 11, expnt(s) = [1449.74589812]
bas 12, expnt(s) = [374.02242808]
bas 13, expnt(s) = [113.28707587]
bas 14, expnt(s) = [37.92960367]
bas 15, expnt(s) = [8.4120874]
bas 16, expnt(s) = [3.36934558]
bas 17, expnt(s) = [8.60356956]
bas 18, expnt(s) = [0.49256269]
CPU time:       196.25
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63040092e-01 9.27964762e-01 1.17616814e+05 1.60460109e+04
 6.68342067e-01 1.86751510e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656076e+03 7.30347315e+03 1.99600719e+03
 1.83758101e+04 3.98749265e+03 1.44974590e+03 5.93586398e+02
 3.74022428e+02 2.14876172e+02 1.13287076e+02 8.77304384e+01
 3.79296037e+01 3.86143521e+01 8.41208740e+00 1.24793756e+01
 3.36934558e+00 6.28310319e+00 8.60356956e+00 4.29865643e+01
 4.92562691e-01 1.20381925e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335778564780547
cond(S) = 907756.3783238879
E1 = -689.560635681055  E_coul = 184.95881775812694
init E= -504.601817922928
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672521447065981  LUMO = 0.766959644748199
  mo_energy =
[-1.21704991e+02 -1.33853301e+01 -7.62440670e+00 -7.62440670e+00
 -7.62440670e+00 -1.65766251e+00 -6.72521447e-01 -6.72521447e-01
 -6.72521447e-01  7.66959645e-01  1.25685292e+01  1.13001549e+02
  6.07283153e+02  2.74653586e+03  1.22253573e+04  4.08466982e+04
  1.04890259e+05  2.30073651e+05  4.55888555e+05  8.44840787e+05
  1.52801803e+06  2.85028539e+06  5.80817262e+06]
E1 = -707.7262192049737  E_coul = 199.77080069492132
cycle= 1 E= -507.955418510052  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625898
diis-c [-0.39174879  1.        ]
  HOMO = -0.217980986849271  LUMO = 1.17273500788711
  mo_energy =
[-1.20194668e+02 -1.23038170e+01 -6.59481316e+00 -6.59481316e+00
 -6.59481316e+00 -1.16327213e+00 -2.17980987e-01 -2.17980987e-01
 -2.17980987e-01  1.17273501e+00  1.35144198e+01  1.14402089e+02
  6.08779351e+02  2.74797119e+03  1.22266837e+04  4.08479581e+04
  1.04891482e+05  2.30074851e+05  4.55889737e+05  8.44841956e+05
  1.52801918e+06  2.85028653e+06  5.80817376e+06]
E1 = -706.791008975582  E_coul = 198.81817851873816
cycle= 2 E= -507.972830456844  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258244
diis-c [-6.64007888e-04  2.71150094e-03  9.97288499e-01]
  HOMO = -0.239693394328597  LUMO = 1.16615598212306
  mo_energy =
[-1.20306816e+02 -1.23696922e+01 -6.66776632e+00 -6.66776632e+00
 -6.66776632e+00 -1.17725415e+00 -2.39693394e-01 -2.39693394e-01
 -2.39693394e-01  1.16615598e+00  1.34633697e+01  1.14308409e+02
  6.08663253e+02  2.74783915e+03  1.22265416e+04  4.08478123e+04
  1.04891335e+05  2.30074702e+05  4.55889588e+05  8.44841807e+05
  1.52801903e+06  2.85028638e+06  5.80817361e+06]
E1 = -706.6866832489794  E_coul = 198.71360471698915
cycle= 3 E= -507.97307853199  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0599
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0029285
diis-c [-1.55381461e-06 -1.77339412e-04 -1.14546407e-01  1.11472375e+00]
  HOMO = -0.242825837681822  LUMO = 1.16497971942311
  mo_energy =
[-1.20318913e+02 -1.23783790e+01 -6.67696805e+00 -6.67696805e+00
 -6.67696805e+00 -1.17915075e+00 -2.42825838e-01 -2.42825838e-01
 -2.42825838e-01  1.16497972e+00  1.34563592e+01  1.14297637e+02
  6.08650982e+02  2.74782600e+03  1.22265279e+04  4.08477985e+04
  1.04891321e+05  2.30074688e+05  4.55889574e+05  8.44841793e+05
  1.52801902e+06  2.85028637e+06  5.80817360e+06]
E1 = -706.6717601919441  E_coul = 198.6986771144657
cycle= 4 E= -507.973083077478  delta_E= -4.55e-06  |g|= 0.000158  |ddm|= 0.00916
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108653
diis-c [-6.86330784e-11 -5.31230174e-06  7.34781535e-03 -9.12296707e-02
  1.08388717e+00]
  HOMO = -0.242930721565331  LUMO = 1.16493410303439
  mo_energy =
[-1.20319156e+02 -1.23786345e+01 -6.67721761e+00 -6.67721761e+00
 -6.67721761e+00 -1.17921232e+00 -2.42930722e-01 -2.42930722e-01
 -2.42930722e-01  1.16493410e+00  1.34561422e+01  1.14297391e+02
  6.08650740e+02  2.74782576e+03  1.22265277e+04  4.08477982e+04
  1.04891321e+05  2.30074688e+05  4.55889574e+05  8.44841793e+05
  1.52801902e+06  2.85028637e+06  5.80817360e+06]
E1 = -706.6712670241376  E_coul = 198.69818394120313
cycle= 5 E= -507.973083082934  delta_E= -5.46e-09  |g|= 2.56e-07  |ddm|= 0.000333
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.59535e-07
diis-c [-1.07101182e-14  1.75741274e-07 -9.02760442e-05  1.00841041e-03
 -1.12700944e-02  1.01035178e+00]
  HOMO = -0.2429307698924  LUMO = 1.16493425514002
  mo_energy =
[-1.20319157e+02 -1.23786347e+01 -6.67721793e+00 -6.67721793e+00
 -6.67721793e+00 -1.17921248e+00 -2.42930770e-01 -2.42930770e-01
 -2.42930770e-01  1.16493426e+00  1.34561421e+01  1.14297390e+02
  6.08650740e+02  2.74782576e+03  1.22265277e+04  4.08477982e+04
  1.04891321e+05  2.30074688e+05  4.55889574e+05  8.44841793e+05
  1.52801902e+06  2.85028637e+06  5.80817360e+06]
E1 = -706.6712666085531  E_coul = 198.69818352561876
cycle= 6 E= -507.973083082934  delta_E= 1.71e-13  |g|= 1.31e-08  |ddm|= 1.72e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6712666085531  E_coul = 198.69818352561876
  HOMO = -0.242930763186399  LUMO = 1.16493425509928
  mo_energy =
[-1.20319157e+02 -1.23786347e+01 -6.67721791e+00 -6.67721791e+00
 -6.67721791e+00 -1.17921248e+00 -2.42930763e-01 -2.42930763e-01
 -2.42930763e-01  1.16493426e+00  1.34561421e+01  1.14297390e+02
  6.08650740e+02  2.74782576e+03  1.22265277e+04  4.08477982e+04
  1.04891321e+05  2.30074688e+05  4.55889574e+05  8.44841793e+05
  1.52801902e+06  2.85028637e+06  5.80817360e+06]
E1 = -706.6712666437656  E_coul = 198.6981835608311
Extra cycle  E= -507.973083082935  delta_E= -2.27e-13  |g|= 2.29e-09  |ddm|= 2.34e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907756.3783238879
E1 = -706.6712666437656  E_coul = 198.6981835608311
init E= -507.973083082935
    CPU time for initialize scf      1.48 sec, wall time      0.09 sec
  HOMO = -0.242930762196139  LUMO = 1.16493425502533
  mo_energy =
[-1.20319157e+02 -1.23786347e+01 -6.67721791e+00 -6.67721791e+00
 -6.67721791e+00 -1.17921248e+00 -2.42930762e-01 -2.42930762e-01
 -2.42930762e-01  1.16493426e+00  1.34561421e+01  1.14297390e+02
  6.08650740e+02  2.74782576e+03  1.22265277e+04  4.08477982e+04
  1.04891321e+05  2.30074688e+05  4.55889574e+05  8.44841793e+05
  1.52801902e+06  2.85028637e+06  5.80817360e+06]
E1 = -706.6712666474099  E_coul = 198.6981835644756
cycle= 1 E= -507.973083082934  delta_E= 2.27e-13  |g|= 1.68e-09  |ddm|= 2.44e-09
    CPU time for cycle= 1      0.10 sec, wall time      0.01 sec
E1 = -706.6712666474099  E_coul = 198.6981835644756
  HOMO = -0.242930762085523  LUMO = 1.16493425501994
  mo_energy =
[-1.20319157e+02 -1.23786347e+01 -6.67721791e+00 -6.67721791e+00
 -6.67721791e+00 -1.17921248e+00 -2.42930762e-01 -2.42930762e-01
 -2.42930762e-01  1.16493426e+00  1.34561421e+01  1.14297390e+02
  6.08650740e+02  2.74782576e+03  1.22265277e+04  4.08477982e+04
  1.04891321e+05  2.30074688e+05  4.55889574e+05  8.44841793e+05
  1.52801902e+06  2.85028637e+06  5.80817360e+06]
E1 = -706.6712666484157  E_coul = 198.69818356548151
Extra cycle  E= -507.973083082934  delta_E= 1.14e-13  |g|= 1.59e-09  |ddm|= 6.08e-10
    CPU time for scf_cycle      1.64 sec, wall time      0.16 sec
exp = [2.63040092e-01 1.17616814e+05 6.68342067e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347315e+03 1.83758101e+04 1.44974590e+03
 3.74022428e+02 1.13287076e+02 3.79296037e+01 8.41208740e+00
 3.36934558e+00 8.60356956e+00 4.92562691e-01]
grad_E = [ 2.53633383e-04  4.20678873e-09 -1.52890307e-04  1.90511794e-11
  1.13563886e-10  6.54497913e-10  2.56696166e-09  1.06652713e-08
  5.73471017e-08  3.61061749e-06  1.23573008e-07  3.74587902e-06
  1.55718569e-05 -1.41861830e-04  1.07030338e-05  1.17880142e-04
 -2.22813528e-04 -7.97876896e-06 -4.58838498e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:18 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.26298546828        1
[INPUT] 0    0    [1    /1   ]  117616.814238        1
[INPUT] 0    0    [1    /1   ]  0.668023210283       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031131        1
[INPUT] 0    0    [1    /1   ]  147020.992145        1
[INPUT] 0    0    [1    /1   ]  73510.4209607        1
[INPUT] 0    0    [1    /1   ]  36754.7199879        1
[INPUT] 0    0    [1    /1   ]  7303.47211841        1
[INPUT] 0    0    [1    /1   ]  18375.8100866        1
[INPUT] 0    0    [1    /1   ]  1449.7447606         1
[INPUT] 0    0    [1    /1   ]  374.019067429        1
[INPUT] 0    0    [1    /1   ]  113.317556797        1
[INPUT] 0    0    [1    /1   ]  37.9569300341        1
[INPUT] 0    0    [1    /1   ]  8.41401818044        1
[INPUT] 0    0    [1    /1   ]  3.36982430301        1
[INPUT] 1    0    [1    /1   ]  8.60354765332        1
[INPUT] 1    0    [1    /1   ]  0.492555655405       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26298546828029185, 1.0]], [0, [117616.81423791962, 1.0]], [0, [0.6680232102825886, 1.0]], [0, [1176168.1426188701, 1.0]], [0, [588084.0699924591, 1.0]], [0, [294042.03113127756, 1.0]], [0, [147020.99214540914, 1.0]], [0, [73510.42096070354, 1.0]], [0, [36754.71998785313, 1.0]], [0, [7303.47211840655, 1.0]], [0, [18375.810086630336, 1.0]], [0, [1449.7447605975494, 1.0]], [0, [374.0190674288062, 1.0]], [0, [113.31755679698036, 1.0]], [0, [37.95693003407468, 1.0]], [0, [8.41401818044342, 1.0]], [0, [3.3698243030071686, 1.0]], [1, [8.60354765332291, 1.0]], [1, [0.4925556554050084, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26298547]
bas 1, expnt(s) = [117616.81423792]
bas 2, expnt(s) = [0.66802321]
bas 3, expnt(s) = [1176168.14261887]
bas 4, expnt(s) = [588084.06999246]
bas 5, expnt(s) = [294042.03113128]
bas 6, expnt(s) = [147020.99214541]
bas 7, expnt(s) = [73510.4209607]
bas 8, expnt(s) = [36754.71998785]
bas 9, expnt(s) = [7303.47211841]
bas 10, expnt(s) = [18375.81008663]
bas 11, expnt(s) = [1449.7447606]
bas 12, expnt(s) = [374.01906743]
bas 13, expnt(s) = [113.3175568]
bas 14, expnt(s) = [37.95693003]
bas 15, expnt(s) = [8.41401818]
bas 16, expnt(s) = [3.3698243]
bas 17, expnt(s) = [8.60354765]
bas 18, expnt(s) = [0.49255566]
CPU time:       201.05
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.62985468e-01 9.27820231e-01 1.17616814e+05 1.60460109e+04
 6.68023210e-01 1.86684684e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656075e+03 7.30347212e+03 1.99600698e+03
 1.83758101e+04 3.98749264e+03 1.44974476e+03 5.93586049e+02
 3.74019067e+02 2.14874724e+02 1.13317557e+02 8.77481413e+01
 3.79569300e+01 3.86352150e+01 8.41401818e+00 1.24815238e+01
 3.36982430e+00 6.28377271e+00 8.60354765e+00 4.29864275e+01
 4.92555655e-01 1.20379776e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33578766432328
cond(S) = 907758.2651244684
E1 = -689.5600939488165  E_coul = 184.95847075100312
init E= -504.601623197813
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.672531386446511  LUMO = 0.766431960735663
  mo_energy =
[-1.21705028e+02 -1.33853628e+01 -7.62442831e+00 -7.62442831e+00
 -7.62442831e+00 -1.65767124e+00 -6.72531386e-01 -6.72531386e-01
 -6.72531386e-01  7.66431961e-01  1.25711581e+01  1.13074493e+02
  6.07464821e+02  2.74674248e+03  1.22255427e+04  4.08468685e+04
  1.04890421e+05  2.30073808e+05  4.55888708e+05  8.44840938e+05
  1.52801817e+06  2.85028553e+06  5.80817276e+06]
E1 = -707.7257589368548  E_coul = 199.77033488135075
cycle= 1 E= -507.955424055504  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.18 sec, wall time      0.01 sec
diis-norm(errvec)=0.62592
diis-c [-0.39177531  1.        ]
  HOMO = -0.217995736434069  LUMO = 1.1721168994613
  mo_energy =
[-1.20194686e+02 -1.23038644e+01 -6.59485082e+00 -6.59485082e+00
 -6.59485082e+00 -1.16328455e+00 -2.17995736e-01 -2.17995736e-01
 -2.17995736e-01  1.17211690e+00  1.35171669e+01  1.14475129e+02
  6.08961066e+02  2.74817787e+03  1.22268691e+04  4.08481285e+04
  1.04891644e+05  2.30075007e+05  4.55889890e+05  8.44842107e+05
  1.52801933e+06  2.85028668e+06  5.80817390e+06]
E1 = -706.7906430280859  E_coul = 198.8178094963341
cycle= 2 E= -507.972833531752  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258221
diis-c [-6.63879273e-04  2.71613369e-03  9.97283866e-01]
  HOMO = -0.239706168370939  LUMO = 1.16554218773235
  mo_energy =
[-1.20306823e+02 -1.23697313e+01 -6.66779549e+00 -6.66779549e+00
 -6.66779549e+00 -1.17726555e+00 -2.39706168e-01 -2.39706168e-01
 -2.39706168e-01  1.16554219e+00  1.34661164e+01  1.14381448e+02
  6.08844976e+02  2.74804584e+03  1.22267270e+04  4.08479827e+04
  1.04891497e+05  2.30074859e+05  4.55889741e+05  8.44841958e+05
  1.52801918e+06  2.85028653e+06  5.80817375e+06]
E1 = -706.6863122186235  E_coul = 198.713230566015
cycle= 3 E= -507.973081652608  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0599
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292866
diis-c [-1.55381008e-06 -1.77714791e-04 -1.14566968e-01  1.11474468e+00]
  HOMO = -0.242839123309337  LUMO = 1.16436629036466
  mo_energy =
[-1.20318921e+02 -1.23784190e+01 -6.67699805e+00 -6.67699805e+00
 -6.67699805e+00 -1.17916253e+00 -2.42839123e-01 -2.42839123e-01
 -2.42839123e-01  1.16436629e+00  1.34591044e+01  1.14370673e+02
  6.08832704e+02  2.74803269e+03  1.22267133e+04  4.08479688e+04
  1.04891483e+05  2.30074845e+05  4.55889727e+05  8.44841944e+05
  1.52801917e+06  2.85028652e+06  5.80817374e+06]
E1 = -706.6713846789639  E_coul = 198.69829847790444
cycle= 4 E= -507.973086201059  delta_E= -4.55e-06  |g|= 0.000158  |ddm|= 0.00917
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108681
diis-c [-6.86424673e-11 -5.30858097e-06  7.35014457e-03 -9.12493169e-02
  1.08390448e+00]
  HOMO = -0.242944066552966  LUMO = 1.16432066918128
  mo_energy =
[-1.20319165e+02 -1.23786746e+01 -6.67724774e+00 -6.67724774e+00
 -6.67724774e+00 -1.17922414e+00 -2.42944067e-01 -2.42944067e-01
 -2.42944067e-01  1.16432067e+00  1.34588873e+01  1.14370427e+02
  6.08832462e+02  2.74803245e+03  1.22267131e+04  4.08479686e+04
  1.04891483e+05  2.30074845e+05  4.55889727e+05  8.44841944e+05
  1.52801917e+06  2.85028652e+06  5.80817374e+06]
E1 = -706.6708911541809  E_coul = 198.6978049476581
cycle= 5 E= -507.973086206523  delta_E= -5.46e-09  |g|= 2.56e-07  |ddm|= 0.000334
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.61075e-07
diis-c [-1.07260821e-14  1.79493298e-07 -9.04923128e-05  1.01047480e-03
 -1.12892754e-02  1.01036911e+00]
  HOMO = -0.242944114934761  LUMO = 1.16432081847917
  mo_energy =
[-1.20319165e+02 -1.23786748e+01 -6.67724806e+00 -6.67724806e+00
 -6.67724806e+00 -1.17922430e+00 -2.42944115e-01 -2.42944115e-01
 -2.42944115e-01  1.16432082e+00  1.34588872e+01  1.14370427e+02
  6.08832461e+02  2.74803245e+03  1.22267131e+04  4.08479686e+04
  1.04891483e+05  2.30074845e+05  4.55889727e+05  8.44841944e+05
  1.52801917e+06  2.85028652e+06  5.80817374e+06]
E1 = -706.6708907407818  E_coul = 198.69780453425903
cycle= 6 E= -507.973086206523  delta_E=    0  |g|= 1.3e-08  |ddm|= 1.71e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6708907407818  E_coul = 198.69780453425903
  HOMO = -0.242944108162704  LUMO = 1.16432082201444
  mo_energy =
[-1.20319165e+02 -1.23786748e+01 -6.67724805e+00 -6.67724805e+00
 -6.67724805e+00 -1.17922429e+00 -2.42944108e-01 -2.42944108e-01
 -2.42944108e-01  1.16432082e+00  1.34588872e+01  1.14370427e+02
  6.08832461e+02  2.74803245e+03  1.22267131e+04  4.08479686e+04
  1.04891483e+05  2.30074845e+05  4.55889727e+05  8.44841944e+05
  1.52801917e+06  2.85028652e+06  5.80817374e+06]
E1 = -706.6708907757081  E_coul = 198.6978045691851
Extra cycle  E= -507.973086206523  delta_E= -2.27e-13  |g|= 3.4e-09  |ddm|= 2.31e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.12 sec
exp = [2.62985468e-01 1.17616814e+05 6.68023210e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347212e+03 1.83758101e+04 1.44974476e+03
 3.74019067e+02 1.13317557e+02 3.79569300e+01 8.41401818e+00
 3.36982430e+00 8.60354765e+00 4.92555655e-01]
E = -507.973086206523
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:18 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.26298546828        1
[INPUT] 0    0    [1    /1   ]  117616.814238        1
[INPUT] 0    0    [1    /1   ]  0.668023210283       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031131        1
[INPUT] 0    0    [1    /1   ]  147020.992145        1
[INPUT] 0    0    [1    /1   ]  73510.4209607        1
[INPUT] 0    0    [1    /1   ]  36754.7199879        1
[INPUT] 0    0    [1    /1   ]  7303.47211841        1
[INPUT] 0    0    [1    /1   ]  18375.8100866        1
[INPUT] 0    0    [1    /1   ]  1449.7447606         1
[INPUT] 0    0    [1    /1   ]  374.019067429        1
[INPUT] 0    0    [1    /1   ]  113.317556797        1
[INPUT] 0    0    [1    /1   ]  37.9569300341        1
[INPUT] 0    0    [1    /1   ]  8.41401818044        1
[INPUT] 0    0    [1    /1   ]  3.36982430301        1
[INPUT] 1    0    [1    /1   ]  8.60354765332        1
[INPUT] 1    0    [1    /1   ]  0.492555655405       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26298546828029185, 1.0]], [0, [117616.81423791962, 1.0]], [0, [0.6680232102825886, 1.0]], [0, [1176168.1426188701, 1.0]], [0, [588084.0699924591, 1.0]], [0, [294042.03113127756, 1.0]], [0, [147020.99214540914, 1.0]], [0, [73510.42096070354, 1.0]], [0, [36754.71998785313, 1.0]], [0, [7303.47211840655, 1.0]], [0, [18375.810086630336, 1.0]], [0, [1449.7447605975494, 1.0]], [0, [374.0190674288062, 1.0]], [0, [113.31755679698036, 1.0]], [0, [37.95693003407468, 1.0]], [0, [8.41401818044342, 1.0]], [0, [3.3698243030071686, 1.0]], [1, [8.60354765332291, 1.0]], [1, [0.4925556554050084, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26298547]
bas 1, expnt(s) = [117616.81423792]
bas 2, expnt(s) = [0.66802321]
bas 3, expnt(s) = [1176168.14261887]
bas 4, expnt(s) = [588084.06999246]
bas 5, expnt(s) = [294042.03113128]
bas 6, expnt(s) = [147020.99214541]
bas 7, expnt(s) = [73510.4209607]
bas 8, expnt(s) = [36754.71998785]
bas 9, expnt(s) = [7303.47211841]
bas 10, expnt(s) = [18375.81008663]
bas 11, expnt(s) = [1449.7447606]
bas 12, expnt(s) = [374.01906743]
bas 13, expnt(s) = [113.3175568]
bas 14, expnt(s) = [37.95693003]
bas 15, expnt(s) = [8.41401818]
bas 16, expnt(s) = [3.3698243]
bas 17, expnt(s) = [8.60354765]
bas 18, expnt(s) = [0.49255566]
CPU time:       201.65
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.62985468e-01 9.27820231e-01 1.17616814e+05 1.60460109e+04
 6.68023210e-01 1.86684684e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547200e+04 6.70656075e+03 7.30347212e+03 1.99600698e+03
 1.83758101e+04 3.98749264e+03 1.44974476e+03 5.93586049e+02
 3.74019067e+02 2.14874724e+02 1.13317557e+02 8.77481413e+01
 3.79569300e+01 3.86352150e+01 8.41401818e+00 1.24815238e+01
 3.36982430e+00 6.28377271e+00 8.60354765e+00 4.29864275e+01
 4.92555655e-01 1.20379776e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33578766432328
cond(S) = 907758.2651244684
E1 = -689.5600939488165  E_coul = 184.95847075100312
init E= -504.601623197813
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672531386446511  LUMO = 0.766431960735663
  mo_energy =
[-1.21705028e+02 -1.33853628e+01 -7.62442831e+00 -7.62442831e+00
 -7.62442831e+00 -1.65767124e+00 -6.72531386e-01 -6.72531386e-01
 -6.72531386e-01  7.66431961e-01  1.25711581e+01  1.13074493e+02
  6.07464821e+02  2.74674248e+03  1.22255427e+04  4.08468685e+04
  1.04890421e+05  2.30073808e+05  4.55888708e+05  8.44840938e+05
  1.52801817e+06  2.85028553e+06  5.80817276e+06]
E1 = -707.7257589368548  E_coul = 199.77033488135075
cycle= 1 E= -507.955424055504  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.62592
diis-c [-0.39177531  1.        ]
  HOMO = -0.217995736434069  LUMO = 1.1721168994613
  mo_energy =
[-1.20194686e+02 -1.23038644e+01 -6.59485082e+00 -6.59485082e+00
 -6.59485082e+00 -1.16328455e+00 -2.17995736e-01 -2.17995736e-01
 -2.17995736e-01  1.17211690e+00  1.35171669e+01  1.14475129e+02
  6.08961066e+02  2.74817787e+03  1.22268691e+04  4.08481285e+04
  1.04891644e+05  2.30075007e+05  4.55889890e+05  8.44842107e+05
  1.52801933e+06  2.85028668e+06  5.80817390e+06]
E1 = -706.7906430280859  E_coul = 198.8178094963341
cycle= 2 E= -507.972833531752  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258221
diis-c [-6.63879273e-04  2.71613369e-03  9.97283866e-01]
  HOMO = -0.239706168370939  LUMO = 1.16554218773235
  mo_energy =
[-1.20306823e+02 -1.23697313e+01 -6.66779549e+00 -6.66779549e+00
 -6.66779549e+00 -1.17726555e+00 -2.39706168e-01 -2.39706168e-01
 -2.39706168e-01  1.16554219e+00  1.34661164e+01  1.14381448e+02
  6.08844976e+02  2.74804584e+03  1.22267270e+04  4.08479827e+04
  1.04891497e+05  2.30074859e+05  4.55889741e+05  8.44841958e+05
  1.52801918e+06  2.85028653e+06  5.80817375e+06]
E1 = -706.6863122186235  E_coul = 198.713230566015
cycle= 3 E= -507.973081652608  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0599
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292866
diis-c [-1.55381008e-06 -1.77714791e-04 -1.14566968e-01  1.11474468e+00]
  HOMO = -0.242839123309337  LUMO = 1.16436629036466
  mo_energy =
[-1.20318921e+02 -1.23784190e+01 -6.67699805e+00 -6.67699805e+00
 -6.67699805e+00 -1.17916253e+00 -2.42839123e-01 -2.42839123e-01
 -2.42839123e-01  1.16436629e+00  1.34591044e+01  1.14370673e+02
  6.08832704e+02  2.74803269e+03  1.22267133e+04  4.08479688e+04
  1.04891483e+05  2.30074845e+05  4.55889727e+05  8.44841944e+05
  1.52801917e+06  2.85028652e+06  5.80817374e+06]
E1 = -706.6713846789639  E_coul = 198.69829847790444
cycle= 4 E= -507.973086201059  delta_E= -4.55e-06  |g|= 0.000158  |ddm|= 0.00917
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108681
diis-c [-6.86424673e-11 -5.30858097e-06  7.35014457e-03 -9.12493169e-02
  1.08390448e+00]
  HOMO = -0.242944066552966  LUMO = 1.16432066918128
  mo_energy =
[-1.20319165e+02 -1.23786746e+01 -6.67724774e+00 -6.67724774e+00
 -6.67724774e+00 -1.17922414e+00 -2.42944067e-01 -2.42944067e-01
 -2.42944067e-01  1.16432067e+00  1.34588873e+01  1.14370427e+02
  6.08832462e+02  2.74803245e+03  1.22267131e+04  4.08479686e+04
  1.04891483e+05  2.30074845e+05  4.55889727e+05  8.44841944e+05
  1.52801917e+06  2.85028652e+06  5.80817374e+06]
E1 = -706.6708911541809  E_coul = 198.6978049476581
cycle= 5 E= -507.973086206523  delta_E= -5.46e-09  |g|= 2.56e-07  |ddm|= 0.000334
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.61075e-07
diis-c [-1.07260821e-14  1.79493298e-07 -9.04923128e-05  1.01047480e-03
 -1.12892754e-02  1.01036911e+00]
  HOMO = -0.242944114934761  LUMO = 1.16432081847917
  mo_energy =
[-1.20319165e+02 -1.23786748e+01 -6.67724806e+00 -6.67724806e+00
 -6.67724806e+00 -1.17922430e+00 -2.42944115e-01 -2.42944115e-01
 -2.42944115e-01  1.16432082e+00  1.34588872e+01  1.14370427e+02
  6.08832461e+02  2.74803245e+03  1.22267131e+04  4.08479686e+04
  1.04891483e+05  2.30074845e+05  4.55889727e+05  8.44841944e+05
  1.52801917e+06  2.85028652e+06  5.80817374e+06]
E1 = -706.6708907407818  E_coul = 198.69780453425903
cycle= 6 E= -507.973086206523  delta_E=    0  |g|= 1.3e-08  |ddm|= 1.71e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6708907407818  E_coul = 198.69780453425903
  HOMO = -0.242944108162704  LUMO = 1.16432082201444
  mo_energy =
[-1.20319165e+02 -1.23786748e+01 -6.67724805e+00 -6.67724805e+00
 -6.67724805e+00 -1.17922429e+00 -2.42944108e-01 -2.42944108e-01
 -2.42944108e-01  1.16432082e+00  1.34588872e+01  1.14370427e+02
  6.08832461e+02  2.74803245e+03  1.22267131e+04  4.08479686e+04
  1.04891483e+05  2.30074845e+05  4.55889727e+05  8.44841944e+05
  1.52801917e+06  2.85028652e+06  5.80817374e+06]
E1 = -706.6708907757081  E_coul = 198.6978045691851
Extra cycle  E= -507.973086206523  delta_E= -2.27e-13  |g|= 3.4e-09  |ddm|= 2.31e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907758.2651244684
E1 = -706.6708907757081  E_coul = 198.6978045691851
init E= -507.973086206523
    CPU time for initialize scf      1.50 sec, wall time      0.10 sec
  HOMO = -0.242944107200756  LUMO = 1.16432082006919
  mo_energy =
[-1.20319165e+02 -1.23786748e+01 -6.67724804e+00 -6.67724804e+00
 -6.67724804e+00 -1.17922429e+00 -2.42944107e-01 -2.42944107e-01
 -2.42944107e-01  1.16432082e+00  1.34588872e+01  1.14370427e+02
  6.08832461e+02  2.74803245e+03  1.22267131e+04  4.08479686e+04
  1.04891483e+05  2.30074845e+05  4.55889727e+05  8.44841944e+05
  1.52801917e+06  2.85028652e+06  5.80817374e+06]
E1 = -706.6708907829747  E_coul = 198.6978045764515
cycle= 1 E= -507.973086206523  delta_E= -1.14e-13  |g|= 1.67e-09  |ddm|= 4.7e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6708907829747  E_coul = 198.6978045764515
  HOMO = -0.242944106995403  LUMO = 1.16432081838812
  mo_energy =
[-1.20319165e+02 -1.23786748e+01 -6.67724804e+00 -6.67724804e+00
 -6.67724804e+00 -1.17922429e+00 -2.42944107e-01 -2.42944107e-01
 -2.42944107e-01  1.16432082e+00  1.34588872e+01  1.14370427e+02
  6.08832461e+02  2.74803245e+03  1.22267131e+04  4.08479686e+04
  1.04891483e+05  2.30074845e+05  4.55889727e+05  8.44841944e+05
  1.52801917e+06  2.85028652e+06  5.80817374e+06]
E1 = -706.6708907829349  E_coul = 198.69780457641238
Extra cycle  E= -507.973086206522  delta_E= 6.82e-13  |g|= 2.25e-09  |ddm|= 6.64e-10
    CPU time for scf_cycle      1.67 sec, wall time      0.16 sec
exp = [2.62985468e-01 1.17616814e+05 6.68023210e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547200e+04 7.30347212e+03 1.83758101e+04 1.44974476e+03
 3.74019067e+02 1.13317557e+02 3.79569300e+01 8.41401818e+00
 3.36982430e+00 8.60354765e+00 4.92555655e-01]
grad_E = [ 3.85212072e-04  4.20648652e-09 -2.29560480e-04  1.90475567e-11
  1.13553950e-10  6.54451297e-10  2.56677457e-09  1.06644814e-08
  5.73432795e-08  3.61039976e-06  1.23560768e-07  3.73826814e-06
  1.67132041e-05 -1.63341502e-04  9.37706792e-05  1.44333933e-04
 -3.55382402e-04 -1.24291761e-05 -7.05430104e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263009418025       1
[INPUT] 0    0    [1    /1   ]  117616.814235        1
[INPUT] 0    0    [1    /1   ]  0.667894255771       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031131        1
[INPUT] 0    0    [1    /1   ]  147020.992144        1
[INPUT] 0    0    [1    /1   ]  73510.4209535        1
[INPUT] 0    0    [1    /1   ]  36754.7199491        1
[INPUT] 0    0    [1    /1   ]  7303.46968093        1
[INPUT] 0    0    [1    /1   ]  18375.8100032        1
[INPUT] 0    0    [1    /1   ]  1449.74215754        1
[INPUT] 0    0    [1    /1   ]  374.010110795        1
[INPUT] 0    0    [1    /1   ]  113.395873142        1
[INPUT] 0    0    [1    /1   ]  38.0060341896        1
[INPUT] 0    0    [1    /1   ]  8.41622124419        1
[INPUT] 0    0    [1    /1   ]  3.37092020295        1
[INPUT] 1    0    [1    /1   ]  8.6035206923         1
[INPUT] 1    0    [1    /1   ]  0.49254793826        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26300941802523786, 1.0]], [0, [117616.81423507954, 1.0]], [0, [0.6678942557710973, 1.0]], [0, [1176168.1426188573, 1.0]], [0, [588084.0699923824, 1.0]], [0, [294042.0311308357, 1.0]], [0, [147020.99214367615, 1.0]], [0, [73510.4209535033, 1.0]], [0, [36754.71994913626, 1.0]], [0, [7303.469680929578, 1.0]], [0, [18375.810003213945, 1.0]], [0, [1449.7421575367935, 1.0]], [0, [374.01011079474216, 1.0]], [0, [113.39587314239267, 1.0]], [0, [38.00603418957377, 1.0]], [0, [8.41622124419053, 1.0]], [0, [3.3709202029519862, 1.0]], [1, [8.60352069230426, 1.0]], [1, [0.4925479382596131, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26300942]
bas 1, expnt(s) = [117616.81423508]
bas 2, expnt(s) = [0.66789426]
bas 3, expnt(s) = [1176168.14261886]
bas 4, expnt(s) = [588084.06999238]
bas 5, expnt(s) = [294042.03113084]
bas 6, expnt(s) = [147020.99214368]
bas 7, expnt(s) = [73510.4209535]
bas 8, expnt(s) = [36754.71994914]
bas 9, expnt(s) = [7303.46968093]
bas 10, expnt(s) = [18375.81000321]
bas 11, expnt(s) = [1449.74215754]
bas 12, expnt(s) = [374.01011079]
bas 13, expnt(s) = [113.39587314]
bas 14, expnt(s) = [38.00603419]
bas 15, expnt(s) = [8.41622124]
bas 16, expnt(s) = [3.3709202]
bas 17, expnt(s) = [8.60352069]
bas 18, expnt(s) = [0.49254794]
CPU time:       206.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63009418e-01 9.27883601e-01 1.17616814e+05 1.60460109e+04
 6.67894256e-01 1.86657655e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547199e+04 6.70656075e+03 7.30346968e+03 1.99600648e+03
 1.83758100e+04 3.98749263e+03 1.44974216e+03 5.93585250e+02
 3.74010111e+02 2.14870865e+02 1.13395873e+02 8.77936209e+01
 3.80060342e+01 3.86726952e+01 8.41622124e+00 1.24839748e+01
 3.37092020e+00 6.28530531e+00 8.60352069e+00 4.29862591e+01
 4.92547938e-01 1.20377418e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335795912820902
cond(S) = 907762.2996871409
E1 = -689.5595954389665  E_coul = 184.9580938557537
init E= -504.601501583213
    CPU time for initialize scf      0.19 sec, wall time      0.03 sec
  HOMO = -0.672542026295091  LUMO = 0.766387752099032
  mo_energy =
[-1.21705071e+02 -1.33853987e+01 -7.62445133e+00 -7.62445133e+00
 -7.62445133e+00 -1.65768132e+00 -6.72542026e-01 -6.72542026e-01
 -6.72542026e-01  7.66387752e-01  1.25778672e+01  1.13213776e+02
  6.07845807e+02  2.74718799e+03  1.22259433e+04  4.08472362e+04
  1.04890771e+05  2.30074147e+05  4.55889039e+05  8.44841263e+05
  1.52801849e+06  2.85028584e+06  5.80817307e+06]
E1 = -707.7253733033256  E_coul = 199.7699406527842
cycle= 1 E= -507.955432650541  delta_E= -3.35  |g|= 0.449  |ddm|= 0.511
    CPU time for cycle= 1      0.18 sec, wall time      0.01 sec
diis-norm(errvec)=0.62595
diis-c [-0.39181354  1.        ]
  HOMO = -0.218011235875864  LUMO = 1.17206604366994
  mo_energy =
[-1.20194684e+02 -1.23039094e+01 -6.59488343e+00 -6.59488343e+00
 -6.59488343e+00 -1.16329714e+00 -2.18011236e-01 -2.18011236e-01
 -2.18011236e-01  1.17206604e+00  1.35240734e+01  1.14614613e+02
  6.09342137e+02  2.74862350e+03  1.22272699e+04  4.08484964e+04
  1.04891994e+05  2.30075346e+05  4.55890221e+05  8.44842432e+05
  1.52801965e+06  2.85028699e+06  5.80817421e+06]
E1 = -706.7903413554794  E_coul = 198.81750132986917
cycle= 2 E= -507.97284002561  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258167
diis-c [-6.63577612e-04  2.72589557e-03  9.97274104e-01]
  HOMO = -0.239719058729198  LUMO = 1.16549211409551
  mo_energy =
[-1.20306814e+02 -1.23697689e+01 -6.66782057e+00 -6.66782057e+00
 -6.66782057e+00 -1.17727663e+00 -2.39719059e-01 -2.39719059e-01
 -2.39719059e-01  1.16549211e+00  1.34730152e+01  1.14520917e+02
  6.09226052e+02  2.74849148e+03  1.22271278e+04  4.08483506e+04
  1.04891847e+05  2.30075198e+05  4.55890072e+05  8.44842283e+05
  1.52801950e+06  2.85028684e+06  5.80817406e+06]
E1 = -706.6860179000939  E_coul = 198.7129297666032
cycle= 3 E= -507.973088133491  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0599
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292827
diis-c [-1.55304147e-06 -1.78123333e-04 -1.14581153e-01  1.11475928e+00]
  HOMO = -0.242852041487004  LUMO = 1.16431623625749
  mo_energy =
[-1.20318912e+02 -1.23784567e+01 -6.67702333e+00 -6.67702333e+00
 -6.67702333e+00 -1.17917366e+00 -2.42852041e-01 -2.42852041e-01
 -2.42852041e-01  1.16431624e+00  1.34660017e+01  1.14510140e+02
  6.09213780e+02  2.74847833e+03  1.22271141e+04  4.08483367e+04
  1.04891833e+05  2.30075184e+05  4.55890058e+05  8.44842269e+05
  1.52801949e+06  2.85028683e+06  5.80817405e+06]
E1 = -706.6710894119992  E_coul = 198.69799672930802
cycle= 4 E= -507.973092682691  delta_E= -4.55e-06  |g|= 0.000158  |ddm|= 0.00917
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108661
diis-c [-6.85793624e-11 -5.31581800e-06  7.35223972e-03 -9.12586938e-02
  1.08391177e+00]
  HOMO = -0.242956981081405  LUMO = 1.16427061623982
  mo_energy =
[-1.20319155e+02 -1.23787124e+01 -6.67727301e+00 -6.67727301e+00
 -6.67727301e+00 -1.17923526e+00 -2.42956981e-01 -2.42956981e-01
 -2.42956981e-01  1.16427062e+00  1.34657845e+01  1.14509894e+02
  6.09213538e+02  2.74847809e+03  1.22271138e+04  4.08483365e+04
  1.04891833e+05  2.30075184e+05  4.55890058e+05  8.44842269e+05
  1.52801949e+06  2.85028683e+06  5.80817404e+06]
E1 = -706.6705958708945  E_coul = 198.69750318273913
cycle= 5 E= -507.973092688155  delta_E= -5.46e-09  |g|= 2.57e-07  |ddm|= 0.000334
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.62207e-07
diis-c [-1.07398240e-14  1.81885017e-07 -9.08099244e-05  1.01382688e-03
 -1.13224025e-02  1.01039920e+00]
  HOMO = -0.242957028834844  LUMO = 1.16427076908822
  mo_energy =
[-1.20319156e+02 -1.23787126e+01 -6.67727333e+00 -6.67727333e+00
 -6.67727333e+00 -1.17923542e+00 -2.42957029e-01 -2.42957029e-01
 -2.42957029e-01  1.16427077e+00  1.34657843e+01  1.14509894e+02
  6.09213537e+02  2.74847809e+03  1.22271138e+04  4.08483365e+04
  1.04891833e+05  2.30075184e+05  4.55890058e+05  8.44842269e+05
  1.52801949e+06  2.85028683e+06  5.80817404e+06]
E1 = -706.67059546012  E_coul = 198.6975027719654
cycle= 6 E= -507.973092688155  delta_E= 7.96e-13  |g|= 1.33e-08  |ddm|= 1.69e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.67059546012  E_coul = 198.6975027719654
  HOMO = -0.242957022036318  LUMO = 1.16427076919641
  mo_energy =
[-1.20319156e+02 -1.23787126e+01 -6.67727332e+00 -6.67727332e+00
 -6.67727332e+00 -1.17923542e+00 -2.42957022e-01 -2.42957022e-01
 -2.42957022e-01  1.16427077e+00  1.34657844e+01  1.14509894e+02
  6.09213537e+02  2.74847809e+03  1.22271138e+04  4.08483365e+04
  1.04891833e+05  2.30075184e+05  4.55890058e+05  8.44842269e+05
  1.52801949e+06  2.85028683e+06  5.80817404e+06]
E1 = -706.6705954961145  E_coul = 198.69750280795955
Extra cycle  E= -507.973092688155  delta_E= -3.41e-13  |g|= 2.48e-09  |ddm|= 2.39e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.12 sec
exp = [2.63009418e-01 1.17616814e+05 6.67894256e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547199e+04 7.30346968e+03 1.83758100e+04 1.44974216e+03
 3.74010111e+02 1.13395873e+02 3.80060342e+01 8.41622124e+00
 3.37092020e+00 8.60352069e+00 4.92547938e-01]
E = -507.97309268815496
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263009418025       1
[INPUT] 0    0    [1    /1   ]  117616.814235        1
[INPUT] 0    0    [1    /1   ]  0.667894255771       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031131        1
[INPUT] 0    0    [1    /1   ]  147020.992144        1
[INPUT] 0    0    [1    /1   ]  73510.4209535        1
[INPUT] 0    0    [1    /1   ]  36754.7199491        1
[INPUT] 0    0    [1    /1   ]  7303.46968093        1
[INPUT] 0    0    [1    /1   ]  18375.8100032        1
[INPUT] 0    0    [1    /1   ]  1449.74215754        1
[INPUT] 0    0    [1    /1   ]  374.010110795        1
[INPUT] 0    0    [1    /1   ]  113.395873142        1
[INPUT] 0    0    [1    /1   ]  38.0060341896        1
[INPUT] 0    0    [1    /1   ]  8.41622124419        1
[INPUT] 0    0    [1    /1   ]  3.37092020295        1
[INPUT] 1    0    [1    /1   ]  8.6035206923         1
[INPUT] 1    0    [1    /1   ]  0.49254793826        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26300941802523786, 1.0]], [0, [117616.81423507954, 1.0]], [0, [0.6678942557710973, 1.0]], [0, [1176168.1426188573, 1.0]], [0, [588084.0699923824, 1.0]], [0, [294042.0311308357, 1.0]], [0, [147020.99214367615, 1.0]], [0, [73510.4209535033, 1.0]], [0, [36754.71994913626, 1.0]], [0, [7303.469680929578, 1.0]], [0, [18375.810003213945, 1.0]], [0, [1449.7421575367935, 1.0]], [0, [374.01011079474216, 1.0]], [0, [113.39587314239267, 1.0]], [0, [38.00603418957377, 1.0]], [0, [8.41622124419053, 1.0]], [0, [3.3709202029519862, 1.0]], [1, [8.60352069230426, 1.0]], [1, [0.4925479382596131, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26300942]
bas 1, expnt(s) = [117616.81423508]
bas 2, expnt(s) = [0.66789426]
bas 3, expnt(s) = [1176168.14261886]
bas 4, expnt(s) = [588084.06999238]
bas 5, expnt(s) = [294042.03113084]
bas 6, expnt(s) = [147020.99214368]
bas 7, expnt(s) = [73510.4209535]
bas 8, expnt(s) = [36754.71994914]
bas 9, expnt(s) = [7303.46968093]
bas 10, expnt(s) = [18375.81000321]
bas 11, expnt(s) = [1449.74215754]
bas 12, expnt(s) = [374.01011079]
bas 13, expnt(s) = [113.39587314]
bas 14, expnt(s) = [38.00603419]
bas 15, expnt(s) = [8.41622124]
bas 16, expnt(s) = [3.3709202]
bas 17, expnt(s) = [8.60352069]
bas 18, expnt(s) = [0.49254794]
CPU time:       207.13
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63009418e-01 9.27883601e-01 1.17616814e+05 1.60460109e+04
 6.67894256e-01 1.86657655e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547199e+04 6.70656075e+03 7.30346968e+03 1.99600648e+03
 1.83758100e+04 3.98749263e+03 1.44974216e+03 5.93585250e+02
 3.74010111e+02 2.14870865e+02 1.13395873e+02 8.77936209e+01
 3.80060342e+01 3.86726952e+01 8.41622124e+00 1.24839748e+01
 3.37092020e+00 6.28530531e+00 8.60352069e+00 4.29862591e+01
 4.92547938e-01 1.20377418e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335795912820902
cond(S) = 907762.2996871409
E1 = -689.5595954389665  E_coul = 184.9580938557537
init E= -504.601501583213
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672542026295091  LUMO = 0.766387752099032
  mo_energy =
[-1.21705071e+02 -1.33853987e+01 -7.62445133e+00 -7.62445133e+00
 -7.62445133e+00 -1.65768132e+00 -6.72542026e-01 -6.72542026e-01
 -6.72542026e-01  7.66387752e-01  1.25778672e+01  1.13213776e+02
  6.07845807e+02  2.74718799e+03  1.22259433e+04  4.08472362e+04
  1.04890771e+05  2.30074147e+05  4.55889039e+05  8.44841263e+05
  1.52801849e+06  2.85028584e+06  5.80817307e+06]
E1 = -707.7253733033256  E_coul = 199.7699406527842
cycle= 1 E= -507.955432650541  delta_E= -3.35  |g|= 0.449  |ddm|= 0.511
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.62595
diis-c [-0.39181354  1.        ]
  HOMO = -0.218011235875864  LUMO = 1.17206604366994
  mo_energy =
[-1.20194684e+02 -1.23039094e+01 -6.59488343e+00 -6.59488343e+00
 -6.59488343e+00 -1.16329714e+00 -2.18011236e-01 -2.18011236e-01
 -2.18011236e-01  1.17206604e+00  1.35240734e+01  1.14614613e+02
  6.09342137e+02  2.74862350e+03  1.22272699e+04  4.08484964e+04
  1.04891994e+05  2.30075346e+05  4.55890221e+05  8.44842432e+05
  1.52801965e+06  2.85028699e+06  5.80817421e+06]
E1 = -706.7903413554794  E_coul = 198.81750132986917
cycle= 2 E= -507.97284002561  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258167
diis-c [-6.63577612e-04  2.72589557e-03  9.97274104e-01]
  HOMO = -0.239719058729198  LUMO = 1.16549211409551
  mo_energy =
[-1.20306814e+02 -1.23697689e+01 -6.66782057e+00 -6.66782057e+00
 -6.66782057e+00 -1.17727663e+00 -2.39719059e-01 -2.39719059e-01
 -2.39719059e-01  1.16549211e+00  1.34730152e+01  1.14520917e+02
  6.09226052e+02  2.74849148e+03  1.22271278e+04  4.08483506e+04
  1.04891847e+05  2.30075198e+05  4.55890072e+05  8.44842283e+05
  1.52801950e+06  2.85028684e+06  5.80817406e+06]
E1 = -706.6860179000939  E_coul = 198.7129297666032
cycle= 3 E= -507.973088133491  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0599
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292827
diis-c [-1.55304147e-06 -1.78123333e-04 -1.14581153e-01  1.11475928e+00]
  HOMO = -0.242852041487004  LUMO = 1.16431623625749
  mo_energy =
[-1.20318912e+02 -1.23784567e+01 -6.67702333e+00 -6.67702333e+00
 -6.67702333e+00 -1.17917366e+00 -2.42852041e-01 -2.42852041e-01
 -2.42852041e-01  1.16431624e+00  1.34660017e+01  1.14510140e+02
  6.09213780e+02  2.74847833e+03  1.22271141e+04  4.08483367e+04
  1.04891833e+05  2.30075184e+05  4.55890058e+05  8.44842269e+05
  1.52801949e+06  2.85028683e+06  5.80817405e+06]
E1 = -706.6710894119992  E_coul = 198.69799672930802
cycle= 4 E= -507.973092682691  delta_E= -4.55e-06  |g|= 0.000158  |ddm|= 0.00917
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108661
diis-c [-6.85793624e-11 -5.31581800e-06  7.35223972e-03 -9.12586938e-02
  1.08391177e+00]
  HOMO = -0.242956981081405  LUMO = 1.16427061623982
  mo_energy =
[-1.20319155e+02 -1.23787124e+01 -6.67727301e+00 -6.67727301e+00
 -6.67727301e+00 -1.17923526e+00 -2.42956981e-01 -2.42956981e-01
 -2.42956981e-01  1.16427062e+00  1.34657845e+01  1.14509894e+02
  6.09213538e+02  2.74847809e+03  1.22271138e+04  4.08483365e+04
  1.04891833e+05  2.30075184e+05  4.55890058e+05  8.44842269e+05
  1.52801949e+06  2.85028683e+06  5.80817404e+06]
E1 = -706.6705958708945  E_coul = 198.69750318273913
cycle= 5 E= -507.973092688155  delta_E= -5.46e-09  |g|= 2.57e-07  |ddm|= 0.000334
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.62207e-07
diis-c [-1.07398240e-14  1.81885017e-07 -9.08099244e-05  1.01382688e-03
 -1.13224025e-02  1.01039920e+00]
  HOMO = -0.242957028834844  LUMO = 1.16427076908822
  mo_energy =
[-1.20319156e+02 -1.23787126e+01 -6.67727333e+00 -6.67727333e+00
 -6.67727333e+00 -1.17923542e+00 -2.42957029e-01 -2.42957029e-01
 -2.42957029e-01  1.16427077e+00  1.34657843e+01  1.14509894e+02
  6.09213537e+02  2.74847809e+03  1.22271138e+04  4.08483365e+04
  1.04891833e+05  2.30075184e+05  4.55890058e+05  8.44842269e+05
  1.52801949e+06  2.85028683e+06  5.80817404e+06]
E1 = -706.67059546012  E_coul = 198.6975027719654
cycle= 6 E= -507.973092688155  delta_E= 7.96e-13  |g|= 1.33e-08  |ddm|= 1.69e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.67059546012  E_coul = 198.6975027719654
  HOMO = -0.242957022036318  LUMO = 1.16427076919641
  mo_energy =
[-1.20319156e+02 -1.23787126e+01 -6.67727332e+00 -6.67727332e+00
 -6.67727332e+00 -1.17923542e+00 -2.42957022e-01 -2.42957022e-01
 -2.42957022e-01  1.16427077e+00  1.34657844e+01  1.14509894e+02
  6.09213537e+02  2.74847809e+03  1.22271138e+04  4.08483365e+04
  1.04891833e+05  2.30075184e+05  4.55890058e+05  8.44842269e+05
  1.52801949e+06  2.85028683e+06  5.80817404e+06]
E1 = -706.6705954961145  E_coul = 198.69750280795955
Extra cycle  E= -507.973092688155  delta_E= -3.41e-13  |g|= 2.48e-09  |ddm|= 2.39e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907762.2996871409
E1 = -706.6705954961145  E_coul = 198.69750280795955
init E= -507.973092688155
    CPU time for initialize scf      1.43 sec, wall time      0.09 sec
  HOMO = -0.242957021027184  LUMO = 1.16427076694979
  mo_energy =
[-1.20319156e+02 -1.23787126e+01 -6.67727331e+00 -6.67727331e+00
 -6.67727331e+00 -1.17923542e+00 -2.42957021e-01 -2.42957021e-01
 -2.42957021e-01  1.16427077e+00  1.34657844e+01  1.14509894e+02
  6.09213537e+02  2.74847809e+03  1.22271138e+04  4.08483365e+04
  1.04891833e+05  2.30075184e+05  4.55890058e+05  8.44842269e+05
  1.52801949e+06  2.85028683e+06  5.80817404e+06]
E1 = -706.6705955007789  E_coul = 198.69750281262412
cycle= 1 E= -507.973092688155  delta_E= 2.27e-13  |g|= 2.24e-09  |ddm|= 3.25e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6705955007789  E_coul = 198.69750281262412
  HOMO = -0.242957020878156  LUMO = 1.16427076901629
  mo_energy =
[-1.20319156e+02 -1.23787126e+01 -6.67727331e+00 -6.67727331e+00
 -6.67727331e+00 -1.17923542e+00 -2.42957021e-01 -2.42957021e-01
 -2.42957021e-01  1.16427077e+00  1.34657844e+01  1.14509894e+02
  6.09213537e+02  2.74847809e+03  1.22271138e+04  4.08483365e+04
  1.04891833e+05  2.30075184e+05  4.55890058e+05  8.44842269e+05
  1.52801949e+06  2.85028683e+06  5.80817404e+06]
E1 = -706.6705955013099  E_coul = 198.69750281315484
Extra cycle  E= -507.973092688155  delta_E= -2.84e-13  |g|= 8.39e-10  |ddm|= 5.29e-10
    CPU time for scf_cycle      1.60 sec, wall time      0.16 sec
exp = [2.63009418e-01 1.17616814e+05 6.67894256e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104210e+04
 3.67547199e+04 7.30346968e+03 1.83758100e+04 1.44974216e+03
 3.74010111e+02 1.13395873e+02 3.80060342e+01 8.41622124e+00
 3.37092020e+00 8.60352069e+00 4.92547938e-01]
grad_E = [ 5.16361353e-04  4.19843027e-09 -3.05216398e-04  1.89518898e-11
  1.13292165e-10  6.53204677e-10  2.56179510e-09  1.06434887e-08
  5.72399205e-08  3.60314453e-06  1.23245203e-07  4.10882582e-06
  1.36860585e-05 -1.75622423e-04  1.92100854e-04  1.64324281e-04
 -4.91648439e-04 -1.69178918e-05 -9.54421639e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263230823729       1
[INPUT] 0    0    [1    /1   ]  117616.81423         1
[INPUT] 0    0    [1    /1   ]  0.668407041597       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.03113         1
[INPUT] 0    0    [1    /1   ]  147020.992141        1
[INPUT] 0    0    [1    /1   ]  73510.4209411        1
[INPUT] 0    0    [1    /1   ]  36754.7198822        1
[INPUT] 0    0    [1    /1   ]  7303.46546659        1
[INPUT] 0    0    [1    /1   ]  18375.809859         1
[INPUT] 0    0    [1    /1   ]  1449.73774666        1
[INPUT] 0    0    [1    /1   ]  373.993367286        1
[INPUT] 0    0    [1    /1   ]  113.539207996        1
[INPUT] 0    0    [1    /1   ]  38.0724717341        1
[INPUT] 0    0    [1    /1   ]  8.41720780482        1
[INPUT] 0    0    [1    /1   ]  3.3727684343         1
[INPUT] 1    0    [1    /1   ]  8.60350373788        1
[INPUT] 1    0    [1    /1   ]  0.492545287197       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2632308237292294, 1.0]], [0, [117616.81423016921, 1.0]], [0, [0.668407041596717, 1.0]], [0, [1176168.1426188352, 1.0]], [0, [588084.0699922498, 1.0]], [0, [294042.03113007173, 1.0]], [0, [147020.9921406799, 1.0]], [0, [73510.42094105441, 1.0]], [0, [36754.719882198544, 1.0]], [0, [7303.465466586281, 1.0]], [0, [18375.809858976012, 1.0]], [0, [1449.737746662077, 1.0]], [0, [373.99336728647256, 1.0]], [0, [113.53920799593752, 1.0]], [0, [38.07247173405938, 1.0]], [0, [8.417207804817377, 1.0]], [0, [3.3727684343011144, 1.0]], [1, [8.603503737877887, 1.0]], [1, [0.49254528719675933, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26323082]
bas 1, expnt(s) = [117616.81423017]
bas 2, expnt(s) = [0.66840704]
bas 3, expnt(s) = [1176168.14261884]
bas 4, expnt(s) = [588084.06999225]
bas 5, expnt(s) = [294042.03113007]
bas 6, expnt(s) = [147020.99214068]
bas 7, expnt(s) = [73510.42094105]
bas 8, expnt(s) = [36754.7198822]
bas 9, expnt(s) = [7303.46546659]
bas 10, expnt(s) = [18375.80985898]
bas 11, expnt(s) = [1449.73774666]
bas 12, expnt(s) = [373.99336729]
bas 13, expnt(s) = [113.539208]
bas 14, expnt(s) = [38.07247173]
bas 15, expnt(s) = [8.4172078]
bas 16, expnt(s) = [3.37276843]
bas 17, expnt(s) = [8.60350374]
bas 18, expnt(s) = [0.49254529]
CPU time:       211.93
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63230824e-01 9.28469371e-01 1.17616814e+05 1.60460109e+04
 6.68407042e-01 1.86765127e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547199e+04 6.70656074e+03 7.30346547e+03 1.99600562e+03
 1.83758099e+04 3.98749260e+03 1.44973775e+03 5.93583895e+02
 3.73993367e+02 2.14863650e+02 1.13539208e+02 8.78768376e+01
 3.80724717e+01 3.87233863e+01 8.41720780e+00 1.24850723e+01
 3.37276843e+00 6.28788974e+00 8.60350374e+00 4.29861532e+01
 4.92545287e-01 1.20376608e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335794312977974
cond(S) = 907768.7802098325
E1 = -689.5596752381703  E_coul = 184.95797291206387
init E= -504.601702326106
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672545030713954  LUMO = 0.767727890476345
  mo_energy =
[-1.21705095e+02 -1.33854118e+01 -7.62445758e+00 -7.62445758e+00
 -7.62445758e+00 -1.65768615e+00 -6.72545031e-01 -6.72545031e-01
 -6.72545031e-01  7.67727890e-01  1.25899797e+01  1.13415220e+02
  6.08447708e+02  2.74790859e+03  1.22265926e+04  4.08478320e+04
  1.04891337e+05  2.30074695e+05  4.55889574e+05  8.44841789e+05
  1.52801901e+06  2.85028635e+06  5.80817356e+06]
E1 = -707.7255469384553  E_coul = 199.7701050507124
cycle= 1 E= -507.955441887743  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625979
diis-c [-0.39185026  1.        ]
  HOMO = -0.218014760776603  LUMO = 1.17363862440416
  mo_energy =
[-1.20194630e+02 -1.23039075e+01 -6.59487238e+00 -6.59487238e+00
 -6.59487238e+00 -1.16329885e+00 -2.18014761e-01 -2.18014761e-01
 -2.18014761e-01  1.17363862e+00  1.35364286e+01  1.14816368e+02
  6.09944160e+02  2.74934426e+03  1.22279193e+04  4.08490923e+04
  1.04892561e+05  2.30075894e+05  4.55890756e+05  8.44842958e+05
  1.52802017e+06  2.85028750e+06  5.80817470e+06]
E1 = -706.7904952909468  E_coul = 198.81764523038012
cycle= 2 E= -507.972850060567  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258073
diis-c [-6.63061016e-04  2.74129490e-03  9.97258705e-01]
  HOMO = -0.239720536333572  LUMO = 1.16705495229569
  mo_energy =
[-1.20306763e+02 -1.23697684e+01 -6.66781133e+00 -6.66781133e+00
 -6.66781133e+00 -1.17727674e+00 -2.39720536e-01 -2.39720536e-01
 -2.39720536e-01  1.16705495e+00  1.34853492e+01  1.14722638e+02
  6.09828065e+02  2.74921224e+03  1.22277772e+04  4.08489465e+04
  1.04892413e+05  2.30075746e+05  4.55890608e+05  8.44842809e+05
  1.52802002e+06  2.85028735e+06  5.80817455e+06]
E1 = -706.6862072340195  E_coul = 198.71310923019004
cycle= 3 E= -507.973098003829  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0599
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292668
diis-c [-1.55082993e-06 -1.78271372e-04 -1.14565002e-01  1.11474327e+00]
  HOMO = -0.242852178421932  LUMO = 1.16587811108259
  mo_energy =
[-1.20318860e+02 -1.23784544e+01 -6.67701236e+00 -6.67701236e+00
 -6.67701236e+00 -1.17917290e+00 -2.42852178e-01 -2.42852178e-01
 -2.42852178e-01  1.16587811e+00  1.34783354e+01  1.14711860e+02
  6.09815793e+02  2.74919908e+03  1.22277636e+04  4.08489326e+04
  1.04892399e+05  2.30075732e+05  4.55890594e+05  8.44842795e+05
  1.52802001e+06  2.85028734e+06  5.80817454e+06]
E1 = -706.6712884519519  E_coul = 198.69818590499094
cycle= 4 E= -507.973102546961  delta_E= -4.54e-06  |g|= 0.000158  |ddm|= 0.00916
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00010853
diis-c [-6.84762109e-11 -5.30341554e-06  7.35132838e-03 -9.12299903e-02
  1.08388397e+00]
  HOMO = -0.242956942527533  LUMO = 1.16583251543631
  mo_energy =
[-1.20319103e+02 -1.23787096e+01 -6.67726167e+00 -6.67726167e+00
 -6.67726167e+00 -1.17923440e+00 -2.42956943e-01 -2.42956943e-01
 -2.42956943e-01  1.16583252e+00  1.34781185e+01  1.14711615e+02
  6.09815552e+02  2.74919885e+03  1.22277633e+04  4.08489324e+04
  1.04892399e+05  2.30075732e+05  4.55890594e+05  8.44842795e+05
  1.52802001e+06  2.85028734e+06  5.80817454e+06]
E1 = -706.6707958546006  E_coul = 198.69769330219597
cycle= 5 E= -507.973102552405  delta_E= -5.44e-09  |g|= 2.57e-07  |ddm|= 0.000333
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.60673e-07
diis-c [-1.08696558e-14  1.78562366e-07 -9.05970208e-05  1.01163030e-03
 -1.12928928e-02  1.01037168e+00]
  HOMO = -0.242956988281423  LUMO = 1.16583266994794
  mo_energy =
[-1.20319104e+02 -1.23787099e+01 -6.67726199e+00 -6.67726199e+00
 -6.67726199e+00 -1.17923456e+00 -2.42956988e-01 -2.42956988e-01
 -2.42956988e-01  1.16583267e+00  1.34781184e+01  1.14711614e+02
  6.09815551e+02  2.74919884e+03  1.22277633e+04  4.08489324e+04
  1.04892399e+05  2.30075732e+05  4.55890594e+05  8.44842795e+05
  1.52802001e+06  2.85028734e+06  5.80817454e+06]
E1 = -706.6707954532103  E_coul = 198.69769290080595
cycle= 6 E= -507.973102552404  delta_E= 2.27e-13  |g|= 1.33e-08  |ddm|= 1.64e-07
    CPU time for cycle= 6      0.02 sec, wall time      0.02 sec
E1 = -706.6707954532103  E_coul = 198.69769290080595
  HOMO = -0.242956981413662  LUMO = 1.16583266981487
  mo_energy =
[-1.20319104e+02 -1.23787099e+01 -6.67726197e+00 -6.67726197e+00
 -6.67726197e+00 -1.17923455e+00 -2.42956981e-01 -2.42956981e-01
 -2.42956981e-01  1.16583267e+00  1.34781184e+01  1.14711614e+02
  6.09815551e+02  2.74919884e+03  1.22277633e+04  4.08489324e+04
  1.04892399e+05  2.30075732e+05  4.55890594e+05  8.44842795e+05
  1.52802001e+06  2.85028734e+06  5.80817454e+06]
E1 = -706.6707954881906  E_coul = 198.6976929357865
Extra cycle  E= -507.973102552404  delta_E= 2.84e-13  |g|= 2.39e-09  |ddm|= 2.34e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.12 sec
exp = [2.63230824e-01 1.17616814e+05 6.68407042e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547199e+04 7.30346547e+03 1.83758099e+04 1.44973775e+03
 3.73993367e+02 1.13539208e+02 3.80724717e+01 8.41720780e+00
 3.37276843e+00 8.60350374e+00 4.92545287e-01]
E = -507.9731025524041
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263230823729       1
[INPUT] 0    0    [1    /1   ]  117616.81423         1
[INPUT] 0    0    [1    /1   ]  0.668407041597       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.03113         1
[INPUT] 0    0    [1    /1   ]  147020.992141        1
[INPUT] 0    0    [1    /1   ]  73510.4209411        1
[INPUT] 0    0    [1    /1   ]  36754.7198822        1
[INPUT] 0    0    [1    /1   ]  7303.46546659        1
[INPUT] 0    0    [1    /1   ]  18375.809859         1
[INPUT] 0    0    [1    /1   ]  1449.73774666        1
[INPUT] 0    0    [1    /1   ]  373.993367286        1
[INPUT] 0    0    [1    /1   ]  113.539207996        1
[INPUT] 0    0    [1    /1   ]  38.0724717341        1
[INPUT] 0    0    [1    /1   ]  8.41720780482        1
[INPUT] 0    0    [1    /1   ]  3.3727684343         1
[INPUT] 1    0    [1    /1   ]  8.60350373788        1
[INPUT] 1    0    [1    /1   ]  0.492545287197       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2632308237292294, 1.0]], [0, [117616.81423016921, 1.0]], [0, [0.668407041596717, 1.0]], [0, [1176168.1426188352, 1.0]], [0, [588084.0699922498, 1.0]], [0, [294042.03113007173, 1.0]], [0, [147020.9921406799, 1.0]], [0, [73510.42094105441, 1.0]], [0, [36754.719882198544, 1.0]], [0, [7303.465466586281, 1.0]], [0, [18375.809858976012, 1.0]], [0, [1449.737746662077, 1.0]], [0, [373.99336728647256, 1.0]], [0, [113.53920799593752, 1.0]], [0, [38.07247173405938, 1.0]], [0, [8.417207804817377, 1.0]], [0, [3.3727684343011144, 1.0]], [1, [8.603503737877887, 1.0]], [1, [0.49254528719675933, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26323082]
bas 1, expnt(s) = [117616.81423017]
bas 2, expnt(s) = [0.66840704]
bas 3, expnt(s) = [1176168.14261884]
bas 4, expnt(s) = [588084.06999225]
bas 5, expnt(s) = [294042.03113007]
bas 6, expnt(s) = [147020.99214068]
bas 7, expnt(s) = [73510.42094105]
bas 8, expnt(s) = [36754.7198822]
bas 9, expnt(s) = [7303.46546659]
bas 10, expnt(s) = [18375.80985898]
bas 11, expnt(s) = [1449.73774666]
bas 12, expnt(s) = [373.99336729]
bas 13, expnt(s) = [113.539208]
bas 14, expnt(s) = [38.07247173]
bas 15, expnt(s) = [8.4172078]
bas 16, expnt(s) = [3.37276843]
bas 17, expnt(s) = [8.60350374]
bas 18, expnt(s) = [0.49254529]
CPU time:       212.53
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63230824e-01 9.28469371e-01 1.17616814e+05 1.60460109e+04
 6.68407042e-01 1.86765127e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547199e+04 6.70656074e+03 7.30346547e+03 1.99600562e+03
 1.83758099e+04 3.98749260e+03 1.44973775e+03 5.93583895e+02
 3.73993367e+02 2.14863650e+02 1.13539208e+02 8.78768376e+01
 3.80724717e+01 3.87233863e+01 8.41720780e+00 1.24850723e+01
 3.37276843e+00 6.28788974e+00 8.60350374e+00 4.29861532e+01
 4.92545287e-01 1.20376608e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335794312977974
cond(S) = 907768.7802098325
E1 = -689.5596752381703  E_coul = 184.95797291206387
init E= -504.601702326106
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672545030713954  LUMO = 0.767727890476345
  mo_energy =
[-1.21705095e+02 -1.33854118e+01 -7.62445758e+00 -7.62445758e+00
 -7.62445758e+00 -1.65768615e+00 -6.72545031e-01 -6.72545031e-01
 -6.72545031e-01  7.67727890e-01  1.25899797e+01  1.13415220e+02
  6.08447708e+02  2.74790859e+03  1.22265926e+04  4.08478320e+04
  1.04891337e+05  2.30074695e+05  4.55889574e+05  8.44841789e+05
  1.52801901e+06  2.85028635e+06  5.80817356e+06]
E1 = -707.7255469384553  E_coul = 199.7701050507124
cycle= 1 E= -507.955441887743  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625979
diis-c [-0.39185026  1.        ]
  HOMO = -0.218014760776603  LUMO = 1.17363862440416
  mo_energy =
[-1.20194630e+02 -1.23039075e+01 -6.59487238e+00 -6.59487238e+00
 -6.59487238e+00 -1.16329885e+00 -2.18014761e-01 -2.18014761e-01
 -2.18014761e-01  1.17363862e+00  1.35364286e+01  1.14816368e+02
  6.09944160e+02  2.74934426e+03  1.22279193e+04  4.08490923e+04
  1.04892561e+05  2.30075894e+05  4.55890756e+05  8.44842958e+05
  1.52802017e+06  2.85028750e+06  5.80817470e+06]
E1 = -706.7904952909468  E_coul = 198.81764523038012
cycle= 2 E= -507.972850060567  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258073
diis-c [-6.63061016e-04  2.74129490e-03  9.97258705e-01]
  HOMO = -0.239720536333572  LUMO = 1.16705495229569
  mo_energy =
[-1.20306763e+02 -1.23697684e+01 -6.66781133e+00 -6.66781133e+00
 -6.66781133e+00 -1.17727674e+00 -2.39720536e-01 -2.39720536e-01
 -2.39720536e-01  1.16705495e+00  1.34853492e+01  1.14722638e+02
  6.09828065e+02  2.74921224e+03  1.22277772e+04  4.08489465e+04
  1.04892413e+05  2.30075746e+05  4.55890608e+05  8.44842809e+05
  1.52802002e+06  2.85028735e+06  5.80817455e+06]
E1 = -706.6862072340195  E_coul = 198.71310923019004
cycle= 3 E= -507.973098003829  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0599
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292668
diis-c [-1.55082993e-06 -1.78271372e-04 -1.14565002e-01  1.11474327e+00]
  HOMO = -0.242852178421932  LUMO = 1.16587811108259
  mo_energy =
[-1.20318860e+02 -1.23784544e+01 -6.67701236e+00 -6.67701236e+00
 -6.67701236e+00 -1.17917290e+00 -2.42852178e-01 -2.42852178e-01
 -2.42852178e-01  1.16587811e+00  1.34783354e+01  1.14711860e+02
  6.09815793e+02  2.74919908e+03  1.22277636e+04  4.08489326e+04
  1.04892399e+05  2.30075732e+05  4.55890594e+05  8.44842795e+05
  1.52802001e+06  2.85028734e+06  5.80817454e+06]
E1 = -706.6712884519519  E_coul = 198.69818590499094
cycle= 4 E= -507.973102546961  delta_E= -4.54e-06  |g|= 0.000158  |ddm|= 0.00916
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00010853
diis-c [-6.84762109e-11 -5.30341554e-06  7.35132838e-03 -9.12299903e-02
  1.08388397e+00]
  HOMO = -0.242956942527533  LUMO = 1.16583251543631
  mo_energy =
[-1.20319103e+02 -1.23787096e+01 -6.67726167e+00 -6.67726167e+00
 -6.67726167e+00 -1.17923440e+00 -2.42956943e-01 -2.42956943e-01
 -2.42956943e-01  1.16583252e+00  1.34781185e+01  1.14711615e+02
  6.09815552e+02  2.74919885e+03  1.22277633e+04  4.08489324e+04
  1.04892399e+05  2.30075732e+05  4.55890594e+05  8.44842795e+05
  1.52802001e+06  2.85028734e+06  5.80817454e+06]
E1 = -706.6707958546006  E_coul = 198.69769330219597
cycle= 5 E= -507.973102552405  delta_E= -5.44e-09  |g|= 2.57e-07  |ddm|= 0.000333
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.60673e-07
diis-c [-1.08696558e-14  1.78562366e-07 -9.05970208e-05  1.01163030e-03
 -1.12928928e-02  1.01037168e+00]
  HOMO = -0.242956988281423  LUMO = 1.16583266994794
  mo_energy =
[-1.20319104e+02 -1.23787099e+01 -6.67726199e+00 -6.67726199e+00
 -6.67726199e+00 -1.17923456e+00 -2.42956988e-01 -2.42956988e-01
 -2.42956988e-01  1.16583267e+00  1.34781184e+01  1.14711614e+02
  6.09815551e+02  2.74919884e+03  1.22277633e+04  4.08489324e+04
  1.04892399e+05  2.30075732e+05  4.55890594e+05  8.44842795e+05
  1.52802001e+06  2.85028734e+06  5.80817454e+06]
E1 = -706.6707954532103  E_coul = 198.69769290080595
cycle= 6 E= -507.973102552404  delta_E= 2.27e-13  |g|= 1.33e-08  |ddm|= 1.64e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6707954532103  E_coul = 198.69769290080595
  HOMO = -0.242956981413662  LUMO = 1.16583266981487
  mo_energy =
[-1.20319104e+02 -1.23787099e+01 -6.67726197e+00 -6.67726197e+00
 -6.67726197e+00 -1.17923455e+00 -2.42956981e-01 -2.42956981e-01
 -2.42956981e-01  1.16583267e+00  1.34781184e+01  1.14711614e+02
  6.09815551e+02  2.74919884e+03  1.22277633e+04  4.08489324e+04
  1.04892399e+05  2.30075732e+05  4.55890594e+05  8.44842795e+05
  1.52802001e+06  2.85028734e+06  5.80817454e+06]
E1 = -706.6707954881906  E_coul = 198.6976929357865
Extra cycle  E= -507.973102552404  delta_E= 2.84e-13  |g|= 2.39e-09  |ddm|= 2.34e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907768.7802098325
E1 = -706.6707954881906  E_coul = 198.6976929357865
init E= -507.973102552404
    CPU time for initialize scf      1.59 sec, wall time      0.10 sec
  HOMO = -0.242956980424283  LUMO = 1.16583266748915
  mo_energy =
[-1.20319104e+02 -1.23787099e+01 -6.67726197e+00 -6.67726197e+00
 -6.67726197e+00 -1.17923455e+00 -2.42956980e-01 -2.42956980e-01
 -2.42956980e-01  1.16583267e+00  1.34781184e+01  1.14711614e+02
  6.09815551e+02  2.74919884e+03  1.22277633e+04  4.08489324e+04
  1.04892399e+05  2.30075732e+05  4.55890594e+05  8.44842795e+05
  1.52802001e+06  2.85028734e+06  5.80817454e+06]
E1 = -706.6707954936397  E_coul = 198.6976929412352
cycle= 1 E= -507.973102552404  delta_E= -3.98e-13  |g|= 2.41e-09  |ddm|= 3.65e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6707954936397  E_coul = 198.6976929412352
  HOMO = -0.242956980257732  LUMO = 1.16583267095384
  mo_energy =
[-1.20319104e+02 -1.23787099e+01 -6.67726197e+00 -6.67726197e+00
 -6.67726197e+00 -1.17923455e+00 -2.42956980e-01 -2.42956980e-01
 -2.42956980e-01  1.16583267e+00  1.34781184e+01  1.14711614e+02
  6.09815551e+02  2.74919884e+03  1.22277633e+04  4.08489324e+04
  1.04892399e+05  2.30075732e+05  4.55890594e+05  8.44842795e+05
  1.52802001e+06  2.85028734e+06  5.80817454e+06]
E1 = -706.6707954938696  E_coul = 198.6976929414652
Extra cycle  E= -507.973102552404  delta_E= 1.14e-13  |g|= 2.18e-09  |ddm|= 7.64e-10
    CPU time for scf_cycle      1.76 sec, wall time      0.17 sec
exp = [2.63230824e-01 1.17616814e+05 6.68407042e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547199e+04 7.30346547e+03 1.83758099e+04 1.44973775e+03
 3.73993367e+02 1.13539208e+02 3.80724717e+01 8.41720780e+00
 3.37276843e+00 8.60350374e+00 4.92545287e-01]
grad_E = [ 5.30432933e-04  4.17573205e-09 -3.10953762e-04  1.86822946e-11
  1.12554996e-10  6.49691608e-10  2.54776672e-09  1.05843527e-08
  5.69485112e-08  3.58252924e-06  1.22357785e-07  5.21592712e-06
  1.62145767e-06 -1.51043927e-04  2.45103947e-04  1.48495189e-04
 -5.15817168e-04 -1.74638163e-05 -9.84836506e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263622248636       1
[INPUT] 0    0    [1    /1   ]  117616.814225        1
[INPUT] 0    0    [1    /1   ]  0.669636609579       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031129        1
[INPUT] 0    0    [1    /1   ]  147020.992138        1
[INPUT] 0    0    [1    /1   ]  73510.4209289        1
[INPUT] 0    0    [1    /1   ]  36754.7198167        1
[INPUT] 0    0    [1    /1   ]  7303.46134528        1
[INPUT] 0    0    [1    /1   ]  18375.8097179        1
[INPUT] 0    0    [1    /1   ]  1449.73352412        1
[INPUT] 0    0    [1    /1   ]  373.97571398         1
[INPUT] 0    0    [1    /1   ]  113.687512057        1
[INPUT] 0    0    [1    /1   ]  38.1183734189        1
[INPUT] 0    0    [1    /1   ]  8.41511329175        1
[INPUT] 0    0    [1    /1   ]  3.37445548106        1
[INPUT] 1    0    [1    /1   ]  8.60351746814        1
[INPUT] 1    0    [1    /1   ]  0.492553641046       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2636222486355232, 1.0]], [0, [117616.81422536742, 1.0]], [0, [0.6696366095788303, 1.0]], [0, [1176168.1426188136, 1.0]], [0, [588084.0699921201, 1.0]], [0, [294042.03112932463, 1.0]], [0, [147020.99213774985, 1.0]], [0, [73510.42092888053, 1.0]], [0, [36754.71981674152, 1.0]], [0, [7303.461345281593, 1.0]], [0, [18375.809717909375, 1.0]], [0, [1449.733524119333, 1.0]], [0, [373.97571398024195, 1.0]], [0, [113.68751205735803, 1.0]], [0, [38.11837341885999, 1.0]], [0, [8.415113291746342, 1.0]], [0, [3.374455481064677, 1.0]], [1, [8.603517468140014, 1.0]], [1, [0.4925536410456703, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26362225]
bas 1, expnt(s) = [117616.81422537]
bas 2, expnt(s) = [0.66963661]
bas 3, expnt(s) = [1176168.14261881]
bas 4, expnt(s) = [588084.06999212]
bas 5, expnt(s) = [294042.03112932]
bas 6, expnt(s) = [147020.99213775]
bas 7, expnt(s) = [73510.42092888]
bas 8, expnt(s) = [36754.71981674]
bas 9, expnt(s) = [7303.46134528]
bas 10, expnt(s) = [18375.80971791]
bas 11, expnt(s) = [1449.73352412]
bas 12, expnt(s) = [373.97571398]
bas 13, expnt(s) = [113.68751206]
bas 14, expnt(s) = [38.11837342]
bas 15, expnt(s) = [8.41511329]
bas 16, expnt(s) = [3.37445548]
bas 17, expnt(s) = [8.60351747]
bas 18, expnt(s) = [0.49255364]
CPU time:       217.48
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63622249e-01 9.29504656e-01 1.17616814e+05 1.60460109e+04
 6.69636610e-01 1.87022740e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547198e+04 6.70656073e+03 7.30346135e+03 1.99600477e+03
 1.83758097e+04 3.98749258e+03 1.44973352e+03 5.93582598e+02
 3.73975714e+02 2.14856044e+02 1.13687512e+02 8.79629116e+01
 3.81183734e+01 3.87583959e+01 8.41511329e+00 1.24827422e+01
 3.37445548e+00 6.29024848e+00 8.60351747e+00 4.29862390e+01
 4.92553641e-01 1.20379160e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335776635665304
cond(S) = 907774.5936322837
E1 = -689.5606993491165  E_coul = 184.9583937229356
init E= -504.602305626181
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.672532319831435  LUMO = 0.770431082337934
  mo_energy =
[-1.21705064e+02 -1.33853750e+01 -7.62442964e+00 -7.62442964e+00
 -7.62442964e+00 -1.65767783e+00 -6.72532320e-01 -6.72532320e-01
 -6.72532320e-01  7.70431082e-01  1.26017946e+01  1.13570458e+02
  6.08976516e+02  2.74856094e+03  1.22271819e+04  4.08483723e+04
  1.04891850e+05  2.30075191e+05  4.55890059e+05  8.44842266e+05
  1.52801948e+06  2.85028681e+06  5.80817401e+06]
E1 = -707.7265588913635  E_coul = 199.77111337091694
cycle= 1 E= -507.955445520447  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.18 sec, wall time      0.01 sec
diis-norm(errvec)=0.625984
diis-c [-0.39185583  1.        ]
  HOMO = -0.217994550663607  LUMO = 1.17680789464117
  mo_energy =
[-1.20194527e+02 -1.23038255e+01 -6.59479402e+00 -6.59479402e+00
 -6.59479402e+00 -1.16328009e+00 -2.17994551e-01 -2.17994551e-01
 -2.17994551e-01  1.17680789e+00  1.35483709e+01  1.14971873e+02
  6.10473054e+02  2.74999672e+03  1.22285088e+04  4.08496327e+04
  1.04893074e+05  2.30076391e+05  4.55891241e+05  8.44843435e+05
  1.52802064e+06  2.85028796e+06  5.80817515e+06]
E1 = -706.7913259471956  E_coul = 198.81846710223468
cycle= 2 E= -507.972858844961  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257983
diis-c [-6.62568523e-04  2.75459147e-03  9.97245409e-01]
  HOMO = -0.239700732008524  LUMO = 1.17020385063203
  mo_energy =
[-1.20306681e+02 -1.23697019e+01 -6.66774937e+00 -6.66774937e+00
 -6.66774937e+00 -1.17725743e+00 -2.39700732e-01 -2.39700732e-01
 -2.39700732e-01  1.17020385e+00  1.34972639e+01  1.14878099e+02
  6.10356931e+02  2.74986468e+03  1.22283667e+04  4.08494869e+04
  1.04892927e+05  2.30076243e+05  4.55891093e+05  8.44843286e+05
  1.52802049e+06  2.85028781e+06  5.80817500e+06]
E1 = -706.6870948906036  E_coul = 198.71398840314805
cycle= 3 E= -507.973106487456  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292426
diis-c [-1.54782477e-06 -1.77856884e-04 -1.14509175e-01  1.11468703e+00]
  HOMO = -0.242829690094921  LUMO = 1.16902510044979
  mo_energy =
[-1.20318774e+02 -1.23783840e+01 -6.67694664e+00 -6.67694664e+00
 -6.67694664e+00 -1.17915178e+00 -2.42829690e-01 -2.42829690e-01
 -2.42829690e-01  1.16902510e+00  1.34902522e+01  1.14867323e+02
  6.10344663e+02  2.74985153e+03  1.22283530e+04  4.08494731e+04
  1.04892913e+05  2.30076229e+05  4.55891079e+05  8.44843272e+05
  1.52802047e+06  2.85028779e+06  5.80817498e+06]
E1 = -706.6721967934827  E_coul = 198.69908577605622
cycle= 4 E= -507.973111017427  delta_E= -4.53e-06  |g|= 0.000157  |ddm|= 0.00915
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108306
diis-c [-6.83546087e-11 -5.28633497e-06  7.34611154e-03 -9.11574937e-02
  1.08381667e+00]
  HOMO = -0.242934116411892  LUMO = 1.16897955201609
  mo_energy =
[-1.20319016e+02 -1.23786386e+01 -6.67719524e+00 -6.67719524e+00
 -6.67719524e+00 -1.17921308e+00 -2.42934116e-01 -2.42934116e-01
 -2.42934116e-01  1.16897955e+00  1.34900360e+01  1.14867078e+02
  6.10344422e+02  2.74985129e+03  1.22283528e+04  4.08494728e+04
  1.04892913e+05  2.30076228e+05  4.55891079e+05  8.44843272e+05
  1.52802047e+06  2.85028779e+06  5.80817498e+06]
E1 = -706.6717060602733  E_coul = 198.6985950374435
cycle= 5 E= -507.97311102283  delta_E= -5.4e-09  |g|= 2.57e-07  |ddm|= 0.000332
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.59844e-07
diis-c [-1.11296534e-14  1.78412691e-07 -9.04972886e-05  1.01103539e-03
 -1.12857257e-02  1.01036501e+00]
  HOMO = -0.242934159738138  LUMO = 1.16897970288708
  mo_energy =
[-1.20319017e+02 -1.23786388e+01 -6.67719555e+00 -6.67719555e+00
 -6.67719555e+00 -1.17921323e+00 -2.42934160e-01 -2.42934160e-01
 -2.42934160e-01  1.16897970e+00  1.34900358e+01  1.14867078e+02
  6.10344421e+02  2.74985129e+03  1.22283528e+04  4.08494728e+04
  1.04892913e+05  2.30076228e+05  4.55891079e+05  8.44843272e+05
  1.52802047e+06  2.85028779e+06  5.80817498e+06]
E1 = -706.6717056749318  E_coul = 198.69859465210246
cycle= 6 E= -507.973111022829  delta_E= 4.55e-13  |g|= 1.31e-08  |ddm|= 1.55e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6717056749318  E_coul = 198.69859465210246
  HOMO = -0.242934152727277  LUMO = 1.16897970334403
  mo_energy =
[-1.20319017e+02 -1.23786388e+01 -6.67719553e+00 -6.67719553e+00
 -6.67719553e+00 -1.17921323e+00 -2.42934153e-01 -2.42934153e-01
 -2.42934153e-01  1.16897970e+00  1.34900359e+01  1.14867078e+02
  6.10344421e+02  2.74985129e+03  1.22283528e+04  4.08494728e+04
  1.04892913e+05  2.30076228e+05  4.55891079e+05  8.44843272e+05
  1.52802047e+06  2.85028779e+06  5.80817498e+06]
E1 = -706.6717057108935  E_coul = 198.6985946880639
Extra cycle  E= -507.97311102283  delta_E= -2.84e-13  |g|= 2.75e-09  |ddm|= 2.39e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.12 sec
exp = [2.63622249e-01 1.17616814e+05 6.69636610e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547198e+04 7.30346135e+03 1.83758097e+04 1.44973352e+03
 3.73975714e+02 1.13687512e+02 3.81183734e+01 8.41511329e+00
 3.37445548e+00 8.60351747e+00 4.92553641e-01]
E = -507.97311102282964
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:28 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263622248636       1
[INPUT] 0    0    [1    /1   ]  117616.814225        1
[INPUT] 0    0    [1    /1   ]  0.669636609579       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031129        1
[INPUT] 0    0    [1    /1   ]  147020.992138        1
[INPUT] 0    0    [1    /1   ]  73510.4209289        1
[INPUT] 0    0    [1    /1   ]  36754.7198167        1
[INPUT] 0    0    [1    /1   ]  7303.46134528        1
[INPUT] 0    0    [1    /1   ]  18375.8097179        1
[INPUT] 0    0    [1    /1   ]  1449.73352412        1
[INPUT] 0    0    [1    /1   ]  373.97571398         1
[INPUT] 0    0    [1    /1   ]  113.687512057        1
[INPUT] 0    0    [1    /1   ]  38.1183734189        1
[INPUT] 0    0    [1    /1   ]  8.41511329175        1
[INPUT] 0    0    [1    /1   ]  3.37445548106        1
[INPUT] 1    0    [1    /1   ]  8.60351746814        1
[INPUT] 1    0    [1    /1   ]  0.492553641046       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2636222486355232, 1.0]], [0, [117616.81422536742, 1.0]], [0, [0.6696366095788303, 1.0]], [0, [1176168.1426188136, 1.0]], [0, [588084.0699921201, 1.0]], [0, [294042.03112932463, 1.0]], [0, [147020.99213774985, 1.0]], [0, [73510.42092888053, 1.0]], [0, [36754.71981674152, 1.0]], [0, [7303.461345281593, 1.0]], [0, [18375.809717909375, 1.0]], [0, [1449.733524119333, 1.0]], [0, [373.97571398024195, 1.0]], [0, [113.68751205735803, 1.0]], [0, [38.11837341885999, 1.0]], [0, [8.415113291746342, 1.0]], [0, [3.374455481064677, 1.0]], [1, [8.603517468140014, 1.0]], [1, [0.4925536410456703, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26362225]
bas 1, expnt(s) = [117616.81422537]
bas 2, expnt(s) = [0.66963661]
bas 3, expnt(s) = [1176168.14261881]
bas 4, expnt(s) = [588084.06999212]
bas 5, expnt(s) = [294042.03112932]
bas 6, expnt(s) = [147020.99213775]
bas 7, expnt(s) = [73510.42092888]
bas 8, expnt(s) = [36754.71981674]
bas 9, expnt(s) = [7303.46134528]
bas 10, expnt(s) = [18375.80971791]
bas 11, expnt(s) = [1449.73352412]
bas 12, expnt(s) = [373.97571398]
bas 13, expnt(s) = [113.68751206]
bas 14, expnt(s) = [38.11837342]
bas 15, expnt(s) = [8.41511329]
bas 16, expnt(s) = [3.37445548]
bas 17, expnt(s) = [8.60351747]
bas 18, expnt(s) = [0.49255364]
CPU time:       218.09
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63622249e-01 9.29504656e-01 1.17616814e+05 1.60460109e+04
 6.69636610e-01 1.87022740e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547198e+04 6.70656073e+03 7.30346135e+03 1.99600477e+03
 1.83758097e+04 3.98749258e+03 1.44973352e+03 5.93582598e+02
 3.73975714e+02 2.14856044e+02 1.13687512e+02 8.79629116e+01
 3.81183734e+01 3.87583959e+01 8.41511329e+00 1.24827422e+01
 3.37445548e+00 6.29024848e+00 8.60351747e+00 4.29862390e+01
 4.92553641e-01 1.20379160e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335776635665304
cond(S) = 907774.5936322837
E1 = -689.5606993491165  E_coul = 184.9583937229356
init E= -504.602305626181
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672532319831435  LUMO = 0.770431082337934
  mo_energy =
[-1.21705064e+02 -1.33853750e+01 -7.62442964e+00 -7.62442964e+00
 -7.62442964e+00 -1.65767783e+00 -6.72532320e-01 -6.72532320e-01
 -6.72532320e-01  7.70431082e-01  1.26017946e+01  1.13570458e+02
  6.08976516e+02  2.74856094e+03  1.22271819e+04  4.08483723e+04
  1.04891850e+05  2.30075191e+05  4.55890059e+05  8.44842266e+05
  1.52801948e+06  2.85028681e+06  5.80817401e+06]
E1 = -707.7265588913635  E_coul = 199.77111337091694
cycle= 1 E= -507.955445520447  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625984
diis-c [-0.39185583  1.        ]
  HOMO = -0.217994550663607  LUMO = 1.17680789464117
  mo_energy =
[-1.20194527e+02 -1.23038255e+01 -6.59479402e+00 -6.59479402e+00
 -6.59479402e+00 -1.16328009e+00 -2.17994551e-01 -2.17994551e-01
 -2.17994551e-01  1.17680789e+00  1.35483709e+01  1.14971873e+02
  6.10473054e+02  2.74999672e+03  1.22285088e+04  4.08496327e+04
  1.04893074e+05  2.30076391e+05  4.55891241e+05  8.44843435e+05
  1.52802064e+06  2.85028796e+06  5.80817515e+06]
E1 = -706.7913259471956  E_coul = 198.81846710223468
cycle= 2 E= -507.972858844961  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257983
diis-c [-6.62568523e-04  2.75459147e-03  9.97245409e-01]
  HOMO = -0.239700732008524  LUMO = 1.17020385063203
  mo_energy =
[-1.20306681e+02 -1.23697019e+01 -6.66774937e+00 -6.66774937e+00
 -6.66774937e+00 -1.17725743e+00 -2.39700732e-01 -2.39700732e-01
 -2.39700732e-01  1.17020385e+00  1.34972639e+01  1.14878099e+02
  6.10356931e+02  2.74986468e+03  1.22283667e+04  4.08494869e+04
  1.04892927e+05  2.30076243e+05  4.55891093e+05  8.44843286e+05
  1.52802049e+06  2.85028781e+06  5.80817500e+06]
E1 = -706.6870948906036  E_coul = 198.71398840314805
cycle= 3 E= -507.973106487456  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292426
diis-c [-1.54782477e-06 -1.77856884e-04 -1.14509175e-01  1.11468703e+00]
  HOMO = -0.242829690094921  LUMO = 1.16902510044979
  mo_energy =
[-1.20318774e+02 -1.23783840e+01 -6.67694664e+00 -6.67694664e+00
 -6.67694664e+00 -1.17915178e+00 -2.42829690e-01 -2.42829690e-01
 -2.42829690e-01  1.16902510e+00  1.34902522e+01  1.14867323e+02
  6.10344663e+02  2.74985153e+03  1.22283530e+04  4.08494731e+04
  1.04892913e+05  2.30076229e+05  4.55891079e+05  8.44843272e+05
  1.52802047e+06  2.85028779e+06  5.80817498e+06]
E1 = -706.6721967934827  E_coul = 198.69908577605622
cycle= 4 E= -507.973111017427  delta_E= -4.53e-06  |g|= 0.000157  |ddm|= 0.00915
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108306
diis-c [-6.83546087e-11 -5.28633497e-06  7.34611154e-03 -9.11574937e-02
  1.08381667e+00]
  HOMO = -0.242934116411892  LUMO = 1.16897955201609
  mo_energy =
[-1.20319016e+02 -1.23786386e+01 -6.67719524e+00 -6.67719524e+00
 -6.67719524e+00 -1.17921308e+00 -2.42934116e-01 -2.42934116e-01
 -2.42934116e-01  1.16897955e+00  1.34900360e+01  1.14867078e+02
  6.10344422e+02  2.74985129e+03  1.22283528e+04  4.08494728e+04
  1.04892913e+05  2.30076228e+05  4.55891079e+05  8.44843272e+05
  1.52802047e+06  2.85028779e+06  5.80817498e+06]
E1 = -706.6717060602733  E_coul = 198.6985950374435
cycle= 5 E= -507.97311102283  delta_E= -5.4e-09  |g|= 2.57e-07  |ddm|= 0.000332
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.59844e-07
diis-c [-1.11296534e-14  1.78412691e-07 -9.04972886e-05  1.01103539e-03
 -1.12857257e-02  1.01036501e+00]
  HOMO = -0.242934159738138  LUMO = 1.16897970288708
  mo_energy =
[-1.20319017e+02 -1.23786388e+01 -6.67719555e+00 -6.67719555e+00
 -6.67719555e+00 -1.17921323e+00 -2.42934160e-01 -2.42934160e-01
 -2.42934160e-01  1.16897970e+00  1.34900358e+01  1.14867078e+02
  6.10344421e+02  2.74985129e+03  1.22283528e+04  4.08494728e+04
  1.04892913e+05  2.30076228e+05  4.55891079e+05  8.44843272e+05
  1.52802047e+06  2.85028779e+06  5.80817498e+06]
E1 = -706.6717056749318  E_coul = 198.69859465210246
cycle= 6 E= -507.973111022829  delta_E= 4.55e-13  |g|= 1.31e-08  |ddm|= 1.55e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6717056749318  E_coul = 198.69859465210246
  HOMO = -0.242934152727277  LUMO = 1.16897970334403
  mo_energy =
[-1.20319017e+02 -1.23786388e+01 -6.67719553e+00 -6.67719553e+00
 -6.67719553e+00 -1.17921323e+00 -2.42934153e-01 -2.42934153e-01
 -2.42934153e-01  1.16897970e+00  1.34900359e+01  1.14867078e+02
  6.10344421e+02  2.74985129e+03  1.22283528e+04  4.08494728e+04
  1.04892913e+05  2.30076228e+05  4.55891079e+05  8.44843272e+05
  1.52802047e+06  2.85028779e+06  5.80817498e+06]
E1 = -706.6717057108935  E_coul = 198.6985946880639
Extra cycle  E= -507.97311102283  delta_E= -2.84e-13  |g|= 2.75e-09  |ddm|= 2.39e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907774.5936322837
E1 = -706.6717057108935  E_coul = 198.6985946880639
init E= -507.97311102283
    CPU time for initialize scf      1.48 sec, wall time      0.09 sec
  HOMO = -0.24293415171577  LUMO = 1.16897970575918
  mo_energy =
[-1.20319017e+02 -1.23786388e+01 -6.67719553e+00 -6.67719553e+00
 -6.67719553e+00 -1.17921323e+00 -2.42934152e-01 -2.42934152e-01
 -2.42934152e-01  1.16897971e+00  1.34900359e+01  1.14867078e+02
  6.10344421e+02  2.74985129e+03  1.22283528e+04  4.08494728e+04
  1.04892913e+05  2.30076228e+05  4.55891079e+05  8.44843272e+05
  1.52802047e+06  2.85028779e+06  5.80817498e+06]
E1 = -706.6717057147721  E_coul = 198.6985946919422
cycle= 1 E= -507.97311102283  delta_E= -2.84e-13  |g|= 1.54e-09  |ddm|= 2.48e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.6717057147721  E_coul = 198.6985946919422
  HOMO = -0.242934151614749  LUMO = 1.16897970472845
  mo_energy =
[-1.20319017e+02 -1.23786388e+01 -6.67719553e+00 -6.67719553e+00
 -6.67719553e+00 -1.17921323e+00 -2.42934152e-01 -2.42934152e-01
 -2.42934152e-01  1.16897970e+00  1.34900359e+01  1.14867078e+02
  6.10344421e+02  2.74985129e+03  1.22283528e+04  4.08494728e+04
  1.04892913e+05  2.30076228e+05  4.55891079e+05  8.44843272e+05
  1.52802047e+06  2.85028779e+06  5.80817498e+06]
E1 = -706.6717057147503  E_coul = 198.69859469192096
Extra cycle  E= -507.973111022829  delta_E= 6.25e-13  |g|= 2.43e-09  |ddm|= 3.5e-10
    CPU time for scf_cycle      1.65 sec, wall time      0.17 sec
exp = [2.63622249e-01 1.17616814e+05 6.69636610e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547198e+04 7.30346135e+03 1.83758097e+04 1.44973352e+03
 3.73975714e+02 1.13687512e+02 3.81183734e+01 8.41511329e+00
 3.37445548e+00 8.60351747e+00 4.92553641e-01]
grad_E = [ 3.33231475e-04  4.14460050e-09 -1.93385732e-04  1.83122206e-11
  1.11544334e-10  6.44872199e-10  2.52852753e-09  1.05032586e-08
  5.65486266e-08  3.55410765e-06  1.21142700e-07  6.77858743e-06
 -1.71501611e-05 -8.03989477e-05  1.76895477e-04  8.26266719e-05
 -3.25609543e-04 -1.08232035e-05 -6.07612402e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.26388672015        1
[INPUT] 0    0    [1    /1   ]  117616.814224        1
[INPUT] 0    0    [1    /1   ]  0.670626928633       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031129        1
[INPUT] 0    0    [1    /1   ]  147020.992137        1
[INPUT] 0    0    [1    /1   ]  73510.420925         1
[INPUT] 0    0    [1    /1   ]  36754.7197957        1
[INPUT] 0    0    [1    /1   ]  7303.46002331        1
[INPUT] 0    0    [1    /1   ]  18375.8096726        1
[INPUT] 0    0    [1    /1   ]  1449.73224165        1
[INPUT] 0    0    [1    /1   ]  373.969030689        1
[INPUT] 0    0    [1    /1   ]  113.741683629        1
[INPUT] 0    0    [1    /1   ]  38.1174263014        1
[INPUT] 0    0    [1    /1   ]  8.41158556865        1
[INPUT] 0    0    [1    /1   ]  3.37478649188        1
[INPUT] 1    0    [1    /1   ]  8.60354659128        1
[INPUT] 1    0    [1    /1   ]  0.492565144374       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2638867201501351, 1.0]], [0, [117616.81422382726, 1.0]], [0, [0.6706269286327795, 1.0]], [0, [1176168.1426188066, 1.0]], [0, [588084.0699920786, 1.0]], [0, [294042.031129085, 1.0]], [0, [147020.99213681003, 1.0]], [0, [73510.42092497571, 1.0]], [0, [36754.71979574746, 1.0]], [0, [7303.46002330766, 1.0]], [0, [18375.80967264978, 1.0]], [0, [1449.7322416543984, 1.0]], [0, [373.9690306891417, 1.0]], [0, [113.74168362920858, 1.0]], [0, [38.11742630144725, 1.0]], [0, [8.411585568653479, 1.0]], [0, [3.3747864918812853, 1.0]], [1, [8.603546591277244, 1.0]], [1, [0.4925651443740823, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26388672]
bas 1, expnt(s) = [117616.81422383]
bas 2, expnt(s) = [0.67062693]
bas 3, expnt(s) = [1176168.14261881]
bas 4, expnt(s) = [588084.06999208]
bas 5, expnt(s) = [294042.03112908]
bas 6, expnt(s) = [147020.99213681]
bas 7, expnt(s) = [73510.42092498]
bas 8, expnt(s) = [36754.71979575]
bas 9, expnt(s) = [7303.46002331]
bas 10, expnt(s) = [18375.80967265]
bas 11, expnt(s) = [1449.73224165]
bas 12, expnt(s) = [373.96903069]
bas 13, expnt(s) = [113.74168363]
bas 14, expnt(s) = [38.1174263]
bas 15, expnt(s) = [8.41158557]
bas 16, expnt(s) = [3.37478649]
bas 17, expnt(s) = [8.60354659]
bas 18, expnt(s) = [0.49256514]
CPU time:       222.91
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63886720e-01 9.30203942e-01 1.17616814e+05 1.60460109e+04
 6.70626929e-01 1.87230141e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547198e+04 6.70656073e+03 7.30346002e+03 1.99600450e+03
 1.83758097e+04 3.98749257e+03 1.44973224e+03 5.93582205e+02
 3.73969031e+02 2.14853164e+02 1.13741684e+02 8.79943451e+01
 3.81174263e+01 3.87576736e+01 8.41158557e+00 1.24788173e+01
 3.37478649e+00 6.29071125e+00 8.60354659e+00 4.29864208e+01
 4.92565144e-01 1.20382675e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335758079128972
cond(S) = 907776.0056892892
E1 = -689.5617826657922  E_coul = 184.95896411100992
init E= -504.602818554782
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672515586103974  LUMO = 0.772421781654507
  mo_energy =
[-1.21705013e+02 -1.33853232e+01 -7.62439321e+00 -7.62439321e+00
 -7.62439321e+00 -1.65766443e+00 -6.72515586e-01 -6.72515586e-01
 -6.72515586e-01  7.72421782e-01  1.26048652e+01  1.13583983e+02
  6.09095151e+02  2.74872542e+03  1.22273318e+04  4.08485094e+04
  1.04891980e+05  2.30075317e+05  4.55890181e+05  8.44842386e+05
  1.52801960e+06  2.85028693e+06  5.80817412e+06]
E1 = -707.7275541795442  E_coul = 199.77211068327966
cycle= 1 E= -507.955443496265  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625966
diis-c [-0.39183292  1.        ]
  HOMO = -0.217969221558674  LUMO = 1.17913950231225
  mo_energy =
[-1.20194456e+02 -1.23037353e+01 -6.59471495e+00 -6.59471495e+00
 -6.59471495e+00 -1.16325771e+00 -2.17969222e-01 -2.17969222e-01
 -2.17969222e-01  1.17913950e+00  1.35513759e+01  1.14985451e+02
  6.10591690e+02  2.75016120e+03  1.22286587e+04  4.08497699e+04
  1.04893204e+05  2.30076516e+05  4.55891364e+05  8.44843555e+05
  1.52802076e+06  2.85028807e+06  5.80817526e+06]
E1 = -706.7921304209481  E_coul = 198.81926836666267
cycle= 2 E= -507.972862054285  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257957
diis-c [-6.62428614e-04  2.75720064e-03  9.97242799e-01]
  HOMO = -0.239677491624164  LUMO = 1.17252022877674
  mo_energy =
[-1.20306631e+02 -1.23696281e+01 -6.66768757e+00 -6.66768757e+00
 -6.66768757e+00 -1.17723567e+00 -2.39677492e-01 -2.39677492e-01
 -2.39677492e-01  1.17252023e+00  1.35002556e+01  1.14891655e+02
  6.10475543e+02  2.75002913e+03  1.22285166e+04  4.08496240e+04
  1.04893057e+05  2.30076368e+05  4.55891215e+05  8.44843406e+05
  1.52802061e+06  2.85028792e+06  5.80817511e+06]
E1 = -706.6879357468441  E_coul = 198.71482625965356
cycle= 3 E= -507.973109487191  delta_E= -0.000247  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292279
diis-c [-1.54619855e-06 -1.77265972e-04 -1.14459103e-01  1.11463637e+00]
  HOMO = -0.2428044747167  LUMO = 1.17134009642725
  mo_energy =
[-1.20318722e+02 -1.23783073e+01 -6.67688194e+00 -6.67688194e+00
 -6.67688194e+00 -1.17912867e+00 -2.42804475e-01 -2.42804475e-01
 -2.42804475e-01  1.17134010e+00  1.34932468e+01  1.14880882e+02
  6.10463278e+02  2.75001599e+03  1.22285029e+04  4.08496102e+04
  1.04893043e+05  2.30076354e+05  4.55891201e+05  8.44843392e+05
  1.52802059e+06  2.85028791e+06  5.80817510e+06]
E1 = -706.6730533560938  E_coul = 198.69993934899205
cycle= 4 E= -507.973114007102  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108157
diis-c [-6.82426718e-11 -5.28551709e-06  7.34108084e-03 -9.10989174e-02
  1.08376312e+00]
  HOMO = -0.242908657951049  LUMO = 1.17129457974579
  mo_energy =
[-1.20318963e+02 -1.23785613e+01 -6.67713003e+00 -6.67713003e+00
 -6.67713003e+00 -1.17918981e+00 -2.42908658e-01 -2.42908658e-01
 -2.42908658e-01  1.17129458e+00  1.34930310e+01  1.14880638e+02
  6.10463037e+02  2.75001575e+03  1.22285027e+04  4.08496099e+04
  1.04893042e+05  2.30076354e+05  4.55891201e+05  8.44843392e+05
  1.52802059e+06  2.85028791e+06  5.80817510e+06]
E1 = -706.6725639917597  E_coul = 198.69944997928377
cycle= 5 E= -507.973114012476  delta_E= -5.37e-09  |g|= 2.56e-07  |ddm|= 0.000331
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.57564e-07
diis-c [-1.11263149e-14  1.75854540e-07 -9.04953942e-05  1.01224560e-03
 -1.13110293e-02  1.01038910e+00]
  HOMO = -0.242908699901157  LUMO = 1.17129473214762
  mo_energy =
[-1.20318964e+02 -1.23785616e+01 -6.67713033e+00 -6.67713033e+00
 -6.67713033e+00 -1.17918996e+00 -2.42908700e-01 -2.42908700e-01
 -2.42908700e-01  1.17129473e+00  1.34930309e+01  1.14880637e+02
  6.10463037e+02  2.75001575e+03  1.22285027e+04  4.08496099e+04
  1.04893042e+05  2.30076354e+05  4.55891201e+05  8.44843392e+05
  1.52802059e+06  2.85028791e+06  5.80817510e+06]
E1 = -706.6725636123475  E_coul = 198.6994495998712
cycle= 6 E= -507.973114012476  delta_E= -3.98e-13  |g|= 1.34e-08  |ddm|= 1.52e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6725636123475  E_coul = 198.6994495998712
  HOMO = -0.242908692912589  LUMO = 1.17129473241089
  mo_energy =
[-1.20318964e+02 -1.23785616e+01 -6.67713031e+00 -6.67713031e+00
 -6.67713031e+00 -1.17918996e+00 -2.42908693e-01 -2.42908693e-01
 -2.42908693e-01  1.17129473e+00  1.34930309e+01  1.14880637e+02
  6.10463037e+02  2.75001575e+03  1.22285027e+04  4.08496099e+04
  1.04893042e+05  2.30076354e+05  4.55891201e+05  8.44843392e+05
  1.52802059e+06  2.85028791e+06  5.80817510e+06]
E1 = -706.6725636501061  E_coul = 198.69944963762998
Extra cycle  E= -507.973114012476  delta_E= 2.27e-13  |g|= 1.76e-09  |ddm|= 2.5e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.63886720e-01 1.17616814e+05 6.70626929e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547198e+04 7.30346002e+03 1.83758097e+04 1.44973224e+03
 3.73969031e+02 1.13741684e+02 3.81174263e+01 8.41158557e+00
 3.37478649e+00 8.60354659e+00 4.92565144e-01]
E = -507.9731140124761
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.26388672015        1
[INPUT] 0    0    [1    /1   ]  117616.814224        1
[INPUT] 0    0    [1    /1   ]  0.670626928633       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031129        1
[INPUT] 0    0    [1    /1   ]  147020.992137        1
[INPUT] 0    0    [1    /1   ]  73510.420925         1
[INPUT] 0    0    [1    /1   ]  36754.7197957        1
[INPUT] 0    0    [1    /1   ]  7303.46002331        1
[INPUT] 0    0    [1    /1   ]  18375.8096726        1
[INPUT] 0    0    [1    /1   ]  1449.73224165        1
[INPUT] 0    0    [1    /1   ]  373.969030689        1
[INPUT] 0    0    [1    /1   ]  113.741683629        1
[INPUT] 0    0    [1    /1   ]  38.1174263014        1
[INPUT] 0    0    [1    /1   ]  8.41158556865        1
[INPUT] 0    0    [1    /1   ]  3.37478649188        1
[INPUT] 1    0    [1    /1   ]  8.60354659128        1
[INPUT] 1    0    [1    /1   ]  0.492565144374       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2638867201501351, 1.0]], [0, [117616.81422382726, 1.0]], [0, [0.6706269286327795, 1.0]], [0, [1176168.1426188066, 1.0]], [0, [588084.0699920786, 1.0]], [0, [294042.031129085, 1.0]], [0, [147020.99213681003, 1.0]], [0, [73510.42092497571, 1.0]], [0, [36754.71979574746, 1.0]], [0, [7303.46002330766, 1.0]], [0, [18375.80967264978, 1.0]], [0, [1449.7322416543984, 1.0]], [0, [373.9690306891417, 1.0]], [0, [113.74168362920858, 1.0]], [0, [38.11742630144725, 1.0]], [0, [8.411585568653479, 1.0]], [0, [3.3747864918812853, 1.0]], [1, [8.603546591277244, 1.0]], [1, [0.4925651443740823, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26388672]
bas 1, expnt(s) = [117616.81422383]
bas 2, expnt(s) = [0.67062693]
bas 3, expnt(s) = [1176168.14261881]
bas 4, expnt(s) = [588084.06999208]
bas 5, expnt(s) = [294042.03112908]
bas 6, expnt(s) = [147020.99213681]
bas 7, expnt(s) = [73510.42092498]
bas 8, expnt(s) = [36754.71979575]
bas 9, expnt(s) = [7303.46002331]
bas 10, expnt(s) = [18375.80967265]
bas 11, expnt(s) = [1449.73224165]
bas 12, expnt(s) = [373.96903069]
bas 13, expnt(s) = [113.74168363]
bas 14, expnt(s) = [38.1174263]
bas 15, expnt(s) = [8.41158557]
bas 16, expnt(s) = [3.37478649]
bas 17, expnt(s) = [8.60354659]
bas 18, expnt(s) = [0.49256514]
CPU time:       223.49
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63886720e-01 9.30203942e-01 1.17616814e+05 1.60460109e+04
 6.70626929e-01 1.87230141e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547198e+04 6.70656073e+03 7.30346002e+03 1.99600450e+03
 1.83758097e+04 3.98749257e+03 1.44973224e+03 5.93582205e+02
 3.73969031e+02 2.14853164e+02 1.13741684e+02 8.79943451e+01
 3.81174263e+01 3.87576736e+01 8.41158557e+00 1.24788173e+01
 3.37478649e+00 6.29071125e+00 8.60354659e+00 4.29864208e+01
 4.92565144e-01 1.20382675e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335758079128972
cond(S) = 907776.0056892892
E1 = -689.5617826657922  E_coul = 184.95896411100992
init E= -504.602818554782
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672515586103974  LUMO = 0.772421781654507
  mo_energy =
[-1.21705013e+02 -1.33853232e+01 -7.62439321e+00 -7.62439321e+00
 -7.62439321e+00 -1.65766443e+00 -6.72515586e-01 -6.72515586e-01
 -6.72515586e-01  7.72421782e-01  1.26048652e+01  1.13583983e+02
  6.09095151e+02  2.74872542e+03  1.22273318e+04  4.08485094e+04
  1.04891980e+05  2.30075317e+05  4.55890181e+05  8.44842386e+05
  1.52801960e+06  2.85028693e+06  5.80817412e+06]
E1 = -707.7275541795442  E_coul = 199.77211068327966
cycle= 1 E= -507.955443496265  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625966
diis-c [-0.39183292  1.        ]
  HOMO = -0.217969221558674  LUMO = 1.17913950231225
  mo_energy =
[-1.20194456e+02 -1.23037353e+01 -6.59471495e+00 -6.59471495e+00
 -6.59471495e+00 -1.16325771e+00 -2.17969222e-01 -2.17969222e-01
 -2.17969222e-01  1.17913950e+00  1.35513759e+01  1.14985451e+02
  6.10591690e+02  2.75016120e+03  1.22286587e+04  4.08497699e+04
  1.04893204e+05  2.30076516e+05  4.55891364e+05  8.44843555e+05
  1.52802076e+06  2.85028807e+06  5.80817526e+06]
E1 = -706.7921304209481  E_coul = 198.81926836666267
cycle= 2 E= -507.972862054285  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257957
diis-c [-6.62428614e-04  2.75720064e-03  9.97242799e-01]
  HOMO = -0.239677491624164  LUMO = 1.17252022877674
  mo_energy =
[-1.20306631e+02 -1.23696281e+01 -6.66768757e+00 -6.66768757e+00
 -6.66768757e+00 -1.17723567e+00 -2.39677492e-01 -2.39677492e-01
 -2.39677492e-01  1.17252023e+00  1.35002556e+01  1.14891655e+02
  6.10475543e+02  2.75002913e+03  1.22285166e+04  4.08496240e+04
  1.04893057e+05  2.30076368e+05  4.55891215e+05  8.44843406e+05
  1.52802061e+06  2.85028792e+06  5.80817511e+06]
E1 = -706.6879357468441  E_coul = 198.71482625965356
cycle= 3 E= -507.973109487191  delta_E= -0.000247  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292279
diis-c [-1.54619855e-06 -1.77265972e-04 -1.14459103e-01  1.11463637e+00]
  HOMO = -0.2428044747167  LUMO = 1.17134009642725
  mo_energy =
[-1.20318722e+02 -1.23783073e+01 -6.67688194e+00 -6.67688194e+00
 -6.67688194e+00 -1.17912867e+00 -2.42804475e-01 -2.42804475e-01
 -2.42804475e-01  1.17134010e+00  1.34932468e+01  1.14880882e+02
  6.10463278e+02  2.75001599e+03  1.22285029e+04  4.08496102e+04
  1.04893043e+05  2.30076354e+05  4.55891201e+05  8.44843392e+05
  1.52802059e+06  2.85028791e+06  5.80817510e+06]
E1 = -706.6730533560938  E_coul = 198.69993934899205
cycle= 4 E= -507.973114007102  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108157
diis-c [-6.82426718e-11 -5.28551709e-06  7.34108084e-03 -9.10989174e-02
  1.08376312e+00]
  HOMO = -0.242908657951049  LUMO = 1.17129457974579
  mo_energy =
[-1.20318963e+02 -1.23785613e+01 -6.67713003e+00 -6.67713003e+00
 -6.67713003e+00 -1.17918981e+00 -2.42908658e-01 -2.42908658e-01
 -2.42908658e-01  1.17129458e+00  1.34930310e+01  1.14880638e+02
  6.10463037e+02  2.75001575e+03  1.22285027e+04  4.08496099e+04
  1.04893042e+05  2.30076354e+05  4.55891201e+05  8.44843392e+05
  1.52802059e+06  2.85028791e+06  5.80817510e+06]
E1 = -706.6725639917597  E_coul = 198.69944997928377
cycle= 5 E= -507.973114012476  delta_E= -5.37e-09  |g|= 2.56e-07  |ddm|= 0.000331
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.57564e-07
diis-c [-1.11263149e-14  1.75854540e-07 -9.04953942e-05  1.01224560e-03
 -1.13110293e-02  1.01038910e+00]
  HOMO = -0.242908699901157  LUMO = 1.17129473214762
  mo_energy =
[-1.20318964e+02 -1.23785616e+01 -6.67713033e+00 -6.67713033e+00
 -6.67713033e+00 -1.17918996e+00 -2.42908700e-01 -2.42908700e-01
 -2.42908700e-01  1.17129473e+00  1.34930309e+01  1.14880637e+02
  6.10463037e+02  2.75001575e+03  1.22285027e+04  4.08496099e+04
  1.04893042e+05  2.30076354e+05  4.55891201e+05  8.44843392e+05
  1.52802059e+06  2.85028791e+06  5.80817510e+06]
E1 = -706.6725636123475  E_coul = 198.6994495998712
cycle= 6 E= -507.973114012476  delta_E= -3.98e-13  |g|= 1.34e-08  |ddm|= 1.52e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6725636123475  E_coul = 198.6994495998712
  HOMO = -0.242908692912589  LUMO = 1.17129473241089
  mo_energy =
[-1.20318964e+02 -1.23785616e+01 -6.67713031e+00 -6.67713031e+00
 -6.67713031e+00 -1.17918996e+00 -2.42908693e-01 -2.42908693e-01
 -2.42908693e-01  1.17129473e+00  1.34930309e+01  1.14880637e+02
  6.10463037e+02  2.75001575e+03  1.22285027e+04  4.08496099e+04
  1.04893042e+05  2.30076354e+05  4.55891201e+05  8.44843392e+05
  1.52802059e+06  2.85028791e+06  5.80817510e+06]
E1 = -706.6725636501061  E_coul = 198.69944963762998
Extra cycle  E= -507.973114012476  delta_E= 2.27e-13  |g|= 1.76e-09  |ddm|= 2.5e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907776.0056892892
E1 = -706.6725636501061  E_coul = 198.69944963762998
init E= -507.973114012476
    CPU time for initialize scf      1.50 sec, wall time      0.10 sec
  HOMO = -0.242908691858738  LUMO = 1.17129473218463
  mo_energy =
[-1.20318964e+02 -1.23785616e+01 -6.67713031e+00 -6.67713031e+00
 -6.67713031e+00 -1.17918996e+00 -2.42908692e-01 -2.42908692e-01
 -2.42908692e-01  1.17129473e+00  1.34930309e+01  1.14880637e+02
  6.10463037e+02  2.75001575e+03  1.22285027e+04  4.08496099e+04
  1.04893042e+05  2.30076354e+05  4.55891201e+05  8.44843392e+05
  1.52802059e+06  2.85028791e+06  5.80817510e+06]
E1 = -706.6725636561468  E_coul = 198.69944964367093
cycle= 1 E= -507.973114012476  delta_E= 2.27e-13  |g|= 1.38e-09  |ddm|= 3.86e-09
    CPU time for cycle= 1      0.10 sec, wall time      0.01 sec
E1 = -706.6725636561468  E_coul = 198.69944964367093
  HOMO = -0.24290869169097  LUMO = 1.1712947327502
  mo_energy =
[-1.20318964e+02 -1.23785616e+01 -6.67713031e+00 -6.67713031e+00
 -6.67713031e+00 -1.17918996e+00 -2.42908692e-01 -2.42908692e-01
 -2.42908692e-01  1.17129473e+00  1.34930309e+01  1.14880637e+02
  6.10463037e+02  2.75001575e+03  1.22285027e+04  4.08496099e+04
  1.04893042e+05  2.30076354e+05  4.55891201e+05  8.44843392e+05
  1.52802059e+06  2.85028791e+06  5.80817510e+06]
E1 = -706.6725636554752  E_coul = 198.6994496429991
Extra cycle  E= -507.973114012476  delta_E= -2.27e-13  |g|= 1.47e-09  |ddm|= 4.34e-10
    CPU time for scf_cycle      1.65 sec, wall time      0.16 sec
exp = [2.63886720e-01 1.17616814e+05 6.70626929e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547198e+04 7.30346002e+03 1.83758097e+04 1.44973224e+03
 3.73969031e+02 1.13741684e+02 3.81174263e+01 8.41158557e+00
 3.37478649e+00 8.60354659e+00 4.92565144e-01]
grad_E = [ 9.51148414e-05  4.12720687e-09 -5.48298951e-05  1.81052990e-11
  1.10979883e-10  6.42178944e-10  2.51777903e-09  1.04579572e-08
  5.63250924e-08  3.53814496e-06  1.20464925e-07  7.67741404e-06
 -2.89528270e-05 -1.92656822e-05  5.62106969e-05  1.97368500e-05
 -9.08822195e-05 -3.00643525e-06 -1.60227635e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263937263798       1
[INPUT] 0    0    [1    /1   ]  117616.814224        1
[INPUT] 0    0    [1    /1   ]  0.670881404855       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031129        1
[INPUT] 0    0    [1    /1   ]  147020.992137        1
[INPUT] 0    0    [1    /1   ]  73510.420926         1
[INPUT] 0    0    [1    /1   ]  36754.7198011        1
[INPUT] 0    0    [1    /1   ]  7303.46035965        1
[INPUT] 0    0    [1    /1   ]  18375.8096842        1
[INPUT] 0    0    [1    /1   ]  1449.73262351        1
[INPUT] 0    0    [1    /1   ]  373.969932934        1
[INPUT] 0    0    [1    /1   ]  113.733198102        1
[INPUT] 0    0    [1    /1   ]  38.1048350522        1
[INPUT] 0    0    [1    /1   ]  8.41001818792        1
[INPUT] 0    0    [1    /1   ]  3.37450711395        1
[INPUT] 1    0    [1    /1   ]  8.60355943491        1
[INPUT] 1    0    [1    /1   ]  0.49256932872        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2639372637980167, 1.0]], [0, [117616.81422421918, 1.0]], [0, [0.6708814048550467, 1.0]], [0, [1176168.1426188084, 1.0]], [0, [588084.0699920892, 1.0]], [0, [294042.031129146, 1.0]], [0, [147020.99213704918, 1.0]], [0, [73510.4209259693, 1.0]], [0, [36754.719801090614, 1.0]], [0, [7303.460359647969, 1.0]], [0, [18375.809684157004, 1.0]], [0, [1449.7326235135229, 1.0]], [0, [373.96993293420326, 1.0]], [0, [113.73319810185953, 1.0]], [0, [38.10483505224638, 1.0]], [0, [8.410018187920569, 1.0]], [0, [3.3745071139460863, 1.0]], [1, [8.603559434912707, 1.0]], [1, [0.4925693287203196, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26393726]
bas 1, expnt(s) = [117616.81422422]
bas 2, expnt(s) = [0.6708814]
bas 3, expnt(s) = [1176168.14261881]
bas 4, expnt(s) = [588084.06999209]
bas 5, expnt(s) = [294042.03112915]
bas 6, expnt(s) = [147020.99213705]
bas 7, expnt(s) = [73510.42092597]
bas 8, expnt(s) = [36754.71980109]
bas 9, expnt(s) = [7303.46035965]
bas 10, expnt(s) = [18375.80968416]
bas 11, expnt(s) = [1449.73262351]
bas 12, expnt(s) = [373.96993293]
bas 13, expnt(s) = [113.7331981]
bas 14, expnt(s) = [38.10483505]
bas 15, expnt(s) = [8.41001819]
bas 16, expnt(s) = [3.37450711]
bas 17, expnt(s) = [8.60355943]
bas 18, expnt(s) = [0.49256933]
CPU time:       228.32
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63937264e-01 9.30337564e-01 1.17616814e+05 1.60460109e+04
 6.70881405e-01 1.87283424e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547198e+04 6.70656073e+03 7.30346036e+03 1.99600457e+03
 1.83758097e+04 3.98749258e+03 1.44973262e+03 5.93582322e+02
 3.73969933e+02 2.14853553e+02 1.13733198e+02 8.79894216e+01
 3.81048351e+01 3.87480712e+01 8.41001819e+00 1.24770733e+01
 3.37450711e+00 6.29032066e+00 8.60355943e+00 4.29865011e+01
 4.92569329e-01 1.20383953e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335752381527026
cond(S) = 907775.2682554423
E1 = -689.5621257400724  E_coul = 184.95917401260346
init E= -504.602951727469
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.67250953358113  LUMO = 0.772867798671337
  mo_energy =
[-1.21704992e+02 -1.33853040e+01 -7.62438004e+00 -7.62438004e+00
 -7.62438004e+00 -1.65765912e+00 -6.72509534e-01 -6.72509534e-01
 -6.72509534e-01  7.72867799e-01  1.26034111e+01  1.13550281e+02
  6.09022506e+02  2.74864618e+03  1.22272610e+04  4.08484443e+04
  1.04891918e+05  2.30075257e+05  4.55890123e+05  8.44842328e+05
  1.52801954e+06  2.85028687e+06  5.80817407e+06]
E1 = -707.7278503372188  E_coul = 199.77240817313725
cycle= 1 E= -507.955442164082  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625954
diis-c [-0.39181842  1.        ]
  HOMO = -0.217960504947899  LUMO = 1.17966083297698
  mo_energy =
[-1.20194443e+02 -1.23037060e+01 -6.59469072e+00 -6.59469072e+00
 -6.59469072e+00 -1.16325018e+00 -2.17960505e-01 -2.17960505e-01
 -2.17960505e-01  1.17966083e+00  1.35498465e+01  1.14951708e+02
  6.10519023e+02  2.75008194e+03  1.22285879e+04  4.08497047e+04
  1.04893142e+05  2.30076456e+05  4.55891305e+05  8.44843497e+05
  1.52802070e+06  2.85028802e+06  5.80817521e+06]
E1 = -706.7923623600755  E_coul = 198.81949993351563
cycle= 2 E= -507.97286242656  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257966
diis-c [-6.62478556e-04  2.75523022e-03  9.97244770e-01]
  HOMO = -0.239669890315443  LUMO = 1.1730380658666
  mo_energy =
[-1.20306625e+02 -1.23696044e+01 -6.66766915e+00 -6.66766915e+00
 -6.66766915e+00 -1.17722866e+00 -2.39669890e-01 -2.39669890e-01
 -2.39669890e-01  1.17303807e+00  1.34987258e+01  1.14857911e+02
  6.10402869e+02  2.74994986e+03  1.22284457e+04  4.08495588e+04
  1.04892994e+05  2.30076308e+05  4.55891156e+05  8.44843348e+05
  1.52802055e+06  2.85028787e+06  5.80817506e+06]
E1 = -706.6881738336439  E_coul = 198.71506401713694
cycle= 3 E= -507.973109816507  delta_E= -0.000247  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292258
diis-c [-1.54604326e-06 -1.77028717e-04 -1.14444861e-01  1.11462189e+00]
  HOMO = -0.242796430713443  LUMO = 1.17185763561716
  mo_energy =
[-1.20318715e+02 -1.23782829e+01 -6.67686284e+00 -6.67686284e+00
 -6.67686284e+00 -1.17912134e+00 -2.42796431e-01 -2.42796431e-01
 -2.42796431e-01  1.17185764e+00  1.34917182e+01  1.14847140e+02
  6.10390604e+02  2.74993672e+03  1.22284320e+04  4.08495450e+04
  1.04892981e+05  2.30076294e+05  4.55891143e+05  8.44843334e+05
  1.52802054e+06  2.85028785e+06  5.80817504e+06]
E1 = -706.6732951423974  E_coul = 198.70018080837812
cycle= 4 E= -507.973114334019  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108129
diis-c [-6.82497589e-11 -5.28395813e-06  7.33947236e-03 -9.10832421e-02
  1.08374905e+00]
  HOMO = -0.242900560565608  LUMO = 1.1718121247893
  mo_energy =
[-1.20318956e+02 -1.23785368e+01 -6.67711081e+00 -6.67711081e+00
 -6.67711081e+00 -1.17918245e+00 -2.42900561e-01 -2.42900561e-01
 -2.42900561e-01  1.17181212e+00  1.34915025e+01  1.14846895e+02
  6.10390364e+02  2.74993648e+03  1.22284318e+04  4.08495447e+04
  1.04892980e+05  2.30076294e+05  4.55891142e+05  8.44843334e+05
  1.52802054e+06  2.85028785e+06  5.80817504e+06]
E1 = -706.6728060871876  E_coul = 198.69969174780084
cycle= 5 E= -507.973114339387  delta_E= -5.37e-09  |g|= 2.56e-07  |ddm|= 0.00033
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58465e-07
diis-c [-1.11014402e-14  1.77765219e-07 -9.07322597e-05  1.01489432e-03
 -1.13400221e-02  1.01041568e+00]
  HOMO = -0.242900602526383  LUMO = 1.17181227608926
  mo_energy =
[-1.20318957e+02 -1.23785370e+01 -6.67711111e+00 -6.67711111e+00
 -6.67711111e+00 -1.17918261e+00 -2.42900603e-01 -2.42900603e-01
 -2.42900603e-01  1.17181228e+00  1.34915024e+01  1.14846895e+02
  6.10390363e+02  2.74993648e+03  1.22284318e+04  4.08495447e+04
  1.04892980e+05  2.30076294e+05  4.55891142e+05  8.44843334e+05
  1.52802054e+06  2.85028785e+06  5.80817504e+06]
E1 = -706.6728057092275  E_coul = 198.69969136984054
cycle= 6 E= -507.973114339387  delta_E= -2.27e-13  |g|= 1.33e-08  |ddm|= 1.51e-07
    CPU time for cycle= 6      0.02 sec, wall time      0.02 sec
E1 = -706.6728057092275  E_coul = 198.69969136984054
  HOMO = -0.24290059551564  LUMO = 1.17181227859867
  mo_energy =
[-1.20318957e+02 -1.23785370e+01 -6.67711109e+00 -6.67711109e+00
 -6.67711109e+00 -1.17918260e+00 -2.42900596e-01 -2.42900596e-01
 -2.42900596e-01  1.17181228e+00  1.34915024e+01  1.14846895e+02
  6.10390363e+02  2.74993648e+03  1.22284318e+04  4.08495447e+04
  1.04892980e+05  2.30076294e+05  4.55891142e+05  8.44843334e+05
  1.52802054e+06  2.85028785e+06  5.80817504e+06]
E1 = -706.6728057455852  E_coul = 198.69969140619827
Extra cycle  E= -507.973114339387  delta_E= 1.14e-13  |g|= 2.51e-09  |ddm|= 2.41e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.12 sec
exp = [2.63937264e-01 1.17616814e+05 6.70881405e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547198e+04 7.30346036e+03 1.83758097e+04 1.44973262e+03
 3.73969933e+02 1.13733198e+02 3.81048351e+01 8.41001819e+00
 3.37450711e+00 8.60355943e+00 4.92569329e-01]
E = -507.9731143393869
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263937263798       1
[INPUT] 0    0    [1    /1   ]  117616.814224        1
[INPUT] 0    0    [1    /1   ]  0.670881404855       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031129        1
[INPUT] 0    0    [1    /1   ]  147020.992137        1
[INPUT] 0    0    [1    /1   ]  73510.420926         1
[INPUT] 0    0    [1    /1   ]  36754.7198011        1
[INPUT] 0    0    [1    /1   ]  7303.46035965        1
[INPUT] 0    0    [1    /1   ]  18375.8096842        1
[INPUT] 0    0    [1    /1   ]  1449.73262351        1
[INPUT] 0    0    [1    /1   ]  373.969932934        1
[INPUT] 0    0    [1    /1   ]  113.733198102        1
[INPUT] 0    0    [1    /1   ]  38.1048350522        1
[INPUT] 0    0    [1    /1   ]  8.41001818792        1
[INPUT] 0    0    [1    /1   ]  3.37450711395        1
[INPUT] 1    0    [1    /1   ]  8.60355943491        1
[INPUT] 1    0    [1    /1   ]  0.49256932872        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2639372637980167, 1.0]], [0, [117616.81422421918, 1.0]], [0, [0.6708814048550467, 1.0]], [0, [1176168.1426188084, 1.0]], [0, [588084.0699920892, 1.0]], [0, [294042.031129146, 1.0]], [0, [147020.99213704918, 1.0]], [0, [73510.4209259693, 1.0]], [0, [36754.719801090614, 1.0]], [0, [7303.460359647969, 1.0]], [0, [18375.809684157004, 1.0]], [0, [1449.7326235135229, 1.0]], [0, [373.96993293420326, 1.0]], [0, [113.73319810185953, 1.0]], [0, [38.10483505224638, 1.0]], [0, [8.410018187920569, 1.0]], [0, [3.3745071139460863, 1.0]], [1, [8.603559434912707, 1.0]], [1, [0.4925693287203196, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26393726]
bas 1, expnt(s) = [117616.81422422]
bas 2, expnt(s) = [0.6708814]
bas 3, expnt(s) = [1176168.14261881]
bas 4, expnt(s) = [588084.06999209]
bas 5, expnt(s) = [294042.03112915]
bas 6, expnt(s) = [147020.99213705]
bas 7, expnt(s) = [73510.42092597]
bas 8, expnt(s) = [36754.71980109]
bas 9, expnt(s) = [7303.46035965]
bas 10, expnt(s) = [18375.80968416]
bas 11, expnt(s) = [1449.73262351]
bas 12, expnt(s) = [373.96993293]
bas 13, expnt(s) = [113.7331981]
bas 14, expnt(s) = [38.10483505]
bas 15, expnt(s) = [8.41001819]
bas 16, expnt(s) = [3.37450711]
bas 17, expnt(s) = [8.60355943]
bas 18, expnt(s) = [0.49256933]
CPU time:       228.93
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63937264e-01 9.30337564e-01 1.17616814e+05 1.60460109e+04
 6.70881405e-01 1.87283424e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547198e+04 6.70656073e+03 7.30346036e+03 1.99600457e+03
 1.83758097e+04 3.98749258e+03 1.44973262e+03 5.93582322e+02
 3.73969933e+02 2.14853553e+02 1.13733198e+02 8.79894216e+01
 3.81048351e+01 3.87480712e+01 8.41001819e+00 1.24770733e+01
 3.37450711e+00 6.29032066e+00 8.60355943e+00 4.29865011e+01
 4.92569329e-01 1.20383953e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335752381527026
cond(S) = 907775.2682554423
E1 = -689.5621257400724  E_coul = 184.95917401260346
init E= -504.602951727469
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.67250953358113  LUMO = 0.772867798671337
  mo_energy =
[-1.21704992e+02 -1.33853040e+01 -7.62438004e+00 -7.62438004e+00
 -7.62438004e+00 -1.65765912e+00 -6.72509534e-01 -6.72509534e-01
 -6.72509534e-01  7.72867799e-01  1.26034111e+01  1.13550281e+02
  6.09022506e+02  2.74864618e+03  1.22272610e+04  4.08484443e+04
  1.04891918e+05  2.30075257e+05  4.55890123e+05  8.44842328e+05
  1.52801954e+06  2.85028687e+06  5.80817407e+06]
E1 = -707.7278503372188  E_coul = 199.77240817313725
cycle= 1 E= -507.955442164082  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625954
diis-c [-0.39181842  1.        ]
  HOMO = -0.217960504947899  LUMO = 1.17966083297698
  mo_energy =
[-1.20194443e+02 -1.23037060e+01 -6.59469072e+00 -6.59469072e+00
 -6.59469072e+00 -1.16325018e+00 -2.17960505e-01 -2.17960505e-01
 -2.17960505e-01  1.17966083e+00  1.35498465e+01  1.14951708e+02
  6.10519023e+02  2.75008194e+03  1.22285879e+04  4.08497047e+04
  1.04893142e+05  2.30076456e+05  4.55891305e+05  8.44843497e+05
  1.52802070e+06  2.85028802e+06  5.80817521e+06]
E1 = -706.7923623600755  E_coul = 198.81949993351563
cycle= 2 E= -507.97286242656  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257966
diis-c [-6.62478556e-04  2.75523022e-03  9.97244770e-01]
  HOMO = -0.239669890315443  LUMO = 1.1730380658666
  mo_energy =
[-1.20306625e+02 -1.23696044e+01 -6.66766915e+00 -6.66766915e+00
 -6.66766915e+00 -1.17722866e+00 -2.39669890e-01 -2.39669890e-01
 -2.39669890e-01  1.17303807e+00  1.34987258e+01  1.14857911e+02
  6.10402869e+02  2.74994986e+03  1.22284457e+04  4.08495588e+04
  1.04892994e+05  2.30076308e+05  4.55891156e+05  8.44843348e+05
  1.52802055e+06  2.85028787e+06  5.80817506e+06]
E1 = -706.6881738336439  E_coul = 198.71506401713694
cycle= 3 E= -507.973109816507  delta_E= -0.000247  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292258
diis-c [-1.54604326e-06 -1.77028717e-04 -1.14444861e-01  1.11462189e+00]
  HOMO = -0.242796430713443  LUMO = 1.17185763561716
  mo_energy =
[-1.20318715e+02 -1.23782829e+01 -6.67686284e+00 -6.67686284e+00
 -6.67686284e+00 -1.17912134e+00 -2.42796431e-01 -2.42796431e-01
 -2.42796431e-01  1.17185764e+00  1.34917182e+01  1.14847140e+02
  6.10390604e+02  2.74993672e+03  1.22284320e+04  4.08495450e+04
  1.04892981e+05  2.30076294e+05  4.55891143e+05  8.44843334e+05
  1.52802054e+06  2.85028785e+06  5.80817504e+06]
E1 = -706.6732951423974  E_coul = 198.70018080837812
cycle= 4 E= -507.973114334019  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108129
diis-c [-6.82497589e-11 -5.28395813e-06  7.33947236e-03 -9.10832421e-02
  1.08374905e+00]
  HOMO = -0.242900560565608  LUMO = 1.1718121247893
  mo_energy =
[-1.20318956e+02 -1.23785368e+01 -6.67711081e+00 -6.67711081e+00
 -6.67711081e+00 -1.17918245e+00 -2.42900561e-01 -2.42900561e-01
 -2.42900561e-01  1.17181212e+00  1.34915025e+01  1.14846895e+02
  6.10390364e+02  2.74993648e+03  1.22284318e+04  4.08495447e+04
  1.04892980e+05  2.30076294e+05  4.55891142e+05  8.44843334e+05
  1.52802054e+06  2.85028785e+06  5.80817504e+06]
E1 = -706.6728060871876  E_coul = 198.69969174780084
cycle= 5 E= -507.973114339387  delta_E= -5.37e-09  |g|= 2.56e-07  |ddm|= 0.00033
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58465e-07
diis-c [-1.11014402e-14  1.77765219e-07 -9.07322597e-05  1.01489432e-03
 -1.13400221e-02  1.01041568e+00]
  HOMO = -0.242900602526383  LUMO = 1.17181227608926
  mo_energy =
[-1.20318957e+02 -1.23785370e+01 -6.67711111e+00 -6.67711111e+00
 -6.67711111e+00 -1.17918261e+00 -2.42900603e-01 -2.42900603e-01
 -2.42900603e-01  1.17181228e+00  1.34915024e+01  1.14846895e+02
  6.10390363e+02  2.74993648e+03  1.22284318e+04  4.08495447e+04
  1.04892980e+05  2.30076294e+05  4.55891142e+05  8.44843334e+05
  1.52802054e+06  2.85028785e+06  5.80817504e+06]
E1 = -706.6728057092275  E_coul = 198.69969136984054
cycle= 6 E= -507.973114339387  delta_E= -2.27e-13  |g|= 1.33e-08  |ddm|= 1.51e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6728057092275  E_coul = 198.69969136984054
  HOMO = -0.24290059551564  LUMO = 1.17181227859867
  mo_energy =
[-1.20318957e+02 -1.23785370e+01 -6.67711109e+00 -6.67711109e+00
 -6.67711109e+00 -1.17918260e+00 -2.42900596e-01 -2.42900596e-01
 -2.42900596e-01  1.17181228e+00  1.34915024e+01  1.14846895e+02
  6.10390363e+02  2.74993648e+03  1.22284318e+04  4.08495447e+04
  1.04892980e+05  2.30076294e+05  4.55891142e+05  8.44843334e+05
  1.52802054e+06  2.85028785e+06  5.80817504e+06]
E1 = -706.6728057455852  E_coul = 198.69969140619827
Extra cycle  E= -507.973114339387  delta_E= 1.14e-13  |g|= 2.51e-09  |ddm|= 2.41e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907775.2682554423
E1 = -706.6728057455852  E_coul = 198.69969140619827
init E= -507.973114339387
    CPU time for initialize scf      1.46 sec, wall time      0.09 sec
  HOMO = -0.242900594508424  LUMO = 1.17181227845249
  mo_energy =
[-1.20318957e+02 -1.23785370e+01 -6.67711109e+00 -6.67711109e+00
 -6.67711109e+00 -1.17918260e+00 -2.42900595e-01 -2.42900595e-01
 -2.42900595e-01  1.17181228e+00  1.34915024e+01  1.14846895e+02
  6.10390363e+02  2.74993648e+03  1.22284318e+04  4.08495447e+04
  1.04892980e+05  2.30076294e+05  4.55891142e+05  8.44843334e+05
  1.52802054e+06  2.85028785e+06  5.80817504e+06]
E1 = -706.6728057485681  E_coul = 198.69969140918133
cycle= 1 E= -507.973114339387  delta_E= 1.71e-13  |g|= 1.8e-09  |ddm|= 2.11e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6728057485681  E_coul = 198.69969140918133
  HOMO = -0.242900594412358  LUMO = 1.17181227710832
  mo_energy =
[-1.20318957e+02 -1.23785370e+01 -6.67711109e+00 -6.67711109e+00
 -6.67711109e+00 -1.17918260e+00 -2.42900594e-01 -2.42900594e-01
 -2.42900594e-01  1.17181228e+00  1.34915024e+01  1.14846895e+02
  6.10390363e+02  2.74993648e+03  1.22284318e+04  4.08495447e+04
  1.04892980e+05  2.30076294e+05  4.55891142e+05  8.44843334e+05
  1.52802054e+06  2.85028785e+06  5.80817504e+06]
E1 = -706.6728057524168  E_coul = 198.6996914130298
Extra cycle  E= -507.973114339387  delta_E= -3.41e-13  |g|= 1.06e-09  |ddm|= 2.39e-09
    CPU time for scf_cycle      1.63 sec, wall time      0.16 sec
exp = [2.63937264e-01 1.17616814e+05 6.70881405e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547198e+04 7.30346036e+03 1.83758097e+04 1.44973262e+03
 3.73969933e+02 1.13733198e+02 3.81048351e+01 8.41001819e+00
 3.37450711e+00 8.60355943e+00 4.92569329e-01]
grad_E = [ 7.56354632e-06  4.12555799e-09 -4.33092227e-06  1.80856913e-11
  1.10926437e-10  6.41923535e-10  2.51676026e-09  1.04536642e-08
  5.63038718e-08  3.53660345e-06  1.20400907e-07  7.77344713e-06
 -3.06908344e-05 -3.24737340e-06  6.05971995e-06  5.90607748e-07
 -6.80966730e-06 -2.29544519e-07 -1.02356619e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263933268695       1
[INPUT] 0    0    [1    /1   ]  117616.814224        1
[INPUT] 0    0    [1    /1   ]  0.670885258947       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031129        1
[INPUT] 0    0    [1    /1   ]  147020.992137        1
[INPUT] 0    0    [1    /1   ]  73510.4209265        1
[INPUT] 0    0    [1    /1   ]  36754.7198042        1
[INPUT] 0    0    [1    /1   ]  7303.46055489        1
[INPUT] 0    0    [1    /1   ]  18375.8096908        1
[INPUT] 0    0    [1    /1   ]  1449.73282559        1
[INPUT] 0    0    [1    /1   ]  373.970726239        1
[INPUT] 0    0    [1    /1   ]  113.726637678        1
[INPUT] 0    0    [1    /1   ]  38.1011898325        1
[INPUT] 0    0    [1    /1   ]  8.40981772782        1
[INPUT] 0    0    [1    /1   ]  3.37440306323        1
[INPUT] 1    0    [1    /1   ]  8.60356108783        1
[INPUT] 1    0    [1    /1   ]  0.4925697267         1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26393326869506234, 1.0]], [0, [117616.81422444667, 1.0]], [0, [0.6708852589472497, 1.0]], [0, [1176168.1426188094, 1.0]], [0, [588084.0699920953, 1.0]], [0, [294042.0311291814, 1.0]], [0, [147020.992137188, 1.0]], [0, [73510.42092654604, 1.0]], [0, [36754.71980419168, 1.0]], [0, [7303.460554892887, 1.0]], [0, [18375.80969083975, 1.0]], [0, [1449.732825593779, 1.0]], [0, [373.9707262388232, 1.0]], [0, [113.72663767765806, 1.0]], [0, [38.101189832533436, 1.0]], [0, [8.409817727820288, 1.0]], [0, [3.374403063226161, 1.0]], [1, [8.60356108782786, 1.0]], [1, [0.4925697267004129, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26393327]
bas 1, expnt(s) = [117616.81422445]
bas 2, expnt(s) = [0.67088526]
bas 3, expnt(s) = [1176168.14261881]
bas 4, expnt(s) = [588084.0699921]
bas 5, expnt(s) = [294042.03112918]
bas 6, expnt(s) = [147020.99213719]
bas 7, expnt(s) = [73510.42092655]
bas 8, expnt(s) = [36754.71980419]
bas 9, expnt(s) = [7303.46055489]
bas 10, expnt(s) = [18375.80969084]
bas 11, expnt(s) = [1449.73282559]
bas 12, expnt(s) = [373.97072624]
bas 13, expnt(s) = [113.72663768]
bas 14, expnt(s) = [38.10118983]
bas 15, expnt(s) = [8.40981773]
bas 16, expnt(s) = [3.37440306]
bas 17, expnt(s) = [8.60356109]
bas 18, expnt(s) = [0.49256973]
CPU time:       233.74
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63933269e-01 9.30327003e-01 1.17616814e+05 1.60460109e+04
 6.70885259e-01 1.87284231e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547198e+04 6.70656073e+03 7.30346055e+03 1.99600461e+03
 1.83758097e+04 3.98749258e+03 1.44973283e+03 5.93582384e+02
 3.73970726e+02 2.14853894e+02 1.13726638e+02 8.79856150e+01
 3.81011898e+01 3.87452911e+01 8.40981773e+00 1.24768502e+01
 3.37440306e+00 6.29017520e+00 8.60356109e+00 4.29865114e+01
 4.92569727e-01 1.20384075e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335752046029754
cond(S) = 907774.9456573884
E1 = -689.5621481891565  E_coul = 184.95919455517276
init E= -504.602953633984
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672508960213539  LUMO = 0.772856545754712
  mo_energy =
[-1.21704989e+02 -1.33853021e+01 -7.62437879e+00 -7.62437879e+00
 -7.62437879e+00 -1.65765854e+00 -6.72508960e-01 -6.72508960e-01
 -6.72508960e-01  7.72856546e-01  1.26027769e+01  1.13539344e+02
  6.08992219e+02  2.74861056e+03  1.22272290e+04  4.08484149e+04
  1.04891890e+05  2.30075230e+05  4.55890096e+05  8.44842302e+05
  1.52801952e+06  2.85028685e+06  5.80817404e+06]
E1 = -707.72786621072  E_coul = 199.77242416351424
cycle= 1 E= -507.955442047206  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625952
diis-c [-0.39181581  1.        ]
  HOMO = -0.217959766486194  LUMO = 1.17964736954458
  mo_energy =
[-1.20194444e+02 -1.23037039e+01 -6.59468927e+00 -6.59468927e+00
 -6.59468927e+00 -1.16324958e+00 -2.17959766e-01 -2.17959766e-01
 -2.17959766e-01  1.17964737e+00  1.35491952e+01  1.14940756e+02
  6.10488730e+02  2.75004631e+03  1.22285558e+04  4.08496753e+04
  1.04893114e+05  2.30076429e+05  4.55891279e+05  8.44843471e+05
  1.52802067e+06  2.85028799e+06  5.80817518e+06]
E1 = -706.7923729699683  E_coul = 198.81951053335607
cycle= 2 E= -507.972862436612  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.025797
diis-c [-6.62503092e-04  2.75446783e-03  9.97245532e-01]
  HOMO = -0.239669331409095  LUMO = 1.17302466342075
  mo_energy =
[-1.20306627e+02 -1.23696028e+01 -6.66766818e+00 -6.66766818e+00
 -6.66766818e+00 -1.17722818e+00 -2.39669331e-01 -2.39669331e-01
 -2.39669331e-01  1.17302466e+00  1.34980754e+01  1.14846960e+02
  6.10372576e+02  2.74991424e+03  1.22284136e+04  4.08495294e+04
  1.04892967e+05  2.30076281e+05  4.55891130e+05  8.44843322e+05
  1.52802052e+06  2.85028784e+06  5.80817503e+06]
E1 = -706.6881836424245  E_coul = 198.71507381349704
cycle= 3 E= -507.973109828927  delta_E= -0.000247  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292263
diis-c [-1.54611274e-06 -1.76993482e-04 -1.14444317e-01  1.11462131e+00]
  HOMO = -0.242795883098711  LUMO = 1.17184424048331
  mo_energy =
[-1.20318717e+02 -1.23782813e+01 -6.67686187e+00 -6.67686187e+00
 -6.67686187e+00 -1.17912086e+00 -2.42795883e-01 -2.42795883e-01
 -2.42795883e-01  1.17184424e+00  1.34910679e+01  1.14836188e+02
  6.10360311e+02  2.74990109e+03  1.22284000e+04  4.08495156e+04
  1.04892953e+05  2.30076267e+05  4.55891116e+05  8.44843308e+05
  1.52802051e+06  2.85028783e+06  5.80817502e+06]
E1 = -706.6733049172752  E_coul = 198.70019057082158
cycle= 4 E= -507.973114346454  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108131
diis-c [-6.82491292e-11 -5.27736917e-06  7.33915690e-03 -9.10821147e-02
  1.08374824e+00]
  HOMO = -0.242900014750448  LUMO = 1.17179873179141
  mo_energy =
[-1.20318958e+02 -1.23785352e+01 -6.67710984e+00 -6.67710984e+00
 -6.67710984e+00 -1.17918197e+00 -2.42900015e-01 -2.42900015e-01
 -2.42900015e-01  1.17179873e+00  1.34908522e+01  1.14835944e+02
  6.10360071e+02  2.74990085e+03  1.22283997e+04  4.08495153e+04
  1.04892952e+05  2.30076267e+05  4.55891116e+05  8.44843308e+05
  1.52802051e+06  2.85028783e+06  5.80817502e+06]
E1 = -706.672815854038  E_coul = 198.69970150221693
cycle= 5 E= -507.973114351821  delta_E= -5.37e-09  |g|= 2.56e-07  |ddm|= 0.00033
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.57413e-07
diis-c [-1.11182144e-14  1.75222993e-07 -9.01799263e-05  1.00841755e-03
 -1.12681473e-02  1.01034973e+00]
  HOMO = -0.242900056691805  LUMO = 1.17179888453031
  mo_energy =
[-1.20318959e+02 -1.23785354e+01 -6.67711014e+00 -6.67711014e+00
 -6.67711014e+00 -1.17918213e+00 -2.42900057e-01 -2.42900057e-01
 -2.42900057e-01  1.17179888e+00  1.34908520e+01  1.14835944e+02
  6.10360070e+02  2.74990085e+03  1.22283997e+04  4.08495153e+04
  1.04892952e+05  2.30076267e+05  4.55891116e+05  8.44843308e+05
  1.52802051e+06  2.85028783e+06  5.80817502e+06]
E1 = -706.6728154747485  E_coul = 198.69970112292737
cycle= 6 E= -507.973114351821  delta_E= -5.68e-14  |g|= 1.34e-08  |ddm|= 1.52e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6728154747485  E_coul = 198.69970112292737
  HOMO = -0.242900049688878  LUMO = 1.17179888731035
  mo_energy =
[-1.20318959e+02 -1.23785354e+01 -6.67711012e+00 -6.67711012e+00
 -6.67711012e+00 -1.17918212e+00 -2.42900050e-01 -2.42900050e-01
 -2.42900050e-01  1.17179889e+00  1.34908521e+01  1.14835944e+02
  6.10360070e+02  2.74990085e+03  1.22283997e+04  4.08495153e+04
  1.04892952e+05  2.30076267e+05  4.55891116e+05  8.44843308e+05
  1.52802051e+06  2.85028783e+06  5.80817502e+06]
E1 = -706.6728155121818  E_coul = 198.69970116036072
Extra cycle  E= -507.973114351821  delta_E= 5.68e-14  |g|= 3.43e-09  |ddm|= 2.47e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.63933269e-01 1.17616814e+05 6.70885259e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547198e+04 7.30346055e+03 1.83758097e+04 1.44973283e+03
 3.73970726e+02 1.13726638e+02 3.81011898e+01 8.40981773e+00
 3.37440306e+00 8.60356109e+00 4.92569727e-01]
E = -507.9731143518211
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263933268695       1
[INPUT] 0    0    [1    /1   ]  117616.814224        1
[INPUT] 0    0    [1    /1   ]  0.670885258947       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031129        1
[INPUT] 0    0    [1    /1   ]  147020.992137        1
[INPUT] 0    0    [1    /1   ]  73510.4209265        1
[INPUT] 0    0    [1    /1   ]  36754.7198042        1
[INPUT] 0    0    [1    /1   ]  7303.46055489        1
[INPUT] 0    0    [1    /1   ]  18375.8096908        1
[INPUT] 0    0    [1    /1   ]  1449.73282559        1
[INPUT] 0    0    [1    /1   ]  373.970726239        1
[INPUT] 0    0    [1    /1   ]  113.726637678        1
[INPUT] 0    0    [1    /1   ]  38.1011898325        1
[INPUT] 0    0    [1    /1   ]  8.40981772782        1
[INPUT] 0    0    [1    /1   ]  3.37440306323        1
[INPUT] 1    0    [1    /1   ]  8.60356108783        1
[INPUT] 1    0    [1    /1   ]  0.4925697267         1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26393326869506234, 1.0]], [0, [117616.81422444667, 1.0]], [0, [0.6708852589472497, 1.0]], [0, [1176168.1426188094, 1.0]], [0, [588084.0699920953, 1.0]], [0, [294042.0311291814, 1.0]], [0, [147020.992137188, 1.0]], [0, [73510.42092654604, 1.0]], [0, [36754.71980419168, 1.0]], [0, [7303.460554892887, 1.0]], [0, [18375.80969083975, 1.0]], [0, [1449.732825593779, 1.0]], [0, [373.9707262388232, 1.0]], [0, [113.72663767765806, 1.0]], [0, [38.101189832533436, 1.0]], [0, [8.409817727820288, 1.0]], [0, [3.374403063226161, 1.0]], [1, [8.60356108782786, 1.0]], [1, [0.4925697267004129, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26393327]
bas 1, expnt(s) = [117616.81422445]
bas 2, expnt(s) = [0.67088526]
bas 3, expnt(s) = [1176168.14261881]
bas 4, expnt(s) = [588084.0699921]
bas 5, expnt(s) = [294042.03112918]
bas 6, expnt(s) = [147020.99213719]
bas 7, expnt(s) = [73510.42092655]
bas 8, expnt(s) = [36754.71980419]
bas 9, expnt(s) = [7303.46055489]
bas 10, expnt(s) = [18375.80969084]
bas 11, expnt(s) = [1449.73282559]
bas 12, expnt(s) = [373.97072624]
bas 13, expnt(s) = [113.72663768]
bas 14, expnt(s) = [38.10118983]
bas 15, expnt(s) = [8.40981773]
bas 16, expnt(s) = [3.37440306]
bas 17, expnt(s) = [8.60356109]
bas 18, expnt(s) = [0.49256973]
CPU time:       234.33
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63933269e-01 9.30327003e-01 1.17616814e+05 1.60460109e+04
 6.70885259e-01 1.87284231e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547198e+04 6.70656073e+03 7.30346055e+03 1.99600461e+03
 1.83758097e+04 3.98749258e+03 1.44973283e+03 5.93582384e+02
 3.73970726e+02 2.14853894e+02 1.13726638e+02 8.79856150e+01
 3.81011898e+01 3.87452911e+01 8.40981773e+00 1.24768502e+01
 3.37440306e+00 6.29017520e+00 8.60356109e+00 4.29865114e+01
 4.92569727e-01 1.20384075e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335752046029754
cond(S) = 907774.9456573884
E1 = -689.5621481891565  E_coul = 184.95919455517276
init E= -504.602953633984
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672508960213539  LUMO = 0.772856545754712
  mo_energy =
[-1.21704989e+02 -1.33853021e+01 -7.62437879e+00 -7.62437879e+00
 -7.62437879e+00 -1.65765854e+00 -6.72508960e-01 -6.72508960e-01
 -6.72508960e-01  7.72856546e-01  1.26027769e+01  1.13539344e+02
  6.08992219e+02  2.74861056e+03  1.22272290e+04  4.08484149e+04
  1.04891890e+05  2.30075230e+05  4.55890096e+05  8.44842302e+05
  1.52801952e+06  2.85028685e+06  5.80817404e+06]
E1 = -707.72786621072  E_coul = 199.77242416351424
cycle= 1 E= -507.955442047206  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625952
diis-c [-0.39181581  1.        ]
  HOMO = -0.217959766486194  LUMO = 1.17964736954458
  mo_energy =
[-1.20194444e+02 -1.23037039e+01 -6.59468927e+00 -6.59468927e+00
 -6.59468927e+00 -1.16324958e+00 -2.17959766e-01 -2.17959766e-01
 -2.17959766e-01  1.17964737e+00  1.35491952e+01  1.14940756e+02
  6.10488730e+02  2.75004631e+03  1.22285558e+04  4.08496753e+04
  1.04893114e+05  2.30076429e+05  4.55891279e+05  8.44843471e+05
  1.52802067e+06  2.85028799e+06  5.80817518e+06]
E1 = -706.7923729699683  E_coul = 198.81951053335607
cycle= 2 E= -507.972862436612  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.025797
diis-c [-6.62503092e-04  2.75446783e-03  9.97245532e-01]
  HOMO = -0.239669331409095  LUMO = 1.17302466342075
  mo_energy =
[-1.20306627e+02 -1.23696028e+01 -6.66766818e+00 -6.66766818e+00
 -6.66766818e+00 -1.17722818e+00 -2.39669331e-01 -2.39669331e-01
 -2.39669331e-01  1.17302466e+00  1.34980754e+01  1.14846960e+02
  6.10372576e+02  2.74991424e+03  1.22284136e+04  4.08495294e+04
  1.04892967e+05  2.30076281e+05  4.55891130e+05  8.44843322e+05
  1.52802052e+06  2.85028784e+06  5.80817503e+06]
E1 = -706.6881836424245  E_coul = 198.71507381349704
cycle= 3 E= -507.973109828927  delta_E= -0.000247  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292263
diis-c [-1.54611274e-06 -1.76993482e-04 -1.14444317e-01  1.11462131e+00]
  HOMO = -0.242795883098711  LUMO = 1.17184424048331
  mo_energy =
[-1.20318717e+02 -1.23782813e+01 -6.67686187e+00 -6.67686187e+00
 -6.67686187e+00 -1.17912086e+00 -2.42795883e-01 -2.42795883e-01
 -2.42795883e-01  1.17184424e+00  1.34910679e+01  1.14836188e+02
  6.10360311e+02  2.74990109e+03  1.22284000e+04  4.08495156e+04
  1.04892953e+05  2.30076267e+05  4.55891116e+05  8.44843308e+05
  1.52802051e+06  2.85028783e+06  5.80817502e+06]
E1 = -706.6733049172752  E_coul = 198.70019057082158
cycle= 4 E= -507.973114346454  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108131
diis-c [-6.82491292e-11 -5.27736917e-06  7.33915690e-03 -9.10821147e-02
  1.08374824e+00]
  HOMO = -0.242900014750448  LUMO = 1.17179873179141
  mo_energy =
[-1.20318958e+02 -1.23785352e+01 -6.67710984e+00 -6.67710984e+00
 -6.67710984e+00 -1.17918197e+00 -2.42900015e-01 -2.42900015e-01
 -2.42900015e-01  1.17179873e+00  1.34908522e+01  1.14835944e+02
  6.10360071e+02  2.74990085e+03  1.22283997e+04  4.08495153e+04
  1.04892952e+05  2.30076267e+05  4.55891116e+05  8.44843308e+05
  1.52802051e+06  2.85028783e+06  5.80817502e+06]
E1 = -706.672815854038  E_coul = 198.69970150221693
cycle= 5 E= -507.973114351821  delta_E= -5.37e-09  |g|= 2.56e-07  |ddm|= 0.00033
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.57413e-07
diis-c [-1.11182144e-14  1.75222993e-07 -9.01799263e-05  1.00841755e-03
 -1.12681473e-02  1.01034973e+00]
  HOMO = -0.242900056691805  LUMO = 1.17179888453031
  mo_energy =
[-1.20318959e+02 -1.23785354e+01 -6.67711014e+00 -6.67711014e+00
 -6.67711014e+00 -1.17918213e+00 -2.42900057e-01 -2.42900057e-01
 -2.42900057e-01  1.17179888e+00  1.34908520e+01  1.14835944e+02
  6.10360070e+02  2.74990085e+03  1.22283997e+04  4.08495153e+04
  1.04892952e+05  2.30076267e+05  4.55891116e+05  8.44843308e+05
  1.52802051e+06  2.85028783e+06  5.80817502e+06]
E1 = -706.6728154747485  E_coul = 198.69970112292737
cycle= 6 E= -507.973114351821  delta_E= -5.68e-14  |g|= 1.34e-08  |ddm|= 1.52e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6728154747485  E_coul = 198.69970112292737
  HOMO = -0.242900049688878  LUMO = 1.17179888731035
  mo_energy =
[-1.20318959e+02 -1.23785354e+01 -6.67711012e+00 -6.67711012e+00
 -6.67711012e+00 -1.17918212e+00 -2.42900050e-01 -2.42900050e-01
 -2.42900050e-01  1.17179889e+00  1.34908521e+01  1.14835944e+02
  6.10360070e+02  2.74990085e+03  1.22283997e+04  4.08495153e+04
  1.04892952e+05  2.30076267e+05  4.55891116e+05  8.44843308e+05
  1.52802051e+06  2.85028783e+06  5.80817502e+06]
E1 = -706.6728155121818  E_coul = 198.69970116036072
Extra cycle  E= -507.973114351821  delta_E= 5.68e-14  |g|= 3.43e-09  |ddm|= 2.47e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907774.9456573884
E1 = -706.6728155121818  E_coul = 198.69970116036072
init E= -507.973114351821
    CPU time for initialize scf      1.45 sec, wall time      0.09 sec
  HOMO = -0.242900048659233  LUMO = 1.17179888532241
  mo_energy =
[-1.20318959e+02 -1.23785354e+01 -6.67711012e+00 -6.67711012e+00
 -6.67711012e+00 -1.17918212e+00 -2.42900049e-01 -2.42900049e-01
 -2.42900049e-01  1.17179889e+00  1.34908521e+01  1.14835944e+02
  6.10360070e+02  2.74990085e+03  1.22283997e+04  4.08495153e+04
  1.04892952e+05  2.30076267e+05  4.55891116e+05  8.44843308e+05
  1.52802051e+06  2.85028783e+06  5.80817502e+06]
E1 = -706.6728155175489  E_coul = 198.69970116572762
cycle= 1 E= -507.973114351821  delta_E= -1.71e-13  |g|= 1.22e-09  |ddm|= 3.61e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6728155175489  E_coul = 198.69970116572762
  HOMO = -0.242900048496209  LUMO = 1.1717988864609
  mo_energy =
[-1.20318959e+02 -1.23785354e+01 -6.67711012e+00 -6.67711012e+00
 -6.67711012e+00 -1.17918212e+00 -2.42900048e-01 -2.42900048e-01
 -2.42900048e-01  1.17179889e+00  1.34908521e+01  1.14835944e+02
  6.10360070e+02  2.74990085e+03  1.22283997e+04  4.08495153e+04
  1.04892952e+05  2.30076267e+05  4.55891116e+05  8.44843308e+05
  1.52802051e+06  2.85028783e+06  5.80817502e+06]
E1 = -706.6728155170352  E_coul = 198.69970116521404
Extra cycle  E= -507.973114351821  delta_E= 5.68e-14  |g|= 1.56e-09  |ddm|= 3.79e-10
    CPU time for scf_cycle      1.62 sec, wall time      0.16 sec
exp = [2.63933269e-01 1.17616814e+05 6.70885259e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547198e+04 7.30346055e+03 1.83758097e+04 1.44973283e+03
 3.73970726e+02 1.13726638e+02 3.81011898e+01 8.40981773e+00
 3.37440306e+00 8.60356109e+00 4.92569727e-01]
grad_E = [-1.04276001e-06  4.12637644e-09  6.25255758e-07  1.80954361e-11
  1.10953013e-10  6.42050250e-10  2.51726607e-09  1.04557961e-08
  5.63143828e-08  3.53734690e-06  1.20432848e-07  7.73428822e-06
 -3.03192533e-05 -3.09641251e-06  2.91382840e-07 -4.86425985e-07
  9.14129942e-07  2.68632192e-08  1.59703177e-06]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263931202721       1
[INPUT] 0    0    [1    /1   ]  117616.814224        1
[INPUT] 0    0    [1    /1   ]  0.670880024927       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031129        1
[INPUT] 0    0    [1    /1   ]  147020.992137        1
[INPUT] 0    0    [1    /1   ]  73510.4209266        1
[INPUT] 0    0    [1    /1   ]  36754.7198047        1
[INPUT] 0    0    [1    /1   ]  7303.46058458        1
[INPUT] 0    0    [1    /1   ]  18375.8096919        1
[INPUT] 0    0    [1    /1   ]  1449.73285161        1
[INPUT] 0    0    [1    /1   ]  373.97090052         1
[INPUT] 0    0    [1    /1   ]  113.725466088        1
[INPUT] 0    0    [1    /1   ]  38.1007088884        1
[INPUT] 0    0    [1    /1   ]  8.40980742483        1
[INPUT] 0    0    [1    /1   ]  3.37438654463        1
[INPUT] 1    0    [1    /1   ]  8.60356116562        1
[INPUT] 1    0    [1    /1   ]  0.492569729279       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26393120272105963, 1.0]], [0, [117616.81422448125, 1.0]], [0, [0.6708800249265287, 1.0]], [0, [1176168.1426188096, 1.0]], [0, [588084.0699920963, 1.0]], [0, [294042.03112918674, 1.0]], [0, [147020.9921372091, 1.0]], [0, [73510.42092663371, 1.0]], [0, [36754.719804662986, 1.0]], [0, [7303.460584576151, 1.0]], [0, [18375.809691856466, 1.0]], [0, [1449.7328516117154, 1.0]], [0, [373.9709005201383, 1.0]], [0, [113.72546608750018, 1.0]], [0, [38.100708888400284, 1.0]], [0, [8.409807424826825, 1.0]], [0, [3.374386544634572, 1.0]], [1, [8.603561165618345, 1.0]], [1, [0.4925697292789069, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2639312]
bas 1, expnt(s) = [117616.81422448]
bas 2, expnt(s) = [0.67088002]
bas 3, expnt(s) = [1176168.14261881]
bas 4, expnt(s) = [588084.0699921]
bas 5, expnt(s) = [294042.03112919]
bas 6, expnt(s) = [147020.99213721]
bas 7, expnt(s) = [73510.42092663]
bas 8, expnt(s) = [36754.71980466]
bas 9, expnt(s) = [7303.46058458]
bas 10, expnt(s) = [18375.80969186]
bas 11, expnt(s) = [1449.73285161]
bas 12, expnt(s) = [373.97090052]
bas 13, expnt(s) = [113.72546609]
bas 14, expnt(s) = [38.10070889]
bas 15, expnt(s) = [8.40980742]
bas 16, expnt(s) = [3.37438654]
bas 17, expnt(s) = [8.60356117]
bas 18, expnt(s) = [0.49256973]
CPU time:       239.14
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63931203e-01 9.30321541e-01 1.17616814e+05 1.60460109e+04
 6.70880025e-01 1.87283135e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547198e+04 6.70656073e+03 7.30346058e+03 1.99600462e+03
 1.83758097e+04 3.98749258e+03 1.44973285e+03 5.93582392e+02
 3.73970901e+02 2.14853970e+02 1.13725466e+02 8.79849352e+01
 3.81007089e+01 3.87449243e+01 8.40980742e+00 1.24768388e+01
 3.37438654e+00 6.29015210e+00 8.60356117e+00 4.29865119e+01
 4.92569729e-01 1.20384075e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335752087901554
cond(S) = 907774.8954498492
E1 = -689.5621457131787  E_coul = 184.95919461448008
init E= -504.602951098699
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.672508961205651  LUMO = 0.772843477514947
  mo_energy =
[-1.21704989e+02 -1.33853021e+01 -7.62437880e+00 -7.62437880e+00
 -7.62437880e+00 -1.65765853e+00 -6.72508961e-01 -6.72508961e-01
 -6.72508961e-01  7.72843478e-01  1.26026683e+01  1.13537795e+02
  6.08987538e+02  2.74860498e+03  1.22272240e+04  4.08484103e+04
  1.04891886e+05  2.30075225e+05  4.55890092e+05  8.44842298e+05
  1.52801951e+06  2.85028684e+06  5.80817404e+06]
E1 = -707.7278635487205  E_coul = 199.77242148965422
cycle= 1 E= -507.955442059066  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.19 sec, wall time      0.01 sec
diis-norm(errvec)=0.625952
diis-c [-0.39181558  1.        ]
  HOMO = -0.217959777502992  LUMO = 1.17963203031325
  mo_energy =
[-1.20194445e+02 -1.23037041e+01 -6.59468947e+00 -6.59468947e+00
 -6.59468947e+00 -1.16324960e+00 -2.17959778e-01 -2.17959778e-01
 -2.17959778e-01  1.17963203e+00  1.35490846e+01  1.14939204e+02
  6.10484048e+02  2.75004073e+03  1.22285508e+04  4.08496707e+04
  1.04893110e+05  2.30076425e+05  4.55891275e+05  8.44843467e+05
  1.52802067e+06  2.85028799e+06  5.80817518e+06]
E1 = -706.7923706664832  E_coul = 198.81950823019952
cycle= 2 E= -507.972862436284  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257971
diis-c [-6.62507151e-04  2.75434783e-03  9.97245652e-01]
  HOMO = -0.239669355738513  LUMO = 1.17300942066296
  mo_energy =
[-1.20306627e+02 -1.23696029e+01 -6.66766835e+00 -6.66766835e+00
 -6.66766835e+00 -1.17722821e+00 -2.39669356e-01 -2.39669356e-01
 -2.39669356e-01  1.17300942e+00  1.34979650e+01  1.14845408e+02
  6.10367894e+02  2.74990865e+03  1.22284086e+04  4.08495248e+04
  1.04892962e+05  2.30076277e+05  4.55891126e+05  8.44843318e+05
  1.52802052e+06  2.85028784e+06  5.80817503e+06]
E1 = -706.6881810178111  E_coul = 198.715071187667
cycle= 3 E= -507.973109830144  delta_E= -0.000247  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292264
diis-c [-1.54613060e-06 -1.76997996e-04 -1.14444508e-01  1.11462151e+00]
  HOMO = -0.242795920530391  LUMO = 1.17182900771623
  mo_energy =
[-1.20318717e+02 -1.23782814e+01 -6.67686206e+00 -6.67686206e+00
 -6.67686206e+00 -1.17912091e+00 -2.42795921e-01 -2.42795921e-01
 -2.42795921e-01  1.17182901e+00  1.34909574e+01  1.14834637e+02
  6.10355630e+02  2.74989551e+03  1.22283950e+04  4.08495109e+04
  1.04892948e+05  2.30076263e+05  4.55891112e+05  8.44843304e+05
  1.52802051e+06  2.85028783e+06  5.80817502e+06]
E1 = -706.6733021941657  E_coul = 198.7001878464347
cycle= 4 E= -507.973114347731  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108133
diis-c [-6.82399317e-11 -5.28368801e-06  7.33941523e-03 -9.10839213e-02
  1.08374979e+00]
  HOMO = -0.242900053824631  LUMO = 1.17178349969563
  mo_energy =
[-1.20318958e+02 -1.23785353e+01 -6.67711003e+00 -6.67711003e+00
 -6.67711003e+00 -1.17918202e+00 -2.42900054e-01 -2.42900054e-01
 -2.42900054e-01  1.17178350e+00  1.34907418e+01  1.14834393e+02
  6.10355389e+02  2.74989527e+03  1.22283947e+04  4.08495107e+04
  1.04892948e+05  2.30076262e+05  4.55891112e+05  8.44843304e+05
  1.52802051e+06  2.85028783e+06  5.80817502e+06]
E1 = -706.6728131223842  E_coul = 198.69969876928505
cycle= 5 E= -507.973114353099  delta_E= -5.37e-09  |g|= 2.56e-07  |ddm|= 0.00033
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.57474e-07
diis-c [-1.11156835e-14  1.75530900e-07 -9.07342822e-05  1.01528390e-03
 -1.13449298e-02  1.01042020e+00]
  HOMO = -0.24290009570955  LUMO = 1.17178365030904
  mo_energy =
[-1.20318959e+02 -1.23785356e+01 -6.67711033e+00 -6.67711033e+00
 -6.67711033e+00 -1.17918217e+00 -2.42900096e-01 -2.42900096e-01
 -2.42900096e-01  1.17178365e+00  1.34907416e+01  1.14834392e+02
  6.10355388e+02  2.74989527e+03  1.22283947e+04  4.08495107e+04
  1.04892948e+05  2.30076262e+05  4.55891112e+05  8.44843304e+05
  1.52802051e+06  2.85028783e+06  5.80817502e+06]
E1 = -706.6728127444796  E_coul = 198.69969839138048
cycle= 6 E= -507.973114353099  delta_E=    0  |g|= 1.31e-08  |ddm|= 1.51e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6728127444796  E_coul = 198.69969839138048
  HOMO = -0.242900088720259  LUMO = 1.17178365054347
  mo_energy =
[-1.20318959e+02 -1.23785356e+01 -6.67711031e+00 -6.67711031e+00
 -6.67711031e+00 -1.17918217e+00 -2.42900089e-01 -2.42900089e-01
 -2.42900089e-01  1.17178365e+00  1.34907417e+01  1.14834392e+02
  6.10355388e+02  2.74989527e+03  1.22283947e+04  4.08495107e+04
  1.04892948e+05  2.30076262e+05  4.55891112e+05  8.44843304e+05
  1.52802051e+06  2.85028783e+06  5.80817502e+06]
E1 = -706.6728127820734  E_coul = 198.69969842897413
Extra cycle  E= -507.973114353099  delta_E= -1.14e-13  |g|= 2.15e-09  |ddm|= 2.49e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.12 sec
exp = [2.63931203e-01 1.17616814e+05 6.70880025e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547198e+04 7.30346058e+03 1.83758097e+04 1.44973285e+03
 3.73970901e+02 1.13725466e+02 3.81007089e+01 8.40980742e+00
 3.37438654e+00 8.60356117e+00 4.92569729e-01]
E = -507.9731143530993
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263931202721       1
[INPUT] 0    0    [1    /1   ]  117616.814224        1
[INPUT] 0    0    [1    /1   ]  0.670880024927       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031129        1
[INPUT] 0    0    [1    /1   ]  147020.992137        1
[INPUT] 0    0    [1    /1   ]  73510.4209266        1
[INPUT] 0    0    [1    /1   ]  36754.7198047        1
[INPUT] 0    0    [1    /1   ]  7303.46058458        1
[INPUT] 0    0    [1    /1   ]  18375.8096919        1
[INPUT] 0    0    [1    /1   ]  1449.73285161        1
[INPUT] 0    0    [1    /1   ]  373.97090052         1
[INPUT] 0    0    [1    /1   ]  113.725466088        1
[INPUT] 0    0    [1    /1   ]  38.1007088884        1
[INPUT] 0    0    [1    /1   ]  8.40980742483        1
[INPUT] 0    0    [1    /1   ]  3.37438654463        1
[INPUT] 1    0    [1    /1   ]  8.60356116562        1
[INPUT] 1    0    [1    /1   ]  0.492569729279       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26393120272105963, 1.0]], [0, [117616.81422448125, 1.0]], [0, [0.6708800249265287, 1.0]], [0, [1176168.1426188096, 1.0]], [0, [588084.0699920963, 1.0]], [0, [294042.03112918674, 1.0]], [0, [147020.9921372091, 1.0]], [0, [73510.42092663371, 1.0]], [0, [36754.719804662986, 1.0]], [0, [7303.460584576151, 1.0]], [0, [18375.809691856466, 1.0]], [0, [1449.7328516117154, 1.0]], [0, [373.9709005201383, 1.0]], [0, [113.72546608750018, 1.0]], [0, [38.100708888400284, 1.0]], [0, [8.409807424826825, 1.0]], [0, [3.374386544634572, 1.0]], [1, [8.603561165618345, 1.0]], [1, [0.4925697292789069, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2639312]
bas 1, expnt(s) = [117616.81422448]
bas 2, expnt(s) = [0.67088002]
bas 3, expnt(s) = [1176168.14261881]
bas 4, expnt(s) = [588084.0699921]
bas 5, expnt(s) = [294042.03112919]
bas 6, expnt(s) = [147020.99213721]
bas 7, expnt(s) = [73510.42092663]
bas 8, expnt(s) = [36754.71980466]
bas 9, expnt(s) = [7303.46058458]
bas 10, expnt(s) = [18375.80969186]
bas 11, expnt(s) = [1449.73285161]
bas 12, expnt(s) = [373.97090052]
bas 13, expnt(s) = [113.72546609]
bas 14, expnt(s) = [38.10070889]
bas 15, expnt(s) = [8.40980742]
bas 16, expnt(s) = [3.37438654]
bas 17, expnt(s) = [8.60356117]
bas 18, expnt(s) = [0.49256973]
CPU time:       239.76
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63931203e-01 9.30321541e-01 1.17616814e+05 1.60460109e+04
 6.70880025e-01 1.87283135e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547198e+04 6.70656073e+03 7.30346058e+03 1.99600462e+03
 1.83758097e+04 3.98749258e+03 1.44973285e+03 5.93582392e+02
 3.73970901e+02 2.14853970e+02 1.13725466e+02 8.79849352e+01
 3.81007089e+01 3.87449243e+01 8.40980742e+00 1.24768388e+01
 3.37438654e+00 6.29015210e+00 8.60356117e+00 4.29865119e+01
 4.92569729e-01 1.20384075e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335752087901554
cond(S) = 907774.8954498492
E1 = -689.5621457131787  E_coul = 184.95919461448008
init E= -504.602951098699
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672508961205651  LUMO = 0.772843477514947
  mo_energy =
[-1.21704989e+02 -1.33853021e+01 -7.62437880e+00 -7.62437880e+00
 -7.62437880e+00 -1.65765853e+00 -6.72508961e-01 -6.72508961e-01
 -6.72508961e-01  7.72843478e-01  1.26026683e+01  1.13537795e+02
  6.08987538e+02  2.74860498e+03  1.22272240e+04  4.08484103e+04
  1.04891886e+05  2.30075225e+05  4.55890092e+05  8.44842298e+05
  1.52801951e+06  2.85028684e+06  5.80817404e+06]
E1 = -707.7278635487205  E_coul = 199.77242148965422
cycle= 1 E= -507.955442059066  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625952
diis-c [-0.39181558  1.        ]
  HOMO = -0.217959777502992  LUMO = 1.17963203031325
  mo_energy =
[-1.20194445e+02 -1.23037041e+01 -6.59468947e+00 -6.59468947e+00
 -6.59468947e+00 -1.16324960e+00 -2.17959778e-01 -2.17959778e-01
 -2.17959778e-01  1.17963203e+00  1.35490846e+01  1.14939204e+02
  6.10484048e+02  2.75004073e+03  1.22285508e+04  4.08496707e+04
  1.04893110e+05  2.30076425e+05  4.55891275e+05  8.44843467e+05
  1.52802067e+06  2.85028799e+06  5.80817518e+06]
E1 = -706.7923706664832  E_coul = 198.81950823019952
cycle= 2 E= -507.972862436284  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257971
diis-c [-6.62507151e-04  2.75434783e-03  9.97245652e-01]
  HOMO = -0.239669355738513  LUMO = 1.17300942066296
  mo_energy =
[-1.20306627e+02 -1.23696029e+01 -6.66766835e+00 -6.66766835e+00
 -6.66766835e+00 -1.17722821e+00 -2.39669356e-01 -2.39669356e-01
 -2.39669356e-01  1.17300942e+00  1.34979650e+01  1.14845408e+02
  6.10367894e+02  2.74990865e+03  1.22284086e+04  4.08495248e+04
  1.04892962e+05  2.30076277e+05  4.55891126e+05  8.44843318e+05
  1.52802052e+06  2.85028784e+06  5.80817503e+06]
E1 = -706.6881810178111  E_coul = 198.715071187667
cycle= 3 E= -507.973109830144  delta_E= -0.000247  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292264
diis-c [-1.54613060e-06 -1.76997996e-04 -1.14444508e-01  1.11462151e+00]
  HOMO = -0.242795920530391  LUMO = 1.17182900771623
  mo_energy =
[-1.20318717e+02 -1.23782814e+01 -6.67686206e+00 -6.67686206e+00
 -6.67686206e+00 -1.17912091e+00 -2.42795921e-01 -2.42795921e-01
 -2.42795921e-01  1.17182901e+00  1.34909574e+01  1.14834637e+02
  6.10355630e+02  2.74989551e+03  1.22283950e+04  4.08495109e+04
  1.04892948e+05  2.30076263e+05  4.55891112e+05  8.44843304e+05
  1.52802051e+06  2.85028783e+06  5.80817502e+06]
E1 = -706.6733021941657  E_coul = 198.7001878464347
cycle= 4 E= -507.973114347731  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108133
diis-c [-6.82399317e-11 -5.28368801e-06  7.33941523e-03 -9.10839213e-02
  1.08374979e+00]
  HOMO = -0.242900053824631  LUMO = 1.17178349969563
  mo_energy =
[-1.20318958e+02 -1.23785353e+01 -6.67711003e+00 -6.67711003e+00
 -6.67711003e+00 -1.17918202e+00 -2.42900054e-01 -2.42900054e-01
 -2.42900054e-01  1.17178350e+00  1.34907418e+01  1.14834393e+02
  6.10355389e+02  2.74989527e+03  1.22283947e+04  4.08495107e+04
  1.04892948e+05  2.30076262e+05  4.55891112e+05  8.44843304e+05
  1.52802051e+06  2.85028783e+06  5.80817502e+06]
E1 = -706.6728131223842  E_coul = 198.69969876928505
cycle= 5 E= -507.973114353099  delta_E= -5.37e-09  |g|= 2.56e-07  |ddm|= 0.00033
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.57474e-07
diis-c [-1.11156835e-14  1.75530900e-07 -9.07342822e-05  1.01528390e-03
 -1.13449298e-02  1.01042020e+00]
  HOMO = -0.24290009570955  LUMO = 1.17178365030904
  mo_energy =
[-1.20318959e+02 -1.23785356e+01 -6.67711033e+00 -6.67711033e+00
 -6.67711033e+00 -1.17918217e+00 -2.42900096e-01 -2.42900096e-01
 -2.42900096e-01  1.17178365e+00  1.34907416e+01  1.14834392e+02
  6.10355388e+02  2.74989527e+03  1.22283947e+04  4.08495107e+04
  1.04892948e+05  2.30076262e+05  4.55891112e+05  8.44843304e+05
  1.52802051e+06  2.85028783e+06  5.80817502e+06]
E1 = -706.6728127444796  E_coul = 198.69969839138048
cycle= 6 E= -507.973114353099  delta_E=    0  |g|= 1.31e-08  |ddm|= 1.51e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6728127444796  E_coul = 198.69969839138048
  HOMO = -0.242900088720259  LUMO = 1.17178365054347
  mo_energy =
[-1.20318959e+02 -1.23785356e+01 -6.67711031e+00 -6.67711031e+00
 -6.67711031e+00 -1.17918217e+00 -2.42900089e-01 -2.42900089e-01
 -2.42900089e-01  1.17178365e+00  1.34907417e+01  1.14834392e+02
  6.10355388e+02  2.74989527e+03  1.22283947e+04  4.08495107e+04
  1.04892948e+05  2.30076262e+05  4.55891112e+05  8.44843304e+05
  1.52802051e+06  2.85028783e+06  5.80817502e+06]
E1 = -706.6728127820734  E_coul = 198.69969842897413
Extra cycle  E= -507.973114353099  delta_E= -1.14e-13  |g|= 2.15e-09  |ddm|= 2.49e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907774.8954498492
E1 = -706.6728127820734  E_coul = 198.69969842897413
init E= -507.973114353099
    CPU time for initialize scf      1.48 sec, wall time      0.09 sec
  HOMO = -0.24290008767096  LUMO = 1.17178365116827
  mo_energy =
[-1.20318959e+02 -1.23785356e+01 -6.67711031e+00 -6.67711031e+00
 -6.67711031e+00 -1.17918217e+00 -2.42900088e-01 -2.42900088e-01
 -2.42900088e-01  1.17178365e+00  1.34907417e+01  1.14834392e+02
  6.10355388e+02  2.74989527e+03  1.22283947e+04  4.08495107e+04
  1.04892948e+05  2.30076262e+05  4.55891112e+05  8.44843304e+05
  1.52802051e+06  2.85028783e+06  5.80817502e+06]
E1 = -706.6728127862432  E_coul = 198.69969843314416
cycle= 1 E= -507.973114353099  delta_E= 2.27e-13  |g|= 1.09e-09  |ddm|= 2.74e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6728127862432  E_coul = 198.69969843314416
  HOMO = -0.242900087550855  LUMO = 1.17178365319541
  mo_energy =
[-1.20318959e+02 -1.23785356e+01 -6.67711031e+00 -6.67711031e+00
 -6.67711031e+00 -1.17918217e+00 -2.42900088e-01 -2.42900088e-01
 -2.42900088e-01  1.17178365e+00  1.34907417e+01  1.14834392e+02
  6.10355388e+02  2.74989527e+03  1.22283947e+04  4.08495107e+04
  1.04892948e+05  2.30076262e+05  4.55891112e+05  8.44843304e+05
  1.52802051e+06  2.85028783e+06  5.80817502e+06]
E1 = -706.672812786004  E_coul = 198.69969843290502
Extra cycle  E= -507.973114353099  delta_E= 1.14e-13  |g|= 1.49e-09  |ddm|= 4.13e-10
    CPU time for scf_cycle      1.65 sec, wall time      0.16 sec
exp = [2.63931203e-01 1.17616814e+05 6.70880025e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547198e+04 7.30346058e+03 1.83758097e+04 1.44973285e+03
 3.73970901e+02 1.13725466e+02 3.81007089e+01 8.40980742e+00
 3.37438654e+00 8.60356117e+00 4.92569729e-01]
grad_E = [-7.94741958e-07  4.12658610e-09  4.79488051e-07  1.80979317e-11
  1.10959818e-10  6.42082712e-10  2.51739563e-09  1.04563422e-08
  5.63170762e-08  3.53753822e-06  1.20441023e-07  7.72391027e-06
 -3.02029724e-05 -3.41876031e-06  1.96605385e-07 -2.95925829e-07
  6.60543275e-07  1.98978682e-08  1.14720569e-06]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.2639259774         1
[INPUT] 0    0    [1    /1   ]  117616.814225        1
[INPUT] 0    0    [1    /1   ]  0.670866220991       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031129        1
[INPUT] 0    0    [1    /1   ]  147020.992137        1
[INPUT] 0    0    [1    /1   ]  73510.4209268        1
[INPUT] 0    0    [1    /1   ]  36754.7198056        1
[INPUT] 0    0    [1    /1   ]  7303.46064183        1
[INPUT] 0    0    [1    /1   ]  18375.8096938        1
[INPUT] 0    0    [1    /1   ]  1449.73288556        1
[INPUT] 0    0    [1    /1   ]  373.971416025        1
[INPUT] 0    0    [1    /1   ]  113.722721171        1
[INPUT] 0    0    [1    /1   ]  38.0996043065        1
[INPUT] 0    0    [1    /1   ]  8.40978535705        1
[INPUT] 0    0    [1    /1   ]  3.37434722196        1
[INPUT] 1    0    [1    /1   ]  8.60356132146        1
[INPUT] 1    0    [1    /1   ]  0.492569726183       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.263925977400128, 1.0]], [0, [117616.81422454792, 1.0]], [0, [0.670866220991252, 1.0]], [0, [1176168.1426188098, 1.0]], [0, [588084.069992098, 1.0]], [0, [294042.0311291971, 1.0]], [0, [147020.9921372498, 1.0]], [0, [73510.4209268028, 1.0]], [0, [36754.71980557158, 1.0]], [0, [7303.460641832762, 1.0]], [0, [18375.80969382018, 1.0]], [0, [1449.732885564298, 1.0]], [0, [373.97141602469776, 1.0]], [0, [113.72272117082798, 1.0]], [0, [38.09960430649213, 1.0]], [0, [8.409785357049252, 1.0]], [0, [3.37434722196364, 1.0]], [1, [8.603561321456944, 1.0]], [1, [0.49256972618309397, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26392598]
bas 1, expnt(s) = [117616.81422455]
bas 2, expnt(s) = [0.67086622]
bas 3, expnt(s) = [1176168.14261881]
bas 4, expnt(s) = [588084.0699921]
bas 5, expnt(s) = [294042.0311292]
bas 6, expnt(s) = [147020.99213725]
bas 7, expnt(s) = [73510.4209268]
bas 8, expnt(s) = [36754.71980557]
bas 9, expnt(s) = [7303.46064183]
bas 10, expnt(s) = [18375.80969382]
bas 11, expnt(s) = [1449.73288556]
bas 12, expnt(s) = [373.97141602]
bas 13, expnt(s) = [113.72272117]
bas 14, expnt(s) = [38.09960431]
bas 15, expnt(s) = [8.40978536]
bas 16, expnt(s) = [3.37434722]
bas 17, expnt(s) = [8.60356132]
bas 18, expnt(s) = [0.49256973]
CPU time:       244.60
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63925977e-01 9.30307727e-01 1.17616814e+05 1.60460109e+04
 6.70866221e-01 1.87280245e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547198e+04 6.70656073e+03 7.30346064e+03 1.99600463e+03
 1.83758097e+04 3.98749258e+03 1.44973289e+03 5.93582402e+02
 3.73971416e+02 2.14854192e+02 1.13722721e+02 8.79833424e+01
 3.80996043e+01 3.87440818e+01 8.40978536e+00 1.24768142e+01
 3.37434722e+00 6.29009713e+00 8.60356132e+00 4.29865128e+01
 4.92569726e-01 1.20384074e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33575220239008
cond(S) = 907774.7805284191
E1 = -689.5621387031572  E_coul = 184.95919420157222
init E= -504.602944501585
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672508979787504  LUMO = 0.772809848129179
  mo_energy =
[-1.21704989e+02 -1.33853021e+01 -7.62437885e+00 -7.62437885e+00
 -7.62437885e+00 -1.65765851e+00 -6.72508980e-01 -6.72508980e-01
 -6.72508980e-01  7.72809848e-01  1.26024062e+01  1.13534205e+02
  6.08976731e+02  2.74859226e+03  1.22272126e+04  4.08483998e+04
  1.04891876e+05  2.30075216e+05  4.55890083e+05  8.44842289e+05
  1.52801950e+06  2.85028683e+06  5.80817403e+06]
E1 = -707.7278563868732  E_coul = 199.7724142909644
cycle= 1 E= -507.955442095909  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625951
diis-c [-0.39181505  1.        ]
  HOMO = -0.217959821720885  LUMO = 1.17959256958514
  mo_energy =
[-1.20194446e+02 -1.23037046e+01 -6.59469003e+00 -6.59469003e+00
 -6.59469003e+00 -1.16324968e+00 -2.17959822e-01 -2.17959822e-01
 -2.17959822e-01  1.17959257e+00  1.35488177e+01  1.14935609e+02
  6.10473238e+02  2.75002800e+03  1.22285394e+04  4.08496602e+04
  1.04893100e+05  2.30076415e+05  4.55891265e+05  8.44843458e+05
  1.52802066e+06  2.85028798e+06  5.80817517e+06]
E1 = -706.7923646281845  E_coul = 198.81950219129348
cycle= 2 E= -507.972862436891  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257973
diis-c [-6.62516851e-04  2.75407381e-03  9.97245926e-01]
  HOMO = -0.239669427894922  LUMO = 1.17297021103021
  mo_energy =
[-1.20306628e+02 -1.23696033e+01 -6.66766880e+00 -6.66766880e+00
 -6.66766880e+00 -1.17722831e+00 -2.39669428e-01 -2.39669428e-01
 -2.39669428e-01  1.17297021e+00  1.34976986e+01  1.14841814e+02
  6.10357085e+02  2.74989592e+03  1.22283972e+04  4.08495143e+04
  1.04892952e+05  2.30076267e+05  4.55891116e+05  8.44843309e+05
  1.52802051e+06  2.85028783e+06  5.80817502e+06]
E1 = -706.6881741664441  E_coul = 198.71506433174866
cycle= 3 E= -507.973109834695  delta_E= -0.000247  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292268
diis-c [-1.54617821e-06 -1.77000831e-04 -1.14445025e-01  1.11462203e+00]
  HOMO = -0.242796026549204  LUMO = 1.17178982137398
  mo_energy =
[-1.20318718e+02 -1.23782819e+01 -6.67686255e+00 -6.67686255e+00
 -6.67686255e+00 -1.17912103e+00 -2.42796027e-01 -2.42796027e-01
 -2.42796027e-01  1.17178982e+00  1.34906911e+01  1.14831042e+02
  6.10344820e+02  2.74988278e+03  1.22283836e+04  4.08495005e+04
  1.04892938e+05  2.30076253e+05  4.55891102e+05  8.44843295e+05
  1.52802050e+06  2.85028782e+06  5.80817501e+06]
E1 = -706.6732950943946  E_coul = 198.70018074195664
cycle= 4 E= -507.973114352438  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108135
diis-c [-6.82557995e-11 -5.27819790e-06  7.33929434e-03 -9.10835887e-02
  1.08374957e+00]
  HOMO = -0.242900164011284  LUMO = 1.17174431054171
  mo_energy =
[-1.20318959e+02 -1.23785358e+01 -6.67711054e+00 -6.67711054e+00
 -6.67711054e+00 -1.17918214e+00 -2.42900164e-01 -2.42900164e-01
 -2.42900164e-01  1.17174431e+00  1.34904754e+01  1.14830798e+02
  6.10344580e+02  2.74988254e+03  1.22283833e+04  4.08495002e+04
  1.04892938e+05  2.30076253e+05  4.55891102e+05  8.44843295e+05
  1.52802050e+06  2.85028782e+06  5.80817501e+06]
E1 = -706.6728060022309  E_coul = 198.69969164442458
cycle= 5 E= -507.973114357806  delta_E= -5.37e-09  |g|= 2.57e-07  |ddm|= 0.00033
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58728e-07
diis-c [-1.11284738e-14  1.77600536e-07 -9.11436133e-05  1.01991996e-03
 -1.13986039e-02  1.01046965e+00]
  HOMO = -0.242900205994858  LUMO = 1.171744462364
  mo_energy =
[-1.20318960e+02 -1.23785360e+01 -6.67711084e+00 -6.67711084e+00
 -6.67711084e+00 -1.17918230e+00 -2.42900206e-01 -2.42900206e-01
 -2.42900206e-01  1.17174446e+00  1.34904753e+01  1.14830797e+02
  6.10344579e+02  2.74988254e+03  1.22283833e+04  4.08495002e+04
  1.04892938e+05  2.30076253e+05  4.55891102e+05  8.44843295e+05
  1.52802050e+06  2.85028782e+06  5.80817501e+06]
E1 = -706.6728056236618  E_coul = 198.69969126585562
cycle= 6 E= -507.973114357806  delta_E= 1.71e-13  |g|= 1.29e-08  |ddm|= 1.52e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6728056236618  E_coul = 198.69969126585562
  HOMO = -0.242900198979601  LUMO = 1.17174446451158
  mo_energy =
[-1.20318960e+02 -1.23785360e+01 -6.67711082e+00 -6.67711082e+00
 -6.67711082e+00 -1.17918229e+00 -2.42900199e-01 -2.42900199e-01
 -2.42900199e-01  1.17174446e+00  1.34904753e+01  1.14830797e+02
  6.10344579e+02  2.74988254e+03  1.22283833e+04  4.08495002e+04
  1.04892938e+05  2.30076253e+05  4.55891102e+05  8.44843295e+05
  1.52802050e+06  2.85028782e+06  5.80817501e+06]
E1 = -706.6728056580558  E_coul = 198.69969130024953
Extra cycle  E= -507.973114357806  delta_E= -1.14e-13  |g|= 2.02e-09  |ddm|= 2.29e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.63925977e-01 1.17616814e+05 6.70866221e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547198e+04 7.30346064e+03 1.83758097e+04 1.44973289e+03
 3.73971416e+02 1.13722721e+02 3.80996043e+01 8.40978536e+00
 3.37434722e+00 8.60356132e+00 4.92569726e-01]
E = -507.9731143578063
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.2639259774         1
[INPUT] 0    0    [1    /1   ]  117616.814225        1
[INPUT] 0    0    [1    /1   ]  0.670866220991       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031129        1
[INPUT] 0    0    [1    /1   ]  147020.992137        1
[INPUT] 0    0    [1    /1   ]  73510.4209268        1
[INPUT] 0    0    [1    /1   ]  36754.7198056        1
[INPUT] 0    0    [1    /1   ]  7303.46064183        1
[INPUT] 0    0    [1    /1   ]  18375.8096938        1
[INPUT] 0    0    [1    /1   ]  1449.73288556        1
[INPUT] 0    0    [1    /1   ]  373.971416025        1
[INPUT] 0    0    [1    /1   ]  113.722721171        1
[INPUT] 0    0    [1    /1   ]  38.0996043065        1
[INPUT] 0    0    [1    /1   ]  8.40978535705        1
[INPUT] 0    0    [1    /1   ]  3.37434722196        1
[INPUT] 1    0    [1    /1   ]  8.60356132146        1
[INPUT] 1    0    [1    /1   ]  0.492569726183       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.263925977400128, 1.0]], [0, [117616.81422454792, 1.0]], [0, [0.670866220991252, 1.0]], [0, [1176168.1426188098, 1.0]], [0, [588084.069992098, 1.0]], [0, [294042.0311291971, 1.0]], [0, [147020.9921372498, 1.0]], [0, [73510.4209268028, 1.0]], [0, [36754.71980557158, 1.0]], [0, [7303.460641832762, 1.0]], [0, [18375.80969382018, 1.0]], [0, [1449.732885564298, 1.0]], [0, [373.97141602469776, 1.0]], [0, [113.72272117082798, 1.0]], [0, [38.09960430649213, 1.0]], [0, [8.409785357049252, 1.0]], [0, [3.37434722196364, 1.0]], [1, [8.603561321456944, 1.0]], [1, [0.49256972618309397, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26392598]
bas 1, expnt(s) = [117616.81422455]
bas 2, expnt(s) = [0.67086622]
bas 3, expnt(s) = [1176168.14261881]
bas 4, expnt(s) = [588084.0699921]
bas 5, expnt(s) = [294042.0311292]
bas 6, expnt(s) = [147020.99213725]
bas 7, expnt(s) = [73510.4209268]
bas 8, expnt(s) = [36754.71980557]
bas 9, expnt(s) = [7303.46064183]
bas 10, expnt(s) = [18375.80969382]
bas 11, expnt(s) = [1449.73288556]
bas 12, expnt(s) = [373.97141602]
bas 13, expnt(s) = [113.72272117]
bas 14, expnt(s) = [38.09960431]
bas 15, expnt(s) = [8.40978536]
bas 16, expnt(s) = [3.37434722]
bas 17, expnt(s) = [8.60356132]
bas 18, expnt(s) = [0.49256973]
CPU time:       245.20
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63925977e-01 9.30307727e-01 1.17616814e+05 1.60460109e+04
 6.70866221e-01 1.87280245e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547198e+04 6.70656073e+03 7.30346064e+03 1.99600463e+03
 1.83758097e+04 3.98749258e+03 1.44973289e+03 5.93582402e+02
 3.73971416e+02 2.14854192e+02 1.13722721e+02 8.79833424e+01
 3.80996043e+01 3.87440818e+01 8.40978536e+00 1.24768142e+01
 3.37434722e+00 6.29009713e+00 8.60356132e+00 4.29865128e+01
 4.92569726e-01 1.20384074e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33575220239008
cond(S) = 907774.7805284191
E1 = -689.5621387031572  E_coul = 184.95919420157222
init E= -504.602944501585
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672508979787504  LUMO = 0.772809848129179
  mo_energy =
[-1.21704989e+02 -1.33853021e+01 -7.62437885e+00 -7.62437885e+00
 -7.62437885e+00 -1.65765851e+00 -6.72508980e-01 -6.72508980e-01
 -6.72508980e-01  7.72809848e-01  1.26024062e+01  1.13534205e+02
  6.08976731e+02  2.74859226e+03  1.22272126e+04  4.08483998e+04
  1.04891876e+05  2.30075216e+05  4.55890083e+05  8.44842289e+05
  1.52801950e+06  2.85028683e+06  5.80817403e+06]
E1 = -707.7278563868732  E_coul = 199.7724142909644
cycle= 1 E= -507.955442095909  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625951
diis-c [-0.39181505  1.        ]
  HOMO = -0.217959821720885  LUMO = 1.17959256958514
  mo_energy =
[-1.20194446e+02 -1.23037046e+01 -6.59469003e+00 -6.59469003e+00
 -6.59469003e+00 -1.16324968e+00 -2.17959822e-01 -2.17959822e-01
 -2.17959822e-01  1.17959257e+00  1.35488177e+01  1.14935609e+02
  6.10473238e+02  2.75002800e+03  1.22285394e+04  4.08496602e+04
  1.04893100e+05  2.30076415e+05  4.55891265e+05  8.44843458e+05
  1.52802066e+06  2.85028798e+06  5.80817517e+06]
E1 = -706.7923646281845  E_coul = 198.81950219129348
cycle= 2 E= -507.972862436891  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257973
diis-c [-6.62516851e-04  2.75407381e-03  9.97245926e-01]
  HOMO = -0.239669427894922  LUMO = 1.17297021103021
  mo_energy =
[-1.20306628e+02 -1.23696033e+01 -6.66766880e+00 -6.66766880e+00
 -6.66766880e+00 -1.17722831e+00 -2.39669428e-01 -2.39669428e-01
 -2.39669428e-01  1.17297021e+00  1.34976986e+01  1.14841814e+02
  6.10357085e+02  2.74989592e+03  1.22283972e+04  4.08495143e+04
  1.04892952e+05  2.30076267e+05  4.55891116e+05  8.44843309e+05
  1.52802051e+06  2.85028783e+06  5.80817502e+06]
E1 = -706.6881741664441  E_coul = 198.71506433174866
cycle= 3 E= -507.973109834695  delta_E= -0.000247  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292268
diis-c [-1.54617821e-06 -1.77000831e-04 -1.14445025e-01  1.11462203e+00]
  HOMO = -0.242796026549204  LUMO = 1.17178982137398
  mo_energy =
[-1.20318718e+02 -1.23782819e+01 -6.67686255e+00 -6.67686255e+00
 -6.67686255e+00 -1.17912103e+00 -2.42796027e-01 -2.42796027e-01
 -2.42796027e-01  1.17178982e+00  1.34906911e+01  1.14831042e+02
  6.10344820e+02  2.74988278e+03  1.22283836e+04  4.08495005e+04
  1.04892938e+05  2.30076253e+05  4.55891102e+05  8.44843295e+05
  1.52802050e+06  2.85028782e+06  5.80817501e+06]
E1 = -706.6732950943946  E_coul = 198.70018074195664
cycle= 4 E= -507.973114352438  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108135
diis-c [-6.82557995e-11 -5.27819790e-06  7.33929434e-03 -9.10835887e-02
  1.08374957e+00]
  HOMO = -0.242900164011284  LUMO = 1.17174431054171
  mo_energy =
[-1.20318959e+02 -1.23785358e+01 -6.67711054e+00 -6.67711054e+00
 -6.67711054e+00 -1.17918214e+00 -2.42900164e-01 -2.42900164e-01
 -2.42900164e-01  1.17174431e+00  1.34904754e+01  1.14830798e+02
  6.10344580e+02  2.74988254e+03  1.22283833e+04  4.08495002e+04
  1.04892938e+05  2.30076253e+05  4.55891102e+05  8.44843295e+05
  1.52802050e+06  2.85028782e+06  5.80817501e+06]
E1 = -706.6728060022309  E_coul = 198.69969164442458
cycle= 5 E= -507.973114357806  delta_E= -5.37e-09  |g|= 2.57e-07  |ddm|= 0.00033
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58728e-07
diis-c [-1.11284738e-14  1.77600536e-07 -9.11436133e-05  1.01991996e-03
 -1.13986039e-02  1.01046965e+00]
  HOMO = -0.242900205994858  LUMO = 1.171744462364
  mo_energy =
[-1.20318960e+02 -1.23785360e+01 -6.67711084e+00 -6.67711084e+00
 -6.67711084e+00 -1.17918230e+00 -2.42900206e-01 -2.42900206e-01
 -2.42900206e-01  1.17174446e+00  1.34904753e+01  1.14830797e+02
  6.10344579e+02  2.74988254e+03  1.22283833e+04  4.08495002e+04
  1.04892938e+05  2.30076253e+05  4.55891102e+05  8.44843295e+05
  1.52802050e+06  2.85028782e+06  5.80817501e+06]
E1 = -706.6728056236618  E_coul = 198.69969126585562
cycle= 6 E= -507.973114357806  delta_E= 1.71e-13  |g|= 1.29e-08  |ddm|= 1.52e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6728056236618  E_coul = 198.69969126585562
  HOMO = -0.242900198979601  LUMO = 1.17174446451158
  mo_energy =
[-1.20318960e+02 -1.23785360e+01 -6.67711082e+00 -6.67711082e+00
 -6.67711082e+00 -1.17918229e+00 -2.42900199e-01 -2.42900199e-01
 -2.42900199e-01  1.17174446e+00  1.34904753e+01  1.14830797e+02
  6.10344579e+02  2.74988254e+03  1.22283833e+04  4.08495002e+04
  1.04892938e+05  2.30076253e+05  4.55891102e+05  8.44843295e+05
  1.52802050e+06  2.85028782e+06  5.80817501e+06]
E1 = -706.6728056580558  E_coul = 198.69969130024953
Extra cycle  E= -507.973114357806  delta_E= -1.14e-13  |g|= 2.02e-09  |ddm|= 2.29e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907774.7805284191
E1 = -706.6728056580558  E_coul = 198.69969130024953
init E= -507.973114357806
    CPU time for initialize scf      1.47 sec, wall time      0.09 sec
  HOMO = -0.242900198016321  LUMO = 1.17174446281156
  mo_energy =
[-1.20318960e+02 -1.23785360e+01 -6.67711082e+00 -6.67711082e+00
 -6.67711082e+00 -1.17918229e+00 -2.42900198e-01 -2.42900198e-01
 -2.42900198e-01  1.17174446e+00  1.34904753e+01  1.14830797e+02
  6.10344579e+02  2.74988254e+03  1.22283833e+04  4.08495002e+04
  1.04892938e+05  2.30076253e+05  4.55891102e+05  8.44843295e+05
  1.52802050e+06  2.85028782e+06  5.80817501e+06]
E1 = -706.6728056657073  E_coul = 198.69969130790057
cycle= 1 E= -507.973114357807  delta_E= -3.98e-13  |g|= 1.19e-09  |ddm|= 4.9e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.6728056657073  E_coul = 198.69969130790057
  HOMO = -0.242900197803893  LUMO = 1.17174446484679
  mo_energy =
[-1.20318960e+02 -1.23785360e+01 -6.67711082e+00 -6.67711082e+00
 -6.67711082e+00 -1.17918229e+00 -2.42900198e-01 -2.42900198e-01
 -2.42900198e-01  1.17174446e+00  1.34904753e+01  1.14830797e+02
  6.10344579e+02  2.74988254e+03  1.22283833e+04  4.08495002e+04
  1.04892938e+05  2.30076253e+05  4.55891102e+05  8.44843295e+05
  1.52802050e+06  2.85028782e+06  5.80817501e+06]
E1 = -706.672805663889  E_coul = 198.69969130608294
Extra cycle  E= -507.973114357806  delta_E= 6.82e-13  |g|= 7.91e-10  |ddm|= 1.14e-09
    CPU time for scf_cycle      1.65 sec, wall time      0.16 sec
exp = [2.63925977e-01 1.17616814e+05 6.70866221e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547198e+04 7.30346064e+03 1.83758097e+04 1.44973289e+03
 3.73971416e+02 1.13722721e+02 3.80996043e+01 8.40978536e+00
 3.37434722e+00 8.60356132e+00 4.92569726e-01]
grad_E = [ 1.95889676e-07  4.12710243e-09 -1.07444627e-07  1.81040776e-11
  1.10976578e-10  6.42162658e-10  2.51771471e-09  1.04576870e-08
  5.63237095e-08  3.53800918e-06  1.20461155e-07  7.69842816e-06
 -2.99174751e-05 -4.24230052e-06  1.31210229e-07  2.12356896e-07
 -2.19638647e-07 -1.17663745e-09 -2.92764241e-07]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263918717585       1
[INPUT] 0    0    [1    /1   ]  117616.814225        1
[INPUT] 0    0    [1    /1   ]  0.670846874732       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031129        1
[INPUT] 0    0    [1    /1   ]  147020.992137        1
[INPUT] 0    0    [1    /1   ]  73510.4209269        1
[INPUT] 0    0    [1    /1   ]  36754.7198063        1
[INPUT] 0    0    [1    /1   ]  7303.46068999        1
[INPUT] 0    0    [1    /1   ]  18375.8096955        1
[INPUT] 0    0    [1    /1   ]  1449.73286702        1
[INPUT] 0    0    [1    /1   ]  373.972369004        1
[INPUT] 0    0    [1    /1   ]  113.71902131         1
[INPUT] 0    0    [1    /1   ]  38.0981039483        1
[INPUT] 0    0    [1    /1   ]  8.40975582256        1
[INPUT] 0    0    [1    /1   ]  3.37429349976        1
[INPUT] 1    0    [1    /1   ]  8.60356153219        1
[INPUT] 1    0    [1    /1   ]  0.492569720085       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26391871758464674, 1.0]], [0, [117616.81422460395, 1.0]], [0, [0.670846874732051, 1.0]], [0, [1176168.14261881, 1.0]], [0, [588084.0699920995, 1.0]], [0, [294042.03112920583, 1.0]], [0, [147020.992137284, 1.0]], [0, [73510.42092694493, 1.0]], [0, [36754.719806334186, 1.0]], [0, [7303.460689985289, 1.0]], [0, [18375.809695479064, 1.0]], [0, [1449.7328670239597, 1.0]], [0, [373.9723690044691, 1.0]], [0, [113.71902131044361, 1.0]], [0, [38.09810394827392, 1.0]], [0, [8.40975582256021, 1.0]], [0, [3.374293499764091, 1.0]], [1, [8.603561532190128, 1.0]], [1, [0.49256972008468686, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26391872]
bas 1, expnt(s) = [117616.8142246]
bas 2, expnt(s) = [0.67084687]
bas 3, expnt(s) = [1176168.14261881]
bas 4, expnt(s) = [588084.0699921]
bas 5, expnt(s) = [294042.03112921]
bas 6, expnt(s) = [147020.99213728]
bas 7, expnt(s) = [73510.42092694]
bas 8, expnt(s) = [36754.71980633]
bas 9, expnt(s) = [7303.46068999]
bas 10, expnt(s) = [18375.80969548]
bas 11, expnt(s) = [1449.73286702]
bas 12, expnt(s) = [373.972369]
bas 13, expnt(s) = [113.71902131]
bas 14, expnt(s) = [38.09810395]
bas 15, expnt(s) = [8.40975582]
bas 16, expnt(s) = [3.3742935]
bas 17, expnt(s) = [8.60356153]
bas 18, expnt(s) = [0.49256972]
CPU time:       250.06
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63918718e-01 9.30288534e-01 1.17616814e+05 1.60460109e+04
 6.70846875e-01 1.87276194e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547198e+04 6.70656073e+03 7.30346069e+03 1.99600464e+03
 1.83758097e+04 3.98749258e+03 1.44973287e+03 5.93582397e+02
 3.73972369e+02 2.14854602e+02 1.13719021e+02 8.79811956e+01
 3.80981039e+01 3.87429375e+01 8.40975582e+00 1.24767813e+01
 3.37429350e+00 6.29002202e+00 8.60356153e+00 4.29865142e+01
 4.92569720e-01 1.20384072e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335752362468234
cond(S) = 907774.630407918
E1 = -689.5621286575483  E_coul = 184.95919351323863
init E= -504.60293514431
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672509009235317  LUMO = 0.772762968738017
  mo_energy =
[-1.21704989e+02 -1.33853022e+01 -7.62437893e+00 -7.62437893e+00
 -7.62437893e+00 -1.65765848e+00 -6.72509009e-01 -6.72509009e-01
 -6.72509009e-01  7.72762969e-01  1.26020462e+01  1.13529338e+02
  6.08962305e+02  2.74857572e+03  1.22271979e+04  4.08483863e+04
  1.04891863e+05  2.30075203e+05  4.55890070e+05  8.44842277e+05
  1.52801949e+06  2.85028682e+06  5.80817402e+06]
E1 = -707.7278463953601  E_coul = 199.7724042426396
cycle= 1 E= -507.95544215272  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.19 sec, wall time      0.01 sec
diis-norm(errvec)=0.625951
diis-c [-0.39181428  1.        ]
  HOMO = -0.217959885843527  LUMO = 1.17953755998936
  mo_energy =
[-1.20194448e+02 -1.23037053e+01 -6.59469080e+00 -6.59469080e+00
 -6.59469080e+00 -1.16324978e+00 -2.17959886e-01 -2.17959886e-01
 -2.17959886e-01  1.17953756e+00  1.35484513e+01  1.14930734e+02
  6.10458810e+02  2.75001146e+03  1.22285247e+04  4.08496466e+04
  1.04893087e+05  2.30076403e+05  4.55891253e+05  8.44843446e+05
  1.52802065e+06  2.85028797e+06  5.80817516e+06]
E1 = -706.7923562588036  E_coul = 198.8194938170329
cycle= 2 E= -507.972862441771  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257975
diis-c [-6.62530079e-04  2.75369003e-03  9.97246310e-01]
  HOMO = -0.239669529618963  LUMO = 1.17291555229439
  mo_energy =
[-1.20306630e+02 -1.23696038e+01 -6.66766943e+00 -6.66766943e+00
 -6.66766943e+00 -1.17722845e+00 -2.39669530e-01 -2.39669530e-01
 -2.39669530e-01  1.17291555e+00  1.34973328e+01  1.14836940e+02
  6.10342657e+02  2.74987938e+03  1.22283825e+04  4.08495008e+04
  1.04892939e+05  2.30076254e+05  4.55891104e+05  8.44843297e+05
  1.52802050e+06  2.85028782e+06  5.80817501e+06]
E1 = -706.6881646688025  E_coul = 198.71505482373126
cycle= 3 E= -507.973109845071  delta_E= -0.000247  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292273
diis-c [-1.54624253e-06 -1.77001288e-04 -1.14445832e-01  1.11462283e+00]
  HOMO = -0.242796175431361  LUMO = 1.17173519610569
  mo_energy =
[-1.20318720e+02 -1.23782825e+01 -6.67686325e+00 -6.67686325e+00
 -6.67686325e+00 -1.17912120e+00 -2.42796175e-01 -2.42796175e-01
 -2.42796175e-01  1.17173520e+00  1.34903253e+01  1.14826169e+02
  6.10330393e+02  2.74986624e+03  1.22283689e+04  4.08494869e+04
  1.04892925e+05  2.30076240e+05  4.55891090e+05  8.44843283e+05
  1.52802049e+06  2.85028781e+06  5.80817500e+06]
E1 = -706.6732852485874  E_coul = 198.70017088555488
cycle= 4 E= -507.973114363032  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00010814
diis-c [-6.82565291e-11 -5.28032845e-06  7.33941684e-03 -9.10851313e-02
  1.08375099e+00]
  HOMO = -0.242900318769206  LUMO = 1.17168968615379
  mo_energy =
[-1.20318961e+02 -1.23785364e+01 -6.67711124e+00 -6.67711124e+00
 -6.67711124e+00 -1.17918232e+00 -2.42900319e-01 -2.42900319e-01
 -2.42900319e-01  1.17168969e+00  1.34901096e+01  1.14825925e+02
  6.10330152e+02  2.74986600e+03  1.22283686e+04  4.08494867e+04
  1.04892925e+05  2.30076240e+05  4.55891090e+05  8.44843283e+05
  1.52802048e+06  2.85028781e+06  5.80817499e+06]
E1 = -706.6727961229506  E_coul = 198.69968175454912
cycle= 5 E= -507.973114368401  delta_E= -5.37e-09  |g|= 2.57e-07  |ddm|= 0.00033
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58057e-07
diis-c [-1.11052155e-14  1.76213121e-07 -9.06787084e-05  1.01433334e-03
 -1.13314321e-02  1.01040760e+00]
  HOMO = -0.242900360787476  LUMO = 1.17168983481411
  mo_energy =
[-1.20318962e+02 -1.23785367e+01 -6.67711155e+00 -6.67711155e+00
 -6.67711155e+00 -1.17918247e+00 -2.42900361e-01 -2.42900361e-01
 -2.42900361e-01  1.17168983e+00  1.34901095e+01  1.14825924e+02
  6.10330151e+02  2.74986600e+03  1.22283686e+04  4.08494867e+04
  1.04892925e+05  2.30076240e+05  4.55891090e+05  8.44843283e+05
  1.52802048e+06  2.85028781e+06  5.80817499e+06]
E1 = -706.672795744064  E_coul = 198.6996813756621
cycle= 6 E= -507.973114368402  delta_E= -5.68e-13  |g|= 1.31e-08  |ddm|= 1.52e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.672795744064  E_coul = 198.6996813756621
  HOMO = -0.242900353789651  LUMO = 1.17168983785082
  mo_energy =
[-1.20318962e+02 -1.23785366e+01 -6.67711153e+00 -6.67711153e+00
 -6.67711153e+00 -1.17918247e+00 -2.42900354e-01 -2.42900354e-01
 -2.42900354e-01  1.17168984e+00  1.34901095e+01  1.14825924e+02
  6.10330151e+02  2.74986600e+03  1.22283686e+04  4.08494867e+04
  1.04892925e+05  2.30076240e+05  4.55891090e+05  8.44843283e+05
  1.52802048e+06  2.85028781e+06  5.80817499e+06]
E1 = -706.6727957814211  E_coul = 198.69968141301948
Extra cycle  E= -507.973114368402  delta_E= 3.41e-13  |g|= 1.61e-09  |ddm|= 2.46e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.12 sec
exp = [2.63918718e-01 1.17616814e+05 6.70846875e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547198e+04 7.30346069e+03 1.83758097e+04 1.44973287e+03
 3.73972369e+02 1.13719021e+02 3.80981039e+01 8.40975582e+00
 3.37429350e+00 8.60356153e+00 4.92569720e-01]
E = -507.97311436840164
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263918717585       1
[INPUT] 0    0    [1    /1   ]  117616.814225        1
[INPUT] 0    0    [1    /1   ]  0.670846874732       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031129        1
[INPUT] 0    0    [1    /1   ]  147020.992137        1
[INPUT] 0    0    [1    /1   ]  73510.4209269        1
[INPUT] 0    0    [1    /1   ]  36754.7198063        1
[INPUT] 0    0    [1    /1   ]  7303.46068999        1
[INPUT] 0    0    [1    /1   ]  18375.8096955        1
[INPUT] 0    0    [1    /1   ]  1449.73286702        1
[INPUT] 0    0    [1    /1   ]  373.972369004        1
[INPUT] 0    0    [1    /1   ]  113.71902131         1
[INPUT] 0    0    [1    /1   ]  38.0981039483        1
[INPUT] 0    0    [1    /1   ]  8.40975582256        1
[INPUT] 0    0    [1    /1   ]  3.37429349976        1
[INPUT] 1    0    [1    /1   ]  8.60356153219        1
[INPUT] 1    0    [1    /1   ]  0.492569720085       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26391871758464674, 1.0]], [0, [117616.81422460395, 1.0]], [0, [0.670846874732051, 1.0]], [0, [1176168.14261881, 1.0]], [0, [588084.0699920995, 1.0]], [0, [294042.03112920583, 1.0]], [0, [147020.992137284, 1.0]], [0, [73510.42092694493, 1.0]], [0, [36754.719806334186, 1.0]], [0, [7303.460689985289, 1.0]], [0, [18375.809695479064, 1.0]], [0, [1449.7328670239597, 1.0]], [0, [373.9723690044691, 1.0]], [0, [113.71902131044361, 1.0]], [0, [38.09810394827392, 1.0]], [0, [8.40975582256021, 1.0]], [0, [3.374293499764091, 1.0]], [1, [8.603561532190128, 1.0]], [1, [0.49256972008468686, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26391872]
bas 1, expnt(s) = [117616.8142246]
bas 2, expnt(s) = [0.67084687]
bas 3, expnt(s) = [1176168.14261881]
bas 4, expnt(s) = [588084.0699921]
bas 5, expnt(s) = [294042.03112921]
bas 6, expnt(s) = [147020.99213728]
bas 7, expnt(s) = [73510.42092694]
bas 8, expnt(s) = [36754.71980633]
bas 9, expnt(s) = [7303.46068999]
bas 10, expnt(s) = [18375.80969548]
bas 11, expnt(s) = [1449.73286702]
bas 12, expnt(s) = [373.972369]
bas 13, expnt(s) = [113.71902131]
bas 14, expnt(s) = [38.09810395]
bas 15, expnt(s) = [8.40975582]
bas 16, expnt(s) = [3.3742935]
bas 17, expnt(s) = [8.60356153]
bas 18, expnt(s) = [0.49256972]
CPU time:       250.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63918718e-01 9.30288534e-01 1.17616814e+05 1.60460109e+04
 6.70846875e-01 1.87276194e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547198e+04 6.70656073e+03 7.30346069e+03 1.99600464e+03
 1.83758097e+04 3.98749258e+03 1.44973287e+03 5.93582397e+02
 3.73972369e+02 2.14854602e+02 1.13719021e+02 8.79811956e+01
 3.80981039e+01 3.87429375e+01 8.40975582e+00 1.24767813e+01
 3.37429350e+00 6.29002202e+00 8.60356153e+00 4.29865142e+01
 4.92569720e-01 1.20384072e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335752362468234
cond(S) = 907774.630407918
E1 = -689.5621286575483  E_coul = 184.95919351323863
init E= -504.60293514431
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672509009235317  LUMO = 0.772762968738017
  mo_energy =
[-1.21704989e+02 -1.33853022e+01 -7.62437893e+00 -7.62437893e+00
 -7.62437893e+00 -1.65765848e+00 -6.72509009e-01 -6.72509009e-01
 -6.72509009e-01  7.72762969e-01  1.26020462e+01  1.13529338e+02
  6.08962305e+02  2.74857572e+03  1.22271979e+04  4.08483863e+04
  1.04891863e+05  2.30075203e+05  4.55890070e+05  8.44842277e+05
  1.52801949e+06  2.85028682e+06  5.80817402e+06]
E1 = -707.7278463953601  E_coul = 199.7724042426396
cycle= 1 E= -507.95544215272  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625951
diis-c [-0.39181428  1.        ]
  HOMO = -0.217959885843527  LUMO = 1.17953755998936
  mo_energy =
[-1.20194448e+02 -1.23037053e+01 -6.59469080e+00 -6.59469080e+00
 -6.59469080e+00 -1.16324978e+00 -2.17959886e-01 -2.17959886e-01
 -2.17959886e-01  1.17953756e+00  1.35484513e+01  1.14930734e+02
  6.10458810e+02  2.75001146e+03  1.22285247e+04  4.08496466e+04
  1.04893087e+05  2.30076403e+05  4.55891253e+05  8.44843446e+05
  1.52802065e+06  2.85028797e+06  5.80817516e+06]
E1 = -706.7923562588036  E_coul = 198.8194938170329
cycle= 2 E= -507.972862441771  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257975
diis-c [-6.62530079e-04  2.75369003e-03  9.97246310e-01]
  HOMO = -0.239669529618963  LUMO = 1.17291555229439
  mo_energy =
[-1.20306630e+02 -1.23696038e+01 -6.66766943e+00 -6.66766943e+00
 -6.66766943e+00 -1.17722845e+00 -2.39669530e-01 -2.39669530e-01
 -2.39669530e-01  1.17291555e+00  1.34973328e+01  1.14836940e+02
  6.10342657e+02  2.74987938e+03  1.22283825e+04  4.08495008e+04
  1.04892939e+05  2.30076254e+05  4.55891104e+05  8.44843297e+05
  1.52802050e+06  2.85028782e+06  5.80817501e+06]
E1 = -706.6881646688025  E_coul = 198.71505482373126
cycle= 3 E= -507.973109845071  delta_E= -0.000247  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292273
diis-c [-1.54624253e-06 -1.77001288e-04 -1.14445832e-01  1.11462283e+00]
  HOMO = -0.242796175431361  LUMO = 1.17173519610569
  mo_energy =
[-1.20318720e+02 -1.23782825e+01 -6.67686325e+00 -6.67686325e+00
 -6.67686325e+00 -1.17912120e+00 -2.42796175e-01 -2.42796175e-01
 -2.42796175e-01  1.17173520e+00  1.34903253e+01  1.14826169e+02
  6.10330393e+02  2.74986624e+03  1.22283689e+04  4.08494869e+04
  1.04892925e+05  2.30076240e+05  4.55891090e+05  8.44843283e+05
  1.52802049e+06  2.85028781e+06  5.80817500e+06]
E1 = -706.6732852485874  E_coul = 198.70017088555488
cycle= 4 E= -507.973114363032  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00010814
diis-c [-6.82565291e-11 -5.28032845e-06  7.33941684e-03 -9.10851313e-02
  1.08375099e+00]
  HOMO = -0.242900318769206  LUMO = 1.17168968615379
  mo_energy =
[-1.20318961e+02 -1.23785364e+01 -6.67711124e+00 -6.67711124e+00
 -6.67711124e+00 -1.17918232e+00 -2.42900319e-01 -2.42900319e-01
 -2.42900319e-01  1.17168969e+00  1.34901096e+01  1.14825925e+02
  6.10330152e+02  2.74986600e+03  1.22283686e+04  4.08494867e+04
  1.04892925e+05  2.30076240e+05  4.55891090e+05  8.44843283e+05
  1.52802048e+06  2.85028781e+06  5.80817499e+06]
E1 = -706.6727961229506  E_coul = 198.69968175454912
cycle= 5 E= -507.973114368401  delta_E= -5.37e-09  |g|= 2.57e-07  |ddm|= 0.00033
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58057e-07
diis-c [-1.11052155e-14  1.76213121e-07 -9.06787084e-05  1.01433334e-03
 -1.13314321e-02  1.01040760e+00]
  HOMO = -0.242900360787476  LUMO = 1.17168983481411
  mo_energy =
[-1.20318962e+02 -1.23785367e+01 -6.67711155e+00 -6.67711155e+00
 -6.67711155e+00 -1.17918247e+00 -2.42900361e-01 -2.42900361e-01
 -2.42900361e-01  1.17168983e+00  1.34901095e+01  1.14825924e+02
  6.10330151e+02  2.74986600e+03  1.22283686e+04  4.08494867e+04
  1.04892925e+05  2.30076240e+05  4.55891090e+05  8.44843283e+05
  1.52802048e+06  2.85028781e+06  5.80817499e+06]
E1 = -706.672795744064  E_coul = 198.6996813756621
cycle= 6 E= -507.973114368402  delta_E= -5.68e-13  |g|= 1.31e-08  |ddm|= 1.52e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.672795744064  E_coul = 198.6996813756621
  HOMO = -0.242900353789651  LUMO = 1.17168983785082
  mo_energy =
[-1.20318962e+02 -1.23785366e+01 -6.67711153e+00 -6.67711153e+00
 -6.67711153e+00 -1.17918247e+00 -2.42900354e-01 -2.42900354e-01
 -2.42900354e-01  1.17168984e+00  1.34901095e+01  1.14825924e+02
  6.10330151e+02  2.74986600e+03  1.22283686e+04  4.08494867e+04
  1.04892925e+05  2.30076240e+05  4.55891090e+05  8.44843283e+05
  1.52802048e+06  2.85028781e+06  5.80817499e+06]
E1 = -706.6727957814211  E_coul = 198.69968141301948
Extra cycle  E= -507.973114368402  delta_E= 3.41e-13  |g|= 1.61e-09  |ddm|= 2.46e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907774.630407918
E1 = -706.6727957814211  E_coul = 198.69968141301948
init E= -507.973114368402
    CPU time for initialize scf      1.49 sec, wall time      0.09 sec
  HOMO = -0.242900352763239  LUMO = 1.17168983884575
  mo_energy =
[-1.20318962e+02 -1.23785366e+01 -6.67711152e+00 -6.67711152e+00
 -6.67711152e+00 -1.17918247e+00 -2.42900353e-01 -2.42900353e-01
 -2.42900353e-01  1.17168984e+00  1.34901095e+01  1.14825924e+02
  6.10330151e+02  2.74986600e+03  1.22283686e+04  4.08494867e+04
  1.04892925e+05  2.30076240e+05  4.55891090e+05  8.44843283e+05
  1.52802048e+06  2.85028781e+06  5.80817499e+06]
E1 = -706.672795784448  E_coul = 198.6996814160461
cycle= 1 E= -507.973114368402  delta_E= -2.27e-13  |g|= 1.49e-09  |ddm|= 2.02e-09
    CPU time for cycle= 1      0.10 sec, wall time      0.01 sec
E1 = -706.672795784448  E_coul = 198.6996814160461
  HOMO = -0.242900352673918  LUMO = 1.17168984077746
  mo_energy =
[-1.20318962e+02 -1.23785366e+01 -6.67711152e+00 -6.67711152e+00
 -6.67711152e+00 -1.17918247e+00 -2.42900353e-01 -2.42900353e-01
 -2.42900353e-01  1.17168984e+00  1.34901095e+01  1.14825924e+02
  6.10330151e+02  2.74986600e+03  1.22283686e+04  4.08494867e+04
  1.04892925e+05  2.30076240e+05  4.55891090e+05  8.44843283e+05
  1.52802048e+06  2.85028781e+06  5.80817499e+06]
E1 = -706.6727957854996  E_coul = 198.69968141709765
Extra cycle  E= -507.973114368402  delta_E= -1.14e-13  |g|= 2.36e-09  |ddm|= 7.95e-10
    CPU time for scf_cycle      1.65 sec, wall time      0.16 sec
exp = [2.63918718e-01 1.17616814e+05 6.70846875e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547198e+04 7.30346069e+03 1.83758097e+04 1.44973287e+03
 3.73972369e+02 1.13719021e+02 3.80981039e+01 8.40975582e+00
 3.37429350e+00 8.60356153e+00 4.92569720e-01]
grad_E = [ 1.64669968e-06  4.12783646e-09 -9.81489713e-07  1.81128145e-11
  1.11000405e-10  6.42276313e-10  2.51816832e-09  1.04595989e-08
  5.63331390e-08  3.53867793e-06  1.20489775e-07  7.66248796e-06
 -2.95196992e-05 -5.38443358e-06  6.04318938e-08  9.14768323e-07
 -1.46033045e-06 -2.87912059e-08 -2.34657301e-06]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263906314671       1
[INPUT] 0    0    [1    /1   ]  117616.814225        1
[INPUT] 0    0    [1    /1   ]  0.670813649773       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031129        1
[INPUT] 0    0    [1    /1   ]  147020.992137        1
[INPUT] 0    0    [1    /1   ]  73510.4209269        1
[INPUT] 0    0    [1    /1   ]  36754.7198063        1
[INPUT] 0    0    [1    /1   ]  7303.46068918        1
[INPUT] 0    0    [1    /1   ]  18375.8096955        1
[INPUT] 0    0    [1    /1   ]  1449.73265712        1
[INPUT] 0    0    [1    /1   ]  373.9746716          1
[INPUT] 0    0    [1    /1   ]  113.712874497        1
[INPUT] 0    0    [1    /1   ]  38.095570626         1
[INPUT] 0    0    [1    /1   ]  8.40970890115        1
[INPUT] 0    0    [1    /1   ]  3.37420299256        1
[INPUT] 1    0    [1    /1   ]  8.60356188677        1
[INPUT] 1    0    [1    /1   ]  0.492569706588       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26390631467101583, 1.0]], [0, [117616.81422460276, 1.0]], [0, [0.6708136497729319, 1.0]], [0, [1176168.14261881, 1.0]], [0, [588084.0699920995, 1.0]], [0, [294042.03112920566, 1.0]], [0, [147020.9921372833, 1.0]], [0, [73510.4209269422, 1.0]], [0, [36754.71980631463, 1.0]], [0, [7303.4606891769345, 1.0]], [0, [18375.80969548428, 1.0]], [0, [1449.7326571161157, 1.0]], [0, [373.9746716003208, 1.0]], [0, [113.71287449719291, 1.0]], [0, [38.09557062602627, 1.0]], [0, [8.409708901148873, 1.0]], [0, [3.374202992558027, 1.0]], [1, [8.60356188676936, 1.0]], [1, [0.4925697065884563, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26390631]
bas 1, expnt(s) = [117616.8142246]
bas 2, expnt(s) = [0.67081365]
bas 3, expnt(s) = [1176168.14261881]
bas 4, expnt(s) = [588084.0699921]
bas 5, expnt(s) = [294042.03112921]
bas 6, expnt(s) = [147020.99213728]
bas 7, expnt(s) = [73510.42092694]
bas 8, expnt(s) = [36754.71980631]
bas 9, expnt(s) = [7303.46068918]
bas 10, expnt(s) = [18375.80969548]
bas 11, expnt(s) = [1449.73265712]
bas 12, expnt(s) = [373.9746716]
bas 13, expnt(s) = [113.7128745]
bas 14, expnt(s) = [38.09557063]
bas 15, expnt(s) = [8.4097089]
bas 16, expnt(s) = [3.37420299]
bas 17, expnt(s) = [8.60356189]
bas 18, expnt(s) = [0.49256971]
CPU time:       255.53
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63906315e-01 9.30255745e-01 1.17616814e+05 1.60460109e+04
 6.70813650e-01 1.87269238e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547198e+04 6.70656073e+03 7.30346069e+03 1.99600464e+03
 1.83758097e+04 3.98749258e+03 1.44973266e+03 5.93582332e+02
 3.73974672e+02 2.14855594e+02 1.13712874e+02 8.79776288e+01
 3.80955706e+01 3.87410053e+01 8.40970890e+00 1.24767291e+01
 3.37420299e+00 6.28989548e+00 8.60356189e+00 4.29865164e+01
 4.92569707e-01 1.20384068e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33575263856088
cond(S) = 907774.3943060413
E1 = -689.562110672674  E_coul = 184.95919218151212
init E= -504.602918491162
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672509064798594  LUMO = 0.772682728632163
  mo_energy =
[-1.21704989e+02 -1.33853023e+01 -7.62437908e+00 -7.62437908e+00
 -7.62437908e+00 -1.65765844e+00 -6.72509065e-01 -6.72509065e-01
 -6.72509065e-01  7.72682729e-01  1.26014386e+01  1.13521173e+02
  6.08938720e+02  2.74854994e+03  1.22271753e+04  4.08483653e+04
  1.04891843e+05  2.30075184e+05  4.55890051e+05  8.44842258e+05
  1.52801947e+06  2.85028680e+06  5.80817400e+06]
E1 = -707.727829182945  E_coul = 199.77238692018534
cycle= 1 E= -507.95544226276  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.62595
diis-c [-0.39181293  1.        ]
  HOMO = -0.217960001100541  LUMO = 1.17944341623711
  mo_energy =
[-1.20194451e+02 -1.23037064e+01 -6.59469214e+00 -6.59469214e+00
 -6.59469214e+00 -1.16324997e+00 -2.17960001e-01 -2.17960001e-01
 -2.17960001e-01  1.17944342e+00  1.35478329e+01  1.14922556e+02
  6.10435220e+02  2.74998567e+03  1.22285021e+04  4.08496257e+04
  1.04893066e+05  2.30076383e+05  4.55891234e+05  8.44843427e+05
  1.52802063e+06  2.85028795e+06  5.80817514e+06]
E1 = -706.7923418791588  E_coul = 198.81947941769397
cycle= 2 E= -507.972862461465  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257979
diis-c [-6.62552527e-04  2.75304106e-03  9.97246959e-01]
  HOMO = -0.239669707921982  LUMO = 1.17282200547915
  mo_energy =
[-1.20306632e+02 -1.23696048e+01 -6.66767051e+00 -6.66767051e+00
 -6.66767051e+00 -1.17722869e+00 -2.39669708e-01 -2.39669708e-01
 -2.39669708e-01  1.17282201e+00  1.34967156e+01  1.14828764e+02
  6.10319067e+02  2.74985359e+03  1.22283600e+04  4.08494798e+04
  1.04892919e+05  2.30076235e+05  4.55891085e+05  8.44843278e+05
  1.52802048e+06  2.85028780e+06  5.80817499e+06]
E1 = -706.6881483658577  E_coul = 198.7150384917109
cycle= 3 E= -507.973109874147  delta_E= -0.000247  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292281
diis-c [-1.54634780e-06 -1.76998880e-04 -1.14447249e-01  1.11462425e+00]
  HOMO = -0.242796434406775  LUMO = 1.17164170636006
  mo_energy =
[-1.20318722e+02 -1.23782835e+01 -6.67686444e+00 -6.67686444e+00
 -6.67686444e+00 -1.17912149e+00 -2.42796434e-01 -2.42796434e-01
 -2.42796434e-01  1.17164171e+00  1.34897081e+01  1.14817992e+02
  6.10306803e+02  2.74984045e+03  1.22283463e+04  4.08494660e+04
  1.04892905e+05  2.30076221e+05  4.55891071e+05  8.44843264e+05
  1.52802047e+06  2.85028779e+06  5.80817498e+06]
E1 = -706.6732683472687  E_coul = 198.7001539547854
cycle= 4 E= -507.973114392483  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108147
diis-c [-6.82487666e-11 -5.28326379e-06  7.33958907e-03 -9.10873452e-02
  1.08375304e+00]
  HOMO = -0.242900587781142  LUMO = 1.17159619367821
  mo_energy =
[-1.20318964e+02 -1.23785375e+01 -6.67711245e+00 -6.67711245e+00
 -6.67711245e+00 -1.17918262e+00 -2.42900588e-01 -2.42900588e-01
 -2.42900588e-01  1.17159619e+00  1.34894923e+01  1.14817748e+02
  6.10306562e+02  2.74984021e+03  1.22283461e+04  4.08494657e+04
  1.04892905e+05  2.30076221e+05  4.55891071e+05  8.44843264e+05
  1.52802047e+06  2.85028779e+06  5.80817498e+06]
E1 = -706.6727791671226  E_coul = 198.69966476926928
cycle= 5 E= -507.973114397853  delta_E= -5.37e-09  |g|= 2.56e-07  |ddm|= 0.00033
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.57894e-07
diis-c [-1.10217105e-14  1.77805558e-07 -9.10267609e-05  1.01898300e-03
 -1.13973162e-02  1.01046918e+00]
  HOMO = -0.242900629925765  LUMO = 1.17159634723329
  mo_energy =
[-1.20318964e+02 -1.23785377e+01 -6.67711276e+00 -6.67711276e+00
 -6.67711276e+00 -1.17918277e+00 -2.42900630e-01 -2.42900630e-01
 -2.42900630e-01  1.17159635e+00  1.34894922e+01  1.14817748e+02
  6.10306561e+02  2.74984021e+03  1.22283461e+04  4.08494657e+04
  1.04892905e+05  2.30076221e+05  4.55891071e+05  8.44843264e+05
  1.52802047e+06  2.85028779e+06  5.80817498e+06]
E1 = -706.6727787870648  E_coul = 198.69966438921134
cycle= 6 E= -507.973114397853  delta_E= -1.14e-13  |g|= 1.36e-08  |ddm|= 1.52e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6727787870648  E_coul = 198.69966438921134
  HOMO = -0.242900622950456  LUMO = 1.17159634623846
  mo_energy =
[-1.20318964e+02 -1.23785377e+01 -6.67711274e+00 -6.67711274e+00
 -6.67711274e+00 -1.17918277e+00 -2.42900623e-01 -2.42900623e-01
 -2.42900623e-01  1.17159635e+00  1.34894922e+01  1.14817748e+02
  6.10306561e+02  2.74984021e+03  1.22283461e+04  4.08494657e+04
  1.04892905e+05  2.30076221e+05  4.55891071e+05  8.44843264e+05
  1.52802047e+06  2.85028779e+06  5.80817498e+06]
E1 = -706.6727788251  E_coul = 198.69966442724635
Extra cycle  E= -507.973114397854  delta_E= -1.14e-13  |g|= 2.02e-09  |ddm|= 2.52e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.63906315e-01 1.17616814e+05 6.70813650e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547198e+04 7.30346069e+03 1.83758097e+04 1.44973266e+03
 3.73974672e+02 1.13712874e+02 3.80955706e+01 8.40970890e+00
 3.37420299e+00 8.60356189e+00 4.92569707e-01]
E = -507.9731143978536
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263906314671       1
[INPUT] 0    0    [1    /1   ]  117616.814225        1
[INPUT] 0    0    [1    /1   ]  0.670813649773       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031129        1
[INPUT] 0    0    [1    /1   ]  147020.992137        1
[INPUT] 0    0    [1    /1   ]  73510.4209269        1
[INPUT] 0    0    [1    /1   ]  36754.7198063        1
[INPUT] 0    0    [1    /1   ]  7303.46068918        1
[INPUT] 0    0    [1    /1   ]  18375.8096955        1
[INPUT] 0    0    [1    /1   ]  1449.73265712        1
[INPUT] 0    0    [1    /1   ]  373.9746716          1
[INPUT] 0    0    [1    /1   ]  113.712874497        1
[INPUT] 0    0    [1    /1   ]  38.095570626         1
[INPUT] 0    0    [1    /1   ]  8.40970890115        1
[INPUT] 0    0    [1    /1   ]  3.37420299256        1
[INPUT] 1    0    [1    /1   ]  8.60356188677        1
[INPUT] 1    0    [1    /1   ]  0.492569706588       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26390631467101583, 1.0]], [0, [117616.81422460276, 1.0]], [0, [0.6708136497729319, 1.0]], [0, [1176168.14261881, 1.0]], [0, [588084.0699920995, 1.0]], [0, [294042.03112920566, 1.0]], [0, [147020.9921372833, 1.0]], [0, [73510.4209269422, 1.0]], [0, [36754.71980631463, 1.0]], [0, [7303.4606891769345, 1.0]], [0, [18375.80969548428, 1.0]], [0, [1449.7326571161157, 1.0]], [0, [373.9746716003208, 1.0]], [0, [113.71287449719291, 1.0]], [0, [38.09557062602627, 1.0]], [0, [8.409708901148873, 1.0]], [0, [3.374202992558027, 1.0]], [1, [8.60356188676936, 1.0]], [1, [0.4925697065884563, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26390631]
bas 1, expnt(s) = [117616.8142246]
bas 2, expnt(s) = [0.67081365]
bas 3, expnt(s) = [1176168.14261881]
bas 4, expnt(s) = [588084.0699921]
bas 5, expnt(s) = [294042.03112921]
bas 6, expnt(s) = [147020.99213728]
bas 7, expnt(s) = [73510.42092694]
bas 8, expnt(s) = [36754.71980631]
bas 9, expnt(s) = [7303.46068918]
bas 10, expnt(s) = [18375.80969548]
bas 11, expnt(s) = [1449.73265712]
bas 12, expnt(s) = [373.9746716]
bas 13, expnt(s) = [113.7128745]
bas 14, expnt(s) = [38.09557063]
bas 15, expnt(s) = [8.4097089]
bas 16, expnt(s) = [3.37420299]
bas 17, expnt(s) = [8.60356189]
bas 18, expnt(s) = [0.49256971]
CPU time:       256.14
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63906315e-01 9.30255745e-01 1.17616814e+05 1.60460109e+04
 6.70813650e-01 1.87269238e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547198e+04 6.70656073e+03 7.30346069e+03 1.99600464e+03
 1.83758097e+04 3.98749258e+03 1.44973266e+03 5.93582332e+02
 3.73974672e+02 2.14855594e+02 1.13712874e+02 8.79776288e+01
 3.80955706e+01 3.87410053e+01 8.40970890e+00 1.24767291e+01
 3.37420299e+00 6.28989548e+00 8.60356189e+00 4.29865164e+01
 4.92569707e-01 1.20384068e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33575263856088
cond(S) = 907774.3943060413
E1 = -689.562110672674  E_coul = 184.95919218151212
init E= -504.602918491162
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672509064798594  LUMO = 0.772682728632163
  mo_energy =
[-1.21704989e+02 -1.33853023e+01 -7.62437908e+00 -7.62437908e+00
 -7.62437908e+00 -1.65765844e+00 -6.72509065e-01 -6.72509065e-01
 -6.72509065e-01  7.72682729e-01  1.26014386e+01  1.13521173e+02
  6.08938720e+02  2.74854994e+03  1.22271753e+04  4.08483653e+04
  1.04891843e+05  2.30075184e+05  4.55890051e+05  8.44842258e+05
  1.52801947e+06  2.85028680e+06  5.80817400e+06]
E1 = -707.727829182945  E_coul = 199.77238692018534
cycle= 1 E= -507.95544226276  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.62595
diis-c [-0.39181293  1.        ]
  HOMO = -0.217960001100541  LUMO = 1.17944341623711
  mo_energy =
[-1.20194451e+02 -1.23037064e+01 -6.59469214e+00 -6.59469214e+00
 -6.59469214e+00 -1.16324997e+00 -2.17960001e-01 -2.17960001e-01
 -2.17960001e-01  1.17944342e+00  1.35478329e+01  1.14922556e+02
  6.10435220e+02  2.74998567e+03  1.22285021e+04  4.08496257e+04
  1.04893066e+05  2.30076383e+05  4.55891234e+05  8.44843427e+05
  1.52802063e+06  2.85028795e+06  5.80817514e+06]
E1 = -706.7923418791588  E_coul = 198.81947941769397
cycle= 2 E= -507.972862461465  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257979
diis-c [-6.62552527e-04  2.75304106e-03  9.97246959e-01]
  HOMO = -0.239669707921982  LUMO = 1.17282200547915
  mo_energy =
[-1.20306632e+02 -1.23696048e+01 -6.66767051e+00 -6.66767051e+00
 -6.66767051e+00 -1.17722869e+00 -2.39669708e-01 -2.39669708e-01
 -2.39669708e-01  1.17282201e+00  1.34967156e+01  1.14828764e+02
  6.10319067e+02  2.74985359e+03  1.22283600e+04  4.08494798e+04
  1.04892919e+05  2.30076235e+05  4.55891085e+05  8.44843278e+05
  1.52802048e+06  2.85028780e+06  5.80817499e+06]
E1 = -706.6881483658577  E_coul = 198.7150384917109
cycle= 3 E= -507.973109874147  delta_E= -0.000247  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292281
diis-c [-1.54634780e-06 -1.76998880e-04 -1.14447249e-01  1.11462425e+00]
  HOMO = -0.242796434406775  LUMO = 1.17164170636006
  mo_energy =
[-1.20318722e+02 -1.23782835e+01 -6.67686444e+00 -6.67686444e+00
 -6.67686444e+00 -1.17912149e+00 -2.42796434e-01 -2.42796434e-01
 -2.42796434e-01  1.17164171e+00  1.34897081e+01  1.14817992e+02
  6.10306803e+02  2.74984045e+03  1.22283463e+04  4.08494660e+04
  1.04892905e+05  2.30076221e+05  4.55891071e+05  8.44843264e+05
  1.52802047e+06  2.85028779e+06  5.80817498e+06]
E1 = -706.6732683472687  E_coul = 198.7001539547854
cycle= 4 E= -507.973114392483  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108147
diis-c [-6.82487666e-11 -5.28326379e-06  7.33958907e-03 -9.10873452e-02
  1.08375304e+00]
  HOMO = -0.242900587781142  LUMO = 1.17159619367821
  mo_energy =
[-1.20318964e+02 -1.23785375e+01 -6.67711245e+00 -6.67711245e+00
 -6.67711245e+00 -1.17918262e+00 -2.42900588e-01 -2.42900588e-01
 -2.42900588e-01  1.17159619e+00  1.34894923e+01  1.14817748e+02
  6.10306562e+02  2.74984021e+03  1.22283461e+04  4.08494657e+04
  1.04892905e+05  2.30076221e+05  4.55891071e+05  8.44843264e+05
  1.52802047e+06  2.85028779e+06  5.80817498e+06]
E1 = -706.6727791671226  E_coul = 198.69966476926928
cycle= 5 E= -507.973114397853  delta_E= -5.37e-09  |g|= 2.56e-07  |ddm|= 0.00033
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.57894e-07
diis-c [-1.10217105e-14  1.77805558e-07 -9.10267609e-05  1.01898300e-03
 -1.13973162e-02  1.01046918e+00]
  HOMO = -0.242900629925765  LUMO = 1.17159634723329
  mo_energy =
[-1.20318964e+02 -1.23785377e+01 -6.67711276e+00 -6.67711276e+00
 -6.67711276e+00 -1.17918277e+00 -2.42900630e-01 -2.42900630e-01
 -2.42900630e-01  1.17159635e+00  1.34894922e+01  1.14817748e+02
  6.10306561e+02  2.74984021e+03  1.22283461e+04  4.08494657e+04
  1.04892905e+05  2.30076221e+05  4.55891071e+05  8.44843264e+05
  1.52802047e+06  2.85028779e+06  5.80817498e+06]
E1 = -706.6727787870648  E_coul = 198.69966438921134
cycle= 6 E= -507.973114397853  delta_E= -1.14e-13  |g|= 1.36e-08  |ddm|= 1.52e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6727787870648  E_coul = 198.69966438921134
  HOMO = -0.242900622950456  LUMO = 1.17159634623846
  mo_energy =
[-1.20318964e+02 -1.23785377e+01 -6.67711274e+00 -6.67711274e+00
 -6.67711274e+00 -1.17918277e+00 -2.42900623e-01 -2.42900623e-01
 -2.42900623e-01  1.17159635e+00  1.34894922e+01  1.14817748e+02
  6.10306561e+02  2.74984021e+03  1.22283461e+04  4.08494657e+04
  1.04892905e+05  2.30076221e+05  4.55891071e+05  8.44843264e+05
  1.52802047e+06  2.85028779e+06  5.80817498e+06]
E1 = -706.6727788251  E_coul = 198.69966442724635
Extra cycle  E= -507.973114397854  delta_E= -1.14e-13  |g|= 2.02e-09  |ddm|= 2.52e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907774.3943060413
E1 = -706.6727788251  E_coul = 198.69966442724635
init E= -507.973114397854
    CPU time for initialize scf      1.40 sec, wall time      0.09 sec
  HOMO = -0.242900621883122  LUMO = 1.17159634626094
  mo_energy =
[-1.20318964e+02 -1.23785377e+01 -6.67711273e+00 -6.67711273e+00
 -6.67711273e+00 -1.17918277e+00 -2.42900622e-01 -2.42900622e-01
 -2.42900622e-01  1.17159635e+00  1.34894922e+01  1.14817748e+02
  6.10306561e+02  2.74984021e+03  1.22283461e+04  4.08494657e+04
  1.04892905e+05  2.30076221e+05  4.55891071e+05  8.44843264e+05
  1.52802047e+06  2.85028779e+06  5.80817498e+06]
E1 = -706.6727788317143  E_coul = 198.69966443386065
cycle= 1 E= -507.973114397854  delta_E=    0  |g|= 1.04e-09  |ddm|= 4.19e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6727788317143  E_coul = 198.69966443386065
  HOMO = -0.242900621703514  LUMO = 1.17159634611016
  mo_energy =
[-1.20318964e+02 -1.23785377e+01 -6.67711273e+00 -6.67711273e+00
 -6.67711273e+00 -1.17918277e+00 -2.42900622e-01 -2.42900622e-01
 -2.42900622e-01  1.17159635e+00  1.34894922e+01  1.14817748e+02
  6.10306561e+02  2.74984021e+03  1.22283461e+04  4.08494657e+04
  1.04892905e+05  2.30076221e+05  4.55891071e+05  8.44843264e+05
  1.52802047e+06  2.85028779e+06  5.80817498e+06]
E1 = -706.6727788319101  E_coul = 198.6996644340562
Extra cycle  E= -507.973114397854  delta_E= -3.41e-13  |g|= 1.43e-09  |ddm|= 2.53e-10
    CPU time for scf_cycle      1.57 sec, wall time      0.16 sec
exp = [2.63906315e-01 1.17616814e+05 6.70813650e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547198e+04 7.30346069e+03 1.83758097e+04 1.44973266e+03
 3.73974672e+02 1.13712874e+02 3.80955706e+01 8.40970890e+00
 3.37420299e+00 8.60356189e+00 4.92569707e-01]
grad_E = [ 4.19416340e-06  4.12915896e-09 -2.52429876e-06  1.81285549e-11
  1.11043335e-10  6.42481084e-10  2.51898561e-09  1.04630435e-08
  5.63501267e-08  3.53988071e-06  1.20541342e-07  7.59850708e-06
 -2.88253040e-05 -7.35306207e-06 -5.91225452e-08  2.12247944e-06
 -3.59700874e-06 -7.48419211e-08 -5.95515434e-06]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263887166039       1
[INPUT] 0    0    [1    /1   ]  117616.814224        1
[INPUT] 0    0    [1    /1   ]  0.670762058778       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031129        1
[INPUT] 0    0    [1    /1   ]  147020.992137        1
[INPUT] 0    0    [1    /1   ]  73510.4209263        1
[INPUT] 0    0    [1    /1   ]  36754.7198028        1
[INPUT] 0    0    [1    /1   ]  7303.46047177        1
[INPUT] 0    0    [1    /1   ]  18375.8096881        1
[INPUT] 0    0    [1    /1   ]  1449.73186732        1
[INPUT] 0    0    [1    /1   ]  373.980003157        1
[INPUT] 0    0    [1    /1   ]  113.703780023        1
[INPUT] 0    0    [1    /1   ]  38.0917127257        1
[INPUT] 0    0    [1    /1   ]  8.40964643441        1
[INPUT] 0    0    [1    /1   ]  3.37406607898        1
[INPUT] 1    0    [1    /1   ]  8.60356242302        1
[INPUT] 1    0    [1    /1   ]  0.492569680929       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26388716603894075, 1.0]], [0, [117616.81422434877, 1.0]], [0, [0.6707620587778504, 1.0]], [0, [1176168.142618809, 1.0]], [0, [588084.0699920928, 1.0]], [0, [294042.03112916613, 1.0]], [0, [147020.9921371284, 1.0]], [0, [73510.42092629905, 1.0]], [0, [36754.7198028434, 1.0]], [0, [7303.460471768962, 1.0]], [0, [18375.809688131845, 1.0]], [0, [1449.7318673232585, 1.0]], [0, [373.98000315694384, 1.0]], [0, [113.70378002280673, 1.0]], [0, [38.091712725746234, 1.0]], [0, [8.40964643440782, 1.0]], [0, [3.3740660789829184, 1.0]], [1, [8.603562423015799, 1.0]], [1, [0.49256968092941855, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26388717]
bas 1, expnt(s) = [117616.81422435]
bas 2, expnt(s) = [0.67076206]
bas 3, expnt(s) = [1176168.14261881]
bas 4, expnt(s) = [588084.06999209]
bas 5, expnt(s) = [294042.03112917]
bas 6, expnt(s) = [147020.99213713]
bas 7, expnt(s) = [73510.4209263]
bas 8, expnt(s) = [36754.71980284]
bas 9, expnt(s) = [7303.46047177]
bas 10, expnt(s) = [18375.80968813]
bas 11, expnt(s) = [1449.73186732]
bas 12, expnt(s) = [373.98000316]
bas 13, expnt(s) = [113.70378002]
bas 14, expnt(s) = [38.09171273]
bas 15, expnt(s) = [8.40964643]
bas 16, expnt(s) = [3.37406608]
bas 17, expnt(s) = [8.60356242]
bas 18, expnt(s) = [0.49256968]
CPU time:       260.92
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63887166e-01 9.30205121e-01 1.17616814e+05 1.60460109e+04
 6.70762059e-01 1.87258436e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547198e+04 6.70656073e+03 7.30346047e+03 1.99600459e+03
 1.83758097e+04 3.98749258e+03 1.44973187e+03 5.93582090e+02
 3.73980003e+02 2.14857892e+02 1.13703780e+02 8.79723516e+01
 3.80917127e+01 3.87380629e+01 8.40964643e+00 1.24766596e+01
 3.37406608e+00 6.28970406e+00 8.60356242e+00 4.29865197e+01
 4.92569681e-01 1.20384061e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33575306850466
cond(S) = 907774.0801812017
E1 = -689.5620808201726  E_coul = 184.95918987729206
init E= -504.602890942881
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.672509158979256  LUMO = 0.772558612203364
  mo_energy =
[-1.21704988e+02 -1.33853025e+01 -7.62437932e+00 -7.62437932e+00
 -7.62437932e+00 -1.65765839e+00 -6.72509159e-01 -6.72509159e-01
 -6.72509159e-01  7.72558612e-01  1.26005194e+01  1.13508884e+02
  6.08904844e+02  2.74851632e+03  1.22271469e+04  4.08483386e+04
  1.04891817e+05  2.30075158e+05  4.55890026e+05  8.44842233e+05
  1.52801945e+06  2.85028678e+06  5.80817398e+06]
E1 = -707.7278023327195  E_coul = 199.77235986744836
cycle= 1 E= -507.955442465271  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625948
diis-c [-0.39181061  1.        ]
  HOMO = -0.217960188111912  LUMO = 1.17929781163563
  mo_energy =
[-1.20194455e+02 -1.23037083e+01 -6.59469423e+00 -6.59469423e+00
 -6.59469423e+00 -1.16325025e+00 -2.17960188e-01 -2.17960188e-01
 -2.17960188e-01  1.17929781e+00  1.35468976e+01  1.14910249e+02
  6.10401337e+02  2.74995204e+03  1.22284737e+04  4.08495989e+04
  1.04893041e+05  2.30076358e+05  4.55891209e+05  8.44843402e+05
  1.52802061e+06  2.85028793e+06  5.80817512e+06]
E1 = -706.792319522267  E_coul = 198.81945700064003
cycle= 2 E= -507.972862521627  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257986
diis-c [-6.62587147e-04  2.75204204e-03  9.97247958e-01]
  HOMO = -0.239669990335597  LUMO = 1.17267732642639
  mo_energy =
[-1.20306636e+02 -1.23696062e+01 -6.66767218e+00 -6.66767218e+00
 -6.66767218e+00 -1.17722907e+00 -2.39669990e-01 -2.39669990e-01
 -2.39669990e-01  1.17267733e+00  1.34957820e+01  1.14816459e+02
  6.10285185e+02  2.74981997e+03  1.22283315e+04  4.08494531e+04
  1.04892893e+05  2.30076209e+05  4.55891060e+05  8.44843253e+05
  1.52802046e+06  2.85028778e+06  5.80817497e+06]
E1 = -706.6881230365177  E_coul = 198.71501308768336
cycle= 3 E= -507.973109948834  delta_E= -0.000247  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292294
diis-c [-1.54651611e-06 -1.77004189e-04 -1.14449336e-01  1.11462634e+00]
  HOMO = -0.242796841604304  LUMO = 1.17149711488355
  mo_energy =
[-1.20318727e+02 -1.23782852e+01 -6.67686629e+00 -6.67686629e+00
 -6.67686629e+00 -1.17912196e+00 -2.42796842e-01 -2.42796842e-01
 -2.42796842e-01  1.17149711e+00  1.34887745e+01  1.14805688e+02
  6.10272920e+02  2.74980682e+03  1.22283178e+04  4.08494392e+04
  1.04892879e+05  2.30076196e+05  4.55891046e+05  8.44843240e+05
  1.52802044e+06  2.85028776e+06  5.80817495e+06]
E1 = -706.6732420955374  E_coul = 198.7001276277861
cycle= 4 E= -507.973114467751  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108158
diis-c [-6.82528142e-11 -5.28415017e-06  7.33970515e-03 -9.10900160e-02
  1.08375559e+00]
  HOMO = -0.242901010560031  LUMO = 1.17145160156173
  mo_energy =
[-1.20318968e+02 -1.23785392e+01 -6.67711433e+00 -6.67711433e+00
 -6.67711433e+00 -1.17918309e+00 -2.42901011e-01 -2.42901011e-01
 -2.42901011e-01  1.17145160e+00  1.34885587e+01  1.14805443e+02
  6.10272680e+02  2.74980658e+03  1.22283176e+04  4.08494390e+04
  1.04892879e+05  2.30076195e+05  4.55891046e+05  8.44843239e+05
  1.52802044e+06  2.85028776e+06  5.80817495e+06]
E1 = -706.6727528292972  E_coul = 198.69963835617366
cycle= 5 E= -507.973114473124  delta_E= -5.37e-09  |g|= 2.56e-07  |ddm|= 0.00033
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58648e-07
diis-c [-1.10659293e-14  1.78238246e-07 -9.08996182e-05  1.01698456e-03
 -1.13673484e-02  1.01044109e+00]
  HOMO = -0.242901052846845  LUMO = 1.17145175212038
  mo_energy =
[-1.20318969e+02 -1.23785394e+01 -6.67711464e+00 -6.67711464e+00
 -6.67711464e+00 -1.17918325e+00 -2.42901053e-01 -2.42901053e-01
 -2.42901053e-01  1.17145175e+00  1.34885586e+01  1.14805443e+02
  6.10272679e+02  2.74980658e+03  1.22283176e+04  4.08494390e+04
  1.04892879e+05  2.30076195e+05  4.55891046e+05  8.44843239e+05
  1.52802044e+06  2.85028776e+06  5.80817495e+06]
E1 = -706.672752450536  E_coul = 198.6996379774123
cycle= 6 E= -507.973114473124  delta_E= -1.14e-13  |g|= 1.29e-08  |ddm|= 1.52e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.672752450536  E_coul = 198.6996379774123
  HOMO = -0.242901045813515  LUMO = 1.17145175534474
  mo_energy =
[-1.20318969e+02 -1.23785394e+01 -6.67711462e+00 -6.67711462e+00
 -6.67711462e+00 -1.17918324e+00 -2.42901046e-01 -2.42901046e-01
 -2.42901046e-01  1.17145176e+00  1.34885586e+01  1.14805443e+02
  6.10272679e+02  2.74980658e+03  1.22283176e+04  4.08494390e+04
  1.04892879e+05  2.30076195e+05  4.55891046e+05  8.44843239e+05
  1.52802044e+06  2.85028776e+06  5.80817495e+06]
E1 = -706.6727524848337  E_coul = 198.69963801171025
Extra cycle  E= -507.973114473123  delta_E= 2.27e-13  |g|= 2.51e-09  |ddm|= 2.28e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
exp = [2.63887166e-01 1.17616814e+05 6.70762059e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547198e+04 7.30346047e+03 1.83758097e+04 1.44973187e+03
 3.73980003e+02 1.13703780e+02 3.80917127e+01 8.40964643e+00
 3.37406608e+00 8.60356242e+00 4.92569681e-01]
E = -507.9731144731235
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:54 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263887166039       1
[INPUT] 0    0    [1    /1   ]  117616.814224        1
[INPUT] 0    0    [1    /1   ]  0.670762058778       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031129        1
[INPUT] 0    0    [1    /1   ]  147020.992137        1
[INPUT] 0    0    [1    /1   ]  73510.4209263        1
[INPUT] 0    0    [1    /1   ]  36754.7198028        1
[INPUT] 0    0    [1    /1   ]  7303.46047177        1
[INPUT] 0    0    [1    /1   ]  18375.8096881        1
[INPUT] 0    0    [1    /1   ]  1449.73186732        1
[INPUT] 0    0    [1    /1   ]  373.980003157        1
[INPUT] 0    0    [1    /1   ]  113.703780023        1
[INPUT] 0    0    [1    /1   ]  38.0917127257        1
[INPUT] 0    0    [1    /1   ]  8.40964643441        1
[INPUT] 0    0    [1    /1   ]  3.37406607898        1
[INPUT] 1    0    [1    /1   ]  8.60356242302        1
[INPUT] 1    0    [1    /1   ]  0.492569680929       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26388716603894075, 1.0]], [0, [117616.81422434877, 1.0]], [0, [0.6707620587778504, 1.0]], [0, [1176168.142618809, 1.0]], [0, [588084.0699920928, 1.0]], [0, [294042.03112916613, 1.0]], [0, [147020.9921371284, 1.0]], [0, [73510.42092629905, 1.0]], [0, [36754.7198028434, 1.0]], [0, [7303.460471768962, 1.0]], [0, [18375.809688131845, 1.0]], [0, [1449.7318673232585, 1.0]], [0, [373.98000315694384, 1.0]], [0, [113.70378002280673, 1.0]], [0, [38.091712725746234, 1.0]], [0, [8.40964643440782, 1.0]], [0, [3.3740660789829184, 1.0]], [1, [8.603562423015799, 1.0]], [1, [0.49256968092941855, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26388717]
bas 1, expnt(s) = [117616.81422435]
bas 2, expnt(s) = [0.67076206]
bas 3, expnt(s) = [1176168.14261881]
bas 4, expnt(s) = [588084.06999209]
bas 5, expnt(s) = [294042.03112917]
bas 6, expnt(s) = [147020.99213713]
bas 7, expnt(s) = [73510.4209263]
bas 8, expnt(s) = [36754.71980284]
bas 9, expnt(s) = [7303.46047177]
bas 10, expnt(s) = [18375.80968813]
bas 11, expnt(s) = [1449.73186732]
bas 12, expnt(s) = [373.98000316]
bas 13, expnt(s) = [113.70378002]
bas 14, expnt(s) = [38.09171273]
bas 15, expnt(s) = [8.40964643]
bas 16, expnt(s) = [3.37406608]
bas 17, expnt(s) = [8.60356242]
bas 18, expnt(s) = [0.49256968]
CPU time:       261.54
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63887166e-01 9.30205121e-01 1.17616814e+05 1.60460109e+04
 6.70762059e-01 1.87258436e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547198e+04 6.70656073e+03 7.30346047e+03 1.99600459e+03
 1.83758097e+04 3.98749258e+03 1.44973187e+03 5.93582090e+02
 3.73980003e+02 2.14857892e+02 1.13703780e+02 8.79723516e+01
 3.80917127e+01 3.87380629e+01 8.40964643e+00 1.24766596e+01
 3.37406608e+00 6.28970406e+00 8.60356242e+00 4.29865197e+01
 4.92569681e-01 1.20384061e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33575306850466
cond(S) = 907774.0801812017
E1 = -689.5620808201726  E_coul = 184.95918987729206
init E= -504.602890942881
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672509158979256  LUMO = 0.772558612203364
  mo_energy =
[-1.21704988e+02 -1.33853025e+01 -7.62437932e+00 -7.62437932e+00
 -7.62437932e+00 -1.65765839e+00 -6.72509159e-01 -6.72509159e-01
 -6.72509159e-01  7.72558612e-01  1.26005194e+01  1.13508884e+02
  6.08904844e+02  2.74851632e+03  1.22271469e+04  4.08483386e+04
  1.04891817e+05  2.30075158e+05  4.55890026e+05  8.44842233e+05
  1.52801945e+06  2.85028678e+06  5.80817398e+06]
E1 = -707.7278023327195  E_coul = 199.77235986744836
cycle= 1 E= -507.955442465271  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625948
diis-c [-0.39181061  1.        ]
  HOMO = -0.217960188111912  LUMO = 1.17929781163563
  mo_energy =
[-1.20194455e+02 -1.23037083e+01 -6.59469423e+00 -6.59469423e+00
 -6.59469423e+00 -1.16325025e+00 -2.17960188e-01 -2.17960188e-01
 -2.17960188e-01  1.17929781e+00  1.35468976e+01  1.14910249e+02
  6.10401337e+02  2.74995204e+03  1.22284737e+04  4.08495989e+04
  1.04893041e+05  2.30076358e+05  4.55891209e+05  8.44843402e+05
  1.52802061e+06  2.85028793e+06  5.80817512e+06]
E1 = -706.792319522267  E_coul = 198.81945700064003
cycle= 2 E= -507.972862521627  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257986
diis-c [-6.62587147e-04  2.75204204e-03  9.97247958e-01]
  HOMO = -0.239669990335597  LUMO = 1.17267732642639
  mo_energy =
[-1.20306636e+02 -1.23696062e+01 -6.66767218e+00 -6.66767218e+00
 -6.66767218e+00 -1.17722907e+00 -2.39669990e-01 -2.39669990e-01
 -2.39669990e-01  1.17267733e+00  1.34957820e+01  1.14816459e+02
  6.10285185e+02  2.74981997e+03  1.22283315e+04  4.08494531e+04
  1.04892893e+05  2.30076209e+05  4.55891060e+05  8.44843253e+05
  1.52802046e+06  2.85028778e+06  5.80817497e+06]
E1 = -706.6881230365177  E_coul = 198.71501308768336
cycle= 3 E= -507.973109948834  delta_E= -0.000247  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292294
diis-c [-1.54651611e-06 -1.77004189e-04 -1.14449336e-01  1.11462634e+00]
  HOMO = -0.242796841604304  LUMO = 1.17149711488355
  mo_energy =
[-1.20318727e+02 -1.23782852e+01 -6.67686629e+00 -6.67686629e+00
 -6.67686629e+00 -1.17912196e+00 -2.42796842e-01 -2.42796842e-01
 -2.42796842e-01  1.17149711e+00  1.34887745e+01  1.14805688e+02
  6.10272920e+02  2.74980682e+03  1.22283178e+04  4.08494392e+04
  1.04892879e+05  2.30076196e+05  4.55891046e+05  8.44843240e+05
  1.52802044e+06  2.85028776e+06  5.80817495e+06]
E1 = -706.6732420955374  E_coul = 198.7001276277861
cycle= 4 E= -507.973114467751  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108158
diis-c [-6.82528142e-11 -5.28415017e-06  7.33970515e-03 -9.10900160e-02
  1.08375559e+00]
  HOMO = -0.242901010560031  LUMO = 1.17145160156173
  mo_energy =
[-1.20318968e+02 -1.23785392e+01 -6.67711433e+00 -6.67711433e+00
 -6.67711433e+00 -1.17918309e+00 -2.42901011e-01 -2.42901011e-01
 -2.42901011e-01  1.17145160e+00  1.34885587e+01  1.14805443e+02
  6.10272680e+02  2.74980658e+03  1.22283176e+04  4.08494390e+04
  1.04892879e+05  2.30076195e+05  4.55891046e+05  8.44843239e+05
  1.52802044e+06  2.85028776e+06  5.80817495e+06]
E1 = -706.6727528292972  E_coul = 198.69963835617366
cycle= 5 E= -507.973114473124  delta_E= -5.37e-09  |g|= 2.56e-07  |ddm|= 0.00033
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58648e-07
diis-c [-1.10659293e-14  1.78238246e-07 -9.08996182e-05  1.01698456e-03
 -1.13673484e-02  1.01044109e+00]
  HOMO = -0.242901052846845  LUMO = 1.17145175212038
  mo_energy =
[-1.20318969e+02 -1.23785394e+01 -6.67711464e+00 -6.67711464e+00
 -6.67711464e+00 -1.17918325e+00 -2.42901053e-01 -2.42901053e-01
 -2.42901053e-01  1.17145175e+00  1.34885586e+01  1.14805443e+02
  6.10272679e+02  2.74980658e+03  1.22283176e+04  4.08494390e+04
  1.04892879e+05  2.30076195e+05  4.55891046e+05  8.44843239e+05
  1.52802044e+06  2.85028776e+06  5.80817495e+06]
E1 = -706.672752450536  E_coul = 198.6996379774123
cycle= 6 E= -507.973114473124  delta_E= -1.14e-13  |g|= 1.29e-08  |ddm|= 1.52e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.672752450536  E_coul = 198.6996379774123
  HOMO = -0.242901045813515  LUMO = 1.17145175534474
  mo_energy =
[-1.20318969e+02 -1.23785394e+01 -6.67711462e+00 -6.67711462e+00
 -6.67711462e+00 -1.17918324e+00 -2.42901046e-01 -2.42901046e-01
 -2.42901046e-01  1.17145176e+00  1.34885586e+01  1.14805443e+02
  6.10272679e+02  2.74980658e+03  1.22283176e+04  4.08494390e+04
  1.04892879e+05  2.30076195e+05  4.55891046e+05  8.44843239e+05
  1.52802044e+06  2.85028776e+06  5.80817495e+06]
E1 = -706.6727524848337  E_coul = 198.69963801171025
Extra cycle  E= -507.973114473123  delta_E= 2.27e-13  |g|= 2.51e-09  |ddm|= 2.28e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907774.0801812017
E1 = -706.6727524848337  E_coul = 198.69963801171025
init E= -507.973114473123
    CPU time for initialize scf      1.48 sec, wall time      0.09 sec
  HOMO = -0.24290104485762  LUMO = 1.17145175504645
  mo_energy =
[-1.20318969e+02 -1.23785394e+01 -6.67711462e+00 -6.67711462e+00
 -6.67711462e+00 -1.17918324e+00 -2.42901045e-01 -2.42901045e-01
 -2.42901045e-01  1.17145176e+00  1.34885586e+01  1.14805443e+02
  6.10272679e+02  2.74980658e+03  1.22283176e+04  4.08494390e+04
  1.04892879e+05  2.30076195e+05  4.55891046e+05  8.44843239e+05
  1.52802044e+06  2.85028776e+06  5.80817495e+06]
E1 = -706.6727524917615  E_coul = 198.69963801863804
cycle= 1 E= -507.973114473123  delta_E= 5.68e-14  |g|= 1.6e-09  |ddm|= 4.39e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6727524917615  E_coul = 198.69963801863804
  HOMO = -0.242901044671437  LUMO = 1.17145175432894
  mo_energy =
[-1.20318969e+02 -1.23785394e+01 -6.67711462e+00 -6.67711462e+00
 -6.67711462e+00 -1.17918324e+00 -2.42901045e-01 -2.42901045e-01
 -2.42901045e-01  1.17145175e+00  1.34885586e+01  1.14805443e+02
  6.10272679e+02  2.74980658e+03  1.22283176e+04  4.08494390e+04
  1.04892879e+05  2.30076195e+05  4.55891046e+05  8.44843239e+05
  1.52802044e+06  2.85028776e+06  5.80817495e+06]
E1 = -706.6727524906357  E_coul = 198.69963801751246
Extra cycle  E= -507.973114473123  delta_E= 1.71e-13  |g|= 1.75e-09  |ddm|= 8.59e-10
    CPU time for scf_cycle      1.65 sec, wall time      0.16 sec
exp = [2.63887166e-01 1.17616814e+05 6.70762059e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547198e+04 7.30346047e+03 1.83758097e+04 1.44973187e+03
 3.73980003e+02 1.13703780e+02 3.80917127e+01 8.40964643e+00
 3.37406608e+00 8.60356242e+00 4.92569681e-01]
grad_E = [ 8.22770006e-06  4.13139097e-09 -4.97615368e-06  1.81551178e-11
  1.11115788e-10  6.42826675e-10  2.52036495e-09  1.04688569e-08
  5.63787938e-08  3.54190544e-06  1.20628374e-07  7.49243947e-06
 -2.77085190e-05 -1.04536803e-05 -2.47852646e-07  4.02396114e-06
 -6.96038035e-06 -1.47306409e-07 -1.16795449e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263857235038       1
[INPUT] 0    0    [1    /1   ]  117616.814223        1
[INPUT] 0    0    [1    /1   ]  0.670680698884       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031129        1
[INPUT] 0    0    [1    /1   ]  147020.992136        1
[INPUT] 0    0    [1    /1   ]  73510.4209236        1
[INPUT] 0    0    [1    /1   ]  36754.7197882        1
[INPUT] 0    0    [1    /1   ]  7303.4595502         1
[INPUT] 0    0    [1    /1   ]  18375.8096568        1
[INPUT] 0    0    [1    /1   ]  1449.72937802        1
[INPUT] 0    0    [1    /1   ]  373.993133975        1
[INPUT] 0    0    [1    /1   ]  113.690586322        1
[INPUT] 0    0    [1    /1   ]  38.0858084314        1
[INPUT] 0    0    [1    /1   ]  8.40957594566        1
[INPUT] 0    0    [1    /1   ]  3.37385918928        1
[INPUT] 1    0    [1    /1   ]  8.60356323475        1
[INPUT] 1    0    [1    /1   ]  0.49256962894        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26385723503808156, 1.0]], [0, [117616.81422327318, 1.0]], [0, [0.670680698884105, 1.0]], [0, [1176168.1426188042, 1.0]], [0, [588084.0699920639, 1.0]], [0, [294042.0311289988, 1.0]], [0, [147020.9921364723, 1.0]], [0, [73510.42092357426, 1.0]], [0, [36754.71978815687, 1.0]], [0, [7303.459550202851, 1.0]], [0, [18375.80965683073, 1.0]], [0, [1449.7293780187683, 1.0]], [0, [373.99313397532785, 1.0]], [0, [113.69058632237197, 1.0]], [0, [38.085808431373344, 1.0]], [0, [8.409575945657245, 1.0]], [0, [3.373859189275009, 1.0]], [1, [8.603563234750368, 1.0]], [1, [0.49256962893983136, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26385724]
bas 1, expnt(s) = [117616.81422327]
bas 2, expnt(s) = [0.6706807]
bas 3, expnt(s) = [1176168.1426188]
bas 4, expnt(s) = [588084.06999206]
bas 5, expnt(s) = [294042.031129]
bas 6, expnt(s) = [147020.99213647]
bas 7, expnt(s) = [73510.42092357]
bas 8, expnt(s) = [36754.71978816]
bas 9, expnt(s) = [7303.4595502]
bas 10, expnt(s) = [18375.80965683]
bas 11, expnt(s) = [1449.72937802]
bas 12, expnt(s) = [373.99313398]
bas 13, expnt(s) = [113.69058632]
bas 14, expnt(s) = [38.08580843]
bas 15, expnt(s) = [8.40957595]
bas 16, expnt(s) = [3.37385919]
bas 17, expnt(s) = [8.60356323]
bas 18, expnt(s) = [0.49256963]
CPU time:       266.39
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63857235e-01 9.30125990e-01 1.17616814e+05 1.60460109e+04
 6.70680699e-01 1.87241400e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547198e+04 6.70656073e+03 7.30345955e+03 1.99600441e+03
 1.83758097e+04 3.98749257e+03 1.44972938e+03 5.93581325e+02
 3.73993134e+02 2.14863550e+02 1.13690586e+02 8.79646955e+01
 3.80858084e+01 3.87335594e+01 8.40957595e+00 1.24765812e+01
 3.37385919e+00 6.28941481e+00 8.60356323e+00 4.29865248e+01
 4.92569629e-01 1.20384045e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335753749775012
cond(S) = 907773.7232814505
E1 = -689.5620285117581  E_coul = 184.95918567837862
init E= -504.602842833379
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672509326759224  LUMO = 0.772364048408234
  mo_energy =
[-1.21704988e+02 -1.33853029e+01 -7.62437975e+00 -7.62437975e+00
 -7.62437975e+00 -1.65765832e+00 -6.72509327e-01 -6.72509327e-01
 -6.72509327e-01  7.72364048e-01  1.25991320e+01  1.13490483e+02
  6.08858564e+02  2.74848024e+03  1.22271194e+04  4.08483117e+04
  1.04891790e+05  2.30075131e+05  4.55890000e+05  8.44842207e+05
  1.52801942e+06  2.85028675e+06  5.80817395e+06]
E1 = -707.727759612358  E_coul = 199.77231674278795
cycle= 1 E= -507.95544286957  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625944
diis-c [-0.39180644  1.        ]
  HOMO = -0.217960503410649  LUMO = 1.17906961988793
  mo_energy =
[-1.20194463e+02 -1.23037112e+01 -6.59469756e+00 -6.59469756e+00
 -6.59469756e+00 -1.16325072e+00 -2.17960503e-01 -2.17960503e-01
 -2.17960503e-01  1.17906962e+00  1.35454865e+01  1.14891819e+02
  6.10355047e+02  2.74991595e+03  1.22284462e+04  4.08495720e+04
  1.04893013e+05  2.30076331e+05  4.55891182e+05  8.44843376e+05
  1.52802058e+06  2.85028790e+06  5.80817509e+06]
E1 = -706.7922841327451  E_coul = 198.81942143681965
cycle= 2 E= -507.972862695925  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257995
diis-c [-6.62641081e-04  2.75048673e-03  9.97249513e-01]
  HOMO = -0.239670449906519  LUMO = 1.1724505784341
  mo_energy =
[-1.20306643e+02 -1.23696085e+01 -6.66767484e+00 -6.66767484e+00
 -6.66767484e+00 -1.17722968e+00 -2.39670450e-01 -2.39670450e-01
 -2.39670450e-01  1.17245058e+00  1.34943736e+01  1.14798033e+02
  6.10238896e+02  2.74978388e+03  1.22283040e+04  4.08494262e+04
  1.04892866e+05  2.30076183e+05  4.55891033e+05  8.44843227e+05
  1.52802043e+06  2.85028775e+06  5.80817494e+06]
E1 = -706.6880830009881  E_coul = 198.71497285509204
cycle= 3 E= -507.973110145896  delta_E= -0.000247  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292314
diis-c [-1.54677763e-06 -1.77010925e-04 -1.14452640e-01  1.11462965e+00]
  HOMO = -0.24279749670863  LUMO = 1.17127050683889
  mo_energy =
[-1.20318733e+02 -1.23782877e+01 -6.67686921e+00 -6.67686921e+00
 -6.67686921e+00 -1.17912269e+00 -2.42797497e-01 -2.42797497e-01
 -2.42797497e-01  1.17127051e+00  1.34873659e+01  1.14787261e+02
  6.10226631e+02  2.74977073e+03  1.22282903e+04  4.08494123e+04
  1.04892852e+05  2.30076169e+05  4.55891019e+05  8.44843213e+05
  1.52802042e+06  2.85028774e+06  5.80817493e+06]
E1 = -706.6732006081295  E_coul = 198.70008594240505
cycle= 4 E= -507.973114665724  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108175
diis-c [-6.82800627e-11 -5.28508685e-06  7.34001505e-03 -9.10949353e-02
  1.08376021e+00]
  HOMO = -0.242901690114042  LUMO = 1.17122498953689
  mo_energy =
[-1.20318975e+02 -1.23785418e+01 -6.67711730e+00 -6.67711730e+00
 -6.67711730e+00 -1.17918384e+00 -2.42901690e-01 -2.42901690e-01
 -2.42901690e-01  1.17122499e+00  1.34871501e+01  1.14787017e+02
  6.10226391e+02  2.74977049e+03  1.22282901e+04  4.08494121e+04
  1.04892852e+05  2.30076168e+05  4.55891019e+05  8.44843213e+05
  1.52802042e+06  2.85028774e+06  5.80817493e+06]
E1 = -706.6727112096069  E_coul = 198.69959653850708
cycle= 5 E= -507.9731146711  delta_E= -5.38e-09  |g|= 2.56e-07  |ddm|= 0.000331
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58571e-07
diis-c [-1.10533174e-14  1.77759808e-07 -9.09045385e-05  1.01701665e-03
 -1.13684130e-02  1.01044212e+00]
  HOMO = -0.242901732662652  LUMO = 1.1712251413067
  mo_energy =
[-1.20318975e+02 -1.23785420e+01 -6.67711761e+00 -6.67711761e+00
 -6.67711761e+00 -1.17918400e+00 -2.42901733e-01 -2.42901733e-01
 -2.42901733e-01  1.17122514e+00  1.34871500e+01  1.14787017e+02
  6.10226390e+02  2.74977049e+03  1.22282901e+04  4.08494121e+04
  1.04892852e+05  2.30076168e+05  4.55891019e+05  8.44843213e+05
  1.52802042e+06  2.85028774e+06  5.80817493e+06]
E1 = -706.6727108277878  E_coul = 198.6995961566883
cycle= 6 E= -507.973114671099  delta_E= 2.84e-13  |g|= 1.31e-08  |ddm|= 1.53e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6727108277878  E_coul = 198.6995961566883
  HOMO = -0.242901725672401  LUMO = 1.17122514172351
  mo_energy =
[-1.20318975e+02 -1.23785420e+01 -6.67711759e+00 -6.67711759e+00
 -6.67711759e+00 -1.17918399e+00 -2.42901726e-01 -2.42901726e-01
 -2.42901726e-01  1.17122514e+00  1.34871500e+01  1.14787017e+02
  6.10226390e+02  2.74977049e+03  1.22282901e+04  4.08494121e+04
  1.04892852e+05  2.30076168e+05  4.55891019e+05  8.44843213e+05
  1.52802042e+06  2.85028774e+06  5.80817493e+06]
E1 = -706.6727108634904  E_coul = 198.69959619239123
Extra cycle  E= -507.973114671099  delta_E= 3.98e-13  |g|= 2.16e-09  |ddm|= 2.38e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.63857235e-01 1.17616814e+05 6.70680699e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547198e+04 7.30345955e+03 1.83758097e+04 1.44972938e+03
 3.73993134e+02 1.13690586e+02 3.80858084e+01 8.40957595e+00
 3.37385919e+00 8.60356323e+00 4.92569629e-01]
E = -507.9731146710991
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:54:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263857235038       1
[INPUT] 0    0    [1    /1   ]  117616.814223        1
[INPUT] 0    0    [1    /1   ]  0.670680698884       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031129        1
[INPUT] 0    0    [1    /1   ]  147020.992136        1
[INPUT] 0    0    [1    /1   ]  73510.4209236        1
[INPUT] 0    0    [1    /1   ]  36754.7197882        1
[INPUT] 0    0    [1    /1   ]  7303.4595502         1
[INPUT] 0    0    [1    /1   ]  18375.8096568        1
[INPUT] 0    0    [1    /1   ]  1449.72937802        1
[INPUT] 0    0    [1    /1   ]  373.993133975        1
[INPUT] 0    0    [1    /1   ]  113.690586322        1
[INPUT] 0    0    [1    /1   ]  38.0858084314        1
[INPUT] 0    0    [1    /1   ]  8.40957594566        1
[INPUT] 0    0    [1    /1   ]  3.37385918928        1
[INPUT] 1    0    [1    /1   ]  8.60356323475        1
[INPUT] 1    0    [1    /1   ]  0.49256962894        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26385723503808156, 1.0]], [0, [117616.81422327318, 1.0]], [0, [0.670680698884105, 1.0]], [0, [1176168.1426188042, 1.0]], [0, [588084.0699920639, 1.0]], [0, [294042.0311289988, 1.0]], [0, [147020.9921364723, 1.0]], [0, [73510.42092357426, 1.0]], [0, [36754.71978815687, 1.0]], [0, [7303.459550202851, 1.0]], [0, [18375.80965683073, 1.0]], [0, [1449.7293780187683, 1.0]], [0, [373.99313397532785, 1.0]], [0, [113.69058632237197, 1.0]], [0, [38.085808431373344, 1.0]], [0, [8.409575945657245, 1.0]], [0, [3.373859189275009, 1.0]], [1, [8.603563234750368, 1.0]], [1, [0.49256962893983136, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26385724]
bas 1, expnt(s) = [117616.81422327]
bas 2, expnt(s) = [0.6706807]
bas 3, expnt(s) = [1176168.1426188]
bas 4, expnt(s) = [588084.06999206]
bas 5, expnt(s) = [294042.031129]
bas 6, expnt(s) = [147020.99213647]
bas 7, expnt(s) = [73510.42092357]
bas 8, expnt(s) = [36754.71978816]
bas 9, expnt(s) = [7303.4595502]
bas 10, expnt(s) = [18375.80965683]
bas 11, expnt(s) = [1449.72937802]
bas 12, expnt(s) = [373.99313398]
bas 13, expnt(s) = [113.69058632]
bas 14, expnt(s) = [38.08580843]
bas 15, expnt(s) = [8.40957595]
bas 16, expnt(s) = [3.37385919]
bas 17, expnt(s) = [8.60356323]
bas 18, expnt(s) = [0.49256963]
CPU time:       267.01
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63857235e-01 9.30125990e-01 1.17616814e+05 1.60460109e+04
 6.70680699e-01 1.87241400e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547198e+04 6.70656073e+03 7.30345955e+03 1.99600441e+03
 1.83758097e+04 3.98749257e+03 1.44972938e+03 5.93581325e+02
 3.73993134e+02 2.14863550e+02 1.13690586e+02 8.79646955e+01
 3.80858084e+01 3.87335594e+01 8.40957595e+00 1.24765812e+01
 3.37385919e+00 6.28941481e+00 8.60356323e+00 4.29865248e+01
 4.92569629e-01 1.20384045e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335753749775012
cond(S) = 907773.7232814505
E1 = -689.5620285117581  E_coul = 184.95918567837862
init E= -504.602842833379
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672509326759224  LUMO = 0.772364048408234
  mo_energy =
[-1.21704988e+02 -1.33853029e+01 -7.62437975e+00 -7.62437975e+00
 -7.62437975e+00 -1.65765832e+00 -6.72509327e-01 -6.72509327e-01
 -6.72509327e-01  7.72364048e-01  1.25991320e+01  1.13490483e+02
  6.08858564e+02  2.74848024e+03  1.22271194e+04  4.08483117e+04
  1.04891790e+05  2.30075131e+05  4.55890000e+05  8.44842207e+05
  1.52801942e+06  2.85028675e+06  5.80817395e+06]
E1 = -707.727759612358  E_coul = 199.77231674278795
cycle= 1 E= -507.95544286957  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625944
diis-c [-0.39180644  1.        ]
  HOMO = -0.217960503410649  LUMO = 1.17906961988793
  mo_energy =
[-1.20194463e+02 -1.23037112e+01 -6.59469756e+00 -6.59469756e+00
 -6.59469756e+00 -1.16325072e+00 -2.17960503e-01 -2.17960503e-01
 -2.17960503e-01  1.17906962e+00  1.35454865e+01  1.14891819e+02
  6.10355047e+02  2.74991595e+03  1.22284462e+04  4.08495720e+04
  1.04893013e+05  2.30076331e+05  4.55891182e+05  8.44843376e+05
  1.52802058e+06  2.85028790e+06  5.80817509e+06]
E1 = -706.7922841327451  E_coul = 198.81942143681965
cycle= 2 E= -507.972862695925  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257995
diis-c [-6.62641081e-04  2.75048673e-03  9.97249513e-01]
  HOMO = -0.239670449906519  LUMO = 1.1724505784341
  mo_energy =
[-1.20306643e+02 -1.23696085e+01 -6.66767484e+00 -6.66767484e+00
 -6.66767484e+00 -1.17722968e+00 -2.39670450e-01 -2.39670450e-01
 -2.39670450e-01  1.17245058e+00  1.34943736e+01  1.14798033e+02
  6.10238896e+02  2.74978388e+03  1.22283040e+04  4.08494262e+04
  1.04892866e+05  2.30076183e+05  4.55891033e+05  8.44843227e+05
  1.52802043e+06  2.85028775e+06  5.80817494e+06]
E1 = -706.6880830009881  E_coul = 198.71497285509204
cycle= 3 E= -507.973110145896  delta_E= -0.000247  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292314
diis-c [-1.54677763e-06 -1.77010925e-04 -1.14452640e-01  1.11462965e+00]
  HOMO = -0.24279749670863  LUMO = 1.17127050683889
  mo_energy =
[-1.20318733e+02 -1.23782877e+01 -6.67686921e+00 -6.67686921e+00
 -6.67686921e+00 -1.17912269e+00 -2.42797497e-01 -2.42797497e-01
 -2.42797497e-01  1.17127051e+00  1.34873659e+01  1.14787261e+02
  6.10226631e+02  2.74977073e+03  1.22282903e+04  4.08494123e+04
  1.04892852e+05  2.30076169e+05  4.55891019e+05  8.44843213e+05
  1.52802042e+06  2.85028774e+06  5.80817493e+06]
E1 = -706.6732006081295  E_coul = 198.70008594240505
cycle= 4 E= -507.973114665724  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108175
diis-c [-6.82800627e-11 -5.28508685e-06  7.34001505e-03 -9.10949353e-02
  1.08376021e+00]
  HOMO = -0.242901690114042  LUMO = 1.17122498953689
  mo_energy =
[-1.20318975e+02 -1.23785418e+01 -6.67711730e+00 -6.67711730e+00
 -6.67711730e+00 -1.17918384e+00 -2.42901690e-01 -2.42901690e-01
 -2.42901690e-01  1.17122499e+00  1.34871501e+01  1.14787017e+02
  6.10226391e+02  2.74977049e+03  1.22282901e+04  4.08494121e+04
  1.04892852e+05  2.30076168e+05  4.55891019e+05  8.44843213e+05
  1.52802042e+06  2.85028774e+06  5.80817493e+06]
E1 = -706.6727112096069  E_coul = 198.69959653850708
cycle= 5 E= -507.9731146711  delta_E= -5.38e-09  |g|= 2.56e-07  |ddm|= 0.000331
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58571e-07
diis-c [-1.10533174e-14  1.77759808e-07 -9.09045385e-05  1.01701665e-03
 -1.13684130e-02  1.01044212e+00]
  HOMO = -0.242901732662652  LUMO = 1.1712251413067
  mo_energy =
[-1.20318975e+02 -1.23785420e+01 -6.67711761e+00 -6.67711761e+00
 -6.67711761e+00 -1.17918400e+00 -2.42901733e-01 -2.42901733e-01
 -2.42901733e-01  1.17122514e+00  1.34871500e+01  1.14787017e+02
  6.10226390e+02  2.74977049e+03  1.22282901e+04  4.08494121e+04
  1.04892852e+05  2.30076168e+05  4.55891019e+05  8.44843213e+05
  1.52802042e+06  2.85028774e+06  5.80817493e+06]
E1 = -706.6727108277878  E_coul = 198.6995961566883
cycle= 6 E= -507.973114671099  delta_E= 2.84e-13  |g|= 1.31e-08  |ddm|= 1.53e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6727108277878  E_coul = 198.6995961566883
  HOMO = -0.242901725672401  LUMO = 1.17122514172351
  mo_energy =
[-1.20318975e+02 -1.23785420e+01 -6.67711759e+00 -6.67711759e+00
 -6.67711759e+00 -1.17918399e+00 -2.42901726e-01 -2.42901726e-01
 -2.42901726e-01  1.17122514e+00  1.34871500e+01  1.14787017e+02
  6.10226390e+02  2.74977049e+03  1.22282901e+04  4.08494121e+04
  1.04892852e+05  2.30076168e+05  4.55891019e+05  8.44843213e+05
  1.52802042e+06  2.85028774e+06  5.80817493e+06]
E1 = -706.6727108634904  E_coul = 198.69959619239123
Extra cycle  E= -507.973114671099  delta_E= 3.98e-13  |g|= 2.16e-09  |ddm|= 2.38e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907773.7232814505
E1 = -706.6727108634904  E_coul = 198.69959619239123
init E= -507.973114671099
    CPU time for initialize scf      1.48 sec, wall time      0.09 sec
  HOMO = -0.242901724667824  LUMO = 1.1712251453027
  mo_energy =
[-1.20318975e+02 -1.23785420e+01 -6.67711759e+00 -6.67711759e+00
 -6.67711759e+00 -1.17918399e+00 -2.42901725e-01 -2.42901725e-01
 -2.42901725e-01  1.17122515e+00  1.34871500e+01  1.14787017e+02
  6.10226390e+02  2.74977049e+03  1.22282901e+04  4.08494121e+04
  1.04892852e+05  2.30076168e+05  4.55891019e+05  8.44843213e+05
  1.52802042e+06  2.85028774e+06  5.80817493e+06]
E1 = -706.6727108670602  E_coul = 198.69959619596077
cycle= 1 E= -507.973114671099  delta_E= -3.41e-13  |g|= 2.6e-09  |ddm|= 2.26e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6727108670602  E_coul = 198.69959619596077
  HOMO = -0.242901724582335  LUMO = 1.17122514403226
  mo_energy =
[-1.20318975e+02 -1.23785420e+01 -6.67711759e+00 -6.67711759e+00
 -6.67711759e+00 -1.17918399e+00 -2.42901725e-01 -2.42901725e-01
 -2.42901725e-01  1.17122514e+00  1.34871500e+01  1.14787017e+02
  6.10226390e+02  2.74977049e+03  1.22282901e+04  4.08494121e+04
  1.04892852e+05  2.30076168e+05  4.55891019e+05  8.44843213e+05
  1.52802042e+06  2.85028774e+06  5.80817493e+06]
E1 = -706.6727108694259  E_coul = 198.69959619832656
Extra cycle  E= -507.973114671099  delta_E= 5.68e-14  |g|= 1.82e-09  |ddm|= 1.5e-09
    CPU time for scf_cycle      1.65 sec, wall time      0.16 sec
exp = [2.63857235e-01 1.17616814e+05 6.70680699e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547198e+04 7.30345955e+03 1.83758097e+04 1.44972938e+03
 3.73993134e+02 1.13690586e+02 3.80858084e+01 8.40957595e+00
 3.37385919e+00 8.60356323e+00 4.92569629e-01]
grad_E = [ 1.47918354e-05  4.13540100e-09 -8.96920764e-06  1.82028338e-11
  1.11245961e-10  6.43447558e-10  2.52284310e-09  1.04793015e-08
  5.64302885e-08  3.54553006e-06  1.20784747e-07  7.30660392e-06
 -2.58379696e-05 -1.54779763e-05 -5.56209997e-07  7.10893351e-06
 -1.24150126e-05 -2.64923983e-07 -2.10094767e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:55:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263812826746       1
[INPUT] 0    0    [1    /1   ]  117616.81422         1
[INPUT] 0    0    [1    /1   ]  0.670558104283       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031128        1
[INPUT] 0    0    [1    /1   ]  147020.992134        1
[INPUT] 0    0    [1    /1   ]  73510.4209149        1
[INPUT] 0    0    [1    /1   ]  36754.7197413        1
[INPUT] 0    0    [1    /1   ]  7303.45660593        1
[INPUT] 0    0    [1    /1   ]  18375.8095567        1
[INPUT] 0    0    [1    /1   ]  1449.72228268        1
[INPUT] 0    0    [1    /1   ]  374.025626254        1
[INPUT] 0    0    [1    /1   ]  113.673763063        1
[INPUT] 0    0    [1    /1   ]  38.0773832608        1
[INPUT] 0    0    [1    /1   ]  8.4095449564         1
[INPUT] 0    0    [1    /1   ]  3.37357128077        1
[INPUT] 1    0    [1    /1   ]  8.60356437023        1
[INPUT] 1    0    [1    /1   ]  0.492569521823       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2638128267459494, 1.0]], [0, [117616.81421983785, 1.0]], [0, [0.6705581042833835, 1.0]], [0, [1176168.1426187893, 1.0]], [0, [588084.0699919716, 1.0]], [0, [294042.03112846427, 1.0]], [0, [147020.99213437672, 1.0]], [0, [73510.4209148704, 1.0]], [0, [36754.719741263085, 1.0]], [0, [7303.456605931919, 1.0]], [0, [18375.809556693275, 1.0]], [0, [1449.7222826798209, 1.0]], [0, [374.02562625358405, 1.0]], [0, [113.67376306322134, 1.0]], [0, [38.0773832607604, 1.0]], [0, [8.409544956400914, 1.0]], [0, [3.3735712807740286, 1.0]], [1, [8.603564370227524, 1.0]], [1, [0.4925695218228901, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26381283]
bas 1, expnt(s) = [117616.81421984]
bas 2, expnt(s) = [0.6705581]
bas 3, expnt(s) = [1176168.14261879]
bas 4, expnt(s) = [588084.06999197]
bas 5, expnt(s) = [294042.03112846]
bas 6, expnt(s) = [147020.99213438]
bas 7, expnt(s) = [73510.42091487]
bas 8, expnt(s) = [36754.71974126]
bas 9, expnt(s) = [7303.45660593]
bas 10, expnt(s) = [18375.80955669]
bas 11, expnt(s) = [1449.72228268]
bas 12, expnt(s) = [374.02562625]
bas 13, expnt(s) = [113.67376306]
bas 14, expnt(s) = [38.07738326]
bas 15, expnt(s) = [8.40954496]
bas 16, expnt(s) = [3.37357128]
bas 17, expnt(s) = [8.60356437]
bas 18, expnt(s) = [0.49256952]
CPU time:       271.86
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63812827e-01 9.30008579e-01 1.17616814e+05 1.60460109e+04
 6.70558104e-01 1.87215730e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547197e+04 6.70656072e+03 7.30345661e+03 1.99600380e+03
 1.83758096e+04 3.98749255e+03 1.44972228e+03 5.93579146e+02
 3.74025626e+02 2.14877550e+02 1.13673763e+02 8.79549330e+01
 3.80773833e+01 3.87271329e+01 8.40954496e+00 1.24765467e+01
 3.37357128e+00 6.28901227e+00 8.60356437e+00 4.29865319e+01
 4.92569522e-01 1.20384012e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335754783308634
cond(S) = 907773.5569105077
E1 = -689.5619356275478  E_coul = 184.95917793642667
init E= -504.602757691121
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.672509627987565  LUMO = 0.772073916084763
  mo_energy =
[-1.21704988e+02 -1.33853034e+01 -7.62438047e+00 -7.62438047e+00
 -7.62438047e+00 -1.65765826e+00 -6.72509628e-01 -6.72509628e-01
 -6.72509628e-01  7.72073916e-01  1.25972069e+01  1.13465344e+02
  6.08807922e+02  2.74847132e+03  1.22271246e+04  4.08483121e+04
  1.04891786e+05  2.30075126e+05  4.55889994e+05  8.44842201e+05
  1.52801942e+06  2.85028675e+06  5.80817395e+06]
E1 = -707.7276943069771  E_coul = 199.77225060126372
cycle= 1 E= -507.955443705713  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.19 sec, wall time      0.01 sec
diis-norm(errvec)=0.625938
diis-c [-0.39179877  1.        ]
  HOMO = -0.217961028651795  LUMO = 1.17872949308339
  mo_energy =
[-1.20194474e+02 -1.23037156e+01 -6.59470263e+00 -6.59470263e+00
 -6.59470263e+00 -1.16325145e+00 -2.17961029e-01 -2.17961029e-01
 -2.17961029e-01  1.17872949e+00  1.35435301e+01  1.14866641e+02
  6.10304388e+02  2.74990700e+03  1.22284514e+04  4.08495724e+04
  1.04893010e+05  2.30076325e+05  4.55891176e+05  8.44843370e+05
  1.52802057e+06  2.85028789e+06  5.80817509e+06]
E1 = -706.7922304972162  E_coul = 198.8193673255991
cycle= 2 E= -507.972863171617  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.025801
diis-c [-6.62720181e-04  2.74814173e-03  9.97251858e-01]
  HOMO = -0.23967117824149  LUMO = 1.1721125978955
  mo_energy =
[-1.20306652e+02 -1.23696119e+01 -6.66767885e+00 -6.66767885e+00
 -6.66767885e+00 -1.17723061e+00 -2.39671178e-01 -2.39671178e-01
 -2.39671178e-01  1.17211260e+00  1.34924208e+01  1.14772860e+02
  6.10188239e+02  2.74977493e+03  1.22283092e+04  4.08494265e+04
  1.04892863e+05  2.30076177e+05  4.55891027e+05  8.44843221e+05
  1.52802042e+06  2.85028775e+06  5.80817494e+06]
E1 = -706.6880224619097  E_coul = 198.7149118063675
cycle= 3 E= -507.973110655542  delta_E= -0.000247  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292343
diis-c [-1.54716465e-06 -1.77026976e-04 -1.14457378e-01  1.11463441e+00]
  HOMO = -0.242798515184382  LUMO = 1.17093273413778
  mo_energy =
[-1.20318743e+02 -1.23782916e+01 -6.67687361e+00 -6.67687361e+00
 -6.67687361e+00 -1.17912381e+00 -2.42798515e-01 -2.42798515e-01
 -2.42798515e-01  1.17093273e+00  1.34854130e+01  1.14762088e+02
  6.10175974e+02  2.74976179e+03  1.22282956e+04  4.08494127e+04
  1.04892849e+05  2.30076163e+05  4.55891013e+05  8.44843207e+05
  1.52802041e+06  2.85028773e+06  5.80817492e+06]
E1 = -706.6731379025724  E_coul = 198.7000227258405
cycle= 4 E= -507.973115176732  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0001082
diis-c [-6.82830587e-11 -5.28754021e-06  7.34031481e-03 -9.11011012e-02
  1.08376607e+00]
  HOMO = -0.24290274549011  LUMO = 1.17088720868077
  mo_energy =
[-1.20318985e+02 -1.23785457e+01 -6.67712179e+00 -6.67712179e+00
 -6.67712179e+00 -1.17918498e+00 -2.42902745e-01 -2.42902745e-01
 -2.42902745e-01  1.17088721e+00  1.34851972e+01  1.14761844e+02
  6.10175733e+02  2.74976155e+03  1.22282953e+04  4.08494125e+04
  1.04892848e+05  2.30076163e+05  4.55891013e+05  8.44843206e+05
  1.52802041e+06  2.85028773e+06  5.80817492e+06]
E1 = -706.6726483051916  E_coul = 198.6995331230805
cycle= 5 E= -507.973115182111  delta_E= -5.38e-09  |g|= 2.56e-07  |ddm|= 0.000331
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.59082e-07
diis-c [-1.10577120e-14  1.78091041e-07 -9.06474621e-05  1.01355917e-03
 -1.13289846e-02  1.01040589e+00]
  HOMO = -0.242902788429141  LUMO = 1.17088736128844
  mo_energy =
[-1.20318986e+02 -1.23785459e+01 -6.67712209e+00 -6.67712209e+00
 -6.67712209e+00 -1.17918514e+00 -2.42902788e-01 -2.42902788e-01
 -2.42902788e-01  1.17088736e+00  1.34851971e+01  1.14761843e+02
  6.10175733e+02  2.74976155e+03  1.22282953e+04  4.08494124e+04
  1.04892848e+05  2.30076163e+05  4.55891013e+05  8.44843206e+05
  1.52802041e+06  2.85028773e+06  5.80817492e+06]
E1 = -706.6726479186527  E_coul = 198.69953273654107
cycle= 6 E= -507.973115182112  delta_E= -5.68e-13  |g|= 1.35e-08  |ddm|= 1.56e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6726479186527  E_coul = 198.69953273654107
  HOMO = -0.242902781466428  LUMO = 1.1708873624556
  mo_energy =
[-1.20318986e+02 -1.23785459e+01 -6.67712207e+00 -6.67712207e+00
 -6.67712207e+00 -1.17918513e+00 -2.42902781e-01 -2.42902781e-01
 -2.42902781e-01  1.17088736e+00  1.34851971e+01  1.14761843e+02
  6.10175733e+02  2.74976155e+03  1.22282953e+04  4.08494124e+04
  1.04892848e+05  2.30076163e+05  4.55891013e+05  8.44843206e+05
  1.52802041e+06  2.85028773e+06  5.80817492e+06]
E1 = -706.6726479564059  E_coul = 198.69953277429443
Extra cycle  E= -507.973115182111  delta_E= 2.27e-13  |g|= 1.83e-09  |ddm|= 2.49e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.12 sec
exp = [2.63812827e-01 1.17616814e+05 6.70558104e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547197e+04 7.30345661e+03 1.83758096e+04 1.44972228e+03
 3.74025626e+02 1.13673763e+02 3.80773833e+01 8.40954496e+00
 3.37357128e+00 8.60356437e+00 4.92569522e-01]
E = -507.9731151821114
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:55:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263812826746       1
[INPUT] 0    0    [1    /1   ]  117616.81422         1
[INPUT] 0    0    [1    /1   ]  0.670558104283       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031128        1
[INPUT] 0    0    [1    /1   ]  147020.992134        1
[INPUT] 0    0    [1    /1   ]  73510.4209149        1
[INPUT] 0    0    [1    /1   ]  36754.7197413        1
[INPUT] 0    0    [1    /1   ]  7303.45660593        1
[INPUT] 0    0    [1    /1   ]  18375.8095567        1
[INPUT] 0    0    [1    /1   ]  1449.72228268        1
[INPUT] 0    0    [1    /1   ]  374.025626254        1
[INPUT] 0    0    [1    /1   ]  113.673763063        1
[INPUT] 0    0    [1    /1   ]  38.0773832608        1
[INPUT] 0    0    [1    /1   ]  8.4095449564         1
[INPUT] 0    0    [1    /1   ]  3.37357128077        1
[INPUT] 1    0    [1    /1   ]  8.60356437023        1
[INPUT] 1    0    [1    /1   ]  0.492569521823       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2638128267459494, 1.0]], [0, [117616.81421983785, 1.0]], [0, [0.6705581042833835, 1.0]], [0, [1176168.1426187893, 1.0]], [0, [588084.0699919716, 1.0]], [0, [294042.03112846427, 1.0]], [0, [147020.99213437672, 1.0]], [0, [73510.4209148704, 1.0]], [0, [36754.719741263085, 1.0]], [0, [7303.456605931919, 1.0]], [0, [18375.809556693275, 1.0]], [0, [1449.7222826798209, 1.0]], [0, [374.02562625358405, 1.0]], [0, [113.67376306322134, 1.0]], [0, [38.0773832607604, 1.0]], [0, [8.409544956400914, 1.0]], [0, [3.3735712807740286, 1.0]], [1, [8.603564370227524, 1.0]], [1, [0.4925695218228901, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26381283]
bas 1, expnt(s) = [117616.81421984]
bas 2, expnt(s) = [0.6705581]
bas 3, expnt(s) = [1176168.14261879]
bas 4, expnt(s) = [588084.06999197]
bas 5, expnt(s) = [294042.03112846]
bas 6, expnt(s) = [147020.99213438]
bas 7, expnt(s) = [73510.42091487]
bas 8, expnt(s) = [36754.71974126]
bas 9, expnt(s) = [7303.45660593]
bas 10, expnt(s) = [18375.80955669]
bas 11, expnt(s) = [1449.72228268]
bas 12, expnt(s) = [374.02562625]
bas 13, expnt(s) = [113.67376306]
bas 14, expnt(s) = [38.07738326]
bas 15, expnt(s) = [8.40954496]
bas 16, expnt(s) = [3.37357128]
bas 17, expnt(s) = [8.60356437]
bas 18, expnt(s) = [0.49256952]
CPU time:       272.50
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63812827e-01 9.30008579e-01 1.17616814e+05 1.60460109e+04
 6.70558104e-01 1.87215730e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547197e+04 6.70656072e+03 7.30345661e+03 1.99600380e+03
 1.83758096e+04 3.98749255e+03 1.44972228e+03 5.93579146e+02
 3.74025626e+02 2.14877550e+02 1.13673763e+02 8.79549330e+01
 3.80773833e+01 3.87271329e+01 8.40954496e+00 1.24765467e+01
 3.37357128e+00 6.28901227e+00 8.60356437e+00 4.29865319e+01
 4.92569522e-01 1.20384012e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335754783308634
cond(S) = 907773.5569105077
E1 = -689.5619356275478  E_coul = 184.95917793642667
init E= -504.602757691121
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.672509627987565  LUMO = 0.772073916084763
  mo_energy =
[-1.21704988e+02 -1.33853034e+01 -7.62438047e+00 -7.62438047e+00
 -7.62438047e+00 -1.65765826e+00 -6.72509628e-01 -6.72509628e-01
 -6.72509628e-01  7.72073916e-01  1.25972069e+01  1.13465344e+02
  6.08807922e+02  2.74847132e+03  1.22271246e+04  4.08483121e+04
  1.04891786e+05  2.30075126e+05  4.55889994e+05  8.44842201e+05
  1.52801942e+06  2.85028675e+06  5.80817395e+06]
E1 = -707.7276943069771  E_coul = 199.77225060126372
cycle= 1 E= -507.955443705713  delta_E= -3.35  |g|= 0.449  |ddm|= 0.509
    CPU time for cycle= 1      0.18 sec, wall time      0.01 sec
diis-norm(errvec)=0.625938
diis-c [-0.39179877  1.        ]
  HOMO = -0.217961028651795  LUMO = 1.17872949308339
  mo_energy =
[-1.20194474e+02 -1.23037156e+01 -6.59470263e+00 -6.59470263e+00
 -6.59470263e+00 -1.16325145e+00 -2.17961029e-01 -2.17961029e-01
 -2.17961029e-01  1.17872949e+00  1.35435301e+01  1.14866641e+02
  6.10304388e+02  2.74990700e+03  1.22284514e+04  4.08495724e+04
  1.04893010e+05  2.30076325e+05  4.55891176e+05  8.44843370e+05
  1.52802057e+06  2.85028789e+06  5.80817509e+06]
E1 = -706.7922304972162  E_coul = 198.8193673255991
cycle= 2 E= -507.972863171617  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.025801
diis-c [-6.62720181e-04  2.74814173e-03  9.97251858e-01]
  HOMO = -0.23967117824149  LUMO = 1.1721125978955
  mo_energy =
[-1.20306652e+02 -1.23696119e+01 -6.66767885e+00 -6.66767885e+00
 -6.66767885e+00 -1.17723061e+00 -2.39671178e-01 -2.39671178e-01
 -2.39671178e-01  1.17211260e+00  1.34924208e+01  1.14772860e+02
  6.10188239e+02  2.74977493e+03  1.22283092e+04  4.08494265e+04
  1.04892863e+05  2.30076177e+05  4.55891027e+05  8.44843221e+05
  1.52802042e+06  2.85028775e+06  5.80817494e+06]
E1 = -706.6880224619097  E_coul = 198.7149118063675
cycle= 3 E= -507.973110655542  delta_E= -0.000247  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292343
diis-c [-1.54716465e-06 -1.77026976e-04 -1.14457378e-01  1.11463441e+00]
  HOMO = -0.242798515184382  LUMO = 1.17093273413778
  mo_energy =
[-1.20318743e+02 -1.23782916e+01 -6.67687361e+00 -6.67687361e+00
 -6.67687361e+00 -1.17912381e+00 -2.42798515e-01 -2.42798515e-01
 -2.42798515e-01  1.17093273e+00  1.34854130e+01  1.14762088e+02
  6.10175974e+02  2.74976179e+03  1.22282956e+04  4.08494127e+04
  1.04892849e+05  2.30076163e+05  4.55891013e+05  8.44843207e+05
  1.52802041e+06  2.85028773e+06  5.80817492e+06]
E1 = -706.6731379025724  E_coul = 198.7000227258405
cycle= 4 E= -507.973115176732  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0001082
diis-c [-6.82830587e-11 -5.28754021e-06  7.34031481e-03 -9.11011012e-02
  1.08376607e+00]
  HOMO = -0.24290274549011  LUMO = 1.17088720868077
  mo_energy =
[-1.20318985e+02 -1.23785457e+01 -6.67712179e+00 -6.67712179e+00
 -6.67712179e+00 -1.17918498e+00 -2.42902745e-01 -2.42902745e-01
 -2.42902745e-01  1.17088721e+00  1.34851972e+01  1.14761844e+02
  6.10175733e+02  2.74976155e+03  1.22282953e+04  4.08494125e+04
  1.04892848e+05  2.30076163e+05  4.55891013e+05  8.44843206e+05
  1.52802041e+06  2.85028773e+06  5.80817492e+06]
E1 = -706.6726483051916  E_coul = 198.6995331230805
cycle= 5 E= -507.973115182111  delta_E= -5.38e-09  |g|= 2.56e-07  |ddm|= 0.000331
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.59082e-07
diis-c [-1.10577120e-14  1.78091041e-07 -9.06474621e-05  1.01355917e-03
 -1.13289846e-02  1.01040589e+00]
  HOMO = -0.242902788429141  LUMO = 1.17088736128844
  mo_energy =
[-1.20318986e+02 -1.23785459e+01 -6.67712209e+00 -6.67712209e+00
 -6.67712209e+00 -1.17918514e+00 -2.42902788e-01 -2.42902788e-01
 -2.42902788e-01  1.17088736e+00  1.34851971e+01  1.14761843e+02
  6.10175733e+02  2.74976155e+03  1.22282953e+04  4.08494124e+04
  1.04892848e+05  2.30076163e+05  4.55891013e+05  8.44843206e+05
  1.52802041e+06  2.85028773e+06  5.80817492e+06]
E1 = -706.6726479186527  E_coul = 198.69953273654107
cycle= 6 E= -507.973115182112  delta_E= -5.68e-13  |g|= 1.35e-08  |ddm|= 1.56e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6726479186527  E_coul = 198.69953273654107
  HOMO = -0.242902781466428  LUMO = 1.1708873624556
  mo_energy =
[-1.20318986e+02 -1.23785459e+01 -6.67712207e+00 -6.67712207e+00
 -6.67712207e+00 -1.17918513e+00 -2.42902781e-01 -2.42902781e-01
 -2.42902781e-01  1.17088736e+00  1.34851971e+01  1.14761843e+02
  6.10175733e+02  2.74976155e+03  1.22282953e+04  4.08494124e+04
  1.04892848e+05  2.30076163e+05  4.55891013e+05  8.44843206e+05
  1.52802041e+06  2.85028773e+06  5.80817492e+06]
E1 = -706.6726479564059  E_coul = 198.69953277429443
Extra cycle  E= -507.973115182111  delta_E= 2.27e-13  |g|= 1.83e-09  |ddm|= 2.49e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907773.5569105077
E1 = -706.6726479564059  E_coul = 198.69953277429443
init E= -507.973115182111
    CPU time for initialize scf      1.50 sec, wall time      0.10 sec
  HOMO = -0.242902780419639  LUMO = 1.17088736381394
  mo_energy =
[-1.20318986e+02 -1.23785459e+01 -6.67712207e+00 -6.67712207e+00
 -6.67712207e+00 -1.17918513e+00 -2.42902780e-01 -2.42902780e-01
 -2.42902780e-01  1.17088736e+00  1.34851971e+01  1.14761843e+02
  6.10175733e+02  2.74976155e+03  1.22282953e+04  4.08494124e+04
  1.04892848e+05  2.30076163e+05  4.55891013e+05  8.44843206e+05
  1.52802041e+06  2.85028773e+06  5.80817492e+06]
E1 = -706.6726479608845  E_coul = 198.69953277877286
cycle= 1 E= -507.973115182112  delta_E= -2.27e-13  |g|= 1.2e-09  |ddm|= 2.85e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6726479608845  E_coul = 198.69953277877286
  HOMO = -0.242902780298516  LUMO = 1.17088736387677
  mo_energy =
[-1.20318986e+02 -1.23785459e+01 -6.67712207e+00 -6.67712207e+00
 -6.67712207e+00 -1.17918513e+00 -2.42902780e-01 -2.42902780e-01
 -2.42902780e-01  1.17088736e+00  1.34851971e+01  1.14761843e+02
  6.10175733e+02  2.74976155e+03  1.22282953e+04  4.08494124e+04
  1.04892848e+05  2.30076163e+05  4.55891013e+05  8.44843206e+05
  1.52802041e+06  2.85028773e+06  5.80817492e+06]
E1 = -706.6726479609789  E_coul = 198.6995327788672
Extra cycle  E= -507.973115182112  delta_E= -5.68e-14  |g|= 9.62e-10  |ddm|= 1.19e-10
    CPU time for scf_cycle      1.67 sec, wall time      0.17 sec
exp = [2.63812827e-01 1.17616814e+05 6.70558104e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547197e+04 7.30345661e+03 1.83758096e+04 1.44972228e+03
 3.74025626e+02 1.13673763e+02 3.80773833e+01 8.40954496e+00
 3.37357128e+00 8.60356437e+00 4.92569522e-01]
grad_E = [ 2.51925403e-05  4.14276809e-09 -1.52992077e-05  1.82904738e-11
  1.11485121e-10  6.44588196e-10  2.52739596e-09  1.04984902e-08
  5.65248710e-08  3.55215763e-06  1.21072080e-07  6.97643502e-06
 -2.27230188e-05 -2.34173598e-05 -1.05281093e-06  1.19982150e-05
 -2.10516862e-05 -4.52353497e-07 -3.58116574e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:55:03 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263752091463       1
[INPUT] 0    0    [1    /1   ]  117616.81421         1
[INPUT] 0    0    [1    /1   ]  0.670385204555       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031127        1
[INPUT] 0    0    [1    /1   ]  147020.992128        1
[INPUT] 0    0    [1    /1   ]  73510.42089          1
[INPUT] 0    0    [1    /1   ]  36754.719607         1
[INPUT] 0    0    [1    /1   ]  7303.44817677        1
[INPUT] 0    0    [1    /1   ]  18375.8092698        1
[INPUT] 0    0    [1    /1   ]  1449.70308127        1
[INPUT] 0    0    [1    /1   ]  374.106386542        1
[INPUT] 0    0    [1    /1   ]  113.658432832        1
[INPUT] 0    0    [1    /1   ]  38.0667968713        1
[INPUT] 0    0    [1    /1   ]  8.40970700297        1
[INPUT] 0    0    [1    /1   ]  3.37323035932        1
[INPUT] 1    0    [1    /1   ]  8.60356573342        1
[INPUT] 1    0    [1    /1   ]  0.492569292425       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26375209146314094, 1.0]], [0, [117616.81421000416, 1.0]], [0, [0.6703852045545036, 1.0]], [0, [1176168.1426187463, 1.0]], [0, [588084.0699917072, 1.0]], [0, [294042.03112693416, 1.0]], [0, [147020.99212837787, 1.0]], [0, [73510.42088995395, 1.0]], [0, [36754.719607046514, 1.0]], [0, [7303.448176772772, 1.0]], [0, [18375.80926983466, 1.0]], [0, [1449.7030812733913, 1.0]], [0, [374.10638654167786, 1.0]], [0, [113.65843283191742, 1.0]], [0, [38.066796871311, 1.0]], [0, [8.409707002965117, 1.0]], [0, [3.37323035932252, 1.0]], [1, [8.603565733422771, 1.0]], [1, [0.49256929242537556, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26375209]
bas 1, expnt(s) = [117616.81421]
bas 2, expnt(s) = [0.6703852]
bas 3, expnt(s) = [1176168.14261875]
bas 4, expnt(s) = [588084.06999171]
bas 5, expnt(s) = [294042.03112693]
bas 6, expnt(s) = [147020.99212838]
bas 7, expnt(s) = [73510.42088995]
bas 8, expnt(s) = [36754.71960705]
bas 9, expnt(s) = [7303.44817677]
bas 10, expnt(s) = [18375.80926983]
bas 11, expnt(s) = [1449.70308127]
bas 12, expnt(s) = [374.10638654]
bas 13, expnt(s) = [113.65843283]
bas 14, expnt(s) = [38.06679687]
bas 15, expnt(s) = [8.409707]
bas 16, expnt(s) = [3.37323036]
bas 17, expnt(s) = [8.60356573]
bas 18, expnt(s) = [0.49256929]
CPU time:       277.38
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63752091e-01 9.29847994e-01 1.17616814e+05 1.60460109e+04
 6.70385205e-01 1.87179525e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547196e+04 6.70656070e+03 7.30344818e+03 1.99600207e+03
 1.83758093e+04 3.98749251e+03 1.44970308e+03 5.93573250e+02
 3.74106387e+02 2.14912346e+02 1.13658433e+02 8.79460365e+01
 3.80667969e+01 3.87190573e+01 8.40970700e+00 1.24767270e+01
 3.37323036e+00 6.28853561e+00 8.60356573e+00 4.29865404e+01
 4.92569292e-01 1.20383942e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33575626041158
cond(S) = 907774.3432580534
E1 = -689.5617658312478  E_coul = 184.95916318374373
init E= -504.602602647504
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672510184081387  LUMO = 0.771673020496837
  mo_energy =
[-1.21704988e+02 -1.33853042e+01 -7.62438173e+00 -7.62438173e+00
 -7.62438173e+00 -1.65765828e+00 -6.72510184e-01 -6.72510184e-01
 -6.72510184e-01  7.71673020e-01  1.25949444e+01  1.13436995e+02
  6.08788963e+02  2.74858359e+03  1.22272603e+04  4.08484251e+04
  1.04891884e+05  2.30075215e+05  4.55890078e+05  8.44842283e+05
  1.52801950e+06  2.85028683e+06  5.80817402e+06]
E1 = -707.7275996769058  E_coul = 199.7721541719189
cycle= 1 E= -507.955445504987  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625927
diis-c [-0.39178411  1.        ]
  HOMO = -0.217961905370894  LUMO = 1.17825993784356
  mo_energy =
[-1.20194491e+02 -1.23037218e+01 -6.59470999e+00 -6.59470999e+00
 -6.59470999e+00 -1.16325254e+00 -2.17961905e-01 -2.17961905e-01
 -2.17961905e-01  1.17825994e+00  1.35412353e+01  1.14838246e+02
  6.10285406e+02  2.75001925e+03  1.22285870e+04  4.08496854e+04
  1.04893108e+05  2.30076415e+05  4.55891261e+05  8.44843452e+05
  1.52802065e+06  2.85028797e+06  5.80817516e+06]
E1 = -706.7921540106729  E_coul = 198.81928958604004
cycle= 2 E= -507.972864424633  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258029
diis-c [-6.62826838e-04  2.74492276e-03  9.97255077e-01]
  HOMO = -0.239672301087969  LUMO = 1.17164598715034
  mo_energy =
[-1.20306667e+02 -1.23696166e+01 -6.66768455e+00 -6.66768455e+00
 -6.66768455e+00 -1.17723197e+00 -2.39672301e-01 -2.39672301e-01
 -2.39672301e-01  1.17164599e+00  1.34901304e+01  1.14744471e+02
  6.10169258e+02  2.74988718e+03  1.22284449e+04  4.08495395e+04
  1.04892960e+05  2.30076266e+05  4.55891112e+05  8.44843303e+05
  1.52802050e+06  2.85028782e+06  5.80817501e+06]
E1 = -706.6879365074958  E_coul = 198.7148245520173
cycle= 3 E= -507.973111955479  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292383
diis-c [-1.54769485e-06 -1.77046670e-04 -1.14463709e-01  1.11464076e+00]
  HOMO = -0.242800037199405  LUMO = 1.17046640434218
  mo_energy =
[-1.20318758e+02 -1.23782968e+01 -6.67687985e+00 -6.67687985e+00
 -6.67687985e+00 -1.17912544e+00 -2.42800037e-01 -2.42800037e-01
 -2.42800037e-01  1.17046640e+00  1.34831225e+01  1.14733699e+02
  6.10156993e+02  2.74987403e+03  1.22284312e+04  4.08495257e+04
  1.04892946e+05  2.30076252e+05  4.55891098e+05  8.44843289e+05
  1.52802049e+06  2.85028781e+06  5.80817500e+06]
E1 = -706.6730489521061  E_coul = 198.6999324735527
cycle= 4 E= -507.973116478553  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00914
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108237
diis-c [-6.83250273e-11 -5.28594909e-06  7.34089307e-03 -9.11117268e-02
  1.08377612e+00]
  HOMO = -0.242904319397552  LUMO = 1.17042087568621
  mo_energy =
[-1.20319000e+02 -1.23785510e+01 -6.67712814e+00 -6.67712814e+00
 -6.67712814e+00 -1.17918664e+00 -2.42904319e-01 -2.42904319e-01
 -2.42904319e-01  1.17042088e+00  1.34829065e+01  1.14733455e+02
  6.10156752e+02  2.74987379e+03  1.22284310e+04  4.08495254e+04
  1.04892946e+05  2.30076252e+05  4.55891098e+05  8.44843289e+05
  1.52802049e+06  2.85028781e+06  5.80817500e+06]
E1 = -706.672559069106  E_coul = 198.6994425851671
cycle= 5 E= -507.973116483939  delta_E= -5.39e-09  |g|= 2.57e-07  |ddm|= 0.000331
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.62746e-07
diis-c [-1.08759932e-14  1.88339476e-07 -9.29869827e-05  1.04157608e-03
 -1.16455389e-02  1.01069676e+00]
  HOMO = -0.242904362667361  LUMO = 1.17042102345276
  mo_energy =
[-1.20319001e+02 -1.23785513e+01 -6.67712844e+00 -6.67712844e+00
 -6.67712844e+00 -1.17918680e+00 -2.42904363e-01 -2.42904363e-01
 -2.42904363e-01  1.17042102e+00  1.34829064e+01  1.14733454e+02
  6.10156751e+02  2.74987379e+03  1.22284310e+04  4.08495254e+04
  1.04892946e+05  2.30076252e+05  4.55891098e+05  8.44843289e+05
  1.52802049e+06  2.85028781e+06  5.80817500e+06]
E1 = -706.6725586869469  E_coul = 198.6994422030074
cycle= 6 E= -507.97311648394  delta_E= -6.25e-13  |g|= 1.27e-08  |ddm|= 1.53e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6725586869469  E_coul = 198.6994422030074
  HOMO = -0.24290435573511  LUMO = 1.1704210262481
  mo_energy =
[-1.20319001e+02 -1.23785513e+01 -6.67712842e+00 -6.67712842e+00
 -6.67712842e+00 -1.17918679e+00 -2.42904356e-01 -2.42904356e-01
 -2.42904356e-01  1.17042103e+00  1.34829064e+01  1.14733454e+02
  6.10156751e+02  2.74987379e+03  1.22284310e+04  4.08495254e+04
  1.04892946e+05  2.30076252e+05  4.55891098e+05  8.44843289e+05
  1.52802049e+06  2.85028781e+06  5.80817500e+06]
E1 = -706.6725587219022  E_coul = 198.69944223796352
Extra cycle  E= -507.973116483939  delta_E= 8.53e-13  |g|= 2.23e-09  |ddm|= 2.32e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.63752091e-01 1.17616814e+05 6.70385205e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547196e+04 7.30344818e+03 1.83758093e+04 1.44970308e+03
 3.74106387e+02 1.13658433e+02 3.80667969e+01 8.40970700e+00
 3.37323036e+00 8.60356573e+00 4.92569292e-01]
E = -507.97311648393867
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:55:03 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263752091463       1
[INPUT] 0    0    [1    /1   ]  117616.81421         1
[INPUT] 0    0    [1    /1   ]  0.670385204555       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069992        1
[INPUT] 0    0    [1    /1   ]  294042.031127        1
[INPUT] 0    0    [1    /1   ]  147020.992128        1
[INPUT] 0    0    [1    /1   ]  73510.42089          1
[INPUT] 0    0    [1    /1   ]  36754.719607         1
[INPUT] 0    0    [1    /1   ]  7303.44817677        1
[INPUT] 0    0    [1    /1   ]  18375.8092698        1
[INPUT] 0    0    [1    /1   ]  1449.70308127        1
[INPUT] 0    0    [1    /1   ]  374.106386542        1
[INPUT] 0    0    [1    /1   ]  113.658432832        1
[INPUT] 0    0    [1    /1   ]  38.0667968713        1
[INPUT] 0    0    [1    /1   ]  8.40970700297        1
[INPUT] 0    0    [1    /1   ]  3.37323035932        1
[INPUT] 1    0    [1    /1   ]  8.60356573342        1
[INPUT] 1    0    [1    /1   ]  0.492569292425       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26375209146314094, 1.0]], [0, [117616.81421000416, 1.0]], [0, [0.6703852045545036, 1.0]], [0, [1176168.1426187463, 1.0]], [0, [588084.0699917072, 1.0]], [0, [294042.03112693416, 1.0]], [0, [147020.99212837787, 1.0]], [0, [73510.42088995395, 1.0]], [0, [36754.719607046514, 1.0]], [0, [7303.448176772772, 1.0]], [0, [18375.80926983466, 1.0]], [0, [1449.7030812733913, 1.0]], [0, [374.10638654167786, 1.0]], [0, [113.65843283191742, 1.0]], [0, [38.066796871311, 1.0]], [0, [8.409707002965117, 1.0]], [0, [3.37323035932252, 1.0]], [1, [8.603565733422771, 1.0]], [1, [0.49256929242537556, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26375209]
bas 1, expnt(s) = [117616.81421]
bas 2, expnt(s) = [0.6703852]
bas 3, expnt(s) = [1176168.14261875]
bas 4, expnt(s) = [588084.06999171]
bas 5, expnt(s) = [294042.03112693]
bas 6, expnt(s) = [147020.99212838]
bas 7, expnt(s) = [73510.42088995]
bas 8, expnt(s) = [36754.71960705]
bas 9, expnt(s) = [7303.44817677]
bas 10, expnt(s) = [18375.80926983]
bas 11, expnt(s) = [1449.70308127]
bas 12, expnt(s) = [374.10638654]
bas 13, expnt(s) = [113.65843283]
bas 14, expnt(s) = [38.06679687]
bas 15, expnt(s) = [8.409707]
bas 16, expnt(s) = [3.37323036]
bas 17, expnt(s) = [8.60356573]
bas 18, expnt(s) = [0.49256929]
CPU time:       278.01
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63752091e-01 9.29847994e-01 1.17616814e+05 1.60460109e+04
 6.70385205e-01 1.87179525e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104209e+04 1.12791587e+04
 3.67547196e+04 6.70656070e+03 7.30344818e+03 1.99600207e+03
 1.83758093e+04 3.98749251e+03 1.44970308e+03 5.93573250e+02
 3.74106387e+02 2.14912346e+02 1.13658433e+02 8.79460365e+01
 3.80667969e+01 3.87190573e+01 8.40970700e+00 1.24767270e+01
 3.37323036e+00 6.28853561e+00 8.60356573e+00 4.29865404e+01
 4.92569292e-01 1.20383942e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33575626041158
cond(S) = 907774.3432580534
E1 = -689.5617658312478  E_coul = 184.95916318374373
init E= -504.602602647504
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672510184081387  LUMO = 0.771673020496837
  mo_energy =
[-1.21704988e+02 -1.33853042e+01 -7.62438173e+00 -7.62438173e+00
 -7.62438173e+00 -1.65765828e+00 -6.72510184e-01 -6.72510184e-01
 -6.72510184e-01  7.71673020e-01  1.25949444e+01  1.13436995e+02
  6.08788963e+02  2.74858359e+03  1.22272603e+04  4.08484251e+04
  1.04891884e+05  2.30075215e+05  4.55890078e+05  8.44842283e+05
  1.52801950e+06  2.85028683e+06  5.80817402e+06]
E1 = -707.7275996769058  E_coul = 199.7721541719189
cycle= 1 E= -507.955445504987  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625927
diis-c [-0.39178411  1.        ]
  HOMO = -0.217961905370894  LUMO = 1.17825993784356
  mo_energy =
[-1.20194491e+02 -1.23037218e+01 -6.59470999e+00 -6.59470999e+00
 -6.59470999e+00 -1.16325254e+00 -2.17961905e-01 -2.17961905e-01
 -2.17961905e-01  1.17825994e+00  1.35412353e+01  1.14838246e+02
  6.10285406e+02  2.75001925e+03  1.22285870e+04  4.08496854e+04
  1.04893108e+05  2.30076415e+05  4.55891261e+05  8.44843452e+05
  1.52802065e+06  2.85028797e+06  5.80817516e+06]
E1 = -706.7921540106729  E_coul = 198.81928958604004
cycle= 2 E= -507.972864424633  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258029
diis-c [-6.62826838e-04  2.74492276e-03  9.97255077e-01]
  HOMO = -0.239672301087969  LUMO = 1.17164598715034
  mo_energy =
[-1.20306667e+02 -1.23696166e+01 -6.66768455e+00 -6.66768455e+00
 -6.66768455e+00 -1.17723197e+00 -2.39672301e-01 -2.39672301e-01
 -2.39672301e-01  1.17164599e+00  1.34901304e+01  1.14744471e+02
  6.10169258e+02  2.74988718e+03  1.22284449e+04  4.08495395e+04
  1.04892960e+05  2.30076266e+05  4.55891112e+05  8.44843303e+05
  1.52802050e+06  2.85028782e+06  5.80817501e+06]
E1 = -706.6879365074958  E_coul = 198.7148245520173
cycle= 3 E= -507.973111955479  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292383
diis-c [-1.54769485e-06 -1.77046670e-04 -1.14463709e-01  1.11464076e+00]
  HOMO = -0.242800037199405  LUMO = 1.17046640434218
  mo_energy =
[-1.20318758e+02 -1.23782968e+01 -6.67687985e+00 -6.67687985e+00
 -6.67687985e+00 -1.17912544e+00 -2.42800037e-01 -2.42800037e-01
 -2.42800037e-01  1.17046640e+00  1.34831225e+01  1.14733699e+02
  6.10156993e+02  2.74987403e+03  1.22284312e+04  4.08495257e+04
  1.04892946e+05  2.30076252e+05  4.55891098e+05  8.44843289e+05
  1.52802049e+06  2.85028781e+06  5.80817500e+06]
E1 = -706.6730489521061  E_coul = 198.6999324735527
cycle= 4 E= -507.973116478553  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00914
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108237
diis-c [-6.83250273e-11 -5.28594909e-06  7.34089307e-03 -9.11117268e-02
  1.08377612e+00]
  HOMO = -0.242904319397552  LUMO = 1.17042087568621
  mo_energy =
[-1.20319000e+02 -1.23785510e+01 -6.67712814e+00 -6.67712814e+00
 -6.67712814e+00 -1.17918664e+00 -2.42904319e-01 -2.42904319e-01
 -2.42904319e-01  1.17042088e+00  1.34829065e+01  1.14733455e+02
  6.10156752e+02  2.74987379e+03  1.22284310e+04  4.08495254e+04
  1.04892946e+05  2.30076252e+05  4.55891098e+05  8.44843289e+05
  1.52802049e+06  2.85028781e+06  5.80817500e+06]
E1 = -706.672559069106  E_coul = 198.6994425851671
cycle= 5 E= -507.973116483939  delta_E= -5.39e-09  |g|= 2.57e-07  |ddm|= 0.000331
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.62746e-07
diis-c [-1.08759932e-14  1.88339476e-07 -9.29869827e-05  1.04157608e-03
 -1.16455389e-02  1.01069676e+00]
  HOMO = -0.242904362667361  LUMO = 1.17042102345276
  mo_energy =
[-1.20319001e+02 -1.23785513e+01 -6.67712844e+00 -6.67712844e+00
 -6.67712844e+00 -1.17918680e+00 -2.42904363e-01 -2.42904363e-01
 -2.42904363e-01  1.17042102e+00  1.34829064e+01  1.14733454e+02
  6.10156751e+02  2.74987379e+03  1.22284310e+04  4.08495254e+04
  1.04892946e+05  2.30076252e+05  4.55891098e+05  8.44843289e+05
  1.52802049e+06  2.85028781e+06  5.80817500e+06]
E1 = -706.6725586869469  E_coul = 198.6994422030074
cycle= 6 E= -507.97311648394  delta_E= -6.25e-13  |g|= 1.27e-08  |ddm|= 1.53e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6725586869469  E_coul = 198.6994422030074
  HOMO = -0.24290435573511  LUMO = 1.1704210262481
  mo_energy =
[-1.20319001e+02 -1.23785513e+01 -6.67712842e+00 -6.67712842e+00
 -6.67712842e+00 -1.17918679e+00 -2.42904356e-01 -2.42904356e-01
 -2.42904356e-01  1.17042103e+00  1.34829064e+01  1.14733454e+02
  6.10156751e+02  2.74987379e+03  1.22284310e+04  4.08495254e+04
  1.04892946e+05  2.30076252e+05  4.55891098e+05  8.44843289e+05
  1.52802049e+06  2.85028781e+06  5.80817500e+06]
E1 = -706.6725587219022  E_coul = 198.69944223796352
Extra cycle  E= -507.973116483939  delta_E= 8.53e-13  |g|= 2.23e-09  |ddm|= 2.32e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907774.3432580534
E1 = -706.6725587219022  E_coul = 198.69944223796352
init E= -507.973116483939
    CPU time for initialize scf      1.44 sec, wall time      0.09 sec
  HOMO = -0.242904354763164  LUMO = 1.17042102670124
  mo_energy =
[-1.20319001e+02 -1.23785513e+01 -6.67712842e+00 -6.67712842e+00
 -6.67712842e+00 -1.17918679e+00 -2.42904355e-01 -2.42904355e-01
 -2.42904355e-01  1.17042103e+00  1.34829064e+01  1.14733454e+02
  6.10156751e+02  2.74987379e+03  1.22284310e+04  4.08495254e+04
  1.04892946e+05  2.30076252e+05  4.55891098e+05  8.44843289e+05
  1.52802049e+06  2.85028781e+06  5.80817500e+06]
E1 = -706.6725587250578  E_coul = 198.6994422411189
cycle= 1 E= -507.973116483939  delta_E= -2.27e-13  |g|= 1.51e-09  |ddm|= 2.12e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6725587250578  E_coul = 198.6994422411189
  HOMO = -0.242904354668385  LUMO = 1.17042102575123
  mo_energy =
[-1.20319001e+02 -1.23785513e+01 -6.67712842e+00 -6.67712842e+00
 -6.67712842e+00 -1.17918679e+00 -2.42904355e-01 -2.42904355e-01
 -2.42904355e-01  1.17042103e+00  1.34829064e+01  1.14733454e+02
  6.10156751e+02  2.74987379e+03  1.22284310e+04  4.08495254e+04
  1.04892946e+05  2.30076252e+05  4.55891098e+05  8.44843289e+05
  1.52802049e+06  2.85028781e+06  5.80817500e+06]
E1 = -706.6725587280399  E_coul = 198.69944224410108
Extra cycle  E= -507.973116483939  delta_E= 5.68e-14  |g|= 1.68e-09  |ddm|= 1.82e-09
    CPU time for scf_cycle      1.61 sec, wall time      0.16 sec
exp = [2.63752091e-01 1.17616814e+05 6.70385205e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104209e+04
 3.67547196e+04 7.30344818e+03 1.83758093e+04 1.44970308e+03
 3.74106387e+02 1.13658433e+02 3.80667969e+01 8.40970700e+00
 3.37323036e+00 8.60356573e+00 4.92569292e-01]
grad_E = [ 4.12360690e-05  4.15680460e-09 -2.50585849e-05  1.84573783e-11
  1.11940825e-10  6.46761325e-10  2.53607070e-09  1.05350515e-08
  5.67050218e-08  3.56471078e-06  1.21619728e-07  6.37316466e-06
 -1.75186095e-05 -3.56194229e-05 -1.85087035e-06  1.95578265e-05
 -3.43733892e-05 -7.44616472e-07 -5.87055588e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:55:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263686139772       1
[INPUT] 0    0    [1    /1   ]  117616.814184        1
[INPUT] 0    0    [1    /1   ]  0.670182068065       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069991        1
[INPUT] 0    0    [1    /1   ]  294042.031123        1
[INPUT] 0    0    [1    /1   ]  147020.992113        1
[INPUT] 0    0    [1    /1   ]  73510.4208246        1
[INPUT] 0    0    [1    /1   ]  36754.7192553        1
[INPUT] 0    0    [1    /1   ]  7303.42608013        1
[INPUT] 0    0    [1    /1   ]  18375.8085176        1
[INPUT] 0    0    [1    /1   ]  1449.65430933        1
[INPUT] 0    0    [1    /1   ]  374.300853232        1
[INPUT] 0    0    [1    /1   ]  113.66440965         1
[INPUT] 0    0    [1    /1   ]  38.0580868113        1
[INPUT] 0    0    [1    /1   ]  8.41047940079        1
[INPUT] 0    0    [1    /1   ]  3.373014889          1
[INPUT] 1    0    [1    /1   ]  8.60356665717        1
[INPUT] 1    0    [1    /1   ]  0.49256880253        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26368613977196204, 1.0]], [0, [117616.81418422749, 1.0]], [0, [0.6701820680648449, 1.0]], [0, [1176168.1426186333, 1.0]], [0, [588084.0699910142, 1.0]], [0, [294042.03112292336, 1.0]], [0, [147020.99211265307, 1.0]], [0, [73510.42082463925, 1.0]], [0, [36754.7192552543, 1.0]], [0, [7303.426080125274, 1.0]], [0, [18375.80851760219, 1.0]], [0, [1449.6543093312785, 1.0]], [0, [374.300853232423, 1.0]], [0, [113.66440964984338, 1.0]], [0, [38.058086811333624, 1.0]], [0, [8.410479400788727, 1.0]], [0, [3.373014889004341, 1.0]], [1, [8.603566657171612, 1.0]], [1, [0.4925688025301986, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26368614]
bas 1, expnt(s) = [117616.81418423]
bas 2, expnt(s) = [0.67018207]
bas 3, expnt(s) = [1176168.14261863]
bas 4, expnt(s) = [588084.06999101]
bas 5, expnt(s) = [294042.03112292]
bas 6, expnt(s) = [147020.99211265]
bas 7, expnt(s) = [73510.42082464]
bas 8, expnt(s) = [36754.71925525]
bas 9, expnt(s) = [7303.42608013]
bas 10, expnt(s) = [18375.8085176]
bas 11, expnt(s) = [1449.65430933]
bas 12, expnt(s) = [374.30085323]
bas 13, expnt(s) = [113.66440965]
bas 14, expnt(s) = [38.05808681]
bas 15, expnt(s) = [8.4104794]
bas 16, expnt(s) = [3.37301489]
bas 17, expnt(s) = [8.60356666]
bas 18, expnt(s) = [0.4925688]
CPU time:       282.84
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63686140e-01 9.29673606e-01 1.17616814e+05 1.60460109e+04
 6.70182068e-01 1.87136984e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104208e+04 1.12791587e+04
 3.67547193e+04 6.70656065e+03 7.30342608e+03 1.99599754e+03
 1.83758085e+04 3.98749239e+03 1.44965431e+03 5.93558273e+02
 3.74300853e+02 2.14996127e+02 1.13664410e+02 8.79495050e+01
 3.80580868e+01 3.87124127e+01 8.41047940e+00 1.24775865e+01
 3.37301489e+00 6.28823434e+00 8.60356666e+00 4.29865462e+01
 4.92568803e-01 1.20383792e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335758050720436
cond(S) = 907778.1797175782
E1 = -689.5614555077942  E_coul = 184.95913508591457
init E= -504.60232042188
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.672511205284398  LUMO = 0.771225511323208
  mo_energy =
[-1.21704992e+02 -1.33853053e+01 -7.62438388e+00 -7.62438388e+00
 -7.62438388e+00 -1.65765863e+00 -6.72511205e-01 -6.72511205e-01
 -6.72511205e-01  7.71225511e-01  1.25935713e+01  1.13424004e+02
  6.08916481e+02  2.74907167e+03  1.22277857e+04  4.08488786e+04
  1.04892290e+05  2.30075596e+05  4.55890445e+05  8.44842640e+05
  1.52801985e+06  2.85028717e+06  5.80817435e+06]
E1 = -707.7274816508142  E_coul = 199.77203229067015
cycle= 1 E= -507.955449360144  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.19 sec, wall time      0.01 sec
diis-norm(errvec)=0.625904
diis-c [-0.39175604  1.        ]
  HOMO = -0.217963312664482  LUMO = 1.17773703471774
  mo_energy =
[-1.20194513e+02 -1.23037291e+01 -6.59471915e+00 -6.59471915e+00
 -6.59471915e+00 -1.16325402e+00 -2.17963313e-01 -2.17963313e-01
 -2.17963313e-01  1.17773703e+00  1.35398580e+01  1.14825230e+02
  6.10412897e+02  2.75050728e+03  1.22291124e+04  4.08501389e+04
  1.04893514e+05  2.30076795e+05  4.55891627e+05  8.44843809e+05
  1.52802100e+06  2.85028831e+06  5.80817550e+06]
E1 = -706.7920619506406  E_coul = 198.8191944170719
cycle= 2 E= -507.972867533569  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258049
diis-c [-6.62937373e-04  2.74134098e-03  9.97258659e-01]
  HOMO = -0.239673888643983  LUMO = 1.17112630789355
  mo_energy =
[-1.20306686e+02 -1.23696218e+01 -6.66769136e+00 -6.66769136e+00
 -6.66769136e+00 -1.17723370e+00 -2.39673889e-01 -2.39673889e-01
 -2.39673889e-01  1.17112631e+00  1.34887562e+01  1.14731459e+02
  6.10296748e+02  2.75037521e+03  1.22289702e+04  4.08499930e+04
  1.04893367e+05  2.30076647e+05  4.55891478e+05  8.44843660e+05
  1.52802085e+06  2.85028817e+06  5.80817535e+06]
E1 = -706.6878340702034  E_coul = 198.71471895333718
cycle= 3 E= -507.973115116866  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292424
diis-c [-1.54826377e-06 -1.77076108e-04 -1.14470027e-01  1.11464710e+00]
  HOMO = -0.242802064682386  LUMO = 1.16994702754303
  mo_energy =
[-1.20318778e+02 -1.23783026e+01 -6.67688723e+00 -6.67688723e+00
 -6.67688723e+00 -1.17912746e+00 -2.42802065e-01 -2.42802065e-01
 -2.42802065e-01  1.16994703e+00  1.34817478e+01  1.14720687e+02
  6.10284482e+02  2.75036206e+03  1.22289565e+04  4.08499792e+04
  1.04893353e+05  2.30076633e+05  4.55891464e+05  8.44843646e+05
  1.52802084e+06  2.85028815e+06  5.80817533e+06]
E1 = -706.6729431529004  E_coul = 198.6998235108403
cycle= 4 E= -507.97311964206  delta_E= -4.53e-06  |g|= 0.000157  |ddm|= 0.00914
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108278
diis-c [-6.83368965e-11 -5.29012856e-06  7.34156407e-03 -9.11245409e-02
  1.08378827e+00]
  HOMO = -0.242906407440884  LUMO = 1.16990148668585
  mo_energy =
[-1.20319019e+02 -1.23785570e+01 -6.67713565e+00 -6.67713565e+00
 -6.67713565e+00 -1.17918870e+00 -2.42906407e-01 -2.42906407e-01
 -2.42906407e-01  1.16990149e+00  1.34815317e+01  1.14720442e+02
  6.10284241e+02  2.75036182e+03  1.22289563e+04  4.08499789e+04
  1.04893353e+05  2.30076633e+05  4.55891464e+05  8.44843646e+05
  1.52802084e+06  2.85028815e+06  5.80817533e+06]
E1 = -706.6724529425242  E_coul = 198.69933329507168
cycle= 5 E= -507.973119647452  delta_E= -5.39e-09  |g|= 2.56e-07  |ddm|= 0.000331
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.59722e-07
diis-c [-1.10020457e-14  1.79308130e-07 -9.09642489e-05  1.01730244e-03
 -1.13689214e-02  1.01044240e+00]
  HOMO = -0.242906451085818  LUMO = 1.1699016401187
  mo_energy =
[-1.20319020e+02 -1.23785572e+01 -6.67713596e+00 -6.67713596e+00
 -6.67713596e+00 -1.17918886e+00 -2.42906451e-01 -2.42906451e-01
 -2.42906451e-01  1.16990164e+00  1.34815316e+01  1.14720442e+02
  6.10284240e+02  2.75036182e+03  1.22289563e+04  4.08499789e+04
  1.04893353e+05  2.30076633e+05  4.55891464e+05  8.44843646e+05
  1.52802084e+06  2.85028815e+06  5.80817533e+06]
E1 = -706.6724525532111  E_coul = 198.69933290575864
cycle= 6 E= -507.973119647452  delta_E=    0  |g|= 1.37e-08  |ddm|= 1.57e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6724525532111  E_coul = 198.69933290575864
  HOMO = -0.242906444189106  LUMO = 1.16990163963706
  mo_energy =
[-1.20319020e+02 -1.23785572e+01 -6.67713594e+00 -6.67713594e+00
 -6.67713594e+00 -1.17918885e+00 -2.42906444e-01 -2.42906444e-01
 -2.42906444e-01  1.16990164e+00  1.34815316e+01  1.14720442e+02
  6.10284240e+02  2.75036182e+03  1.22289563e+04  4.08499789e+04
  1.04893353e+05  2.30076633e+05  4.55891464e+05  8.44843646e+05
  1.52802084e+06  2.85028815e+06  5.80817533e+06]
E1 = -706.6724525914341  E_coul = 198.6993329439816
Extra cycle  E= -507.973119647452  delta_E=    0  |g|= 2.36e-09  |ddm|= 2.53e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.12 sec
exp = [2.63686140e-01 1.17616814e+05 6.70182068e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104208e+04
 3.67547193e+04 7.30342608e+03 1.83758085e+04 1.44965431e+03
 3.74300853e+02 1.13664410e+02 3.80580868e+01 8.41047940e+00
 3.37301489e+00 8.60356666e+00 4.92568803e-01]
E = -507.97311964745245
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:55:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263686139772       1
[INPUT] 0    0    [1    /1   ]  117616.814184        1
[INPUT] 0    0    [1    /1   ]  0.670182068065       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069991        1
[INPUT] 0    0    [1    /1   ]  294042.031123        1
[INPUT] 0    0    [1    /1   ]  147020.992113        1
[INPUT] 0    0    [1    /1   ]  73510.4208246        1
[INPUT] 0    0    [1    /1   ]  36754.7192553        1
[INPUT] 0    0    [1    /1   ]  7303.42608013        1
[INPUT] 0    0    [1    /1   ]  18375.8085176        1
[INPUT] 0    0    [1    /1   ]  1449.65430933        1
[INPUT] 0    0    [1    /1   ]  374.300853232        1
[INPUT] 0    0    [1    /1   ]  113.66440965         1
[INPUT] 0    0    [1    /1   ]  38.0580868113        1
[INPUT] 0    0    [1    /1   ]  8.41047940079        1
[INPUT] 0    0    [1    /1   ]  3.373014889          1
[INPUT] 1    0    [1    /1   ]  8.60356665717        1
[INPUT] 1    0    [1    /1   ]  0.49256880253        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26368613977196204, 1.0]], [0, [117616.81418422749, 1.0]], [0, [0.6701820680648449, 1.0]], [0, [1176168.1426186333, 1.0]], [0, [588084.0699910142, 1.0]], [0, [294042.03112292336, 1.0]], [0, [147020.99211265307, 1.0]], [0, [73510.42082463925, 1.0]], [0, [36754.7192552543, 1.0]], [0, [7303.426080125274, 1.0]], [0, [18375.80851760219, 1.0]], [0, [1449.6543093312785, 1.0]], [0, [374.300853232423, 1.0]], [0, [113.66440964984338, 1.0]], [0, [38.058086811333624, 1.0]], [0, [8.410479400788727, 1.0]], [0, [3.373014889004341, 1.0]], [1, [8.603566657171612, 1.0]], [1, [0.4925688025301986, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26368614]
bas 1, expnt(s) = [117616.81418423]
bas 2, expnt(s) = [0.67018207]
bas 3, expnt(s) = [1176168.14261863]
bas 4, expnt(s) = [588084.06999101]
bas 5, expnt(s) = [294042.03112292]
bas 6, expnt(s) = [147020.99211265]
bas 7, expnt(s) = [73510.42082464]
bas 8, expnt(s) = [36754.71925525]
bas 9, expnt(s) = [7303.42608013]
bas 10, expnt(s) = [18375.8085176]
bas 11, expnt(s) = [1449.65430933]
bas 12, expnt(s) = [374.30085323]
bas 13, expnt(s) = [113.66440965]
bas 14, expnt(s) = [38.05808681]
bas 15, expnt(s) = [8.4104794]
bas 16, expnt(s) = [3.37301489]
bas 17, expnt(s) = [8.60356666]
bas 18, expnt(s) = [0.4925688]
CPU time:       283.49
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63686140e-01 9.29673606e-01 1.17616814e+05 1.60460109e+04
 6.70182068e-01 1.87136984e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104208e+04 1.12791587e+04
 3.67547193e+04 6.70656065e+03 7.30342608e+03 1.99599754e+03
 1.83758085e+04 3.98749239e+03 1.44965431e+03 5.93558273e+02
 3.74300853e+02 2.14996127e+02 1.13664410e+02 8.79495050e+01
 3.80580868e+01 3.87124127e+01 8.41047940e+00 1.24775865e+01
 3.37301489e+00 6.28823434e+00 8.60356666e+00 4.29865462e+01
 4.92568803e-01 1.20383792e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335758050720436
cond(S) = 907778.1797175782
E1 = -689.5614555077942  E_coul = 184.95913508591457
init E= -504.60232042188
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672511205284398  LUMO = 0.771225511323208
  mo_energy =
[-1.21704992e+02 -1.33853053e+01 -7.62438388e+00 -7.62438388e+00
 -7.62438388e+00 -1.65765863e+00 -6.72511205e-01 -6.72511205e-01
 -6.72511205e-01  7.71225511e-01  1.25935713e+01  1.13424004e+02
  6.08916481e+02  2.74907167e+03  1.22277857e+04  4.08488786e+04
  1.04892290e+05  2.30075596e+05  4.55890445e+05  8.44842640e+05
  1.52801985e+06  2.85028717e+06  5.80817435e+06]
E1 = -707.7274816508142  E_coul = 199.77203229067015
cycle= 1 E= -507.955449360144  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625904
diis-c [-0.39175604  1.        ]
  HOMO = -0.217963312664482  LUMO = 1.17773703471774
  mo_energy =
[-1.20194513e+02 -1.23037291e+01 -6.59471915e+00 -6.59471915e+00
 -6.59471915e+00 -1.16325402e+00 -2.17963313e-01 -2.17963313e-01
 -2.17963313e-01  1.17773703e+00  1.35398580e+01  1.14825230e+02
  6.10412897e+02  2.75050728e+03  1.22291124e+04  4.08501389e+04
  1.04893514e+05  2.30076795e+05  4.55891627e+05  8.44843809e+05
  1.52802100e+06  2.85028831e+06  5.80817550e+06]
E1 = -706.7920619506406  E_coul = 198.8191944170719
cycle= 2 E= -507.972867533569  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258049
diis-c [-6.62937373e-04  2.74134098e-03  9.97258659e-01]
  HOMO = -0.239673888643983  LUMO = 1.17112630789355
  mo_energy =
[-1.20306686e+02 -1.23696218e+01 -6.66769136e+00 -6.66769136e+00
 -6.66769136e+00 -1.17723370e+00 -2.39673889e-01 -2.39673889e-01
 -2.39673889e-01  1.17112631e+00  1.34887562e+01  1.14731459e+02
  6.10296748e+02  2.75037521e+03  1.22289702e+04  4.08499930e+04
  1.04893367e+05  2.30076647e+05  4.55891478e+05  8.44843660e+05
  1.52802085e+06  2.85028817e+06  5.80817535e+06]
E1 = -706.6878340702034  E_coul = 198.71471895333718
cycle= 3 E= -507.973115116866  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292424
diis-c [-1.54826377e-06 -1.77076108e-04 -1.14470027e-01  1.11464710e+00]
  HOMO = -0.242802064682386  LUMO = 1.16994702754303
  mo_energy =
[-1.20318778e+02 -1.23783026e+01 -6.67688723e+00 -6.67688723e+00
 -6.67688723e+00 -1.17912746e+00 -2.42802065e-01 -2.42802065e-01
 -2.42802065e-01  1.16994703e+00  1.34817478e+01  1.14720687e+02
  6.10284482e+02  2.75036206e+03  1.22289565e+04  4.08499792e+04
  1.04893353e+05  2.30076633e+05  4.55891464e+05  8.44843646e+05
  1.52802084e+06  2.85028815e+06  5.80817533e+06]
E1 = -706.6729431529004  E_coul = 198.6998235108403
cycle= 4 E= -507.97311964206  delta_E= -4.53e-06  |g|= 0.000157  |ddm|= 0.00914
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108278
diis-c [-6.83368965e-11 -5.29012856e-06  7.34156407e-03 -9.11245409e-02
  1.08378827e+00]
  HOMO = -0.242906407440884  LUMO = 1.16990148668585
  mo_energy =
[-1.20319019e+02 -1.23785570e+01 -6.67713565e+00 -6.67713565e+00
 -6.67713565e+00 -1.17918870e+00 -2.42906407e-01 -2.42906407e-01
 -2.42906407e-01  1.16990149e+00  1.34815317e+01  1.14720442e+02
  6.10284241e+02  2.75036182e+03  1.22289563e+04  4.08499789e+04
  1.04893353e+05  2.30076633e+05  4.55891464e+05  8.44843646e+05
  1.52802084e+06  2.85028815e+06  5.80817533e+06]
E1 = -706.6724529425242  E_coul = 198.69933329507168
cycle= 5 E= -507.973119647452  delta_E= -5.39e-09  |g|= 2.56e-07  |ddm|= 0.000331
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.59722e-07
diis-c [-1.10020457e-14  1.79308130e-07 -9.09642489e-05  1.01730244e-03
 -1.13689214e-02  1.01044240e+00]
  HOMO = -0.242906451085818  LUMO = 1.1699016401187
  mo_energy =
[-1.20319020e+02 -1.23785572e+01 -6.67713596e+00 -6.67713596e+00
 -6.67713596e+00 -1.17918886e+00 -2.42906451e-01 -2.42906451e-01
 -2.42906451e-01  1.16990164e+00  1.34815316e+01  1.14720442e+02
  6.10284240e+02  2.75036182e+03  1.22289563e+04  4.08499789e+04
  1.04893353e+05  2.30076633e+05  4.55891464e+05  8.44843646e+05
  1.52802084e+06  2.85028815e+06  5.80817533e+06]
E1 = -706.6724525532111  E_coul = 198.69933290575864
cycle= 6 E= -507.973119647452  delta_E=    0  |g|= 1.37e-08  |ddm|= 1.57e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6724525532111  E_coul = 198.69933290575864
  HOMO = -0.242906444189106  LUMO = 1.16990163963706
  mo_energy =
[-1.20319020e+02 -1.23785572e+01 -6.67713594e+00 -6.67713594e+00
 -6.67713594e+00 -1.17918885e+00 -2.42906444e-01 -2.42906444e-01
 -2.42906444e-01  1.16990164e+00  1.34815316e+01  1.14720442e+02
  6.10284240e+02  2.75036182e+03  1.22289563e+04  4.08499789e+04
  1.04893353e+05  2.30076633e+05  4.55891464e+05  8.44843646e+05
  1.52802084e+06  2.85028815e+06  5.80817533e+06]
E1 = -706.6724525914341  E_coul = 198.6993329439816
Extra cycle  E= -507.973119647452  delta_E=    0  |g|= 2.36e-09  |ddm|= 2.53e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907778.1797175782
E1 = -706.6724525914341  E_coul = 198.6993329439816
init E= -507.973119647452
    CPU time for initialize scf      1.45 sec, wall time      0.09 sec
  HOMO = -0.24290644312347  LUMO = 1.16990164078926
  mo_energy =
[-1.20319020e+02 -1.23785572e+01 -6.67713594e+00 -6.67713594e+00
 -6.67713594e+00 -1.17918885e+00 -2.42906443e-01 -2.42906443e-01
 -2.42906443e-01  1.16990164e+00  1.34815316e+01  1.14720442e+02
  6.10284240e+02  2.75036182e+03  1.22289563e+04  4.08499789e+04
  1.04893353e+05  2.30076633e+05  4.55891464e+05  8.44843646e+05
  1.52802084e+06  2.85028815e+06  5.80817533e+06]
E1 = -706.6724525957375  E_coul = 198.69933294828505
cycle= 1 E= -507.973119647452  delta_E=    0  |g|= 1.52e-09  |ddm|= 2.78e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6724525957375  E_coul = 198.69933294828505
  HOMO = -0.242906443003654  LUMO = 1.16990164054366
  mo_energy =
[-1.20319020e+02 -1.23785572e+01 -6.67713594e+00 -6.67713594e+00
 -6.67713594e+00 -1.17918885e+00 -2.42906443e-01 -2.42906443e-01
 -2.42906443e-01  1.16990164e+00  1.34815316e+01  1.14720442e+02
  6.10284240e+02  2.75036182e+03  1.22289563e+04  4.08499789e+04
  1.04893353e+05  2.30076633e+05  4.55891464e+05  8.44843646e+05
  1.52802084e+06  2.85028815e+06  5.80817533e+06]
E1 = -706.6724525966583  E_coul = 198.69933294920614
Extra cycle  E= -507.973119647452  delta_E= 2.27e-13  |g|= 1.58e-09  |ddm|= 6e-10
    CPU time for scf_cycle      1.62 sec, wall time      0.16 sec
exp = [2.63686140e-01 1.17616814e+05 6.70182068e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104208e+04
 3.67547193e+04 7.30342608e+03 1.83758085e+04 1.44965431e+03
 3.74300853e+02 1.13664410e+02 3.80580868e+01 8.41047940e+00
 3.37301489e+00 8.60356666e+00 4.92568803e-01]
grad_E = [ 6.38694673e-05  4.18368803e-09 -3.88092687e-05  1.87767781e-11
  1.12813737e-10  6.50922924e-10  2.55268564e-09  1.06050802e-08
  5.70499056e-08  3.58858189e-06  1.22669388e-07  5.27412667e-06
 -9.11565523e-06 -5.27605707e-05 -3.09005240e-06  3.03149074e-05
 -5.32149062e-05 -1.16880113e-06 -9.12303012e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:55:10 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263664617086       1
[INPUT] 0    0    [1    /1   ]  117616.814124        1
[INPUT] 0    0    [1    /1   ]  0.670063288946       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069989        1
[INPUT] 0    0    [1    /1   ]  294042.031114        1
[INPUT] 0    0    [1    /1   ]  147020.992076        1
[INPUT] 0    0    [1    /1   ]  73510.4206731        1
[INPUT] 0    0    [1    /1   ]  36754.7184391        1
[INPUT] 0    0    [1    /1   ]  7303.3748147         1
[INPUT] 0    0    [1    /1   ]  18375.806772         1
[INPUT] 0    0    [1    /1   ]  1449.54336742        1
[INPUT] 0    0    [1    /1   ]  374.727642947        1
[INPUT] 0    0    [1    /1   ]  113.743543877        1
[INPUT] 0    0    [1    /1   ]  38.064841344         1
[INPUT] 0    0    [1    /1   ]  8.41274376559        1
[INPUT] 0    0    [1    /1   ]  3.37346887568        1
[INPUT] 1    0    [1    /1   ]  8.60356506625        1
[INPUT] 1    0    [1    /1   ]  0.492567829624       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26366461708637373, 1.0]], [0, [117616.81412442686, 1.0]], [0, [0.6700632889460493, 1.0]], [0, [1176168.142618371, 1.0]], [0, [588084.0699894062, 1.0]], [0, [294042.0311136186, 1.0]], [0, [147020.99207617194, 1.0]], [0, [73510.42067310929, 1.0]], [0, [36754.71843914827, 1.0]], [0, [7303.374814698835, 1.0]], [0, [18375.806772033866, 1.0]], [0, [1449.543367420967, 1.0]], [0, [374.72764294724504, 1.0]], [0, [113.74354387680361, 1.0]], [0, [38.06484134395858, 1.0]], [0, [8.412743765588873, 1.0]], [0, [3.3734688756846882, 1.0]], [1, [8.603565066248908, 1.0]], [1, [0.4925678296240002, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26366462]
bas 1, expnt(s) = [117616.81412443]
bas 2, expnt(s) = [0.67006329]
bas 3, expnt(s) = [1176168.14261837]
bas 4, expnt(s) = [588084.06998941]
bas 5, expnt(s) = [294042.03111362]
bas 6, expnt(s) = [147020.99207617]
bas 7, expnt(s) = [73510.42067311]
bas 8, expnt(s) = [36754.71843915]
bas 9, expnt(s) = [7303.3748147]
bas 10, expnt(s) = [18375.80677203]
bas 11, expnt(s) = [1449.54336742]
bas 12, expnt(s) = [374.72764295]
bas 13, expnt(s) = [113.74354388]
bas 14, expnt(s) = [38.06484134]
bas 15, expnt(s) = [8.41274377]
bas 16, expnt(s) = [3.37346888]
bas 17, expnt(s) = [8.60356507]
bas 18, expnt(s) = [0.49256783]
CPU time:       288.32
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63664617e-01 9.29616693e-01 1.17616814e+05 1.60460109e+04
 6.70063289e-01 1.87112109e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104207e+04 1.12791586e+04
 3.67547184e+04 6.70656054e+03 7.30337481e+03 1.99598704e+03
 1.83758068e+04 3.98749210e+03 1.44954337e+03 5.93524204e+02
 3.74727643e+02 2.15179960e+02 1.13743544e+02 8.79954245e+01
 3.80648413e+01 3.87175655e+01 8.41274377e+00 1.24801059e+01
 3.37346888e+00 6.28886910e+00 8.60356507e+00 4.29865362e+01
 4.92567830e-01 1.20383495e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33575926792015
cond(S) = 907789.5920996992
E1 = -689.5609256578703  E_coul = 184.95908520150743
init E= -504.601840456363
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672512944469453  LUMO = 0.771037484690635
  mo_energy =
[-1.21705003e+02 -1.33853063e+01 -7.62438722e+00 -7.62438722e+00
 -7.62438722e+00 -1.65765986e+00 -6.72512944e-01 -6.72512944e-01
 -6.72512944e-01  7.71037485e-01  1.25967916e+01  1.13480551e+02
  6.09462953e+02  2.75047778e+03  1.22292444e+04  4.08501535e+04
  1.04893448e+05  2.30076687e+05  4.55891497e+05  8.44843668e+05
  1.52802085e+06  2.85028815e+06  5.80817531e+06]
E1 = -707.727392170653  E_coul = 199.7719352064987
cycle= 1 E= -507.955456964154  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625864
diis-c [-0.39170568  1.        ]
  HOMO = -0.217965295338615  LUMO = 1.17752152871277
  mo_energy =
[-1.20194532e+02 -1.23037335e+01 -6.59472605e+00 -6.59472605e+00
 -6.59472605e+00 -1.16325550e+00 -2.17965295e-01 -2.17965295e-01
 -2.17965295e-01  1.17752153e+00  1.35431819e+01  1.14881851e+02
  6.10959354e+02  2.75191336e+03  1.22305711e+04  4.08514137e+04
  1.04894671e+05  2.30077886e+05  4.55892680e+05  8.44844837e+05
  1.52802201e+06  2.85028930e+06  5.80817645e+06]
E1 = -706.7920018410842  E_coul = 198.81912745933283
cycle= 2 E= -507.972874381751  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258052
diis-c [-6.62955263e-04  2.73994530e-03  9.97260055e-01]
  HOMO = -0.239675645196038  LUMO = 1.17091193325006
  mo_energy =
[-1.20306702e+02 -1.23696238e+01 -6.66769563e+00 -6.66769563e+00
 -6.66769563e+00 -1.17723514e+00 -2.39675645e-01 -2.39675645e-01
 -2.39675645e-01  1.17091193e+00  1.34920751e+01  1.14788073e+02
  6.10843197e+02  2.75178129e+03  1.22304289e+04  4.08512679e+04
  1.04894524e+05  2.30077738e+05  4.55892531e+05  8.44844688e+05
  1.52802186e+06  2.85028915e+06  5.80817630e+06]
E1 = -706.6877702048818  E_coul = 198.7146482175203
cycle= 3 E= -507.973121987361  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0029243
diis-c [-1.54843913e-06 -1.77141779e-04 -1.14470103e-01  1.11464724e+00]
  HOMO = -0.242803989976107  LUMO = 1.16973274798402
  mo_energy =
[-1.20318794e+02 -1.23783048e+01 -6.67689167e+00 -6.67689167e+00
 -6.67689167e+00 -1.17912902e+00 -2.42803990e-01 -2.42803990e-01
 -2.42803990e-01  1.16973275e+00  1.34850658e+01  1.14777300e+02
  6.10830929e+02  2.75176815e+03  1.22304152e+04  4.08512540e+04
  1.04894510e+05  2.30077724e+05  4.55892517e+05  8.44844674e+05
  1.52802185e+06  2.85028914e+06  5.80817629e+06]
E1 = -706.6728778095061  E_coul = 198.69975129601
cycle= 4 E= -507.973126513496  delta_E= -4.53e-06  |g|= 0.000157  |ddm|= 0.00914
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108298
diis-c [-6.83870752e-11 -5.28261996e-06  7.34196092e-03 -9.11344858e-02
  1.08379781e+00]
  HOMO = -0.242908366394882  LUMO = 1.16968719712959
  mo_energy =
[-1.20319036e+02 -1.23785592e+01 -6.67714018e+00 -6.67714018e+00
 -6.67714018e+00 -1.17919028e+00 -2.42908366e-01 -2.42908366e-01
 -2.42908366e-01  1.16968720e+00  1.34848496e+01  1.14777056e+02
  6.10830688e+02  2.75176791e+03  1.22304150e+04  4.08512538e+04
  1.04894510e+05  2.30077724e+05  4.55892517e+05  8.44844674e+05
  1.52802185e+06  2.85028914e+06  5.80817629e+06]
E1 = -706.6723874165292  E_coul = 198.69926089763698
cycle= 5 E= -507.973126518892  delta_E= -5.4e-09  |g|= 2.56e-07  |ddm|= 0.000331
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.56744e-07
diis-c [-1.12367432e-14  1.69653511e-07 -8.88493774e-05  9.91831474e-04
 -1.10721229e-02  1.01016897e+00]
  HOMO = -0.242908409863885  LUMO = 1.16968734916975
  mo_energy =
[-1.20319037e+02 -1.23785595e+01 -6.67714049e+00 -6.67714049e+00
 -6.67714049e+00 -1.17919044e+00 -2.42908410e-01 -2.42908410e-01
 -2.42908410e-01  1.16968735e+00  1.34848495e+01  1.14777055e+02
  6.10830687e+02  2.75176791e+03  1.22304150e+04  4.08512538e+04
  1.04894510e+05  2.30077724e+05  4.55892517e+05  8.44844674e+05
  1.52802185e+06  2.85028914e+06  5.80817629e+06]
E1 = -706.6723870283502  E_coul = 198.69926050945838
cycle= 6 E= -507.973126518892  delta_E= 4.55e-13  |g|= 1.29e-08  |ddm|= 1.57e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6723870283502  E_coul = 198.69926050945838
  HOMO = -0.24290840281586  LUMO = 1.16968735249586
  mo_energy =
[-1.20319037e+02 -1.23785595e+01 -6.67714047e+00 -6.67714047e+00
 -6.67714047e+00 -1.17919043e+00 -2.42908403e-01 -2.42908403e-01
 -2.42908403e-01  1.16968735e+00  1.34848495e+01  1.14777055e+02
  6.10830687e+02  2.75176791e+03  1.22304150e+04  4.08512538e+04
  1.04894510e+05  2.30077724e+05  4.55892517e+05  8.44844674e+05
  1.52802185e+06  2.85028914e+06  5.80817629e+06]
E1 = -706.672387062475  E_coul = 198.69926054358243
Extra cycle  E= -507.973126518893  delta_E= -7.39e-13  |g|= 2.28e-09  |ddm|= 2.26e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.63664617e-01 1.17616814e+05 6.70063289e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104207e+04
 3.67547184e+04 7.30337481e+03 1.83758068e+04 1.44954337e+03
 3.74727643e+02 1.13743544e+02 3.80648413e+01 8.41274377e+00
 3.37346888e+00 8.60356507e+00 4.92567830e-01]
E = -507.9731265188925
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:55:10 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263664617086       1
[INPUT] 0    0    [1    /1   ]  117616.814124        1
[INPUT] 0    0    [1    /1   ]  0.670063288946       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069989        1
[INPUT] 0    0    [1    /1   ]  294042.031114        1
[INPUT] 0    0    [1    /1   ]  147020.992076        1
[INPUT] 0    0    [1    /1   ]  73510.4206731        1
[INPUT] 0    0    [1    /1   ]  36754.7184391        1
[INPUT] 0    0    [1    /1   ]  7303.3748147         1
[INPUT] 0    0    [1    /1   ]  18375.806772         1
[INPUT] 0    0    [1    /1   ]  1449.54336742        1
[INPUT] 0    0    [1    /1   ]  374.727642947        1
[INPUT] 0    0    [1    /1   ]  113.743543877        1
[INPUT] 0    0    [1    /1   ]  38.064841344         1
[INPUT] 0    0    [1    /1   ]  8.41274376559        1
[INPUT] 0    0    [1    /1   ]  3.37346887568        1
[INPUT] 1    0    [1    /1   ]  8.60356506625        1
[INPUT] 1    0    [1    /1   ]  0.492567829624       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26366461708637373, 1.0]], [0, [117616.81412442686, 1.0]], [0, [0.6700632889460493, 1.0]], [0, [1176168.142618371, 1.0]], [0, [588084.0699894062, 1.0]], [0, [294042.0311136186, 1.0]], [0, [147020.99207617194, 1.0]], [0, [73510.42067310929, 1.0]], [0, [36754.71843914827, 1.0]], [0, [7303.374814698835, 1.0]], [0, [18375.806772033866, 1.0]], [0, [1449.543367420967, 1.0]], [0, [374.72764294724504, 1.0]], [0, [113.74354387680361, 1.0]], [0, [38.06484134395858, 1.0]], [0, [8.412743765588873, 1.0]], [0, [3.3734688756846882, 1.0]], [1, [8.603565066248908, 1.0]], [1, [0.4925678296240002, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26366462]
bas 1, expnt(s) = [117616.81412443]
bas 2, expnt(s) = [0.67006329]
bas 3, expnt(s) = [1176168.14261837]
bas 4, expnt(s) = [588084.06998941]
bas 5, expnt(s) = [294042.03111362]
bas 6, expnt(s) = [147020.99207617]
bas 7, expnt(s) = [73510.42067311]
bas 8, expnt(s) = [36754.71843915]
bas 9, expnt(s) = [7303.3748147]
bas 10, expnt(s) = [18375.80677203]
bas 11, expnt(s) = [1449.54336742]
bas 12, expnt(s) = [374.72764295]
bas 13, expnt(s) = [113.74354388]
bas 14, expnt(s) = [38.06484134]
bas 15, expnt(s) = [8.41274377]
bas 16, expnt(s) = [3.37346888]
bas 17, expnt(s) = [8.60356507]
bas 18, expnt(s) = [0.49256783]
CPU time:       288.95
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63664617e-01 9.29616693e-01 1.17616814e+05 1.60460109e+04
 6.70063289e-01 1.87112109e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104207e+04 1.12791586e+04
 3.67547184e+04 6.70656054e+03 7.30337481e+03 1.99598704e+03
 1.83758068e+04 3.98749210e+03 1.44954337e+03 5.93524204e+02
 3.74727643e+02 2.15179960e+02 1.13743544e+02 8.79954245e+01
 3.80648413e+01 3.87175655e+01 8.41274377e+00 1.24801059e+01
 3.37346888e+00 6.28886910e+00 8.60356507e+00 4.29865362e+01
 4.92567830e-01 1.20383495e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33575926792015
cond(S) = 907789.5920996992
E1 = -689.5609256578703  E_coul = 184.95908520150743
init E= -504.601840456363
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672512944469453  LUMO = 0.771037484690635
  mo_energy =
[-1.21705003e+02 -1.33853063e+01 -7.62438722e+00 -7.62438722e+00
 -7.62438722e+00 -1.65765986e+00 -6.72512944e-01 -6.72512944e-01
 -6.72512944e-01  7.71037485e-01  1.25967916e+01  1.13480551e+02
  6.09462953e+02  2.75047778e+03  1.22292444e+04  4.08501535e+04
  1.04893448e+05  2.30076687e+05  4.55891497e+05  8.44843668e+05
  1.52802085e+06  2.85028815e+06  5.80817531e+06]
E1 = -707.727392170653  E_coul = 199.7719352064987
cycle= 1 E= -507.955456964154  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625864
diis-c [-0.39170568  1.        ]
  HOMO = -0.217965295338615  LUMO = 1.17752152871277
  mo_energy =
[-1.20194532e+02 -1.23037335e+01 -6.59472605e+00 -6.59472605e+00
 -6.59472605e+00 -1.16325550e+00 -2.17965295e-01 -2.17965295e-01
 -2.17965295e-01  1.17752153e+00  1.35431819e+01  1.14881851e+02
  6.10959354e+02  2.75191336e+03  1.22305711e+04  4.08514137e+04
  1.04894671e+05  2.30077886e+05  4.55892680e+05  8.44844837e+05
  1.52802201e+06  2.85028930e+06  5.80817645e+06]
E1 = -706.7920018410842  E_coul = 198.81912745933283
cycle= 2 E= -507.972874381751  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258052
diis-c [-6.62955263e-04  2.73994530e-03  9.97260055e-01]
  HOMO = -0.239675645196038  LUMO = 1.17091193325006
  mo_energy =
[-1.20306702e+02 -1.23696238e+01 -6.66769563e+00 -6.66769563e+00
 -6.66769563e+00 -1.17723514e+00 -2.39675645e-01 -2.39675645e-01
 -2.39675645e-01  1.17091193e+00  1.34920751e+01  1.14788073e+02
  6.10843197e+02  2.75178129e+03  1.22304289e+04  4.08512679e+04
  1.04894524e+05  2.30077738e+05  4.55892531e+05  8.44844688e+05
  1.52802186e+06  2.85028915e+06  5.80817630e+06]
E1 = -706.6877702048818  E_coul = 198.7146482175203
cycle= 3 E= -507.973121987361  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0029243
diis-c [-1.54843913e-06 -1.77141779e-04 -1.14470103e-01  1.11464724e+00]
  HOMO = -0.242803989976107  LUMO = 1.16973274798402
  mo_energy =
[-1.20318794e+02 -1.23783048e+01 -6.67689167e+00 -6.67689167e+00
 -6.67689167e+00 -1.17912902e+00 -2.42803990e-01 -2.42803990e-01
 -2.42803990e-01  1.16973275e+00  1.34850658e+01  1.14777300e+02
  6.10830929e+02  2.75176815e+03  1.22304152e+04  4.08512540e+04
  1.04894510e+05  2.30077724e+05  4.55892517e+05  8.44844674e+05
  1.52802185e+06  2.85028914e+06  5.80817629e+06]
E1 = -706.6728778095061  E_coul = 198.69975129601
cycle= 4 E= -507.973126513496  delta_E= -4.53e-06  |g|= 0.000157  |ddm|= 0.00914
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108298
diis-c [-6.83870752e-11 -5.28261996e-06  7.34196092e-03 -9.11344858e-02
  1.08379781e+00]
  HOMO = -0.242908366394882  LUMO = 1.16968719712959
  mo_energy =
[-1.20319036e+02 -1.23785592e+01 -6.67714018e+00 -6.67714018e+00
 -6.67714018e+00 -1.17919028e+00 -2.42908366e-01 -2.42908366e-01
 -2.42908366e-01  1.16968720e+00  1.34848496e+01  1.14777056e+02
  6.10830688e+02  2.75176791e+03  1.22304150e+04  4.08512538e+04
  1.04894510e+05  2.30077724e+05  4.55892517e+05  8.44844674e+05
  1.52802185e+06  2.85028914e+06  5.80817629e+06]
E1 = -706.6723874165292  E_coul = 198.69926089763698
cycle= 5 E= -507.973126518892  delta_E= -5.4e-09  |g|= 2.56e-07  |ddm|= 0.000331
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.56744e-07
diis-c [-1.12367432e-14  1.69653511e-07 -8.88493774e-05  9.91831474e-04
 -1.10721229e-02  1.01016897e+00]
  HOMO = -0.242908409863885  LUMO = 1.16968734916975
  mo_energy =
[-1.20319037e+02 -1.23785595e+01 -6.67714049e+00 -6.67714049e+00
 -6.67714049e+00 -1.17919044e+00 -2.42908410e-01 -2.42908410e-01
 -2.42908410e-01  1.16968735e+00  1.34848495e+01  1.14777055e+02
  6.10830687e+02  2.75176791e+03  1.22304150e+04  4.08512538e+04
  1.04894510e+05  2.30077724e+05  4.55892517e+05  8.44844674e+05
  1.52802185e+06  2.85028914e+06  5.80817629e+06]
E1 = -706.6723870283502  E_coul = 198.69926050945838
cycle= 6 E= -507.973126518892  delta_E= 4.55e-13  |g|= 1.29e-08  |ddm|= 1.57e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6723870283502  E_coul = 198.69926050945838
  HOMO = -0.24290840281586  LUMO = 1.16968735249586
  mo_energy =
[-1.20319037e+02 -1.23785595e+01 -6.67714047e+00 -6.67714047e+00
 -6.67714047e+00 -1.17919043e+00 -2.42908403e-01 -2.42908403e-01
 -2.42908403e-01  1.16968735e+00  1.34848495e+01  1.14777055e+02
  6.10830687e+02  2.75176791e+03  1.22304150e+04  4.08512538e+04
  1.04894510e+05  2.30077724e+05  4.55892517e+05  8.44844674e+05
  1.52802185e+06  2.85028914e+06  5.80817629e+06]
E1 = -706.672387062475  E_coul = 198.69926054358243
Extra cycle  E= -507.973126518893  delta_E= -7.39e-13  |g|= 2.28e-09  |ddm|= 2.26e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907789.5920996992
E1 = -706.672387062475  E_coul = 198.69926054358243
init E= -507.973126518893
    CPU time for initialize scf      1.48 sec, wall time      0.09 sec
  HOMO = -0.242908401865145  LUMO = 1.16968735209076
  mo_energy =
[-1.20319036e+02 -1.23785595e+01 -6.67714047e+00 -6.67714047e+00
 -6.67714047e+00 -1.17919043e+00 -2.42908402e-01 -2.42908402e-01
 -2.42908402e-01  1.16968735e+00  1.34848495e+01  1.14777055e+02
  6.10830687e+02  2.75176791e+03  1.22304150e+04  4.08512538e+04
  1.04894510e+05  2.30077724e+05  4.55892517e+05  8.44844674e+05
  1.52802185e+06  2.85028914e+06  5.80817629e+06]
E1 = -706.6723870672771  E_coul = 198.69926054838476
cycle= 1 E= -507.973126518892  delta_E= 1.71e-13  |g|= 1.54e-09  |ddm|= 3.15e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6723870672771  E_coul = 198.69926054838476
  HOMO = -0.242908401726766  LUMO = 1.16968735186784
  mo_energy =
[-1.20319036e+02 -1.23785595e+01 -6.67714047e+00 -6.67714047e+00
 -6.67714047e+00 -1.17919043e+00 -2.42908402e-01 -2.42908402e-01
 -2.42908402e-01  1.16968735e+00  1.34848495e+01  1.14777055e+02
  6.10830687e+02  2.75176791e+03  1.22304150e+04  4.08512538e+04
  1.04894510e+05  2.30077724e+05  4.55892517e+05  8.44844674e+05
  1.52802185e+06  2.85028914e+06  5.80817629e+06]
E1 = -706.6723870704988  E_coul = 198.69926055160647
Extra cycle  E= -507.973126518892  delta_E= 5.68e-14  |g|= 9.06e-10  |ddm|= 1.99e-09
    CPU time for scf_cycle      1.65 sec, wall time      0.16 sec
exp = [2.63664617e-01 1.17616814e+05 6.70063289e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104207e+04
 3.67547184e+04 7.30337481e+03 1.83758068e+04 1.44954337e+03
 3.74727643e+02 1.13743544e+02 3.80648413e+01 8.41274377e+00
 3.37346888e+00 8.60356507e+00 4.92567830e-01]
grad_E = [ 8.87032641e-05  4.23204367e-09 -5.38590626e-05  1.93504430e-11
  1.14384266e-10  6.58406777e-10  2.58257308e-09  1.07310589e-08
  5.76698669e-08  3.63114237e-06  1.24560082e-07  3.41229514e-06
  2.90978934e-06 -7.14322662e-05 -4.71910098e-06  4.24168958e-05
 -7.41396430e-05 -1.66371314e-06 -1.27641529e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:55:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263797822075       1
[INPUT] 0    0    [1    /1   ]  117616.814016        1
[INPUT] 0    0    [1    /1   ]  0.670309258918       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069986        1
[INPUT] 0    0    [1    /1   ]  294042.031097        1
[INPUT] 0    0    [1    /1   ]  147020.99201         1
[INPUT] 0    0    [1    /1   ]  73510.4203982        1
[INPUT] 0    0    [1    /1   ]  36754.7169588        1
[INPUT] 0    0    [1    /1   ]  7303.28181541        1
[INPUT] 0    0    [1    /1   ]  18375.803605         1
[INPUT] 0    0    [1    /1   ]  1449.34502314        1
[INPUT] 0    0    [1    /1   ]  375.469770485        1
[INPUT] 0    0    [1    /1   ]  113.972991014        1
[INPUT] 0    0    [1    /1   ]  38.1126569472        1
[INPUT] 0    0    [1    /1   ]  8.41742228786        1
[INPUT] 0    0    [1    /1   ]  3.37553490007        1
[INPUT] 1    0    [1    /1   ]  8.60355730065        1
[INPUT] 1    0    [1    /1   ]  0.492566295279       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2637978220745175, 1.0]], [0, [117616.8140159476, 1.0]], [0, [0.6703092589178969, 1.0]], [0, [1176168.1426178946, 1.0]], [0, [588084.0699864888, 1.0]], [0, [294042.03109673964, 1.0]], [0, [147020.99200999417, 1.0]], [0, [73510.42039822752, 1.0]], [0, [36754.71695876504, 1.0]], [0, [7303.281815414425, 1.0]], [0, [18375.803604985078, 1.0]], [0, [1449.3450231370127, 1.0]], [0, [375.46977048478635, 1.0]], [0, [113.97299101398039, 1.0]], [0, [38.11265694717968, 1.0]], [0, [8.417422287864499, 1.0]], [0, [3.3755349000714987, 1.0]], [1, [8.603557300645699, 1.0]], [1, [0.492566295279322, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26379782]
bas 1, expnt(s) = [117616.81401595]
bas 2, expnt(s) = [0.67030926]
bas 3, expnt(s) = [1176168.14261789]
bas 4, expnt(s) = [588084.06998649]
bas 5, expnt(s) = [294042.03109674]
bas 6, expnt(s) = [147020.99200999]
bas 7, expnt(s) = [73510.42039823]
bas 8, expnt(s) = [36754.71695877]
bas 9, expnt(s) = [7303.28181541]
bas 10, expnt(s) = [18375.80360499]
bas 11, expnt(s) = [1449.34502314]
bas 12, expnt(s) = [375.46977048]
bas 13, expnt(s) = [113.97299101]
bas 14, expnt(s) = [38.11265695]
bas 15, expnt(s) = [8.41742229]
bas 16, expnt(s) = [3.3755349]
bas 17, expnt(s) = [8.6035573]
bas 18, expnt(s) = [0.4925663]
CPU time:       293.82
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63797822e-01 9.29968907e-01 1.17616814e+05 1.60460109e+04
 6.70309259e-01 1.87163621e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104204e+04 1.12791586e+04
 3.67547170e+04 6.70656034e+03 7.30328182e+03 1.99596797e+03
 1.83758036e+04 3.98749159e+03 1.44934502e+03 5.93463293e+02
 3.75469770e+02 2.15499495e+02 1.13972991e+02 8.81285214e+01
 3.81126569e+01 3.87540365e+01 8.41742229e+00 1.24853109e+01
 3.37553490e+00 6.29175751e+00 8.60355730e+00 4.29864877e+01
 4.92566295e-01 1.20383026e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33575760439617
cond(S) = 907813.6056509452
E1 = -689.5602174890788  E_coul = 184.9590154599346
init E= -504.601202029144
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672515255115068  LUMO = 0.771809508693902
  mo_energy =
[-1.21705025e+02 -1.33853061e+01 -7.62439107e+00 -7.62439107e+00
 -7.62439107e+00 -1.65766263e+00 -6.72515255e-01 -6.72515255e-01
 -6.72515255e-01  7.71809509e-01  1.26109712e+01  1.13697206e+02
  6.10784172e+02  2.75338822e+03  1.22322064e+04  4.08527593e+04
  1.04895828e+05  2.30078940e+05  4.55893676e+05  8.44845798e+05
  1.52802294e+06  2.85029020e+06  5.80817730e+06]
E1 = -707.7274734275255  E_coul = 199.77200481084884
cycle= 1 E= -507.955468616677  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625807
diis-c [-0.39163393  1.        ]
  HOMO = -0.217967160339902  LUMO = 1.17843669586253
  mo_energy =
[-1.20194525e+02 -1.23037248e+01 -6.59471966e+00 -6.59471966e+00
 -6.59471966e+00 -1.16325557e+00 -2.17967160e-01 -2.17967160e-01
 -2.17967160e-01  1.17843670e+00  1.35576964e+01  1.15098817e+02
  6.12280611e+02  2.75482384e+03  1.22335332e+04  4.08540197e+04
  1.04897052e+05  2.30080140e+05  4.55894858e+05  8.44846967e+05
  1.52802410e+06  2.85029134e+06  5.80817844e+06]
E1 = -706.7920955292407  E_coul = 198.8192095799628
cycle= 2 E= -507.972885949278  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258
diis-c [-6.62674140e-04  2.74648154e-03  9.97253518e-01]
  HOMO = -0.23967626136344  LUMO = 1.1718208522479
  mo_energy =
[-1.20306694e+02 -1.23696142e+01 -6.66768819e+00 -6.66768819e+00
 -6.66768819e+00 -1.17723434e+00 -2.39676261e-01 -2.39676261e-01
 -2.39676261e-01  1.17182085e+00  1.35065650e+01  1.15005004e+02
  6.12164429e+02  2.75469178e+03  1.22333910e+04  4.08538739e+04
  1.04896905e+05  2.30079992e+05  4.55894709e+05  8.44846818e+05
  1.52802395e+06  2.85029119e+06  5.80817829e+06]
E1 = -706.687883679184  E_coul = 198.71475021398814
cycle= 3 E= -507.973133465196  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292325
diis-c [-1.54724329e-06 -1.77220908e-04 -1.14451591e-01  1.11462881e+00]
  HOMO = -0.242803797401785  LUMO = 1.17064104016998
  mo_energy =
[-1.20318785e+02 -1.23782939e+01 -6.67688302e+00 -6.67688302e+00
 -6.67688302e+00 -1.17912770e+00 -2.42803797e-01 -2.42803797e-01
 -2.42803797e-01  1.17064104e+00  1.34995541e+01  1.14994230e+02
  6.12152162e+02  2.75467863e+03  1.22333774e+04  4.08538600e+04
  1.04896891e+05  2.30079978e+05  4.55894695e+05  8.44846804e+05
  1.52802394e+06  2.85029118e+06  5.80817828e+06]
E1 = -706.672996883413  E_coul = 198.6998588955843
cycle= 4 E= -507.973137987829  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00914
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108238
diis-c [-6.83518945e-11 -5.27633804e-06  7.34139272e-03 -9.11272538e-02
  1.08379114e+00]
  HOMO = -0.242908094825852  LUMO = 1.17059549759399
  mo_energy =
[-1.20319027e+02 -1.23785482e+01 -6.67713140e+00 -6.67713140e+00
 -6.67713140e+00 -1.17918891e+00 -2.42908095e-01 -2.42908095e-01
 -2.42908095e-01  1.17059550e+00  1.34993380e+01  1.14993985e+02
  6.12151921e+02  2.75467839e+03  1.22333771e+04  4.08538598e+04
  1.04896890e+05  2.30079977e+05  4.55894695e+05  8.44846804e+05
  1.52802394e+06  2.85029118e+06  5.80817828e+06]
E1 = -706.672506911119  E_coul = 198.69936891790437
cycle= 5 E= -507.973137993215  delta_E= -5.39e-09  |g|= 2.57e-07  |ddm|= 0.000331
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.57686e-07
diis-c [-1.12386719e-14  1.75247491e-07 -9.05029280e-05  1.01260880e-03
 -1.13106967e-02  1.01038842e+00]
  HOMO = -0.24290813631931  LUMO = 1.17059564943854
  mo_energy =
[-1.20319028e+02 -1.23785485e+01 -6.67713171e+00 -6.67713171e+00
 -6.67713171e+00 -1.17918907e+00 -2.42908136e-01 -2.42908136e-01
 -2.42908136e-01  1.17059565e+00  1.34993379e+01  1.14993984e+02
  6.12151920e+02  2.75467839e+03  1.22333771e+04  4.08538598e+04
  1.04896890e+05  2.30079977e+05  4.55894695e+05  8.44846804e+05
  1.52802394e+06  2.85029118e+06  5.80817828e+06]
E1 = -706.6725065340988  E_coul = 198.69936854088417
cycle= 6 E= -507.973137993215  delta_E= -1.14e-13  |g|= 1.34e-08  |ddm|= 1.51e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6725065340988  E_coul = 198.69936854088417
  HOMO = -0.242908129269833  LUMO = 1.17059565168351
  mo_energy =
[-1.20319028e+02 -1.23785484e+01 -6.67713169e+00 -6.67713169e+00
 -6.67713169e+00 -1.17918906e+00 -2.42908129e-01 -2.42908129e-01
 -2.42908129e-01  1.17059565e+00  1.34993379e+01  1.14993984e+02
  6.12151920e+02  2.75467839e+03  1.22333771e+04  4.08538598e+04
  1.04896890e+05  2.30079977e+05  4.55894695e+05  8.44846804e+05
  1.52802394e+06  2.85029118e+06  5.80817828e+06]
E1 = -706.6725065715536  E_coul = 198.69936857833827
Extra cycle  E= -507.973137993215  delta_E= -6.82e-13  |g|= 2.43e-09  |ddm|= 2.47e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.12 sec
exp = [2.63797822e-01 1.17616814e+05 6.70309259e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104204e+04
 3.67547170e+04 7.30328182e+03 1.83758036e+04 1.44934502e+03
 3.75469770e+02 1.13972991e+02 3.81126569e+01 8.41742229e+00
 3.37553490e+00 8.60355730e+00 4.92566295e-01]
E = -507.97313799321535
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:55:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263797822075       1
[INPUT] 0    0    [1    /1   ]  117616.814016        1
[INPUT] 0    0    [1    /1   ]  0.670309258918       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069986        1
[INPUT] 0    0    [1    /1   ]  294042.031097        1
[INPUT] 0    0    [1    /1   ]  147020.99201         1
[INPUT] 0    0    [1    /1   ]  73510.4203982        1
[INPUT] 0    0    [1    /1   ]  36754.7169588        1
[INPUT] 0    0    [1    /1   ]  7303.28181541        1
[INPUT] 0    0    [1    /1   ]  18375.803605         1
[INPUT] 0    0    [1    /1   ]  1449.34502314        1
[INPUT] 0    0    [1    /1   ]  375.469770485        1
[INPUT] 0    0    [1    /1   ]  113.972991014        1
[INPUT] 0    0    [1    /1   ]  38.1126569472        1
[INPUT] 0    0    [1    /1   ]  8.41742228786        1
[INPUT] 0    0    [1    /1   ]  3.37553490007        1
[INPUT] 1    0    [1    /1   ]  8.60355730065        1
[INPUT] 1    0    [1    /1   ]  0.492566295279       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2637978220745175, 1.0]], [0, [117616.8140159476, 1.0]], [0, [0.6703092589178969, 1.0]], [0, [1176168.1426178946, 1.0]], [0, [588084.0699864888, 1.0]], [0, [294042.03109673964, 1.0]], [0, [147020.99200999417, 1.0]], [0, [73510.42039822752, 1.0]], [0, [36754.71695876504, 1.0]], [0, [7303.281815414425, 1.0]], [0, [18375.803604985078, 1.0]], [0, [1449.3450231370127, 1.0]], [0, [375.46977048478635, 1.0]], [0, [113.97299101398039, 1.0]], [0, [38.11265694717968, 1.0]], [0, [8.417422287864499, 1.0]], [0, [3.3755349000714987, 1.0]], [1, [8.603557300645699, 1.0]], [1, [0.492566295279322, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26379782]
bas 1, expnt(s) = [117616.81401595]
bas 2, expnt(s) = [0.67030926]
bas 3, expnt(s) = [1176168.14261789]
bas 4, expnt(s) = [588084.06998649]
bas 5, expnt(s) = [294042.03109674]
bas 6, expnt(s) = [147020.99200999]
bas 7, expnt(s) = [73510.42039823]
bas 8, expnt(s) = [36754.71695877]
bas 9, expnt(s) = [7303.28181541]
bas 10, expnt(s) = [18375.80360499]
bas 11, expnt(s) = [1449.34502314]
bas 12, expnt(s) = [375.46977048]
bas 13, expnt(s) = [113.97299101]
bas 14, expnt(s) = [38.11265695]
bas 15, expnt(s) = [8.41742229]
bas 16, expnt(s) = [3.3755349]
bas 17, expnt(s) = [8.6035573]
bas 18, expnt(s) = [0.4925663]
CPU time:       294.48
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63797822e-01 9.29968907e-01 1.17616814e+05 1.60460109e+04
 6.70309259e-01 1.87163621e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104204e+04 1.12791586e+04
 3.67547170e+04 6.70656034e+03 7.30328182e+03 1.99596797e+03
 1.83758036e+04 3.98749159e+03 1.44934502e+03 5.93463293e+02
 3.75469770e+02 2.15499495e+02 1.13972991e+02 8.81285214e+01
 3.81126569e+01 3.87540365e+01 8.41742229e+00 1.24853109e+01
 3.37553490e+00 6.29175751e+00 8.60355730e+00 4.29864877e+01
 4.92566295e-01 1.20383026e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33575760439617
cond(S) = 907813.6056509452
E1 = -689.5602174890788  E_coul = 184.9590154599346
init E= -504.601202029144
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672515255115068  LUMO = 0.771809508693902
  mo_energy =
[-1.21705025e+02 -1.33853061e+01 -7.62439107e+00 -7.62439107e+00
 -7.62439107e+00 -1.65766263e+00 -6.72515255e-01 -6.72515255e-01
 -6.72515255e-01  7.71809509e-01  1.26109712e+01  1.13697206e+02
  6.10784172e+02  2.75338822e+03  1.22322064e+04  4.08527593e+04
  1.04895828e+05  2.30078940e+05  4.55893676e+05  8.44845798e+05
  1.52802294e+06  2.85029020e+06  5.80817730e+06]
E1 = -707.7274734275255  E_coul = 199.77200481084884
cycle= 1 E= -507.955468616677  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625807
diis-c [-0.39163393  1.        ]
  HOMO = -0.217967160339902  LUMO = 1.17843669586253
  mo_energy =
[-1.20194525e+02 -1.23037248e+01 -6.59471966e+00 -6.59471966e+00
 -6.59471966e+00 -1.16325557e+00 -2.17967160e-01 -2.17967160e-01
 -2.17967160e-01  1.17843670e+00  1.35576964e+01  1.15098817e+02
  6.12280611e+02  2.75482384e+03  1.22335332e+04  4.08540197e+04
  1.04897052e+05  2.30080140e+05  4.55894858e+05  8.44846967e+05
  1.52802410e+06  2.85029134e+06  5.80817844e+06]
E1 = -706.7920955292407  E_coul = 198.8192095799628
cycle= 2 E= -507.972885949278  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0258
diis-c [-6.62674140e-04  2.74648154e-03  9.97253518e-01]
  HOMO = -0.23967626136344  LUMO = 1.1718208522479
  mo_energy =
[-1.20306694e+02 -1.23696142e+01 -6.66768819e+00 -6.66768819e+00
 -6.66768819e+00 -1.17723434e+00 -2.39676261e-01 -2.39676261e-01
 -2.39676261e-01  1.17182085e+00  1.35065650e+01  1.15005004e+02
  6.12164429e+02  2.75469178e+03  1.22333910e+04  4.08538739e+04
  1.04896905e+05  2.30079992e+05  4.55894709e+05  8.44846818e+05
  1.52802395e+06  2.85029119e+06  5.80817829e+06]
E1 = -706.687883679184  E_coul = 198.71475021398814
cycle= 3 E= -507.973133465196  delta_E= -0.000248  |g|= 0.00435  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292325
diis-c [-1.54724329e-06 -1.77220908e-04 -1.14451591e-01  1.11462881e+00]
  HOMO = -0.242803797401785  LUMO = 1.17064104016998
  mo_energy =
[-1.20318785e+02 -1.23782939e+01 -6.67688302e+00 -6.67688302e+00
 -6.67688302e+00 -1.17912770e+00 -2.42803797e-01 -2.42803797e-01
 -2.42803797e-01  1.17064104e+00  1.34995541e+01  1.14994230e+02
  6.12152162e+02  2.75467863e+03  1.22333774e+04  4.08538600e+04
  1.04896891e+05  2.30079978e+05  4.55894695e+05  8.44846804e+05
  1.52802394e+06  2.85029118e+06  5.80817828e+06]
E1 = -706.672996883413  E_coul = 198.6998588955843
cycle= 4 E= -507.973137987829  delta_E= -4.52e-06  |g|= 0.000157  |ddm|= 0.00914
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108238
diis-c [-6.83518945e-11 -5.27633804e-06  7.34139272e-03 -9.11272538e-02
  1.08379114e+00]
  HOMO = -0.242908094825852  LUMO = 1.17059549759399
  mo_energy =
[-1.20319027e+02 -1.23785482e+01 -6.67713140e+00 -6.67713140e+00
 -6.67713140e+00 -1.17918891e+00 -2.42908095e-01 -2.42908095e-01
 -2.42908095e-01  1.17059550e+00  1.34993380e+01  1.14993985e+02
  6.12151921e+02  2.75467839e+03  1.22333771e+04  4.08538598e+04
  1.04896890e+05  2.30079977e+05  4.55894695e+05  8.44846804e+05
  1.52802394e+06  2.85029118e+06  5.80817828e+06]
E1 = -706.672506911119  E_coul = 198.69936891790437
cycle= 5 E= -507.973137993215  delta_E= -5.39e-09  |g|= 2.57e-07  |ddm|= 0.000331
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.57686e-07
diis-c [-1.12386719e-14  1.75247491e-07 -9.05029280e-05  1.01260880e-03
 -1.13106967e-02  1.01038842e+00]
  HOMO = -0.24290813631931  LUMO = 1.17059564943854
  mo_energy =
[-1.20319028e+02 -1.23785485e+01 -6.67713171e+00 -6.67713171e+00
 -6.67713171e+00 -1.17918907e+00 -2.42908136e-01 -2.42908136e-01
 -2.42908136e-01  1.17059565e+00  1.34993379e+01  1.14993984e+02
  6.12151920e+02  2.75467839e+03  1.22333771e+04  4.08538598e+04
  1.04896890e+05  2.30079977e+05  4.55894695e+05  8.44846804e+05
  1.52802394e+06  2.85029118e+06  5.80817828e+06]
E1 = -706.6725065340988  E_coul = 198.69936854088417
cycle= 6 E= -507.973137993215  delta_E= -1.14e-13  |g|= 1.34e-08  |ddm|= 1.51e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6725065340988  E_coul = 198.69936854088417
  HOMO = -0.242908129269833  LUMO = 1.17059565168351
  mo_energy =
[-1.20319028e+02 -1.23785484e+01 -6.67713169e+00 -6.67713169e+00
 -6.67713169e+00 -1.17918906e+00 -2.42908129e-01 -2.42908129e-01
 -2.42908129e-01  1.17059565e+00  1.34993379e+01  1.14993984e+02
  6.12151920e+02  2.75467839e+03  1.22333771e+04  4.08538598e+04
  1.04896890e+05  2.30079977e+05  4.55894695e+05  8.44846804e+05
  1.52802394e+06  2.85029118e+06  5.80817828e+06]
E1 = -706.6725065715536  E_coul = 198.69936857833827
Extra cycle  E= -507.973137993215  delta_E= -6.82e-13  |g|= 2.43e-09  |ddm|= 2.47e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907813.6056509452
E1 = -706.6725065715536  E_coul = 198.69936857833827
init E= -507.973137993215
    CPU time for initialize scf      1.47 sec, wall time      0.09 sec
  HOMO = -0.242908128234688  LUMO = 1.17059564992594
  mo_energy =
[-1.20319028e+02 -1.23785484e+01 -6.67713168e+00 -6.67713168e+00
 -6.67713168e+00 -1.17918906e+00 -2.42908128e-01 -2.42908128e-01
 -2.42908128e-01  1.17059565e+00  1.34993379e+01  1.14993984e+02
  6.12151920e+02  2.75467839e+03  1.22333771e+04  4.08538598e+04
  1.04896890e+05  2.30079977e+05  4.55894695e+05  8.44846804e+05
  1.52802394e+06  2.85029118e+06  5.80817828e+06]
E1 = -706.6725065778771  E_coul = 198.699368584662
cycle= 1 E= -507.973137993215  delta_E= 2.27e-13  |g|= 1.35e-09  |ddm|= 4.13e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6725065778771  E_coul = 198.699368584662
  HOMO = -0.242908128050886  LUMO = 1.17059565110903
  mo_energy =
[-1.20319028e+02 -1.23785484e+01 -6.67713168e+00 -6.67713168e+00
 -6.67713168e+00 -1.17918906e+00 -2.42908128e-01 -2.42908128e-01
 -2.42908128e-01  1.17059565e+00  1.34993379e+01  1.14993984e+02
  6.12151920e+02  2.75467839e+03  1.22333771e+04  4.08538598e+04
  1.04896890e+05  2.30079977e+05  4.55894695e+05  8.44846804e+05
  1.52802394e+06  2.85029118e+06  5.80817828e+06]
E1 = -706.6725065780187  E_coul = 198.6993685848036
Extra cycle  E= -507.973137993215  delta_E= 5.68e-14  |g|= 1.75e-09  |ddm|= 1.58e-10
    CPU time for scf_cycle      1.64 sec, wall time      0.16 sec
exp = [2.63797822e-01 1.17616814e+05 6.70309259e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104204e+04
 3.67547170e+04 7.30328182e+03 1.83758036e+04 1.44934502e+03
 3.75469770e+02 1.13972991e+02 3.81126569e+01 8.41742229e+00
 3.37553490e+00 8.60355730e+00 4.92566295e-01]
grad_E = [ 9.76490811e-05  4.30122612e-09 -5.93365825e-05  2.01693446e-11
  1.16632122e-10  6.69110198e-10  2.62533715e-09  1.09113352e-08
  5.85560713e-08  3.69133785e-06  1.27270997e-07  9.51208673e-07
  1.48243989e-05 -7.76128504e-05 -5.30792713e-06  4.72687475e-05
 -8.25756549e-05 -1.85660414e-06 -1.41960833e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:55:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.264134124844       1
[INPUT] 0    0    [1    /1   ]  117616.813898        1
[INPUT] 0    0    [1    /1   ]  0.671088894357       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031078        1
[INPUT] 0    0    [1    /1   ]  147020.991938        1
[INPUT] 0    0    [1    /1   ]  73510.4200985        1
[INPUT] 0    0    [1    /1   ]  36754.7153448        1
[INPUT] 0    0    [1    /1   ]  7303.18042029        1
[INPUT] 0    0    [1    /1   ]  18375.8001515        1
[INPUT] 0    0    [1    /1   ]  1449.13199842        1
[INPUT] 0    0    [1    /1   ]  376.243361217        1
[INPUT] 0    0    [1    /1   ]  114.318217692        1
[INPUT] 0    0    [1    /1   ]  38.204073796         1
[INPUT] 0    0    [1    /1   ]  8.42312054447        1
[INPUT] 0    0    [1    /1   ]  3.3791562797         1
[INPUT] 1    0    [1    /1   ]  8.60354347699        1
[INPUT] 1    0    [1    /1   ]  0.492564879298       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2641341248438247, 1.0]], [0, [117616.81389767888, 1.0]], [0, [0.6710888943566689, 1.0]], [0, [1176168.1426173747, 1.0]], [0, [588084.0699833077, 1.0]], [0, [294042.0310783376, 1.0]], [0, [147020.99193784385, 1.0]], [0, [73510.42009853519, 1.0]], [0, [36754.71534483863, 1.0]], [0, [7303.180420290208, 1.0]], [0, [18375.800151511707, 1.0]], [0, [1449.1319984200163, 1.0]], [0, [376.2433612169615, 1.0]], [0, [114.31821769185053, 1.0]], [0, [38.20407379603425, 1.0]], [0, [8.423120544469931, 1.0]], [0, [3.379156279702112, 1.0]], [1, [8.603543476993543, 1.0]], [1, [0.4925648792976359, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26413412]
bas 1, expnt(s) = [117616.81389768]
bas 2, expnt(s) = [0.67108889]
bas 3, expnt(s) = [1176168.14261737]
bas 4, expnt(s) = [588084.06998331]
bas 5, expnt(s) = [294042.03107834]
bas 6, expnt(s) = [147020.99193784]
bas 7, expnt(s) = [73510.42009854]
bas 8, expnt(s) = [36754.71534484]
bas 9, expnt(s) = [7303.18042029]
bas 10, expnt(s) = [18375.80015151]
bas 11, expnt(s) = [1449.13199842]
bas 12, expnt(s) = [376.24336122]
bas 13, expnt(s) = [114.31821769]
bas 14, expnt(s) = [38.2040738]
bas 15, expnt(s) = [8.42312054]
bas 16, expnt(s) = [3.37915628]
bas 17, expnt(s) = [8.60354348]
bas 18, expnt(s) = [0.49256488]
CPU time:       299.35
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.64134125e-01 9.30857944e-01 1.17616814e+05 1.60460109e+04
 6.71088894e-01 1.87326864e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104201e+04 1.12791586e+04
 3.67547153e+04 6.70656012e+03 7.30318042e+03 1.99594719e+03
 1.83758002e+04 3.98749102e+03 1.44913200e+03 5.93397871e+02
 3.76243361e+02 2.15832409e+02 1.14318218e+02 8.83286531e+01
 3.82040738e+01 3.88237320e+01 8.42312054e+00 1.24916494e+01
 3.37915628e+00 6.29681933e+00 8.60354348e+00 4.29864014e+01
 4.92564879e-01 1.20382594e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335751438991398
cond(S) = 907843.4553410738
E1 = -689.5597362890642  E_coul = 184.95896170833547
init E= -504.600774580729
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672516883896277  LUMO = 0.77388706207203
  mo_energy =
[-1.21705052e+02 -1.33853038e+01 -7.62439285e+00 -7.62439285e+00
 -7.62439285e+00 -1.65766619e+00 -6.72516884e-01 -6.72516884e-01
 -6.72516884e-01  7.73887062e-01  1.26356231e+01  1.14059623e+02
  6.12589304e+02  2.75695880e+03  1.22357853e+04  4.08559251e+04
  1.04898735e+05  2.30081700e+05  4.55896347e+05  8.44848412e+05
  1.52802551e+06  2.85029270e+06  5.80817974e+06]
E1 = -707.7278314231825  E_coul = 199.77235261885616
cycle= 1 E= -507.955478804326  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625761
diis-c [-0.3915767  1.       ]
  HOMO = -0.217967298898325  LUMO = 1.18088409870347
  mo_energy =
[-1.20194471e+02 -1.23036970e+01 -6.59469188e+00 -6.59469188e+00
 -6.59469188e+00 -1.16325272e+00 -2.17967299e-01 -2.17967299e-01
 -2.17967299e-01  1.18088410e+00  1.35828744e+01  1.15461765e+02
  6.14085856e+02  2.75839456e+03  1.22371123e+04  4.08571857e+04
  1.04899959e+05  2.30082900e+05  4.55897530e+05  8.44849581e+05
  1.52802666e+06  2.85029385e+06  5.80818088e+06]
E1 = -706.7924235373678  E_coul = 198.8195261029391
cycle= 2 E= -507.972897434429  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.025788
diis-c [-6.62021199e-04  2.76358604e-03  9.97236414e-01]
  HOMO = -0.239674038994158  LUMO = 1.17425226743426
  mo_energy =
[-1.20306645e+02 -1.23695890e+01 -6.66766326e+00 -6.66766326e+00
 -6.66766326e+00 -1.17722959e+00 -2.39674039e-01 -2.39674039e-01
 -2.39674039e-01  1.17425227e+00  1.35316989e+01  1.15367889e+02
  6.13969638e+02  2.75826248e+03  1.22369702e+04  4.08570398e+04
  1.04899812e+05  2.30082751e+05  4.55897381e+05  8.44849432e+05
  1.52802652e+06  2.85029370e+06  5.80818073e+06]
E1 = -706.6882630151858  E_coul = 198.71511830758212
cycle= 3 E= -507.973144707604  delta_E= -0.000247  |g|= 0.00434  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292082
diis-c [-1.54427921e-06 -1.77283459e-04 -1.14410276e-01  1.11458756e+00]
  HOMO = -0.242799445974943  LUMO = 1.17307089396065
  mo_energy =
[-1.20318733e+02 -1.23782656e+01 -6.67685507e+00 -6.67685507e+00
 -6.67685507e+00 -1.17912157e+00 -2.42799446e-01 -2.42799446e-01
 -2.42799446e-01  1.17307089e+00  1.35246867e+01  1.15357114e+02
  6.13957371e+02  2.75824933e+03  1.22369565e+04  4.08570260e+04
  1.04899798e+05  2.30082737e+05  4.55897367e+05  8.44849418e+05
  1.52802650e+06  2.85029369e+06  5.80818072e+06]
E1 = -706.6733915359723  E_coul = 198.70024231532588
cycle= 4 E= -507.973149220646  delta_E= -4.51e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108064
diis-c [-6.82713296e-11 -5.25442274e-06  7.33918483e-03 -9.10912329e-02
  1.08375730e+00]
  HOMO = -0.242903502760405  LUMO = 1.17302537837579
  mo_energy =
[-1.20318974e+02 -1.23785195e+01 -6.67710299e+00 -6.67710299e+00
 -6.67710299e+00 -1.17918263e+00 -2.42903503e-01 -2.42903503e-01
 -2.42903503e-01  1.17302538e+00  1.35244709e+01  1.15356869e+02
  6.13957131e+02  2.75824910e+03  1.22369563e+04  4.08570257e+04
  1.04899798e+05  2.30082737e+05  4.55897367e+05  8.44849418e+05
  1.52802650e+06  2.85029369e+06  5.80818072e+06]
E1 = -706.6729028698184  E_coul = 198.69975364381472
cycle= 5 E= -507.973149226004  delta_E= -5.36e-09  |g|= 2.58e-07  |ddm|= 0.00033
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58622e-07
diis-c [-1.13473497e-14  1.79143752e-07 -9.17453343e-05  1.02797616e-03
 -1.14734056e-02  1.01053700e+00]
  HOMO = -0.242903540480049  LUMO = 1.17302553275144
  mo_energy =
[-1.20318975e+02 -1.23785197e+01 -6.67710328e+00 -6.67710328e+00
 -6.67710328e+00 -1.17918279e+00 -2.42903540e-01 -2.42903540e-01
 -2.42903540e-01  1.17302553e+00  1.35244708e+01  1.15356869e+02
  6.13957130e+02  2.75824910e+03  1.22369563e+04  4.08570257e+04
  1.04899798e+05  2.30082737e+05  4.55897367e+05  8.44849418e+05
  1.52802650e+06  2.85029369e+06  5.80818072e+06]
E1 = -706.6729025120167  E_coul = 198.69975328601328
cycle= 6 E= -507.973149226003  delta_E= 2.84e-13  |g|= 1.35e-08  |ddm|= 1.41e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6729025120167  E_coul = 198.69975328601328
  HOMO = -0.242903533349562  LUMO = 1.17302553379575
  mo_energy =
[-1.20318975e+02 -1.23785197e+01 -6.67710326e+00 -6.67710326e+00
 -6.67710326e+00 -1.17918278e+00 -2.42903533e-01 -2.42903533e-01
 -2.42903533e-01  1.17302553e+00  1.35244708e+01  1.15356869e+02
  6.13957130e+02  2.75824910e+03  1.22369563e+04  4.08570257e+04
  1.04899798e+05  2.30082737e+05  4.55897367e+05  8.44849418e+05
  1.52802650e+06  2.85029369e+06  5.80818072e+06]
E1 = -706.6729025476266  E_coul = 198.69975332162258
Extra cycle  E= -507.973149226004  delta_E= -6.25e-13  |g|= 2.52e-09  |ddm|= 2.38e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.64134125e-01 1.17616814e+05 6.71088894e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104201e+04
 3.67547153e+04 7.30318042e+03 1.83758002e+04 1.44913200e+03
 3.76243361e+02 1.14318218e+02 3.82040738e+01 8.42312054e+00
 3.37915628e+00 8.60354348e+00 4.92564879e-01]
E = -507.973149226004
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:55:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.264134124844       1
[INPUT] 0    0    [1    /1   ]  117616.813898        1
[INPUT] 0    0    [1    /1   ]  0.671088894357       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031078        1
[INPUT] 0    0    [1    /1   ]  147020.991938        1
[INPUT] 0    0    [1    /1   ]  73510.4200985        1
[INPUT] 0    0    [1    /1   ]  36754.7153448        1
[INPUT] 0    0    [1    /1   ]  7303.18042029        1
[INPUT] 0    0    [1    /1   ]  18375.8001515        1
[INPUT] 0    0    [1    /1   ]  1449.13199842        1
[INPUT] 0    0    [1    /1   ]  376.243361217        1
[INPUT] 0    0    [1    /1   ]  114.318217692        1
[INPUT] 0    0    [1    /1   ]  38.204073796         1
[INPUT] 0    0    [1    /1   ]  8.42312054447        1
[INPUT] 0    0    [1    /1   ]  3.3791562797         1
[INPUT] 1    0    [1    /1   ]  8.60354347699        1
[INPUT] 1    0    [1    /1   ]  0.492564879298       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2641341248438247, 1.0]], [0, [117616.81389767888, 1.0]], [0, [0.6710888943566689, 1.0]], [0, [1176168.1426173747, 1.0]], [0, [588084.0699833077, 1.0]], [0, [294042.0310783376, 1.0]], [0, [147020.99193784385, 1.0]], [0, [73510.42009853519, 1.0]], [0, [36754.71534483863, 1.0]], [0, [7303.180420290208, 1.0]], [0, [18375.800151511707, 1.0]], [0, [1449.1319984200163, 1.0]], [0, [376.2433612169615, 1.0]], [0, [114.31821769185053, 1.0]], [0, [38.20407379603425, 1.0]], [0, [8.423120544469931, 1.0]], [0, [3.379156279702112, 1.0]], [1, [8.603543476993543, 1.0]], [1, [0.4925648792976359, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26413412]
bas 1, expnt(s) = [117616.81389768]
bas 2, expnt(s) = [0.67108889]
bas 3, expnt(s) = [1176168.14261737]
bas 4, expnt(s) = [588084.06998331]
bas 5, expnt(s) = [294042.03107834]
bas 6, expnt(s) = [147020.99193784]
bas 7, expnt(s) = [73510.42009854]
bas 8, expnt(s) = [36754.71534484]
bas 9, expnt(s) = [7303.18042029]
bas 10, expnt(s) = [18375.80015151]
bas 11, expnt(s) = [1449.13199842]
bas 12, expnt(s) = [376.24336122]
bas 13, expnt(s) = [114.31821769]
bas 14, expnt(s) = [38.2040738]
bas 15, expnt(s) = [8.42312054]
bas 16, expnt(s) = [3.37915628]
bas 17, expnt(s) = [8.60354348]
bas 18, expnt(s) = [0.49256488]
CPU time:       300.00
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.64134125e-01 9.30857944e-01 1.17616814e+05 1.60460109e+04
 6.71088894e-01 1.87326864e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104201e+04 1.12791586e+04
 3.67547153e+04 6.70656012e+03 7.30318042e+03 1.99594719e+03
 1.83758002e+04 3.98749102e+03 1.44913200e+03 5.93397871e+02
 3.76243361e+02 2.15832409e+02 1.14318218e+02 8.83286531e+01
 3.82040738e+01 3.88237320e+01 8.42312054e+00 1.24916494e+01
 3.37915628e+00 6.29681933e+00 8.60354348e+00 4.29864014e+01
 4.92564879e-01 1.20382594e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335751438991398
cond(S) = 907843.4553410738
E1 = -689.5597362890642  E_coul = 184.95896170833547
init E= -504.600774580729
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672516883896277  LUMO = 0.77388706207203
  mo_energy =
[-1.21705052e+02 -1.33853038e+01 -7.62439285e+00 -7.62439285e+00
 -7.62439285e+00 -1.65766619e+00 -6.72516884e-01 -6.72516884e-01
 -6.72516884e-01  7.73887062e-01  1.26356231e+01  1.14059623e+02
  6.12589304e+02  2.75695880e+03  1.22357853e+04  4.08559251e+04
  1.04898735e+05  2.30081700e+05  4.55896347e+05  8.44848412e+05
  1.52802551e+06  2.85029270e+06  5.80817974e+06]
E1 = -707.7278314231825  E_coul = 199.77235261885616
cycle= 1 E= -507.955478804326  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625761
diis-c [-0.3915767  1.       ]
  HOMO = -0.217967298898325  LUMO = 1.18088409870347
  mo_energy =
[-1.20194471e+02 -1.23036970e+01 -6.59469188e+00 -6.59469188e+00
 -6.59469188e+00 -1.16325272e+00 -2.17967299e-01 -2.17967299e-01
 -2.17967299e-01  1.18088410e+00  1.35828744e+01  1.15461765e+02
  6.14085856e+02  2.75839456e+03  1.22371123e+04  4.08571857e+04
  1.04899959e+05  2.30082900e+05  4.55897530e+05  8.44849581e+05
  1.52802666e+06  2.85029385e+06  5.80818088e+06]
E1 = -706.7924235373678  E_coul = 198.8195261029391
cycle= 2 E= -507.972897434429  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.025788
diis-c [-6.62021199e-04  2.76358604e-03  9.97236414e-01]
  HOMO = -0.239674038994158  LUMO = 1.17425226743426
  mo_energy =
[-1.20306645e+02 -1.23695890e+01 -6.66766326e+00 -6.66766326e+00
 -6.66766326e+00 -1.17722959e+00 -2.39674039e-01 -2.39674039e-01
 -2.39674039e-01  1.17425227e+00  1.35316989e+01  1.15367889e+02
  6.13969638e+02  2.75826248e+03  1.22369702e+04  4.08570398e+04
  1.04899812e+05  2.30082751e+05  4.55897381e+05  8.44849432e+05
  1.52802652e+06  2.85029370e+06  5.80818073e+06]
E1 = -706.6882630151858  E_coul = 198.71511830758212
cycle= 3 E= -507.973144707604  delta_E= -0.000247  |g|= 0.00434  |ddm|= 0.0598
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00292082
diis-c [-1.54427921e-06 -1.77283459e-04 -1.14410276e-01  1.11458756e+00]
  HOMO = -0.242799445974943  LUMO = 1.17307089396065
  mo_energy =
[-1.20318733e+02 -1.23782656e+01 -6.67685507e+00 -6.67685507e+00
 -6.67685507e+00 -1.17912157e+00 -2.42799446e-01 -2.42799446e-01
 -2.42799446e-01  1.17307089e+00  1.35246867e+01  1.15357114e+02
  6.13957371e+02  2.75824933e+03  1.22369565e+04  4.08570260e+04
  1.04899798e+05  2.30082737e+05  4.55897367e+05  8.44849418e+05
  1.52802650e+06  2.85029369e+06  5.80818072e+06]
E1 = -706.6733915359723  E_coul = 198.70024231532588
cycle= 4 E= -507.973149220646  delta_E= -4.51e-06  |g|= 0.000157  |ddm|= 0.00913
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000108064
diis-c [-6.82713296e-11 -5.25442274e-06  7.33918483e-03 -9.10912329e-02
  1.08375730e+00]
  HOMO = -0.242903502760405  LUMO = 1.17302537837579
  mo_energy =
[-1.20318974e+02 -1.23785195e+01 -6.67710299e+00 -6.67710299e+00
 -6.67710299e+00 -1.17918263e+00 -2.42903503e-01 -2.42903503e-01
 -2.42903503e-01  1.17302538e+00  1.35244709e+01  1.15356869e+02
  6.13957131e+02  2.75824910e+03  1.22369563e+04  4.08570257e+04
  1.04899798e+05  2.30082737e+05  4.55897367e+05  8.44849418e+05
  1.52802650e+06  2.85029369e+06  5.80818072e+06]
E1 = -706.6729028698184  E_coul = 198.69975364381472
cycle= 5 E= -507.973149226004  delta_E= -5.36e-09  |g|= 2.58e-07  |ddm|= 0.00033
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58622e-07
diis-c [-1.13473497e-14  1.79143752e-07 -9.17453343e-05  1.02797616e-03
 -1.14734056e-02  1.01053700e+00]
  HOMO = -0.242903540480049  LUMO = 1.17302553275144
  mo_energy =
[-1.20318975e+02 -1.23785197e+01 -6.67710328e+00 -6.67710328e+00
 -6.67710328e+00 -1.17918279e+00 -2.42903540e-01 -2.42903540e-01
 -2.42903540e-01  1.17302553e+00  1.35244708e+01  1.15356869e+02
  6.13957130e+02  2.75824910e+03  1.22369563e+04  4.08570257e+04
  1.04899798e+05  2.30082737e+05  4.55897367e+05  8.44849418e+05
  1.52802650e+06  2.85029369e+06  5.80818072e+06]
E1 = -706.6729025120167  E_coul = 198.69975328601328
cycle= 6 E= -507.973149226003  delta_E= 2.84e-13  |g|= 1.35e-08  |ddm|= 1.41e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6729025120167  E_coul = 198.69975328601328
  HOMO = -0.242903533349562  LUMO = 1.17302553379575
  mo_energy =
[-1.20318975e+02 -1.23785197e+01 -6.67710326e+00 -6.67710326e+00
 -6.67710326e+00 -1.17918278e+00 -2.42903533e-01 -2.42903533e-01
 -2.42903533e-01  1.17302553e+00  1.35244708e+01  1.15356869e+02
  6.13957130e+02  2.75824910e+03  1.22369563e+04  4.08570257e+04
  1.04899798e+05  2.30082737e+05  4.55897367e+05  8.44849418e+05
  1.52802650e+06  2.85029369e+06  5.80818072e+06]
E1 = -706.6729025476266  E_coul = 198.69975332162258
Extra cycle  E= -507.973149226004  delta_E= -6.25e-13  |g|= 2.52e-09  |ddm|= 2.38e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907843.4553410738
E1 = -706.6729025476266  E_coul = 198.69975332162258
init E= -507.973149226004
    CPU time for initialize scf      1.51 sec, wall time      0.10 sec
  HOMO = -0.242903532346539  LUMO = 1.17302553317496
  mo_energy =
[-1.20318975e+02 -1.23785197e+01 -6.67710326e+00 -6.67710326e+00
 -6.67710326e+00 -1.17918278e+00 -2.42903532e-01 -2.42903532e-01
 -2.42903532e-01  1.17302553e+00  1.35244709e+01  1.15356869e+02
  6.13957130e+02  2.75824910e+03  1.22369563e+04  4.08570257e+04
  1.04899798e+05  2.30082737e+05  4.55897367e+05  8.44849418e+05
  1.52802650e+06  2.85029369e+06  5.80818072e+06]
E1 = -706.6729025540571  E_coul = 198.6997533280535
cycle= 1 E= -507.973149226004  delta_E= 3.41e-13  |g|= 1.13e-09  |ddm|= 4.1e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6729025540571  E_coul = 198.6997533280535
  HOMO = -0.242903532168534  LUMO = 1.17302553376981
  mo_energy =
[-1.20318975e+02 -1.23785197e+01 -6.67710326e+00 -6.67710326e+00
 -6.67710326e+00 -1.17918278e+00 -2.42903532e-01 -2.42903532e-01
 -2.42903532e-01  1.17302553e+00  1.35244708e+01  1.15356869e+02
  6.13957130e+02  2.75824910e+03  1.22369563e+04  4.08570257e+04
  1.04899798e+05  2.30082737e+05  4.55897367e+05  8.44849418e+05
  1.52802650e+06  2.85029369e+06  5.80818072e+06]
E1 = -706.672902555302  E_coul = 198.69975332929812
Extra cycle  E= -507.973149226004  delta_E= -2.27e-13  |g|= 1.37e-09  |ddm|= 7.79e-10
    CPU time for scf_cycle      1.67 sec, wall time      0.17 sec
exp = [2.64134125e-01 1.17616814e+05 6.71088894e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104201e+04
 3.67547153e+04 7.30318042e+03 1.83758002e+04 1.44913200e+03
 3.76243361e+02 1.14318218e+02 3.82040738e+01 8.42312054e+00
 3.37915628e+00 8.60354348e+00 4.92564879e-01]
grad_E = [ 7.01589789e-05  4.35587017e-09 -4.30302620e-05  2.08146260e-11
  1.18408332e-10  6.77561411e-10  2.65911809e-09  1.10537563e-08
  5.92552548e-08  3.73804612e-06  1.29416804e-07 -7.25857023e-07
  1.70523341e-05 -5.45265605e-05 -1.75094622e-06  3.32592774e-05
 -6.03431474e-05 -1.14496324e-06 -1.00551373e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:55:20 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.26443767987        1
[INPUT] 0    0    [1    /1   ]  117616.813851        1
[INPUT] 0    0    [1    /1   ]  0.671854768199       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.99191         1
[INPUT] 0    0    [1    /1   ]  73510.4199811        1
[INPUT] 0    0    [1    /1   ]  36754.7147127        1
[INPUT] 0    0    [1    /1   ]  7303.14070321        1
[INPUT] 0    0    [1    /1   ]  18375.7987983        1
[INPUT] 0    0    [1    /1   ]  1449.05138452        1
[INPUT] 0    0    [1    /1   ]  376.51523867         1
[INPUT] 0    0    [1    /1   ]  114.536817477        1
[INPUT] 0    0    [1    /1   ]  38.2738017313        1
[INPUT] 0    0    [1    /1   ]  8.42603155827        1
[INPUT] 0    0    [1    /1   ]  3.38182010116        1
[INPUT] 1    0    [1    /1   ]  8.60353329751        1
[INPUT] 1    0    [1    /1   ]  0.49256449891        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2644376798698995, 1.0]], [0, [117616.8138513557, 1.0]], [0, [0.6718547681987864, 1.0]], [0, [1176168.1426171707, 1.0]], [0, [588084.0699820615, 1.0]], [0, [294042.03107112995, 1.0]], [0, [147020.99190958377, 1.0]], [0, [73510.4199811486, 1.0]], [0, [36754.71471274487, 1.0]], [0, [7303.140703212256, 1.0]], [0, [18375.79879831948, 1.0]], [0, [1449.051384521321, 1.0]], [0, [376.5152386696179, 1.0]], [0, [114.53681747697064, 1.0]], [0, [38.27380173129142, 1.0]], [0, [8.426031558267296, 1.0]], [0, [3.3818201011588167, 1.0]], [1, [8.603533297507834, 1.0]], [1, [0.49256449891039117, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26443768]
bas 1, expnt(s) = [117616.81385136]
bas 2, expnt(s) = [0.67185477]
bas 3, expnt(s) = [1176168.14261717]
bas 4, expnt(s) = [588084.06998206]
bas 5, expnt(s) = [294042.03107113]
bas 6, expnt(s) = [147020.99190958]
bas 7, expnt(s) = [73510.41998115]
bas 8, expnt(s) = [36754.71471274]
bas 9, expnt(s) = [7303.14070321]
bas 10, expnt(s) = [18375.79879832]
bas 11, expnt(s) = [1449.05138452]
bas 12, expnt(s) = [376.51523867]
bas 13, expnt(s) = [114.53681748]
bas 14, expnt(s) = [38.27380173]
bas 15, expnt(s) = [8.42603156]
bas 16, expnt(s) = [3.3818201]
bas 17, expnt(s) = [8.6035333]
bas 18, expnt(s) = [0.4925645]
CPU time:       304.91
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.64437680e-01 9.31660167e-01 1.17616814e+05 1.60460109e+04
 6.71854768e-01 1.87487180e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104200e+04 1.12791586e+04
 3.67547147e+04 6.70656003e+03 7.30314070e+03 1.99593905e+03
 1.83757988e+04 3.98749080e+03 1.44905138e+03 5.93373113e+02
 3.76515239e+02 2.15949371e+02 1.14536817e+02 8.84552996e+01
 3.82738017e+01 3.88768641e+01 8.42603156e+00 1.24948871e+01
 3.38182010e+00 6.30054184e+00 8.60353330e+00 4.29863378e+01
 4.92564499e-01 1.20382477e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33574515743802
cond(S) = 907858.3504769728
E1 = -689.5598168683285  E_coul = 184.9589580620112
init E= -504.600858806317
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.672516818829275  LUMO = 0.775814883502845
  mo_energy =
[-1.21705066e+02 -1.33853011e+01 -7.62439158e+00 -7.62439158e+00
 -7.62439158e+00 -1.65766806e+00 -6.72516819e-01 -6.72516819e-01
 -6.72516819e-01  7.75814884e-01  1.26536779e+01  1.14312120e+02
  6.13614992e+02  2.75870570e+03  1.22374926e+04  4.08574485e+04
  1.04900146e+05  2.30083045e+05  4.55897653e+05  8.44849691e+05
  1.52802676e+06  2.85029393e+06  5.80818094e+06]
E1 = -707.728207141151  E_coul = 199.77272510174933
cycle= 1 E= -507.955482039402  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625757
diis-c [-0.39157152  1.        ]
  HOMO = -0.217965838631096  LUMO = 1.18314927469278
  mo_energy =
[-1.20194410e+02 -1.23036699e+01 -6.59466271e+00 -6.59466271e+00
 -6.59466271e+00 -1.16324903e+00 -2.17965839e-01 -2.17965839e-01
 -2.17965839e-01  1.18314927e+00  1.36012821e+01  1.15714638e+02
  6.15111651e+02  2.76014160e+03  1.22388198e+04  4.08587093e+04
  1.04901370e+05  2.30084245e+05  4.55898836e+05  8.44850860e+05
  1.52802792e+06  2.85029508e+06  5.80818208e+06]
E1 = -706.7927504599103  E_coul = 198.8198480761171
cycle= 2 E= -507.972902383793  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257778
diis-c [-6.61459237e-04  2.77895411e-03  9.97221046e-01]
  HOMO = -0.239670705095376  LUMO = 1.17650292324482
  mo_energy =
[-1.20306591e+02 -1.23695661e+01 -6.66763868e+00 -6.66763868e+00
 -6.66763868e+00 -1.17722429e+00 -2.39670705e-01 -2.39670705e-01
 -2.39670705e-01  1.17650292e+00  1.35500739e+01  1.15620717e+02
  6.14995410e+02  2.76000951e+03  1.22386776e+04  4.08585634e+04
  1.04901223e+05  2.30084097e+05  4.55898687e+05  8.44850711e+05
  1.52802777e+06  2.85029493e+06  5.80818193e+06]
E1 = -706.6886370018425  E_coul = 198.71548757078878
cycle= 3 E= -507.973149431054  delta_E= -0.000247  |g|= 0.00434  |ddm|= 0.0597
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00291872
diis-c [-1.54165189e-06 -1.77264873e-04 -1.14374404e-01  1.11455167e+00]
  HOMO = -0.242794141128532  LUMO = 1.17532015377753
  mo_energy =
[-1.20318677e+02 -1.23782399e+01 -6.67682771e+00 -6.67682771e+00
 -6.67682771e+00 -1.17911497e+00 -2.42794141e-01 -2.42794141e-01
 -2.42794141e-01  1.17532015e+00  1.35430613e+01  1.15609940e+02
  6.14983145e+02  2.75999637e+03  1.22386640e+04  4.08585496e+04
  1.04901209e+05  2.30084083e+05  4.55898673e+05  8.44850697e+05
  1.52802776e+06  2.85029492e+06  5.80818191e+06]
E1 = -706.6737798707846  E_coul = 198.70062593564916
cycle= 4 E= -507.973153935135  delta_E= -4.5e-06  |g|= 0.000157  |ddm|= 0.00911
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0001079
diis-c [-6.81419781e-11 -5.24824239e-06  7.33683302e-03 -9.10514594e-02
  1.08371987e+00]
  HOMO = -0.242897966310682  LUMO = 1.17527466751723
  mo_energy =
[-1.20318917e+02 -1.23784933e+01 -6.67707517e+00 -6.67707517e+00
 -6.67707517e+00 -1.17917589e+00 -2.42897966e-01 -2.42897966e-01
 -2.42897966e-01  1.17527467e+00  1.35428460e+01  1.15609697e+02
  6.14982905e+02  2.75999613e+03  1.22386638e+04  4.08585494e+04
  1.04901209e+05  2.30084083e+05  4.55898673e+05  8.44850697e+05
  1.52802776e+06  2.85029492e+06  5.80818191e+06]
E1 = -706.6732924583876  E_coul = 198.70013851792268
cycle= 5 E= -507.973153940465  delta_E= -5.33e-09  |g|= 2.58e-07  |ddm|= 0.000329
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58829e-07
diis-c [-1.14992075e-14  1.81060683e-07 -9.20520047e-05  1.03192270e-03
 -1.15106079e-02  1.01057056e+00]
  HOMO = -0.242898001211499  LUMO = 1.17527482065979
  mo_energy =
[-1.20318918e+02 -1.23784935e+01 -6.67707545e+00 -6.67707545e+00
 -6.67707545e+00 -1.17917604e+00 -2.42898001e-01 -2.42898001e-01
 -2.42898001e-01  1.17527482e+00  1.35428459e+01  1.15609696e+02
  6.14982904e+02  2.75999613e+03  1.22386638e+04  4.08585494e+04
  1.04901209e+05  2.30084083e+05  4.55898673e+05  8.44850697e+05
  1.52802776e+06  2.85029492e+06  5.80818191e+06]
E1 = -706.6732921164604  E_coul = 198.70013817599528
cycle= 6 E= -507.973153940465  delta_E= -2.84e-13  |g|= 1.38e-08  |ddm|= 1.33e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6732921164604  E_coul = 198.70013817599528
  HOMO = -0.242897993956504  LUMO = 1.17527482192841
  mo_energy =
[-1.20318918e+02 -1.23784935e+01 -6.67707543e+00 -6.67707543e+00
 -6.67707543e+00 -1.17917603e+00 -2.42897994e-01 -2.42897994e-01
 -2.42897994e-01  1.17527482e+00  1.35428459e+01  1.15609696e+02
  6.14982904e+02  2.75999613e+03  1.22386638e+04  4.08585494e+04
  1.04901209e+05  2.30084083e+05  4.55898673e+05  8.44850697e+05
  1.52802776e+06  2.85029492e+06  5.80818191e+06]
E1 = -706.6732921529009  E_coul = 198.70013821243595
Extra cycle  E= -507.973153940465  delta_E= 1.71e-13  |g|= 3.16e-09  |ddm|= 2.43e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
exp = [2.64437680e-01 1.17616814e+05 6.71854768e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104200e+04
 3.67547147e+04 7.30314070e+03 1.83757988e+04 1.44905138e+03
 3.76515239e+02 1.14536817e+02 3.82738017e+01 8.42603156e+00
 3.38182010e+00 8.60353330e+00 4.92564499e-01]
E = -507.97315394046495
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:55:20 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.26443767987        1
[INPUT] 0    0    [1    /1   ]  117616.813851        1
[INPUT] 0    0    [1    /1   ]  0.671854768199       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.99191         1
[INPUT] 0    0    [1    /1   ]  73510.4199811        1
[INPUT] 0    0    [1    /1   ]  36754.7147127        1
[INPUT] 0    0    [1    /1   ]  7303.14070321        1
[INPUT] 0    0    [1    /1   ]  18375.7987983        1
[INPUT] 0    0    [1    /1   ]  1449.05138452        1
[INPUT] 0    0    [1    /1   ]  376.51523867         1
[INPUT] 0    0    [1    /1   ]  114.536817477        1
[INPUT] 0    0    [1    /1   ]  38.2738017313        1
[INPUT] 0    0    [1    /1   ]  8.42603155827        1
[INPUT] 0    0    [1    /1   ]  3.38182010116        1
[INPUT] 1    0    [1    /1   ]  8.60353329751        1
[INPUT] 1    0    [1    /1   ]  0.49256449891        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2644376798698995, 1.0]], [0, [117616.8138513557, 1.0]], [0, [0.6718547681987864, 1.0]], [0, [1176168.1426171707, 1.0]], [0, [588084.0699820615, 1.0]], [0, [294042.03107112995, 1.0]], [0, [147020.99190958377, 1.0]], [0, [73510.4199811486, 1.0]], [0, [36754.71471274487, 1.0]], [0, [7303.140703212256, 1.0]], [0, [18375.79879831948, 1.0]], [0, [1449.051384521321, 1.0]], [0, [376.5152386696179, 1.0]], [0, [114.53681747697064, 1.0]], [0, [38.27380173129142, 1.0]], [0, [8.426031558267296, 1.0]], [0, [3.3818201011588167, 1.0]], [1, [8.603533297507834, 1.0]], [1, [0.49256449891039117, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26443768]
bas 1, expnt(s) = [117616.81385136]
bas 2, expnt(s) = [0.67185477]
bas 3, expnt(s) = [1176168.14261717]
bas 4, expnt(s) = [588084.06998206]
bas 5, expnt(s) = [294042.03107113]
bas 6, expnt(s) = [147020.99190958]
bas 7, expnt(s) = [73510.41998115]
bas 8, expnt(s) = [36754.71471274]
bas 9, expnt(s) = [7303.14070321]
bas 10, expnt(s) = [18375.79879832]
bas 11, expnt(s) = [1449.05138452]
bas 12, expnt(s) = [376.51523867]
bas 13, expnt(s) = [114.53681748]
bas 14, expnt(s) = [38.27380173]
bas 15, expnt(s) = [8.42603156]
bas 16, expnt(s) = [3.3818201]
bas 17, expnt(s) = [8.6035333]
bas 18, expnt(s) = [0.4925645]
CPU time:       305.55
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.64437680e-01 9.31660167e-01 1.17616814e+05 1.60460109e+04
 6.71854768e-01 1.87487180e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104200e+04 1.12791586e+04
 3.67547147e+04 6.70656003e+03 7.30314070e+03 1.99593905e+03
 1.83757988e+04 3.98749080e+03 1.44905138e+03 5.93373113e+02
 3.76515239e+02 2.15949371e+02 1.14536817e+02 8.84552996e+01
 3.82738017e+01 3.88768641e+01 8.42603156e+00 1.24948871e+01
 3.38182010e+00 6.30054184e+00 8.60353330e+00 4.29863378e+01
 4.92564499e-01 1.20382477e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33574515743802
cond(S) = 907858.3504769728
E1 = -689.5598168683285  E_coul = 184.9589580620112
init E= -504.600858806317
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672516818829275  LUMO = 0.775814883502845
  mo_energy =
[-1.21705066e+02 -1.33853011e+01 -7.62439158e+00 -7.62439158e+00
 -7.62439158e+00 -1.65766806e+00 -6.72516819e-01 -6.72516819e-01
 -6.72516819e-01  7.75814884e-01  1.26536779e+01  1.14312120e+02
  6.13614992e+02  2.75870570e+03  1.22374926e+04  4.08574485e+04
  1.04900146e+05  2.30083045e+05  4.55897653e+05  8.44849691e+05
  1.52802676e+06  2.85029393e+06  5.80818094e+06]
E1 = -707.728207141151  E_coul = 199.77272510174933
cycle= 1 E= -507.955482039402  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625757
diis-c [-0.39157152  1.        ]
  HOMO = -0.217965838631096  LUMO = 1.18314927469278
  mo_energy =
[-1.20194410e+02 -1.23036699e+01 -6.59466271e+00 -6.59466271e+00
 -6.59466271e+00 -1.16324903e+00 -2.17965839e-01 -2.17965839e-01
 -2.17965839e-01  1.18314927e+00  1.36012821e+01  1.15714638e+02
  6.15111651e+02  2.76014160e+03  1.22388198e+04  4.08587093e+04
  1.04901370e+05  2.30084245e+05  4.55898836e+05  8.44850860e+05
  1.52802792e+06  2.85029508e+06  5.80818208e+06]
E1 = -706.7927504599103  E_coul = 198.8198480761171
cycle= 2 E= -507.972902383793  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257778
diis-c [-6.61459237e-04  2.77895411e-03  9.97221046e-01]
  HOMO = -0.239670705095376  LUMO = 1.17650292324482
  mo_energy =
[-1.20306591e+02 -1.23695661e+01 -6.66763868e+00 -6.66763868e+00
 -6.66763868e+00 -1.17722429e+00 -2.39670705e-01 -2.39670705e-01
 -2.39670705e-01  1.17650292e+00  1.35500739e+01  1.15620717e+02
  6.14995410e+02  2.76000951e+03  1.22386776e+04  4.08585634e+04
  1.04901223e+05  2.30084097e+05  4.55898687e+05  8.44850711e+05
  1.52802777e+06  2.85029493e+06  5.80818193e+06]
E1 = -706.6886370018425  E_coul = 198.71548757078878
cycle= 3 E= -507.973149431054  delta_E= -0.000247  |g|= 0.00434  |ddm|= 0.0597
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00291872
diis-c [-1.54165189e-06 -1.77264873e-04 -1.14374404e-01  1.11455167e+00]
  HOMO = -0.242794141128532  LUMO = 1.17532015377753
  mo_energy =
[-1.20318677e+02 -1.23782399e+01 -6.67682771e+00 -6.67682771e+00
 -6.67682771e+00 -1.17911497e+00 -2.42794141e-01 -2.42794141e-01
 -2.42794141e-01  1.17532015e+00  1.35430613e+01  1.15609940e+02
  6.14983145e+02  2.75999637e+03  1.22386640e+04  4.08585496e+04
  1.04901209e+05  2.30084083e+05  4.55898673e+05  8.44850697e+05
  1.52802776e+06  2.85029492e+06  5.80818191e+06]
E1 = -706.6737798707846  E_coul = 198.70062593564916
cycle= 4 E= -507.973153935135  delta_E= -4.5e-06  |g|= 0.000157  |ddm|= 0.00911
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0001079
diis-c [-6.81419781e-11 -5.24824239e-06  7.33683302e-03 -9.10514594e-02
  1.08371987e+00]
  HOMO = -0.242897966310682  LUMO = 1.17527466751723
  mo_energy =
[-1.20318917e+02 -1.23784933e+01 -6.67707517e+00 -6.67707517e+00
 -6.67707517e+00 -1.17917589e+00 -2.42897966e-01 -2.42897966e-01
 -2.42897966e-01  1.17527467e+00  1.35428460e+01  1.15609697e+02
  6.14982905e+02  2.75999613e+03  1.22386638e+04  4.08585494e+04
  1.04901209e+05  2.30084083e+05  4.55898673e+05  8.44850697e+05
  1.52802776e+06  2.85029492e+06  5.80818191e+06]
E1 = -706.6732924583876  E_coul = 198.70013851792268
cycle= 5 E= -507.973153940465  delta_E= -5.33e-09  |g|= 2.58e-07  |ddm|= 0.000329
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58829e-07
diis-c [-1.14992075e-14  1.81060683e-07 -9.20520047e-05  1.03192270e-03
 -1.15106079e-02  1.01057056e+00]
  HOMO = -0.242898001211499  LUMO = 1.17527482065979
  mo_energy =
[-1.20318918e+02 -1.23784935e+01 -6.67707545e+00 -6.67707545e+00
 -6.67707545e+00 -1.17917604e+00 -2.42898001e-01 -2.42898001e-01
 -2.42898001e-01  1.17527482e+00  1.35428459e+01  1.15609696e+02
  6.14982904e+02  2.75999613e+03  1.22386638e+04  4.08585494e+04
  1.04901209e+05  2.30084083e+05  4.55898673e+05  8.44850697e+05
  1.52802776e+06  2.85029492e+06  5.80818191e+06]
E1 = -706.6732921164604  E_coul = 198.70013817599528
cycle= 6 E= -507.973153940465  delta_E= -2.84e-13  |g|= 1.38e-08  |ddm|= 1.33e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6732921164604  E_coul = 198.70013817599528
  HOMO = -0.242897993956504  LUMO = 1.17527482192841
  mo_energy =
[-1.20318918e+02 -1.23784935e+01 -6.67707543e+00 -6.67707543e+00
 -6.67707543e+00 -1.17917603e+00 -2.42897994e-01 -2.42897994e-01
 -2.42897994e-01  1.17527482e+00  1.35428459e+01  1.15609696e+02
  6.14982904e+02  2.75999613e+03  1.22386638e+04  4.08585494e+04
  1.04901209e+05  2.30084083e+05  4.55898673e+05  8.44850697e+05
  1.52802776e+06  2.85029492e+06  5.80818191e+06]
E1 = -706.6732921529009  E_coul = 198.70013821243595
Extra cycle  E= -507.973153940465  delta_E= 1.71e-13  |g|= 3.16e-09  |ddm|= 2.43e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907858.3504769728
E1 = -706.6732921529009  E_coul = 198.70013821243595
init E= -507.973153940465
    CPU time for initialize scf      1.79 sec, wall time      0.12 sec
  HOMO = -0.242897992932731  LUMO = 1.17527482398521
  mo_energy =
[-1.20318918e+02 -1.23784935e+01 -6.67707543e+00 -6.67707543e+00
 -6.67707543e+00 -1.17917603e+00 -2.42897993e-01 -2.42897993e-01
 -2.42897993e-01  1.17527482e+00  1.35428459e+01  1.15609696e+02
  6.14982904e+02  2.75999613e+03  1.22386638e+04  4.08585494e+04
  1.04901209e+05  2.30084083e+05  4.55898673e+05  8.44850697e+05
  1.52802776e+06  2.85029492e+06  5.80818191e+06]
E1 = -706.67329215918  E_coul = 198.70013821871538
cycle= 1 E= -507.973153940465  delta_E= 2.84e-13  |g|= 2.17e-09  |ddm|= 3.96e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.67329215918  E_coul = 198.70013821871538
  HOMO = -0.242897992774309  LUMO = 1.17527482255597
  mo_energy =
[-1.20318918e+02 -1.23784935e+01 -6.67707543e+00 -6.67707543e+00
 -6.67707543e+00 -1.17917603e+00 -2.42897993e-01 -2.42897993e-01
 -2.42897993e-01  1.17527482e+00  1.35428459e+01  1.15609696e+02
  6.14982904e+02  2.75999613e+03  1.22386638e+04  4.08585494e+04
  1.04901209e+05  2.30084083e+05  4.55898673e+05  8.44850697e+05
  1.52802776e+06  2.85029492e+06  5.80818191e+06]
E1 = -706.6732921601553  E_coul = 198.70013821969016
Extra cycle  E= -507.973153940465  delta_E= -3.98e-13  |g|= 1.28e-09  |ddm|= 7.5e-10
    CPU time for scf_cycle      1.96 sec, wall time      0.19 sec
exp = [2.64437680e-01 1.17616814e+05 6.71854768e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104200e+04
 3.67547147e+04 7.30314070e+03 1.83757988e+04 1.44905138e+03
 3.76515239e+02 1.14536817e+02 3.82738017e+01 8.42603156e+00
 3.38182010e+00 8.60353330e+00 4.92564499e-01]
grad_E = [ 2.71952359e-05  4.35884360e-09 -1.69004591e-05  2.08496178e-11
  1.18505002e-10  6.78021527e-10  2.66095704e-09  1.10615006e-08
  5.92928376e-08  3.73979982e-06  1.29533099e-07 -5.21149850e-07
  8.67786272e-06 -1.91596916e-05  1.43509251e-06  1.09454184e-05
 -2.22164889e-05 -1.50825031e-07 -3.53838524e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:55:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.26453347631        1
[INPUT] 0    0    [1    /1   ]  117616.81386         1
[INPUT] 0    0    [1    /1   ]  0.672121916862       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031072        1
[INPUT] 0    0    [1    /1   ]  147020.991915        1
[INPUT] 0    0    [1    /1   ]  73510.4200033        1
[INPUT] 0    0    [1    /1   ]  36754.7148321        1
[INPUT] 0    0    [1    /1   ]  7303.14819601        1
[INPUT] 0    0    [1    /1   ]  18375.7990532        1
[INPUT] 0    0    [1    /1   ]  1449.0690807         1
[INPUT] 0    0    [1    /1   ]  376.436594782        1
[INPUT] 0    0    [1    /1   ]  114.56879457         1
[INPUT] 0    0    [1    /1   ]  38.2901580988        1
[INPUT] 0    0    [1    /1   ]  8.42623482817        1
[INPUT] 0    0    [1    /1   ]  3.38245042778        1
[INPUT] 1    0    [1    /1   ]  8.6035308752         1
[INPUT] 1    0    [1    /1   ]  0.492564716952       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2645334763099311, 1.0]], [0, [117616.81386009775, 1.0]], [0, [0.6721219168623903, 1.0]], [0, [1176168.1426172089, 1.0]], [0, [588084.0699822964, 1.0]], [0, [294042.0310724902, 1.0]], [0, [147020.99191491658, 1.0]], [0, [73510.4200032982, 1.0]], [0, [36754.71483207203, 1.0]], [0, [7303.148196012529, 1.0]], [0, [18375.799053212322, 1.0]], [0, [1449.069080701683, 1.0]], [0, [376.43659478203756, 1.0]], [0, [114.56879456953578, 1.0]], [0, [38.2901580988189, 1.0]], [0, [8.426234828173818, 1.0]], [0, [3.382450427782916, 1.0]], [1, [8.603530875200368, 1.0]], [1, [0.4925647169518669, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26453348]
bas 1, expnt(s) = [117616.8138601]
bas 2, expnt(s) = [0.67212192]
bas 3, expnt(s) = [1176168.14261721]
bas 4, expnt(s) = [588084.0699823]
bas 5, expnt(s) = [294042.03107249]
bas 6, expnt(s) = [147020.99191492]
bas 7, expnt(s) = [73510.4200033]
bas 8, expnt(s) = [36754.71483207]
bas 9, expnt(s) = [7303.14819601]
bas 10, expnt(s) = [18375.79905321]
bas 11, expnt(s) = [1449.0690807]
bas 12, expnt(s) = [376.43659478]
bas 13, expnt(s) = [114.56879457]
bas 14, expnt(s) = [38.2901581]
bas 15, expnt(s) = [8.42623483]
bas 16, expnt(s) = [3.38245043]
bas 17, expnt(s) = [8.60353088]
bas 18, expnt(s) = [0.49256472]
CPU time:       310.76
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.64533476e-01 9.31913286e-01 1.17616814e+05 1.60460109e+04
 6.72121917e-01 1.87543090e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104200e+04 1.12791586e+04
 3.67547148e+04 6.70656005e+03 7.30314820e+03 1.99594059e+03
 1.83757991e+04 3.98749085e+03 1.44906908e+03 5.93378548e+02
 3.76436595e+02 2.15915540e+02 1.14568795e+02 8.84738206e+01
 3.82901581e+01 3.88893240e+01 8.42623483e+00 1.24951131e+01
 3.38245043e+00 6.30142258e+00 8.60353088e+00 4.29863227e+01
 4.92564717e-01 1.20382544e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335742932078446
cond(S) = 907858.3474661671
E1 = -689.5600457960578  E_coul = 184.9589743907422
init E= -504.601071405316
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672516185878182  LUMO = 0.776445658004695
  mo_energy =
[-1.21705068e+02 -1.33852998e+01 -7.62439006e+00 -7.62439006e+00
 -7.62439006e+00 -1.65766811e+00 -6.72516186e-01 -6.72516186e-01
 -6.72516186e-01  7.76445658e-01  1.26579444e+01  1.14361765e+02
  6.13701084e+02  2.75868205e+03  1.22374384e+04  4.08574095e+04
  1.04900118e+05  2.30083023e+05  4.55897634e+05  8.44849673e+05
  1.52802675e+06  2.85029392e+06  5.80818092e+06]
E1 = -707.7283446642826  E_coul = 199.77286258872908
cycle= 1 E= -507.955482075554  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.62577
diis-c [-0.39158764  1.        ]
  HOMO = -0.217964803623094  LUMO = 1.18388858872423
  mo_energy =
[-1.20194388e+02 -1.23036605e+01 -6.59465199e+00 -6.59465199e+00
 -6.59465199e+00 -1.16324745e+00 -2.17964804e-01 -2.17964804e-01
 -2.17964804e-01  1.18388859e+00  1.36056172e+01  1.15764358e+02
  6.15197776e+02  2.76011799e+03  1.22387656e+04  4.08586703e+04
  1.04901343e+05  2.30084223e+05  4.55898817e+05  8.44850842e+05
  1.52802790e+06  2.85029506e+06  5.80818206e+06]
E1 = -706.792863453521  E_coul = 198.8199602650019
cycle= 2 E= -507.972903188519  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257748
diis-c [-6.61296411e-04  2.78369704e-03  9.97216303e-01]
  HOMO = -0.239669219036426  LUMO = 1.17723756509784
  mo_energy =
[-1.20306572e+02 -1.23695587e+01 -6.66763022e+00 -6.66763022e+00
 -6.66763022e+00 -1.17722226e+00 -2.39669219e-01 -2.39669219e-01
 -2.39669219e-01  1.17723757e+00  1.35544010e+01  1.15670427e+02
  6.15081532e+02  2.75998590e+03  1.22386234e+04  4.08585245e+04
  1.04901195e+05  2.30084075e+05  4.55898668e+05  8.44850693e+05
  1.52802775e+06  2.85029492e+06  5.80818191e+06]
E1 = -706.6887650187646  E_coul = 198.71561485671344
cycle= 3 E= -507.973150162051  delta_E= -0.000247  |g|= 0.00434  |ddm|= 0.0597
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00291809
diis-c [-1.54085069e-06 -1.77227777e-04 -1.14363292e-01  1.11454052e+00]
  HOMO = -0.242792014821408  LUMO = 1.17605435209279
  mo_energy =
[-1.20318657e+02 -1.23782316e+01 -6.67681837e+00 -6.67681837e+00
 -6.67681837e+00 -1.17911252e+00 -2.42792015e-01 -2.42792015e-01
 -2.42792015e-01  1.17605435e+00  1.35473886e+01  1.15659651e+02
  6.15069267e+02  2.75997276e+03  1.22386098e+04  4.08585106e+04
  1.04901181e+05  2.30084061e+05  4.55898654e+05  8.44850679e+05
  1.52802774e+06  2.85029490e+06  5.80818190e+06]
E1 = -706.6739126272237  E_coul = 198.70075796405465
cycle= 4 E= -507.973154663169  delta_E= -4.5e-06  |g|= 0.000156  |ddm|= 0.00911
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000107845
diis-c [-6.81458792e-11 -5.23522208e-06  7.33579731e-03 -9.10357984e-02
  1.08370524e+00]
  HOMO = -0.242895761403867  LUMO = 1.17600887484118
  mo_energy =
[-1.20318898e+02 -1.23784848e+01 -6.67706566e+00 -6.67706566e+00
 -6.67706566e+00 -1.17917340e+00 -2.42895761e-01 -2.42895761e-01
 -2.42895761e-01  1.17600887e+00  1.35471734e+01  1.15659407e+02
  6.15069027e+02  2.75997253e+03  1.22386095e+04  4.08585104e+04
  1.04901181e+05  2.30084061e+05  4.55898654e+05  8.44850679e+05
  1.52802774e+06  2.85029490e+06  5.80818190e+06]
E1 = -706.6734256444531  E_coul = 198.70027097596352
cycle= 5 E= -507.97315466849  delta_E= -5.32e-09  |g|= 2.59e-07  |ddm|= 0.000329
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58993e-07
diis-c [-1.15942344e-14  1.80979390e-07 -9.16232372e-05  1.02658792e-03
 -1.14496579e-02  1.01051451e+00]
  HOMO = -0.242895795658131  LUMO = 1.1760090301996
  mo_energy =
[-1.20318898e+02 -1.23784850e+01 -6.67706594e+00 -6.67706594e+00
 -6.67706594e+00 -1.17917355e+00 -2.42895796e-01 -2.42895796e-01
 -2.42895796e-01  1.17600903e+00  1.35471733e+01  1.15659406e+02
  6.15069026e+02  2.75997253e+03  1.22386095e+04  4.08585104e+04
  1.04901181e+05  2.30084061e+05  4.55898654e+05  8.44850679e+05
  1.52802774e+06  2.85029490e+06  5.80818190e+06]
E1 = -706.673425307906  E_coul = 198.7002706394166
cycle= 6 E= -507.973154668489  delta_E= 2.27e-13  |g|= 1.34e-08  |ddm|= 1.31e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.673425307906  E_coul = 198.7002706394166
  HOMO = -0.242895788281741  LUMO = 1.17600902921162
  mo_energy =
[-1.20318898e+02 -1.23784850e+01 -6.67706592e+00 -6.67706592e+00
 -6.67706592e+00 -1.17917354e+00 -2.42895788e-01 -2.42895788e-01
 -2.42895788e-01  1.17600903e+00  1.35471733e+01  1.15659406e+02
  6.15069026e+02  2.75997253e+03  1.22386095e+04  4.08585104e+04
  1.04901181e+05  2.30084061e+05  4.55898654e+05  8.44850679e+05
  1.52802774e+06  2.85029490e+06  5.80818190e+06]
E1 = -706.6734253450209  E_coul = 198.70027067653155
Extra cycle  E= -507.973154668489  delta_E= 5.68e-14  |g|= 2.95e-09  |ddm|= 2.49e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.12 sec
exp = [2.64533476e-01 1.17616814e+05 6.72121917e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104200e+04
 3.67547148e+04 7.30314820e+03 1.83757991e+04 1.44906908e+03
 3.76436595e+02 1.14568795e+02 3.82901581e+01 8.42623483e+00
 3.38245043e+00 8.60353088e+00 4.92564717e-01]
E = -507.9731546684893
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:55:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.26453347631        1
[INPUT] 0    0    [1    /1   ]  117616.81386         1
[INPUT] 0    0    [1    /1   ]  0.672121916862       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031072        1
[INPUT] 0    0    [1    /1   ]  147020.991915        1
[INPUT] 0    0    [1    /1   ]  73510.4200033        1
[INPUT] 0    0    [1    /1   ]  36754.7148321        1
[INPUT] 0    0    [1    /1   ]  7303.14819601        1
[INPUT] 0    0    [1    /1   ]  18375.7990532        1
[INPUT] 0    0    [1    /1   ]  1449.0690807         1
[INPUT] 0    0    [1    /1   ]  376.436594782        1
[INPUT] 0    0    [1    /1   ]  114.56879457         1
[INPUT] 0    0    [1    /1   ]  38.2901580988        1
[INPUT] 0    0    [1    /1   ]  8.42623482817        1
[INPUT] 0    0    [1    /1   ]  3.38245042778        1
[INPUT] 1    0    [1    /1   ]  8.6035308752         1
[INPUT] 1    0    [1    /1   ]  0.492564716952       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.2645334763099311, 1.0]], [0, [117616.81386009775, 1.0]], [0, [0.6721219168623903, 1.0]], [0, [1176168.1426172089, 1.0]], [0, [588084.0699822964, 1.0]], [0, [294042.0310724902, 1.0]], [0, [147020.99191491658, 1.0]], [0, [73510.4200032982, 1.0]], [0, [36754.71483207203, 1.0]], [0, [7303.148196012529, 1.0]], [0, [18375.799053212322, 1.0]], [0, [1449.069080701683, 1.0]], [0, [376.43659478203756, 1.0]], [0, [114.56879456953578, 1.0]], [0, [38.2901580988189, 1.0]], [0, [8.426234828173818, 1.0]], [0, [3.382450427782916, 1.0]], [1, [8.603530875200368, 1.0]], [1, [0.4925647169518669, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26453348]
bas 1, expnt(s) = [117616.8138601]
bas 2, expnt(s) = [0.67212192]
bas 3, expnt(s) = [1176168.14261721]
bas 4, expnt(s) = [588084.0699823]
bas 5, expnt(s) = [294042.03107249]
bas 6, expnt(s) = [147020.99191492]
bas 7, expnt(s) = [73510.4200033]
bas 8, expnt(s) = [36754.71483207]
bas 9, expnt(s) = [7303.14819601]
bas 10, expnt(s) = [18375.79905321]
bas 11, expnt(s) = [1449.0690807]
bas 12, expnt(s) = [376.43659478]
bas 13, expnt(s) = [114.56879457]
bas 14, expnt(s) = [38.2901581]
bas 15, expnt(s) = [8.42623483]
bas 16, expnt(s) = [3.38245043]
bas 17, expnt(s) = [8.60353088]
bas 18, expnt(s) = [0.49256472]
CPU time:       311.43
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.64533476e-01 9.31913286e-01 1.17616814e+05 1.60460109e+04
 6.72121917e-01 1.87543090e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104200e+04 1.12791586e+04
 3.67547148e+04 6.70656005e+03 7.30314820e+03 1.99594059e+03
 1.83757991e+04 3.98749085e+03 1.44906908e+03 5.93378548e+02
 3.76436595e+02 2.15915540e+02 1.14568795e+02 8.84738206e+01
 3.82901581e+01 3.88893240e+01 8.42623483e+00 1.24951131e+01
 3.38245043e+00 6.30142258e+00 8.60353088e+00 4.29863227e+01
 4.92564717e-01 1.20382544e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335742932078446
cond(S) = 907858.3474661671
E1 = -689.5600457960578  E_coul = 184.9589743907422
init E= -504.601071405316
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.672516185878182  LUMO = 0.776445658004695
  mo_energy =
[-1.21705068e+02 -1.33852998e+01 -7.62439006e+00 -7.62439006e+00
 -7.62439006e+00 -1.65766811e+00 -6.72516186e-01 -6.72516186e-01
 -6.72516186e-01  7.76445658e-01  1.26579444e+01  1.14361765e+02
  6.13701084e+02  2.75868205e+03  1.22374384e+04  4.08574095e+04
  1.04900118e+05  2.30083023e+05  4.55897634e+05  8.44849673e+05
  1.52802675e+06  2.85029392e+06  5.80818092e+06]
E1 = -707.7283446642826  E_coul = 199.77286258872908
cycle= 1 E= -507.955482075554  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.62577
diis-c [-0.39158764  1.        ]
  HOMO = -0.217964803623094  LUMO = 1.18388858872423
  mo_energy =
[-1.20194388e+02 -1.23036605e+01 -6.59465199e+00 -6.59465199e+00
 -6.59465199e+00 -1.16324745e+00 -2.17964804e-01 -2.17964804e-01
 -2.17964804e-01  1.18388859e+00  1.36056172e+01  1.15764358e+02
  6.15197776e+02  2.76011799e+03  1.22387656e+04  4.08586703e+04
  1.04901343e+05  2.30084223e+05  4.55898817e+05  8.44850842e+05
  1.52802790e+06  2.85029506e+06  5.80818206e+06]
E1 = -706.792863453521  E_coul = 198.8199602650019
cycle= 2 E= -507.972903188519  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257748
diis-c [-6.61296411e-04  2.78369704e-03  9.97216303e-01]
  HOMO = -0.239669219036426  LUMO = 1.17723756509784
  mo_energy =
[-1.20306572e+02 -1.23695587e+01 -6.66763022e+00 -6.66763022e+00
 -6.66763022e+00 -1.17722226e+00 -2.39669219e-01 -2.39669219e-01
 -2.39669219e-01  1.17723757e+00  1.35544010e+01  1.15670427e+02
  6.15081532e+02  2.75998590e+03  1.22386234e+04  4.08585245e+04
  1.04901195e+05  2.30084075e+05  4.55898668e+05  8.44850693e+05
  1.52802775e+06  2.85029492e+06  5.80818191e+06]
E1 = -706.6887650187646  E_coul = 198.71561485671344
cycle= 3 E= -507.973150162051  delta_E= -0.000247  |g|= 0.00434  |ddm|= 0.0597
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00291809
diis-c [-1.54085069e-06 -1.77227777e-04 -1.14363292e-01  1.11454052e+00]
  HOMO = -0.242792014821408  LUMO = 1.17605435209279
  mo_energy =
[-1.20318657e+02 -1.23782316e+01 -6.67681837e+00 -6.67681837e+00
 -6.67681837e+00 -1.17911252e+00 -2.42792015e-01 -2.42792015e-01
 -2.42792015e-01  1.17605435e+00  1.35473886e+01  1.15659651e+02
  6.15069267e+02  2.75997276e+03  1.22386098e+04  4.08585106e+04
  1.04901181e+05  2.30084061e+05  4.55898654e+05  8.44850679e+05
  1.52802774e+06  2.85029490e+06  5.80818190e+06]
E1 = -706.6739126272237  E_coul = 198.70075796405465
cycle= 4 E= -507.973154663169  delta_E= -4.5e-06  |g|= 0.000156  |ddm|= 0.00911
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000107845
diis-c [-6.81458792e-11 -5.23522208e-06  7.33579731e-03 -9.10357984e-02
  1.08370524e+00]
  HOMO = -0.242895761403867  LUMO = 1.17600887484118
  mo_energy =
[-1.20318898e+02 -1.23784848e+01 -6.67706566e+00 -6.67706566e+00
 -6.67706566e+00 -1.17917340e+00 -2.42895761e-01 -2.42895761e-01
 -2.42895761e-01  1.17600887e+00  1.35471734e+01  1.15659407e+02
  6.15069027e+02  2.75997253e+03  1.22386095e+04  4.08585104e+04
  1.04901181e+05  2.30084061e+05  4.55898654e+05  8.44850679e+05
  1.52802774e+06  2.85029490e+06  5.80818190e+06]
E1 = -706.6734256444531  E_coul = 198.70027097596352
cycle= 5 E= -507.97315466849  delta_E= -5.32e-09  |g|= 2.59e-07  |ddm|= 0.000329
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58993e-07
diis-c [-1.15942344e-14  1.80979390e-07 -9.16232372e-05  1.02658792e-03
 -1.14496579e-02  1.01051451e+00]
  HOMO = -0.242895795658131  LUMO = 1.1760090301996
  mo_energy =
[-1.20318898e+02 -1.23784850e+01 -6.67706594e+00 -6.67706594e+00
 -6.67706594e+00 -1.17917355e+00 -2.42895796e-01 -2.42895796e-01
 -2.42895796e-01  1.17600903e+00  1.35471733e+01  1.15659406e+02
  6.15069026e+02  2.75997253e+03  1.22386095e+04  4.08585104e+04
  1.04901181e+05  2.30084061e+05  4.55898654e+05  8.44850679e+05
  1.52802774e+06  2.85029490e+06  5.80818190e+06]
E1 = -706.673425307906  E_coul = 198.7002706394166
cycle= 6 E= -507.973154668489  delta_E= 2.27e-13  |g|= 1.34e-08  |ddm|= 1.31e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.673425307906  E_coul = 198.7002706394166
  HOMO = -0.242895788281741  LUMO = 1.17600902921162
  mo_energy =
[-1.20318898e+02 -1.23784850e+01 -6.67706592e+00 -6.67706592e+00
 -6.67706592e+00 -1.17917354e+00 -2.42895788e-01 -2.42895788e-01
 -2.42895788e-01  1.17600903e+00  1.35471733e+01  1.15659406e+02
  6.15069026e+02  2.75997253e+03  1.22386095e+04  4.08585104e+04
  1.04901181e+05  2.30084061e+05  4.55898654e+05  8.44850679e+05
  1.52802774e+06  2.85029490e+06  5.80818190e+06]
E1 = -706.6734253450209  E_coul = 198.70027067653155
Extra cycle  E= -507.973154668489  delta_E= 5.68e-14  |g|= 2.95e-09  |ddm|= 2.49e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907858.3474661671
E1 = -706.6734253450209  E_coul = 198.70027067653155
init E= -507.973154668489
    CPU time for initialize scf      1.46 sec, wall time      0.09 sec
  HOMO = -0.242895787225364  LUMO = 1.1760090328652
  mo_energy =
[-1.20318898e+02 -1.23784850e+01 -6.67706592e+00 -6.67706592e+00
 -6.67706592e+00 -1.17917354e+00 -2.42895787e-01 -2.42895787e-01
 -2.42895787e-01  1.17600903e+00  1.35471733e+01  1.15659406e+02
  6.15069026e+02  2.75997253e+03  1.22386095e+04  4.08585104e+04
  1.04901181e+05  2.30084061e+05  4.55898654e+05  8.44850679e+05
  1.52802774e+06  2.85029490e+06  5.80818190e+06]
E1 = -706.6734253484236  E_coul = 198.70027067993414
cycle= 1 E= -507.973154668489  delta_E= -1.71e-13  |g|= 1.34e-09  |ddm|= 2.17e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6734253484236  E_coul = 198.70027067993414
  HOMO = -0.242895787141959  LUMO = 1.17600903332528
  mo_energy =
[-1.20318898e+02 -1.23784850e+01 -6.67706592e+00 -6.67706592e+00
 -6.67706592e+00 -1.17917354e+00 -2.42895787e-01 -2.42895787e-01
 -2.42895787e-01  1.17600903e+00  1.35471733e+01  1.15659406e+02
  6.15069026e+02  2.75997253e+03  1.22386095e+04  4.08585104e+04
  1.04901181e+05  2.30084061e+05  4.55898654e+05  8.44850679e+05
  1.52802774e+06  2.85029490e+06  5.80818190e+06]
E1 = -706.6734253495691  E_coul = 198.70027068107976
Extra cycle  E= -507.973154668489  delta_E= 1.14e-13  |g|= 1.98e-09  |ddm|= 6.93e-10
    CPU time for scf_cycle      1.63 sec, wall time      0.16 sec
exp = [2.64533476e-01 1.17616814e+05 6.72121917e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104200e+04
 3.67547148e+04 7.30314820e+03 1.83757991e+04 1.44906908e+03
 3.76436595e+02 1.14568795e+02 3.82901581e+01 8.42623483e+00
 3.38245043e+00 8.60353088e+00 4.92564717e-01]
grad_E = [ 3.83822568e-06  4.34204254e-09 -2.47421179e-06  2.06513175e-11
  1.17958806e-10  6.75423656e-10  2.65057080e-09  1.10177034e-08
  5.90775947e-08  3.72491506e-06  1.28872400e-07  1.97475910e-07
  2.06156952e-06 -1.96984973e-06  3.14787722e-07  9.42660908e-07
 -2.05668468e-06  6.10969479e-08 -4.12561667e-06]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:55:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.264535373938       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.672136183893       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200236        1
[INPUT] 0    0    [1    /1   ]  36754.7149415        1
[INPUT] 0    0    [1    /1   ]  7303.15506922        1
[INPUT] 0    0    [1    /1   ]  18375.7992872        1
[INPUT] 0    0    [1    /1   ]  1449.0839289         1
[INPUT] 0    0    [1    /1   ]  376.379721694        1
[INPUT] 0    0    [1    /1   ]  114.557167338        1
[INPUT] 0    0    [1    /1   ]  38.2887338495        1
[INPUT] 0    0    [1    /1   ]  8.42599766215        1
[INPUT] 0    0    [1    /1   ]  3.38239117922        1
[INPUT] 1    0    [1    /1   ]  8.60353103241        1
[INPUT] 1    0    [1    /1   ]  0.49256484046        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26453537393791565, 1.0]], [0, [117616.81386811525, 1.0]], [0, [0.6721361838929967, 1.0]], [0, [1176168.142617244, 1.0]], [0, [588084.069982512, 1.0]], [0, [294042.0310737377, 1.0]], [0, [147020.99191980762, 1.0]], [0, [73510.42002361391, 1.0]], [0, [36754.71494148734, 1.0]], [0, [7303.155069221313, 1.0]], [0, [18375.79928724561, 1.0]], [0, [1449.083928904265, 1.0]], [0, [376.3797216937185, 1.0]], [0, [114.5571673377634, 1.0]], [0, [38.288733849518216, 1.0]], [0, [8.425997662149568, 1.0]], [0, [3.3823911792214205, 1.0]], [1, [8.603531032405357, 1.0]], [1, [0.4925648404604559, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26453537]
bas 1, expnt(s) = [117616.81386812]
bas 2, expnt(s) = [0.67213618]
bas 3, expnt(s) = [1176168.14261724]
bas 4, expnt(s) = [588084.06998251]
bas 5, expnt(s) = [294042.03107374]
bas 6, expnt(s) = [147020.99191981]
bas 7, expnt(s) = [73510.42002361]
bas 8, expnt(s) = [36754.71494149]
bas 9, expnt(s) = [7303.15506922]
bas 10, expnt(s) = [18375.79928725]
bas 11, expnt(s) = [1449.0839289]
bas 12, expnt(s) = [376.37972169]
bas 13, expnt(s) = [114.55716734]
bas 14, expnt(s) = [38.28873385]
bas 15, expnt(s) = [8.42599766]
bas 16, expnt(s) = [3.38239118]
bas 17, expnt(s) = [8.60353103]
bas 18, expnt(s) = [0.49256484]
CPU time:       316.32
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.64535374e-01 9.31918300e-01 1.17616814e+05 1.60460109e+04
 6.72136184e-01 1.87546076e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104200e+04 1.12791586e+04
 3.67547149e+04 6.70656006e+03 7.30315507e+03 1.99594199e+03
 1.83757993e+04 3.98749088e+03 1.44908393e+03 5.93383108e+02
 3.76379722e+02 2.15891074e+02 1.14557167e+02 8.84670863e+01
 3.82887338e+01 3.88882391e+01 8.42599766e+00 1.24948494e+01
 3.38239118e+00 6.30133979e+00 8.60353103e+00 4.29863237e+01
 4.92564840e-01 1.20382582e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335742804237956
cond(S) = 907856.7757595535
E1 = -689.560118720972  E_coul = 184.95898085362853
init E= -504.601137867343
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672515952740312  LUMO = 0.77646594147781
  mo_energy =
[-1.21705067e+02 -1.33852996e+01 -7.62438962e+00 -7.62438962e+00
 -7.62438962e+00 -1.65766793e+00 -6.72515953e-01 -6.72515953e-01
 -6.72515953e-01  7.76465941e-01  1.26575521e+01  1.14352998e+02
  6.13623897e+02  2.75848940e+03  1.22372389e+04  4.08572349e+04
  1.04899960e+05  2.30082874e+05  4.55897489e+05  8.44849532e+05
  1.52802661e+06  2.85029378e+06  5.80818079e+06]
E1 = -707.7283543312611  E_coul = 199.77287231568152
cycle= 1 E= -507.95548201558  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625775
diis-c [-0.39159416  1.        ]
  HOMO = -0.217964576769979  LUMO = 1.18391179964228
  mo_energy =
[-1.20194387e+02 -1.23036600e+01 -6.59465127e+00 -6.59465127e+00
 -6.59465127e+00 -1.16324728e+00 -2.17964577e-01 -2.17964577e-01
 -2.17964577e-01  1.18391180e+00  1.36052120e+01  1.15755580e+02
  6.15120591e+02  2.75992535e+03  1.22385661e+04  4.08584957e+04
  1.04901184e+05  2.30084074e+05  4.55898672e+05  8.44850701e+05
  1.52802776e+06  2.85029493e+06  5.80818193e+06]
E1 = -706.792869291612  E_coul = 198.8199660649407
cycle= 2 E= -507.972903226671  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257749
diis-c [-6.61297965e-04  2.78378083e-03  9.97216219e-01]
  HOMO = -0.23966903672311  LUMO = 1.17726064633223
  mo_energy =
[-1.20306571e+02 -1.23695586e+01 -6.66762985e+00 -6.66762985e+00
 -6.66762985e+00 -1.17722211e+00 -2.39669037e-01 -2.39669037e-01
 -2.39669037e-01  1.17726065e+00  1.35539965e+01  1.15661649e+02
  6.15004348e+02  2.75979326e+03  1.22384239e+04  4.08583498e+04
  1.04901037e+05  2.30083925e+05  4.55898523e+05  8.44850552e+05
  1.52802762e+06  2.85029478e+06  5.80818178e+06]
E1 = -706.6887712039288  E_coul = 198.71562100600613
cycle= 3 E= -507.973150197923  delta_E= -0.000247  |g|= 0.00434  |ddm|= 0.0597
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00291809
diis-c [-1.54084318e-06 -1.77218342e-04 -1.14363220e-01  1.11454044e+00]
  HOMO = -0.24279181470217  LUMO = 1.17607742378071
  mo_energy =
[-1.20318656e+02 -1.23782314e+01 -6.67681798e+00 -6.67681798e+00
 -6.67681798e+00 -1.17911236e+00 -2.42791815e-01 -2.42791815e-01
 -2.42791815e-01  1.17607742e+00  1.35469842e+01  1.15650874e+02
  6.14992083e+02  2.75978012e+03  1.22384103e+04  4.08583360e+04
  1.04901023e+05  2.30083911e+05  4.55898509e+05  8.44850538e+05
  1.52802760e+06  2.85029477e+06  5.80818176e+06]
E1 = -706.6739189743894  E_coul = 198.70076427545214
cycle= 4 E= -507.973154698937  delta_E= -4.5e-06  |g|= 0.000156  |ddm|= 0.00911
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000107844
diis-c [-6.81404303e-11 -5.23674774e-06  7.33580447e-03 -9.10352256e-02
  1.08370466e+00]
  HOMO = -0.24289555772544  LUMO = 1.17603194854975
  mo_energy =
[-1.20318897e+02 -1.23784847e+01 -6.67706526e+00 -6.67706526e+00
 -6.67706526e+00 -1.17917323e+00 -2.42895558e-01 -2.42895558e-01
 -2.42895558e-01  1.17603195e+00  1.35467690e+01  1.15650630e+02
  6.14991843e+02  2.75977988e+03  1.22384101e+04  4.08583357e+04
  1.04901022e+05  2.30083911e+05  4.55898509e+05  8.44850538e+05
  1.52802760e+06  2.85029477e+06  5.80818176e+06]
E1 = -706.6734320117541  E_coul = 198.70027730749683
cycle= 5 E= -507.973154704257  delta_E= -5.32e-09  |g|= 2.58e-07  |ddm|= 0.000329
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58688e-07
diis-c [-1.16601188e-14  1.79143922e-07 -9.12771761e-05  1.02220329e-03
 -1.13937208e-02  1.01046262e+00]
  HOMO = -0.242895591964451  LUMO = 1.17603210457435
  mo_energy =
[-1.20318897e+02 -1.23784849e+01 -6.67706554e+00 -6.67706554e+00
 -6.67706554e+00 -1.17917338e+00 -2.42895592e-01 -2.42895592e-01
 -2.42895592e-01  1.17603210e+00  1.35467689e+01  1.15650629e+02
  6.14991842e+02  2.75977988e+03  1.22384100e+04  4.08583357e+04
  1.04901022e+05  2.30083911e+05  4.55898509e+05  8.44850538e+05
  1.52802760e+06  2.85029477e+06  5.80818176e+06]
E1 = -706.6734316725871  E_coul = 198.7002769683301
cycle= 6 E= -507.973154704257  delta_E= 2.84e-13  |g|= 1.39e-08  |ddm|= 1.32e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6734316725871  E_coul = 198.7002769683301
  HOMO = -0.242895584646972  LUMO = 1.17603210407574
  mo_energy =
[-1.20318897e+02 -1.23784849e+01 -6.67706552e+00 -6.67706552e+00
 -6.67706552e+00 -1.17917337e+00 -2.42895585e-01 -2.42895585e-01
 -2.42895585e-01  1.17603210e+00  1.35467689e+01  1.15650629e+02
  6.14991843e+02  2.75977988e+03  1.22384100e+04  4.08583357e+04
  1.04901022e+05  2.30083911e+05  4.55898509e+05  8.44850538e+05
  1.52802760e+06  2.85029477e+06  5.80818176e+06]
E1 = -706.6734317121378  E_coul = 198.70027700788083
Extra cycle  E= -507.973154704257  delta_E=    0  |g|= 2.12e-09  |ddm|= 2.62e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
exp = [2.64535374e-01 1.17616814e+05 6.72136184e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104200e+04
 3.67547149e+04 7.30315507e+03 1.83757993e+04 1.44908393e+03
 3.76379722e+02 1.14557167e+02 3.82887338e+01 8.42599766e+00
 3.38239118e+00 8.60353103e+00 4.92564840e-01]
E = -507.973154704257
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:55:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.264535373938       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.672136183893       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200236        1
[INPUT] 0    0    [1    /1   ]  36754.7149415        1
[INPUT] 0    0    [1    /1   ]  7303.15506922        1
[INPUT] 0    0    [1    /1   ]  18375.7992872        1
[INPUT] 0    0    [1    /1   ]  1449.0839289         1
[INPUT] 0    0    [1    /1   ]  376.379721694        1
[INPUT] 0    0    [1    /1   ]  114.557167338        1
[INPUT] 0    0    [1    /1   ]  38.2887338495        1
[INPUT] 0    0    [1    /1   ]  8.42599766215        1
[INPUT] 0    0    [1    /1   ]  3.38239117922        1
[INPUT] 1    0    [1    /1   ]  8.60353103241        1
[INPUT] 1    0    [1    /1   ]  0.49256484046        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26453537393791565, 1.0]], [0, [117616.81386811525, 1.0]], [0, [0.6721361838929967, 1.0]], [0, [1176168.142617244, 1.0]], [0, [588084.069982512, 1.0]], [0, [294042.0310737377, 1.0]], [0, [147020.99191980762, 1.0]], [0, [73510.42002361391, 1.0]], [0, [36754.71494148734, 1.0]], [0, [7303.155069221313, 1.0]], [0, [18375.79928724561, 1.0]], [0, [1449.083928904265, 1.0]], [0, [376.3797216937185, 1.0]], [0, [114.5571673377634, 1.0]], [0, [38.288733849518216, 1.0]], [0, [8.425997662149568, 1.0]], [0, [3.3823911792214205, 1.0]], [1, [8.603531032405357, 1.0]], [1, [0.4925648404604559, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26453537]
bas 1, expnt(s) = [117616.81386812]
bas 2, expnt(s) = [0.67213618]
bas 3, expnt(s) = [1176168.14261724]
bas 4, expnt(s) = [588084.06998251]
bas 5, expnt(s) = [294042.03107374]
bas 6, expnt(s) = [147020.99191981]
bas 7, expnt(s) = [73510.42002361]
bas 8, expnt(s) = [36754.71494149]
bas 9, expnt(s) = [7303.15506922]
bas 10, expnt(s) = [18375.79928725]
bas 11, expnt(s) = [1449.0839289]
bas 12, expnt(s) = [376.37972169]
bas 13, expnt(s) = [114.55716734]
bas 14, expnt(s) = [38.28873385]
bas 15, expnt(s) = [8.42599766]
bas 16, expnt(s) = [3.38239118]
bas 17, expnt(s) = [8.60353103]
bas 18, expnt(s) = [0.49256484]
CPU time:       316.95
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.64535374e-01 9.31918300e-01 1.17616814e+05 1.60460109e+04
 6.72136184e-01 1.87546076e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104200e+04 1.12791586e+04
 3.67547149e+04 6.70656006e+03 7.30315507e+03 1.99594199e+03
 1.83757993e+04 3.98749088e+03 1.44908393e+03 5.93383108e+02
 3.76379722e+02 2.15891074e+02 1.14557167e+02 8.84670863e+01
 3.82887338e+01 3.88882391e+01 8.42599766e+00 1.24948494e+01
 3.38239118e+00 6.30133979e+00 8.60353103e+00 4.29863237e+01
 4.92564840e-01 1.20382582e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335742804237956
cond(S) = 907856.7757595535
E1 = -689.560118720972  E_coul = 184.95898085362853
init E= -504.601137867343
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672515952740312  LUMO = 0.77646594147781
  mo_energy =
[-1.21705067e+02 -1.33852996e+01 -7.62438962e+00 -7.62438962e+00
 -7.62438962e+00 -1.65766793e+00 -6.72515953e-01 -6.72515953e-01
 -6.72515953e-01  7.76465941e-01  1.26575521e+01  1.14352998e+02
  6.13623897e+02  2.75848940e+03  1.22372389e+04  4.08572349e+04
  1.04899960e+05  2.30082874e+05  4.55897489e+05  8.44849532e+05
  1.52802661e+06  2.85029378e+06  5.80818079e+06]
E1 = -707.7283543312611  E_coul = 199.77287231568152
cycle= 1 E= -507.95548201558  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.625775
diis-c [-0.39159416  1.        ]
  HOMO = -0.217964576769979  LUMO = 1.18391179964228
  mo_energy =
[-1.20194387e+02 -1.23036600e+01 -6.59465127e+00 -6.59465127e+00
 -6.59465127e+00 -1.16324728e+00 -2.17964577e-01 -2.17964577e-01
 -2.17964577e-01  1.18391180e+00  1.36052120e+01  1.15755580e+02
  6.15120591e+02  2.75992535e+03  1.22385661e+04  4.08584957e+04
  1.04901184e+05  2.30084074e+05  4.55898672e+05  8.44850701e+05
  1.52802776e+06  2.85029493e+06  5.80818193e+06]
E1 = -706.792869291612  E_coul = 198.8199660649407
cycle= 2 E= -507.972903226671  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257749
diis-c [-6.61297965e-04  2.78378083e-03  9.97216219e-01]
  HOMO = -0.23966903672311  LUMO = 1.17726064633223
  mo_energy =
[-1.20306571e+02 -1.23695586e+01 -6.66762985e+00 -6.66762985e+00
 -6.66762985e+00 -1.17722211e+00 -2.39669037e-01 -2.39669037e-01
 -2.39669037e-01  1.17726065e+00  1.35539965e+01  1.15661649e+02
  6.15004348e+02  2.75979326e+03  1.22384239e+04  4.08583498e+04
  1.04901037e+05  2.30083925e+05  4.55898523e+05  8.44850552e+05
  1.52802762e+06  2.85029478e+06  5.80818178e+06]
E1 = -706.6887712039288  E_coul = 198.71562100600613
cycle= 3 E= -507.973150197923  delta_E= -0.000247  |g|= 0.00434  |ddm|= 0.0597
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00291809
diis-c [-1.54084318e-06 -1.77218342e-04 -1.14363220e-01  1.11454044e+00]
  HOMO = -0.24279181470217  LUMO = 1.17607742378071
  mo_energy =
[-1.20318656e+02 -1.23782314e+01 -6.67681798e+00 -6.67681798e+00
 -6.67681798e+00 -1.17911236e+00 -2.42791815e-01 -2.42791815e-01
 -2.42791815e-01  1.17607742e+00  1.35469842e+01  1.15650874e+02
  6.14992083e+02  2.75978012e+03  1.22384103e+04  4.08583360e+04
  1.04901023e+05  2.30083911e+05  4.55898509e+05  8.44850538e+05
  1.52802760e+06  2.85029477e+06  5.80818176e+06]
E1 = -706.6739189743894  E_coul = 198.70076427545214
cycle= 4 E= -507.973154698937  delta_E= -4.5e-06  |g|= 0.000156  |ddm|= 0.00911
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000107844
diis-c [-6.81404303e-11 -5.23674774e-06  7.33580447e-03 -9.10352256e-02
  1.08370466e+00]
  HOMO = -0.24289555772544  LUMO = 1.17603194854975
  mo_energy =
[-1.20318897e+02 -1.23784847e+01 -6.67706526e+00 -6.67706526e+00
 -6.67706526e+00 -1.17917323e+00 -2.42895558e-01 -2.42895558e-01
 -2.42895558e-01  1.17603195e+00  1.35467690e+01  1.15650630e+02
  6.14991843e+02  2.75977988e+03  1.22384101e+04  4.08583357e+04
  1.04901022e+05  2.30083911e+05  4.55898509e+05  8.44850538e+05
  1.52802760e+06  2.85029477e+06  5.80818176e+06]
E1 = -706.6734320117541  E_coul = 198.70027730749683
cycle= 5 E= -507.973154704257  delta_E= -5.32e-09  |g|= 2.58e-07  |ddm|= 0.000329
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58688e-07
diis-c [-1.16601188e-14  1.79143922e-07 -9.12771761e-05  1.02220329e-03
 -1.13937208e-02  1.01046262e+00]
  HOMO = -0.242895591964451  LUMO = 1.17603210457435
  mo_energy =
[-1.20318897e+02 -1.23784849e+01 -6.67706554e+00 -6.67706554e+00
 -6.67706554e+00 -1.17917338e+00 -2.42895592e-01 -2.42895592e-01
 -2.42895592e-01  1.17603210e+00  1.35467689e+01  1.15650629e+02
  6.14991842e+02  2.75977988e+03  1.22384100e+04  4.08583357e+04
  1.04901022e+05  2.30083911e+05  4.55898509e+05  8.44850538e+05
  1.52802760e+06  2.85029477e+06  5.80818176e+06]
E1 = -706.6734316725871  E_coul = 198.7002769683301
cycle= 6 E= -507.973154704257  delta_E= 2.84e-13  |g|= 1.39e-08  |ddm|= 1.32e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6734316725871  E_coul = 198.7002769683301
  HOMO = -0.242895584646972  LUMO = 1.17603210407574
  mo_energy =
[-1.20318897e+02 -1.23784849e+01 -6.67706552e+00 -6.67706552e+00
 -6.67706552e+00 -1.17917337e+00 -2.42895585e-01 -2.42895585e-01
 -2.42895585e-01  1.17603210e+00  1.35467689e+01  1.15650629e+02
  6.14991843e+02  2.75977988e+03  1.22384100e+04  4.08583357e+04
  1.04901022e+05  2.30083911e+05  4.55898509e+05  8.44850538e+05
  1.52802760e+06  2.85029477e+06  5.80818176e+06]
E1 = -706.6734317121378  E_coul = 198.70027700788083
Extra cycle  E= -507.973154704257  delta_E=    0  |g|= 2.12e-09  |ddm|= 2.62e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907856.7757595535
E1 = -706.6734317121378  E_coul = 198.70027700788083
init E= -507.973154704257
    CPU time for initialize scf      1.44 sec, wall time      0.09 sec
  HOMO = -0.242895583539544  LUMO = 1.17603210551775
  mo_energy =
[-1.20318897e+02 -1.23784849e+01 -6.67706552e+00 -6.67706552e+00
 -6.67706552e+00 -1.17917337e+00 -2.42895584e-01 -2.42895584e-01
 -2.42895584e-01  1.17603211e+00  1.35467689e+01  1.15650629e+02
  6.14991843e+02  2.75977988e+03  1.22384100e+04  4.08583357e+04
  1.04901022e+05  2.30083911e+05  4.55898509e+05  8.44850538e+05
  1.52802760e+06  2.85029477e+06  5.80818176e+06]
E1 = -706.6734317160204  E_coul = 198.70027701176366
cycle= 1 E= -507.973154704257  delta_E= 2.27e-13  |g|= 1.57e-09  |ddm|= 2.53e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6734317160204  E_coul = 198.70027701176366
  HOMO = -0.242895583430084  LUMO = 1.17603210556717
  mo_energy =
[-1.20318897e+02 -1.23784849e+01 -6.67706552e+00 -6.67706552e+00
 -6.67706552e+00 -1.17917337e+00 -2.42895583e-01 -2.42895583e-01
 -2.42895583e-01  1.17603211e+00  1.35467689e+01  1.15650629e+02
  6.14991843e+02  2.75977988e+03  1.22384100e+04  4.08583357e+04
  1.04901022e+05  2.30083911e+05  4.55898509e+05  8.44850538e+05
  1.52802760e+06  2.85029477e+06  5.80818176e+06]
E1 = -706.6734317169005  E_coul = 198.70027701264357
Extra cycle  E= -507.973154704257  delta_E= -1.14e-13  |g|= 1.16e-09  |ddm|= 5.32e-10
    CPU time for scf_cycle      1.61 sec, wall time      0.16 sec
exp = [2.64535374e-01 1.17616814e+05 6.72136184e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104200e+04
 3.67547149e+04 7.30315507e+03 1.83757993e+04 1.44908393e+03
 3.76379722e+02 1.14557167e+02 3.82887338e+01 8.42599766e+00
 3.38239118e+00 8.60353103e+00 4.92564840e-01]
grad_E = [-2.20263530e-07  4.33573692e-09  8.28921571e-08  2.05768721e-11
  1.17753828e-10  6.74448541e-10  2.64667271e-09  1.10012672e-08
  5.89968568e-08  3.71941772e-06  1.28624609e-07  4.32567673e-07
  5.83216894e-07  3.55042736e-07 -6.84904098e-08 -1.17915008e-07
  3.93996494e-07  5.29922772e-11  3.31874446e-07]
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -507.973154704257
       x: [ 2.645e-01  1.176e+05 ...  8.604e+00  4.926e-01]
     nit: 58
     jac: [-2.203e-07  4.336e-09 ...  5.299e-11  3.319e-07]
    nfev: 61
    njev: 58
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((19, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681424230179e+05,3.9663197410767775e-01,1.1761681426188892e+06,5.8808406999257731e+05,2.9404203113195952e+05,1.4702099214808299e+05,7.3510420971812651e+04,3.6754720047599032e+04,7.3034758786067814e+03,1.8375810215251393e+04,1.4497493176266319e+03,3.7402470747543651e+02,1.1325921993227522e+02,3.7742420726359853e+01,8.0882397218522861e+00,3.2040571457499500e+00,8.6038775469600708e+00,4.9300595703824823e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "17s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11310.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:55:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35633237.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.264535373938       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.672136183893       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200236        1
[INPUT] 0    0    [1    /1   ]  36754.7149415        1
[INPUT] 0    0    [1    /1   ]  7303.15506922        1
[INPUT] 0    0    [1    /1   ]  18375.7992872        1
[INPUT] 0    0    [1    /1   ]  1449.0839289         1
[INPUT] 0    0    [1    /1   ]  376.379721694        1
[INPUT] 0    0    [1    /1   ]  114.557167338        1
[INPUT] 0    0    [1    /1   ]  38.2887338495        1
[INPUT] 0    0    [1    /1   ]  8.42599766215        1
[INPUT] 0    0    [1    /1   ]  3.38239117922        1
[INPUT] 1    0    [1    /1   ]  8.60353103241        1
[INPUT] 1    0    [1    /1   ]  0.49256484046        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 23
number of NR cGTOs = 23
basis = {'Ar': [[0, [0.26453537393791565, 1.0]], [0, [117616.81386811525, 1.0]], [0, [0.6721361838929967, 1.0]], [0, [1176168.142617244, 1.0]], [0, [588084.069982512, 1.0]], [0, [294042.0310737377, 1.0]], [0, [147020.99191980762, 1.0]], [0, [73510.42002361391, 1.0]], [0, [36754.71494148734, 1.0]], [0, [7303.155069221313, 1.0]], [0, [18375.79928724561, 1.0]], [0, [1449.083928904265, 1.0]], [0, [376.3797216937185, 1.0]], [0, [114.5571673377634, 1.0]], [0, [38.288733849518216, 1.0]], [0, [8.425997662149568, 1.0]], [0, [3.3823911792214205, 1.0]], [1, [8.603531032405357, 1.0]], [1, [0.4925648404604559, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26453537]
bas 1, expnt(s) = [117616.81386812]
bas 2, expnt(s) = [0.67213618]
bas 3, expnt(s) = [1176168.14261724]
bas 4, expnt(s) = [588084.06998251]
bas 5, expnt(s) = [294042.03107374]
bas 6, expnt(s) = [147020.99191981]
bas 7, expnt(s) = [73510.42002361]
bas 8, expnt(s) = [36754.71494149]
bas 9, expnt(s) = [7303.15506922]
bas 10, expnt(s) = [18375.79928725]
bas 11, expnt(s) = [1449.0839289]
bas 12, expnt(s) = [376.37972169]
bas 13, expnt(s) = [114.55716734]
bas 14, expnt(s) = [38.28873385]
bas 15, expnt(s) = [8.42599766]
bas 16, expnt(s) = [3.38239118]
bas 17, expnt(s) = [8.60353103]
bas 18, expnt(s) = [0.49256484]
CPU time:       321.78
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.64535374e-01 9.31918300e-01 1.17616814e+05 1.60460109e+04
 6.72136184e-01 1.87546076e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104200e+04 1.12791586e+04
 3.67547149e+04 6.70656006e+03 7.30315507e+03 1.99594199e+03
 1.83757993e+04 3.98749088e+03 1.44908393e+03 5.93383108e+02
 3.76379722e+02 2.15891074e+02 1.14557167e+02 8.84670863e+01
 3.82887338e+01 3.88882391e+01 8.42599766e+00 1.24948494e+01
 3.38239118e+00 6.30133979e+00 8.60353103e+00 4.29863237e+01
 4.92564840e-01 1.20382582e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335742804237956
cond(S) = 907856.7757595535
E1 = -689.560118720972  E_coul = 184.95898085362853
init E= -504.601137867343
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.672515952740312  LUMO = 0.77646594147781
  mo_energy =
[-1.21705067e+02 -1.33852996e+01 -7.62438962e+00 -7.62438962e+00
 -7.62438962e+00 -1.65766793e+00 -6.72515953e-01 -6.72515953e-01
 -6.72515953e-01  7.76465941e-01  1.26575521e+01  1.14352998e+02
  6.13623897e+02  2.75848940e+03  1.22372389e+04  4.08572349e+04
  1.04899960e+05  2.30082874e+05  4.55897489e+05  8.44849532e+05
  1.52802661e+06  2.85029378e+06  5.80818079e+06]
E1 = -707.7283543312611  E_coul = 199.77287231568152
cycle= 1 E= -507.95548201558  delta_E= -3.35  |g|= 0.449  |ddm|= 0.51
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.625775
diis-c [-0.39159416  1.        ]
  HOMO = -0.217964576769979  LUMO = 1.18391179964228
  mo_energy =
[-1.20194387e+02 -1.23036600e+01 -6.59465127e+00 -6.59465127e+00
 -6.59465127e+00 -1.16324728e+00 -2.17964577e-01 -2.17964577e-01
 -2.17964577e-01  1.18391180e+00  1.36052120e+01  1.15755580e+02
  6.15120591e+02  2.75992535e+03  1.22385661e+04  4.08584957e+04
  1.04901184e+05  2.30084074e+05  4.55898672e+05  8.44850701e+05
  1.52802776e+06  2.85029493e+06  5.80818193e+06]
E1 = -706.792869291612  E_coul = 198.8199660649407
cycle= 2 E= -507.972903226671  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.447
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0257749
diis-c [-6.61297965e-04  2.78378083e-03  9.97216219e-01]
  HOMO = -0.23966903672311  LUMO = 1.17726064633223
  mo_energy =
[-1.20306571e+02 -1.23695586e+01 -6.66762985e+00 -6.66762985e+00
 -6.66762985e+00 -1.17722211e+00 -2.39669037e-01 -2.39669037e-01
 -2.39669037e-01  1.17726065e+00  1.35539965e+01  1.15661649e+02
  6.15004348e+02  2.75979326e+03  1.22384239e+04  4.08583498e+04
  1.04901037e+05  2.30083925e+05  4.55898523e+05  8.44850552e+05
  1.52802762e+06  2.85029478e+06  5.80818178e+06]
E1 = -706.6887712039288  E_coul = 198.71562100600613
cycle= 3 E= -507.973150197923  delta_E= -0.000247  |g|= 0.00434  |ddm|= 0.0597
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00291809
diis-c [-1.54084318e-06 -1.77218342e-04 -1.14363220e-01  1.11454044e+00]
  HOMO = -0.24279181470217  LUMO = 1.17607742378071
  mo_energy =
[-1.20318656e+02 -1.23782314e+01 -6.67681798e+00 -6.67681798e+00
 -6.67681798e+00 -1.17911236e+00 -2.42791815e-01 -2.42791815e-01
 -2.42791815e-01  1.17607742e+00  1.35469842e+01  1.15650874e+02
  6.14992083e+02  2.75978012e+03  1.22384103e+04  4.08583360e+04
  1.04901023e+05  2.30083911e+05  4.55898509e+05  8.44850538e+05
  1.52802760e+06  2.85029477e+06  5.80818176e+06]
E1 = -706.6739189743894  E_coul = 198.70076427545214
cycle= 4 E= -507.973154698937  delta_E= -4.5e-06  |g|= 0.000156  |ddm|= 0.00911
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000107844
diis-c [-6.81404303e-11 -5.23674774e-06  7.33580447e-03 -9.10352256e-02
  1.08370466e+00]
  HOMO = -0.24289555772544  LUMO = 1.17603194854975
  mo_energy =
[-1.20318897e+02 -1.23784847e+01 -6.67706526e+00 -6.67706526e+00
 -6.67706526e+00 -1.17917323e+00 -2.42895558e-01 -2.42895558e-01
 -2.42895558e-01  1.17603195e+00  1.35467690e+01  1.15650630e+02
  6.14991843e+02  2.75977988e+03  1.22384101e+04  4.08583357e+04
  1.04901022e+05  2.30083911e+05  4.55898509e+05  8.44850538e+05
  1.52802760e+06  2.85029477e+06  5.80818176e+06]
E1 = -706.6734320117541  E_coul = 198.70027730749683
cycle= 5 E= -507.973154704257  delta_E= -5.32e-09  |g|= 2.58e-07  |ddm|= 0.000329
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.58688e-07
diis-c [-1.16601188e-14  1.79143922e-07 -9.12771761e-05  1.02220329e-03
 -1.13937208e-02  1.01046262e+00]
  HOMO = -0.242895591964451  LUMO = 1.17603210457435
  mo_energy =
[-1.20318897e+02 -1.23784849e+01 -6.67706554e+00 -6.67706554e+00
 -6.67706554e+00 -1.17917338e+00 -2.42895592e-01 -2.42895592e-01
 -2.42895592e-01  1.17603210e+00  1.35467689e+01  1.15650629e+02
  6.14991842e+02  2.75977988e+03  1.22384100e+04  4.08583357e+04
  1.04901022e+05  2.30083911e+05  4.55898509e+05  8.44850538e+05
  1.52802760e+06  2.85029477e+06  5.80818176e+06]
E1 = -706.6734316725871  E_coul = 198.7002769683301
cycle= 6 E= -507.973154704257  delta_E= 2.84e-13  |g|= 1.39e-08  |ddm|= 1.32e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.6734316725871  E_coul = 198.7002769683301
  HOMO = -0.242895584646972  LUMO = 1.17603210407574
  mo_energy =
[-1.20318897e+02 -1.23784849e+01 -6.67706552e+00 -6.67706552e+00
 -6.67706552e+00 -1.17917337e+00 -2.42895585e-01 -2.42895585e-01
 -2.42895585e-01  1.17603210e+00  1.35467689e+01  1.15650629e+02
  6.14991843e+02  2.75977988e+03  1.22384100e+04  4.08583357e+04
  1.04901022e+05  2.30083911e+05  4.55898509e+05  8.44850538e+05
  1.52802760e+06  2.85029477e+06  5.80818176e+06]
E1 = -706.6734317121378  E_coul = 198.70027700788083
Extra cycle  E= -507.973154704257  delta_E=    0  |g|= 2.12e-09  |ddm|= 2.62e-08
    CPU time for scf_cycle      0.45 sec, wall time      0.11 sec
exp = [2.64535374e-01 1.17616814e+05 6.72136184e-01 1.17616814e+06
 5.88084070e+05 2.94042031e+05 1.47020992e+05 7.35104200e+04
 3.67547149e+04 7.30315507e+03 1.83757993e+04 1.44908393e+03
 3.76379722e+02 1.14557167e+02 3.82887338e+01 8.42599766e+00
 3.38239118e+00 8.60353103e+00 4.92564840e-01]
E = -507.973154704257
E = -507.973154704257
exp = [2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01]
