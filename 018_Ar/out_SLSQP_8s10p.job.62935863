created virtual environment CPython3.10.2.final.0-64 in 2194ms
  creator CPython3Posix(dest=/localscratch/nike.62935863.0/ENV, clear=True, no_vcs_ignore=False, global=False)
  seeder FromAppData(download=False, pip=bundle, setuptools=bundle, wheel=bundle, via=copy, app_data_dir=/home/nike/.local/share/virtualenv)
    added seed packages: pip==23.0.1, setuptools==67.3.3, wheel==0.38.4+computecanada
  activators BashActivator,CShellActivator,FishActivator,NushellActivator,PowerShellActivator,PythonActivator
Looking in links: /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic
Requirement already satisfied: pip in /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages (23.0.1)
Looking in links: /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic
Processing /home/nike/pyscf_ad/dist/pyscf-2.1.1+ad-cp310-cp310-linux_x86_64.whl
Processing /home/nike/pyscf_properties_ad/dist/pyscf_properties-0.1.0+ad-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/absl_py-1.4.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/contourpy-1.0.7+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/cycler-0.11.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/fonttools-4.39.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/h5py-3.8.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/jax-0.4.2+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/jaxlib-0.4.2+cuda11.cudnn82.computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/jaxopt-0.6+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/kiwisolver-1.4.4+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/matplotlib-3.7.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/numpy-1.24.2+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/opt_einsum-3.3.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/packaging-23.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/Pillow-9.4.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pyparsing-3.0.9+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pyscfad-0.1.2+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/python_dateutil-2.8.2+computecanada-py2.py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/scipy-1.10.1+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/six-1.16.0+computecanada-py2.py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/typing_extensions-4.5.0+computecanada-py3-none-any.whl
Installing collected packages: typing_extensions, six, pyparsing, Pillow, packaging, numpy, kiwisolver, fonttools, cycler, absl_py, scipy, python-dateutil, opt-einsum, h5py, contourpy, pyscf, matplotlib, jaxlib, pyscf-properties, jax, jaxopt, pyscfad
Successfully installed Pillow-9.4.0+computecanada absl_py-1.4.0+computecanada contourpy-1.0.7+computecanada cycler-0.11.0+computecanada fonttools-4.39.0+computecanada h5py-3.8.0+computecanada jax-0.4.2+computecanada jaxlib-0.4.2+cuda11.cudnn82.computecanada jaxopt-0.6+computecanada kiwisolver-1.4.4+computecanada matplotlib-3.7.0+computecanada numpy-1.24.2+computecanada opt-einsum-3.3.0+computecanada packaging-23.0+computecanada pyparsing-3.0.9+computecanada pyscf-2.1.1+ad pyscf-properties-0.1.0+ad pyscfad-0.1.2+computecanada python-dateutil-2.8.2+computecanada scipy-1.10.1+computecanada six-1.16.0+computecanada typing_extensions-4.5.0+computecanada

real	0m51.943s
user	0m44.852s
sys	0m2.223s
/project/6004934/nike/basis-set-optimization/018_Ar/./input.py:89: OptimizeWarning: Unknown solver options: maxfev
  res = optimize.minimize(
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078499        1
[INPUT] 0    0    [1    /1   ]  7618.25078499        1
[INPUT] 0    0    [1    /1   ]  3618.25078499        1
[INPUT] 0    0    [1    /1   ]  1618.25078499        1
[INPUT] 0    0    [1    /1   ]  239.783987351        1
[INPUT] 0    0    [1    /1   ]  51.8979142065        1
[INPUT] 0    0    [1    /1   ]  4.38708529427        1
[INPUT] 0    0    [1    /1   ]  0.438708529427       1
[INPUT] 1    0    [1    /1   ]  1362.79300324        1
[INPUT] 1    0    [1    /1   ]  665.180725752        1
[INPUT] 1    0    [1    /1   ]  303.320641863        1
[INPUT] 1    0    [1    /1   ]  316.146456063        1
[INPUT] 1    0    [1    /1   ]  49.3001440185        1
[INPUT] 1    0    [1    /1   ]  4.75377857326        1
[INPUT] 1    0    [1    /1   ]  14.7472935001        1
[INPUT] 1    0    [1    /1   ]  0.403281232738       1
[INPUT] 1    0    [1    /1   ]  1.23333836929        1
[INPUT] 1    0    [1    /1   ]  0.0387165584804      1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507849929174, 1.0]], [0, [7618.250784992918, 1.0]], [0, [3618.2507849929175, 1.0]], [0, [1618.2507849929175, 1.0]], [0, [239.7839873511053, 1.0]], [0, [51.89791420649664, 1.0]], [0, [4.387085294269393, 1.0]], [0, [0.4387085294269393, 1.0]], [1, [1362.7930032386791, 1.0]], [1, [665.1807257515178, 1.0]], [1, [303.32064186335555, 1.0]], [1, [316.1464560630523, 1.0]], [1, [49.300144018458525, 1.0]], [1, [4.75377857325692, 1.0]], [1, [14.74729350005786, 1.0]], [1, [0.40328123273769173, 1.0]], [1, [1.2333383692864934, 1.0]], [1, [0.03871655848043362, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50784993]
bas 1, expnt(s) = [7618.25078499]
bas 2, expnt(s) = [3618.25078499]
bas 3, expnt(s) = [1618.25078499]
bas 4, expnt(s) = [239.78398735]
bas 5, expnt(s) = [51.89791421]
bas 6, expnt(s) = [4.38708529]
bas 7, expnt(s) = [0.43870853]
bas 8, expnt(s) = [1362.79300324]
bas 9, expnt(s) = [665.18072575]
bas 10, expnt(s) = [303.32064186]
bas 11, expnt(s) = [316.14645606]
bas 12, expnt(s) = [49.30014402]
bas 13, expnt(s) = [4.75377857]
bas 14, expnt(s) = [14.7472935]
bas 15, expnt(s) = [0.40328123]
bas 16, expnt(s) = [1.23333837]
bas 17, expnt(s) = [0.03871656]
CPU time:         0.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825078e+04 5.20024082e+03 7.61825078e+03 2.06018620e+03
 3.61825078e+03 1.17866130e+03 1.61825078e+03 6.44613496e+02
 2.39783987e+02 1.53950165e+02 5.18979142e+01 4.88514492e+01
 4.38708529e+00 7.65855936e+00 4.38708529e-01 1.36190584e+00
 1.36279300e+03 2.41558187e+04 6.65180726e+02 9.85505298e+03
 3.03320642e+02 3.69285156e+03 3.16146456e+02 3.88906131e+03
 4.93001440e+01 3.81104983e+02 4.75377857e+00 2.04777897e+01
 1.47472935e+01 8.43091668e+01 4.03281233e-01 9.37549934e-01
 1.23333837e+00 3.79172818e+00 3.87165585e-02 5.01020303e-02]
ecpbas  = []
2023-03-19 08:22:00.920674: W external/org_tensorflow/tensorflow/tsl/platform/default/dso_loader.cc:67] Could not load dynamic library 'libcuda.so.1'; dlerror: libcuda.so.1: cannot open shared object file: No such file or directory
2023-03-19 08:22:00.920768: W external/org_tensorflow/tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:264] failed call to cuInit: UNKNOWN ERROR (303)
No GPU/TPU found, falling back to CPU. (Set TF_CPP_MIN_LOG_LEVEL=0 and rerun for more info.)
Set gradient conv threshold to 3.16228e-05
/localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscfad/gto/moleintor.py:74: UserWarning: AO symmetry is not supported. Setting aosym = s1.
  warnings.warn(msg)
Nelec from initial guess = 17.902213147256237
cond(S) = 83440.78659491103
E1 = -726.9927698971701  E_coul = 203.065615998613
init E= -523.927153898557
    CPU time for initialize scf      0.30 sec, wall time      0.19 sec
/localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/jax/_src/numpy/lax_numpy.py:3493: UserWarning: 'kind' argument to argsort is ignored; only 'stable' sorts are supported.
  warnings.warn("'kind' argument to argsort is ignored; only 'stable' sorts "
  HOMO = -0.53951612746283  LUMO = 0.107259647790948
  mo_energy =
[-1.17893403e+02 -1.20905225e+01 -9.44765349e+00 -9.44765349e+00
 -9.44765349e+00 -1.21540892e+00 -5.39516127e-01 -5.39516127e-01
 -5.39516127e-01  1.07259648e-01  1.07259648e-01  1.07259648e-01
  2.34979780e+00  2.34979780e+00  2.34979780e+00  1.67230259e+01
  1.67230259e+01  1.67230259e+01  8.68320821e+01  8.68320821e+01
  8.68320821e+01  1.82114405e+02  4.19412420e+02  4.19412420e+02
  4.19412420e+02  1.27326207e+03  1.27326207e+03  1.27326207e+03
  1.91406379e+03  2.97542074e+03  2.97542074e+03  2.97542074e+03
  6.60469677e+03  6.60469677e+03  6.60469677e+03  8.27259751e+03
  2.46604808e+04  7.54569091e+04]
E1 = -728.7309153701634  E_coul = 203.34114955186234
cycle= 1 E= -525.389765818301  delta_E= -1.46  |g|= 0.192  |ddm|= 1.45
    CPU time for cycle= 1      0.25 sec, wall time      0.25 sec
diis-norm(errvec)=0.45625
diis-c [-0.20816416  1.        ]
  HOMO = -0.503504449590519  LUMO = 0.125818047059823
  mo_energy =
[-1.18026821e+02 -1.20561943e+01 -9.41785265e+00 -9.41785265e+00
 -9.41785265e+00 -1.17788983e+00 -5.03504450e-01 -5.03504450e-01
 -5.03504450e-01  1.25818047e-01  1.25818047e-01  1.25818047e-01
  2.39118168e+00  2.39118168e+00  2.39118168e+00  1.67560227e+01
  1.67560227e+01  1.67560227e+01  8.67991996e+01  8.67991996e+01
  8.67991996e+01  1.82045431e+02  4.19292597e+02  4.19292597e+02
  4.19292597e+02  1.27308582e+03  1.27308582e+03  1.27308582e+03
  1.91374980e+03  2.97517359e+03  2.97517359e+03  2.97517359e+03
  6.60432332e+03  6.60432332e+03  6.60432332e+03  8.27213472e+03
  2.46599191e+04  7.54562526e+04]
E1 = -728.3957861938654  E_coul = 203.00459311481188
cycle= 2 E= -525.391193079054  delta_E= -0.00143  |g|= 0.0126  |ddm|= 0.0819
    CPU time for cycle= 2      0.10 sec, wall time      0.10 sec
diis-norm(errvec)=0.0130435
diis-c [-1.69928656e-04  9.91498970e-04  9.99008501e-01]
  HOMO = -0.516607622232566  LUMO = 0.12406647246079
  mo_energy =
[-1.18043702e+02 -1.20800415e+01 -9.44189205e+00 -9.44189205e+00
 -9.44189205e+00 -1.19390454e+00 -5.16607622e-01 -5.16607622e-01
 -5.16607622e-01  1.24066472e-01  1.24066472e-01  1.24066472e-01
  2.37471842e+00  2.37471842e+00  2.37471842e+00  1.67330190e+01
  1.67330190e+01  1.67330190e+01  8.67786481e+01  8.67786481e+01
  8.67786481e+01  1.82028301e+02  4.19275646e+02  4.19275646e+02
  4.19275646e+02  1.27307002e+03  1.27307002e+03  1.27307002e+03
  1.91373474e+03  2.97515834e+03  2.97515834e+03  2.97515834e+03
  6.60430830e+03  6.60430830e+03  6.60430830e+03  8.27211974e+03
  2.46599040e+04  7.54562373e+04]
E1 = -728.4154592601042  E_coul = 203.0242353151462
cycle= 3 E= -525.391223944958  delta_E= -3.09e-05  |g|= 0.00164  |ddm|= 0.013
    CPU time for cycle= 3      0.02 sec, wall time      0.03 sec
diis-norm(errvec)=0.00271367
diis-c [-6.05317371e-06  1.78622608e-03 -7.08309952e-02  1.06904477e+00]
  HOMO = -0.516637900194602  LUMO = 0.123973559605849
  mo_energy =
[-1.18040927e+02 -1.20781300e+01 -9.43991907e+00 -9.43991907e+00
 -9.43991907e+00 -1.19378812e+00 -5.16637900e-01 -5.16637900e-01
 -5.16637900e-01  1.23973560e-01  1.23973560e-01  1.23973560e-01
  2.37478284e+00  2.37478284e+00  2.37478284e+00  1.67346152e+01
  1.67346152e+01  1.67346152e+01  8.67810429e+01  8.67810429e+01
  8.67810429e+01  1.82031019e+02  4.19278392e+02  4.19278392e+02
  4.19278392e+02  1.27307282e+03  1.27307282e+03  1.27307282e+03
  1.91373750e+03  2.97516114e+03  2.97516114e+03  2.97516114e+03
  6.60431106e+03  6.60431106e+03  6.60431106e+03  8.27212247e+03
  2.46599067e+04  7.54562400e+04]
E1 = -728.4046268209075  E_coul = 203.01340198080769
cycle= 4 E= -525.3912248401  delta_E= -8.95e-07  |g|= 0.000493  |ddm|= 0.00229
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00073748
diis-c [-1.32846724e-07 -1.40485658e-04 -2.31184604e-02  2.10535815e-01
  8.12723132e-01]
  HOMO = -0.516932189579076  LUMO = 0.123933536989259
  mo_energy =
[-1.18041910e+02 -1.20788577e+01 -9.44065787e+00 -9.44065787e+00
 -9.44065787e+00 -1.19415400e+00 -5.16932190e-01 -5.16932190e-01
 -5.16932190e-01  1.23933537e-01  1.23933537e-01  1.23933537e-01
  2.37439739e+00  2.37439739e+00  2.37439739e+00  1.67339395e+01
  1.67339395e+01  1.67339395e+01  8.67801798e+01  8.67801798e+01
  8.67801798e+01  1.82030058e+02  4.19277415e+02  4.19277415e+02
  4.19277415e+02  1.27307181e+03  1.27307181e+03  1.27307181e+03
  1.91373648e+03  2.97516012e+03  2.97516012e+03  2.97516012e+03
  6.60431003e+03  6.60431003e+03  6.60431003e+03  8.27212144e+03
  2.46599057e+04  7.54562390e+04]
E1 = -728.405951959464  E_coul = 203.01472709696785
cycle= 5 E= -525.391224862496  delta_E= -2.24e-08  |g|= 4.79e-05  |ddm|= 0.000283
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=5.11769e-05
diis-c [-8.98808300e-11  1.51219904e-05 -1.90517987e-03 -1.28062172e-02
 -6.84247415e-02  1.08312102e+00]
  HOMO = -0.516979336805698  LUMO = 0.123925622742626
  mo_energy =
[-1.18041979e+02 -1.20789313e+01 -9.44073125e+00 -9.44073125e+00
 -9.44073125e+00 -1.19420998e+00 -5.16979337e-01 -5.16979337e-01
 -5.16979337e-01  1.23925623e-01  1.23925623e-01  1.23925623e-01
  2.37433796e+00  2.37433796e+00  2.37433796e+00  1.67338673e+01
  1.67338673e+01  1.67338673e+01  8.67801079e+01  8.67801079e+01
  8.67801079e+01  1.82029989e+02  4.19277346e+02  4.19277346e+02
  4.19277346e+02  1.27307175e+03  1.27307175e+03  1.27307175e+03
  1.91373642e+03  2.97516005e+03  2.97516005e+03  2.97516005e+03
  6.60430997e+03  6.60430997e+03  6.60430997e+03  8.27212138e+03
  2.46599056e+04  7.54562389e+04]
E1 = -728.4059477253758  E_coul = 203.01472286222113
cycle= 6 E= -525.391224863155  delta_E= -6.58e-10  |g|= 4.51e-07  |ddm|= 7.06e-05
    CPU time for cycle= 6      0.02 sec, wall time      0.02 sec
E1 = -728.4059477253758  E_coul = 203.01472286222113
  HOMO = -0.516979144231942  LUMO = 0.123925660320624
  mo_energy =
[-1.18041979e+02 -1.20789311e+01 -9.44073113e+00 -9.44073113e+00
 -9.44073113e+00 -1.19420976e+00 -5.16979144e-01 -5.16979144e-01
 -5.16979144e-01  1.23925660e-01  1.23925660e-01  1.23925660e-01
  2.37433818e+00  2.37433818e+00  2.37433818e+00  1.67338674e+01
  1.67338674e+01  1.67338674e+01  8.67801080e+01  8.67801080e+01
  8.67801080e+01  1.82029989e+02  4.19277346e+02  4.19277346e+02
  4.19277346e+02  1.27307175e+03  1.27307175e+03  1.27307175e+03
  1.91373642e+03  2.97516005e+03  2.97516005e+03  2.97516005e+03
  6.60430997e+03  6.60430997e+03  6.60430997e+03  8.27212138e+03
  2.46599056e+04  7.54562389e+04]
E1 = -728.4059486961365  E_coul = 203.01472383298184
Extra cycle  E= -525.391224863155  delta_E=    0  |g|= 5.43e-08  |ddm|= 4.48e-07
    CPU time for scf_cycle      0.75 sec, wall time      0.65 sec
exp = [2.61825078e+04 7.61825078e+03 3.61825078e+03 1.61825078e+03
 2.39783987e+02 5.18979142e+01 4.38708529e+00 4.38708529e-01
 1.36279300e+03 6.65180726e+02 3.03320642e+02 3.16146456e+02
 4.93001440e+01 4.75377857e+00 1.47472935e+01 4.03281233e-01
 1.23333837e+00 3.87165585e-02]
E = -525.3912248631547
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078499        1
[INPUT] 0    0    [1    /1   ]  7618.25078499        1
[INPUT] 0    0    [1    /1   ]  3618.25078499        1
[INPUT] 0    0    [1    /1   ]  1618.25078499        1
[INPUT] 0    0    [1    /1   ]  239.783987351        1
[INPUT] 0    0    [1    /1   ]  51.8979142065        1
[INPUT] 0    0    [1    /1   ]  4.38708529427        1
[INPUT] 0    0    [1    /1   ]  0.438708529427       1
[INPUT] 1    0    [1    /1   ]  1362.79300324        1
[INPUT] 1    0    [1    /1   ]  665.180725752        1
[INPUT] 1    0    [1    /1   ]  303.320641863        1
[INPUT] 1    0    [1    /1   ]  316.146456063        1
[INPUT] 1    0    [1    /1   ]  49.3001440185        1
[INPUT] 1    0    [1    /1   ]  4.75377857326        1
[INPUT] 1    0    [1    /1   ]  14.7472935001        1
[INPUT] 1    0    [1    /1   ]  0.403281232738       1
[INPUT] 1    0    [1    /1   ]  1.23333836929        1
[INPUT] 1    0    [1    /1   ]  0.0387165584804      1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507849929174, 1.0]], [0, [7618.250784992918, 1.0]], [0, [3618.2507849929175, 1.0]], [0, [1618.2507849929175, 1.0]], [0, [239.7839873511053, 1.0]], [0, [51.89791420649664, 1.0]], [0, [4.387085294269393, 1.0]], [0, [0.4387085294269393, 1.0]], [1, [1362.7930032386791, 1.0]], [1, [665.1807257515178, 1.0]], [1, [303.32064186335555, 1.0]], [1, [316.1464560630523, 1.0]], [1, [49.300144018458525, 1.0]], [1, [4.75377857325692, 1.0]], [1, [14.74729350005786, 1.0]], [1, [0.40328123273769173, 1.0]], [1, [1.2333383692864934, 1.0]], [1, [0.03871655848043362, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50784993]
bas 1, expnt(s) = [7618.25078499]
bas 2, expnt(s) = [3618.25078499]
bas 3, expnt(s) = [1618.25078499]
bas 4, expnt(s) = [239.78398735]
bas 5, expnt(s) = [51.89791421]
bas 6, expnt(s) = [4.38708529]
bas 7, expnt(s) = [0.43870853]
bas 8, expnt(s) = [1362.79300324]
bas 9, expnt(s) = [665.18072575]
bas 10, expnt(s) = [303.32064186]
bas 11, expnt(s) = [316.14645606]
bas 12, expnt(s) = [49.30014402]
bas 13, expnt(s) = [4.75377857]
bas 14, expnt(s) = [14.7472935]
bas 15, expnt(s) = [0.40328123]
bas 16, expnt(s) = [1.23333837]
bas 17, expnt(s) = [0.03871656]
CPU time:         1.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825078e+04 5.20024082e+03 7.61825078e+03 2.06018620e+03
 3.61825078e+03 1.17866130e+03 1.61825078e+03 6.44613496e+02
 2.39783987e+02 1.53950165e+02 5.18979142e+01 4.88514492e+01
 4.38708529e+00 7.65855936e+00 4.38708529e-01 1.36190584e+00
 1.36279300e+03 2.41558187e+04 6.65180726e+02 9.85505298e+03
 3.03320642e+02 3.69285156e+03 3.16146456e+02 3.88906131e+03
 4.93001440e+01 3.81104983e+02 4.75377857e+00 2.04777897e+01
 1.47472935e+01 8.43091668e+01 4.03281233e-01 9.37549934e-01
 1.23333837e+00 3.79172818e+00 3.87165585e-02 5.01020303e-02]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.902213147256237
cond(S) = 83440.78659491103
E1 = -726.9927698971701  E_coul = 203.065615998613
init E= -523.927153898557
    CPU time for initialize scf      0.15 sec, wall time      0.04 sec
  HOMO = -0.53951612746283  LUMO = 0.107259647790948
  mo_energy =
[-1.17893403e+02 -1.20905225e+01 -9.44765349e+00 -9.44765349e+00
 -9.44765349e+00 -1.21540892e+00 -5.39516127e-01 -5.39516127e-01
 -5.39516127e-01  1.07259648e-01  1.07259648e-01  1.07259648e-01
  2.34979780e+00  2.34979780e+00  2.34979780e+00  1.67230259e+01
  1.67230259e+01  1.67230259e+01  8.68320821e+01  8.68320821e+01
  8.68320821e+01  1.82114405e+02  4.19412420e+02  4.19412420e+02
  4.19412420e+02  1.27326207e+03  1.27326207e+03  1.27326207e+03
  1.91406379e+03  2.97542074e+03  2.97542074e+03  2.97542074e+03
  6.60469677e+03  6.60469677e+03  6.60469677e+03  8.27259751e+03
  2.46604808e+04  7.54569091e+04]
E1 = -728.7309153701634  E_coul = 203.34114955186234
cycle= 1 E= -525.389765818301  delta_E= -1.46  |g|= 0.192  |ddm|= 1.45
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.45625
diis-c [-0.20816416  1.        ]
  HOMO = -0.503504449590519  LUMO = 0.125818047059823
  mo_energy =
[-1.18026821e+02 -1.20561943e+01 -9.41785265e+00 -9.41785265e+00
 -9.41785265e+00 -1.17788983e+00 -5.03504450e-01 -5.03504450e-01
 -5.03504450e-01  1.25818047e-01  1.25818047e-01  1.25818047e-01
  2.39118168e+00  2.39118168e+00  2.39118168e+00  1.67560227e+01
  1.67560227e+01  1.67560227e+01  8.67991996e+01  8.67991996e+01
  8.67991996e+01  1.82045431e+02  4.19292597e+02  4.19292597e+02
  4.19292597e+02  1.27308582e+03  1.27308582e+03  1.27308582e+03
  1.91374980e+03  2.97517359e+03  2.97517359e+03  2.97517359e+03
  6.60432332e+03  6.60432332e+03  6.60432332e+03  8.27213472e+03
  2.46599191e+04  7.54562526e+04]
E1 = -728.3957861938654  E_coul = 203.00459311481188
cycle= 2 E= -525.391193079054  delta_E= -0.00143  |g|= 0.0126  |ddm|= 0.0819
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0130435
diis-c [-1.69928656e-04  9.91498970e-04  9.99008501e-01]
  HOMO = -0.516607622232566  LUMO = 0.12406647246079
  mo_energy =
[-1.18043702e+02 -1.20800415e+01 -9.44189205e+00 -9.44189205e+00
 -9.44189205e+00 -1.19390454e+00 -5.16607622e-01 -5.16607622e-01
 -5.16607622e-01  1.24066472e-01  1.24066472e-01  1.24066472e-01
  2.37471842e+00  2.37471842e+00  2.37471842e+00  1.67330190e+01
  1.67330190e+01  1.67330190e+01  8.67786481e+01  8.67786481e+01
  8.67786481e+01  1.82028301e+02  4.19275646e+02  4.19275646e+02
  4.19275646e+02  1.27307002e+03  1.27307002e+03  1.27307002e+03
  1.91373474e+03  2.97515834e+03  2.97515834e+03  2.97515834e+03
  6.60430830e+03  6.60430830e+03  6.60430830e+03  8.27211974e+03
  2.46599040e+04  7.54562373e+04]
E1 = -728.4154592601042  E_coul = 203.0242353151462
cycle= 3 E= -525.391223944958  delta_E= -3.09e-05  |g|= 0.00164  |ddm|= 0.013
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00271367
diis-c [-6.05317371e-06  1.78622608e-03 -7.08309952e-02  1.06904477e+00]
  HOMO = -0.516637900194602  LUMO = 0.123973559605849
  mo_energy =
[-1.18040927e+02 -1.20781300e+01 -9.43991907e+00 -9.43991907e+00
 -9.43991907e+00 -1.19378812e+00 -5.16637900e-01 -5.16637900e-01
 -5.16637900e-01  1.23973560e-01  1.23973560e-01  1.23973560e-01
  2.37478284e+00  2.37478284e+00  2.37478284e+00  1.67346152e+01
  1.67346152e+01  1.67346152e+01  8.67810429e+01  8.67810429e+01
  8.67810429e+01  1.82031019e+02  4.19278392e+02  4.19278392e+02
  4.19278392e+02  1.27307282e+03  1.27307282e+03  1.27307282e+03
  1.91373750e+03  2.97516114e+03  2.97516114e+03  2.97516114e+03
  6.60431106e+03  6.60431106e+03  6.60431106e+03  8.27212247e+03
  2.46599067e+04  7.54562400e+04]
E1 = -728.4046268209075  E_coul = 203.01340198080769
cycle= 4 E= -525.3912248401  delta_E= -8.95e-07  |g|= 0.000493  |ddm|= 0.00229
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00073748
diis-c [-1.32846724e-07 -1.40485658e-04 -2.31184604e-02  2.10535815e-01
  8.12723132e-01]
  HOMO = -0.516932189579076  LUMO = 0.123933536989259
  mo_energy =
[-1.18041910e+02 -1.20788577e+01 -9.44065787e+00 -9.44065787e+00
 -9.44065787e+00 -1.19415400e+00 -5.16932190e-01 -5.16932190e-01
 -5.16932190e-01  1.23933537e-01  1.23933537e-01  1.23933537e-01
  2.37439739e+00  2.37439739e+00  2.37439739e+00  1.67339395e+01
  1.67339395e+01  1.67339395e+01  8.67801798e+01  8.67801798e+01
  8.67801798e+01  1.82030058e+02  4.19277415e+02  4.19277415e+02
  4.19277415e+02  1.27307181e+03  1.27307181e+03  1.27307181e+03
  1.91373648e+03  2.97516012e+03  2.97516012e+03  2.97516012e+03
  6.60431003e+03  6.60431003e+03  6.60431003e+03  8.27212144e+03
  2.46599057e+04  7.54562390e+04]
E1 = -728.405951959464  E_coul = 203.01472709696785
cycle= 5 E= -525.391224862496  delta_E= -2.24e-08  |g|= 4.79e-05  |ddm|= 0.000283
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=5.11769e-05
diis-c [-8.98808300e-11  1.51219904e-05 -1.90517987e-03 -1.28062172e-02
 -6.84247415e-02  1.08312102e+00]
  HOMO = -0.516979336805698  LUMO = 0.123925622742626
  mo_energy =
[-1.18041979e+02 -1.20789313e+01 -9.44073125e+00 -9.44073125e+00
 -9.44073125e+00 -1.19420998e+00 -5.16979337e-01 -5.16979337e-01
 -5.16979337e-01  1.23925623e-01  1.23925623e-01  1.23925623e-01
  2.37433796e+00  2.37433796e+00  2.37433796e+00  1.67338673e+01
  1.67338673e+01  1.67338673e+01  8.67801079e+01  8.67801079e+01
  8.67801079e+01  1.82029989e+02  4.19277346e+02  4.19277346e+02
  4.19277346e+02  1.27307175e+03  1.27307175e+03  1.27307175e+03
  1.91373642e+03  2.97516005e+03  2.97516005e+03  2.97516005e+03
  6.60430997e+03  6.60430997e+03  6.60430997e+03  8.27212138e+03
  2.46599056e+04  7.54562389e+04]
E1 = -728.4059477253758  E_coul = 203.01472286222113
cycle= 6 E= -525.391224863155  delta_E= -6.58e-10  |g|= 4.51e-07  |ddm|= 7.06e-05
    CPU time for cycle= 6      0.02 sec, wall time      0.02 sec
E1 = -728.4059477253758  E_coul = 203.01472286222113
  HOMO = -0.516979144231942  LUMO = 0.123925660320624
  mo_energy =
[-1.18041979e+02 -1.20789311e+01 -9.44073113e+00 -9.44073113e+00
 -9.44073113e+00 -1.19420976e+00 -5.16979144e-01 -5.16979144e-01
 -5.16979144e-01  1.23925660e-01  1.23925660e-01  1.23925660e-01
  2.37433818e+00  2.37433818e+00  2.37433818e+00  1.67338674e+01
  1.67338674e+01  1.67338674e+01  8.67801080e+01  8.67801080e+01
  8.67801080e+01  1.82029989e+02  4.19277346e+02  4.19277346e+02
  4.19277346e+02  1.27307175e+03  1.27307175e+03  1.27307175e+03
  1.91373642e+03  2.97516005e+03  2.97516005e+03  2.97516005e+03
  6.60430997e+03  6.60430997e+03  6.60430997e+03  8.27212138e+03
  2.46599056e+04  7.54562389e+04]
E1 = -728.4059486961365  E_coul = 203.01472383298184
Extra cycle  E= -525.391224863155  delta_E=    0  |g|= 5.43e-08  |ddm|= 4.48e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.17 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 83440.78659491103
E1 = -728.4059486961365  E_coul = 203.01472383298184
init E= -525.391224863155
    CPU time for initialize scf      1.23 sec, wall time      0.39 sec
  HOMO = -0.516979101738991  LUMO = 0.12392566782429
  mo_energy =
[-1.18041979e+02 -1.20789311e+01 -9.44073107e+00 -9.44073107e+00
 -9.44073107e+00 -1.19420971e+00 -5.16979102e-01 -5.16979102e-01
 -5.16979102e-01  1.23925668e-01  1.23925668e-01  1.23925668e-01
  2.37433824e+00  2.37433824e+00  2.37433824e+00  1.67338675e+01
  1.67338675e+01  1.67338675e+01  8.67801080e+01  8.67801080e+01
  8.67801080e+01  1.82029989e+02  4.19277347e+02  4.19277347e+02
  4.19277347e+02  1.27307175e+03  1.27307175e+03  1.27307175e+03
  1.91373642e+03  2.97516005e+03  2.97516005e+03  2.97516005e+03
  6.60430997e+03  6.60430997e+03  6.60430997e+03  8.27212138e+03
  2.46599056e+04  7.54562389e+04]
E1 = -728.4059487363259  E_coul = 203.01472387317017
cycle= 1 E= -525.391224863156  delta_E= -1.02e-12  |g|= 8.37e-09  |ddm|= 7.27e-08
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.4059487363259  E_coul = 203.01472387317017
  HOMO = -0.51697909736979  LUMO = 0.123925668789436
  mo_energy =
[-1.18041979e+02 -1.20789311e+01 -9.44073107e+00 -9.44073107e+00
 -9.44073107e+00 -1.19420970e+00 -5.16979097e-01 -5.16979097e-01
 -5.16979097e-01  1.23925669e-01  1.23925669e-01  1.23925669e-01
  2.37433824e+00  2.37433824e+00  2.37433824e+00  1.67338675e+01
  1.67338675e+01  1.67338675e+01  8.67801080e+01  8.67801080e+01
  8.67801080e+01  1.82029989e+02  4.19277347e+02  4.19277347e+02
  4.19277347e+02  1.27307175e+03  1.27307175e+03  1.27307175e+03
  1.91373642e+03  2.97516005e+03  2.97516005e+03  2.97516005e+03
  6.60430997e+03  6.60430997e+03  6.60430997e+03  8.27212138e+03
  2.46599056e+04  7.54562389e+04]
E1 = -728.4059487667508  E_coul = 203.01472390359473
Extra cycle  E= -525.391224863156  delta_E= -4.55e-13  |g|= 1.57e-09  |ddm|= 1.2e-08
    CPU time for scf_cycle      2.10 sec, wall time      1.24 sec
exp = [2.61825078e+04 7.61825078e+03 3.61825078e+03 1.61825078e+03
 2.39783987e+02 5.18979142e+01 4.38708529e+00 4.38708529e-01
 1.36279300e+03 6.65180726e+02 3.03320642e+02 3.16146456e+02
 4.93001440e+01 4.75377857e+00 1.47472935e+01 4.03281233e-01
 1.23333837e+00 3.87165585e-02]
grad_E = [-1.98069504e-06  2.16829745e-05  4.32505042e-05  6.64959264e-04
  9.51406558e-04 -7.39633628e-03 -2.07456132e-01  6.10352783e-01
  1.37393854e-06  2.03070313e-05  1.10095124e-04  9.69737962e-05
 -1.40763298e-03 -1.68549008e-02  9.90473111e-03  1.27530512e+00
 -1.18187427e-01 -2.55976375e+00]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078519        1
[INPUT] 0    0    [1    /1   ]  7618.25076331        1
[INPUT] 0    0    [1    /1   ]  3618.25074174        1
[INPUT] 0    0    [1    /1   ]  1618.25012003        1
[INPUT] 0    0    [1    /1   ]  239.783035945        1
[INPUT] 0    0    [1    /1   ]  51.9053105428        1
[INPUT] 0    0    [1    /1   ]  4.5945414267         1
[INPUT] 0    0    [1    /1   ]  1.00000008274e-09      1
[INPUT] 1    0    [1    /1   ]  1362.79300186        1
[INPUT] 1    0    [1    /1   ]  665.180705444        1
[INPUT] 1    0    [1    /1   ]  303.320531768        1
[INPUT] 1    0    [1    /1   ]  316.146359089        1
[INPUT] 1    0    [1    /1   ]  49.3015516514        1
[INPUT] 1    0    [1    /1   ]  4.77063347405        1
[INPUT] 1    0    [1    /1   ]  14.7373887689        1
[INPUT] 1    0    [1    /1   ]  1.0000003603e-09      1
[INPUT] 1    0    [1    /1   ]  1.35152579592        1
[INPUT] 1    0    [1    /1   ]  2.59848031327        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507851909868, 1.0]], [0, [7618.250763309943, 1.0]], [0, [3618.250741742413, 1.0]], [0, [1618.2501200336533, 1.0]], [0, [239.78303594454695, 1.0]], [0, [51.90531054277814, 1.0]], [0, [4.594541426696639, 1.0]], [0, [1.000000082740371e-09, 1.0]], [1, [1362.7930018647405, 1.0]], [1, [665.1807054444864, 1.0]], [1, [303.3205317682319, 1.0]], [1, [316.1463590892561, 1.0]], [1, [49.301551651440306, 1.0]], [1, [4.770633474053728, 1.0]], [1, [14.73738876894466, 1.0]], [1, [1.0000003602961272e-09, 1.0]], [1, [1.3515257959240905, 1.0]], [1, [2.598480313265344, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785191]
bas 1, expnt(s) = [7618.25076331]
bas 2, expnt(s) = [3618.25074174]
bas 3, expnt(s) = [1618.25012003]
bas 4, expnt(s) = [239.78303594]
bas 5, expnt(s) = [51.90531054]
bas 6, expnt(s) = [4.59454143]
bas 7, expnt(s) = [1.00000008e-09]
bas 8, expnt(s) = [1362.79300186]
bas 9, expnt(s) = [665.18070544]
bas 10, expnt(s) = [303.32053177]
bas 11, expnt(s) = [316.14635909]
bas 12, expnt(s) = [49.30155165]
bas 13, expnt(s) = [4.77063347]
bas 14, expnt(s) = [14.73738877]
bas 15, expnt(s) = [1.00000036e-09]
bas 16, expnt(s) = [1.3515258]
bas 17, expnt(s) = [2.59848031]
CPU time:        10.12
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825076e+03 2.06018619e+03
 3.61825074e+03 1.17866129e+03 1.61825012e+03 6.44613297e+02
 2.39783036e+02 1.53949706e+02 5.19053105e+01 4.88566708e+01
 4.59454143e+00 7.92860264e+00 1.00000008e-09 4.49277895e-07
 1.36279300e+03 2.41558187e+04 6.65180705e+02 9.85505260e+03
 3.03320532e+02 3.69284988e+03 3.16146359e+02 3.88905982e+03
 4.93015517e+01 3.81118585e+02 4.77063347e+00 2.05685869e+01
 1.47373888e+01 8.42383919e+01 1.00000036e-09 1.64053155e-11
 1.35152580e+00 4.25123210e+00 2.59848031e+00 9.62462198e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 14.208035686953975
cond(S) = 85469.30347912434
E1 = -673.5897816776468  E_coul = 171.3820015577595
init E= -502.207780119887
    CPU time for initialize scf      0.21 sec, wall time      0.04 sec

WARN: HOMO -0.000605549414920405 == LUMO -0.00060554941437731

  mo_energy =
[-1.20072740e+02 -1.42405432e+01 -1.16513856e+01 -1.16513856e+01
 -1.16513856e+01 -1.62072761e+00 -1.62072761e+00 -1.62072761e+00
 -6.05549415e-04 -6.05549414e-04 -6.05549414e-04 -1.91351077e-04
  5.47660493e+00  5.47660493e+00  5.47660493e+00  2.31483407e+01
  2.31483407e+01  2.31483407e+01  9.20478085e+01  9.20478085e+01
  9.20478085e+01  1.79682220e+02  4.22408790e+02  4.22408790e+02
  4.22408790e+02  1.27547812e+03  1.27547812e+03  1.27547812e+03
  1.91179033e+03  2.97728364e+03  2.97728364e+03  2.97728364e+03
  6.60619012e+03  6.60619012e+03  6.60619012e+03  8.27034215e+03
  2.46582313e+04  7.54546656e+04]
E1 = -720.658523809432  E_coul = 202.24034007931314
cycle= 1 E= -518.418183730119  delta_E= -16.2  |g|= 0.746  |ddm|= 52.8
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.916454
diis-c [-0.83988876  1.        ]

WARN: HOMO -0.000605549414440907 == LUMO -0.000605549414390641

  mo_energy =
[-1.17412163e+02 -1.18889685e+01 -9.29895502e+00 -9.29895502e+00
 -9.29895502e+00 -3.00550115e-01 -3.00550115e-01 -3.00550115e-01
 -6.05549414e-04 -6.05549414e-04 -6.05549414e-04 -1.00923805e-04
  7.28627376e+00  7.28627376e+00  7.28627376e+00  2.53319491e+01
  2.53319491e+01  2.53319491e+01  9.45651923e+01  9.45651923e+01
  9.45651923e+01  1.82392256e+02  4.25070992e+02  4.25070992e+02
  4.25070992e+02  1.27813883e+03  1.27813883e+03  1.27813883e+03
  1.91432716e+03  2.97988667e+03  2.97988667e+03  2.97988667e+03
  6.60867180e+03  6.60867180e+03  6.60867180e+03  8.27273477e+03
  2.46605240e+04  7.54568618e+04]
E1 = -719.1411301371796  E_coul = 200.7017974792255
cycle= 2 E= -518.439332657954  delta_E= -0.0211  |g|= 0.116  |ddm|= 1.11
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.229274
diis-c [-0.0138923   0.17789024  0.82210976]

WARN: HOMO -0.000605549415646957 == LUMO -0.000605549414389119

  mo_energy =
[-1.17602089e+02 -1.19832266e+01 -9.39427867e+00 -9.39427867e+00
 -9.39427867e+00 -3.21124622e-01 -3.21124622e-01 -3.21124622e-01
 -6.05549416e-04 -6.05549414e-04 -6.05549414e-04 -1.00923805e-04
  7.25129880e+00  7.25129880e+00  7.25129880e+00  2.52548211e+01
  2.52548211e+01  2.52548211e+01  9.44255264e+01  9.44255264e+01
  9.44255264e+01  1.82211629e+02  4.24884121e+02  4.24884121e+02
  4.24884121e+02  1.27793921e+03  1.27793921e+03  1.27793921e+03
  1.91411859e+03  2.97968081e+03  2.97968081e+03  2.97968081e+03
  6.60846107e+03  6.60846107e+03  6.60846107e+03  8.27252144e+03
  2.46603089e+04  7.54566456e+04]
E1 = -719.249846295947  E_coul = 200.81031635772675
cycle= 3 E= -518.43952993822  delta_E= -0.000197  |g|= 0.00953  |ddm|= 0.0233
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0198221
diis-c [-1.05020057e-05 -2.59165533e-03 -1.02145163e-01  1.10473682e+00]

WARN: HOMO -0.000605549415663582 == LUMO -0.000605549414372342

  mo_energy =
[-1.17620739e+02 -1.19956332e+01 -9.40690243e+00 -9.40690243e+00
 -9.40690243e+00 -3.24410208e-01 -3.24410208e-01 -3.24410208e-01
 -6.05549416e-04 -6.05549414e-04 -6.05549414e-04 -1.00923805e-04
  7.24617957e+00  7.24617957e+00  7.24617957e+00  2.52445949e+01
  2.52445949e+01  2.52445949e+01  9.44100557e+01  9.44100557e+01
  9.44100557e+01  1.82193581e+02  4.24865729e+02  4.24865729e+02
  4.24865729e+02  1.27792025e+03  1.27792025e+03  1.27792025e+03
  1.91409954e+03  2.97966171e+03  2.97966171e+03  2.97966171e+03
  6.60844197e+03  6.60844197e+03  6.60844197e+03  8.27250236e+03
  2.46602898e+04  7.54566266e+04]
E1 = -719.2578145834323  E_coul = 200.81828297597488
cycle= 4 E= -518.439531607457  delta_E= -1.67e-06  |g|= 0.000135  |ddm|= 0.00222
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000145479
diis-c [-5.21700347e-09 -7.06262636e-06  2.65621101e-03 -2.65664608e-02
  1.02391731e+00]

WARN: HOMO -0.000605549414449875 == LUMO -0.000605549414372606

  mo_energy =
[-1.17620636e+02 -1.19955967e+01 -9.40686739e+00 -9.40686739e+00
 -9.40686739e+00 -3.24412623e-01 -3.24412623e-01 -3.24412623e-01
 -6.05549414e-04 -6.05549414e-04 -6.05549414e-04 -1.00923805e-04
  7.24618487e+00  7.24618487e+00  7.24618487e+00  2.52446231e+01
  2.52446231e+01  2.52446231e+01  9.44101337e+01  9.44101337e+01
  9.44101337e+01  1.82193682e+02  4.24865828e+02  4.24865828e+02
  4.24865828e+02  1.27792035e+03  1.27792035e+03  1.27792035e+03
  1.91409961e+03  2.97966179e+03  2.97966179e+03  2.97966179e+03
  6.60844204e+03  6.60844204e+03  6.60844204e+03  8.27250242e+03
  2.46602899e+04  7.54566266e+04]
E1 = -719.2577011956295  E_coul = 200.8181695877854
cycle= 5 E= -518.439531607844  delta_E= -3.87e-10  |g|= 3.12e-06  |ddm|= 7.99e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -719.2577011956295  E_coul = 200.8181695877854

WARN: HOMO -0.000605549414372838 == LUMO -0.000605549414369575

  mo_energy =
[-1.17620638e+02 -1.19955969e+01 -9.40686765e+00 -9.40686765e+00
 -9.40686765e+00 -3.24412678e-01 -3.24412678e-01 -3.24412678e-01
 -6.05549414e-04 -6.05549414e-04 -6.05549414e-04 -1.00923805e-04
  7.24618493e+00  7.24618493e+00  7.24618493e+00  2.52446230e+01
  2.52446230e+01  2.52446230e+01  9.44101331e+01  9.44101331e+01
  9.44101331e+01  1.82193681e+02  4.24865827e+02  4.24865827e+02
  4.24865827e+02  1.27792034e+03  1.27792034e+03  1.27792034e+03
  1.91409961e+03  2.97966179e+03  2.97966179e+03  2.97966179e+03
  6.60844204e+03  6.60844204e+03  6.60844204e+03  8.27250242e+03
  2.46602899e+04  7.54566266e+04]
E1 = -719.2577021115469  E_coul = 200.81817050370213
Extra cycle  E= -518.439531607845  delta_E= -6.82e-13  |g|= 2.06e-07  |ddm|= 2.83
    CPU time for scf_cycle      0.33 sec, wall time      0.16 sec
exp = [2.61825079e+04 7.61825076e+03 3.61825074e+03 1.61825012e+03
 2.39783036e+02 5.19053105e+01 4.59454143e+00 1.00000008e-09
 1.36279300e+03 6.65180705e+02 3.03320532e+02 3.16146359e+02
 4.93015517e+01 4.77063347e+00 1.47373888e+01 1.00000036e-09
 1.35152580e+00 2.59848031e+00]
E = -518.4395316078447
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078504        1
[INPUT] 0    0    [1    /1   ]  7618.25077941        1
[INPUT] 0    0    [1    /1   ]  3618.25077385        1
[INPUT] 0    0    [1    /1   ]  1618.25061365        1
[INPUT] 0    0    [1    /1   ]  239.7837422          1
[INPUT] 0    0    [1    /1   ]  51.8998200405        1
[INPUT] 0    0    [1    /1   ]  4.44054107858        1
[INPUT] 0    0    [1    /1   ]  0.325665313032       1
[INPUT] 1    0    [1    /1   ]  1362.79300288        1
[INPUT] 1    0    [1    /1   ]  665.180720519        1
[INPUT] 1    0    [1    /1   ]  303.320613495        1
[INPUT] 1    0    [1    /1   ]  316.146431076        1
[INPUT] 1    0    [1    /1   ]  49.3005067271        1
[INPUT] 1    0    [1    /1   ]  4.75812162126        1
[INPUT] 1    0    [1    /1   ]  14.7447413211        1
[INPUT] 1    0    [1    /1   ]  0.299366663968       1
[INPUT] 1    0    [1    /1   ]  1.26379204406        1
[INPUT] 1    0    [1    /1   ]  0.698297827823       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507850439546, 1.0]], [0, [7618.250779405807, 1.0]], [0, [3618.250773848443, 1.0]], [0, [1618.2506136510603, 1.0]], [0, [239.783742199597, 1.0]], [0, [51.8998200405268, 1.0]], [0, [4.440541078579011, 1.0]], [0, [0.32566531303223945, 1.0]], [1, [1362.7930028846527, 1.0]], [1, [665.18072051895, 1.0]], [1, [303.32061349484644, 1.0]], [1, [316.1464310755512, 1.0]], [1, [49.300506727066754, 1.0]], [1, [4.758121621259466, 1.0]], [1, [14.744741321128092, 1.0]], [1, [0.29936666396760453, 1.0]], [1, [1.2637920440587438, 1.0]], [1, [0.6982978278234786, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785044]
bas 1, expnt(s) = [7618.25077941]
bas 2, expnt(s) = [3618.25077385]
bas 3, expnt(s) = [1618.25061365]
bas 4, expnt(s) = [239.7837422]
bas 5, expnt(s) = [51.89982004]
bas 6, expnt(s) = [4.44054108]
bas 7, expnt(s) = [0.32566531]
bas 8, expnt(s) = [1362.79300288]
bas 9, expnt(s) = [665.18072052]
bas 10, expnt(s) = [303.32061349]
bas 11, expnt(s) = [316.14643108]
bas 12, expnt(s) = [49.30050673]
bas 13, expnt(s) = [4.75812162]
bas 14, expnt(s) = [14.74474132]
bas 15, expnt(s) = [0.29936666]
bas 16, expnt(s) = [1.26379204]
bas 17, expnt(s) = [0.69829783]
CPU time:        10.48
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825078e+03 2.06018620e+03
 3.61825077e+03 1.17866129e+03 1.61825061e+03 6.44613445e+02
 2.39783742e+02 1.53950047e+02 5.18998200e+01 4.88527947e+01
 4.44054108e+00 7.72844184e+00 3.25665313e-01 1.08916494e+00
 1.36279300e+03 2.41558187e+04 6.65180721e+02 9.85505288e+03
 3.03320613e+02 3.69285112e+03 3.16146431e+02 3.88906093e+03
 4.93005067e+01 3.81108488e+02 4.75812162e+00 2.05011780e+01
 1.47447413e+01 8.42909289e+01 2.99366664e-01 6.46009180e-01
 1.26379204e+00 3.90911920e+00 6.98297828e-01 1.86223831e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.933286743941657
cond(S) = 83859.44632165844
E1 = -724.977007330759  E_coul = 201.20522110421413
init E= -523.771786226545
    CPU time for initialize scf      0.13 sec, wall time      0.03 sec
  HOMO = -0.606406677955471  LUMO = 1.13860347035419
  mo_energy =
[-1.18040592e+02 -1.22245234e+01 -9.59249063e+00 -9.59249063e+00
 -9.59249063e+00 -1.25102090e+00 -6.06406678e-01 -6.06406678e-01
 -6.06406678e-01  1.13860347e+00  1.13860347e+00  1.13860347e+00
  4.33934560e+00  4.33934560e+00  4.33934560e+00  1.86265206e+01
  1.86265206e+01  1.86265206e+01  8.81090737e+01  8.81090737e+01
  8.81090737e+01  1.81831610e+02  4.20217555e+02  4.20217555e+02
  4.20217555e+02  1.27391837e+03  1.27391837e+03  1.27391837e+03
  1.91384044e+03  2.97601017e+03  2.97601017e+03  2.97601017e+03
  6.60521769e+03  6.60521769e+03  6.60521769e+03  8.27238461e+03
  2.46602719e+04  7.54567046e+04]
E1 = -726.8671534252305  E_coul = 201.4349411517186
cycle= 1 E= -525.432212273512  delta_E= -1.66  |g|= 0.191  |ddm|= 0.873
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.456589
diis-c [-0.20847313  1.        ]
  HOMO = -0.566730978003551  LUMO = 1.17479849952287
  mo_energy =
[-1.18183009e+02 -1.21962657e+01 -9.56898422e+00 -9.56898422e+00
 -9.56898422e+00 -1.21234717e+00 -5.66730978e-01 -5.66730978e-01
 -5.66730978e-01  1.17479850e+00  1.17479850e+00  1.17479850e+00
  4.38409814e+00  4.38409814e+00  4.38409814e+00  1.86533631e+01
  1.86533631e+01  1.86533631e+01  8.80699562e+01  8.80699562e+01
  8.80699562e+01  1.81758527e+02  4.20089334e+02  4.20089334e+02
  4.20089334e+02  1.27373223e+03  1.27373223e+03  1.27373223e+03
  1.91351341e+03  2.97575133e+03  2.97575133e+03  2.97575133e+03
  6.60483030e+03  6.60483030e+03  6.60483030e+03  8.27190643e+03
  2.46596936e+04  7.54560306e+04]
E1 = -726.8429963059283  E_coul = 201.41052880318847
cycle= 2 E= -525.43246750274  delta_E= -0.000255  |g|= 0.00794  |ddm|= 0.0236
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0124472
diis-c [-1.41688394e-04  7.91049912e-03  9.92089501e-01]
  HOMO = -0.568673061389528  LUMO = 1.17374871612988
  mo_energy =
[-1.18175897e+02 -1.21990010e+01 -9.57175986e+00 -9.57175986e+00
 -9.57175986e+00 -1.21467656e+00 -5.68673061e-01 -5.68673061e-01
 -5.68673061e-01  1.17374872e+00  1.17374872e+00  1.17374872e+00
  4.38141684e+00  4.38141684e+00  4.38141684e+00  1.86504682e+01
  1.86504682e+01  1.86504682e+01  8.80719617e+01  8.80719617e+01
  8.80719617e+01  1.81765128e+02  4.20096286e+02  4.20096286e+02
  4.20096286e+02  1.27374067e+03  1.27374067e+03  1.27374067e+03
  1.91352278e+03  2.97576046e+03  2.97576046e+03  2.97576046e+03
  6.60483975e+03  6.60483975e+03  6.60483975e+03  8.27191596e+03
  2.46597031e+04  7.54560400e+04]
E1 = -726.8433201264818  E_coul = 201.41085164088466
cycle= 3 E= -525.432468485597  delta_E= -9.83e-07  |g|= 0.000512  |ddm|= 0.00333
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.001021
diis-c [-7.52838307e-08 -5.39160382e-04  6.60575360e-02  9.34481624e-01]
  HOMO = -0.56855181776338  LUMO = 1.17382738721427
  mo_energy =
[-1.18176467e+02 -1.21989606e+01 -9.57173382e+00 -9.57173382e+00
 -9.57173382e+00 -1.21454062e+00 -5.68551818e-01 -5.68551818e-01
 -5.68551818e-01  1.17382739e+00  1.17382739e+00  1.17382739e+00
  4.38156438e+00  4.38156438e+00  4.38156438e+00  1.86505345e+01
  1.86505345e+01  1.86505345e+01  8.80717060e+01  8.80717060e+01
  8.80717060e+01  1.81764631e+02  4.20095728e+02  4.20095728e+02
  4.20095728e+02  1.27374000e+03  1.27374000e+03  1.27374000e+03
  1.91352199e+03  2.97575972e+03  2.97575972e+03  2.97575972e+03
  6.60483893e+03  6.60483893e+03  6.60483893e+03  8.27191509e+03
  2.46597022e+04  7.54560390e+04]
E1 = -726.8437610612541  E_coul = 201.41129256996598
cycle= 4 E= -525.432468491288  delta_E= -5.69e-09  |g|= 2.77e-05  |ddm|= 0.000225
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=3.15339e-05
diis-c [-7.39719908e-10  2.80839810e-05 -4.28123442e-03 -5.33881147e-02
  1.05764127e+00]
  HOMO = -0.56853516673989  LUMO = 1.17383874572166
  mo_energy =
[-1.18176428e+02 -1.21989246e+01 -9.57169795e+00 -9.57169795e+00
 -9.57169795e+00 -1.21452228e+00 -5.68535167e-01 -5.68535167e-01
 -5.68535167e-01  1.17383875e+00  1.17383875e+00  1.17383875e+00
  4.38158756e+00  4.38158756e+00  4.38158756e+00  1.86505684e+01
  1.86505684e+01  1.86505684e+01  8.80717444e+01  8.80717444e+01
  8.80717444e+01  1.81764671e+02  4.20095767e+02  4.20095767e+02
  4.20095767e+02  1.27374004e+03  1.27374004e+03  1.27374004e+03
  1.91352203e+03  2.97575976e+03  2.97575976e+03  2.97575976e+03
  6.60483896e+03  6.60483896e+03  6.60483896e+03  8.27191513e+03
  2.46597022e+04  7.54560391e+04]
E1 = -726.8437079841626  E_coul = 201.4112394928028
cycle= 5 E= -525.43246849136  delta_E= -7.17e-11  |g|= 3.51e-06  |ddm|= 3.41e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -726.8437079841626  E_coul = 201.4112394928028
  HOMO = -0.568536678124169  LUMO = 1.17383784962812
  mo_energy =
[-1.18176437e+02 -1.21989308e+01 -9.57170428e+00 -9.57170428e+00
 -9.57170428e+00 -1.21452409e+00 -5.68536678e-01 -5.68536678e-01
 -5.68536678e-01  1.17383785e+00  1.17383785e+00  1.17383785e+00
  4.38158510e+00  4.38158510e+00  4.38158510e+00  1.86505630e+01
  1.86505630e+01  1.86505630e+01  8.80717368e+01  8.80717368e+01
  8.80717368e+01  1.81764663e+02  4.20095758e+02  4.20095758e+02
  4.20095758e+02  1.27374003e+03  1.27374003e+03  1.27374003e+03
  1.91352202e+03  2.97575975e+03  2.97575975e+03  2.97575975e+03
  6.60483895e+03  6.60483895e+03  6.60483895e+03  8.27191512e+03
  2.46597022e+04  7.54560391e+04]
E1 = -726.8437223697958  E_coul = 201.41125387843547
Extra cycle  E= -525.43246849136  delta_E= -5.68e-13  |g|= 7.7e-07  |ddm|= 2.47e-06
    CPU time for scf_cycle      0.25 sec, wall time      0.15 sec
exp = [2.61825079e+04 7.61825078e+03 3.61825077e+03 1.61825061e+03
 2.39783742e+02 5.18998200e+01 4.44054108e+00 3.25665313e-01
 1.36279300e+03 6.65180721e+02 3.03320613e+02 3.16146431e+02
 4.93005067e+01 4.75812162e+00 1.47447413e+01 2.99366664e-01
 1.26379204e+00 6.98297828e-01]
E = -525.4324684913604
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078502        1
[INPUT] 0    0    [1    /1   ]  7618.25078214        1
[INPUT] 0    0    [1    /1   ]  3618.2507793         1
[INPUT] 0    0    [1    /1   ]  1618.25069743        1
[INPUT] 0    0    [1    /1   ]  239.783862062        1
[INPUT] 0    0    [1    /1   ]  51.8988882144        1
[INPUT] 0    0    [1    /1   ]  4.41440475326        1
[INPUT] 0    0    [1    /1   ]  0.380935931854       1
[INPUT] 1    0    [1    /1   ]  1362.79300306        1
[INPUT] 1    0    [1    /1   ]  665.180723077        1
[INPUT] 1    0    [1    /1   ]  303.320627365        1
[INPUT] 1    0    [1    /1   ]  316.146443293        1
[INPUT] 1    0    [1    /1   ]  49.3003293867        1
[INPUT] 1    0    [1    /1   ]  4.75599815947        1
[INPUT] 1    0    [1    /1   ]  14.745989167         1
[INPUT] 1    0    [1    /1   ]  0.350173980883       1
[INPUT] 1    0    [1    /1   ]  1.24890222135        1
[INPUT] 1    0    [1    /1   ]  0.375806429556       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507850190006, 1.0]], [0, [7618.250782137533, 1.0]], [0, [3618.25077929735, 1.0]], [0, [1618.2506974258395, 1.0]], [0, [239.78386206238932, 1.0]], [0, [51.89888821436705, 1.0]], [0, [4.414404753263612, 1.0]], [0, [0.3809359318539221, 1.0]], [1, [1362.7930030577481, 1.0]], [1, [665.1807230773278, 1.0]], [1, [303.3206273651617, 1.0]], [1, [316.1464432927783, 1.0]], [1, [49.30032938666661, 1.0]], [1, [4.755998159469111, 1.0]], [1, [14.74598916698113, 1.0]], [1, [0.3501739808830874, 1.0]], [1, [1.2489022213543055, 1.0]], [1, [0.37580642955599, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785019]
bas 1, expnt(s) = [7618.25078214]
bas 2, expnt(s) = [3618.2507793]
bas 3, expnt(s) = [1618.25069743]
bas 4, expnt(s) = [239.78386206]
bas 5, expnt(s) = [51.89888821]
bas 6, expnt(s) = [4.41440475]
bas 7, expnt(s) = [0.38093593]
bas 8, expnt(s) = [1362.79300306]
bas 9, expnt(s) = [665.18072308]
bas 10, expnt(s) = [303.32062737]
bas 11, expnt(s) = [316.14644329]
bas 12, expnt(s) = [49.30032939]
bas 13, expnt(s) = [4.75599816]
bas 14, expnt(s) = [14.74598917]
bas 15, expnt(s) = [0.35017398]
bas 16, expnt(s) = [1.24890222]
bas 17, expnt(s) = [0.37580643]
CPU time:        10.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825078e+03 2.06018620e+03
 3.61825078e+03 1.17866130e+03 1.61825070e+03 6.44613470e+02
 2.39783862e+02 1.53950104e+02 5.18988882e+01 4.88521369e+01
 4.41440475e+00 7.69430039e+00 3.80935932e-01 1.22505046e+00
 1.36279300e+03 2.41558187e+04 6.65180723e+02 9.85505293e+03
 3.03320627e+02 3.69285134e+03 3.16146443e+02 3.88906111e+03
 4.93003294e+01 3.81106774e+02 4.75599816e+00 2.04897420e+01
 1.47459892e+01 8.42998459e+01 3.50173981e-01 7.85849234e-01
 1.24890222e+00 3.85163336e+00 3.75806430e-01 8.58399884e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.938631984690947
cond(S) = 83639.80604018734
E1 = -726.246638582295  E_coul = 202.32684411220455
init E= -523.91979447009
    CPU time for initialize scf      0.12 sec, wall time      0.03 sec
  HOMO = -0.568437360777403  LUMO = 0.926889695460382
  mo_energy =
[-1.17950299e+02 -1.21404176e+01 -9.50298280e+00 -9.50298280e+00
 -9.50298280e+00 -1.24541910e+00 -5.68437361e-01 -5.68437361e-01
 -5.68437361e-01  9.26889695e-01  9.26889695e-01  9.26889695e-01
  3.50841877e+00  3.50841877e+00  3.50841877e+00  1.76167745e+01
  1.76167745e+01  1.76167745e+01  8.74085993e+01  8.74085993e+01
  8.74085993e+01  1.81985016e+02  4.19776019e+02  4.19776019e+02
  4.19776019e+02  1.27355977e+03  1.27355977e+03  1.27355977e+03
  1.91396592e+03  2.97568877e+03  2.97568877e+03  2.97568877e+03
  6.60493456e+03  6.60493456e+03  6.60493456e+03  8.27250531e+03
  2.46603908e+04  7.54568215e+04]
E1 = -727.6706961874344  E_coul = 202.2392526217558
cycle= 1 E= -525.431443565679  delta_E= -1.51  |g|= 0.193  |ddm|= 23.1
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.450674
diis-c [-0.20310697  1.        ]
  HOMO = -0.538624580436327  LUMO = 0.955744588455775
  mo_energy =
[-1.18115122e+02 -1.21377481e+01 -9.50449909e+00 -9.50449909e+00
 -9.50449909e+00 -1.21402966e+00 -5.38624580e-01 -5.38624580e-01
 -5.38624580e-01  9.55744588e-01  9.55744588e-01  9.55744588e-01
  3.54011777e+00  3.54011777e+00  3.54011777e+00  1.76193794e+01
  1.76193794e+01  1.76193794e+01  8.73456591e+01  8.73456591e+01
  8.73456591e+01  1.81887133e+02  4.19625021e+02  4.19625021e+02
  4.19625021e+02  1.27335138e+03  1.27335138e+03  1.27335138e+03
  1.91361829e+03  2.97540864e+03  2.97540864e+03  2.97540864e+03
  6.60452696e+03  6.60452696e+03  6.60452696e+03  8.27200760e+03
  2.46597935e+04  7.54561289e+04]
E1 = -727.724377773525  E_coul = 202.292574237787
cycle= 2 E= -525.431803535738  delta_E= -0.00036  |g|= 0.00967  |ddm|= 1.29
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0149561
diis-c [-2.02609234e-04  1.00889076e-02  9.89911092e-01]
  HOMO = -0.538265436694015  LUMO = 0.956156839305225
  mo_energy =
[-1.18101659e+02 -1.21348982e+01 -9.50158838e+00 -9.50158838e+00
 -9.50158838e+00 -1.21376628e+00 -5.38265437e-01 -5.38265437e-01
 -5.38265437e-01  9.56156839e-01  9.56156839e-01  9.56156839e-01
  3.54068659e+00  3.54068659e+00  3.54068659e+00  1.76216306e+01
  1.76216306e+01  1.76216306e+01  8.73536949e+01  8.73536949e+01
  8.73536949e+01  1.81900013e+02  4.19638302e+02  4.19638302e+02
  4.19638302e+02  1.27336620e+03  1.27336620e+03  1.27336620e+03
  1.91363406e+03  2.97542418e+03  2.97542418e+03  2.97542418e+03
  6.60454282e+03  6.60454282e+03  6.60454282e+03  8.27202355e+03
  2.46598094e+04  7.54561447e+04]
E1 = -727.7173979058798  E_coul = 202.2855910368587
cycle= 3 E= -525.431806869021  delta_E= -3.33e-06  |g|= 0.00102  |ddm|= 0.16
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00183823
diis-c [-2.03579553e-07 -8.16775559e-04  9.81484742e-02  9.02668301e-01]
  HOMO = -0.538183067439063  LUMO = 0.956216196953343
  mo_energy =
[-1.18103044e+02 -1.21353242e+01 -9.50204499e+00 -9.50204499e+00
 -9.50204499e+00 -1.21369360e+00 -5.38183067e-01 -5.38183067e-01
 -5.38183067e-01  9.56216197e-01  9.56216197e-01  9.56216197e-01
  3.54074095e+00  3.54074095e+00  3.54074095e+00  1.76213030e+01
  1.76213030e+01  1.76213030e+01  8.73527870e+01  8.73527870e+01
  8.73527870e+01  1.81898733e+02  4.19636939e+02  4.19636939e+02
  4.19636939e+02  1.27336469e+03  1.27336469e+03  1.27336469e+03
  1.91363241e+03  2.97542258e+03  2.97542258e+03  2.97542258e+03
  6.60454113e+03  6.60454113e+03  6.60454113e+03  8.27202180e+03
  2.46598076e+04  7.54561428e+04]
E1 = -727.7195287743457  E_coul = 202.28772185284325
cycle= 4 E= -525.431806921502  delta_E= -5.25e-08  |g|= 9.79e-05  |ddm|= 0.0213
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=9.72042e-05
diis-c [-4.92777675e-09  1.13071724e-04 -1.76687006e-02 -1.42176405e-01
  1.15973203e+00]
  HOMO = -0.538122607085548  LUMO = 0.956249732269505
  mo_energy =
[-1.18102927e+02 -1.21352134e+01 -9.50193451e+00 -9.50193451e+00
 -9.50193451e+00 -1.21362506e+00 -5.38122607e-01 -5.38122607e-01
 -5.38122607e-01  9.56249732e-01  9.56249732e-01  9.56249732e-01
  3.54081661e+00  3.54081661e+00  3.54081661e+00  1.76214097e+01
  1.76214097e+01  1.76214097e+01  8.73529021e+01  8.73529021e+01
  8.73529021e+01  1.81898851e+02  4.19637056e+02  4.19637056e+02
  4.19637056e+02  1.27336481e+03  1.27336481e+03  1.27336481e+03
  1.91363252e+03  2.97542270e+03  2.97542270e+03  2.97542270e+03
  6.60454124e+03  6.60454124e+03  6.60454124e+03  8.27202191e+03
  2.46598077e+04  7.54561429e+04]
E1 = -727.719450101984  E_coul = 202.28764317909088
cycle= 5 E= -525.431806922893  delta_E= -1.39e-09  |g|= 1.1e-05  |ddm|= 0.00404
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=1.76735e-05
diis-c [-1.07989969e-11  3.63962477e-06 -4.44236873e-04 -9.97844095e-03
  1.15623149e-01  8.94795890e-01]
  HOMO = -0.538129338470502  LUMO = 0.956246413134828
  mo_energy =
[-1.18102951e+02 -1.21352330e+01 -9.50195437e+00 -9.50195437e+00
 -9.50195437e+00 -1.21363324e+00 -5.38129338e-01 -5.38129338e-01
 -5.38129338e-01  9.56246413e-01  9.56246413e-01  9.56246413e-01
  3.54080756e+00  3.54080756e+00  3.54080756e+00  1.76213920e+01
  1.76213920e+01  1.76213920e+01  8.73528801e+01  8.73528801e+01
  8.73528801e+01  1.81898827e+02  4.19637032e+02  4.19637032e+02
  4.19637032e+02  1.27336479e+03  1.27336479e+03  1.27336479e+03
  1.91363250e+03  2.97542267e+03  2.97542267e+03  2.97542267e+03
  6.60454122e+03  6.60454122e+03  6.60454122e+03  8.27202189e+03
  2.46598077e+04  7.54561429e+04]
E1 = -727.719487806495  E_coul = 202.28768088359334
cycle= 6 E= -525.431806922902  delta_E= -8.53e-12  |g|= 4.5e-07  |ddm|= 6.49e-05
    CPU time for cycle= 6      0.02 sec, wall time      0.02 sec
E1 = -727.719487806495  E_coul = 202.28768088359334
  HOMO = -0.538129093584757  LUMO = 0.956246533531524
  mo_energy =
[-1.18102950e+02 -1.21352323e+01 -9.50195358e+00 -9.50195358e+00
 -9.50195358e+00 -1.21363294e+00 -5.38129094e-01 -5.38129094e-01
 -5.38129094e-01  9.56246534e-01  9.56246534e-01  9.56246534e-01
  3.54080789e+00  3.54080789e+00  3.54080789e+00  1.76213927e+01
  1.76213927e+01  1.76213927e+01  8.73528810e+01  8.73528810e+01
  8.73528810e+01  1.81898828e+02  4.19637033e+02  4.19637033e+02
  4.19637033e+02  1.27336479e+03  1.27336479e+03  1.27336479e+03
  1.91363250e+03  2.97542267e+03  2.97542267e+03  2.97542267e+03
  6.60454122e+03  6.60454122e+03  6.60454122e+03  8.27202189e+03
  2.46598077e+04  7.54561429e+04]
E1 = -727.7194862100822  E_coul = 202.28767928718003
Extra cycle  E= -525.431806922902  delta_E= -5.68e-13  |g|= 9.07e-08  |ddm|= 1.72e-06
    CPU time for scf_cycle      0.26 sec, wall time      0.17 sec
exp = [2.61825079e+04 7.61825078e+03 3.61825078e+03 1.61825070e+03
 2.39783862e+02 5.18988882e+01 4.41440475e+00 3.80935932e-01
 1.36279300e+03 6.65180723e+02 3.03320627e+02 3.16146443e+02
 4.93003294e+01 4.75599816e+00 1.47459892e+01 3.50173981e-01
 1.24890222e+00 3.75806430e-01]
E = -525.4318069229022
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078501        1
[INPUT] 0    0    [1    /1   ]  7618.2507835         1
[INPUT] 0    0    [1    /1   ]  3618.25078202        1
[INPUT] 0    0    [1    /1   ]  1618.2507393         1
[INPUT] 0    0    [1    /1   ]  239.783921981        1
[INPUT] 0    0    [1    /1   ]  51.8984223969        1
[INPUT] 0    0    [1    /1   ]  4.40133927162        1
[INPUT] 0    0    [1    /1   ]  0.408565571701       1
[INPUT] 1    0    [1    /1   ]  1362.79300314        1
[INPUT] 1    0    [1    /1   ]  665.180724356        1
[INPUT] 1    0    [1    /1   ]  303.320634299        1
[INPUT] 1    0    [1    /1   ]  316.1464494          1
[INPUT] 1    0    [1    /1   ]  49.3002407347        1
[INPUT] 1    0    [1    /1   ]  4.75493664639        1
[INPUT] 1    0    [1    /1   ]  14.7466129619        1
[INPUT] 1    0    [1    /1   ]  0.375572427615       1
[INPUT] 1    0    [1    /1   ]  1.24145883737        1
[INPUT] 1    0    [1    /1   ]  0.214593811027       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507850065263, 1.0]], [0, [7618.250783503116, 1.0]], [0, [3618.250782021245, 1.0]], [0, [1618.2507393046353, 1.0]], [0, [239.78392198149015, 1.0]], [0, [51.89842239687228, 1.0]], [0, [4.401339271624558, 1.0]], [0, [0.4085655717011261, 1.0]], [1, [1362.7930031442781, 1.0]], [1, [665.1807243562544, 1.0]], [1, [303.3206342988966, 1.0]], [1, [316.1464494001387, 1.0]], [1, [49.30024073465781, 1.0]], [1, [4.754936646394938, 1.0]], [1, [14.746612961905797, 1.0]], [1, [0.375572427614913, 1.0]], [1, [1.241458837374118, 1.0]], [1, [0.21459381102716657, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785007]
bas 1, expnt(s) = [7618.2507835]
bas 2, expnt(s) = [3618.25078202]
bas 3, expnt(s) = [1618.2507393]
bas 4, expnt(s) = [239.78392198]
bas 5, expnt(s) = [51.8984224]
bas 6, expnt(s) = [4.40133927]
bas 7, expnt(s) = [0.40856557]
bas 8, expnt(s) = [1362.79300314]
bas 9, expnt(s) = [665.18072436]
bas 10, expnt(s) = [303.3206343]
bas 11, expnt(s) = [316.1464494]
bas 12, expnt(s) = [49.30024073]
bas 13, expnt(s) = [4.75493665]
bas 14, expnt(s) = [14.74661296]
bas 15, expnt(s) = [0.37557243]
bas 16, expnt(s) = [1.24145884]
bas 17, expnt(s) = [0.21459381]
CPU time:        11.05
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825078e+03 2.06018620e+03
 3.61825078e+03 1.17866130e+03 1.61825074e+03 6.44613482e+02
 2.39783922e+02 1.53950133e+02 5.18984224e+01 4.88518080e+01
 4.40133927e+00 7.67721423e+00 4.08565572e-01 1.29110437e+00
 1.36279300e+03 2.41558187e+04 6.65180724e+02 9.85505295e+03
 3.03320634e+02 3.69285144e+03 3.16146449e+02 3.88906121e+03
 4.93002407e+01 3.81105918e+02 4.75493665e+00 2.04840257e+01
 1.47466130e+01 8.43043036e+01 3.75572428e-01 8.57731815e-01
 1.24145884e+00 3.82296039e+00 2.14593811e-01 4.26094456e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.961126360855566
cond(S) = 83520.77328398063
E1 = -726.8362136153153  E_coul = 202.79801812203408
init E= -524.038195493281
    CPU time for initialize scf      0.12 sec, wall time      0.03 sec
  HOMO = -0.559796999720395  LUMO = 0.660174288222487
  mo_energy =
[-1.17913866e+02 -1.21068344e+01 -9.46693209e+00 -9.46693209e+00
 -9.46693209e+00 -1.23044362e+00 -5.59797000e-01 -5.59797000e-01
 -5.59797000e-01  6.60174288e-01  6.60174288e-01  6.60174288e-01
  2.96917092e+00  2.96917092e+00  2.96917092e+00  1.71409116e+01
  1.71409116e+01  1.71409116e+01  8.70971473e+01  8.70971473e+01
  8.70971473e+01  1.82055302e+02  4.19580789e+02  4.19580789e+02
  4.19580789e+02  1.27340090e+03  1.27340090e+03  1.27340090e+03
  1.91402155e+03  2.97554621e+03  2.97554621e+03  2.97554621e+03
  6.60480867e+03  6.60480867e+03  6.60480867e+03  8.27255833e+03
  2.46604428e+04  7.54568724e+04]
E1 = -727.2280336784704  E_coul = 201.76464969148742
cycle= 1 E= -525.463383986983  delta_E= -1.43  |g|= 0.195  |ddm|= 0.761
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.463214
diis-c [-0.21456709  1.        ]
  HOMO = -0.559502179359968  LUMO = 0.669839579634454
  mo_energy =
[-1.18155635e+02 -1.21711778e+01 -9.53595420e+00 -9.53595420e+00
 -9.53595420e+00 -1.23635338e+00 -5.59502179e-01 -5.59502179e-01
 -5.59502179e-01  6.69839580e-01  6.69839580e-01  6.69839580e-01
  2.96337134e+00  2.96337134e+00  2.96337134e+00  1.70808829e+01
  1.70808829e+01  1.70808829e+01  8.69617791e+01  8.69617791e+01
  8.69617791e+01  1.81880312e+02  4.19353020e+02  4.19353020e+02
  4.19353020e+02  1.27311494e+03  1.27311494e+03  1.27311494e+03
  1.91359655e+03  2.97518850e+03  2.97518850e+03  2.97518850e+03
  6.60432378e+03  6.60432378e+03  6.60432378e+03  8.27198358e+03
  2.46597688e+04  7.54561032e+04]
E1 = -727.4475103706518  E_coul = 201.98381687185275
cycle= 2 E= -525.463693498799  delta_E= -0.00031  |g|= 0.0161  |ddm|= 0.051
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0279859
diis-c [-6.16692487e-04  2.71410574e-02  9.72858943e-01]
  HOMO = -0.55604324403849  LUMO = 0.671255900750826
  mo_energy =
[-1.18124587e+02 -1.21562282e+01 -9.52066936e+00 -9.52066936e+00
 -9.52066936e+00 -1.23196345e+00 -5.56043244e-01 -5.56043244e-01
 -5.56043244e-01  6.71255901e-01  6.71255901e-01  6.71255901e-01
  2.96828544e+00  2.96828544e+00  2.96828544e+00  1.70939272e+01
  1.70939272e+01  1.70939272e+01  8.69848137e+01  8.69848137e+01
  8.69848137e+01  1.81910281e+02  4.19383734e+02  4.19383734e+02
  4.19383734e+02  1.27314782e+03  1.27314782e+03  1.27314782e+03
  1.91363076e+03  2.97522236e+03  2.97522236e+03  2.97522236e+03
  6.60435816e+03  6.60435816e+03  6.60435816e+03  8.27201815e+03
  2.46598033e+04  7.54561377e+04]
E1 = -727.4083447112574  E_coul = 201.9446438226841
cycle= 3 E= -525.463700888573  delta_E= -7.39e-06  |g|= 0.0022  |ddm|= 0.00455
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00422406
diis-c [-2.08546664e-07 -9.78425470e-04  1.24079201e-01  8.76899225e-01]
  HOMO = -0.556399729354  LUMO = 0.671148361618583
  mo_energy =
[-1.18128564e+02 -1.21583124e+01 -9.52282367e+00 -9.52282367e+00
 -9.52282367e+00 -1.23246379e+00 -5.56399729e-01 -5.56399729e-01
 -5.56399729e-01  6.71148362e-01  6.71148362e-01  6.71148362e-01
  2.96773584e+00  2.96773584e+00  2.96773584e+00  1.70921113e+01
  1.70921113e+01  1.70921113e+01  8.69817580e+01  8.69817580e+01
  8.69817580e+01  1.81906501e+02  4.19379805e+02  4.19379805e+02
  4.19379805e+02  1.27314363e+03  1.27314363e+03  1.27314363e+03
  1.91362634e+03  2.97521802e+03  2.97521802e+03  2.97521802e+03
  6.60435369e+03  6.60435369e+03  6.60435369e+03  8.27201359e+03
  2.46597987e+04  7.54561330e+04]
E1 = -727.4151756373557  E_coul = 201.951474540602
cycle= 4 E= -525.463701096754  delta_E= -2.08e-07  |g|= 0.000106  |ddm|= 0.00125
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000106105
diis-c [-8.24687606e-09  5.53615406e-05 -1.06493774e-02 -6.22915538e-02
  1.07288557e+00]
  HOMO = -0.556331956036825  LUMO = 0.671178100361873
  mo_energy =
[-1.18128430e+02 -1.21581837e+01 -9.52269495e+00 -9.52269495e+00
 -9.52269495e+00 -1.23238381e+00 -5.56331956e-01 -5.56331956e-01
 -5.56331956e-01  6.71178100e-01  6.71178100e-01  6.71178100e-01
  2.96782047e+00  2.96782047e+00  2.96782047e+00  1.70922348e+01
  1.70922348e+01  1.70922348e+01  8.69818902e+01  8.69818902e+01
  8.69818902e+01  1.81906636e+02  4.19379939e+02  4.19379939e+02
  4.19379939e+02  1.27314376e+03  1.27314376e+03  1.27314376e+03
  1.91362647e+03  2.97521816e+03  2.97521816e+03  2.97521816e+03
  6.60435381e+03  6.60435381e+03  6.60435381e+03  8.27201372e+03
  2.46597988e+04  7.54561331e+04]
E1 = -727.415065965765  E_coul = 201.9513648670472
cycle= 5 E= -525.463701098718  delta_E= -1.96e-09  |g|= 9.29e-06  |ddm|= 0.000191
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=1.48196e-05
diis-c [-1.60071472e-11  4.92507676e-06 -5.68531116e-04 -7.25520294e-03
  8.81736553e-03  9.99001443e-01]
  HOMO = -0.556333872986199  LUMO = 0.671177772252324
  mo_energy =
[-1.18128446e+02 -1.21581960e+01 -9.52270757e+00 -9.52270757e+00
 -9.52270757e+00 -1.23238685e+00 -5.56333873e-01 -5.56333873e-01
 -5.56333873e-01  6.71177772e-01  6.71177772e-01  6.71177772e-01
  2.96781745e+00  2.96781745e+00  2.96781745e+00  1.70922242e+01
  1.70922242e+01  1.70922242e+01  8.69818758e+01  8.69818758e+01
  8.69818758e+01  1.81906620e+02  4.19379923e+02  4.19379923e+02
  4.19379923e+02  1.27314375e+03  1.27314375e+03  1.27314375e+03
  1.91362645e+03  2.97521814e+03  2.97521814e+03  2.97521814e+03
  6.60435380e+03  6.60435380e+03  6.60435380e+03  8.27201370e+03
  2.46597988e+04  7.54561331e+04]
E1 = -727.4151106352003  E_coul = 201.95140953646907
cycle= 6 E= -525.463701098731  delta_E= -1.34e-11  |g|= 6.07e-07  |ddm|= 1.62e-05
    CPU time for cycle= 6      0.02 sec, wall time      0.02 sec
E1 = -727.4151106352003  E_coul = 201.95140953646907
  HOMO = -0.556333494857586  LUMO = 0.67117792329896
  mo_energy =
[-1.18128444e+02 -1.21581950e+01 -9.52270652e+00 -9.52270652e+00
 -9.52270652e+00 -1.23238639e+00 -5.56333495e-01 -5.56333495e-01
 -5.56333495e-01  6.71177923e-01  6.71177923e-01  6.71177923e-01
  2.96781794e+00  2.96781794e+00  2.96781794e+00  1.70922252e+01
  1.70922252e+01  1.70922252e+01  8.69818770e+01  8.69818770e+01
  8.69818770e+01  1.81906621e+02  4.19379924e+02  4.19379924e+02
  4.19379924e+02  1.27314375e+03  1.27314375e+03  1.27314375e+03
  1.91362646e+03  2.97521814e+03  2.97521814e+03  2.97521814e+03
  6.60435380e+03  6.60435380e+03  6.60435380e+03  8.27201370e+03
  2.46597988e+04  7.54561331e+04]
E1 = -727.4151085517801  E_coul = 201.95140745304943
Extra cycle  E= -525.463701098731  delta_E= 5.68e-13  |g|= 1.2e-07  |ddm|= 4.74e-07
    CPU time for scf_cycle      0.26 sec, wall time      0.17 sec
exp = [2.61825079e+04 7.61825078e+03 3.61825078e+03 1.61825074e+03
 2.39783922e+02 5.18984224e+01 4.40133927e+00 4.08565572e-01
 1.36279300e+03 6.65180724e+02 3.03320634e+02 3.16146449e+02
 4.93002407e+01 4.75493665e+00 1.47466130e+01 3.75572428e-01
 1.24145884e+00 2.14593811e-01]
E = -525.4637010987307
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:09 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078501        1
[INPUT] 0    0    [1    /1   ]  7618.2507835         1
[INPUT] 0    0    [1    /1   ]  3618.25078202        1
[INPUT] 0    0    [1    /1   ]  1618.2507393         1
[INPUT] 0    0    [1    /1   ]  239.783921981        1
[INPUT] 0    0    [1    /1   ]  51.8984223969        1
[INPUT] 0    0    [1    /1   ]  4.40133927162        1
[INPUT] 0    0    [1    /1   ]  0.408565571701       1
[INPUT] 1    0    [1    /1   ]  1362.79300314        1
[INPUT] 1    0    [1    /1   ]  665.180724356        1
[INPUT] 1    0    [1    /1   ]  303.320634299        1
[INPUT] 1    0    [1    /1   ]  316.1464494          1
[INPUT] 1    0    [1    /1   ]  49.3002407347        1
[INPUT] 1    0    [1    /1   ]  4.75493664639        1
[INPUT] 1    0    [1    /1   ]  14.7466129619        1
[INPUT] 1    0    [1    /1   ]  0.375572427615       1
[INPUT] 1    0    [1    /1   ]  1.24145883737        1
[INPUT] 1    0    [1    /1   ]  0.214593811027       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507850065263, 1.0]], [0, [7618.250783503116, 1.0]], [0, [3618.250782021245, 1.0]], [0, [1618.2507393046353, 1.0]], [0, [239.78392198149015, 1.0]], [0, [51.89842239687228, 1.0]], [0, [4.401339271624558, 1.0]], [0, [0.4085655717011261, 1.0]], [1, [1362.7930031442781, 1.0]], [1, [665.1807243562544, 1.0]], [1, [303.3206342988966, 1.0]], [1, [316.1464494001387, 1.0]], [1, [49.30024073465781, 1.0]], [1, [4.754936646394938, 1.0]], [1, [14.746612961905797, 1.0]], [1, [0.375572427614913, 1.0]], [1, [1.241458837374118, 1.0]], [1, [0.21459381102716657, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785007]
bas 1, expnt(s) = [7618.2507835]
bas 2, expnt(s) = [3618.25078202]
bas 3, expnt(s) = [1618.2507393]
bas 4, expnt(s) = [239.78392198]
bas 5, expnt(s) = [51.8984224]
bas 6, expnt(s) = [4.40133927]
bas 7, expnt(s) = [0.40856557]
bas 8, expnt(s) = [1362.79300314]
bas 9, expnt(s) = [665.18072436]
bas 10, expnt(s) = [303.3206343]
bas 11, expnt(s) = [316.1464494]
bas 12, expnt(s) = [49.30024073]
bas 13, expnt(s) = [4.75493665]
bas 14, expnt(s) = [14.74661296]
bas 15, expnt(s) = [0.37557243]
bas 16, expnt(s) = [1.24145884]
bas 17, expnt(s) = [0.21459381]
CPU time:        11.34
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825078e+03 2.06018620e+03
 3.61825078e+03 1.17866130e+03 1.61825074e+03 6.44613482e+02
 2.39783922e+02 1.53950133e+02 5.18984224e+01 4.88518080e+01
 4.40133927e+00 7.67721423e+00 4.08565572e-01 1.29110437e+00
 1.36279300e+03 2.41558187e+04 6.65180724e+02 9.85505295e+03
 3.03320634e+02 3.69285144e+03 3.16146449e+02 3.88906121e+03
 4.93002407e+01 3.81105918e+02 4.75493665e+00 2.04840257e+01
 1.47466130e+01 8.43043036e+01 3.75572428e-01 8.57731815e-01
 1.24145884e+00 3.82296039e+00 2.14593811e-01 4.26094456e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.961126360855566
cond(S) = 83520.77328398063
E1 = -726.8362136153153  E_coul = 202.79801812203408
init E= -524.038195493281
    CPU time for initialize scf      0.13 sec, wall time      0.04 sec
  HOMO = -0.559796999720395  LUMO = 0.660174288222487
  mo_energy =
[-1.17913866e+02 -1.21068344e+01 -9.46693209e+00 -9.46693209e+00
 -9.46693209e+00 -1.23044362e+00 -5.59797000e-01 -5.59797000e-01
 -5.59797000e-01  6.60174288e-01  6.60174288e-01  6.60174288e-01
  2.96917092e+00  2.96917092e+00  2.96917092e+00  1.71409116e+01
  1.71409116e+01  1.71409116e+01  8.70971473e+01  8.70971473e+01
  8.70971473e+01  1.82055302e+02  4.19580789e+02  4.19580789e+02
  4.19580789e+02  1.27340090e+03  1.27340090e+03  1.27340090e+03
  1.91402155e+03  2.97554621e+03  2.97554621e+03  2.97554621e+03
  6.60480867e+03  6.60480867e+03  6.60480867e+03  8.27255833e+03
  2.46604428e+04  7.54568724e+04]
E1 = -727.2280336784704  E_coul = 201.76464969148742
cycle= 1 E= -525.463383986983  delta_E= -1.43  |g|= 0.195  |ddm|= 0.761
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.463214
diis-c [-0.21456709  1.        ]
  HOMO = -0.559502179359968  LUMO = 0.669839579634454
  mo_energy =
[-1.18155635e+02 -1.21711778e+01 -9.53595420e+00 -9.53595420e+00
 -9.53595420e+00 -1.23635338e+00 -5.59502179e-01 -5.59502179e-01
 -5.59502179e-01  6.69839580e-01  6.69839580e-01  6.69839580e-01
  2.96337134e+00  2.96337134e+00  2.96337134e+00  1.70808829e+01
  1.70808829e+01  1.70808829e+01  8.69617791e+01  8.69617791e+01
  8.69617791e+01  1.81880312e+02  4.19353020e+02  4.19353020e+02
  4.19353020e+02  1.27311494e+03  1.27311494e+03  1.27311494e+03
  1.91359655e+03  2.97518850e+03  2.97518850e+03  2.97518850e+03
  6.60432378e+03  6.60432378e+03  6.60432378e+03  8.27198358e+03
  2.46597688e+04  7.54561032e+04]
E1 = -727.4475103706518  E_coul = 201.98381687185275
cycle= 2 E= -525.463693498799  delta_E= -0.00031  |g|= 0.0161  |ddm|= 0.051
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0279859
diis-c [-6.16692487e-04  2.71410574e-02  9.72858943e-01]
  HOMO = -0.55604324403849  LUMO = 0.671255900750826
  mo_energy =
[-1.18124587e+02 -1.21562282e+01 -9.52066936e+00 -9.52066936e+00
 -9.52066936e+00 -1.23196345e+00 -5.56043244e-01 -5.56043244e-01
 -5.56043244e-01  6.71255901e-01  6.71255901e-01  6.71255901e-01
  2.96828544e+00  2.96828544e+00  2.96828544e+00  1.70939272e+01
  1.70939272e+01  1.70939272e+01  8.69848137e+01  8.69848137e+01
  8.69848137e+01  1.81910281e+02  4.19383734e+02  4.19383734e+02
  4.19383734e+02  1.27314782e+03  1.27314782e+03  1.27314782e+03
  1.91363076e+03  2.97522236e+03  2.97522236e+03  2.97522236e+03
  6.60435816e+03  6.60435816e+03  6.60435816e+03  8.27201815e+03
  2.46598033e+04  7.54561377e+04]
E1 = -727.4083447112574  E_coul = 201.9446438226841
cycle= 3 E= -525.463700888573  delta_E= -7.39e-06  |g|= 0.0022  |ddm|= 0.00455
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00422406
diis-c [-2.08546664e-07 -9.78425470e-04  1.24079201e-01  8.76899225e-01]
  HOMO = -0.556399729354  LUMO = 0.671148361618583
  mo_energy =
[-1.18128564e+02 -1.21583124e+01 -9.52282367e+00 -9.52282367e+00
 -9.52282367e+00 -1.23246379e+00 -5.56399729e-01 -5.56399729e-01
 -5.56399729e-01  6.71148362e-01  6.71148362e-01  6.71148362e-01
  2.96773584e+00  2.96773584e+00  2.96773584e+00  1.70921113e+01
  1.70921113e+01  1.70921113e+01  8.69817580e+01  8.69817580e+01
  8.69817580e+01  1.81906501e+02  4.19379805e+02  4.19379805e+02
  4.19379805e+02  1.27314363e+03  1.27314363e+03  1.27314363e+03
  1.91362634e+03  2.97521802e+03  2.97521802e+03  2.97521802e+03
  6.60435369e+03  6.60435369e+03  6.60435369e+03  8.27201359e+03
  2.46597987e+04  7.54561330e+04]
E1 = -727.4151756373557  E_coul = 201.951474540602
cycle= 4 E= -525.463701096754  delta_E= -2.08e-07  |g|= 0.000106  |ddm|= 0.00125
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000106105
diis-c [-8.24687606e-09  5.53615406e-05 -1.06493774e-02 -6.22915538e-02
  1.07288557e+00]
  HOMO = -0.556331956036825  LUMO = 0.671178100361873
  mo_energy =
[-1.18128430e+02 -1.21581837e+01 -9.52269495e+00 -9.52269495e+00
 -9.52269495e+00 -1.23238381e+00 -5.56331956e-01 -5.56331956e-01
 -5.56331956e-01  6.71178100e-01  6.71178100e-01  6.71178100e-01
  2.96782047e+00  2.96782047e+00  2.96782047e+00  1.70922348e+01
  1.70922348e+01  1.70922348e+01  8.69818902e+01  8.69818902e+01
  8.69818902e+01  1.81906636e+02  4.19379939e+02  4.19379939e+02
  4.19379939e+02  1.27314376e+03  1.27314376e+03  1.27314376e+03
  1.91362647e+03  2.97521816e+03  2.97521816e+03  2.97521816e+03
  6.60435381e+03  6.60435381e+03  6.60435381e+03  8.27201372e+03
  2.46597988e+04  7.54561331e+04]
E1 = -727.415065965765  E_coul = 201.9513648670472
cycle= 5 E= -525.463701098718  delta_E= -1.96e-09  |g|= 9.29e-06  |ddm|= 0.000191
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=1.48196e-05
diis-c [-1.60071472e-11  4.92507676e-06 -5.68531116e-04 -7.25520294e-03
  8.81736553e-03  9.99001443e-01]
  HOMO = -0.556333872986199  LUMO = 0.671177772252324
  mo_energy =
[-1.18128446e+02 -1.21581960e+01 -9.52270757e+00 -9.52270757e+00
 -9.52270757e+00 -1.23238685e+00 -5.56333873e-01 -5.56333873e-01
 -5.56333873e-01  6.71177772e-01  6.71177772e-01  6.71177772e-01
  2.96781745e+00  2.96781745e+00  2.96781745e+00  1.70922242e+01
  1.70922242e+01  1.70922242e+01  8.69818758e+01  8.69818758e+01
  8.69818758e+01  1.81906620e+02  4.19379923e+02  4.19379923e+02
  4.19379923e+02  1.27314375e+03  1.27314375e+03  1.27314375e+03
  1.91362645e+03  2.97521814e+03  2.97521814e+03  2.97521814e+03
  6.60435380e+03  6.60435380e+03  6.60435380e+03  8.27201370e+03
  2.46597988e+04  7.54561331e+04]
E1 = -727.4151106352003  E_coul = 201.95140953646907
cycle= 6 E= -525.463701098731  delta_E= -1.34e-11  |g|= 6.07e-07  |ddm|= 1.62e-05
    CPU time for cycle= 6      0.02 sec, wall time      0.02 sec
E1 = -727.4151106352003  E_coul = 201.95140953646907
  HOMO = -0.556333494857586  LUMO = 0.67117792329896
  mo_energy =
[-1.18128444e+02 -1.21581950e+01 -9.52270652e+00 -9.52270652e+00
 -9.52270652e+00 -1.23238639e+00 -5.56333495e-01 -5.56333495e-01
 -5.56333495e-01  6.71177923e-01  6.71177923e-01  6.71177923e-01
  2.96781794e+00  2.96781794e+00  2.96781794e+00  1.70922252e+01
  1.70922252e+01  1.70922252e+01  8.69818770e+01  8.69818770e+01
  8.69818770e+01  1.81906621e+02  4.19379924e+02  4.19379924e+02
  4.19379924e+02  1.27314375e+03  1.27314375e+03  1.27314375e+03
  1.91362646e+03  2.97521814e+03  2.97521814e+03  2.97521814e+03
  6.60435380e+03  6.60435380e+03  6.60435380e+03  8.27201370e+03
  2.46597988e+04  7.54561331e+04]
E1 = -727.4151085517801  E_coul = 201.95140745304943
Extra cycle  E= -525.463701098731  delta_E= 5.68e-13  |g|= 1.2e-07  |ddm|= 4.74e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.18 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 83520.77328398063
E1 = -727.4151085517801  E_coul = 201.95140745304943
init E= -525.463701098731
    CPU time for initialize scf      0.92 sec, wall time      0.16 sec
  HOMO = -0.556333524148053  LUMO = 0.671177914859277
  mo_energy =
[-1.18128445e+02 -1.21581951e+01 -9.52270668e+00 -9.52270668e+00
 -9.52270668e+00 -1.23238643e+00 -5.56333524e-01 -5.56333524e-01
 -5.56333524e-01  6.71177915e-01  6.71177915e-01  6.71177915e-01
  2.96781790e+00  2.96781790e+00  2.96781790e+00  1.70922250e+01
  1.70922250e+01  1.70922250e+01  8.69818768e+01  8.69818768e+01
  8.69818768e+01  1.81906621e+02  4.19379924e+02  4.19379924e+02
  4.19379924e+02  1.27314375e+03  1.27314375e+03  1.27314375e+03
  1.91362646e+03  2.97521814e+03  2.97521814e+03  2.97521814e+03
  6.60435380e+03  6.60435380e+03  6.60435380e+03  8.27201370e+03
  2.46597988e+04  7.54561331e+04]
E1 = -727.4151090680504  E_coul = 201.9514079693188
cycle= 1 E= -525.463701098732  delta_E= -9.09e-13  |g|= 2.66e-08  |ddm|= 1.14e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4151090680504  E_coul = 201.9514079693188
  HOMO = -0.556333513484219  LUMO = 0.671177918978621
  mo_energy =
[-1.18128445e+02 -1.21581951e+01 -9.52270664e+00 -9.52270664e+00
 -9.52270664e+00 -1.23238641e+00 -5.56333513e-01 -5.56333513e-01
 -5.56333513e-01  6.71177919e-01  6.71177919e-01  6.71177919e-01
  2.96781791e+00  2.96781791e+00  2.96781791e+00  1.70922251e+01
  1.70922251e+01  1.70922251e+01  8.69818769e+01  8.69818769e+01
  8.69818769e+01  1.81906621e+02  4.19379924e+02  4.19379924e+02
  4.19379924e+02  1.27314375e+03  1.27314375e+03  1.27314375e+03
  1.91362646e+03  2.97521814e+03  2.97521814e+03  2.97521814e+03
  6.60435380e+03  6.60435380e+03  6.60435380e+03  8.27201370e+03
  2.46597988e+04  7.54561331e+04]
E1 = -727.4151089759627  E_coul = 201.95140787723182
Extra cycle  E= -525.463701098731  delta_E= 7.96e-13  |g|= 5.34e-09  |ddm|= 8.86e-09
    CPU time for scf_cycle      1.17 sec, wall time      0.41 sec
exp = [2.61825079e+04 7.61825078e+03 3.61825078e+03 1.61825074e+03
 2.39783922e+02 5.18984224e+01 4.40133927e+00 4.08565572e-01
 1.36279300e+03 6.65180724e+02 3.03320634e+02 3.16146449e+02
 4.93002407e+01 4.75493665e+00 1.47466130e+01 3.75572428e-01
 1.24145884e+00 2.14593811e-01]
grad_E = [-1.98038071e-06  2.16856816e-05  4.32619640e-05  6.65097330e-04
  9.24044336e-04 -6.99704751e-03 -1.96497700e-01  1.78031826e-01
  1.35311658e-06  2.01582426e-05  1.09171356e-04  9.61603158e-05
 -1.25653735e-03 -7.44022862e-03  7.83463769e-03 -3.67121012e-01
  8.69927015e-02  3.17831999e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078521        1
[INPUT] 0    0    [1    /1   ]  7618.25076119        1
[INPUT] 0    0    [1    /1   ]  3618.25073751        1
[INPUT] 0    0    [1    /1   ]  1618.25005499        1
[INPUT] 0    0    [1    /1   ]  239.782967598        1
[INPUT] 0    0    [1    /1   ]  51.9056746018        1
[INPUT] 0    0    [1    /1   ]  4.60496882377        1
[INPUT] 0    0    [1    /1   ]  0.173132207094       1
[INPUT] 1    0    [1    /1   ]  1362.79300175        1
[INPUT] 1    0    [1    /1   ]  665.180703595        1
[INPUT] 1    0    [1    /1   ]  303.320521849        1
[INPUT] 1    0    [1    /1   ]  316.146350352        1
[INPUT] 1    0    [1    /1   ]  49.3015536007        1
[INPUT] 1    0    [1    /1   ]  4.76383801519        1
[INPUT] 1    0    [1    /1   ]  14.738277821         1
[INPUT] 1    0    [1    /1   ]  0.561150068631       1
[INPUT] 1    0    [1    /1   ]  1.17910602916        1
[INPUT] 1    0    [1    /1   ]  0.26841630501        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507852102946, 1.0]], [0, [7618.250761190774, 1.0]], [0, [3618.2507375099235, 1.0]], [0, [1618.2500549949882, 1.0]], [0, [239.78296759804624, 1.0]], [0, [51.905674601759195, 1.0]], [0, [4.604968823773825, 1.0]], [0, [0.1731322070938385, 1.0]], [1, [1362.793001749282, 1.0]], [1, [665.1807035954655, 1.0]], [1, [303.32052184870685, 1.0]], [1, [316.1463503517859, 1.0]], [1, [49.301553600680236, 1.0]], [1, [4.763838015185013, 1.0]], [1, [14.738277821009685, 1.0]], [1, [0.5611500686312084, 1.0]], [1, [1.179106029157235, 1.0]], [1, [0.26841630501021035, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5078521]
bas 1, expnt(s) = [7618.25076119]
bas 2, expnt(s) = [3618.25073751]
bas 3, expnt(s) = [1618.25005499]
bas 4, expnt(s) = [239.7829676]
bas 5, expnt(s) = [51.9056746]
bas 6, expnt(s) = [4.60496882]
bas 7, expnt(s) = [0.17313221]
bas 8, expnt(s) = [1362.79300175]
bas 9, expnt(s) = [665.1807036]
bas 10, expnt(s) = [303.32052185]
bas 11, expnt(s) = [316.14635035]
bas 12, expnt(s) = [49.3015536]
bas 13, expnt(s) = [4.76383802]
bas 14, expnt(s) = [14.73827782]
bas 15, expnt(s) = [0.56115007]
bas 16, expnt(s) = [1.17910603]
bas 17, expnt(s) = [0.26841631]
CPU time:        16.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825076e+03 2.06018619e+03
 3.61825074e+03 1.17866129e+03 1.61825005e+03 6.44613278e+02
 2.39782968e+02 1.53949674e+02 5.19056746e+01 4.88569278e+01
 4.60496882e+00 7.94209440e+00 1.73132207e-01 6.78107306e-01
 1.36279300e+03 2.41558187e+04 6.65180704e+02 9.85505257e+03
 3.03320522e+02 3.69284973e+03 3.16146350e+02 3.88905969e+03
 4.93015536e+01 3.81118604e+02 4.76383802e+00 2.05319702e+01
 1.47382778e+01 8.42447442e+01 5.61150069e-01 1.41688032e+00
 1.17910603e+00 3.58447427e+00 2.68416305e-01 5.63631828e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.61524106727513
cond(S) = 83658.3846889226
E1 = -715.9614777283404  E_coul = 194.4446948233942
init E= -521.516782904946
    CPU time for initialize scf      0.70 sec, wall time      0.08 sec
  HOMO = -0.889630048776361  LUMO = 0.733469519774505
  mo_energy =
[-1.18518550e+02 -1.26849422e+01 -1.00751026e+01 -1.00751026e+01
 -1.00751026e+01 -1.16698987e+00 -8.89630049e-01 -8.89630049e-01
 -8.89630049e-01  7.33469520e-01  7.33469520e-01  7.33469520e-01
  3.34697422e+00  3.34697422e+00  3.34697422e+00  1.72274501e+01
  1.72274501e+01  1.72274501e+01  8.69197653e+01  8.69197653e+01
  8.69197653e+01  1.81613050e+02  4.19255916e+02  4.19255916e+02
  4.19255916e+02  1.27303201e+03  1.27303201e+03  1.27303201e+03
  1.91358024e+03  2.97515832e+03  2.97515832e+03  2.97515832e+03
  6.60440112e+03  6.60440112e+03  6.60440112e+03  8.27210002e+03
  2.46599757e+04  7.54563956e+04]
E1 = -724.0924295626618  E_coul = 199.15139569392937
cycle= 1 E= -524.941033868732  delta_E= -3.42  |g|= 0.219  |ddm|= 0.916
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460494
diis-c [-0.21205462  1.        ]
  HOMO = -0.668662216591319  LUMO = 0.909087558941996
  mo_energy =
[-1.18303567e+02 -1.23465169e+01 -9.73724381e+00 -9.73724381e+00
 -9.73724381e+00 -1.02923186e+00 -6.68662217e-01 -6.68662217e-01
 -6.68662217e-01  9.09087559e-01  9.09087559e-01  9.09087559e-01
  3.59689650e+00  3.59689650e+00  3.59689650e+00  1.75482692e+01
  1.75482692e+01  1.75482692e+01  8.72168025e+01  8.72168025e+01
  8.72168025e+01  1.81896750e+02  4.19483868e+02  4.19483868e+02
  4.19483868e+02  1.27320825e+03  1.27320825e+03  1.27320825e+03
  1.91362036e+03  2.97526480e+03  2.97526480e+03  2.97526480e+03
  6.60438188e+03  6.60438188e+03  6.60438188e+03  8.27199162e+03
  2.46597684e+04  7.54560932e+04]
E1 = -723.1838700582598  E_coul = 198.2389391420101
cycle= 2 E= -524.94493091625  delta_E= -0.0039  |g|= 0.0306  |ddm|= 0.139
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0514058
diis-c [-0.00260874  0.01254813  0.98745187]
  HOMO = -0.691038852686284  LUMO = 0.898411344963781
  mo_energy =
[-1.18388104e+02 -1.24159648e+01 -9.80734841e+00 -9.80734841e+00
 -9.80734841e+00 -1.04808723e+00 -6.91038853e-01 -6.91038853e-01
 -6.91038853e-01  8.98411345e-01  8.98411345e-01  8.98411345e-01
  3.56711057e+00  3.56711057e+00  3.56711057e+00  1.74865175e+01
  1.74865175e+01  1.74865175e+01  8.71394852e+01  8.71394852e+01
  8.71394852e+01  1.81813830e+02  4.19399894e+02  4.19399894e+02
  4.19399894e+02  1.27312288e+03  1.27312288e+03  1.27312288e+03
  1.91353430e+03  2.97517889e+03  2.97517889e+03  2.97517889e+03
  6.60429552e+03  6.60429552e+03  6.60429552e+03  8.27190499e+03
  2.46596815e+04  7.54560061e+04]
E1 = -723.330597382916  E_coul = 198.38559339347887
cycle= 3 E= -524.945003989437  delta_E= -7.31e-05  |g|= 0.0071  |ddm|= 0.014
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0126801
diis-c [-9.22013243e-06  2.25197390e-03  1.92242048e-01  8.05505978e-01]
  HOMO = -0.689029233690073  LUMO = 0.899383610248075
  mo_energy =
[-1.18374766e+02 -1.24076861e+01 -9.79898503e+00 -9.79898503e+00
 -9.79898503e+00 -1.04644709e+00 -6.89029234e-01 -6.89029234e-01
 -6.89029234e-01  8.99383610e-01  8.99383610e-01  8.99383610e-01
  3.56995900e+00  3.56995900e+00  3.56995900e+00  1.74936488e+01
  1.74936488e+01  1.74936488e+01  8.71503247e+01  8.71503247e+01
  8.71503247e+01  1.81826718e+02  4.19413093e+02  4.19413093e+02
  4.19413093e+02  1.27313670e+03  1.27313670e+03  1.27313670e+03
  1.91354850e+03  2.97519299e+03  2.97519299e+03  2.97519299e+03
  6.60430981e+03  6.60430981e+03  6.60430981e+03  8.27191938e+03
  2.46596959e+04  7.54560206e+04]
E1 = -723.3103744160859  E_coul = 198.3653683659623
cycle= 4 E= -524.945006050124  delta_E= -2.06e-06  |g|= 0.000244  |ddm|= 0.00197
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000404613
diis-c [-4.18574837e-09 -1.82109756e-05  4.19375331e-03 -1.52768602e-02
  1.01110132e+00]
  HOMO = -0.688917765828699  LUMO = 0.899434373260774
  mo_energy =
[-1.18374248e+02 -1.24072505e+01 -9.79854577e+00 -9.79854577e+00
 -9.79854577e+00 -1.04635649e+00 -6.88917766e-01 -6.88917766e-01
 -6.88917766e-01  8.99434373e-01  8.99434373e-01  8.99434373e-01
  3.57011683e+00  3.57011683e+00  3.57011683e+00  1.74940266e+01
  1.74940266e+01  1.74940266e+01  8.71508083e+01  8.71508083e+01
  8.71508083e+01  1.81827234e+02  4.19413607e+02  4.19413607e+02
  4.19413607e+02  1.27313721e+03  1.27313721e+03  1.27313721e+03
  1.91354900e+03  2.97519350e+03  2.97519350e+03  2.97519350e+03
  6.60431030e+03  6.60431030e+03  6.60431030e+03  8.27191986e+03
  2.46596964e+04  7.54560210e+04]
E1 = -723.3093511693941  E_coul = 198.36434511432253
cycle= 5 E= -524.945006055072  delta_E= -4.95e-09  |g|= 9.2e-06  |ddm|= 0.000177
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.00137e-05
diis-c [-9.94632861e-12  3.72044213e-06 -5.85633728e-04  1.48548203e-04
 -5.89164425e-02  1.05934981e+00]
  HOMO = -0.688923277827604  LUMO = 0.899431240359678
  mo_energy =
[-1.18374260e+02 -1.24072609e+01 -9.79855615e+00 -9.79855615e+00
 -9.79855615e+00 -1.04636150e+00 -6.88923278e-01 -6.88923278e-01
 -6.88923278e-01  8.99431240e-01  8.99431240e-01  8.99431240e-01
  3.57011003e+00  3.57011003e+00  3.57011003e+00  1.74940167e+01
  1.74940167e+01  1.74940167e+01  8.71507970e+01  8.71507970e+01
  8.71507970e+01  1.81827222e+02  4.19413595e+02  4.19413595e+02
  4.19413595e+02  1.27313720e+03  1.27313720e+03  1.27313720e+03
  1.91354899e+03  2.97519349e+03  2.97519349e+03  2.97519349e+03
  6.60431029e+03  6.60431029e+03  6.60431029e+03  8.27191985e+03
  2.46596964e+04  7.54560210e+04]
E1 = -723.3093636089135  E_coul = 198.36435755383187
cycle= 6 E= -524.945006055082  delta_E= -1.01e-11  |g|= 3.9e-07  |ddm|= 1.27e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -723.3093636089135  E_coul = 198.36435755383187
  HOMO = -0.688923505142531  LUMO = 0.899431111896237
  mo_energy =
[-1.18374261e+02 -1.24072614e+01 -9.79855664e+00 -9.79855664e+00
 -9.79855664e+00 -1.04636171e+00 -6.88923505e-01 -6.88923505e-01
 -6.88923505e-01  8.99431112e-01  8.99431112e-01  8.99431112e-01
  3.57010974e+00  3.57010974e+00  3.57010974e+00  1.74940162e+01
  1.74940162e+01  1.74940162e+01  8.71507965e+01  8.71507965e+01
  8.71507965e+01  1.81827222e+02  4.19413595e+02  4.19413595e+02
  4.19413595e+02  1.27313720e+03  1.27313720e+03  1.27313720e+03
  1.91354898e+03  2.97519348e+03  2.97519348e+03  2.97519348e+03
  6.60431029e+03  6.60431029e+03  6.60431029e+03  8.27191985e+03
  2.46596964e+04  7.54560210e+04]
E1 = -723.3093643098463  E_coul = 198.36435825476454
Extra cycle  E= -524.945006055082  delta_E= -1.14e-13  |g|= 5.29e-08  |ddm|= 4.6e-07
    CPU time for scf_cycle      0.93 sec, wall time      0.31 sec
exp = [2.61825079e+04 7.61825076e+03 3.61825074e+03 1.61825005e+03
 2.39782968e+02 5.19056746e+01 4.60496882e+00 1.73132207e-01
 1.36279300e+03 6.65180704e+02 3.03320522e+02 3.16146350e+02
 4.93015536e+01 4.76383802e+00 1.47382778e+01 5.61150069e-01
 1.17910603e+00 2.68416305e-01]
E = -524.9450060550818
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078503        1
[INPUT] 0    0    [1    /1   ]  7618.25078115        1
[INPUT] 0    0    [1    /1   ]  3618.25077733        1
[INPUT] 0    0    [1    /1   ]  1618.25066717        1
[INPUT] 0    0    [1    /1   ]  239.783821382        1
[INPUT] 0    0    [1    /1   ]  51.8991868372        1
[INPUT] 0    0    [1    /1   ]  4.42280345421        1
[INPUT] 0    0    [1    /1   ]  0.383749013052       1
[INPUT] 1    0    [1    /1   ]  1362.793003          1
[INPUT] 1    0    [1    /1   ]  665.180722168        1
[INPUT] 1    0    [1    /1   ]  303.320622446        1
[INPUT] 1    0    [1    /1   ]  316.14643896         1
[INPUT] 1    0    [1    /1   ]  49.3003791212        1
[INPUT] 1    0    [1    /1   ]  4.75587492182        1
[INPUT] 1    0    [1    /1   ]  14.7457343714        1
[INPUT] 1    0    [1    /1   ]  0.395133794458       1
[INPUT] 1    0    [1    /1   ]  1.23488635295        1
[INPUT] 1    0    [1    /1   ]  0.220267132142       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.50785028005, 1.0]], [0, [7618.250781151216, 1.0]], [0, [3618.250777329396, 1.0]], [0, [1618.2506671729282, 1.0]], [0, [239.78382138184597, 1.0]], [0, [51.8991868372404, 1.0]], [0, [4.422803454205358, 1.0]], [0, [0.38374901305231707, 1.0]], [1, [1362.7930029972345, 1.0]], [1, [665.1807221679013, 1.0]], [1, [303.3206224457477, 1.0]], [1, [316.14643895965054, 1.0]], [1, [49.30037912123143, 1.0]], [1, [4.7558749218216265, 1.0]], [1, [14.745734371425474, 1.0]], [1, [0.3951337944580132, 1.0]], [1, [1.2348863529490097, 1.0]], [1, [0.22026713214196847, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785028]
bas 1, expnt(s) = [7618.25078115]
bas 2, expnt(s) = [3618.25077733]
bas 3, expnt(s) = [1618.25066717]
bas 4, expnt(s) = [239.78382138]
bas 5, expnt(s) = [51.89918684]
bas 6, expnt(s) = [4.42280345]
bas 7, expnt(s) = [0.38374901]
bas 8, expnt(s) = [1362.793003]
bas 9, expnt(s) = [665.18072217]
bas 10, expnt(s) = [303.32062245]
bas 11, expnt(s) = [316.14643896]
bas 12, expnt(s) = [49.30037912]
bas 13, expnt(s) = [4.75587492]
bas 14, expnt(s) = [14.74573437]
bas 15, expnt(s) = [0.39513379]
bas 16, expnt(s) = [1.23488635]
bas 17, expnt(s) = [0.22026713]
CPU time:        17.54
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825078e+03 2.06018620e+03
 3.61825078e+03 1.17866129e+03 1.61825067e+03 6.44613461e+02
 2.39783821e+02 1.53950085e+02 5.18991868e+01 4.88523477e+01
 4.42280345e+00 7.70527697e+00 3.83749013e-01 1.23182915e+00
 1.36279300e+03 2.41558187e+04 6.65180722e+02 9.85505291e+03
 3.03320622e+02 3.69285126e+03 3.16146439e+02 3.88906105e+03
 4.93003791e+01 3.81107255e+02 4.75587492e+00 2.04890783e+01
 1.47457344e+01 8.42980251e+01 3.95133794e-01 9.13933531e-01
 1.23488635e+00 3.79767794e+00 2.20267132e-01 4.40221769e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.96504422685823
cond(S) = 83533.14277172417
E1 = -726.4929203889118  E_coul = 202.45371812790287
init E= -524.039202261009
    CPU time for initialize scf      0.20 sec, wall time      0.05 sec
  HOMO = -0.569984701804777  LUMO = 0.6911302836283
  mo_energy =
[-1.17941213e+02 -1.21336339e+01 -9.49449020e+00 -9.49449020e+00
 -9.49449020e+00 -1.23984716e+00 -5.69984702e-01 -5.69984702e-01
 -5.69984702e-01  6.91130284e-01  6.91130284e-01  6.91130284e-01
  3.04414329e+00  3.04414329e+00  3.04414329e+00  1.71826625e+01
  1.71826625e+01  1.71826625e+01  8.71120134e+01  8.71120134e+01
  8.71120134e+01  1.82038637e+02  4.19580827e+02  4.19580827e+02
  4.19580827e+02  1.27339657e+03  1.27339657e+03  1.27339657e+03
  1.91400636e+03  2.97553990e+03  2.97553990e+03  2.97553990e+03
  6.60480037e+03  6.60480037e+03  6.60480037e+03  8.27254187e+03
  2.46604256e+04  7.54568545e+04]
E1 = -727.016569768112  E_coul = 201.54403014475005
cycle= 1 E= -525.472539623362  delta_E= -1.43  |g|= 0.193  |ddm|= 0.685
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.46022
diis-c [-0.21180254  1.        ]
  HOMO = -0.567352233474119  LUMO = 0.700743161230114
  mo_energy =
[-1.18171147e+02 -1.21884590e+01 -9.55388800e+00 -9.55388800e+00
 -9.55388800e+00 -1.24107752e+00 -5.67352233e-01 -5.67352233e-01
 -5.67352233e-01  7.00743161e-01  7.00743161e-01  7.00743161e-01
  3.04162290e+00  3.04162290e+00  3.04162290e+00  1.71315594e+01
  1.71315594e+01  1.71315594e+01  8.69873810e+01  8.69873810e+01
  8.69873810e+01  1.81875557e+02  4.19364845e+02  4.19364845e+02
  4.19364845e+02  1.27312272e+03  1.27312272e+03  1.27312272e+03
  1.91359366e+03  2.97519443e+03  2.97519443e+03  2.97519443e+03
  6.60432779e+03  6.60432779e+03  6.60432779e+03  8.27197947e+03
  2.46597640e+04  7.54560977e+04]
E1 = -727.2122765024751  E_coul = 201.73945877191508
cycle= 2 E= -525.47281773056  delta_E= -0.000278  |g|= 0.0151  |ddm|= 0.0441
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0261282
diis-c [-5.47414464e-04  2.46799968e-02  9.75320003e-01]
  HOMO = -0.564385989884044  LUMO = 0.702024311983005
  mo_energy =
[-1.18142460e+02 -1.21751455e+01 -9.54029887e+00 -9.54029887e+00
 -9.54029887e+00 -1.23743452e+00 -5.64385990e-01 -5.64385990e-01
 -5.64385990e-01  7.02024312e-01  7.02024312e-01  7.02024312e-01
  3.04587847e+00  3.04587847e+00  3.04587847e+00  1.71430964e+01
  1.71430964e+01  1.71430964e+01  8.70083844e+01  8.70083844e+01
  8.70083844e+01  1.81903228e+02  4.19393217e+02  4.19393217e+02
  4.19393217e+02  1.27315317e+03  1.27315317e+03  1.27315317e+03
  1.91362539e+03  2.97522584e+03  2.97522584e+03  2.97522584e+03
  6.60435969e+03  6.60435969e+03  6.60435969e+03  8.27201153e+03
  2.46597960e+04  7.54561296e+04]
E1 = -727.1772180377435  E_coul = 201.70439422497614
cycle= 3 E= -525.472823812767  delta_E= -6.08e-06  |g|= 0.00204  |ddm|= 0.00404
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00390519
diis-c [-1.88921959e-07 -9.47426074e-04  1.22879049e-01  8.78068377e-01]
  HOMO = -0.564707558012618  LUMO = 0.701921734648858
  mo_energy =
[-1.18146140e+02 -1.21770514e+01 -9.54226683e+00 -9.54226683e+00
 -9.54226683e+00 -1.23786967e+00 -5.64707558e-01 -5.64707558e-01
 -5.64707558e-01  7.01921735e-01  7.01921735e-01  7.01921735e-01
  3.04537926e+00  3.04537926e+00  3.04537926e+00  1.71414428e+01
  1.71414428e+01  1.71414428e+01  8.70055709e+01  8.70055709e+01
  8.70055709e+01  1.81899733e+02  4.19389582e+02  4.19389582e+02
  4.19389582e+02  1.27314929e+03  1.27314929e+03  1.27314929e+03
  1.91362129e+03  2.97522182e+03  2.97522182e+03  2.97522182e+03
  6.60435554e+03  6.60435554e+03  6.60435554e+03  8.27200730e+03
  2.46597917e+04  7.54561253e+04]
E1 = -727.1833576200988  E_coul = 201.71053363866332
cycle= 4 E= -525.472823981436  delta_E= -1.69e-07  |g|= 9.49e-05  |ddm|= 0.00104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.84043e-05
diis-c [-7.09850462e-09  4.19561361e-05 -8.88084654e-03 -4.99034823e-02
  1.05874237e+00]
  HOMO = -0.564646272300379  LUMO = 0.701949493475438
  mo_energy =
[-1.18146014e+02 -1.21769316e+01 -9.54214702e+00 -9.54214702e+00
 -9.54214702e+00 -1.23779858e+00 -5.64646272e-01 -5.64646272e-01
 -5.64646272e-01  7.01949493e-01  7.01949493e-01  7.01949493e-01
  3.04545612e+00  3.04545612e+00  3.04545612e+00  1.71415571e+01
  1.71415571e+01  1.71415571e+01  8.70056948e+01  8.70056948e+01
  8.70056948e+01  1.81899859e+02  4.19389708e+02  4.19389708e+02
  4.19389708e+02  1.27314942e+03  1.27314942e+03  1.27314942e+03
  1.91362141e+03  2.97522194e+03  2.97522194e+03  2.97522194e+03
  6.60435566e+03  6.60435566e+03  6.60435566e+03  8.27200742e+03
  2.46597918e+04  7.54561254e+04]
E1 = -727.1832340810389  E_coul = 201.71041009815707
cycle= 5 E= -525.472823982882  delta_E= -1.45e-09  |g|= 8.84e-06  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.40022e-05
diis-c [-1.35560184e-11  4.85908719e-06 -5.87790667e-04 -7.53108371e-03
  6.16340030e-03  1.00195061e+00]
  HOMO = -0.564647938856175  LUMO = 0.701949221134465
  mo_energy =
[-1.18146029e+02 -1.21769430e+01 -9.54215867e+00 -9.54215867e+00
 -9.54215867e+00 -1.23780117e+00 -5.64647939e-01 -5.64647939e-01
 -5.64647939e-01  7.01949221e-01  7.01949221e-01  7.01949221e-01
  3.04545342e+00  3.04545342e+00  3.04545342e+00  1.71415474e+01
  1.71415474e+01  1.71415474e+01  8.70056815e+01  8.70056815e+01
  8.70056815e+01  1.81899845e+02  4.19389693e+02  4.19389693e+02
  4.19389693e+02  1.27314940e+03  1.27314940e+03  1.27314940e+03
  1.91362140e+03  2.97522193e+03  2.97522193e+03  2.97522193e+03
  6.60435564e+03  6.60435564e+03  6.60435564e+03  8.27200741e+03
  2.46597918e+04  7.54561254e+04]
E1 = -727.1832747088348  E_coul = 201.7104507259422
cycle= 6 E= -525.472823982893  delta_E= -1.07e-11  |g|= 5.3e-07  |ddm|= 1.42e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.1832747088348  E_coul = 201.7104507259422
  HOMO = -0.564647610419211  LUMO = 0.701949358059803
  mo_energy =
[-1.18146028e+02 -1.21769421e+01 -9.54215775e+00 -9.54215775e+00
 -9.54215775e+00 -1.23780077e+00 -5.64647610e-01 -5.64647610e-01
 -5.64647610e-01  7.01949358e-01  7.01949358e-01  7.01949358e-01
  3.04545386e+00  3.04545386e+00  3.04545386e+00  1.71415482e+01
  1.71415482e+01  1.71415482e+01  8.70056825e+01  8.70056825e+01
  8.70056825e+01  1.81899846e+02  4.19389694e+02  4.19389694e+02
  4.19389694e+02  1.27314941e+03  1.27314941e+03  1.27314941e+03
  1.91362140e+03  2.97522193e+03  2.97522193e+03  2.97522193e+03
  6.60435565e+03  6.60435565e+03  6.60435565e+03  8.27200741e+03
  2.46597918e+04  7.54561254e+04]
E1 = -727.183272890442  E_coul = 201.71044890755005
Extra cycle  E= -525.472823982892  delta_E= 5.68e-13  |g|= 1.05e-07  |ddm|= 3.82e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.28 sec
exp = [2.61825079e+04 7.61825078e+03 3.61825078e+03 1.61825067e+03
 2.39783821e+02 5.18991868e+01 4.42280345e+00 3.83749013e-01
 1.36279300e+03 6.65180722e+02 3.03320622e+02 3.16146439e+02
 4.93003791e+01 4.75587492e+00 1.47457344e+01 3.95133794e-01
 1.23488635e+00 2.20267132e-01]
E = -525.472823982892
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078503        1
[INPUT] 0    0    [1    /1   ]  7618.25078115        1
[INPUT] 0    0    [1    /1   ]  3618.25077733        1
[INPUT] 0    0    [1    /1   ]  1618.25066717        1
[INPUT] 0    0    [1    /1   ]  239.783821382        1
[INPUT] 0    0    [1    /1   ]  51.8991868372        1
[INPUT] 0    0    [1    /1   ]  4.42280345421        1
[INPUT] 0    0    [1    /1   ]  0.383749013052       1
[INPUT] 1    0    [1    /1   ]  1362.793003          1
[INPUT] 1    0    [1    /1   ]  665.180722168        1
[INPUT] 1    0    [1    /1   ]  303.320622446        1
[INPUT] 1    0    [1    /1   ]  316.14643896         1
[INPUT] 1    0    [1    /1   ]  49.3003791212        1
[INPUT] 1    0    [1    /1   ]  4.75587492182        1
[INPUT] 1    0    [1    /1   ]  14.7457343714        1
[INPUT] 1    0    [1    /1   ]  0.395133794458       1
[INPUT] 1    0    [1    /1   ]  1.23488635295        1
[INPUT] 1    0    [1    /1   ]  0.220267132142       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.50785028005, 1.0]], [0, [7618.250781151216, 1.0]], [0, [3618.250777329396, 1.0]], [0, [1618.2506671729282, 1.0]], [0, [239.78382138184597, 1.0]], [0, [51.8991868372404, 1.0]], [0, [4.422803454205358, 1.0]], [0, [0.38374901305231707, 1.0]], [1, [1362.7930029972345, 1.0]], [1, [665.1807221679013, 1.0]], [1, [303.3206224457477, 1.0]], [1, [316.14643895965054, 1.0]], [1, [49.30037912123143, 1.0]], [1, [4.7558749218216265, 1.0]], [1, [14.745734371425474, 1.0]], [1, [0.3951337944580132, 1.0]], [1, [1.2348863529490097, 1.0]], [1, [0.22026713214196847, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785028]
bas 1, expnt(s) = [7618.25078115]
bas 2, expnt(s) = [3618.25077733]
bas 3, expnt(s) = [1618.25066717]
bas 4, expnt(s) = [239.78382138]
bas 5, expnt(s) = [51.89918684]
bas 6, expnt(s) = [4.42280345]
bas 7, expnt(s) = [0.38374901]
bas 8, expnt(s) = [1362.793003]
bas 9, expnt(s) = [665.18072217]
bas 10, expnt(s) = [303.32062245]
bas 11, expnt(s) = [316.14643896]
bas 12, expnt(s) = [49.30037912]
bas 13, expnt(s) = [4.75587492]
bas 14, expnt(s) = [14.74573437]
bas 15, expnt(s) = [0.39513379]
bas 16, expnt(s) = [1.23488635]
bas 17, expnt(s) = [0.22026713]
CPU time:        18.07
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825078e+03 2.06018620e+03
 3.61825078e+03 1.17866129e+03 1.61825067e+03 6.44613461e+02
 2.39783821e+02 1.53950085e+02 5.18991868e+01 4.88523477e+01
 4.42280345e+00 7.70527697e+00 3.83749013e-01 1.23182915e+00
 1.36279300e+03 2.41558187e+04 6.65180722e+02 9.85505291e+03
 3.03320622e+02 3.69285126e+03 3.16146439e+02 3.88906105e+03
 4.93003791e+01 3.81107255e+02 4.75587492e+00 2.04890783e+01
 1.47457344e+01 8.42980251e+01 3.95133794e-01 9.13933531e-01
 1.23488635e+00 3.79767794e+00 2.20267132e-01 4.40221769e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.96504422685823
cond(S) = 83533.14277172417
E1 = -726.4929203889118  E_coul = 202.45371812790287
init E= -524.039202261009
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.569984701804777  LUMO = 0.6911302836283
  mo_energy =
[-1.17941213e+02 -1.21336339e+01 -9.49449020e+00 -9.49449020e+00
 -9.49449020e+00 -1.23984716e+00 -5.69984702e-01 -5.69984702e-01
 -5.69984702e-01  6.91130284e-01  6.91130284e-01  6.91130284e-01
  3.04414329e+00  3.04414329e+00  3.04414329e+00  1.71826625e+01
  1.71826625e+01  1.71826625e+01  8.71120134e+01  8.71120134e+01
  8.71120134e+01  1.82038637e+02  4.19580827e+02  4.19580827e+02
  4.19580827e+02  1.27339657e+03  1.27339657e+03  1.27339657e+03
  1.91400636e+03  2.97553990e+03  2.97553990e+03  2.97553990e+03
  6.60480037e+03  6.60480037e+03  6.60480037e+03  8.27254187e+03
  2.46604256e+04  7.54568545e+04]
E1 = -727.016569768112  E_coul = 201.54403014475005
cycle= 1 E= -525.472539623362  delta_E= -1.43  |g|= 0.193  |ddm|= 0.685
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.46022
diis-c [-0.21180254  1.        ]
  HOMO = -0.567352233474119  LUMO = 0.700743161230114
  mo_energy =
[-1.18171147e+02 -1.21884590e+01 -9.55388800e+00 -9.55388800e+00
 -9.55388800e+00 -1.24107752e+00 -5.67352233e-01 -5.67352233e-01
 -5.67352233e-01  7.00743161e-01  7.00743161e-01  7.00743161e-01
  3.04162290e+00  3.04162290e+00  3.04162290e+00  1.71315594e+01
  1.71315594e+01  1.71315594e+01  8.69873810e+01  8.69873810e+01
  8.69873810e+01  1.81875557e+02  4.19364845e+02  4.19364845e+02
  4.19364845e+02  1.27312272e+03  1.27312272e+03  1.27312272e+03
  1.91359366e+03  2.97519443e+03  2.97519443e+03  2.97519443e+03
  6.60432779e+03  6.60432779e+03  6.60432779e+03  8.27197947e+03
  2.46597640e+04  7.54560977e+04]
E1 = -727.2122765024751  E_coul = 201.73945877191508
cycle= 2 E= -525.47281773056  delta_E= -0.000278  |g|= 0.0151  |ddm|= 0.0441
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0261282
diis-c [-5.47414464e-04  2.46799968e-02  9.75320003e-01]
  HOMO = -0.564385989884044  LUMO = 0.702024311983005
  mo_energy =
[-1.18142460e+02 -1.21751455e+01 -9.54029887e+00 -9.54029887e+00
 -9.54029887e+00 -1.23743452e+00 -5.64385990e-01 -5.64385990e-01
 -5.64385990e-01  7.02024312e-01  7.02024312e-01  7.02024312e-01
  3.04587847e+00  3.04587847e+00  3.04587847e+00  1.71430964e+01
  1.71430964e+01  1.71430964e+01  8.70083844e+01  8.70083844e+01
  8.70083844e+01  1.81903228e+02  4.19393217e+02  4.19393217e+02
  4.19393217e+02  1.27315317e+03  1.27315317e+03  1.27315317e+03
  1.91362539e+03  2.97522584e+03  2.97522584e+03  2.97522584e+03
  6.60435969e+03  6.60435969e+03  6.60435969e+03  8.27201153e+03
  2.46597960e+04  7.54561296e+04]
E1 = -727.1772180377435  E_coul = 201.70439422497614
cycle= 3 E= -525.472823812767  delta_E= -6.08e-06  |g|= 0.00204  |ddm|= 0.00404
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00390519
diis-c [-1.88921959e-07 -9.47426074e-04  1.22879049e-01  8.78068377e-01]
  HOMO = -0.564707558012618  LUMO = 0.701921734648858
  mo_energy =
[-1.18146140e+02 -1.21770514e+01 -9.54226683e+00 -9.54226683e+00
 -9.54226683e+00 -1.23786967e+00 -5.64707558e-01 -5.64707558e-01
 -5.64707558e-01  7.01921735e-01  7.01921735e-01  7.01921735e-01
  3.04537926e+00  3.04537926e+00  3.04537926e+00  1.71414428e+01
  1.71414428e+01  1.71414428e+01  8.70055709e+01  8.70055709e+01
  8.70055709e+01  1.81899733e+02  4.19389582e+02  4.19389582e+02
  4.19389582e+02  1.27314929e+03  1.27314929e+03  1.27314929e+03
  1.91362129e+03  2.97522182e+03  2.97522182e+03  2.97522182e+03
  6.60435554e+03  6.60435554e+03  6.60435554e+03  8.27200730e+03
  2.46597917e+04  7.54561253e+04]
E1 = -727.1833576200988  E_coul = 201.71053363866332
cycle= 4 E= -525.472823981436  delta_E= -1.69e-07  |g|= 9.49e-05  |ddm|= 0.00104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.84043e-05
diis-c [-7.09850462e-09  4.19561361e-05 -8.88084654e-03 -4.99034823e-02
  1.05874237e+00]
  HOMO = -0.564646272300379  LUMO = 0.701949493475438
  mo_energy =
[-1.18146014e+02 -1.21769316e+01 -9.54214702e+00 -9.54214702e+00
 -9.54214702e+00 -1.23779858e+00 -5.64646272e-01 -5.64646272e-01
 -5.64646272e-01  7.01949493e-01  7.01949493e-01  7.01949493e-01
  3.04545612e+00  3.04545612e+00  3.04545612e+00  1.71415571e+01
  1.71415571e+01  1.71415571e+01  8.70056948e+01  8.70056948e+01
  8.70056948e+01  1.81899859e+02  4.19389708e+02  4.19389708e+02
  4.19389708e+02  1.27314942e+03  1.27314942e+03  1.27314942e+03
  1.91362141e+03  2.97522194e+03  2.97522194e+03  2.97522194e+03
  6.60435566e+03  6.60435566e+03  6.60435566e+03  8.27200742e+03
  2.46597918e+04  7.54561254e+04]
E1 = -727.1832340810389  E_coul = 201.71041009815707
cycle= 5 E= -525.472823982882  delta_E= -1.45e-09  |g|= 8.84e-06  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.40022e-05
diis-c [-1.35560184e-11  4.85908719e-06 -5.87790667e-04 -7.53108371e-03
  6.16340030e-03  1.00195061e+00]
  HOMO = -0.564647938856175  LUMO = 0.701949221134465
  mo_energy =
[-1.18146029e+02 -1.21769430e+01 -9.54215867e+00 -9.54215867e+00
 -9.54215867e+00 -1.23780117e+00 -5.64647939e-01 -5.64647939e-01
 -5.64647939e-01  7.01949221e-01  7.01949221e-01  7.01949221e-01
  3.04545342e+00  3.04545342e+00  3.04545342e+00  1.71415474e+01
  1.71415474e+01  1.71415474e+01  8.70056815e+01  8.70056815e+01
  8.70056815e+01  1.81899845e+02  4.19389693e+02  4.19389693e+02
  4.19389693e+02  1.27314940e+03  1.27314940e+03  1.27314940e+03
  1.91362140e+03  2.97522193e+03  2.97522193e+03  2.97522193e+03
  6.60435564e+03  6.60435564e+03  6.60435564e+03  8.27200741e+03
  2.46597918e+04  7.54561254e+04]
E1 = -727.1832747088348  E_coul = 201.7104507259422
cycle= 6 E= -525.472823982893  delta_E= -1.07e-11  |g|= 5.3e-07  |ddm|= 1.42e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.1832747088348  E_coul = 201.7104507259422
  HOMO = -0.564647610419211  LUMO = 0.701949358059803
  mo_energy =
[-1.18146028e+02 -1.21769421e+01 -9.54215775e+00 -9.54215775e+00
 -9.54215775e+00 -1.23780077e+00 -5.64647610e-01 -5.64647610e-01
 -5.64647610e-01  7.01949358e-01  7.01949358e-01  7.01949358e-01
  3.04545386e+00  3.04545386e+00  3.04545386e+00  1.71415482e+01
  1.71415482e+01  1.71415482e+01  8.70056825e+01  8.70056825e+01
  8.70056825e+01  1.81899846e+02  4.19389694e+02  4.19389694e+02
  4.19389694e+02  1.27314941e+03  1.27314941e+03  1.27314941e+03
  1.91362140e+03  2.97522193e+03  2.97522193e+03  2.97522193e+03
  6.60435565e+03  6.60435565e+03  6.60435565e+03  8.27200741e+03
  2.46597918e+04  7.54561254e+04]
E1 = -727.183272890442  E_coul = 201.71044890755005
Extra cycle  E= -525.472823982892  delta_E= 5.68e-13  |g|= 1.05e-07  |ddm|= 3.82e-07
    CPU time for scf_cycle      0.38 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 83533.14277172417
E1 = -727.183272890442  E_coul = 201.71044890755005
init E= -525.472823982892
    CPU time for initialize scf      0.94 sec, wall time      0.18 sec
  HOMO = -0.564647636287361  LUMO = 0.701949350101643
  mo_energy =
[-1.18146028e+02 -1.21769422e+01 -9.54215789e+00 -9.54215789e+00
 -9.54215789e+00 -1.23780081e+00 -5.64647636e-01 -5.64647636e-01
 -5.64647636e-01  7.01949350e-01  7.01949350e-01  7.01949350e-01
  3.04545382e+00  3.04545382e+00  3.04545382e+00  1.71415481e+01
  1.71415481e+01  1.71415481e+01  8.70056824e+01  8.70056824e+01
  8.70056824e+01  1.81899846e+02  4.19389694e+02  4.19389694e+02
  4.19389694e+02  1.27314941e+03  1.27314941e+03  1.27314941e+03
  1.91362140e+03  2.97522193e+03  2.97522193e+03  2.97522193e+03
  6.60435565e+03  6.60435565e+03  6.60435565e+03  8.27200741e+03
  2.46597918e+04  7.54561254e+04]
E1 = -727.1832733291687  E_coul = 201.71044934627713
cycle= 1 E= -525.472823982892  delta_E= 3.41e-13  |g|= 2.28e-08  |ddm|= 8.88e-08
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.1832733291687  E_coul = 201.71044934627713
  HOMO = -0.564647627300375  LUMO = 0.701949353719888
  mo_energy =
[-1.18146028e+02 -1.21769422e+01 -9.54215786e+00 -9.54215786e+00
 -9.54215786e+00 -1.23780080e+00 -5.64647627e-01 -5.64647627e-01
 -5.64647627e-01  7.01949354e-01  7.01949354e-01  7.01949354e-01
  3.04545383e+00  3.04545383e+00  3.04545383e+00  1.71415481e+01
  1.71415481e+01  1.71415481e+01  8.70056824e+01  8.70056824e+01
  8.70056824e+01  1.81899846e+02  4.19389694e+02  4.19389694e+02
  4.19389694e+02  1.27314941e+03  1.27314941e+03  1.27314941e+03
  1.91362140e+03  2.97522193e+03  2.97522193e+03  2.97522193e+03
  6.60435565e+03  6.60435565e+03  6.60435565e+03  8.27200741e+03
  2.46597918e+04  7.54561254e+04]
E1 = -727.1832732507149  E_coul = 201.7104492678222
Extra cycle  E= -525.472823982893  delta_E= -1.02e-12  |g|= 4.55e-09  |ddm|= 7.08e-09
    CPU time for scf_cycle      1.07 sec, wall time      0.31 sec
exp = [2.61825079e+04 7.61825078e+03 3.61825078e+03 1.61825067e+03
 2.39783821e+02 5.18991868e+01 4.42280345e+00 3.83749013e-01
 1.36279300e+03 6.65180722e+02 3.03320622e+02 3.16146439e+02
 4.93003791e+01 4.75587492e+00 1.47457344e+01 3.95133794e-01
 1.23488635e+00 2.20267132e-01]
grad_E = [-1.98041464e-06  2.16906220e-05  4.32758411e-05  6.65295691e-04
  8.99654913e-04 -6.64521212e-03 -1.73307990e-01 -1.84550435e-01
  1.35595401e-06  2.01831407e-05  1.09321366e-04  9.62920960e-05
 -1.28017321e-03 -1.03173894e-02  8.22539020e-03 -3.00824580e-01
  6.52739119e-02  3.45556676e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078538        1
[INPUT] 0    0    [1    /1   ]  7618.25074222        1
[INPUT] 0    0    [1    /1   ]  3618.25069966        1
[INPUT] 0    0    [1    /1   ]  1618.24947306        1
[INPUT] 0    0    [1    /1   ]  239.782188222        1
[INPUT] 0    0    [1    /1   ]  51.9113794205        1
[INPUT] 0    0    [1    /1   ]  4.74761791408        1
[INPUT] 0    0    [1    /1   ]  0.442036813425       1
[INPUT] 1    0    [1    /1   ]  1362.79300056        1
[INPUT] 1    0    [1    /1   ]  665.180685914        1
[INPUT] 1    0    [1    /1   ]  303.320426058        1
[INPUT] 1    0    [1    /1   ]  316.146265978        1
[INPUT] 1    0    [1    /1   ]  49.3027020763        1
[INPUT] 1    0    [1    /1   ]  4.77527977545        1
[INPUT] 1    0    [1    /1   ]  14.7306592017        1
[INPUT] 1    0    [1    /1   ]  0.593522840551       1
[INPUT] 1    0    [1    /1   ]  1.15658717047        1
[INPUT] 1    0    [1    /1   ]  0.304004000151       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507853835064, 1.0]], [0, [7618.250742218331, 1.0]], [0, [3618.2506996561924, 1.0]], [0, [1618.2494730574083, 1.0]], [0, [239.7821882221439, 1.0]], [0, [51.911379420521605, 1.0]], [0, [4.747617914083867, 1.0]], [0, [0.4420368134247311, 1.0]], [1, [1362.793000559578, 1.0]], [1, [665.1806859142048, 1.0]], [1, [303.320426057657, 1.0]], [1, [316.1462659775985, 1.0]], [1, [49.302702076286295, 1.0]], [1, [4.775279775445608, 1.0]], [1, [14.73065920168768, 1.0]], [1, [0.5935228405511469, 1.0]], [1, [1.1565871704712567, 1.0]], [1, [0.3040040001506789, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785384]
bas 1, expnt(s) = [7618.25074222]
bas 2, expnt(s) = [3618.25069966]
bas 3, expnt(s) = [1618.24947306]
bas 4, expnt(s) = [239.78218822]
bas 5, expnt(s) = [51.91137942]
bas 6, expnt(s) = [4.74761791]
bas 7, expnt(s) = [0.44203681]
bas 8, expnt(s) = [1362.79300056]
bas 9, expnt(s) = [665.18068591]
bas 10, expnt(s) = [303.32042606]
bas 11, expnt(s) = [316.14626598]
bas 12, expnt(s) = [49.30270208]
bas 13, expnt(s) = [4.77527978]
bas 14, expnt(s) = [14.7306592]
bas 15, expnt(s) = [0.59352284]
bas 16, expnt(s) = [1.15658717]
bas 17, expnt(s) = [0.304004]
CPU time:        23.82
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825074e+03 2.06018619e+03
 3.61825070e+03 1.17866128e+03 1.61824947e+03 6.44613104e+02
 2.39782188e+02 1.53949298e+02 5.19113794e+01 4.88609550e+01
 4.74761791e+00 8.12590694e+00 4.42036813e-01 1.36964764e+00
 1.36279300e+03 2.41558186e+04 6.65180686e+02 9.85505224e+03
 3.03320426e+02 3.69284827e+03 3.16146266e+02 3.88905839e+03
 4.93027021e+01 3.81129702e+02 4.77527978e+00 2.05936306e+01
 1.47306592e+01 8.41903122e+01 5.93522841e-01 1.51978162e+00
 1.15658717e+00 3.49910807e+00 3.04004000e-01 6.58542056e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.92975014055866
cond(S) = 83713.76321139235
E1 = -728.3658399252325  E_coul = 203.95275789015164
init E= -524.413082035081
    CPU time for initialize scf      0.16 sec, wall time      0.05 sec
  HOMO = -0.54200660344582  LUMO = 1.08779531582034
  mo_energy =
[-1.17785056e+02 -1.20249159e+01 -9.36819134e+00 -9.36819134e+00
 -9.36819134e+00 -1.20795515e+00 -5.42006603e-01 -5.42006603e-01
 -5.42006603e-01  1.08779532e+00  1.08779532e+00  1.08779532e+00
  3.96238877e+00  3.96238877e+00  3.96238877e+00  1.80675406e+01
  1.80675406e+01  1.80675406e+01  8.77724913e+01  8.77724913e+01
  8.77724913e+01  1.83761370e+02  4.20081880e+02  4.20081880e+02
  4.20081880e+02  1.27384683e+03  1.27384683e+03  1.27384683e+03
  1.91528090e+03  2.97596385e+03  2.97596385e+03  2.97596385e+03
  6.60519915e+03  6.60519915e+03  6.60519915e+03  8.27367961e+03
  2.46615033e+04  7.54578660e+04]
E1 = -729.2506240119366  E_coul = 203.79935209251911
cycle= 1 E= -525.451271919417  delta_E= -1.04  |g|= 0.166  |ddm|= 0.855
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.409775
diis-c [-0.16791524  1.        ]
  HOMO = -0.51456197208869  LUMO = 1.11686549085806
  mo_energy =
[-1.17923309e+02 -1.20411481e+01 -9.37700074e+00 -9.37700074e+00
 -9.37700074e+00 -1.18689234e+00 -5.14561972e-01 -5.14561972e-01
 -5.14561972e-01  1.11686549e+00  1.11686549e+00  1.11686549e+00
  3.98932386e+00  3.98932386e+00  3.98932386e+00  1.80654020e+01
  1.80654020e+01  1.80654020e+01  8.77155451e+01  8.77155451e+01
  8.77155451e+01  1.83661836e+02  4.19954025e+02  4.19954025e+02
  4.19954025e+02  1.27367596e+03  1.27367596e+03  1.27367596e+03
  1.91500069e+03  2.97573830e+03  2.97573830e+03  2.97573830e+03
  6.60486599e+03  6.60486599e+03  6.60486599e+03  8.27326910e+03
  2.46610030e+04  7.54572772e+04]
E1 = -729.2229878992358  E_coul = 203.77156071199218
cycle= 2 E= -525.451427187244  delta_E= -0.000155  |g|= 0.00477  |ddm|= 0.0353
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00768108
diis-c [-5.89962156e-05  1.29856130e-04  9.99870144e-01]
  HOMO = -0.515878983449652  LUMO = 1.11625862263269
  mo_energy =
[-1.17920111e+02 -1.20439243e+01 -9.37983636e+00 -9.37983636e+00
 -9.37983636e+00 -1.18875047e+00 -5.15878983e-01 -5.15878983e-01
 -5.15878983e-01  1.11625862e+00  1.11625862e+00  1.11625862e+00
  3.98749150e+00  3.98749150e+00  3.98749150e+00  1.80626917e+01
  1.80626917e+01  1.80626917e+01  8.77156508e+01  8.77156508e+01
  8.77156508e+01  1.83664574e+02  4.19957123e+02  4.19957123e+02
  4.19957123e+02  1.27368002e+03  1.27368002e+03  1.27368002e+03
  1.91500545e+03  2.97574286e+03  2.97574286e+03  2.97574286e+03
  6.60487080e+03  6.60487080e+03  6.60487080e+03  8.27327398e+03
  2.46610078e+04  7.54572819e+04]
E1 = -729.2266590071404  E_coul = 203.77523096301258
cycle= 3 E= -525.451428044128  delta_E= -8.57e-07  |g|= 0.000336  |ddm|= 0.00528
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000555551
diis-c [-5.78073488e-08 -3.01269741e-04  5.94243395e-02  9.40876930e-01]
  HOMO = -0.515704114614477  LUMO = 1.11636592462811
  mo_energy =
[-1.17920190e+02 -1.20436585e+01 -9.37957228e+00 -9.37957228e+00
 -9.37957228e+00 -1.18853325e+00 -5.15704115e-01 -5.15704115e-01
 -5.15704115e-01  1.11636592e+00  1.11636592e+00  1.11636592e+00
  3.98771607e+00  3.98771607e+00  3.98771607e+00  1.80629587e+01
  1.80629587e+01  1.80629587e+01  8.77157538e+01  8.77157538e+01
  8.77157538e+01  1.83664535e+02  4.19957050e+02  4.19957050e+02
  4.19957050e+02  1.27367988e+03  1.27367988e+03  1.27367988e+03
  1.91500524e+03  2.97574268e+03  2.97574268e+03  2.97574268e+03
  6.60487057e+03  6.60487057e+03  6.60487057e+03  8.27327372e+03
  2.46610075e+04  7.54572816e+04]
E1 = -729.2265189576401  E_coul = 203.77509090718831
cycle= 4 E= -525.451428050452  delta_E= -6.32e-09  |g|= 3.02e-05  |ddm|= 0.00035
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.21383e-05
diis-c [-9.18451768e-11  1.77672015e-05 -4.63665234e-03 -1.11570000e-01
  1.11618888e+00]
  HOMO = -0.515694510805301  LUMO = 1.11637303688437
  mo_energy =
[-1.17920195e+02 -1.20436558e+01 -9.37957008e+00 -9.37957008e+00
 -9.37957008e+00 -1.18852315e+00 -5.15694511e-01 -5.15694511e-01
 -5.15694511e-01  1.11637304e+00  1.11637304e+00  1.11637304e+00
  3.98772701e+00  3.98772701e+00  3.98772701e+00  1.80629640e+01
  1.80629640e+01  1.80629640e+01  8.77157529e+01  8.77157529e+01
  8.77157529e+01  1.83664531e+02  4.19957045e+02  4.19957045e+02
  4.19957045e+02  1.27367987e+03  1.27367987e+03  1.27367987e+03
  1.91500523e+03  2.97574267e+03  2.97574267e+03  2.97574267e+03
  6.60487056e+03  6.60487056e+03  6.60487056e+03  8.27327371e+03
  2.46610075e+04  7.54572816e+04]
E1 = -729.2265499859784  E_coul = 203.77512193541125
cycle= 5 E= -525.451428050567  delta_E= -1.15e-10  |g|= 1.3e-06  |ddm|= 7.05e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -729.2265499859784  E_coul = 203.77512193541125
  HOMO = -0.515693870201207  LUMO = 1.11637341152559
  mo_energy =
[-1.17920192e+02 -1.20436535e+01 -9.37956784e+00 -9.37956784e+00
 -9.37956784e+00 -1.18852229e+00 -5.15693870e-01 -5.15693870e-01
 -5.15693870e-01  1.11637341e+00  1.11637341e+00  1.11637341e+00
  3.98772795e+00  3.98772795e+00  3.98772795e+00  1.80629660e+01
  1.80629660e+01  1.80629660e+01  8.77157556e+01  8.77157556e+01
  8.77157556e+01  1.83664534e+02  4.19957048e+02  4.19957048e+02
  4.19957048e+02  1.27367988e+03  1.27367988e+03  1.27367988e+03
  1.91500524e+03  2.97574267e+03  2.97574267e+03  2.97574267e+03
  6.60487056e+03  6.60487056e+03  6.60487056e+03  8.27327371e+03
  2.46610075e+04  7.54572816e+04]
E1 = -729.226545149466  E_coul = 203.77511709889828
Extra cycle  E= -525.451428050568  delta_E= -5.68e-13  |g|= 2.67e-07  |ddm|= 4.95e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.25 sec
exp = [2.61825079e+04 7.61825074e+03 3.61825070e+03 1.61824947e+03
 2.39782188e+02 5.19113794e+01 4.74761791e+00 4.42036813e-01
 1.36279300e+03 6.65180686e+02 3.03320426e+02 3.16146266e+02
 4.93027021e+01 4.77527978e+00 1.47306592e+01 5.93522841e-01
 1.15658717e+00 3.04004000e-01]
E = -525.4514280505678
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:18 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078518        1
[INPUT] 0    0    [1    /1   ]  7618.25076502        1
[INPUT] 0    0    [1    /1   ]  3618.25074516        1
[INPUT] 0    0    [1    /1   ]  1618.25017255        1
[INPUT] 0    0    [1    /1   ]  239.783144897        1
[INPUT] 0    0    [1    /1   ]  51.9042372306        1
[INPUT] 0    0    [1    /1   ]  4.55734760652        1
[INPUT] 0    0    [1    /1   ]  0.407892897208       1
[INPUT] 1    0    [1    /1   ]  1362.79300199        1
[INPUT] 1    0    [1    /1   ]  665.180707151        1
[INPUT] 1    0    [1    /1   ]  303.320541098        1
[INPUT] 1    0    [1    /1   ]  316.146367307        1
[INPUT] 1    0    [1    /1   ]  49.3013413321        1
[INPUT] 1    0    [1    /1   ]  4.76391277082        1
[INPUT] 1    0    [1    /1   ]  14.7394899575        1
[INPUT] 1    0    [1    /1   ]  0.477310203862       1
[INPUT] 1    0    [1    /1   ]  1.20245338449        1
[INPUT] 1    0    [1    /1   ]  0.254952490448       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.5078517526, 1.0]], [0, [7618.250765024495, 1.0]], [0, [3618.2507451557194, 1.0]], [0, [1618.250172548211, 1.0]], [0, [239.78314489691425, 1.0]], [0, [51.904237230571766, 1.0]], [0, [4.557347606520432, 1.0]], [0, [0.40789289720805927, 1.0]], [1, [1362.793001987512, 1.0]], [1, [665.1807071509502, 1.0]], [1, [303.320541098171, 1.0]], [1, [316.1463673072876, 1.0]], [1, [49.30134133214667, 1.0]], [1, [4.763912770821986, 1.0]], [1, [14.739489957509493, 1.0]], [1, [0.4773102038616478, 1.0]], [1, [1.2024533844864207, 1.0]], [1, [0.2549524904476459, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785175]
bas 1, expnt(s) = [7618.25076502]
bas 2, expnt(s) = [3618.25074516]
bas 3, expnt(s) = [1618.25017255]
bas 4, expnt(s) = [239.7831449]
bas 5, expnt(s) = [51.90423723]
bas 6, expnt(s) = [4.55734761]
bas 7, expnt(s) = [0.4078929]
bas 8, expnt(s) = [1362.79300199]
bas 9, expnt(s) = [665.18070715]
bas 10, expnt(s) = [303.3205411]
bas 11, expnt(s) = [316.14636731]
bas 12, expnt(s) = [49.30134133]
bas 13, expnt(s) = [4.76391277]
bas 14, expnt(s) = [14.73948996]
bas 15, expnt(s) = [0.4773102]
bas 16, expnt(s) = [1.20245338]
bas 17, expnt(s) = [0.25495249]
CPU time:        24.28
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825077e+03 2.06018619e+03
 3.61825075e+03 1.17866129e+03 1.61825017e+03 6.44613313e+02
 2.39783145e+02 1.53949759e+02 5.19042372e+01 4.88559131e+01
 4.55734761e+00 7.88041594e+00 4.07892897e-01 1.28950975e+00
 1.36279300e+03 2.41558187e+04 6.65180707e+02 9.85505263e+03
 3.03320541e+02 3.69285002e+03 3.16146367e+02 3.88905995e+03
 4.93013413e+01 3.81116553e+02 4.76391277e+00 2.05323729e+01
 1.47394900e+01 8.42534051e+01 4.77310204e-01 1.15740483e+00
 1.20245338e+00 3.67341254e+00 2.54952490e-01 5.28516397e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.95853822427012
cond(S) = 83598.73537158323
E1 = -727.4874951904792  E_coul = 203.16830189829153
init E= -524.319193292188
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.555817397603711  LUMO = 0.859202585377089
  mo_energy =
[-1.17869659e+02 -1.20874997e+01 -9.43586324e+00 -9.43586324e+00
 -9.43586324e+00 -1.22825246e+00 -5.55817398e-01 -5.55817398e-01
 -5.55817398e-01  8.59202585e-01  8.59202585e-01  8.59202585e-01
  3.44672733e+00  3.44672733e+00  3.44672733e+00  1.75481040e+01
  1.75481040e+01  1.75481040e+01  8.73836334e+01  8.73836334e+01
  8.73836334e+01  1.82758047e+02  4.19788977e+02  4.19788977e+02
  4.19788977e+02  1.27358459e+03  1.27358459e+03  1.27358459e+03
  1.91453893e+03  2.97571738e+03  2.97571738e+03  2.97571738e+03
  6.60496784e+03  6.60496784e+03  6.60496784e+03  8.27301792e+03
  2.46608769e+04  7.54572785e+04]
E1 = -727.9087754122675  E_coul = 202.4178064129076
cycle= 1 E= -525.49096899936  delta_E= -1.17  |g|= 0.178  |ddm|= 0.565
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.436461
diis-c [-0.19049852  1.        ]
  HOMO = -0.548206305958301  LUMO = 0.871909108591872
  mo_energy =
[-1.18074781e+02 -1.21364520e+01 -9.48506782e+00 -9.48506782e+00
 -9.48506782e+00 -1.22562282e+00 -5.48206306e-01 -5.48206306e-01
 -5.48206306e-01  8.71909109e-01  8.71909109e-01  8.71909109e-01
  3.44960288e+00  3.44960288e+00  3.44960288e+00  1.75077043e+01
  1.75077043e+01  1.75077043e+01  8.72749486e+01  8.72749486e+01
  8.72749486e+01  1.82607891e+02  4.19596388e+02  4.19596388e+02
  4.19596388e+02  1.27334008e+03  1.27334008e+03  1.27334008e+03
  1.91416780e+03  2.97540826e+03  2.97540826e+03  2.97540826e+03
  6.60453970e+03  6.60453970e+03  6.60453970e+03  8.27250513e+03
  2.46602688e+04  7.54565780e+04]
E1 = -728.0362113430417  E_coul = 202.5450612399351
cycle= 2 E= -525.491150103107  delta_E= -0.000181  |g|= 0.0117  |ddm|= 0.0326
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0202162
diis-c [-3.57910610e-04  1.60800120e-02  9.83919988e-01]
  HOMO = -0.546630789217865  LUMO = 0.872782380971255
  mo_energy =
[-1.18053602e+02 -1.21278745e+01 -9.47635823e+00 -9.47635823e+00
 -9.47635823e+00 -1.22362532e+00 -5.46630789e-01 -5.46630789e-01
 -5.46630789e-01  8.72782381e-01  8.72782381e-01  8.72782381e-01
  3.45203167e+00  3.45203167e+00  3.45203167e+00  1.75149610e+01
  1.75149610e+01  1.75149610e+01  8.72897826e+01  8.72897826e+01
  8.72897826e+01  1.82628180e+02  4.19617309e+02  4.19617309e+02
  4.19617309e+02  1.27336275e+03  1.27336275e+03  1.27336275e+03
  1.91419159e+03  2.97543176e+03  2.97543176e+03  2.97543176e+03
  6.60456363e+03  6.60456363e+03  6.60456363e+03  8.27252921e+03
  2.46602928e+04  7.54566019e+04]
E1 = -728.012639943436  E_coul = 202.52148682524407
cycle= 3 E= -525.491153118192  delta_E= -3.02e-06  |g|= 0.00155  |ddm|= 0.00293
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00292173
diis-c [-1.10950858e-07 -7.67902136e-04  1.20285217e-01  8.80482686e-01]
  HOMO = -0.54684570614391  LUMO = 0.872692855334663
  mo_energy =
[-1.18056375e+02 -1.21292425e+01 -9.47776353e+00 -9.47776353e+00
 -9.47776353e+00 -1.22393060e+00 -5.46845706e-01 -5.46845706e-01
 -5.46845706e-01  8.72692855e-01  8.72692855e-01  8.72692855e-01
  3.45167760e+00  3.45167760e+00  3.45167760e+00  1.75137915e+01
  1.75137915e+01  1.75137915e+01  8.72877055e+01  8.72877055e+01
  8.72877055e+01  1.82625553e+02  4.19614571e+02  4.19614571e+02
  4.19614571e+02  1.27335981e+03  1.27335981e+03  1.27335981e+03
  1.91418848e+03  2.97542871e+03  2.97542871e+03  2.97542871e+03
  6.60456047e+03  6.60456047e+03  6.60456047e+03  8.27252598e+03
  2.46602895e+04  7.54565986e+04]
E1 = -728.0168144892397  E_coul = 202.5256612917647
cycle= 4 E= -525.491153197475  delta_E= -7.93e-08  |g|= 6.3e-05  |ddm|= 0.000655
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.29609e-05
diis-c [-3.67633657e-09  2.33277427e-05 -5.77253988e-03 -2.75573424e-02
  1.03330655e+00]
  HOMO = -0.546804321311195  LUMO = 0.872714916202735
  mo_energy =
[-1.18056276e+02 -1.21291533e+01 -9.47767419e+00 -9.47767419e+00
 -9.47767419e+00 -1.22388091e+00 -5.46804321e-01 -5.46804321e-01
 -5.46804321e-01  8.72714916e-01  8.72714916e-01  8.72714916e-01
  3.45173128e+00  3.45173128e+00  3.45173128e+00  1.75138754e+01
  1.75138754e+01  1.75138754e+01  8.72878004e+01  8.72878004e+01
  8.72878004e+01  1.82625652e+02  4.19614670e+02  4.19614670e+02
  4.19614670e+02  1.27335991e+03  1.27335991e+03  1.27335991e+03
  1.91418857e+03  2.97542881e+03  2.97542881e+03  2.97542881e+03
  6.60456056e+03  6.60456056e+03  6.60456056e+03  8.27252608e+03
  2.46602896e+04  7.54565987e+04]
E1 = -728.0166817858484  E_coul = 202.52552858789124
cycle= 5 E= -525.491153197957  delta_E= -4.82e-10  |g|= 6.65e-06  |ddm|= 7.74e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.0166817858484  E_coul = 202.52552858789124
  HOMO = -0.546806352477407  LUMO = 0.87271417925168
  mo_energy =
[-1.18056291e+02 -1.21291639e+01 -9.47768499e+00 -9.47768499e+00
 -9.47768499e+00 -1.22388389e+00 -5.46806352e-01 -5.46806352e-01
 -5.46806352e-01  8.72714179e-01  8.72714179e-01  8.72714179e-01
  3.45172811e+00  3.45172811e+00  3.45172811e+00  1.75138663e+01
  1.75138663e+01  1.75138663e+01  8.72877878e+01  8.72877878e+01
  8.72877878e+01  1.82625638e+02  4.19614655e+02  4.19614655e+02
  4.19614655e+02  1.27335990e+03  1.27335990e+03  1.27335990e+03
  1.91418856e+03  2.97542879e+03  2.97542879e+03  2.97542879e+03
  6.60456055e+03  6.60456055e+03  6.60456055e+03  8.27252606e+03
  2.46602896e+04  7.54565987e+04]
E1 = -728.0167128808956  E_coul = 202.52555968293237
Extra cycle  E= -525.491153197963  delta_E= -6.14e-12  |g|= 1.52e-06  |ddm|= 8.46e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.24 sec
exp = [2.61825079e+04 7.61825077e+03 3.61825075e+03 1.61825017e+03
 2.39783145e+02 5.19042372e+01 4.55734761e+00 4.07892897e-01
 1.36279300e+03 6.65180707e+02 3.03320541e+02 3.16146367e+02
 4.93013413e+01 4.76391277e+00 1.47394900e+01 4.77310204e-01
 1.20245338e+00 2.54952490e-01]
E = -525.4911531979633
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:18 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078518        1
[INPUT] 0    0    [1    /1   ]  7618.25076502        1
[INPUT] 0    0    [1    /1   ]  3618.25074516        1
[INPUT] 0    0    [1    /1   ]  1618.25017255        1
[INPUT] 0    0    [1    /1   ]  239.783144897        1
[INPUT] 0    0    [1    /1   ]  51.9042372306        1
[INPUT] 0    0    [1    /1   ]  4.55734760652        1
[INPUT] 0    0    [1    /1   ]  0.407892897208       1
[INPUT] 1    0    [1    /1   ]  1362.79300199        1
[INPUT] 1    0    [1    /1   ]  665.180707151        1
[INPUT] 1    0    [1    /1   ]  303.320541098        1
[INPUT] 1    0    [1    /1   ]  316.146367307        1
[INPUT] 1    0    [1    /1   ]  49.3013413321        1
[INPUT] 1    0    [1    /1   ]  4.76391277082        1
[INPUT] 1    0    [1    /1   ]  14.7394899575        1
[INPUT] 1    0    [1    /1   ]  0.477310203862       1
[INPUT] 1    0    [1    /1   ]  1.20245338449        1
[INPUT] 1    0    [1    /1   ]  0.254952490448       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.5078517526, 1.0]], [0, [7618.250765024495, 1.0]], [0, [3618.2507451557194, 1.0]], [0, [1618.250172548211, 1.0]], [0, [239.78314489691425, 1.0]], [0, [51.904237230571766, 1.0]], [0, [4.557347606520432, 1.0]], [0, [0.40789289720805927, 1.0]], [1, [1362.793001987512, 1.0]], [1, [665.1807071509502, 1.0]], [1, [303.320541098171, 1.0]], [1, [316.1463673072876, 1.0]], [1, [49.30134133214667, 1.0]], [1, [4.763912770821986, 1.0]], [1, [14.739489957509493, 1.0]], [1, [0.4773102038616478, 1.0]], [1, [1.2024533844864207, 1.0]], [1, [0.2549524904476459, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785175]
bas 1, expnt(s) = [7618.25076502]
bas 2, expnt(s) = [3618.25074516]
bas 3, expnt(s) = [1618.25017255]
bas 4, expnt(s) = [239.7831449]
bas 5, expnt(s) = [51.90423723]
bas 6, expnt(s) = [4.55734761]
bas 7, expnt(s) = [0.4078929]
bas 8, expnt(s) = [1362.79300199]
bas 9, expnt(s) = [665.18070715]
bas 10, expnt(s) = [303.3205411]
bas 11, expnt(s) = [316.14636731]
bas 12, expnt(s) = [49.30134133]
bas 13, expnt(s) = [4.76391277]
bas 14, expnt(s) = [14.73948996]
bas 15, expnt(s) = [0.4773102]
bas 16, expnt(s) = [1.20245338]
bas 17, expnt(s) = [0.25495249]
CPU time:        24.76
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825077e+03 2.06018619e+03
 3.61825075e+03 1.17866129e+03 1.61825017e+03 6.44613313e+02
 2.39783145e+02 1.53949759e+02 5.19042372e+01 4.88559131e+01
 4.55734761e+00 7.88041594e+00 4.07892897e-01 1.28950975e+00
 1.36279300e+03 2.41558187e+04 6.65180707e+02 9.85505263e+03
 3.03320541e+02 3.69285002e+03 3.16146367e+02 3.88905995e+03
 4.93013413e+01 3.81116553e+02 4.76391277e+00 2.05323729e+01
 1.47394900e+01 8.42534051e+01 4.77310204e-01 1.15740483e+00
 1.20245338e+00 3.67341254e+00 2.54952490e-01 5.28516397e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.95853822427012
cond(S) = 83598.73537158323
E1 = -727.4874951904792  E_coul = 203.16830189829153
init E= -524.319193292188
    CPU time for initialize scf      0.19 sec, wall time      0.05 sec
  HOMO = -0.555817397603711  LUMO = 0.859202585377089
  mo_energy =
[-1.17869659e+02 -1.20874997e+01 -9.43586324e+00 -9.43586324e+00
 -9.43586324e+00 -1.22825246e+00 -5.55817398e-01 -5.55817398e-01
 -5.55817398e-01  8.59202585e-01  8.59202585e-01  8.59202585e-01
  3.44672733e+00  3.44672733e+00  3.44672733e+00  1.75481040e+01
  1.75481040e+01  1.75481040e+01  8.73836334e+01  8.73836334e+01
  8.73836334e+01  1.82758047e+02  4.19788977e+02  4.19788977e+02
  4.19788977e+02  1.27358459e+03  1.27358459e+03  1.27358459e+03
  1.91453893e+03  2.97571738e+03  2.97571738e+03  2.97571738e+03
  6.60496784e+03  6.60496784e+03  6.60496784e+03  8.27301792e+03
  2.46608769e+04  7.54572785e+04]
E1 = -727.9087754122675  E_coul = 202.4178064129076
cycle= 1 E= -525.49096899936  delta_E= -1.17  |g|= 0.178  |ddm|= 0.565
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.436461
diis-c [-0.19049852  1.        ]
  HOMO = -0.548206305958301  LUMO = 0.871909108591872
  mo_energy =
[-1.18074781e+02 -1.21364520e+01 -9.48506782e+00 -9.48506782e+00
 -9.48506782e+00 -1.22562282e+00 -5.48206306e-01 -5.48206306e-01
 -5.48206306e-01  8.71909109e-01  8.71909109e-01  8.71909109e-01
  3.44960288e+00  3.44960288e+00  3.44960288e+00  1.75077043e+01
  1.75077043e+01  1.75077043e+01  8.72749486e+01  8.72749486e+01
  8.72749486e+01  1.82607891e+02  4.19596388e+02  4.19596388e+02
  4.19596388e+02  1.27334008e+03  1.27334008e+03  1.27334008e+03
  1.91416780e+03  2.97540826e+03  2.97540826e+03  2.97540826e+03
  6.60453970e+03  6.60453970e+03  6.60453970e+03  8.27250513e+03
  2.46602688e+04  7.54565780e+04]
E1 = -728.0362113430417  E_coul = 202.5450612399351
cycle= 2 E= -525.491150103107  delta_E= -0.000181  |g|= 0.0117  |ddm|= 0.0326
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0202162
diis-c [-3.57910610e-04  1.60800120e-02  9.83919988e-01]
  HOMO = -0.546630789217865  LUMO = 0.872782380971255
  mo_energy =
[-1.18053602e+02 -1.21278745e+01 -9.47635823e+00 -9.47635823e+00
 -9.47635823e+00 -1.22362532e+00 -5.46630789e-01 -5.46630789e-01
 -5.46630789e-01  8.72782381e-01  8.72782381e-01  8.72782381e-01
  3.45203167e+00  3.45203167e+00  3.45203167e+00  1.75149610e+01
  1.75149610e+01  1.75149610e+01  8.72897826e+01  8.72897826e+01
  8.72897826e+01  1.82628180e+02  4.19617309e+02  4.19617309e+02
  4.19617309e+02  1.27336275e+03  1.27336275e+03  1.27336275e+03
  1.91419159e+03  2.97543176e+03  2.97543176e+03  2.97543176e+03
  6.60456363e+03  6.60456363e+03  6.60456363e+03  8.27252921e+03
  2.46602928e+04  7.54566019e+04]
E1 = -728.012639943436  E_coul = 202.52148682524407
cycle= 3 E= -525.491153118192  delta_E= -3.02e-06  |g|= 0.00155  |ddm|= 0.00293
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00292173
diis-c [-1.10950858e-07 -7.67902136e-04  1.20285217e-01  8.80482686e-01]
  HOMO = -0.54684570614391  LUMO = 0.872692855334663
  mo_energy =
[-1.18056375e+02 -1.21292425e+01 -9.47776353e+00 -9.47776353e+00
 -9.47776353e+00 -1.22393060e+00 -5.46845706e-01 -5.46845706e-01
 -5.46845706e-01  8.72692855e-01  8.72692855e-01  8.72692855e-01
  3.45167760e+00  3.45167760e+00  3.45167760e+00  1.75137915e+01
  1.75137915e+01  1.75137915e+01  8.72877055e+01  8.72877055e+01
  8.72877055e+01  1.82625553e+02  4.19614571e+02  4.19614571e+02
  4.19614571e+02  1.27335981e+03  1.27335981e+03  1.27335981e+03
  1.91418848e+03  2.97542871e+03  2.97542871e+03  2.97542871e+03
  6.60456047e+03  6.60456047e+03  6.60456047e+03  8.27252598e+03
  2.46602895e+04  7.54565986e+04]
E1 = -728.0168144892397  E_coul = 202.5256612917647
cycle= 4 E= -525.491153197475  delta_E= -7.93e-08  |g|= 6.3e-05  |ddm|= 0.000655
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.29609e-05
diis-c [-3.67633657e-09  2.33277427e-05 -5.77253988e-03 -2.75573424e-02
  1.03330655e+00]
  HOMO = -0.546804321311195  LUMO = 0.872714916202735
  mo_energy =
[-1.18056276e+02 -1.21291533e+01 -9.47767419e+00 -9.47767419e+00
 -9.47767419e+00 -1.22388091e+00 -5.46804321e-01 -5.46804321e-01
 -5.46804321e-01  8.72714916e-01  8.72714916e-01  8.72714916e-01
  3.45173128e+00  3.45173128e+00  3.45173128e+00  1.75138754e+01
  1.75138754e+01  1.75138754e+01  8.72878004e+01  8.72878004e+01
  8.72878004e+01  1.82625652e+02  4.19614670e+02  4.19614670e+02
  4.19614670e+02  1.27335991e+03  1.27335991e+03  1.27335991e+03
  1.91418857e+03  2.97542881e+03  2.97542881e+03  2.97542881e+03
  6.60456056e+03  6.60456056e+03  6.60456056e+03  8.27252608e+03
  2.46602896e+04  7.54565987e+04]
E1 = -728.0166817858484  E_coul = 202.52552858789124
cycle= 5 E= -525.491153197957  delta_E= -4.82e-10  |g|= 6.65e-06  |ddm|= 7.74e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.0166817858484  E_coul = 202.52552858789124
  HOMO = -0.546806352477407  LUMO = 0.87271417925168
  mo_energy =
[-1.18056291e+02 -1.21291639e+01 -9.47768499e+00 -9.47768499e+00
 -9.47768499e+00 -1.22388389e+00 -5.46806352e-01 -5.46806352e-01
 -5.46806352e-01  8.72714179e-01  8.72714179e-01  8.72714179e-01
  3.45172811e+00  3.45172811e+00  3.45172811e+00  1.75138663e+01
  1.75138663e+01  1.75138663e+01  8.72877878e+01  8.72877878e+01
  8.72877878e+01  1.82625638e+02  4.19614655e+02  4.19614655e+02
  4.19614655e+02  1.27335990e+03  1.27335990e+03  1.27335990e+03
  1.91418856e+03  2.97542879e+03  2.97542879e+03  2.97542879e+03
  6.60456055e+03  6.60456055e+03  6.60456055e+03  8.27252606e+03
  2.46602896e+04  7.54565987e+04]
E1 = -728.0167128808956  E_coul = 202.52555968293237
Extra cycle  E= -525.491153197963  delta_E= -6.14e-12  |g|= 1.52e-06  |ddm|= 8.46e-06
    CPU time for scf_cycle      0.40 sec, wall time      0.26 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 83598.73537158323
E1 = -728.0167128808956  E_coul = 202.52555968293237
init E= -525.491153197963
    CPU time for initialize scf      1.05 sec, wall time      0.20 sec
  HOMO = -0.546805665966061  LUMO = 0.872714522593082
  mo_energy =
[-1.18056287e+02 -1.21291616e+01 -9.47768271e+00 -9.47768271e+00
 -9.47768271e+00 -1.22388302e+00 -5.46805666e-01 -5.46805666e-01
 -5.46805666e-01  8.72714523e-01  8.72714523e-01  8.72714523e-01
  3.45172907e+00  3.45172907e+00  3.45172907e+00  1.75138683e+01
  1.75138683e+01  1.75138683e+01  8.72877907e+01  8.72877907e+01
  8.72877907e+01  1.82625641e+02  4.19614659e+02  4.19614659e+02
  4.19614659e+02  1.27335990e+03  1.27335990e+03  1.27335990e+03
  1.91418856e+03  2.97542880e+03  2.97542880e+03  2.97542880e+03
  6.60456055e+03  6.60456055e+03  6.60456055e+03  8.27252607e+03
  2.46602896e+04  7.54565987e+04]
E1 = -728.0167077097551  E_coul = 202.52555451179134
cycle= 1 E= -525.491153197964  delta_E= -4.55e-13  |g|= 3e-07  |ddm|= 5.86e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.0167077097551  E_coul = 202.52555451179134
  HOMO = -0.546805744827021  LUMO = 0.87271448816226
  mo_energy =
[-1.18056288e+02 -1.21291620e+01 -9.47768310e+00 -9.47768310e+00
 -9.47768310e+00 -1.22388313e+00 -5.46805745e-01 -5.46805745e-01
 -5.46805745e-01  8.72714488e-01  8.72714488e-01  8.72714488e-01
  3.45172894e+00  3.45172894e+00  3.45172894e+00  1.75138680e+01
  1.75138680e+01  1.75138680e+01  8.72877901e+01  8.72877901e+01
  8.72877901e+01  1.82625640e+02  4.19614658e+02  4.19614658e+02
  4.19614658e+02  1.27335990e+03  1.27335990e+03  1.27335990e+03
  1.91418856e+03  2.97542879e+03  2.97542879e+03  2.97542879e+03
  6.60456055e+03  6.60456055e+03  6.60456055e+03  8.27252607e+03
  2.46602896e+04  7.54565987e+04]
E1 = -728.016708800161  E_coul = 202.52555560219855
Extra cycle  E= -525.491153197962  delta_E= 1.25e-12  |g|= 6.03e-08  |ddm|= 1.6e-07
    CPU time for scf_cycle      1.47 sec, wall time      0.62 sec
exp = [2.61825079e+04 7.61825077e+03 3.61825075e+03 1.61825017e+03
 2.39783145e+02 5.19042372e+01 4.55734761e+00 4.07892897e-01
 1.36279300e+03 6.65180707e+02 3.03320541e+02 3.16146367e+02
 4.93013413e+01 4.76391277e+00 1.47394900e+01 4.77310204e-01
 1.20245338e+00 2.54952490e-01]
grad_E = [-1.98510179e-06  2.17226524e-05  4.33137703e-05  6.66191941e-04
  9.26139686e-04 -7.04565377e-03 -4.19904069e-02  1.76865443e-01
  1.34332298e-06  2.00597970e-05  1.08612359e-04  9.56672271e-05
 -1.23921219e-03 -1.56854273e-02  8.34186672e-03 -1.29339457e-01
  1.73667117e-02  4.57743372e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.507855         1
[INPUT] 0    0    [1    /1   ]  7618.25072935        1
[INPUT] 0    0    [1    /1   ]  3618.25067399        1
[INPUT] 0    0    [1    /1   ]  1618.24907827        1
[INPUT] 0    0    [1    /1   ]  239.781643016        1
[INPUT] 0    0    [1    /1   ]  51.9155128455        1
[INPUT] 0    0    [1    /1   ]  4.71520258351        1
[INPUT] 0    0    [1    /1   ]  0.386329960939       1
[INPUT] 1    0    [1    /1   ]  1362.79299977        1
[INPUT] 1    0    [1    /1   ]  665.180674056        1
[INPUT] 1    0    [1    /1   ]  303.320361852        1
[INPUT] 1    0    [1    /1   ]  316.146209424        1
[INPUT] 1    0    [1    /1   ]  49.3034458293        1
[INPUT] 1    0    [1    /1   ]  4.78870197122        1
[INPUT] 1    0    [1    /1   ]  14.7253125338        1
[INPUT] 1    0    [1    /1   ]  0.4301451299         1
[INPUT] 1    0    [1    /1   ]  1.18941468766        1
[INPUT] 1    0    [1    /1   ]  0.179871214676       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507855011856, 1.0]], [0, [7618.250729345249, 1.0]], [0, [3618.2506739949276, 1.0]], [0, [1618.2490782710543, 1.0]], [0, [239.78164301594927, 1.0]], [0, [51.91551284548772, 1.0]], [0, [4.715202583510247, 1.0]], [0, [0.3863299609392458, 1.0]], [1, [1362.79299976557, 1.0]], [1, [665.1806740564153, 1.0]], [1, [303.3203618515448, 1.0]], [1, [316.1462094243302, 1.0]], [1, [49.303445829300905, 1.0]], [1, [4.788701971217612, 1.0]], [1, [14.725312533784178, 1.0]], [1, [0.4301451299002997, 1.0]], [1, [1.1894146876643485, 1.0]], [1, [0.17987121467647813, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785501]
bas 1, expnt(s) = [7618.25072935]
bas 2, expnt(s) = [3618.25067399]
bas 3, expnt(s) = [1618.24907827]
bas 4, expnt(s) = [239.78164302]
bas 5, expnt(s) = [51.91551285]
bas 6, expnt(s) = [4.71520258]
bas 7, expnt(s) = [0.38632996]
bas 8, expnt(s) = [1362.79299977]
bas 9, expnt(s) = [665.18067406]
bas 10, expnt(s) = [303.32036185]
bas 11, expnt(s) = [316.14620942]
bas 12, expnt(s) = [49.30344583]
bas 13, expnt(s) = [4.78870197]
bas 14, expnt(s) = [14.72531253]
bas 15, expnt(s) = [0.43014513]
bas 16, expnt(s) = [1.18941469]
bas 17, expnt(s) = [0.17987121]
CPU time:        31.01
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825073e+03 2.06018619e+03
 3.61825067e+03 1.17866127e+03 1.61824908e+03 6.44612986e+02
 2.39781643e+02 1.53949036e+02 5.19155128e+01 4.88638729e+01
 4.71520258e+00 8.08426035e+00 3.86329961e-01 1.23803755e+00
 1.36279300e+03 2.41558186e+04 6.65180674e+02 9.85505202e+03
 3.03320362e+02 3.69284730e+03 3.16146209e+02 3.88905752e+03
 4.93034458e+01 3.81136888e+02 4.78870197e+00 2.06660109e+01
 1.47253125e+01 8.41521166e+01 4.30145130e-01 1.01625608e+00
 1.18941469e+00 3.62368980e+00 1.79871215e-01 3.41732652e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.975235815304096
cond(S) = 83507.68328750093
E1 = -727.5971538642127  E_coul = 203.12915907280046
init E= -524.467994791412
    CPU time for initialize scf      0.71 sec, wall time      0.08 sec
  HOMO = -0.56596992621668  LUMO = 0.616779802313026
  mo_energy =
[-1.17859585e+02 -1.20845133e+01 -9.43611720e+00 -9.43611720e+00
 -9.43611720e+00 -1.23737636e+00 -5.65969926e-01 -5.65969926e-01
 -5.65969926e-01  6.16779802e-01  6.16779802e-01  6.16779802e-01
  2.94814796e+00  2.94814796e+00  2.94814796e+00  1.71175286e+01
  1.71175286e+01  1.71175286e+01  8.71096604e+01  8.71096604e+01
  8.71096604e+01  1.83383167e+02  4.19611636e+02  4.19611636e+02
  4.19611636e+02  1.27343795e+03  1.27343795e+03  1.27343795e+03
  1.91500356e+03  2.97558294e+03  2.97558294e+03  2.97558294e+03
  6.60484659e+03  6.60484659e+03  6.60484659e+03  8.27342699e+03
  2.46612608e+04  7.54576352e+04]
E1 = -727.4572484079193  E_coul = 201.95174256627206
cycle= 1 E= -525.505505841647  delta_E= -1.04  |g|= 0.17  |ddm|= 0.253
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.422955
diis-c [-0.17889095  1.        ]
  HOMO = -0.576301367736935  LUMO = 0.618389616676345
  mo_energy =
[-1.18080087e+02 -1.21679166e+01 -9.51491812e+00 -9.51491812e+00
 -9.51491812e+00 -1.25530115e+00 -5.76301368e-01 -5.76301368e-01
 -5.76301368e-01  6.18389617e-01  6.18389617e-01  6.18389617e-01
  2.92971500e+00  2.92971500e+00  2.92971500e+00  1.70490488e+01
  1.70490488e+01  1.70490488e+01  8.69774697e+01  8.69774697e+01
  8.69774697e+01  1.83208035e+02  4.19402391e+02  4.19402391e+02
  4.19402391e+02  1.27318218e+03  1.27318218e+03  1.27318218e+03
  1.91463232e+03  2.97526894e+03  2.97526894e+03  2.97526894e+03
  6.60442082e+03  6.60442082e+03  6.60442082e+03  8.27292122e+03
  2.46606633e+04  7.54569476e+04]
E1 = -727.6445769634704  E_coul = 202.13893626094216
cycle= 2 E= -525.505640702528  delta_E= -0.000135  |g|= 0.0129  |ddm|= 0.0156
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0231968
diis-c [-4.78907371e-04  1.78878038e-02  9.82112196e-01]
  HOMO = -0.573478261768131  LUMO = 0.619460833546808
  mo_energy =
[-1.18053832e+02 -1.21546239e+01 -9.50150090e+00 -9.50150090e+00
 -9.50150090e+00 -1.25163608e+00 -5.73478262e-01 -5.73478262e-01
 -5.73478262e-01  6.19460834e-01  6.19460834e-01  6.19460834e-01
  2.93381025e+00  2.93381025e+00  2.93381025e+00  1.70605168e+01
  1.70605168e+01  1.70605168e+01  8.69972388e+01  8.69972388e+01
  8.69972388e+01  1.83233259e+02  4.19428358e+02  4.19428358e+02
  4.19428358e+02  1.27320990e+03  1.27320990e+03  1.27320990e+03
  1.91466119e+03  2.97529750e+03  2.97529750e+03  2.97529750e+03
  6.60444984e+03  6.60444984e+03  6.60444984e+03  8.27295040e+03
  2.46606924e+04  7.54569767e+04]
E1 = -727.6060514188074  E_coul = 202.10040608920065
cycle= 3 E= -525.505645329607  delta_E= -4.63e-06  |g|= 0.00206  |ddm|= 0.00277
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0038598
diis-c [-5.77028659e-08 -7.22043978e-04  1.38861250e-01  8.61860794e-01]
  HOMO = -0.573966575266  LUMO = 0.61928778888332
  mo_energy =
[-1.18057726e+02 -1.21568152e+01 -9.50372376e+00 -9.50372376e+00
 -9.50372376e+00 -1.25227873e+00 -5.73966575e-01 -5.73966575e-01
 -5.73966575e-01  6.19287789e-01  6.19287789e-01  6.19287789e-01
  2.93310797e+00  2.93310797e+00  2.93310797e+00  1.70586031e+01
  1.70586031e+01  1.70586031e+01  8.69941872e+01  8.69941872e+01
  8.69941872e+01  1.83229535e+02  4.19424507e+02  4.19424507e+02
  4.19424507e+02  1.27320582e+03  1.27320582e+03  1.27320582e+03
  1.91465692e+03  2.97529329e+03  2.97529329e+03  2.97529329e+03
  6.60444551e+03  6.60444551e+03  6.60444551e+03  8.27294601e+03
  2.46606880e+04  7.54569723e+04]
E1 = -727.6125514661998  E_coul = 202.10690597071724
cycle= 4 E= -525.505645495483  delta_E= -1.66e-07  |g|= 3.94e-05  |ddm|= 0.000551
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.51495e-05
diis-c [-9.21345826e-10 -4.35119172e-05  7.92602690e-03  5.96177020e-02
  9.32499783e-01]
  HOMO = -0.573939817380364  LUMO = 0.619298578968508
  mo_energy =
[-1.18057650e+02 -1.21567482e+01 -9.50365642e+00 -9.50365642e+00
 -9.50365642e+00 -1.25224587e+00 -5.73939817e-01 -5.73939817e-01
 -5.73939817e-01  6.19298579e-01  6.19298579e-01  6.19298579e-01
  2.93314274e+00  2.93314274e+00  2.93314274e+00  1.70586650e+01
  1.70586650e+01  1.70586650e+01  8.69942590e+01  8.69942590e+01
  8.69942590e+01  1.83229610e+02  4.19424582e+02  4.19424582e+02
  4.19424582e+02  1.27320589e+03  1.27320589e+03  1.27320589e+03
  1.91465699e+03  2.97529336e+03  2.97529336e+03  2.97529336e+03
  6.60444559e+03  6.60444559e+03  6.60444559e+03  8.27294608e+03
  2.46606881e+04  7.54569723e+04]
E1 = -727.6124128703115  E_coul = 202.10676737466008
cycle= 5 E= -525.505645495651  delta_E= -1.69e-10  |g|= 3.76e-06  |ddm|= 2.51e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.6124128703115  E_coul = 202.10676737466008
  HOMO = -0.573939085958522  LUMO = 0.619299057420435
  mo_energy =
[-1.18057653e+02 -1.21567496e+01 -9.50365788e+00 -9.50365788e+00
 -9.50365788e+00 -1.25224523e+00 -5.73939086e-01 -5.73939086e-01
 -5.73939086e-01  6.19299057e-01  6.19299057e-01  6.19299057e-01
  2.93314347e+00  2.93314347e+00  2.93314347e+00  1.70586641e+01
  1.70586641e+01  1.70586641e+01  8.69942568e+01  8.69942568e+01
  8.69942568e+01  1.83229607e+02  4.19424579e+02  4.19424579e+02
  4.19424579e+02  1.27320589e+03  1.27320589e+03  1.27320589e+03
  1.91465699e+03  2.97529336e+03  2.97529336e+03  2.97529336e+03
  6.60444558e+03  6.60444558e+03  6.60444558e+03  8.27294608e+03
  2.46606881e+04  7.54569723e+04]
E1 = -727.6124237747684  E_coul = 202.10677827911434
Extra cycle  E= -525.505645495654  delta_E= -2.73e-12  |g|= 6.18e-07  |ddm|= 5.34e-06
    CPU time for scf_cycle      0.90 sec, wall time      0.27 sec
exp = [2.61825079e+04 7.61825073e+03 3.61825067e+03 1.61824908e+03
 2.39781643e+02 5.19155128e+01 4.71520258e+00 3.86329961e-01
 1.36279300e+03 6.65180674e+02 3.03320362e+02 3.16146209e+02
 4.93034458e+01 4.78870197e+00 1.47253125e+01 4.30145130e-01
 1.18941469e+00 1.79871215e-01]
E = -525.5056454956541
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.507855         1
[INPUT] 0    0    [1    /1   ]  7618.25072935        1
[INPUT] 0    0    [1    /1   ]  3618.25067399        1
[INPUT] 0    0    [1    /1   ]  1618.24907827        1
[INPUT] 0    0    [1    /1   ]  239.781643016        1
[INPUT] 0    0    [1    /1   ]  51.9155128455        1
[INPUT] 0    0    [1    /1   ]  4.71520258351        1
[INPUT] 0    0    [1    /1   ]  0.386329960939       1
[INPUT] 1    0    [1    /1   ]  1362.79299977        1
[INPUT] 1    0    [1    /1   ]  665.180674056        1
[INPUT] 1    0    [1    /1   ]  303.320361852        1
[INPUT] 1    0    [1    /1   ]  316.146209424        1
[INPUT] 1    0    [1    /1   ]  49.3034458293        1
[INPUT] 1    0    [1    /1   ]  4.78870197122        1
[INPUT] 1    0    [1    /1   ]  14.7253125338        1
[INPUT] 1    0    [1    /1   ]  0.4301451299         1
[INPUT] 1    0    [1    /1   ]  1.18941468766        1
[INPUT] 1    0    [1    /1   ]  0.179871214676       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507855011856, 1.0]], [0, [7618.250729345249, 1.0]], [0, [3618.2506739949276, 1.0]], [0, [1618.2490782710543, 1.0]], [0, [239.78164301594927, 1.0]], [0, [51.91551284548772, 1.0]], [0, [4.715202583510247, 1.0]], [0, [0.3863299609392458, 1.0]], [1, [1362.79299976557, 1.0]], [1, [665.1806740564153, 1.0]], [1, [303.3203618515448, 1.0]], [1, [316.1462094243302, 1.0]], [1, [49.303445829300905, 1.0]], [1, [4.788701971217612, 1.0]], [1, [14.725312533784178, 1.0]], [1, [0.4301451299002997, 1.0]], [1, [1.1894146876643485, 1.0]], [1, [0.17987121467647813, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785501]
bas 1, expnt(s) = [7618.25072935]
bas 2, expnt(s) = [3618.25067399]
bas 3, expnt(s) = [1618.24907827]
bas 4, expnt(s) = [239.78164302]
bas 5, expnt(s) = [51.91551285]
bas 6, expnt(s) = [4.71520258]
bas 7, expnt(s) = [0.38632996]
bas 8, expnt(s) = [1362.79299977]
bas 9, expnt(s) = [665.18067406]
bas 10, expnt(s) = [303.32036185]
bas 11, expnt(s) = [316.14620942]
bas 12, expnt(s) = [49.30344583]
bas 13, expnt(s) = [4.78870197]
bas 14, expnt(s) = [14.72531253]
bas 15, expnt(s) = [0.43014513]
bas 16, expnt(s) = [1.18941469]
bas 17, expnt(s) = [0.17987121]
CPU time:        31.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825073e+03 2.06018619e+03
 3.61825067e+03 1.17866127e+03 1.61824908e+03 6.44612986e+02
 2.39781643e+02 1.53949036e+02 5.19155128e+01 4.88638729e+01
 4.71520258e+00 8.08426035e+00 3.86329961e-01 1.23803755e+00
 1.36279300e+03 2.41558186e+04 6.65180674e+02 9.85505202e+03
 3.03320362e+02 3.69284730e+03 3.16146209e+02 3.88905752e+03
 4.93034458e+01 3.81136888e+02 4.78870197e+00 2.06660109e+01
 1.47253125e+01 8.41521166e+01 4.30145130e-01 1.01625608e+00
 1.18941469e+00 3.62368980e+00 1.79871215e-01 3.41732652e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.975235815304096
cond(S) = 83507.68328750093
E1 = -727.5971538642127  E_coul = 203.12915907280046
init E= -524.467994791412
    CPU time for initialize scf      0.68 sec, wall time      0.08 sec
  HOMO = -0.56596992621668  LUMO = 0.616779802313026
  mo_energy =
[-1.17859585e+02 -1.20845133e+01 -9.43611720e+00 -9.43611720e+00
 -9.43611720e+00 -1.23737636e+00 -5.65969926e-01 -5.65969926e-01
 -5.65969926e-01  6.16779802e-01  6.16779802e-01  6.16779802e-01
  2.94814796e+00  2.94814796e+00  2.94814796e+00  1.71175286e+01
  1.71175286e+01  1.71175286e+01  8.71096604e+01  8.71096604e+01
  8.71096604e+01  1.83383167e+02  4.19611636e+02  4.19611636e+02
  4.19611636e+02  1.27343795e+03  1.27343795e+03  1.27343795e+03
  1.91500356e+03  2.97558294e+03  2.97558294e+03  2.97558294e+03
  6.60484659e+03  6.60484659e+03  6.60484659e+03  8.27342699e+03
  2.46612608e+04  7.54576352e+04]
E1 = -727.4572484079193  E_coul = 201.95174256627206
cycle= 1 E= -525.505505841647  delta_E= -1.04  |g|= 0.17  |ddm|= 0.253
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.422955
diis-c [-0.17889095  1.        ]
  HOMO = -0.576301367736935  LUMO = 0.618389616676345
  mo_energy =
[-1.18080087e+02 -1.21679166e+01 -9.51491812e+00 -9.51491812e+00
 -9.51491812e+00 -1.25530115e+00 -5.76301368e-01 -5.76301368e-01
 -5.76301368e-01  6.18389617e-01  6.18389617e-01  6.18389617e-01
  2.92971500e+00  2.92971500e+00  2.92971500e+00  1.70490488e+01
  1.70490488e+01  1.70490488e+01  8.69774697e+01  8.69774697e+01
  8.69774697e+01  1.83208035e+02  4.19402391e+02  4.19402391e+02
  4.19402391e+02  1.27318218e+03  1.27318218e+03  1.27318218e+03
  1.91463232e+03  2.97526894e+03  2.97526894e+03  2.97526894e+03
  6.60442082e+03  6.60442082e+03  6.60442082e+03  8.27292122e+03
  2.46606633e+04  7.54569476e+04]
E1 = -727.6445769634704  E_coul = 202.13893626094216
cycle= 2 E= -525.505640702528  delta_E= -0.000135  |g|= 0.0129  |ddm|= 0.0156
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0231968
diis-c [-4.78907371e-04  1.78878038e-02  9.82112196e-01]
  HOMO = -0.573478261768131  LUMO = 0.619460833546808
  mo_energy =
[-1.18053832e+02 -1.21546239e+01 -9.50150090e+00 -9.50150090e+00
 -9.50150090e+00 -1.25163608e+00 -5.73478262e-01 -5.73478262e-01
 -5.73478262e-01  6.19460834e-01  6.19460834e-01  6.19460834e-01
  2.93381025e+00  2.93381025e+00  2.93381025e+00  1.70605168e+01
  1.70605168e+01  1.70605168e+01  8.69972388e+01  8.69972388e+01
  8.69972388e+01  1.83233259e+02  4.19428358e+02  4.19428358e+02
  4.19428358e+02  1.27320990e+03  1.27320990e+03  1.27320990e+03
  1.91466119e+03  2.97529750e+03  2.97529750e+03  2.97529750e+03
  6.60444984e+03  6.60444984e+03  6.60444984e+03  8.27295040e+03
  2.46606924e+04  7.54569767e+04]
E1 = -727.6060514188074  E_coul = 202.10040608920065
cycle= 3 E= -525.505645329607  delta_E= -4.63e-06  |g|= 0.00206  |ddm|= 0.00277
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0038598
diis-c [-5.77028659e-08 -7.22043978e-04  1.38861250e-01  8.61860794e-01]
  HOMO = -0.573966575266  LUMO = 0.61928778888332
  mo_energy =
[-1.18057726e+02 -1.21568152e+01 -9.50372376e+00 -9.50372376e+00
 -9.50372376e+00 -1.25227873e+00 -5.73966575e-01 -5.73966575e-01
 -5.73966575e-01  6.19287789e-01  6.19287789e-01  6.19287789e-01
  2.93310797e+00  2.93310797e+00  2.93310797e+00  1.70586031e+01
  1.70586031e+01  1.70586031e+01  8.69941872e+01  8.69941872e+01
  8.69941872e+01  1.83229535e+02  4.19424507e+02  4.19424507e+02
  4.19424507e+02  1.27320582e+03  1.27320582e+03  1.27320582e+03
  1.91465692e+03  2.97529329e+03  2.97529329e+03  2.97529329e+03
  6.60444551e+03  6.60444551e+03  6.60444551e+03  8.27294601e+03
  2.46606880e+04  7.54569723e+04]
E1 = -727.6125514661998  E_coul = 202.10690597071724
cycle= 4 E= -525.505645495483  delta_E= -1.66e-07  |g|= 3.94e-05  |ddm|= 0.000551
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.51495e-05
diis-c [-9.21345826e-10 -4.35119172e-05  7.92602690e-03  5.96177020e-02
  9.32499783e-01]
  HOMO = -0.573939817380364  LUMO = 0.619298578968508
  mo_energy =
[-1.18057650e+02 -1.21567482e+01 -9.50365642e+00 -9.50365642e+00
 -9.50365642e+00 -1.25224587e+00 -5.73939817e-01 -5.73939817e-01
 -5.73939817e-01  6.19298579e-01  6.19298579e-01  6.19298579e-01
  2.93314274e+00  2.93314274e+00  2.93314274e+00  1.70586650e+01
  1.70586650e+01  1.70586650e+01  8.69942590e+01  8.69942590e+01
  8.69942590e+01  1.83229610e+02  4.19424582e+02  4.19424582e+02
  4.19424582e+02  1.27320589e+03  1.27320589e+03  1.27320589e+03
  1.91465699e+03  2.97529336e+03  2.97529336e+03  2.97529336e+03
  6.60444559e+03  6.60444559e+03  6.60444559e+03  8.27294608e+03
  2.46606881e+04  7.54569723e+04]
E1 = -727.6124128703115  E_coul = 202.10676737466008
cycle= 5 E= -525.505645495651  delta_E= -1.69e-10  |g|= 3.76e-06  |ddm|= 2.51e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.6124128703115  E_coul = 202.10676737466008
  HOMO = -0.573939085958522  LUMO = 0.619299057420435
  mo_energy =
[-1.18057653e+02 -1.21567496e+01 -9.50365788e+00 -9.50365788e+00
 -9.50365788e+00 -1.25224523e+00 -5.73939086e-01 -5.73939086e-01
 -5.73939086e-01  6.19299057e-01  6.19299057e-01  6.19299057e-01
  2.93314347e+00  2.93314347e+00  2.93314347e+00  1.70586641e+01
  1.70586641e+01  1.70586641e+01  8.69942568e+01  8.69942568e+01
  8.69942568e+01  1.83229607e+02  4.19424579e+02  4.19424579e+02
  4.19424579e+02  1.27320589e+03  1.27320589e+03  1.27320589e+03
  1.91465699e+03  2.97529336e+03  2.97529336e+03  2.97529336e+03
  6.60444558e+03  6.60444558e+03  6.60444558e+03  8.27294608e+03
  2.46606881e+04  7.54569723e+04]
E1 = -727.6124237747684  E_coul = 202.10677827911434
Extra cycle  E= -525.505645495654  delta_E= -2.73e-12  |g|= 6.18e-07  |ddm|= 5.34e-06
    CPU time for scf_cycle      0.87 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 83507.68328750093
E1 = -727.6124237747684  E_coul = 202.10677827911434
init E= -525.505645495654
    CPU time for initialize scf      1.09 sec, wall time      0.19 sec
  HOMO = -0.573938753180314  LUMO = 0.619299204889169
  mo_energy =
[-1.18057652e+02 -1.21567489e+01 -9.50365714e+00 -9.50365714e+00
 -9.50365714e+00 -1.25224484e+00 -5.73938753e-01 -5.73938753e-01
 -5.73938753e-01  6.19299205e-01  6.19299205e-01  6.19299205e-01
  2.93314389e+00  2.93314389e+00  2.93314389e+00  1.70586648e+01
  1.70586648e+01  1.70586648e+01  8.69942577e+01  8.69942577e+01
  8.69942577e+01  1.83229609e+02  4.19424580e+02  4.19424580e+02
  4.19424580e+02  1.27320589e+03  1.27320589e+03  1.27320589e+03
  1.91465699e+03  2.97529336e+03  2.97529336e+03  2.97529336e+03
  6.60444558e+03  6.60444558e+03  6.60444558e+03  8.27294608e+03
  2.46606881e+04  7.54569723e+04]
E1 = -727.6124225735749  E_coul = 202.10677707792155
cycle= 1 E= -525.505645495653  delta_E= 6.82e-13  |g|= 9.83e-08  |ddm|= 6.09e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.6124225735749  E_coul = 202.10677707792155
  HOMO = -0.573938759154152  LUMO = 0.619299206077562
  mo_energy =
[-1.18057652e+02 -1.21567490e+01 -9.50365723e+00 -9.50365723e+00
 -9.50365723e+00 -1.25224485e+00 -5.73938759e-01 -5.73938759e-01
 -5.73938759e-01  6.19299206e-01  6.19299206e-01  6.19299206e-01
  2.93314388e+00  2.93314388e+00  2.93314388e+00  1.70586647e+01
  1.70586647e+01  1.70586647e+01  8.69942576e+01  8.69942576e+01
  8.69942576e+01  1.83229608e+02  4.19424580e+02  4.19424580e+02
  4.19424580e+02  1.27320589e+03  1.27320589e+03  1.27320589e+03
  1.91465699e+03  2.97529336e+03  2.97529336e+03  2.97529336e+03
  6.60444558e+03  6.60444558e+03  6.60444558e+03  8.27294608e+03
  2.46606881e+04  7.54569723e+04]
E1 = -727.6124229621431  E_coul = 202.10677746648986
Extra cycle  E= -525.505645495653  delta_E= 2.27e-13  |g|= 1.98e-08  |ddm|= 9.34e-08
    CPU time for scf_cycle      1.46 sec, wall time      0.56 sec
exp = [2.61825079e+04 7.61825073e+03 3.61825067e+03 1.61824908e+03
 2.39781643e+02 5.19155128e+01 4.71520258e+00 3.86329961e-01
 1.36279300e+03 6.65180674e+02 3.03320362e+02 3.16146209e+02
 4.93034458e+01 4.78870197e+00 1.47253125e+01 4.30145130e-01
 1.18941469e+00 1.79871215e-01]
grad_E = [-1.98933267e-06  2.17696960e-05  4.34028001e-05  6.67707133e-04
  8.80306317e-04 -6.46551622e-03  1.06609329e-01 -1.96759372e-01
  1.25121590e-06  1.93665941e-05  1.04342961e-04  9.19117817e-05
 -5.80751568e-04  1.13537358e-02  1.46567970e-03 -1.79640092e-01
 -1.83456373e-02  2.46540165e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078571        1
[INPUT] 0    0    [1    /1   ]  7618.250707          1
[INPUT] 0    0    [1    /1   ]  3618.25062945        1
[INPUT] 0    0    [1    /1   ]  1618.24839303        1
[INPUT] 0    0    [1    /1   ]  239.780720882        1
[INPUT] 0    0    [1    /1   ]  51.9223929488        1
[INPUT] 0    0    [1    /1   ]  4.65455225878        1
[INPUT] 0    0    [1    /1   ]  0.391900539106       1
[INPUT] 1    0    [1    /1   ]  1362.79299846        1
[INPUT] 1    0    [1    /1   ]  665.180653978        1
[INPUT] 1    0    [1    /1   ]  303.320253528        1
[INPUT] 1    0    [1    /1   ]  316.146114008        1
[INPUT] 1    0    [1    /1   ]  49.3042200164        1
[INPUT] 1    0    [1    /1   ]  4.78397373367        1
[INPUT] 1    0    [1    /1   ]  14.7219542104        1
[INPUT] 1    0    [1    /1   ]  0.453279651631       1
[INPUT] 1    0    [1    /1   ]  1.21330759015        1
[INPUT] 1    0    [1    /1   ]  0.171567724691       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507857053584, 1.0]], [0, [7618.250707003067, 1.0]], [0, [3618.250629449862, 1.0]], [0, [1618.2483930344931, 1.0]], [0, [239.78072088235845, 1.0]], [0, [51.922392948830414, 1.0]], [0, [4.654552258782901, 1.0]], [0, [0.3919005391061746, 1.0]], [1, [1362.7929984553903, 1.0]], [1, [665.1806539780797, 1.0]], [1, [303.32025352844636, 1.0]], [1, [316.1461140078672, 1.0]], [1, [49.304220016391106, 1.0]], [1, [4.783973733668857, 1.0]], [1, [14.72195421041133, 1.0]], [1, [0.4532796516310684, 1.0]], [1, [1.2133075901548902, 1.0]], [1, [0.1715677246907471, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785705]
bas 1, expnt(s) = [7618.250707]
bas 2, expnt(s) = [3618.25062945]
bas 3, expnt(s) = [1618.24839303]
bas 4, expnt(s) = [239.78072088]
bas 5, expnt(s) = [51.92239295]
bas 6, expnt(s) = [4.65455226]
bas 7, expnt(s) = [0.39190054]
bas 8, expnt(s) = [1362.79299846]
bas 9, expnt(s) = [665.18065398]
bas 10, expnt(s) = [303.32025353]
bas 11, expnt(s) = [316.14611401]
bas 12, expnt(s) = [49.30422002]
bas 13, expnt(s) = [4.78397373]
bas 14, expnt(s) = [14.72195421]
bas 15, expnt(s) = [0.45327965]
bas 16, expnt(s) = [1.21330759]
bas 17, expnt(s) = [0.17156772]
CPU time:        38.38
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825071e+03 2.06018618e+03
 3.61825063e+03 1.17866126e+03 1.61824839e+03 6.44612782e+02
 2.39780721e+02 1.53948592e+02 5.19223929e+01 4.88687296e+01
 4.65455226e+00 8.00614511e+00 3.91900539e-01 1.25140222e+00
 1.36279300e+03 2.41558186e+04 6.65180654e+02 9.85505165e+03
 3.03320254e+02 3.69284565e+03 3.16146114e+02 3.88905605e+03
 4.93042200e+01 3.81144369e+02 4.78397373e+00 2.06405077e+01
 1.47219542e+01 8.41281271e+01 4.53279652e-01 1.08503106e+00
 1.21330759e+00 3.71490777e+00 1.71567725e-01 3.22128301e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977688103140117
cond(S) = 83523.98027735359
E1 = -727.5566869057031  E_coul = 203.1120134052047
init E= -524.444673500498
    CPU time for initialize scf      0.16 sec, wall time      0.04 sec
  HOMO = -0.563812295420607  LUMO = 0.608639509971327
  mo_energy =
[-1.17866936e+02 -1.20905722e+01 -9.43970604e+00 -9.43970604e+00
 -9.43970604e+00 -1.23396925e+00 -5.63812295e-01 -5.63812295e-01
 -5.63812295e-01  6.08639510e-01  6.08639510e-01  6.08639510e-01
  3.02568774e+00  3.02568774e+00  3.02568774e+00  1.72488348e+01
  1.72488348e+01  1.72488348e+01  8.71891788e+01  8.71891788e+01
  8.71891788e+01  1.83160686e+02  4.19656705e+02  4.19656705e+02
  4.19656705e+02  1.27347372e+03  1.27347372e+03  1.27347372e+03
  1.91485030e+03  2.97561492e+03  2.97561492e+03  2.97561492e+03
  6.60487459e+03  6.60487459e+03  6.60487459e+03  8.27329053e+03
  2.46611311e+04  7.54575136e+04]
E1 = -727.3069960021146  E_coul = 201.79019333952647
cycle= 1 E= -525.516802662588  delta_E= -1.07  |g|= 0.175  |ddm|= 0.333
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.433147
diis-c [-0.18761621  1.        ]
  HOMO = -0.578045878333331  LUMO = 0.607801837141399
  mo_energy =
[-1.18106731e+02 -1.21813804e+01 -9.52818666e+00 -9.52818666e+00
 -9.52818666e+00 -1.25660068e+00 -5.78045878e-01 -5.78045878e-01
 -5.78045878e-01  6.07801837e-01  6.07801837e-01  6.07801837e-01
  3.00148404e+00  3.00148404e+00  3.00148404e+00  1.71717022e+01
  1.71717022e+01  1.71717022e+01  8.70427965e+01  8.70427965e+01
  8.70427965e+01  1.82970401e+02  4.19428835e+02  4.19428835e+02
  4.19428835e+02  1.27319690e+03  1.27319690e+03  1.27319690e+03
  1.91445359e+03  2.97527730e+03  2.97527730e+03  2.97527730e+03
  6.60442233e+03  6.60442233e+03  6.60442233e+03  8.27275645e+03
  2.46605038e+04  7.54567954e+04]
E1 = -727.5210082732289  E_coul = 202.0040342993521
cycle= 2 E= -525.516973973877  delta_E= -0.000171  |g|= 0.0148  |ddm|= 0.0142
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0267324
diis-c [-6.04157784e-04  2.37271706e-02  9.76272829e-01]
  HOMO = -0.575008613227842  LUMO = 0.608937486561782
  mo_energy =
[-1.18076716e+02 -1.21662045e+01 -9.51282766e+00 -9.51282766e+00
 -9.51282766e+00 -1.25258137e+00 -5.75008613e-01 -5.75008613e-01
 -5.75008613e-01  6.08937487e-01  6.08937487e-01  6.08937487e-01
  3.00607792e+00  3.00607792e+00  3.00607792e+00  1.71847738e+01
  1.71847738e+01  1.71847738e+01  8.70654044e+01  8.70654044e+01
  8.70654044e+01  1.82999259e+02  4.19458518e+02  4.19458518e+02
  4.19458518e+02  1.27322857e+03  1.27322857e+03  1.27322857e+03
  1.91448655e+03  2.97530992e+03  2.97530992e+03  2.97530992e+03
  6.60445546e+03  6.60445546e+03  6.60445546e+03  8.27278978e+03
  2.46605372e+04  7.54568287e+04]
E1 = -727.4749542723285  E_coul = 201.95797405223067
cycle= 3 E= -525.516980220098  delta_E= -6.25e-06  |g|= 0.00231  |ddm|= 0.00342
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00431164
diis-c [-9.64753501e-08 -7.37652992e-04  1.34791329e-01  8.65946324e-01]
  HOMO = -0.575619937684189  LUMO = 0.608709167173053
  mo_energy =
[-1.18081140e+02 -1.21687411e+01 -9.51540604e+00 -9.51540604e+00
 -9.51540604e+00 -1.25337839e+00 -5.75619938e-01 -5.75619938e-01
 -5.75619938e-01  6.08709167e-01  6.08709167e-01  6.08709167e-01
  3.00519122e+00  3.00519122e+00  3.00519122e+00  1.71825424e+01
  1.71825424e+01  1.71825424e+01  8.70619122e+01  8.70619122e+01
  8.70619122e+01  1.82995025e+02  4.19454142e+02  4.19454142e+02
  4.19454142e+02  1.27322394e+03  1.27322394e+03  1.27322394e+03
  1.91448170e+03  2.97530514e+03  2.97530514e+03  2.97530514e+03
  6.60445056e+03  6.60445056e+03  6.60445056e+03  8.27278480e+03
  2.46605321e+04  7.54568236e+04]
E1 = -727.482384572239  E_coul = 201.96540413668657
cycle= 4 E= -525.516980435552  delta_E= -2.15e-07  |g|= 3.83e-05  |ddm|= 0.000577
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.47065e-05
diis-c [-3.44618788e-10 -3.87353878e-05  6.76558592e-03  5.62549747e-02
  9.37018175e-01]
  HOMO = -0.575597514584268  LUMO = 0.608717376498859
  mo_energy =
[-1.18081054e+02 -1.21686685e+01 -9.51533284e+00 -9.51533284e+00
 -9.51533284e+00 -1.25334928e+00 -5.75597515e-01 -5.75597515e-01
 -5.75597515e-01  6.08717376e-01  6.08717376e-01  6.08717376e-01
  3.00522230e+00  3.00522230e+00  3.00522230e+00  1.71826076e+01
  1.71826076e+01  1.71826076e+01  8.70619920e+01  8.70619920e+01
  8.70619920e+01  1.82995110e+02  4.19454227e+02  4.19454227e+02
  4.19454227e+02  1.27322402e+03  1.27322402e+03  1.27322402e+03
  1.91448178e+03  2.97530523e+03  2.97530523e+03  2.97530523e+03
  6.60445064e+03  6.60445064e+03  6.60445064e+03  8.27278488e+03
  2.46605322e+04  7.54568237e+04]
E1 = -727.4821876260289  E_coul = 201.96520719033242
cycle= 5 E= -525.516980435696  delta_E= -1.44e-10  |g|= 1.85e-06  |ddm|= 1.84e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4821876260289  E_coul = 201.96520719033242
  HOMO = -0.575598637665386  LUMO = 0.60871694059878
  mo_energy =
[-1.18081059e+02 -1.21686720e+01 -9.51533636e+00 -9.51533636e+00
 -9.51533636e+00 -1.25335070e+00 -5.75598638e-01 -5.75598638e-01
 -5.75598638e-01  6.08716941e-01  6.08716941e-01  6.08716941e-01
  3.00522076e+00  3.00522076e+00  3.00522076e+00  1.71826045e+01
  1.71826045e+01  1.71826045e+01  8.70619878e+01  8.70619878e+01
  8.70619878e+01  1.82995106e+02  4.19454222e+02  4.19454222e+02
  4.19454222e+02  1.27322402e+03  1.27322402e+03  1.27322402e+03
  1.91448178e+03  2.97530522e+03  2.97530522e+03  2.97530522e+03
  6.60445064e+03  6.60445064e+03  6.60445064e+03  8.27278488e+03
  2.46605322e+04  7.54568237e+04]
E1 = -727.4821965876602  E_coul = 201.96521615196366
Extra cycle  E= -525.516980435696  delta_E=    0  |g|= 4.47e-07  |ddm|= 7.78e-07
    CPU time for scf_cycle      0.35 sec, wall time      0.24 sec
exp = [2.61825079e+04 7.61825071e+03 3.61825063e+03 1.61824839e+03
 2.39780721e+02 5.19223929e+01 4.65455226e+00 3.91900539e-01
 1.36279300e+03 6.65180654e+02 3.03320254e+02 3.16146114e+02
 4.93042200e+01 4.78397373e+00 1.47219542e+01 4.53279652e-01
 1.21330759e+00 1.71567725e-01]
E = -525.5169804356965
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:28 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078571        1
[INPUT] 0    0    [1    /1   ]  7618.250707          1
[INPUT] 0    0    [1    /1   ]  3618.25062945        1
[INPUT] 0    0    [1    /1   ]  1618.24839303        1
[INPUT] 0    0    [1    /1   ]  239.780720882        1
[INPUT] 0    0    [1    /1   ]  51.9223929488        1
[INPUT] 0    0    [1    /1   ]  4.65455225878        1
[INPUT] 0    0    [1    /1   ]  0.391900539106       1
[INPUT] 1    0    [1    /1   ]  1362.79299846        1
[INPUT] 1    0    [1    /1   ]  665.180653978        1
[INPUT] 1    0    [1    /1   ]  303.320253528        1
[INPUT] 1    0    [1    /1   ]  316.146114008        1
[INPUT] 1    0    [1    /1   ]  49.3042200164        1
[INPUT] 1    0    [1    /1   ]  4.78397373367        1
[INPUT] 1    0    [1    /1   ]  14.7219542104        1
[INPUT] 1    0    [1    /1   ]  0.453279651631       1
[INPUT] 1    0    [1    /1   ]  1.21330759015        1
[INPUT] 1    0    [1    /1   ]  0.171567724691       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507857053584, 1.0]], [0, [7618.250707003067, 1.0]], [0, [3618.250629449862, 1.0]], [0, [1618.2483930344931, 1.0]], [0, [239.78072088235845, 1.0]], [0, [51.922392948830414, 1.0]], [0, [4.654552258782901, 1.0]], [0, [0.3919005391061746, 1.0]], [1, [1362.7929984553903, 1.0]], [1, [665.1806539780797, 1.0]], [1, [303.32025352844636, 1.0]], [1, [316.1461140078672, 1.0]], [1, [49.304220016391106, 1.0]], [1, [4.783973733668857, 1.0]], [1, [14.72195421041133, 1.0]], [1, [0.4532796516310684, 1.0]], [1, [1.2133075901548902, 1.0]], [1, [0.1715677246907471, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785705]
bas 1, expnt(s) = [7618.250707]
bas 2, expnt(s) = [3618.25062945]
bas 3, expnt(s) = [1618.24839303]
bas 4, expnt(s) = [239.78072088]
bas 5, expnt(s) = [51.92239295]
bas 6, expnt(s) = [4.65455226]
bas 7, expnt(s) = [0.39190054]
bas 8, expnt(s) = [1362.79299846]
bas 9, expnt(s) = [665.18065398]
bas 10, expnt(s) = [303.32025353]
bas 11, expnt(s) = [316.14611401]
bas 12, expnt(s) = [49.30422002]
bas 13, expnt(s) = [4.78397373]
bas 14, expnt(s) = [14.72195421]
bas 15, expnt(s) = [0.45327965]
bas 16, expnt(s) = [1.21330759]
bas 17, expnt(s) = [0.17156772]
CPU time:        38.83
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825071e+03 2.06018618e+03
 3.61825063e+03 1.17866126e+03 1.61824839e+03 6.44612782e+02
 2.39780721e+02 1.53948592e+02 5.19223929e+01 4.88687296e+01
 4.65455226e+00 8.00614511e+00 3.91900539e-01 1.25140222e+00
 1.36279300e+03 2.41558186e+04 6.65180654e+02 9.85505165e+03
 3.03320254e+02 3.69284565e+03 3.16146114e+02 3.88905605e+03
 4.93042200e+01 3.81144369e+02 4.78397373e+00 2.06405077e+01
 1.47219542e+01 8.41281271e+01 4.53279652e-01 1.08503106e+00
 1.21330759e+00 3.71490777e+00 1.71567725e-01 3.22128301e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977688103140117
cond(S) = 83523.98027735359
E1 = -727.5566869057031  E_coul = 203.1120134052047
init E= -524.444673500498
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.563812295420607  LUMO = 0.608639509971327
  mo_energy =
[-1.17866936e+02 -1.20905722e+01 -9.43970604e+00 -9.43970604e+00
 -9.43970604e+00 -1.23396925e+00 -5.63812295e-01 -5.63812295e-01
 -5.63812295e-01  6.08639510e-01  6.08639510e-01  6.08639510e-01
  3.02568774e+00  3.02568774e+00  3.02568774e+00  1.72488348e+01
  1.72488348e+01  1.72488348e+01  8.71891788e+01  8.71891788e+01
  8.71891788e+01  1.83160686e+02  4.19656705e+02  4.19656705e+02
  4.19656705e+02  1.27347372e+03  1.27347372e+03  1.27347372e+03
  1.91485030e+03  2.97561492e+03  2.97561492e+03  2.97561492e+03
  6.60487459e+03  6.60487459e+03  6.60487459e+03  8.27329053e+03
  2.46611311e+04  7.54575136e+04]
E1 = -727.3069960021146  E_coul = 201.79019333952647
cycle= 1 E= -525.516802662588  delta_E= -1.07  |g|= 0.175  |ddm|= 0.333
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.433147
diis-c [-0.18761621  1.        ]
  HOMO = -0.578045878333331  LUMO = 0.607801837141399
  mo_energy =
[-1.18106731e+02 -1.21813804e+01 -9.52818666e+00 -9.52818666e+00
 -9.52818666e+00 -1.25660068e+00 -5.78045878e-01 -5.78045878e-01
 -5.78045878e-01  6.07801837e-01  6.07801837e-01  6.07801837e-01
  3.00148404e+00  3.00148404e+00  3.00148404e+00  1.71717022e+01
  1.71717022e+01  1.71717022e+01  8.70427965e+01  8.70427965e+01
  8.70427965e+01  1.82970401e+02  4.19428835e+02  4.19428835e+02
  4.19428835e+02  1.27319690e+03  1.27319690e+03  1.27319690e+03
  1.91445359e+03  2.97527730e+03  2.97527730e+03  2.97527730e+03
  6.60442233e+03  6.60442233e+03  6.60442233e+03  8.27275645e+03
  2.46605038e+04  7.54567954e+04]
E1 = -727.5210082732289  E_coul = 202.0040342993521
cycle= 2 E= -525.516973973877  delta_E= -0.000171  |g|= 0.0148  |ddm|= 0.0142
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0267324
diis-c [-6.04157784e-04  2.37271706e-02  9.76272829e-01]
  HOMO = -0.575008613227842  LUMO = 0.608937486561782
  mo_energy =
[-1.18076716e+02 -1.21662045e+01 -9.51282766e+00 -9.51282766e+00
 -9.51282766e+00 -1.25258137e+00 -5.75008613e-01 -5.75008613e-01
 -5.75008613e-01  6.08937487e-01  6.08937487e-01  6.08937487e-01
  3.00607792e+00  3.00607792e+00  3.00607792e+00  1.71847738e+01
  1.71847738e+01  1.71847738e+01  8.70654044e+01  8.70654044e+01
  8.70654044e+01  1.82999259e+02  4.19458518e+02  4.19458518e+02
  4.19458518e+02  1.27322857e+03  1.27322857e+03  1.27322857e+03
  1.91448655e+03  2.97530992e+03  2.97530992e+03  2.97530992e+03
  6.60445546e+03  6.60445546e+03  6.60445546e+03  8.27278978e+03
  2.46605372e+04  7.54568287e+04]
E1 = -727.4749542723285  E_coul = 201.95797405223067
cycle= 3 E= -525.516980220098  delta_E= -6.25e-06  |g|= 0.00231  |ddm|= 0.00342
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00431164
diis-c [-9.64753501e-08 -7.37652992e-04  1.34791329e-01  8.65946324e-01]
  HOMO = -0.575619937684189  LUMO = 0.608709167173053
  mo_energy =
[-1.18081140e+02 -1.21687411e+01 -9.51540604e+00 -9.51540604e+00
 -9.51540604e+00 -1.25337839e+00 -5.75619938e-01 -5.75619938e-01
 -5.75619938e-01  6.08709167e-01  6.08709167e-01  6.08709167e-01
  3.00519122e+00  3.00519122e+00  3.00519122e+00  1.71825424e+01
  1.71825424e+01  1.71825424e+01  8.70619122e+01  8.70619122e+01
  8.70619122e+01  1.82995025e+02  4.19454142e+02  4.19454142e+02
  4.19454142e+02  1.27322394e+03  1.27322394e+03  1.27322394e+03
  1.91448170e+03  2.97530514e+03  2.97530514e+03  2.97530514e+03
  6.60445056e+03  6.60445056e+03  6.60445056e+03  8.27278480e+03
  2.46605321e+04  7.54568236e+04]
E1 = -727.482384572239  E_coul = 201.96540413668657
cycle= 4 E= -525.516980435552  delta_E= -2.15e-07  |g|= 3.83e-05  |ddm|= 0.000577
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.47065e-05
diis-c [-3.44618788e-10 -3.87353878e-05  6.76558592e-03  5.62549747e-02
  9.37018175e-01]
  HOMO = -0.575597514584268  LUMO = 0.608717376498859
  mo_energy =
[-1.18081054e+02 -1.21686685e+01 -9.51533284e+00 -9.51533284e+00
 -9.51533284e+00 -1.25334928e+00 -5.75597515e-01 -5.75597515e-01
 -5.75597515e-01  6.08717376e-01  6.08717376e-01  6.08717376e-01
  3.00522230e+00  3.00522230e+00  3.00522230e+00  1.71826076e+01
  1.71826076e+01  1.71826076e+01  8.70619920e+01  8.70619920e+01
  8.70619920e+01  1.82995110e+02  4.19454227e+02  4.19454227e+02
  4.19454227e+02  1.27322402e+03  1.27322402e+03  1.27322402e+03
  1.91448178e+03  2.97530523e+03  2.97530523e+03  2.97530523e+03
  6.60445064e+03  6.60445064e+03  6.60445064e+03  8.27278488e+03
  2.46605322e+04  7.54568237e+04]
E1 = -727.4821876260289  E_coul = 201.96520719033242
cycle= 5 E= -525.516980435696  delta_E= -1.44e-10  |g|= 1.85e-06  |ddm|= 1.84e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4821876260289  E_coul = 201.96520719033242
  HOMO = -0.575598637665386  LUMO = 0.60871694059878
  mo_energy =
[-1.18081059e+02 -1.21686720e+01 -9.51533636e+00 -9.51533636e+00
 -9.51533636e+00 -1.25335070e+00 -5.75598638e-01 -5.75598638e-01
 -5.75598638e-01  6.08716941e-01  6.08716941e-01  6.08716941e-01
  3.00522076e+00  3.00522076e+00  3.00522076e+00  1.71826045e+01
  1.71826045e+01  1.71826045e+01  8.70619878e+01  8.70619878e+01
  8.70619878e+01  1.82995106e+02  4.19454222e+02  4.19454222e+02
  4.19454222e+02  1.27322402e+03  1.27322402e+03  1.27322402e+03
  1.91448178e+03  2.97530522e+03  2.97530522e+03  2.97530522e+03
  6.60445064e+03  6.60445064e+03  6.60445064e+03  8.27278488e+03
  2.46605322e+04  7.54568237e+04]
E1 = -727.4821965876602  E_coul = 201.96521615196366
Extra cycle  E= -525.516980435696  delta_E=    0  |g|= 4.47e-07  |ddm|= 7.78e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 83523.98027735359
E1 = -727.4821965876602  E_coul = 201.96521615196366
init E= -525.516980435696
    CPU time for initialize scf      0.95 sec, wall time      0.18 sec
  HOMO = -0.57559847400513  LUMO = 0.60871699904029
  mo_energy =
[-1.18081058e+02 -1.21686713e+01 -9.51533568e+00 -9.51533568e+00
 -9.51533568e+00 -1.25335048e+00 -5.75598474e-01 -5.75598474e-01
 -5.75598474e-01  6.08716999e-01  6.08716999e-01  6.08716999e-01
  3.00522100e+00  3.00522100e+00  3.00522100e+00  1.71826051e+01
  1.71826051e+01  1.71826051e+01  8.70619887e+01  8.70619887e+01
  8.70619887e+01  1.82995107e+02  4.19454223e+02  4.19454223e+02
  4.19454223e+02  1.27322402e+03  1.27322402e+03  1.27322402e+03
  1.91448178e+03  2.97530522e+03  2.97530522e+03  2.97530522e+03
  6.60445064e+03  6.60445064e+03  6.60445064e+03  8.27278488e+03
  2.46605322e+04  7.54568237e+04]
E1 = -727.4821945971183  E_coul = 201.96521416142286
cycle= 1 E= -525.516980435695  delta_E= 1.02e-12  |g|= 1.01e-07  |ddm|= 1.82e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.4821945971183  E_coul = 201.96521416142286
  HOMO = -0.575598512888486  LUMO = 0.608716984272501
  mo_energy =
[-1.18081058e+02 -1.21686715e+01 -9.51533582e+00 -9.51533582e+00
 -9.51533582e+00 -1.25335053e+00 -5.75598513e-01 -5.75598513e-01
 -5.75598513e-01  6.08716984e-01  6.08716984e-01  6.08716984e-01
  3.00522094e+00  3.00522094e+00  3.00522094e+00  1.71826049e+01
  1.71826049e+01  1.71826049e+01  8.70619885e+01  8.70619885e+01
  8.70619885e+01  1.82995106e+02  4.19454223e+02  4.19454223e+02
  4.19454223e+02  1.27322402e+03  1.27322402e+03  1.27322402e+03
  1.91448178e+03  2.97530522e+03  2.97530522e+03  2.97530522e+03
  6.60445064e+03  6.60445064e+03  6.60445064e+03  8.27278488e+03
  2.46605322e+04  7.54568237e+04]
E1 = -727.4821950088212  E_coul = 201.96521457312494
Extra cycle  E= -525.516980435696  delta_E= -7.96e-13  |g|= 2.18e-08  |ddm|= 3.2e-08
    CPU time for scf_cycle      1.07 sec, wall time      0.31 sec
exp = [2.61825079e+04 7.61825071e+03 3.61825063e+03 1.61824839e+03
 2.39780721e+02 5.19223929e+01 4.65455226e+00 3.91900539e-01
 1.36279300e+03 6.65180654e+02 3.03320254e+02 3.16146114e+02
 4.93042200e+01 4.78397373e+00 1.47219542e+01 4.53279652e-01
 1.21330759e+00 1.71567725e-01]
grad_E = [-1.98768830e-06  2.17665720e-05  4.34149066e-05  6.67692521e-04
  8.54387388e-04 -6.37971214e-03  4.97394420e-02 -1.07540815e-01
  1.27028012e-06  1.95107270e-05  1.05237187e-04  9.26975531e-05
 -7.39725536e-04  9.22016475e-06  3.61035444e-03 -1.06735242e-01
 -3.16783939e-02  1.57669984e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.507863         1
[INPUT] 0    0    [1    /1   ]  7618.25064185        1
[INPUT] 0    0    [1    /1   ]  3618.25049951        1
[INPUT] 0    0    [1    /1   ]  1618.24639464        1
[INPUT] 0    0    [1    /1   ]  239.778109243        1
[INPUT] 0    0    [1    /1   ]  51.9420266272        1
[INPUT] 0    0    [1    /1   ]  4.58974103503        1
[INPUT] 0    0    [1    /1   ]  0.39896688924        1
[INPUT] 1    0    [1    /1   ]  1362.7929946         1
[INPUT] 1    0    [1    /1   ]  665.180595196        1
[INPUT] 1    0    [1    /1   ]  303.319936209        1
[INPUT] 1    0    [1    /1   ]  316.145834501        1
[INPUT] 1    0    [1    /1   ]  49.3067449032        1
[INPUT] 1    0    [1    /1   ]  4.79222206588        1
[INPUT] 1    0    [1    /1   ]  14.7082727338        1
[INPUT] 1    0    [1    /1   ]  0.494835148679       1
[INPUT] 1    0    [1    /1   ]  1.30474669838        1
[INPUT] 1    0    [1    /1   ]  0.146768677659       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.50786300388, 1.0]], [0, [7618.2506418526045, 1.0]], [0, [3618.2504995098843, 1.0]], [0, [1618.2463946422986, 1.0]], [0, [239.77810924289503, 1.0]], [0, [51.942026627204, 1.0]], [0, [4.589741035033793, 1.0]], [0, [0.3989668892399854, 1.0]], [1, [1362.7929946045606, 1.0]], [1, [665.1805951959946, 1.0]], [1, [303.3199362091647, 1.0]], [1, [316.14583450071257, 1.0]], [1, [49.30674490315869, 1.0]], [1, [4.792222065884068, 1.0]], [1, [14.708272733792262, 1.0]], [1, [0.49483514867860945, 1.0]], [1, [1.3047466983817577, 1.0]], [1, [0.14676867765910784, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.507863]
bas 1, expnt(s) = [7618.25064185]
bas 2, expnt(s) = [3618.25049951]
bas 3, expnt(s) = [1618.24639464]
bas 4, expnt(s) = [239.77810924]
bas 5, expnt(s) = [51.94202663]
bas 6, expnt(s) = [4.58974104]
bas 7, expnt(s) = [0.39896689]
bas 8, expnt(s) = [1362.7929946]
bas 9, expnt(s) = [665.1805952]
bas 10, expnt(s) = [303.31993621]
bas 11, expnt(s) = [316.1458345]
bas 12, expnt(s) = [49.3067449]
bas 13, expnt(s) = [4.79222207]
bas 14, expnt(s) = [14.70827273]
bas 15, expnt(s) = [0.49483515]
bas 16, expnt(s) = [1.3047467]
bas 17, expnt(s) = [0.14676868]
CPU time:        44.45
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825064e+03 2.06018617e+03
 3.61825050e+03 1.17866123e+03 1.61824639e+03 6.44612185e+02
 2.39778109e+02 1.53947334e+02 5.19420266e+01 4.88825882e+01
 4.58974104e+00 7.92238896e+00 3.98966889e-01 1.26828736e+00
 1.36279299e+03 2.41558185e+04 6.65180595e+02 9.85505056e+03
 3.03319936e+02 3.69284082e+03 3.16145835e+02 3.88905175e+03
 4.93067449e+01 3.81168768e+02 4.79222207e+00 2.06850017e+01
 1.47082727e+01 8.40304106e+01 4.94835149e-01 1.21076559e+00
 1.30474670e+00 4.06810497e+00 1.46768678e-01 2.65018456e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977196430220445
cond(S) = 83582.82157069718
E1 = -727.4645496504087  E_coul = 203.07697044251796
init E= -524.387579207891
    CPU time for initialize scf      0.35 sec, wall time      0.06 sec
  HOMO = -0.56102331665805  LUMO = 0.551450346689336
  mo_energy =
[-1.17875920e+02 -1.20966769e+01 -9.44524885e+00 -9.44524885e+00
 -9.44524885e+00 -1.23055474e+00 -5.61023317e-01 -5.61023317e-01
 -5.61023317e-01  5.51450347e-01  5.51450347e-01  5.51450347e-01
  3.19013090e+00  3.19013090e+00  3.19013090e+00  1.76717494e+01
  1.76717494e+01  1.76717494e+01  8.75031154e+01  8.75031154e+01
  8.75031154e+01  1.82958785e+02  4.19857631e+02  4.19857631e+02
  4.19857631e+02  1.27364069e+03  1.27364069e+03  1.27364069e+03
  1.91472664e+03  2.97576660e+03  2.97576660e+03  2.97576660e+03
  6.60501055e+03  6.60501055e+03  6.60501055e+03  8.27317856e+03
  2.46610225e+04  7.54574106e+04]
E1 = -727.0494738371493  E_coul = 201.52751917362903
cycle= 1 E= -525.52195466352  delta_E= -1.13  |g|= 0.184  |ddm|= 0.684
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.448908
diis-c [-0.20151806  1.        ]
  HOMO = -0.582733973268234  LUMO = 0.547022893030538
  mo_energy =
[-1.18142184e+02 -1.21997945e+01 -9.54841585e+00 -9.54841585e+00
 -9.54841585e+00 -1.26195118e+00 -5.82733973e-01 -5.82733973e-01
 -5.82733973e-01  5.47022893e-01  5.47022893e-01  5.47022893e-01
  3.15420381e+00  3.15420381e+00  3.15420381e+00  1.75812536e+01
  1.75812536e+01  1.75812536e+01  8.73364322e+01  8.73364322e+01
  8.73364322e+01  1.82746500e+02  4.19604123e+02  4.19604123e+02
  4.19604123e+02  1.27333569e+03  1.27333569e+03  1.27333569e+03
  1.91429723e+03  2.97539817e+03  2.97539817e+03  2.97539817e+03
  6.60452456e+03  6.60452456e+03  6.60452456e+03  8.27260891e+03
  2.46603583e+04  7.54566544e+04]
E1 = -727.2883181943454  E_coul = 201.7660885886939
cycle= 2 E= -525.522229605652  delta_E= -0.000275  |g|= 0.0174  |ddm|= 0.0237
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0316947
diis-c [-7.89024068e-04  3.17281305e-02  9.68271870e-01]
  HOMO = -0.579887568907242  LUMO = 0.54799694774948
  mo_energy =
[-1.18107899e+02 -1.21828114e+01 -9.53116283e+00 -9.53116283e+00
 -9.53116283e+00 -1.25799983e+00 -5.79887569e-01 -5.79887569e-01
 -5.79887569e-01  5.47996948e-01  5.47996948e-01  5.47996948e-01
  3.15908963e+00  3.15908963e+00  3.15908963e+00  1.75957829e+01
  1.75957829e+01  1.75957829e+01  8.73620927e+01  8.73620927e+01
  8.73620927e+01  1.82779453e+02  4.19638014e+02  4.19638014e+02
  4.19638014e+02  1.27337188e+03  1.27337188e+03  1.27337188e+03
  1.91433488e+03  2.97543542e+03  2.97543542e+03  2.97543542e+03
  6.60456242e+03  6.60456242e+03  6.60456242e+03  8.27264702e+03
  2.46603964e+04  7.54566925e+04]
E1 = -727.2310533775209  E_coul = 201.70881442056458
cycle= 3 E= -525.522238956956  delta_E= -9.35e-06  |g|= 0.00263  |ddm|= 0.00493
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0048477
diis-c [-4.01519957e-07 -7.46241095e-04  1.27750998e-01  8.72995243e-01]
  HOMO = -0.580736823086843  LUMO = 0.547663795475641
  mo_energy =
[-1.18113030e+02 -1.21858607e+01 -9.53426587e+00 -9.53426587e+00
 -9.53426587e+00 -1.25908797e+00 -5.80736823e-01 -5.80736823e-01
 -5.80736823e-01  5.47663795e-01  5.47663795e-01  5.47663795e-01
  3.15781939e+00  3.15781939e+00  3.15781939e+00  1.75930623e+01
  1.75930623e+01  1.75930623e+01  8.73579888e+01  8.73579888e+01
  8.73579888e+01  1.82774534e+02  4.19632936e+02  4.19632936e+02
  4.19632936e+02  1.27336652e+03  1.27336652e+03  1.27336652e+03
  1.91432928e+03  2.97542991e+03  2.97542991e+03  2.97542991e+03
  6.60455676e+03  6.60455676e+03  6.60455676e+03  8.27264127e+03
  2.46603906e+04  7.54566866e+04]
E1 = -727.2400622491682  E_coul = 201.71782297673744
cycle= 4 E= -525.522239272431  delta_E= -3.15e-07  |g|= 7.68e-05  |ddm|= 0.000706
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000128312
diis-c [-2.11616217e-09  1.07908799e-05 -2.24902506e-03  9.45873623e-03
  9.92779498e-01]
  HOMO = -0.580717505850637  LUMO = 0.547668166024277
  mo_energy =
[-1.18112888e+02 -1.21857494e+01 -9.53415268e+00 -9.53415268e+00
 -9.53415268e+00 -1.25905846e+00 -5.80717506e-01 -5.80717506e-01
 -5.80717506e-01  5.47668166e-01  5.47668166e-01  5.47668166e-01
  3.15785282e+00  3.15785282e+00  3.15785282e+00  1.75931584e+01
  1.75931584e+01  1.75931584e+01  8.73581166e+01  8.73581166e+01
  8.73581166e+01  1.82774674e+02  4.19633077e+02  4.19633077e+02
  4.19633077e+02  1.27336666e+03  1.27336666e+03  1.27336666e+03
  1.91432942e+03  2.97543005e+03  2.97543005e+03  2.97543005e+03
  6.60455690e+03  6.60455690e+03  6.60455690e+03  8.27264140e+03
  2.46603907e+04  7.54566868e+04]
E1 = -727.2396520332915  E_coul = 201.71741276000353
cycle= 5 E= -525.522239273288  delta_E= -8.57e-10  |g|= 8.84e-06  |ddm|= 7.16e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.2396520332915  E_coul = 201.71741276000353
  HOMO = -0.580724114140529  LUMO = 0.547665371554573
  mo_energy =
[-1.18112906e+02 -1.21857647e+01 -9.53416801e+00 -9.53416801e+00
 -9.53416801e+00 -1.25906652e+00 -5.80724114e-01 -5.80724114e-01
 -5.80724114e-01  5.47665372e-01  5.47665372e-01  5.47665372e-01
  3.15784369e+00  3.15784369e+00  3.15784369e+00  1.75931442e+01
  1.75931442e+01  1.75931442e+01  8.73580998e+01  8.73580998e+01
  8.73580998e+01  1.82774656e+02  4.19633059e+02  4.19633059e+02
  4.19633059e+02  1.27336664e+03  1.27336664e+03  1.27336664e+03
  1.91432940e+03  2.97543003e+03  2.97543003e+03  2.97543003e+03
  6.60455688e+03  6.60455688e+03  6.60455688e+03  8.27264139e+03
  2.46603907e+04  7.54566868e+04]
E1 = -727.2396867021946  E_coul = 201.7174474288981
Extra cycle  E= -525.522239273296  delta_E= -8.53e-12  |g|= 1.75e-06  |ddm|= 6e-06
    CPU time for scf_cycle      0.55 sec, wall time      0.25 sec
exp = [2.61825079e+04 7.61825064e+03 3.61825050e+03 1.61824639e+03
 2.39778109e+02 5.19420266e+01 4.58974104e+00 3.98966889e-01
 1.36279299e+03 6.65180595e+02 3.03319936e+02 3.16145835e+02
 4.93067449e+01 4.79222207e+00 1.47082727e+01 4.94835149e-01
 1.30474670e+00 1.46768678e-01]
E = -525.5222392732965
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.507863         1
[INPUT] 0    0    [1    /1   ]  7618.25064185        1
[INPUT] 0    0    [1    /1   ]  3618.25049951        1
[INPUT] 0    0    [1    /1   ]  1618.24639464        1
[INPUT] 0    0    [1    /1   ]  239.778109243        1
[INPUT] 0    0    [1    /1   ]  51.9420266272        1
[INPUT] 0    0    [1    /1   ]  4.58974103503        1
[INPUT] 0    0    [1    /1   ]  0.39896688924        1
[INPUT] 1    0    [1    /1   ]  1362.7929946         1
[INPUT] 1    0    [1    /1   ]  665.180595196        1
[INPUT] 1    0    [1    /1   ]  303.319936209        1
[INPUT] 1    0    [1    /1   ]  316.145834501        1
[INPUT] 1    0    [1    /1   ]  49.3067449032        1
[INPUT] 1    0    [1    /1   ]  4.79222206588        1
[INPUT] 1    0    [1    /1   ]  14.7082727338        1
[INPUT] 1    0    [1    /1   ]  0.494835148679       1
[INPUT] 1    0    [1    /1   ]  1.30474669838        1
[INPUT] 1    0    [1    /1   ]  0.146768677659       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.50786300388, 1.0]], [0, [7618.2506418526045, 1.0]], [0, [3618.2504995098843, 1.0]], [0, [1618.2463946422986, 1.0]], [0, [239.77810924289503, 1.0]], [0, [51.942026627204, 1.0]], [0, [4.589741035033793, 1.0]], [0, [0.3989668892399854, 1.0]], [1, [1362.7929946045606, 1.0]], [1, [665.1805951959946, 1.0]], [1, [303.3199362091647, 1.0]], [1, [316.14583450071257, 1.0]], [1, [49.30674490315869, 1.0]], [1, [4.792222065884068, 1.0]], [1, [14.708272733792262, 1.0]], [1, [0.49483514867860945, 1.0]], [1, [1.3047466983817577, 1.0]], [1, [0.14676867765910784, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.507863]
bas 1, expnt(s) = [7618.25064185]
bas 2, expnt(s) = [3618.25049951]
bas 3, expnt(s) = [1618.24639464]
bas 4, expnt(s) = [239.77810924]
bas 5, expnt(s) = [51.94202663]
bas 6, expnt(s) = [4.58974104]
bas 7, expnt(s) = [0.39896689]
bas 8, expnt(s) = [1362.7929946]
bas 9, expnt(s) = [665.1805952]
bas 10, expnt(s) = [303.31993621]
bas 11, expnt(s) = [316.1458345]
bas 12, expnt(s) = [49.3067449]
bas 13, expnt(s) = [4.79222207]
bas 14, expnt(s) = [14.70827273]
bas 15, expnt(s) = [0.49483515]
bas 16, expnt(s) = [1.3047467]
bas 17, expnt(s) = [0.14676868]
CPU time:        45.10
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825064e+03 2.06018617e+03
 3.61825050e+03 1.17866123e+03 1.61824639e+03 6.44612185e+02
 2.39778109e+02 1.53947334e+02 5.19420266e+01 4.88825882e+01
 4.58974104e+00 7.92238896e+00 3.98966889e-01 1.26828736e+00
 1.36279299e+03 2.41558185e+04 6.65180595e+02 9.85505056e+03
 3.03319936e+02 3.69284082e+03 3.16145835e+02 3.88905175e+03
 4.93067449e+01 3.81168768e+02 4.79222207e+00 2.06850017e+01
 1.47082727e+01 8.40304106e+01 4.94835149e-01 1.21076559e+00
 1.30474670e+00 4.06810497e+00 1.46768678e-01 2.65018456e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977196430220445
cond(S) = 83582.82157069718
E1 = -727.4645496504087  E_coul = 203.07697044251796
init E= -524.387579207891
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.56102331665805  LUMO = 0.551450346689336
  mo_energy =
[-1.17875920e+02 -1.20966769e+01 -9.44524885e+00 -9.44524885e+00
 -9.44524885e+00 -1.23055474e+00 -5.61023317e-01 -5.61023317e-01
 -5.61023317e-01  5.51450347e-01  5.51450347e-01  5.51450347e-01
  3.19013090e+00  3.19013090e+00  3.19013090e+00  1.76717494e+01
  1.76717494e+01  1.76717494e+01  8.75031154e+01  8.75031154e+01
  8.75031154e+01  1.82958785e+02  4.19857631e+02  4.19857631e+02
  4.19857631e+02  1.27364069e+03  1.27364069e+03  1.27364069e+03
  1.91472664e+03  2.97576660e+03  2.97576660e+03  2.97576660e+03
  6.60501055e+03  6.60501055e+03  6.60501055e+03  8.27317856e+03
  2.46610225e+04  7.54574106e+04]
E1 = -727.0494738371493  E_coul = 201.52751917362903
cycle= 1 E= -525.52195466352  delta_E= -1.13  |g|= 0.184  |ddm|= 0.684
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.448908
diis-c [-0.20151806  1.        ]
  HOMO = -0.582733973268234  LUMO = 0.547022893030538
  mo_energy =
[-1.18142184e+02 -1.21997945e+01 -9.54841585e+00 -9.54841585e+00
 -9.54841585e+00 -1.26195118e+00 -5.82733973e-01 -5.82733973e-01
 -5.82733973e-01  5.47022893e-01  5.47022893e-01  5.47022893e-01
  3.15420381e+00  3.15420381e+00  3.15420381e+00  1.75812536e+01
  1.75812536e+01  1.75812536e+01  8.73364322e+01  8.73364322e+01
  8.73364322e+01  1.82746500e+02  4.19604123e+02  4.19604123e+02
  4.19604123e+02  1.27333569e+03  1.27333569e+03  1.27333569e+03
  1.91429723e+03  2.97539817e+03  2.97539817e+03  2.97539817e+03
  6.60452456e+03  6.60452456e+03  6.60452456e+03  8.27260891e+03
  2.46603583e+04  7.54566544e+04]
E1 = -727.2883181943454  E_coul = 201.7660885886939
cycle= 2 E= -525.522229605652  delta_E= -0.000275  |g|= 0.0174  |ddm|= 0.0237
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0316947
diis-c [-7.89024068e-04  3.17281305e-02  9.68271870e-01]
  HOMO = -0.579887568907242  LUMO = 0.54799694774948
  mo_energy =
[-1.18107899e+02 -1.21828114e+01 -9.53116283e+00 -9.53116283e+00
 -9.53116283e+00 -1.25799983e+00 -5.79887569e-01 -5.79887569e-01
 -5.79887569e-01  5.47996948e-01  5.47996948e-01  5.47996948e-01
  3.15908963e+00  3.15908963e+00  3.15908963e+00  1.75957829e+01
  1.75957829e+01  1.75957829e+01  8.73620927e+01  8.73620927e+01
  8.73620927e+01  1.82779453e+02  4.19638014e+02  4.19638014e+02
  4.19638014e+02  1.27337188e+03  1.27337188e+03  1.27337188e+03
  1.91433488e+03  2.97543542e+03  2.97543542e+03  2.97543542e+03
  6.60456242e+03  6.60456242e+03  6.60456242e+03  8.27264702e+03
  2.46603964e+04  7.54566925e+04]
E1 = -727.2310533775209  E_coul = 201.70881442056458
cycle= 3 E= -525.522238956956  delta_E= -9.35e-06  |g|= 0.00263  |ddm|= 0.00493
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0048477
diis-c [-4.01519957e-07 -7.46241095e-04  1.27750998e-01  8.72995243e-01]
  HOMO = -0.580736823086843  LUMO = 0.547663795475641
  mo_energy =
[-1.18113030e+02 -1.21858607e+01 -9.53426587e+00 -9.53426587e+00
 -9.53426587e+00 -1.25908797e+00 -5.80736823e-01 -5.80736823e-01
 -5.80736823e-01  5.47663795e-01  5.47663795e-01  5.47663795e-01
  3.15781939e+00  3.15781939e+00  3.15781939e+00  1.75930623e+01
  1.75930623e+01  1.75930623e+01  8.73579888e+01  8.73579888e+01
  8.73579888e+01  1.82774534e+02  4.19632936e+02  4.19632936e+02
  4.19632936e+02  1.27336652e+03  1.27336652e+03  1.27336652e+03
  1.91432928e+03  2.97542991e+03  2.97542991e+03  2.97542991e+03
  6.60455676e+03  6.60455676e+03  6.60455676e+03  8.27264127e+03
  2.46603906e+04  7.54566866e+04]
E1 = -727.2400622491682  E_coul = 201.71782297673744
cycle= 4 E= -525.522239272431  delta_E= -3.15e-07  |g|= 7.68e-05  |ddm|= 0.000706
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000128312
diis-c [-2.11616217e-09  1.07908799e-05 -2.24902506e-03  9.45873623e-03
  9.92779498e-01]
  HOMO = -0.580717505850637  LUMO = 0.547668166024277
  mo_energy =
[-1.18112888e+02 -1.21857494e+01 -9.53415268e+00 -9.53415268e+00
 -9.53415268e+00 -1.25905846e+00 -5.80717506e-01 -5.80717506e-01
 -5.80717506e-01  5.47668166e-01  5.47668166e-01  5.47668166e-01
  3.15785282e+00  3.15785282e+00  3.15785282e+00  1.75931584e+01
  1.75931584e+01  1.75931584e+01  8.73581166e+01  8.73581166e+01
  8.73581166e+01  1.82774674e+02  4.19633077e+02  4.19633077e+02
  4.19633077e+02  1.27336666e+03  1.27336666e+03  1.27336666e+03
  1.91432942e+03  2.97543005e+03  2.97543005e+03  2.97543005e+03
  6.60455690e+03  6.60455690e+03  6.60455690e+03  8.27264140e+03
  2.46603907e+04  7.54566868e+04]
E1 = -727.2396520332915  E_coul = 201.71741276000353
cycle= 5 E= -525.522239273288  delta_E= -8.57e-10  |g|= 8.84e-06  |ddm|= 7.16e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.2396520332915  E_coul = 201.71741276000353
  HOMO = -0.580724114140529  LUMO = 0.547665371554573
  mo_energy =
[-1.18112906e+02 -1.21857647e+01 -9.53416801e+00 -9.53416801e+00
 -9.53416801e+00 -1.25906652e+00 -5.80724114e-01 -5.80724114e-01
 -5.80724114e-01  5.47665372e-01  5.47665372e-01  5.47665372e-01
  3.15784369e+00  3.15784369e+00  3.15784369e+00  1.75931442e+01
  1.75931442e+01  1.75931442e+01  8.73580998e+01  8.73580998e+01
  8.73580998e+01  1.82774656e+02  4.19633059e+02  4.19633059e+02
  4.19633059e+02  1.27336664e+03  1.27336664e+03  1.27336664e+03
  1.91432940e+03  2.97543003e+03  2.97543003e+03  2.97543003e+03
  6.60455688e+03  6.60455688e+03  6.60455688e+03  8.27264139e+03
  2.46603907e+04  7.54566868e+04]
E1 = -727.2396867021946  E_coul = 201.7174474288981
Extra cycle  E= -525.522239273296  delta_E= -8.53e-12  |g|= 1.75e-06  |ddm|= 6e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 83582.82157069718
E1 = -727.2396867021946  E_coul = 201.7174474288981
init E= -525.522239273296
    CPU time for initialize scf      0.94 sec, wall time      0.18 sec
  HOMO = -0.580723559970626  LUMO = 0.547665544494907
  mo_energy =
[-1.18112902e+02 -1.21857620e+01 -9.53416529e+00 -9.53416529e+00
 -9.53416529e+00 -1.25906575e+00 -5.80723560e-01 -5.80723560e-01
 -5.80723560e-01  5.47665544e-01  5.47665544e-01  5.47665544e-01
  3.15784459e+00  3.15784459e+00  3.15784459e+00  1.75931465e+01
  1.75931465e+01  1.75931465e+01  8.73581032e+01  8.73581032e+01
  8.73581032e+01  1.82774660e+02  4.19633063e+02  4.19633063e+02
  4.19633063e+02  1.27336665e+03  1.27336665e+03  1.27336665e+03
  1.91432941e+03  2.97543003e+03  2.97543003e+03  2.97543003e+03
  6.60455689e+03  6.60455689e+03  6.60455689e+03  8.27264139e+03
  2.46603907e+04  7.54566868e+04]
E1 = -727.2396776040973  E_coul = 201.71743833079958
cycle= 1 E= -525.522239273298  delta_E= -1.25e-12  |g|= 4.3e-07  |ddm|= 1.1e-06
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.2396776040973  E_coul = 201.71743833079958
  HOMO = -0.580723760836778  LUMO = 0.547665464912769
  mo_energy =
[-1.18112903e+02 -1.21857627e+01 -9.53416596e+00 -9.53416596e+00
 -9.53416596e+00 -1.25906600e+00 -5.80723761e-01 -5.80723761e-01
 -5.80723761e-01  5.47665465e-01  5.47665465e-01  5.47665465e-01
  3.15784430e+00  3.15784430e+00  3.15784430e+00  1.75931459e+01
  1.75931459e+01  1.75931459e+01  8.73581024e+01  8.73581024e+01
  8.73581024e+01  1.82774659e+02  4.19633062e+02  4.19633062e+02
  4.19633062e+02  1.27336665e+03  1.27336665e+03  1.27336665e+03
  1.91432941e+03  2.97543003e+03  2.97543003e+03  2.97543003e+03
  6.60455688e+03  6.60455688e+03  6.60455688e+03  8.27264139e+03
  2.46603907e+04  7.54566868e+04]
E1 = -727.2396794837042  E_coul = 201.71744021040664
Extra cycle  E= -525.522239273298  delta_E= 1.14e-13  |g|= 9.62e-08  |ddm|= 1.55e-07
    CPU time for scf_cycle      1.31 sec, wall time      0.56 sec
exp = [2.61825079e+04 7.61825064e+03 3.61825050e+03 1.61824639e+03
 2.39778109e+02 5.19420266e+01 4.58974104e+00 3.98966889e-01
 1.36279299e+03 6.65180595e+02 3.03319936e+02 3.16145835e+02
 4.93067449e+01 4.79222207e+00 1.47082727e+01 4.94835149e-01
 1.30474670e+00 1.46768678e-01]
grad_E = [-1.98599354e-06  2.17804810e-05  4.34804282e-05  6.68323302e-04
  7.80294317e-04 -5.94441949e-03 -1.25328092e-02 -8.80481480e-03
  1.27604510e-06  1.95569018e-05  1.05535775e-04  9.29582640e-05
 -8.37339529e-04 -1.87873388e-02  5.98249170e-03  1.04798554e-01
 -4.54478812e-02 -2.88621157e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:36 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078639        1
[INPUT] 0    0    [1    /1   ]  7618.25063177        1
[INPUT] 0    0    [1    /1   ]  3618.25047938        1
[INPUT] 0    0    [1    /1   ]  1618.24608528        1
[INPUT] 0    0    [1    /1   ]  239.777783771        1
[INPUT] 0    0    [1    /1   ]  51.9445486522        1
[INPUT] 0    0    [1    /1   ]  4.56922131962        1
[INPUT] 0    0    [1    /1   ]  0.402098243834       1
[INPUT] 1    0    [1    /1   ]  1362.79299403        1
[INPUT] 1    0    [1    /1   ]  665.180586298        1
[INPUT] 1    0    [1    /1   ]  303.31988828         1
[INPUT] 1    0    [1    /1   ]  316.145792284        1
[INPUT] 1    0    [1    /1   ]  49.3070390902        1
[INPUT] 1    0    [1    /1   ]  4.80340337483        1
[INPUT] 1    0    [1    /1   ]  14.7059189537        1
[INPUT] 1    0    [1    /1   ]  0.507443889089       1
[INPUT] 1    0    [1    /1   ]  1.33403673509        1
[INPUT] 1    0    [1    /1   ]  0.172276539295       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.50786392204, 1.0]], [0, [7618.250631773111, 1.0]], [0, [3618.2504793782905, 1.0]], [0, [1618.2460852754953, 1.0]], [0, [239.77778377121922, 1.0]], [0, [51.94454865220008, 1.0]], [0, [4.569221319616112, 1.0]], [0, [0.4020982438338161, 1.0]], [1, [1362.7929940325475, 1.0]], [1, [665.1805862980746, 1.0]], [1, [303.319888280226, 1.0]], [1, [316.14579228394115, 1.0]], [1, [49.30703909022054, 1.0]], [1, [4.803403374825753, 1.0]], [1, [14.70591895372674, 1.0]], [1, [0.5074438890894548, 1.0]], [1, [1.3340367350865572, 1.0]], [1, [0.172276539294751, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50786392]
bas 1, expnt(s) = [7618.25063177]
bas 2, expnt(s) = [3618.25047938]
bas 3, expnt(s) = [1618.24608528]
bas 4, expnt(s) = [239.77778377]
bas 5, expnt(s) = [51.94454865]
bas 6, expnt(s) = [4.56922132]
bas 7, expnt(s) = [0.40209824]
bas 8, expnt(s) = [1362.79299403]
bas 9, expnt(s) = [665.1805863]
bas 10, expnt(s) = [303.31988828]
bas 11, expnt(s) = [316.14579228]
bas 12, expnt(s) = [49.30703909]
bas 13, expnt(s) = [4.80340337]
bas 14, expnt(s) = [14.70591895]
bas 15, expnt(s) = [0.50744389]
bas 16, expnt(s) = [1.33403674]
bas 17, expnt(s) = [0.17227654]
CPU time:        51.07
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825063e+03 2.06018617e+03
 3.61825048e+03 1.17866122e+03 1.61824609e+03 6.44612092e+02
 2.39777784e+02 1.53947177e+02 5.19445487e+01 4.88843682e+01
 4.56922132e+00 7.89580965e+00 4.02098244e-01 1.27574583e+00
 1.36279299e+03 2.41558185e+04 6.65180586e+02 9.85505040e+03
 3.03319888e+02 3.69284009e+03 3.16145792e+02 3.88905110e+03
 4.93070391e+01 3.81171611e+02 4.80340337e+00 2.07453476e+01
 1.47059190e+01 8.40136016e+01 5.07443889e-01 1.24945157e+00
 1.33403674e+00 4.18257877e+00 1.72276539e-01 3.23792710e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.978041868579606
cond(S) = 83632.23883111136
E1 = -727.4883274764642  E_coul = 203.10684758261556
init E= -524.381479893849
    CPU time for initialize scf      0.70 sec, wall time      0.08 sec
  HOMO = -0.560103437319019  LUMO = 0.646134643827595
  mo_energy =
[-1.17875338e+02 -1.20944744e+01 -9.44340153e+00 -9.44340153e+00
 -9.44340153e+00 -1.22842201e+00 -5.60103437e-01 -5.60103437e-01
 -5.60103437e-01  6.46134644e-01  6.46134644e-01  6.46134644e-01
  3.38658596e+00  3.38658596e+00  3.38658596e+00  1.79356878e+01
  1.79356878e+01  1.79356878e+01  8.77130145e+01  8.77130145e+01
  8.77130145e+01  1.82891257e+02  4.20000935e+02  4.20000935e+02
  4.20000935e+02  1.27376197e+03  1.27376197e+03  1.27376197e+03
  1.91468150e+03  2.97587787e+03  2.97587787e+03  2.97587787e+03
  6.60511146e+03  6.60511146e+03  6.60511146e+03  8.27313859e+03
  2.46609845e+04  7.54573751e+04]
E1 = -727.1717111653363  E_coul = 201.6466121209249
cycle= 1 E= -525.525099044411  delta_E= -1.14  |g|= 0.184  |ddm|= 0.469
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.450568
diis-c [-0.20301189  1.        ]
  HOMO = -0.577406844770582  LUMO = 0.642781729365303
  mo_energy =
[-1.18137412e+02 -1.21915689e+01 -9.54101803e+00 -9.54101803e+00
 -9.54101803e+00 -1.25512870e+00 -5.77406845e-01 -5.77406845e-01
 -5.77406845e-01  6.42781729e-01  6.42781729e-01  6.42781729e-01
  3.35529641e+00  3.35529641e+00  3.35529641e+00  1.78503462e+01
  1.78503462e+01  1.78503462e+01  8.75515209e+01  8.75515209e+01
  8.75515209e+01  1.82684413e+02  4.19751796e+02  4.19751796e+02
  4.19751796e+02  1.27346066e+03  1.27346066e+03  1.27346066e+03
  1.91425446e+03  2.97551237e+03  2.97551237e+03  2.97551237e+03
  6.60462751e+03  6.60462751e+03  6.60462751e+03  8.27257042e+03
  2.46603213e+04  7.54566197e+04]
E1 = -727.4133919542577  E_coul = 201.88806059630335
cycle= 2 E= -525.525331357954  delta_E= -0.000232  |g|= 0.0171  |ddm|= 0.0164
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0311192
diis-c [-7.59360188e-04  3.11477715e-02  9.68852228e-01]
  HOMO = -0.574201661562156  LUMO = 0.644101767511776
  mo_energy =
[-1.18103323e+02 -1.21745401e+01 -9.52371284e+00 -9.52371284e+00
 -9.52371284e+00 -1.25079522e+00 -5.74201662e-01 -5.74201662e-01
 -5.74201662e-01  6.44101768e-01  6.44101768e-01  6.44101768e-01
  3.36069578e+00  3.36069578e+00  3.36069578e+00  1.78649966e+01
  1.78649966e+01  1.78649966e+01  8.75770890e+01  8.75770890e+01
  8.75770890e+01  1.82717205e+02  4.19785499e+02  4.19785499e+02
  4.19785499e+02  1.27349663e+03  1.27349663e+03  1.27349663e+03
  1.91429189e+03  2.97554940e+03  2.97554940e+03  2.97554940e+03
  6.60466515e+03  6.60466515e+03  6.60466515e+03  8.27260829e+03
  2.46603592e+04  7.54566575e+04]
E1 = -727.3599095550873  E_coul = 201.83456980522735
cycle= 3 E= -525.52533974986  delta_E= -8.39e-06  |g|= 0.00253  |ddm|= 0.0042
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00476314
diis-c [-1.88051597e-07 -7.70453450e-04  1.28074279e-01  8.72696174e-01]
  HOMO = -0.574920209334791  LUMO = 0.643796285868743
  mo_energy =
[-1.18108213e+02 -1.21773740e+01 -9.52660278e+00 -9.52660278e+00
 -9.52660278e+00 -1.25173146e+00 -5.74920209e-01 -5.74920209e-01
 -5.74920209e-01  6.43796286e-01  6.43796286e-01  6.43796286e-01
  3.35957852e+00  3.35957852e+00  3.35957852e+00  1.78624871e+01
  1.78624871e+01  1.78624871e+01  8.75732138e+01  8.75732138e+01
  8.75732138e+01  1.82712524e+02  4.19780661e+02  4.19780661e+02
  4.19780661e+02  1.27349151e+03  1.27349151e+03  1.27349151e+03
  1.91428653e+03  2.97554413e+03  2.97554413e+03  2.97554413e+03
  6.60465973e+03  6.60465973e+03  6.60465973e+03  8.27260279e+03
  2.46603537e+04  7.54566519e+04]
E1 = -727.3682214116149  E_coul = 201.84288139367766
cycle= 4 E= -525.525340017937  delta_E= -2.68e-07  |g|= 5.01e-05  |ddm|= 0.000639
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.64645e-05
diis-c [-6.12637360e-10 -2.35811416e-05  3.40302149e-03  3.95764517e-02
  9.57044108e-01]
  HOMO = -0.574896836920901  LUMO = 0.643805141915514
  mo_energy =
[-1.18108104e+02 -1.21772843e+01 -9.52651194e+00 -9.52651194e+00
 -9.52651194e+00 -1.25169963e+00 -5.74896837e-01 -5.74896837e-01
 -5.74896837e-01  6.43805142e-01  6.43805142e-01  6.43805142e-01
  3.35961514e+00  3.35961514e+00  3.35961514e+00  1.78625666e+01
  1.78625666e+01  1.78625666e+01  8.75733139e+01  8.75733139e+01
  8.75733139e+01  1.82712632e+02  4.19780769e+02  4.19780769e+02
  4.19780769e+02  1.27349162e+03  1.27349162e+03  1.27349162e+03
  1.91428664e+03  2.97554424e+03  2.97554424e+03  2.97554424e+03
  6.60465984e+03  6.60465984e+03  6.60465984e+03  8.27260289e+03
  2.46603538e+04  7.54566520e+04]
E1 = -727.3679503524862  E_coul = 201.84261033426546
cycle= 5 E= -525.525340018221  delta_E= -2.84e-10  |g|= 4.13e-06  |ddm|= 3.43e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.3679503524862  E_coul = 201.84261033426546
  HOMO = -0.574899764656945  LUMO = 0.643803793847781
  mo_energy =
[-1.18108113e+02 -1.21772915e+01 -9.52651918e+00 -9.52651918e+00
 -9.52651918e+00 -1.25170322e+00 -5.74899765e-01 -5.74899765e-01
 -5.74899765e-01  6.43803794e-01  6.43803794e-01  6.43803794e-01
  3.35961102e+00  3.35961102e+00  3.35961102e+00  1.78625600e+01
  1.78625600e+01  1.78625600e+01  8.75733058e+01  8.75733058e+01
  8.75733058e+01  1.82712623e+02  4.19780760e+02  4.19780760e+02
  4.19780760e+02  1.27349161e+03  1.27349161e+03  1.27349161e+03
  1.91428663e+03  2.97554423e+03  2.97554423e+03  2.97554423e+03
  6.60465983e+03  6.60465983e+03  6.60465983e+03  8.27260288e+03
  2.46603537e+04  7.54566520e+04]
E1 = -727.3679664365767  E_coul = 201.84262641835355
Extra cycle  E= -525.525340018223  delta_E= -2.39e-12  |g|= 8.39e-07  |ddm|= 2.52e-06
    CPU time for scf_cycle      0.90 sec, wall time      0.27 sec
exp = [2.61825079e+04 7.61825063e+03 3.61825048e+03 1.61824609e+03
 2.39777784e+02 5.19445487e+01 4.56922132e+00 4.02098244e-01
 1.36279299e+03 6.65180586e+02 3.03319888e+02 3.16145792e+02
 4.93070391e+01 4.80340337e+00 1.47059190e+01 5.07443889e-01
 1.33403674e+00 1.72276539e-01]
E = -525.5253400182231
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078639        1
[INPUT] 0    0    [1    /1   ]  7618.25063177        1
[INPUT] 0    0    [1    /1   ]  3618.25047938        1
[INPUT] 0    0    [1    /1   ]  1618.24608528        1
[INPUT] 0    0    [1    /1   ]  239.777783771        1
[INPUT] 0    0    [1    /1   ]  51.9445486522        1
[INPUT] 0    0    [1    /1   ]  4.56922131962        1
[INPUT] 0    0    [1    /1   ]  0.402098243834       1
[INPUT] 1    0    [1    /1   ]  1362.79299403        1
[INPUT] 1    0    [1    /1   ]  665.180586298        1
[INPUT] 1    0    [1    /1   ]  303.31988828         1
[INPUT] 1    0    [1    /1   ]  316.145792284        1
[INPUT] 1    0    [1    /1   ]  49.3070390902        1
[INPUT] 1    0    [1    /1   ]  4.80340337483        1
[INPUT] 1    0    [1    /1   ]  14.7059189537        1
[INPUT] 1    0    [1    /1   ]  0.507443889089       1
[INPUT] 1    0    [1    /1   ]  1.33403673509        1
[INPUT] 1    0    [1    /1   ]  0.172276539295       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.50786392204, 1.0]], [0, [7618.250631773111, 1.0]], [0, [3618.2504793782905, 1.0]], [0, [1618.2460852754953, 1.0]], [0, [239.77778377121922, 1.0]], [0, [51.94454865220008, 1.0]], [0, [4.569221319616112, 1.0]], [0, [0.4020982438338161, 1.0]], [1, [1362.7929940325475, 1.0]], [1, [665.1805862980746, 1.0]], [1, [303.319888280226, 1.0]], [1, [316.14579228394115, 1.0]], [1, [49.30703909022054, 1.0]], [1, [4.803403374825753, 1.0]], [1, [14.70591895372674, 1.0]], [1, [0.5074438890894548, 1.0]], [1, [1.3340367350865572, 1.0]], [1, [0.172276539294751, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50786392]
bas 1, expnt(s) = [7618.25063177]
bas 2, expnt(s) = [3618.25047938]
bas 3, expnt(s) = [1618.24608528]
bas 4, expnt(s) = [239.77778377]
bas 5, expnt(s) = [51.94454865]
bas 6, expnt(s) = [4.56922132]
bas 7, expnt(s) = [0.40209824]
bas 8, expnt(s) = [1362.79299403]
bas 9, expnt(s) = [665.1805863]
bas 10, expnt(s) = [303.31988828]
bas 11, expnt(s) = [316.14579228]
bas 12, expnt(s) = [49.30703909]
bas 13, expnt(s) = [4.80340337]
bas 14, expnt(s) = [14.70591895]
bas 15, expnt(s) = [0.50744389]
bas 16, expnt(s) = [1.33403674]
bas 17, expnt(s) = [0.17227654]
CPU time:        52.07
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825063e+03 2.06018617e+03
 3.61825048e+03 1.17866122e+03 1.61824609e+03 6.44612092e+02
 2.39777784e+02 1.53947177e+02 5.19445487e+01 4.88843682e+01
 4.56922132e+00 7.89580965e+00 4.02098244e-01 1.27574583e+00
 1.36279299e+03 2.41558185e+04 6.65180586e+02 9.85505040e+03
 3.03319888e+02 3.69284009e+03 3.16145792e+02 3.88905110e+03
 4.93070391e+01 3.81171611e+02 4.80340337e+00 2.07453476e+01
 1.47059190e+01 8.40136016e+01 5.07443889e-01 1.24945157e+00
 1.33403674e+00 4.18257877e+00 1.72276539e-01 3.23792710e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.978041868579606
cond(S) = 83632.23883111136
E1 = -727.4883274764642  E_coul = 203.10684758261556
init E= -524.381479893849
    CPU time for initialize scf      0.70 sec, wall time      0.08 sec
  HOMO = -0.560103437319019  LUMO = 0.646134643827595
  mo_energy =
[-1.17875338e+02 -1.20944744e+01 -9.44340153e+00 -9.44340153e+00
 -9.44340153e+00 -1.22842201e+00 -5.60103437e-01 -5.60103437e-01
 -5.60103437e-01  6.46134644e-01  6.46134644e-01  6.46134644e-01
  3.38658596e+00  3.38658596e+00  3.38658596e+00  1.79356878e+01
  1.79356878e+01  1.79356878e+01  8.77130145e+01  8.77130145e+01
  8.77130145e+01  1.82891257e+02  4.20000935e+02  4.20000935e+02
  4.20000935e+02  1.27376197e+03  1.27376197e+03  1.27376197e+03
  1.91468150e+03  2.97587787e+03  2.97587787e+03  2.97587787e+03
  6.60511146e+03  6.60511146e+03  6.60511146e+03  8.27313859e+03
  2.46609845e+04  7.54573751e+04]
E1 = -727.1717111653363  E_coul = 201.6466121209249
cycle= 1 E= -525.525099044411  delta_E= -1.14  |g|= 0.184  |ddm|= 0.469
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.450568
diis-c [-0.20301189  1.        ]
  HOMO = -0.577406844770582  LUMO = 0.642781729365303
  mo_energy =
[-1.18137412e+02 -1.21915689e+01 -9.54101803e+00 -9.54101803e+00
 -9.54101803e+00 -1.25512870e+00 -5.77406845e-01 -5.77406845e-01
 -5.77406845e-01  6.42781729e-01  6.42781729e-01  6.42781729e-01
  3.35529641e+00  3.35529641e+00  3.35529641e+00  1.78503462e+01
  1.78503462e+01  1.78503462e+01  8.75515209e+01  8.75515209e+01
  8.75515209e+01  1.82684413e+02  4.19751796e+02  4.19751796e+02
  4.19751796e+02  1.27346066e+03  1.27346066e+03  1.27346066e+03
  1.91425446e+03  2.97551237e+03  2.97551237e+03  2.97551237e+03
  6.60462751e+03  6.60462751e+03  6.60462751e+03  8.27257042e+03
  2.46603213e+04  7.54566197e+04]
E1 = -727.4133919542577  E_coul = 201.88806059630335
cycle= 2 E= -525.525331357954  delta_E= -0.000232  |g|= 0.0171  |ddm|= 0.0164
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0311192
diis-c [-7.59360188e-04  3.11477715e-02  9.68852228e-01]
  HOMO = -0.574201661562156  LUMO = 0.644101767511776
  mo_energy =
[-1.18103323e+02 -1.21745401e+01 -9.52371284e+00 -9.52371284e+00
 -9.52371284e+00 -1.25079522e+00 -5.74201662e-01 -5.74201662e-01
 -5.74201662e-01  6.44101768e-01  6.44101768e-01  6.44101768e-01
  3.36069578e+00  3.36069578e+00  3.36069578e+00  1.78649966e+01
  1.78649966e+01  1.78649966e+01  8.75770890e+01  8.75770890e+01
  8.75770890e+01  1.82717205e+02  4.19785499e+02  4.19785499e+02
  4.19785499e+02  1.27349663e+03  1.27349663e+03  1.27349663e+03
  1.91429189e+03  2.97554940e+03  2.97554940e+03  2.97554940e+03
  6.60466515e+03  6.60466515e+03  6.60466515e+03  8.27260829e+03
  2.46603592e+04  7.54566575e+04]
E1 = -727.3599095550873  E_coul = 201.83456980522735
cycle= 3 E= -525.52533974986  delta_E= -8.39e-06  |g|= 0.00253  |ddm|= 0.0042
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00476314
diis-c [-1.88051597e-07 -7.70453450e-04  1.28074279e-01  8.72696174e-01]
  HOMO = -0.574920209334791  LUMO = 0.643796285868743
  mo_energy =
[-1.18108213e+02 -1.21773740e+01 -9.52660278e+00 -9.52660278e+00
 -9.52660278e+00 -1.25173146e+00 -5.74920209e-01 -5.74920209e-01
 -5.74920209e-01  6.43796286e-01  6.43796286e-01  6.43796286e-01
  3.35957852e+00  3.35957852e+00  3.35957852e+00  1.78624871e+01
  1.78624871e+01  1.78624871e+01  8.75732138e+01  8.75732138e+01
  8.75732138e+01  1.82712524e+02  4.19780661e+02  4.19780661e+02
  4.19780661e+02  1.27349151e+03  1.27349151e+03  1.27349151e+03
  1.91428653e+03  2.97554413e+03  2.97554413e+03  2.97554413e+03
  6.60465973e+03  6.60465973e+03  6.60465973e+03  8.27260279e+03
  2.46603537e+04  7.54566519e+04]
E1 = -727.3682214116149  E_coul = 201.84288139367766
cycle= 4 E= -525.525340017937  delta_E= -2.68e-07  |g|= 5.01e-05  |ddm|= 0.000639
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.64645e-05
diis-c [-6.12637360e-10 -2.35811416e-05  3.40302149e-03  3.95764517e-02
  9.57044108e-01]
  HOMO = -0.574896836920901  LUMO = 0.643805141915514
  mo_energy =
[-1.18108104e+02 -1.21772843e+01 -9.52651194e+00 -9.52651194e+00
 -9.52651194e+00 -1.25169963e+00 -5.74896837e-01 -5.74896837e-01
 -5.74896837e-01  6.43805142e-01  6.43805142e-01  6.43805142e-01
  3.35961514e+00  3.35961514e+00  3.35961514e+00  1.78625666e+01
  1.78625666e+01  1.78625666e+01  8.75733139e+01  8.75733139e+01
  8.75733139e+01  1.82712632e+02  4.19780769e+02  4.19780769e+02
  4.19780769e+02  1.27349162e+03  1.27349162e+03  1.27349162e+03
  1.91428664e+03  2.97554424e+03  2.97554424e+03  2.97554424e+03
  6.60465984e+03  6.60465984e+03  6.60465984e+03  8.27260289e+03
  2.46603538e+04  7.54566520e+04]
E1 = -727.3679503524862  E_coul = 201.84261033426546
cycle= 5 E= -525.525340018221  delta_E= -2.84e-10  |g|= 4.13e-06  |ddm|= 3.43e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.3679503524862  E_coul = 201.84261033426546
  HOMO = -0.574899764656945  LUMO = 0.643803793847781
  mo_energy =
[-1.18108113e+02 -1.21772915e+01 -9.52651918e+00 -9.52651918e+00
 -9.52651918e+00 -1.25170322e+00 -5.74899765e-01 -5.74899765e-01
 -5.74899765e-01  6.43803794e-01  6.43803794e-01  6.43803794e-01
  3.35961102e+00  3.35961102e+00  3.35961102e+00  1.78625600e+01
  1.78625600e+01  1.78625600e+01  8.75733058e+01  8.75733058e+01
  8.75733058e+01  1.82712623e+02  4.19780760e+02  4.19780760e+02
  4.19780760e+02  1.27349161e+03  1.27349161e+03  1.27349161e+03
  1.91428663e+03  2.97554423e+03  2.97554423e+03  2.97554423e+03
  6.60465983e+03  6.60465983e+03  6.60465983e+03  8.27260288e+03
  2.46603537e+04  7.54566520e+04]
E1 = -727.3679664365767  E_coul = 201.84262641835355
Extra cycle  E= -525.525340018223  delta_E= -2.39e-12  |g|= 8.39e-07  |ddm|= 2.52e-06
    CPU time for scf_cycle      0.89 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 83632.23883111136
E1 = -727.3679664365767  E_coul = 201.84262641835355
init E= -525.525340018223
    CPU time for initialize scf      1.30 sec, wall time      0.21 sec
  HOMO = -0.574899511759392  LUMO = 0.643803885543304
  mo_energy =
[-1.18108111e+02 -1.21772903e+01 -9.52651792e+00 -9.52651792e+00
 -9.52651792e+00 -1.25170287e+00 -5.74899512e-01 -5.74899512e-01
 -5.74899512e-01  6.43803886e-01  6.43803886e-01  6.43803886e-01
  3.35961144e+00  3.35961144e+00  3.35961144e+00  1.78625610e+01
  1.78625610e+01  1.78625610e+01  8.75733073e+01  8.75733073e+01
  8.75733073e+01  1.82712625e+02  4.19780762e+02  4.19780762e+02
  4.19780762e+02  1.27349161e+03  1.27349161e+03  1.27349161e+03
  1.91428663e+03  2.97554423e+03  2.97554423e+03  2.97554423e+03
  6.60465983e+03  6.60465983e+03  6.60465983e+03  8.27260288e+03
  2.46603538e+04  7.54566520e+04]
E1 = -727.3679624598553  E_coul = 201.84262244163253
cycle= 1 E= -525.525340018223  delta_E= 3.41e-13  |g|= 1.95e-07  |ddm|= 4.89e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.3679624598553  E_coul = 201.84262244163253
  HOMO = -0.574899595650679  LUMO = 0.643803848908736
  mo_energy =
[-1.18108112e+02 -1.21772906e+01 -9.52651822e+00 -9.52651822e+00
 -9.52651822e+00 -1.25170297e+00 -5.74899596e-01 -5.74899596e-01
 -5.74899596e-01  6.43803849e-01  6.43803849e-01  6.43803849e-01
  3.35961131e+00  3.35961131e+00  3.35961131e+00  1.78625608e+01
  1.78625608e+01  1.78625608e+01  8.75733070e+01  8.75733070e+01
  8.75733070e+01  1.82712625e+02  4.19780761e+02  4.19780761e+02
  4.19780761e+02  1.27349161e+03  1.27349161e+03  1.27349161e+03
  1.91428663e+03  2.97554423e+03  2.97554423e+03  2.97554423e+03
  6.60465983e+03  6.60465983e+03  6.60465983e+03  8.27260288e+03
  2.46603538e+04  7.54566520e+04]
E1 = -727.367963257379  E_coul = 201.8426232391558
Extra cycle  E= -525.525340018223  delta_E= -3.41e-13  |g|= 4.22e-08  |ddm|= 6.33e-08
    CPU time for scf_cycle      1.39 sec, wall time      0.30 sec
exp = [2.61825079e+04 7.61825063e+03 3.61825048e+03 1.61824609e+03
 2.39777784e+02 5.19445487e+01 4.56922132e+00 4.02098244e-01
 1.36279299e+03 6.65180586e+02 3.03319888e+02 3.16145792e+02
 4.93070391e+01 4.80340337e+00 1.47059190e+01 5.07443889e-01
 1.33403674e+00 1.72276539e-01]
grad_E = [-1.98546209e-06  2.17799826e-05  4.34859918e-05  6.68337178e-04
  7.70988704e-04 -5.90615201e-03 -3.21985313e-02  4.93860018e-02
  1.26191331e-06  1.94579071e-05  1.04917794e-04  9.24143725e-05
 -7.38818151e-04 -1.87107859e-02  5.15111186e-03 -2.53828739e-02
 -2.40894795e-02  4.86039342e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078668        1
[INPUT] 0    0    [1    /1   ]  7618.25060061        1
[INPUT] 0    0    [1    /1   ]  3618.25041717        1
[INPUT] 0    0    [1    /1   ]  1618.24512897        1
[INPUT] 0    0    [1    /1   ]  239.776646844        1
[INPUT] 0    0    [1    /1   ]  51.9531838327        1
[INPUT] 0    0    [1    /1   ]  4.5882757393         1
[INPUT] 0    0    [1    /1   ]  0.400664565683       1
[INPUT] 1    0    [1    /1   ]  1362.79299222        1
[INPUT] 1    0    [1    /1   ]  665.180558381        1
[INPUT] 1    0    [1    /1   ]  303.319737702        1
[INPUT] 1    0    [1    /1   ]  316.145659651        1
[INPUT] 1    0    [1    /1   ]  49.3081402132        1
[INPUT] 1    0    [1    /1   ]  4.82482786571        1
[INPUT] 1    0    [1    /1   ]  14.6986670439        1
[INPUT] 1    0    [1    /1   ]  0.520502150165       1
[INPUT] 1    0    [1    /1   ]  1.37182765173        1
[INPUT] 1    0    [1    /1   ]  0.17390817479        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507866764605, 1.0]], [0, [7618.250600605599, 1.0]], [0, [3618.250417166094, 1.0]], [0, [1618.245128966279, 1.0]], [0, [239.7766468440992, 1.0]], [0, [51.95318383267034, 1.0]], [0, [4.588275739302385, 1.0]], [0, [0.4006645656829042, 1.0]], [1, [1362.7929922170106, 1.0]], [1, [665.1805583810903, 1.0]], [1, [303.31973770248896, 1.0]], [1, [316.14565965065924, 1.0]], [1, [49.30814021323596, 1.0]], [1, [4.824827865706852, 1.0]], [1, [14.698667043912973, 1.0]], [1, [0.5205021501653379, 1.0]], [1, [1.3718276517314303, 1.0]], [1, [0.1739081747896951, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50786676]
bas 1, expnt(s) = [7618.25060061]
bas 2, expnt(s) = [3618.25041717]
bas 3, expnt(s) = [1618.24512897]
bas 4, expnt(s) = [239.77664684]
bas 5, expnt(s) = [51.95318383]
bas 6, expnt(s) = [4.58827574]
bas 7, expnt(s) = [0.40066457]
bas 8, expnt(s) = [1362.79299222]
bas 9, expnt(s) = [665.18055838]
bas 10, expnt(s) = [303.3197377]
bas 11, expnt(s) = [316.14565965]
bas 12, expnt(s) = [49.30814021]
bas 13, expnt(s) = [4.82482787]
bas 14, expnt(s) = [14.69866704]
bas 15, expnt(s) = [0.52050215]
bas 16, expnt(s) = [1.37182765]
bas 17, expnt(s) = [0.17390817]
CPU time:        57.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825060e+03 2.06018616e+03
 3.61825042e+03 1.17866121e+03 1.61824513e+03 6.44611806e+02
 2.39776647e+02 1.53946630e+02 5.19531838e+01 4.88904630e+01
 4.58827574e+00 7.92049194e+00 4.00664566e-01 1.27233281e+00
 1.36279299e+03 2.41558185e+04 6.65180558e+02 9.85504988e+03
 3.03319738e+02 3.69283780e+03 3.16145660e+02 3.88904906e+03
 4.93081402e+01 3.81182251e+02 4.82482787e+00 2.08610744e+01
 1.46986670e+01 8.39618179e+01 5.20502150e-01 1.28977084e+00
 1.37182765e+00 4.33120593e+00 1.73908175e-01 3.27630549e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.978097036694447
cond(S) = 83674.82030405375
E1 = -727.5250096620276  E_coul = 203.12225101854332
init E= -524.402758643484
    CPU time for initialize scf      0.22 sec, wall time      0.05 sec
  HOMO = -0.560433351809296  LUMO = 0.659677966095761
  mo_energy =
[-1.17872264e+02 -1.20932157e+01 -9.44204616e+00 -9.44204616e+00
 -9.44204616e+00 -1.22916018e+00 -5.60433352e-01 -5.60433352e-01
 -5.60433352e-01  6.59677966e-01  6.59677966e-01  6.59677966e-01
  3.49371964e+00  3.49371964e+00  3.49371964e+00  1.81765359e+01
  1.81765359e+01  1.81765359e+01  8.79249137e+01  8.79249137e+01
  8.79249137e+01  1.82991802e+02  4.20148533e+02  4.20148533e+02
  4.20148533e+02  1.27388775e+03  1.27388775e+03  1.27388775e+03
  1.91476450e+03  2.97599316e+03  2.97599316e+03  2.97599316e+03
  6.60521607e+03  6.60521607e+03  6.60521607e+03  8.27321098e+03
  2.46610515e+04  7.54574369e+04]
E1 = -727.1976835627449  E_coul = 201.67054805922157
cycle= 1 E= -525.527135503523  delta_E= -1.12  |g|= 0.182  |ddm|= 0.441
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.448531
diis-c [-0.20117973  1.        ]
  HOMO = -0.577808043165688  LUMO = 0.655983632915124
  mo_energy =
[-1.18131793e+02 -1.21903075e+01 -9.53901568e+00 -9.53901568e+00
 -9.53901568e+00 -1.25585877e+00 -5.77808043e-01 -5.77808043e-01
 -5.77808043e-01  6.55983633e-01  6.55983633e-01  6.55983633e-01
  3.46158822e+00  3.46158822e+00  3.46158822e+00  1.80916900e+01
  1.80916900e+01  1.80916900e+01  8.77649536e+01  8.77649536e+01
  8.77649536e+01  1.82786221e+02  4.19901819e+02  4.19901819e+02
  4.19901819e+02  1.27358962e+03  1.27358962e+03  1.27358962e+03
  1.91434222e+03  2.97563174e+03  2.97563174e+03  2.97563174e+03
  6.60473722e+03  6.60473722e+03  6.60473722e+03  8.27264855e+03
  2.46603945e+04  7.54566880e+04]
E1 = -727.4355522126693  E_coul = 201.90819170752295
cycle= 2 E= -525.527360505146  delta_E= -0.000225  |g|= 0.0168  |ddm|= 0.0162
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0307891
diis-c [-7.49385407e-04  3.05162660e-02  9.69483734e-01]
  HOMO = -0.574662968650274  LUMO = 0.657320252580261
  mo_energy =
[-1.18098214e+02 -1.21735152e+01 -9.52196424e+00 -9.52196424e+00
 -9.52196424e+00 -1.25160473e+00 -5.74662969e-01 -5.74662969e-01
 -5.74662969e-01  6.57320253e-01  6.57320253e-01  6.57320253e-01
  3.46702140e+00  3.46702140e+00  3.46702140e+00  1.81061330e+01
  1.81061330e+01  1.81061330e+01  8.77901304e+01  8.77901304e+01
  8.77901304e+01  1.82818513e+02  4.19935013e+02  4.19935013e+02
  4.19935013e+02  1.27362505e+03  1.27362505e+03  1.27362505e+03
  1.91437909e+03  2.97566823e+03  2.97566823e+03  2.97566823e+03
  6.60477431e+03  6.60477431e+03  6.60477431e+03  8.27268586e+03
  2.46604319e+04  7.54567253e+04]
E1 = -727.3828098269041  E_coul = 201.85544117692902
cycle= 3 E= -525.527368649975  delta_E= -8.14e-06  |g|= 0.00251  |ddm|= 0.00418
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00473312
diis-c [-1.84869043e-07 -7.59185025e-04  1.28682609e-01  8.72076576e-01]
  HOMO = -0.575373588720115  LUMO = 0.657008836927735
  mo_energy =
[-1.18103057e+02 -1.21763216e+01 -9.52482354e+00 -9.52482354e+00
 -9.52482354e+00 -1.25253006e+00 -5.75373589e-01 -5.75373589e-01
 -5.75373589e-01  6.57008837e-01  6.57008837e-01  6.57008837e-01
  3.46589294e+00  3.46589294e+00  3.46589294e+00  1.81036484e+01
  1.81036484e+01  1.81036484e+01  8.77862959e+01  8.77862959e+01
  8.77862959e+01  1.82813877e+02  4.19930223e+02  4.19930223e+02
  4.19930223e+02  1.27361998e+03  1.27361998e+03  1.27361998e+03
  1.91437379e+03  2.97566301e+03  2.97566301e+03  2.97566301e+03
  6.60476894e+03  6.60476894e+03  6.60476894e+03  8.27268042e+03
  2.46604264e+04  7.54567197e+04]
E1 = -727.3910412676485  E_coul = 201.8636723548924
cycle= 4 E= -525.527368912756  delta_E= -2.63e-07  |g|= 4.98e-05  |ddm|= 0.000635
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.63271e-05
diis-c [-5.94954614e-10 -2.19031953e-05  3.29025875e-03  3.87958586e-02
  9.57935786e-01]
  HOMO = -0.575350542611322  LUMO = 0.657017875242209
  mo_energy =
[-1.18102949e+02 -1.21762327e+01 -9.52473356e+00 -9.52473356e+00
 -9.52473356e+00 -1.25249867e+00 -5.75350543e-01 -5.75350543e-01
 -5.75350543e-01  6.57017875e-01  6.57017875e-01  6.57017875e-01
  3.46592993e+00  3.46592993e+00  3.46592993e+00  1.81037272e+01
  1.81037272e+01  1.81037272e+01  8.77863951e+01  8.77863951e+01
  8.77863951e+01  1.82813984e+02  4.19930330e+02  4.19930330e+02
  4.19930330e+02  1.27362009e+03  1.27362009e+03  1.27362009e+03
  1.91437389e+03  2.97566312e+03  2.97566312e+03  2.97566312e+03
  6.60476905e+03  6.60476905e+03  6.60476905e+03  8.27268052e+03
  2.46604265e+04  7.54567198e+04]
E1 = -727.3907732350965  E_coul = 201.8634043220649
cycle= 5 E= -525.527368913032  delta_E= -2.76e-10  |g|= 4.08e-06  |ddm|= 3.39e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.3907732350965  E_coul = 201.8634043220649
  HOMO = -0.575353429812649  LUMO = 0.657016513930197
  mo_energy =
[-1.18102958e+02 -1.21762398e+01 -9.52474073e+00 -9.52474073e+00
 -9.52474073e+00 -1.25250222e+00 -5.75353430e-01 -5.75353430e-01
 -5.75353430e-01  6.57016514e-01  6.57016514e-01  6.57016514e-01
  3.46592579e+00  3.46592579e+00  3.46592579e+00  1.81037206e+01
  1.81037206e+01  1.81037206e+01  8.77863870e+01  8.77863870e+01
  8.77863870e+01  1.82813975e+02  4.19930321e+02  4.19930321e+02
  4.19930321e+02  1.27362008e+03  1.27362008e+03  1.27362008e+03
  1.91437388e+03  2.97566311e+03  2.97566311e+03  2.97566311e+03
  6.60476904e+03  6.60476904e+03  6.60476904e+03  8.27268051e+03
  2.46604265e+04  7.54567198e+04]
E1 = -727.3907893619274  E_coul = 201.86342044889244
Extra cycle  E= -525.527368913035  delta_E= -3.3e-12  |g|= 8.32e-07  |ddm|= 2.37e-06
    CPU time for scf_cycle      0.41 sec, wall time      0.24 sec
exp = [2.61825079e+04 7.61825060e+03 3.61825042e+03 1.61824513e+03
 2.39776647e+02 5.19531838e+01 4.58827574e+00 4.00664566e-01
 1.36279299e+03 6.65180558e+02 3.03319738e+02 3.16145660e+02
 4.93081402e+01 4.82482787e+00 1.46986670e+01 5.20502150e-01
 1.37182765e+00 1.73908175e-01]
E = -525.5273689130349
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078668        1
[INPUT] 0    0    [1    /1   ]  7618.25060061        1
[INPUT] 0    0    [1    /1   ]  3618.25041717        1
[INPUT] 0    0    [1    /1   ]  1618.24512897        1
[INPUT] 0    0    [1    /1   ]  239.776646844        1
[INPUT] 0    0    [1    /1   ]  51.9531838327        1
[INPUT] 0    0    [1    /1   ]  4.5882757393         1
[INPUT] 0    0    [1    /1   ]  0.400664565683       1
[INPUT] 1    0    [1    /1   ]  1362.79299222        1
[INPUT] 1    0    [1    /1   ]  665.180558381        1
[INPUT] 1    0    [1    /1   ]  303.319737702        1
[INPUT] 1    0    [1    /1   ]  316.145659651        1
[INPUT] 1    0    [1    /1   ]  49.3081402132        1
[INPUT] 1    0    [1    /1   ]  4.82482786571        1
[INPUT] 1    0    [1    /1   ]  14.6986670439        1
[INPUT] 1    0    [1    /1   ]  0.520502150165       1
[INPUT] 1    0    [1    /1   ]  1.37182765173        1
[INPUT] 1    0    [1    /1   ]  0.17390817479        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507866764605, 1.0]], [0, [7618.250600605599, 1.0]], [0, [3618.250417166094, 1.0]], [0, [1618.245128966279, 1.0]], [0, [239.7766468440992, 1.0]], [0, [51.95318383267034, 1.0]], [0, [4.588275739302385, 1.0]], [0, [0.4006645656829042, 1.0]], [1, [1362.7929922170106, 1.0]], [1, [665.1805583810903, 1.0]], [1, [303.31973770248896, 1.0]], [1, [316.14565965065924, 1.0]], [1, [49.30814021323596, 1.0]], [1, [4.824827865706852, 1.0]], [1, [14.698667043912973, 1.0]], [1, [0.5205021501653379, 1.0]], [1, [1.3718276517314303, 1.0]], [1, [0.1739081747896951, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50786676]
bas 1, expnt(s) = [7618.25060061]
bas 2, expnt(s) = [3618.25041717]
bas 3, expnt(s) = [1618.24512897]
bas 4, expnt(s) = [239.77664684]
bas 5, expnt(s) = [51.95318383]
bas 6, expnt(s) = [4.58827574]
bas 7, expnt(s) = [0.40066457]
bas 8, expnt(s) = [1362.79299222]
bas 9, expnt(s) = [665.18055838]
bas 10, expnt(s) = [303.3197377]
bas 11, expnt(s) = [316.14565965]
bas 12, expnt(s) = [49.30814021]
bas 13, expnt(s) = [4.82482787]
bas 14, expnt(s) = [14.69866704]
bas 15, expnt(s) = [0.52050215]
bas 16, expnt(s) = [1.37182765]
bas 17, expnt(s) = [0.17390817]
CPU time:        58.50
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825060e+03 2.06018616e+03
 3.61825042e+03 1.17866121e+03 1.61824513e+03 6.44611806e+02
 2.39776647e+02 1.53946630e+02 5.19531838e+01 4.88904630e+01
 4.58827574e+00 7.92049194e+00 4.00664566e-01 1.27233281e+00
 1.36279299e+03 2.41558185e+04 6.65180558e+02 9.85504988e+03
 3.03319738e+02 3.69283780e+03 3.16145660e+02 3.88904906e+03
 4.93081402e+01 3.81182251e+02 4.82482787e+00 2.08610744e+01
 1.46986670e+01 8.39618179e+01 5.20502150e-01 1.28977084e+00
 1.37182765e+00 4.33120593e+00 1.73908175e-01 3.27630549e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.978097036694447
cond(S) = 83674.82030405375
E1 = -727.5250096620276  E_coul = 203.12225101854332
init E= -524.402758643484
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.560433351809296  LUMO = 0.659677966095761
  mo_energy =
[-1.17872264e+02 -1.20932157e+01 -9.44204616e+00 -9.44204616e+00
 -9.44204616e+00 -1.22916018e+00 -5.60433352e-01 -5.60433352e-01
 -5.60433352e-01  6.59677966e-01  6.59677966e-01  6.59677966e-01
  3.49371964e+00  3.49371964e+00  3.49371964e+00  1.81765359e+01
  1.81765359e+01  1.81765359e+01  8.79249137e+01  8.79249137e+01
  8.79249137e+01  1.82991802e+02  4.20148533e+02  4.20148533e+02
  4.20148533e+02  1.27388775e+03  1.27388775e+03  1.27388775e+03
  1.91476450e+03  2.97599316e+03  2.97599316e+03  2.97599316e+03
  6.60521607e+03  6.60521607e+03  6.60521607e+03  8.27321098e+03
  2.46610515e+04  7.54574369e+04]
E1 = -727.1976835627449  E_coul = 201.67054805922157
cycle= 1 E= -525.527135503523  delta_E= -1.12  |g|= 0.182  |ddm|= 0.441
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.448531
diis-c [-0.20117973  1.        ]
  HOMO = -0.577808043165688  LUMO = 0.655983632915124
  mo_energy =
[-1.18131793e+02 -1.21903075e+01 -9.53901568e+00 -9.53901568e+00
 -9.53901568e+00 -1.25585877e+00 -5.77808043e-01 -5.77808043e-01
 -5.77808043e-01  6.55983633e-01  6.55983633e-01  6.55983633e-01
  3.46158822e+00  3.46158822e+00  3.46158822e+00  1.80916900e+01
  1.80916900e+01  1.80916900e+01  8.77649536e+01  8.77649536e+01
  8.77649536e+01  1.82786221e+02  4.19901819e+02  4.19901819e+02
  4.19901819e+02  1.27358962e+03  1.27358962e+03  1.27358962e+03
  1.91434222e+03  2.97563174e+03  2.97563174e+03  2.97563174e+03
  6.60473722e+03  6.60473722e+03  6.60473722e+03  8.27264855e+03
  2.46603945e+04  7.54566880e+04]
E1 = -727.4355522126693  E_coul = 201.90819170752295
cycle= 2 E= -525.527360505146  delta_E= -0.000225  |g|= 0.0168  |ddm|= 0.0162
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0307891
diis-c [-7.49385407e-04  3.05162660e-02  9.69483734e-01]
  HOMO = -0.574662968650274  LUMO = 0.657320252580261
  mo_energy =
[-1.18098214e+02 -1.21735152e+01 -9.52196424e+00 -9.52196424e+00
 -9.52196424e+00 -1.25160473e+00 -5.74662969e-01 -5.74662969e-01
 -5.74662969e-01  6.57320253e-01  6.57320253e-01  6.57320253e-01
  3.46702140e+00  3.46702140e+00  3.46702140e+00  1.81061330e+01
  1.81061330e+01  1.81061330e+01  8.77901304e+01  8.77901304e+01
  8.77901304e+01  1.82818513e+02  4.19935013e+02  4.19935013e+02
  4.19935013e+02  1.27362505e+03  1.27362505e+03  1.27362505e+03
  1.91437909e+03  2.97566823e+03  2.97566823e+03  2.97566823e+03
  6.60477431e+03  6.60477431e+03  6.60477431e+03  8.27268586e+03
  2.46604319e+04  7.54567253e+04]
E1 = -727.3828098269041  E_coul = 201.85544117692902
cycle= 3 E= -525.527368649975  delta_E= -8.14e-06  |g|= 0.00251  |ddm|= 0.00418
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00473312
diis-c [-1.84869043e-07 -7.59185025e-04  1.28682609e-01  8.72076576e-01]
  HOMO = -0.575373588720115  LUMO = 0.657008836927735
  mo_energy =
[-1.18103057e+02 -1.21763216e+01 -9.52482354e+00 -9.52482354e+00
 -9.52482354e+00 -1.25253006e+00 -5.75373589e-01 -5.75373589e-01
 -5.75373589e-01  6.57008837e-01  6.57008837e-01  6.57008837e-01
  3.46589294e+00  3.46589294e+00  3.46589294e+00  1.81036484e+01
  1.81036484e+01  1.81036484e+01  8.77862959e+01  8.77862959e+01
  8.77862959e+01  1.82813877e+02  4.19930223e+02  4.19930223e+02
  4.19930223e+02  1.27361998e+03  1.27361998e+03  1.27361998e+03
  1.91437379e+03  2.97566301e+03  2.97566301e+03  2.97566301e+03
  6.60476894e+03  6.60476894e+03  6.60476894e+03  8.27268042e+03
  2.46604264e+04  7.54567197e+04]
E1 = -727.3910412676485  E_coul = 201.8636723548924
cycle= 4 E= -525.527368912756  delta_E= -2.63e-07  |g|= 4.98e-05  |ddm|= 0.000635
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=8.63271e-05
diis-c [-5.94954614e-10 -2.19031953e-05  3.29025875e-03  3.87958586e-02
  9.57935786e-01]
  HOMO = -0.575350542611322  LUMO = 0.657017875242209
  mo_energy =
[-1.18102949e+02 -1.21762327e+01 -9.52473356e+00 -9.52473356e+00
 -9.52473356e+00 -1.25249867e+00 -5.75350543e-01 -5.75350543e-01
 -5.75350543e-01  6.57017875e-01  6.57017875e-01  6.57017875e-01
  3.46592993e+00  3.46592993e+00  3.46592993e+00  1.81037272e+01
  1.81037272e+01  1.81037272e+01  8.77863951e+01  8.77863951e+01
  8.77863951e+01  1.82813984e+02  4.19930330e+02  4.19930330e+02
  4.19930330e+02  1.27362009e+03  1.27362009e+03  1.27362009e+03
  1.91437389e+03  2.97566312e+03  2.97566312e+03  2.97566312e+03
  6.60476905e+03  6.60476905e+03  6.60476905e+03  8.27268052e+03
  2.46604265e+04  7.54567198e+04]
E1 = -727.3907732350965  E_coul = 201.8634043220649
cycle= 5 E= -525.527368913032  delta_E= -2.76e-10  |g|= 4.08e-06  |ddm|= 3.39e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.3907732350965  E_coul = 201.8634043220649
  HOMO = -0.575353429812649  LUMO = 0.657016513930197
  mo_energy =
[-1.18102958e+02 -1.21762398e+01 -9.52474073e+00 -9.52474073e+00
 -9.52474073e+00 -1.25250222e+00 -5.75353430e-01 -5.75353430e-01
 -5.75353430e-01  6.57016514e-01  6.57016514e-01  6.57016514e-01
  3.46592579e+00  3.46592579e+00  3.46592579e+00  1.81037206e+01
  1.81037206e+01  1.81037206e+01  8.77863870e+01  8.77863870e+01
  8.77863870e+01  1.82813975e+02  4.19930321e+02  4.19930321e+02
  4.19930321e+02  1.27362008e+03  1.27362008e+03  1.27362008e+03
  1.91437388e+03  2.97566311e+03  2.97566311e+03  2.97566311e+03
  6.60476904e+03  6.60476904e+03  6.60476904e+03  8.27268051e+03
  2.46604265e+04  7.54567198e+04]
E1 = -727.3907893619274  E_coul = 201.86342044889244
Extra cycle  E= -525.527368913035  delta_E= -3.3e-12  |g|= 8.32e-07  |ddm|= 2.37e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.21 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 83674.82030405375
E1 = -727.3907893619274  E_coul = 201.86342044889244
init E= -525.527368913035
    CPU time for initialize scf      1.80 sec, wall time      0.22 sec
  HOMO = -0.575353171822157  LUMO = 0.657016612202964
  mo_energy =
[-1.18102956e+02 -1.21762386e+01 -9.52473947e+00 -9.52473947e+00
 -9.52473947e+00 -1.25250186e+00 -5.75353172e-01 -5.75353172e-01
 -5.75353172e-01  6.57016612e-01  6.57016612e-01  6.57016612e-01
  3.46592623e+00  3.46592623e+00  3.46592623e+00  1.81037217e+01
  1.81037217e+01  1.81037217e+01  8.77863886e+01  8.77863886e+01
  8.77863886e+01  1.82813977e+02  4.19930323e+02  4.19930323e+02
  4.19930323e+02  1.27362008e+03  1.27362008e+03  1.27362008e+03
  1.91437388e+03  2.97566311e+03  2.97566311e+03  2.97566311e+03
  6.60476904e+03  6.60476904e+03  6.60476904e+03  8.27268051e+03
  2.46604265e+04  7.54567198e+04]
E1 = -727.3907854174768  E_coul = 201.86341650444257
cycle= 1 E= -525.527368913034  delta_E= 6.82e-13  |g|= 1.94e-07  |ddm|= 4.74e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.3907854174768  E_coul = 201.86341650444257
  HOMO = -0.575353254413672  LUMO = 0.657016575193578
  mo_energy =
[-1.18102956e+02 -1.21762389e+01 -9.52473976e+00 -9.52473976e+00
 -9.52473976e+00 -1.25250197e+00 -5.75353254e-01 -5.75353254e-01
 -5.75353254e-01  6.57016575e-01  6.57016575e-01  6.57016575e-01
  3.46592610e+00  3.46592610e+00  3.46592610e+00  1.81037214e+01
  1.81037214e+01  1.81037214e+01  8.77863882e+01  8.77863882e+01
  8.77863882e+01  1.82813977e+02  4.19930322e+02  4.19930322e+02
  4.19930322e+02  1.27362008e+03  1.27362008e+03  1.27362008e+03
  1.91437388e+03  2.97566311e+03  2.97566311e+03  2.97566311e+03
  6.60476904e+03  6.60476904e+03  6.60476904e+03  8.27268051e+03
  2.46604265e+04  7.54567198e+04]
E1 = -727.3907862145983  E_coul = 201.8634173015641
Extra cycle  E= -525.527368913034  delta_E= 1.14e-13  |g|= 4.21e-08  |ddm|= 6.26e-08
    CPU time for scf_cycle      1.89 sec, wall time      0.32 sec
exp = [2.61825079e+04 7.61825060e+03 3.61825042e+03 1.61824513e+03
 2.39776647e+02 5.19531838e+01 4.58827574e+00 4.00664566e-01
 1.36279299e+03 6.65180558e+02 3.03319738e+02 3.16145660e+02
 4.93081402e+01 4.82482787e+00 1.46986670e+01 5.20502150e-01
 1.37182765e+00 1.73908175e-01]
grad_E = [-1.98602681e-06  2.17955870e-05  4.35267180e-05  6.68891226e-04
  7.39213153e-04 -5.66349848e-03 -1.39439798e-02  2.63405798e-02
  1.22764421e-06  1.92047556e-05  1.03354128e-04  9.10388011e-05
 -5.01822702e-04 -1.62363215e-02  3.17431681e-03 -1.70482121e-02
 -2.19457451e-02  3.39753616e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078823        1
[INPUT] 0    0    [1    /1   ]  7618.25043051        1
[INPUT] 0    0    [1    /1   ]  3618.25007761        1
[INPUT] 0    0    [1    /1   ]  1618.23990962        1
[INPUT] 0    0    [1    /1   ]  239.770558507        1
[INPUT] 0    0    [1    /1   ]  51.9994725113        1
[INPUT] 0    0    [1    /1   ]  4.61429926629        1
[INPUT] 0    0    [1    /1   ]  0.398436413724       1
[INPUT] 1    0    [1    /1   ]  1362.79298245        1
[INPUT] 1    0    [1    /1   ]  665.180407066        1
[INPUT] 1    0    [1    /1   ]  303.318922314        1
[INPUT] 1    0    [1    /1   ]  316.144941426        1
[INPUT] 1    0    [1    /1   ]  49.3132272659        1
[INPUT] 1    0    [1    /1   ]  4.9302962736         1
[INPUT] 1    0    [1    /1   ]  14.6668988267        1
[INPUT] 1    0    [1    /1   ]  0.588936140128       1
[INPUT] 1    0    [1    /1   ]  1.57654435278        1
[INPUT] 1    0    [1    /1   ]  0.184175713879       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507882274927, 1.0]], [0, [7618.250430508326, 1.0]], [0, [3618.2500776086677, 1.0]], [0, [1618.2399096210877, 1.0]], [0, [239.7705585072868, 1.0]], [0, [51.99947251125077, 1.0]], [0, [4.614299266287287, 1.0]], [0, [0.39843641372410143, 1.0]], [1, [1362.7929824454302, 1.0]], [1, [665.180407066496, 1.0]], [1, [303.318922314488, 1.0]], [1, [316.1449414261964, 1.0]], [1, [49.31322726586633, 1.0]], [1, [4.93029627359611, 1.0]], [1, [14.666898826746435, 1.0]], [1, [0.5889361401283992, 1.0]], [1, [1.5765443527806624, 1.0]], [1, [0.1841757138794152, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50788227]
bas 1, expnt(s) = [7618.25043051]
bas 2, expnt(s) = [3618.25007761]
bas 3, expnt(s) = [1618.23990962]
bas 4, expnt(s) = [239.77055851]
bas 5, expnt(s) = [51.99947251]
bas 6, expnt(s) = [4.61429927]
bas 7, expnt(s) = [0.39843641]
bas 8, expnt(s) = [1362.79298245]
bas 9, expnt(s) = [665.18040707]
bas 10, expnt(s) = [303.31892231]
bas 11, expnt(s) = [316.14494143]
bas 12, expnt(s) = [49.31322727]
bas 13, expnt(s) = [4.93029627]
bas 14, expnt(s) = [14.66689883]
bas 15, expnt(s) = [0.58893614]
bas 16, expnt(s) = [1.57654435]
bas 17, expnt(s) = [0.18417571]
CPU time:        64.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61825043e+03 2.06018612e+03
 3.61825008e+03 1.17866112e+03 1.61823991e+03 6.44610247e+02
 2.39770559e+02 1.53943698e+02 5.19994725e+01 4.89231292e+01
 4.61429927e+00 7.95416036e+00 3.98436414e-01 1.26702239e+00
 1.36279298e+03 2.41558182e+04 6.65180407e+02 9.85504708e+03
 3.03318922e+02 3.69282539e+03 3.16144941e+02 3.88903802e+03
 4.93132273e+01 3.81231409e+02 4.93029627e+00 2.14326398e+01
 1.46668988e+01 8.37350459e+01 5.88936140e-01 1.50511488e+00
 1.57654435e+00 5.15367626e+00 1.84175714e-01 3.51985558e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977707003112734
cond(S) = 83914.32699096779
E1 = -727.5652556594774  E_coul = 203.1367383596633
init E= -524.428517299814
    CPU time for initialize scf      0.70 sec, wall time      0.08 sec
  HOMO = -0.560815342618528  LUMO = 0.738952639891013
  mo_energy =
[-1.17868359e+02 -1.20920779e+01 -9.44136412e+00 -9.44136412e+00
 -9.44136412e+00 -1.23023366e+00 -5.60815343e-01 -5.60815343e-01
 -5.60815343e-01  7.38952640e-01  7.38952640e-01  7.38952640e-01
  4.08052304e+00  4.08052304e+00  4.08052304e+00  1.94474429e+01
  1.94474429e+01  1.94474429e+01  8.90607147e+01  8.90607147e+01
  8.90607147e+01  1.83220694e+02  4.20940284e+02  4.20940284e+02
  4.20940284e+02  1.27456049e+03  1.27456049e+03  1.27456049e+03
  1.91498472e+03  2.97660913e+03  2.97660913e+03  2.97660913e+03
  6.60577384e+03  6.60577384e+03  6.60577384e+03  8.27339971e+03
  2.46612222e+04  7.54575920e+04]
E1 = -727.2227673782174  E_coul = 201.6908793443581
cycle= 1 E= -525.531888033859  delta_E= -1.1  |g|= 0.182  |ddm|= 0.378
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.449145
diis-c [-0.20173159  1.        ]
  HOMO = -0.578684873874956  LUMO = 0.733430675429993
  mo_energy =
[-1.18125174e+02 -1.21893823e+01 -9.53758043e+00 -9.53758043e+00
 -9.53758043e+00 -1.25728500e+00 -5.78684874e-01 -5.78684874e-01
 -5.78684874e-01  7.33430675e-01  7.33430675e-01  7.33430675e-01
  4.04392144e+00  4.04392144e+00  4.04392144e+00  1.93628402e+01
  1.93628402e+01  1.93628402e+01  8.89027311e+01  8.89027311e+01
  8.89027311e+01  1.83016141e+02  4.20696341e+02  4.20696341e+02
  4.20696341e+02  1.27426633e+03  1.27426633e+03  1.27426633e+03
  1.91456924e+03  2.97625332e+03  2.97625332e+03  2.97625332e+03
  6.60530231e+03  6.60530231e+03  6.60530231e+03  8.27284570e+03
  2.46605744e+04  7.54568529e+04]
E1 = -727.4552519505424  E_coul = 201.92314451039903
cycle= 2 E= -525.532107440143  delta_E= -0.000219  |g|= 0.0166  |ddm|= 0.0159
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0310425
diis-c [-7.61543952e-04  3.07361152e-02  9.69263885e-01]
  HOMO = -0.575677785855476  LUMO = 0.734932172897475
  mo_energy =
[-1.18092222e+02 -1.21729290e+01 -9.52088891e+00 -9.52088891e+00
 -9.52088891e+00 -1.25320520e+00 -5.75677786e-01 -5.75677786e-01
 -5.75677786e-01  7.34932173e-01  7.34932173e-01  7.34932173e-01
  4.04977530e+00  4.04977530e+00  4.04977530e+00  1.93770093e+01
  1.93770093e+01  1.93770093e+01  8.89273559e+01  8.89273559e+01
  8.89273559e+01  1.83047813e+02  4.20728900e+02  4.20728900e+02
  4.20728900e+02  1.27430111e+03  1.27430111e+03  1.27430111e+03
  1.91460545e+03  2.97628914e+03  2.97628914e+03  2.97628914e+03
  6.60533874e+03  6.60533874e+03  6.60533874e+03  8.27288235e+03
  2.46606111e+04  7.54568895e+04]
E1 = -727.4036683479875  E_coul = 201.87155306829854
cycle= 3 E= -525.532115279689  delta_E= -7.84e-06  |g|= 0.00246  |ddm|= 0.00425
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00473439
diis-c [-1.91881040e-07 -7.38239348e-04  1.27900635e-01  8.72837605e-01]
  HOMO = -0.576370901629428  LUMO = 0.734578941196121
  mo_energy =
[-1.18096968e+02 -1.21756757e+01 -9.52368403e+00 -9.52368403e+00
 -9.52368403e+00 -1.25410686e+00 -5.76370902e-01 -5.76370902e-01
 -5.76370902e-01  7.34578941e-01  7.34578941e-01  7.34578941e-01
  4.04856236e+00  4.04856236e+00  4.04856236e+00  1.93745724e+01
  1.93745724e+01  1.93745724e+01  8.89236097e+01  8.89236097e+01
  8.89236097e+01  1.83043270e+02  4.20724207e+02  4.20724207e+02
  4.20724207e+02  1.27429614e+03  1.27429614e+03  1.27429614e+03
  1.91460025e+03  2.97628403e+03  2.97628403e+03  2.97628403e+03
  6.60533348e+03  6.60533348e+03  6.60533348e+03  8.27287702e+03
  2.46606057e+04  7.54568840e+04]
E1 = -727.4117393858775  E_coul = 201.87962385427508
cycle= 4 E= -525.532115531602  delta_E= -2.52e-07  |g|= 5.1e-05  |ddm|= 0.000643
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.06025e-05
diis-c [-5.91878137e-10 -1.86234151e-05  2.93709194e-03  3.74835205e-02
  9.59598011e-01]
  HOMO = -0.576346969181289  LUMO = 0.734590202092203
  mo_energy =
[-1.18096857e+02 -1.21755844e+01 -9.52359161e+00 -9.52359161e+00
 -9.52359161e+00 -1.25407443e+00 -5.76346969e-01 -5.76346969e-01
 -5.76346969e-01  7.34590202e-01  7.34590202e-01  7.34590202e-01
  4.04860480e+00  4.04860480e+00  4.04860480e+00  1.93746536e+01
  1.93746536e+01  1.93746536e+01  8.89237116e+01  8.89237116e+01
  8.89237116e+01  1.83043380e+02  4.20724318e+02  4.20724318e+02
  4.20724318e+02  1.27429626e+03  1.27429626e+03  1.27429626e+03
  1.91460036e+03  2.97628414e+03  2.97628414e+03  2.97628414e+03
  6.60533359e+03  6.60533359e+03  6.60533359e+03  8.27287713e+03
  2.46606058e+04  7.54568841e+04]
E1 = -727.4114706000695  E_coul = 201.8793550681952
cycle= 5 E= -525.532115531874  delta_E= -2.72e-10  |g|= 3.9e-06  |ddm|= 3.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4114706000695  E_coul = 201.8793550681952
  HOMO = -0.576349707997422  LUMO = 0.734588747855934
  mo_energy =
[-1.18096866e+02 -1.21755915e+01 -9.52359871e+00 -9.52359871e+00
 -9.52359871e+00 -1.25407782e+00 -5.76349708e-01 -5.76349708e-01
 -5.76349708e-01  7.34588748e-01  7.34588748e-01  7.34588748e-01
  4.04860052e+00  4.04860052e+00  4.04860052e+00  1.93746470e+01
  1.93746470e+01  1.93746470e+01  8.89237036e+01  8.89237036e+01
  8.89237036e+01  1.83043371e+02  4.20724309e+02  4.20724309e+02
  4.20724309e+02  1.27429625e+03  1.27429625e+03  1.27429625e+03
  1.91460035e+03  2.97628413e+03  2.97628413e+03  2.97628413e+03
  6.60533358e+03  6.60533358e+03  6.60533358e+03  8.27287712e+03
  2.46606058e+04  7.54568841e+04]
E1 = -727.4114877274537  E_coul = 201.87937219557745
Extra cycle  E= -525.532115531876  delta_E= -2.05e-12  |g|= 8.4e-07  |ddm|= 1.82e-06
    CPU time for scf_cycle      0.89 sec, wall time      0.27 sec
exp = [2.61825079e+04 7.61825043e+03 3.61825008e+03 1.61823991e+03
 2.39770559e+02 5.19994725e+01 4.61429927e+00 3.98436414e-01
 1.36279298e+03 6.65180407e+02 3.03318922e+02 3.16144941e+02
 4.93132273e+01 4.93029627e+00 1.46668988e+01 5.88936140e-01
 1.57654435e+00 1.84175714e-01]
E = -525.5321155318763
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078823        1
[INPUT] 0    0    [1    /1   ]  7618.25043051        1
[INPUT] 0    0    [1    /1   ]  3618.25007761        1
[INPUT] 0    0    [1    /1   ]  1618.23990962        1
[INPUT] 0    0    [1    /1   ]  239.770558507        1
[INPUT] 0    0    [1    /1   ]  51.9994725113        1
[INPUT] 0    0    [1    /1   ]  4.61429926629        1
[INPUT] 0    0    [1    /1   ]  0.398436413724       1
[INPUT] 1    0    [1    /1   ]  1362.79298245        1
[INPUT] 1    0    [1    /1   ]  665.180407066        1
[INPUT] 1    0    [1    /1   ]  303.318922314        1
[INPUT] 1    0    [1    /1   ]  316.144941426        1
[INPUT] 1    0    [1    /1   ]  49.3132272659        1
[INPUT] 1    0    [1    /1   ]  4.9302962736         1
[INPUT] 1    0    [1    /1   ]  14.6668988267        1
[INPUT] 1    0    [1    /1   ]  0.588936140128       1
[INPUT] 1    0    [1    /1   ]  1.57654435278        1
[INPUT] 1    0    [1    /1   ]  0.184175713879       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507882274927, 1.0]], [0, [7618.250430508326, 1.0]], [0, [3618.2500776086677, 1.0]], [0, [1618.2399096210877, 1.0]], [0, [239.7705585072868, 1.0]], [0, [51.99947251125077, 1.0]], [0, [4.614299266287287, 1.0]], [0, [0.39843641372410143, 1.0]], [1, [1362.7929824454302, 1.0]], [1, [665.180407066496, 1.0]], [1, [303.318922314488, 1.0]], [1, [316.1449414261964, 1.0]], [1, [49.31322726586633, 1.0]], [1, [4.93029627359611, 1.0]], [1, [14.666898826746435, 1.0]], [1, [0.5889361401283992, 1.0]], [1, [1.5765443527806624, 1.0]], [1, [0.1841757138794152, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50788227]
bas 1, expnt(s) = [7618.25043051]
bas 2, expnt(s) = [3618.25007761]
bas 3, expnt(s) = [1618.23990962]
bas 4, expnt(s) = [239.77055851]
bas 5, expnt(s) = [51.99947251]
bas 6, expnt(s) = [4.61429927]
bas 7, expnt(s) = [0.39843641]
bas 8, expnt(s) = [1362.79298245]
bas 9, expnt(s) = [665.18040707]
bas 10, expnt(s) = [303.31892231]
bas 11, expnt(s) = [316.14494143]
bas 12, expnt(s) = [49.31322727]
bas 13, expnt(s) = [4.93029627]
bas 14, expnt(s) = [14.66689883]
bas 15, expnt(s) = [0.58893614]
bas 16, expnt(s) = [1.57654435]
bas 17, expnt(s) = [0.18417571]
CPU time:        65.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61825043e+03 2.06018612e+03
 3.61825008e+03 1.17866112e+03 1.61823991e+03 6.44610247e+02
 2.39770559e+02 1.53943698e+02 5.19994725e+01 4.89231292e+01
 4.61429927e+00 7.95416036e+00 3.98436414e-01 1.26702239e+00
 1.36279298e+03 2.41558182e+04 6.65180407e+02 9.85504708e+03
 3.03318922e+02 3.69282539e+03 3.16144941e+02 3.88903802e+03
 4.93132273e+01 3.81231409e+02 4.93029627e+00 2.14326398e+01
 1.46668988e+01 8.37350459e+01 5.88936140e-01 1.50511488e+00
 1.57654435e+00 5.15367626e+00 1.84175714e-01 3.51985558e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977707003112734
cond(S) = 83914.32699096779
E1 = -727.5652556594774  E_coul = 203.1367383596633
init E= -524.428517299814
    CPU time for initialize scf      0.68 sec, wall time      0.08 sec
  HOMO = -0.560815342618528  LUMO = 0.738952639891013
  mo_energy =
[-1.17868359e+02 -1.20920779e+01 -9.44136412e+00 -9.44136412e+00
 -9.44136412e+00 -1.23023366e+00 -5.60815343e-01 -5.60815343e-01
 -5.60815343e-01  7.38952640e-01  7.38952640e-01  7.38952640e-01
  4.08052304e+00  4.08052304e+00  4.08052304e+00  1.94474429e+01
  1.94474429e+01  1.94474429e+01  8.90607147e+01  8.90607147e+01
  8.90607147e+01  1.83220694e+02  4.20940284e+02  4.20940284e+02
  4.20940284e+02  1.27456049e+03  1.27456049e+03  1.27456049e+03
  1.91498472e+03  2.97660913e+03  2.97660913e+03  2.97660913e+03
  6.60577384e+03  6.60577384e+03  6.60577384e+03  8.27339971e+03
  2.46612222e+04  7.54575920e+04]
E1 = -727.2227673782174  E_coul = 201.6908793443581
cycle= 1 E= -525.531888033859  delta_E= -1.1  |g|= 0.182  |ddm|= 0.378
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.449145
diis-c [-0.20173159  1.        ]
  HOMO = -0.578684873874956  LUMO = 0.733430675429993
  mo_energy =
[-1.18125174e+02 -1.21893823e+01 -9.53758043e+00 -9.53758043e+00
 -9.53758043e+00 -1.25728500e+00 -5.78684874e-01 -5.78684874e-01
 -5.78684874e-01  7.33430675e-01  7.33430675e-01  7.33430675e-01
  4.04392144e+00  4.04392144e+00  4.04392144e+00  1.93628402e+01
  1.93628402e+01  1.93628402e+01  8.89027311e+01  8.89027311e+01
  8.89027311e+01  1.83016141e+02  4.20696341e+02  4.20696341e+02
  4.20696341e+02  1.27426633e+03  1.27426633e+03  1.27426633e+03
  1.91456924e+03  2.97625332e+03  2.97625332e+03  2.97625332e+03
  6.60530231e+03  6.60530231e+03  6.60530231e+03  8.27284570e+03
  2.46605744e+04  7.54568529e+04]
E1 = -727.4552519505424  E_coul = 201.92314451039903
cycle= 2 E= -525.532107440143  delta_E= -0.000219  |g|= 0.0166  |ddm|= 0.0159
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0310425
diis-c [-7.61543952e-04  3.07361152e-02  9.69263885e-01]
  HOMO = -0.575677785855476  LUMO = 0.734932172897475
  mo_energy =
[-1.18092222e+02 -1.21729290e+01 -9.52088891e+00 -9.52088891e+00
 -9.52088891e+00 -1.25320520e+00 -5.75677786e-01 -5.75677786e-01
 -5.75677786e-01  7.34932173e-01  7.34932173e-01  7.34932173e-01
  4.04977530e+00  4.04977530e+00  4.04977530e+00  1.93770093e+01
  1.93770093e+01  1.93770093e+01  8.89273559e+01  8.89273559e+01
  8.89273559e+01  1.83047813e+02  4.20728900e+02  4.20728900e+02
  4.20728900e+02  1.27430111e+03  1.27430111e+03  1.27430111e+03
  1.91460545e+03  2.97628914e+03  2.97628914e+03  2.97628914e+03
  6.60533874e+03  6.60533874e+03  6.60533874e+03  8.27288235e+03
  2.46606111e+04  7.54568895e+04]
E1 = -727.4036683479875  E_coul = 201.87155306829854
cycle= 3 E= -525.532115279689  delta_E= -7.84e-06  |g|= 0.00246  |ddm|= 0.00425
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00473439
diis-c [-1.91881040e-07 -7.38239348e-04  1.27900635e-01  8.72837605e-01]
  HOMO = -0.576370901629428  LUMO = 0.734578941196121
  mo_energy =
[-1.18096968e+02 -1.21756757e+01 -9.52368403e+00 -9.52368403e+00
 -9.52368403e+00 -1.25410686e+00 -5.76370902e-01 -5.76370902e-01
 -5.76370902e-01  7.34578941e-01  7.34578941e-01  7.34578941e-01
  4.04856236e+00  4.04856236e+00  4.04856236e+00  1.93745724e+01
  1.93745724e+01  1.93745724e+01  8.89236097e+01  8.89236097e+01
  8.89236097e+01  1.83043270e+02  4.20724207e+02  4.20724207e+02
  4.20724207e+02  1.27429614e+03  1.27429614e+03  1.27429614e+03
  1.91460025e+03  2.97628403e+03  2.97628403e+03  2.97628403e+03
  6.60533348e+03  6.60533348e+03  6.60533348e+03  8.27287702e+03
  2.46606057e+04  7.54568840e+04]
E1 = -727.4117393858775  E_coul = 201.87962385427508
cycle= 4 E= -525.532115531602  delta_E= -2.52e-07  |g|= 5.1e-05  |ddm|= 0.000643
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.06025e-05
diis-c [-5.91878137e-10 -1.86234151e-05  2.93709194e-03  3.74835205e-02
  9.59598011e-01]
  HOMO = -0.576346969181289  LUMO = 0.734590202092203
  mo_energy =
[-1.18096857e+02 -1.21755844e+01 -9.52359161e+00 -9.52359161e+00
 -9.52359161e+00 -1.25407443e+00 -5.76346969e-01 -5.76346969e-01
 -5.76346969e-01  7.34590202e-01  7.34590202e-01  7.34590202e-01
  4.04860480e+00  4.04860480e+00  4.04860480e+00  1.93746536e+01
  1.93746536e+01  1.93746536e+01  8.89237116e+01  8.89237116e+01
  8.89237116e+01  1.83043380e+02  4.20724318e+02  4.20724318e+02
  4.20724318e+02  1.27429626e+03  1.27429626e+03  1.27429626e+03
  1.91460036e+03  2.97628414e+03  2.97628414e+03  2.97628414e+03
  6.60533359e+03  6.60533359e+03  6.60533359e+03  8.27287713e+03
  2.46606058e+04  7.54568841e+04]
E1 = -727.4114706000695  E_coul = 201.8793550681952
cycle= 5 E= -525.532115531874  delta_E= -2.72e-10  |g|= 3.9e-06  |ddm|= 3.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4114706000695  E_coul = 201.8793550681952
  HOMO = -0.576349707997422  LUMO = 0.734588747855934
  mo_energy =
[-1.18096866e+02 -1.21755915e+01 -9.52359871e+00 -9.52359871e+00
 -9.52359871e+00 -1.25407782e+00 -5.76349708e-01 -5.76349708e-01
 -5.76349708e-01  7.34588748e-01  7.34588748e-01  7.34588748e-01
  4.04860052e+00  4.04860052e+00  4.04860052e+00  1.93746470e+01
  1.93746470e+01  1.93746470e+01  8.89237036e+01  8.89237036e+01
  8.89237036e+01  1.83043371e+02  4.20724309e+02  4.20724309e+02
  4.20724309e+02  1.27429625e+03  1.27429625e+03  1.27429625e+03
  1.91460035e+03  2.97628413e+03  2.97628413e+03  2.97628413e+03
  6.60533358e+03  6.60533358e+03  6.60533358e+03  8.27287712e+03
  2.46606058e+04  7.54568841e+04]
E1 = -727.4114877274537  E_coul = 201.87937219557745
Extra cycle  E= -525.532115531876  delta_E= -2.05e-12  |g|= 8.4e-07  |ddm|= 1.82e-06
    CPU time for scf_cycle      0.87 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 83914.32699096779
E1 = -727.4114877274537  E_coul = 201.87937219557745
init E= -525.532115531876
    CPU time for initialize scf      1.43 sec, wall time      0.21 sec
  HOMO = -0.576349409816983  LUMO = 0.734588889506745
  mo_energy =
[-1.18096864e+02 -1.21755902e+01 -9.52359739e+00 -9.52359739e+00
 -9.52359739e+00 -1.25407741e+00 -5.76349410e-01 -5.76349410e-01
 -5.76349410e-01  7.34588890e-01  7.34588890e-01  7.34588890e-01
  4.04860107e+00  4.04860107e+00  4.04860107e+00  1.93746482e+01
  1.93746482e+01  1.93746482e+01  8.89237053e+01  8.89237053e+01
  8.89237053e+01  1.83043373e+02  4.20724311e+02  4.20724311e+02
  4.20724311e+02  1.27429625e+03  1.27429625e+03  1.27429625e+03
  1.91460036e+03  2.97628413e+03  2.97628413e+03  2.97628413e+03
  6.60533358e+03  6.60533358e+03  6.60533358e+03  8.27287712e+03
  2.46606058e+04  7.54568841e+04]
E1 = -727.4114837605593  E_coul = 201.8793682286834
cycle= 1 E= -525.532115531876  delta_E= 4.55e-13  |g|= 1.97e-07  |ddm|= 4.29e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4114837605593  E_coul = 201.8793682286834
  HOMO = -0.576349489828236  LUMO = 0.734588848521631
  mo_energy =
[-1.18096864e+02 -1.21755905e+01 -9.52359769e+00 -9.52359769e+00
 -9.52359769e+00 -1.25407752e+00 -5.76349490e-01 -5.76349490e-01
 -5.76349490e-01  7.34588849e-01  7.34588849e-01  7.34588849e-01
  4.04860093e+00  4.04860093e+00  4.04860093e+00  1.93746479e+01
  1.93746479e+01  1.93746479e+01  8.89237049e+01  8.89237049e+01
  8.89237049e+01  1.83043373e+02  4.20724310e+02  4.20724310e+02
  4.20724310e+02  1.27429625e+03  1.27429625e+03  1.27429625e+03
  1.91460036e+03  2.97628413e+03  2.97628413e+03  2.97628413e+03
  6.60533358e+03  6.60533358e+03  6.60533358e+03  8.27287712e+03
  2.46606058e+04  7.54568841e+04]
E1 = -727.4114845874914  E_coul = 201.87936905561557
Extra cycle  E= -525.532115531876  delta_E= 1.14e-13  |g|= 4.32e-08  |ddm|= 6.63e-08
    CPU time for scf_cycle      1.51 sec, wall time      0.29 sec
exp = [2.61825079e+04 7.61825043e+03 3.61825008e+03 1.61823991e+03
 2.39770559e+02 5.19994725e+01 4.61429927e+00 3.98436414e-01
 1.36279298e+03 6.65180407e+02 3.03318922e+02 3.16144941e+02
 4.93132273e+01 4.93029627e+00 1.46668988e+01 5.88936140e-01
 1.57654435e+00 1.84175714e-01]
grad_E = [-1.98689840e-06  2.18644752e-05  4.37280674e-05  6.71438943e-04
  5.64467714e-04 -4.39010727e-03  1.07121622e-02 -1.11080800e-02
  1.09029171e-06  1.81884854e-05  9.70651795e-05  8.55088946e-05
  4.69877204e-04 -1.01351421e-02 -4.25762716e-03  2.90032935e-02
 -1.23765823e-02 -4.96191144e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.507891         1
[INPUT] 0    0    [1    /1   ]  7618.25033503        1
[INPUT] 0    0    [1    /1   ]  3618.2498869         1
[INPUT] 0    0    [1    /1   ]  1618.23697915        1
[INPUT] 0    0    [1    /1   ]  239.767408045        1
[INPUT] 0    0    [1    /1   ]  52.0235560099        1
[INPUT] 0    0    [1    /1   ]  4.61095225968        1
[INPUT] 0    0    [1    /1   ]  0.398469011559       1
[INPUT] 1    0    [1    /1   ]  1362.79297716        1
[INPUT] 1    0    [1    /1   ]  665.180323656        1
[INPUT] 1    0    [1    /1   ]  303.318473982        1
[INPUT] 1    0    [1    /1   ]  316.144546506        1
[INPUT] 1    0    [1    /1   ]  49.3147252715        1
[INPUT] 1    0    [1    /1   ]  4.98511972603        1
[INPUT] 1    0    [1    /1   ]  14.6591077305        1
[INPUT] 1    0    [1    /1   ]  0.617178577          1
[INPUT] 1    0    [1    /1   ]  1.67489400432        1
[INPUT] 1    0    [1    /1   ]  0.19238933204        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507890973087, 1.0]], [0, [7618.250335026565, 1.0]], [0, [3618.2498869035767, 1.0]], [0, [1618.2369791531862, 1.0]], [0, [239.7674080450549, 1.0]], [0, [52.02355600989739, 1.0]], [0, [4.610952259675018, 1.0]], [0, [0.3984690115586536, 1.0]], [1, [1362.7929771605984, 1.0]], [1, [665.1803236556736, 1.0]], [1, [303.31847398246356, 1.0]], [1, [316.1445465059201, 1.0]], [1, [49.31472527147238, 1.0]], [1, [4.985119726032796, 1.0]], [1, [14.659107730452652, 1.0]], [1, [0.6171785769997026, 1.0]], [1, [1.6748940043150675, 1.0]], [1, [0.19238933204048653, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50789097]
bas 1, expnt(s) = [7618.25033503]
bas 2, expnt(s) = [3618.2498869]
bas 3, expnt(s) = [1618.23697915]
bas 4, expnt(s) = [239.76740805]
bas 5, expnt(s) = [52.02355601]
bas 6, expnt(s) = [4.61095226]
bas 7, expnt(s) = [0.39846901]
bas 8, expnt(s) = [1362.79297716]
bas 9, expnt(s) = [665.18032366]
bas 10, expnt(s) = [303.31847398]
bas 11, expnt(s) = [316.14454651]
bas 12, expnt(s) = [49.31472527]
bas 13, expnt(s) = [4.98511973]
bas 14, expnt(s) = [14.65910773]
bas 15, expnt(s) = [0.61717858]
bas 16, expnt(s) = [1.674894]
bas 17, expnt(s) = [0.19238933]
CPU time:        72.14
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61825034e+03 2.06018611e+03
 3.61824989e+03 1.17866108e+03 1.61823698e+03 6.44609372e+02
 2.39767408e+02 1.53942181e+02 5.20235560e+01 4.89401223e+01
 4.61095226e+00 7.94983278e+00 3.98469012e-01 1.26710014e+00
 1.36279298e+03 2.41558181e+04 6.65180324e+02 9.85504553e+03
 3.03318474e+02 3.69281856e+03 3.16144547e+02 3.88903195e+03
 4.93147253e+01 3.81245885e+02 4.98511973e+00 2.17309586e+01
 1.46591077e+01 8.36794493e+01 6.17178577e-01 1.59587160e+00
 1.67489400e+00 5.55864005e+00 1.92389332e-01 3.71715462e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977317416500025
cond(S) = 84043.15821761175
E1 = -727.5581865174057  E_coul = 203.13321870014892
init E= -524.424967817257
    CPU time for initialize scf      0.71 sec, wall time      0.08 sec
  HOMO = -0.560665693893953  LUMO = 0.787437023742841
  mo_energy =
[-1.17868762e+02 -1.20926363e+01 -9.44198999e+00 -9.44198999e+00
 -9.44198999e+00 -1.23012667e+00 -5.60665694e-01 -5.60665694e-01
 -5.60665694e-01  7.87437024e-01  7.87437024e-01  7.87437024e-01
  4.36503797e+00  4.36503797e+00  4.36503797e+00  2.00606987e+01
  2.00606987e+01  2.00606987e+01  8.96434875e+01  8.96434875e+01
  8.96434875e+01  1.83271232e+02  4.21355616e+02  4.21355616e+02
  4.21355616e+02  1.27491387e+03  1.27491387e+03  1.27491387e+03
  1.91504963e+03  2.97693271e+03  2.97693271e+03  2.97693271e+03
  6.60606666e+03  6.60606666e+03  6.60606666e+03  8.27345358e+03
  2.46612689e+04  7.54576332e+04]
E1 = -727.2540167853608  E_coul = 201.72107540193142
cycle= 1 E= -525.532941383429  delta_E= -1.11  |g|= 0.182  |ddm|= 0.322
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.450847
diis-c [-0.20326284  1.        ]
  HOMO = -0.577361949764391  LUMO = 0.781858079768065
  mo_energy =
[-1.18123285e+02 -1.21875105e+01 -9.53580751e+00 -9.53580751e+00
 -9.53580751e+00 -1.25575739e+00 -5.77361950e-01 -5.77361950e-01
 -5.77361950e-01  7.81858080e-01  7.81858080e-01  7.81858080e-01
  4.32845262e+00  4.32845262e+00  4.32845262e+00  1.99780839e+01
  1.99780839e+01  1.99780839e+01  8.94881191e+01  8.94881191e+01
  8.94881191e+01  1.83069191e+02  4.21114128e+02  4.21114128e+02
  4.21114128e+02  1.27462223e+03  1.27462223e+03  1.27462223e+03
  1.91463691e+03  2.97657956e+03  2.97657956e+03  2.97657956e+03
  6.60559787e+03  6.60559787e+03  6.60559787e+03  8.27290237e+03
  2.46606239e+04  7.54568969e+04]
E1 = -727.481501471929  E_coul = 201.94834829549853
cycle= 2 E= -525.53315317643  delta_E= -0.000212  |g|= 0.0163  |ddm|= 0.0152
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0309465
diis-c [-7.54674974e-04  3.06901033e-02  9.69309897e-01]
  HOMO = -0.574435786151441  LUMO = 0.783436209309314
  mo_energy =
[-1.18090867e+02 -1.21714345e+01 -9.51949690e+00 -9.51949690e+00
 -9.51949690e+00 -1.25179501e+00 -5.74435786e-01 -5.74435786e-01
 -5.74435786e-01  7.83436209e-01  7.83436209e-01  7.83436209e-01
  4.33440528e+00  4.33440528e+00  4.33440528e+00  1.99919548e+01
  1.99919548e+01  1.99919548e+01  8.95122580e+01  8.95122580e+01
  8.95122580e+01  1.83100346e+02  4.21146152e+02  4.21146152e+02
  4.21146152e+02  1.27465645e+03  1.27465645e+03  1.27465645e+03
  1.91467257e+03  2.97661483e+03  2.97661483e+03  2.97661483e+03
  6.60563374e+03  6.60563374e+03  6.60563374e+03  8.27293847e+03
  2.46606600e+04  7.54569330e+04]
E1 = -727.4316674993939  E_coul = 201.89850688066375
cycle= 3 E= -525.53316061873  delta_E= -7.44e-06  |g|= 0.0024  |ddm|= 0.00411
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00467393
diis-c [-1.69409281e-07 -7.35189719e-04  1.26785244e-01  8.73949946e-01]
  HOMO = -0.575093586165178  LUMO = 0.783078599806736
  mo_energy =
[-1.18095486e+02 -1.21740882e+01 -9.52219837e+00 -9.52219837e+00
 -9.52219837e+00 -1.25265254e+00 -5.75093586e-01 -5.75093586e-01
 -5.75093586e-01  7.83078600e-01  7.83078600e-01  7.83078600e-01
  4.33320284e+00  4.33320284e+00  4.33320284e+00  1.99895985e+01
  1.99895985e+01  1.99895985e+01  8.95086262e+01  8.95086262e+01
  8.95086262e+01  1.83095927e+02  4.21141587e+02  4.21141587e+02
  4.21141587e+02  1.27465162e+03  1.27465162e+03  1.27465162e+03
  1.91466751e+03  2.97660984e+03  2.97660984e+03  2.97660984e+03
  6.60562862e+03  6.60562862e+03  6.60562862e+03  8.27293327e+03
  2.46606548e+04  7.54569277e+04]
E1 = -727.439426721074  E_coul = 201.90626586810154
cycle= 4 E= -525.533160852973  delta_E= -2.34e-07  |g|= 4.86e-05  |ddm|= 0.000632
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.69943e-05
diis-c [-4.93901794e-10 -2.32307442e-05  3.68501989e-03  4.22388589e-02
  9.54099352e-01]
  HOMO = -0.575069333749031  LUMO = 0.783091070321119
  mo_energy =
[-1.18095378e+02 -1.21739996e+01 -9.52210865e+00 -9.52210865e+00
 -9.52210865e+00 -1.25262005e+00 -5.75069334e-01 -5.75069334e-01
 -5.75069334e-01  7.83091070e-01  7.83091070e-01  7.83091070e-01
  4.33324688e+00  4.33324688e+00  4.33324688e+00  1.99896778e+01
  1.99896778e+01  1.99896778e+01  8.95087250e+01  8.95087250e+01
  8.95087250e+01  1.83096034e+02  4.21141694e+02  4.21141694e+02
  4.21141694e+02  1.27465173e+03  1.27465173e+03  1.27465173e+03
  1.91466761e+03  2.97660995e+03  2.97660995e+03  2.97660995e+03
  6.60562873e+03  6.60562873e+03  6.60562873e+03  8.27293338e+03
  2.46606549e+04  7.54569278e+04]
E1 = -727.4391747849927  E_coul = 201.90601393178295
cycle= 5 E= -525.53316085321  delta_E= -2.37e-10  |g|= 3.3e-06  |ddm|= 2.97e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4391747849927  E_coul = 201.90601393178295
  HOMO = -0.575071597122135  LUMO = 0.783089804410548
  mo_energy =
[-1.18095386e+02 -1.21740056e+01 -9.52211477e+00 -9.52211477e+00
 -9.52211477e+00 -1.25262287e+00 -5.75071597e-01 -5.75071597e-01
 -5.75071597e-01  7.83089804e-01  7.83089804e-01  7.83089804e-01
  4.33324320e+00  4.33324320e+00  4.33324320e+00  1.99896721e+01
  1.99896721e+01  1.99896721e+01  8.95087180e+01  8.95087180e+01
  8.95087180e+01  1.83096026e+02  4.21141686e+02  4.21141686e+02
  4.21141686e+02  1.27465172e+03  1.27465172e+03  1.27465172e+03
  1.91466761e+03  2.97660994e+03  2.97660994e+03  2.97660994e+03
  6.60562872e+03  6.60562872e+03  6.60562872e+03  8.27293337e+03
  2.46606549e+04  7.54569277e+04]
E1 = -727.4391898230897  E_coul = 201.9060289698797
Extra cycle  E= -525.53316085321  delta_E= -2.27e-13  |g|= 7.34e-07  |ddm|= 1.43e-06
    CPU time for scf_cycle      0.90 sec, wall time      0.28 sec
exp = [2.61825079e+04 7.61825034e+03 3.61824989e+03 1.61823698e+03
 2.39767408e+02 5.20235560e+01 4.61095226e+00 3.98469012e-01
 1.36279298e+03 6.65180324e+02 3.03318474e+02 3.16144547e+02
 4.93147253e+01 4.98511973e+00 1.46591077e+01 6.17178577e-01
 1.67489400e+00 1.92389332e-01]
E = -525.53316085321
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.507891         1
[INPUT] 0    0    [1    /1   ]  7618.25033503        1
[INPUT] 0    0    [1    /1   ]  3618.2498869         1
[INPUT] 0    0    [1    /1   ]  1618.23697915        1
[INPUT] 0    0    [1    /1   ]  239.767408045        1
[INPUT] 0    0    [1    /1   ]  52.0235560099        1
[INPUT] 0    0    [1    /1   ]  4.61095225968        1
[INPUT] 0    0    [1    /1   ]  0.398469011559       1
[INPUT] 1    0    [1    /1   ]  1362.79297716        1
[INPUT] 1    0    [1    /1   ]  665.180323656        1
[INPUT] 1    0    [1    /1   ]  303.318473982        1
[INPUT] 1    0    [1    /1   ]  316.144546506        1
[INPUT] 1    0    [1    /1   ]  49.3147252715        1
[INPUT] 1    0    [1    /1   ]  4.98511972603        1
[INPUT] 1    0    [1    /1   ]  14.6591077305        1
[INPUT] 1    0    [1    /1   ]  0.617178577          1
[INPUT] 1    0    [1    /1   ]  1.67489400432        1
[INPUT] 1    0    [1    /1   ]  0.19238933204        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507890973087, 1.0]], [0, [7618.250335026565, 1.0]], [0, [3618.2498869035767, 1.0]], [0, [1618.2369791531862, 1.0]], [0, [239.7674080450549, 1.0]], [0, [52.02355600989739, 1.0]], [0, [4.610952259675018, 1.0]], [0, [0.3984690115586536, 1.0]], [1, [1362.7929771605984, 1.0]], [1, [665.1803236556736, 1.0]], [1, [303.31847398246356, 1.0]], [1, [316.1445465059201, 1.0]], [1, [49.31472527147238, 1.0]], [1, [4.985119726032796, 1.0]], [1, [14.659107730452652, 1.0]], [1, [0.6171785769997026, 1.0]], [1, [1.6748940043150675, 1.0]], [1, [0.19238933204048653, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50789097]
bas 1, expnt(s) = [7618.25033503]
bas 2, expnt(s) = [3618.2498869]
bas 3, expnt(s) = [1618.23697915]
bas 4, expnt(s) = [239.76740805]
bas 5, expnt(s) = [52.02355601]
bas 6, expnt(s) = [4.61095226]
bas 7, expnt(s) = [0.39846901]
bas 8, expnt(s) = [1362.79297716]
bas 9, expnt(s) = [665.18032366]
bas 10, expnt(s) = [303.31847398]
bas 11, expnt(s) = [316.14454651]
bas 12, expnt(s) = [49.31472527]
bas 13, expnt(s) = [4.98511973]
bas 14, expnt(s) = [14.65910773]
bas 15, expnt(s) = [0.61717858]
bas 16, expnt(s) = [1.674894]
bas 17, expnt(s) = [0.19238933]
CPU time:        73.16
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61825034e+03 2.06018611e+03
 3.61824989e+03 1.17866108e+03 1.61823698e+03 6.44609372e+02
 2.39767408e+02 1.53942181e+02 5.20235560e+01 4.89401223e+01
 4.61095226e+00 7.94983278e+00 3.98469012e-01 1.26710014e+00
 1.36279298e+03 2.41558181e+04 6.65180324e+02 9.85504553e+03
 3.03318474e+02 3.69281856e+03 3.16144547e+02 3.88903195e+03
 4.93147253e+01 3.81245885e+02 4.98511973e+00 2.17309586e+01
 1.46591077e+01 8.36794493e+01 6.17178577e-01 1.59587160e+00
 1.67489400e+00 5.55864005e+00 1.92389332e-01 3.71715462e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977317416500025
cond(S) = 84043.15821761175
E1 = -727.5581865174057  E_coul = 203.13321870014892
init E= -524.424967817257
    CPU time for initialize scf      0.69 sec, wall time      0.08 sec
  HOMO = -0.560665693893953  LUMO = 0.787437023742841
  mo_energy =
[-1.17868762e+02 -1.20926363e+01 -9.44198999e+00 -9.44198999e+00
 -9.44198999e+00 -1.23012667e+00 -5.60665694e-01 -5.60665694e-01
 -5.60665694e-01  7.87437024e-01  7.87437024e-01  7.87437024e-01
  4.36503797e+00  4.36503797e+00  4.36503797e+00  2.00606987e+01
  2.00606987e+01  2.00606987e+01  8.96434875e+01  8.96434875e+01
  8.96434875e+01  1.83271232e+02  4.21355616e+02  4.21355616e+02
  4.21355616e+02  1.27491387e+03  1.27491387e+03  1.27491387e+03
  1.91504963e+03  2.97693271e+03  2.97693271e+03  2.97693271e+03
  6.60606666e+03  6.60606666e+03  6.60606666e+03  8.27345358e+03
  2.46612689e+04  7.54576332e+04]
E1 = -727.2540167853608  E_coul = 201.72107540193142
cycle= 1 E= -525.532941383429  delta_E= -1.11  |g|= 0.182  |ddm|= 0.322
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.450847
diis-c [-0.20326284  1.        ]
  HOMO = -0.577361949764391  LUMO = 0.781858079768065
  mo_energy =
[-1.18123285e+02 -1.21875105e+01 -9.53580751e+00 -9.53580751e+00
 -9.53580751e+00 -1.25575739e+00 -5.77361950e-01 -5.77361950e-01
 -5.77361950e-01  7.81858080e-01  7.81858080e-01  7.81858080e-01
  4.32845262e+00  4.32845262e+00  4.32845262e+00  1.99780839e+01
  1.99780839e+01  1.99780839e+01  8.94881191e+01  8.94881191e+01
  8.94881191e+01  1.83069191e+02  4.21114128e+02  4.21114128e+02
  4.21114128e+02  1.27462223e+03  1.27462223e+03  1.27462223e+03
  1.91463691e+03  2.97657956e+03  2.97657956e+03  2.97657956e+03
  6.60559787e+03  6.60559787e+03  6.60559787e+03  8.27290237e+03
  2.46606239e+04  7.54568969e+04]
E1 = -727.481501471929  E_coul = 201.94834829549853
cycle= 2 E= -525.53315317643  delta_E= -0.000212  |g|= 0.0163  |ddm|= 0.0152
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0309465
diis-c [-7.54674974e-04  3.06901033e-02  9.69309897e-01]
  HOMO = -0.574435786151441  LUMO = 0.783436209309314
  mo_energy =
[-1.18090867e+02 -1.21714345e+01 -9.51949690e+00 -9.51949690e+00
 -9.51949690e+00 -1.25179501e+00 -5.74435786e-01 -5.74435786e-01
 -5.74435786e-01  7.83436209e-01  7.83436209e-01  7.83436209e-01
  4.33440528e+00  4.33440528e+00  4.33440528e+00  1.99919548e+01
  1.99919548e+01  1.99919548e+01  8.95122580e+01  8.95122580e+01
  8.95122580e+01  1.83100346e+02  4.21146152e+02  4.21146152e+02
  4.21146152e+02  1.27465645e+03  1.27465645e+03  1.27465645e+03
  1.91467257e+03  2.97661483e+03  2.97661483e+03  2.97661483e+03
  6.60563374e+03  6.60563374e+03  6.60563374e+03  8.27293847e+03
  2.46606600e+04  7.54569330e+04]
E1 = -727.4316674993939  E_coul = 201.89850688066375
cycle= 3 E= -525.53316061873  delta_E= -7.44e-06  |g|= 0.0024  |ddm|= 0.00411
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00467393
diis-c [-1.69409281e-07 -7.35189719e-04  1.26785244e-01  8.73949946e-01]
  HOMO = -0.575093586165178  LUMO = 0.783078599806736
  mo_energy =
[-1.18095486e+02 -1.21740882e+01 -9.52219837e+00 -9.52219837e+00
 -9.52219837e+00 -1.25265254e+00 -5.75093586e-01 -5.75093586e-01
 -5.75093586e-01  7.83078600e-01  7.83078600e-01  7.83078600e-01
  4.33320284e+00  4.33320284e+00  4.33320284e+00  1.99895985e+01
  1.99895985e+01  1.99895985e+01  8.95086262e+01  8.95086262e+01
  8.95086262e+01  1.83095927e+02  4.21141587e+02  4.21141587e+02
  4.21141587e+02  1.27465162e+03  1.27465162e+03  1.27465162e+03
  1.91466751e+03  2.97660984e+03  2.97660984e+03  2.97660984e+03
  6.60562862e+03  6.60562862e+03  6.60562862e+03  8.27293327e+03
  2.46606548e+04  7.54569277e+04]
E1 = -727.439426721074  E_coul = 201.90626586810154
cycle= 4 E= -525.533160852973  delta_E= -2.34e-07  |g|= 4.86e-05  |ddm|= 0.000632
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.69943e-05
diis-c [-4.93901794e-10 -2.32307442e-05  3.68501989e-03  4.22388589e-02
  9.54099352e-01]
  HOMO = -0.575069333749031  LUMO = 0.783091070321119
  mo_energy =
[-1.18095378e+02 -1.21739996e+01 -9.52210865e+00 -9.52210865e+00
 -9.52210865e+00 -1.25262005e+00 -5.75069334e-01 -5.75069334e-01
 -5.75069334e-01  7.83091070e-01  7.83091070e-01  7.83091070e-01
  4.33324688e+00  4.33324688e+00  4.33324688e+00  1.99896778e+01
  1.99896778e+01  1.99896778e+01  8.95087250e+01  8.95087250e+01
  8.95087250e+01  1.83096034e+02  4.21141694e+02  4.21141694e+02
  4.21141694e+02  1.27465173e+03  1.27465173e+03  1.27465173e+03
  1.91466761e+03  2.97660995e+03  2.97660995e+03  2.97660995e+03
  6.60562873e+03  6.60562873e+03  6.60562873e+03  8.27293338e+03
  2.46606549e+04  7.54569278e+04]
E1 = -727.4391747849927  E_coul = 201.90601393178295
cycle= 5 E= -525.53316085321  delta_E= -2.37e-10  |g|= 3.3e-06  |ddm|= 2.97e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4391747849927  E_coul = 201.90601393178295
  HOMO = -0.575071597122135  LUMO = 0.783089804410548
  mo_energy =
[-1.18095386e+02 -1.21740056e+01 -9.52211477e+00 -9.52211477e+00
 -9.52211477e+00 -1.25262287e+00 -5.75071597e-01 -5.75071597e-01
 -5.75071597e-01  7.83089804e-01  7.83089804e-01  7.83089804e-01
  4.33324320e+00  4.33324320e+00  4.33324320e+00  1.99896721e+01
  1.99896721e+01  1.99896721e+01  8.95087180e+01  8.95087180e+01
  8.95087180e+01  1.83096026e+02  4.21141686e+02  4.21141686e+02
  4.21141686e+02  1.27465172e+03  1.27465172e+03  1.27465172e+03
  1.91466761e+03  2.97660994e+03  2.97660994e+03  2.97660994e+03
  6.60562872e+03  6.60562872e+03  6.60562872e+03  8.27293337e+03
  2.46606549e+04  7.54569277e+04]
E1 = -727.4391898230897  E_coul = 201.9060289698797
Extra cycle  E= -525.53316085321  delta_E= -2.27e-13  |g|= 7.34e-07  |ddm|= 1.43e-06
    CPU time for scf_cycle      0.89 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 84043.15821761175
E1 = -727.4391898230897  E_coul = 201.9060289698797
init E= -525.53316085321
    CPU time for initialize scf      1.10 sec, wall time      0.20 sec
  HOMO = -0.575071329700374  LUMO = 0.783089942808437
  mo_energy =
[-1.18095384e+02 -1.21740045e+01 -9.52211362e+00 -9.52211362e+00
 -9.52211362e+00 -1.25262250e+00 -5.75071330e-01 -5.75071330e-01
 -5.75071330e-01  7.83089943e-01  7.83089943e-01  7.83089943e-01
  4.33324370e+00  4.33324370e+00  4.33324370e+00  1.99896731e+01
  1.99896731e+01  1.99896731e+01  8.95087195e+01  8.95087195e+01
  8.95087195e+01  1.83096028e+02  4.21141688e+02  4.21141688e+02
  4.21141688e+02  1.27465172e+03  1.27465172e+03  1.27465172e+03
  1.91466761e+03  2.97660995e+03  2.97660995e+03  2.97660995e+03
  6.60562872e+03  6.60562872e+03  6.60562872e+03  8.27293337e+03
  2.46606549e+04  7.54569278e+04]
E1 = -727.4391864407037  E_coul = 201.90602558749367
cycle= 1 E= -525.53316085321  delta_E=    0  |g|= 1.7e-07  |ddm|= 3.55e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.4391864407037  E_coul = 201.90602558749367
  HOMO = -0.575071396389335  LUMO = 0.783089906476718
  mo_energy =
[-1.18095384e+02 -1.21740048e+01 -9.52211387e+00 -9.52211387e+00
 -9.52211387e+00 -1.25262259e+00 -5.75071396e-01 -5.75071396e-01
 -5.75071396e-01  7.83089906e-01  7.83089906e-01  7.83089906e-01
  4.33324358e+00  4.33324358e+00  4.33324358e+00  1.99896729e+01
  1.99896729e+01  1.99896729e+01  8.95087191e+01  8.95087191e+01
  8.95087191e+01  1.83096027e+02  4.21141687e+02  4.21141687e+02
  4.21141687e+02  1.27465172e+03  1.27465172e+03  1.27465172e+03
  1.91466761e+03  2.97660995e+03  2.97660995e+03  2.97660995e+03
  6.60562872e+03  6.60562872e+03  6.60562872e+03  8.27293337e+03
  2.46606549e+04  7.54569277e+04]
E1 = -727.4391871457821  E_coul = 201.90602629257236
Extra cycle  E= -525.53316085321  delta_E= 3.41e-13  |g|= 3.71e-08  |ddm|= 5.8e-08
    CPU time for scf_cycle      1.23 sec, wall time      0.33 sec
exp = [2.61825079e+04 7.61825034e+03 3.61824989e+03 1.61823698e+03
 2.39767408e+02 5.20235560e+01 4.61095226e+00 3.98469012e-01
 1.36279298e+03 6.65180324e+02 3.03318474e+02 3.16144547e+02
 4.93147253e+01 4.98511973e+00 1.46591077e+01 6.17178577e-01
 1.67489400e+00 1.92389332e-01]
grad_E = [-1.98687167e-06  2.18970276e-05  4.38290468e-05  6.72670537e-04
  4.72615814e-04 -3.73515246e-03  7.56046443e-03 -8.35562570e-03
  1.03691634e-06  1.77916598e-05  9.46008027e-05  8.33436513e-05
  8.72050652e-04 -6.82246737e-03 -7.33191459e-03  2.40710030e-02
 -7.64693655e-03 -1.61904634e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5079007        1
[INPUT] 0    0    [1    /1   ]  7618.25022785        1
[INPUT] 0    0    [1    /1   ]  3618.24967272        1
[INPUT] 0    0    [1    /1   ]  1618.23368903        1
[INPUT] 0    0    [1    /1   ]  239.764219301        1
[INPUT] 0    0    [1    /1   ]  52.0481067575        1
[INPUT] 0    0    [1    /1   ]  4.60404331417        1
[INPUT] 0    0    [1    /1   ]  0.398614216105       1
[INPUT] 1    0    [1    /1   ]  1362.79297147        1
[INPUT] 1    0    [1    /1   ]  665.180231844        1
[INPUT] 1    0    [1    /1   ]  303.317981889        1
[INPUT] 1    0    [1    /1   ]  316.14411302         1
[INPUT] 1    0    [1    /1   ]  49.3147513648        1
[INPUT] 1    0    [1    /1   ]  5.03767252871        1
[INPUT] 1    0    [1    /1   ]  14.6628251001        1
[INPUT] 1    0    [1    /1   ]  0.632298350377       1
[INPUT] 1    0    [1    /1   ]  1.76341403196        1
[INPUT] 1    0    [1    /1   ]  0.195219316155       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507900725166, 1.0]], [0, [7618.250227854502, 1.0]], [0, [3618.2496727174653, 1.0]], [0, [1618.233689029137, 1.0]], [0, [239.76421930094313, 1.0]], [0, [52.048106757473654, 1.0]], [0, [4.604043314172606, 1.0]], [0, [0.39861421610455017, 1.0]], [1, [1362.7929714655463, 1.0]], [1, [665.1802318435329, 1.0]], [1, [303.3179818894944, 1.0]], [1, [316.14411301968573, 1.0]], [1, [49.31475136476105, 1.0]], [1, [5.037672528710316, 1.0]], [1, [14.662825100059077, 1.0]], [1, [0.6322983503774637, 1.0]], [1, [1.7634140319584524, 1.0]], [1, [0.19521931615467425, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50790073]
bas 1, expnt(s) = [7618.25022785]
bas 2, expnt(s) = [3618.24967272]
bas 3, expnt(s) = [1618.23368903]
bas 4, expnt(s) = [239.7642193]
bas 5, expnt(s) = [52.04810676]
bas 6, expnt(s) = [4.60404331]
bas 7, expnt(s) = [0.39861422]
bas 8, expnt(s) = [1362.79297147]
bas 9, expnt(s) = [665.18023184]
bas 10, expnt(s) = [303.31798189]
bas 11, expnt(s) = [316.14411302]
bas 12, expnt(s) = [49.31475136]
bas 13, expnt(s) = [5.03767253]
bas 14, expnt(s) = [14.6628251]
bas 15, expnt(s) = [0.63229835]
bas 16, expnt(s) = [1.76341403]
bas 17, expnt(s) = [0.19521932]
CPU time:        79.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61825023e+03 2.06018608e+03
 3.61824967e+03 1.17866102e+03 1.61823369e+03 6.44608389e+02
 2.39764219e+02 1.53940646e+02 5.20481068e+01 4.89574430e+01
 4.60404331e+00 7.94089722e+00 3.98614216e-01 1.26744643e+00
 1.36279297e+03 2.41558180e+04 6.65180232e+02 9.85504383e+03
 3.03317982e+02 3.69281108e+03 3.16144113e+02 3.88902528e+03
 4.93147514e+01 3.81246137e+02 5.03767253e+00 2.20176928e+01
 1.46628251e+01 8.37059752e+01 6.32298350e-01 1.64489035e+00
 1.76341403e+00 5.92826021e+00 1.95219316e-01 3.78562749e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977165522282903
cond(S) = 84159.16585928811
E1 = -727.5400993310801  E_coul = 203.12328075915855
init E= -524.416818571922
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.560582380572659  LUMO = 0.808600734982807
  mo_energy =
[-1.17869976e+02 -1.20937461e+01 -9.44309246e+00 -9.44309246e+00
 -9.44309246e+00 -1.23002829e+00 -5.60582381e-01 -5.60582381e-01
 -5.60582381e-01  8.08600735e-01  8.08600735e-01  8.08600735e-01
  4.56780456e+00  4.56780456e+00  4.56780456e+00  2.05689960e+01
  2.05689960e+01  2.05689960e+01  9.01723128e+01  9.01723128e+01
  9.01723128e+01  1.83307833e+02  4.21744995e+02  4.21744995e+02
  4.21744995e+02  1.27524619e+03  1.27524619e+03  1.27524619e+03
  1.91510483e+03  2.97723701e+03  2.97723701e+03  2.97723701e+03
  6.60634189e+03  6.60634189e+03  6.60634189e+03  8.27349826e+03
  2.46613064e+04  7.54576656e+04]
E1 = -727.2502025592241  E_coul = 201.7166188402758
cycle= 1 E= -525.533583718948  delta_E= -1.12  |g|= 0.183  |ddm|= 0.289
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.453147
diis-c [-0.20534177  1.        ]
  HOMO = -0.577054278150448  LUMO = 0.802780689740425
  mo_energy =
[-1.18124602e+02 -1.21880233e+01 -9.53648286e+00 -9.53648286e+00
 -9.53648286e+00 -1.25537419e+00 -5.77054278e-01 -5.77054278e-01
 -5.77054278e-01  8.02780690e-01  8.02780690e-01  8.02780690e-01
  4.53022500e+00  4.53022500e+00  4.53022500e+00  2.04864705e+01
  2.04864705e+01  2.04864705e+01  9.00173589e+01  9.00173589e+01
  9.00173589e+01  1.83106157e+02  4.21503601e+02  4.21503601e+02
  4.21503601e+02  1.27495456e+03  1.27495456e+03  1.27495456e+03
  1.91469210e+03  2.97688387e+03  2.97688387e+03  2.97688387e+03
  6.60587303e+03  6.60587303e+03  6.60587303e+03  8.27294691e+03
  2.46606612e+04  7.54569290e+04]
E1 = -727.4778572968365  E_coul = 201.94406164368522
cycle= 2 E= -525.533795653151  delta_E= -0.000212  |g|= 0.0164  |ddm|= 0.0151
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0312839
diis-c [-7.65807804e-04  3.12498303e-02  9.68750170e-01]
  HOMO = -0.574124378440375  LUMO = 0.804423397592223
  mo_energy =
[-1.18092161e+02 -1.21719546e+01 -9.52017491e+00 -9.52017491e+00
 -9.52017491e+00 -1.25141209e+00 -5.74124378e-01 -5.74124378e-01
 -5.74124378e-01  8.04423398e-01  8.04423398e-01  8.04423398e-01
  4.53638079e+00  4.53638079e+00  4.53638079e+00  2.05003813e+01
  2.05003813e+01  2.05003813e+01  9.00414846e+01  9.00414846e+01
  9.00414846e+01  1.83137339e+02  4.21535641e+02  4.21535641e+02
  4.21535641e+02  1.27498882e+03  1.27498882e+03  1.27498882e+03
  1.91472779e+03  2.97691917e+03  2.97691917e+03  2.97691917e+03
  6.60590894e+03  6.60590894e+03  6.60590894e+03  8.27298305e+03
  2.46606973e+04  7.54569651e+04]
E1 = -727.4282649597571  E_coul = 201.89446188744515
cycle= 3 E= -525.533803072312  delta_E= -7.42e-06  |g|= 0.00238  |ddm|= 0.00412
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00469263
diis-c [-1.63013061e-07 -7.36515879e-04  1.25985222e-01  8.74751294e-01]
  HOMO = -0.57477313149017  LUMO = 0.804058851137191
  mo_energy =
[-1.18096751e+02 -1.21745867e+01 -9.52285525e+00 -9.52285525e+00
 -9.52285525e+00 -1.25225837e+00 -5.74773131e-01 -5.74773131e-01
 -5.74773131e-01  8.04058851e-01  8.04058851e-01  8.04058851e-01
  4.53515745e+00  4.53515745e+00  4.53515745e+00  2.04980385e+01
  2.04980385e+01  2.04980385e+01  9.00378808e+01  9.00378808e+01
  9.00378808e+01  1.83132948e+02  4.21531106e+02  4.21531106e+02
  4.21531106e+02  1.27498401e+03  1.27498401e+03  1.27498401e+03
  1.91472276e+03  2.97691422e+03  2.97691422e+03  2.97691422e+03
  6.60590385e+03  6.60590385e+03  6.60590385e+03  8.27297788e+03
  2.46606921e+04  7.54569598e+04]
E1 = -727.4359504496211  E_coul = 201.90214714720204
cycle= 4 E= -525.533803302419  delta_E= -2.3e-07  |g|= 4.8e-05  |ddm|= 0.000638
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=8.63976e-05
diis-c [-4.70854118e-10 -2.48437554e-05  3.89349471e-03  4.36659793e-02
  9.52465370e-01]
  HOMO = -0.574748573302184  LUMO = 0.804072025594933
  mo_energy =
[-1.18096644e+02 -1.21744986e+01 -9.52276605e+00 -9.52276605e+00
 -9.52276605e+00 -1.25222563e+00 -5.74748573e-01 -5.74748573e-01
 -5.74748573e-01  8.04072026e-01  8.04072026e-01  8.04072026e-01
  4.53520303e+00  4.53520303e+00  4.53520303e+00  2.04981176e+01
  2.04981176e+01  2.04981176e+01  9.00379788e+01  9.00379788e+01
  9.00379788e+01  1.83133054e+02  4.21531212e+02  4.21531212e+02
  4.21531212e+02  1.27498412e+03  1.27498412e+03  1.27498412e+03
  1.91472287e+03  2.97691432e+03  2.97691432e+03  2.97691432e+03
  6.60590395e+03  6.60590395e+03  6.60590395e+03  8.27297799e+03
  2.46606922e+04  7.54569599e+04]
E1 = -727.435703389973  E_coul = 201.90190008732839
cycle= 5 E= -525.533803302645  delta_E= -2.26e-10  |g|= 3.1e-06  |ddm|= 2.85e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.435703389973  E_coul = 201.90190008732839
  HOMO = -0.574750673171676  LUMO = 0.804070821179125
  mo_energy =
[-1.18096651e+02 -1.21745043e+01 -9.52277188e+00 -9.52277188e+00
 -9.52277188e+00 -1.25222826e+00 -5.74750673e-01 -5.74750673e-01
 -5.74750673e-01  8.04070821e-01  8.04070821e-01  8.04070821e-01
  4.53519951e+00  4.53519951e+00  4.53519951e+00  2.04981122e+01
  2.04981122e+01  2.04981122e+01  9.00379722e+01  9.00379722e+01
  9.00379722e+01  1.83133047e+02  4.21531204e+02  4.21531204e+02
  4.21531204e+02  1.27498411e+03  1.27498411e+03  1.27498411e+03
  1.91472286e+03  2.97691431e+03  2.97691431e+03  2.97691431e+03
  6.60590394e+03  6.60590394e+03  6.60590394e+03  8.27297798e+03
  2.46606922e+04  7.54569599e+04]
E1 = -727.4357179024446  E_coul = 201.90191459979854
Extra cycle  E= -525.533803302646  delta_E= -1.36e-12  |g|= 7.05e-07  |ddm|= 1.31e-06
    CPU time for scf_cycle      0.84 sec, wall time      0.21 sec
exp = [2.61825079e+04 7.61825023e+03 3.61824967e+03 1.61823369e+03
 2.39764219e+02 5.20481068e+01 4.60404331e+00 3.98614216e-01
 1.36279297e+03 6.65180232e+02 3.03317982e+02 3.16144113e+02
 4.93147514e+01 5.03767253e+00 1.46628251e+01 6.32298350e-01
 1.76341403e+00 1.95219316e-01]
E = -525.533803302646
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:54 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5079007        1
[INPUT] 0    0    [1    /1   ]  7618.25022785        1
[INPUT] 0    0    [1    /1   ]  3618.24967272        1
[INPUT] 0    0    [1    /1   ]  1618.23368903        1
[INPUT] 0    0    [1    /1   ]  239.764219301        1
[INPUT] 0    0    [1    /1   ]  52.0481067575        1
[INPUT] 0    0    [1    /1   ]  4.60404331417        1
[INPUT] 0    0    [1    /1   ]  0.398614216105       1
[INPUT] 1    0    [1    /1   ]  1362.79297147        1
[INPUT] 1    0    [1    /1   ]  665.180231844        1
[INPUT] 1    0    [1    /1   ]  303.317981889        1
[INPUT] 1    0    [1    /1   ]  316.14411302         1
[INPUT] 1    0    [1    /1   ]  49.3147513648        1
[INPUT] 1    0    [1    /1   ]  5.03767252871        1
[INPUT] 1    0    [1    /1   ]  14.6628251001        1
[INPUT] 1    0    [1    /1   ]  0.632298350377       1
[INPUT] 1    0    [1    /1   ]  1.76341403196        1
[INPUT] 1    0    [1    /1   ]  0.195219316155       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507900725166, 1.0]], [0, [7618.250227854502, 1.0]], [0, [3618.2496727174653, 1.0]], [0, [1618.233689029137, 1.0]], [0, [239.76421930094313, 1.0]], [0, [52.048106757473654, 1.0]], [0, [4.604043314172606, 1.0]], [0, [0.39861421610455017, 1.0]], [1, [1362.7929714655463, 1.0]], [1, [665.1802318435329, 1.0]], [1, [303.3179818894944, 1.0]], [1, [316.14411301968573, 1.0]], [1, [49.31475136476105, 1.0]], [1, [5.037672528710316, 1.0]], [1, [14.662825100059077, 1.0]], [1, [0.6322983503774637, 1.0]], [1, [1.7634140319584524, 1.0]], [1, [0.19521931615467425, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50790073]
bas 1, expnt(s) = [7618.25022785]
bas 2, expnt(s) = [3618.24967272]
bas 3, expnt(s) = [1618.23368903]
bas 4, expnt(s) = [239.7642193]
bas 5, expnt(s) = [52.04810676]
bas 6, expnt(s) = [4.60404331]
bas 7, expnt(s) = [0.39861422]
bas 8, expnt(s) = [1362.79297147]
bas 9, expnt(s) = [665.18023184]
bas 10, expnt(s) = [303.31798189]
bas 11, expnt(s) = [316.14411302]
bas 12, expnt(s) = [49.31475136]
bas 13, expnt(s) = [5.03767253]
bas 14, expnt(s) = [14.6628251]
bas 15, expnt(s) = [0.63229835]
bas 16, expnt(s) = [1.76341403]
bas 17, expnt(s) = [0.19521932]
CPU time:        80.63
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61825023e+03 2.06018608e+03
 3.61824967e+03 1.17866102e+03 1.61823369e+03 6.44608389e+02
 2.39764219e+02 1.53940646e+02 5.20481068e+01 4.89574430e+01
 4.60404331e+00 7.94089722e+00 3.98614216e-01 1.26744643e+00
 1.36279297e+03 2.41558180e+04 6.65180232e+02 9.85504383e+03
 3.03317982e+02 3.69281108e+03 3.16144113e+02 3.88902528e+03
 4.93147514e+01 3.81246137e+02 5.03767253e+00 2.20176928e+01
 1.46628251e+01 8.37059752e+01 6.32298350e-01 1.64489035e+00
 1.76341403e+00 5.92826021e+00 1.95219316e-01 3.78562749e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977165522282903
cond(S) = 84159.16585928811
E1 = -727.5400993310801  E_coul = 203.12328075915855
init E= -524.416818571922
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.560582380572659  LUMO = 0.808600734982807
  mo_energy =
[-1.17869976e+02 -1.20937461e+01 -9.44309246e+00 -9.44309246e+00
 -9.44309246e+00 -1.23002829e+00 -5.60582381e-01 -5.60582381e-01
 -5.60582381e-01  8.08600735e-01  8.08600735e-01  8.08600735e-01
  4.56780456e+00  4.56780456e+00  4.56780456e+00  2.05689960e+01
  2.05689960e+01  2.05689960e+01  9.01723128e+01  9.01723128e+01
  9.01723128e+01  1.83307833e+02  4.21744995e+02  4.21744995e+02
  4.21744995e+02  1.27524619e+03  1.27524619e+03  1.27524619e+03
  1.91510483e+03  2.97723701e+03  2.97723701e+03  2.97723701e+03
  6.60634189e+03  6.60634189e+03  6.60634189e+03  8.27349826e+03
  2.46613064e+04  7.54576656e+04]
E1 = -727.2502025592241  E_coul = 201.7166188402758
cycle= 1 E= -525.533583718948  delta_E= -1.12  |g|= 0.183  |ddm|= 0.289
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.453147
diis-c [-0.20534177  1.        ]
  HOMO = -0.577054278150448  LUMO = 0.802780689740425
  mo_energy =
[-1.18124602e+02 -1.21880233e+01 -9.53648286e+00 -9.53648286e+00
 -9.53648286e+00 -1.25537419e+00 -5.77054278e-01 -5.77054278e-01
 -5.77054278e-01  8.02780690e-01  8.02780690e-01  8.02780690e-01
  4.53022500e+00  4.53022500e+00  4.53022500e+00  2.04864705e+01
  2.04864705e+01  2.04864705e+01  9.00173589e+01  9.00173589e+01
  9.00173589e+01  1.83106157e+02  4.21503601e+02  4.21503601e+02
  4.21503601e+02  1.27495456e+03  1.27495456e+03  1.27495456e+03
  1.91469210e+03  2.97688387e+03  2.97688387e+03  2.97688387e+03
  6.60587303e+03  6.60587303e+03  6.60587303e+03  8.27294691e+03
  2.46606612e+04  7.54569290e+04]
E1 = -727.4778572968365  E_coul = 201.94406164368522
cycle= 2 E= -525.533795653151  delta_E= -0.000212  |g|= 0.0164  |ddm|= 0.0151
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0312839
diis-c [-7.65807804e-04  3.12498303e-02  9.68750170e-01]
  HOMO = -0.574124378440375  LUMO = 0.804423397592223
  mo_energy =
[-1.18092161e+02 -1.21719546e+01 -9.52017491e+00 -9.52017491e+00
 -9.52017491e+00 -1.25141209e+00 -5.74124378e-01 -5.74124378e-01
 -5.74124378e-01  8.04423398e-01  8.04423398e-01  8.04423398e-01
  4.53638079e+00  4.53638079e+00  4.53638079e+00  2.05003813e+01
  2.05003813e+01  2.05003813e+01  9.00414846e+01  9.00414846e+01
  9.00414846e+01  1.83137339e+02  4.21535641e+02  4.21535641e+02
  4.21535641e+02  1.27498882e+03  1.27498882e+03  1.27498882e+03
  1.91472779e+03  2.97691917e+03  2.97691917e+03  2.97691917e+03
  6.60590894e+03  6.60590894e+03  6.60590894e+03  8.27298305e+03
  2.46606973e+04  7.54569651e+04]
E1 = -727.4282649597571  E_coul = 201.89446188744515
cycle= 3 E= -525.533803072312  delta_E= -7.42e-06  |g|= 0.00238  |ddm|= 0.00412
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00469263
diis-c [-1.63013061e-07 -7.36515879e-04  1.25985222e-01  8.74751294e-01]
  HOMO = -0.57477313149017  LUMO = 0.804058851137191
  mo_energy =
[-1.18096751e+02 -1.21745867e+01 -9.52285525e+00 -9.52285525e+00
 -9.52285525e+00 -1.25225837e+00 -5.74773131e-01 -5.74773131e-01
 -5.74773131e-01  8.04058851e-01  8.04058851e-01  8.04058851e-01
  4.53515745e+00  4.53515745e+00  4.53515745e+00  2.04980385e+01
  2.04980385e+01  2.04980385e+01  9.00378808e+01  9.00378808e+01
  9.00378808e+01  1.83132948e+02  4.21531106e+02  4.21531106e+02
  4.21531106e+02  1.27498401e+03  1.27498401e+03  1.27498401e+03
  1.91472276e+03  2.97691422e+03  2.97691422e+03  2.97691422e+03
  6.60590385e+03  6.60590385e+03  6.60590385e+03  8.27297788e+03
  2.46606921e+04  7.54569598e+04]
E1 = -727.4359504496211  E_coul = 201.90214714720204
cycle= 4 E= -525.533803302419  delta_E= -2.3e-07  |g|= 4.8e-05  |ddm|= 0.000638
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=8.63976e-05
diis-c [-4.70854118e-10 -2.48437554e-05  3.89349471e-03  4.36659793e-02
  9.52465370e-01]
  HOMO = -0.574748573302184  LUMO = 0.804072025594933
  mo_energy =
[-1.18096644e+02 -1.21744986e+01 -9.52276605e+00 -9.52276605e+00
 -9.52276605e+00 -1.25222563e+00 -5.74748573e-01 -5.74748573e-01
 -5.74748573e-01  8.04072026e-01  8.04072026e-01  8.04072026e-01
  4.53520303e+00  4.53520303e+00  4.53520303e+00  2.04981176e+01
  2.04981176e+01  2.04981176e+01  9.00379788e+01  9.00379788e+01
  9.00379788e+01  1.83133054e+02  4.21531212e+02  4.21531212e+02
  4.21531212e+02  1.27498412e+03  1.27498412e+03  1.27498412e+03
  1.91472287e+03  2.97691432e+03  2.97691432e+03  2.97691432e+03
  6.60590395e+03  6.60590395e+03  6.60590395e+03  8.27297799e+03
  2.46606922e+04  7.54569599e+04]
E1 = -727.435703389973  E_coul = 201.90190008732839
cycle= 5 E= -525.533803302645  delta_E= -2.26e-10  |g|= 3.1e-06  |ddm|= 2.85e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.435703389973  E_coul = 201.90190008732839
  HOMO = -0.574750673171676  LUMO = 0.804070821179125
  mo_energy =
[-1.18096651e+02 -1.21745043e+01 -9.52277188e+00 -9.52277188e+00
 -9.52277188e+00 -1.25222826e+00 -5.74750673e-01 -5.74750673e-01
 -5.74750673e-01  8.04070821e-01  8.04070821e-01  8.04070821e-01
  4.53519951e+00  4.53519951e+00  4.53519951e+00  2.04981122e+01
  2.04981122e+01  2.04981122e+01  9.00379722e+01  9.00379722e+01
  9.00379722e+01  1.83133047e+02  4.21531204e+02  4.21531204e+02
  4.21531204e+02  1.27498411e+03  1.27498411e+03  1.27498411e+03
  1.91472286e+03  2.97691431e+03  2.97691431e+03  2.97691431e+03
  6.60590394e+03  6.60590394e+03  6.60590394e+03  8.27297798e+03
  2.46606922e+04  7.54569599e+04]
E1 = -727.4357179024446  E_coul = 201.90191459979854
Extra cycle  E= -525.533803302646  delta_E= -1.36e-12  |g|= 7.05e-07  |ddm|= 1.31e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.21 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 84159.16585928811
E1 = -727.4357179024446  E_coul = 201.90191459979854
init E= -525.533803302646
    CPU time for initialize scf      1.12 sec, wall time      0.18 sec
  HOMO = -0.574750411189568  LUMO = 0.804070962769122
  mo_energy =
[-1.18096650e+02 -1.21745033e+01 -9.52277077e+00 -9.52277077e+00
 -9.52277077e+00 -1.25222791e+00 -5.74750411e-01 -5.74750411e-01
 -5.74750411e-01  8.04070963e-01  8.04070963e-01  8.04070963e-01
  4.53520001e+00  4.53520001e+00  4.53520001e+00  2.04981132e+01
  2.04981132e+01  2.04981132e+01  9.00379736e+01  9.00379736e+01
  9.00379736e+01  1.83133048e+02  4.21531206e+02  4.21531206e+02
  4.21531206e+02  1.27498411e+03  1.27498411e+03  1.27498411e+03
  1.91472286e+03  2.97691432e+03  2.97691432e+03  2.97691432e+03
  6.60590395e+03  6.60590395e+03  6.60590395e+03  8.27297798e+03
  2.46606922e+04  7.54569599e+04]
E1 = -727.4357146838013  E_coul = 201.9019113811555
cycle= 1 E= -525.533803302646  delta_E= 2.27e-13  |g|= 1.63e-07  |ddm|= 3.31e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4357146838013  E_coul = 201.9019113811555
  HOMO = -0.574750473936748  LUMO = 0.804070927499049
  mo_energy =
[-1.18096650e+02 -1.21745035e+01 -9.52277101e+00 -9.52277101e+00
 -9.52277101e+00 -1.25222799e+00 -5.74750474e-01 -5.74750474e-01
 -5.74750474e-01  8.04070927e-01  8.04070927e-01  8.04070928e-01
  4.53519990e+00  4.53519990e+00  4.53519990e+00  2.04981130e+01
  2.04981130e+01  2.04981130e+01  9.00379733e+01  9.00379733e+01
  9.00379733e+01  1.83133048e+02  4.21531206e+02  4.21531206e+02
  4.21531206e+02  1.27498411e+03  1.27498411e+03  1.27498411e+03
  1.91472286e+03  2.97691432e+03  2.97691432e+03  2.97691432e+03
  6.60590395e+03  6.60590395e+03  6.60590395e+03  8.27297798e+03
  2.46606922e+04  7.54569599e+04]
E1 = -727.4357153560188  E_coul = 201.90191205337283
Extra cycle  E= -525.533803302646  delta_E= -2.27e-13  |g|= 3.54e-08  |ddm|= 5.66e-08
    CPU time for scf_cycle      1.21 sec, wall time      0.27 sec
exp = [2.61825079e+04 7.61825023e+03 3.61824967e+03 1.61823369e+03
 2.39764219e+02 5.20481068e+01 4.60404331e+00 3.98614216e-01
 1.36279297e+03 6.65180232e+02 3.03317982e+02 3.16144113e+02
 4.93147514e+01 5.03767253e+00 1.46628251e+01 6.32298350e-01
 1.76341403e+00 1.95219316e-01]
grad_E = [-1.98674090e-06  2.19295142e-05  4.39312111e-05  6.73906462e-04
  3.78773240e-04 -3.06768216e-03  9.90152426e-04 -5.43886470e-03
  1.00296947e-06  1.75381548e-05  9.30200210e-05  8.19557503e-05
  1.14782618e-03 -4.02873067e-03 -9.57076577e-03  2.20229042e-02
 -4.17107295e-03 -1.30039822e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5079121        1
[INPUT] 0    0    [1    /1   ]  7618.25010262        1
[INPUT] 0    0    [1    /1   ]  3618.24942227        1
[INPUT] 0    0    [1    /1   ]  1618.22984338        1
[INPUT] 0    0    [1    /1   ]  239.760951827        1
[INPUT] 0    0    [1    /1   ]  52.0735244567        1
[INPUT] 0    0    [1    /1   ]  4.60014450815        1
[INPUT] 0    0    [1    /1   ]  0.398840323907       1
[INPUT] 1    0    [1    /1   ]  1362.79296508        1
[INPUT] 1    0    [1    /1   ]  665.180126622        1
[INPUT] 1    0    [1    /1   ]  303.31741954         1
[INPUT] 1    0    [1    /1   ]  316.143617621        1
[INPUT] 1    0    [1    /1   ]  49.3128862276        1
[INPUT] 1    0    [1    /1   ]  5.08879117802        1
[INPUT] 1    0    [1    /1   ]  14.6816160176        1
[INPUT] 1    0    [1    /1   ]  0.635639832297       1
[INPUT] 1    0    [1    /1   ]  1.84083452216        1
[INPUT] 1    0    [1    /1   ]  0.195453070641       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507912105804, 1.0]], [0, [7618.2501026240825, 1.0]], [0, [3618.2494222656337, 1.0]], [0, [1618.2298433791302, 1.0]], [0, [239.7609518271948, 1.0]], [0, [52.07352445666432, 1.0]], [0, [4.60014450814731, 1.0]], [0, [0.39884032390692087, 1.0]], [1, [1362.7929650788283, 1.0]], [1, [665.1801266219278, 1.0]], [1, [303.317419539769, 1.0]], [1, [316.14361762123536, 1.0]], [1, [49.31288622762757, 1.0]], [1, [5.088791178020827, 1.0]], [1, [14.681616017579543, 1.0]], [1, [0.6356398322969374, 1.0]], [1, [1.840834522164632, 1.0]], [1, [0.19545307064050285, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50791211]
bas 1, expnt(s) = [7618.25010262]
bas 2, expnt(s) = [3618.24942227]
bas 3, expnt(s) = [1618.22984338]
bas 4, expnt(s) = [239.76095183]
bas 5, expnt(s) = [52.07352446]
bas 6, expnt(s) = [4.60014451]
bas 7, expnt(s) = [0.39884032]
bas 8, expnt(s) = [1362.79296508]
bas 9, expnt(s) = [665.18012662]
bas 10, expnt(s) = [303.31741954]
bas 11, expnt(s) = [316.14361762]
bas 12, expnt(s) = [49.31288623]
bas 13, expnt(s) = [5.08879118]
bas 14, expnt(s) = [14.68161602]
bas 15, expnt(s) = [0.63563983]
bas 16, expnt(s) = [1.84083452]
bas 17, expnt(s) = [0.19545307]
CPU time:        86.31
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61825010e+03 2.06018606e+03
 3.61824942e+03 1.17866096e+03 1.61822984e+03 6.44607240e+02
 2.39760952e+02 1.53939072e+02 5.20735245e+01 4.89753732e+01
 4.60014451e+00 7.93585329e+00 3.98840324e-01 1.26798559e+00
 1.36279297e+03 2.41558179e+04 6.65180127e+02 9.85504188e+03
 3.03317420e+02 3.69280252e+03 3.16143618e+02 3.88901766e+03
 4.93128862e+01 3.81228114e+02 5.08879118e+00 2.22973207e+01
 1.46816160e+01 8.38400868e+01 6.35639832e-01 1.65576338e+00
 1.84083452e+00 6.25536751e+00 1.95453071e-01 3.79129445e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977167671793993
cond(S) = 84265.83325107464
E1 = -727.5315838998633  E_coul = 203.12035344748324
init E= -524.41123045238
    CPU time for initialize scf      0.12 sec, wall time      0.03 sec
  HOMO = -0.560486142775393  LUMO = 0.81247029616303
  mo_energy =
[-1.17870300e+02 -1.20942582e+01 -9.44351657e+00 -9.44351657e+00
 -9.44351657e+00 -1.22994291e+00 -5.60486143e-01 -5.60486143e-01
 -5.60486143e-01  8.12470296e-01  8.12470296e-01  8.12470296e-01
  4.70250559e+00  4.70250559e+00  4.70250559e+00  2.09874981e+01
  2.09874981e+01  2.09874981e+01  9.06647489e+01  9.06647489e+01
  9.06647489e+01  1.83360393e+02  4.22124398e+02  4.22124398e+02
  4.22124398e+02  1.27557160e+03  1.27557160e+03  1.27557160e+03
  1.91517250e+03  2.97753513e+03  2.97753513e+03  2.97753513e+03
  6.60661157e+03  6.60661157e+03  6.60661157e+03  8.27355318e+03
  2.46613528e+04  7.54577059e+04]
E1 = -727.2480306055614  E_coul = 201.71390555488495
cycle= 1 E= -525.534125050676  delta_E= -1.12  |g|= 0.183  |ddm|= 0.265
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.454688
diis-c [-0.20674087  1.        ]
  HOMO = -0.576858567353522  LUMO = 0.806600987189078
  mo_energy =
[-1.18125072e+02 -1.21885210e+01 -9.53695326e+00 -9.53695326e+00
 -9.53695326e+00 -1.25520892e+00 -5.76858567e-01 -5.76858567e-01
 -5.76858567e-01  8.06600987e-01  8.06600987e-01  8.06600987e-01
  4.66397043e+00  4.66397043e+00  4.66397043e+00  2.09045904e+01
  2.09045904e+01  2.09045904e+01  9.05098777e+01  9.05098777e+01
  9.05098777e+01  1.83158800e+02  4.21883019e+02  4.21883019e+02
  4.21883019e+02  1.27528006e+03  1.27528006e+03  1.27528006e+03
  1.91476008e+03  2.97718220e+03  2.97718220e+03  2.97718220e+03
  6.60614300e+03  6.60614300e+03  6.60614300e+03  8.27300218e+03
  2.46607079e+04  7.54569696e+04]
E1 = -727.4768519560556  E_coul = 201.9425155795997
cycle= 2 E= -525.534336376456  delta_E= -0.000211  |g|= 0.0164  |ddm|= 0.0151
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0315636
diis-c [-7.76089560e-04  3.16601913e-02  9.68339809e-01]
  HOMO = -0.573886052647324  LUMO = 0.80829205444056
  mo_energy =
[-1.18092565e+02 -1.21723863e+01 -9.52057590e+00 -9.52057590e+00
 -9.52057590e+00 -1.25119752e+00 -5.73886053e-01 -5.73886053e-01
 -5.73886053e-01  8.08292054e-01  8.08292054e-01  8.08292054e-01
  4.67034425e+00  4.67034425e+00  4.67034425e+00  2.09186203e+01
  2.09186203e+01  2.09186203e+01  9.05340556e+01  9.05340556e+01
  9.05340556e+01  1.83190052e+02  4.21915121e+02  4.21915121e+02
  4.21915121e+02  1.27531438e+03  1.27531438e+03  1.27531438e+03
  1.91479584e+03  2.97721758e+03  2.97721758e+03  2.97721758e+03
  6.60617898e+03  6.60617898e+03  6.60617898e+03  8.27303840e+03
  2.46607442e+04  7.54570058e+04]
E1 = -727.4272552182775  E_coul = 201.8929114049469
cycle= 3 E= -525.534343813331  delta_E= -7.44e-06  |g|= 0.00238  |ddm|= 0.00413
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00472287
diis-c [-1.53576629e-07 -7.38426074e-04  1.25712496e-01  8.75025930e-01]
  HOMO = -0.574530127301613  LUMO = 0.807926381397049
  mo_energy =
[-1.18097144e+02 -1.21750112e+01 -9.52324934e+00 -9.52324934e+00
 -9.52324934e+00 -1.25203845e+00 -5.74530127e-01 -5.74530127e-01
 -5.74530127e-01  8.07926381e-01  8.07926381e-01  8.07926381e-01
  4.66910076e+00  4.66910076e+00  4.66910076e+00  2.09162770e+01
  2.09162770e+01  2.09162770e+01  9.05304622e+01  9.05304622e+01
  9.05304622e+01  1.83185671e+02  4.21910596e+02  4.21910596e+02
  4.21910596e+02  1.27530958e+03  1.27530958e+03  1.27530958e+03
  1.91479082e+03  2.97721264e+03  2.97721264e+03  2.97721264e+03
  6.60617390e+03  6.60617390e+03  6.60617390e+03  8.27303324e+03
  2.46607389e+04  7.54570005e+04]
E1 = -727.4349118267864  E_coul = 201.90056778505664
cycle= 4 E= -525.53434404173  delta_E= -2.28e-07  |g|= 4.69e-05  |ddm|= 0.000646
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=8.47716e-05
diis-c [-4.42595282e-10 -2.65501419e-05  4.14442097e-03  4.50281634e-02
  9.50853966e-01]
  HOMO = -0.574505525347557  LUMO = 0.807939811398587
  mo_energy =
[-1.18097040e+02 -1.21749244e+01 -9.52316158e+00 -9.52316158e+00
 -9.52316158e+00 -1.25200579e+00 -5.74505525e-01 -5.74505525e-01
 -5.74505525e-01  8.07939811e-01  8.07939811e-01  8.07939811e-01
  4.66914707e+00  4.66914707e+00  4.66914707e+00  2.09163552e+01
  2.09163552e+01  2.09163552e+01  9.05305585e+01  9.05305585e+01
  9.05305585e+01  1.83185775e+02  4.21910700e+02  4.21910700e+02
  4.21910700e+02  1.27530969e+03  1.27530969e+03  1.27530969e+03
  1.91479093e+03  2.97721274e+03  2.97721274e+03  2.97721274e+03
  6.60617401e+03  6.60617401e+03  6.60617401e+03  8.27303334e+03
  2.46607390e+04  7.54570006e+04]
E1 = -727.4346712477939  E_coul = 201.90032720585018
cycle= 5 E= -525.534344041944  delta_E= -2.14e-10  |g|= 2.89e-06  |ddm|= 2.73e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.4346712477939  E_coul = 201.90032720585018
  HOMO = -0.574507462499616  LUMO = 0.807938694710701
  mo_energy =
[-1.18097047e+02 -1.21749299e+01 -9.52316709e+00 -9.52316709e+00
 -9.52316709e+00 -1.25200822e+00 -5.74507462e-01 -5.74507462e-01
 -5.74507462e-01  8.07938695e-01  8.07938695e-01  8.07938695e-01
  4.66914374e+00  4.66914374e+00  4.66914374e+00  2.09163501e+01
  2.09163501e+01  2.09163501e+01  9.05305522e+01  9.05305522e+01
  9.05305522e+01  1.83185768e+02  4.21910693e+02  4.21910693e+02
  4.21910693e+02  1.27530968e+03  1.27530968e+03  1.27530968e+03
  1.91479092e+03  2.97721273e+03  2.97721273e+03  2.97721273e+03
  6.60617400e+03  6.60617400e+03  6.60617400e+03  8.27303333e+03
  2.46607390e+04  7.54570006e+04]
E1 = -727.434685074956  E_coul = 201.9003410330113
Extra cycle  E= -525.534344041945  delta_E= -1.02e-12  |g|= 6.71e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.24 sec, wall time      0.15 sec
exp = [2.61825079e+04 7.61825010e+03 3.61824942e+03 1.61822984e+03
 2.39760952e+02 5.20735245e+01 4.60014451e+00 3.98840324e-01
 1.36279297e+03 6.65180127e+02 3.03317420e+02 3.16143618e+02
 4.93128862e+01 5.08879118e+00 1.46816160e+01 6.35639832e-01
 1.84083452e+00 1.95453071e-01]
E = -525.5343440419447
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:22:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5079121        1
[INPUT] 0    0    [1    /1   ]  7618.25010262        1
[INPUT] 0    0    [1    /1   ]  3618.24942227        1
[INPUT] 0    0    [1    /1   ]  1618.22984338        1
[INPUT] 0    0    [1    /1   ]  239.760951827        1
[INPUT] 0    0    [1    /1   ]  52.0735244567        1
[INPUT] 0    0    [1    /1   ]  4.60014450815        1
[INPUT] 0    0    [1    /1   ]  0.398840323907       1
[INPUT] 1    0    [1    /1   ]  1362.79296508        1
[INPUT] 1    0    [1    /1   ]  665.180126622        1
[INPUT] 1    0    [1    /1   ]  303.31741954         1
[INPUT] 1    0    [1    /1   ]  316.143617621        1
[INPUT] 1    0    [1    /1   ]  49.3128862276        1
[INPUT] 1    0    [1    /1   ]  5.08879117802        1
[INPUT] 1    0    [1    /1   ]  14.6816160176        1
[INPUT] 1    0    [1    /1   ]  0.635639832297       1
[INPUT] 1    0    [1    /1   ]  1.84083452216        1
[INPUT] 1    0    [1    /1   ]  0.195453070641       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507912105804, 1.0]], [0, [7618.2501026240825, 1.0]], [0, [3618.2494222656337, 1.0]], [0, [1618.2298433791302, 1.0]], [0, [239.7609518271948, 1.0]], [0, [52.07352445666432, 1.0]], [0, [4.60014450814731, 1.0]], [0, [0.39884032390692087, 1.0]], [1, [1362.7929650788283, 1.0]], [1, [665.1801266219278, 1.0]], [1, [303.317419539769, 1.0]], [1, [316.14361762123536, 1.0]], [1, [49.31288622762757, 1.0]], [1, [5.088791178020827, 1.0]], [1, [14.681616017579543, 1.0]], [1, [0.6356398322969374, 1.0]], [1, [1.840834522164632, 1.0]], [1, [0.19545307064050285, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50791211]
bas 1, expnt(s) = [7618.25010262]
bas 2, expnt(s) = [3618.24942227]
bas 3, expnt(s) = [1618.22984338]
bas 4, expnt(s) = [239.76095183]
bas 5, expnt(s) = [52.07352446]
bas 6, expnt(s) = [4.60014451]
bas 7, expnt(s) = [0.39884032]
bas 8, expnt(s) = [1362.79296508]
bas 9, expnt(s) = [665.18012662]
bas 10, expnt(s) = [303.31741954]
bas 11, expnt(s) = [316.14361762]
bas 12, expnt(s) = [49.31288623]
bas 13, expnt(s) = [5.08879118]
bas 14, expnt(s) = [14.68161602]
bas 15, expnt(s) = [0.63563983]
bas 16, expnt(s) = [1.84083452]
bas 17, expnt(s) = [0.19545307]
CPU time:        86.61
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61825010e+03 2.06018606e+03
 3.61824942e+03 1.17866096e+03 1.61822984e+03 6.44607240e+02
 2.39760952e+02 1.53939072e+02 5.20735245e+01 4.89753732e+01
 4.60014451e+00 7.93585329e+00 3.98840324e-01 1.26798559e+00
 1.36279297e+03 2.41558179e+04 6.65180127e+02 9.85504188e+03
 3.03317420e+02 3.69280252e+03 3.16143618e+02 3.88901766e+03
 4.93128862e+01 3.81228114e+02 5.08879118e+00 2.22973207e+01
 1.46816160e+01 8.38400868e+01 6.35639832e-01 1.65576338e+00
 1.84083452e+00 6.25536751e+00 1.95453071e-01 3.79129445e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977167671793993
cond(S) = 84265.83325107464
E1 = -727.5315838998633  E_coul = 203.12035344748324
init E= -524.41123045238
    CPU time for initialize scf      0.12 sec, wall time      0.03 sec
  HOMO = -0.560486142775393  LUMO = 0.81247029616303
  mo_energy =
[-1.17870300e+02 -1.20942582e+01 -9.44351657e+00 -9.44351657e+00
 -9.44351657e+00 -1.22994291e+00 -5.60486143e-01 -5.60486143e-01
 -5.60486143e-01  8.12470296e-01  8.12470296e-01  8.12470296e-01
  4.70250559e+00  4.70250559e+00  4.70250559e+00  2.09874981e+01
  2.09874981e+01  2.09874981e+01  9.06647489e+01  9.06647489e+01
  9.06647489e+01  1.83360393e+02  4.22124398e+02  4.22124398e+02
  4.22124398e+02  1.27557160e+03  1.27557160e+03  1.27557160e+03
  1.91517250e+03  2.97753513e+03  2.97753513e+03  2.97753513e+03
  6.60661157e+03  6.60661157e+03  6.60661157e+03  8.27355318e+03
  2.46613528e+04  7.54577059e+04]
E1 = -727.2480306055614  E_coul = 201.71390555488495
cycle= 1 E= -525.534125050676  delta_E= -1.12  |g|= 0.183  |ddm|= 0.265
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.454688
diis-c [-0.20674087  1.        ]
  HOMO = -0.576858567353522  LUMO = 0.806600987189078
  mo_energy =
[-1.18125072e+02 -1.21885210e+01 -9.53695326e+00 -9.53695326e+00
 -9.53695326e+00 -1.25520892e+00 -5.76858567e-01 -5.76858567e-01
 -5.76858567e-01  8.06600987e-01  8.06600987e-01  8.06600987e-01
  4.66397043e+00  4.66397043e+00  4.66397043e+00  2.09045904e+01
  2.09045904e+01  2.09045904e+01  9.05098777e+01  9.05098777e+01
  9.05098777e+01  1.83158800e+02  4.21883019e+02  4.21883019e+02
  4.21883019e+02  1.27528006e+03  1.27528006e+03  1.27528006e+03
  1.91476008e+03  2.97718220e+03  2.97718220e+03  2.97718220e+03
  6.60614300e+03  6.60614300e+03  6.60614300e+03  8.27300218e+03
  2.46607079e+04  7.54569696e+04]
E1 = -727.4768519560556  E_coul = 201.9425155795997
cycle= 2 E= -525.534336376456  delta_E= -0.000211  |g|= 0.0164  |ddm|= 0.0151
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0315636
diis-c [-7.76089560e-04  3.16601913e-02  9.68339809e-01]
  HOMO = -0.573886052647324  LUMO = 0.80829205444056
  mo_energy =
[-1.18092565e+02 -1.21723863e+01 -9.52057590e+00 -9.52057590e+00
 -9.52057590e+00 -1.25119752e+00 -5.73886053e-01 -5.73886053e-01
 -5.73886053e-01  8.08292054e-01  8.08292054e-01  8.08292054e-01
  4.67034425e+00  4.67034425e+00  4.67034425e+00  2.09186203e+01
  2.09186203e+01  2.09186203e+01  9.05340556e+01  9.05340556e+01
  9.05340556e+01  1.83190052e+02  4.21915121e+02  4.21915121e+02
  4.21915121e+02  1.27531438e+03  1.27531438e+03  1.27531438e+03
  1.91479584e+03  2.97721758e+03  2.97721758e+03  2.97721758e+03
  6.60617898e+03  6.60617898e+03  6.60617898e+03  8.27303840e+03
  2.46607442e+04  7.54570058e+04]
E1 = -727.4272552182775  E_coul = 201.8929114049469
cycle= 3 E= -525.534343813331  delta_E= -7.44e-06  |g|= 0.00238  |ddm|= 0.00413
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00472287
diis-c [-1.53576629e-07 -7.38426074e-04  1.25712496e-01  8.75025930e-01]
  HOMO = -0.574530127301613  LUMO = 0.807926381397049
  mo_energy =
[-1.18097144e+02 -1.21750112e+01 -9.52324934e+00 -9.52324934e+00
 -9.52324934e+00 -1.25203845e+00 -5.74530127e-01 -5.74530127e-01
 -5.74530127e-01  8.07926381e-01  8.07926381e-01  8.07926381e-01
  4.66910076e+00  4.66910076e+00  4.66910076e+00  2.09162770e+01
  2.09162770e+01  2.09162770e+01  9.05304622e+01  9.05304622e+01
  9.05304622e+01  1.83185671e+02  4.21910596e+02  4.21910596e+02
  4.21910596e+02  1.27530958e+03  1.27530958e+03  1.27530958e+03
  1.91479082e+03  2.97721264e+03  2.97721264e+03  2.97721264e+03
  6.60617390e+03  6.60617390e+03  6.60617390e+03  8.27303324e+03
  2.46607389e+04  7.54570005e+04]
E1 = -727.4349118267864  E_coul = 201.90056778505664
cycle= 4 E= -525.53434404173  delta_E= -2.28e-07  |g|= 4.69e-05  |ddm|= 0.000646
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=8.47716e-05
diis-c [-4.42595282e-10 -2.65501419e-05  4.14442097e-03  4.50281634e-02
  9.50853966e-01]
  HOMO = -0.574505525347557  LUMO = 0.807939811398587
  mo_energy =
[-1.18097040e+02 -1.21749244e+01 -9.52316158e+00 -9.52316158e+00
 -9.52316158e+00 -1.25200579e+00 -5.74505525e-01 -5.74505525e-01
 -5.74505525e-01  8.07939811e-01  8.07939811e-01  8.07939811e-01
  4.66914707e+00  4.66914707e+00  4.66914707e+00  2.09163552e+01
  2.09163552e+01  2.09163552e+01  9.05305585e+01  9.05305585e+01
  9.05305585e+01  1.83185775e+02  4.21910700e+02  4.21910700e+02
  4.21910700e+02  1.27530969e+03  1.27530969e+03  1.27530969e+03
  1.91479093e+03  2.97721274e+03  2.97721274e+03  2.97721274e+03
  6.60617401e+03  6.60617401e+03  6.60617401e+03  8.27303334e+03
  2.46607390e+04  7.54570006e+04]
E1 = -727.4346712477939  E_coul = 201.90032720585018
cycle= 5 E= -525.534344041944  delta_E= -2.14e-10  |g|= 2.89e-06  |ddm|= 2.73e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.4346712477939  E_coul = 201.90032720585018
  HOMO = -0.574507462499616  LUMO = 0.807938694710701
  mo_energy =
[-1.18097047e+02 -1.21749299e+01 -9.52316709e+00 -9.52316709e+00
 -9.52316709e+00 -1.25200822e+00 -5.74507462e-01 -5.74507462e-01
 -5.74507462e-01  8.07938695e-01  8.07938695e-01  8.07938695e-01
  4.66914374e+00  4.66914374e+00  4.66914374e+00  2.09163501e+01
  2.09163501e+01  2.09163501e+01  9.05305522e+01  9.05305522e+01
  9.05305522e+01  1.83185768e+02  4.21910693e+02  4.21910693e+02
  4.21910693e+02  1.27530968e+03  1.27530968e+03  1.27530968e+03
  1.91479092e+03  2.97721273e+03  2.97721273e+03  2.97721273e+03
  6.60617400e+03  6.60617400e+03  6.60617400e+03  8.27303333e+03
  2.46607390e+04  7.54570006e+04]
E1 = -727.434685074956  E_coul = 201.9003410330113
Extra cycle  E= -525.534344041945  delta_E= -1.02e-12  |g|= 6.71e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.24 sec, wall time      0.15 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 84265.83325107464
E1 = -727.434685074956  E_coul = 201.9003410330113
init E= -525.534344041945
    CPU time for initialize scf      1.17 sec, wall time      0.18 sec
  HOMO = -0.57450721021751  LUMO = 0.807938833425051
  mo_energy =
[-1.18097045e+02 -1.21749288e+01 -9.52316603e+00 -9.52316603e+00
 -9.52316603e+00 -1.25200788e+00 -5.74507210e-01 -5.74507210e-01
 -5.74507210e-01  8.07938833e-01  8.07938833e-01  8.07938833e-01
  4.66914423e+00  4.66914423e+00  4.66914423e+00  2.09163511e+01
  2.09163511e+01  2.09163511e+01  9.05305535e+01  9.05305535e+01
  9.05305535e+01  1.83185769e+02  4.21910695e+02  4.21910695e+02
  4.21910695e+02  1.27530968e+03  1.27530968e+03  1.27530968e+03
  1.91479092e+03  2.97721273e+03  2.97721273e+03  2.97721273e+03
  6.60617400e+03  6.60617400e+03  6.60617400e+03  8.27303333e+03
  2.46607390e+04  7.54570006e+04]
E1 = -727.4346820369308  E_coul = 201.9003379949862
cycle= 1 E= -525.534344041945  delta_E= 1.14e-13  |g|= 1.54e-07  |ddm|= 3.08e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4346820369308  E_coul = 201.9003379949862
  HOMO = -0.57450726898317  LUMO = 0.807938800074034
  mo_energy =
[-1.18097045e+02 -1.21749291e+01 -9.52316626e+00 -9.52316626e+00
 -9.52316626e+00 -1.25200796e+00 -5.74507269e-01 -5.74507269e-01
 -5.74507269e-01  8.07938800e-01  8.07938800e-01  8.07938800e-01
  4.66914412e+00  4.66914412e+00  4.66914412e+00  2.09163509e+01
  2.09163509e+01  2.09163509e+01  9.05305532e+01  9.05305532e+01
  9.05305532e+01  1.83185769e+02  4.21910694e+02  4.21910694e+02
  4.21910694e+02  1.27530968e+03  1.27530968e+03  1.27530968e+03
  1.91479092e+03  2.97721273e+03  2.97721273e+03  2.97721273e+03
  6.60617400e+03  6.60617400e+03  6.60617400e+03  8.27303333e+03
  2.46607390e+04  7.54570006e+04]
E1 = -727.4346826719304  E_coul = 201.9003386299856
Extra cycle  E= -525.534344041945  delta_E= -2.27e-13  |g|= 3.35e-08  |ddm|= 5.44e-08
    CPU time for scf_cycle      1.26 sec, wall time      0.27 sec
exp = [2.61825079e+04 7.61825010e+03 3.61824942e+03 1.61822984e+03
 2.39760952e+02 5.20735245e+01 4.60014451e+00 3.98840324e-01
 1.36279297e+03 6.65180127e+02 3.03317420e+02 3.16143618e+02
 4.93128862e+01 5.08879118e+00 1.46816160e+01 6.35639832e-01
 1.84083452e+00 1.95453071e-01]
grad_E = [-1.98670357e-06  2.19637733e-05  4.40376376e-05  6.75203657e-04
  2.82215363e-04 -2.37970353e-03 -2.75927442e-03 -1.95122482e-03
  9.89897950e-07  1.74391376e-05  9.23928463e-05  8.14063751e-05
  1.28580696e-03 -1.61718618e-03 -1.10078627e-02  9.31967952e-03
 -6.38464129e-04  1.59502136e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5079262        1
[INPUT] 0    0    [1    /1   ]  7618.249947          1
[INPUT] 0    0    [1    /1   ]  3618.24911083        1
[INPUT] 0    0    [1    /1   ]  1618.22506309        1
[INPUT] 0    0    [1    /1   ]  239.757419684        1
[INPUT] 0    0    [1    /1   ]  52.1013382119        1
[INPUT] 0    0    [1    /1   ]  4.59952706269        1
[INPUT] 0    0    [1    /1   ]  0.399118170538       1
[INPUT] 1    0    [1    /1   ]  1362.79295738        1
[INPUT] 1    0    [1    /1   ]  665.179997748        1
[INPUT] 1    0    [1    /1   ]  303.316732282        1
[INPUT] 1    0    [1    /1   ]  316.143012162        1
[INPUT] 1    0    [1    /1   ]  49.3088039726        1
[INPUT] 1    0    [1    /1   ]  5.13996818433        1
[INPUT] 1    0    [1    /1   ]  14.719107371         1
[INPUT] 1    0    [1    /1   ]  0.630903844112       1
[INPUT] 1    0    [1    /1   ]  1.91086957462        1
[INPUT] 1    0    [1    /1   ]  0.193009714191       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507926231567, 1.0]], [0, [7618.2499470009125, 1.0]], [0, [3618.2491108279683, 1.0]], [0, [1618.225063090405, 1.0]], [0, [239.75741968419723, 1.0]], [0, [52.10133821189437, 1.0]], [0, [4.599527062686131, 1.0]], [0, [0.3991181705376876, 1.0]], [1, [1362.7929573843082, 1.0]], [1, [665.1799977482773, 1.0]], [1, [303.31673228188004, 1.0]], [1, [316.14301216197214, 1.0]], [1, [49.30880397256925, 1.0]], [1, [5.13996818433067, 1.0]], [1, [14.719107371002677, 1.0]], [1, [0.6309038441122153, 1.0]], [1, [1.9108695746169773, 1.0]], [1, [0.193009714190632, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50792623]
bas 1, expnt(s) = [7618.249947]
bas 2, expnt(s) = [3618.24911083]
bas 3, expnt(s) = [1618.22506309]
bas 4, expnt(s) = [239.75741968]
bas 5, expnt(s) = [52.10133821]
bas 6, expnt(s) = [4.59952706]
bas 7, expnt(s) = [0.39911817]
bas 8, expnt(s) = [1362.79295738]
bas 9, expnt(s) = [665.17999775]
bas 10, expnt(s) = [303.31673228]
bas 11, expnt(s) = [316.14301216]
bas 12, expnt(s) = [49.30880397]
bas 13, expnt(s) = [5.13996818]
bas 14, expnt(s) = [14.71910737]
bas 15, expnt(s) = [0.63090384]
bas 16, expnt(s) = [1.91086957]
bas 17, expnt(s) = [0.19300971]
CPU time:        91.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61824995e+03 2.06018603e+03
 3.61824911e+03 1.17866089e+03 1.61822506e+03 6.44605812e+02
 2.39757420e+02 1.53937371e+02 5.21013382e+01 4.89949911e+01
 4.59952706e+00 7.93505439e+00 3.99118171e-01 1.26864803e+00
 1.36279296e+03 2.41558177e+04 6.65179998e+02 9.85503950e+03
 3.03316732e+02 3.69279206e+03 3.16143012e+02 3.88900835e+03
 4.93088040e+01 3.81188665e+02 5.13996818e+00 2.25779720e+01
 1.47191074e+01 8.41077924e+01 6.30903844e-01 1.64035694e+00
 1.91086957e+00 6.55425297e+00 1.93009714e-01 3.73214366e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977286244604663
cond(S) = 84371.29857268385
E1 = -727.5317462832139  E_coul = 203.1237001948182
init E= -524.408046088396
    CPU time for initialize scf      0.16 sec, wall time      0.05 sec
  HOMO = -0.560374706451052  LUMO = 0.800914558546762
  mo_energy =
[-1.17869736e+02 -1.20942573e+01 -9.44334573e+00 -9.44334573e+00
 -9.44334573e+00 -1.22991353e+00 -5.60374706e-01 -5.60374706e-01
 -5.60374706e-01  8.00914559e-01  8.00914559e-01  8.00914559e-01
  4.78636730e+00  4.78636730e+00  4.78636730e+00  2.13497190e+01
  2.13497190e+01  2.13497190e+01  9.11569513e+01  9.11569513e+01
  9.11569513e+01  1.83434054e+02  4.22522831e+02  4.22522831e+02
  4.22522831e+02  1.27591509e+03  1.27591509e+03  1.27591509e+03
  1.91525806e+03  2.97784995e+03  2.97784995e+03  2.97784995e+03
  6.60689636e+03  6.60689636e+03  6.60689636e+03  8.27362260e+03
  2.46614115e+04  7.54577570e+04]
E1 = -727.2373391985834  E_coul = 201.70276113905695
cycle= 1 E= -525.534578059526  delta_E= -1.13  |g|= 0.184  |ddm|= 0.268
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.455688
diis-c [-0.20765133  1.        ]
  HOMO = -0.577103670768039  LUMO = 0.794938584213111
  mo_energy =
[-1.18125435e+02 -1.21897389e+01 -9.53795303e+00 -9.53795303e+00
 -9.53795303e+00 -1.25569377e+00 -5.77103671e-01 -5.77103671e-01
 -5.77103671e-01  7.94938584e-01  7.94938584e-01  7.94938584e-01
  4.74629674e+00  4.74629674e+00  4.74629674e+00  2.12653477e+01
  2.12653477e+01  2.12653477e+01  9.10011342e+01  9.10011342e+01
  9.10011342e+01  1.83231509e+02  4.22280663e+02  4.22280663e+02
  4.22280663e+02  1.27562299e+03  1.27562299e+03  1.27562299e+03
  1.91484559e+03  2.97749677e+03  2.97749677e+03  2.97749677e+03
  6.60642781e+03  6.60642781e+03  6.60642781e+03  8.27307178e+03
  2.46607670e+04  7.54570211e+04]
E1 = -727.4697582449858  E_coul = 201.93496768135938
cycle= 2 E= -525.534790563626  delta_E= -0.000213  |g|= 0.0165  |ddm|= 0.0155
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0319513
diis-c [-7.92518280e-04  3.21577895e-02  9.67842210e-01]
  HOMO = -0.574031948303447  LUMO = 0.796677676478795
  mo_energy =
[-1.18092652e+02 -1.21733605e+01 -9.52132813e+00 -9.52132813e+00
 -9.52132813e+00 -1.25155716e+00 -5.74031948e-01 -5.74031948e-01
 -5.74031948e-01  7.96677676e-01  7.96677676e-01  7.96677676e-01
  4.75296601e+00  4.75296601e+00  4.75296601e+00  2.12796681e+01
  2.12796681e+01  2.12796681e+01  9.10255627e+01  9.10255627e+01
  9.10255627e+01  1.83263033e+02  4.22313034e+02  4.22313034e+02
  4.22313034e+02  1.27565758e+03  1.27565758e+03  1.27565758e+03
  1.91488165e+03  2.97753243e+03  2.97753243e+03  2.97753243e+03
  6.60646408e+03  6.60646408e+03  6.60646408e+03  8.27310829e+03
  2.46608035e+04  7.54570576e+04]
E1 = -727.4195520254694  E_coul = 201.8847538664615
cycle= 3 E= -525.534798159008  delta_E= -7.6e-06  |g|= 0.00239  |ddm|= 0.0042
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00478659
diis-c [-1.45201223e-07 -7.40703710e-04  1.25888353e-01  8.74852351e-01]
  HOMO = -0.574681177500713  LUMO = 0.796311680856403
  mo_energy =
[-1.18097264e+02 -1.21760079e+01 -9.52402449e+00 -9.52402449e+00
 -9.52402449e+00 -1.25240553e+00 -5.74681178e-01 -5.74681178e-01
 -5.74681178e-01  7.96311681e-01  7.96311681e-01  7.96311681e-01
  4.75168993e+00  4.75168993e+00  4.75168993e+00  2.12772962e+01
  2.12772962e+01  2.12772962e+01  9.10219434e+01  9.10219434e+01
  9.10219434e+01  1.83258621e+02  4.22308478e+02  4.22308478e+02
  4.22308478e+02  1.27565276e+03  1.27565276e+03  1.27565276e+03
  1.91487659e+03  2.97752745e+03  2.97752745e+03  2.97752745e+03
  6.60645897e+03  6.60645897e+03  6.60645897e+03  8.27310310e+03
  2.46607983e+04  7.54570523e+04]
E1 = -727.4272761031848  E_coul = 201.89247771220934
cycle= 4 E= -525.534798390975  delta_E= -2.32e-07  |g|= 4.58e-05  |ddm|= 0.000661
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.30461e-05
diis-c [-4.19574229e-10 -2.75277579e-05  4.30574436e-03  4.55490286e-02
  9.50172755e-01]
  HOMO = -0.574656684309903  LUMO = 0.796325022769117
  mo_energy =
[-1.18097161e+02 -1.21759227e+01 -9.52393835e+00 -9.52393835e+00
 -9.52393835e+00 -1.25237311e+00 -5.74656684e-01 -5.74656684e-01
 -5.74656684e-01  7.96325023e-01  7.96325023e-01  7.96325023e-01
  4.75173654e+00  4.75173654e+00  4.75173654e+00  2.12773732e+01
  2.12773732e+01  2.12773732e+01  9.10220378e+01  9.10220378e+01
  9.10220378e+01  1.83258723e+02  4.22308580e+02  4.22308580e+02
  4.22308580e+02  1.27565286e+03  1.27565286e+03  1.27565286e+03
  1.91487669e+03  2.97752755e+03  2.97752755e+03  2.97752755e+03
  6.60645907e+03  6.60645907e+03  6.60645907e+03  8.27310320e+03
  2.46607984e+04  7.54570524e+04]
E1 = -727.4270410862663  E_coul = 201.8922426950882
cycle= 5 E= -525.534798391178  delta_E= -2.03e-10  |g|= 2.75e-06  |ddm|= 2.64e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4270410862663  E_coul = 201.8922426950882
  HOMO = -0.574658509681209  LUMO = 0.79632398143246
  mo_energy =
[-1.18097168e+02 -1.21759279e+01 -9.52394363e+00 -9.52394363e+00
 -9.52394363e+00 -1.25237540e+00 -5.74658510e-01 -5.74658510e-01
 -5.74658510e-01  7.96323981e-01  7.96323981e-01  7.96323981e-01
  4.75173334e+00  4.75173334e+00  4.75173334e+00  2.12773684e+01
  2.12773684e+01  2.12773684e+01  9.10220318e+01  9.10220318e+01
  9.10220318e+01  1.83258716e+02  4.22308573e+02  4.22308573e+02
  4.22308573e+02  1.27565285e+03  1.27565285e+03  1.27565285e+03
  1.91487669e+03  2.97752755e+03  2.97752755e+03  2.97752755e+03
  6.60645906e+03  6.60645906e+03  6.60645906e+03  8.27310319e+03
  2.46607983e+04  7.54570524e+04]
E1 = -727.4270544342064  E_coul = 201.89225604302877
Extra cycle  E= -525.534798391178  delta_E= 4.55e-13  |g|= 6.46e-07  |ddm|= 1.18e-06
    CPU time for scf_cycle      0.35 sec, wall time      0.24 sec
exp = [2.61825079e+04 7.61824995e+03 3.61824911e+03 1.61822506e+03
 2.39757420e+02 5.21013382e+01 4.59952706e+00 3.99118171e-01
 1.36279296e+03 6.65179998e+02 3.03316732e+02 3.16143012e+02
 4.93088040e+01 5.13996818e+00 1.47191074e+01 6.30903844e-01
 1.91086957e+00 1.93009714e-01]
E = -525.5347983911777
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5079262        1
[INPUT] 0    0    [1    /1   ]  7618.249947          1
[INPUT] 0    0    [1    /1   ]  3618.24911083        1
[INPUT] 0    0    [1    /1   ]  1618.22506309        1
[INPUT] 0    0    [1    /1   ]  239.757419684        1
[INPUT] 0    0    [1    /1   ]  52.1013382119        1
[INPUT] 0    0    [1    /1   ]  4.59952706269        1
[INPUT] 0    0    [1    /1   ]  0.399118170538       1
[INPUT] 1    0    [1    /1   ]  1362.79295738        1
[INPUT] 1    0    [1    /1   ]  665.179997748        1
[INPUT] 1    0    [1    /1   ]  303.316732282        1
[INPUT] 1    0    [1    /1   ]  316.143012162        1
[INPUT] 1    0    [1    /1   ]  49.3088039726        1
[INPUT] 1    0    [1    /1   ]  5.13996818433        1
[INPUT] 1    0    [1    /1   ]  14.719107371         1
[INPUT] 1    0    [1    /1   ]  0.630903844112       1
[INPUT] 1    0    [1    /1   ]  1.91086957462        1
[INPUT] 1    0    [1    /1   ]  0.193009714191       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.507926231567, 1.0]], [0, [7618.2499470009125, 1.0]], [0, [3618.2491108279683, 1.0]], [0, [1618.225063090405, 1.0]], [0, [239.75741968419723, 1.0]], [0, [52.10133821189437, 1.0]], [0, [4.599527062686131, 1.0]], [0, [0.3991181705376876, 1.0]], [1, [1362.7929573843082, 1.0]], [1, [665.1799977482773, 1.0]], [1, [303.31673228188004, 1.0]], [1, [316.14301216197214, 1.0]], [1, [49.30880397256925, 1.0]], [1, [5.13996818433067, 1.0]], [1, [14.719107371002677, 1.0]], [1, [0.6309038441122153, 1.0]], [1, [1.9108695746169773, 1.0]], [1, [0.193009714190632, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50792623]
bas 1, expnt(s) = [7618.249947]
bas 2, expnt(s) = [3618.24911083]
bas 3, expnt(s) = [1618.22506309]
bas 4, expnt(s) = [239.75741968]
bas 5, expnt(s) = [52.10133821]
bas 6, expnt(s) = [4.59952706]
bas 7, expnt(s) = [0.39911817]
bas 8, expnt(s) = [1362.79295738]
bas 9, expnt(s) = [665.17999775]
bas 10, expnt(s) = [303.31673228]
bas 11, expnt(s) = [316.14301216]
bas 12, expnt(s) = [49.30880397]
bas 13, expnt(s) = [5.13996818]
bas 14, expnt(s) = [14.71910737]
bas 15, expnt(s) = [0.63090384]
bas 16, expnt(s) = [1.91086957]
bas 17, expnt(s) = [0.19300971]
CPU time:        92.47
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61824995e+03 2.06018603e+03
 3.61824911e+03 1.17866089e+03 1.61822506e+03 6.44605812e+02
 2.39757420e+02 1.53937371e+02 5.21013382e+01 4.89949911e+01
 4.59952706e+00 7.93505439e+00 3.99118171e-01 1.26864803e+00
 1.36279296e+03 2.41558177e+04 6.65179998e+02 9.85503950e+03
 3.03316732e+02 3.69279206e+03 3.16143012e+02 3.88900835e+03
 4.93088040e+01 3.81188665e+02 5.13996818e+00 2.25779720e+01
 1.47191074e+01 8.41077924e+01 6.30903844e-01 1.64035694e+00
 1.91086957e+00 6.55425297e+00 1.93009714e-01 3.73214366e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977286244604663
cond(S) = 84371.29857268385
E1 = -727.5317462832139  E_coul = 203.1237001948182
init E= -524.408046088396
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.560374706451052  LUMO = 0.800914558546762
  mo_energy =
[-1.17869736e+02 -1.20942573e+01 -9.44334573e+00 -9.44334573e+00
 -9.44334573e+00 -1.22991353e+00 -5.60374706e-01 -5.60374706e-01
 -5.60374706e-01  8.00914559e-01  8.00914559e-01  8.00914559e-01
  4.78636730e+00  4.78636730e+00  4.78636730e+00  2.13497190e+01
  2.13497190e+01  2.13497190e+01  9.11569513e+01  9.11569513e+01
  9.11569513e+01  1.83434054e+02  4.22522831e+02  4.22522831e+02
  4.22522831e+02  1.27591509e+03  1.27591509e+03  1.27591509e+03
  1.91525806e+03  2.97784995e+03  2.97784995e+03  2.97784995e+03
  6.60689636e+03  6.60689636e+03  6.60689636e+03  8.27362260e+03
  2.46614115e+04  7.54577570e+04]
E1 = -727.2373391985834  E_coul = 201.70276113905695
cycle= 1 E= -525.534578059526  delta_E= -1.13  |g|= 0.184  |ddm|= 0.268
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.455688
diis-c [-0.20765133  1.        ]
  HOMO = -0.577103670768039  LUMO = 0.794938584213111
  mo_energy =
[-1.18125435e+02 -1.21897389e+01 -9.53795303e+00 -9.53795303e+00
 -9.53795303e+00 -1.25569377e+00 -5.77103671e-01 -5.77103671e-01
 -5.77103671e-01  7.94938584e-01  7.94938584e-01  7.94938584e-01
  4.74629674e+00  4.74629674e+00  4.74629674e+00  2.12653477e+01
  2.12653477e+01  2.12653477e+01  9.10011342e+01  9.10011342e+01
  9.10011342e+01  1.83231509e+02  4.22280663e+02  4.22280663e+02
  4.22280663e+02  1.27562299e+03  1.27562299e+03  1.27562299e+03
  1.91484559e+03  2.97749677e+03  2.97749677e+03  2.97749677e+03
  6.60642781e+03  6.60642781e+03  6.60642781e+03  8.27307178e+03
  2.46607670e+04  7.54570211e+04]
E1 = -727.4697582449858  E_coul = 201.93496768135938
cycle= 2 E= -525.534790563626  delta_E= -0.000213  |g|= 0.0165  |ddm|= 0.0155
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0319513
diis-c [-7.92518280e-04  3.21577895e-02  9.67842210e-01]
  HOMO = -0.574031948303447  LUMO = 0.796677676478795
  mo_energy =
[-1.18092652e+02 -1.21733605e+01 -9.52132813e+00 -9.52132813e+00
 -9.52132813e+00 -1.25155716e+00 -5.74031948e-01 -5.74031948e-01
 -5.74031948e-01  7.96677676e-01  7.96677676e-01  7.96677676e-01
  4.75296601e+00  4.75296601e+00  4.75296601e+00  2.12796681e+01
  2.12796681e+01  2.12796681e+01  9.10255627e+01  9.10255627e+01
  9.10255627e+01  1.83263033e+02  4.22313034e+02  4.22313034e+02
  4.22313034e+02  1.27565758e+03  1.27565758e+03  1.27565758e+03
  1.91488165e+03  2.97753243e+03  2.97753243e+03  2.97753243e+03
  6.60646408e+03  6.60646408e+03  6.60646408e+03  8.27310829e+03
  2.46608035e+04  7.54570576e+04]
E1 = -727.4195520254694  E_coul = 201.8847538664615
cycle= 3 E= -525.534798159008  delta_E= -7.6e-06  |g|= 0.00239  |ddm|= 0.0042
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00478659
diis-c [-1.45201223e-07 -7.40703710e-04  1.25888353e-01  8.74852351e-01]
  HOMO = -0.574681177500713  LUMO = 0.796311680856403
  mo_energy =
[-1.18097264e+02 -1.21760079e+01 -9.52402449e+00 -9.52402449e+00
 -9.52402449e+00 -1.25240553e+00 -5.74681178e-01 -5.74681178e-01
 -5.74681178e-01  7.96311681e-01  7.96311681e-01  7.96311681e-01
  4.75168993e+00  4.75168993e+00  4.75168993e+00  2.12772962e+01
  2.12772962e+01  2.12772962e+01  9.10219434e+01  9.10219434e+01
  9.10219434e+01  1.83258621e+02  4.22308478e+02  4.22308478e+02
  4.22308478e+02  1.27565276e+03  1.27565276e+03  1.27565276e+03
  1.91487659e+03  2.97752745e+03  2.97752745e+03  2.97752745e+03
  6.60645897e+03  6.60645897e+03  6.60645897e+03  8.27310310e+03
  2.46607983e+04  7.54570523e+04]
E1 = -727.4272761031848  E_coul = 201.89247771220934
cycle= 4 E= -525.534798390975  delta_E= -2.32e-07  |g|= 4.58e-05  |ddm|= 0.000661
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.30461e-05
diis-c [-4.19574229e-10 -2.75277579e-05  4.30574436e-03  4.55490286e-02
  9.50172755e-01]
  HOMO = -0.574656684309903  LUMO = 0.796325022769117
  mo_energy =
[-1.18097161e+02 -1.21759227e+01 -9.52393835e+00 -9.52393835e+00
 -9.52393835e+00 -1.25237311e+00 -5.74656684e-01 -5.74656684e-01
 -5.74656684e-01  7.96325023e-01  7.96325023e-01  7.96325023e-01
  4.75173654e+00  4.75173654e+00  4.75173654e+00  2.12773732e+01
  2.12773732e+01  2.12773732e+01  9.10220378e+01  9.10220378e+01
  9.10220378e+01  1.83258723e+02  4.22308580e+02  4.22308580e+02
  4.22308580e+02  1.27565286e+03  1.27565286e+03  1.27565286e+03
  1.91487669e+03  2.97752755e+03  2.97752755e+03  2.97752755e+03
  6.60645907e+03  6.60645907e+03  6.60645907e+03  8.27310320e+03
  2.46607984e+04  7.54570524e+04]
E1 = -727.4270410862663  E_coul = 201.8922426950882
cycle= 5 E= -525.534798391178  delta_E= -2.03e-10  |g|= 2.75e-06  |ddm|= 2.64e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4270410862663  E_coul = 201.8922426950882
  HOMO = -0.574658509681209  LUMO = 0.79632398143246
  mo_energy =
[-1.18097168e+02 -1.21759279e+01 -9.52394363e+00 -9.52394363e+00
 -9.52394363e+00 -1.25237540e+00 -5.74658510e-01 -5.74658510e-01
 -5.74658510e-01  7.96323981e-01  7.96323981e-01  7.96323981e-01
  4.75173334e+00  4.75173334e+00  4.75173334e+00  2.12773684e+01
  2.12773684e+01  2.12773684e+01  9.10220318e+01  9.10220318e+01
  9.10220318e+01  1.83258716e+02  4.22308573e+02  4.22308573e+02
  4.22308573e+02  1.27565285e+03  1.27565285e+03  1.27565285e+03
  1.91487669e+03  2.97752755e+03  2.97752755e+03  2.97752755e+03
  6.60645906e+03  6.60645906e+03  6.60645906e+03  8.27310319e+03
  2.46607983e+04  7.54570524e+04]
E1 = -727.4270544342064  E_coul = 201.89225604302877
Extra cycle  E= -525.534798391178  delta_E= 4.55e-13  |g|= 6.46e-07  |ddm|= 1.18e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.24 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 84371.29857268385
E1 = -727.4270544342064  E_coul = 201.89225604302877
init E= -525.534798391178
    CPU time for initialize scf      0.95 sec, wall time      0.18 sec
  HOMO = -0.574658263879362  LUMO = 0.79632411625534
  mo_energy =
[-1.18097167e+02 -1.21759269e+01 -9.52394261e+00 -9.52394261e+00
 -9.52394261e+00 -1.25237508e+00 -5.74658264e-01 -5.74658264e-01
 -5.74658264e-01  7.96324116e-01  7.96324116e-01  7.96324116e-01
  4.75173382e+00  4.75173382e+00  4.75173382e+00  2.12773693e+01
  2.12773693e+01  2.12773693e+01  9.10220331e+01  9.10220331e+01
  9.10220331e+01  1.83258718e+02  4.22308575e+02  4.22308575e+02
  4.22308575e+02  1.27565286e+03  1.27565286e+03  1.27565286e+03
  1.91487669e+03  2.97752755e+03  2.97752755e+03  2.97752755e+03
  6.60645906e+03  6.60645906e+03  6.60645906e+03  8.27310319e+03
  2.46607983e+04  7.54570524e+04]
E1 = -727.427051515414  E_coul = 201.8922531242363
cycle= 1 E= -525.534798391178  delta_E=    0  |g|= 1.48e-07  |ddm|= 2.93e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.427051515414  E_coul = 201.8922531242363
  HOMO = -0.574658320131348  LUMO = 0.796324084561814
  mo_energy =
[-1.18097167e+02 -1.21759272e+01 -9.52394283e+00 -9.52394283e+00
 -9.52394283e+00 -1.25237515e+00 -5.74658320e-01 -5.74658320e-01
 -5.74658320e-01  7.96324085e-01  7.96324085e-01  7.96324085e-01
  4.75173372e+00  4.75173372e+00  4.75173372e+00  2.12773691e+01
  2.12773691e+01  2.12773691e+01  9.10220328e+01  9.10220328e+01
  9.10220328e+01  1.83258717e+02  4.22308574e+02  4.22308574e+02
  4.22308574e+02  1.27565285e+03  1.27565285e+03  1.27565285e+03
  1.91487669e+03  2.97752755e+03  2.97752755e+03  2.97752755e+03
  6.60645906e+03  6.60645906e+03  6.60645906e+03  8.27310319e+03
  2.46607983e+04  7.54570524e+04]
E1 = -727.4270521264652  E_coul = 201.8922537352866
Extra cycle  E= -525.534798391179  delta_E= -9.09e-13  |g|= 3.22e-08  |ddm|= 5.32e-08
    CPU time for scf_cycle      1.33 sec, wall time      0.57 sec
exp = [2.61825079e+04 7.61824995e+03 3.61824911e+03 1.61822506e+03
 2.39757420e+02 5.21013382e+01 4.59952706e+00 3.99118171e-01
 1.36279296e+03 6.65179998e+02 3.03316732e+02 3.16143012e+02
 4.93088040e+01 5.13996818e+00 1.47191074e+01 6.30903844e-01
 1.91086957e+00 1.93009714e-01]
grad_E = [-1.98677162e-06  2.20019437e-05  4.41547797e-05  6.76642367e-04
  1.77237994e-04 -1.63057464e-03 -3.43458834e-03  9.78289006e-04
  1.00135990e-06  1.75223133e-05  9.28907768e-05  8.18460838e-05
  1.25927741e-03 -1.83866315e-04 -1.14822072e-02 -8.34410028e-03
  3.25199901e-03  8.61748680e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5079384        1
[INPUT] 0    0    [1    /1   ]  7618.2498124         1
[INPUT] 0    0    [1    /1   ]  3618.24884128        1
[INPUT] 0    0    [1    /1   ]  1618.22092744        1
[INPUT] 0    0    [1    /1   ]  239.75485306         1
[INPUT] 0    0    [1    /1   ]  52.121905367         1
[INPUT] 0    0    [1    /1   ]  4.60139069023        1
[INPUT] 0    0    [1    /1   ]  0.39934496325        1
[INPUT] 1    0    [1    /1   ]  1362.79295088        1
[INPUT] 1    0    [1    /1   ]  665.179887457        1
[INPUT] 1    0    [1    /1   ]  303.316145049        1
[INPUT] 1    0    [1    /1   ]  316.142494805        1
[INPUT] 1    0    [1    /1   ]  49.3041476741        1
[INPUT] 1    0    [1    /1   ]  5.17426513344        1
[INPUT] 1    0    [1    /1   ]  14.7614595513        1
[INPUT] 1    0    [1    /1   ]  0.62774174968        1
[INPUT] 1    0    [1    /1   ]  1.95079851957        1
[INPUT] 1    0    [1    /1   ]  0.191629289254       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.50793843319, 1.0]], [0, [7618.2498124038875, 1.0]], [0, [3618.2488412812218, 1.0]], [0, [1618.2209274413322, 1.0]], [0, [239.75485305954194, 1.0]], [0, [52.121905367031026, 1.0]], [0, [4.601390690225999, 1.0]], [0, [0.39934496324958146, 1.0]], [1, [1362.792950875873, 1.0]], [1, [665.1798874571531, 1.0]], [1, [303.31614504914575, 1.0]], [1, [316.1424948052558, 1.0]], [1, [49.3041476740653, 1.0]], [1, [5.174265133444701, 1.0]], [1, [14.761459551281211, 1.0]], [1, [0.627741749679721, 1.0]], [1, [1.9507985195662334, 1.0]], [1, [0.19162928925414294, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50793843]
bas 1, expnt(s) = [7618.2498124]
bas 2, expnt(s) = [3618.24884128]
bas 3, expnt(s) = [1618.22092744]
bas 4, expnt(s) = [239.75485306]
bas 5, expnt(s) = [52.12190537]
bas 6, expnt(s) = [4.60139069]
bas 7, expnt(s) = [0.39934496]
bas 8, expnt(s) = [1362.79295088]
bas 9, expnt(s) = [665.17988746]
bas 10, expnt(s) = [303.31614505]
bas 11, expnt(s) = [316.14249481]
bas 12, expnt(s) = [49.30414767]
bas 13, expnt(s) = [5.17426513]
bas 14, expnt(s) = [14.76145955]
bas 15, expnt(s) = [0.62774175]
bas 16, expnt(s) = [1.95079852]
bas 17, expnt(s) = [0.19162929]
CPU time:        98.27
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61824981e+03 2.06018600e+03
 3.61824884e+03 1.17866082e+03 1.61822093e+03 6.44604576e+02
 2.39754853e+02 1.53936135e+02 5.21219054e+01 4.90094960e+01
 4.60139069e+00 7.93746560e+00 3.99344963e-01 1.26918866e+00
 1.36279295e+03 2.41558175e+04 6.65179887e+02 9.85503745e+03
 3.03316145e+02 3.69278312e+03 3.16142495e+02 3.88900040e+03
 4.93041477e+01 3.81143670e+02 5.17426513e+00 2.27664461e+01
 1.47614596e+01 8.44104117e+01 6.27741750e-01 1.63008653e+00
 1.95079852e+00 6.72589238e+00 1.91629289e-01 3.69880770e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977303836572425
cond(S) = 84448.90903970179
E1 = -727.5384998377214  E_coul = 203.1308156684077
init E= -524.407684169314
    CPU time for initialize scf      0.27 sec, wall time      0.05 sec
  HOMO = -0.560256490769356  LUMO = 0.794000216902973
  mo_energy =
[-1.17868709e+02 -1.20938811e+01 -9.44280483e+00 -9.44280483e+00
 -9.44280483e+00 -1.22989685e+00 -5.60256491e-01 -5.60256491e-01
 -5.60256491e-01  7.94000217e-01  7.94000217e-01  7.94000217e-01
  4.83319349e+00  4.83319349e+00  4.83319349e+00  2.15777345e+01
  2.15777345e+01  2.15777345e+01  9.15119161e+01  9.15119161e+01
  9.15119161e+01  1.83498835e+02  4.22824297e+02  4.22824297e+02
  4.22824297e+02  1.27617624e+03  1.27617624e+03  1.27617624e+03
  1.91532859e+03  2.97808941e+03  2.97808941e+03  2.97808941e+03
  6.60711299e+03  6.60711299e+03  6.60711299e+03  8.27367943e+03
  2.46614594e+04  7.54577985e+04]
E1 = -727.2375012981325  E_coul = 201.70260811110322
cycle= 1 E= -525.534893187029  delta_E= -1.13  |g|= 0.184  |ddm|= 0.286
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.455761
diis-c [-0.20771824  1.        ]
  HOMO = -0.577145917738076  LUMO = 0.788011467322867
  mo_energy =
[-1.18124537e+02 -1.21901341e+01 -9.53807181e+00 -9.53807181e+00
 -9.53807181e+00 -1.25594716e+00 -5.77145918e-01 -5.77145918e-01
 -5.77145918e-01  7.88011467e-01  7.88011467e-01  7.88011467e-01
  4.79228171e+00  4.79228171e+00  4.79228171e+00  2.14924978e+01
  2.14924978e+01  2.14924978e+01  9.13557178e+01  9.13557178e+01
  9.13557178e+01  1.83295950e+02  4.22582074e+02  4.22582074e+02
  4.22582074e+02  1.27588436e+03  1.27588436e+03  1.27588436e+03
  1.91491692e+03  2.97773679e+03  2.97773679e+03  2.97773679e+03
  6.60664532e+03  6.60664532e+03  6.60664532e+03  8.27312969e+03
  2.46608160e+04  7.54570639e+04]
E1 = -727.47142216107  E_coul = 201.93631699516172
cycle= 2 E= -525.535105165908  delta_E= -0.000212  |g|= 0.0165  |ddm|= 0.0157
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0320816
diis-c [-7.99099365e-04  3.22727763e-02  9.67727224e-01]
  HOMO = -0.574021096663424  LUMO = 0.789774158258644
  mo_energy =
[-1.18091680e+02 -1.21736526e+01 -9.52134372e+00 -9.52134372e+00
 -9.52134372e+00 -1.25174341e+00 -5.74021097e-01 -5.74021097e-01
 -5.74021097e-01  7.89774158e-01  7.89774158e-01  7.89774158e-01
  4.79911084e+00  4.79911084e+00  4.79911084e+00  2.15069632e+01
  2.15069632e+01  2.15069632e+01  9.13802326e+01  9.13802326e+01
  9.13802326e+01  1.83327549e+02  4.22614516e+02  4.22614516e+02
  4.22614516e+02  1.27591903e+03  1.27591903e+03  1.27591903e+03
  1.91495304e+03  2.97777252e+03  2.97777252e+03  2.97777252e+03
  6.60668166e+03  6.60668166e+03  6.60668166e+03  8.27316627e+03
  2.46608526e+04  7.54571005e+04]
E1 = -727.4210207575914  E_coul = 201.88590794954408
cycle= 3 E= -525.535112808047  delta_E= -7.64e-06  |g|= 0.0024  |ddm|= 0.00423
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00481451
diis-c [-1.37990072e-07 -7.40627326e-04  1.26130173e-01  8.74610454e-01]
  HOMO = -0.574671190012885  LUMO = 0.789409505524187
  mo_energy =
[-1.18096301e+02 -1.21763069e+01 -9.52404691e+00 -9.52404691e+00
 -9.52404691e+00 -1.25259363e+00 -5.74671190e-01 -5.74671190e-01
 -5.74671190e-01  7.89409506e-01  7.89409506e-01  7.89409506e-01
  4.79781971e+00  4.79781971e+00  4.79781971e+00  2.15045793e+01
  2.15045793e+01  2.15045793e+01  9.13766056e+01  9.13766056e+01
  9.13766056e+01  1.83323128e+02  4.22609951e+02  4.22609951e+02
  4.22609951e+02  1.27591420e+03  1.27591420e+03  1.27591420e+03
  1.91494798e+03  2.97776753e+03  2.97776753e+03  2.97776753e+03
  6.60667654e+03  6.60667654e+03  6.60667654e+03  8.27316108e+03
  2.46608474e+04  7.54570952e+04]
E1 = -727.4287618189177  E_coul = 201.89364877800483
cycle= 4 E= -525.535113040913  delta_E= -2.33e-07  |g|= 4.49e-05  |ddm|= 0.000668
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.14067e-05
diis-c [-4.00770983e-10 -2.81847706e-05  4.44443832e-03  4.60278054e-02
  9.49555941e-01]
  HOMO = -0.574646918082463  LUMO = 0.789422701369481
  mo_energy =
[-1.18096200e+02 -1.21762233e+01 -9.52396232e+00 -9.52396232e+00
 -9.52396232e+00 -1.25256155e+00 -5.74646918e-01 -5.74646918e-01
 -5.74646918e-01  7.89422701e-01  7.89422701e-01  7.89422701e-01
  4.79786615e+00  4.79786615e+00  4.79786615e+00  2.15046551e+01
  2.15046551e+01  2.15046551e+01  9.13766983e+01  9.13766983e+01
  9.13766983e+01  1.83323228e+02  4.22610051e+02  4.22610051e+02
  4.22610051e+02  1.27591430e+03  1.27591430e+03  1.27591430e+03
  1.91494808e+03  2.97776763e+03  2.97776763e+03  2.97776763e+03
  6.60667664e+03  6.60667664e+03  6.60667664e+03  8.27316117e+03
  2.46608475e+04  7.54570953e+04]
E1 = -727.4285320171036  E_coul = 201.8934189759992
cycle= 5 E= -525.535113041104  delta_E= -1.92e-10  |g|= 2.63e-06  |ddm|= 2.56e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4285320171036  E_coul = 201.8934189759992
  HOMO = -0.574648652880388  LUMO = 0.789421718767388
  mo_energy =
[-1.18096207e+02 -1.21762283e+01 -9.52396740e+00 -9.52396740e+00
 -9.52396740e+00 -1.25256374e+00 -5.74648653e-01 -5.74648653e-01
 -5.74648653e-01  7.89421719e-01  7.89421719e-01  7.89421719e-01
  4.79786308e+00  4.79786308e+00  4.79786308e+00  2.15046505e+01
  2.15046505e+01  2.15046505e+01  9.13766925e+01  9.13766925e+01
  9.13766925e+01  1.83323221e+02  4.22610045e+02  4.22610045e+02
  4.22610045e+02  1.27591429e+03  1.27591429e+03  1.27591429e+03
  1.91494807e+03  2.97776762e+03  2.97776762e+03  2.97776762e+03
  6.60667663e+03  6.60667663e+03  6.60667663e+03  8.27316117e+03
  2.46608474e+04  7.54570953e+04]
E1 = -727.4285449037671  E_coul = 201.8934318626612
Extra cycle  E= -525.535113041106  delta_E= -1.48e-12  |g|= 6.23e-07  |ddm|= 1.15e-06
    CPU time for scf_cycle      0.46 sec, wall time      0.24 sec
exp = [2.61825079e+04 7.61824981e+03 3.61824884e+03 1.61822093e+03
 2.39754853e+02 5.21219054e+01 4.60139069e+00 3.99344963e-01
 1.36279295e+03 6.65179887e+02 3.03316145e+02 3.16142495e+02
 4.93041477e+01 5.17426513e+00 1.47614596e+01 6.27741750e-01
 1.95079852e+00 1.91629289e-01]
E = -525.5351130411059
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5079384        1
[INPUT] 0    0    [1    /1   ]  7618.2498124         1
[INPUT] 0    0    [1    /1   ]  3618.24884128        1
[INPUT] 0    0    [1    /1   ]  1618.22092744        1
[INPUT] 0    0    [1    /1   ]  239.75485306         1
[INPUT] 0    0    [1    /1   ]  52.121905367         1
[INPUT] 0    0    [1    /1   ]  4.60139069023        1
[INPUT] 0    0    [1    /1   ]  0.39934496325        1
[INPUT] 1    0    [1    /1   ]  1362.79295088        1
[INPUT] 1    0    [1    /1   ]  665.179887457        1
[INPUT] 1    0    [1    /1   ]  303.316145049        1
[INPUT] 1    0    [1    /1   ]  316.142494805        1
[INPUT] 1    0    [1    /1   ]  49.3041476741        1
[INPUT] 1    0    [1    /1   ]  5.17426513344        1
[INPUT] 1    0    [1    /1   ]  14.7614595513        1
[INPUT] 1    0    [1    /1   ]  0.62774174968        1
[INPUT] 1    0    [1    /1   ]  1.95079851957        1
[INPUT] 1    0    [1    /1   ]  0.191629289254       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.50793843319, 1.0]], [0, [7618.2498124038875, 1.0]], [0, [3618.2488412812218, 1.0]], [0, [1618.2209274413322, 1.0]], [0, [239.75485305954194, 1.0]], [0, [52.121905367031026, 1.0]], [0, [4.601390690225999, 1.0]], [0, [0.39934496324958146, 1.0]], [1, [1362.792950875873, 1.0]], [1, [665.1798874571531, 1.0]], [1, [303.31614504914575, 1.0]], [1, [316.1424948052558, 1.0]], [1, [49.3041476740653, 1.0]], [1, [5.174265133444701, 1.0]], [1, [14.761459551281211, 1.0]], [1, [0.627741749679721, 1.0]], [1, [1.9507985195662334, 1.0]], [1, [0.19162928925414294, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50793843]
bas 1, expnt(s) = [7618.2498124]
bas 2, expnt(s) = [3618.24884128]
bas 3, expnt(s) = [1618.22092744]
bas 4, expnt(s) = [239.75485306]
bas 5, expnt(s) = [52.12190537]
bas 6, expnt(s) = [4.60139069]
bas 7, expnt(s) = [0.39934496]
bas 8, expnt(s) = [1362.79295088]
bas 9, expnt(s) = [665.17988746]
bas 10, expnt(s) = [303.31614505]
bas 11, expnt(s) = [316.14249481]
bas 12, expnt(s) = [49.30414767]
bas 13, expnt(s) = [5.17426513]
bas 14, expnt(s) = [14.76145955]
bas 15, expnt(s) = [0.62774175]
bas 16, expnt(s) = [1.95079852]
bas 17, expnt(s) = [0.19162929]
CPU time:        98.86
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61824981e+03 2.06018600e+03
 3.61824884e+03 1.17866082e+03 1.61822093e+03 6.44604576e+02
 2.39754853e+02 1.53936135e+02 5.21219054e+01 4.90094960e+01
 4.60139069e+00 7.93746560e+00 3.99344963e-01 1.26918866e+00
 1.36279295e+03 2.41558175e+04 6.65179887e+02 9.85503745e+03
 3.03316145e+02 3.69278312e+03 3.16142495e+02 3.88900040e+03
 4.93041477e+01 3.81143670e+02 5.17426513e+00 2.27664461e+01
 1.47614596e+01 8.44104117e+01 6.27741750e-01 1.63008653e+00
 1.95079852e+00 6.72589238e+00 1.91629289e-01 3.69880770e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977303836572425
cond(S) = 84448.90903970179
E1 = -727.5384998377214  E_coul = 203.1308156684077
init E= -524.407684169314
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.560256490769356  LUMO = 0.794000216902973
  mo_energy =
[-1.17868709e+02 -1.20938811e+01 -9.44280483e+00 -9.44280483e+00
 -9.44280483e+00 -1.22989685e+00 -5.60256491e-01 -5.60256491e-01
 -5.60256491e-01  7.94000217e-01  7.94000217e-01  7.94000217e-01
  4.83319349e+00  4.83319349e+00  4.83319349e+00  2.15777345e+01
  2.15777345e+01  2.15777345e+01  9.15119161e+01  9.15119161e+01
  9.15119161e+01  1.83498835e+02  4.22824297e+02  4.22824297e+02
  4.22824297e+02  1.27617624e+03  1.27617624e+03  1.27617624e+03
  1.91532859e+03  2.97808941e+03  2.97808941e+03  2.97808941e+03
  6.60711299e+03  6.60711299e+03  6.60711299e+03  8.27367943e+03
  2.46614594e+04  7.54577985e+04]
E1 = -727.2375012981325  E_coul = 201.70260811110322
cycle= 1 E= -525.534893187029  delta_E= -1.13  |g|= 0.184  |ddm|= 0.286
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.455761
diis-c [-0.20771824  1.        ]
  HOMO = -0.577145917738076  LUMO = 0.788011467322867
  mo_energy =
[-1.18124537e+02 -1.21901341e+01 -9.53807181e+00 -9.53807181e+00
 -9.53807181e+00 -1.25594716e+00 -5.77145918e-01 -5.77145918e-01
 -5.77145918e-01  7.88011467e-01  7.88011467e-01  7.88011467e-01
  4.79228171e+00  4.79228171e+00  4.79228171e+00  2.14924978e+01
  2.14924978e+01  2.14924978e+01  9.13557178e+01  9.13557178e+01
  9.13557178e+01  1.83295950e+02  4.22582074e+02  4.22582074e+02
  4.22582074e+02  1.27588436e+03  1.27588436e+03  1.27588436e+03
  1.91491692e+03  2.97773679e+03  2.97773679e+03  2.97773679e+03
  6.60664532e+03  6.60664532e+03  6.60664532e+03  8.27312969e+03
  2.46608160e+04  7.54570639e+04]
E1 = -727.47142216107  E_coul = 201.93631699516172
cycle= 2 E= -525.535105165908  delta_E= -0.000212  |g|= 0.0165  |ddm|= 0.0157
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0320816
diis-c [-7.99099365e-04  3.22727763e-02  9.67727224e-01]
  HOMO = -0.574021096663424  LUMO = 0.789774158258644
  mo_energy =
[-1.18091680e+02 -1.21736526e+01 -9.52134372e+00 -9.52134372e+00
 -9.52134372e+00 -1.25174341e+00 -5.74021097e-01 -5.74021097e-01
 -5.74021097e-01  7.89774158e-01  7.89774158e-01  7.89774158e-01
  4.79911084e+00  4.79911084e+00  4.79911084e+00  2.15069632e+01
  2.15069632e+01  2.15069632e+01  9.13802326e+01  9.13802326e+01
  9.13802326e+01  1.83327549e+02  4.22614516e+02  4.22614516e+02
  4.22614516e+02  1.27591903e+03  1.27591903e+03  1.27591903e+03
  1.91495304e+03  2.97777252e+03  2.97777252e+03  2.97777252e+03
  6.60668166e+03  6.60668166e+03  6.60668166e+03  8.27316627e+03
  2.46608526e+04  7.54571005e+04]
E1 = -727.4210207575914  E_coul = 201.88590794954408
cycle= 3 E= -525.535112808047  delta_E= -7.64e-06  |g|= 0.0024  |ddm|= 0.00423
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00481451
diis-c [-1.37990072e-07 -7.40627326e-04  1.26130173e-01  8.74610454e-01]
  HOMO = -0.574671190012885  LUMO = 0.789409505524187
  mo_energy =
[-1.18096301e+02 -1.21763069e+01 -9.52404691e+00 -9.52404691e+00
 -9.52404691e+00 -1.25259363e+00 -5.74671190e-01 -5.74671190e-01
 -5.74671190e-01  7.89409506e-01  7.89409506e-01  7.89409506e-01
  4.79781971e+00  4.79781971e+00  4.79781971e+00  2.15045793e+01
  2.15045793e+01  2.15045793e+01  9.13766056e+01  9.13766056e+01
  9.13766056e+01  1.83323128e+02  4.22609951e+02  4.22609951e+02
  4.22609951e+02  1.27591420e+03  1.27591420e+03  1.27591420e+03
  1.91494798e+03  2.97776753e+03  2.97776753e+03  2.97776753e+03
  6.60667654e+03  6.60667654e+03  6.60667654e+03  8.27316108e+03
  2.46608474e+04  7.54570952e+04]
E1 = -727.4287618189177  E_coul = 201.89364877800483
cycle= 4 E= -525.535113040913  delta_E= -2.33e-07  |g|= 4.49e-05  |ddm|= 0.000668
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.14067e-05
diis-c [-4.00770983e-10 -2.81847706e-05  4.44443832e-03  4.60278054e-02
  9.49555941e-01]
  HOMO = -0.574646918082463  LUMO = 0.789422701369481
  mo_energy =
[-1.18096200e+02 -1.21762233e+01 -9.52396232e+00 -9.52396232e+00
 -9.52396232e+00 -1.25256155e+00 -5.74646918e-01 -5.74646918e-01
 -5.74646918e-01  7.89422701e-01  7.89422701e-01  7.89422701e-01
  4.79786615e+00  4.79786615e+00  4.79786615e+00  2.15046551e+01
  2.15046551e+01  2.15046551e+01  9.13766983e+01  9.13766983e+01
  9.13766983e+01  1.83323228e+02  4.22610051e+02  4.22610051e+02
  4.22610051e+02  1.27591430e+03  1.27591430e+03  1.27591430e+03
  1.91494808e+03  2.97776763e+03  2.97776763e+03  2.97776763e+03
  6.60667664e+03  6.60667664e+03  6.60667664e+03  8.27316117e+03
  2.46608475e+04  7.54570953e+04]
E1 = -727.4285320171036  E_coul = 201.8934189759992
cycle= 5 E= -525.535113041104  delta_E= -1.92e-10  |g|= 2.63e-06  |ddm|= 2.56e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4285320171036  E_coul = 201.8934189759992
  HOMO = -0.574648652880388  LUMO = 0.789421718767388
  mo_energy =
[-1.18096207e+02 -1.21762283e+01 -9.52396740e+00 -9.52396740e+00
 -9.52396740e+00 -1.25256374e+00 -5.74648653e-01 -5.74648653e-01
 -5.74648653e-01  7.89421719e-01  7.89421719e-01  7.89421719e-01
  4.79786308e+00  4.79786308e+00  4.79786308e+00  2.15046505e+01
  2.15046505e+01  2.15046505e+01  9.13766925e+01  9.13766925e+01
  9.13766925e+01  1.83323221e+02  4.22610045e+02  4.22610045e+02
  4.22610045e+02  1.27591429e+03  1.27591429e+03  1.27591429e+03
  1.91494807e+03  2.97776762e+03  2.97776762e+03  2.97776762e+03
  6.60667663e+03  6.60667663e+03  6.60667663e+03  8.27316117e+03
  2.46608474e+04  7.54570953e+04]
E1 = -727.4285449037671  E_coul = 201.8934318626612
Extra cycle  E= -525.535113041106  delta_E= -1.48e-12  |g|= 6.23e-07  |ddm|= 1.15e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 84448.90903970179
E1 = -727.4285449037671  E_coul = 201.8934318626612
init E= -525.535113041106
    CPU time for initialize scf      1.08 sec, wall time      0.19 sec
  HOMO = -0.574648414317764  LUMO = 0.789421849331895
  mo_energy =
[-1.18096205e+02 -1.21762274e+01 -9.52396642e+00 -9.52396642e+00
 -9.52396642e+00 -1.25256342e+00 -5.74648414e-01 -5.74648414e-01
 -5.74648414e-01  7.89421849e-01  7.89421849e-01  7.89421849e-01
  4.79786355e+00  4.79786355e+00  4.79786355e+00  2.15046513e+01
  2.15046513e+01  2.15046513e+01  9.13766937e+01  9.13766937e+01
  9.13766937e+01  1.83323223e+02  4.22610046e+02  4.22610046e+02
  4.22610046e+02  1.27591429e+03  1.27591429e+03  1.27591429e+03
  1.91494807e+03  2.97776763e+03  2.97776763e+03  2.97776763e+03
  6.60667663e+03  6.60667663e+03  6.60667663e+03  8.27316117e+03
  2.46608474e+04  7.54570953e+04]
E1 = -727.4285420965613  E_coul = 201.8934290554556
cycle= 1 E= -525.535113041106  delta_E= 2.27e-13  |g|= 1.43e-07  |ddm|= 2.81e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4285420965613  E_coul = 201.8934290554556
  HOMO = -0.574648468268728  LUMO = 0.789421819088808
  mo_energy =
[-1.18096206e+02 -1.21762276e+01 -9.52396663e+00 -9.52396663e+00
 -9.52396663e+00 -1.25256349e+00 -5.74648468e-01 -5.74648468e-01
 -5.74648468e-01  7.89421819e-01  7.89421819e-01  7.89421819e-01
  4.79786345e+00  4.79786345e+00  4.79786345e+00  2.15046512e+01
  2.15046512e+01  2.15046512e+01  9.13766935e+01  9.13766935e+01
  9.13766935e+01  1.83323222e+02  4.22610046e+02  4.22610046e+02
  4.22610046e+02  1.27591429e+03  1.27591429e+03  1.27591429e+03
  1.91494807e+03  2.97776763e+03  2.97776763e+03  2.97776763e+03
  6.60667663e+03  6.60667663e+03  6.60667663e+03  8.27316117e+03
  2.46608474e+04  7.54570953e+04]
E1 = -727.4285426844838  E_coul = 201.893429643377
Extra cycle  E= -525.535113041107  delta_E= -1.14e-12  |g|= 3.1e-08  |ddm|= 5.16e-08
    CPU time for scf_cycle      1.20 sec, wall time      0.31 sec
exp = [2.61825079e+04 7.61824981e+03 3.61824884e+03 1.61822093e+03
 2.39754853e+02 5.21219054e+01 4.60139069e+00 3.99344963e-01
 1.36279295e+03 6.65179887e+02 3.03316145e+02 3.16142495e+02
 4.93041477e+01 5.17426513e+00 1.47614596e+01 6.27741750e-01
 1.95079852e+00 1.91629289e-01]
grad_E = [-1.98689113e-06  2.20305858e-05  4.42417755e-05  6.77718196e-04
  1.00042105e-04 -1.07879812e-03 -1.72126360e-03  3.42075735e-03
  1.03109893e-06  1.77418038e-05  9.42348605e-05  8.30291208e-05
  1.09569469e-03 -2.46635451e-04 -1.09728757e-02 -2.10574876e-02
  5.75436749e-03  1.58325401e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:10 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5079651        1
[INPUT] 0    0    [1    /1   ]  7618.24951773        1
[INPUT] 0    0    [1    /1   ]  3618.24825092        1
[INPUT] 0    0    [1    /1   ]  1618.21187175        1
[INPUT] 0    0    [1    /1   ]  239.749878196        1
[INPUT] 0    0    [1    /1   ]  52.1623250645        1
[INPUT] 0    0    [1    /1   ]  4.60524707226        1
[INPUT] 0    0    [1    /1   ]  0.399660527735       1
[INPUT] 1    0    [1    /1   ]  1362.79293671        1
[INPUT] 1    0    [1    /1   ]  665.179646759        1
[INPUT] 1    0    [1    /1   ]  303.314864052        1
[INPUT] 1    0    [1    /1   ]  316.141366221        1
[INPUT] 1    0    [1    /1   ]  49.2931647619        1
[INPUT] 1    0    [1    /1   ]  5.23892627519        1
[INPUT] 1    0    [1    /1   ]  14.8630595358        1
[INPUT] 1    0    [1    /1   ]  0.627868990161       1
[INPUT] 1    0    [1    /1   ]  2.01510323705        1
[INPUT] 1    0    [1    /1   ]  0.190624496467       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.50796512533, 1.0]], [0, [7618.249517733776, 1.0]], [0, [3618.2482509220918, 1.0]], [0, [1618.2118717469364, 1.0]], [0, [239.74987819567275, 1.0]], [0, [52.16232506454059, 1.0]], [0, [4.605247072263015, 1.0]], [0, [0.39966052773483657, 1.0]], [1, [1362.7929367142171, 1.0]], [1, [665.1796467587498, 1.0]], [1, [303.31486405227855, 1.0]], [1, [316.14136622084743, 1.0]], [1, [49.2931647618693, 1.0]], [1, [5.238926275186033, 1.0]], [1, [14.863059535787173, 1.0]], [1, [0.6278689901614244, 1.0]], [1, [2.0151032370528705, 1.0]], [1, [0.19062449646689558, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50796513]
bas 1, expnt(s) = [7618.24951773]
bas 2, expnt(s) = [3618.24825092]
bas 3, expnt(s) = [1618.21187175]
bas 4, expnt(s) = [239.7498782]
bas 5, expnt(s) = [52.16232506]
bas 6, expnt(s) = [4.60524707]
bas 7, expnt(s) = [0.39966053]
bas 8, expnt(s) = [1362.79293671]
bas 9, expnt(s) = [665.17964676]
bas 10, expnt(s) = [303.31486405]
bas 11, expnt(s) = [316.14136622]
bas 12, expnt(s) = [49.29316476]
bas 13, expnt(s) = [5.23892628]
bas 14, expnt(s) = [14.86305954]
bas 15, expnt(s) = [0.62786899]
bas 16, expnt(s) = [2.01510324]
bas 17, expnt(s) = [0.1906245]
CPU time:       104.66
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825080e+04 5.20024084e+03 7.61824952e+03 2.06018594e+03
 3.61824825e+03 1.17866068e+03 1.61821187e+03 6.44601871e+02
 2.39749878e+02 1.53933740e+02 5.21623251e+01 4.90379978e+01
 4.60524707e+00 7.94245432e+00 3.99660528e-01 1.26994077e+00
 1.36279294e+03 2.41558172e+04 6.65179647e+02 9.85503300e+03
 3.03314864e+02 3.69276363e+03 3.16141366e+02 3.88898305e+03
 4.92931648e+01 3.81037545e+02 5.23892628e+00 2.31226311e+01
 1.48630595e+01 8.51372591e+01 6.27868990e-01 1.63049956e+00
 2.01510324e+00 7.00415936e+00 1.90624496e-01 3.67458061e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977222267177105
cond(S) = 84609.33133021567
E1 = -727.5502013787686  E_coul = 203.1434391579321
init E= -524.406762220837
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.560063577679451  LUMO = 0.790803742904435
  mo_energy =
[-1.17866784e+02 -1.20932552e+01 -9.44185964e+00 -9.44185964e+00
 -9.44185964e+00 -1.22988079e+00 -5.60063578e-01 -5.60063578e-01
 -5.60063578e-01  7.90803743e-01  7.90803743e-01  7.90803743e-01
  4.93401528e+00  4.93401528e+00  4.93401528e+00  2.20082768e+01
  2.20082768e+01  2.20082768e+01  9.22249222e+01  9.22249222e+01
  9.22249222e+01  1.83626458e+02  4.23445104e+02  4.23445104e+02
  4.23445104e+02  1.27671535e+03  1.27671535e+03  1.27671535e+03
  1.91546706e+03  2.97858385e+03  2.97858385e+03  2.97858385e+03
  6.60756024e+03  6.60756024e+03  6.60756024e+03  8.27378949e+03
  2.46615505e+04  7.54578768e+04]
E1 = -727.2425240973156  E_coul = 201.70696742257016
cycle= 1 E= -525.535556674745  delta_E= -1.13  |g|= 0.185  |ddm|= 0.334
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.45549
diis-c [-0.2074714  1.       ]
  HOMO = -0.57717739186838  LUMO = 0.784699861811038
  mo_energy =
[-1.18122205e+02 -1.21905416e+01 -9.53794544e+00 -9.53794544e+00
 -9.53794544e+00 -1.25630774e+00 -5.77177392e-01 -5.77177392e-01
 -5.77177392e-01  7.84699862e-01  7.84699862e-01  7.84699862e-01
  4.89179869e+00  4.89179869e+00  4.89179869e+00  2.19218130e+01
  2.19218130e+01  2.19218130e+01  9.20684970e+01  9.20684970e+01
  9.20684970e+01  1.83423529e+02  4.23203428e+02  4.23203428e+02
  4.23203428e+02  1.27642461e+03  1.27642461e+03  1.27642461e+03
  1.91505764e+03  2.97823302e+03  2.97823302e+03  2.97823302e+03
  6.60709500e+03  6.60709500e+03  6.60709500e+03  8.27324260e+03
  2.46609103e+04  7.54571454e+04]
E1 = -727.4774113964658  E_coul = 201.941644543114
cycle= 2 E= -525.535766853352  delta_E= -0.00021  |g|= 0.0164  |ddm|= 0.016
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0321744
diis-c [-8.05559078e-04  3.22581808e-02  9.67741819e-01]
  HOMO = -0.574001930313451  LUMO = 0.786497341851564
  mo_energy =
[-1.18089369e+02 -1.21739902e+01 -9.52114914e+00 -9.52114914e+00
 -9.52114914e+00 -1.25203918e+00 -5.74001930e-01 -5.74001930e-01
 -5.74001930e-01  7.86497342e-01  7.86497342e-01  7.86497342e-01
  4.89883693e+00  4.89883693e+00  4.89883693e+00  2.19364360e+01
  2.19364360e+01  2.19364360e+01  9.20930342e+01  9.20930342e+01
  9.20930342e+01  1.83455112e+02  4.23235844e+02  4.23235844e+02
  4.23235844e+02  1.27645925e+03  1.27645925e+03  1.27645925e+03
  1.91509374e+03  2.97826871e+03  2.97826871e+03  2.97826871e+03
  6.60713131e+03  6.60713131e+03  6.60713131e+03  8.27327915e+03
  2.46609468e+04  7.54571819e+04]
E1 = -727.4269642240664  E_coul = 201.89118972650803
cycle= 3 E= -525.535774497558  delta_E= -7.64e-06  |g|= 0.0024  |ddm|= 0.00427
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00484113
diis-c [-1.28258506e-07 -7.38148552e-04  1.26506039e-01  8.74232109e-01]
  HOMO = -0.574651057426765  LUMO = 0.786132592174191
  mo_energy =
[-1.18093988e+02 -1.21766451e+01 -9.52385242e+00 -9.52385242e+00
 -9.52385242e+00 -1.25288914e+00 -5.74651057e-01 -5.74651057e-01
 -5.74651057e-01  7.86132592e-01  7.86132592e-01  7.86132592e-01
  4.89752496e+00  4.89752496e+00  4.89752496e+00  2.19340406e+01
  2.19340406e+01  2.19340406e+01  9.20894083e+01  9.20894083e+01
  9.20894083e+01  1.83450691e+02  4.23231281e+02  4.23231281e+02
  4.23231281e+02  1.27645442e+03  1.27645442e+03  1.27645442e+03
  1.91508868e+03  2.97826373e+03  2.97826373e+03  2.97826373e+03
  6.60712619e+03  6.60712619e+03  6.60712619e+03  8.27327395e+03
  2.46609416e+04  7.54571767e+04]
E1 = -727.4347005576082  E_coul = 201.89892582747441
cycle= 4 E= -525.535774730134  delta_E= -2.33e-07  |g|= 4.36e-05  |ddm|= 0.000676
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=7.93224e-05
diis-c [-3.76407500e-10 -2.86343038e-05  4.59670484e-03  4.64844884e-02
  9.48947441e-01]
  HOMO = -0.574627174969864  LUMO = 0.786145646306823
  mo_energy =
[-1.18093891e+02 -1.21765636e+01 -9.52377001e+00 -9.52377001e+00
 -9.52377001e+00 -1.25285763e+00 -5.74627175e-01 -5.74627175e-01
 -5.74627175e-01  7.86145646e-01  7.86145646e-01  7.86145646e-01
  4.89757119e+00  4.89757119e+00  4.89757119e+00  2.19341149e+01
  2.19341149e+01  2.19341149e+01  9.20894986e+01  9.20894986e+01
  9.20894986e+01  1.83450789e+02  4.23231378e+02  4.23231378e+02
  4.23231378e+02  1.27645452e+03  1.27645452e+03  1.27645452e+03
  1.91508877e+03  2.97826383e+03  2.97826383e+03  2.97826383e+03
  6.60712629e+03  6.60712629e+03  6.60712629e+03  8.27327405e+03
  2.46609417e+04  7.54571767e+04]
E1 = -727.4344779699283  E_coul = 201.89870323961304
cycle= 5 E= -525.535774730315  delta_E= -1.81e-10  |g|= 2.47e-06  |ddm|= 2.46e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.4344779699283  E_coul = 201.89870323961304
  HOMO = -0.574628795599914  LUMO = 0.786144730024091
  mo_energy =
[-1.18093897e+02 -1.21765684e+01 -9.52377482e+00 -9.52377482e+00
 -9.52377482e+00 -1.25285968e+00 -5.74628796e-01 -5.74628796e-01
 -5.74628796e-01  7.86144730e-01  7.86144730e-01  7.86144730e-01
  4.89756826e+00  4.89756826e+00  4.89756826e+00  2.19341104e+01
  2.19341104e+01  2.19341104e+01  9.20894931e+01  9.20894931e+01
  9.20894931e+01  1.83450782e+02  4.23231372e+02  4.23231372e+02
  4.23231372e+02  1.27645451e+03  1.27645451e+03  1.27645451e+03
  1.91508877e+03  2.97826382e+03  2.97826382e+03  2.97826382e+03
  6.60712628e+03  6.60712628e+03  6.60712628e+03  8.27327404e+03
  2.46609417e+04  7.54571767e+04]
E1 = -727.4344902626527  E_coul = 201.89871553233837
Extra cycle  E= -525.535774730314  delta_E= 7.96e-13  |g|= 5.94e-07  |ddm|= 1.11e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.22 sec
exp = [2.61825080e+04 7.61824952e+03 3.61824825e+03 1.61821187e+03
 2.39749878e+02 5.21623251e+01 4.60524707e+00 3.99660528e-01
 1.36279294e+03 6.65179647e+02 3.03314864e+02 3.16141366e+02
 4.92931648e+01 5.23892628e+00 1.48630595e+01 6.27868990e-01
 2.01510324e+00 1.90624496e-01]
E = -525.5357747303144
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5079651        1
[INPUT] 0    0    [1    /1   ]  7618.24951773        1
[INPUT] 0    0    [1    /1   ]  3618.24825092        1
[INPUT] 0    0    [1    /1   ]  1618.21187175        1
[INPUT] 0    0    [1    /1   ]  239.749878196        1
[INPUT] 0    0    [1    /1   ]  52.1623250645        1
[INPUT] 0    0    [1    /1   ]  4.60524707226        1
[INPUT] 0    0    [1    /1   ]  0.399660527735       1
[INPUT] 1    0    [1    /1   ]  1362.79293671        1
[INPUT] 1    0    [1    /1   ]  665.179646759        1
[INPUT] 1    0    [1    /1   ]  303.314864052        1
[INPUT] 1    0    [1    /1   ]  316.141366221        1
[INPUT] 1    0    [1    /1   ]  49.2931647619        1
[INPUT] 1    0    [1    /1   ]  5.23892627519        1
[INPUT] 1    0    [1    /1   ]  14.8630595358        1
[INPUT] 1    0    [1    /1   ]  0.627868990161       1
[INPUT] 1    0    [1    /1   ]  2.01510323705        1
[INPUT] 1    0    [1    /1   ]  0.190624496467       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.50796512533, 1.0]], [0, [7618.249517733776, 1.0]], [0, [3618.2482509220918, 1.0]], [0, [1618.2118717469364, 1.0]], [0, [239.74987819567275, 1.0]], [0, [52.16232506454059, 1.0]], [0, [4.605247072263015, 1.0]], [0, [0.39966052773483657, 1.0]], [1, [1362.7929367142171, 1.0]], [1, [665.1796467587498, 1.0]], [1, [303.31486405227855, 1.0]], [1, [316.14136622084743, 1.0]], [1, [49.2931647618693, 1.0]], [1, [5.238926275186033, 1.0]], [1, [14.863059535787173, 1.0]], [1, [0.6278689901614244, 1.0]], [1, [2.0151032370528705, 1.0]], [1, [0.19062449646689558, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50796513]
bas 1, expnt(s) = [7618.24951773]
bas 2, expnt(s) = [3618.24825092]
bas 3, expnt(s) = [1618.21187175]
bas 4, expnt(s) = [239.7498782]
bas 5, expnt(s) = [52.16232506]
bas 6, expnt(s) = [4.60524707]
bas 7, expnt(s) = [0.39966053]
bas 8, expnt(s) = [1362.79293671]
bas 9, expnt(s) = [665.17964676]
bas 10, expnt(s) = [303.31486405]
bas 11, expnt(s) = [316.14136622]
bas 12, expnt(s) = [49.29316476]
bas 13, expnt(s) = [5.23892628]
bas 14, expnt(s) = [14.86305954]
bas 15, expnt(s) = [0.62786899]
bas 16, expnt(s) = [2.01510324]
bas 17, expnt(s) = [0.1906245]
CPU time:       105.56
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825080e+04 5.20024084e+03 7.61824952e+03 2.06018594e+03
 3.61824825e+03 1.17866068e+03 1.61821187e+03 6.44601871e+02
 2.39749878e+02 1.53933740e+02 5.21623251e+01 4.90379978e+01
 4.60524707e+00 7.94245432e+00 3.99660528e-01 1.26994077e+00
 1.36279294e+03 2.41558172e+04 6.65179647e+02 9.85503300e+03
 3.03314864e+02 3.69276363e+03 3.16141366e+02 3.88898305e+03
 4.92931648e+01 3.81037545e+02 5.23892628e+00 2.31226311e+01
 1.48630595e+01 8.51372591e+01 6.27868990e-01 1.63049956e+00
 2.01510324e+00 7.00415936e+00 1.90624496e-01 3.67458061e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977222267177105
cond(S) = 84609.33133021567
E1 = -727.5502013787686  E_coul = 203.1434391579321
init E= -524.406762220837
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.560063577679451  LUMO = 0.790803742904435
  mo_energy =
[-1.17866784e+02 -1.20932552e+01 -9.44185964e+00 -9.44185964e+00
 -9.44185964e+00 -1.22988079e+00 -5.60063578e-01 -5.60063578e-01
 -5.60063578e-01  7.90803743e-01  7.90803743e-01  7.90803743e-01
  4.93401528e+00  4.93401528e+00  4.93401528e+00  2.20082768e+01
  2.20082768e+01  2.20082768e+01  9.22249222e+01  9.22249222e+01
  9.22249222e+01  1.83626458e+02  4.23445104e+02  4.23445104e+02
  4.23445104e+02  1.27671535e+03  1.27671535e+03  1.27671535e+03
  1.91546706e+03  2.97858385e+03  2.97858385e+03  2.97858385e+03
  6.60756024e+03  6.60756024e+03  6.60756024e+03  8.27378949e+03
  2.46615505e+04  7.54578768e+04]
E1 = -727.2425240973156  E_coul = 201.70696742257016
cycle= 1 E= -525.535556674745  delta_E= -1.13  |g|= 0.185  |ddm|= 0.334
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.45549
diis-c [-0.2074714  1.       ]
  HOMO = -0.57717739186838  LUMO = 0.784699861811038
  mo_energy =
[-1.18122205e+02 -1.21905416e+01 -9.53794544e+00 -9.53794544e+00
 -9.53794544e+00 -1.25630774e+00 -5.77177392e-01 -5.77177392e-01
 -5.77177392e-01  7.84699862e-01  7.84699862e-01  7.84699862e-01
  4.89179869e+00  4.89179869e+00  4.89179869e+00  2.19218130e+01
  2.19218130e+01  2.19218130e+01  9.20684970e+01  9.20684970e+01
  9.20684970e+01  1.83423529e+02  4.23203428e+02  4.23203428e+02
  4.23203428e+02  1.27642461e+03  1.27642461e+03  1.27642461e+03
  1.91505764e+03  2.97823302e+03  2.97823302e+03  2.97823302e+03
  6.60709500e+03  6.60709500e+03  6.60709500e+03  8.27324260e+03
  2.46609103e+04  7.54571454e+04]
E1 = -727.4774113964658  E_coul = 201.941644543114
cycle= 2 E= -525.535766853352  delta_E= -0.00021  |g|= 0.0164  |ddm|= 0.016
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0321744
diis-c [-8.05559078e-04  3.22581808e-02  9.67741819e-01]
  HOMO = -0.574001930313451  LUMO = 0.786497341851564
  mo_energy =
[-1.18089369e+02 -1.21739902e+01 -9.52114914e+00 -9.52114914e+00
 -9.52114914e+00 -1.25203918e+00 -5.74001930e-01 -5.74001930e-01
 -5.74001930e-01  7.86497342e-01  7.86497342e-01  7.86497342e-01
  4.89883693e+00  4.89883693e+00  4.89883693e+00  2.19364360e+01
  2.19364360e+01  2.19364360e+01  9.20930342e+01  9.20930342e+01
  9.20930342e+01  1.83455112e+02  4.23235844e+02  4.23235844e+02
  4.23235844e+02  1.27645925e+03  1.27645925e+03  1.27645925e+03
  1.91509374e+03  2.97826871e+03  2.97826871e+03  2.97826871e+03
  6.60713131e+03  6.60713131e+03  6.60713131e+03  8.27327915e+03
  2.46609468e+04  7.54571819e+04]
E1 = -727.4269642240664  E_coul = 201.89118972650803
cycle= 3 E= -525.535774497558  delta_E= -7.64e-06  |g|= 0.0024  |ddm|= 0.00427
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00484113
diis-c [-1.28258506e-07 -7.38148552e-04  1.26506039e-01  8.74232109e-01]
  HOMO = -0.574651057426765  LUMO = 0.786132592174191
  mo_energy =
[-1.18093988e+02 -1.21766451e+01 -9.52385242e+00 -9.52385242e+00
 -9.52385242e+00 -1.25288914e+00 -5.74651057e-01 -5.74651057e-01
 -5.74651057e-01  7.86132592e-01  7.86132592e-01  7.86132592e-01
  4.89752496e+00  4.89752496e+00  4.89752496e+00  2.19340406e+01
  2.19340406e+01  2.19340406e+01  9.20894083e+01  9.20894083e+01
  9.20894083e+01  1.83450691e+02  4.23231281e+02  4.23231281e+02
  4.23231281e+02  1.27645442e+03  1.27645442e+03  1.27645442e+03
  1.91508868e+03  2.97826373e+03  2.97826373e+03  2.97826373e+03
  6.60712619e+03  6.60712619e+03  6.60712619e+03  8.27327395e+03
  2.46609416e+04  7.54571767e+04]
E1 = -727.4347005576082  E_coul = 201.89892582747441
cycle= 4 E= -525.535774730134  delta_E= -2.33e-07  |g|= 4.36e-05  |ddm|= 0.000676
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=7.93224e-05
diis-c [-3.76407500e-10 -2.86343038e-05  4.59670484e-03  4.64844884e-02
  9.48947441e-01]
  HOMO = -0.574627174969864  LUMO = 0.786145646306823
  mo_energy =
[-1.18093891e+02 -1.21765636e+01 -9.52377001e+00 -9.52377001e+00
 -9.52377001e+00 -1.25285763e+00 -5.74627175e-01 -5.74627175e-01
 -5.74627175e-01  7.86145646e-01  7.86145646e-01  7.86145646e-01
  4.89757119e+00  4.89757119e+00  4.89757119e+00  2.19341149e+01
  2.19341149e+01  2.19341149e+01  9.20894986e+01  9.20894986e+01
  9.20894986e+01  1.83450789e+02  4.23231378e+02  4.23231378e+02
  4.23231378e+02  1.27645452e+03  1.27645452e+03  1.27645452e+03
  1.91508877e+03  2.97826383e+03  2.97826383e+03  2.97826383e+03
  6.60712629e+03  6.60712629e+03  6.60712629e+03  8.27327405e+03
  2.46609417e+04  7.54571767e+04]
E1 = -727.4344779699283  E_coul = 201.89870323961304
cycle= 5 E= -525.535774730315  delta_E= -1.81e-10  |g|= 2.47e-06  |ddm|= 2.46e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.4344779699283  E_coul = 201.89870323961304
  HOMO = -0.574628795599914  LUMO = 0.786144730024091
  mo_energy =
[-1.18093897e+02 -1.21765684e+01 -9.52377482e+00 -9.52377482e+00
 -9.52377482e+00 -1.25285968e+00 -5.74628796e-01 -5.74628796e-01
 -5.74628796e-01  7.86144730e-01  7.86144730e-01  7.86144730e-01
  4.89756826e+00  4.89756826e+00  4.89756826e+00  2.19341104e+01
  2.19341104e+01  2.19341104e+01  9.20894931e+01  9.20894931e+01
  9.20894931e+01  1.83450782e+02  4.23231372e+02  4.23231372e+02
  4.23231372e+02  1.27645451e+03  1.27645451e+03  1.27645451e+03
  1.91508877e+03  2.97826382e+03  2.97826382e+03  2.97826382e+03
  6.60712628e+03  6.60712628e+03  6.60712628e+03  8.27327404e+03
  2.46609417e+04  7.54571767e+04]
E1 = -727.4344902626527  E_coul = 201.89871553233837
Extra cycle  E= -525.535774730314  delta_E= 7.96e-13  |g|= 5.94e-07  |ddm|= 1.11e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.21 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 84609.33133021567
E1 = -727.4344902626527  E_coul = 201.89871553233837
init E= -525.535774730314
    CPU time for initialize scf      1.78 sec, wall time      0.23 sec
  HOMO = -0.574628566284843  LUMO = 0.786144856217429
  mo_energy =
[-1.18093895e+02 -1.21765675e+01 -9.52377389e+00 -9.52377389e+00
 -9.52377389e+00 -1.25285938e+00 -5.74628566e-01 -5.74628566e-01
 -5.74628566e-01  7.86144856e-01  7.86144856e-01  7.86144856e-01
  4.89756873e+00  4.89756873e+00  4.89756873e+00  2.19341113e+01
  2.19341113e+01  2.19341113e+01  9.20894943e+01  9.20894943e+01
  9.20894943e+01  1.83450784e+02  4.23231374e+02  4.23231374e+02
  4.23231374e+02  1.27645451e+03  1.27645451e+03  1.27645451e+03
  1.91508877e+03  2.97826382e+03  2.97826382e+03  2.97826382e+03
  6.60712628e+03  6.60712628e+03  6.60712628e+03  8.27327404e+03
  2.46609417e+04  7.54571767e+04]
E1 = -727.4344876009698  E_coul = 201.89871287065364
cycle= 1 E= -525.535774730316  delta_E= -1.71e-12  |g|= 1.36e-07  |ddm|= 2.65e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4344876009698  E_coul = 201.89871287065364
  HOMO = -0.574628617232832  LUMO = 0.786144827617561
  mo_energy =
[-1.18093896e+02 -1.21765677e+01 -9.52377409e+00 -9.52377409e+00
 -9.52377409e+00 -1.25285944e+00 -5.74628617e-01 -5.74628617e-01
 -5.74628617e-01  7.86144828e-01  7.86144828e-01  7.86144828e-01
  4.89756863e+00  4.89756863e+00  4.89756863e+00  2.19341111e+01
  2.19341111e+01  2.19341111e+01  9.20894940e+01  9.20894940e+01
  9.20894940e+01  1.83450784e+02  4.23231373e+02  4.23231373e+02
  4.23231373e+02  1.27645451e+03  1.27645451e+03  1.27645451e+03
  1.91508877e+03  2.97826382e+03  2.97826382e+03  2.97826382e+03
  6.60712628e+03  6.60712628e+03  6.60712628e+03  8.27327404e+03
  2.46609417e+04  7.54571767e+04]
E1 = -727.4344881587214  E_coul = 201.89871342840667
Extra cycle  E= -525.535774730315  delta_E= 1.48e-12  |g|= 2.94e-08  |ddm|= 4.97e-08
    CPU time for scf_cycle      1.87 sec, wall time      0.32 sec
exp = [2.61825080e+04 7.61824952e+03 3.61824825e+03 1.61821187e+03
 2.39749878e+02 5.21623251e+01 4.60524707e+00 3.99660528e-01
 1.36279294e+03 6.65179647e+02 3.03314864e+02 3.16141366e+02
 4.92931648e+01 5.23892628e+00 1.48630595e+01 6.27868990e-01
 2.01510324e+00 1.90624496e-01]
grad_E = [-1.98712571e-06  2.20868671e-05  4.44127334e-05  6.79833141e-04
 -5.15230831e-05  6.17771923e-06  1.87509706e-03  6.53665349e-03
  1.11539672e-06  1.83623963e-05  9.80415585e-05  8.63796359e-05
  6.13785249e-04 -1.87912050e-03 -9.02366356e-03 -3.35559196e-02
  9.11542141e-03  1.77905065e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:14 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5080141        1
[INPUT] 0    0    [1    /1   ]  7618.24897693        1
[INPUT] 0    0    [1    /1   ]  3618.24716704        1
[INPUT] 0    0    [1    /1   ]  1618.1952493         1
[INPUT] 0    0    [1    /1   ]  239.741802844        1
[INPUT] 0    0    [1    /1   ]  52.2289595473        1
[INPUT] 0    0    [1    /1   ]  4.60985803281        1
[INPUT] 0    0    [1    /1   ]  0.399895295815       1
[INPUT] 1    0    [1    /1   ]  1362.79291075        1
[INPUT] 1    0    [1    /1   ]  665.179205428        1
[INPUT] 1    0    [1    /1   ]  303.312515539        1
[INPUT] 1    0    [1    /1   ]  316.139297113        1
[INPUT] 1    0    [1    /1   ]  49.272439364         1
[INPUT] 1    0    [1    /1   ]  5.34624545862        1
[INPUT] 1    0    [1    /1   ]  15.059674388         1
[INPUT] 1    0    [1    /1   ]  0.637115046952       1
[INPUT] 1    0    [1    /1   ]  2.0986994782         1
[INPUT] 1    0    [1    /1   ]  0.192371419189       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508014079336, 1.0]], [0, [7618.248976929575, 1.0]], [0, [3618.2471670395666, 1.0]], [0, [1618.195249300645, 1.0]], [0, [239.74180284353818, 1.0]], [0, [52.22895954727346, 1.0]], [0, [4.609858032805922, 1.0]], [0, [0.3998952958151589, 1.0]], [1, [1362.7929107542882, 1.0]], [1, [665.1792054282313, 1.0]], [1, [303.31251553932225, 1.0]], [1, [316.13929711349493, 1.0]], [1, [49.27243936399411, 1.0]], [1, [5.34624545862071, 1.0]], [1, [15.059674388008261, 1.0]], [1, [0.6371150469516162, 1.0]], [1, [2.0986994781986033, 1.0]], [1, [0.19237141918875308, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50801408]
bas 1, expnt(s) = [7618.24897693]
bas 2, expnt(s) = [3618.24716704]
bas 3, expnt(s) = [1618.1952493]
bas 4, expnt(s) = [239.74180284]
bas 5, expnt(s) = [52.22895955]
bas 6, expnt(s) = [4.60985803]
bas 7, expnt(s) = [0.3998953]
bas 8, expnt(s) = [1362.79291075]
bas 9, expnt(s) = [665.17920543]
bas 10, expnt(s) = [303.31251554]
bas 11, expnt(s) = [316.13929711]
bas 12, expnt(s) = [49.27243936]
bas 13, expnt(s) = [5.34624546]
bas 14, expnt(s) = [15.05967439]
bas 15, expnt(s) = [0.63711505]
bas 16, expnt(s) = [2.09869948]
bas 17, expnt(s) = [0.19237142]
CPU time:       111.90
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825080e+04 5.20024084e+03 7.61824898e+03 2.06018583e+03
 3.61824717e+03 1.17866041e+03 1.61819525e+03 6.44596905e+02
 2.39741803e+02 1.53929851e+02 5.22289595e+01 4.90849728e+01
 4.60985803e+00 7.94841780e+00 3.99895296e-01 1.27050022e+00
 1.36279291e+03 2.41558167e+04 6.65179205e+02 9.85502482e+03
 3.03312516e+02 3.69272789e+03 3.16139297e+02 3.88895123e+03
 4.92724394e+01 3.80837295e+02 5.34624546e+00 2.37162222e+01
 1.50596744e+01 8.65473690e+01 6.37115047e-01 1.66056821e+00
 2.09869948e+00 7.36923168e+00 1.92371419e-01 3.71672200e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97697037627467
cond(S) = 84891.23300336354
E1 = -727.5603061165122  E_coul = 203.15763617258398
init E= -524.402669943928
    CPU time for initialize scf      0.66 sec, wall time      0.08 sec
  HOMO = -0.559864750752491  LUMO = 0.804085781329296
  mo_energy =
[-1.17864329e+02 -1.20927584e+01 -9.44086114e+00 -9.44086114e+00
 -9.44086114e+00 -1.22987651e+00 -5.59864751e-01 -5.59864751e-01
 -5.59864751e-01  8.04085781e-01  8.04085781e-01  8.04085781e-01
  5.11573955e+00  5.11573955e+00  5.11573955e+00  2.27006856e+01
  2.27006856e+01  2.27006856e+01  9.34397466e+01  9.34397466e+01
  9.34397466e+01  1.83827968e+02  4.24528501e+02  4.24528501e+02
  4.24528501e+02  1.27765867e+03  1.27765867e+03  1.27765867e+03
  1.91568826e+03  2.97944927e+03  2.97944927e+03  2.97944927e+03
  6.60834301e+03  6.60834301e+03  6.60834301e+03  8.27396192e+03
  2.46616899e+04  7.54579943e+04]
E1 = -727.2650862725739  E_coul = 201.72839298985866
cycle= 1 E= -525.536693282715  delta_E= -1.13  |g|= 0.185  |ddm|= 0.424
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.454513
diis-c [-0.20658205  1.        ]
  HOMO = -0.576819458785785  LUMO = 0.797850647771905
  mo_energy =
[-1.18117365e+02 -1.21901028e+01 -9.53671696e+00 -9.53671696e+00
 -9.53671696e+00 -1.25619726e+00 -5.76819459e-01 -5.76819459e-01
 -5.76819459e-01  7.97850648e-01  7.97850648e-01  7.97850648e-01
  5.07255335e+00  5.07255335e+00  5.07255335e+00  2.26137012e+01
  2.26137012e+01  2.26137012e+01  9.32845566e+01  9.32845566e+01
  9.32845566e+01  1.83626786e+02  4.24289449e+02  4.24289449e+02
  4.24289449e+02  1.27737150e+03  1.27737150e+03  1.27737150e+03
  1.91528409e+03  2.97910301e+03  2.97910301e+03  2.97910301e+03
  6.60788331e+03  6.60788331e+03  6.60788331e+03  8.27342116e+03
  2.46610561e+04  7.54572698e+04]
E1 = -727.4970280423871  E_coul = 201.9601307142396
cycle= 2 E= -525.536897328147  delta_E= -0.000204  |g|= 0.0162  |ddm|= 0.016
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0319443
diis-c [-7.99986120e-04  3.16930106e-02  9.68306989e-01]
  HOMO = -0.573667050541398  LUMO = 0.799678600923171
  mo_energy =
[-1.18084971e+02 -1.21737504e+01 -9.52012580e+00 -9.52012580e+00
 -9.52012580e+00 -1.25196062e+00 -5.73667051e-01 -5.73667051e-01
 -5.73667051e-01  7.99678601e-01  7.99678601e-01  7.99678601e-01
  5.07971393e+00  5.07971393e+00  5.07971393e+00  2.26282890e+01
  2.26282890e+01  2.26282890e+01  9.33087755e+01  9.33087755e+01
  9.33087755e+01  1.83657944e+02  4.24321417e+02  4.24321417e+02
  4.24321417e+02  1.27740567e+03  1.27740567e+03  1.27740567e+03
  1.91531971e+03  2.97913823e+03  2.97913823e+03  2.97913823e+03
  6.60791913e+03  6.60791913e+03  6.60791913e+03  8.27345723e+03
  2.46610922e+04  7.54573058e+04]
E1 = -727.4474097240495  E_coul = 201.91050498385204
cycle= 3 E= -525.536904740198  delta_E= -7.41e-06  |g|= 0.00237  |ddm|= 0.00423
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00481937
diis-c [-1.16317081e-07 -7.30923304e-04  1.26913205e-01  8.73817718e-01]
  HOMO = -0.574304098165233  LUMO = 0.799312815175718
  mo_energy =
[-1.18089534e+02 -1.21763686e+01 -9.52279117e+00 -9.52279117e+00
 -9.52279117e+00 -1.25279590e+00 -5.74304098e-01 -5.74304098e-01
 -5.74304098e-01  7.99312815e-01  7.99312815e-01  7.99312815e-01
  5.07839334e+00  5.07839334e+00  5.07839334e+00  2.26259098e+01
  2.26259098e+01  2.26259098e+01  9.33051966e+01  9.33051966e+01
  9.33051966e+01  1.83653577e+02  4.24316912e+02  4.24316912e+02
  4.24316912e+02  1.27740090e+03  1.27740090e+03  1.27740090e+03
  1.91531471e+03  2.97913331e+03  2.97913331e+03  2.97913331e+03
  6.60791408e+03  6.60791408e+03  6.60791408e+03  8.27345210e+03
  2.46610870e+04  7.54573006e+04]
E1 = -727.4550225189988  E_coul = 201.91811755298593
cycle= 4 E= -525.536904966013  delta_E= -2.26e-07  |g|= 4.23e-05  |ddm|= 0.000675
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.70732e-05
diis-c [-3.50053596e-10 -2.90068654e-05  4.79943688e-03  4.73772432e-02
  9.47852327e-01]
  HOMO = -0.574280760354653  LUMO = 0.79932589762517
  mo_energy =
[-1.18089439e+02 -1.21762896e+01 -9.52271137e+00 -9.52271137e+00
 -9.52271137e+00 -1.25276516e+00 -5.74280760e-01 -5.74280760e-01
 -5.74280760e-01  7.99325898e-01  7.99325898e-01  7.99325898e-01
  5.07843932e+00  5.07843932e+00  5.07843932e+00  2.26259821e+01
  2.26259821e+01  2.26259821e+01  9.33052842e+01  9.33052842e+01
  9.33052842e+01  1.83653671e+02  4.24317007e+02  4.24317007e+02
  4.24317007e+02  1.27740099e+03  1.27740099e+03  1.27740099e+03
  1.91531481e+03  2.97913340e+03  2.97913340e+03  2.97913340e+03
  6.60791417e+03  6.60791417e+03  6.60791417e+03  8.27345219e+03
  2.46610871e+04  7.54573007e+04]
E1 = -727.4548090399776  E_coul = 201.91790407379708
cycle= 5 E= -525.53690496618  delta_E= -1.68e-10  |g|= 2.27e-06  |ddm|= 2.35e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4548090399776  E_coul = 201.91790407379708
  HOMO = -0.574282234526914  LUMO = 0.79932505058528
  mo_energy =
[-1.18089445e+02 -1.21762941e+01 -9.52271584e+00 -9.52271584e+00
 -9.52271584e+00 -1.25276703e+00 -5.74282235e-01 -5.74282235e-01
 -5.74282235e-01  7.99325051e-01  7.99325051e-01  7.99325051e-01
  5.07843659e+00  5.07843659e+00  5.07843659e+00  2.26259780e+01
  2.26259780e+01  2.26259780e+01  9.33052790e+01  9.33052790e+01
  9.33052790e+01  1.83653666e+02  4.24317001e+02  4.24317001e+02
  4.24317001e+02  1.27740098e+03  1.27740098e+03  1.27740098e+03
  1.91531480e+03  2.97913339e+03  2.97913339e+03  2.97913339e+03
  6.60791417e+03  6.60791417e+03  6.60791417e+03  8.27345219e+03
  2.46610871e+04  7.54573007e+04]
E1 = -727.4548205241343  E_coul = 201.91791555795442
Extra cycle  E= -525.53690496618  delta_E= 5.68e-13  |g|= 5.54e-07  |ddm|= 1.06e-06
    CPU time for scf_cycle      0.86 sec, wall time      0.27 sec
exp = [2.61825080e+04 7.61824898e+03 3.61824717e+03 1.61819525e+03
 2.39741803e+02 5.22289595e+01 4.60985803e+00 3.99895296e-01
 1.36279291e+03 6.65179205e+02 3.03312516e+02 3.16139297e+02
 4.92724394e+01 5.34624546e+00 1.50596744e+01 6.37115047e-01
 2.09869948e+00 1.92371419e-01]
E = -525.5369049661799
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5080141        1
[INPUT] 0    0    [1    /1   ]  7618.24897693        1
[INPUT] 0    0    [1    /1   ]  3618.24716704        1
[INPUT] 0    0    [1    /1   ]  1618.1952493         1
[INPUT] 0    0    [1    /1   ]  239.741802844        1
[INPUT] 0    0    [1    /1   ]  52.2289595473        1
[INPUT] 0    0    [1    /1   ]  4.60985803281        1
[INPUT] 0    0    [1    /1   ]  0.399895295815       1
[INPUT] 1    0    [1    /1   ]  1362.79291075        1
[INPUT] 1    0    [1    /1   ]  665.179205428        1
[INPUT] 1    0    [1    /1   ]  303.312515539        1
[INPUT] 1    0    [1    /1   ]  316.139297113        1
[INPUT] 1    0    [1    /1   ]  49.272439364         1
[INPUT] 1    0    [1    /1   ]  5.34624545862        1
[INPUT] 1    0    [1    /1   ]  15.059674388         1
[INPUT] 1    0    [1    /1   ]  0.637115046952       1
[INPUT] 1    0    [1    /1   ]  2.0986994782         1
[INPUT] 1    0    [1    /1   ]  0.192371419189       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508014079336, 1.0]], [0, [7618.248976929575, 1.0]], [0, [3618.2471670395666, 1.0]], [0, [1618.195249300645, 1.0]], [0, [239.74180284353818, 1.0]], [0, [52.22895954727346, 1.0]], [0, [4.609858032805922, 1.0]], [0, [0.3998952958151589, 1.0]], [1, [1362.7929107542882, 1.0]], [1, [665.1792054282313, 1.0]], [1, [303.31251553932225, 1.0]], [1, [316.13929711349493, 1.0]], [1, [49.27243936399411, 1.0]], [1, [5.34624545862071, 1.0]], [1, [15.059674388008261, 1.0]], [1, [0.6371150469516162, 1.0]], [1, [2.0986994781986033, 1.0]], [1, [0.19237141918875308, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50801408]
bas 1, expnt(s) = [7618.24897693]
bas 2, expnt(s) = [3618.24716704]
bas 3, expnt(s) = [1618.1952493]
bas 4, expnt(s) = [239.74180284]
bas 5, expnt(s) = [52.22895955]
bas 6, expnt(s) = [4.60985803]
bas 7, expnt(s) = [0.3998953]
bas 8, expnt(s) = [1362.79291075]
bas 9, expnt(s) = [665.17920543]
bas 10, expnt(s) = [303.31251554]
bas 11, expnt(s) = [316.13929711]
bas 12, expnt(s) = [49.27243936]
bas 13, expnt(s) = [5.34624546]
bas 14, expnt(s) = [15.05967439]
bas 15, expnt(s) = [0.63711505]
bas 16, expnt(s) = [2.09869948]
bas 17, expnt(s) = [0.19237142]
CPU time:       112.91
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825080e+04 5.20024084e+03 7.61824898e+03 2.06018583e+03
 3.61824717e+03 1.17866041e+03 1.61819525e+03 6.44596905e+02
 2.39741803e+02 1.53929851e+02 5.22289595e+01 4.90849728e+01
 4.60985803e+00 7.94841780e+00 3.99895296e-01 1.27050022e+00
 1.36279291e+03 2.41558167e+04 6.65179205e+02 9.85502482e+03
 3.03312516e+02 3.69272789e+03 3.16139297e+02 3.88895123e+03
 4.92724394e+01 3.80837295e+02 5.34624546e+00 2.37162222e+01
 1.50596744e+01 8.65473690e+01 6.37115047e-01 1.66056821e+00
 2.09869948e+00 7.36923168e+00 1.92371419e-01 3.71672200e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97697037627467
cond(S) = 84891.23300336354
E1 = -727.5603061165122  E_coul = 203.15763617258398
init E= -524.402669943928
    CPU time for initialize scf      0.38 sec, wall time      0.08 sec
  HOMO = -0.559864750752491  LUMO = 0.804085781329296
  mo_energy =
[-1.17864329e+02 -1.20927584e+01 -9.44086114e+00 -9.44086114e+00
 -9.44086114e+00 -1.22987651e+00 -5.59864751e-01 -5.59864751e-01
 -5.59864751e-01  8.04085781e-01  8.04085781e-01  8.04085781e-01
  5.11573955e+00  5.11573955e+00  5.11573955e+00  2.27006856e+01
  2.27006856e+01  2.27006856e+01  9.34397466e+01  9.34397466e+01
  9.34397466e+01  1.83827968e+02  4.24528501e+02  4.24528501e+02
  4.24528501e+02  1.27765867e+03  1.27765867e+03  1.27765867e+03
  1.91568826e+03  2.97944927e+03  2.97944927e+03  2.97944927e+03
  6.60834301e+03  6.60834301e+03  6.60834301e+03  8.27396192e+03
  2.46616899e+04  7.54579943e+04]
E1 = -727.2650862725739  E_coul = 201.72839298985866
cycle= 1 E= -525.536693282715  delta_E= -1.13  |g|= 0.185  |ddm|= 0.424
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.454513
diis-c [-0.20658205  1.        ]
  HOMO = -0.576819458785785  LUMO = 0.797850647771905
  mo_energy =
[-1.18117365e+02 -1.21901028e+01 -9.53671696e+00 -9.53671696e+00
 -9.53671696e+00 -1.25619726e+00 -5.76819459e-01 -5.76819459e-01
 -5.76819459e-01  7.97850648e-01  7.97850648e-01  7.97850648e-01
  5.07255335e+00  5.07255335e+00  5.07255335e+00  2.26137012e+01
  2.26137012e+01  2.26137012e+01  9.32845566e+01  9.32845566e+01
  9.32845566e+01  1.83626786e+02  4.24289449e+02  4.24289449e+02
  4.24289449e+02  1.27737150e+03  1.27737150e+03  1.27737150e+03
  1.91528409e+03  2.97910301e+03  2.97910301e+03  2.97910301e+03
  6.60788331e+03  6.60788331e+03  6.60788331e+03  8.27342116e+03
  2.46610561e+04  7.54572698e+04]
E1 = -727.4970280423871  E_coul = 201.9601307142396
cycle= 2 E= -525.536897328147  delta_E= -0.000204  |g|= 0.0162  |ddm|= 0.016
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0319443
diis-c [-7.99986120e-04  3.16930106e-02  9.68306989e-01]
  HOMO = -0.573667050541398  LUMO = 0.799678600923171
  mo_energy =
[-1.18084971e+02 -1.21737504e+01 -9.52012580e+00 -9.52012580e+00
 -9.52012580e+00 -1.25196062e+00 -5.73667051e-01 -5.73667051e-01
 -5.73667051e-01  7.99678601e-01  7.99678601e-01  7.99678601e-01
  5.07971393e+00  5.07971393e+00  5.07971393e+00  2.26282890e+01
  2.26282890e+01  2.26282890e+01  9.33087755e+01  9.33087755e+01
  9.33087755e+01  1.83657944e+02  4.24321417e+02  4.24321417e+02
  4.24321417e+02  1.27740567e+03  1.27740567e+03  1.27740567e+03
  1.91531971e+03  2.97913823e+03  2.97913823e+03  2.97913823e+03
  6.60791913e+03  6.60791913e+03  6.60791913e+03  8.27345723e+03
  2.46610922e+04  7.54573058e+04]
E1 = -727.4474097240495  E_coul = 201.91050498385204
cycle= 3 E= -525.536904740198  delta_E= -7.41e-06  |g|= 0.00237  |ddm|= 0.00423
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00481937
diis-c [-1.16317081e-07 -7.30923304e-04  1.26913205e-01  8.73817718e-01]
  HOMO = -0.574304098165233  LUMO = 0.799312815175718
  mo_energy =
[-1.18089534e+02 -1.21763686e+01 -9.52279117e+00 -9.52279117e+00
 -9.52279117e+00 -1.25279590e+00 -5.74304098e-01 -5.74304098e-01
 -5.74304098e-01  7.99312815e-01  7.99312815e-01  7.99312815e-01
  5.07839334e+00  5.07839334e+00  5.07839334e+00  2.26259098e+01
  2.26259098e+01  2.26259098e+01  9.33051966e+01  9.33051966e+01
  9.33051966e+01  1.83653577e+02  4.24316912e+02  4.24316912e+02
  4.24316912e+02  1.27740090e+03  1.27740090e+03  1.27740090e+03
  1.91531471e+03  2.97913331e+03  2.97913331e+03  2.97913331e+03
  6.60791408e+03  6.60791408e+03  6.60791408e+03  8.27345210e+03
  2.46610870e+04  7.54573006e+04]
E1 = -727.4550225189988  E_coul = 201.91811755298593
cycle= 4 E= -525.536904966013  delta_E= -2.26e-07  |g|= 4.23e-05  |ddm|= 0.000675
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.70732e-05
diis-c [-3.50053596e-10 -2.90068654e-05  4.79943688e-03  4.73772432e-02
  9.47852327e-01]
  HOMO = -0.574280760354653  LUMO = 0.79932589762517
  mo_energy =
[-1.18089439e+02 -1.21762896e+01 -9.52271137e+00 -9.52271137e+00
 -9.52271137e+00 -1.25276516e+00 -5.74280760e-01 -5.74280760e-01
 -5.74280760e-01  7.99325898e-01  7.99325898e-01  7.99325898e-01
  5.07843932e+00  5.07843932e+00  5.07843932e+00  2.26259821e+01
  2.26259821e+01  2.26259821e+01  9.33052842e+01  9.33052842e+01
  9.33052842e+01  1.83653671e+02  4.24317007e+02  4.24317007e+02
  4.24317007e+02  1.27740099e+03  1.27740099e+03  1.27740099e+03
  1.91531481e+03  2.97913340e+03  2.97913340e+03  2.97913340e+03
  6.60791417e+03  6.60791417e+03  6.60791417e+03  8.27345219e+03
  2.46610871e+04  7.54573007e+04]
E1 = -727.4548090399776  E_coul = 201.91790407379708
cycle= 5 E= -525.53690496618  delta_E= -1.68e-10  |g|= 2.27e-06  |ddm|= 2.35e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4548090399776  E_coul = 201.91790407379708
  HOMO = -0.574282234526914  LUMO = 0.79932505058528
  mo_energy =
[-1.18089445e+02 -1.21762941e+01 -9.52271584e+00 -9.52271584e+00
 -9.52271584e+00 -1.25276703e+00 -5.74282235e-01 -5.74282235e-01
 -5.74282235e-01  7.99325051e-01  7.99325051e-01  7.99325051e-01
  5.07843659e+00  5.07843659e+00  5.07843659e+00  2.26259780e+01
  2.26259780e+01  2.26259780e+01  9.33052790e+01  9.33052790e+01
  9.33052790e+01  1.83653666e+02  4.24317001e+02  4.24317001e+02
  4.24317001e+02  1.27740098e+03  1.27740098e+03  1.27740098e+03
  1.91531480e+03  2.97913339e+03  2.97913339e+03  2.97913339e+03
  6.60791417e+03  6.60791417e+03  6.60791417e+03  8.27345219e+03
  2.46610871e+04  7.54573007e+04]
E1 = -727.4548205241343  E_coul = 201.91791555795442
Extra cycle  E= -525.53690496618  delta_E= 5.68e-13  |g|= 5.54e-07  |ddm|= 1.06e-06
    CPU time for scf_cycle      0.58 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 84891.23300336354
E1 = -727.4548205241343  E_coul = 201.91791555795442
init E= -525.53690496618
    CPU time for initialize scf      1.10 sec, wall time      0.20 sec
  HOMO = -0.574282018496805  LUMO = 0.79932517258609
  mo_energy =
[-1.18089444e+02 -1.21762932e+01 -9.52271497e+00 -9.52271497e+00
 -9.52271497e+00 -1.25276675e+00 -5.74282018e-01 -5.74282018e-01
 -5.74282018e-01  7.99325173e-01  7.99325173e-01  7.99325173e-01
  5.07843703e+00  5.07843703e+00  5.07843703e+00  2.26259788e+01
  2.26259788e+01  2.26259788e+01  9.33052801e+01  9.33052801e+01
  9.33052801e+01  1.83653667e+02  4.24317002e+02  4.24317002e+02
  4.24317002e+02  1.27740099e+03  1.27740099e+03  1.27740099e+03
  1.91531480e+03  2.97913340e+03  2.97913340e+03  2.97913340e+03
  6.60791417e+03  6.60791417e+03  6.60791417e+03  8.27345219e+03
  2.46610871e+04  7.54573007e+04]
E1 = -727.4548180620232  E_coul = 201.91791309584417
cycle= 1 E= -525.536904966179  delta_E= 9.09e-13  |g|= 1.26e-07  |ddm|= 2.43e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4548180620232  E_coul = 201.91791309584417
  HOMO = -0.574282065298837  LUMO = 0.799325145760598
  mo_energy =
[-1.18089444e+02 -1.21762934e+01 -9.52271515e+00 -9.52271515e+00
 -9.52271515e+00 -1.25276681e+00 -5.74282065e-01 -5.74282065e-01
 -5.74282065e-01  7.99325146e-01  7.99325146e-01  7.99325146e-01
  5.07843694e+00  5.07843694e+00  5.07843694e+00  2.26259786e+01
  2.26259786e+01  2.26259786e+01  9.33052799e+01  9.33052799e+01
  9.33052799e+01  1.83653667e+02  4.24317002e+02  4.24317002e+02
  4.24317002e+02  1.27740099e+03  1.27740099e+03  1.27740099e+03
  1.91531480e+03  2.97913340e+03  2.97913340e+03  2.97913340e+03
  6.60791417e+03  6.60791417e+03  6.60791417e+03  8.27345219e+03
  2.46610871e+04  7.54573007e+04]
E1 = -727.4548185777426  E_coul = 201.91791361156174
Extra cycle  E= -525.536904966181  delta_E= -1.82e-12  |g|= 2.72e-08  |ddm|= 4.67e-08
    CPU time for scf_cycle      1.22 sec, wall time      0.32 sec
exp = [2.61825080e+04 7.61824898e+03 3.61824717e+03 1.61819525e+03
 2.39741803e+02 5.22289595e+01 4.60985803e+00 3.99895296e-01
 1.36279291e+03 6.65179205e+02 3.03312516e+02 3.16139297e+02
 4.92724394e+01 5.34624546e+00 1.50596744e+01 6.37115047e-01
 2.09869948e+00 1.92371419e-01]
grad_E = [-1.98744436e-06  2.21792545e-05  4.46943086e-05  6.83310350e-04
 -3.01180392e-04  1.79583176e-03  6.24022195e-03  8.77833531e-03
  1.28905500e-06  1.96267413e-05  1.05788366e-04  9.32029695e-05
 -3.33383489e-04 -5.55250543e-03 -5.08515414e-03 -3.88089129e-02
  1.20412422e-02  2.07433283e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:18 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.508072         1
[INPUT] 0    0    [1    /1   ]  7618.24833628        1
[INPUT] 0    0    [1    /1   ]  3618.2458824         1
[INPUT] 0    0    [1    /1   ]  1618.17555378        1
[INPUT] 0    0    [1    /1   ]  239.733937149        1
[INPUT] 0    0    [1    /1   ]  52.2957253511        1
[INPUT] 0    0    [1    /1   ]  4.61069929813        1
[INPUT] 0    0    [1    /1   ]  0.399722353771       1
[INPUT] 1    0    [1    /1   ]  1362.79287991        1
[INPUT] 1    0    [1    /1   ]  665.178682314        1
[INPUT] 1    0    [1    /1   ]  303.309731418        1
[INPUT] 1    0    [1    /1   ]  316.13684419         1
[INPUT] 1    0    [1    /1   ]  49.2477294798        1
[INPUT] 1    0    [1    /1   ]  5.46026350003        1
[INPUT] 1    0    [1    /1   ]  15.3047769075        1
[INPUT] 1    0    [1    /1   ]  0.652811388112       1
[INPUT] 1    0    [1    /1   ]  2.14631127265        1
[INPUT] 1    0    [1    /1   ]  0.196549056618       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508072016702, 1.0]], [0, [7618.24833628332, 1.0]], [0, [3618.2458824007836, 1.0]], [0, [1618.1755537777178, 1.0]], [0, [239.7339371489343, 1.0]], [0, [52.295725351089146, 1.0]], [0, [4.6106992981342785, 1.0]], [0, [0.3997223537709332, 1.0]], [1, [1362.792879914254, 1.0]], [1, [665.1786823143615, 1.0]], [1, [303.3097314184975, 1.0]], [1, [316.13684418995695, 1.0]], [1, [49.2477294798064, 1.0]], [1, [5.460263500030897, 1.0]], [1, [15.30477690748688, 1.0]], [1, [0.6528113881115511, 1.0]], [1, [2.146311272651402, 1.0]], [1, [0.1965490566179627, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50807202]
bas 1, expnt(s) = [7618.24833628]
bas 2, expnt(s) = [3618.2458824]
bas 3, expnt(s) = [1618.17555378]
bas 4, expnt(s) = [239.73393715]
bas 5, expnt(s) = [52.29572535]
bas 6, expnt(s) = [4.6106993]
bas 7, expnt(s) = [0.39972235]
bas 8, expnt(s) = [1362.79287991]
bas 9, expnt(s) = [665.17868231]
bas 10, expnt(s) = [303.30973142]
bas 11, expnt(s) = [316.13684419]
bas 12, expnt(s) = [49.24772948]
bas 13, expnt(s) = [5.4602635]
bas 14, expnt(s) = [15.30477691]
bas 15, expnt(s) = [0.65281139]
bas 16, expnt(s) = [2.14631127]
bas 17, expnt(s) = [0.19654906]
CPU time:       118.59
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825081e+04 5.20024085e+03 7.61824834e+03 2.06018570e+03
 3.61824588e+03 1.17866010e+03 1.61817555e+03 6.44591020e+02
 2.39733937e+02 1.53926063e+02 5.22957254e+01 4.91320254e+01
 4.61069930e+00 7.94950567e+00 3.99722354e-01 1.27008811e+00
 1.36279288e+03 2.41558160e+04 6.65178682e+02 9.85501514e+03
 3.03309731e+02 3.69268552e+03 3.16136844e+02 3.88891351e+03
 4.92477295e+01 3.80598575e+02 5.46026350e+00 2.43501362e+01
 1.53047769e+01 8.83116800e+01 6.52811388e-01 1.71186316e+00
 2.14631127e+00 7.57879702e+00 1.96549057e-01 3.81788724e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.976685783210414
cond(S) = 85195.29011628652
E1 = -727.5538819093159  E_coul = 203.15974905350208
init E= -524.394132855814
    CPU time for initialize scf      0.69 sec, wall time      0.08 sec
  HOMO = -0.559865980376103  LUMO = 0.83084017663441
  mo_energy =
[-1.17863230e+02 -1.20932322e+01 -9.44088551e+00 -9.44088551e+00
 -9.44088551e+00 -1.22995324e+00 -5.59865980e-01 -5.59865980e-01
 -5.59865980e-01  8.30840177e-01  8.30840177e-01  8.30840177e-01
  5.28103705e+00  5.28103705e+00  5.28103705e+00  2.33401225e+01
  2.33401225e+01  2.33401225e+01  9.47090131e+01  9.47090131e+01
  9.47090131e+01  1.84011566e+02  4.25706238e+02  4.25706238e+02
  4.25706238e+02  1.27868877e+03  1.27868877e+03  1.27868877e+03
  1.91589546e+03  2.98039482e+03  2.98039482e+03  2.98039482e+03
  6.60919814e+03  6.60919814e+03  6.60919814e+03  8.27411700e+03
  2.46618085e+04  7.54580903e+04]
E1 = -727.2932464961993  E_coul = 201.75532239164914
cycle= 1 E= -525.53792410455  delta_E= -1.14  |g|= 0.186  |ddm|= 0.53
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.453145
diis-c [-0.20534005  1.        ]
  HOMO = -0.576255019198682  LUMO = 0.824541549932101
  mo_energy =
[-1.18112601e+02 -1.21891176e+01 -9.53512535e+00 -9.53512535e+00
 -9.53512535e+00 -1.25556024e+00 -5.76255019e-01 -5.76255019e-01
 -5.76255019e-01  8.24541550e-01  8.24541550e-01  8.24541550e-01
  5.23805055e+00  5.23805055e+00  5.23805055e+00  2.32538738e+01
  2.32538738e+01  2.32538738e+01  9.45563540e+01  9.45563540e+01
  9.45563540e+01  1.83813679e+02  4.25471118e+02  4.25471118e+02
  4.25471118e+02  1.27840636e+03  1.27840636e+03  1.27840636e+03
  1.91549740e+03  2.98005412e+03  2.98005412e+03  2.98005412e+03
  6.60874475e+03  6.60874475e+03  6.60874475e+03  8.27358303e+03
  2.46611818e+04  7.54573730e+04]
E1 = -727.5188397859155  E_coul = 201.98071964222433
cycle= 2 E= -525.538120143691  delta_E= -0.000196  |g|= 0.0158  |ddm|= 0.0155
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0314132
diis-c [-7.81465840e-04  3.07090749e-02  9.69290925e-01]
  HOMO = -0.573212321881671  LUMO = 0.82636913402554
  mo_energy =
[-1.18080934e+02 -1.21731996e+01 -9.51897565e+00 -9.51897565e+00
 -9.51897565e+00 -1.25146886e+00 -5.73212322e-01 -5.73212322e-01
 -5.73212322e-01  8.26369134e-01  8.26369134e-01  8.26369134e-01
  5.24512245e+00  5.24512245e+00  5.24512245e+00  2.32682068e+01
  2.32682068e+01  2.32682068e+01  9.45800036e+01  9.45800036e+01
  9.45800036e+01  1.83844136e+02  4.25502357e+02  4.25502357e+02
  4.25502357e+02  1.27843977e+03  1.27843977e+03  1.27843977e+03
  1.91553226e+03  2.98008857e+03  2.98008857e+03  2.98008857e+03
  6.60877981e+03  6.60877981e+03  6.60877981e+03  8.27361833e+03
  2.46612172e+04  7.54574082e+04]
E1 = -727.4706378895103  E_coul = 201.93251071555332
cycle= 3 E= -525.538127173957  delta_E= -7.03e-06  |g|= 0.00233  |ddm|= 0.00413
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00474854
diis-c [-1.10532997e-07 -7.22103395e-04  1.27209278e-01  8.73512825e-01]
  HOMO = -0.573831258895625  LUMO = 0.826001659111664
  mo_energy =
[-1.18085407e+02 -1.21757576e+01 -9.52157971e+00 -9.52157971e+00
 -9.52157971e+00 -1.25228067e+00 -5.73831259e-01 -5.73831259e-01
 -5.73831259e-01  8.26001659e-01  8.26001659e-01  8.26001659e-01
  5.24381485e+00  5.24381485e+00  5.24381485e+00  2.32658649e+01
  2.32658649e+01  2.32658649e+01  9.45764989e+01  9.45764989e+01
  9.45764989e+01  1.83839856e+02  4.25497942e+02  4.25497942e+02
  4.25497942e+02  1.27843509e+03  1.27843509e+03  1.27843509e+03
  1.91552736e+03  2.98008375e+03  2.98008375e+03  2.98008375e+03
  6.60877485e+03  6.60877485e+03  6.60877485e+03  8.27361329e+03
  2.46612121e+04  7.54574031e+04]
E1 = -727.4780616333707  E_coul = 201.93993424374227
cycle= 4 E= -525.538127389628  delta_E= -2.16e-07  |g|= 4.18e-05  |ddm|= 0.000662
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.6374e-05
diis-c [-3.34743484e-10 -2.86989814e-05  4.88602496e-03  4.79515793e-02
  9.47191095e-01]
  HOMO = -0.573808302704743  LUMO = 0.826014975498853
  mo_energy =
[-1.18085313e+02 -1.21756799e+01 -9.52150120e+00 -9.52150120e+00
 -9.52150120e+00 -1.25225046e+00 -5.73808303e-01 -5.73808303e-01
 -5.73808303e-01  8.26014975e-01  8.26014975e-01  8.26014975e-01
  5.24386076e+00  5.24386076e+00  5.24386076e+00  2.32659365e+01
  2.32659365e+01  2.32659365e+01  9.45765852e+01  9.45765852e+01
  9.45765852e+01  1.83839949e+02  4.25498035e+02  4.25498035e+02
  4.25498035e+02  1.27843518e+03  1.27843518e+03  1.27843518e+03
  1.91552745e+03  2.98008384e+03  2.98008384e+03  2.98008384e+03
  6.60877494e+03  6.60877494e+03  6.60877494e+03  8.27361339e+03
  2.46612122e+04  7.54574032e+04]
E1 = -727.4778528759157  E_coul = 201.93972548612496
cycle= 5 E= -525.538127389791  delta_E= -1.62e-10  |g|= 2.17e-06  |ddm|= 2.3e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4778528759157  E_coul = 201.93972548612496
  HOMO = -0.573809704070657  LUMO = 0.826014145750956
  mo_energy =
[-1.18085319e+02 -1.21756842e+01 -9.52150548e+00 -9.52150548e+00
 -9.52150548e+00 -1.25225224e+00 -5.73809704e-01 -5.73809704e-01
 -5.73809704e-01  8.26014146e-01  8.26014146e-01  8.26014146e-01
  5.24385812e+00  5.24385812e+00  5.24385812e+00  2.32659325e+01
  2.32659325e+01  2.32659325e+01  9.45765802e+01  9.45765802e+01
  9.45765802e+01  1.83839943e+02  4.25498030e+02  4.25498030e+02
  4.25498030e+02  1.27843518e+03  1.27843518e+03  1.27843518e+03
  1.91552744e+03  2.98008383e+03  2.98008383e+03  2.98008383e+03
  6.60877494e+03  6.60877494e+03  6.60877494e+03  8.27361338e+03
  2.46612122e+04  7.54574032e+04]
E1 = -727.477863900926  E_coul = 201.9397365111355
Extra cycle  E= -525.53812738979  delta_E= 2.27e-13  |g|= 5.33e-07  |ddm|= 1.03e-06
    CPU time for scf_cycle      0.88 sec, wall time      0.27 sec
exp = [2.61825081e+04 7.61824834e+03 3.61824588e+03 1.61817555e+03
 2.39733937e+02 5.22957254e+01 4.61069930e+00 3.99722354e-01
 1.36279288e+03 6.65178682e+02 3.03309731e+02 3.16136844e+02
 4.92477295e+01 5.46026350e+00 1.53047769e+01 6.52811388e-01
 2.14631127e+00 1.96549057e-01]
E = -525.5381273897905
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:19 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.508072         1
[INPUT] 0    0    [1    /1   ]  7618.24833628        1
[INPUT] 0    0    [1    /1   ]  3618.2458824         1
[INPUT] 0    0    [1    /1   ]  1618.17555378        1
[INPUT] 0    0    [1    /1   ]  239.733937149        1
[INPUT] 0    0    [1    /1   ]  52.2957253511        1
[INPUT] 0    0    [1    /1   ]  4.61069929813        1
[INPUT] 0    0    [1    /1   ]  0.399722353771       1
[INPUT] 1    0    [1    /1   ]  1362.79287991        1
[INPUT] 1    0    [1    /1   ]  665.178682314        1
[INPUT] 1    0    [1    /1   ]  303.309731418        1
[INPUT] 1    0    [1    /1   ]  316.13684419         1
[INPUT] 1    0    [1    /1   ]  49.2477294798        1
[INPUT] 1    0    [1    /1   ]  5.46026350003        1
[INPUT] 1    0    [1    /1   ]  15.3047769075        1
[INPUT] 1    0    [1    /1   ]  0.652811388112       1
[INPUT] 1    0    [1    /1   ]  2.14631127265        1
[INPUT] 1    0    [1    /1   ]  0.196549056618       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508072016702, 1.0]], [0, [7618.24833628332, 1.0]], [0, [3618.2458824007836, 1.0]], [0, [1618.1755537777178, 1.0]], [0, [239.7339371489343, 1.0]], [0, [52.295725351089146, 1.0]], [0, [4.6106992981342785, 1.0]], [0, [0.3997223537709332, 1.0]], [1, [1362.792879914254, 1.0]], [1, [665.1786823143615, 1.0]], [1, [303.3097314184975, 1.0]], [1, [316.13684418995695, 1.0]], [1, [49.2477294798064, 1.0]], [1, [5.460263500030897, 1.0]], [1, [15.30477690748688, 1.0]], [1, [0.6528113881115511, 1.0]], [1, [2.146311272651402, 1.0]], [1, [0.1965490566179627, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50807202]
bas 1, expnt(s) = [7618.24833628]
bas 2, expnt(s) = [3618.2458824]
bas 3, expnt(s) = [1618.17555378]
bas 4, expnt(s) = [239.73393715]
bas 5, expnt(s) = [52.29572535]
bas 6, expnt(s) = [4.6106993]
bas 7, expnt(s) = [0.39972235]
bas 8, expnt(s) = [1362.79287991]
bas 9, expnt(s) = [665.17868231]
bas 10, expnt(s) = [303.30973142]
bas 11, expnt(s) = [316.13684419]
bas 12, expnt(s) = [49.24772948]
bas 13, expnt(s) = [5.4602635]
bas 14, expnt(s) = [15.30477691]
bas 15, expnt(s) = [0.65281139]
bas 16, expnt(s) = [2.14631127]
bas 17, expnt(s) = [0.19654906]
CPU time:       119.60
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825081e+04 5.20024085e+03 7.61824834e+03 2.06018570e+03
 3.61824588e+03 1.17866010e+03 1.61817555e+03 6.44591020e+02
 2.39733937e+02 1.53926063e+02 5.22957254e+01 4.91320254e+01
 4.61069930e+00 7.94950567e+00 3.99722354e-01 1.27008811e+00
 1.36279288e+03 2.41558160e+04 6.65178682e+02 9.85501514e+03
 3.03309731e+02 3.69268552e+03 3.16136844e+02 3.88891351e+03
 4.92477295e+01 3.80598575e+02 5.46026350e+00 2.43501362e+01
 1.53047769e+01 8.83116800e+01 6.52811388e-01 1.71186316e+00
 2.14631127e+00 7.57879702e+00 1.96549057e-01 3.81788724e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.976685783210414
cond(S) = 85195.29011628652
E1 = -727.5538819093159  E_coul = 203.15974905350208
init E= -524.394132855814
    CPU time for initialize scf      0.68 sec, wall time      0.08 sec
  HOMO = -0.559865980376103  LUMO = 0.83084017663441
  mo_energy =
[-1.17863230e+02 -1.20932322e+01 -9.44088551e+00 -9.44088551e+00
 -9.44088551e+00 -1.22995324e+00 -5.59865980e-01 -5.59865980e-01
 -5.59865980e-01  8.30840177e-01  8.30840177e-01  8.30840177e-01
  5.28103705e+00  5.28103705e+00  5.28103705e+00  2.33401225e+01
  2.33401225e+01  2.33401225e+01  9.47090131e+01  9.47090131e+01
  9.47090131e+01  1.84011566e+02  4.25706238e+02  4.25706238e+02
  4.25706238e+02  1.27868877e+03  1.27868877e+03  1.27868877e+03
  1.91589546e+03  2.98039482e+03  2.98039482e+03  2.98039482e+03
  6.60919814e+03  6.60919814e+03  6.60919814e+03  8.27411700e+03
  2.46618085e+04  7.54580903e+04]
E1 = -727.2932464961993  E_coul = 201.75532239164914
cycle= 1 E= -525.53792410455  delta_E= -1.14  |g|= 0.186  |ddm|= 0.53
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.453145
diis-c [-0.20534005  1.        ]
  HOMO = -0.576255019198682  LUMO = 0.824541549932101
  mo_energy =
[-1.18112601e+02 -1.21891176e+01 -9.53512535e+00 -9.53512535e+00
 -9.53512535e+00 -1.25556024e+00 -5.76255019e-01 -5.76255019e-01
 -5.76255019e-01  8.24541550e-01  8.24541550e-01  8.24541550e-01
  5.23805055e+00  5.23805055e+00  5.23805055e+00  2.32538738e+01
  2.32538738e+01  2.32538738e+01  9.45563540e+01  9.45563540e+01
  9.45563540e+01  1.83813679e+02  4.25471118e+02  4.25471118e+02
  4.25471118e+02  1.27840636e+03  1.27840636e+03  1.27840636e+03
  1.91549740e+03  2.98005412e+03  2.98005412e+03  2.98005412e+03
  6.60874475e+03  6.60874475e+03  6.60874475e+03  8.27358303e+03
  2.46611818e+04  7.54573730e+04]
E1 = -727.5188397859155  E_coul = 201.98071964222433
cycle= 2 E= -525.538120143691  delta_E= -0.000196  |g|= 0.0158  |ddm|= 0.0155
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0314132
diis-c [-7.81465840e-04  3.07090749e-02  9.69290925e-01]
  HOMO = -0.573212321881671  LUMO = 0.82636913402554
  mo_energy =
[-1.18080934e+02 -1.21731996e+01 -9.51897565e+00 -9.51897565e+00
 -9.51897565e+00 -1.25146886e+00 -5.73212322e-01 -5.73212322e-01
 -5.73212322e-01  8.26369134e-01  8.26369134e-01  8.26369134e-01
  5.24512245e+00  5.24512245e+00  5.24512245e+00  2.32682068e+01
  2.32682068e+01  2.32682068e+01  9.45800036e+01  9.45800036e+01
  9.45800036e+01  1.83844136e+02  4.25502357e+02  4.25502357e+02
  4.25502357e+02  1.27843977e+03  1.27843977e+03  1.27843977e+03
  1.91553226e+03  2.98008857e+03  2.98008857e+03  2.98008857e+03
  6.60877981e+03  6.60877981e+03  6.60877981e+03  8.27361833e+03
  2.46612172e+04  7.54574082e+04]
E1 = -727.4706378895103  E_coul = 201.93251071555332
cycle= 3 E= -525.538127173957  delta_E= -7.03e-06  |g|= 0.00233  |ddm|= 0.00413
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00474854
diis-c [-1.10532997e-07 -7.22103395e-04  1.27209278e-01  8.73512825e-01]
  HOMO = -0.573831258895625  LUMO = 0.826001659111664
  mo_energy =
[-1.18085407e+02 -1.21757576e+01 -9.52157971e+00 -9.52157971e+00
 -9.52157971e+00 -1.25228067e+00 -5.73831259e-01 -5.73831259e-01
 -5.73831259e-01  8.26001659e-01  8.26001659e-01  8.26001659e-01
  5.24381485e+00  5.24381485e+00  5.24381485e+00  2.32658649e+01
  2.32658649e+01  2.32658649e+01  9.45764989e+01  9.45764989e+01
  9.45764989e+01  1.83839856e+02  4.25497942e+02  4.25497942e+02
  4.25497942e+02  1.27843509e+03  1.27843509e+03  1.27843509e+03
  1.91552736e+03  2.98008375e+03  2.98008375e+03  2.98008375e+03
  6.60877485e+03  6.60877485e+03  6.60877485e+03  8.27361329e+03
  2.46612121e+04  7.54574031e+04]
E1 = -727.4780616333707  E_coul = 201.93993424374227
cycle= 4 E= -525.538127389628  delta_E= -2.16e-07  |g|= 4.18e-05  |ddm|= 0.000662
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.6374e-05
diis-c [-3.34743484e-10 -2.86989814e-05  4.88602496e-03  4.79515793e-02
  9.47191095e-01]
  HOMO = -0.573808302704743  LUMO = 0.826014975498853
  mo_energy =
[-1.18085313e+02 -1.21756799e+01 -9.52150120e+00 -9.52150120e+00
 -9.52150120e+00 -1.25225046e+00 -5.73808303e-01 -5.73808303e-01
 -5.73808303e-01  8.26014975e-01  8.26014975e-01  8.26014975e-01
  5.24386076e+00  5.24386076e+00  5.24386076e+00  2.32659365e+01
  2.32659365e+01  2.32659365e+01  9.45765852e+01  9.45765852e+01
  9.45765852e+01  1.83839949e+02  4.25498035e+02  4.25498035e+02
  4.25498035e+02  1.27843518e+03  1.27843518e+03  1.27843518e+03
  1.91552745e+03  2.98008384e+03  2.98008384e+03  2.98008384e+03
  6.60877494e+03  6.60877494e+03  6.60877494e+03  8.27361339e+03
  2.46612122e+04  7.54574032e+04]
E1 = -727.4778528759157  E_coul = 201.93972548612496
cycle= 5 E= -525.538127389791  delta_E= -1.62e-10  |g|= 2.17e-06  |ddm|= 2.3e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4778528759157  E_coul = 201.93972548612496
  HOMO = -0.573809704070657  LUMO = 0.826014145750956
  mo_energy =
[-1.18085319e+02 -1.21756842e+01 -9.52150548e+00 -9.52150548e+00
 -9.52150548e+00 -1.25225224e+00 -5.73809704e-01 -5.73809704e-01
 -5.73809704e-01  8.26014146e-01  8.26014146e-01  8.26014146e-01
  5.24385812e+00  5.24385812e+00  5.24385812e+00  2.32659325e+01
  2.32659325e+01  2.32659325e+01  9.45765802e+01  9.45765802e+01
  9.45765802e+01  1.83839943e+02  4.25498030e+02  4.25498030e+02
  4.25498030e+02  1.27843518e+03  1.27843518e+03  1.27843518e+03
  1.91552744e+03  2.98008383e+03  2.98008383e+03  2.98008383e+03
  6.60877494e+03  6.60877494e+03  6.60877494e+03  8.27361338e+03
  2.46612122e+04  7.54574032e+04]
E1 = -727.477863900926  E_coul = 201.9397365111355
Extra cycle  E= -525.53812738979  delta_E= 2.27e-13  |g|= 5.33e-07  |ddm|= 1.03e-06
    CPU time for scf_cycle      0.87 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 85195.29011628652
E1 = -727.477863900926  E_coul = 201.9397365111355
init E= -525.53812738979
    CPU time for initialize scf      1.14 sec, wall time      0.19 sec
  HOMO = -0.573809496255323  LUMO = 0.826014267291964
  mo_energy =
[-1.18085318e+02 -1.21756833e+01 -9.52150464e+00 -9.52150464e+00
 -9.52150464e+00 -1.25225197e+00 -5.73809496e-01 -5.73809496e-01
 -5.73809496e-01  8.26014267e-01  8.26014267e-01  8.26014267e-01
  5.24385856e+00  5.24385856e+00  5.24385856e+00  2.32659333e+01
  2.32659333e+01  2.32659333e+01  9.45765813e+01  9.45765813e+01
  9.45765813e+01  1.83839945e+02  4.25498031e+02  4.25498031e+02
  4.25498031e+02  1.27843518e+03  1.27843518e+03  1.27843518e+03
  1.91552745e+03  2.98008383e+03  2.98008383e+03  2.98008383e+03
  6.60877494e+03  6.60877494e+03  6.60877494e+03  8.27361338e+03
  2.46612122e+04  7.54574032e+04]
E1 = -727.4778615520396  E_coul = 201.93973416224975
cycle= 1 E= -525.53812738979  delta_E= 5.68e-13  |g|= 1.21e-07  |ddm|= 2.32e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4778615520396  E_coul = 201.93973416224975
  HOMO = -0.573809540673093  LUMO = 0.826014240986188
  mo_energy =
[-1.18085318e+02 -1.21756835e+01 -9.52150482e+00 -9.52150482e+00
 -9.52150482e+00 -1.25225203e+00 -5.73809541e-01 -5.73809541e-01
 -5.73809541e-01  8.26014241e-01  8.26014241e-01  8.26014241e-01
  5.24385847e+00  5.24385847e+00  5.24385847e+00  2.32659331e+01
  2.32659331e+01  2.32659331e+01  9.45765811e+01  9.45765811e+01
  9.45765811e+01  1.83839944e+02  4.25498031e+02  4.25498031e+02
  4.25498031e+02  1.27843518e+03  1.27843518e+03  1.27843518e+03
  1.91552745e+03  2.98008383e+03  2.98008383e+03  2.98008383e+03
  6.60877494e+03  6.60877494e+03  6.60877494e+03  8.27361338e+03
  2.46612122e+04  7.54574032e+04]
E1 = -727.4778620433681  E_coul = 201.93973465357732
Extra cycle  E= -525.538127389791  delta_E= -9.09e-13  |g|= 2.6e-08  |ddm|= 4.49e-08
    CPU time for scf_cycle      1.26 sec, wall time      0.31 sec
exp = [2.61825081e+04 7.61824834e+03 3.61824588e+03 1.61817555e+03
 2.39733937e+02 5.22957254e+01 4.61069930e+00 3.99722354e-01
 1.36279288e+03 6.65178682e+02 3.03309731e+02 3.16136844e+02
 4.92477295e+01 5.46026350e+00 1.53047769e+01 6.52811388e-01
 2.14631127e+00 1.96549057e-01]
grad_E = [-1.98763018e-06  2.22709167e-05  4.49754398e-05  6.86771664e-04
 -5.51197432e-04  3.59138491e-03  7.12632411e-03  6.27167890e-03
  1.50889378e-06  2.12014606e-05  1.15411836e-04  1.01689054e-04
 -1.42080074e-03 -8.79662467e-03 -8.50463386e-04 -2.89454765e-02
  1.15583601e-02  2.10134177e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5081132        1
[INPUT] 0    0    [1    /1   ]  7618.24787996        1
[INPUT] 0    0    [1    /1   ]  3618.24496648        1
[INPUT] 0    0    [1    /1   ]  1618.1615191         1
[INPUT] 0    0    [1    /1   ]  239.730643753        1
[INPUT] 0    0    [1    /1   ]  52.3267485778        1
[INPUT] 0    0    [1    /1   ]  4.60707585604        1
[INPUT] 0    0    [1    /1   ]  0.399311335786       1
[INPUT] 1    0    [1    /1   ]  1362.79285764        1
[INPUT] 1    0    [1    /1   ]  665.178307965        1
[INPUT] 1    0    [1    /1   ]  303.307737453        1
[INPUT] 1    0    [1    /1   ]  316.13508737         1
[INPUT] 1    0    [1    /1   ]  49.2308389431        1
[INPUT] 1    0    [1    /1   ]  5.52719179003        1
[INPUT] 1    0    [1    /1   ]  15.4913697307        1
[INPUT] 1    0    [1    /1   ]  0.662647646798       1
[INPUT] 1    0    [1    /1   ]  2.1168866363         1
[INPUT] 1    0    [1    /1   ]  0.199544489511       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.5081132107, 1.0]], [0, [7618.247879959805, 1.0]], [0, [3618.244966483083, 1.0]], [0, [1618.1615191048757, 1.0]], [0, [239.7306437531929, 1.0]], [0, [52.32674857782007, 1.0]], [0, [4.6070758560442595, 1.0]], [0, [0.39931133578587197, 1.0]], [1, [1362.7928576409784, 1.0]], [1, [665.178307965023, 1.0]], [1, [303.30773745282966, 1.0]], [1, [316.1350873697364, 1.0]], [1, [49.23083894305456, 1.0]], [1, [5.527191790032335, 1.0]], [1, [15.49136973070766, 1.0]], [1, [0.6626476467984808, 1.0]], [1, [2.1168866363047725, 1.0]], [1, [0.19954448951088025, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50811321]
bas 1, expnt(s) = [7618.24787996]
bas 2, expnt(s) = [3618.24496648]
bas 3, expnt(s) = [1618.1615191]
bas 4, expnt(s) = [239.73064375]
bas 5, expnt(s) = [52.32674858]
bas 6, expnt(s) = [4.60707586]
bas 7, expnt(s) = [0.39931134]
bas 8, expnt(s) = [1362.79285764]
bas 9, expnt(s) = [665.17830797]
bas 10, expnt(s) = [303.30773745]
bas 11, expnt(s) = [316.13508737]
bas 12, expnt(s) = [49.23083894]
bas 13, expnt(s) = [5.52719179]
bas 14, expnt(s) = [15.49136973]
bas 15, expnt(s) = [0.66264765]
bas 16, expnt(s) = [2.11688664]
bas 17, expnt(s) = [0.19954449]
CPU time:       126.05
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825081e+04 5.20024086e+03 7.61824788e+03 2.06018561e+03
 3.61824497e+03 1.17865988e+03 1.61816152e+03 6.44586827e+02
 2.39730644e+02 1.53924477e+02 5.23267486e+01 4.91538836e+01
 4.60707586e+00 7.94481971e+00 3.99311336e-01 1.26910850e+00
 1.36279286e+03 2.41558155e+04 6.65178308e+02 9.85500820e+03
 3.03307737e+02 3.69265517e+03 3.16135087e+02 3.88888650e+03
 4.92308389e+01 3.80435415e+02 5.52719179e+00 2.47237908e+01
 1.54913697e+01 8.96595731e+01 6.62647647e-01 1.74416560e+00
 2.11688664e+00 7.44914442e+00 1.99544490e-01 3.89075663e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.976563926113847
cond(S) = 85361.62762729006
E1 = -727.5351025587707  E_coul = 203.14868399142404
init E= -524.386418567347
    CPU time for initialize scf      0.31 sec, wall time      0.06 sec
  HOMO = -0.560054882783493  LUMO = 0.848684447346884
  mo_energy =
[-1.17864102e+02 -1.20944165e+01 -9.44193596e+00 -9.44193596e+00
 -9.44193596e+00 -1.23009661e+00 -5.60054883e-01 -5.60054883e-01
 -5.60054883e-01  8.48684447e-01  8.48684447e-01  8.48684447e-01
  5.29741607e+00  5.29741607e+00  5.29741607e+00  2.35397712e+01
  2.35397712e+01  2.35397712e+01  9.53763818e+01  9.53763818e+01
  9.53763818e+01  1.84077980e+02  4.26389614e+02  4.26389614e+02
  4.26389614e+02  1.27929291e+03  1.27929291e+03  1.27929291e+03
  1.91597616e+03  2.98094996e+03  2.98094996e+03  2.98094996e+03
  6.60969996e+03  6.60969996e+03  6.60969996e+03  8.27416740e+03
  2.46618363e+04  7.54581058e+04]
E1 = -727.3039862126477  E_coul = 201.7652441908959
cycle= 1 E= -525.538742021752  delta_E= -1.15  |g|= 0.186  |ddm|= 0.584
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.451952
diis-c [-0.20426037  1.        ]
  HOMO = -0.575992969720843  LUMO = 0.842424970501566
  mo_energy =
[-1.18111130e+02 -1.21887241e+01 -9.53465908e+00 -9.53465908e+00
 -9.53465908e+00 -1.25505481e+00 -5.75992970e-01 -5.75992970e-01
 -5.75992970e-01  8.42424971e-01  8.42424971e-01  8.42424971e-01
  5.25539357e+00  5.25539357e+00  5.25539357e+00  2.34544437e+01
  2.34544437e+01  2.34544437e+01  9.52255428e+01  9.52255428e+01
  9.52255428e+01  1.83882555e+02  4.26156995e+02  4.26156995e+02
  4.26156995e+02  1.27901322e+03  1.27901322e+03  1.27901322e+03
  1.91558112e+03  2.98061218e+03  2.98061218e+03  2.98061218e+03
  6.60924960e+03  6.60924960e+03  6.60924960e+03  8.27363654e+03
  2.46612128e+04  7.54573917e+04]
E1 = -727.5249693606045  E_coul = 201.9860356595711
cycle= 2 E= -525.538933701033  delta_E= -0.000192  |g|= 0.0156  |ddm|= 0.015
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0309567
diis-c [-7.64328453e-04  2.99505918e-02  9.70049408e-01]
  HOMO = -0.573047392794081  LUMO = 0.844225728953129
  mo_energy =
[-1.18079927e+02 -1.21731208e+01 -9.51882629e+00 -9.51882629e+00
 -9.51882629e+00 -1.25109092e+00 -5.73047393e-01 -5.73047393e-01
 -5.73047393e-01  8.44225729e-01  8.44225729e-01  8.44225729e-01
  5.26227129e+00  5.26227129e+00  5.26227129e+00  2.34685680e+01
  2.34685680e+01  2.34685680e+01  9.52488219e+01  9.52488219e+01
  9.52488219e+01  1.83912564e+02  4.26187768e+02  4.26187768e+02
  4.26187768e+02  1.27904615e+03  1.27904615e+03  1.27904615e+03
  1.91561549e+03  2.98064614e+03  2.98064614e+03  2.98064614e+03
  6.60928417e+03  6.60928417e+03  6.60928417e+03  8.27367135e+03
  2.46612476e+04  7.54574265e+04]
E1 = -727.4776407204685  E_coul = 201.9387002228934
cycle= 3 E= -525.538940497575  delta_E= -6.8e-06  |g|= 0.0023  |ddm|= 0.00404
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00468907
diis-c [-1.13298601e-07 -7.17463798e-04  1.27457129e-01  8.73260335e-01]
  HOMO = -0.573656561922879  LUMO = 0.843857513450786
  mo_energy =
[-1.18084351e+02 -1.21756444e+01 -9.52139564e+00 -9.52139564e+00
 -9.52139564e+00 -1.25188925e+00 -5.73656562e-01 -5.73656562e-01
 -5.73656562e-01  8.43857513e-01  8.43857513e-01  8.43857513e-01
  5.26098467e+00  5.26098467e+00  5.26098467e+00  2.34662470e+01
  2.34662470e+01  2.34662470e+01  9.52453565e+01  9.52453565e+01
  9.52453565e+01  1.83908332e+02  4.26183404e+02  4.26183404e+02
  4.26183404e+02  1.27904153e+03  1.27904153e+03  1.27904153e+03
  1.91561065e+03  2.98064137e+03  2.98064137e+03  2.98064137e+03
  6.60927927e+03  6.60927927e+03  6.60927927e+03  8.27366638e+03
  2.46612426e+04  7.54574214e+04]
E1 = -727.484963974009  E_coul = 201.9460232659698
cycle= 4 E= -525.538940708039  delta_E= -2.1e-07  |g|= 4.21e-05  |ddm|= 0.000649
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.69946e-05
diis-c [-3.31491906e-10 -2.77081886e-05  4.77961041e-03  4.74710106e-02
  9.47777087e-01]
  HOMO = -0.573633717589092  LUMO = 0.843870977288452
  mo_energy =
[-1.18084257e+02 -1.21755665e+01 -9.52131685e+00 -9.52131685e+00
 -9.52131685e+00 -1.25185916e+00 -5.73633718e-01 -5.73633718e-01
 -5.73633718e-01  8.43870977e-01  8.43870977e-01  8.43870977e-01
  5.26103046e+00  5.26103046e+00  5.26103046e+00  2.34663189e+01
  2.34663189e+01  2.34663189e+01  9.52454432e+01  9.52454432e+01
  9.52454432e+01  1.83908425e+02  4.26183497e+02  4.26183497e+02
  4.26183497e+02  1.27904162e+03  1.27904162e+03  1.27904162e+03
  1.91561074e+03  2.98064147e+03  2.98064147e+03  2.98064147e+03
  6.60927936e+03  6.60927936e+03  6.60927936e+03  8.27366647e+03
  2.46612427e+04  7.54574215e+04]
E1 = -727.484754135402  E_coul = 201.94581342720033
cycle= 5 E= -525.538940708202  delta_E= -1.62e-10  |g|= 2.22e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.484754135402  E_coul = 201.94581342720033
  HOMO = -0.573635157097661  LUMO = 0.84387010848693
  mo_energy =
[-1.18084263e+02 -1.21755708e+01 -9.52132120e+00 -9.52132120e+00
 -9.52132120e+00 -1.25186098e+00 -5.73635157e-01 -5.73635157e-01
 -5.73635157e-01  8.43870108e-01  8.43870108e-01  8.43870108e-01
  5.26102776e+00  5.26102776e+00  5.26102776e+00  2.34663148e+01
  2.34663148e+01  2.34663148e+01  9.52454382e+01  9.52454382e+01
  9.52454382e+01  1.83908419e+02  4.26183492e+02  4.26183492e+02
  4.26183492e+02  1.27904161e+03  1.27904161e+03  1.27904161e+03
  1.91561073e+03  2.98064146e+03  2.98064146e+03  2.98064146e+03
  6.60927936e+03  6.60927936e+03  6.60927936e+03  8.27366646e+03
  2.46612427e+04  7.54574215e+04]
E1 = -727.4847653085893  E_coul = 201.9458246003869
Extra cycle  E= -525.538940708202  delta_E= -7.96e-13  |g|= 5.4e-07  |ddm|= 1.03e-06
    CPU time for scf_cycle      0.50 sec, wall time      0.25 sec
exp = [2.61825081e+04 7.61824788e+03 3.61824497e+03 1.61816152e+03
 2.39730644e+02 5.23267486e+01 4.60707586e+00 3.99311336e-01
 1.36279286e+03 6.65178308e+02 3.03307737e+02 3.16135087e+02
 4.92308389e+01 5.52719179e+00 1.54913697e+01 6.62647647e-01
 2.11688664e+00 1.99544490e-01]
E = -525.5389407082024
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5081132        1
[INPUT] 0    0    [1    /1   ]  7618.24787996        1
[INPUT] 0    0    [1    /1   ]  3618.24496648        1
[INPUT] 0    0    [1    /1   ]  1618.1615191         1
[INPUT] 0    0    [1    /1   ]  239.730643753        1
[INPUT] 0    0    [1    /1   ]  52.3267485778        1
[INPUT] 0    0    [1    /1   ]  4.60707585604        1
[INPUT] 0    0    [1    /1   ]  0.399311335786       1
[INPUT] 1    0    [1    /1   ]  1362.79285764        1
[INPUT] 1    0    [1    /1   ]  665.178307965        1
[INPUT] 1    0    [1    /1   ]  303.307737453        1
[INPUT] 1    0    [1    /1   ]  316.13508737         1
[INPUT] 1    0    [1    /1   ]  49.2308389431        1
[INPUT] 1    0    [1    /1   ]  5.52719179003        1
[INPUT] 1    0    [1    /1   ]  15.4913697307        1
[INPUT] 1    0    [1    /1   ]  0.662647646798       1
[INPUT] 1    0    [1    /1   ]  2.1168866363         1
[INPUT] 1    0    [1    /1   ]  0.199544489511       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.5081132107, 1.0]], [0, [7618.247879959805, 1.0]], [0, [3618.244966483083, 1.0]], [0, [1618.1615191048757, 1.0]], [0, [239.7306437531929, 1.0]], [0, [52.32674857782007, 1.0]], [0, [4.6070758560442595, 1.0]], [0, [0.39931133578587197, 1.0]], [1, [1362.7928576409784, 1.0]], [1, [665.178307965023, 1.0]], [1, [303.30773745282966, 1.0]], [1, [316.1350873697364, 1.0]], [1, [49.23083894305456, 1.0]], [1, [5.527191790032335, 1.0]], [1, [15.49136973070766, 1.0]], [1, [0.6626476467984808, 1.0]], [1, [2.1168866363047725, 1.0]], [1, [0.19954448951088025, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50811321]
bas 1, expnt(s) = [7618.24787996]
bas 2, expnt(s) = [3618.24496648]
bas 3, expnt(s) = [1618.1615191]
bas 4, expnt(s) = [239.73064375]
bas 5, expnt(s) = [52.32674858]
bas 6, expnt(s) = [4.60707586]
bas 7, expnt(s) = [0.39931134]
bas 8, expnt(s) = [1362.79285764]
bas 9, expnt(s) = [665.17830797]
bas 10, expnt(s) = [303.30773745]
bas 11, expnt(s) = [316.13508737]
bas 12, expnt(s) = [49.23083894]
bas 13, expnt(s) = [5.52719179]
bas 14, expnt(s) = [15.49136973]
bas 15, expnt(s) = [0.66264765]
bas 16, expnt(s) = [2.11688664]
bas 17, expnt(s) = [0.19954449]
CPU time:       126.69
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825081e+04 5.20024086e+03 7.61824788e+03 2.06018561e+03
 3.61824497e+03 1.17865988e+03 1.61816152e+03 6.44586827e+02
 2.39730644e+02 1.53924477e+02 5.23267486e+01 4.91538836e+01
 4.60707586e+00 7.94481971e+00 3.99311336e-01 1.26910850e+00
 1.36279286e+03 2.41558155e+04 6.65178308e+02 9.85500820e+03
 3.03307737e+02 3.69265517e+03 3.16135087e+02 3.88888650e+03
 4.92308389e+01 3.80435415e+02 5.52719179e+00 2.47237908e+01
 1.54913697e+01 8.96595731e+01 6.62647647e-01 1.74416560e+00
 2.11688664e+00 7.44914442e+00 1.99544490e-01 3.89075663e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.976563926113847
cond(S) = 85361.62762729006
E1 = -727.5351025587707  E_coul = 203.14868399142404
init E= -524.386418567347
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.560054882783493  LUMO = 0.848684447346884
  mo_energy =
[-1.17864102e+02 -1.20944165e+01 -9.44193596e+00 -9.44193596e+00
 -9.44193596e+00 -1.23009661e+00 -5.60054883e-01 -5.60054883e-01
 -5.60054883e-01  8.48684447e-01  8.48684447e-01  8.48684447e-01
  5.29741607e+00  5.29741607e+00  5.29741607e+00  2.35397712e+01
  2.35397712e+01  2.35397712e+01  9.53763818e+01  9.53763818e+01
  9.53763818e+01  1.84077980e+02  4.26389614e+02  4.26389614e+02
  4.26389614e+02  1.27929291e+03  1.27929291e+03  1.27929291e+03
  1.91597616e+03  2.98094996e+03  2.98094996e+03  2.98094996e+03
  6.60969996e+03  6.60969996e+03  6.60969996e+03  8.27416740e+03
  2.46618363e+04  7.54581058e+04]
E1 = -727.3039862126477  E_coul = 201.7652441908959
cycle= 1 E= -525.538742021752  delta_E= -1.15  |g|= 0.186  |ddm|= 0.584
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.451952
diis-c [-0.20426037  1.        ]
  HOMO = -0.575992969720843  LUMO = 0.842424970501566
  mo_energy =
[-1.18111130e+02 -1.21887241e+01 -9.53465908e+00 -9.53465908e+00
 -9.53465908e+00 -1.25505481e+00 -5.75992970e-01 -5.75992970e-01
 -5.75992970e-01  8.42424971e-01  8.42424971e-01  8.42424971e-01
  5.25539357e+00  5.25539357e+00  5.25539357e+00  2.34544437e+01
  2.34544437e+01  2.34544437e+01  9.52255428e+01  9.52255428e+01
  9.52255428e+01  1.83882555e+02  4.26156995e+02  4.26156995e+02
  4.26156995e+02  1.27901322e+03  1.27901322e+03  1.27901322e+03
  1.91558112e+03  2.98061218e+03  2.98061218e+03  2.98061218e+03
  6.60924960e+03  6.60924960e+03  6.60924960e+03  8.27363654e+03
  2.46612128e+04  7.54573917e+04]
E1 = -727.5249693606045  E_coul = 201.9860356595711
cycle= 2 E= -525.538933701033  delta_E= -0.000192  |g|= 0.0156  |ddm|= 0.015
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0309567
diis-c [-7.64328453e-04  2.99505918e-02  9.70049408e-01]
  HOMO = -0.573047392794081  LUMO = 0.844225728953129
  mo_energy =
[-1.18079927e+02 -1.21731208e+01 -9.51882629e+00 -9.51882629e+00
 -9.51882629e+00 -1.25109092e+00 -5.73047393e-01 -5.73047393e-01
 -5.73047393e-01  8.44225729e-01  8.44225729e-01  8.44225729e-01
  5.26227129e+00  5.26227129e+00  5.26227129e+00  2.34685680e+01
  2.34685680e+01  2.34685680e+01  9.52488219e+01  9.52488219e+01
  9.52488219e+01  1.83912564e+02  4.26187768e+02  4.26187768e+02
  4.26187768e+02  1.27904615e+03  1.27904615e+03  1.27904615e+03
  1.91561549e+03  2.98064614e+03  2.98064614e+03  2.98064614e+03
  6.60928417e+03  6.60928417e+03  6.60928417e+03  8.27367135e+03
  2.46612476e+04  7.54574265e+04]
E1 = -727.4776407204685  E_coul = 201.9387002228934
cycle= 3 E= -525.538940497575  delta_E= -6.8e-06  |g|= 0.0023  |ddm|= 0.00404
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00468907
diis-c [-1.13298601e-07 -7.17463798e-04  1.27457129e-01  8.73260335e-01]
  HOMO = -0.573656561922879  LUMO = 0.843857513450786
  mo_energy =
[-1.18084351e+02 -1.21756444e+01 -9.52139564e+00 -9.52139564e+00
 -9.52139564e+00 -1.25188925e+00 -5.73656562e-01 -5.73656562e-01
 -5.73656562e-01  8.43857513e-01  8.43857513e-01  8.43857513e-01
  5.26098467e+00  5.26098467e+00  5.26098467e+00  2.34662470e+01
  2.34662470e+01  2.34662470e+01  9.52453565e+01  9.52453565e+01
  9.52453565e+01  1.83908332e+02  4.26183404e+02  4.26183404e+02
  4.26183404e+02  1.27904153e+03  1.27904153e+03  1.27904153e+03
  1.91561065e+03  2.98064137e+03  2.98064137e+03  2.98064137e+03
  6.60927927e+03  6.60927927e+03  6.60927927e+03  8.27366638e+03
  2.46612426e+04  7.54574214e+04]
E1 = -727.484963974009  E_coul = 201.9460232659698
cycle= 4 E= -525.538940708039  delta_E= -2.1e-07  |g|= 4.21e-05  |ddm|= 0.000649
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.69946e-05
diis-c [-3.31491906e-10 -2.77081886e-05  4.77961041e-03  4.74710106e-02
  9.47777087e-01]
  HOMO = -0.573633717589092  LUMO = 0.843870977288452
  mo_energy =
[-1.18084257e+02 -1.21755665e+01 -9.52131685e+00 -9.52131685e+00
 -9.52131685e+00 -1.25185916e+00 -5.73633718e-01 -5.73633718e-01
 -5.73633718e-01  8.43870977e-01  8.43870977e-01  8.43870977e-01
  5.26103046e+00  5.26103046e+00  5.26103046e+00  2.34663189e+01
  2.34663189e+01  2.34663189e+01  9.52454432e+01  9.52454432e+01
  9.52454432e+01  1.83908425e+02  4.26183497e+02  4.26183497e+02
  4.26183497e+02  1.27904162e+03  1.27904162e+03  1.27904162e+03
  1.91561074e+03  2.98064147e+03  2.98064147e+03  2.98064147e+03
  6.60927936e+03  6.60927936e+03  6.60927936e+03  8.27366647e+03
  2.46612427e+04  7.54574215e+04]
E1 = -727.484754135402  E_coul = 201.94581342720033
cycle= 5 E= -525.538940708202  delta_E= -1.62e-10  |g|= 2.22e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.484754135402  E_coul = 201.94581342720033
  HOMO = -0.573635157097661  LUMO = 0.84387010848693
  mo_energy =
[-1.18084263e+02 -1.21755708e+01 -9.52132120e+00 -9.52132120e+00
 -9.52132120e+00 -1.25186098e+00 -5.73635157e-01 -5.73635157e-01
 -5.73635157e-01  8.43870108e-01  8.43870108e-01  8.43870108e-01
  5.26102776e+00  5.26102776e+00  5.26102776e+00  2.34663148e+01
  2.34663148e+01  2.34663148e+01  9.52454382e+01  9.52454382e+01
  9.52454382e+01  1.83908419e+02  4.26183492e+02  4.26183492e+02
  4.26183492e+02  1.27904161e+03  1.27904161e+03  1.27904161e+03
  1.91561073e+03  2.98064146e+03  2.98064146e+03  2.98064146e+03
  6.60927936e+03  6.60927936e+03  6.60927936e+03  8.27366646e+03
  2.46612427e+04  7.54574215e+04]
E1 = -727.4847653085893  E_coul = 201.9458246003869
Extra cycle  E= -525.538940708202  delta_E= -7.96e-13  |g|= 5.4e-07  |ddm|= 1.03e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 85361.62762729006
E1 = -727.4847653085893  E_coul = 201.9458246003869
init E= -525.538940708202
    CPU time for initialize scf      1.01 sec, wall time      0.18 sec
  HOMO = -0.573634947572055  LUMO = 0.843870233026146
  mo_energy =
[-1.18084261e+02 -1.21755699e+01 -9.52132036e+00 -9.52132036e+00
 -9.52132036e+00 -1.25186071e+00 -5.73634948e-01 -5.73634948e-01
 -5.73634948e-01  8.43870233e-01  8.43870233e-01  8.43870233e-01
  5.26102820e+00  5.26102820e+00  5.26102820e+00  2.34663156e+01
  2.34663156e+01  2.34663156e+01  9.52454392e+01  9.52454392e+01
  9.52454392e+01  1.83908421e+02  4.26183493e+02  4.26183493e+02
  4.26183493e+02  1.27904162e+03  1.27904162e+03  1.27904162e+03
  1.91561073e+03  2.98064146e+03  2.98064146e+03  2.98064146e+03
  6.60927936e+03  6.60927936e+03  6.60927936e+03  8.27366646e+03
  2.46612427e+04  7.54574215e+04]
E1 = -727.4847629239695  E_coul = 201.9458222157682
cycle= 1 E= -525.538940708201  delta_E= 1.14e-12  |g|= 1.23e-07  |ddm|= 2.37e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4847629239695  E_coul = 201.9458222157682
  HOMO = -0.573634992668696  LUMO = 0.843870205838116
  mo_energy =
[-1.18084262e+02 -1.21755701e+01 -9.52132053e+00 -9.52132053e+00
 -9.52132053e+00 -1.25186077e+00 -5.73634993e-01 -5.73634993e-01
 -5.73634993e-01  8.43870206e-01  8.43870206e-01  8.43870206e-01
  5.26102811e+00  5.26102811e+00  5.26102811e+00  2.34663154e+01
  2.34663154e+01  2.34663154e+01  9.52454390e+01  9.52454390e+01
  9.52454390e+01  1.83908420e+02  4.26183493e+02  4.26183493e+02
  4.26183493e+02  1.27904162e+03  1.27904162e+03  1.27904162e+03
  1.91561073e+03  2.98064146e+03  2.98064146e+03  2.98064146e+03
  6.60927936e+03  6.60927936e+03  6.60927936e+03  8.27366646e+03
  2.46612427e+04  7.54574215e+04]
E1 = -727.4847634222812  E_coul = 201.94582271407774
Extra cycle  E= -525.538940708203  delta_E= -2.16e-12  |g|= 2.64e-08  |ddm|= 4.53e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.26 sec
exp = [2.61825081e+04 7.61824788e+03 3.61824497e+03 1.61816152e+03
 2.39730644e+02 5.23267486e+01 4.60707586e+00 3.99311336e-01
 1.36279286e+03 6.65178308e+02 3.03307737e+02 3.16135087e+02
 4.92308389e+01 5.52719179e+00 1.54913697e+01 6.62647647e-01
 2.11688664e+00 1.99544490e-01]
grad_E = [-1.98758621e-06  2.23123039e-05  4.51039248e-05  6.88349956e-04
 -6.67579288e-04  4.43109272e-03  3.78943926e-03  9.17759463e-04
  1.66961716e-06  2.23368463e-05  1.22328162e-04  1.07794765e-04
 -2.12773488e-03 -8.16975105e-03  1.37481758e-03 -1.44811679e-02
  6.50503235e-03  1.69110071e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5081286        1
[INPUT] 0    0    [1    /1   ]  7618.24770939        1
[INPUT] 0    0    [1    /1   ]  3618.24462347        1
[INPUT] 0    0    [1    /1   ]  1618.1562688         1
[INPUT] 0    0    [1    /1   ]  239.731124565        1
[INPUT] 0    0    [1    /1   ]  52.3260713257        1
[INPUT] 0    0    [1    /1   ]  4.60395570385        1
[INPUT] 0    0    [1    /1   ]  0.399174050491       1
[INPUT] 1    0    [1    /1   ]  1362.7928486         1
[INPUT] 1    0    [1    /1   ]  665.178163251        1
[INPUT] 1    0    [1    /1   ]  303.306962623        1
[INPUT] 1    0    [1    /1   ]  316.13440465         1
[INPUT] 1    0    [1    /1   ]  49.2277533935        1
[INPUT] 1    0    [1    /1   ]  5.54948607303        1
[INPUT] 1    0    [1    /1   ]  15.5556687959        1
[INPUT] 1    0    [1    /1   ]  0.667176938084       1
[INPUT] 1    0    [1    /1   ]  2.07923414963        1
[INPUT] 1    0    [1    /1   ]  0.200378246042       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508128553494, 1.0]], [0, [7618.2477093925145, 1.0]], [0, [3618.244623467009, 1.0]], [0, [1618.1562687989046, 1.0]], [0, [239.73112456463122, 1.0]], [0, [52.32607132566763, 1.0]], [0, [4.603955703849835, 1.0]], [0, [0.3991740504905295, 1.0]], [1, [1362.7928486041822, 1.0]], [1, [665.1781632507721, 1.0]], [1, [303.3069626227327, 1.0]], [1, [316.1344046500259, 1.0]], [1, [49.22775339352391, 1.0]], [1, [5.549486073027878, 1.0]], [1, [15.555668795886165, 1.0]], [1, [0.6671769380840828, 1.0]], [1, [2.0792341496313194, 1.0]], [1, [0.20037824604197457, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50812855]
bas 1, expnt(s) = [7618.24770939]
bas 2, expnt(s) = [3618.24462347]
bas 3, expnt(s) = [1618.1562688]
bas 4, expnt(s) = [239.73112456]
bas 5, expnt(s) = [52.32607133]
bas 6, expnt(s) = [4.6039557]
bas 7, expnt(s) = [0.39917405]
bas 8, expnt(s) = [1362.7928486]
bas 9, expnt(s) = [665.17816325]
bas 10, expnt(s) = [303.30696262]
bas 11, expnt(s) = [316.13440465]
bas 12, expnt(s) = [49.22775339]
bas 13, expnt(s) = [5.54948607]
bas 14, expnt(s) = [15.5556688]
bas 15, expnt(s) = [0.66717694]
bas 16, expnt(s) = [2.07923415]
bas 17, expnt(s) = [0.20037825]
CPU time:       131.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825081e+04 5.20024086e+03 7.61824771e+03 2.06018557e+03
 3.61824462e+03 1.17865979e+03 1.61815627e+03 6.44585259e+02
 2.39731125e+02 1.53924709e+02 5.23260713e+01 4.91534065e+01
 4.60395570e+00 7.94078389e+00 3.99174050e-01 1.26878124e+00
 1.36279285e+03 2.41558153e+04 6.65178163e+02 9.85500552e+03
 3.03306963e+02 3.69264338e+03 3.16134405e+02 3.88887600e+03
 4.92277534e+01 3.80405610e+02 5.54948607e+00 2.48485099e+01
 1.55556688e+01 9.01249947e+01 6.67176938e-01 1.75908034e+00
 2.07923415e+00 7.28389442e+00 2.00378246e-01 3.91108816e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97651938765779
cond(S) = 85399.99598734363
E1 = -727.5251014606084  E_coul = 203.14099974858308
init E= -524.384101712025
    CPU time for initialize scf      0.64 sec, wall time      0.08 sec
  HOMO = -0.560164078868159  LUMO = 0.85461691581995
  mo_energy =
[-1.17865047e+02 -1.20950357e+01 -9.44261174e+00 -9.44261174e+00
 -9.44261174e+00 -1.23013474e+00 -5.60164079e-01 -5.60164079e-01
 -5.60164079e-01  8.54616916e-01  8.54616916e-01  8.54616916e-01
  5.26474219e+00  5.26474219e+00  5.26474219e+00  2.35116650e+01
  2.35116650e+01  2.35116650e+01  9.55157598e+01  9.55157598e+01
  9.55157598e+01  1.84062090e+02  4.26566050e+02  4.26566050e+02
  4.26566050e+02  1.27945278e+03  1.27945278e+03  1.27945278e+03
  1.91596182e+03  2.98109732e+03  2.98109732e+03  2.98109732e+03
  6.60983302e+03  6.60983302e+03  6.60983302e+03  8.27414625e+03
  2.46618090e+04  7.54580766e+04]
E1 = -727.2990238084329  E_coul = 201.76003436872128
cycle= 1 E= -525.538989439712  delta_E= -1.15  |g|= 0.186  |ddm|= 0.579
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.451455
diis-c [-0.20381121  1.        ]
  HOMO = -0.576181292181668  LUMO = 0.848228887395414
  mo_energy =
[-1.18111808e+02 -1.21889568e+01 -9.53505397e+00 -9.53505397e+00
 -9.53505397e+00 -1.25512368e+00 -5.76181292e-01 -5.76181292e-01
 -5.76181292e-01  8.48228887e-01  8.48228887e-01  8.48228887e-01
  5.22298502e+00  5.22298502e+00  5.22298502e+00  2.34264146e+01
  2.34264146e+01  2.34264146e+01  9.53651579e+01  9.53651579e+01
  9.53651579e+01  1.83867150e+02  4.26333728e+02  4.26333728e+02
  4.26333728e+02  1.27917327e+03  1.27917327e+03  1.27917327e+03
  1.91556668e+03  2.98075956e+03  2.98075956e+03  2.98075956e+03
  6.60938251e+03  6.60938251e+03  6.60938251e+03  8.27361512e+03
  2.46611851e+04  7.54573620e+04]
E1 = -727.5192620763049  E_coul = 201.98008062229053
cycle= 2 E= -525.539181454014  delta_E= -0.000192  |g|= 0.0156  |ddm|= 0.0148
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0308457
diis-c [-7.60167990e-04  2.97794441e-02  9.70220556e-01]
  HOMO = -0.573265526002867  LUMO = 0.850018677572921
  mo_energy =
[-1.18080649e+02 -1.21733983e+01 -9.51926416e+00 -9.51926416e+00
 -9.51926416e+00 -1.25119556e+00 -5.73265526e-01 -5.73265526e-01
 -5.73265526e-01  8.50018678e-01  8.50018678e-01  8.50018678e-01
  5.22977509e+00  5.22977509e+00  5.22977509e+00  2.34405176e+01
  2.34405176e+01  2.34405176e+01  9.53884034e+01  9.53884034e+01
  9.53884034e+01  1.83897117e+02  4.26364456e+02  4.26364456e+02
  4.26364456e+02  1.27920615e+03  1.27920615e+03  1.27920615e+03
  1.91560100e+03  2.98079348e+03  2.98079348e+03  2.98079348e+03
  6.60941704e+03  6.60941704e+03  6.60941704e+03  8.27364988e+03
  2.46612199e+04  7.54573967e+04]
E1 = -727.4719220696161  E_coul = 201.93273382428308
cycle= 3 E= -525.539188245333  delta_E= -6.79e-06  |g|= 0.00231  |ddm|= 0.00404
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00467869
diis-c [-1.20388241e-07 -7.16750810e-04  1.27602197e-01  8.73114554e-01]
  HOMO = -0.573877057872461  LUMO = 0.849646967659219
  mo_energy =
[-1.18085079e+02 -1.21759258e+01 -9.52183764e+00 -9.52183764e+00
 -9.52183764e+00 -1.25199631e+00 -5.73877058e-01 -5.73877058e-01
 -5.73877058e-01  8.49646968e-01  8.49646968e-01  8.49646968e-01
  5.22849195e+00  5.22849195e+00  5.22849195e+00  2.34381894e+01
  2.34381894e+01  2.34381894e+01  9.53849314e+01  9.53849314e+01
  9.53849314e+01  1.83892879e+02  4.26360086e+02  4.26360086e+02
  4.26360086e+02  1.27920152e+03  1.27920152e+03  1.27920152e+03
  1.91559615e+03  2.98078870e+03  2.98078870e+03  2.98078870e+03
  6.60941213e+03  6.60941213e+03  6.60941213e+03  8.27364490e+03
  2.46612149e+04  7.54573916e+04]
E1 = -727.479267512773  E_coul = 201.94007905571868
cycle= 4 E= -525.539188457054  delta_E= -2.12e-07  |g|= 4.28e-05  |ddm|= 0.000646
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.84027e-05
diis-c [-3.42534936e-10 -2.61419213e-05  4.51160158e-03  4.59519231e-02
  9.49562617e-01]
  HOMO = -0.573854117925851  LUMO = 0.849660523972782
  mo_energy =
[-1.18084983e+02 -1.21758467e+01 -9.52175765e+00 -9.52175765e+00
 -9.52175765e+00 -1.25196601e+00 -5.73854118e-01 -5.73854118e-01
 -5.73854118e-01  8.49660524e-01  8.49660524e-01  8.49660524e-01
  5.22853789e+00  5.22853789e+00  5.22853789e+00  2.34382624e+01
  2.34382624e+01  2.34382624e+01  9.53850194e+01  9.53850194e+01
  9.53850194e+01  1.83892974e+02  4.26360181e+02  4.26360181e+02
  4.26360181e+02  1.27920161e+03  1.27920161e+03  1.27920161e+03
  1.91559625e+03  2.98078879e+03  2.98078879e+03  2.98078879e+03
  6.60941222e+03  6.60941222e+03  6.60941222e+03  8.27364499e+03
  2.46612149e+04  7.54573917e+04]
E1 = -727.4790530861139  E_coul = 201.93986462888992
cycle= 5 E= -525.539188457224  delta_E= -1.7e-10  |g|= 2.37e-06  |ddm|= 2.4e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4790530861139  E_coul = 201.93986462888992
  HOMO = -0.573855666308888  LUMO = 0.84965958176737
  mo_energy =
[-1.18084989e+02 -1.21758513e+01 -9.52176226e+00 -9.52176226e+00
 -9.52176226e+00 -1.25196797e+00 -5.73855666e-01 -5.73855666e-01
 -5.73855666e-01  8.49659582e-01  8.49659582e-01  8.49659582e-01
  5.22853501e+00  5.22853501e+00  5.22853501e+00  2.34382581e+01
  2.34382581e+01  2.34382581e+01  9.53850141e+01  9.53850141e+01
  9.53850141e+01  1.83892968e+02  4.26360175e+02  4.26360175e+02
  4.26360175e+02  1.27920161e+03  1.27920161e+03  1.27920161e+03
  1.91559624e+03  2.98078879e+03  2.98078879e+03  2.98078879e+03
  6.60941222e+03  6.60941222e+03  6.60941222e+03  8.27364499e+03
  2.46612149e+04  7.54573917e+04]
E1 = -727.4790648842315  E_coul = 201.93987642700637
Extra cycle  E= -525.539188457225  delta_E= -1.25e-12  |g|= 5.7e-07  |ddm|= 1.07e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.26 sec
exp = [2.61825081e+04 7.61824771e+03 3.61824462e+03 1.61815627e+03
 2.39731125e+02 5.23260713e+01 4.60395570e+00 3.99174050e-01
 1.36279285e+03 6.65178163e+02 3.03306963e+02 3.16134405e+02
 4.92277534e+01 5.54948607e+00 1.55556688e+01 6.67176938e-01
 2.07923415e+00 2.00378246e-01]
E = -525.5391884572252
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:28 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5081286        1
[INPUT] 0    0    [1    /1   ]  7618.24770939        1
[INPUT] 0    0    [1    /1   ]  3618.24462347        1
[INPUT] 0    0    [1    /1   ]  1618.1562688         1
[INPUT] 0    0    [1    /1   ]  239.731124565        1
[INPUT] 0    0    [1    /1   ]  52.3260713257        1
[INPUT] 0    0    [1    /1   ]  4.60395570385        1
[INPUT] 0    0    [1    /1   ]  0.399174050491       1
[INPUT] 1    0    [1    /1   ]  1362.7928486         1
[INPUT] 1    0    [1    /1   ]  665.178163251        1
[INPUT] 1    0    [1    /1   ]  303.306962623        1
[INPUT] 1    0    [1    /1   ]  316.13440465         1
[INPUT] 1    0    [1    /1   ]  49.2277533935        1
[INPUT] 1    0    [1    /1   ]  5.54948607303        1
[INPUT] 1    0    [1    /1   ]  15.5556687959        1
[INPUT] 1    0    [1    /1   ]  0.667176938084       1
[INPUT] 1    0    [1    /1   ]  2.07923414963        1
[INPUT] 1    0    [1    /1   ]  0.200378246042       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508128553494, 1.0]], [0, [7618.2477093925145, 1.0]], [0, [3618.244623467009, 1.0]], [0, [1618.1562687989046, 1.0]], [0, [239.73112456463122, 1.0]], [0, [52.32607132566763, 1.0]], [0, [4.603955703849835, 1.0]], [0, [0.3991740504905295, 1.0]], [1, [1362.7928486041822, 1.0]], [1, [665.1781632507721, 1.0]], [1, [303.3069626227327, 1.0]], [1, [316.1344046500259, 1.0]], [1, [49.22775339352391, 1.0]], [1, [5.549486073027878, 1.0]], [1, [15.555668795886165, 1.0]], [1, [0.6671769380840828, 1.0]], [1, [2.0792341496313194, 1.0]], [1, [0.20037824604197457, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50812855]
bas 1, expnt(s) = [7618.24770939]
bas 2, expnt(s) = [3618.24462347]
bas 3, expnt(s) = [1618.1562688]
bas 4, expnt(s) = [239.73112456]
bas 5, expnt(s) = [52.32607133]
bas 6, expnt(s) = [4.6039557]
bas 7, expnt(s) = [0.39917405]
bas 8, expnt(s) = [1362.7928486]
bas 9, expnt(s) = [665.17816325]
bas 10, expnt(s) = [303.30696262]
bas 11, expnt(s) = [316.13440465]
bas 12, expnt(s) = [49.22775339]
bas 13, expnt(s) = [5.54948607]
bas 14, expnt(s) = [15.5556688]
bas 15, expnt(s) = [0.66717694]
bas 16, expnt(s) = [2.07923415]
bas 17, expnt(s) = [0.20037825]
CPU time:       132.84
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825081e+04 5.20024086e+03 7.61824771e+03 2.06018557e+03
 3.61824462e+03 1.17865979e+03 1.61815627e+03 6.44585259e+02
 2.39731125e+02 1.53924709e+02 5.23260713e+01 4.91534065e+01
 4.60395570e+00 7.94078389e+00 3.99174050e-01 1.26878124e+00
 1.36279285e+03 2.41558153e+04 6.65178163e+02 9.85500552e+03
 3.03306963e+02 3.69264338e+03 3.16134405e+02 3.88887600e+03
 4.92277534e+01 3.80405610e+02 5.54948607e+00 2.48485099e+01
 1.55556688e+01 9.01249947e+01 6.67176938e-01 1.75908034e+00
 2.07923415e+00 7.28389442e+00 2.00378246e-01 3.91108816e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97651938765779
cond(S) = 85399.99598734363
E1 = -727.5251014606084  E_coul = 203.14099974858308
init E= -524.384101712025
    CPU time for initialize scf      0.24 sec, wall time      0.05 sec
  HOMO = -0.560164078868159  LUMO = 0.85461691581995
  mo_energy =
[-1.17865047e+02 -1.20950357e+01 -9.44261174e+00 -9.44261174e+00
 -9.44261174e+00 -1.23013474e+00 -5.60164079e-01 -5.60164079e-01
 -5.60164079e-01  8.54616916e-01  8.54616916e-01  8.54616916e-01
  5.26474219e+00  5.26474219e+00  5.26474219e+00  2.35116650e+01
  2.35116650e+01  2.35116650e+01  9.55157598e+01  9.55157598e+01
  9.55157598e+01  1.84062090e+02  4.26566050e+02  4.26566050e+02
  4.26566050e+02  1.27945278e+03  1.27945278e+03  1.27945278e+03
  1.91596182e+03  2.98109732e+03  2.98109732e+03  2.98109732e+03
  6.60983302e+03  6.60983302e+03  6.60983302e+03  8.27414625e+03
  2.46618090e+04  7.54580766e+04]
E1 = -727.2990238084329  E_coul = 201.76003436872128
cycle= 1 E= -525.538989439712  delta_E= -1.15  |g|= 0.186  |ddm|= 0.579
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.451455
diis-c [-0.20381121  1.        ]
  HOMO = -0.576181292181668  LUMO = 0.848228887395414
  mo_energy =
[-1.18111808e+02 -1.21889568e+01 -9.53505397e+00 -9.53505397e+00
 -9.53505397e+00 -1.25512368e+00 -5.76181292e-01 -5.76181292e-01
 -5.76181292e-01  8.48228887e-01  8.48228887e-01  8.48228887e-01
  5.22298502e+00  5.22298502e+00  5.22298502e+00  2.34264146e+01
  2.34264146e+01  2.34264146e+01  9.53651579e+01  9.53651579e+01
  9.53651579e+01  1.83867150e+02  4.26333728e+02  4.26333728e+02
  4.26333728e+02  1.27917327e+03  1.27917327e+03  1.27917327e+03
  1.91556668e+03  2.98075956e+03  2.98075956e+03  2.98075956e+03
  6.60938251e+03  6.60938251e+03  6.60938251e+03  8.27361512e+03
  2.46611851e+04  7.54573620e+04]
E1 = -727.5192620763049  E_coul = 201.98008062229053
cycle= 2 E= -525.539181454014  delta_E= -0.000192  |g|= 0.0156  |ddm|= 0.0148
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0308457
diis-c [-7.60167990e-04  2.97794441e-02  9.70220556e-01]
  HOMO = -0.573265526002867  LUMO = 0.850018677572921
  mo_energy =
[-1.18080649e+02 -1.21733983e+01 -9.51926416e+00 -9.51926416e+00
 -9.51926416e+00 -1.25119556e+00 -5.73265526e-01 -5.73265526e-01
 -5.73265526e-01  8.50018678e-01  8.50018678e-01  8.50018678e-01
  5.22977509e+00  5.22977509e+00  5.22977509e+00  2.34405176e+01
  2.34405176e+01  2.34405176e+01  9.53884034e+01  9.53884034e+01
  9.53884034e+01  1.83897117e+02  4.26364456e+02  4.26364456e+02
  4.26364456e+02  1.27920615e+03  1.27920615e+03  1.27920615e+03
  1.91560100e+03  2.98079348e+03  2.98079348e+03  2.98079348e+03
  6.60941704e+03  6.60941704e+03  6.60941704e+03  8.27364988e+03
  2.46612199e+04  7.54573967e+04]
E1 = -727.4719220696161  E_coul = 201.93273382428308
cycle= 3 E= -525.539188245333  delta_E= -6.79e-06  |g|= 0.00231  |ddm|= 0.00404
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00467869
diis-c [-1.20388241e-07 -7.16750810e-04  1.27602197e-01  8.73114554e-01]
  HOMO = -0.573877057872461  LUMO = 0.849646967659219
  mo_energy =
[-1.18085079e+02 -1.21759258e+01 -9.52183764e+00 -9.52183764e+00
 -9.52183764e+00 -1.25199631e+00 -5.73877058e-01 -5.73877058e-01
 -5.73877058e-01  8.49646968e-01  8.49646968e-01  8.49646968e-01
  5.22849195e+00  5.22849195e+00  5.22849195e+00  2.34381894e+01
  2.34381894e+01  2.34381894e+01  9.53849314e+01  9.53849314e+01
  9.53849314e+01  1.83892879e+02  4.26360086e+02  4.26360086e+02
  4.26360086e+02  1.27920152e+03  1.27920152e+03  1.27920152e+03
  1.91559615e+03  2.98078870e+03  2.98078870e+03  2.98078870e+03
  6.60941213e+03  6.60941213e+03  6.60941213e+03  8.27364490e+03
  2.46612149e+04  7.54573916e+04]
E1 = -727.479267512773  E_coul = 201.94007905571868
cycle= 4 E= -525.539188457054  delta_E= -2.12e-07  |g|= 4.28e-05  |ddm|= 0.000646
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.84027e-05
diis-c [-3.42534936e-10 -2.61419213e-05  4.51160158e-03  4.59519231e-02
  9.49562617e-01]
  HOMO = -0.573854117925851  LUMO = 0.849660523972782
  mo_energy =
[-1.18084983e+02 -1.21758467e+01 -9.52175765e+00 -9.52175765e+00
 -9.52175765e+00 -1.25196601e+00 -5.73854118e-01 -5.73854118e-01
 -5.73854118e-01  8.49660524e-01  8.49660524e-01  8.49660524e-01
  5.22853789e+00  5.22853789e+00  5.22853789e+00  2.34382624e+01
  2.34382624e+01  2.34382624e+01  9.53850194e+01  9.53850194e+01
  9.53850194e+01  1.83892974e+02  4.26360181e+02  4.26360181e+02
  4.26360181e+02  1.27920161e+03  1.27920161e+03  1.27920161e+03
  1.91559625e+03  2.98078879e+03  2.98078879e+03  2.98078879e+03
  6.60941222e+03  6.60941222e+03  6.60941222e+03  8.27364499e+03
  2.46612149e+04  7.54573917e+04]
E1 = -727.4790530861139  E_coul = 201.93986462888992
cycle= 5 E= -525.539188457224  delta_E= -1.7e-10  |g|= 2.37e-06  |ddm|= 2.4e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4790530861139  E_coul = 201.93986462888992
  HOMO = -0.573855666308888  LUMO = 0.84965958176737
  mo_energy =
[-1.18084989e+02 -1.21758513e+01 -9.52176226e+00 -9.52176226e+00
 -9.52176226e+00 -1.25196797e+00 -5.73855666e-01 -5.73855666e-01
 -5.73855666e-01  8.49659582e-01  8.49659582e-01  8.49659582e-01
  5.22853501e+00  5.22853501e+00  5.22853501e+00  2.34382581e+01
  2.34382581e+01  2.34382581e+01  9.53850141e+01  9.53850141e+01
  9.53850141e+01  1.83892968e+02  4.26360175e+02  4.26360175e+02
  4.26360175e+02  1.27920161e+03  1.27920161e+03  1.27920161e+03
  1.91559624e+03  2.98078879e+03  2.98078879e+03  2.98078879e+03
  6.60941222e+03  6.60941222e+03  6.60941222e+03  8.27364499e+03
  2.46612149e+04  7.54573917e+04]
E1 = -727.4790648842315  E_coul = 201.93987642700637
Extra cycle  E= -525.539188457225  delta_E= -1.25e-12  |g|= 5.7e-07  |ddm|= 1.07e-06
    CPU time for scf_cycle      0.43 sec, wall time      0.24 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 85399.99598734363
E1 = -727.4790648842315  E_coul = 201.93987642700637
init E= -525.539188457225
    CPU time for initialize scf      0.94 sec, wall time      0.18 sec
  HOMO = -0.573855446035605  LUMO = 0.849659713087029
  mo_energy =
[-1.18084988e+02 -1.21758504e+01 -9.52176137e+00 -9.52176137e+00
 -9.52176137e+00 -1.25196768e+00 -5.73855446e-01 -5.73855446e-01
 -5.73855446e-01  8.49659713e-01  8.49659713e-01  8.49659713e-01
  5.22853548e+00  5.22853548e+00  5.22853548e+00  2.34382589e+01
  2.34382589e+01  2.34382589e+01  9.53850152e+01  9.53850152e+01
  9.53850152e+01  1.83892969e+02  4.26360176e+02  4.26360176e+02
  4.26360176e+02  1.27920161e+03  1.27920161e+03  1.27920161e+03
  1.91559624e+03  2.98078879e+03  2.98078879e+03  2.98078879e+03
  6.60941222e+03  6.60941222e+03  6.60941222e+03  8.27364499e+03
  2.46612149e+04  7.54573917e+04]
E1 = -727.479062352625  E_coul = 201.93987389540067
cycle= 1 E= -525.539188457224  delta_E= 9.09e-13  |g|= 1.3e-07  |ddm|= 2.53e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.479062352625  E_coul = 201.93987389540067
  HOMO = -0.573855494090778  LUMO = 0.849659683951915
  mo_energy =
[-1.18084988e+02 -1.21758506e+01 -9.52176156e+00 -9.52176156e+00
 -9.52176156e+00 -1.25196774e+00 -5.73855494e-01 -5.73855494e-01
 -5.73855494e-01  8.49659684e-01  8.49659684e-01  8.49659684e-01
  5.22853538e+00  5.22853538e+00  5.22853538e+00  2.34382587e+01
  2.34382587e+01  2.34382587e+01  9.53850150e+01  9.53850150e+01
  9.53850150e+01  1.83892969e+02  4.26360176e+02  4.26360176e+02
  4.26360176e+02  1.27920161e+03  1.27920161e+03  1.27920161e+03
  1.91559624e+03  2.98078879e+03  2.98078879e+03  2.98078879e+03
  6.60941222e+03  6.60941222e+03  6.60941222e+03  8.27364499e+03
  2.46612149e+04  7.54573917e+04]
E1 = -727.4790628820675  E_coul = 201.9398744248438
Extra cycle  E= -525.539188457224  delta_E= 5.68e-13  |g|= 2.8e-08  |ddm|= 4.77e-08
    CPU time for scf_cycle      1.22 sec, wall time      0.46 sec
exp = [2.61825081e+04 7.61824771e+03 3.61824462e+03 1.61815627e+03
 2.39731125e+02 5.23260713e+01 4.60395570e+00 3.99174050e-01
 1.36279285e+03 6.65178163e+02 3.03306963e+02 3.16134405e+02
 4.92277534e+01 5.54948607e+00 1.55556688e+01 6.67176938e-01
 2.07923415e+00 2.00378246e-01]
grad_E = [-1.98748974e-06  2.23102609e-05  4.50986606e-05  6.88287424e-04
 -6.65221192e-04  4.41716153e-03  8.63076503e-04 -9.83003404e-04
  1.71012358e-06  2.26215441e-05  1.24051507e-04  1.09317691e-04
 -2.27148597e-03 -5.24523511e-03  1.30620605e-03 -1.19284949e-03
  1.30316212e-03 -1.21237782e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5081328        1
[INPUT] 0    0    [1    /1   ]  7618.24766183        1
[INPUT] 0    0    [1    /1   ]  3618.24452746        1
[INPUT] 0    0    [1    /1   ]  1618.15480237        1
[INPUT] 0    0    [1    /1   ]  239.732195272        1
[INPUT] 0    0    [1    /1   ]  52.3191521732        1
[INPUT] 0    0    [1    /1   ]  4.60296143434        1
[INPUT] 0    0    [1    /1   ]  0.399175340034       1
[INPUT] 1    0    [1    /1   ]  1362.79284526        1
[INPUT] 1    0    [1    /1   ]  665.178117093        1
[INPUT] 1    0    [1    /1   ]  303.306710868        1
[INPUT] 1    0    [1    /1   ]  316.134182806        1
[INPUT] 1    0    [1    /1   ]  49.2311429973        1
[INPUT] 1    0    [1    /1   ]  5.56057733592        1
[INPUT] 1    0    [1    /1   ]  15.5575957179        1
[INPUT] 1    0    [1    /1   ]  0.670951675018       1
[INPUT] 1    0    [1    /1   ]  2.074269919          1
[INPUT] 1    0    [1    /1   ]  0.201465582074       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508132801653, 1.0]], [0, [7618.247661830539, 1.0]], [0, [3618.244527457215, 1.0]], [0, [1618.154802370619, 1.0]], [0, [239.73219527191253, 1.0]], [0, [52.319152173157214, 1.0]], [0, [4.602961434343799, 1.0]], [0, [0.39917534003369853, 1.0]], [1, [1362.7928452554202, 1.0]], [1, [665.1781170933233, 1.0]], [1, [303.30671086772253, 1.0]], [1, [316.1341828056186, 1.0]], [1, [49.23114299727836, 1.0]], [1, [5.560577335915313, 1.0]], [1, [15.557595717883116, 1.0]], [1, [0.6709516750181033, 1.0]], [1, [2.074269919004242, 1.0]], [1, [0.2014655820736182, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5081328]
bas 1, expnt(s) = [7618.24766183]
bas 2, expnt(s) = [3618.24452746]
bas 3, expnt(s) = [1618.15480237]
bas 4, expnt(s) = [239.73219527]
bas 5, expnt(s) = [52.31915217]
bas 6, expnt(s) = [4.60296143]
bas 7, expnt(s) = [0.39917534]
bas 8, expnt(s) = [1362.79284526]
bas 9, expnt(s) = [665.17811709]
bas 10, expnt(s) = [303.30671087]
bas 11, expnt(s) = [316.13418281]
bas 12, expnt(s) = [49.231143]
bas 13, expnt(s) = [5.56057734]
bas 14, expnt(s) = [15.55759572]
bas 15, expnt(s) = [0.67095168]
bas 16, expnt(s) = [2.07426992]
bas 17, expnt(s) = [0.20146558]
CPU time:       138.45
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825081e+04 5.20024086e+03 7.61824766e+03 2.06018556e+03
 3.61824453e+03 1.17865977e+03 1.61815480e+03 6.44584821e+02
 2.39732195e+02 1.53925225e+02 5.23191522e+01 4.91485317e+01
 4.60296143e+00 7.93949768e+00 3.99175340e-01 1.26878432e+00
 1.36279285e+03 2.41558152e+04 6.65178117e+02 9.85500467e+03
 3.03306711e+02 3.69263955e+03 3.16134183e+02 3.88887259e+03
 4.92311430e+01 3.80438352e+02 5.56057734e+00 2.49106035e+01
 1.55575957e+01 9.01389500e+01 6.70951675e-01 1.77152973e+00
 2.07426992e+00 7.26216278e+00 2.01465582e-01 3.93763513e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97643492720681
cond(S) = 85413.10660821675
E1 = -727.5238147757698  E_coul = 203.1391106357869
init E= -524.384704139983
    CPU time for initialize scf      0.70 sec, wall time      0.08 sec
  HOMO = -0.560162041018444  LUMO = 0.861263584593999
  mo_energy =
[-1.17865398e+02 -1.20951303e+01 -9.44280060e+00 -9.44280060e+00
 -9.44280060e+00 -1.23011278e+00 -5.60162041e-01 -5.60162041e-01
 -5.60162041e-01  8.61263585e-01  8.61263585e-01  8.61263585e-01
  5.27772214e+00  5.27772214e+00  5.27772214e+00  2.35374656e+01
  2.35374656e+01  2.35374656e+01  9.55593888e+01  9.55593888e+01
  9.55593888e+01  1.84039172e+02  4.26610368e+02  4.26610368e+02
  4.26610368e+02  1.27949346e+03  1.27949346e+03  1.27949346e+03
  1.91593622e+03  2.98113504e+03  2.98113504e+03  2.98113504e+03
  6.60986711e+03  6.60986711e+03  6.60986711e+03  8.27412092e+03
  2.46617830e+04  7.54580514e+04]
E1 = -727.3032173275742  E_coul = 201.7641422725363
cycle= 1 E= -525.539075055038  delta_E= -1.15  |g|= 0.186  |ddm|= 0.556
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.451395
diis-c [-0.20375717  1.        ]
  HOMO = -0.576024358005295  LUMO = 0.854890296767417
  mo_energy =
[-1.18111779e+02 -1.21885344e+01 -9.53476601e+00 -9.53476601e+00
 -9.53476601e+00 -1.25489822e+00 -5.76024358e-01 -5.76024358e-01
 -5.76024358e-01  8.54890297e-01  8.54890297e-01  8.54890297e-01
  5.23623058e+00  5.23623058e+00  5.23623058e+00  2.34526176e+01
  2.34526176e+01  2.34526176e+01  9.54092390e+01  9.54092390e+01
  9.54092390e+01  1.83844708e+02  4.26378416e+02  4.26378416e+02
  4.26378416e+02  1.27921420e+03  1.27921420e+03  1.27921420e+03
  1.91554112e+03  2.98079739e+03  2.98079739e+03  2.98079739e+03
  6.60941660e+03  6.60941660e+03  6.60941660e+03  8.27358971e+03
  2.46611590e+04  7.54573366e+04]
E1 = -727.5222941419901  E_coul = 201.98302783565282
cycle= 2 E= -525.539266306337  delta_E= -0.000191  |g|= 0.0156  |ddm|= 0.0147
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.030756
diis-c [-7.55934400e-04  2.96851866e-02  9.70314813e-01]
  HOMO = -0.573136220140638  LUMO = 0.856675293279721
  mo_energy =
[-1.18080724e+02 -1.21730580e+01 -9.51905877e+00 -9.51905877e+00
 -9.51905877e+00 -1.25100577e+00 -5.73136220e-01 -5.73136220e-01
 -5.73136220e-01  8.56675293e-01  8.56675293e-01  8.56675293e-01
  5.24296970e+00  5.24296970e+00  5.24296970e+00  2.34666478e+01
  2.34666478e+01  2.34666478e+01  9.54323908e+01  9.54323908e+01
  9.54323908e+01  1.83874574e+02  4.26409041e+02  4.26409041e+02
  4.26409041e+02  1.27924698e+03  1.27924698e+03  1.27924698e+03
  1.91557533e+03  2.98083121e+03  2.98083121e+03  2.98083121e+03
  6.60945101e+03  6.60945101e+03  6.60945101e+03  8.27362436e+03
  2.46611937e+04  7.54573712e+04]
E1 = -727.4752031333845  E_coul = 201.9359300936333
cycle= 3 E= -525.539273039751  delta_E= -6.73e-06  |g|= 0.0023  |ddm|= 0.00402
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00466063
diis-c [-1.21405016e-07 -7.16199357e-04  1.27479575e-01  8.73236625e-01]
  HOMO = -0.573744272352671  LUMO = 0.856303203072211
  mo_energy =
[-1.18085137e+02 -1.21755740e+01 -9.52162065e+00 -9.52162065e+00
 -9.52162065e+00 -1.25180193e+00 -5.73744272e-01 -5.73744272e-01
 -5.73744272e-01  8.56303203e-01  8.56303203e-01  8.56303203e-01
  5.24169308e+00  5.24169308e+00  5.24169308e+00  2.34643297e+01
  2.34643297e+01  2.34643297e+01  9.54289326e+01  9.54289326e+01
  9.54289326e+01  1.83870352e+02  4.26404687e+02  4.26404687e+02
  4.26404687e+02  1.27924236e+03  1.27924236e+03  1.27924236e+03
  1.91557049e+03  2.98082644e+03  2.98082644e+03  2.98082644e+03
  6.60944612e+03  6.60944612e+03  6.60944612e+03  8.27361939e+03
  2.46611887e+04  7.54573662e+04]
E1 = -727.4825119868391  E_coul = 201.94323873724258
cycle= 4 E= -525.539273249596  delta_E= -2.1e-07  |g|= 4.29e-05  |ddm|= 0.000642
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.85668e-05
diis-c [-3.45923902e-10 -2.59424935e-05  4.46594803e-03  4.57696687e-02
  9.49790326e-01]
  HOMO = -0.573721318419085  LUMO = 0.856316852099752
  mo_energy =
[-1.18085042e+02 -1.21754948e+01 -9.52154050e+00 -9.52154050e+00
 -9.52154050e+00 -1.25177161e+00 -5.73721318e-01 -5.73721318e-01
 -5.73721318e-01  8.56316852e-01  8.56316852e-01  8.56316852e-01
  5.24173908e+00  5.24173908e+00  5.24173908e+00  2.34644027e+01
  2.34644027e+01  2.34644027e+01  9.54290208e+01  9.54290208e+01
  9.54290208e+01  1.83870447e+02  4.26404782e+02  4.26404782e+02
  4.26404782e+02  1.27924246e+03  1.27924246e+03  1.27924246e+03
  1.91557059e+03  2.98082654e+03  2.98082654e+03  2.98082654e+03
  6.60944621e+03  6.60944621e+03  6.60944621e+03  8.27361949e+03
  2.46611888e+04  7.54573663e+04]
E1 = -727.4822972416646  E_coul = 201.94302399189695
cycle= 5 E= -525.539273249768  delta_E= -1.71e-10  |g|= 2.4e-06  |ddm|= 2.41e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4822972416646  E_coul = 201.94302399189695
  HOMO = -0.573722878687553  LUMO = 0.856315896280683
  mo_energy =
[-1.18085048e+02 -1.21754994e+01 -9.52154515e+00 -9.52154515e+00
 -9.52154515e+00 -1.25177359e+00 -5.73722879e-01 -5.73722879e-01
 -5.73722879e-01  8.56315896e-01  8.56315896e-01  8.56315896e-01
  5.24173618e+00  5.24173618e+00  5.24173618e+00  2.34643984e+01
  2.34643984e+01  2.34643984e+01  9.54290155e+01  9.54290155e+01
  9.54290155e+01  1.83870441e+02  4.26404776e+02  4.26404776e+02
  4.26404776e+02  1.27924245e+03  1.27924245e+03  1.27924245e+03
  1.91557058e+03  2.98082653e+03  2.98082653e+03  2.98082653e+03
  6.60944621e+03  6.60944621e+03  6.60944621e+03  8.27361948e+03
  2.46611888e+04  7.54573663e+04]
E1 = -727.4823091280991  E_coul = 201.9430358783305
Extra cycle  E= -525.539273249769  delta_E= -1.02e-12  |g|= 5.74e-07  |ddm|= 1.08e-06
    CPU time for scf_cycle      0.87 sec, wall time      0.25 sec
exp = [2.61825081e+04 7.61824766e+03 3.61824453e+03 1.61815480e+03
 2.39732195e+02 5.23191522e+01 4.60296143e+00 3.99175340e-01
 1.36279285e+03 6.65178117e+02 3.03306711e+02 3.16134183e+02
 4.92311430e+01 5.56057734e+00 1.55575957e+01 6.70951675e-01
 2.07426992e+00 2.01465582e-01]
E = -525.5392732497686
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5081328        1
[INPUT] 0    0    [1    /1   ]  7618.24766183        1
[INPUT] 0    0    [1    /1   ]  3618.24452746        1
[INPUT] 0    0    [1    /1   ]  1618.15480237        1
[INPUT] 0    0    [1    /1   ]  239.732195272        1
[INPUT] 0    0    [1    /1   ]  52.3191521732        1
[INPUT] 0    0    [1    /1   ]  4.60296143434        1
[INPUT] 0    0    [1    /1   ]  0.399175340034       1
[INPUT] 1    0    [1    /1   ]  1362.79284526        1
[INPUT] 1    0    [1    /1   ]  665.178117093        1
[INPUT] 1    0    [1    /1   ]  303.306710868        1
[INPUT] 1    0    [1    /1   ]  316.134182806        1
[INPUT] 1    0    [1    /1   ]  49.2311429973        1
[INPUT] 1    0    [1    /1   ]  5.56057733592        1
[INPUT] 1    0    [1    /1   ]  15.5575957179        1
[INPUT] 1    0    [1    /1   ]  0.670951675018       1
[INPUT] 1    0    [1    /1   ]  2.074269919          1
[INPUT] 1    0    [1    /1   ]  0.201465582074       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508132801653, 1.0]], [0, [7618.247661830539, 1.0]], [0, [3618.244527457215, 1.0]], [0, [1618.154802370619, 1.0]], [0, [239.73219527191253, 1.0]], [0, [52.319152173157214, 1.0]], [0, [4.602961434343799, 1.0]], [0, [0.39917534003369853, 1.0]], [1, [1362.7928452554202, 1.0]], [1, [665.1781170933233, 1.0]], [1, [303.30671086772253, 1.0]], [1, [316.1341828056186, 1.0]], [1, [49.23114299727836, 1.0]], [1, [5.560577335915313, 1.0]], [1, [15.557595717883116, 1.0]], [1, [0.6709516750181033, 1.0]], [1, [2.074269919004242, 1.0]], [1, [0.2014655820736182, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5081328]
bas 1, expnt(s) = [7618.24766183]
bas 2, expnt(s) = [3618.24452746]
bas 3, expnt(s) = [1618.15480237]
bas 4, expnt(s) = [239.73219527]
bas 5, expnt(s) = [52.31915217]
bas 6, expnt(s) = [4.60296143]
bas 7, expnt(s) = [0.39917534]
bas 8, expnt(s) = [1362.79284526]
bas 9, expnt(s) = [665.17811709]
bas 10, expnt(s) = [303.30671087]
bas 11, expnt(s) = [316.13418281]
bas 12, expnt(s) = [49.231143]
bas 13, expnt(s) = [5.56057734]
bas 14, expnt(s) = [15.55759572]
bas 15, expnt(s) = [0.67095168]
bas 16, expnt(s) = [2.07426992]
bas 17, expnt(s) = [0.20146558]
CPU time:       139.40
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825081e+04 5.20024086e+03 7.61824766e+03 2.06018556e+03
 3.61824453e+03 1.17865977e+03 1.61815480e+03 6.44584821e+02
 2.39732195e+02 1.53925225e+02 5.23191522e+01 4.91485317e+01
 4.60296143e+00 7.93949768e+00 3.99175340e-01 1.26878432e+00
 1.36279285e+03 2.41558152e+04 6.65178117e+02 9.85500467e+03
 3.03306711e+02 3.69263955e+03 3.16134183e+02 3.88887259e+03
 4.92311430e+01 3.80438352e+02 5.56057734e+00 2.49106035e+01
 1.55575957e+01 9.01389500e+01 6.70951675e-01 1.77152973e+00
 2.07426992e+00 7.26216278e+00 2.01465582e-01 3.93763513e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97643492720681
cond(S) = 85413.10660821675
E1 = -727.5238147757698  E_coul = 203.1391106357869
init E= -524.384704139983
    CPU time for initialize scf      0.65 sec, wall time      0.08 sec
  HOMO = -0.560162041018444  LUMO = 0.861263584593999
  mo_energy =
[-1.17865398e+02 -1.20951303e+01 -9.44280060e+00 -9.44280060e+00
 -9.44280060e+00 -1.23011278e+00 -5.60162041e-01 -5.60162041e-01
 -5.60162041e-01  8.61263585e-01  8.61263585e-01  8.61263585e-01
  5.27772214e+00  5.27772214e+00  5.27772214e+00  2.35374656e+01
  2.35374656e+01  2.35374656e+01  9.55593888e+01  9.55593888e+01
  9.55593888e+01  1.84039172e+02  4.26610368e+02  4.26610368e+02
  4.26610368e+02  1.27949346e+03  1.27949346e+03  1.27949346e+03
  1.91593622e+03  2.98113504e+03  2.98113504e+03  2.98113504e+03
  6.60986711e+03  6.60986711e+03  6.60986711e+03  8.27412092e+03
  2.46617830e+04  7.54580514e+04]
E1 = -727.3032173275742  E_coul = 201.7641422725363
cycle= 1 E= -525.539075055038  delta_E= -1.15  |g|= 0.186  |ddm|= 0.556
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.451395
diis-c [-0.20375717  1.        ]
  HOMO = -0.576024358005295  LUMO = 0.854890296767417
  mo_energy =
[-1.18111779e+02 -1.21885344e+01 -9.53476601e+00 -9.53476601e+00
 -9.53476601e+00 -1.25489822e+00 -5.76024358e-01 -5.76024358e-01
 -5.76024358e-01  8.54890297e-01  8.54890297e-01  8.54890297e-01
  5.23623058e+00  5.23623058e+00  5.23623058e+00  2.34526176e+01
  2.34526176e+01  2.34526176e+01  9.54092390e+01  9.54092390e+01
  9.54092390e+01  1.83844708e+02  4.26378416e+02  4.26378416e+02
  4.26378416e+02  1.27921420e+03  1.27921420e+03  1.27921420e+03
  1.91554112e+03  2.98079739e+03  2.98079739e+03  2.98079739e+03
  6.60941660e+03  6.60941660e+03  6.60941660e+03  8.27358971e+03
  2.46611590e+04  7.54573366e+04]
E1 = -727.5222941419901  E_coul = 201.98302783565282
cycle= 2 E= -525.539266306337  delta_E= -0.000191  |g|= 0.0156  |ddm|= 0.0147
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.030756
diis-c [-7.55934400e-04  2.96851866e-02  9.70314813e-01]
  HOMO = -0.573136220140638  LUMO = 0.856675293279721
  mo_energy =
[-1.18080724e+02 -1.21730580e+01 -9.51905877e+00 -9.51905877e+00
 -9.51905877e+00 -1.25100577e+00 -5.73136220e-01 -5.73136220e-01
 -5.73136220e-01  8.56675293e-01  8.56675293e-01  8.56675293e-01
  5.24296970e+00  5.24296970e+00  5.24296970e+00  2.34666478e+01
  2.34666478e+01  2.34666478e+01  9.54323908e+01  9.54323908e+01
  9.54323908e+01  1.83874574e+02  4.26409041e+02  4.26409041e+02
  4.26409041e+02  1.27924698e+03  1.27924698e+03  1.27924698e+03
  1.91557533e+03  2.98083121e+03  2.98083121e+03  2.98083121e+03
  6.60945101e+03  6.60945101e+03  6.60945101e+03  8.27362436e+03
  2.46611937e+04  7.54573712e+04]
E1 = -727.4752031333845  E_coul = 201.9359300936333
cycle= 3 E= -525.539273039751  delta_E= -6.73e-06  |g|= 0.0023  |ddm|= 0.00402
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00466063
diis-c [-1.21405016e-07 -7.16199357e-04  1.27479575e-01  8.73236625e-01]
  HOMO = -0.573744272352671  LUMO = 0.856303203072211
  mo_energy =
[-1.18085137e+02 -1.21755740e+01 -9.52162065e+00 -9.52162065e+00
 -9.52162065e+00 -1.25180193e+00 -5.73744272e-01 -5.73744272e-01
 -5.73744272e-01  8.56303203e-01  8.56303203e-01  8.56303203e-01
  5.24169308e+00  5.24169308e+00  5.24169308e+00  2.34643297e+01
  2.34643297e+01  2.34643297e+01  9.54289326e+01  9.54289326e+01
  9.54289326e+01  1.83870352e+02  4.26404687e+02  4.26404687e+02
  4.26404687e+02  1.27924236e+03  1.27924236e+03  1.27924236e+03
  1.91557049e+03  2.98082644e+03  2.98082644e+03  2.98082644e+03
  6.60944612e+03  6.60944612e+03  6.60944612e+03  8.27361939e+03
  2.46611887e+04  7.54573662e+04]
E1 = -727.4825119868391  E_coul = 201.94323873724258
cycle= 4 E= -525.539273249596  delta_E= -2.1e-07  |g|= 4.29e-05  |ddm|= 0.000642
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=7.85668e-05
diis-c [-3.45923902e-10 -2.59424935e-05  4.46594803e-03  4.57696687e-02
  9.49790326e-01]
  HOMO = -0.573721318419085  LUMO = 0.856316852099752
  mo_energy =
[-1.18085042e+02 -1.21754948e+01 -9.52154050e+00 -9.52154050e+00
 -9.52154050e+00 -1.25177161e+00 -5.73721318e-01 -5.73721318e-01
 -5.73721318e-01  8.56316852e-01  8.56316852e-01  8.56316852e-01
  5.24173908e+00  5.24173908e+00  5.24173908e+00  2.34644027e+01
  2.34644027e+01  2.34644027e+01  9.54290208e+01  9.54290208e+01
  9.54290208e+01  1.83870447e+02  4.26404782e+02  4.26404782e+02
  4.26404782e+02  1.27924246e+03  1.27924246e+03  1.27924246e+03
  1.91557059e+03  2.98082654e+03  2.98082654e+03  2.98082654e+03
  6.60944621e+03  6.60944621e+03  6.60944621e+03  8.27361949e+03
  2.46611888e+04  7.54573663e+04]
E1 = -727.4822972416646  E_coul = 201.94302399189695
cycle= 5 E= -525.539273249768  delta_E= -1.71e-10  |g|= 2.4e-06  |ddm|= 2.41e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.4822972416646  E_coul = 201.94302399189695
  HOMO = -0.573722878687553  LUMO = 0.856315896280683
  mo_energy =
[-1.18085048e+02 -1.21754994e+01 -9.52154515e+00 -9.52154515e+00
 -9.52154515e+00 -1.25177359e+00 -5.73722879e-01 -5.73722879e-01
 -5.73722879e-01  8.56315896e-01  8.56315896e-01  8.56315896e-01
  5.24173618e+00  5.24173618e+00  5.24173618e+00  2.34643984e+01
  2.34643984e+01  2.34643984e+01  9.54290155e+01  9.54290155e+01
  9.54290155e+01  1.83870441e+02  4.26404776e+02  4.26404776e+02
  4.26404776e+02  1.27924245e+03  1.27924245e+03  1.27924245e+03
  1.91557058e+03  2.98082653e+03  2.98082653e+03  2.98082653e+03
  6.60944621e+03  6.60944621e+03  6.60944621e+03  8.27361948e+03
  2.46611888e+04  7.54573663e+04]
E1 = -727.4823091280991  E_coul = 201.9430358783305
Extra cycle  E= -525.539273249769  delta_E= -1.02e-12  |g|= 5.74e-07  |ddm|= 1.08e-06
    CPU time for scf_cycle      0.78 sec, wall time      0.21 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 85413.10660821675
E1 = -727.4823091280991  E_coul = 201.9430358783305
init E= -525.539273249769
    CPU time for initialize scf      1.87 sec, wall time      0.25 sec
  HOMO = -0.573722656970071  LUMO = 0.85631602931623
  mo_energy =
[-1.18085046e+02 -1.21754985e+01 -9.52154425e+00 -9.52154425e+00
 -9.52154425e+00 -1.25177329e+00 -5.73722657e-01 -5.73722657e-01
 -5.73722657e-01  8.56316029e-01  8.56316029e-01  8.56316029e-01
  5.24173664e+00  5.24173664e+00  5.24173664e+00  2.34643992e+01
  2.34643992e+01  2.34643992e+01  9.54290166e+01  9.54290166e+01
  9.54290166e+01  1.83870443e+02  4.26404777e+02  4.26404777e+02
  4.26404777e+02  1.27924245e+03  1.27924245e+03  1.27924245e+03
  1.91557058e+03  2.98082654e+03  2.98082654e+03  2.98082654e+03
  6.60944621e+03  6.60944621e+03  6.60944621e+03  8.27361948e+03
  2.46611888e+04  7.54573663e+04]
E1 = -727.4823065789062  E_coul = 201.94303332913904
cycle= 1 E= -525.539273249767  delta_E= 1.48e-12  |g|= 1.31e-07  |ddm|= 2.55e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4823065789062  E_coul = 201.94303332913904
  HOMO = -0.57372270532367  LUMO = 0.85631599980496
  mo_energy =
[-1.18085047e+02 -1.21754987e+01 -9.52154444e+00 -9.52154444e+00
 -9.52154444e+00 -1.25177335e+00 -5.73722705e-01 -5.73722705e-01
 -5.73722705e-01  8.56316000e-01  8.56316000e-01  8.56316000e-01
  5.24173654e+00  5.24173654e+00  5.24173654e+00  2.34643991e+01
  2.34643991e+01  2.34643991e+01  9.54290164e+01  9.54290164e+01
  9.54290164e+01  1.83870442e+02  4.26404777e+02  4.26404777e+02
  4.26404777e+02  1.27924245e+03  1.27924245e+03  1.27924245e+03
  1.91557058e+03  2.98082654e+03  2.98082654e+03  2.98082654e+03
  6.60944621e+03  6.60944621e+03  6.60944621e+03  8.27361948e+03
  2.46611888e+04  7.54573663e+04]
E1 = -727.4823071117274  E_coul = 201.94303386195926
Extra cycle  E= -525.539273249768  delta_E= -1.02e-12  |g|= 2.82e-08  |ddm|= 4.8e-08
    CPU time for scf_cycle      1.97 sec, wall time      0.35 sec
exp = [2.61825081e+04 7.61824766e+03 3.61824453e+03 1.61815480e+03
 2.39732195e+02 5.23191522e+01 4.60296143e+00 3.99175340e-01
 1.36279285e+03 6.65178117e+02 3.03306711e+02 3.16134183e+02
 4.92311430e+01 5.56057734e+00 1.55575957e+01 6.70951675e-01
 2.07426992e+00 2.01465582e-01]
grad_E = [-1.98744512e-06  2.23002513e-05  4.50681296e-05  6.87916698e-04
 -6.39284835e-04  4.23232965e-03 -6.46215248e-05 -4.98398359e-04
  1.69262946e-06  2.24992433e-05  1.23298087e-04  1.08653064e-04
 -2.17057612e-03 -3.06644437e-03  4.91108779e-04  2.37189080e-03
 -7.32931293e-04 -1.87920988e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:36 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5081421        1
[INPUT] 0    0    [1    /1   ]  7618.24755816        1
[INPUT] 0    0    [1    /1   ]  3618.24431834        1
[INPUT] 0    0    [1    /1   ]  1618.15160693        1
[INPUT] 0    0    [1    /1   ]  239.734105702        1
[INPUT] 0    0    [1    /1   ]  52.3070893804        1
[INPUT] 0    0    [1    /1   ]  4.60178081106        1
[INPUT] 0    0    [1    /1   ]  0.399142794553       1
[INPUT] 1    0    [1    /1   ]  1362.79283775        1
[INPUT] 1    0    [1    /1   ]  665.178014884        1
[INPUT] 1    0    [1    /1   ]  303.306152339        1
[INPUT] 1    0    [1    /1   ]  316.13369065         1
[INPUT] 1    0    [1    /1   ]  49.2398811997        1
[INPUT] 1    0    [1    /1   ]  5.5880929095         1
[INPUT] 1    0    [1    /1   ]  15.5525566466        1
[INPUT] 1    0    [1    /1   ]  0.677846377455       1
[INPUT] 1    0    [1    /1   ]  2.08949661195        1
[INPUT] 1    0    [1    /1   ]  0.203004805395       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.50814207528, 1.0]], [0, [7618.247558156036, 1.0]], [0, [3618.244318340505, 1.0]], [0, [1618.151606930004, 1.0]], [0, [239.73410570185507, 1.0]], [0, [52.30708938043206, 1.0]], [0, [4.601780811055485, 1.0]], [0, [0.39914279455346124, 1.0]], [1, [1362.7928377489386, 1.0]], [1, [665.1780148840392, 1.0]], [1, [303.30615233922026, 1.0]], [1, [316.1336906503968, 1.0]], [1, [49.239881199698026, 1.0]], [1, [5.588092909504526, 1.0]], [1, [15.552556646597383, 1.0]], [1, [0.6778463774550054, 1.0]], [1, [2.0894966119460743, 1.0]], [1, [0.2030048053949026, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50814208]
bas 1, expnt(s) = [7618.24755816]
bas 2, expnt(s) = [3618.24431834]
bas 3, expnt(s) = [1618.15160693]
bas 4, expnt(s) = [239.7341057]
bas 5, expnt(s) = [52.30708938]
bas 6, expnt(s) = [4.60178081]
bas 7, expnt(s) = [0.39914279]
bas 8, expnt(s) = [1362.79283775]
bas 9, expnt(s) = [665.17801488]
bas 10, expnt(s) = [303.30615234]
bas 11, expnt(s) = [316.13369065]
bas 12, expnt(s) = [49.2398812]
bas 13, expnt(s) = [5.58809291]
bas 14, expnt(s) = [15.55255665]
bas 15, expnt(s) = [0.67784638]
bas 16, expnt(s) = [2.08949661]
bas 17, expnt(s) = [0.20300481]
CPU time:       145.95
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825081e+04 5.20024086e+03 7.61824756e+03 2.06018554e+03
 3.61824432e+03 1.17865972e+03 1.61815161e+03 6.44583866e+02
 2.39734106e+02 1.53926145e+02 5.23070894e+01 4.91400326e+01
 4.60178081e+00 7.93797032e+00 3.99142795e-01 1.26870673e+00
 1.36279284e+03 2.41558150e+04 6.65178015e+02 9.85500278e+03
 3.03306152e+02 3.69263105e+03 3.16133691e+02 3.88886502e+03
 4.92398812e+01 3.80522760e+02 5.58809291e+00 2.50647811e+01
 1.55525566e+01 9.01024567e+01 6.77846377e-01 1.79431419e+00
 2.08949661e+00 7.32886095e+00 2.03004805e-01 3.97527603e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97630080787284
cond(S) = 85456.95989608458
E1 = -727.5221076678426  E_coul = 203.13608096535208
init E= -524.386026702491
    CPU time for initialize scf      0.67 sec, wall time      0.08 sec
  HOMO = -0.560154715271686  LUMO = 0.871986027402026
  mo_energy =
[-1.17865932e+02 -1.20952556e+01 -9.44311428e+00 -9.44311428e+00
 -9.44311428e+00 -1.23010240e+00 -5.60154715e-01 -5.60154715e-01
 -5.60154715e-01  8.71986027e-01  8.71986027e-01  8.71986027e-01
  5.33770179e+00  5.33770179e+00  5.33770179e+00  2.36816341e+01
  2.36816341e+01  2.36816341e+01  9.57239894e+01  9.57239894e+01
  9.57239894e+01  1.84001496e+02  4.26750470e+02  4.26750470e+02
  4.26750470e+02  1.27961863e+03  1.27961863e+03  1.27961863e+03
  1.91589299e+03  2.98125066e+03  2.98125066e+03  2.98125066e+03
  6.60997171e+03  6.60997171e+03  6.60997171e+03  8.27407697e+03
  2.46617371e+04  7.54580063e+04]
E1 = -727.3055167896679  E_coul = 201.76633360228263
cycle= 1 E= -525.539183187385  delta_E= -1.15  |g|= 0.186  |ddm|= 0.517
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.451722
diis-c [-0.20405265  1.        ]
  HOMO = -0.575883346137627  LUMO = 0.865543939789416
  mo_energy =
[-1.18112121e+02 -1.21881598e+01 -9.53463457e+00 -9.53463457e+00
 -9.53463457e+00 -1.25470541e+00 -5.75883346e-01 -5.75883346e-01
 -5.75883346e-01  8.65543940e-01  8.65543940e-01  8.65543940e-01
  5.29617698e+00  5.29617698e+00  5.29617698e+00  2.35970946e+01
  2.35970946e+01  2.35970946e+01  9.55742277e+01  9.55742277e+01
  9.55742277e+01  1.83807363e+02  4.26518702e+02  4.26518702e+02
  4.26518702e+02  1.27933934e+03  1.27933934e+03  1.27933934e+03
  1.91549753e+03  2.98091279e+03  2.98091279e+03  2.98091279e+03
  6.60952078e+03  6.60952078e+03  6.60952078e+03  8.27354522e+03
  2.46611125e+04  7.54572909e+04]
E1 = -727.5236666272363  E_coul = 201.98429251397923
cycle= 2 E= -525.539374113257  delta_E= -0.000191  |g|= 0.0156  |ddm|= 0.0146
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.03075
diis-c [-7.54403093e-04  2.97519567e-02  9.70248043e-01]
  HOMO = -0.573020239592689  LUMO = 0.867337236509293
  mo_energy =
[-1.18081143e+02 -1.21727518e+01 -9.51899562e+00 -9.51899562e+00
 -9.51899562e+00 -1.25084550e+00 -5.73020240e-01 -5.73020240e-01
 -5.73020240e-01  8.67337237e-01  8.67337237e-01  8.67337237e-01
  5.30291091e+00  5.30291091e+00  5.30291091e+00  2.36110727e+01
  2.36110727e+01  2.36110727e+01  9.55973018e+01  9.55973018e+01
  9.55973018e+01  1.83837155e+02  4.26549250e+02  4.26549250e+02
  4.26549250e+02  1.27937204e+03  1.27937204e+03  1.27937204e+03
  1.91553166e+03  2.98094653e+03  2.98094653e+03  2.98094653e+03
  6.60955512e+03  6.60955512e+03  6.60955512e+03  8.27357979e+03
  2.46611471e+04  7.54573254e+04]
E1 = -727.4768109233579  E_coul = 201.93743012286782
cycle= 3 E= -525.53938080049  delta_E= -6.69e-06  |g|= 0.00229  |ddm|= 0.004
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00464772
diis-c [-1.22117304e-07 -7.16021998e-04  1.27162950e-01  8.73553072e-01]
  HOMO = -0.573624242727182  LUMO = 0.866962888850864
  mo_energy =
[-1.18085538e+02 -1.21752547e+01 -9.52154441e+00 -9.52154441e+00
 -9.52154441e+00 -1.25163636e+00 -5.73624243e-01 -5.73624243e-01
 -5.73624243e-01  8.66962889e-01  8.66962889e-01  8.66962889e-01
  5.30163515e+00  5.30163515e+00  5.30163515e+00  2.36087648e+01
  2.36087648e+01  2.36087648e+01  9.55938601e+01  9.55938601e+01
  9.55938601e+01  1.83832951e+02  4.26544914e+02  4.26544914e+02
  4.26544914e+02  1.27936745e+03  1.27936745e+03  1.27936745e+03
  1.91552684e+03  2.98094178e+03  2.98094178e+03  2.98094178e+03
  6.60955024e+03  6.60955024e+03  6.60955024e+03  8.27357485e+03
  2.46611421e+04  7.54573204e+04]
E1 = -727.4840765730634  E_coul = 201.94469556491092
cycle= 4 E= -525.539381008152  delta_E= -2.08e-07  |g|= 4.3e-05  |ddm|= 0.000639
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.87823e-05
diis-c [-3.50507209e-10 -2.57839474e-05  4.40829086e-03  4.55560226e-02
  9.50061470e-01]
  HOMO = -0.573601237408288  LUMO = 0.866976741205308
  mo_energy =
[-1.18085442e+02 -1.21751752e+01 -9.52146406e+00 -9.52146406e+00
 -9.52146406e+00 -1.25160597e+00 -5.73601237e-01 -5.73601237e-01
 -5.73601237e-01  8.66976741e-01  8.66976741e-01  8.66976741e-01
  5.30168148e+00  5.30168148e+00  5.30168148e+00  2.36088381e+01
  2.36088381e+01  2.36088381e+01  9.55939485e+01  9.55939485e+01
  9.55939485e+01  1.83833047e+02  4.26545010e+02  4.26545010e+02
  4.26545010e+02  1.27936754e+03  1.27936754e+03  1.27936754e+03
  1.91552694e+03  2.98094188e+03  2.98094188e+03  2.98094188e+03
  6.60955034e+03  6.60955034e+03  6.60955034e+03  8.27357494e+03
  2.46611422e+04  7.54573205e+04]
E1 = -727.4838616828838  E_coul = 201.9444806745594
cycle= 5 E= -525.539381008324  delta_E= -1.72e-10  |g|= 2.42e-06  |ddm|= 2.41e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4838616828838  E_coul = 201.9444806745594
  HOMO = -0.573602804754127  LUMO = 0.866975769641947
  mo_energy =
[-1.18085448e+02 -1.21751799e+01 -9.52146875e+00 -9.52146875e+00
 -9.52146875e+00 -1.25160795e+00 -5.73602805e-01 -5.73602805e-01
 -5.73602805e-01  8.66975770e-01  8.66975770e-01  8.66975770e-01
  5.30167855e+00  5.30167855e+00  5.30167855e+00  2.36088337e+01
  2.36088337e+01  2.36088337e+01  9.55939431e+01  9.55939431e+01
  9.55939431e+01  1.83833041e+02  4.26545004e+02  4.26545004e+02
  4.26545004e+02  1.27936754e+03  1.27936754e+03  1.27936754e+03
  1.91552693e+03  2.98094187e+03  2.98094187e+03  2.98094187e+03
  6.60955033e+03  6.60955033e+03  6.60955033e+03  8.27357494e+03
  2.46611422e+04  7.54573205e+04]
E1 = -727.4838736783493  E_coul = 201.94449267002562
Extra cycle  E= -525.539381008324  delta_E= 7.96e-13  |g|= 5.79e-07  |ddm|= 1.09e-06
    CPU time for scf_cycle      0.86 sec, wall time      0.26 sec
exp = [2.61825081e+04 7.61824756e+03 3.61824432e+03 1.61815161e+03
 2.39734106e+02 5.23070894e+01 4.60178081e+00 3.99142795e-01
 1.36279284e+03 6.65178015e+02 3.03306152e+02 3.16133691e+02
 4.92398812e+01 5.58809291e+00 1.55525566e+01 6.77846377e-01
 2.08949661e+00 2.03004805e-01]
E = -525.5393810083236
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:36 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5081421        1
[INPUT] 0    0    [1    /1   ]  7618.24755816        1
[INPUT] 0    0    [1    /1   ]  3618.24431834        1
[INPUT] 0    0    [1    /1   ]  1618.15160693        1
[INPUT] 0    0    [1    /1   ]  239.734105702        1
[INPUT] 0    0    [1    /1   ]  52.3070893804        1
[INPUT] 0    0    [1    /1   ]  4.60178081106        1
[INPUT] 0    0    [1    /1   ]  0.399142794553       1
[INPUT] 1    0    [1    /1   ]  1362.79283775        1
[INPUT] 1    0    [1    /1   ]  665.178014884        1
[INPUT] 1    0    [1    /1   ]  303.306152339        1
[INPUT] 1    0    [1    /1   ]  316.13369065         1
[INPUT] 1    0    [1    /1   ]  49.2398811997        1
[INPUT] 1    0    [1    /1   ]  5.5880929095         1
[INPUT] 1    0    [1    /1   ]  15.5525566466        1
[INPUT] 1    0    [1    /1   ]  0.677846377455       1
[INPUT] 1    0    [1    /1   ]  2.08949661195        1
[INPUT] 1    0    [1    /1   ]  0.203004805395       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.50814207528, 1.0]], [0, [7618.247558156036, 1.0]], [0, [3618.244318340505, 1.0]], [0, [1618.151606930004, 1.0]], [0, [239.73410570185507, 1.0]], [0, [52.30708938043206, 1.0]], [0, [4.601780811055485, 1.0]], [0, [0.39914279455346124, 1.0]], [1, [1362.7928377489386, 1.0]], [1, [665.1780148840392, 1.0]], [1, [303.30615233922026, 1.0]], [1, [316.1336906503968, 1.0]], [1, [49.239881199698026, 1.0]], [1, [5.588092909504526, 1.0]], [1, [15.552556646597383, 1.0]], [1, [0.6778463774550054, 1.0]], [1, [2.0894966119460743, 1.0]], [1, [0.2030048053949026, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50814208]
bas 1, expnt(s) = [7618.24755816]
bas 2, expnt(s) = [3618.24431834]
bas 3, expnt(s) = [1618.15160693]
bas 4, expnt(s) = [239.7341057]
bas 5, expnt(s) = [52.30708938]
bas 6, expnt(s) = [4.60178081]
bas 7, expnt(s) = [0.39914279]
bas 8, expnt(s) = [1362.79283775]
bas 9, expnt(s) = [665.17801488]
bas 10, expnt(s) = [303.30615234]
bas 11, expnt(s) = [316.13369065]
bas 12, expnt(s) = [49.2398812]
bas 13, expnt(s) = [5.58809291]
bas 14, expnt(s) = [15.55255665]
bas 15, expnt(s) = [0.67784638]
bas 16, expnt(s) = [2.08949661]
bas 17, expnt(s) = [0.20300481]
CPU time:       146.95
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825081e+04 5.20024086e+03 7.61824756e+03 2.06018554e+03
 3.61824432e+03 1.17865972e+03 1.61815161e+03 6.44583866e+02
 2.39734106e+02 1.53926145e+02 5.23070894e+01 4.91400326e+01
 4.60178081e+00 7.93797032e+00 3.99142795e-01 1.26870673e+00
 1.36279284e+03 2.41558150e+04 6.65178015e+02 9.85500278e+03
 3.03306152e+02 3.69263105e+03 3.16133691e+02 3.88886502e+03
 4.92398812e+01 3.80522760e+02 5.58809291e+00 2.50647811e+01
 1.55525566e+01 9.01024567e+01 6.77846377e-01 1.79431419e+00
 2.08949661e+00 7.32886095e+00 2.03004805e-01 3.97527603e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97630080787284
cond(S) = 85456.95989608458
E1 = -727.5221076678426  E_coul = 203.13608096535208
init E= -524.386026702491
    CPU time for initialize scf      0.29 sec, wall time      0.05 sec
  HOMO = -0.560154715271686  LUMO = 0.871986027402026
  mo_energy =
[-1.17865932e+02 -1.20952556e+01 -9.44311428e+00 -9.44311428e+00
 -9.44311428e+00 -1.23010240e+00 -5.60154715e-01 -5.60154715e-01
 -5.60154715e-01  8.71986027e-01  8.71986027e-01  8.71986027e-01
  5.33770179e+00  5.33770179e+00  5.33770179e+00  2.36816341e+01
  2.36816341e+01  2.36816341e+01  9.57239894e+01  9.57239894e+01
  9.57239894e+01  1.84001496e+02  4.26750470e+02  4.26750470e+02
  4.26750470e+02  1.27961863e+03  1.27961863e+03  1.27961863e+03
  1.91589299e+03  2.98125066e+03  2.98125066e+03  2.98125066e+03
  6.60997171e+03  6.60997171e+03  6.60997171e+03  8.27407697e+03
  2.46617371e+04  7.54580063e+04]
E1 = -727.3055167896679  E_coul = 201.76633360228263
cycle= 1 E= -525.539183187385  delta_E= -1.15  |g|= 0.186  |ddm|= 0.517
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.451722
diis-c [-0.20405265  1.        ]
  HOMO = -0.575883346137627  LUMO = 0.865543939789416
  mo_energy =
[-1.18112121e+02 -1.21881598e+01 -9.53463457e+00 -9.53463457e+00
 -9.53463457e+00 -1.25470541e+00 -5.75883346e-01 -5.75883346e-01
 -5.75883346e-01  8.65543940e-01  8.65543940e-01  8.65543940e-01
  5.29617698e+00  5.29617698e+00  5.29617698e+00  2.35970946e+01
  2.35970946e+01  2.35970946e+01  9.55742277e+01  9.55742277e+01
  9.55742277e+01  1.83807363e+02  4.26518702e+02  4.26518702e+02
  4.26518702e+02  1.27933934e+03  1.27933934e+03  1.27933934e+03
  1.91549753e+03  2.98091279e+03  2.98091279e+03  2.98091279e+03
  6.60952078e+03  6.60952078e+03  6.60952078e+03  8.27354522e+03
  2.46611125e+04  7.54572909e+04]
E1 = -727.5236666272363  E_coul = 201.98429251397923
cycle= 2 E= -525.539374113257  delta_E= -0.000191  |g|= 0.0156  |ddm|= 0.0146
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.03075
diis-c [-7.54403093e-04  2.97519567e-02  9.70248043e-01]
  HOMO = -0.573020239592689  LUMO = 0.867337236509293
  mo_energy =
[-1.18081143e+02 -1.21727518e+01 -9.51899562e+00 -9.51899562e+00
 -9.51899562e+00 -1.25084550e+00 -5.73020240e-01 -5.73020240e-01
 -5.73020240e-01  8.67337237e-01  8.67337237e-01  8.67337237e-01
  5.30291091e+00  5.30291091e+00  5.30291091e+00  2.36110727e+01
  2.36110727e+01  2.36110727e+01  9.55973018e+01  9.55973018e+01
  9.55973018e+01  1.83837155e+02  4.26549250e+02  4.26549250e+02
  4.26549250e+02  1.27937204e+03  1.27937204e+03  1.27937204e+03
  1.91553166e+03  2.98094653e+03  2.98094653e+03  2.98094653e+03
  6.60955512e+03  6.60955512e+03  6.60955512e+03  8.27357979e+03
  2.46611471e+04  7.54573254e+04]
E1 = -727.4768109233579  E_coul = 201.93743012286782
cycle= 3 E= -525.53938080049  delta_E= -6.69e-06  |g|= 0.00229  |ddm|= 0.004
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00464772
diis-c [-1.22117304e-07 -7.16021998e-04  1.27162950e-01  8.73553072e-01]
  HOMO = -0.573624242727182  LUMO = 0.866962888850864
  mo_energy =
[-1.18085538e+02 -1.21752547e+01 -9.52154441e+00 -9.52154441e+00
 -9.52154441e+00 -1.25163636e+00 -5.73624243e-01 -5.73624243e-01
 -5.73624243e-01  8.66962889e-01  8.66962889e-01  8.66962889e-01
  5.30163515e+00  5.30163515e+00  5.30163515e+00  2.36087648e+01
  2.36087648e+01  2.36087648e+01  9.55938601e+01  9.55938601e+01
  9.55938601e+01  1.83832951e+02  4.26544914e+02  4.26544914e+02
  4.26544914e+02  1.27936745e+03  1.27936745e+03  1.27936745e+03
  1.91552684e+03  2.98094178e+03  2.98094178e+03  2.98094178e+03
  6.60955024e+03  6.60955024e+03  6.60955024e+03  8.27357485e+03
  2.46611421e+04  7.54573204e+04]
E1 = -727.4840765730634  E_coul = 201.94469556491092
cycle= 4 E= -525.539381008152  delta_E= -2.08e-07  |g|= 4.3e-05  |ddm|= 0.000639
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.87823e-05
diis-c [-3.50507209e-10 -2.57839474e-05  4.40829086e-03  4.55560226e-02
  9.50061470e-01]
  HOMO = -0.573601237408288  LUMO = 0.866976741205308
  mo_energy =
[-1.18085442e+02 -1.21751752e+01 -9.52146406e+00 -9.52146406e+00
 -9.52146406e+00 -1.25160597e+00 -5.73601237e-01 -5.73601237e-01
 -5.73601237e-01  8.66976741e-01  8.66976741e-01  8.66976741e-01
  5.30168148e+00  5.30168148e+00  5.30168148e+00  2.36088381e+01
  2.36088381e+01  2.36088381e+01  9.55939485e+01  9.55939485e+01
  9.55939485e+01  1.83833047e+02  4.26545010e+02  4.26545010e+02
  4.26545010e+02  1.27936754e+03  1.27936754e+03  1.27936754e+03
  1.91552694e+03  2.98094188e+03  2.98094188e+03  2.98094188e+03
  6.60955034e+03  6.60955034e+03  6.60955034e+03  8.27357494e+03
  2.46611422e+04  7.54573205e+04]
E1 = -727.4838616828838  E_coul = 201.9444806745594
cycle= 5 E= -525.539381008324  delta_E= -1.72e-10  |g|= 2.42e-06  |ddm|= 2.41e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4838616828838  E_coul = 201.9444806745594
  HOMO = -0.573602804754127  LUMO = 0.866975769641947
  mo_energy =
[-1.18085448e+02 -1.21751799e+01 -9.52146875e+00 -9.52146875e+00
 -9.52146875e+00 -1.25160795e+00 -5.73602805e-01 -5.73602805e-01
 -5.73602805e-01  8.66975770e-01  8.66975770e-01  8.66975770e-01
  5.30167855e+00  5.30167855e+00  5.30167855e+00  2.36088337e+01
  2.36088337e+01  2.36088337e+01  9.55939431e+01  9.55939431e+01
  9.55939431e+01  1.83833041e+02  4.26545004e+02  4.26545004e+02
  4.26545004e+02  1.27936754e+03  1.27936754e+03  1.27936754e+03
  1.91552693e+03  2.98094187e+03  2.98094187e+03  2.98094187e+03
  6.60955033e+03  6.60955033e+03  6.60955033e+03  8.27357494e+03
  2.46611422e+04  7.54573205e+04]
E1 = -727.4838736783493  E_coul = 201.94449267002562
Extra cycle  E= -525.539381008324  delta_E= 7.96e-13  |g|= 5.79e-07  |ddm|= 1.09e-06
    CPU time for scf_cycle      0.47 sec, wall time      0.24 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 85456.95989608458
E1 = -727.4838736783493  E_coul = 201.94449267002562
init E= -525.539381008324
    CPU time for initialize scf      1.18 sec, wall time      0.18 sec
  HOMO = -0.57360258088049  LUMO = 0.866975905730263
  mo_energy =
[-1.18085446e+02 -1.21751790e+01 -9.52146784e+00 -9.52146784e+00
 -9.52146784e+00 -1.25160766e+00 -5.73602581e-01 -5.73602581e-01
 -5.73602581e-01  8.66975906e-01  8.66975906e-01  8.66975906e-01
  5.30167902e+00  5.30167902e+00  5.30167902e+00  2.36088345e+01
  2.36088345e+01  2.36088345e+01  9.55939442e+01  9.55939442e+01
  9.55939442e+01  1.83833042e+02  4.26545005e+02  4.26545005e+02
  4.26545005e+02  1.27936754e+03  1.27936754e+03  1.27936754e+03
  1.91552693e+03  2.98094188e+03  2.98094188e+03  2.98094188e+03
  6.60955033e+03  6.60955033e+03  6.60955033e+03  8.27357494e+03
  2.46611422e+04  7.54573205e+04]
E1 = -727.4838711107703  E_coul = 201.94449010244531
cycle= 1 E= -525.539381008325  delta_E= -1.36e-12  |g|= 1.32e-07  |ddm|= 2.57e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4838711107703  E_coul = 201.94449010244531
  HOMO = -0.573602629497219  LUMO = 0.866975875686806
  mo_energy =
[-1.18085447e+02 -1.21751792e+01 -9.52146803e+00 -9.52146803e+00
 -9.52146803e+00 -1.25160772e+00 -5.73602629e-01 -5.73602629e-01
 -5.73602629e-01  8.66975876e-01  8.66975876e-01  8.66975876e-01
  5.30167892e+00  5.30167892e+00  5.30167892e+00  2.36088344e+01
  2.36088344e+01  2.36088344e+01  9.55939440e+01  9.55939440e+01
  9.55939440e+01  1.83833042e+02  4.26545005e+02  4.26545005e+02
  4.26545005e+02  1.27936754e+03  1.27936754e+03  1.27936754e+03
  1.91552693e+03  2.98094188e+03  2.98094188e+03  2.98094188e+03
  6.60955033e+03  6.60955033e+03  6.60955033e+03  8.27357494e+03
  2.46611422e+04  7.54573205e+04]
E1 = -727.4838716471725  E_coul = 201.94449063884892
Extra cycle  E= -525.539381008324  delta_E= 1.48e-12  |g|= 2.85e-08  |ddm|= 4.84e-08
    CPU time for scf_cycle      1.27 sec, wall time      0.27 sec
exp = [2.61825081e+04 7.61824756e+03 3.61824432e+03 1.61815161e+03
 2.39734106e+02 5.23070894e+01 4.60178081e+00 3.99142795e-01
 1.36279284e+03 6.65178015e+02 3.03306152e+02 3.16133691e+02
 4.92398812e+01 5.58809291e+00 1.55525566e+01 6.77846377e-01
 2.08949661e+00 2.03004805e-01]
grad_E = [-1.98738323e-06  2.22828449e-05  4.50148090e-05  6.87271947e-04
 -5.93913943e-04  3.90918423e-03 -1.16852270e-03 -4.79638264e-04
  1.64984376e-06  2.21990217e-05  1.21455221e-04  1.07026990e-04
 -1.94067595e-03  1.38568866e-04 -1.07945543e-03  7.04059569e-03
 -2.63977713e-03 -6.35757766e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5081553        1
[INPUT] 0    0    [1    /1   ]  7618.24741025        1
[INPUT] 0    0    [1    /1   ]  3618.24402047        1
[INPUT] 0    0    [1    /1   ]  1618.14705132        1
[INPUT] 0    0    [1    /1   ]  239.735648784        1
[INPUT] 0    0    [1    /1   ]  52.2983689327        1
[INPUT] 0    0    [1    /1   ]  4.60152592177        1
[INPUT] 0    0    [1    /1   ]  0.399112422054       1
[INPUT] 1    0    [1    /1   ]  1362.79282794        1
[INPUT] 1    0    [1    /1   ]  665.177875354        1
[INPUT] 1    0    [1    /1   ]  303.305394207        1
[INPUT] 1    0    [1    /1   ]  316.133022633        1
[INPUT] 1    0    [1    /1   ]  49.2477374887        1
[INPUT] 1    0    [1    /1   ]  5.61922277886        1
[INPUT] 1    0    [1    /1   ]  15.5627503296        1
[INPUT] 1    0    [1    /1   ]  0.682154871234       1
[INPUT] 1    0    [1    /1   ]  2.11330931104        1
[INPUT] 1    0    [1    /1   ]  0.204139288996       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.50815534314, 1.0]], [0, [7618.247410253621, 1.0]], [0, [3618.24402047093, 1.0]], [0, [1618.1470513163604, 1.0]], [0, [239.73564878444643, 1.0]], [0, [52.298368932694856, 1.0]], [0, [4.601525921769534, 1.0]], [0, [0.3991124220539117, 1.0]], [1, [1362.7928279427924, 1.0]], [1, [665.1778753540668, 1.0]], [1, [303.3053942070332, 1.0]], [1, [316.1330226328479, 1.0]], [1, [49.247737488702214, 1.0]], [1, [5.619222778858469, 1.0]], [1, [15.562750329623958, 1.0]], [1, [0.6821548712336686, 1.0]], [1, [2.113309311035801, 1.0]], [1, [0.20413928899619316, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50815534]
bas 1, expnt(s) = [7618.24741025]
bas 2, expnt(s) = [3618.24402047]
bas 3, expnt(s) = [1618.14705132]
bas 4, expnt(s) = [239.73564878]
bas 5, expnt(s) = [52.29836893]
bas 6, expnt(s) = [4.60152592]
bas 7, expnt(s) = [0.39911242]
bas 8, expnt(s) = [1362.79282794]
bas 9, expnt(s) = [665.17787535]
bas 10, expnt(s) = [303.30539421]
bas 11, expnt(s) = [316.13302263]
bas 12, expnt(s) = [49.24773749]
bas 13, expnt(s) = [5.61922278]
bas 14, expnt(s) = [15.56275033]
bas 15, expnt(s) = [0.68215487]
bas 16, expnt(s) = [2.11330931]
bas 17, expnt(s) = [0.20413929]
CPU time:       152.50
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825082e+04 5.20024087e+03 7.61824741e+03 2.06018551e+03
 3.61824402e+03 1.17865964e+03 1.61814705e+03 6.44582505e+02
 2.39735649e+02 1.53926888e+02 5.22983689e+01 4.91338881e+01
 4.60152592e+00 7.93764056e+00 3.99112422e-01 1.26863433e+00
 1.36279283e+03 2.41558148e+04 6.65177875e+02 9.85500019e+03
 3.03305394e+02 3.69261951e+03 3.16133023e+02 3.88885475e+03
 4.92477375e+01 3.80598653e+02 5.61922278e+00 2.52394395e+01
 1.55627503e+01 9.01762831e+01 6.82154871e-01 1.80858166e+00
 2.11330931e+00 7.43341236e+00 2.04139289e-01 4.00306498e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97620643216582
cond(S) = 85518.84514298815
E1 = -727.522318854489  E_coul = 203.13495544622234
init E= -524.387363408267
    CPU time for initialize scf      0.16 sec, wall time      0.04 sec
  HOMO = -0.5601329026159  LUMO = 0.87949790381394
  mo_energy =
[-1.17866179e+02 -1.20952516e+01 -9.44325600e+00 -9.44325600e+00
 -9.44325600e+00 -1.23010272e+00 -5.60132903e-01 -5.60132903e-01
 -5.60132903e-01  8.79497904e-01  8.79497904e-01  8.79497904e-01
  5.40028418e+00  5.40028418e+00  5.40028418e+00  2.38625468e+01
  2.38625468e+01  2.38625468e+01  9.59632157e+01  9.59632157e+01
  9.59632157e+01  1.83976952e+02  4.26962364e+02  4.26962364e+02
  4.26962364e+02  1.27980719e+03  1.27980719e+03  1.27980719e+03
  1.91586284e+03  2.98142458e+03  2.98142458e+03  2.98142458e+03
  6.61012907e+03  6.61012907e+03  6.61012907e+03  8.27404260e+03
  2.46616983e+04  7.54579669e+04]
E1 = -727.3100492446899  E_coul = 201.7707867421445
cycle= 1 E= -525.539262502545  delta_E= -1.15  |g|= 0.186  |ddm|= 0.493
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.452021
diis-c [-0.20432261  1.        ]
  HOMO = -0.575657668693637  LUMO = 0.873079189362856
  mo_energy =
[-1.18112098e+02 -1.21877285e+01 -9.53436529e+00 -9.53436529e+00
 -9.53436529e+00 -1.25445773e+00 -5.75657669e-01 -5.75657669e-01
 -5.75657669e-01  8.73079189e-01  8.73079189e-01  8.73079189e-01
  5.35872956e+00  5.35872956e+00  5.35872956e+00  2.37782516e+01
  2.37782516e+01  2.37782516e+01  9.58138454e+01  9.58138454e+01
  9.58138454e+01  1.83783145e+02  4.26730869e+02  4.26730869e+02
  4.26730869e+02  1.27952803e+03  1.27952803e+03  1.27952803e+03
  1.91546731e+03  2.98108673e+03  2.98108673e+03  2.98108673e+03
  6.60967805e+03  6.60967805e+03  6.60967805e+03  8.27351069e+03
  2.46610735e+04  7.54572513e+04]
E1 = -727.5273024377636  E_coul = 201.98784993571147
cycle= 2 E= -525.539452502052  delta_E= -0.00019  |g|= 0.0155  |ddm|= 0.0146
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0307384
diis-c [-7.52771656e-04  2.98018931e-02  9.70198107e-01]
  HOMO = -0.572810941848088  LUMO = 0.874880297365219
  mo_energy =
[-1.18081210e+02 -1.21723891e+01 -9.51879581e+00 -9.51879581e+00
 -9.51879581e+00 -1.25062089e+00 -5.72810942e-01 -5.72810942e-01
 -5.72810942e-01  8.74880297e-01  8.74880297e-01  8.74880297e-01
  5.36547814e+00  5.36547814e+00  5.36547814e+00  2.37921876e+01
  2.37921876e+01  2.37921876e+01  9.58368351e+01  9.58368351e+01
  9.58368351e+01  1.83812849e+02  4.26761324e+02  4.26761324e+02
  4.26761324e+02  1.27956064e+03  1.27956064e+03  1.27956064e+03
  1.91550135e+03  2.98112037e+03  2.98112037e+03  2.98112037e+03
  6.60971229e+03  6.60971229e+03  6.60971229e+03  8.27354517e+03
  2.46611080e+04  7.54572857e+04]
E1 = -727.4807284108236  E_coul = 201.94126927963782
cycle= 3 E= -525.539459131186  delta_E= -6.63e-06  |g|= 0.00228  |ddm|= 0.00398
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00463533
diis-c [-1.19833110e-07 -7.16011238e-04  1.26888010e-01  8.73828001e-01]
  HOMO = -0.573409617668001  LUMO = 0.874505888996277
  mo_energy =
[-1.18085582e+02 -1.21748763e+01 -9.52132880e+00 -9.52132880e+00
 -9.52132880e+00 -1.25140496e+00 -5.73409618e-01 -5.73409618e-01
 -5.73409618e-01  8.74505889e-01  8.74505889e-01  8.74505889e-01
  5.36420378e+00  5.36420378e+00  5.36420378e+00  2.37898915e+01
  2.37898915e+01  2.37898915e+01  9.58334131e+01  9.58334131e+01
  9.58334131e+01  1.83808667e+02  4.26757011e+02  4.26757011e+02
  4.26757011e+02  1.27955607e+03  1.27955607e+03  1.27955607e+03
  1.91549656e+03  2.98111565e+03  2.98111565e+03  2.98111565e+03
  6.60970744e+03  6.60970744e+03  6.60970744e+03  8.27354024e+03
  2.46611030e+04  7.54572807e+04]
E1 = -727.4879395183527  E_coul = 201.94848018229519
cycle= 4 E= -525.539459336058  delta_E= -2.05e-07  |g|= 4.27e-05  |ddm|= 0.000636
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.82935e-05
diis-c [-3.47705872e-10 -2.62391996e-05  4.46293581e-03  4.59425649e-02
  9.49620739e-01]
  HOMO = -0.573386641397157  LUMO = 0.874519860462446
  mo_energy =
[-1.18085487e+02 -1.21747972e+01 -9.52124885e+00 -9.52124885e+00
 -9.52124885e+00 -1.25137464e+00 -5.73386641e-01 -5.73386641e-01
 -5.73386641e-01  8.74519860e-01  8.74519860e-01  8.74519860e-01
  5.36425026e+00  5.36425026e+00  5.36425026e+00  2.37899645e+01
  2.37899645e+01  2.37899645e+01  9.58335010e+01  9.58335010e+01
  9.58335010e+01  1.83808762e+02  4.26757106e+02  4.26757106e+02
  4.26757106e+02  1.27955617e+03  1.27955617e+03  1.27955617e+03
  1.91549665e+03  2.98111575e+03  2.98111575e+03  2.98111575e+03
  6.60970753e+03  6.60970753e+03  6.60970753e+03  8.27354034e+03
  2.46611031e+04  7.54572808e+04]
E1 = -727.4877265647277  E_coul = 201.94826722850303
cycle= 5 E= -525.539459336225  delta_E= -1.67e-10  |g|= 2.38e-06  |ddm|= 2.38e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4877265647277  E_coul = 201.94826722850303
  HOMO = -0.573388172025324  LUMO = 0.874518904489545
  mo_energy =
[-1.18085493e+02 -1.21748018e+01 -9.52125347e+00 -9.52125347e+00
 -9.52125347e+00 -1.25137658e+00 -5.73388172e-01 -5.73388172e-01
 -5.73388172e-01  8.74518904e-01  8.74518904e-01  8.74518904e-01
  5.36424737e+00  5.36424737e+00  5.36424737e+00  2.37899602e+01
  2.37899602e+01  2.37899602e+01  9.58334957e+01  9.58334957e+01
  9.58334957e+01  1.83808756e+02  4.26757100e+02  4.26757100e+02
  4.26757100e+02  1.27955616e+03  1.27955616e+03  1.27955616e+03
  1.91549665e+03  2.98111574e+03  2.98111574e+03  2.98111574e+03
  6.60970753e+03  6.60970753e+03  6.60970753e+03  8.27354033e+03
  2.46611031e+04  7.54572808e+04]
E1 = -727.4877383928706  E_coul = 201.94827905664525
Extra cycle  E= -525.539459336225  delta_E= -6.82e-13  |g|= 5.72e-07  |ddm|= 1.08e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.23 sec
exp = [2.61825082e+04 7.61824741e+03 3.61824402e+03 1.61814705e+03
 2.39735649e+02 5.22983689e+01 4.60152592e+00 3.99112422e-01
 1.36279283e+03 6.65177875e+02 3.03305394e+02 3.16133023e+02
 4.92477375e+01 5.61922278e+00 1.55627503e+01 6.82154871e-01
 2.11330931e+00 2.04139289e-01]
E = -525.5394593362254
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5081553        1
[INPUT] 0    0    [1    /1   ]  7618.24741025        1
[INPUT] 0    0    [1    /1   ]  3618.24402047        1
[INPUT] 0    0    [1    /1   ]  1618.14705132        1
[INPUT] 0    0    [1    /1   ]  239.735648784        1
[INPUT] 0    0    [1    /1   ]  52.2983689327        1
[INPUT] 0    0    [1    /1   ]  4.60152592177        1
[INPUT] 0    0    [1    /1   ]  0.399112422054       1
[INPUT] 1    0    [1    /1   ]  1362.79282794        1
[INPUT] 1    0    [1    /1   ]  665.177875354        1
[INPUT] 1    0    [1    /1   ]  303.305394207        1
[INPUT] 1    0    [1    /1   ]  316.133022633        1
[INPUT] 1    0    [1    /1   ]  49.2477374887        1
[INPUT] 1    0    [1    /1   ]  5.61922277886        1
[INPUT] 1    0    [1    /1   ]  15.5627503296        1
[INPUT] 1    0    [1    /1   ]  0.682154871234       1
[INPUT] 1    0    [1    /1   ]  2.11330931104        1
[INPUT] 1    0    [1    /1   ]  0.204139288996       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.50815534314, 1.0]], [0, [7618.247410253621, 1.0]], [0, [3618.24402047093, 1.0]], [0, [1618.1470513163604, 1.0]], [0, [239.73564878444643, 1.0]], [0, [52.298368932694856, 1.0]], [0, [4.601525921769534, 1.0]], [0, [0.3991124220539117, 1.0]], [1, [1362.7928279427924, 1.0]], [1, [665.1778753540668, 1.0]], [1, [303.3053942070332, 1.0]], [1, [316.1330226328479, 1.0]], [1, [49.247737488702214, 1.0]], [1, [5.619222778858469, 1.0]], [1, [15.562750329623958, 1.0]], [1, [0.6821548712336686, 1.0]], [1, [2.113309311035801, 1.0]], [1, [0.20413928899619316, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50815534]
bas 1, expnt(s) = [7618.24741025]
bas 2, expnt(s) = [3618.24402047]
bas 3, expnt(s) = [1618.14705132]
bas 4, expnt(s) = [239.73564878]
bas 5, expnt(s) = [52.29836893]
bas 6, expnt(s) = [4.60152592]
bas 7, expnt(s) = [0.39911242]
bas 8, expnt(s) = [1362.79282794]
bas 9, expnt(s) = [665.17787535]
bas 10, expnt(s) = [303.30539421]
bas 11, expnt(s) = [316.13302263]
bas 12, expnt(s) = [49.24773749]
bas 13, expnt(s) = [5.61922278]
bas 14, expnt(s) = [15.56275033]
bas 15, expnt(s) = [0.68215487]
bas 16, expnt(s) = [2.11330931]
bas 17, expnt(s) = [0.20413929]
CPU time:       152.99
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825082e+04 5.20024087e+03 7.61824741e+03 2.06018551e+03
 3.61824402e+03 1.17865964e+03 1.61814705e+03 6.44582505e+02
 2.39735649e+02 1.53926888e+02 5.22983689e+01 4.91338881e+01
 4.60152592e+00 7.93764056e+00 3.99112422e-01 1.26863433e+00
 1.36279283e+03 2.41558148e+04 6.65177875e+02 9.85500019e+03
 3.03305394e+02 3.69261951e+03 3.16133023e+02 3.88885475e+03
 4.92477375e+01 3.80598653e+02 5.61922278e+00 2.52394395e+01
 1.55627503e+01 9.01762831e+01 6.82154871e-01 1.80858166e+00
 2.11330931e+00 7.43341236e+00 2.04139289e-01 4.00306498e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97620643216582
cond(S) = 85518.84514298815
E1 = -727.522318854489  E_coul = 203.13495544622234
init E= -524.387363408267
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.5601329026159  LUMO = 0.87949790381394
  mo_energy =
[-1.17866179e+02 -1.20952516e+01 -9.44325600e+00 -9.44325600e+00
 -9.44325600e+00 -1.23010272e+00 -5.60132903e-01 -5.60132903e-01
 -5.60132903e-01  8.79497904e-01  8.79497904e-01  8.79497904e-01
  5.40028418e+00  5.40028418e+00  5.40028418e+00  2.38625468e+01
  2.38625468e+01  2.38625468e+01  9.59632157e+01  9.59632157e+01
  9.59632157e+01  1.83976952e+02  4.26962364e+02  4.26962364e+02
  4.26962364e+02  1.27980719e+03  1.27980719e+03  1.27980719e+03
  1.91586284e+03  2.98142458e+03  2.98142458e+03  2.98142458e+03
  6.61012907e+03  6.61012907e+03  6.61012907e+03  8.27404260e+03
  2.46616983e+04  7.54579669e+04]
E1 = -727.3100492446899  E_coul = 201.7707867421445
cycle= 1 E= -525.539262502545  delta_E= -1.15  |g|= 0.186  |ddm|= 0.493
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.452021
diis-c [-0.20432261  1.        ]
  HOMO = -0.575657668693637  LUMO = 0.873079189362856
  mo_energy =
[-1.18112098e+02 -1.21877285e+01 -9.53436529e+00 -9.53436529e+00
 -9.53436529e+00 -1.25445773e+00 -5.75657669e-01 -5.75657669e-01
 -5.75657669e-01  8.73079189e-01  8.73079189e-01  8.73079189e-01
  5.35872956e+00  5.35872956e+00  5.35872956e+00  2.37782516e+01
  2.37782516e+01  2.37782516e+01  9.58138454e+01  9.58138454e+01
  9.58138454e+01  1.83783145e+02  4.26730869e+02  4.26730869e+02
  4.26730869e+02  1.27952803e+03  1.27952803e+03  1.27952803e+03
  1.91546731e+03  2.98108673e+03  2.98108673e+03  2.98108673e+03
  6.60967805e+03  6.60967805e+03  6.60967805e+03  8.27351069e+03
  2.46610735e+04  7.54572513e+04]
E1 = -727.5273024377636  E_coul = 201.98784993571147
cycle= 2 E= -525.539452502052  delta_E= -0.00019  |g|= 0.0155  |ddm|= 0.0146
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0307384
diis-c [-7.52771656e-04  2.98018931e-02  9.70198107e-01]
  HOMO = -0.572810941848088  LUMO = 0.874880297365219
  mo_energy =
[-1.18081210e+02 -1.21723891e+01 -9.51879581e+00 -9.51879581e+00
 -9.51879581e+00 -1.25062089e+00 -5.72810942e-01 -5.72810942e-01
 -5.72810942e-01  8.74880297e-01  8.74880297e-01  8.74880297e-01
  5.36547814e+00  5.36547814e+00  5.36547814e+00  2.37921876e+01
  2.37921876e+01  2.37921876e+01  9.58368351e+01  9.58368351e+01
  9.58368351e+01  1.83812849e+02  4.26761324e+02  4.26761324e+02
  4.26761324e+02  1.27956064e+03  1.27956064e+03  1.27956064e+03
  1.91550135e+03  2.98112037e+03  2.98112037e+03  2.98112037e+03
  6.60971229e+03  6.60971229e+03  6.60971229e+03  8.27354517e+03
  2.46611080e+04  7.54572857e+04]
E1 = -727.4807284108236  E_coul = 201.94126927963782
cycle= 3 E= -525.539459131186  delta_E= -6.63e-06  |g|= 0.00228  |ddm|= 0.00398
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00463533
diis-c [-1.19833110e-07 -7.16011238e-04  1.26888010e-01  8.73828001e-01]
  HOMO = -0.573409617668001  LUMO = 0.874505888996277
  mo_energy =
[-1.18085582e+02 -1.21748763e+01 -9.52132880e+00 -9.52132880e+00
 -9.52132880e+00 -1.25140496e+00 -5.73409618e-01 -5.73409618e-01
 -5.73409618e-01  8.74505889e-01  8.74505889e-01  8.74505889e-01
  5.36420378e+00  5.36420378e+00  5.36420378e+00  2.37898915e+01
  2.37898915e+01  2.37898915e+01  9.58334131e+01  9.58334131e+01
  9.58334131e+01  1.83808667e+02  4.26757011e+02  4.26757011e+02
  4.26757011e+02  1.27955607e+03  1.27955607e+03  1.27955607e+03
  1.91549656e+03  2.98111565e+03  2.98111565e+03  2.98111565e+03
  6.60970744e+03  6.60970744e+03  6.60970744e+03  8.27354024e+03
  2.46611030e+04  7.54572807e+04]
E1 = -727.4879395183527  E_coul = 201.94848018229519
cycle= 4 E= -525.539459336058  delta_E= -2.05e-07  |g|= 4.27e-05  |ddm|= 0.000636
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.82935e-05
diis-c [-3.47705872e-10 -2.62391996e-05  4.46293581e-03  4.59425649e-02
  9.49620739e-01]
  HOMO = -0.573386641397157  LUMO = 0.874519860462446
  mo_energy =
[-1.18085487e+02 -1.21747972e+01 -9.52124885e+00 -9.52124885e+00
 -9.52124885e+00 -1.25137464e+00 -5.73386641e-01 -5.73386641e-01
 -5.73386641e-01  8.74519860e-01  8.74519860e-01  8.74519860e-01
  5.36425026e+00  5.36425026e+00  5.36425026e+00  2.37899645e+01
  2.37899645e+01  2.37899645e+01  9.58335010e+01  9.58335010e+01
  9.58335010e+01  1.83808762e+02  4.26757106e+02  4.26757106e+02
  4.26757106e+02  1.27955617e+03  1.27955617e+03  1.27955617e+03
  1.91549665e+03  2.98111575e+03  2.98111575e+03  2.98111575e+03
  6.60970753e+03  6.60970753e+03  6.60970753e+03  8.27354034e+03
  2.46611031e+04  7.54572808e+04]
E1 = -727.4877265647277  E_coul = 201.94826722850303
cycle= 5 E= -525.539459336225  delta_E= -1.67e-10  |g|= 2.38e-06  |ddm|= 2.38e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4877265647277  E_coul = 201.94826722850303
  HOMO = -0.573388172025324  LUMO = 0.874518904489545
  mo_energy =
[-1.18085493e+02 -1.21748018e+01 -9.52125347e+00 -9.52125347e+00
 -9.52125347e+00 -1.25137658e+00 -5.73388172e-01 -5.73388172e-01
 -5.73388172e-01  8.74518904e-01  8.74518904e-01  8.74518904e-01
  5.36424737e+00  5.36424737e+00  5.36424737e+00  2.37899602e+01
  2.37899602e+01  2.37899602e+01  9.58334957e+01  9.58334957e+01
  9.58334957e+01  1.83808756e+02  4.26757100e+02  4.26757100e+02
  4.26757100e+02  1.27955616e+03  1.27955616e+03  1.27955616e+03
  1.91549665e+03  2.98111574e+03  2.98111574e+03  2.98111574e+03
  6.60970753e+03  6.60970753e+03  6.60970753e+03  8.27354033e+03
  2.46611031e+04  7.54572808e+04]
E1 = -727.4877383928706  E_coul = 201.94827905664525
Extra cycle  E= -525.539459336225  delta_E= -6.82e-13  |g|= 5.72e-07  |ddm|= 1.08e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 85518.84514298815
E1 = -727.4877383928706  E_coul = 201.94827905664525
init E= -525.539459336225
    CPU time for initialize scf      0.95 sec, wall time      0.18 sec
  HOMO = -0.573387950985221  LUMO = 0.874519040206065
  mo_energy =
[-1.18085491e+02 -1.21748009e+01 -9.52125257e+00 -9.52125257e+00
 -9.52125257e+00 -1.25137629e+00 -5.73387951e-01 -5.73387951e-01
 -5.73387951e-01  8.74519040e-01  8.74519040e-01  8.74519040e-01
  5.36424784e+00  5.36424784e+00  5.36424784e+00  2.37899610e+01
  2.37899610e+01  2.37899610e+01  9.58334968e+01  9.58334968e+01
  9.58334968e+01  1.83808758e+02  4.26757102e+02  4.26757102e+02
  4.26757102e+02  1.27955616e+03  1.27955616e+03  1.27955616e+03
  1.91549665e+03  2.98111575e+03  2.98111575e+03  2.98111575e+03
  6.60970753e+03  6.60970753e+03  6.60970753e+03  8.27354033e+03
  2.46611031e+04  7.54572808e+04]
E1 = -727.4877358698056  E_coul = 201.94827653357876
cycle= 1 E= -525.539459336227  delta_E= -1.48e-12  |g|= 1.3e-07  |ddm|= 2.52e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4877358698056  E_coul = 201.94827653357876
  HOMO = -0.573387998620278  LUMO = 0.874519010508245
  mo_energy =
[-1.18085492e+02 -1.21748011e+01 -9.52125276e+00 -9.52125276e+00
 -9.52125276e+00 -1.25137635e+00 -5.73387999e-01 -5.73387999e-01
 -5.73387999e-01  8.74519011e-01  8.74519011e-01  8.74519011e-01
  5.36424774e+00  5.36424774e+00  5.36424774e+00  2.37899608e+01
  2.37899608e+01  2.37899608e+01  9.58334966e+01  9.58334966e+01
  9.58334966e+01  1.83808757e+02  4.26757101e+02  4.26757101e+02
  4.26757101e+02  1.27955616e+03  1.27955616e+03  1.27955616e+03
  1.91549665e+03  2.98111574e+03  2.98111574e+03  2.98111574e+03
  6.60970753e+03  6.60970753e+03  6.60970753e+03  8.27354033e+03
  2.46611031e+04  7.54572808e+04]
E1 = -727.4877363963755  E_coul = 201.9482770601487
Extra cycle  E= -525.539459336227  delta_E= 1.14e-13  |g|= 2.8e-08  |ddm|= 4.77e-08
    CPU time for scf_cycle      1.06 sec, wall time      0.29 sec
exp = [2.61825082e+04 7.61824741e+03 3.61824402e+03 1.61814705e+03
 2.39735649e+02 5.22983689e+01 4.60152592e+00 3.99112422e-01
 1.36279283e+03 6.65177875e+02 3.03305394e+02 3.16133023e+02
 4.92477375e+01 5.61922278e+00 1.55627503e+01 6.82154871e-01
 2.11330931e+00 2.04139289e-01]
grad_E = [-1.98735724e-06  2.22701647e-05  4.49756336e-05  6.86804387e-04
 -5.60817887e-04  3.67417811e-03 -1.39839268e-03 -4.60410713e-04
  1.62760211e-06  2.20423646e-05  1.20492231e-04  1.06177529e-04
 -1.81322486e-03  2.07248384e-03 -2.03874063e-03  5.92580552e-03
 -3.15722485e-03 -1.37028459e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5081877        1
[INPUT] 0    0    [1    /1   ]  7618.24704983        1
[INPUT] 0    0    [1    /1   ]  3618.24329496        1
[INPUT] 0    0    [1    /1   ]  1618.13595215        1
[INPUT] 0    0    [1    /1   ]  239.738454926        1
[INPUT] 0    0    [1    /1   ]  52.283971058         1
[INPUT] 0    0    [1    /1   ]  4.60149890673        1
[INPUT] 0    0    [1    /1   ]  0.399081757972       1
[INPUT] 1    0    [1    /1   ]  1362.79280496        1
[INPUT] 1    0    [1    /1   ]  665.17754175         1
[INPUT] 1    0    [1    /1   ]  303.3035862          1
[INPUT] 1    0    [1    /1   ]  316.131429547        1
[INPUT] 1    0    [1    /1   ]  49.2620600534        1
[INPUT] 1    0    [1    /1   ]  5.68328636834        1
[INPUT] 1    0    [1    /1   ]  15.6081160241        1
[INPUT] 1    0    [1    /1   ]  0.687647410572       1
[INPUT] 1    0    [1    /1   ]  2.16414226227        1
[INPUT] 1    0    [1    /1   ]  0.205001211038       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508187706484, 1.0]], [0, [7618.247049829488, 1.0]], [0, [3618.243294961656, 1.0]], [0, [1618.1359521520303, 1.0]], [0, [239.738454925884, 1.0]], [0, [52.283971058048316, 1.0]], [0, [4.601498906726797, 1.0]], [0, [0.39908175797172274, 1.0]], [1, [1362.792804960295, 1.0]], [1, [665.1775417499714, 1.0]], [1, [303.3035862001583, 1.0]], [1, [316.131429547155, 1.0]], [1, [49.262060053420065, 1.0]], [1, [5.683286368343019, 1.0]], [1, [15.608116024125735, 1.0]], [1, [0.6876474105718126, 1.0]], [1, [2.164142262271247, 1.0]], [1, [0.20500121103791508, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50818771]
bas 1, expnt(s) = [7618.24704983]
bas 2, expnt(s) = [3618.24329496]
bas 3, expnt(s) = [1618.13595215]
bas 4, expnt(s) = [239.73845493]
bas 5, expnt(s) = [52.28397106]
bas 6, expnt(s) = [4.60149891]
bas 7, expnt(s) = [0.39908176]
bas 8, expnt(s) = [1362.79280496]
bas 9, expnt(s) = [665.17754175]
bas 10, expnt(s) = [303.3035862]
bas 11, expnt(s) = [316.13142955]
bas 12, expnt(s) = [49.26206005]
bas 13, expnt(s) = [5.68328637]
bas 14, expnt(s) = [15.60811602]
bas 15, expnt(s) = [0.68764741]
bas 16, expnt(s) = [2.16414226]
bas 17, expnt(s) = [0.20500121]
CPU time:       158.48
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825082e+04 5.20024087e+03 7.61824705e+03 2.06018544e+03
 3.61824329e+03 1.17865947e+03 1.61813595e+03 6.44579189e+02
 2.39738455e+02 1.53928239e+02 5.22839711e+01 4.91237428e+01
 4.60149891e+00 7.93760561e+00 3.99081758e-01 1.26856122e+00
 1.36279280e+03 2.41558143e+04 6.65177542e+02 9.85499401e+03
 3.03303586e+02 3.69259200e+03 3.16131430e+02 3.88883025e+03
 4.92620601e+01 3.80737018e+02 5.68328637e+00 2.55996376e+01
 1.56081160e+01 9.05049845e+01 6.87647411e-01 1.82680275e+00
 2.16414226e+00 7.65758190e+00 2.05001211e-01 4.02420342e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97611200319285
cond(S) = 85661.25757209143
E1 = -727.5234155808972  E_coul = 203.1339128246217
init E= -524.389502756276
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.560097204028502  LUMO = 0.887110842257603
  mo_energy =
[-1.17866475e+02 -1.20951720e+01 -9.44341343e+00 -9.44341343e+00
 -9.44341343e+00 -1.23011410e+00 -5.60097204e-01 -5.60097204e-01
 -5.60097204e-01  8.87110842e-01  8.87110842e-01  8.87110842e-01
  5.51365247e+00  5.51365247e+00  5.51365247e+00  2.42379425e+01
  2.42379425e+01  2.42379425e+01  9.65146196e+01  9.65146196e+01
  9.65146196e+01  1.83938397e+02  4.27467437e+02  4.27467437e+02
  4.27467437e+02  1.28025716e+03  1.28025716e+03  1.28025716e+03
  1.91581314e+03  2.98183955e+03  2.98183955e+03  2.98183955e+03
  6.61050448e+03  6.61050448e+03  6.61050448e+03  8.27398021e+03
  2.46616239e+04  7.54578897e+04]
E1 = -727.3082466817998  E_coul = 201.76885169927803
cycle= 1 E= -525.539394982522  delta_E= -1.15  |g|= 0.185  |ddm|= 0.477
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.452723
diis-c [-0.20495772  1.        ]
  HOMO = -0.575593362998235  LUMO = 0.880574937359639
  mo_energy =
[-1.18112729e+02 -1.21876883e+01 -9.53458266e+00 -9.53458266e+00
 -9.53458266e+00 -1.25444164e+00 -5.75593363e-01 -5.75593363e-01
 -5.75593363e-01  8.80574937e-01  8.80574937e-01  8.80574937e-01
  5.47141920e+00  5.47141920e+00  5.47141920e+00  2.41532525e+01
  2.41532525e+01  2.41532525e+01  9.63651137e+01  9.63651137e+01
  9.63651137e+01  1.83744311e+02  4.27235624e+02  4.27235624e+02
  4.27235624e+02  1.27997747e+03  1.27997747e+03  1.27997747e+03
  1.91541675e+03  2.98150097e+03  2.98150097e+03  2.98150097e+03
  6.61005257e+03  6.61005257e+03  6.61005257e+03  8.27344729e+03
  2.46609980e+04  7.54571730e+04]
E1 = -727.5259181250839  E_coul = 201.9863327701421
cycle= 2 E= -525.539585354942  delta_E= -0.00019  |g|= 0.0155  |ddm|= 0.0147
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0309019
diis-c [-7.57642580e-04  3.01454892e-02  9.69854511e-01]
  HOMO = -0.572736751682761  LUMO = 0.882405721006841
  mo_energy =
[-1.18081801e+02 -1.21723280e+01 -9.51899181e+00 -9.51899181e+00
 -9.51899181e+00 -1.25059366e+00 -5.72736752e-01 -5.72736752e-01
 -5.72736752e-01  8.82405721e-01  8.82405721e-01  8.82405721e-01
  5.47828634e+00  5.47828634e+00  5.47828634e+00  2.41672605e+01
  2.41672605e+01  2.41672605e+01  9.63881280e+01  9.63881280e+01
  9.63881280e+01  1.83774053e+02  4.27266114e+02  4.27266114e+02
  4.27266114e+02  1.28001012e+03  1.28001012e+03  1.28001012e+03
  1.91545083e+03  2.98153464e+03  2.98153464e+03  2.98153464e+03
  6.61008684e+03  6.61008684e+03  6.61008684e+03  8.27348181e+03
  2.46610326e+04  7.54572074e+04]
E1 = -727.4793719584993  E_coul = 201.93977996312748
cycle= 3 E= -525.539591995372  delta_E= -6.64e-06  |g|= 0.00228  |ddm|= 0.00399
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00464468
diis-c [-1.17191365e-07 -7.17414639e-04  1.26495495e-01  8.74221920e-01]
  HOMO = -0.573332808108729  LUMO = 0.88202861539863
  mo_energy =
[-1.18086164e+02 -1.21748086e+01 -9.52151828e+00 -9.52151828e+00
 -9.52151828e+00 -1.25137453e+00 -5.73332808e-01 -5.73332808e-01
 -5.73332808e-01  8.82028615e-01  8.82028615e-01  8.82028615e-01
  5.47699964e+00  5.47699964e+00  5.47699964e+00  2.41649635e+01
  2.41649635e+01  2.41649635e+01  9.63847146e+01  9.63847146e+01
  9.63847146e+01  1.83769881e+02  4.27261811e+02  4.27261811e+02
  4.27261811e+02  1.28000555e+03  1.28000555e+03  1.28000555e+03
  1.91544604e+03  2.98152994e+03  2.98152994e+03  2.98152994e+03
  6.61008201e+03  6.61008201e+03  6.61008201e+03  8.27347690e+03
  2.46610276e+04  7.54572024e+04]
E1 = -727.4865561997261  E_coul = 201.94696400079596
cycle= 4 E= -525.53959219893  delta_E= -2.04e-07  |g|= 4.24e-05  |ddm|= 0.000638
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.77922e-05
diis-c [-3.46066942e-10 -2.67018488e-05  4.49528021e-03  4.61462342e-02
  9.49385187e-01]
  HOMO = -0.573309826680568  LUMO = 0.882042769468093
  mo_energy =
[-1.18086069e+02 -1.21747300e+01 -9.52143875e+00 -9.52143875e+00
 -9.52143875e+00 -1.25134424e+00 -5.73309827e-01 -5.73309827e-01
 -5.73309827e-01  8.82042769e-01  8.82042769e-01  8.82042769e-01
  5.47704657e+00  5.47704657e+00  5.47704657e+00  2.41650363e+01
  2.41650363e+01  2.41650363e+01  9.63848021e+01  9.63848021e+01
  9.63848021e+01  1.83769975e+02  4.27261906e+02  4.27261906e+02
  4.27261906e+02  1.28000565e+03  1.28000565e+03  1.28000565e+03
  1.91544614e+03  2.98153003e+03  2.98153003e+03  2.98153003e+03
  6.61008210e+03  6.61008210e+03  6.61008210e+03  8.27347699e+03
  2.46610277e+04  7.54572025e+04]
E1 = -727.4863452390102  E_coul = 201.946753039914
cycle= 5 E= -525.539592199096  delta_E= -1.66e-10  |g|= 2.35e-06  |ddm|= 2.36e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4863452390102  E_coul = 201.946753039914
  HOMO = -0.573311321148175  LUMO = 0.882041827302845
  mo_energy =
[-1.18086075e+02 -1.21747345e+01 -9.52144332e+00 -9.52144332e+00
 -9.52144332e+00 -1.25134613e+00 -5.73311321e-01 -5.73311321e-01
 -5.73311321e-01  8.82041827e-01  8.82041827e-01  8.82041827e-01
  5.47704370e+00  5.47704370e+00  5.47704370e+00  2.41650320e+01
  2.41650320e+01  2.41650320e+01  9.63847968e+01  9.63847968e+01
  9.63847968e+01  1.83769969e+02  4.27261900e+02  4.27261900e+02
  4.27261900e+02  1.28000564e+03  1.28000564e+03  1.28000564e+03
  1.91544613e+03  2.98153003e+03  2.98153003e+03  2.98153003e+03
  6.61008209e+03  6.61008209e+03  6.61008209e+03  8.27347698e+03
  2.46610277e+04  7.54572025e+04]
E1 = -727.4863569577404  E_coul = 201.9467647586446
Extra cycle  E= -525.539592199096  delta_E= 3.41e-13  |g|= 5.67e-07  |ddm|= 1.08e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
exp = [2.61825082e+04 7.61824705e+03 3.61824329e+03 1.61813595e+03
 2.39738455e+02 5.22839711e+01 4.60149891e+00 3.99081758e-01
 1.36279280e+03 6.65177542e+02 3.03303586e+02 3.16131430e+02
 4.92620601e+01 5.68328637e+00 1.56081160e+01 6.87647411e-01
 2.16414226e+00 2.05001211e-01]
E = -525.5395921990959
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5081877        1
[INPUT] 0    0    [1    /1   ]  7618.24704983        1
[INPUT] 0    0    [1    /1   ]  3618.24329496        1
[INPUT] 0    0    [1    /1   ]  1618.13595215        1
[INPUT] 0    0    [1    /1   ]  239.738454926        1
[INPUT] 0    0    [1    /1   ]  52.283971058         1
[INPUT] 0    0    [1    /1   ]  4.60149890673        1
[INPUT] 0    0    [1    /1   ]  0.399081757972       1
[INPUT] 1    0    [1    /1   ]  1362.79280496        1
[INPUT] 1    0    [1    /1   ]  665.17754175         1
[INPUT] 1    0    [1    /1   ]  303.3035862          1
[INPUT] 1    0    [1    /1   ]  316.131429547        1
[INPUT] 1    0    [1    /1   ]  49.2620600534        1
[INPUT] 1    0    [1    /1   ]  5.68328636834        1
[INPUT] 1    0    [1    /1   ]  15.6081160241        1
[INPUT] 1    0    [1    /1   ]  0.687647410572       1
[INPUT] 1    0    [1    /1   ]  2.16414226227        1
[INPUT] 1    0    [1    /1   ]  0.205001211038       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508187706484, 1.0]], [0, [7618.247049829488, 1.0]], [0, [3618.243294961656, 1.0]], [0, [1618.1359521520303, 1.0]], [0, [239.738454925884, 1.0]], [0, [52.283971058048316, 1.0]], [0, [4.601498906726797, 1.0]], [0, [0.39908175797172274, 1.0]], [1, [1362.792804960295, 1.0]], [1, [665.1775417499714, 1.0]], [1, [303.3035862001583, 1.0]], [1, [316.131429547155, 1.0]], [1, [49.262060053420065, 1.0]], [1, [5.683286368343019, 1.0]], [1, [15.608116024125735, 1.0]], [1, [0.6876474105718126, 1.0]], [1, [2.164142262271247, 1.0]], [1, [0.20500121103791508, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50818771]
bas 1, expnt(s) = [7618.24704983]
bas 2, expnt(s) = [3618.24329496]
bas 3, expnt(s) = [1618.13595215]
bas 4, expnt(s) = [239.73845493]
bas 5, expnt(s) = [52.28397106]
bas 6, expnt(s) = [4.60149891]
bas 7, expnt(s) = [0.39908176]
bas 8, expnt(s) = [1362.79280496]
bas 9, expnt(s) = [665.17754175]
bas 10, expnt(s) = [303.3035862]
bas 11, expnt(s) = [316.13142955]
bas 12, expnt(s) = [49.26206005]
bas 13, expnt(s) = [5.68328637]
bas 14, expnt(s) = [15.60811602]
bas 15, expnt(s) = [0.68764741]
bas 16, expnt(s) = [2.16414226]
bas 17, expnt(s) = [0.20500121]
CPU time:       158.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825082e+04 5.20024087e+03 7.61824705e+03 2.06018544e+03
 3.61824329e+03 1.17865947e+03 1.61813595e+03 6.44579189e+02
 2.39738455e+02 1.53928239e+02 5.22839711e+01 4.91237428e+01
 4.60149891e+00 7.93760561e+00 3.99081758e-01 1.26856122e+00
 1.36279280e+03 2.41558143e+04 6.65177542e+02 9.85499401e+03
 3.03303586e+02 3.69259200e+03 3.16131430e+02 3.88883025e+03
 4.92620601e+01 3.80737018e+02 5.68328637e+00 2.55996376e+01
 1.56081160e+01 9.05049845e+01 6.87647411e-01 1.82680275e+00
 2.16414226e+00 7.65758190e+00 2.05001211e-01 4.02420342e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97611200319285
cond(S) = 85661.25757209143
E1 = -727.5234155808972  E_coul = 203.1339128246217
init E= -524.389502756276
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.560097204028502  LUMO = 0.887110842257603
  mo_energy =
[-1.17866475e+02 -1.20951720e+01 -9.44341343e+00 -9.44341343e+00
 -9.44341343e+00 -1.23011410e+00 -5.60097204e-01 -5.60097204e-01
 -5.60097204e-01  8.87110842e-01  8.87110842e-01  8.87110842e-01
  5.51365247e+00  5.51365247e+00  5.51365247e+00  2.42379425e+01
  2.42379425e+01  2.42379425e+01  9.65146196e+01  9.65146196e+01
  9.65146196e+01  1.83938397e+02  4.27467437e+02  4.27467437e+02
  4.27467437e+02  1.28025716e+03  1.28025716e+03  1.28025716e+03
  1.91581314e+03  2.98183955e+03  2.98183955e+03  2.98183955e+03
  6.61050448e+03  6.61050448e+03  6.61050448e+03  8.27398021e+03
  2.46616239e+04  7.54578897e+04]
E1 = -727.3082466817998  E_coul = 201.76885169927803
cycle= 1 E= -525.539394982522  delta_E= -1.15  |g|= 0.185  |ddm|= 0.477
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.452723
diis-c [-0.20495772  1.        ]
  HOMO = -0.575593362998235  LUMO = 0.880574937359639
  mo_energy =
[-1.18112729e+02 -1.21876883e+01 -9.53458266e+00 -9.53458266e+00
 -9.53458266e+00 -1.25444164e+00 -5.75593363e-01 -5.75593363e-01
 -5.75593363e-01  8.80574937e-01  8.80574937e-01  8.80574937e-01
  5.47141920e+00  5.47141920e+00  5.47141920e+00  2.41532525e+01
  2.41532525e+01  2.41532525e+01  9.63651137e+01  9.63651137e+01
  9.63651137e+01  1.83744311e+02  4.27235624e+02  4.27235624e+02
  4.27235624e+02  1.27997747e+03  1.27997747e+03  1.27997747e+03
  1.91541675e+03  2.98150097e+03  2.98150097e+03  2.98150097e+03
  6.61005257e+03  6.61005257e+03  6.61005257e+03  8.27344729e+03
  2.46609980e+04  7.54571730e+04]
E1 = -727.5259181250839  E_coul = 201.9863327701421
cycle= 2 E= -525.539585354942  delta_E= -0.00019  |g|= 0.0155  |ddm|= 0.0147
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0309019
diis-c [-7.57642580e-04  3.01454892e-02  9.69854511e-01]
  HOMO = -0.572736751682761  LUMO = 0.882405721006841
  mo_energy =
[-1.18081801e+02 -1.21723280e+01 -9.51899181e+00 -9.51899181e+00
 -9.51899181e+00 -1.25059366e+00 -5.72736752e-01 -5.72736752e-01
 -5.72736752e-01  8.82405721e-01  8.82405721e-01  8.82405721e-01
  5.47828634e+00  5.47828634e+00  5.47828634e+00  2.41672605e+01
  2.41672605e+01  2.41672605e+01  9.63881280e+01  9.63881280e+01
  9.63881280e+01  1.83774053e+02  4.27266114e+02  4.27266114e+02
  4.27266114e+02  1.28001012e+03  1.28001012e+03  1.28001012e+03
  1.91545083e+03  2.98153464e+03  2.98153464e+03  2.98153464e+03
  6.61008684e+03  6.61008684e+03  6.61008684e+03  8.27348181e+03
  2.46610326e+04  7.54572074e+04]
E1 = -727.4793719584993  E_coul = 201.93977996312748
cycle= 3 E= -525.539591995372  delta_E= -6.64e-06  |g|= 0.00228  |ddm|= 0.00399
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00464468
diis-c [-1.17191365e-07 -7.17414639e-04  1.26495495e-01  8.74221920e-01]
  HOMO = -0.573332808108729  LUMO = 0.88202861539863
  mo_energy =
[-1.18086164e+02 -1.21748086e+01 -9.52151828e+00 -9.52151828e+00
 -9.52151828e+00 -1.25137453e+00 -5.73332808e-01 -5.73332808e-01
 -5.73332808e-01  8.82028615e-01  8.82028615e-01  8.82028615e-01
  5.47699964e+00  5.47699964e+00  5.47699964e+00  2.41649635e+01
  2.41649635e+01  2.41649635e+01  9.63847146e+01  9.63847146e+01
  9.63847146e+01  1.83769881e+02  4.27261811e+02  4.27261811e+02
  4.27261811e+02  1.28000555e+03  1.28000555e+03  1.28000555e+03
  1.91544604e+03  2.98152994e+03  2.98152994e+03  2.98152994e+03
  6.61008201e+03  6.61008201e+03  6.61008201e+03  8.27347690e+03
  2.46610276e+04  7.54572024e+04]
E1 = -727.4865561997261  E_coul = 201.94696400079596
cycle= 4 E= -525.53959219893  delta_E= -2.04e-07  |g|= 4.24e-05  |ddm|= 0.000638
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.77922e-05
diis-c [-3.46066942e-10 -2.67018488e-05  4.49528021e-03  4.61462342e-02
  9.49385187e-01]
  HOMO = -0.573309826680568  LUMO = 0.882042769468093
  mo_energy =
[-1.18086069e+02 -1.21747300e+01 -9.52143875e+00 -9.52143875e+00
 -9.52143875e+00 -1.25134424e+00 -5.73309827e-01 -5.73309827e-01
 -5.73309827e-01  8.82042769e-01  8.82042769e-01  8.82042769e-01
  5.47704657e+00  5.47704657e+00  5.47704657e+00  2.41650363e+01
  2.41650363e+01  2.41650363e+01  9.63848021e+01  9.63848021e+01
  9.63848021e+01  1.83769975e+02  4.27261906e+02  4.27261906e+02
  4.27261906e+02  1.28000565e+03  1.28000565e+03  1.28000565e+03
  1.91544614e+03  2.98153003e+03  2.98153003e+03  2.98153003e+03
  6.61008210e+03  6.61008210e+03  6.61008210e+03  8.27347699e+03
  2.46610277e+04  7.54572025e+04]
E1 = -727.4863452390102  E_coul = 201.946753039914
cycle= 5 E= -525.539592199096  delta_E= -1.66e-10  |g|= 2.35e-06  |ddm|= 2.36e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4863452390102  E_coul = 201.946753039914
  HOMO = -0.573311321148175  LUMO = 0.882041827302845
  mo_energy =
[-1.18086075e+02 -1.21747345e+01 -9.52144332e+00 -9.52144332e+00
 -9.52144332e+00 -1.25134613e+00 -5.73311321e-01 -5.73311321e-01
 -5.73311321e-01  8.82041827e-01  8.82041827e-01  8.82041827e-01
  5.47704370e+00  5.47704370e+00  5.47704370e+00  2.41650320e+01
  2.41650320e+01  2.41650320e+01  9.63847968e+01  9.63847968e+01
  9.63847968e+01  1.83769969e+02  4.27261900e+02  4.27261900e+02
  4.27261900e+02  1.28000564e+03  1.28000564e+03  1.28000564e+03
  1.91544613e+03  2.98153003e+03  2.98153003e+03  2.98153003e+03
  6.61008209e+03  6.61008209e+03  6.61008209e+03  8.27347698e+03
  2.46610277e+04  7.54572025e+04]
E1 = -727.4863569577404  E_coul = 201.9467647586446
Extra cycle  E= -525.539592199096  delta_E= 3.41e-13  |g|= 5.67e-07  |ddm|= 1.08e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 85661.25757209143
E1 = -727.4863569577404  E_coul = 201.9467647586446
init E= -525.539592199096
    CPU time for initialize scf      0.94 sec, wall time      0.19 sec
  HOMO = -0.573311101413223  LUMO = 0.882041963996052
  mo_energy =
[-1.18086074e+02 -1.21747336e+01 -9.52144243e+00 -9.52144243e+00
 -9.52144243e+00 -1.25134584e+00 -5.73311101e-01 -5.73311101e-01
 -5.73311101e-01  8.82041964e-01  8.82041964e-01  8.82041964e-01
  5.47704417e+00  5.47704417e+00  5.47704417e+00  2.41650329e+01
  2.41650329e+01  2.41650329e+01  9.63847979e+01  9.63847979e+01
  9.63847979e+01  1.83769970e+02  4.27261901e+02  4.27261901e+02
  4.27261901e+02  1.28000564e+03  1.28000564e+03  1.28000564e+03
  1.91544613e+03  2.98153003e+03  2.98153003e+03  2.98153003e+03
  6.61008210e+03  6.61008210e+03  6.61008210e+03  8.27347698e+03
  2.46610277e+04  7.54572025e+04]
E1 = -727.4863544680712  E_coul = 201.9467622689744
cycle= 1 E= -525.539592199097  delta_E= -1.02e-12  |g|= 1.29e-07  |ddm|= 2.48e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4863544680712  E_coul = 201.9467622689744
  HOMO = -0.573311148268304  LUMO = 0.882041934452548
  mo_energy =
[-1.18086074e+02 -1.21747338e+01 -9.52144261e+00 -9.52144261e+00
 -9.52144261e+00 -1.25134590e+00 -5.73311148e-01 -5.73311148e-01
 -5.73311148e-01  8.82041934e-01  8.82041934e-01  8.82041934e-01
  5.47704407e+00  5.47704407e+00  5.47704407e+00  2.41650327e+01
  2.41650327e+01  2.41650327e+01  9.63847977e+01  9.63847977e+01
  9.63847977e+01  1.83769970e+02  4.27261901e+02  4.27261901e+02
  4.27261901e+02  1.28000564e+03  1.28000564e+03  1.28000564e+03
  1.91544613e+03  2.98153003e+03  2.98153003e+03  2.98153003e+03
  6.61008210e+03  6.61008210e+03  6.61008210e+03  8.27347698e+03
  2.46610277e+04  7.54572025e+04]
E1 = -727.4863549874403  E_coul = 201.94676278834373
Extra cycle  E= -525.539592199097  delta_E= 2.27e-13  |g|= 2.76e-08  |ddm|= 4.74e-08
    CPU time for scf_cycle      1.06 sec, wall time      0.31 sec
exp = [2.61825082e+04 7.61824705e+03 3.61824329e+03 1.61813595e+03
 2.39738455e+02 5.22839711e+01 4.60149891e+00 3.99081758e-01
 1.36279280e+03 6.65177542e+02 3.03303586e+02 3.16131430e+02
 4.92620601e+01 5.68328637e+00 1.56081160e+01 6.87647411e-01
 2.16414226e+00 2.05001211e-01]
grad_E = [-1.98732819e-06  2.22489651e-05  4.49098267e-05  6.86026943e-04
 -5.05736187e-04  3.28391047e-03 -1.41937975e-03 -7.52664257e-04
  1.61758469e-06  2.19714416e-05  1.20052456e-04  1.05789914e-04
 -1.73488329e-03  4.00364973e-03 -2.92444526e-03  4.37708677e-03
 -3.05172488e-03 -2.49582783e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5082364        1
[INPUT] 0    0    [1    /1   ]  7618.24650698        1
[INPUT] 0    0    [1    /1   ]  3618.24220222        1
[INPUT] 0    0    [1    /1   ]  1618.11923496        1
[INPUT] 0    0    [1    /1   ]  239.742738195        1
[INPUT] 0    0    [1    /1   ]  52.2618817547        1
[INPUT] 0    0    [1    /1   ]  4.60214064334        1
[INPUT] 0    0    [1    /1   ]  0.39909354514        1
[INPUT] 1    0    [1    /1   ]  1362.79277069        1
[INPUT] 1    0    [1    /1   ]  665.177041838        1
[INPUT] 1    0    [1    /1   ]  303.300878753        1
[INPUT] 1    0    [1    /1   ]  316.129043928        1
[INPUT] 1    0    [1    /1   ]  49.2814190407        1
[INPUT] 1    0    [1    /1   ]  5.7640036514         1
[INPUT] 1    0    [1    /1   ]  15.6917036007        1
[INPUT] 1    0    [1    /1   ]  0.691890486921       1
[INPUT] 1    0    [1    /1   ]  2.22364987794        1
[INPUT] 1    0    [1    /1   ]  0.20586168153        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508236449154, 1.0]], [0, [7618.246506975875, 1.0]], [0, [3618.2422022186447, 1.0]], [0, [1618.1192349591877, 1.0]], [0, [239.74273819484782, 1.0]], [0, [52.26188175469251, 1.0]], [0, [4.602140643340954, 1.0]], [0, [0.39909354513977513, 1.0]], [1, [1362.7927706947326, 1.0]], [1, [665.17704183778, 1.0]], [1, [303.30087875316815, 1.0]], [1, [316.1290439284181, 1.0]], [1, [49.28141904067311, 1.0]], [1, [5.764003651397497, 1.0]], [1, [15.691703600695407, 1.0]], [1, [0.6918904869212279, 1.0]], [1, [2.2236498779364076, 1.0]], [1, [0.20586168152976123, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50823645]
bas 1, expnt(s) = [7618.24650698]
bas 2, expnt(s) = [3618.24220222]
bas 3, expnt(s) = [1618.11923496]
bas 4, expnt(s) = [239.74273819]
bas 5, expnt(s) = [52.26188175]
bas 6, expnt(s) = [4.60214064]
bas 7, expnt(s) = [0.39909355]
bas 8, expnt(s) = [1362.79277069]
bas 9, expnt(s) = [665.17704184]
bas 10, expnt(s) = [303.30087875]
bas 11, expnt(s) = [316.12904393]
bas 12, expnt(s) = [49.28141904]
bas 13, expnt(s) = [5.76400365]
bas 14, expnt(s) = [15.6917036]
bas 15, expnt(s) = [0.69189049]
bas 16, expnt(s) = [2.22364988]
bas 17, expnt(s) = [0.20586168]
CPU time:       164.82
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825082e+04 5.20024088e+03 7.61824651e+03 2.06018533e+03
 3.61824220e+03 1.17865920e+03 1.61811923e+03 6.44574195e+02
 2.39742738e+02 1.53930302e+02 5.22618818e+01 4.91081763e+01
 4.60214064e+00 7.93843584e+00 3.99093545e-01 1.26858932e+00
 1.36279277e+03 2.41558136e+04 6.65177042e+02 9.85498476e+03
 3.03300879e+02 3.69255080e+03 3.16129044e+02 3.88879357e+03
 4.92814190e+01 3.80924055e+02 5.76400365e+00 2.60549175e+01
 1.56917036e+01 9.11112516e+01 6.91890487e-01 1.84090379e+00
 2.22364988e+00 7.92168194e+00 2.05861682e-01 4.04532844e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97601844144177
cond(S) = 85857.51571958979
E1 = -727.5275228361941  E_coul = 203.13461735785225
init E= -524.392905478342
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.560026602308876  LUMO = 0.893941194779362
  mo_energy =
[-1.17866677e+02 -1.20948811e+01 -9.44342796e+00 -9.44342796e+00
 -9.44342796e+00 -1.23010405e+00 -5.60026602e-01 -5.60026602e-01
 -5.60026602e-01  8.93941195e-01  8.93941195e-01  8.93941195e-01
  5.63942998e+00  5.63942998e+00  5.63942998e+00  2.46991600e+01
  2.46991600e+01  2.46991600e+01  9.72605537e+01  9.72605537e+01
  9.72605537e+01  1.83882509e+02  4.28177511e+02  4.28177511e+02
  4.28177511e+02  1.28089275e+03  1.28089275e+03  1.28089275e+03
  1.91573937e+03  2.98242601e+03  2.98242601e+03  2.98242601e+03
  6.61103503e+03  6.61103503e+03  6.61103503e+03  8.27388718e+03
  2.46615128e+04  7.54577743e+04]
E1 = -727.3099539277107  E_coul = 201.77040477366532
cycle= 1 E= -525.539549154045  delta_E= -1.15  |g|= 0.185  |ddm|= 0.479
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.453403
diis-c [-0.20557393  1.        ]
  HOMO = -0.575368483242229  LUMO = 0.887386033274812
  mo_energy =
[-1.18113216e+02 -1.21873666e+01 -9.53457662e+00 -9.53457662e+00
 -9.53457662e+00 -1.25426990e+00 -5.75368483e-01 -5.75368483e-01
 -5.75368483e-01  8.87386033e-01  8.87386033e-01  8.87386033e-01
  5.59657810e+00  5.59657810e+00  5.59657810e+00  2.46140368e+01
  2.46140368e+01  2.46140368e+01  9.71109473e+01  9.71109473e+01
  9.71109473e+01  1.83688149e+02  4.27945423e+02  4.27945423e+02
  4.27945423e+02  1.28061250e+03  1.28061250e+03  1.28061250e+03
  1.91534196e+03  2.98208660e+03  2.98208660e+03  2.98208660e+03
  6.61058207e+03  6.61058207e+03  6.61058207e+03  8.27335308e+03
  2.46608856e+04  7.54570562e+04]
E1 = -727.5277894089705  E_coul = 201.98805001241345
cycle= 2 E= -525.539739396557  delta_E= -0.00019  |g|= 0.0156  |ddm|= 0.0148
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0310496
diis-c [-7.61235142e-04  3.05101163e-02  9.69489884e-01]
  HOMO = -0.572502519417595  LUMO = 0.889245026745192
  mo_energy =
[-1.18082279e+02 -1.21720076e+01 -9.51898753e+00 -9.51898753e+00
 -9.51898753e+00 -1.25041283e+00 -5.72502519e-01 -5.72502519e-01
 -5.72502519e-01  8.89245027e-01  8.89245027e-01  8.89245027e-01
  5.60357241e+00  5.60357241e+00  5.60357241e+00  2.46281179e+01
  2.46281179e+01  2.46281179e+01  9.71339629e+01  9.71339629e+01
  9.71339629e+01  1.83717899e+02  4.27975916e+02  4.27975916e+02
  4.27975916e+02  1.28064515e+03  1.28064515e+03  1.28064515e+03
  1.91537605e+03  2.98212029e+03  2.98212029e+03  2.98212029e+03
  6.61061635e+03  6.61061635e+03  6.61061635e+03  8.27338760e+03
  2.46609202e+04  7.54570907e+04]
E1 = -727.4813844756983  E_coul = 201.94163845083602
cycle= 3 E= -525.539746024862  delta_E= -6.63e-06  |g|= 0.00227  |ddm|= 0.00398
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00464821
diis-c [-1.12309104e-07 -7.19566093e-04  1.26015111e-01  8.74704455e-01]
  HOMO = -0.573093556228865  LUMO = 0.888867216788503
  mo_energy =
[-1.18086622e+02 -1.21744751e+01 -9.52150083e+00 -9.52150083e+00
 -9.52150083e+00 -1.25118755e+00 -5.73093556e-01 -5.73093556e-01
 -5.73093556e-01  8.88867217e-01  8.88867217e-01  8.88867217e-01
  5.60227556e+00  5.60227556e+00  5.60227556e+00  2.46258237e+01
  2.46258237e+01  2.46258237e+01  9.71305659e+01  9.71305659e+01
  9.71305659e+01  1.83713745e+02  4.27971633e+02  4.27971633e+02
  4.27971633e+02  1.28064061e+03  1.28064061e+03  1.28064061e+03
  1.91537128e+03  2.98211560e+03  2.98211560e+03  2.98211560e+03
  6.61061154e+03  6.61061154e+03  6.61061154e+03  8.27338271e+03
  2.46609152e+04  7.54570857e+04]
E1 = -727.4885171956242  E_coul = 201.94877096977422
cycle= 4 E= -525.53974622585  delta_E= -2.01e-07  |g|= 4.18e-05  |ddm|= 0.000638
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.66593e-05
diis-c [-3.42162497e-10 -2.77045540e-05  4.60608640e-03  4.67996874e-02
  9.48621931e-01]
  HOMO = -0.573070631170899  LUMO = 0.888881508002091
  mo_energy =
[-1.18086528e+02 -1.21743974e+01 -9.52142220e+00 -9.52142220e+00
 -9.52142220e+00 -1.25115739e+00 -5.73070631e-01 -5.73070631e-01
 -5.73070631e-01  8.88881508e-01  8.88881508e-01  8.88881508e-01
  5.60232281e+00  5.60232281e+00  5.60232281e+00  2.46258959e+01
  2.46258959e+01  2.46258959e+01  9.71306523e+01  9.71306523e+01
  9.71306523e+01  1.83713838e+02  4.27971726e+02  4.27971726e+02
  4.27971726e+02  1.28064070e+03  1.28064070e+03  1.28064070e+03
  1.91537138e+03  2.98211569e+03  2.98211569e+03  2.98211569e+03
  6.61061163e+03  6.61061163e+03  6.61061163e+03  8.27338280e+03
  2.46609153e+04  7.54570858e+04]
E1 = -727.4883100117406  E_coul = 201.94856378573152
cycle= 5 E= -525.539746226009  delta_E= -1.59e-10  |g|= 2.27e-06  |ddm|= 2.3e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4883100117406  E_coul = 201.94856378573152
  HOMO = -0.573072056796075  LUMO = 0.888880602483973
  mo_energy =
[-1.18086534e+02 -1.21744017e+01 -9.52142664e+00 -9.52142664e+00
 -9.52142664e+00 -1.25115921e+00 -5.73072057e-01 -5.73072057e-01
 -5.73072057e-01  8.88880602e-01  8.88880602e-01  8.88880602e-01
  5.60232002e+00  5.60232002e+00  5.60232002e+00  2.46258918e+01
  2.46258918e+01  2.46258918e+01  9.71306472e+01  9.71306472e+01
  9.71306472e+01  1.83713832e+02  4.27971720e+02  4.27971720e+02
  4.27971720e+02  1.28064070e+03  1.28064070e+03  1.28064070e+03
  1.91537137e+03  2.98211569e+03  2.98211569e+03  2.98211569e+03
  6.61061162e+03  6.61061162e+03  6.61061162e+03  8.27338279e+03
  2.46609153e+04  7.54570858e+04]
E1 = -727.4883214270044  E_coul = 201.9485752009934
Extra cycle  E= -525.539746226011  delta_E= -1.82e-12  |g|= 5.53e-07  |ddm|= 1.07e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
exp = [2.61825082e+04 7.61824651e+03 3.61824220e+03 1.61811923e+03
 2.39742738e+02 5.22618818e+01 4.60214064e+00 3.99093545e-01
 1.36279277e+03 6.65177042e+02 3.03300879e+02 3.16129044e+02
 4.92814190e+01 5.76400365e+00 1.56917036e+01 6.91890487e-01
 2.22364988e+00 2.05861682e-01]
E = -525.539746226011
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5082364        1
[INPUT] 0    0    [1    /1   ]  7618.24650698        1
[INPUT] 0    0    [1    /1   ]  3618.24220222        1
[INPUT] 0    0    [1    /1   ]  1618.11923496        1
[INPUT] 0    0    [1    /1   ]  239.742738195        1
[INPUT] 0    0    [1    /1   ]  52.2618817547        1
[INPUT] 0    0    [1    /1   ]  4.60214064334        1
[INPUT] 0    0    [1    /1   ]  0.39909354514        1
[INPUT] 1    0    [1    /1   ]  1362.79277069        1
[INPUT] 1    0    [1    /1   ]  665.177041838        1
[INPUT] 1    0    [1    /1   ]  303.300878753        1
[INPUT] 1    0    [1    /1   ]  316.129043928        1
[INPUT] 1    0    [1    /1   ]  49.2814190407        1
[INPUT] 1    0    [1    /1   ]  5.7640036514         1
[INPUT] 1    0    [1    /1   ]  15.6917036007        1
[INPUT] 1    0    [1    /1   ]  0.691890486921       1
[INPUT] 1    0    [1    /1   ]  2.22364987794        1
[INPUT] 1    0    [1    /1   ]  0.20586168153        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508236449154, 1.0]], [0, [7618.246506975875, 1.0]], [0, [3618.2422022186447, 1.0]], [0, [1618.1192349591877, 1.0]], [0, [239.74273819484782, 1.0]], [0, [52.26188175469251, 1.0]], [0, [4.602140643340954, 1.0]], [0, [0.39909354513977513, 1.0]], [1, [1362.7927706947326, 1.0]], [1, [665.17704183778, 1.0]], [1, [303.30087875316815, 1.0]], [1, [316.1290439284181, 1.0]], [1, [49.28141904067311, 1.0]], [1, [5.764003651397497, 1.0]], [1, [15.691703600695407, 1.0]], [1, [0.6918904869212279, 1.0]], [1, [2.2236498779364076, 1.0]], [1, [0.20586168152976123, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50823645]
bas 1, expnt(s) = [7618.24650698]
bas 2, expnt(s) = [3618.24220222]
bas 3, expnt(s) = [1618.11923496]
bas 4, expnt(s) = [239.74273819]
bas 5, expnt(s) = [52.26188175]
bas 6, expnt(s) = [4.60214064]
bas 7, expnt(s) = [0.39909355]
bas 8, expnt(s) = [1362.79277069]
bas 9, expnt(s) = [665.17704184]
bas 10, expnt(s) = [303.30087875]
bas 11, expnt(s) = [316.12904393]
bas 12, expnt(s) = [49.28141904]
bas 13, expnt(s) = [5.76400365]
bas 14, expnt(s) = [15.6917036]
bas 15, expnt(s) = [0.69189049]
bas 16, expnt(s) = [2.22364988]
bas 17, expnt(s) = [0.20586168]
CPU time:       165.31
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825082e+04 5.20024088e+03 7.61824651e+03 2.06018533e+03
 3.61824220e+03 1.17865920e+03 1.61811923e+03 6.44574195e+02
 2.39742738e+02 1.53930302e+02 5.22618818e+01 4.91081763e+01
 4.60214064e+00 7.93843584e+00 3.99093545e-01 1.26858932e+00
 1.36279277e+03 2.41558136e+04 6.65177042e+02 9.85498476e+03
 3.03300879e+02 3.69255080e+03 3.16129044e+02 3.88879357e+03
 4.92814190e+01 3.80924055e+02 5.76400365e+00 2.60549175e+01
 1.56917036e+01 9.11112516e+01 6.91890487e-01 1.84090379e+00
 2.22364988e+00 7.92168194e+00 2.05861682e-01 4.04532844e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97601844144177
cond(S) = 85857.51571958979
E1 = -727.5275228361941  E_coul = 203.13461735785225
init E= -524.392905478342
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.560026602308876  LUMO = 0.893941194779362
  mo_energy =
[-1.17866677e+02 -1.20948811e+01 -9.44342796e+00 -9.44342796e+00
 -9.44342796e+00 -1.23010405e+00 -5.60026602e-01 -5.60026602e-01
 -5.60026602e-01  8.93941195e-01  8.93941195e-01  8.93941195e-01
  5.63942998e+00  5.63942998e+00  5.63942998e+00  2.46991600e+01
  2.46991600e+01  2.46991600e+01  9.72605537e+01  9.72605537e+01
  9.72605537e+01  1.83882509e+02  4.28177511e+02  4.28177511e+02
  4.28177511e+02  1.28089275e+03  1.28089275e+03  1.28089275e+03
  1.91573937e+03  2.98242601e+03  2.98242601e+03  2.98242601e+03
  6.61103503e+03  6.61103503e+03  6.61103503e+03  8.27388718e+03
  2.46615128e+04  7.54577743e+04]
E1 = -727.3099539277107  E_coul = 201.77040477366532
cycle= 1 E= -525.539549154045  delta_E= -1.15  |g|= 0.185  |ddm|= 0.479
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.453403
diis-c [-0.20557393  1.        ]
  HOMO = -0.575368483242229  LUMO = 0.887386033274812
  mo_energy =
[-1.18113216e+02 -1.21873666e+01 -9.53457662e+00 -9.53457662e+00
 -9.53457662e+00 -1.25426990e+00 -5.75368483e-01 -5.75368483e-01
 -5.75368483e-01  8.87386033e-01  8.87386033e-01  8.87386033e-01
  5.59657810e+00  5.59657810e+00  5.59657810e+00  2.46140368e+01
  2.46140368e+01  2.46140368e+01  9.71109473e+01  9.71109473e+01
  9.71109473e+01  1.83688149e+02  4.27945423e+02  4.27945423e+02
  4.27945423e+02  1.28061250e+03  1.28061250e+03  1.28061250e+03
  1.91534196e+03  2.98208660e+03  2.98208660e+03  2.98208660e+03
  6.61058207e+03  6.61058207e+03  6.61058207e+03  8.27335308e+03
  2.46608856e+04  7.54570562e+04]
E1 = -727.5277894089705  E_coul = 201.98805001241345
cycle= 2 E= -525.539739396557  delta_E= -0.00019  |g|= 0.0156  |ddm|= 0.0148
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0310496
diis-c [-7.61235142e-04  3.05101163e-02  9.69489884e-01]
  HOMO = -0.572502519417595  LUMO = 0.889245026745192
  mo_energy =
[-1.18082279e+02 -1.21720076e+01 -9.51898753e+00 -9.51898753e+00
 -9.51898753e+00 -1.25041283e+00 -5.72502519e-01 -5.72502519e-01
 -5.72502519e-01  8.89245027e-01  8.89245027e-01  8.89245027e-01
  5.60357241e+00  5.60357241e+00  5.60357241e+00  2.46281179e+01
  2.46281179e+01  2.46281179e+01  9.71339629e+01  9.71339629e+01
  9.71339629e+01  1.83717899e+02  4.27975916e+02  4.27975916e+02
  4.27975916e+02  1.28064515e+03  1.28064515e+03  1.28064515e+03
  1.91537605e+03  2.98212029e+03  2.98212029e+03  2.98212029e+03
  6.61061635e+03  6.61061635e+03  6.61061635e+03  8.27338760e+03
  2.46609202e+04  7.54570907e+04]
E1 = -727.4813844756983  E_coul = 201.94163845083602
cycle= 3 E= -525.539746024862  delta_E= -6.63e-06  |g|= 0.00227  |ddm|= 0.00398
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00464821
diis-c [-1.12309104e-07 -7.19566093e-04  1.26015111e-01  8.74704455e-01]
  HOMO = -0.573093556228865  LUMO = 0.888867216788503
  mo_energy =
[-1.18086622e+02 -1.21744751e+01 -9.52150083e+00 -9.52150083e+00
 -9.52150083e+00 -1.25118755e+00 -5.73093556e-01 -5.73093556e-01
 -5.73093556e-01  8.88867217e-01  8.88867217e-01  8.88867217e-01
  5.60227556e+00  5.60227556e+00  5.60227556e+00  2.46258237e+01
  2.46258237e+01  2.46258237e+01  9.71305659e+01  9.71305659e+01
  9.71305659e+01  1.83713745e+02  4.27971633e+02  4.27971633e+02
  4.27971633e+02  1.28064061e+03  1.28064061e+03  1.28064061e+03
  1.91537128e+03  2.98211560e+03  2.98211560e+03  2.98211560e+03
  6.61061154e+03  6.61061154e+03  6.61061154e+03  8.27338271e+03
  2.46609152e+04  7.54570857e+04]
E1 = -727.4885171956242  E_coul = 201.94877096977422
cycle= 4 E= -525.53974622585  delta_E= -2.01e-07  |g|= 4.18e-05  |ddm|= 0.000638
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.66593e-05
diis-c [-3.42162497e-10 -2.77045540e-05  4.60608640e-03  4.67996874e-02
  9.48621931e-01]
  HOMO = -0.573070631170899  LUMO = 0.888881508002091
  mo_energy =
[-1.18086528e+02 -1.21743974e+01 -9.52142220e+00 -9.52142220e+00
 -9.52142220e+00 -1.25115739e+00 -5.73070631e-01 -5.73070631e-01
 -5.73070631e-01  8.88881508e-01  8.88881508e-01  8.88881508e-01
  5.60232281e+00  5.60232281e+00  5.60232281e+00  2.46258959e+01
  2.46258959e+01  2.46258959e+01  9.71306523e+01  9.71306523e+01
  9.71306523e+01  1.83713838e+02  4.27971726e+02  4.27971726e+02
  4.27971726e+02  1.28064070e+03  1.28064070e+03  1.28064070e+03
  1.91537138e+03  2.98211569e+03  2.98211569e+03  2.98211569e+03
  6.61061163e+03  6.61061163e+03  6.61061163e+03  8.27338280e+03
  2.46609153e+04  7.54570858e+04]
E1 = -727.4883100117406  E_coul = 201.94856378573152
cycle= 5 E= -525.539746226009  delta_E= -1.59e-10  |g|= 2.27e-06  |ddm|= 2.3e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4883100117406  E_coul = 201.94856378573152
  HOMO = -0.573072056796075  LUMO = 0.888880602483973
  mo_energy =
[-1.18086534e+02 -1.21744017e+01 -9.52142664e+00 -9.52142664e+00
 -9.52142664e+00 -1.25115921e+00 -5.73072057e-01 -5.73072057e-01
 -5.73072057e-01  8.88880602e-01  8.88880602e-01  8.88880602e-01
  5.60232002e+00  5.60232002e+00  5.60232002e+00  2.46258918e+01
  2.46258918e+01  2.46258918e+01  9.71306472e+01  9.71306472e+01
  9.71306472e+01  1.83713832e+02  4.27971720e+02  4.27971720e+02
  4.27971720e+02  1.28064070e+03  1.28064070e+03  1.28064070e+03
  1.91537137e+03  2.98211569e+03  2.98211569e+03  2.98211569e+03
  6.61061162e+03  6.61061162e+03  6.61061162e+03  8.27338279e+03
  2.46609153e+04  7.54570858e+04]
E1 = -727.4883214270044  E_coul = 201.9485752009934
Extra cycle  E= -525.539746226011  delta_E= -1.82e-12  |g|= 5.53e-07  |ddm|= 1.07e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 85857.51571958979
E1 = -727.4883214270044  E_coul = 201.9485752009934
init E= -525.539746226011
    CPU time for initialize scf      0.93 sec, wall time      0.18 sec
  HOMO = -0.573071841922748  LUMO = 0.888880737814519
  mo_energy =
[-1.18086533e+02 -1.21744009e+01 -9.52142577e+00 -9.52142577e+00
 -9.52142577e+00 -1.25115892e+00 -5.73071842e-01 -5.73071842e-01
 -5.73071842e-01  8.88880738e-01  8.88880738e-01  8.88880738e-01
  5.60232049e+00  5.60232049e+00  5.60232049e+00  2.46258926e+01
  2.46258926e+01  2.46258926e+01  9.71306483e+01  9.71306483e+01
  9.71306483e+01  1.83713834e+02  4.27971722e+02  4.27971722e+02
  4.27971722e+02  1.28064070e+03  1.28064070e+03  1.28064070e+03
  1.91537137e+03  2.98211569e+03  2.98211569e+03  2.98211569e+03
  6.61061162e+03  6.61061162e+03  6.61061162e+03  8.27338279e+03
  2.46609153e+04  7.54570858e+04]
E1 = -727.4883190160832  E_coul = 201.94857279007283
cycle= 1 E= -525.53974622601  delta_E= 5.68e-13  |g|= 1.25e-07  |ddm|= 2.39e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4883190160832  E_coul = 201.94857279007283
  HOMO = -0.573071887085124  LUMO = 0.888880709050136
  mo_energy =
[-1.18086533e+02 -1.21744011e+01 -9.52142595e+00 -9.52142595e+00
 -9.52142595e+00 -1.25115898e+00 -5.73071887e-01 -5.73071887e-01
 -5.73071887e-01  8.88880709e-01  8.88880709e-01  8.88880709e-01
  5.60232039e+00  5.60232039e+00  5.60232039e+00  2.46258924e+01
  2.46258924e+01  2.46258924e+01  9.71306480e+01  9.71306480e+01
  9.71306480e+01  1.83713833e+02  4.27971721e+02  4.27971721e+02
  4.27971721e+02  1.28064070e+03  1.28064070e+03  1.28064070e+03
  1.91537137e+03  2.98211569e+03  2.98211569e+03  2.98211569e+03
  6.61061162e+03  6.61061162e+03  6.61061162e+03  8.27338279e+03
  2.46609153e+04  7.54570858e+04]
E1 = -727.4883195184105  E_coul = 201.94857329240025
Extra cycle  E= -525.53974622601  delta_E= 1.14e-13  |g|= 2.68e-08  |ddm|= 4.62e-08
    CPU time for scf_cycle      1.04 sec, wall time      0.29 sec
exp = [2.61825082e+04 7.61824651e+03 3.61824220e+03 1.61811923e+03
 2.39742738e+02 5.22618818e+01 4.60214064e+00 3.99093545e-01
 1.36279277e+03 6.65177042e+02 3.03300879e+02 3.16129044e+02
 4.92814190e+01 5.76400365e+00 1.56917036e+01 6.91890487e-01
 2.22364988e+00 2.05861682e-01]
grad_E = [-1.98730453e-06  2.22166157e-05  4.48091647e-05  6.84838657e-04
 -4.21035578e-04  2.68350741e-03 -7.97954531e-04 -1.66576526e-04
  1.63709967e-06  2.21086163e-05  1.20888391e-04  1.06527723e-04
 -1.80251951e-03  4.98575108e-03 -3.10468622e-03 -1.90553163e-03
 -2.25189292e-03  5.79324740e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5082949        1
[INPUT] 0    0    [1    /1   ]  7618.24585575        1
[INPUT] 0    0    [1    /1   ]  3618.24089105        1
[INPUT] 0    0    [1    /1   ]  1618.09917851        1
[INPUT] 0    0    [1    /1   ]  239.748623042        1
[INPUT] 0    0    [1    /1   ]  52.230011483         1
[INPUT] 0    0    [1    /1   ]  4.60277467179        1
[INPUT] 0    0    [1    /1   ]  0.39911332635        1
[INPUT] 1    0    [1    /1   ]  1362.79272929        1
[INPUT] 1    0    [1    /1   ]  665.1764401          1
[INPUT] 1    0    [1    /1   ]  303.297618415        1
[INPUT] 1    0    [1    /1   ]  316.126171112        1
[INPUT] 1    0    [1    /1   ]  49.3056546237        1
[INPUT] 1    0    [1    /1   ]  5.84387058779        1
[INPUT] 1    0    [1    /1   ]  15.797023056         1
[INPUT] 1    0    [1    /1   ]  0.695159974524       1
[INPUT] 1    0    [1    /1   ]  2.27953058229        1
[INPUT] 1    0    [1    /1   ]  0.205951662959       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.50829489907, 1.0]], [0, [7618.24585575125, 1.0]], [0, [3618.2408910523964, 1.0]], [0, [1618.0991785148872, 1.0]], [0, [239.74862304178788, 1.0]], [0, [52.23001148296489, 1.0]], [0, [4.602774671786923, 1.0]], [0, [0.3991133263498335, 1.0]], [1, [1362.792729285963, 1.0]], [1, [665.1764401002835, 1.0]], [1, [303.2976184152443, 1.0]], [1, [316.1261711118272, 1.0]], [1, [49.30565462367279, 1.0]], [1, [5.843870587788307, 1.0]], [1, [15.797023055990797, 1.0]], [1, [0.6951599745244229, 1.0]], [1, [2.2795305822883125, 1.0]], [1, [0.20595166295918899, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5082949]
bas 1, expnt(s) = [7618.24585575]
bas 2, expnt(s) = [3618.24089105]
bas 3, expnt(s) = [1618.09917851]
bas 4, expnt(s) = [239.74862304]
bas 5, expnt(s) = [52.23001148]
bas 6, expnt(s) = [4.60277467]
bas 7, expnt(s) = [0.39911333]
bas 8, expnt(s) = [1362.79272929]
bas 9, expnt(s) = [665.1764401]
bas 10, expnt(s) = [303.29761842]
bas 11, expnt(s) = [316.12617111]
bas 12, expnt(s) = [49.30565462]
bas 13, expnt(s) = [5.84387059]
bas 14, expnt(s) = [15.79702306]
bas 15, expnt(s) = [0.69515997]
bas 16, expnt(s) = [2.27953058]
bas 17, expnt(s) = [0.20595166]
CPU time:       170.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825083e+04 5.20024089e+03 7.61824586e+03 2.06018520e+03
 3.61824089e+03 1.17865888e+03 1.61809918e+03 6.44568202e+02
 2.39748623e+02 1.53933135e+02 5.22300115e+01 4.90857143e+01
 4.60277467e+00 7.93925608e+00 3.99113326e-01 1.26863648e+00
 1.36279273e+03 2.41558126e+04 6.65176440e+02 9.85497361e+03
 3.03297618e+02 3.69250118e+03 3.16126171e+02 3.88874940e+03
 4.93056546e+01 3.81158232e+02 5.84387059e+00 2.65069726e+01
 1.57970231e+01 9.18762916e+01 6.95159975e-01 1.85178406e+00
 2.27953058e+00 8.17130030e+00 2.05951663e-01 4.04753881e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97597295994572
cond(S) = 86071.37105930854
E1 = -727.5321118031275  E_coul = 203.13503113856586
init E= -524.397080664562
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.559975272223353  LUMO = 0.897137327603457
  mo_energy =
[-1.17867022e+02 -1.20945170e+01 -9.44344917e+00 -9.44344917e+00
 -9.44344917e+00 -1.23009070e+00 -5.59975272e-01 -5.59975272e-01
 -5.59975272e-01  8.97137328e-01  8.97137328e-01  8.97137328e-01
  5.75329996e+00  5.75329996e+00  5.75329996e+00  2.51521426e+01
  2.51521426e+01  2.51521426e+01  9.80512271e+01  9.80512271e+01
  9.80512271e+01  1.83800438e+02  4.28959042e+02  4.28959042e+02
  4.28959042e+02  1.28159674e+03  1.28159674e+03  1.28159674e+03
  1.91563338e+03  2.98307619e+03  2.98307619e+03  2.98307619e+03
  6.61162317e+03  6.61162317e+03  6.61162317e+03  8.27375985e+03
  2.46613646e+04  7.54576219e+04]
E1 = -727.3020132731002  E_coul = 201.76231781379994
cycle= 1 E= -525.5396954593  delta_E= -1.14  |g|= 0.184  |ddm|= 0.505
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.454216
diis-c [-0.20631178  1.        ]
  HOMO = -0.575471848903401  LUMO = 0.890395339872036
  mo_energy =
[-1.18114686e+02 -1.21875855e+01 -9.53521867e+00 -9.53521867e+00
 -9.53521867e+00 -1.25446258e+00 -5.75471849e-01 -5.75471849e-01
 -5.75471849e-01  8.90395340e-01  8.90395340e-01  8.90395340e-01
  5.70939245e+00  5.70939245e+00  5.70939245e+00  2.50659372e+01
  2.50659372e+01  2.50659372e+01  9.79007446e+01  9.79007446e+01
  9.79007446e+01  1.83604976e+02  4.28725819e+02  4.28725819e+02
  4.28725819e+02  1.28131496e+03  1.28131496e+03  1.28131496e+03
  1.91523377e+03  2.98273486e+03  2.98273486e+03  2.98273486e+03
  6.61116795e+03  6.61116795e+03  6.61116795e+03  8.27322328e+03
  2.46607349e+04  7.54569013e+04]
E1 = -727.5217391674084  E_coul = 201.9818513195812
cycle= 2 E= -525.539887847827  delta_E= -0.000192  |g|= 0.0157  |ddm|= 0.0151
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0313583
diis-c [-7.71046630e-04  3.11374912e-02  9.68862509e-01]
  HOMO = -0.572569705724147  LUMO = 0.892293488654092
  mo_energy =
[-1.18083547e+02 -1.21721052e+01 -9.51950661e+00 -9.51950661e+00
 -9.51950661e+00 -1.25055925e+00 -5.72569706e-01 -5.72569706e-01
 -5.72569706e-01  8.92293489e-01  8.92293489e-01  8.92293489e-01
  5.71657025e+00  5.71657025e+00  5.71657025e+00  2.50802095e+01
  2.50802095e+01  2.50802095e+01  9.79239231e+01  9.79239231e+01
  9.79239231e+01  1.83634919e+02  4.28756505e+02  4.28756505e+02
  4.28756505e+02  1.28134782e+03  1.28134782e+03  1.28134782e+03
  1.91526807e+03  2.98276875e+03  2.98276875e+03  2.98276875e+03
  6.61120245e+03  6.61120245e+03  6.61120245e+03  8.27325801e+03
  2.46607696e+04  7.54569360e+04]
E1 = -727.4750422620374  E_coul = 201.9351476899447
cycle= 3 E= -525.539894572093  delta_E= -6.72e-06  |g|= 0.00227  |ddm|= 0.00402
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00467589
diis-c [-1.10576358e-07 -7.23695926e-04  1.25532012e-01  8.75191684e-01]
  HOMO = -0.573162184277799  LUMO = 0.891911956826965
  mo_energy =
[-1.18087899e+02 -1.21745789e+01 -9.52202631e+00 -9.52202631e+00
 -9.52202631e+00 -1.25133606e+00 -5.73162184e-01 -5.73162184e-01
 -5.73162184e-01  8.91911957e-01  8.91911957e-01  8.91911957e-01
  5.71525225e+00  5.71525225e+00  5.71525225e+00  2.50778992e+01
  2.50778992e+01  2.50778992e+01  9.79205184e+01  9.79205184e+01
  9.79205184e+01  1.83630757e+02  4.28752213e+02  4.28752213e+02
  4.28752213e+02  1.28134327e+03  1.28134327e+03  1.28134327e+03
  1.91526329e+03  2.98276406e+03  2.98276406e+03  2.98276406e+03
  6.61119762e+03  6.61119762e+03  6.61119762e+03  8.27325311e+03
  2.46607647e+04  7.54569310e+04]
E1 = -727.4821883008655  E_coul = 201.9422935270107
cycle= 4 E= -525.539894773855  delta_E= -2.02e-07  |g|= 4.16e-05  |ddm|= 0.000644
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.62615e-05
diis-c [-3.46548863e-10 -2.81703053e-05  4.60221530e-03  4.67531408e-02
  9.48672814e-01]
  HOMO = -0.573139190885806  LUMO = 0.891926412195622
  mo_energy =
[-1.18087806e+02 -1.21745013e+01 -9.52194788e+00 -9.52194788e+00
 -9.52194788e+00 -1.25130585e+00 -5.73139191e-01 -5.73139191e-01
 -5.73139191e-01  8.91926412e-01  8.91926412e-01  8.91926412e-01
  5.71530009e+00  5.71530009e+00  5.71530009e+00  2.50779715e+01
  2.50779715e+01  2.50779715e+01  9.79206046e+01  9.79206046e+01
  9.79206046e+01  1.83630850e+02  4.28752306e+02  4.28752306e+02
  4.28752306e+02  1.28134336e+03  1.28134336e+03  1.28134336e+03
  1.91526339e+03  2.98276415e+03  2.98276415e+03  2.98276415e+03
  6.61119771e+03  6.61119771e+03  6.61119771e+03  8.27325320e+03
  2.46607648e+04  7.54569310e+04]
E1 = -727.4819822742719  E_coul = 201.94208750026016
cycle= 5 E= -525.539894774012  delta_E= -1.57e-10  |g|= 2.27e-06  |ddm|= 2.29e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4819822742719  E_coul = 201.94208750026016
  HOMO = -0.573140598688687  LUMO = 0.891925513100926
  mo_energy =
[-1.18087812e+02 -1.21745057e+01 -9.52195231e+00 -9.52195231e+00
 -9.52195231e+00 -1.25130765e+00 -5.73140599e-01 -5.73140599e-01
 -5.73140599e-01  8.91925513e-01  8.91925513e-01  8.91925513e-01
  5.71529730e+00  5.71529730e+00  5.71529730e+00  2.50779674e+01
  2.50779674e+01  2.50779674e+01  9.79205994e+01  9.79205994e+01
  9.79205994e+01  1.83630844e+02  4.28752301e+02  4.28752301e+02
  4.28752301e+02  1.28134335e+03  1.28134335e+03  1.28134335e+03
  1.91526338e+03  2.98276414e+03  2.98276414e+03  2.98276414e+03
  6.61119770e+03  6.61119770e+03  6.61119770e+03  8.27325319e+03
  2.46607648e+04  7.54569310e+04]
E1 = -727.4819937114532  E_coul = 201.9420989374406
Extra cycle  E= -525.539894774013  delta_E= -9.09e-13  |g|= 5.54e-07  |ddm|= 1.09e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
exp = [2.61825083e+04 7.61824586e+03 3.61824089e+03 1.61809918e+03
 2.39748623e+02 5.22300115e+01 4.60277467e+00 3.99113326e-01
 1.36279273e+03 6.65176440e+02 3.03297618e+02 3.16126171e+02
 4.93056546e+01 5.84387059e+00 1.57970231e+01 6.95159975e-01
 2.27953058e+00 2.05951663e-01]
E = -525.5398947740126
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5082949        1
[INPUT] 0    0    [1    /1   ]  7618.24585575        1
[INPUT] 0    0    [1    /1   ]  3618.24089105        1
[INPUT] 0    0    [1    /1   ]  1618.09917851        1
[INPUT] 0    0    [1    /1   ]  239.748623042        1
[INPUT] 0    0    [1    /1   ]  52.230011483         1
[INPUT] 0    0    [1    /1   ]  4.60277467179        1
[INPUT] 0    0    [1    /1   ]  0.39911332635        1
[INPUT] 1    0    [1    /1   ]  1362.79272929        1
[INPUT] 1    0    [1    /1   ]  665.1764401          1
[INPUT] 1    0    [1    /1   ]  303.297618415        1
[INPUT] 1    0    [1    /1   ]  316.126171112        1
[INPUT] 1    0    [1    /1   ]  49.3056546237        1
[INPUT] 1    0    [1    /1   ]  5.84387058779        1
[INPUT] 1    0    [1    /1   ]  15.797023056         1
[INPUT] 1    0    [1    /1   ]  0.695159974524       1
[INPUT] 1    0    [1    /1   ]  2.27953058229        1
[INPUT] 1    0    [1    /1   ]  0.205951662959       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.50829489907, 1.0]], [0, [7618.24585575125, 1.0]], [0, [3618.2408910523964, 1.0]], [0, [1618.0991785148872, 1.0]], [0, [239.74862304178788, 1.0]], [0, [52.23001148296489, 1.0]], [0, [4.602774671786923, 1.0]], [0, [0.3991133263498335, 1.0]], [1, [1362.792729285963, 1.0]], [1, [665.1764401002835, 1.0]], [1, [303.2976184152443, 1.0]], [1, [316.1261711118272, 1.0]], [1, [49.30565462367279, 1.0]], [1, [5.843870587788307, 1.0]], [1, [15.797023055990797, 1.0]], [1, [0.6951599745244229, 1.0]], [1, [2.2795305822883125, 1.0]], [1, [0.20595166295918899, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5082949]
bas 1, expnt(s) = [7618.24585575]
bas 2, expnt(s) = [3618.24089105]
bas 3, expnt(s) = [1618.09917851]
bas 4, expnt(s) = [239.74862304]
bas 5, expnt(s) = [52.23001148]
bas 6, expnt(s) = [4.60277467]
bas 7, expnt(s) = [0.39911333]
bas 8, expnt(s) = [1362.79272929]
bas 9, expnt(s) = [665.1764401]
bas 10, expnt(s) = [303.29761842]
bas 11, expnt(s) = [316.12617111]
bas 12, expnt(s) = [49.30565462]
bas 13, expnt(s) = [5.84387059]
bas 14, expnt(s) = [15.79702306]
bas 15, expnt(s) = [0.69515997]
bas 16, expnt(s) = [2.27953058]
bas 17, expnt(s) = [0.20595166]
CPU time:       171.47
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825083e+04 5.20024089e+03 7.61824586e+03 2.06018520e+03
 3.61824089e+03 1.17865888e+03 1.61809918e+03 6.44568202e+02
 2.39748623e+02 1.53933135e+02 5.22300115e+01 4.90857143e+01
 4.60277467e+00 7.93925608e+00 3.99113326e-01 1.26863648e+00
 1.36279273e+03 2.41558126e+04 6.65176440e+02 9.85497361e+03
 3.03297618e+02 3.69250118e+03 3.16126171e+02 3.88874940e+03
 4.93056546e+01 3.81158232e+02 5.84387059e+00 2.65069726e+01
 1.57970231e+01 9.18762916e+01 6.95159975e-01 1.85178406e+00
 2.27953058e+00 8.17130030e+00 2.05951663e-01 4.04753881e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97597295994572
cond(S) = 86071.37105930854
E1 = -727.5321118031275  E_coul = 203.13503113856586
init E= -524.397080664562
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.559975272223353  LUMO = 0.897137327603457
  mo_energy =
[-1.17867022e+02 -1.20945170e+01 -9.44344917e+00 -9.44344917e+00
 -9.44344917e+00 -1.23009070e+00 -5.59975272e-01 -5.59975272e-01
 -5.59975272e-01  8.97137328e-01  8.97137328e-01  8.97137328e-01
  5.75329996e+00  5.75329996e+00  5.75329996e+00  2.51521426e+01
  2.51521426e+01  2.51521426e+01  9.80512271e+01  9.80512271e+01
  9.80512271e+01  1.83800438e+02  4.28959042e+02  4.28959042e+02
  4.28959042e+02  1.28159674e+03  1.28159674e+03  1.28159674e+03
  1.91563338e+03  2.98307619e+03  2.98307619e+03  2.98307619e+03
  6.61162317e+03  6.61162317e+03  6.61162317e+03  8.27375985e+03
  2.46613646e+04  7.54576219e+04]
E1 = -727.3020132731002  E_coul = 201.76231781379994
cycle= 1 E= -525.5396954593  delta_E= -1.14  |g|= 0.184  |ddm|= 0.505
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.454216
diis-c [-0.20631178  1.        ]
  HOMO = -0.575471848903401  LUMO = 0.890395339872036
  mo_energy =
[-1.18114686e+02 -1.21875855e+01 -9.53521867e+00 -9.53521867e+00
 -9.53521867e+00 -1.25446258e+00 -5.75471849e-01 -5.75471849e-01
 -5.75471849e-01  8.90395340e-01  8.90395340e-01  8.90395340e-01
  5.70939245e+00  5.70939245e+00  5.70939245e+00  2.50659372e+01
  2.50659372e+01  2.50659372e+01  9.79007446e+01  9.79007446e+01
  9.79007446e+01  1.83604976e+02  4.28725819e+02  4.28725819e+02
  4.28725819e+02  1.28131496e+03  1.28131496e+03  1.28131496e+03
  1.91523377e+03  2.98273486e+03  2.98273486e+03  2.98273486e+03
  6.61116795e+03  6.61116795e+03  6.61116795e+03  8.27322328e+03
  2.46607349e+04  7.54569013e+04]
E1 = -727.5217391674084  E_coul = 201.9818513195812
cycle= 2 E= -525.539887847827  delta_E= -0.000192  |g|= 0.0157  |ddm|= 0.0151
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0313583
diis-c [-7.71046630e-04  3.11374912e-02  9.68862509e-01]
  HOMO = -0.572569705724147  LUMO = 0.892293488654092
  mo_energy =
[-1.18083547e+02 -1.21721052e+01 -9.51950661e+00 -9.51950661e+00
 -9.51950661e+00 -1.25055925e+00 -5.72569706e-01 -5.72569706e-01
 -5.72569706e-01  8.92293489e-01  8.92293489e-01  8.92293489e-01
  5.71657025e+00  5.71657025e+00  5.71657025e+00  2.50802095e+01
  2.50802095e+01  2.50802095e+01  9.79239231e+01  9.79239231e+01
  9.79239231e+01  1.83634919e+02  4.28756505e+02  4.28756505e+02
  4.28756505e+02  1.28134782e+03  1.28134782e+03  1.28134782e+03
  1.91526807e+03  2.98276875e+03  2.98276875e+03  2.98276875e+03
  6.61120245e+03  6.61120245e+03  6.61120245e+03  8.27325801e+03
  2.46607696e+04  7.54569360e+04]
E1 = -727.4750422620374  E_coul = 201.9351476899447
cycle= 3 E= -525.539894572093  delta_E= -6.72e-06  |g|= 0.00227  |ddm|= 0.00402
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00467589
diis-c [-1.10576358e-07 -7.23695926e-04  1.25532012e-01  8.75191684e-01]
  HOMO = -0.573162184277799  LUMO = 0.891911956826965
  mo_energy =
[-1.18087899e+02 -1.21745789e+01 -9.52202631e+00 -9.52202631e+00
 -9.52202631e+00 -1.25133606e+00 -5.73162184e-01 -5.73162184e-01
 -5.73162184e-01  8.91911957e-01  8.91911957e-01  8.91911957e-01
  5.71525225e+00  5.71525225e+00  5.71525225e+00  2.50778992e+01
  2.50778992e+01  2.50778992e+01  9.79205184e+01  9.79205184e+01
  9.79205184e+01  1.83630757e+02  4.28752213e+02  4.28752213e+02
  4.28752213e+02  1.28134327e+03  1.28134327e+03  1.28134327e+03
  1.91526329e+03  2.98276406e+03  2.98276406e+03  2.98276406e+03
  6.61119762e+03  6.61119762e+03  6.61119762e+03  8.27325311e+03
  2.46607647e+04  7.54569310e+04]
E1 = -727.4821883008655  E_coul = 201.9422935270107
cycle= 4 E= -525.539894773855  delta_E= -2.02e-07  |g|= 4.16e-05  |ddm|= 0.000644
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.62615e-05
diis-c [-3.46548863e-10 -2.81703053e-05  4.60221530e-03  4.67531408e-02
  9.48672814e-01]
  HOMO = -0.573139190885806  LUMO = 0.891926412195622
  mo_energy =
[-1.18087806e+02 -1.21745013e+01 -9.52194788e+00 -9.52194788e+00
 -9.52194788e+00 -1.25130585e+00 -5.73139191e-01 -5.73139191e-01
 -5.73139191e-01  8.91926412e-01  8.91926412e-01  8.91926412e-01
  5.71530009e+00  5.71530009e+00  5.71530009e+00  2.50779715e+01
  2.50779715e+01  2.50779715e+01  9.79206046e+01  9.79206046e+01
  9.79206046e+01  1.83630850e+02  4.28752306e+02  4.28752306e+02
  4.28752306e+02  1.28134336e+03  1.28134336e+03  1.28134336e+03
  1.91526339e+03  2.98276415e+03  2.98276415e+03  2.98276415e+03
  6.61119771e+03  6.61119771e+03  6.61119771e+03  8.27325320e+03
  2.46607648e+04  7.54569310e+04]
E1 = -727.4819822742719  E_coul = 201.94208750026016
cycle= 5 E= -525.539894774012  delta_E= -1.57e-10  |g|= 2.27e-06  |ddm|= 2.29e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4819822742719  E_coul = 201.94208750026016
  HOMO = -0.573140598688687  LUMO = 0.891925513100926
  mo_energy =
[-1.18087812e+02 -1.21745057e+01 -9.52195231e+00 -9.52195231e+00
 -9.52195231e+00 -1.25130765e+00 -5.73140599e-01 -5.73140599e-01
 -5.73140599e-01  8.91925513e-01  8.91925513e-01  8.91925513e-01
  5.71529730e+00  5.71529730e+00  5.71529730e+00  2.50779674e+01
  2.50779674e+01  2.50779674e+01  9.79205994e+01  9.79205994e+01
  9.79205994e+01  1.83630844e+02  4.28752301e+02  4.28752301e+02
  4.28752301e+02  1.28134335e+03  1.28134335e+03  1.28134335e+03
  1.91526338e+03  2.98276414e+03  2.98276414e+03  2.98276414e+03
  6.61119770e+03  6.61119770e+03  6.61119770e+03  8.27325319e+03
  2.46607648e+04  7.54569310e+04]
E1 = -727.4819937114532  E_coul = 201.9420989374406
Extra cycle  E= -525.539894774013  delta_E= -9.09e-13  |g|= 5.54e-07  |ddm|= 1.09e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 86071.37105930854
E1 = -727.4819937114532  E_coul = 201.9420989374406
init E= -525.539894774013
    CPU time for initialize scf      0.93 sec, wall time      0.18 sec
  HOMO = -0.573140382568227  LUMO = 0.891925650408812
  mo_energy =
[-1.18087810e+02 -1.21745048e+01 -9.52195144e+00 -9.52195144e+00
 -9.52195144e+00 -1.25130736e+00 -5.73140383e-01 -5.73140383e-01
 -5.73140383e-01  8.91925650e-01  8.91925650e-01  8.91925650e-01
  5.71529777e+00  5.71529777e+00  5.71529777e+00  2.50779682e+01
  2.50779682e+01  2.50779682e+01  9.79206005e+01  9.79206005e+01
  9.79206005e+01  1.83630846e+02  4.28752302e+02  4.28752302e+02
  4.28752302e+02  1.28134336e+03  1.28134336e+03  1.28134336e+03
  1.91526338e+03  2.98276414e+03  2.98276414e+03  2.98276414e+03
  6.61119771e+03  6.61119771e+03  6.61119771e+03  8.27325320e+03
  2.46607648e+04  7.54569310e+04]
E1 = -727.4819913033859  E_coul = 201.94209652937326
cycle= 1 E= -525.539894774013  delta_E= -1.14e-13  |g|= 1.25e-07  |ddm|= 2.39e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4819913033859  E_coul = 201.94209652937326
  HOMO = -0.573140427582579  LUMO = 0.891925621529997
  mo_energy =
[-1.18087811e+02 -1.21745050e+01 -9.52195162e+00 -9.52195162e+00
 -9.52195162e+00 -1.25130742e+00 -5.73140428e-01 -5.73140428e-01
 -5.73140428e-01  8.91925622e-01  8.91925622e-01  8.91925622e-01
  5.71529767e+00  5.71529767e+00  5.71529767e+00  2.50779680e+01
  2.50779680e+01  2.50779680e+01  9.79206003e+01  9.79206003e+01
  9.79206003e+01  1.83630846e+02  4.28752302e+02  4.28752302e+02
  4.28752302e+02  1.28134336e+03  1.28134336e+03  1.28134336e+03
  1.91526338e+03  2.98276414e+03  2.98276414e+03  2.98276414e+03
  6.61119771e+03  6.61119771e+03  6.61119771e+03  8.27325319e+03
  2.46607648e+04  7.54569310e+04]
E1 = -727.4819918051616  E_coul = 201.94209703115013
Extra cycle  E= -525.539894774011  delta_E= 1.36e-12  |g|= 2.67e-08  |ddm|= 4.65e-08
    CPU time for scf_cycle      1.05 sec, wall time      0.30 sec
exp = [2.61825083e+04 7.61824586e+03 3.61824089e+03 1.61809918e+03
 2.39748623e+02 5.22300115e+01 4.60277467e+00 3.99113326e-01
 1.36279273e+03 6.65176440e+02 3.03297618e+02 3.16126171e+02
 4.93056546e+01 5.84387059e+00 1.57970231e+01 6.95159975e-01
 2.27953058e+00 2.05951663e-01]
grad_E = [-1.98725749e-06  2.21702982e-05  4.46653983e-05  6.83131648e-04
 -2.99058026e-04  1.81767489e-03 -1.81677800e-04  1.68044691e-04
  1.68091937e-06  2.24168784e-05  1.22776454e-04  1.08193461e-04
 -1.99900529e-03  4.61903011e-03 -2.53562953e-03 -4.55073057e-03
 -9.86352888e-04  9.64198629e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5083455        1
[INPUT] 0    0    [1    /1   ]  7618.24529128        1
[INPUT] 0    0    [1    /1   ]  3618.23975389        1
[INPUT] 0    0    [1    /1   ]  1618.08178931        1
[INPUT] 0    0    [1    /1   ]  239.755517972        1
[INPUT] 0    0    [1    /1   ]  52.1894838256        1
[INPUT] 0    0    [1    /1   ]  4.60345982131        1
[INPUT] 0    0    [1    /1   ]  0.399118373873       1
[INPUT] 1    0    [1    /1   ]  1362.79269234        1
[INPUT] 1    0    [1    /1   ]  665.175911286        1
[INPUT] 1    0    [1    /1   ]  303.294748012        1
[INPUT] 1    0    [1    /1   ]  316.123641826        1
[INPUT] 1    0    [1    /1   ]  49.3311841105        1
[INPUT] 1    0    [1    /1   ]  5.89048434129        1
[INPUT] 1    0    [1    /1   ]  15.8856009413        1
[INPUT] 1    0    [1    /1   ]  0.696475206545       1
[INPUT] 1    0    [1    /1   ]  2.30465397284        1
[INPUT] 1    0    [1    /1   ]  0.206404212738       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508345505692, 1.0]], [0, [7618.2452912829895, 1.0]], [0, [3618.2397538874397, 1.0]], [0, [1618.0817893093, 1.0]], [0, [239.75551797165207, 1.0]], [0, [52.18948382556322, 1.0]], [0, [4.603459821313534, 1.0]], [0, [0.39911837387310783, 1.0]], [1, [1362.7926923390194, 1.0]], [1, [665.175911286366, 1.0]], [1, [303.29474801237484, 1.0]], [1, [316.12364182585617, 1.0]], [1, [49.33118411045024, 1.0]], [1, [5.890484341294293, 1.0]], [1, [15.885600941253307, 1.0]], [1, [0.6964752065447947, 1.0]], [1, [2.3046539728353466, 1.0]], [1, [0.2064042127383504, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50834551]
bas 1, expnt(s) = [7618.24529128]
bas 2, expnt(s) = [3618.23975389]
bas 3, expnt(s) = [1618.08178931]
bas 4, expnt(s) = [239.75551797]
bas 5, expnt(s) = [52.18948383]
bas 6, expnt(s) = [4.60345982]
bas 7, expnt(s) = [0.39911837]
bas 8, expnt(s) = [1362.79269234]
bas 9, expnt(s) = [665.17591129]
bas 10, expnt(s) = [303.29474801]
bas 11, expnt(s) = [316.12364183]
bas 12, expnt(s) = [49.33118411]
bas 13, expnt(s) = [5.89048434]
bas 14, expnt(s) = [15.88560094]
bas 15, expnt(s) = [0.69647521]
bas 16, expnt(s) = [2.30465397]
bas 17, expnt(s) = [0.20640421]
CPU time:       176.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825083e+04 5.20024089e+03 7.61824529e+03 2.06018508e+03
 3.61823975e+03 1.17865860e+03 1.61808179e+03 6.44563007e+02
 2.39755518e+02 1.53936456e+02 5.21894838e+01 4.90571456e+01
 4.60345982e+00 7.94014241e+00 3.99118374e-01 1.26864851e+00
 1.36279269e+03 2.41558118e+04 6.65175911e+02 9.85496382e+03
 3.03294748e+02 3.69245750e+03 3.16123642e+02 3.88871050e+03
 4.93311841e+01 3.81404943e+02 5.89048434e+00 2.67715274e+01
 1.58856009e+01 9.25207092e+01 6.96475207e-01 1.85616453e+00
 2.30465397e+00 8.28402790e+00 2.06404213e-01 4.05865923e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9759340955806
cond(S) = 86221.63997360531
E1 = -727.5375249662108  E_coul = 203.1353123400567
init E= -524.402212626154
    CPU time for initialize scf      0.66 sec, wall time      0.08 sec
  HOMO = -0.5599401175043  LUMO = 0.900036465087548
  mo_energy =
[-1.17867488e+02 -1.20940912e+01 -9.44346020e+00 -9.44346020e+00
 -9.44346020e+00 -1.23005783e+00 -5.59940118e-01 -5.59940118e-01
 -5.59940118e-01  9.00036465e-01  9.00036465e-01  9.00036465e-01
  5.80786513e+00  5.80786513e+00  5.80786513e+00  2.54051401e+01
  2.54051401e+01  2.54051401e+01  9.85713938e+01  9.85713938e+01
  9.85713938e+01  1.83695087e+02  4.29517106e+02  4.29517106e+02
  4.29517106e+02  1.28210733e+03  1.28210733e+03  1.28210733e+03
  1.91550095e+03  2.98354889e+03  2.98354889e+03  2.98354889e+03
  6.61205064e+03  6.61205064e+03  6.61205064e+03  8.27361296e+03
  2.46612017e+04  7.54574579e+04]
E1 = -727.3030462183447  E_coul = 201.76322123022675
cycle= 1 E= -525.539824988118  delta_E= -1.14  |g|= 0.184  |ddm|= 0.533
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.454613
diis-c [-0.20667299  1.        ]
  HOMO = -0.575290607770984  LUMO = 0.893343246792188
  mo_energy =
[-1.18115653e+02 -1.21870688e+01 -9.53518806e+00 -9.53518806e+00
 -9.53518806e+00 -1.25426138e+00 -5.75290608e-01 -5.75290608e-01
 -5.75290608e-01  8.93343247e-01  8.93343247e-01  8.93343247e-01
  5.76378766e+00  5.76378766e+00  5.76378766e+00  2.53186368e+01
  2.53186368e+01  2.53186368e+01  9.84206385e+01  9.84206385e+01
  9.84206385e+01  1.83499154e+02  4.29283319e+02  4.29283319e+02
  4.29283319e+02  1.28182452e+03  1.28182452e+03  1.28182452e+03
  1.91509948e+03  2.98320603e+03  2.98320603e+03  2.98320603e+03
  6.61159348e+03  6.61159348e+03  6.61159348e+03  8.27307419e+03
  2.46605697e+04  7.54567348e+04]
E1 = -727.5229718608225  E_coul = 201.9829538415934
cycle= 2 E= -525.540018019229  delta_E= -0.000193  |g|= 0.0157  |ddm|= 0.0151
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0314698
diis-c [-7.72486909e-04  3.15033658e-02  9.68496634e-01]
  HOMO = -0.572386912490497  LUMO = 0.895251448607254
  mo_energy =
[-1.18084470e+02 -1.21715866e+01 -9.51947435e+00 -9.51947435e+00
 -9.51947435e+00 -1.25035759e+00 -5.72386912e-01 -5.72386912e-01
 -5.72386912e-01  8.95251449e-01  8.95251449e-01  8.95251449e-01
  5.77101920e+00  5.77101920e+00  5.77101920e+00  2.53329628e+01
  2.53329628e+01  2.53329628e+01  9.84438458e+01  9.84438458e+01
  9.84438458e+01  1.83529136e+02  4.29314044e+02  4.29314044e+02
  4.29314044e+02  1.28185743e+03  1.28185743e+03  1.28185743e+03
  1.91513382e+03  2.98323997e+03  2.98323997e+03  2.98323997e+03
  6.61162802e+03  6.61162802e+03  6.61162802e+03  8.27310897e+03
  2.46606045e+04  7.54567695e+04]
E1 = -727.4763355847385  E_coul = 201.93631083505022
cycle= 3 E= -525.540024749688  delta_E= -6.73e-06  |g|= 0.00226  |ddm|= 0.00402
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00467445
diis-c [-1.08968465e-07 -7.27699059e-04  1.25046655e-01  8.75681044e-01]
  HOMO = -0.572976283096948  LUMO = 0.894870457181024
  mo_energy =
[-1.18088810e+02 -1.21740518e+01 -9.52198566e+00 -9.52198566e+00
 -9.52198566e+00 -1.25113056e+00 -5.72976283e-01 -5.72976283e-01
 -5.72976283e-01  8.94870457e-01  8.94870457e-01  8.94870457e-01
  5.76969854e+00  5.76969854e+00  5.76969854e+00  2.53306537e+01
  2.53306537e+01  2.53306537e+01  9.84404504e+01  9.84404504e+01
  9.84404504e+01  1.83524987e+02  4.29309765e+02  4.29309765e+02
  4.29309765e+02  1.28185289e+03  1.28185289e+03  1.28185289e+03
  1.91512906e+03  2.98323529e+03  2.98323529e+03  2.98323529e+03
  6.61162321e+03  6.61162321e+03  6.61162321e+03  8.27310407e+03
  2.46605995e+04  7.54567645e+04]
E1 = -727.4834487300626  E_coul = 201.9434237802669
cycle= 4 E= -525.540024949796  delta_E= -2e-07  |g|= 4.13e-05  |ddm|= 0.000643
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.56964e-05
diis-c [-3.52741667e-10 -2.88961889e-05  4.63878079e-03  4.70335009e-02
  9.48356615e-01]
  HOMO = -0.572953243281028  LUMO = 0.894885010036709
  mo_energy =
[-1.18088717e+02 -1.21739745e+01 -9.52190749e+00 -9.52190749e+00
 -9.52190749e+00 -1.25110032e+00 -5.72953243e-01 -5.72953243e-01
 -5.72953243e-01  8.94885010e-01  8.94885010e-01  8.94885010e-01
  5.76974663e+00  5.76974663e+00  5.76974663e+00  2.53307260e+01
  2.53307260e+01  2.53307260e+01  9.84405362e+01  9.84405362e+01
  9.84405362e+01  1.83525079e+02  4.29309858e+02  4.29309858e+02
  4.29309858e+02  1.28185298e+03  1.28185298e+03  1.28185298e+03
  1.91512915e+03  2.98323538e+03  2.98323538e+03  2.98323538e+03
  6.61162330e+03  6.61162330e+03  6.61162330e+03  8.27310416e+03
  2.46605996e+04  7.54567646e+04]
E1 = -727.4832442322988  E_coul = 201.9432192823486
cycle= 5 E= -525.54002494995  delta_E= -1.55e-10  |g|= 2.25e-06  |ddm|= 2.27e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4832442322988  E_coul = 201.9432192823486
  HOMO = -0.572954624858928  LUMO = 0.894884125609236
  mo_energy =
[-1.18088722e+02 -1.21739788e+01 -9.52191189e+00 -9.52191189e+00
 -9.52191189e+00 -1.25110209e+00 -5.72954625e-01 -5.72954625e-01
 -5.72954625e-01  8.94884126e-01  8.94884126e-01  8.94884126e-01
  5.76974387e+00  5.76974387e+00  5.76974387e+00  2.53307219e+01
  2.53307219e+01  2.53307219e+01  9.84405311e+01  9.84405311e+01
  9.84405311e+01  1.83525074e+02  4.29309852e+02  4.29309852e+02
  4.29309852e+02  1.28185298e+03  1.28185298e+03  1.28185298e+03
  1.91512914e+03  2.98323538e+03  2.98323538e+03  2.98323538e+03
  6.61162329e+03  6.61162329e+03  6.61162329e+03  8.27310416e+03
  2.46605996e+04  7.54567646e+04]
E1 = -727.4832556049455  E_coul = 201.94323065499577
Extra cycle  E= -525.54002494995  delta_E= 5.68e-13  |g|= 5.52e-07  |ddm|= 1.09e-06
    CPU time for scf_cycle      0.85 sec, wall time      0.26 sec
exp = [2.61825083e+04 7.61824529e+03 3.61823975e+03 1.61808179e+03
 2.39755518e+02 5.21894838e+01 4.60345982e+00 3.99118374e-01
 1.36279269e+03 6.65175911e+02 3.03294748e+02 3.16123642e+02
 4.93311841e+01 5.89048434e+00 1.58856009e+01 6.96475207e-01
 2.30465397e+00 2.06404213e-01]
E = -525.5400249499497
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:23:58 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5083455        1
[INPUT] 0    0    [1    /1   ]  7618.24529128        1
[INPUT] 0    0    [1    /1   ]  3618.23975389        1
[INPUT] 0    0    [1    /1   ]  1618.08178931        1
[INPUT] 0    0    [1    /1   ]  239.755517972        1
[INPUT] 0    0    [1    /1   ]  52.1894838256        1
[INPUT] 0    0    [1    /1   ]  4.60345982131        1
[INPUT] 0    0    [1    /1   ]  0.399118373873       1
[INPUT] 1    0    [1    /1   ]  1362.79269234        1
[INPUT] 1    0    [1    /1   ]  665.175911286        1
[INPUT] 1    0    [1    /1   ]  303.294748012        1
[INPUT] 1    0    [1    /1   ]  316.123641826        1
[INPUT] 1    0    [1    /1   ]  49.3311841105        1
[INPUT] 1    0    [1    /1   ]  5.89048434129        1
[INPUT] 1    0    [1    /1   ]  15.8856009413        1
[INPUT] 1    0    [1    /1   ]  0.696475206545       1
[INPUT] 1    0    [1    /1   ]  2.30465397284        1
[INPUT] 1    0    [1    /1   ]  0.206404212738       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508345505692, 1.0]], [0, [7618.2452912829895, 1.0]], [0, [3618.2397538874397, 1.0]], [0, [1618.0817893093, 1.0]], [0, [239.75551797165207, 1.0]], [0, [52.18948382556322, 1.0]], [0, [4.603459821313534, 1.0]], [0, [0.39911837387310783, 1.0]], [1, [1362.7926923390194, 1.0]], [1, [665.175911286366, 1.0]], [1, [303.29474801237484, 1.0]], [1, [316.12364182585617, 1.0]], [1, [49.33118411045024, 1.0]], [1, [5.890484341294293, 1.0]], [1, [15.885600941253307, 1.0]], [1, [0.6964752065447947, 1.0]], [1, [2.3046539728353466, 1.0]], [1, [0.2064042127383504, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50834551]
bas 1, expnt(s) = [7618.24529128]
bas 2, expnt(s) = [3618.23975389]
bas 3, expnt(s) = [1618.08178931]
bas 4, expnt(s) = [239.75551797]
bas 5, expnt(s) = [52.18948383]
bas 6, expnt(s) = [4.60345982]
bas 7, expnt(s) = [0.39911837]
bas 8, expnt(s) = [1362.79269234]
bas 9, expnt(s) = [665.17591129]
bas 10, expnt(s) = [303.29474801]
bas 11, expnt(s) = [316.12364183]
bas 12, expnt(s) = [49.33118411]
bas 13, expnt(s) = [5.89048434]
bas 14, expnt(s) = [15.88560094]
bas 15, expnt(s) = [0.69647521]
bas 16, expnt(s) = [2.30465397]
bas 17, expnt(s) = [0.20640421]
CPU time:       177.89
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825083e+04 5.20024089e+03 7.61824529e+03 2.06018508e+03
 3.61823975e+03 1.17865860e+03 1.61808179e+03 6.44563007e+02
 2.39755518e+02 1.53936456e+02 5.21894838e+01 4.90571456e+01
 4.60345982e+00 7.94014241e+00 3.99118374e-01 1.26864851e+00
 1.36279269e+03 2.41558118e+04 6.65175911e+02 9.85496382e+03
 3.03294748e+02 3.69245750e+03 3.16123642e+02 3.88871050e+03
 4.93311841e+01 3.81404943e+02 5.89048434e+00 2.67715274e+01
 1.58856009e+01 9.25207092e+01 6.96475207e-01 1.85616453e+00
 2.30465397e+00 8.28402790e+00 2.06404213e-01 4.05865923e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9759340955806
cond(S) = 86221.63997360531
E1 = -727.5375249662108  E_coul = 203.1353123400567
init E= -524.402212626154
    CPU time for initialize scf      0.69 sec, wall time      0.08 sec
  HOMO = -0.5599401175043  LUMO = 0.900036465087548
  mo_energy =
[-1.17867488e+02 -1.20940912e+01 -9.44346020e+00 -9.44346020e+00
 -9.44346020e+00 -1.23005783e+00 -5.59940118e-01 -5.59940118e-01
 -5.59940118e-01  9.00036465e-01  9.00036465e-01  9.00036465e-01
  5.80786513e+00  5.80786513e+00  5.80786513e+00  2.54051401e+01
  2.54051401e+01  2.54051401e+01  9.85713938e+01  9.85713938e+01
  9.85713938e+01  1.83695087e+02  4.29517106e+02  4.29517106e+02
  4.29517106e+02  1.28210733e+03  1.28210733e+03  1.28210733e+03
  1.91550095e+03  2.98354889e+03  2.98354889e+03  2.98354889e+03
  6.61205064e+03  6.61205064e+03  6.61205064e+03  8.27361296e+03
  2.46612017e+04  7.54574579e+04]
E1 = -727.3030462183447  E_coul = 201.76322123022675
cycle= 1 E= -525.539824988118  delta_E= -1.14  |g|= 0.184  |ddm|= 0.533
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.454613
diis-c [-0.20667299  1.        ]
  HOMO = -0.575290607770984  LUMO = 0.893343246792188
  mo_energy =
[-1.18115653e+02 -1.21870688e+01 -9.53518806e+00 -9.53518806e+00
 -9.53518806e+00 -1.25426138e+00 -5.75290608e-01 -5.75290608e-01
 -5.75290608e-01  8.93343247e-01  8.93343247e-01  8.93343247e-01
  5.76378766e+00  5.76378766e+00  5.76378766e+00  2.53186368e+01
  2.53186368e+01  2.53186368e+01  9.84206385e+01  9.84206385e+01
  9.84206385e+01  1.83499154e+02  4.29283319e+02  4.29283319e+02
  4.29283319e+02  1.28182452e+03  1.28182452e+03  1.28182452e+03
  1.91509948e+03  2.98320603e+03  2.98320603e+03  2.98320603e+03
  6.61159348e+03  6.61159348e+03  6.61159348e+03  8.27307419e+03
  2.46605697e+04  7.54567348e+04]
E1 = -727.5229718608225  E_coul = 201.9829538415934
cycle= 2 E= -525.540018019229  delta_E= -0.000193  |g|= 0.0157  |ddm|= 0.0151
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0314698
diis-c [-7.72486909e-04  3.15033658e-02  9.68496634e-01]
  HOMO = -0.572386912490497  LUMO = 0.895251448607254
  mo_energy =
[-1.18084470e+02 -1.21715866e+01 -9.51947435e+00 -9.51947435e+00
 -9.51947435e+00 -1.25035759e+00 -5.72386912e-01 -5.72386912e-01
 -5.72386912e-01  8.95251449e-01  8.95251449e-01  8.95251449e-01
  5.77101920e+00  5.77101920e+00  5.77101920e+00  2.53329628e+01
  2.53329628e+01  2.53329628e+01  9.84438458e+01  9.84438458e+01
  9.84438458e+01  1.83529136e+02  4.29314044e+02  4.29314044e+02
  4.29314044e+02  1.28185743e+03  1.28185743e+03  1.28185743e+03
  1.91513382e+03  2.98323997e+03  2.98323997e+03  2.98323997e+03
  6.61162802e+03  6.61162802e+03  6.61162802e+03  8.27310897e+03
  2.46606045e+04  7.54567695e+04]
E1 = -727.4763355847385  E_coul = 201.93631083505022
cycle= 3 E= -525.540024749688  delta_E= -6.73e-06  |g|= 0.00226  |ddm|= 0.00402
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00467445
diis-c [-1.08968465e-07 -7.27699059e-04  1.25046655e-01  8.75681044e-01]
  HOMO = -0.572976283096948  LUMO = 0.894870457181024
  mo_energy =
[-1.18088810e+02 -1.21740518e+01 -9.52198566e+00 -9.52198566e+00
 -9.52198566e+00 -1.25113056e+00 -5.72976283e-01 -5.72976283e-01
 -5.72976283e-01  8.94870457e-01  8.94870457e-01  8.94870457e-01
  5.76969854e+00  5.76969854e+00  5.76969854e+00  2.53306537e+01
  2.53306537e+01  2.53306537e+01  9.84404504e+01  9.84404504e+01
  9.84404504e+01  1.83524987e+02  4.29309765e+02  4.29309765e+02
  4.29309765e+02  1.28185289e+03  1.28185289e+03  1.28185289e+03
  1.91512906e+03  2.98323529e+03  2.98323529e+03  2.98323529e+03
  6.61162321e+03  6.61162321e+03  6.61162321e+03  8.27310407e+03
  2.46605995e+04  7.54567645e+04]
E1 = -727.4834487300626  E_coul = 201.9434237802669
cycle= 4 E= -525.540024949796  delta_E= -2e-07  |g|= 4.13e-05  |ddm|= 0.000643
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.56964e-05
diis-c [-3.52741667e-10 -2.88961889e-05  4.63878079e-03  4.70335009e-02
  9.48356615e-01]
  HOMO = -0.572953243281028  LUMO = 0.894885010036709
  mo_energy =
[-1.18088717e+02 -1.21739745e+01 -9.52190749e+00 -9.52190749e+00
 -9.52190749e+00 -1.25110032e+00 -5.72953243e-01 -5.72953243e-01
 -5.72953243e-01  8.94885010e-01  8.94885010e-01  8.94885010e-01
  5.76974663e+00  5.76974663e+00  5.76974663e+00  2.53307260e+01
  2.53307260e+01  2.53307260e+01  9.84405362e+01  9.84405362e+01
  9.84405362e+01  1.83525079e+02  4.29309858e+02  4.29309858e+02
  4.29309858e+02  1.28185298e+03  1.28185298e+03  1.28185298e+03
  1.91512915e+03  2.98323538e+03  2.98323538e+03  2.98323538e+03
  6.61162330e+03  6.61162330e+03  6.61162330e+03  8.27310416e+03
  2.46605996e+04  7.54567646e+04]
E1 = -727.4832442322988  E_coul = 201.9432192823486
cycle= 5 E= -525.54002494995  delta_E= -1.55e-10  |g|= 2.25e-06  |ddm|= 2.27e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4832442322988  E_coul = 201.9432192823486
  HOMO = -0.572954624858928  LUMO = 0.894884125609236
  mo_energy =
[-1.18088722e+02 -1.21739788e+01 -9.52191189e+00 -9.52191189e+00
 -9.52191189e+00 -1.25110209e+00 -5.72954625e-01 -5.72954625e-01
 -5.72954625e-01  8.94884126e-01  8.94884126e-01  8.94884126e-01
  5.76974387e+00  5.76974387e+00  5.76974387e+00  2.53307219e+01
  2.53307219e+01  2.53307219e+01  9.84405311e+01  9.84405311e+01
  9.84405311e+01  1.83525074e+02  4.29309852e+02  4.29309852e+02
  4.29309852e+02  1.28185298e+03  1.28185298e+03  1.28185298e+03
  1.91512914e+03  2.98323538e+03  2.98323538e+03  2.98323538e+03
  6.61162329e+03  6.61162329e+03  6.61162329e+03  8.27310416e+03
  2.46605996e+04  7.54567646e+04]
E1 = -727.4832556049455  E_coul = 201.94323065499577
Extra cycle  E= -525.54002494995  delta_E= 5.68e-13  |g|= 5.52e-07  |ddm|= 1.09e-06
    CPU time for scf_cycle      0.89 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 86221.63997360531
E1 = -727.4832556049455  E_coul = 201.94323065499577
init E= -525.54002494995
    CPU time for initialize scf      1.19 sec, wall time      0.19 sec
  HOMO = -0.572954409558058  LUMO = 0.894884263067145
  mo_energy =
[-1.18088721e+02 -1.21739780e+01 -9.52191102e+00 -9.52191102e+00
 -9.52191102e+00 -1.25110181e+00 -5.72954410e-01 -5.72954410e-01
 -5.72954410e-01  8.94884263e-01  8.94884263e-01  8.94884263e-01
  5.76974434e+00  5.76974434e+00  5.76974434e+00  2.53307227e+01
  2.53307227e+01  2.53307227e+01  9.84405322e+01  9.84405322e+01
  9.84405322e+01  1.83525075e+02  4.29309853e+02  4.29309853e+02
  4.29309853e+02  1.28185298e+03  1.28185298e+03  1.28185298e+03
  1.91512914e+03  2.98323538e+03  2.98323538e+03  2.98323538e+03
  6.61162329e+03  6.61162329e+03  6.61162329e+03  8.27310416e+03
  2.46605996e+04  7.54567646e+04]
E1 = -727.4832532187762  E_coul = 201.94322826882558
cycle= 1 E= -525.540024949951  delta_E= -9.09e-13  |g|= 1.24e-07  |ddm|= 2.36e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4832532187762  E_coul = 201.94322826882558
  HOMO = -0.572954454039627  LUMO = 0.894884234423426
  mo_energy =
[-1.18088721e+02 -1.21739781e+01 -9.52191120e+00 -9.52191120e+00
 -9.52191120e+00 -1.25110186e+00 -5.72954454e-01 -5.72954454e-01
 -5.72954454e-01  8.94884234e-01  8.94884234e-01  8.94884234e-01
  5.76974424e+00  5.76974424e+00  5.76974424e+00  2.53307225e+01
  2.53307225e+01  2.53307225e+01  9.84405320e+01  9.84405320e+01
  9.84405320e+01  1.83525075e+02  4.29309853e+02  4.29309853e+02
  4.29309853e+02  1.28185298e+03  1.28185298e+03  1.28185298e+03
  1.91512914e+03  2.98323538e+03  2.98323538e+03  2.98323538e+03
  6.61162329e+03  6.61162329e+03  6.61162329e+03  8.27310416e+03
  2.46605996e+04  7.54567646e+04]
E1 = -727.4832537155671  E_coul = 201.94322876561597
Extra cycle  E= -525.540024949951  delta_E= -5.68e-13  |g|= 2.65e-08  |ddm|= 4.63e-08
    CPU time for scf_cycle      1.28 sec, wall time      0.28 sec
exp = [2.61825083e+04 7.61824529e+03 3.61823975e+03 1.61808179e+03
 2.39755518e+02 5.21894838e+01 4.60345982e+00 3.99118374e-01
 1.36279269e+03 6.65175911e+02 3.03294748e+02 3.16123642e+02
 4.93311841e+01 5.89048434e+00 1.58856009e+01 6.96475207e-01
 2.30465397e+00 2.06404213e-01]
grad_E = [-1.98718552e-06  2.21121966e-05  4.44855823e-05  6.80978504e-04
 -1.44444504e-04  7.18090689e-04  5.07789102e-04  1.00247550e-03
  1.72759301e-06  2.27450245e-05  1.24792266e-04  1.09971449e-04
 -2.22483159e-03  3.77774636e-03 -1.65414822e-03 -8.99965014e-03
 -1.77931855e-04  9.10029145e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5083821        1
[INPUT] 0    0    [1    /1   ]  7618.24488252        1
[INPUT] 0    0    [1    /1   ]  3618.23892957        1
[INPUT] 0    0    [1    /1   ]  1618.06919084        1
[INPUT] 0    0    [1    /1   ]  239.762740132        1
[INPUT] 0    0    [1    /1   ]  52.1440740344        1
[INPUT] 0    0    [1    /1   ]  4.6035124647         1
[INPUT] 0    0    [1    /1   ]  0.399079174141       1
[INPUT] 1    0    [1    /1   ]  1362.79266386        1
[INPUT] 1    0    [1    /1   ]  665.175516341        1
[INPUT] 1    0    [1    /1   ]  303.292595828        1
[INPUT] 1    0    [1    /1   ]  316.121745332        1
[INPUT] 1    0    [1    /1   ]  49.3573923089        1
[INPUT] 1    0    [1    /1   ]  5.89520656715        1
[INPUT] 1    0    [1    /1   ]  15.9388313115        1
[INPUT] 1    0    [1    /1   ]  0.696789681368       1
[INPUT] 1    0    [1    /1   ]  2.30112490785        1
[INPUT] 1    0    [1    /1   ]  0.206141467114       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508382083113, 1.0]], [0, [7618.244882517502, 1.0]], [0, [3618.2389295694425, 1.0]], [0, [1618.069190839337, 1.0]], [0, [239.7627401315393, 1.0]], [0, [52.14407403444693, 1.0]], [0, [4.603512464697109, 1.0]], [0, [0.3990791741412202, 1.0]], [1, [1362.792663856252, 1.0]], [1, [665.1755163412216, 1.0]], [1, [303.29259582839313, 1.0]], [1, [316.1217453315057, 1.0]], [1, [49.357392308863574, 1.0]], [1, [5.895206567152858, 1.0]], [1, [15.938831311542813, 1.0]], [1, [0.6967896813680845, 1.0]], [1, [2.3011249078513756, 1.0]], [1, [0.20614146711388054, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50838208]
bas 1, expnt(s) = [7618.24488252]
bas 2, expnt(s) = [3618.23892957]
bas 3, expnt(s) = [1618.06919084]
bas 4, expnt(s) = [239.76274013]
bas 5, expnt(s) = [52.14407403]
bas 6, expnt(s) = [4.60351246]
bas 7, expnt(s) = [0.39907917]
bas 8, expnt(s) = [1362.79266386]
bas 9, expnt(s) = [665.17551634]
bas 10, expnt(s) = [303.29259583]
bas 11, expnt(s) = [316.12174533]
bas 12, expnt(s) = [49.35739231]
bas 13, expnt(s) = [5.89520657]
bas 14, expnt(s) = [15.93883131]
bas 15, expnt(s) = [0.69678968]
bas 16, expnt(s) = [2.30112491]
bas 17, expnt(s) = [0.20614147]
CPU time:       183.90
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825084e+04 5.20024090e+03 7.61824488e+03 2.06018500e+03
 3.61823893e+03 1.17865840e+03 1.61806919e+03 6.44559243e+02
 2.39762740e+02 1.53939933e+02 5.21440740e+01 4.90251289e+01
 4.60351246e+00 7.94021051e+00 3.99079174e-01 1.26855506e+00
 1.36279266e+03 2.41558112e+04 6.65175516e+02 9.85495650e+03
 3.03292596e+02 3.69242474e+03 3.16121745e+02 3.88868134e+03
 4.93573923e+01 3.81658247e+02 5.89520657e+00 2.67983575e+01
 1.59388313e+01 9.29084009e+01 6.96789681e-01 1.85721221e+00
 2.30112491e+00 8.26817451e+00 2.06141467e-01 4.05220209e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.975957943319287
cond(S) = 86286.8928332785
E1 = -727.5409293071297  E_coul = 203.1337274733672
init E= -524.407201833762
    CPU time for initialize scf      0.69 sec, wall time      0.08 sec
  HOMO = -0.559973177136275  LUMO = 0.899268211213794
  mo_energy =
[-1.17868196e+02 -1.20937649e+01 -9.44359629e+00 -9.44359629e+00
 -9.44359629e+00 -1.23003153e+00 -5.59973177e-01 -5.59973177e-01
 -5.59973177e-01  8.99268211e-01  8.99268211e-01  8.99268211e-01
  5.80302054e+00  5.80302054e+00  5.80302054e+00  2.54350305e+01
  2.54350305e+01  2.54350305e+01  9.87464690e+01  9.87464690e+01
  9.87464690e+01  1.83573399e+02  4.29769130e+02  4.29769130e+02
  4.29769130e+02  1.28234976e+03  1.28234976e+03  1.28234976e+03
  1.91535250e+03  2.98377501e+03  2.98377501e+03  2.98377501e+03
  6.61225488e+03  6.61225488e+03  6.61225488e+03  8.27345930e+03
  2.46610392e+04  7.54572976e+04]
E1 = -727.2947803588785  E_coul = 201.75483509813546
cycle= 1 E= -525.539945260743  delta_E= -1.13  |g|= 0.183  |ddm|= 0.567
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.454982
diis-c [-0.20700878  1.        ]
  HOMO = -0.575498871653418  LUMO = 0.892457307623309
  mo_energy =
[-1.18117486e+02 -1.21870630e+01 -9.53573442e+00 -9.53573442e+00
 -9.53573442e+00 -1.25442507e+00 -5.75498872e-01 -5.75498872e-01
 -5.75498872e-01  8.92457308e-01  8.92457308e-01  8.92457308e-01
  5.75868588e+00  5.75868588e+00  5.75868588e+00  2.53479854e+01
  2.53479854e+01  2.53479854e+01  9.85948798e+01  9.85948798e+01
  9.85948798e+01  1.83376431e+02  4.29534116e+02  4.29534116e+02
  4.29534116e+02  1.28206521e+03  1.28206521e+03  1.28206521e+03
  1.91494831e+03  2.98342984e+03  2.98342984e+03  2.98342984e+03
  6.61179492e+03  6.61179492e+03  6.61179492e+03  8.27291740e+03
  2.46604038e+04  7.54565711e+04]
E1 = -727.5162440081144  E_coul = 201.97610297304868
cycle= 2 E= -525.540141035066  delta_E= -0.000196  |g|= 0.0158  |ddm|= 0.0152
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.031677
diis-c [-7.78095260e-04  3.19974682e-02  9.68002532e-01]
  HOMO = -0.572579230150678  LUMO = 0.894375195162648
  mo_energy =
[-1.18086097e+02 -1.21714791e+01 -9.51991704e+00 -9.51991704e+00
 -9.51991704e+00 -1.25049881e+00 -5.72579230e-01 -5.72579230e-01
 -5.72579230e-01  8.94375195e-01  8.94375195e-01  8.94375195e-01
  5.76595977e+00  5.76595977e+00  5.76595977e+00  2.53624218e+01
  2.53624218e+01  2.53624218e+01  9.86182492e+01  9.86182492e+01
  9.86182492e+01  1.83406610e+02  4.29565043e+02  4.29565043e+02
  4.29565043e+02  1.28209834e+03  1.28209834e+03  1.28209834e+03
  1.91498287e+03  2.98346400e+03  2.98346400e+03  2.98346400e+03
  6.61182967e+03  6.61182967e+03  6.61182967e+03  8.27295239e+03
  2.46604388e+04  7.54566060e+04]
E1 = -727.4692439014016  E_coul = 201.9290960306397
cycle= 3 E= -525.540147870762  delta_E= -6.84e-06  |g|= 0.00227  |ddm|= 0.00405
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00469258
diis-c [-1.12686883e-07 -7.33094340e-04  1.24685194e-01  8.76047900e-01]
  HOMO = -0.573172849628126  LUMO = 0.893991539669107
  mo_energy =
[-1.18090455e+02 -1.21739569e+01 -9.52244134e+00 -9.52244134e+00
 -9.52244134e+00 -1.25127713e+00 -5.73172850e-01 -5.73172850e-01
 -5.73172850e-01  8.93991540e-01  8.93991540e-01  8.93991540e-01
  5.76463125e+00  5.76463125e+00  5.76463125e+00  2.53600984e+01
  2.53600984e+01  2.53600984e+01  9.86148369e+01  9.86148369e+01
  9.86148369e+01  1.83402443e+02  4.29560746e+02  4.29560746e+02
  4.29560746e+02  1.28209378e+03  1.28209378e+03  1.28209378e+03
  1.91497809e+03  2.98345929e+03  2.98345929e+03  2.98345929e+03
  6.61182484e+03  6.61182484e+03  6.61182484e+03  8.27294748e+03
  2.46604338e+04  7.54566010e+04]
E1 = -727.4763998446125  E_coul = 201.93625177154993
cycle= 4 E= -525.540148073063  delta_E= -2.02e-07  |g|= 4.18e-05  |ddm|= 0.000647
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.64599e-05
diis-c [-3.66101302e-10 -2.88326674e-05  4.53393296e-03  4.65146994e-02
  9.48980200e-01]
  HOMO = -0.573149569113969  LUMO = 0.894006237110784
  mo_energy =
[-1.18090361e+02 -1.21738787e+01 -9.52236224e+00 -9.52236224e+00
 -9.52236224e+00 -1.25124656e+00 -5.73149569e-01 -5.73149569e-01
 -5.73149569e-01  8.94006237e-01  8.94006237e-01  8.94006237e-01
  5.76467986e+00  5.76467986e+00  5.76467986e+00  2.53601716e+01
  2.53601716e+01  2.53601716e+01  9.86149238e+01  9.86149238e+01
  9.86149238e+01  1.83402536e+02  4.29560839e+02  4.29560839e+02
  4.29560839e+02  1.28209387e+03  1.28209387e+03  1.28209387e+03
  1.91497818e+03  2.98345939e+03  2.98345939e+03  2.98345939e+03
  6.61182493e+03  6.61182493e+03  6.61182493e+03  8.27294757e+03
  2.46604339e+04  7.54566011e+04]
E1 = -727.4761925053374  E_coul = 201.93604443211535
cycle= 5 E= -525.540148073222  delta_E= -1.6e-10  |g|= 2.32e-06  |ddm|= 2.3e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4761925053374  E_coul = 201.93604443211535
  HOMO = -0.573150998502086  LUMO = 0.894005321886402
  mo_energy =
[-1.18090367e+02 -1.21738831e+01 -9.52236678e+00 -9.52236678e+00
 -9.52236678e+00 -1.25124839e+00 -5.73150999e-01 -5.73150999e-01
 -5.73150999e-01  8.94005322e-01  8.94005322e-01  8.94005322e-01
  5.76467700e+00  5.76467700e+00  5.76467700e+00  2.53601673e+01
  2.53601673e+01  2.53601673e+01  9.86149185e+01  9.86149185e+01
  9.86149185e+01  1.83402530e+02  4.29560833e+02  4.29560833e+02
  4.29560833e+02  1.28209386e+03  1.28209386e+03  1.28209386e+03
  1.91497817e+03  2.98345938e+03  2.98345938e+03  2.98345938e+03
  6.61182492e+03  6.61182492e+03  6.61182492e+03  8.27294756e+03
  2.46604339e+04  7.54566011e+04]
E1 = -727.4762042481512  E_coul = 201.93605617492966
Extra cycle  E= -525.540148073222  delta_E= 4.55e-13  |g|= 5.7e-07  |ddm|= 1.13e-06
    CPU time for scf_cycle      0.88 sec, wall time      0.27 sec
exp = [2.61825084e+04 7.61824488e+03 3.61823893e+03 1.61806919e+03
 2.39762740e+02 5.21440740e+01 4.60351246e+00 3.99079174e-01
 1.36279266e+03 6.65175516e+02 3.03292596e+02 3.16121745e+02
 4.93573923e+01 5.89520657e+00 1.59388313e+01 6.96789681e-01
 2.30112491e+00 2.06141467e-01]
E = -525.5401480732216
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5083821        1
[INPUT] 0    0    [1    /1   ]  7618.24488252        1
[INPUT] 0    0    [1    /1   ]  3618.23892957        1
[INPUT] 0    0    [1    /1   ]  1618.06919084        1
[INPUT] 0    0    [1    /1   ]  239.762740132        1
[INPUT] 0    0    [1    /1   ]  52.1440740344        1
[INPUT] 0    0    [1    /1   ]  4.6035124647         1
[INPUT] 0    0    [1    /1   ]  0.399079174141       1
[INPUT] 1    0    [1    /1   ]  1362.79266386        1
[INPUT] 1    0    [1    /1   ]  665.175516341        1
[INPUT] 1    0    [1    /1   ]  303.292595828        1
[INPUT] 1    0    [1    /1   ]  316.121745332        1
[INPUT] 1    0    [1    /1   ]  49.3573923089        1
[INPUT] 1    0    [1    /1   ]  5.89520656715        1
[INPUT] 1    0    [1    /1   ]  15.9388313115        1
[INPUT] 1    0    [1    /1   ]  0.696789681368       1
[INPUT] 1    0    [1    /1   ]  2.30112490785        1
[INPUT] 1    0    [1    /1   ]  0.206141467114       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508382083113, 1.0]], [0, [7618.244882517502, 1.0]], [0, [3618.2389295694425, 1.0]], [0, [1618.069190839337, 1.0]], [0, [239.7627401315393, 1.0]], [0, [52.14407403444693, 1.0]], [0, [4.603512464697109, 1.0]], [0, [0.3990791741412202, 1.0]], [1, [1362.792663856252, 1.0]], [1, [665.1755163412216, 1.0]], [1, [303.29259582839313, 1.0]], [1, [316.1217453315057, 1.0]], [1, [49.357392308863574, 1.0]], [1, [5.895206567152858, 1.0]], [1, [15.938831311542813, 1.0]], [1, [0.6967896813680845, 1.0]], [1, [2.3011249078513756, 1.0]], [1, [0.20614146711388054, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50838208]
bas 1, expnt(s) = [7618.24488252]
bas 2, expnt(s) = [3618.23892957]
bas 3, expnt(s) = [1618.06919084]
bas 4, expnt(s) = [239.76274013]
bas 5, expnt(s) = [52.14407403]
bas 6, expnt(s) = [4.60351246]
bas 7, expnt(s) = [0.39907917]
bas 8, expnt(s) = [1362.79266386]
bas 9, expnt(s) = [665.17551634]
bas 10, expnt(s) = [303.29259583]
bas 11, expnt(s) = [316.12174533]
bas 12, expnt(s) = [49.35739231]
bas 13, expnt(s) = [5.89520657]
bas 14, expnt(s) = [15.93883131]
bas 15, expnt(s) = [0.69678968]
bas 16, expnt(s) = [2.30112491]
bas 17, expnt(s) = [0.20614147]
CPU time:       184.94
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825084e+04 5.20024090e+03 7.61824488e+03 2.06018500e+03
 3.61823893e+03 1.17865840e+03 1.61806919e+03 6.44559243e+02
 2.39762740e+02 1.53939933e+02 5.21440740e+01 4.90251289e+01
 4.60351246e+00 7.94021051e+00 3.99079174e-01 1.26855506e+00
 1.36279266e+03 2.41558112e+04 6.65175516e+02 9.85495650e+03
 3.03292596e+02 3.69242474e+03 3.16121745e+02 3.88868134e+03
 4.93573923e+01 3.81658247e+02 5.89520657e+00 2.67983575e+01
 1.59388313e+01 9.29084009e+01 6.96789681e-01 1.85721221e+00
 2.30112491e+00 8.26817451e+00 2.06141467e-01 4.05220209e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.975957943319287
cond(S) = 86286.8928332785
E1 = -727.5409293071297  E_coul = 203.1337274733672
init E= -524.407201833762
    CPU time for initialize scf      0.68 sec, wall time      0.08 sec
  HOMO = -0.559973177136275  LUMO = 0.899268211213794
  mo_energy =
[-1.17868196e+02 -1.20937649e+01 -9.44359629e+00 -9.44359629e+00
 -9.44359629e+00 -1.23003153e+00 -5.59973177e-01 -5.59973177e-01
 -5.59973177e-01  8.99268211e-01  8.99268211e-01  8.99268211e-01
  5.80302054e+00  5.80302054e+00  5.80302054e+00  2.54350305e+01
  2.54350305e+01  2.54350305e+01  9.87464690e+01  9.87464690e+01
  9.87464690e+01  1.83573399e+02  4.29769130e+02  4.29769130e+02
  4.29769130e+02  1.28234976e+03  1.28234976e+03  1.28234976e+03
  1.91535250e+03  2.98377501e+03  2.98377501e+03  2.98377501e+03
  6.61225488e+03  6.61225488e+03  6.61225488e+03  8.27345930e+03
  2.46610392e+04  7.54572976e+04]
E1 = -727.2947803588785  E_coul = 201.75483509813546
cycle= 1 E= -525.539945260743  delta_E= -1.13  |g|= 0.183  |ddm|= 0.567
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.454982
diis-c [-0.20700878  1.        ]
  HOMO = -0.575498871653418  LUMO = 0.892457307623309
  mo_energy =
[-1.18117486e+02 -1.21870630e+01 -9.53573442e+00 -9.53573442e+00
 -9.53573442e+00 -1.25442507e+00 -5.75498872e-01 -5.75498872e-01
 -5.75498872e-01  8.92457308e-01  8.92457308e-01  8.92457308e-01
  5.75868588e+00  5.75868588e+00  5.75868588e+00  2.53479854e+01
  2.53479854e+01  2.53479854e+01  9.85948798e+01  9.85948798e+01
  9.85948798e+01  1.83376431e+02  4.29534116e+02  4.29534116e+02
  4.29534116e+02  1.28206521e+03  1.28206521e+03  1.28206521e+03
  1.91494831e+03  2.98342984e+03  2.98342984e+03  2.98342984e+03
  6.61179492e+03  6.61179492e+03  6.61179492e+03  8.27291740e+03
  2.46604038e+04  7.54565711e+04]
E1 = -727.5162440081144  E_coul = 201.97610297304868
cycle= 2 E= -525.540141035066  delta_E= -0.000196  |g|= 0.0158  |ddm|= 0.0152
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.031677
diis-c [-7.78095260e-04  3.19974682e-02  9.68002532e-01]
  HOMO = -0.572579230150678  LUMO = 0.894375195162648
  mo_energy =
[-1.18086097e+02 -1.21714791e+01 -9.51991704e+00 -9.51991704e+00
 -9.51991704e+00 -1.25049881e+00 -5.72579230e-01 -5.72579230e-01
 -5.72579230e-01  8.94375195e-01  8.94375195e-01  8.94375195e-01
  5.76595977e+00  5.76595977e+00  5.76595977e+00  2.53624218e+01
  2.53624218e+01  2.53624218e+01  9.86182492e+01  9.86182492e+01
  9.86182492e+01  1.83406610e+02  4.29565043e+02  4.29565043e+02
  4.29565043e+02  1.28209834e+03  1.28209834e+03  1.28209834e+03
  1.91498287e+03  2.98346400e+03  2.98346400e+03  2.98346400e+03
  6.61182967e+03  6.61182967e+03  6.61182967e+03  8.27295239e+03
  2.46604388e+04  7.54566060e+04]
E1 = -727.4692439014016  E_coul = 201.9290960306397
cycle= 3 E= -525.540147870762  delta_E= -6.84e-06  |g|= 0.00227  |ddm|= 0.00405
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00469258
diis-c [-1.12686883e-07 -7.33094340e-04  1.24685194e-01  8.76047900e-01]
  HOMO = -0.573172849628126  LUMO = 0.893991539669107
  mo_energy =
[-1.18090455e+02 -1.21739569e+01 -9.52244134e+00 -9.52244134e+00
 -9.52244134e+00 -1.25127713e+00 -5.73172850e-01 -5.73172850e-01
 -5.73172850e-01  8.93991540e-01  8.93991540e-01  8.93991540e-01
  5.76463125e+00  5.76463125e+00  5.76463125e+00  2.53600984e+01
  2.53600984e+01  2.53600984e+01  9.86148369e+01  9.86148369e+01
  9.86148369e+01  1.83402443e+02  4.29560746e+02  4.29560746e+02
  4.29560746e+02  1.28209378e+03  1.28209378e+03  1.28209378e+03
  1.91497809e+03  2.98345929e+03  2.98345929e+03  2.98345929e+03
  6.61182484e+03  6.61182484e+03  6.61182484e+03  8.27294748e+03
  2.46604338e+04  7.54566010e+04]
E1 = -727.4763998446125  E_coul = 201.93625177154993
cycle= 4 E= -525.540148073063  delta_E= -2.02e-07  |g|= 4.18e-05  |ddm|= 0.000647
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.64599e-05
diis-c [-3.66101302e-10 -2.88326674e-05  4.53393296e-03  4.65146994e-02
  9.48980200e-01]
  HOMO = -0.573149569113969  LUMO = 0.894006237110784
  mo_energy =
[-1.18090361e+02 -1.21738787e+01 -9.52236224e+00 -9.52236224e+00
 -9.52236224e+00 -1.25124656e+00 -5.73149569e-01 -5.73149569e-01
 -5.73149569e-01  8.94006237e-01  8.94006237e-01  8.94006237e-01
  5.76467986e+00  5.76467986e+00  5.76467986e+00  2.53601716e+01
  2.53601716e+01  2.53601716e+01  9.86149238e+01  9.86149238e+01
  9.86149238e+01  1.83402536e+02  4.29560839e+02  4.29560839e+02
  4.29560839e+02  1.28209387e+03  1.28209387e+03  1.28209387e+03
  1.91497818e+03  2.98345939e+03  2.98345939e+03  2.98345939e+03
  6.61182493e+03  6.61182493e+03  6.61182493e+03  8.27294757e+03
  2.46604339e+04  7.54566011e+04]
E1 = -727.4761925053374  E_coul = 201.93604443211535
cycle= 5 E= -525.540148073222  delta_E= -1.6e-10  |g|= 2.32e-06  |ddm|= 2.3e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4761925053374  E_coul = 201.93604443211535
  HOMO = -0.573150998502086  LUMO = 0.894005321886402
  mo_energy =
[-1.18090367e+02 -1.21738831e+01 -9.52236678e+00 -9.52236678e+00
 -9.52236678e+00 -1.25124839e+00 -5.73150999e-01 -5.73150999e-01
 -5.73150999e-01  8.94005322e-01  8.94005322e-01  8.94005322e-01
  5.76467700e+00  5.76467700e+00  5.76467700e+00  2.53601673e+01
  2.53601673e+01  2.53601673e+01  9.86149185e+01  9.86149185e+01
  9.86149185e+01  1.83402530e+02  4.29560833e+02  4.29560833e+02
  4.29560833e+02  1.28209386e+03  1.28209386e+03  1.28209386e+03
  1.91497817e+03  2.98345938e+03  2.98345938e+03  2.98345938e+03
  6.61182492e+03  6.61182492e+03  6.61182492e+03  8.27294756e+03
  2.46604339e+04  7.54566011e+04]
E1 = -727.4762042481512  E_coul = 201.93605617492966
Extra cycle  E= -525.540148073222  delta_E= 4.55e-13  |g|= 5.7e-07  |ddm|= 1.13e-06
    CPU time for scf_cycle      0.87 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 86286.8928332785
E1 = -727.4762042481512  E_coul = 201.93605617492966
init E= -525.540148073222
    CPU time for initialize scf      0.94 sec, wall time      0.18 sec
  HOMO = -0.573150776133308  LUMO = 0.894005463796299
  mo_energy =
[-1.18090366e+02 -1.21738823e+01 -9.52236589e+00 -9.52236589e+00
 -9.52236589e+00 -1.25124809e+00 -5.73150776e-01 -5.73150776e-01
 -5.73150776e-01  8.94005464e-01  8.94005464e-01  8.94005464e-01
  5.76467749e+00  5.76467749e+00  5.76467749e+00  2.53601681e+01
  2.53601681e+01  2.53601681e+01  9.86149196e+01  9.86149196e+01
  9.86149196e+01  1.83402532e+02  4.29560835e+02  4.29560835e+02
  4.29560835e+02  1.28209387e+03  1.28209387e+03  1.28209387e+03
  1.91497817e+03  2.98345938e+03  2.98345938e+03  2.98345938e+03
  6.61182492e+03  6.61182492e+03  6.61182492e+03  8.27294756e+03
  2.46604339e+04  7.54566011e+04]
E1 = -727.4762017804763  E_coul = 201.9360537072534
cycle= 1 E= -525.540148073223  delta_E= -1.36e-12  |g|= 1.28e-07  |ddm|= 2.44e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4762017804763  E_coul = 201.9360537072534
  HOMO = -0.573150822189722  LUMO = 0.894005434144382
  mo_energy =
[-1.18090366e+02 -1.21738825e+01 -9.52236607e+00 -9.52236607e+00
 -9.52236607e+00 -1.25124815e+00 -5.73150822e-01 -5.73150822e-01
 -5.73150822e-01  8.94005434e-01  8.94005434e-01  8.94005434e-01
  5.76467739e+00  5.76467739e+00  5.76467739e+00  2.53601680e+01
  2.53601680e+01  2.53601680e+01  9.86149194e+01  9.86149194e+01
  9.86149194e+01  1.83402531e+02  4.29560834e+02  4.29560834e+02
  4.29560834e+02  1.28209387e+03  1.28209387e+03  1.28209387e+03
  1.91497817e+03  2.98345938e+03  2.98345938e+03  2.98345938e+03
  6.61182492e+03  6.61182492e+03  6.61182492e+03  8.27294756e+03
  2.46604339e+04  7.54566011e+04]
E1 = -727.4762022947517  E_coul = 201.93605422152862
Extra cycle  E= -525.540148073223  delta_E= -1.14e-13  |g|= 2.74e-08  |ddm|= 4.79e-08
    CPU time for scf_cycle      1.06 sec, wall time      0.30 sec
exp = [2.61825084e+04 7.61824488e+03 3.61823893e+03 1.61806919e+03
 2.39762740e+02 5.21440740e+01 4.60351246e+00 3.99079174e-01
 1.36279266e+03 6.65175516e+02 3.03292596e+02 3.16121745e+02
 4.93573923e+01 5.89520657e+00 1.59388313e+01 6.96789681e-01
 2.30112491e+00 2.06141467e-01]
grad_E = [-1.98707379e-06  2.20476708e-05  4.42866410e-05  6.78578046e-04
  2.84097277e-05 -5.13139668e-04  6.02676293e-04  8.60296344e-04
  1.76743504e-06  2.30257039e-05  1.26527558e-04  1.11500810e-04
 -2.44557194e-03  2.05159338e-03 -5.16488846e-04 -5.43731665e-03
  3.59419120e-04 -6.03987709e-05]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5083853        1
[INPUT] 0    0    [1    /1   ]  7618.24484508        1
[INPUT] 0    0    [1    /1   ]  3618.23885269        1
[INPUT] 0    0    [1    /1   ]  1618.0680271         1
[INPUT] 0    0    [1    /1   ]  239.767120755        1
[INPUT] 0    0    [1    /1   ]  52.1131068005        1
[INPUT] 0    0    [1    /1   ]  4.60335544342        1
[INPUT] 0    0    [1    /1   ]  0.399017539104       1
[INPUT] 1    0    [1    /1   ]  1362.79265816        1
[INPUT] 1    0    [1    /1   ]  665.17545866         1
[INPUT] 1    0    [1    /1   ]  303.292266884        1
[INPUT] 1    0    [1    /1   ]  316.121455344        1
[INPUT] 1    0    [1    /1   ]  49.3737006498        1
[INPUT] 1    0    [1    /1   ]  5.8482762551         1
[INPUT] 1    0    [1    /1   ]  15.9221329055        1
[INPUT] 1    0    [1    /1   ]  0.694978356746       1
[INPUT] 1    0    [1    /1   ]  2.26467100222        1
[INPUT] 1    0    [1    /1   ]  0.20622960154        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.50838531676, 1.0]], [0, [7618.244845079727, 1.0]], [0, [3618.2388526941945, 1.0]], [0, [1618.0680270972514, 1.0]], [0, [239.76712075452693, 1.0]], [0, [52.113106800469986, 1.0]], [0, [4.603355443420901, 1.0]], [0, [0.3990175391041149, 1.0]], [1, [1362.7926581582253, 1.0]], [1, [665.175458659937, 1.0]], [1, [303.2922668841245, 1.0]], [1, [316.12145534373263, 1.0]], [1, [49.373700649826674, 1.0]], [1, [5.848276255101291, 1.0]], [1, [15.92213290546614, 1.0]], [1, [0.6949783567455069, 1.0]], [1, [2.264671002215422, 1.0]], [1, [0.20622960154011657, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50838532]
bas 1, expnt(s) = [7618.24484508]
bas 2, expnt(s) = [3618.23885269]
bas 3, expnt(s) = [1618.0680271]
bas 4, expnt(s) = [239.76712075]
bas 5, expnt(s) = [52.1131068]
bas 6, expnt(s) = [4.60335544]
bas 7, expnt(s) = [0.39901754]
bas 8, expnt(s) = [1362.79265816]
bas 9, expnt(s) = [665.17545866]
bas 10, expnt(s) = [303.29226688]
bas 11, expnt(s) = [316.12145534]
bas 12, expnt(s) = [49.37370065]
bas 13, expnt(s) = [5.84827626]
bas 14, expnt(s) = [15.92213291]
bas 15, expnt(s) = [0.69497836]
bas 16, expnt(s) = [2.264671]
bas 17, expnt(s) = [0.2062296]
CPU time:       191.19
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825084e+04 5.20024090e+03 7.61824485e+03 2.06018499e+03
 3.61823885e+03 1.17865838e+03 1.61806803e+03 6.44558896e+02
 2.39767121e+02 1.53942043e+02 5.21131068e+01 4.90032910e+01
 4.60335544e+00 7.94000739e+00 3.99017539e-01 1.26840812e+00
 1.36279266e+03 2.41558111e+04 6.65175459e+02 9.85495544e+03
 3.03292267e+02 3.69241974e+03 3.16121455e+02 3.88867688e+03
 4.93737006e+01 3.81815884e+02 5.84827626e+00 2.65319544e+01
 1.59221329e+01 9.27867469e+01 6.94978357e-01 1.85117933e+00
 2.26467100e+00 8.10477181e+00 2.06229602e-01 4.05436782e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97599388980298
cond(S) = 86219.38578221334
E1 = -727.5424551901259  E_coul = 203.1319856208813
init E= -524.410469569245
    CPU time for initialize scf      0.15 sec, wall time      0.04 sec
  HOMO = -0.56002690038876  LUMO = 0.89801257507343
  mo_energy =
[-1.17868745e+02 -1.20936081e+01 -9.44372398e+00 -9.44372398e+00
 -9.44372398e+00 -1.23000645e+00 -5.60026900e-01 -5.60026900e-01
 -5.60026900e-01  8.98012575e-01  8.98012575e-01  8.98012575e-01
  5.73064777e+00  5.73064777e+00  5.73064777e+00  2.51828896e+01
  2.51828896e+01  2.51828896e+01  9.84229431e+01  9.84229431e+01
  9.84229431e+01  1.83489077e+02  4.29534177e+02  4.29534177e+02
  4.29534177e+02  1.28215588e+03  1.28215588e+03  1.28215588e+03
  1.91525308e+03  2.98359854e+03  2.98359854e+03  2.98359854e+03
  6.61209487e+03  6.61209487e+03  6.61209487e+03  8.27336796e+03
  2.46609514e+04  7.54572152e+04]
E1 = -727.2970145145242  E_coul = 201.756996676841
cycle= 1 E= -525.540017837683  delta_E= -1.13  |g|= 0.183  |ddm|= 0.584
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.454831
diis-c [-0.20687089  1.        ]
  HOMO = -0.575416639145292  LUMO = 0.891331908338676
  mo_energy =
[-1.18118136e+02 -1.21864925e+01 -9.53551538e+00 -9.53551538e+00
 -9.53551538e+00 -1.25420451e+00 -5.75416639e-01 -5.75416639e-01
 -5.75416639e-01  8.91331908e-01  8.91331908e-01  8.91331908e-01
  5.68703615e+00  5.68703615e+00  5.68703615e+00  2.50963443e+01
  2.50963443e+01  2.50963443e+01  9.82714100e+01  9.82714100e+01
  9.82714100e+01  1.83292082e+02  4.29298947e+02  4.29298947e+02
  4.29298947e+02  1.28187080e+03  1.28187080e+03  1.28187080e+03
  1.91484770e+03  2.98325245e+03  2.98325245e+03  2.98325245e+03
  6.61163364e+03  6.61163364e+03  6.61163364e+03  8.27282459e+03
  2.46603144e+04  7.54564870e+04]
E1 = -727.5179130200687  E_coul = 201.97769900008433
cycle= 2 E= -525.540214019984  delta_E= -0.000196  |g|= 0.0158  |ddm|= 0.0151
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0316195
diis-c [-7.74139296e-04  3.20292325e-02  9.67970767e-01]
  HOMO = -0.572519640351804  LUMO = 0.893226716090893
  mo_energy =
[-1.18086758e+02 -1.21709507e+01 -9.51974049e+00 -9.51974049e+00
 -9.51974049e+00 -1.25030698e+00 -5.72519640e-01 -5.72519640e-01
 -5.72519640e-01  8.93226716e-01  8.93226716e-01  8.93226716e-01
  5.69420135e+00  5.69420135e+00  5.69420135e+00  2.51107068e+01
  2.51107068e+01  2.51107068e+01  9.82947595e+01  9.82947595e+01
  9.82947595e+01  1.83322246e+02  4.29329865e+02  4.29329865e+02
  4.29329865e+02  1.28190392e+03  1.28190392e+03  1.28190392e+03
  1.91488224e+03  2.98328660e+03  2.98328660e+03  2.98328660e+03
  6.61166839e+03  6.61166839e+03  6.61166839e+03  8.27285957e+03
  2.46603494e+04  7.54565219e+04]
E1 = -727.4709778683356  E_coul = 201.93075702532698
cycle= 3 E= -525.540220843009  delta_E= -6.82e-06  |g|= 0.00227  |ddm|= 0.00404
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00467891
diis-c [-1.15820969e-07 -7.35958680e-04  1.24515262e-01  8.76220697e-01]
  HOMO = -0.57311262005305  LUMO = 0.892845019810665
  mo_energy =
[-1.18091113e+02 -1.21734254e+01 -9.52226180e+00 -9.52226180e+00
 -9.52226180e+00 -1.25108425e+00 -5.73112620e-01 -5.73112620e-01
 -5.73112620e-01  8.92845020e-01  8.92845020e-01  8.92845020e-01
  5.69288560e+00  5.69288560e+00  5.69288560e+00  2.51083906e+01
  2.51083906e+01  2.51083906e+01  9.82913496e+01  9.82913496e+01
  9.82913496e+01  1.83318083e+02  4.29325572e+02  4.29325572e+02
  4.29325572e+02  1.28189936e+03  1.28189936e+03  1.28189936e+03
  1.91487747e+03  2.98328190e+03  2.98328190e+03  2.98328190e+03
  6.61166356e+03  6.61166356e+03  6.61166356e+03  8.27285465e+03
  2.46603445e+04  7.54565169e+04]
E1 = -727.4781274355248  E_coul = 201.93790639061308
cycle= 4 E= -525.540221044912  delta_E= -2.02e-07  |g|= 4.21e-05  |ddm|= 0.000644
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.70117e-05
diis-c [-3.75548833e-10 -2.89537787e-05  4.50212789e-03  4.64883947e-02
  9.49038431e-01]
  HOMO = -0.573089186609221  LUMO = 0.892859746858282
  mo_energy =
[-1.18091018e+02 -1.21733465e+01 -9.52218201e+00 -9.52218201e+00
 -9.52218201e+00 -1.25105347e+00 -5.73089187e-01 -5.73089187e-01
 -5.73089187e-01  8.92859747e-01  8.92859747e-01  8.92859747e-01
  5.69293423e+00  5.69293423e+00  5.69293423e+00  2.51084642e+01
  2.51084642e+01  2.51084642e+01  9.82914373e+01  9.82914373e+01
  9.82914373e+01  1.83318177e+02  4.29325666e+02  4.29325666e+02
  4.29325666e+02  1.28189946e+03  1.28189946e+03  1.28189946e+03
  1.91487756e+03  2.98328200e+03  2.98328200e+03  2.98328200e+03
  6.61166365e+03  6.61166365e+03  6.61166365e+03  8.27285475e+03
  2.46603446e+04  7.54565170e+04]
E1 = -727.4779180301115  E_coul = 201.9376969850381
cycle= 5 E= -525.540221045073  delta_E= -1.62e-10  |g|= 2.36e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4779180301115  E_coul = 201.9376969850381
  HOMO = -0.573090644936198  LUMO = 0.892858816068157
  mo_energy =
[-1.18091024e+02 -1.21733510e+01 -9.52218662e+00 -9.52218662e+00
 -9.52218662e+00 -1.25105533e+00 -5.73090645e-01 -5.73090645e-01
 -5.73090645e-01  8.92858816e-01  8.92858816e-01  8.92858816e-01
  5.69293133e+00  5.69293133e+00  5.69293133e+00  2.51084599e+01
  2.51084599e+01  2.51084599e+01  9.82914319e+01  9.82914319e+01
  9.82914319e+01  1.83318172e+02  4.29325660e+02  4.29325660e+02
  4.29325660e+02  1.28189945e+03  1.28189945e+03  1.28189945e+03
  1.91487755e+03  2.98328199e+03  2.98328199e+03  2.98328199e+03
  6.61166364e+03  6.61166364e+03  6.61166364e+03  8.27285474e+03
  2.46603446e+04  7.54565170e+04]
E1 = -727.4779299521439  E_coul = 201.93770890707034
Extra cycle  E= -525.540221045074  delta_E= -1.14e-13  |g|= 5.79e-07  |ddm|= 1.14e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.23 sec
exp = [2.61825084e+04 7.61824485e+03 3.61823885e+03 1.61806803e+03
 2.39767121e+02 5.21131068e+01 4.60335544e+00 3.99017539e-01
 1.36279266e+03 6.65175459e+02 3.03292267e+02 3.16121455e+02
 4.93737006e+01 5.84827626e+00 1.59221329e+01 6.94978357e-01
 2.26467100e+00 2.06229602e-01]
E = -525.5402210450735
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5083853        1
[INPUT] 0    0    [1    /1   ]  7618.24484508        1
[INPUT] 0    0    [1    /1   ]  3618.23885269        1
[INPUT] 0    0    [1    /1   ]  1618.0680271         1
[INPUT] 0    0    [1    /1   ]  239.767120755        1
[INPUT] 0    0    [1    /1   ]  52.1131068005        1
[INPUT] 0    0    [1    /1   ]  4.60335544342        1
[INPUT] 0    0    [1    /1   ]  0.399017539104       1
[INPUT] 1    0    [1    /1   ]  1362.79265816        1
[INPUT] 1    0    [1    /1   ]  665.17545866         1
[INPUT] 1    0    [1    /1   ]  303.292266884        1
[INPUT] 1    0    [1    /1   ]  316.121455344        1
[INPUT] 1    0    [1    /1   ]  49.3737006498        1
[INPUT] 1    0    [1    /1   ]  5.8482762551         1
[INPUT] 1    0    [1    /1   ]  15.9221329055        1
[INPUT] 1    0    [1    /1   ]  0.694978356746       1
[INPUT] 1    0    [1    /1   ]  2.26467100222        1
[INPUT] 1    0    [1    /1   ]  0.20622960154        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.50838531676, 1.0]], [0, [7618.244845079727, 1.0]], [0, [3618.2388526941945, 1.0]], [0, [1618.0680270972514, 1.0]], [0, [239.76712075452693, 1.0]], [0, [52.113106800469986, 1.0]], [0, [4.603355443420901, 1.0]], [0, [0.3990175391041149, 1.0]], [1, [1362.7926581582253, 1.0]], [1, [665.175458659937, 1.0]], [1, [303.2922668841245, 1.0]], [1, [316.12145534373263, 1.0]], [1, [49.373700649826674, 1.0]], [1, [5.848276255101291, 1.0]], [1, [15.92213290546614, 1.0]], [1, [0.6949783567455069, 1.0]], [1, [2.264671002215422, 1.0]], [1, [0.20622960154011657, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50838532]
bas 1, expnt(s) = [7618.24484508]
bas 2, expnt(s) = [3618.23885269]
bas 3, expnt(s) = [1618.0680271]
bas 4, expnt(s) = [239.76712075]
bas 5, expnt(s) = [52.1131068]
bas 6, expnt(s) = [4.60335544]
bas 7, expnt(s) = [0.39901754]
bas 8, expnt(s) = [1362.79265816]
bas 9, expnt(s) = [665.17545866]
bas 10, expnt(s) = [303.29226688]
bas 11, expnt(s) = [316.12145534]
bas 12, expnt(s) = [49.37370065]
bas 13, expnt(s) = [5.84827626]
bas 14, expnt(s) = [15.92213291]
bas 15, expnt(s) = [0.69497836]
bas 16, expnt(s) = [2.264671]
bas 17, expnt(s) = [0.2062296]
CPU time:       191.69
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825084e+04 5.20024090e+03 7.61824485e+03 2.06018499e+03
 3.61823885e+03 1.17865838e+03 1.61806803e+03 6.44558896e+02
 2.39767121e+02 1.53942043e+02 5.21131068e+01 4.90032910e+01
 4.60335544e+00 7.94000739e+00 3.99017539e-01 1.26840812e+00
 1.36279266e+03 2.41558111e+04 6.65175459e+02 9.85495544e+03
 3.03292267e+02 3.69241974e+03 3.16121455e+02 3.88867688e+03
 4.93737006e+01 3.81815884e+02 5.84827626e+00 2.65319544e+01
 1.59221329e+01 9.27867469e+01 6.94978357e-01 1.85117933e+00
 2.26467100e+00 8.10477181e+00 2.06229602e-01 4.05436782e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97599388980298
cond(S) = 86219.38578221334
E1 = -727.5424551901259  E_coul = 203.1319856208813
init E= -524.410469569245
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.56002690038876  LUMO = 0.89801257507343
  mo_energy =
[-1.17868745e+02 -1.20936081e+01 -9.44372398e+00 -9.44372398e+00
 -9.44372398e+00 -1.23000645e+00 -5.60026900e-01 -5.60026900e-01
 -5.60026900e-01  8.98012575e-01  8.98012575e-01  8.98012575e-01
  5.73064777e+00  5.73064777e+00  5.73064777e+00  2.51828896e+01
  2.51828896e+01  2.51828896e+01  9.84229431e+01  9.84229431e+01
  9.84229431e+01  1.83489077e+02  4.29534177e+02  4.29534177e+02
  4.29534177e+02  1.28215588e+03  1.28215588e+03  1.28215588e+03
  1.91525308e+03  2.98359854e+03  2.98359854e+03  2.98359854e+03
  6.61209487e+03  6.61209487e+03  6.61209487e+03  8.27336796e+03
  2.46609514e+04  7.54572152e+04]
E1 = -727.2970145145242  E_coul = 201.756996676841
cycle= 1 E= -525.540017837683  delta_E= -1.13  |g|= 0.183  |ddm|= 0.584
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.454831
diis-c [-0.20687089  1.        ]
  HOMO = -0.575416639145292  LUMO = 0.891331908338676
  mo_energy =
[-1.18118136e+02 -1.21864925e+01 -9.53551538e+00 -9.53551538e+00
 -9.53551538e+00 -1.25420451e+00 -5.75416639e-01 -5.75416639e-01
 -5.75416639e-01  8.91331908e-01  8.91331908e-01  8.91331908e-01
  5.68703615e+00  5.68703615e+00  5.68703615e+00  2.50963443e+01
  2.50963443e+01  2.50963443e+01  9.82714100e+01  9.82714100e+01
  9.82714100e+01  1.83292082e+02  4.29298947e+02  4.29298947e+02
  4.29298947e+02  1.28187080e+03  1.28187080e+03  1.28187080e+03
  1.91484770e+03  2.98325245e+03  2.98325245e+03  2.98325245e+03
  6.61163364e+03  6.61163364e+03  6.61163364e+03  8.27282459e+03
  2.46603144e+04  7.54564870e+04]
E1 = -727.5179130200687  E_coul = 201.97769900008433
cycle= 2 E= -525.540214019984  delta_E= -0.000196  |g|= 0.0158  |ddm|= 0.0151
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0316195
diis-c [-7.74139296e-04  3.20292325e-02  9.67970767e-01]
  HOMO = -0.572519640351804  LUMO = 0.893226716090893
  mo_energy =
[-1.18086758e+02 -1.21709507e+01 -9.51974049e+00 -9.51974049e+00
 -9.51974049e+00 -1.25030698e+00 -5.72519640e-01 -5.72519640e-01
 -5.72519640e-01  8.93226716e-01  8.93226716e-01  8.93226716e-01
  5.69420135e+00  5.69420135e+00  5.69420135e+00  2.51107068e+01
  2.51107068e+01  2.51107068e+01  9.82947595e+01  9.82947595e+01
  9.82947595e+01  1.83322246e+02  4.29329865e+02  4.29329865e+02
  4.29329865e+02  1.28190392e+03  1.28190392e+03  1.28190392e+03
  1.91488224e+03  2.98328660e+03  2.98328660e+03  2.98328660e+03
  6.61166839e+03  6.61166839e+03  6.61166839e+03  8.27285957e+03
  2.46603494e+04  7.54565219e+04]
E1 = -727.4709778683356  E_coul = 201.93075702532698
cycle= 3 E= -525.540220843009  delta_E= -6.82e-06  |g|= 0.00227  |ddm|= 0.00404
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00467891
diis-c [-1.15820969e-07 -7.35958680e-04  1.24515262e-01  8.76220697e-01]
  HOMO = -0.57311262005305  LUMO = 0.892845019810665
  mo_energy =
[-1.18091113e+02 -1.21734254e+01 -9.52226180e+00 -9.52226180e+00
 -9.52226180e+00 -1.25108425e+00 -5.73112620e-01 -5.73112620e-01
 -5.73112620e-01  8.92845020e-01  8.92845020e-01  8.92845020e-01
  5.69288560e+00  5.69288560e+00  5.69288560e+00  2.51083906e+01
  2.51083906e+01  2.51083906e+01  9.82913496e+01  9.82913496e+01
  9.82913496e+01  1.83318083e+02  4.29325572e+02  4.29325572e+02
  4.29325572e+02  1.28189936e+03  1.28189936e+03  1.28189936e+03
  1.91487747e+03  2.98328190e+03  2.98328190e+03  2.98328190e+03
  6.61166356e+03  6.61166356e+03  6.61166356e+03  8.27285465e+03
  2.46603445e+04  7.54565169e+04]
E1 = -727.4781274355248  E_coul = 201.93790639061308
cycle= 4 E= -525.540221044912  delta_E= -2.02e-07  |g|= 4.21e-05  |ddm|= 0.000644
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.70117e-05
diis-c [-3.75548833e-10 -2.89537787e-05  4.50212789e-03  4.64883947e-02
  9.49038431e-01]
  HOMO = -0.573089186609221  LUMO = 0.892859746858282
  mo_energy =
[-1.18091018e+02 -1.21733465e+01 -9.52218201e+00 -9.52218201e+00
 -9.52218201e+00 -1.25105347e+00 -5.73089187e-01 -5.73089187e-01
 -5.73089187e-01  8.92859747e-01  8.92859747e-01  8.92859747e-01
  5.69293423e+00  5.69293423e+00  5.69293423e+00  2.51084642e+01
  2.51084642e+01  2.51084642e+01  9.82914373e+01  9.82914373e+01
  9.82914373e+01  1.83318177e+02  4.29325666e+02  4.29325666e+02
  4.29325666e+02  1.28189946e+03  1.28189946e+03  1.28189946e+03
  1.91487756e+03  2.98328200e+03  2.98328200e+03  2.98328200e+03
  6.61166365e+03  6.61166365e+03  6.61166365e+03  8.27285475e+03
  2.46603446e+04  7.54565170e+04]
E1 = -727.4779180301115  E_coul = 201.9376969850381
cycle= 5 E= -525.540221045073  delta_E= -1.62e-10  |g|= 2.36e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4779180301115  E_coul = 201.9376969850381
  HOMO = -0.573090644936198  LUMO = 0.892858816068157
  mo_energy =
[-1.18091024e+02 -1.21733510e+01 -9.52218662e+00 -9.52218662e+00
 -9.52218662e+00 -1.25105533e+00 -5.73090645e-01 -5.73090645e-01
 -5.73090645e-01  8.92858816e-01  8.92858816e-01  8.92858816e-01
  5.69293133e+00  5.69293133e+00  5.69293133e+00  2.51084599e+01
  2.51084599e+01  2.51084599e+01  9.82914319e+01  9.82914319e+01
  9.82914319e+01  1.83318172e+02  4.29325660e+02  4.29325660e+02
  4.29325660e+02  1.28189945e+03  1.28189945e+03  1.28189945e+03
  1.91487755e+03  2.98328199e+03  2.98328199e+03  2.98328199e+03
  6.61166364e+03  6.61166364e+03  6.61166364e+03  8.27285474e+03
  2.46603446e+04  7.54565170e+04]
E1 = -727.4779299521439  E_coul = 201.93770890707034
Extra cycle  E= -525.540221045074  delta_E= -1.14e-13  |g|= 5.79e-07  |ddm|= 1.14e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 86219.38578221334
E1 = -727.4779299521439  E_coul = 201.93770890707034
init E= -525.540221045074
    CPU time for initialize scf      0.95 sec, wall time      0.19 sec
  HOMO = -0.573090419599571  LUMO = 0.892858959218015
  mo_energy =
[-1.18091022e+02 -1.21733501e+01 -9.52218571e+00 -9.52218571e+00
 -9.52218571e+00 -1.25105503e+00 -5.73090420e-01 -5.73090420e-01
 -5.73090420e-01  8.92858959e-01  8.92858959e-01  8.92858959e-01
  5.69293183e+00  5.69293183e+00  5.69293183e+00  2.51084607e+01
  2.51084607e+01  2.51084607e+01  9.82914330e+01  9.82914330e+01
  9.82914330e+01  1.83318173e+02  4.29325661e+02  4.29325661e+02
  4.29325661e+02  1.28189945e+03  1.28189945e+03  1.28189945e+03
  1.91487755e+03  2.98328199e+03  2.98328199e+03  2.98328199e+03
  6.61166364e+03  6.61166364e+03  6.61166364e+03  8.27285474e+03
  2.46603446e+04  7.54565170e+04]
E1 = -727.4779274435373  E_coul = 201.93770639846304
cycle= 1 E= -525.540221045074  delta_E= -7.96e-13  |g|= 1.3e-07  |ddm|= 2.48e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4779274435373  E_coul = 201.93770639846304
  HOMO = -0.573090466446167  LUMO = 0.892858929177259
  mo_energy =
[-1.18091023e+02 -1.21733503e+01 -9.52218590e+00 -9.52218590e+00
 -9.52218590e+00 -1.25105509e+00 -5.73090466e-01 -5.73090466e-01
 -5.73090466e-01  8.92858929e-01  8.92858929e-01  8.92858929e-01
  5.69293172e+00  5.69293172e+00  5.69293172e+00  2.51084606e+01
  2.51084606e+01  2.51084606e+01  9.82914328e+01  9.82914328e+01
  9.82914328e+01  1.83318173e+02  4.29325661e+02  4.29325661e+02
  4.29325661e+02  1.28189945e+03  1.28189945e+03  1.28189945e+03
  1.91487755e+03  2.98328199e+03  2.98328199e+03  2.98328199e+03
  6.61166364e+03  6.61166364e+03  6.61166364e+03  8.27285474e+03
  2.46603446e+04  7.54565170e+04]
E1 = -727.4779279663813  E_coul = 201.93770692130707
Extra cycle  E= -525.540221045074  delta_E=    0  |g|= 2.79e-08  |ddm|= 4.85e-08
    CPU time for scf_cycle      1.05 sec, wall time      0.29 sec
exp = [2.61825084e+04 7.61824485e+03 3.61823885e+03 1.61806803e+03
 2.39767121e+02 5.21131068e+01 4.60335544e+00 3.99017539e-01
 1.36279266e+03 6.65175459e+02 3.03292267e+02 3.16121455e+02
 4.93737006e+01 5.84827626e+00 1.59221329e+01 6.94978357e-01
 2.26467100e+00 2.06229602e-01]
grad_E = [-1.98698431e-06  2.20043759e-05  4.41536692e-05  6.76956728e-04
  1.45776717e-04 -1.35108638e-03  5.02044361e-04  8.02107402e-04
  1.77585812e-06  2.30870987e-05  1.26927473e-04  1.11850724e-04
 -2.54341887e-03  3.55542134e-04  3.32519725e-04 -3.47741421e-03
  3.65113782e-04  4.14040143e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:10 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5083754        1
[INPUT] 0    0    [1    /1   ]  7618.24495483        1
[INPUT] 0    0    [1    /1   ]  3618.23907314        1
[INPUT] 0    0    [1    /1   ]  1618.07140323        1
[INPUT] 0    0    [1    /1   ]  239.767602753        1
[INPUT] 0    0    [1    /1   ]  52.1077985318        1
[INPUT] 0    0    [1    /1   ]  4.60294214575        1
[INPUT] 0    0    [1    /1   ]  0.398973123536       1
[INPUT] 1    0    [1    /1   ]  1362.79266313        1
[INPUT] 1    0    [1    /1   ]  665.175545955        1
[INPUT] 1    0    [1    /1   ]  303.292729906        1
[INPUT] 1    0    [1    /1   ]  316.121863266        1
[INPUT] 1    0    [1    /1   ]  49.3789365942        1
[INPUT] 1    0    [1    /1   ]  5.81341741756        1
[INPUT] 1    0    [1    /1   ]  15.8841711035        1
[INPUT] 1    0    [1    /1   ]  0.694460652329       1
[INPUT] 1    0    [1    /1   ]  2.24519953178        1
[INPUT] 1    0    [1    /1   ]  0.206011300927       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508375420763, 1.0]], [0, [7618.244954833998, 1.0]], [0, [3618.2390731437467, 1.0]], [0, [1618.0714032336386, 1.0]], [0, [239.76760275346192, 1.0]], [0, [52.10779853177603, 1.0]], [0, [4.60294214575492, 1.0]], [0, [0.3989731235361267, 1.0]], [1, [1362.7926631345824, 1.0]], [1, [665.1755459545586, 1.0]], [1, [303.29272990636764, 1.0]], [1, [316.1218632655849, 1.0]], [1, [49.37893659417359, 1.0]], [1, [5.813417417557711, 1.0]], [1, [15.884171103452676, 1.0]], [1, [0.6944606523294362, 1.0]], [1, [2.2451995317822178, 1.0]], [1, [0.20601130092747488, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50837542]
bas 1, expnt(s) = [7618.24495483]
bas 2, expnt(s) = [3618.23907314]
bas 3, expnt(s) = [1618.07140323]
bas 4, expnt(s) = [239.76760275]
bas 5, expnt(s) = [52.10779853]
bas 6, expnt(s) = [4.60294215]
bas 7, expnt(s) = [0.39897312]
bas 8, expnt(s) = [1362.79266313]
bas 9, expnt(s) = [665.17554595]
bas 10, expnt(s) = [303.29272991]
bas 11, expnt(s) = [316.12186327]
bas 12, expnt(s) = [49.37893659]
bas 13, expnt(s) = [5.81341742]
bas 14, expnt(s) = [15.8841711]
bas 15, expnt(s) = [0.69446065]
bas 16, expnt(s) = [2.24519953]
bas 17, expnt(s) = [0.2060113]
CPU time:       196.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825084e+04 5.20024090e+03 7.61824495e+03 2.06018501e+03
 3.61823907e+03 1.17865844e+03 1.61807140e+03 6.44559904e+02
 2.39767603e+02 1.53942275e+02 5.21077985e+01 4.89995474e+01
 4.60294215e+00 7.93947273e+00 3.98973124e-01 1.26830223e+00
 1.36279266e+03 2.41558112e+04 6.65175546e+02 9.85495705e+03
 3.03292730e+02 3.69242679e+03 3.16121863e+02 3.88868316e+03
 4.93789366e+01 3.81866498e+02 5.81341742e+00 2.63344212e+01
 1.58841711e+01 9.25102998e+01 6.94460652e-01 1.84945576e+00
 2.24519953e+00 8.01776035e+00 2.06011301e-01 4.04900393e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97602363371188
cond(S) = 86150.39295530309
E1 = -727.5412022033408  E_coul = 203.13048062229015
init E= -524.410721581051
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.560071196873274  LUMO = 0.896659027494488
  mo_energy =
[-1.17868966e+02 -1.20936803e+01 -9.44383554e+00 -9.44383554e+00
 -9.44383554e+00 -1.23000868e+00 -5.60071197e-01 -5.60071197e-01
 -5.60071197e-01  8.96659027e-01  8.96659027e-01  8.96659027e-01
  5.69080012e+00  5.69080012e+00  5.69080012e+00  2.50095689e+01
  2.50095689e+01  2.50095689e+01  9.81339061e+01  9.81339061e+01
  9.81339061e+01  1.83472625e+02  4.29278264e+02  4.29278264e+02
  4.29278264e+02  1.28193324e+03  1.28193324e+03  1.28193324e+03
  1.91523589e+03  2.98339413e+03  2.98339413e+03  2.98339413e+03
  6.61190980e+03  6.61190980e+03  6.61190980e+03  8.27335787e+03
  2.46609466e+04  7.54572132e+04]
E1 = -727.2934635868921  E_coul = 201.7534232914943
cycle= 1 E= -525.540040295398  delta_E= -1.13  |g|= 0.183  |ddm|= 0.587
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.454829
diis-c [-0.20686978  1.        ]
  HOMO = -0.575569858694482  LUMO = 0.889928031000133
  mo_energy =
[-1.18118601e+02 -1.21866305e+01 -9.53572371e+00 -9.53572371e+00
 -9.53572371e+00 -1.25431584e+00 -5.75569859e-01 -5.75569859e-01
 -5.75569859e-01  8.89928031e-01  8.89928031e-01  8.89928031e-01
  5.64732628e+00  5.64732628e+00  5.64732628e+00  2.49231087e+01
  2.49231087e+01  2.49231087e+01  9.79821889e+01  9.79821889e+01
  9.79821889e+01  1.83275430e+02  4.29042753e+02  4.29042753e+02
  4.29042753e+02  1.28164784e+03  1.28164784e+03  1.28164784e+03
  1.91483005e+03  2.98304764e+03  2.98304764e+03  2.98304764e+03
  6.61144809e+03  6.61144809e+03  6.61144809e+03  8.27281397e+03
  2.46603091e+04  7.54564844e+04]
E1 = -727.514734556001  E_coul = 201.97449709668487
cycle= 2 E= -525.540237459316  delta_E= -0.000197  |g|= 0.0159  |ddm|= 0.015
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0316431
diis-c [-7.75034956e-04  3.20705005e-02  9.67929500e-01]
  HOMO = -0.572673835026204  LUMO = 0.891817178567656
  mo_energy =
[-1.18087163e+02 -1.21710599e+01 -9.51991915e+00 -9.51991915e+00
 -9.51991915e+00 -1.25041792e+00 -5.72673835e-01 -5.72673835e-01
 -5.72673835e-01  8.91817179e-01  8.91817179e-01  8.91817179e-01
  5.65445745e+00  5.65445745e+00  5.65445745e+00  2.49374656e+01
  2.49374656e+01  2.49374656e+01  9.80055836e+01  9.80055836e+01
  9.80055836e+01  1.83305653e+02  4.29073734e+02  4.29073734e+02
  4.29073734e+02  1.28168102e+03  1.28168102e+03  1.28168102e+03
  1.91486466e+03  2.98308185e+03  2.98308185e+03  2.98308185e+03
  6.61148290e+03  6.61148290e+03  6.61148290e+03  8.27284901e+03
  2.46603441e+04  7.54565194e+04]
E1 = -727.467645692877  E_coul = 201.9274013745181
cycle= 3 E= -525.540244318359  delta_E= -6.86e-06  |g|= 0.00228  |ddm|= 0.00405
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00468339
diis-c [-1.18961220e-07 -7.36750359e-04  1.24528170e-01  8.76208580e-01]
  HOMO = -0.573269790039918  LUMO = 0.891434371413242
  mo_energy =
[-1.18091529e+02 -1.21735425e+01 -9.52244854e+00 -9.52244854e+00
 -9.52244854e+00 -1.25119882e+00 -5.73269790e-01 -5.73269790e-01
 -5.73269790e-01  8.91434371e-01  8.91434371e-01  8.91434371e-01
  5.65314268e+00  5.65314268e+00  5.65314268e+00  2.49351458e+01
  2.49351458e+01  2.49351458e+01  9.80021638e+01  9.80021638e+01
  9.80021638e+01  1.83301478e+02  4.29069428e+02  4.29069428e+02
  4.29069428e+02  1.28167645e+03  1.28167645e+03  1.28167645e+03
  1.91485987e+03  2.98307714e+03  2.98307714e+03  2.98307714e+03
  6.61147805e+03  6.61147805e+03  6.61147805e+03  8.27284408e+03
  2.46603392e+04  7.54565144e+04]
E1 = -727.4748250433806  E_coul = 201.93458052161625
cycle= 4 E= -525.540244521764  delta_E= -2.03e-07  |g|= 4.25e-05  |ddm|= 0.000645
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=7.77892e-05
diis-c [-3.80922254e-10 -2.86084064e-05  4.43588276e-03  4.61681823e-02
  9.49424543e-01]
  HOMO = -0.573246236235118  LUMO = 0.891449132806201
  mo_energy =
[-1.18091433e+02 -1.21734629e+01 -9.52236804e+00 -9.52236804e+00
 -9.52236804e+00 -1.25116786e+00 -5.73246236e-01 -5.73246236e-01
 -5.73246236e-01  8.91449133e-01  8.91449133e-01  8.91449133e-01
  5.65319143e+00  5.65319143e+00  5.65319143e+00  2.49352200e+01
  2.49352200e+01  2.49352200e+01  9.80022522e+01  9.80022522e+01
  9.80022522e+01  1.83301573e+02  4.29069523e+02  4.29069523e+02
  4.29069523e+02  1.28167655e+03  1.28167655e+03  1.28167655e+03
  1.91485996e+03  2.98307724e+03  2.98307724e+03  2.98307724e+03
  6.61147814e+03  6.61147814e+03  6.61147814e+03  8.27284418e+03
  2.46603393e+04  7.54565144e+04]
E1 = -727.4746131313243  E_coul = 201.9343686093953
cycle= 5 E= -525.540244521929  delta_E= -1.65e-10  |g|= 2.41e-06  |ddm|= 2.36e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.4746131313243  E_coul = 201.9343686093953
  HOMO = -0.573247734299513  LUMO = 0.891448177712285
  mo_energy =
[-1.18091439e+02 -1.21734675e+01 -9.52237274e+00 -9.52237274e+00
 -9.52237274e+00 -1.25116977e+00 -5.73247734e-01 -5.73247734e-01
 -5.73247734e-01  8.91448178e-01  8.91448178e-01  8.91448178e-01
  5.65318847e+00  5.65318847e+00  5.65318847e+00  2.49352156e+01
  2.49352156e+01  2.49352156e+01  9.80022468e+01  9.80022468e+01
  9.80022468e+01  1.83301567e+02  4.29069517e+02  4.29069517e+02
  4.29069517e+02  1.28167654e+03  1.28167654e+03  1.28167654e+03
  1.91485996e+03  2.98307723e+03  2.98307723e+03  2.98307723e+03
  6.61147814e+03  6.61147814e+03  6.61147814e+03  8.27284417e+03
  2.46603392e+04  7.54565144e+04]
E1 = -727.4746252814135  E_coul = 201.93438075948382
Extra cycle  E= -525.54024452193  delta_E= -6.82e-13  |g|= 5.89e-07  |ddm|= 1.15e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.22 sec
exp = [2.61825084e+04 7.61824495e+03 3.61823907e+03 1.61807140e+03
 2.39767603e+02 5.21077985e+01 4.60294215e+00 3.98973124e-01
 1.36279266e+03 6.65175546e+02 3.03292730e+02 3.16121863e+02
 4.93789366e+01 5.81341742e+00 1.58841711e+01 6.94460652e-01
 2.24519953e+00 2.06011301e-01]
E = -525.5402445219297
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5083754        1
[INPUT] 0    0    [1    /1   ]  7618.24495483        1
[INPUT] 0    0    [1    /1   ]  3618.23907314        1
[INPUT] 0    0    [1    /1   ]  1618.07140323        1
[INPUT] 0    0    [1    /1   ]  239.767602753        1
[INPUT] 0    0    [1    /1   ]  52.1077985318        1
[INPUT] 0    0    [1    /1   ]  4.60294214575        1
[INPUT] 0    0    [1    /1   ]  0.398973123536       1
[INPUT] 1    0    [1    /1   ]  1362.79266313        1
[INPUT] 1    0    [1    /1   ]  665.175545955        1
[INPUT] 1    0    [1    /1   ]  303.292729906        1
[INPUT] 1    0    [1    /1   ]  316.121863266        1
[INPUT] 1    0    [1    /1   ]  49.3789365942        1
[INPUT] 1    0    [1    /1   ]  5.81341741756        1
[INPUT] 1    0    [1    /1   ]  15.8841711035        1
[INPUT] 1    0    [1    /1   ]  0.694460652329       1
[INPUT] 1    0    [1    /1   ]  2.24519953178        1
[INPUT] 1    0    [1    /1   ]  0.206011300927       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508375420763, 1.0]], [0, [7618.244954833998, 1.0]], [0, [3618.2390731437467, 1.0]], [0, [1618.0714032336386, 1.0]], [0, [239.76760275346192, 1.0]], [0, [52.10779853177603, 1.0]], [0, [4.60294214575492, 1.0]], [0, [0.3989731235361267, 1.0]], [1, [1362.7926631345824, 1.0]], [1, [665.1755459545586, 1.0]], [1, [303.29272990636764, 1.0]], [1, [316.1218632655849, 1.0]], [1, [49.37893659417359, 1.0]], [1, [5.813417417557711, 1.0]], [1, [15.884171103452676, 1.0]], [1, [0.6944606523294362, 1.0]], [1, [2.2451995317822178, 1.0]], [1, [0.20601130092747488, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50837542]
bas 1, expnt(s) = [7618.24495483]
bas 2, expnt(s) = [3618.23907314]
bas 3, expnt(s) = [1618.07140323]
bas 4, expnt(s) = [239.76760275]
bas 5, expnt(s) = [52.10779853]
bas 6, expnt(s) = [4.60294215]
bas 7, expnt(s) = [0.39897312]
bas 8, expnt(s) = [1362.79266313]
bas 9, expnt(s) = [665.17554595]
bas 10, expnt(s) = [303.29272991]
bas 11, expnt(s) = [316.12186327]
bas 12, expnt(s) = [49.37893659]
bas 13, expnt(s) = [5.81341742]
bas 14, expnt(s) = [15.8841711]
bas 15, expnt(s) = [0.69446065]
bas 16, expnt(s) = [2.24519953]
bas 17, expnt(s) = [0.2060113]
CPU time:       197.91
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825084e+04 5.20024090e+03 7.61824495e+03 2.06018501e+03
 3.61823907e+03 1.17865844e+03 1.61807140e+03 6.44559904e+02
 2.39767603e+02 1.53942275e+02 5.21077985e+01 4.89995474e+01
 4.60294215e+00 7.93947273e+00 3.98973124e-01 1.26830223e+00
 1.36279266e+03 2.41558112e+04 6.65175546e+02 9.85495705e+03
 3.03292730e+02 3.69242679e+03 3.16121863e+02 3.88868316e+03
 4.93789366e+01 3.81866498e+02 5.81341742e+00 2.63344212e+01
 1.58841711e+01 9.25102998e+01 6.94460652e-01 1.84945576e+00
 2.24519953e+00 8.01776035e+00 2.06011301e-01 4.04900393e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97602363371188
cond(S) = 86150.39295530309
E1 = -727.5412022033408  E_coul = 203.13048062229015
init E= -524.410721581051
    CPU time for initialize scf      0.69 sec, wall time      0.08 sec
  HOMO = -0.560071196873274  LUMO = 0.896659027494488
  mo_energy =
[-1.17868966e+02 -1.20936803e+01 -9.44383554e+00 -9.44383554e+00
 -9.44383554e+00 -1.23000868e+00 -5.60071197e-01 -5.60071197e-01
 -5.60071197e-01  8.96659027e-01  8.96659027e-01  8.96659027e-01
  5.69080012e+00  5.69080012e+00  5.69080012e+00  2.50095689e+01
  2.50095689e+01  2.50095689e+01  9.81339061e+01  9.81339061e+01
  9.81339061e+01  1.83472625e+02  4.29278264e+02  4.29278264e+02
  4.29278264e+02  1.28193324e+03  1.28193324e+03  1.28193324e+03
  1.91523589e+03  2.98339413e+03  2.98339413e+03  2.98339413e+03
  6.61190980e+03  6.61190980e+03  6.61190980e+03  8.27335787e+03
  2.46609466e+04  7.54572132e+04]
E1 = -727.2934635868921  E_coul = 201.7534232914943
cycle= 1 E= -525.540040295398  delta_E= -1.13  |g|= 0.183  |ddm|= 0.587
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.454829
diis-c [-0.20686978  1.        ]
  HOMO = -0.575569858694482  LUMO = 0.889928031000133
  mo_energy =
[-1.18118601e+02 -1.21866305e+01 -9.53572371e+00 -9.53572371e+00
 -9.53572371e+00 -1.25431584e+00 -5.75569859e-01 -5.75569859e-01
 -5.75569859e-01  8.89928031e-01  8.89928031e-01  8.89928031e-01
  5.64732628e+00  5.64732628e+00  5.64732628e+00  2.49231087e+01
  2.49231087e+01  2.49231087e+01  9.79821889e+01  9.79821889e+01
  9.79821889e+01  1.83275430e+02  4.29042753e+02  4.29042753e+02
  4.29042753e+02  1.28164784e+03  1.28164784e+03  1.28164784e+03
  1.91483005e+03  2.98304764e+03  2.98304764e+03  2.98304764e+03
  6.61144809e+03  6.61144809e+03  6.61144809e+03  8.27281397e+03
  2.46603091e+04  7.54564844e+04]
E1 = -727.514734556001  E_coul = 201.97449709668487
cycle= 2 E= -525.540237459316  delta_E= -0.000197  |g|= 0.0159  |ddm|= 0.015
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0316431
diis-c [-7.75034956e-04  3.20705005e-02  9.67929500e-01]
  HOMO = -0.572673835026204  LUMO = 0.891817178567656
  mo_energy =
[-1.18087163e+02 -1.21710599e+01 -9.51991915e+00 -9.51991915e+00
 -9.51991915e+00 -1.25041792e+00 -5.72673835e-01 -5.72673835e-01
 -5.72673835e-01  8.91817179e-01  8.91817179e-01  8.91817179e-01
  5.65445745e+00  5.65445745e+00  5.65445745e+00  2.49374656e+01
  2.49374656e+01  2.49374656e+01  9.80055836e+01  9.80055836e+01
  9.80055836e+01  1.83305653e+02  4.29073734e+02  4.29073734e+02
  4.29073734e+02  1.28168102e+03  1.28168102e+03  1.28168102e+03
  1.91486466e+03  2.98308185e+03  2.98308185e+03  2.98308185e+03
  6.61148290e+03  6.61148290e+03  6.61148290e+03  8.27284901e+03
  2.46603441e+04  7.54565194e+04]
E1 = -727.467645692877  E_coul = 201.9274013745181
cycle= 3 E= -525.540244318359  delta_E= -6.86e-06  |g|= 0.00228  |ddm|= 0.00405
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00468339
diis-c [-1.18961220e-07 -7.36750359e-04  1.24528170e-01  8.76208580e-01]
  HOMO = -0.573269790039918  LUMO = 0.891434371413242
  mo_energy =
[-1.18091529e+02 -1.21735425e+01 -9.52244854e+00 -9.52244854e+00
 -9.52244854e+00 -1.25119882e+00 -5.73269790e-01 -5.73269790e-01
 -5.73269790e-01  8.91434371e-01  8.91434371e-01  8.91434371e-01
  5.65314268e+00  5.65314268e+00  5.65314268e+00  2.49351458e+01
  2.49351458e+01  2.49351458e+01  9.80021638e+01  9.80021638e+01
  9.80021638e+01  1.83301478e+02  4.29069428e+02  4.29069428e+02
  4.29069428e+02  1.28167645e+03  1.28167645e+03  1.28167645e+03
  1.91485987e+03  2.98307714e+03  2.98307714e+03  2.98307714e+03
  6.61147805e+03  6.61147805e+03  6.61147805e+03  8.27284408e+03
  2.46603392e+04  7.54565144e+04]
E1 = -727.4748250433806  E_coul = 201.93458052161625
cycle= 4 E= -525.540244521764  delta_E= -2.03e-07  |g|= 4.25e-05  |ddm|= 0.000645
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=7.77892e-05
diis-c [-3.80922254e-10 -2.86084064e-05  4.43588276e-03  4.61681823e-02
  9.49424543e-01]
  HOMO = -0.573246236235118  LUMO = 0.891449132806201
  mo_energy =
[-1.18091433e+02 -1.21734629e+01 -9.52236804e+00 -9.52236804e+00
 -9.52236804e+00 -1.25116786e+00 -5.73246236e-01 -5.73246236e-01
 -5.73246236e-01  8.91449133e-01  8.91449133e-01  8.91449133e-01
  5.65319143e+00  5.65319143e+00  5.65319143e+00  2.49352200e+01
  2.49352200e+01  2.49352200e+01  9.80022522e+01  9.80022522e+01
  9.80022522e+01  1.83301573e+02  4.29069523e+02  4.29069523e+02
  4.29069523e+02  1.28167655e+03  1.28167655e+03  1.28167655e+03
  1.91485996e+03  2.98307724e+03  2.98307724e+03  2.98307724e+03
  6.61147814e+03  6.61147814e+03  6.61147814e+03  8.27284418e+03
  2.46603393e+04  7.54565144e+04]
E1 = -727.4746131313243  E_coul = 201.9343686093953
cycle= 5 E= -525.540244521929  delta_E= -1.65e-10  |g|= 2.41e-06  |ddm|= 2.36e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.4746131313243  E_coul = 201.9343686093953
  HOMO = -0.573247734299513  LUMO = 0.891448177712285
  mo_energy =
[-1.18091439e+02 -1.21734675e+01 -9.52237274e+00 -9.52237274e+00
 -9.52237274e+00 -1.25116977e+00 -5.73247734e-01 -5.73247734e-01
 -5.73247734e-01  8.91448178e-01  8.91448178e-01  8.91448178e-01
  5.65318847e+00  5.65318847e+00  5.65318847e+00  2.49352156e+01
  2.49352156e+01  2.49352156e+01  9.80022468e+01  9.80022468e+01
  9.80022468e+01  1.83301567e+02  4.29069517e+02  4.29069517e+02
  4.29069517e+02  1.28167654e+03  1.28167654e+03  1.28167654e+03
  1.91485996e+03  2.98307723e+03  2.98307723e+03  2.98307723e+03
  6.61147814e+03  6.61147814e+03  6.61147814e+03  8.27284417e+03
  2.46603392e+04  7.54565144e+04]
E1 = -727.4746252814135  E_coul = 201.93438075948382
Extra cycle  E= -525.54024452193  delta_E= -6.82e-13  |g|= 5.89e-07  |ddm|= 1.15e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.21 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 86150.39295530309
E1 = -727.4746252814135  E_coul = 201.93438075948382
init E= -525.54024452193
    CPU time for initialize scf      1.80 sec, wall time      0.22 sec
  HOMO = -0.573247504913239  LUMO = 0.891448323025354
  mo_energy =
[-1.18091438e+02 -1.21734666e+01 -9.52237182e+00 -9.52237182e+00
 -9.52237182e+00 -1.25116947e+00 -5.73247505e-01 -5.73247505e-01
 -5.73247505e-01  8.91448323e-01  8.91448323e-01  8.91448323e-01
  5.65318897e+00  5.65318897e+00  5.65318897e+00  2.49352165e+01
  2.49352165e+01  2.49352165e+01  9.80022479e+01  9.80022479e+01
  9.80022479e+01  1.83301569e+02  4.29069519e+02  4.29069519e+02
  4.29069519e+02  1.28167654e+03  1.28167654e+03  1.28167654e+03
  1.91485996e+03  2.98307723e+03  2.98307723e+03  2.98307723e+03
  6.61147814e+03  6.61147814e+03  6.61147814e+03  8.27284417e+03
  2.46603392e+04  7.54565144e+04]
E1 = -727.4746227185116  E_coul = 201.93437819658064
cycle= 1 E= -525.540244521931  delta_E= -1.25e-12  |g|= 1.33e-07  |ddm|= 2.54e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4746227185116  E_coul = 201.93437819658064
  HOMO = -0.57324755286485  LUMO = 0.891448292339371
  mo_energy =
[-1.18091438e+02 -1.21734668e+01 -9.52237201e+00 -9.52237201e+00
 -9.52237201e+00 -1.25116953e+00 -5.73247553e-01 -5.73247553e-01
 -5.73247553e-01  8.91448292e-01  8.91448292e-01  8.91448292e-01
  5.65318887e+00  5.65318887e+00  5.65318887e+00  2.49352163e+01
  2.49352163e+01  2.49352163e+01  9.80022477e+01  9.80022477e+01
  9.80022477e+01  1.83301568e+02  4.29069518e+02  4.29069518e+02
  4.29069518e+02  1.28167654e+03  1.28167654e+03  1.28167654e+03
  1.91485996e+03  2.98307723e+03  2.98307723e+03  2.98307723e+03
  6.61147814e+03  6.61147814e+03  6.61147814e+03  8.27284417e+03
  2.46603392e+04  7.54565144e+04]
E1 = -727.4746232531083  E_coul = 201.93437873117747
Extra cycle  E= -525.540244521931  delta_E= 1.14e-13  |g|= 2.85e-08  |ddm|= 4.94e-08
    CPU time for scf_cycle      1.89 sec, wall time      0.31 sec
exp = [2.61825084e+04 7.61824495e+03 3.61823907e+03 1.61807140e+03
 2.39767603e+02 5.21077985e+01 4.60294215e+00 3.98973124e-01
 1.36279266e+03 6.65175546e+02 3.03292730e+02 3.16121863e+02
 4.93789366e+01 5.81341742e+00 1.58841711e+01 6.94460652e-01
 2.24519953e+00 2.06011301e-01]
grad_E = [-1.98695458e-06  2.19972280e-05  4.41320484e-05  6.76684598e-04
  1.65505646e-04 -1.49289969e-03  1.22973418e-04  1.69034772e-04
  1.75997701e-06  2.29776665e-05  1.26273342e-04  1.11271295e-04
 -2.50961268e-03 -5.39460569e-04  4.95049154e-04  1.04702600e-03
  4.59563186e-04 -3.22078493e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5083693        1
[INPUT] 0    0    [1    /1   ]  7618.2450231         1
[INPUT] 0    0    [1    /1   ]  3618.23921043        1
[INPUT] 0    0    [1    /1   ]  1618.07350391        1
[INPUT] 0    0    [1    /1   ]  239.7674917          1
[INPUT] 0    0    [1    /1   ]  52.1073874839        1
[INPUT] 0    0    [1    /1   ]  4.60270297422        1
[INPUT] 0    0    [1    /1   ]  0.39893517277        1
[INPUT] 1    0    [1    /1   ]  1362.79266566        1
[INPUT] 1    0    [1    /1   ]  665.175596088        1
[INPUT] 1    0    [1    /1   ]  303.292992506        1
[INPUT] 1    0    [1    /1   ]  316.122094606        1
[INPUT] 1    0    [1    /1   ]  49.3849912904        1
[INPUT] 1    0    [1    /1   ]  5.79173176765        1
[INPUT] 1    0    [1    /1   ]  15.8517944174        1
[INPUT] 1    0    [1    /1   ]  0.694368205515       1
[INPUT] 1    0    [1    /1   ]  2.23410795451        1
[INPUT] 1    0    [1    /1   ]  0.206213515881       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.50836928019, 1.0]], [0, [7618.245023096185, 1.0]], [0, [3618.239210431368, 1.0]], [0, [1618.073503907204, 1.0]], [0, [239.7674916996759, 1.0]], [0, [52.10738748390042, 1.0]], [0, [4.602702974216934, 1.0]], [0, [0.39893517276972185, 1.0]], [1, [1362.7926656606655, 1.0]], [1, [665.1755960884393, 1.0]], [1, [303.29299250646835, 1.0]], [1, [316.1220946058856, 1.0]], [1, [49.38499129041513, 1.0]], [1, [5.791731767653681, 1.0]], [1, [15.85179441737523, 1.0]], [1, [0.6943682055152172, 1.0]], [1, [2.2341079545063285, 1.0]], [1, [0.20621351588116818, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50836928]
bas 1, expnt(s) = [7618.2450231]
bas 2, expnt(s) = [3618.23921043]
bas 3, expnt(s) = [1618.07350391]
bas 4, expnt(s) = [239.7674917]
bas 5, expnt(s) = [52.10738748]
bas 6, expnt(s) = [4.60270297]
bas 7, expnt(s) = [0.39893517]
bas 8, expnt(s) = [1362.79266566]
bas 9, expnt(s) = [665.17559609]
bas 10, expnt(s) = [303.29299251]
bas 11, expnt(s) = [316.12209461]
bas 12, expnt(s) = [49.38499129]
bas 13, expnt(s) = [5.79173177]
bas 14, expnt(s) = [15.85179442]
bas 15, expnt(s) = [0.69436821]
bas 16, expnt(s) = [2.23410795]
bas 17, expnt(s) = [0.20621352]
CPU time:       204.68
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825084e+04 5.20024090e+03 7.61824502e+03 2.06018503e+03
 3.61823921e+03 1.17865847e+03 1.61807350e+03 6.44560532e+02
 2.39767492e+02 1.53942221e+02 5.21073875e+01 4.89992575e+01
 4.60270297e+00 7.93916333e+00 3.98935173e-01 1.26821174e+00
 1.36279267e+03 2.41558112e+04 6.65175596e+02 9.85495798e+03
 3.03292993e+02 3.69243078e+03 3.16122095e+02 3.88868671e+03
 4.93849913e+01 3.81925028e+02 5.79173177e+00 2.62116852e+01
 1.58517944e+01 9.22746553e+01 6.94368206e-01 1.84914802e+00
 2.23410795e+00 7.96827999e+00 2.06213516e-01 4.05397253e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.976022979175728
cond(S) = 86104.55858600151
E1 = -727.5402575450983  E_coul = 203.1295285919567
init E= -524.410728953142
    CPU time for initialize scf      0.69 sec, wall time      0.08 sec
  HOMO = -0.560092229221874  LUMO = 0.897264906307067
  mo_energy =
[-1.17869072e+02 -1.20937560e+01 -9.44391386e+00 -9.44391386e+00
 -9.44391386e+00 -1.23001294e+00 -5.60092229e-01 -5.60092229e-01
 -5.60092229e-01  8.97264906e-01  8.97264906e-01  8.97264906e-01
  5.66997163e+00  5.66997163e+00  5.66997163e+00  2.49020778e+01
  2.49020778e+01  2.49020778e+01  9.79376757e+01  9.79376757e+01
  9.79376757e+01  1.83470200e+02  4.29102994e+02  4.29102994e+02
  4.29102994e+02  1.28178145e+03  1.28178145e+03  1.28178145e+03
  1.91523438e+03  2.98325491e+03  2.98325491e+03  2.98325491e+03
  6.61178374e+03  6.61178374e+03  6.61178374e+03  8.27335985e+03
  2.46609514e+04  7.54572191e+04]
E1 = -727.2955248407519  E_coul = 201.75546579346678
cycle= 1 E= -525.540059047285  delta_E= -1.13  |g|= 0.183  |ddm|= 0.579
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.454777
diis-c [-0.20682198  1.        ]
  HOMO = -0.575511312531601  LUMO = 0.890587680170392
  mo_energy =
[-1.18118499e+02 -1.21864632e+01 -9.53556925e+00 -9.53556925e+00
 -9.53556925e+00 -1.25421188e+00 -5.75511313e-01 -5.75511313e-01
 -5.75511313e-01  8.90587680e-01  8.90587680e-01  8.90587680e-01
  5.62680524e+00  5.62680524e+00  5.62680524e+00  2.48159710e+01
  2.48159710e+01  2.48159710e+01  9.77861770e+01  9.77861770e+01
  9.77861770e+01  1.83273237e+02  4.28867672e+02  4.28867672e+02
  4.28867672e+02  1.28149624e+03  1.28149624e+03  1.28149624e+03
  1.91482872e+03  2.98290860e+03  2.98290860e+03  2.98290860e+03
  6.61132220e+03  6.61132220e+03  6.61132220e+03  8.27281610e+03
  2.46603140e+04  7.54564905e+04]
E1 = -727.5162353424879  E_coul = 201.97597949465455
cycle= 2 E= -525.540255847833  delta_E= -0.000197  |g|= 0.0159  |ddm|= 0.015
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0315829
diis-c [-7.72604519e-04  3.19794212e-02  9.68020579e-01]
  HOMO = -0.572628718798766  LUMO = 0.892467257968879
  mo_energy =
[-1.18087109e+02 -1.21709311e+01 -9.51980367e+00 -9.51980367e+00
 -9.51980367e+00 -1.25033144e+00 -5.72628719e-01 -5.72628719e-01
 -5.72628719e-01  8.92467258e-01  8.92467258e-01  8.92467258e-01
  5.63388681e+00  5.63388681e+00  5.63388681e+00  2.48302694e+01
  2.48302694e+01  2.48302694e+01  9.78095280e+01  9.78095280e+01
  9.78095280e+01  1.83303412e+02  4.28898606e+02  4.28898606e+02
  4.28898606e+02  1.28152937e+03  1.28152937e+03  1.28152937e+03
  1.91486328e+03  2.98294277e+03  2.98294277e+03  2.98294277e+03
  6.61135696e+03  6.61135696e+03  6.61135696e+03  8.27285110e+03
  2.46603490e+04  7.54565255e+04]
E1 = -727.4692509377822  E_coul = 201.92898825828178
cycle= 3 E= -525.540262679501  delta_E= -6.83e-06  |g|= 0.00227  |ddm|= 0.00403
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00467439
diis-c [-1.19552443e-07 -7.36478177e-04  1.24520944e-01  8.76215534e-01]
  HOMO = -0.573223563719345  LUMO = 0.89208530675206
  mo_energy =
[-1.18091469e+02 -1.21734098e+01 -9.52232906e+00 -9.52232906e+00
 -9.52232906e+00 -1.25111081e+00 -5.73223564e-01 -5.73223564e-01
 -5.73223564e-01  8.92085307e-01  8.92085307e-01  8.92085307e-01
  5.63257815e+00  5.63257815e+00  5.63257815e+00  2.48279562e+01
  2.48279562e+01  2.48279562e+01  9.78061130e+01  9.78061130e+01
  9.78061130e+01  1.83299243e+02  4.28894306e+02  4.28894306e+02
  4.28894306e+02  1.28152481e+03  1.28152481e+03  1.28152481e+03
  1.91485849e+03  2.98293806e+03  2.98293806e+03  2.98293806e+03
  6.61135212e+03  6.61135212e+03  6.61135212e+03  8.27284618e+03
  2.46603441e+04  7.54565204e+04]
E1 = -727.4764184623394  E_coul = 201.93615558006337
cycle= 4 E= -525.540262882276  delta_E= -2.03e-07  |g|= 4.26e-05  |ddm|= 0.000643
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=7.79316e-05
diis-c [-3.81872230e-10 -2.86103991e-05  4.43790989e-03  4.62381962e-02
  9.49352504e-01]
  HOMO = -0.573199993732244  LUMO = 0.892100069406088
  mo_energy =
[-1.18091373e+02 -1.21733300e+01 -9.52224842e+00 -9.52224842e+00
 -9.52224842e+00 -1.25107982e+00 -5.73199994e-01 -5.73199994e-01
 -5.73199994e-01  8.92100069e-01  8.92100069e-01  8.92100069e-01
  5.63262683e+00  5.63262683e+00  5.63262683e+00  2.48280304e+01
  2.48280304e+01  2.48280304e+01  9.78062016e+01  9.78062016e+01
  9.78062016e+01  1.83299339e+02  4.28894401e+02  4.28894401e+02
  4.28894401e+02  1.28152490e+03  1.28152490e+03  1.28152490e+03
  1.91485859e+03  2.98293816e+03  2.98293816e+03  2.98293816e+03
  6.61135222e+03  6.61135222e+03  6.61135222e+03  8.27284627e+03
  2.46603442e+04  7.54565205e+04]
E1 = -727.4762061548557  E_coul = 201.93594327241223
cycle= 5 E= -525.540262882443  delta_E= -1.67e-10  |g|= 2.41e-06  |ddm|= 2.36e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.4762061548557  E_coul = 201.93594327241223
  HOMO = -0.573201495954431  LUMO = 0.892099111772509
  mo_energy =
[-1.18091380e+02 -1.21733347e+01 -9.52225312e+00 -9.52225312e+00
 -9.52225312e+00 -1.25108174e+00 -5.73201496e-01 -5.73201496e-01
 -5.73201496e-01  8.92099112e-01  8.92099112e-01  8.92099112e-01
  5.63262388e+00  5.63262388e+00  5.63262388e+00  2.48280260e+01
  2.48280260e+01  2.48280260e+01  9.78061961e+01  9.78061961e+01
  9.78061961e+01  1.83299333e+02  4.28894395e+02  4.28894395e+02
  4.28894395e+02  1.28152490e+03  1.28152490e+03  1.28152490e+03
  1.91485858e+03  2.98293815e+03  2.98293815e+03  2.98293815e+03
  6.61135221e+03  6.61135221e+03  6.61135221e+03  8.27284626e+03
  2.46603442e+04  7.54565205e+04]
E1 = -727.476218312622  E_coul = 201.9359554301785
Extra cycle  E= -525.540262882443  delta_E=    0  |g|= 5.9e-07  |ddm|= 1.15e-06
    CPU time for scf_cycle      0.84 sec, wall time      0.22 sec
exp = [2.61825084e+04 7.61824502e+03 3.61823921e+03 1.61807350e+03
 2.39767492e+02 5.21073875e+01 4.60270297e+00 3.98935173e-01
 1.36279267e+03 6.65175596e+02 3.03292993e+02 3.16122095e+02
 4.93849913e+01 5.79173177e+00 1.58517944e+01 6.94368206e-01
 2.23410795e+00 2.06213516e-01]
E = -525.5402628824435
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5083693        1
[INPUT] 0    0    [1    /1   ]  7618.2450231         1
[INPUT] 0    0    [1    /1   ]  3618.23921043        1
[INPUT] 0    0    [1    /1   ]  1618.07350391        1
[INPUT] 0    0    [1    /1   ]  239.7674917          1
[INPUT] 0    0    [1    /1   ]  52.1073874839        1
[INPUT] 0    0    [1    /1   ]  4.60270297422        1
[INPUT] 0    0    [1    /1   ]  0.39893517277        1
[INPUT] 1    0    [1    /1   ]  1362.79266566        1
[INPUT] 1    0    [1    /1   ]  665.175596088        1
[INPUT] 1    0    [1    /1   ]  303.292992506        1
[INPUT] 1    0    [1    /1   ]  316.122094606        1
[INPUT] 1    0    [1    /1   ]  49.3849912904        1
[INPUT] 1    0    [1    /1   ]  5.79173176765        1
[INPUT] 1    0    [1    /1   ]  15.8517944174        1
[INPUT] 1    0    [1    /1   ]  0.694368205515       1
[INPUT] 1    0    [1    /1   ]  2.23410795451        1
[INPUT] 1    0    [1    /1   ]  0.206213515881       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.50836928019, 1.0]], [0, [7618.245023096185, 1.0]], [0, [3618.239210431368, 1.0]], [0, [1618.073503907204, 1.0]], [0, [239.7674916996759, 1.0]], [0, [52.10738748390042, 1.0]], [0, [4.602702974216934, 1.0]], [0, [0.39893517276972185, 1.0]], [1, [1362.7926656606655, 1.0]], [1, [665.1755960884393, 1.0]], [1, [303.29299250646835, 1.0]], [1, [316.1220946058856, 1.0]], [1, [49.38499129041513, 1.0]], [1, [5.791731767653681, 1.0]], [1, [15.85179441737523, 1.0]], [1, [0.6943682055152172, 1.0]], [1, [2.2341079545063285, 1.0]], [1, [0.20621351588116818, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50836928]
bas 1, expnt(s) = [7618.2450231]
bas 2, expnt(s) = [3618.23921043]
bas 3, expnt(s) = [1618.07350391]
bas 4, expnt(s) = [239.7674917]
bas 5, expnt(s) = [52.10738748]
bas 6, expnt(s) = [4.60270297]
bas 7, expnt(s) = [0.39893517]
bas 8, expnt(s) = [1362.79266566]
bas 9, expnt(s) = [665.17559609]
bas 10, expnt(s) = [303.29299251]
bas 11, expnt(s) = [316.12209461]
bas 12, expnt(s) = [49.38499129]
bas 13, expnt(s) = [5.79173177]
bas 14, expnt(s) = [15.85179442]
bas 15, expnt(s) = [0.69436821]
bas 16, expnt(s) = [2.23410795]
bas 17, expnt(s) = [0.20621352]
CPU time:       205.65
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825084e+04 5.20024090e+03 7.61824502e+03 2.06018503e+03
 3.61823921e+03 1.17865847e+03 1.61807350e+03 6.44560532e+02
 2.39767492e+02 1.53942221e+02 5.21073875e+01 4.89992575e+01
 4.60270297e+00 7.93916333e+00 3.98935173e-01 1.26821174e+00
 1.36279267e+03 2.41558112e+04 6.65175596e+02 9.85495798e+03
 3.03292993e+02 3.69243078e+03 3.16122095e+02 3.88868671e+03
 4.93849913e+01 3.81925028e+02 5.79173177e+00 2.62116852e+01
 1.58517944e+01 9.22746553e+01 6.94368206e-01 1.84914802e+00
 2.23410795e+00 7.96827999e+00 2.06213516e-01 4.05397253e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.976022979175728
cond(S) = 86104.55858600151
E1 = -727.5402575450983  E_coul = 203.1295285919567
init E= -524.410728953142
    CPU time for initialize scf      0.67 sec, wall time      0.08 sec
  HOMO = -0.560092229221874  LUMO = 0.897264906307067
  mo_energy =
[-1.17869072e+02 -1.20937560e+01 -9.44391386e+00 -9.44391386e+00
 -9.44391386e+00 -1.23001294e+00 -5.60092229e-01 -5.60092229e-01
 -5.60092229e-01  8.97264906e-01  8.97264906e-01  8.97264906e-01
  5.66997163e+00  5.66997163e+00  5.66997163e+00  2.49020778e+01
  2.49020778e+01  2.49020778e+01  9.79376757e+01  9.79376757e+01
  9.79376757e+01  1.83470200e+02  4.29102994e+02  4.29102994e+02
  4.29102994e+02  1.28178145e+03  1.28178145e+03  1.28178145e+03
  1.91523438e+03  2.98325491e+03  2.98325491e+03  2.98325491e+03
  6.61178374e+03  6.61178374e+03  6.61178374e+03  8.27335985e+03
  2.46609514e+04  7.54572191e+04]
E1 = -727.2955248407519  E_coul = 201.75546579346678
cycle= 1 E= -525.540059047285  delta_E= -1.13  |g|= 0.183  |ddm|= 0.579
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.454777
diis-c [-0.20682198  1.        ]
  HOMO = -0.575511312531601  LUMO = 0.890587680170392
  mo_energy =
[-1.18118499e+02 -1.21864632e+01 -9.53556925e+00 -9.53556925e+00
 -9.53556925e+00 -1.25421188e+00 -5.75511313e-01 -5.75511313e-01
 -5.75511313e-01  8.90587680e-01  8.90587680e-01  8.90587680e-01
  5.62680524e+00  5.62680524e+00  5.62680524e+00  2.48159710e+01
  2.48159710e+01  2.48159710e+01  9.77861770e+01  9.77861770e+01
  9.77861770e+01  1.83273237e+02  4.28867672e+02  4.28867672e+02
  4.28867672e+02  1.28149624e+03  1.28149624e+03  1.28149624e+03
  1.91482872e+03  2.98290860e+03  2.98290860e+03  2.98290860e+03
  6.61132220e+03  6.61132220e+03  6.61132220e+03  8.27281610e+03
  2.46603140e+04  7.54564905e+04]
E1 = -727.5162353424879  E_coul = 201.97597949465455
cycle= 2 E= -525.540255847833  delta_E= -0.000197  |g|= 0.0159  |ddm|= 0.015
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0315829
diis-c [-7.72604519e-04  3.19794212e-02  9.68020579e-01]
  HOMO = -0.572628718798766  LUMO = 0.892467257968879
  mo_energy =
[-1.18087109e+02 -1.21709311e+01 -9.51980367e+00 -9.51980367e+00
 -9.51980367e+00 -1.25033144e+00 -5.72628719e-01 -5.72628719e-01
 -5.72628719e-01  8.92467258e-01  8.92467258e-01  8.92467258e-01
  5.63388681e+00  5.63388681e+00  5.63388681e+00  2.48302694e+01
  2.48302694e+01  2.48302694e+01  9.78095280e+01  9.78095280e+01
  9.78095280e+01  1.83303412e+02  4.28898606e+02  4.28898606e+02
  4.28898606e+02  1.28152937e+03  1.28152937e+03  1.28152937e+03
  1.91486328e+03  2.98294277e+03  2.98294277e+03  2.98294277e+03
  6.61135696e+03  6.61135696e+03  6.61135696e+03  8.27285110e+03
  2.46603490e+04  7.54565255e+04]
E1 = -727.4692509377822  E_coul = 201.92898825828178
cycle= 3 E= -525.540262679501  delta_E= -6.83e-06  |g|= 0.00227  |ddm|= 0.00403
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00467439
diis-c [-1.19552443e-07 -7.36478177e-04  1.24520944e-01  8.76215534e-01]
  HOMO = -0.573223563719345  LUMO = 0.89208530675206
  mo_energy =
[-1.18091469e+02 -1.21734098e+01 -9.52232906e+00 -9.52232906e+00
 -9.52232906e+00 -1.25111081e+00 -5.73223564e-01 -5.73223564e-01
 -5.73223564e-01  8.92085307e-01  8.92085307e-01  8.92085307e-01
  5.63257815e+00  5.63257815e+00  5.63257815e+00  2.48279562e+01
  2.48279562e+01  2.48279562e+01  9.78061130e+01  9.78061130e+01
  9.78061130e+01  1.83299243e+02  4.28894306e+02  4.28894306e+02
  4.28894306e+02  1.28152481e+03  1.28152481e+03  1.28152481e+03
  1.91485849e+03  2.98293806e+03  2.98293806e+03  2.98293806e+03
  6.61135212e+03  6.61135212e+03  6.61135212e+03  8.27284618e+03
  2.46603441e+04  7.54565204e+04]
E1 = -727.4764184623394  E_coul = 201.93615558006337
cycle= 4 E= -525.540262882276  delta_E= -2.03e-07  |g|= 4.26e-05  |ddm|= 0.000643
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.79316e-05
diis-c [-3.81872230e-10 -2.86103991e-05  4.43790989e-03  4.62381962e-02
  9.49352504e-01]
  HOMO = -0.573199993732244  LUMO = 0.892100069406088
  mo_energy =
[-1.18091373e+02 -1.21733300e+01 -9.52224842e+00 -9.52224842e+00
 -9.52224842e+00 -1.25107982e+00 -5.73199994e-01 -5.73199994e-01
 -5.73199994e-01  8.92100069e-01  8.92100069e-01  8.92100069e-01
  5.63262683e+00  5.63262683e+00  5.63262683e+00  2.48280304e+01
  2.48280304e+01  2.48280304e+01  9.78062016e+01  9.78062016e+01
  9.78062016e+01  1.83299339e+02  4.28894401e+02  4.28894401e+02
  4.28894401e+02  1.28152490e+03  1.28152490e+03  1.28152490e+03
  1.91485859e+03  2.98293816e+03  2.98293816e+03  2.98293816e+03
  6.61135222e+03  6.61135222e+03  6.61135222e+03  8.27284627e+03
  2.46603442e+04  7.54565205e+04]
E1 = -727.4762061548557  E_coul = 201.93594327241223
cycle= 5 E= -525.540262882443  delta_E= -1.67e-10  |g|= 2.41e-06  |ddm|= 2.36e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4762061548557  E_coul = 201.93594327241223
  HOMO = -0.573201495954431  LUMO = 0.892099111772509
  mo_energy =
[-1.18091380e+02 -1.21733347e+01 -9.52225312e+00 -9.52225312e+00
 -9.52225312e+00 -1.25108174e+00 -5.73201496e-01 -5.73201496e-01
 -5.73201496e-01  8.92099112e-01  8.92099112e-01  8.92099112e-01
  5.63262388e+00  5.63262388e+00  5.63262388e+00  2.48280260e+01
  2.48280260e+01  2.48280260e+01  9.78061961e+01  9.78061961e+01
  9.78061961e+01  1.83299333e+02  4.28894395e+02  4.28894395e+02
  4.28894395e+02  1.28152490e+03  1.28152490e+03  1.28152490e+03
  1.91485858e+03  2.98293815e+03  2.98293815e+03  2.98293815e+03
  6.61135221e+03  6.61135221e+03  6.61135221e+03  8.27284626e+03
  2.46603442e+04  7.54565205e+04]
E1 = -727.476218312622  E_coul = 201.9359554301785
Extra cycle  E= -525.540262882443  delta_E=    0  |g|= 5.9e-07  |ddm|= 1.15e-06
    CPU time for scf_cycle      0.87 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 86104.55858600151
E1 = -727.476218312622  E_coul = 201.9359554301785
init E= -525.540262882443
    CPU time for initialize scf      1.74 sec, wall time      0.25 sec
  HOMO = -0.573201266619848  LUMO = 0.8920992569668
  mo_energy =
[-1.18091378e+02 -1.21733338e+01 -9.52225220e+00 -9.52225220e+00
 -9.52225220e+00 -1.25108144e+00 -5.73201267e-01 -5.73201267e-01
 -5.73201267e-01  8.92099257e-01  8.92099257e-01  8.92099257e-01
  5.63262438e+00  5.63262438e+00  5.63262438e+00  2.48280269e+01
  2.48280269e+01  2.48280269e+01  9.78061973e+01  9.78061973e+01
  9.78061973e+01  1.83299334e+02  4.28894397e+02  4.28894397e+02
  4.28894397e+02  1.28152490e+03  1.28152490e+03  1.28152490e+03
  1.91485858e+03  2.98293815e+03  2.98293815e+03  2.98293815e+03
  6.61135221e+03  6.61135221e+03  6.61135221e+03  8.27284627e+03
  2.46603442e+04  7.54565205e+04]
E1 = -727.4762157474363  E_coul = 201.93595286499317
cycle= 1 E= -525.540262882443  delta_E= 3.41e-13  |g|= 1.33e-07  |ddm|= 2.54e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4762157474363  E_coul = 201.93595286499317
  HOMO = -0.573201314617393  LUMO = 0.892099226262298
  mo_energy =
[-1.18091378e+02 -1.21733340e+01 -9.52225239e+00 -9.52225239e+00
 -9.52225239e+00 -1.25108150e+00 -5.73201315e-01 -5.73201315e-01
 -5.73201315e-01  8.92099226e-01  8.92099226e-01  8.92099226e-01
  5.63262427e+00  5.63262427e+00  5.63262427e+00  2.48280267e+01
  2.48280267e+01  2.48280267e+01  9.78061970e+01  9.78061970e+01
  9.78061970e+01  1.83299334e+02  4.28894396e+02  4.28894396e+02
  4.28894396e+02  1.28152490e+03  1.28152490e+03  1.28152490e+03
  1.91485858e+03  2.98293815e+03  2.98293815e+03  2.98293815e+03
  6.61135221e+03  6.61135221e+03  6.61135221e+03  8.27284627e+03
  2.46603442e+04  7.54565205e+04]
E1 = -727.4762162824251  E_coul = 201.93595339998257
Extra cycle  E= -525.540262882442  delta_E= 6.82e-13  |g|= 2.85e-08  |ddm|= 4.94e-08
    CPU time for scf_cycle      1.86 sec, wall time      0.37 sec
exp = [2.61825084e+04 7.61824502e+03 3.61823921e+03 1.61807350e+03
 2.39767492e+02 5.21073875e+01 4.60270297e+00 3.98935173e-01
 1.36279267e+03 6.65175596e+02 3.03292993e+02 3.16122095e+02
 4.93849913e+01 5.79173177e+00 1.58517944e+01 6.94368206e-01
 2.23410795e+00 2.06213516e-01]
grad_E = [-1.98694416e-06  2.19968213e-05  4.41310026e-05  6.76666804e-04
  1.66785519e-04 -1.50250490e-03 -9.37637549e-05 -1.73039194e-04
  1.73738716e-06  2.28208135e-05  1.25325783e-04  1.10433259e-04
 -2.43331799e-03 -6.84208698e-04  3.29420226e-04  2.03783925e-03
  4.00434437e-04 -1.40137215e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:19 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5083723        1
[INPUT] 0    0    [1    /1   ]  7618.24498918        1
[INPUT] 0    0    [1    /1   ]  3618.23914235        1
[INPUT] 0    0    [1    /1   ]  1618.07245899        1
[INPUT] 0    0    [1    /1   ]  239.767586969        1
[INPUT] 0    0    [1    /1   ]  52.1069227383        1
[INPUT] 0    0    [1    /1   ]  4.60226790721        1
[INPUT] 0    0    [1    /1   ]  0.398872243374       1
[INPUT] 1    0    [1    /1   ]  1362.7926596         1
[INPUT] 1    0    [1    /1   ]  665.175536707        1
[INPUT] 1    0    [1    /1   ]  303.292651373        1
[INPUT] 1    0    [1    /1   ]  316.121793931        1
[INPUT] 1    0    [1    /1   ]  49.404764718         1
[INPUT] 1    0    [1    /1   ]  5.76923530992        1
[INPUT] 1    0    [1    /1   ]  15.8109136171        1
[INPUT] 1    0    [1    /1   ]  0.694983849414       1
[INPUT] 1    0    [1    /1   ]  2.2248442502         1
[INPUT] 1    0    [1    /1   ]  0.2065118636         1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508372337274, 1.0]], [0, [7618.244989182995, 1.0]], [0, [3618.239142348699, 1.0]], [0, [1618.07245898765, 1.0]], [0, [239.76758696935235, 1.0]], [0, [52.10692273829734, 1.0]], [0, [4.602267907209551, 1.0]], [0, [0.39887224337367694, 1.0]], [1, [1362.7926596033903, 1.0]], [1, [665.1755367071498, 1.0]], [1, [303.29265137305583, 1.0]], [1, [316.12179393091446, 1.0]], [1, [49.404764717982886, 1.0]], [1, [5.769235309922001, 1.0]], [1, [15.810913617056519, 1.0]], [1, [0.6949838494137468, 1.0]], [1, [2.2248442502015844, 1.0]], [1, [0.20651186359974835, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50837234]
bas 1, expnt(s) = [7618.24498918]
bas 2, expnt(s) = [3618.23914235]
bas 3, expnt(s) = [1618.07245899]
bas 4, expnt(s) = [239.76758697]
bas 5, expnt(s) = [52.10692274]
bas 6, expnt(s) = [4.60226791]
bas 7, expnt(s) = [0.39887224]
bas 8, expnt(s) = [1362.7926596]
bas 9, expnt(s) = [665.17553671]
bas 10, expnt(s) = [303.29265137]
bas 11, expnt(s) = [316.12179393]
bas 12, expnt(s) = [49.40476472]
bas 13, expnt(s) = [5.76923531]
bas 14, expnt(s) = [15.81091362]
bas 15, expnt(s) = [0.69498385]
bas 16, expnt(s) = [2.22484425]
bas 17, expnt(s) = [0.20651186]
CPU time:       212.64
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825084e+04 5.20024090e+03 7.61824499e+03 2.06018502e+03
 3.61823914e+03 1.17865845e+03 1.61807246e+03 6.44560220e+02
 2.39767587e+02 1.53942267e+02 5.21069227e+01 4.89989297e+01
 4.60226791e+00 7.93860049e+00 3.98872243e-01 1.26806170e+00
 1.36279266e+03 2.41558111e+04 6.65175537e+02 9.85495688e+03
 3.03292651e+02 3.69242559e+03 3.16121794e+02 3.88868209e+03
 4.94047647e+01 3.82116188e+02 5.76923531e+00 2.60844815e+01
 1.58109136e+01 9.19772880e+01 6.94983849e-01 1.85119762e+00
 2.22484425e+00 7.92700094e+00 2.06511864e-01 4.06130541e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97601397228166
cond(S) = 86065.7260329601
E1 = -727.5385134326939  E_coul = 203.12779776447547
init E= -524.410715668218
    CPU time for initialize scf      0.62 sec, wall time      0.08 sec
  HOMO = -0.560123166978111  LUMO = 0.898756583183498
  mo_energy =
[-1.17869259e+02 -1.20938905e+01 -9.44406575e+00 -9.44406575e+00
 -9.44406575e+00 -1.23002638e+00 -5.60123167e-01 -5.60123167e-01
 -5.60123167e-01  8.98756583e-01  8.98756583e-01  8.98756583e-01
  5.65489297e+00  5.65489297e+00  5.65489297e+00  2.47969717e+01
  2.47969717e+01  2.47969717e+01  9.77366982e+01  9.77366982e+01
  9.77366982e+01  1.83466770e+02  4.28944709e+02  4.28944709e+02
  4.28944709e+02  1.28165205e+03  1.28165205e+03  1.28165205e+03
  1.91523082e+03  2.98313750e+03  2.98313750e+03  2.98313750e+03
  6.61167728e+03  6.61167728e+03  6.61167728e+03  8.27335496e+03
  2.46609453e+04  7.54572127e+04]
E1 = -727.2965979543193  E_coul = 201.75649979985965
cycle= 1 E= -525.54009815446  delta_E= -1.13  |g|= 0.183  |ddm|= 0.563
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.454828
diis-c [-0.20686863  1.        ]
  HOMO = -0.575480342685681  LUMO = 0.892106789589137
  mo_energy =
[-1.18118515e+02 -1.21863510e+01 -9.53549272e+00 -9.53549272e+00
 -9.53549272e+00 -1.25413282e+00 -5.75480343e-01 -5.75480343e-01
 -5.75480343e-01  8.92106790e-01  8.92106790e-01  8.92106790e-01
  5.61199294e+00  5.61199294e+00  5.61199294e+00  2.47112282e+01
  2.47112282e+01  2.47112282e+01  9.75853945e+01  9.75853945e+01
  9.75853945e+01  1.83270023e+02  4.28709539e+02  4.28709539e+02
  4.28709539e+02  1.28136699e+03  1.28136699e+03  1.28136699e+03
  1.91482528e+03  2.98279132e+03  2.98279132e+03  2.98279132e+03
  6.61121585e+03  6.61121585e+03  6.61121585e+03  8.27281132e+03
  2.46603080e+04  7.54564841e+04]
E1 = -727.5168041967039  E_coul = 201.97650942807624
cycle= 2 E= -525.540294768628  delta_E= -0.000197  |g|= 0.0158  |ddm|= 0.0149
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0315373
diis-c [-7.70683667e-04  3.19096376e-02  9.68090362e-01]
  HOMO = -0.572611517875236  LUMO = 0.89397873815361
  mo_energy =
[-1.18087164e+02 -1.21708533e+01 -9.51976177e+00 -9.51976177e+00
 -9.51976177e+00 -1.25027019e+00 -5.72611518e-01 -5.72611518e-01
 -5.72611518e-01  8.93978738e-01  8.93978738e-01  8.93978738e-01
  5.61902876e+00  5.61902876e+00  5.61902876e+00  2.47254689e+01
  2.47254689e+01  2.47254689e+01  9.76087086e+01  9.76087086e+01
  9.76087086e+01  1.83300160e+02  4.28740437e+02  4.28740437e+02
  4.28740437e+02  1.28140008e+03  1.28140008e+03  1.28140008e+03
  1.91485980e+03  2.98282545e+03  2.98282545e+03  2.98282545e+03
  6.61125057e+03  6.61125057e+03  6.61125057e+03  8.27284627e+03
  2.46603430e+04  7.54565191e+04]
E1 = -727.4699090124253  E_coul = 201.92960743464633
cycle= 3 E= -525.540301577779  delta_E= -6.81e-06  |g|= 0.00227  |ddm|= 0.00402
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00466648
diis-c [-1.20515254e-07 -7.36264060e-04  1.24486179e-01  8.76250085e-01]
  HOMO = -0.573205487325309  LUMO = 0.893597052586537
  mo_energy =
[-1.18091520e+02 -1.21733285e+01 -9.52228373e+00 -9.52228373e+00
 -9.52228373e+00 -1.25104830e+00 -5.73205487e-01 -5.73205487e-01
 -5.73205487e-01  8.93597053e-01  8.93597053e-01  8.93597053e-01
  5.61772526e+00  5.61772526e+00  5.61772526e+00  2.47231620e+01
  2.47231620e+01  2.47231620e+01  9.76052978e+01  9.76052978e+01
  9.76052978e+01  1.83295996e+02  4.28736141e+02  4.28736141e+02
  4.28736141e+02  1.28139553e+03  1.28139553e+03  1.28139553e+03
  1.91485502e+03  2.98282075e+03  2.98282075e+03  2.98282075e+03
  6.61124574e+03  6.61124574e+03  6.61124574e+03  8.27284135e+03
  2.46603380e+04  7.54565140e+04]
E1 = -727.4770666381943  E_coul = 201.93676485816175
cycle= 4 E= -525.540301780033  delta_E= -2.02e-07  |g|= 4.28e-05  |ddm|= 0.000641
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=7.81895e-05
diis-c [-3.83639330e-10 -2.85420076e-05  4.42547379e-03  4.62370205e-02
  9.49366048e-01]
  HOMO = -0.573181883649751  LUMO = 0.893611842901024
  mo_energy =
[-1.18091423e+02 -1.21732485e+01 -9.52220285e+00 -9.52220285e+00
 -9.52220285e+00 -1.25101726e+00 -5.73181884e-01 -5.73181884e-01
 -5.73181884e-01  8.93611843e-01  8.93611843e-01  8.93611843e-01
  5.61777394e+00  5.61777394e+00  5.61777394e+00  2.47232364e+01
  2.47232364e+01  2.47232364e+01  9.76053866e+01  9.76053866e+01
  9.76053866e+01  1.83296092e+02  4.28736237e+02  4.28736237e+02
  4.28736237e+02  1.28139562e+03  1.28139562e+03  1.28139562e+03
  1.91485512e+03  2.98282084e+03  2.98282084e+03  2.98282084e+03
  6.61124583e+03  6.61124583e+03  6.61124583e+03  8.27284145e+03
  2.46603381e+04  7.54565141e+04]
E1 = -727.4768536286325  E_coul = 201.93655184843132
cycle= 5 E= -525.540301780201  delta_E= -1.69e-10  |g|= 2.43e-06  |ddm|= 2.37e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.4768536286325  E_coul = 201.93655184843132
  HOMO = -0.573183395580422  LUMO = 0.893610878061025
  mo_energy =
[-1.18091430e+02 -1.21732532e+01 -9.52220758e+00 -9.52220758e+00
 -9.52220758e+00 -1.25101918e+00 -5.73183396e-01 -5.73183396e-01
 -5.73183396e-01  8.93610878e-01  8.93610878e-01  8.93610878e-01
  5.61777098e+00  5.61777098e+00  5.61777098e+00  2.47232320e+01
  2.47232320e+01  2.47232320e+01  9.76053811e+01  9.76053811e+01
  9.76053811e+01  1.83296085e+02  4.28736231e+02  4.28736231e+02
  4.28736231e+02  1.28139562e+03  1.28139562e+03  1.28139562e+03
  1.91485511e+03  2.98282084e+03  2.98282084e+03  2.98282084e+03
  6.61124583e+03  6.61124583e+03  6.61124583e+03  8.27284144e+03
  2.46603381e+04  7.54565141e+04]
E1 = -727.4768658323289  E_coul = 201.93656405212752
Extra cycle  E= -525.540301780201  delta_E= -2.27e-13  |g|= 5.92e-07  |ddm|= 1.15e-06
    CPU time for scf_cycle      0.78 sec, wall time      0.24 sec
exp = [2.61825084e+04 7.61824499e+03 3.61823914e+03 1.61807246e+03
 2.39767587e+02 5.21069227e+01 4.60226791e+00 3.98872243e-01
 1.36279266e+03 6.65175537e+02 3.03292651e+02 3.16121794e+02
 4.94047647e+01 5.76923531e+00 1.58109136e+01 6.94983849e-01
 2.22484425e+00 2.06511864e-01]
E = -525.5403017802014
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:20 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5083723        1
[INPUT] 0    0    [1    /1   ]  7618.24498918        1
[INPUT] 0    0    [1    /1   ]  3618.23914235        1
[INPUT] 0    0    [1    /1   ]  1618.07245899        1
[INPUT] 0    0    [1    /1   ]  239.767586969        1
[INPUT] 0    0    [1    /1   ]  52.1069227383        1
[INPUT] 0    0    [1    /1   ]  4.60226790721        1
[INPUT] 0    0    [1    /1   ]  0.398872243374       1
[INPUT] 1    0    [1    /1   ]  1362.7926596         1
[INPUT] 1    0    [1    /1   ]  665.175536707        1
[INPUT] 1    0    [1    /1   ]  303.292651373        1
[INPUT] 1    0    [1    /1   ]  316.121793931        1
[INPUT] 1    0    [1    /1   ]  49.404764718         1
[INPUT] 1    0    [1    /1   ]  5.76923530992        1
[INPUT] 1    0    [1    /1   ]  15.8109136171        1
[INPUT] 1    0    [1    /1   ]  0.694983849414       1
[INPUT] 1    0    [1    /1   ]  2.2248442502         1
[INPUT] 1    0    [1    /1   ]  0.2065118636         1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508372337274, 1.0]], [0, [7618.244989182995, 1.0]], [0, [3618.239142348699, 1.0]], [0, [1618.07245898765, 1.0]], [0, [239.76758696935235, 1.0]], [0, [52.10692273829734, 1.0]], [0, [4.602267907209551, 1.0]], [0, [0.39887224337367694, 1.0]], [1, [1362.7926596033903, 1.0]], [1, [665.1755367071498, 1.0]], [1, [303.29265137305583, 1.0]], [1, [316.12179393091446, 1.0]], [1, [49.404764717982886, 1.0]], [1, [5.769235309922001, 1.0]], [1, [15.810913617056519, 1.0]], [1, [0.6949838494137468, 1.0]], [1, [2.2248442502015844, 1.0]], [1, [0.20651186359974835, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50837234]
bas 1, expnt(s) = [7618.24498918]
bas 2, expnt(s) = [3618.23914235]
bas 3, expnt(s) = [1618.07245899]
bas 4, expnt(s) = [239.76758697]
bas 5, expnt(s) = [52.10692274]
bas 6, expnt(s) = [4.60226791]
bas 7, expnt(s) = [0.39887224]
bas 8, expnt(s) = [1362.7926596]
bas 9, expnt(s) = [665.17553671]
bas 10, expnt(s) = [303.29265137]
bas 11, expnt(s) = [316.12179393]
bas 12, expnt(s) = [49.40476472]
bas 13, expnt(s) = [5.76923531]
bas 14, expnt(s) = [15.81091362]
bas 15, expnt(s) = [0.69498385]
bas 16, expnt(s) = [2.22484425]
bas 17, expnt(s) = [0.20651186]
CPU time:       213.58
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825084e+04 5.20024090e+03 7.61824499e+03 2.06018502e+03
 3.61823914e+03 1.17865845e+03 1.61807246e+03 6.44560220e+02
 2.39767587e+02 1.53942267e+02 5.21069227e+01 4.89989297e+01
 4.60226791e+00 7.93860049e+00 3.98872243e-01 1.26806170e+00
 1.36279266e+03 2.41558111e+04 6.65175537e+02 9.85495688e+03
 3.03292651e+02 3.69242559e+03 3.16121794e+02 3.88868209e+03
 4.94047647e+01 3.82116188e+02 5.76923531e+00 2.60844815e+01
 1.58109136e+01 9.19772880e+01 6.94983849e-01 1.85119762e+00
 2.22484425e+00 7.92700094e+00 2.06511864e-01 4.06130541e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97601397228166
cond(S) = 86065.7260329601
E1 = -727.5385134326939  E_coul = 203.12779776447547
init E= -524.410715668218
    CPU time for initialize scf      0.58 sec, wall time      0.08 sec
  HOMO = -0.560123166978111  LUMO = 0.898756583183498
  mo_energy =
[-1.17869259e+02 -1.20938905e+01 -9.44406575e+00 -9.44406575e+00
 -9.44406575e+00 -1.23002638e+00 -5.60123167e-01 -5.60123167e-01
 -5.60123167e-01  8.98756583e-01  8.98756583e-01  8.98756583e-01
  5.65489297e+00  5.65489297e+00  5.65489297e+00  2.47969717e+01
  2.47969717e+01  2.47969717e+01  9.77366982e+01  9.77366982e+01
  9.77366982e+01  1.83466770e+02  4.28944709e+02  4.28944709e+02
  4.28944709e+02  1.28165205e+03  1.28165205e+03  1.28165205e+03
  1.91523082e+03  2.98313750e+03  2.98313750e+03  2.98313750e+03
  6.61167728e+03  6.61167728e+03  6.61167728e+03  8.27335496e+03
  2.46609453e+04  7.54572127e+04]
E1 = -727.2965979543193  E_coul = 201.75649979985965
cycle= 1 E= -525.54009815446  delta_E= -1.13  |g|= 0.183  |ddm|= 0.563
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.454828
diis-c [-0.20686863  1.        ]
  HOMO = -0.575480342685681  LUMO = 0.892106789589137
  mo_energy =
[-1.18118515e+02 -1.21863510e+01 -9.53549272e+00 -9.53549272e+00
 -9.53549272e+00 -1.25413282e+00 -5.75480343e-01 -5.75480343e-01
 -5.75480343e-01  8.92106790e-01  8.92106790e-01  8.92106790e-01
  5.61199294e+00  5.61199294e+00  5.61199294e+00  2.47112282e+01
  2.47112282e+01  2.47112282e+01  9.75853945e+01  9.75853945e+01
  9.75853945e+01  1.83270023e+02  4.28709539e+02  4.28709539e+02
  4.28709539e+02  1.28136699e+03  1.28136699e+03  1.28136699e+03
  1.91482528e+03  2.98279132e+03  2.98279132e+03  2.98279132e+03
  6.61121585e+03  6.61121585e+03  6.61121585e+03  8.27281132e+03
  2.46603080e+04  7.54564841e+04]
E1 = -727.5168041967039  E_coul = 201.97650942807624
cycle= 2 E= -525.540294768628  delta_E= -0.000197  |g|= 0.0158  |ddm|= 0.0149
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0315373
diis-c [-7.70683667e-04  3.19096376e-02  9.68090362e-01]
  HOMO = -0.572611517875236  LUMO = 0.89397873815361
  mo_energy =
[-1.18087164e+02 -1.21708533e+01 -9.51976177e+00 -9.51976177e+00
 -9.51976177e+00 -1.25027019e+00 -5.72611518e-01 -5.72611518e-01
 -5.72611518e-01  8.93978738e-01  8.93978738e-01  8.93978738e-01
  5.61902876e+00  5.61902876e+00  5.61902876e+00  2.47254689e+01
  2.47254689e+01  2.47254689e+01  9.76087086e+01  9.76087086e+01
  9.76087086e+01  1.83300160e+02  4.28740437e+02  4.28740437e+02
  4.28740437e+02  1.28140008e+03  1.28140008e+03  1.28140008e+03
  1.91485980e+03  2.98282545e+03  2.98282545e+03  2.98282545e+03
  6.61125057e+03  6.61125057e+03  6.61125057e+03  8.27284627e+03
  2.46603430e+04  7.54565191e+04]
E1 = -727.4699090124253  E_coul = 201.92960743464633
cycle= 3 E= -525.540301577779  delta_E= -6.81e-06  |g|= 0.00227  |ddm|= 0.00402
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00466648
diis-c [-1.20515254e-07 -7.36264060e-04  1.24486179e-01  8.76250085e-01]
  HOMO = -0.573205487325309  LUMO = 0.893597052586537
  mo_energy =
[-1.18091520e+02 -1.21733285e+01 -9.52228373e+00 -9.52228373e+00
 -9.52228373e+00 -1.25104830e+00 -5.73205487e-01 -5.73205487e-01
 -5.73205487e-01  8.93597053e-01  8.93597053e-01  8.93597053e-01
  5.61772526e+00  5.61772526e+00  5.61772526e+00  2.47231620e+01
  2.47231620e+01  2.47231620e+01  9.76052978e+01  9.76052978e+01
  9.76052978e+01  1.83295996e+02  4.28736141e+02  4.28736141e+02
  4.28736141e+02  1.28139553e+03  1.28139553e+03  1.28139553e+03
  1.91485502e+03  2.98282075e+03  2.98282075e+03  2.98282075e+03
  6.61124574e+03  6.61124574e+03  6.61124574e+03  8.27284135e+03
  2.46603380e+04  7.54565140e+04]
E1 = -727.4770666381943  E_coul = 201.93676485816175
cycle= 4 E= -525.540301780033  delta_E= -2.02e-07  |g|= 4.28e-05  |ddm|= 0.000641
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=7.81895e-05
diis-c [-3.83639330e-10 -2.85420076e-05  4.42547379e-03  4.62370205e-02
  9.49366048e-01]
  HOMO = -0.573181883649751  LUMO = 0.893611842901024
  mo_energy =
[-1.18091423e+02 -1.21732485e+01 -9.52220285e+00 -9.52220285e+00
 -9.52220285e+00 -1.25101726e+00 -5.73181884e-01 -5.73181884e-01
 -5.73181884e-01  8.93611843e-01  8.93611843e-01  8.93611843e-01
  5.61777394e+00  5.61777394e+00  5.61777394e+00  2.47232364e+01
  2.47232364e+01  2.47232364e+01  9.76053866e+01  9.76053866e+01
  9.76053866e+01  1.83296092e+02  4.28736237e+02  4.28736237e+02
  4.28736237e+02  1.28139562e+03  1.28139562e+03  1.28139562e+03
  1.91485512e+03  2.98282084e+03  2.98282084e+03  2.98282084e+03
  6.61124583e+03  6.61124583e+03  6.61124583e+03  8.27284145e+03
  2.46603381e+04  7.54565141e+04]
E1 = -727.4768536286325  E_coul = 201.93655184843132
cycle= 5 E= -525.540301780201  delta_E= -1.69e-10  |g|= 2.43e-06  |ddm|= 2.37e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.4768536286325  E_coul = 201.93655184843132
  HOMO = -0.573183395580422  LUMO = 0.893610878061025
  mo_energy =
[-1.18091430e+02 -1.21732532e+01 -9.52220758e+00 -9.52220758e+00
 -9.52220758e+00 -1.25101918e+00 -5.73183396e-01 -5.73183396e-01
 -5.73183396e-01  8.93610878e-01  8.93610878e-01  8.93610878e-01
  5.61777098e+00  5.61777098e+00  5.61777098e+00  2.47232320e+01
  2.47232320e+01  2.47232320e+01  9.76053811e+01  9.76053811e+01
  9.76053811e+01  1.83296085e+02  4.28736231e+02  4.28736231e+02
  4.28736231e+02  1.28139562e+03  1.28139562e+03  1.28139562e+03
  1.91485511e+03  2.98282084e+03  2.98282084e+03  2.98282084e+03
  6.61124583e+03  6.61124583e+03  6.61124583e+03  8.27284144e+03
  2.46603381e+04  7.54565141e+04]
E1 = -727.4768658323289  E_coul = 201.93656405212752
Extra cycle  E= -525.540301780201  delta_E= -2.27e-13  |g|= 5.92e-07  |ddm|= 1.15e-06
    CPU time for scf_cycle      0.72 sec, wall time      0.21 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 86065.7260329601
E1 = -727.4768658323289  E_coul = 201.93656405212752
init E= -525.540301780201
    CPU time for initialize scf      1.74 sec, wall time      0.24 sec
  HOMO = -0.573183165581189  LUMO = 0.893611023745141
  mo_energy =
[-1.18091428e+02 -1.21732523e+01 -9.52220665e+00 -9.52220665e+00
 -9.52220665e+00 -1.25101888e+00 -5.73183166e-01 -5.73183166e-01
 -5.73183166e-01  8.93611024e-01  8.93611024e-01  8.93611024e-01
  5.61777148e+00  5.61777148e+00  5.61777148e+00  2.47232328e+01
  2.47232328e+01  2.47232328e+01  9.76053823e+01  9.76053823e+01
  9.76053823e+01  1.83296087e+02  4.28736232e+02  4.28736232e+02
  4.28736232e+02  1.28139562e+03  1.28139562e+03  1.28139562e+03
  1.91485511e+03  2.98282084e+03  2.98282084e+03  2.98282084e+03
  6.61124583e+03  6.61124583e+03  6.61124583e+03  8.27284144e+03
  2.46603381e+04  7.54565141e+04]
E1 = -727.4768632564485  E_coul = 201.93656147624796
cycle= 1 E= -525.5403017802  delta_E= 9.09e-13  |g|= 1.33e-07  |ddm|= 2.55e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4768632564485  E_coul = 201.93656147624796
  HOMO = -0.573183213790476  LUMO = 0.893610992882483
  mo_energy =
[-1.18091429e+02 -1.21732525e+01 -9.52220685e+00 -9.52220685e+00
 -9.52220685e+00 -1.25101894e+00 -5.73183214e-01 -5.73183214e-01
 -5.73183214e-01  8.93610993e-01  8.93610993e-01  8.93610993e-01
  5.61777137e+00  5.61777137e+00  5.61777137e+00  2.47232327e+01
  2.47232327e+01  2.47232327e+01  9.76053820e+01  9.76053820e+01
  9.76053820e+01  1.83296087e+02  4.28736232e+02  4.28736232e+02
  4.28736232e+02  1.28139562e+03  1.28139562e+03  1.28139562e+03
  1.91485511e+03  2.98282084e+03  2.98282084e+03  2.98282084e+03
  6.61124583e+03  6.61124583e+03  6.61124583e+03  8.27284144e+03
  2.46603381e+04  7.54565141e+04]
E1 = -727.4768637935754  E_coul = 201.93656201337438
Extra cycle  E= -525.540301780201  delta_E= -4.55e-13  |g|= 2.86e-08  |ddm|= 4.95e-08
    CPU time for scf_cycle      2.03 sec, wall time      0.53 sec
exp = [2.61825084e+04 7.61824499e+03 3.61823914e+03 1.61807246e+03
 2.39767587e+02 5.21069227e+01 4.60226791e+00 3.98872243e-01
 1.36279266e+03 6.65175537e+02 3.03292651e+02 3.16121794e+02
 4.94047647e+01 5.76923531e+00 1.58109136e+01 6.94983849e-01
 2.22484425e+00 2.06511864e-01]
grad_E = [-1.98692817e-06  2.19960255e-05  4.41287085e-05  6.76639447e-04
  1.68450495e-04 -1.51395207e-03 -4.94616884e-04 -8.90775917e-04
  1.69635592e-06  2.25354512e-05  1.23603811e-04  1.08910148e-04
 -2.29201733e-03 -5.92282802e-04 -9.18468823e-05  4.09527951e-03
  2.81268687e-04 -1.68777832e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5084044        1
[INPUT] 0    0    [1    /1   ]  7618.24463254        1
[INPUT] 0    0    [1    /1   ]  3618.23842545        1
[INPUT] 0    0    [1    /1   ]  1618.06147818        1
[INPUT] 0    0    [1    /1   ]  239.768615016        1
[INPUT] 0    0    [1    /1   ]  52.1043893352        1
[INPUT] 0    0    [1    /1   ]  4.60166795238        1
[INPUT] 0    0    [1    /1   ]  0.398779520211       1
[INPUT] 1    0    [1    /1   ]  1362.79262797        1
[INPUT] 1    0    [1    /1   ]  665.175142465        1
[INPUT] 1    0    [1    /1   ]  303.290470837        1
[INPUT] 1    0    [1    /1   ]  316.11987238         1
[INPUT] 1    0    [1    /1   ]  49.4603620016        1
[INPUT] 1    0    [1    /1   ]  5.74590041179        1
[INPUT] 1    0    [1    /1   ]  15.7667804025        1
[INPUT] 1    0    [1    /1   ]  0.69649830503        1
[INPUT] 1    0    [1    /1   ]  2.21600767525        1
[INPUT] 1    0    [1    /1   ]  0.207176804759       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508404434466, 1.0]], [0, [7618.244632543634, 1.0]], [0, [3618.2384254464855, 1.0]], [0, [1618.061478184797, 1.0]], [0, [239.7686150161314, 1.0]], [0, [52.10438933523501, 1.0]], [0, [4.601667952378311, 1.0]], [0, [0.3987795202114201, 1.0]], [1, [1362.792627965526, 1.0]], [1, [665.1751424650453, 1.0]], [1, [303.29047083697515, 1.0]], [1, [316.1198723795707, 1.0]], [1, [49.46036200163651, 1.0]], [1, [5.745900411789765, 1.0]], [1, [15.766780402497535, 1.0]], [1, [0.6964983050303297, 1.0]], [1, [2.216007675250586, 1.0]], [1, [0.20717680475890393, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50840443]
bas 1, expnt(s) = [7618.24463254]
bas 2, expnt(s) = [3618.23842545]
bas 3, expnt(s) = [1618.06147818]
bas 4, expnt(s) = [239.76861502]
bas 5, expnt(s) = [52.10438934]
bas 6, expnt(s) = [4.60166795]
bas 7, expnt(s) = [0.39877952]
bas 8, expnt(s) = [1362.79262797]
bas 9, expnt(s) = [665.17514247]
bas 10, expnt(s) = [303.29047084]
bas 11, expnt(s) = [316.11987238]
bas 12, expnt(s) = [49.460362]
bas 13, expnt(s) = [5.74590041]
bas 14, expnt(s) = [15.7667804]
bas 15, expnt(s) = [0.69649831]
bas 16, expnt(s) = [2.21600768]
bas 17, expnt(s) = [0.2071768]
CPU time:       220.62
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825084e+04 5.20024090e+03 7.61824463e+03 2.06018495e+03
 3.61823843e+03 1.17865828e+03 1.61806148e+03 6.44556939e+02
 2.39768615e+02 1.53942762e+02 5.21043893e+01 4.89971430e+01
 4.60166795e+00 7.93782431e+00 3.98779520e-01 1.26784061e+00
 1.36279263e+03 2.41558104e+04 6.65175142e+02 9.85494958e+03
 3.03290471e+02 3.69239241e+03 3.16119872e+02 3.88865254e+03
 4.94603620e+01 3.82653778e+02 5.74590041e+00 2.59526680e+01
 1.57667804e+01 9.16564782e+01 6.96498305e-01 1.85624148e+00
 2.21600768e+00 7.88766519e+00 2.07176805e-01 4.07765808e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.975979356029587
cond(S) = 86056.44004900233
E1 = -727.5362969834537  E_coul = 203.1252761043124
init E= -524.411020879141
    CPU time for initialize scf      0.36 sec, wall time      0.06 sec
  HOMO = -0.560160008532106  LUMO = 0.902285301601513
  mo_energy =
[-1.17869555e+02 -1.20940665e+01 -9.44430015e+00 -9.44430015e+00
 -9.44430015e+00 -1.23004482e+00 -5.60160009e-01 -5.60160009e-01
 -5.60160009e-01  9.02285302e-01  9.02285302e-01  9.02285302e-01
  5.64522860e+00  5.64522860e+00  5.64522860e+00  2.46936081e+01
  2.46936081e+01  2.46936081e+01  9.75626003e+01  9.75626003e+01
  9.75626003e+01  1.83457281e+02  4.28882432e+02  4.28882432e+02
  4.28882432e+02  1.28162860e+03  1.28162860e+03  1.28162860e+03
  1.91521644e+03  2.98312091e+03  2.98312091e+03  2.98312091e+03
  6.61166167e+03  6.61166167e+03  6.61166167e+03  8.27332448e+03
  2.46609012e+04  7.54571637e+04]
E1 = -727.2999297066054  E_coul = 201.7597413062718
cycle= 1 E= -525.540188400334  delta_E= -1.13  |g|= 0.182  |ddm|= 0.537
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.454949
diis-c [-0.20697837  1.        ]
  HOMO = -0.57535867411651  LUMO = 0.895703671021261
  mo_energy =
[-1.18118450e+02 -1.21860493e+01 -9.53527709e+00 -9.53527709e+00
 -9.53527709e+00 -1.25393592e+00 -5.75358674e-01 -5.75358674e-01
 -5.75358674e-01  8.95703671e-01  8.95703671e-01  8.95703671e-01
  5.60274806e+00  5.60274806e+00  5.60274806e+00  2.46084455e+01
  2.46084455e+01  2.46084455e+01  9.74116649e+01  9.74116649e+01
  9.74116649e+01  1.83260962e+02  4.28647600e+02  4.28647600e+02
  4.28647600e+02  1.28134385e+03  1.28134385e+03  1.28134385e+03
  1.91481114e+03  2.98277500e+03  2.98277500e+03  2.98277500e+03
  6.61120045e+03  6.61120045e+03  6.61120045e+03  8.27278101e+03
  2.46602640e+04  7.54564352e+04]
E1 = -727.5190993697548  E_coul = 201.97871497332085
cycle= 2 E= -525.540384396434  delta_E= -0.000196  |g|= 0.0158  |ddm|= 0.0148
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0314539
diis-c [-7.66957840e-04  3.17955730e-02  9.68204427e-01]
  HOMO = -0.572514799010584  LUMO = 0.897564409923784
  mo_energy =
[-1.18087187e+02 -1.21706243e+01 -9.51961959e+00 -9.51961959e+00
 -9.51961959e+00 -1.25010612e+00 -5.72514799e-01 -5.72514799e-01
 -5.72514799e-01  8.97564410e-01  8.97564410e-01  8.97564410e-01
  5.60971636e+00  5.60971636e+00  5.60971636e+00  2.46225909e+01
  2.46225909e+01  2.46225909e+01  9.74349016e+01  9.74349016e+01
  9.74349016e+01  1.83291014e+02  4.28678412e+02  4.28678412e+02
  4.28678412e+02  1.28137685e+03  1.28137685e+03  1.28137685e+03
  1.91484556e+03  2.98280903e+03  2.98280903e+03  2.98280903e+03
  6.61123508e+03  6.61123508e+03  6.61123508e+03  8.27281587e+03
  2.46602989e+04  7.54564700e+04]
E1 = -727.4724225144906  E_coul = 201.9320313613518
cycle= 3 E= -525.540391153139  delta_E= -6.76e-06  |g|= 0.00226  |ddm|= 0.004
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00465049
diis-c [-1.21166351e-07 -7.36044287e-04  1.24384013e-01  8.76352031e-01]
  HOMO = -0.573105952542232  LUMO = 0.897183556498635
  mo_energy =
[-1.18091529e+02 -1.21730900e+01 -9.52213198e+00 -9.52213198e+00
 -9.52213198e+00 -1.25088043e+00 -5.73105953e-01 -5.73105953e-01
 -5.73105953e-01  8.97183556e-01  8.97183556e-01  8.97183556e-01
  5.60842158e+00  5.60842158e+00  5.60842158e+00  2.46202964e+01
  2.46202964e+01  2.46202964e+01  9.74315019e+01  9.74315019e+01
  9.74315019e+01  1.83286863e+02  4.28674129e+02  4.28674129e+02
  4.28674129e+02  1.28137231e+03  1.28137231e+03  1.28137231e+03
  1.91484080e+03  2.98280434e+03  2.98280434e+03  2.98280434e+03
  6.61123026e+03  6.61123026e+03  6.61123026e+03  8.27281097e+03
  2.46602939e+04  7.54564650e+04]
E1 = -727.4795498911573  E_coul = 201.93915853732884
cycle= 4 E= -525.540391353828  delta_E= -2.01e-07  |g|= 4.29e-05  |ddm|= 0.000637
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.83617e-05
diis-c [-3.85565322e-10 -2.85743888e-05  4.42408213e-03  4.63388041e-02
  9.49265688e-01]
  HOMO = -0.573082323365943  LUMO = 0.897198396283785
  mo_energy =
[-1.18091433e+02 -1.21730099e+01 -9.52205092e+00 -9.52205092e+00
 -9.52205092e+00 -1.25084936e+00 -5.73082323e-01 -5.73082323e-01
 -5.73082323e-01  8.97198396e-01  8.97198396e-01  8.97198396e-01
  5.60847024e+00  5.60847024e+00  5.60847024e+00  2.46203708e+01
  2.46203708e+01  2.46203708e+01  9.74315909e+01  9.74315909e+01
  9.74315909e+01  1.83286958e+02  4.28674225e+02  4.28674225e+02
  4.28674225e+02  1.28137240e+03  1.28137240e+03  1.28137240e+03
  1.91484089e+03  2.98280444e+03  2.98280444e+03  2.98280444e+03
  6.61123035e+03  6.61123035e+03  6.61123035e+03  8.27281106e+03
  2.46602940e+04  7.54564651e+04]
E1 = -727.4793365332902  E_coul = 201.9389451792924
cycle= 5 E= -525.540391353998  delta_E= -1.69e-10  |g|= 2.43e-06  |ddm|= 2.38e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4793365332902  E_coul = 201.9389451792924
  HOMO = -0.573083838702442  LUMO = 0.897197426710448
  mo_energy =
[-1.18091439e+02 -1.21730145e+01 -9.52205565e+00 -9.52205565e+00
 -9.52205565e+00 -1.25085129e+00 -5.73083839e-01 -5.73083839e-01
 -5.73083839e-01  8.97197427e-01  8.97197427e-01  8.97197427e-01
  5.60846728e+00  5.60846728e+00  5.60846728e+00  2.46203664e+01
  2.46203664e+01  2.46203664e+01  9.74315854e+01  9.74315854e+01
  9.74315854e+01  1.83286952e+02  4.28674219e+02  4.28674219e+02
  4.28674219e+02  1.28137240e+03  1.28137240e+03  1.28137240e+03
  1.91484089e+03  2.98280443e+03  2.98280443e+03  2.98280443e+03
  6.61123035e+03  6.61123035e+03  6.61123035e+03  8.27281106e+03
  2.46602940e+04  7.54564651e+04]
E1 = -727.4793487477176  E_coul = 201.93895739371922
Extra cycle  E= -525.540391353998  delta_E= -6.82e-13  |g|= 5.93e-07  |ddm|= 1.15e-06
    CPU time for scf_cycle      0.55 sec, wall time      0.25 sec
exp = [2.61825084e+04 7.61824463e+03 3.61823843e+03 1.61806148e+03
 2.39768615e+02 5.21043893e+01 4.60166795e+00 3.98779520e-01
 1.36279263e+03 6.65175142e+02 3.03290471e+02 3.16119872e+02
 4.94603620e+01 5.74590041e+00 1.57667804e+01 6.96498305e-01
 2.21600768e+00 2.07176805e-01]
E = -525.5403913539984
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5084044        1
[INPUT] 0    0    [1    /1   ]  7618.24463254        1
[INPUT] 0    0    [1    /1   ]  3618.23842545        1
[INPUT] 0    0    [1    /1   ]  1618.06147818        1
[INPUT] 0    0    [1    /1   ]  239.768615016        1
[INPUT] 0    0    [1    /1   ]  52.1043893352        1
[INPUT] 0    0    [1    /1   ]  4.60166795238        1
[INPUT] 0    0    [1    /1   ]  0.398779520211       1
[INPUT] 1    0    [1    /1   ]  1362.79262797        1
[INPUT] 1    0    [1    /1   ]  665.175142465        1
[INPUT] 1    0    [1    /1   ]  303.290470837        1
[INPUT] 1    0    [1    /1   ]  316.11987238         1
[INPUT] 1    0    [1    /1   ]  49.4603620016        1
[INPUT] 1    0    [1    /1   ]  5.74590041179        1
[INPUT] 1    0    [1    /1   ]  15.7667804025        1
[INPUT] 1    0    [1    /1   ]  0.69649830503        1
[INPUT] 1    0    [1    /1   ]  2.21600767525        1
[INPUT] 1    0    [1    /1   ]  0.207176804759       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508404434466, 1.0]], [0, [7618.244632543634, 1.0]], [0, [3618.2384254464855, 1.0]], [0, [1618.061478184797, 1.0]], [0, [239.7686150161314, 1.0]], [0, [52.10438933523501, 1.0]], [0, [4.601667952378311, 1.0]], [0, [0.3987795202114201, 1.0]], [1, [1362.792627965526, 1.0]], [1, [665.1751424650453, 1.0]], [1, [303.29047083697515, 1.0]], [1, [316.1198723795707, 1.0]], [1, [49.46036200163651, 1.0]], [1, [5.745900411789765, 1.0]], [1, [15.766780402497535, 1.0]], [1, [0.6964983050303297, 1.0]], [1, [2.216007675250586, 1.0]], [1, [0.20717680475890393, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50840443]
bas 1, expnt(s) = [7618.24463254]
bas 2, expnt(s) = [3618.23842545]
bas 3, expnt(s) = [1618.06147818]
bas 4, expnt(s) = [239.76861502]
bas 5, expnt(s) = [52.10438934]
bas 6, expnt(s) = [4.60166795]
bas 7, expnt(s) = [0.39877952]
bas 8, expnt(s) = [1362.79262797]
bas 9, expnt(s) = [665.17514247]
bas 10, expnt(s) = [303.29047084]
bas 11, expnt(s) = [316.11987238]
bas 12, expnt(s) = [49.460362]
bas 13, expnt(s) = [5.74590041]
bas 14, expnt(s) = [15.7667804]
bas 15, expnt(s) = [0.69649831]
bas 16, expnt(s) = [2.21600768]
bas 17, expnt(s) = [0.2071768]
CPU time:       221.36
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825084e+04 5.20024090e+03 7.61824463e+03 2.06018495e+03
 3.61823843e+03 1.17865828e+03 1.61806148e+03 6.44556939e+02
 2.39768615e+02 1.53942762e+02 5.21043893e+01 4.89971430e+01
 4.60166795e+00 7.93782431e+00 3.98779520e-01 1.26784061e+00
 1.36279263e+03 2.41558104e+04 6.65175142e+02 9.85494958e+03
 3.03290471e+02 3.69239241e+03 3.16119872e+02 3.88865254e+03
 4.94603620e+01 3.82653778e+02 5.74590041e+00 2.59526680e+01
 1.57667804e+01 9.16564782e+01 6.96498305e-01 1.85624148e+00
 2.21600768e+00 7.88766519e+00 2.07176805e-01 4.07765808e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.975979356029587
cond(S) = 86056.44004900233
E1 = -727.5362969834537  E_coul = 203.1252761043124
init E= -524.411020879141
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.560160008532106  LUMO = 0.902285301601513
  mo_energy =
[-1.17869555e+02 -1.20940665e+01 -9.44430015e+00 -9.44430015e+00
 -9.44430015e+00 -1.23004482e+00 -5.60160009e-01 -5.60160009e-01
 -5.60160009e-01  9.02285302e-01  9.02285302e-01  9.02285302e-01
  5.64522860e+00  5.64522860e+00  5.64522860e+00  2.46936081e+01
  2.46936081e+01  2.46936081e+01  9.75626003e+01  9.75626003e+01
  9.75626003e+01  1.83457281e+02  4.28882432e+02  4.28882432e+02
  4.28882432e+02  1.28162860e+03  1.28162860e+03  1.28162860e+03
  1.91521644e+03  2.98312091e+03  2.98312091e+03  2.98312091e+03
  6.61166167e+03  6.61166167e+03  6.61166167e+03  8.27332448e+03
  2.46609012e+04  7.54571637e+04]
E1 = -727.2999297066054  E_coul = 201.7597413062718
cycle= 1 E= -525.540188400334  delta_E= -1.13  |g|= 0.182  |ddm|= 0.537
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.454949
diis-c [-0.20697837  1.        ]
  HOMO = -0.57535867411651  LUMO = 0.895703671021261
  mo_energy =
[-1.18118450e+02 -1.21860493e+01 -9.53527709e+00 -9.53527709e+00
 -9.53527709e+00 -1.25393592e+00 -5.75358674e-01 -5.75358674e-01
 -5.75358674e-01  8.95703671e-01  8.95703671e-01  8.95703671e-01
  5.60274806e+00  5.60274806e+00  5.60274806e+00  2.46084455e+01
  2.46084455e+01  2.46084455e+01  9.74116649e+01  9.74116649e+01
  9.74116649e+01  1.83260962e+02  4.28647600e+02  4.28647600e+02
  4.28647600e+02  1.28134385e+03  1.28134385e+03  1.28134385e+03
  1.91481114e+03  2.98277500e+03  2.98277500e+03  2.98277500e+03
  6.61120045e+03  6.61120045e+03  6.61120045e+03  8.27278101e+03
  2.46602640e+04  7.54564352e+04]
E1 = -727.5190993697548  E_coul = 201.97871497332085
cycle= 2 E= -525.540384396434  delta_E= -0.000196  |g|= 0.0158  |ddm|= 0.0148
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0314539
diis-c [-7.66957840e-04  3.17955730e-02  9.68204427e-01]
  HOMO = -0.572514799010584  LUMO = 0.897564409923784
  mo_energy =
[-1.18087187e+02 -1.21706243e+01 -9.51961959e+00 -9.51961959e+00
 -9.51961959e+00 -1.25010612e+00 -5.72514799e-01 -5.72514799e-01
 -5.72514799e-01  8.97564410e-01  8.97564410e-01  8.97564410e-01
  5.60971636e+00  5.60971636e+00  5.60971636e+00  2.46225909e+01
  2.46225909e+01  2.46225909e+01  9.74349016e+01  9.74349016e+01
  9.74349016e+01  1.83291014e+02  4.28678412e+02  4.28678412e+02
  4.28678412e+02  1.28137685e+03  1.28137685e+03  1.28137685e+03
  1.91484556e+03  2.98280903e+03  2.98280903e+03  2.98280903e+03
  6.61123508e+03  6.61123508e+03  6.61123508e+03  8.27281587e+03
  2.46602989e+04  7.54564700e+04]
E1 = -727.4724225144906  E_coul = 201.9320313613518
cycle= 3 E= -525.540391153139  delta_E= -6.76e-06  |g|= 0.00226  |ddm|= 0.004
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00465049
diis-c [-1.21166351e-07 -7.36044287e-04  1.24384013e-01  8.76352031e-01]
  HOMO = -0.573105952542232  LUMO = 0.897183556498635
  mo_energy =
[-1.18091529e+02 -1.21730900e+01 -9.52213198e+00 -9.52213198e+00
 -9.52213198e+00 -1.25088043e+00 -5.73105953e-01 -5.73105953e-01
 -5.73105953e-01  8.97183556e-01  8.97183556e-01  8.97183556e-01
  5.60842158e+00  5.60842158e+00  5.60842158e+00  2.46202964e+01
  2.46202964e+01  2.46202964e+01  9.74315019e+01  9.74315019e+01
  9.74315019e+01  1.83286863e+02  4.28674129e+02  4.28674129e+02
  4.28674129e+02  1.28137231e+03  1.28137231e+03  1.28137231e+03
  1.91484080e+03  2.98280434e+03  2.98280434e+03  2.98280434e+03
  6.61123026e+03  6.61123026e+03  6.61123026e+03  8.27281097e+03
  2.46602939e+04  7.54564650e+04]
E1 = -727.4795498911573  E_coul = 201.93915853732884
cycle= 4 E= -525.540391353828  delta_E= -2.01e-07  |g|= 4.29e-05  |ddm|= 0.000637
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.83617e-05
diis-c [-3.85565322e-10 -2.85743888e-05  4.42408213e-03  4.63388041e-02
  9.49265688e-01]
  HOMO = -0.573082323365943  LUMO = 0.897198396283785
  mo_energy =
[-1.18091433e+02 -1.21730099e+01 -9.52205092e+00 -9.52205092e+00
 -9.52205092e+00 -1.25084936e+00 -5.73082323e-01 -5.73082323e-01
 -5.73082323e-01  8.97198396e-01  8.97198396e-01  8.97198396e-01
  5.60847024e+00  5.60847024e+00  5.60847024e+00  2.46203708e+01
  2.46203708e+01  2.46203708e+01  9.74315909e+01  9.74315909e+01
  9.74315909e+01  1.83286958e+02  4.28674225e+02  4.28674225e+02
  4.28674225e+02  1.28137240e+03  1.28137240e+03  1.28137240e+03
  1.91484089e+03  2.98280444e+03  2.98280444e+03  2.98280444e+03
  6.61123035e+03  6.61123035e+03  6.61123035e+03  8.27281106e+03
  2.46602940e+04  7.54564651e+04]
E1 = -727.4793365332902  E_coul = 201.9389451792924
cycle= 5 E= -525.540391353998  delta_E= -1.69e-10  |g|= 2.43e-06  |ddm|= 2.38e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4793365332902  E_coul = 201.9389451792924
  HOMO = -0.573083838702442  LUMO = 0.897197426710448
  mo_energy =
[-1.18091439e+02 -1.21730145e+01 -9.52205565e+00 -9.52205565e+00
 -9.52205565e+00 -1.25085129e+00 -5.73083839e-01 -5.73083839e-01
 -5.73083839e-01  8.97197427e-01  8.97197427e-01  8.97197427e-01
  5.60846728e+00  5.60846728e+00  5.60846728e+00  2.46203664e+01
  2.46203664e+01  2.46203664e+01  9.74315854e+01  9.74315854e+01
  9.74315854e+01  1.83286952e+02  4.28674219e+02  4.28674219e+02
  4.28674219e+02  1.28137240e+03  1.28137240e+03  1.28137240e+03
  1.91484089e+03  2.98280443e+03  2.98280443e+03  2.98280443e+03
  6.61123035e+03  6.61123035e+03  6.61123035e+03  8.27281106e+03
  2.46602940e+04  7.54564651e+04]
E1 = -727.4793487477176  E_coul = 201.93895739371922
Extra cycle  E= -525.540391353998  delta_E= -6.82e-13  |g|= 5.93e-07  |ddm|= 1.15e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 86056.44004900233
E1 = -727.4793487477176  E_coul = 201.93895739371922
init E= -525.540391353998
    CPU time for initialize scf      0.95 sec, wall time      0.19 sec
  HOMO = -0.573083608750302  LUMO = 0.897197572705229
  mo_energy =
[-1.18091437e+02 -1.21730136e+01 -9.52205473e+00 -9.52205473e+00
 -9.52205473e+00 -1.25085099e+00 -5.73083609e-01 -5.73083609e-01
 -5.73083609e-01  8.97197573e-01  8.97197573e-01  8.97197573e-01
  5.60846778e+00  5.60846778e+00  5.60846778e+00  2.46203673e+01
  2.46203673e+01  2.46203673e+01  9.74315866e+01  9.74315866e+01
  9.74315866e+01  1.83286954e+02  4.28674220e+02  4.28674220e+02
  4.28674220e+02  1.28137240e+03  1.28137240e+03  1.28137240e+03
  1.91484089e+03  2.98280443e+03  2.98280443e+03  2.98280443e+03
  6.61123035e+03  6.61123035e+03  6.61123035e+03  8.27281106e+03
  2.46602940e+04  7.54564651e+04]
E1 = -727.4793461704304  E_coul = 201.93895481643247
cycle= 1 E= -525.540391353998  delta_E= 4.55e-13  |g|= 1.34e-07  |ddm|= 2.55e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4793461704304  E_coul = 201.93895481643247
  HOMO = -0.573083656965928  LUMO = 0.897197541761367
  mo_energy =
[-1.18091438e+02 -1.21730138e+01 -9.52205492e+00 -9.52205492e+00
 -9.52205492e+00 -1.25085105e+00 -5.73083657e-01 -5.73083657e-01
 -5.73083657e-01  8.97197542e-01  8.97197542e-01  8.97197542e-01
  5.60846768e+00  5.60846768e+00  5.60846768e+00  2.46203671e+01
  2.46203671e+01  2.46203671e+01  9.74315863e+01  9.74315863e+01
  9.74315863e+01  1.83286953e+02  4.28674220e+02  4.28674220e+02
  4.28674220e+02  1.28137240e+03  1.28137240e+03  1.28137240e+03
  1.91484089e+03  2.98280443e+03  2.98280443e+03  2.98280443e+03
  6.61123035e+03  6.61123035e+03  6.61123035e+03  8.27281106e+03
  2.46602940e+04  7.54564651e+04]
E1 = -727.4793467075467  E_coul = 201.93895535354875
Extra cycle  E= -525.540391353998  delta_E=    0  |g|= 2.86e-08  |ddm|= 4.94e-08
    CPU time for scf_cycle      1.06 sec, wall time      0.30 sec
exp = [2.61825084e+04 7.61824463e+03 3.61823843e+03 1.61806148e+03
 2.39768615e+02 5.21043893e+01 4.60166795e+00 3.98779520e-01
 1.36279263e+03 6.65175142e+02 3.03290471e+02 3.16119872e+02
 4.94603620e+01 5.74590041e+00 1.57667804e+01 6.96498305e-01
 2.21600768e+00 2.07176805e-01]
grad_E = [-1.98690443e-06  2.19914318e-05  4.41143863e-05  6.76484558e-04
  1.78665381e-04 -1.58368807e-03 -1.04314488e-03 -1.82159497e-03
  1.62735940e-06  2.20548433e-05  1.20716417e-04  1.06354910e-04
 -2.07017409e-03 -2.30177373e-04 -7.89618363e-04  6.15180473e-03
  3.47300690e-05  5.34684159e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5085276        1
[INPUT] 0    0    [1    /1   ]  7618.24326358        1
[INPUT] 0    0    [1    /1   ]  3618.2356735         1
[INPUT] 0    0    [1    /1   ]  1618.01933205        1
[INPUT] 0    0    [1    /1   ]  239.77209219         1
[INPUT] 0    0    [1    /1   ]  52.0988491981        1
[INPUT] 0    0    [1    /1   ]  4.60063662244        1
[INPUT] 0    0    [1    /1   ]  0.398621691401       1
[INPUT] 1    0    [1    /1   ]  1362.79251729        1
[INPUT] 1    0    [1    /1   ]  665.173706427        1
[INPUT] 1    0    [1    /1   ]  303.282573032        1
[INPUT] 1    0    [1    /1   ]  316.11291282         1
[INPUT] 1    0    [1    /1   ]  49.6225856089        1
[INPUT] 1    0    [1    /1   ]  5.72436745987        1
[INPUT] 1    0    [1    /1   ]  15.7285100004        1
[INPUT] 1    0    [1    /1   ]  0.700369999334       1
[INPUT] 1    0    [1    /1   ]  2.20997898476        1
[INPUT] 1    0    [1    /1   ]  0.208499210672       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508527638394, 1.0]], [0, [7618.243263581587, 1.0]], [0, [3618.2356734994764, 1.0]], [0, [1618.0193320458723, 1.0]], [0, [239.7720921898645, 1.0]], [0, [52.098849198146084, 1.0]], [0, [4.60063662243941, 1.0]], [0, [0.3986216914014459, 1.0]], [1, [1362.7925172947348, 1.0]], [1, [665.1737064266791, 1.0]], [1, [303.2825730318959, 1.0]], [1, [316.1129128200781, 1.0]], [1, [49.622585608862146, 1.0]], [1, [5.724367459871434, 1.0]], [1, [15.728510000428777, 1.0]], [1, [0.700369999333754, 1.0]], [1, [2.209978984761048, 1.0]], [1, [0.20849921067220867, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50852764]
bas 1, expnt(s) = [7618.24326358]
bas 2, expnt(s) = [3618.2356735]
bas 3, expnt(s) = [1618.01933205]
bas 4, expnt(s) = [239.77209219]
bas 5, expnt(s) = [52.0988492]
bas 6, expnt(s) = [4.60063662]
bas 7, expnt(s) = [0.39862169]
bas 8, expnt(s) = [1362.79251729]
bas 9, expnt(s) = [665.17370643]
bas 10, expnt(s) = [303.28257303]
bas 11, expnt(s) = [316.11291282]
bas 12, expnt(s) = [49.62258561]
bas 13, expnt(s) = [5.72436746]
bas 14, expnt(s) = [15.72851]
bas 15, expnt(s) = [0.70037]
bas 16, expnt(s) = [2.20997898]
bas 17, expnt(s) = [0.20849921]
CPU time:       227.19
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825085e+04 5.20024092e+03 7.61824326e+03 2.06018467e+03
 3.61823567e+03 1.17865760e+03 1.61801933e+03 6.44544347e+02
 2.39772092e+02 1.53944437e+02 5.20988492e+01 4.89932356e+01
 4.60063662e+00 7.93649000e+00 3.98621691e-01 1.26746425e+00
 1.36279252e+03 2.41558079e+04 6.65173706e+02 9.85492299e+03
 3.03282573e+02 3.69227222e+03 3.16112913e+02 3.88854553e+03
 4.96225856e+01 3.84223240e+02 5.72436746e+00 2.58311519e+01
 1.57285100e+01 9.13784677e+01 7.00369999e-01 1.86914852e+00
 2.20997898e+00 7.86085114e+00 2.08499211e-01 4.11021852e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.975888494900413
cond(S) = 86151.01379779492
E1 = -727.5326125993403  E_coul = 203.12087726667457
init E= -524.411735332666
    CPU time for initialize scf      0.15 sec, wall time      0.04 sec
  HOMO = -0.560214498304417  LUMO = 0.910037591129426
  mo_energy =
[-1.17870089e+02 -1.20943580e+01 -9.44473112e+00 -9.44473112e+00
 -9.44473112e+00 -1.23007928e+00 -5.60214498e-01 -5.60214498e-01
 -5.60214498e-01  9.10037591e-01  9.10037591e-01  9.10037591e-01
  5.65172868e+00  5.65172868e+00  5.65172868e+00  2.46171517e+01
  2.46171517e+01  2.46171517e+01  9.75295229e+01  9.75295229e+01
  9.75295229e+01  1.83438683e+02  4.29169870e+02  4.29169870e+02
  4.29169870e+02  1.28197804e+03  1.28197804e+03  1.28197804e+03
  1.91517955e+03  2.98345754e+03  2.98345754e+03  2.98345754e+03
  6.61196453e+03  6.61196453e+03  6.61196453e+03  8.27322398e+03
  2.46607473e+04  7.54569899e+04]
E1 = -727.3054830988299  E_coul = 201.7650552011324
cycle= 1 E= -525.540427897697  delta_E= -1.13  |g|= 0.182  |ddm|= 0.492
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.455285
diis-c [-0.20728467  1.        ]
  HOMO = -0.575142289835664  LUMO = 0.90354586609604
  mo_energy =
[-1.18118371e+02 -1.21855369e+01 -9.53495503e+00 -9.53495503e+00
 -9.53495503e+00 -1.25360386e+00 -5.75142290e-01 -5.75142290e-01
 -5.75142290e-01  9.03545866e-01  9.03545866e-01  9.03545866e-01
  5.60982207e+00  5.60982207e+00  5.60982207e+00  2.45328344e+01
  2.45328344e+01  2.45328344e+01  9.73791204e+01  9.73791204e+01
  9.73791204e+01  1.83243090e+02  4.28935622e+02  4.28935622e+02
  4.28935622e+02  1.28169380e+03  1.28169380e+03  1.28169380e+03
  1.91477460e+03  2.98311207e+03  2.98311207e+03  2.98311207e+03
  6.61150365e+03  6.61150365e+03  6.61150365e+03  8.27268077e+03
  2.46601103e+04  7.54562617e+04]
E1 = -727.5228989176488  E_coul = 201.98227604073034
cycle= 2 E= -525.540622876919  delta_E= -0.000195  |g|= 0.0158  |ddm|= 0.0146
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.031333
diis-c [-7.61251805e-04  3.16415633e-02  9.68358437e-01]
  HOMO = -0.57234052296689  LUMO = 0.905392484493627
  mo_energy =
[-1.18087259e+02 -1.21702358e+01 -9.51942277e+00 -9.51942277e+00
 -9.51942277e+00 -1.24982959e+00 -5.72340523e-01 -5.72340523e-01
 -5.72340523e-01  9.05392484e-01  9.05392484e-01  9.05392484e-01
  5.61669701e+00  5.61669701e+00  5.61669701e+00  2.45468389e+01
  2.45468389e+01  2.45468389e+01  9.74022351e+01  9.74022351e+01
  9.74022351e+01  1.83272995e+02  4.28966288e+02  4.28966288e+02
  4.28966288e+02  1.28172665e+03  1.28172665e+03  1.28172665e+03
  1.91480888e+03  2.98314595e+03  2.98314595e+03  2.98314595e+03
  6.61153812e+03  6.61153812e+03  6.61153812e+03  8.27271547e+03
  2.46601451e+04  7.54562963e+04]
E1 = -727.4766080399382  E_coul = 201.93597849593166
cycle= 3 E= -525.540629544007  delta_E= -6.67e-06  |g|= 0.00225  |ddm|= 0.00395
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00462431
diis-c [-1.21941939e-07 -7.36059026e-04  1.24154817e-01  8.76581242e-01]
  HOMO = -0.572926388345574  LUMO = 0.905012456521611
  mo_energy =
[-1.18091576e+02 -1.21726840e+01 -9.52191743e+00 -9.52191743e+00
 -9.52191743e+00 -1.25059683e+00 -5.72926388e-01 -5.72926388e-01
 -5.72926388e-01  9.05012457e-01  9.05012457e-01  9.05012457e-01
  5.61541461e+00  5.61541461e+00  5.61541461e+00  2.45445639e+01
  2.45445639e+01  2.45445639e+01  9.73988548e+01  9.73988548e+01
  9.73988548e+01  1.83268868e+02  4.28962029e+02  4.28962029e+02
  4.28962029e+02  1.28172213e+03  1.28172213e+03  1.28172213e+03
  1.91480413e+03  2.98314129e+03  2.98314129e+03  2.98314129e+03
  6.61153332e+03  6.61153332e+03  6.61153332e+03  8.27271060e+03
  2.46601401e+04  7.54562914e+04]
E1 = -727.4836785926095  E_coul = 201.94304885080638
cycle= 4 E= -525.540629741803  delta_E= -1.98e-07  |g|= 4.3e-05  |ddm|= 0.000631
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=7.85689e-05
diis-c [-3.89014040e-10 -2.86346206e-05  4.41478017e-03  4.64622142e-02
  9.49151640e-01]
  HOMO = -0.572902724225803  LUMO = 0.905027413762072
  mo_energy =
[-1.18091480e+02 -1.21726036e+01 -9.52183615e+00 -9.52183615e+00
 -9.52183615e+00 -1.25056571e+00 -5.72902724e-01 -5.72902724e-01
 -5.72902724e-01  9.05027414e-01  9.05027414e-01  9.05027414e-01
  5.61546332e+00  5.61546332e+00  5.61546332e+00  2.45446385e+01
  2.45446385e+01  2.45446385e+01  9.73989441e+01  9.73989441e+01
  9.73989441e+01  1.83268964e+02  4.28962125e+02  4.28962125e+02
  4.28962125e+02  1.28172223e+03  1.28172223e+03  1.28172223e+03
  1.91480423e+03  2.98314138e+03  2.98314138e+03  2.98314138e+03
  6.61153341e+03  6.61153341e+03  6.61153341e+03  8.27271069e+03
  2.46601402e+04  7.54562915e+04]
E1 = -727.483464973568  E_coul = 201.9428352315967
cycle= 5 E= -525.540629741971  delta_E= -1.68e-10  |g|= 2.44e-06  |ddm|= 2.38e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.483464973568  E_coul = 201.9428352315967
  HOMO = -0.572904242534603  LUMO = 0.905026435844884
  mo_energy =
[-1.18091486e+02 -1.21726083e+01 -9.52184090e+00 -9.52184090e+00
 -9.52184090e+00 -1.25056765e+00 -5.72904243e-01 -5.72904243e-01
 -5.72904243e-01  9.05026436e-01  9.05026436e-01  9.05026436e-01
  5.61546035e+00  5.61546035e+00  5.61546035e+00  2.45446341e+01
  2.45446341e+01  2.45446341e+01  9.73989386e+01  9.73989386e+01
  9.73989386e+01  1.83268958e+02  4.28962119e+02  4.28962119e+02
  4.28962119e+02  1.28172222e+03  1.28172222e+03  1.28172222e+03
  1.91480422e+03  2.98314138e+03  2.98314138e+03  2.98314138e+03
  6.61153341e+03  6.61153341e+03  6.61153341e+03  8.27271068e+03
  2.46601402e+04  7.54562914e+04]
E1 = -727.4834772089582  E_coul = 201.94284746698582
Extra cycle  E= -525.540629741972  delta_E= -1.14e-12  |g|= 5.94e-07  |ddm|= 1.15e-06
    CPU time for scf_cycle      0.30 sec, wall time      0.20 sec
exp = [2.61825085e+04 7.61824326e+03 3.61823567e+03 1.61801933e+03
 2.39772092e+02 5.20988492e+01 4.60063662e+00 3.98621691e-01
 1.36279252e+03 6.65173706e+02 3.03282573e+02 3.16112913e+02
 4.96225856e+01 5.72436746e+00 1.57285100e+01 7.00369999e-01
 2.20997898e+00 2.08499211e-01]
E = -525.5406297419725
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5085276        1
[INPUT] 0    0    [1    /1   ]  7618.24326358        1
[INPUT] 0    0    [1    /1   ]  3618.2356735         1
[INPUT] 0    0    [1    /1   ]  1618.01933205        1
[INPUT] 0    0    [1    /1   ]  239.77209219         1
[INPUT] 0    0    [1    /1   ]  52.0988491981        1
[INPUT] 0    0    [1    /1   ]  4.60063662244        1
[INPUT] 0    0    [1    /1   ]  0.398621691401       1
[INPUT] 1    0    [1    /1   ]  1362.79251729        1
[INPUT] 1    0    [1    /1   ]  665.173706427        1
[INPUT] 1    0    [1    /1   ]  303.282573032        1
[INPUT] 1    0    [1    /1   ]  316.11291282         1
[INPUT] 1    0    [1    /1   ]  49.6225856089        1
[INPUT] 1    0    [1    /1   ]  5.72436745987        1
[INPUT] 1    0    [1    /1   ]  15.7285100004        1
[INPUT] 1    0    [1    /1   ]  0.700369999334       1
[INPUT] 1    0    [1    /1   ]  2.20997898476        1
[INPUT] 1    0    [1    /1   ]  0.208499210672       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508527638394, 1.0]], [0, [7618.243263581587, 1.0]], [0, [3618.2356734994764, 1.0]], [0, [1618.0193320458723, 1.0]], [0, [239.7720921898645, 1.0]], [0, [52.098849198146084, 1.0]], [0, [4.60063662243941, 1.0]], [0, [0.3986216914014459, 1.0]], [1, [1362.7925172947348, 1.0]], [1, [665.1737064266791, 1.0]], [1, [303.2825730318959, 1.0]], [1, [316.1129128200781, 1.0]], [1, [49.622585608862146, 1.0]], [1, [5.724367459871434, 1.0]], [1, [15.728510000428777, 1.0]], [1, [0.700369999333754, 1.0]], [1, [2.209978984761048, 1.0]], [1, [0.20849921067220867, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50852764]
bas 1, expnt(s) = [7618.24326358]
bas 2, expnt(s) = [3618.2356735]
bas 3, expnt(s) = [1618.01933205]
bas 4, expnt(s) = [239.77209219]
bas 5, expnt(s) = [52.0988492]
bas 6, expnt(s) = [4.60063662]
bas 7, expnt(s) = [0.39862169]
bas 8, expnt(s) = [1362.79251729]
bas 9, expnt(s) = [665.17370643]
bas 10, expnt(s) = [303.28257303]
bas 11, expnt(s) = [316.11291282]
bas 12, expnt(s) = [49.62258561]
bas 13, expnt(s) = [5.72436746]
bas 14, expnt(s) = [15.72851]
bas 15, expnt(s) = [0.70037]
bas 16, expnt(s) = [2.20997898]
bas 17, expnt(s) = [0.20849921]
CPU time:       227.65
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825085e+04 5.20024092e+03 7.61824326e+03 2.06018467e+03
 3.61823567e+03 1.17865760e+03 1.61801933e+03 6.44544347e+02
 2.39772092e+02 1.53944437e+02 5.20988492e+01 4.89932356e+01
 4.60063662e+00 7.93649000e+00 3.98621691e-01 1.26746425e+00
 1.36279252e+03 2.41558079e+04 6.65173706e+02 9.85492299e+03
 3.03282573e+02 3.69227222e+03 3.16112913e+02 3.88854553e+03
 4.96225856e+01 3.84223240e+02 5.72436746e+00 2.58311519e+01
 1.57285100e+01 9.13784677e+01 7.00369999e-01 1.86914852e+00
 2.20997898e+00 7.86085114e+00 2.08499211e-01 4.11021852e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.975888494900413
cond(S) = 86151.01379779492
E1 = -727.5326125993403  E_coul = 203.12087726667457
init E= -524.411735332666
    CPU time for initialize scf      0.67 sec, wall time      0.07 sec
  HOMO = -0.560214498304417  LUMO = 0.910037591129426
  mo_energy =
[-1.17870089e+02 -1.20943580e+01 -9.44473112e+00 -9.44473112e+00
 -9.44473112e+00 -1.23007928e+00 -5.60214498e-01 -5.60214498e-01
 -5.60214498e-01  9.10037591e-01  9.10037591e-01  9.10037591e-01
  5.65172868e+00  5.65172868e+00  5.65172868e+00  2.46171517e+01
  2.46171517e+01  2.46171517e+01  9.75295229e+01  9.75295229e+01
  9.75295229e+01  1.83438683e+02  4.29169870e+02  4.29169870e+02
  4.29169870e+02  1.28197804e+03  1.28197804e+03  1.28197804e+03
  1.91517955e+03  2.98345754e+03  2.98345754e+03  2.98345754e+03
  6.61196453e+03  6.61196453e+03  6.61196453e+03  8.27322398e+03
  2.46607473e+04  7.54569899e+04]
E1 = -727.3054830988299  E_coul = 201.7650552011324
cycle= 1 E= -525.540427897697  delta_E= -1.13  |g|= 0.182  |ddm|= 0.492
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.455285
diis-c [-0.20728467  1.        ]
  HOMO = -0.575142289835664  LUMO = 0.90354586609604
  mo_energy =
[-1.18118371e+02 -1.21855369e+01 -9.53495503e+00 -9.53495503e+00
 -9.53495503e+00 -1.25360386e+00 -5.75142290e-01 -5.75142290e-01
 -5.75142290e-01  9.03545866e-01  9.03545866e-01  9.03545866e-01
  5.60982207e+00  5.60982207e+00  5.60982207e+00  2.45328344e+01
  2.45328344e+01  2.45328344e+01  9.73791204e+01  9.73791204e+01
  9.73791204e+01  1.83243090e+02  4.28935622e+02  4.28935622e+02
  4.28935622e+02  1.28169380e+03  1.28169380e+03  1.28169380e+03
  1.91477460e+03  2.98311207e+03  2.98311207e+03  2.98311207e+03
  6.61150365e+03  6.61150365e+03  6.61150365e+03  8.27268077e+03
  2.46601103e+04  7.54562617e+04]
E1 = -727.5228989176488  E_coul = 201.98227604073034
cycle= 2 E= -525.540622876919  delta_E= -0.000195  |g|= 0.0158  |ddm|= 0.0146
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.031333
diis-c [-7.61251805e-04  3.16415633e-02  9.68358437e-01]
  HOMO = -0.57234052296689  LUMO = 0.905392484493627
  mo_energy =
[-1.18087259e+02 -1.21702358e+01 -9.51942277e+00 -9.51942277e+00
 -9.51942277e+00 -1.24982959e+00 -5.72340523e-01 -5.72340523e-01
 -5.72340523e-01  9.05392484e-01  9.05392484e-01  9.05392484e-01
  5.61669701e+00  5.61669701e+00  5.61669701e+00  2.45468389e+01
  2.45468389e+01  2.45468389e+01  9.74022351e+01  9.74022351e+01
  9.74022351e+01  1.83272995e+02  4.28966288e+02  4.28966288e+02
  4.28966288e+02  1.28172665e+03  1.28172665e+03  1.28172665e+03
  1.91480888e+03  2.98314595e+03  2.98314595e+03  2.98314595e+03
  6.61153812e+03  6.61153812e+03  6.61153812e+03  8.27271547e+03
  2.46601451e+04  7.54562963e+04]
E1 = -727.4766080399382  E_coul = 201.93597849593166
cycle= 3 E= -525.540629544007  delta_E= -6.67e-06  |g|= 0.00225  |ddm|= 0.00395
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00462431
diis-c [-1.21941939e-07 -7.36059026e-04  1.24154817e-01  8.76581242e-01]
  HOMO = -0.572926388345574  LUMO = 0.905012456521611
  mo_energy =
[-1.18091576e+02 -1.21726840e+01 -9.52191743e+00 -9.52191743e+00
 -9.52191743e+00 -1.25059683e+00 -5.72926388e-01 -5.72926388e-01
 -5.72926388e-01  9.05012457e-01  9.05012457e-01  9.05012457e-01
  5.61541461e+00  5.61541461e+00  5.61541461e+00  2.45445639e+01
  2.45445639e+01  2.45445639e+01  9.73988548e+01  9.73988548e+01
  9.73988548e+01  1.83268868e+02  4.28962029e+02  4.28962029e+02
  4.28962029e+02  1.28172213e+03  1.28172213e+03  1.28172213e+03
  1.91480413e+03  2.98314129e+03  2.98314129e+03  2.98314129e+03
  6.61153332e+03  6.61153332e+03  6.61153332e+03  8.27271060e+03
  2.46601401e+04  7.54562914e+04]
E1 = -727.4836785926095  E_coul = 201.94304885080638
cycle= 4 E= -525.540629741803  delta_E= -1.98e-07  |g|= 4.3e-05  |ddm|= 0.000631
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=7.85689e-05
diis-c [-3.89014040e-10 -2.86346206e-05  4.41478017e-03  4.64622142e-02
  9.49151640e-01]
  HOMO = -0.572902724225803  LUMO = 0.905027413762072
  mo_energy =
[-1.18091480e+02 -1.21726036e+01 -9.52183615e+00 -9.52183615e+00
 -9.52183615e+00 -1.25056571e+00 -5.72902724e-01 -5.72902724e-01
 -5.72902724e-01  9.05027414e-01  9.05027414e-01  9.05027414e-01
  5.61546332e+00  5.61546332e+00  5.61546332e+00  2.45446385e+01
  2.45446385e+01  2.45446385e+01  9.73989441e+01  9.73989441e+01
  9.73989441e+01  1.83268964e+02  4.28962125e+02  4.28962125e+02
  4.28962125e+02  1.28172223e+03  1.28172223e+03  1.28172223e+03
  1.91480423e+03  2.98314138e+03  2.98314138e+03  2.98314138e+03
  6.61153341e+03  6.61153341e+03  6.61153341e+03  8.27271069e+03
  2.46601402e+04  7.54562915e+04]
E1 = -727.483464973568  E_coul = 201.9428352315967
cycle= 5 E= -525.540629741971  delta_E= -1.68e-10  |g|= 2.44e-06  |ddm|= 2.38e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.483464973568  E_coul = 201.9428352315967
  HOMO = -0.572904242534603  LUMO = 0.905026435844884
  mo_energy =
[-1.18091486e+02 -1.21726083e+01 -9.52184090e+00 -9.52184090e+00
 -9.52184090e+00 -1.25056765e+00 -5.72904243e-01 -5.72904243e-01
 -5.72904243e-01  9.05026436e-01  9.05026436e-01  9.05026436e-01
  5.61546035e+00  5.61546035e+00  5.61546035e+00  2.45446341e+01
  2.45446341e+01  2.45446341e+01  9.73989386e+01  9.73989386e+01
  9.73989386e+01  1.83268958e+02  4.28962119e+02  4.28962119e+02
  4.28962119e+02  1.28172222e+03  1.28172222e+03  1.28172222e+03
  1.91480422e+03  2.98314138e+03  2.98314138e+03  2.98314138e+03
  6.61153341e+03  6.61153341e+03  6.61153341e+03  8.27271068e+03
  2.46601402e+04  7.54562914e+04]
E1 = -727.4834772089582  E_coul = 201.94284746698582
Extra cycle  E= -525.540629741972  delta_E= -1.14e-12  |g|= 5.94e-07  |ddm|= 1.15e-06
    CPU time for scf_cycle      0.81 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 86151.01379779492
E1 = -727.4834772089582  E_coul = 201.94284746698582
init E= -525.540629741972
    CPU time for initialize scf      1.82 sec, wall time      0.24 sec
  HOMO = -0.572904012509474  LUMO = 0.90502658285507
  mo_energy =
[-1.18091485e+02 -1.21726073e+01 -9.52183997e+00 -9.52183997e+00
 -9.52183997e+00 -1.25056734e+00 -5.72904013e-01 -5.72904013e-01
 -5.72904013e-01  9.05026583e-01  9.05026583e-01  9.05026583e-01
  5.61546085e+00  5.61546085e+00  5.61546085e+00  2.45446349e+01
  2.45446349e+01  2.45446349e+01  9.73989397e+01  9.73989397e+01
  9.73989397e+01  1.83268960e+02  4.28962121e+02  4.28962121e+02
  4.28962121e+02  1.28172223e+03  1.28172223e+03  1.28172223e+03
  1.91480422e+03  2.98314138e+03  2.98314138e+03  2.98314138e+03
  6.61153341e+03  6.61153341e+03  6.61153341e+03  8.27271068e+03
  2.46601402e+04  7.54562914e+04]
E1 = -727.4834746303007  E_coul = 201.9428448883289
cycle= 1 E= -525.540629741972  delta_E= 5.68e-13  |g|= 1.34e-07  |ddm|= 2.55e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.4834746303007  E_coul = 201.9428448883289
  HOMO = -0.572904060690476  LUMO = 0.905026551725887
  mo_energy =
[-1.18091485e+02 -1.21726075e+01 -9.52184016e+00 -9.52184016e+00
 -9.52184016e+00 -1.25056741e+00 -5.72904061e-01 -5.72904061e-01
 -5.72904061e-01  9.05026552e-01  9.05026552e-01  9.05026552e-01
  5.61546075e+00  5.61546075e+00  5.61546075e+00  2.45446348e+01
  2.45446348e+01  2.45446348e+01  9.73989395e+01  9.73989395e+01
  9.73989395e+01  1.83268959e+02  4.28962120e+02  4.28962120e+02
  4.28962120e+02  1.28172222e+03  1.28172222e+03  1.28172222e+03
  1.91480422e+03  2.98314138e+03  2.98314138e+03  2.98314138e+03
  6.61153341e+03  6.61153341e+03  6.61153341e+03  8.27271068e+03
  2.46601402e+04  7.54562914e+04]
E1 = -727.4834751671306  E_coul = 201.94284542515814
Extra cycle  E= -525.540629741972  delta_E= -5.68e-13  |g|= 2.87e-08  |ddm|= 4.94e-08
    CPU time for scf_cycle      1.93 sec, wall time      0.35 sec
exp = [2.61825085e+04 7.61824326e+03 3.61823567e+03 1.61801933e+03
 2.39772092e+02 5.20988492e+01 4.60063662e+00 3.98621691e-01
 1.36279252e+03 6.65173706e+02 3.03282573e+02 3.16112913e+02
 4.96225856e+01 5.72436746e+00 1.57285100e+01 7.00369999e-01
 2.20997898e+00 2.08499211e-01]
grad_E = [-1.98686941e-06  2.19797869e-05  4.40772231e-05  6.76111685e-04
  2.02549197e-04 -1.74240806e-03 -1.98407340e-03 -3.40287302e-03
  1.49235423e-06  2.11103683e-05  1.15076196e-04  1.01360748e-04
 -1.68244474e-03  4.98529020e-04 -1.98471337e-03  9.75938593e-03
 -4.10039205e-04  3.13684735e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5088952        1
[INPUT] 0    0    [1    /1   ]  7618.23917938        1
[INPUT] 0    0    [1    /1   ]  3618.22746335        1
[INPUT] 0    0    [1    /1   ]  1617.89359698        1
[INPUT] 0    0    [1    /1   ]  239.781494539        1
[INPUT] 0    0    [1    /1   ]  52.090085549         1
[INPUT] 0    0    [1    /1   ]  4.59905137119        1
[INPUT] 0    0    [1    /1   ]  0.398373718647       1
[INPUT] 1    0    [1    /1   ]  1362.79219821        1
[INPUT] 1    0    [1    /1   ]  665.169501607        1
[INPUT] 1    0    [1    /1   ]  303.25949632         1
[INPUT] 1    0    [1    /1   ]  316.092577832        1
[INPUT] 1    0    [1    /1   ]  50.0539485799        1
[INPUT] 1    0    [1    /1   ]  5.7259064054         1
[INPUT] 1    0    [1    /1   ]  15.7511747994        1
[INPUT] 1    0    [1    /1   ]  0.709134489679       1
[INPUT] 1    0    [1    /1   ]  2.21649914015        1
[INPUT] 1    0    [1    /1   ]  0.211138951655       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508895223924, 1.0]], [0, [7618.239179381884, 1.0]], [0, [3618.2274633548745, 1.0]], [0, [1617.8935969848208, 1.0]], [0, [239.78149453931846, 1.0]], [0, [52.090085549029915, 1.0]], [0, [4.5990513711852365, 1.0]], [0, [0.3983737186465831, 1.0]], [1, [1362.7921982107787, 1.0]], [1, [665.1695016065084, 1.0]], [1, [303.2594963201975, 1.0]], [1, [316.09257783232573, 1.0]], [1, [50.05394857987525, 1.0]], [1, [5.725906405403759, 1.0]], [1, [15.751174799395855, 1.0]], [1, [0.7091344896788238, 1.0]], [1, [2.2164991401545806, 1.0]], [1, [0.21113895165488705, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50889522]
bas 1, expnt(s) = [7618.23917938]
bas 2, expnt(s) = [3618.22746335]
bas 3, expnt(s) = [1617.89359698]
bas 4, expnt(s) = [239.78149454]
bas 5, expnt(s) = [52.09008555]
bas 6, expnt(s) = [4.59905137]
bas 7, expnt(s) = [0.39837372]
bas 8, expnt(s) = [1362.79219821]
bas 9, expnt(s) = [665.16950161]
bas 10, expnt(s) = [303.25949632]
bas 11, expnt(s) = [316.09257783]
bas 12, expnt(s) = [50.05394858]
bas 13, expnt(s) = [5.72590641]
bas 14, expnt(s) = [15.7511748]
bas 15, expnt(s) = [0.70913449]
bas 16, expnt(s) = [2.21649914]
bas 17, expnt(s) = [0.21113895]
CPU time:       234.67
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825089e+04 5.20024098e+03 7.61823918e+03 2.06018384e+03
 3.61822746e+03 1.17865560e+03 1.61789360e+03 6.44506782e+02
 2.39781495e+02 1.53948964e+02 5.20900855e+01 4.89870545e+01
 4.59905137e+00 7.93443889e+00 3.98373719e-01 1.26687286e+00
 1.36279220e+03 2.41558009e+04 6.65169502e+02 9.85484511e+03
 3.03259496e+02 3.69192104e+03 3.16092578e+02 3.88823285e+03
 5.00539486e+01 3.88402773e+02 5.72590641e+00 2.58398328e+01
 1.57511748e+01 9.15430929e+01 7.09134490e-01 1.89843247e+00
 2.21649914e+00 7.88985191e+00 2.11138952e-01 4.17536882e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9756604190857
cond(S) = 86562.8956564015
E1 = -727.5270398466304  E_coul = 203.11399326343448
init E= -524.413046583196
    CPU time for initialize scf      0.19 sec, wall time      0.05 sec
  HOMO = -0.560278906581117  LUMO = 0.926508694149405
  mo_energy =
[-1.17870941e+02 -1.20948065e+01 -9.44545937e+00 -9.44545937e+00
 -9.44545937e+00 -1.23013823e+00 -5.60278907e-01 -5.60278907e-01
 -5.60278907e-01  9.26508694e-01  9.26508694e-01  9.26508694e-01
  5.70551732e+00  5.70551732e+00  5.70551732e+00  2.46920615e+01
  2.46920615e+01  2.46920615e+01  9.80588006e+01  9.80588006e+01
  9.80588006e+01  1.83411749e+02  4.30549686e+02  4.30549686e+02
  4.30549686e+02  1.28345790e+03  1.28345790e+03  1.28345790e+03
  1.91509991e+03  2.98486095e+03  2.98486095e+03  2.98486095e+03
  6.61323008e+03  6.61323008e+03  6.61323008e+03  8.27295157e+03
  2.46603141e+04  7.54564958e+04]
E1 = -727.3171957662752  E_coul = 201.7761634297486
cycle= 1 E= -525.541032336527  delta_E= -1.13  |g|= 0.182  |ddm|= 0.419
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.455987
diis-c [-0.20792412  1.        ]
  HOMO = -0.574687247869953  LUMO = 0.920167188973104
  mo_energy =
[-1.18117983e+02 -1.21845487e+01 -9.53432718e+00 -9.53432718e+00
 -9.53432718e+00 -1.25297611e+00 -5.74687248e-01 -5.74687248e-01
 -5.74687248e-01  9.20167189e-01  9.20167189e-01  9.20167189e-01
  5.66441038e+00  5.66441038e+00  5.66441038e+00  2.46089658e+01
  2.46089658e+01  2.46089658e+01  9.79092351e+01  9.79092351e+01
  9.79092351e+01  1.83217563e+02  4.30316668e+02  4.30316668e+02
  4.30316668e+02  1.28317481e+03  1.28317481e+03  1.28317481e+03
  1.91469584e+03  2.98451648e+03  2.98451648e+03  2.98451648e+03
  6.61277003e+03  6.61277003e+03  6.61277003e+03  8.27240909e+03
  2.46596778e+04  7.54557681e+04]
E1 = -727.5312854139614  E_coul = 201.99006029718086
cycle= 2 E= -525.541225116781  delta_E= -0.000193  |g|= 0.0157  |ddm|= 0.0143
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0311249
diis-c [-7.51272404e-04  3.13835665e-02  9.68616434e-01]
  HOMO = -0.571961245596587  LUMO = 0.921995007851546
  mo_energy =
[-1.18087170e+02 -1.21694843e+01 -9.51903434e+00 -9.51903434e+00
 -9.51903434e+00 -1.24930215e+00 -5.71961246e-01 -5.71961246e-01
 -5.71961246e-01  9.21995008e-01  9.21995008e-01  9.21995008e-01
  5.67115505e+00  5.67115505e+00  5.67115505e+00  2.46227545e+01
  2.46227545e+01  2.46227545e+01  9.79321304e+01  9.79321304e+01
  9.79321304e+01  1.83247177e+02  4.30347040e+02  4.30347040e+02
  4.30347040e+02  1.28320735e+03  1.28320735e+03  1.28320735e+03
  1.91472980e+03  2.98455005e+03  2.98455005e+03  2.98455005e+03
  6.61280418e+03  6.61280418e+03  6.61280418e+03  8.27244346e+03
  2.46597122e+04  7.54558024e+04]
E1 = -727.4857620015765  E_coul = 201.94453039261705
cycle= 3 E= -525.541231608959  delta_E= -6.49e-06  |g|= 0.00223  |ddm|= 0.00388
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0045769
diis-c [-1.21920807e-07 -7.36452398e-04  1.23695077e-01  8.77041376e-01]
  HOMO = -0.572536044223981  LUMO = 0.921616210640119
  mo_energy =
[-1.18091436e+02 -1.21718963e+01 -9.52149261e+00 -9.52149261e+00
 -9.52149261e+00 -1.25005480e+00 -5.72536044e-01 -5.72536044e-01
 -5.72536044e-01  9.21616211e-01  9.21616211e-01  9.21616211e-01
  5.66989128e+00  5.66989128e+00  5.66989128e+00  2.46205125e+01
  2.46205125e+01  2.46205125e+01  9.79287881e+01  9.79287881e+01
  9.79287881e+01  1.83243100e+02  4.30342832e+02  4.30342832e+02
  4.30342832e+02  1.28320289e+03  1.28320289e+03  1.28320289e+03
  1.91472511e+03  2.98454544e+03  2.98454544e+03  2.98454544e+03
  6.61279944e+03  6.61279944e+03  6.61279944e+03  8.27243864e+03
  2.46597073e+04  7.54557975e+04]
E1 = -727.4927144726435  E_coul = 201.951482671817
cycle= 4 E= -525.541231800826  delta_E= -1.92e-07  |g|= 4.3e-05  |ddm|= 0.000619
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.85663e-05
diis-c [-3.93422797e-10 -2.88156620e-05  4.40482849e-03  4.66756807e-02
  9.48948307e-01]
  HOMO = -0.572512378634984  LUMO = 0.921631401985235
  mo_energy =
[-1.18091339e+02 -1.21718159e+01 -9.52141126e+00 -9.52141126e+00
 -9.52141126e+00 -1.25002370e+00 -5.72512379e-01 -5.72512379e-01
 -5.72512379e-01  9.21631402e-01  9.21631402e-01  9.21631402e-01
  5.66994013e+00  5.66994013e+00  5.66994013e+00  2.46205872e+01
  2.46205872e+01  2.46205872e+01  9.79288776e+01  9.79288776e+01
  9.79288776e+01  1.83243196e+02  4.30342928e+02  4.30342928e+02
  4.30342928e+02  1.28320298e+03  1.28320298e+03  1.28320298e+03
  1.91472521e+03  2.98454553e+03  2.98454553e+03  2.98454553e+03
  6.61279954e+03  6.61279954e+03  6.61279954e+03  8.27243874e+03
  2.46597074e+04  7.54557976e+04]
E1 = -727.4925016533998  E_coul = 201.951269852404
cycle= 5 E= -525.541231800996  delta_E= -1.69e-10  |g|= 2.44e-06  |ddm|= 2.37e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4925016533998  E_coul = 201.951269852404
  HOMO = -0.572513887255484  LUMO = 0.921630415889566
  mo_energy =
[-1.18091345e+02 -1.21718206e+01 -9.52141600e+00 -9.52141600e+00
 -9.52141600e+00 -1.25002562e+00 -5.72513887e-01 -5.72513887e-01
 -5.72513887e-01  9.21630416e-01  9.21630416e-01  9.21630416e-01
  5.66993717e+00  5.66993717e+00  5.66993717e+00  2.46205828e+01
  2.46205828e+01  2.46205828e+01  9.79288721e+01  9.79288721e+01
  9.79288721e+01  1.83243190e+02  4.30342922e+02  4.30342922e+02
  4.30342922e+02  1.28320298e+03  1.28320298e+03  1.28320298e+03
  1.91472520e+03  2.98454553e+03  2.98454553e+03  2.98454553e+03
  6.61279953e+03  6.61279953e+03  6.61279953e+03  8.27243873e+03
  2.46597074e+04  7.54557976e+04]
E1 = -727.4925138643067  E_coul = 201.95128206331043
Extra cycle  E= -525.541231800996  delta_E= -4.55e-13  |g|= 5.94e-07  |ddm|= 1.15e-06
    CPU time for scf_cycle      0.38 sec, wall time      0.24 sec
exp = [2.61825089e+04 7.61823918e+03 3.61822746e+03 1.61789360e+03
 2.39781495e+02 5.20900855e+01 4.59905137e+00 3.98373719e-01
 1.36279220e+03 6.65169502e+02 3.03259496e+02 3.16092578e+02
 5.00539486e+01 5.72590641e+00 1.57511748e+01 7.09134490e-01
 2.21649914e+00 2.11138952e-01]
E = -525.5412318009962
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5088952        1
[INPUT] 0    0    [1    /1   ]  7618.23917938        1
[INPUT] 0    0    [1    /1   ]  3618.22746335        1
[INPUT] 0    0    [1    /1   ]  1617.89359698        1
[INPUT] 0    0    [1    /1   ]  239.781494539        1
[INPUT] 0    0    [1    /1   ]  52.090085549         1
[INPUT] 0    0    [1    /1   ]  4.59905137119        1
[INPUT] 0    0    [1    /1   ]  0.398373718647       1
[INPUT] 1    0    [1    /1   ]  1362.79219821        1
[INPUT] 1    0    [1    /1   ]  665.169501607        1
[INPUT] 1    0    [1    /1   ]  303.25949632         1
[INPUT] 1    0    [1    /1   ]  316.092577832        1
[INPUT] 1    0    [1    /1   ]  50.0539485799        1
[INPUT] 1    0    [1    /1   ]  5.7259064054         1
[INPUT] 1    0    [1    /1   ]  15.7511747994        1
[INPUT] 1    0    [1    /1   ]  0.709134489679       1
[INPUT] 1    0    [1    /1   ]  2.21649914015        1
[INPUT] 1    0    [1    /1   ]  0.211138951655       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.508895223924, 1.0]], [0, [7618.239179381884, 1.0]], [0, [3618.2274633548745, 1.0]], [0, [1617.8935969848208, 1.0]], [0, [239.78149453931846, 1.0]], [0, [52.090085549029915, 1.0]], [0, [4.5990513711852365, 1.0]], [0, [0.3983737186465831, 1.0]], [1, [1362.7921982107787, 1.0]], [1, [665.1695016065084, 1.0]], [1, [303.2594963201975, 1.0]], [1, [316.09257783232573, 1.0]], [1, [50.05394857987525, 1.0]], [1, [5.725906405403759, 1.0]], [1, [15.751174799395855, 1.0]], [1, [0.7091344896788238, 1.0]], [1, [2.2164991401545806, 1.0]], [1, [0.21113895165488705, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50889522]
bas 1, expnt(s) = [7618.23917938]
bas 2, expnt(s) = [3618.22746335]
bas 3, expnt(s) = [1617.89359698]
bas 4, expnt(s) = [239.78149454]
bas 5, expnt(s) = [52.09008555]
bas 6, expnt(s) = [4.59905137]
bas 7, expnt(s) = [0.39837372]
bas 8, expnt(s) = [1362.79219821]
bas 9, expnt(s) = [665.16950161]
bas 10, expnt(s) = [303.25949632]
bas 11, expnt(s) = [316.09257783]
bas 12, expnt(s) = [50.05394858]
bas 13, expnt(s) = [5.72590641]
bas 14, expnt(s) = [15.7511748]
bas 15, expnt(s) = [0.70913449]
bas 16, expnt(s) = [2.21649914]
bas 17, expnt(s) = [0.21113895]
CPU time:       235.23
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825089e+04 5.20024098e+03 7.61823918e+03 2.06018384e+03
 3.61822746e+03 1.17865560e+03 1.61789360e+03 6.44506782e+02
 2.39781495e+02 1.53948964e+02 5.20900855e+01 4.89870545e+01
 4.59905137e+00 7.93443889e+00 3.98373719e-01 1.26687286e+00
 1.36279220e+03 2.41558009e+04 6.65169502e+02 9.85484511e+03
 3.03259496e+02 3.69192104e+03 3.16092578e+02 3.88823285e+03
 5.00539486e+01 3.88402773e+02 5.72590641e+00 2.58398328e+01
 1.57511748e+01 9.15430929e+01 7.09134490e-01 1.89843247e+00
 2.21649914e+00 7.88985191e+00 2.11138952e-01 4.17536882e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9756604190857
cond(S) = 86562.8956564015
E1 = -727.5270398466304  E_coul = 203.11399326343448
init E= -524.413046583196
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.560278906581117  LUMO = 0.926508694149405
  mo_energy =
[-1.17870941e+02 -1.20948065e+01 -9.44545937e+00 -9.44545937e+00
 -9.44545937e+00 -1.23013823e+00 -5.60278907e-01 -5.60278907e-01
 -5.60278907e-01  9.26508694e-01  9.26508694e-01  9.26508694e-01
  5.70551732e+00  5.70551732e+00  5.70551732e+00  2.46920615e+01
  2.46920615e+01  2.46920615e+01  9.80588006e+01  9.80588006e+01
  9.80588006e+01  1.83411749e+02  4.30549686e+02  4.30549686e+02
  4.30549686e+02  1.28345790e+03  1.28345790e+03  1.28345790e+03
  1.91509991e+03  2.98486095e+03  2.98486095e+03  2.98486095e+03
  6.61323008e+03  6.61323008e+03  6.61323008e+03  8.27295157e+03
  2.46603141e+04  7.54564958e+04]
E1 = -727.3171957662752  E_coul = 201.7761634297486
cycle= 1 E= -525.541032336527  delta_E= -1.13  |g|= 0.182  |ddm|= 0.419
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.455987
diis-c [-0.20792412  1.        ]
  HOMO = -0.574687247869953  LUMO = 0.920167188973104
  mo_energy =
[-1.18117983e+02 -1.21845487e+01 -9.53432718e+00 -9.53432718e+00
 -9.53432718e+00 -1.25297611e+00 -5.74687248e-01 -5.74687248e-01
 -5.74687248e-01  9.20167189e-01  9.20167189e-01  9.20167189e-01
  5.66441038e+00  5.66441038e+00  5.66441038e+00  2.46089658e+01
  2.46089658e+01  2.46089658e+01  9.79092351e+01  9.79092351e+01
  9.79092351e+01  1.83217563e+02  4.30316668e+02  4.30316668e+02
  4.30316668e+02  1.28317481e+03  1.28317481e+03  1.28317481e+03
  1.91469584e+03  2.98451648e+03  2.98451648e+03  2.98451648e+03
  6.61277003e+03  6.61277003e+03  6.61277003e+03  8.27240909e+03
  2.46596778e+04  7.54557681e+04]
E1 = -727.5312854139614  E_coul = 201.99006029718086
cycle= 2 E= -525.541225116781  delta_E= -0.000193  |g|= 0.0157  |ddm|= 0.0143
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0311249
diis-c [-7.51272404e-04  3.13835665e-02  9.68616434e-01]
  HOMO = -0.571961245596587  LUMO = 0.921995007851546
  mo_energy =
[-1.18087170e+02 -1.21694843e+01 -9.51903434e+00 -9.51903434e+00
 -9.51903434e+00 -1.24930215e+00 -5.71961246e-01 -5.71961246e-01
 -5.71961246e-01  9.21995008e-01  9.21995008e-01  9.21995008e-01
  5.67115505e+00  5.67115505e+00  5.67115505e+00  2.46227545e+01
  2.46227545e+01  2.46227545e+01  9.79321304e+01  9.79321304e+01
  9.79321304e+01  1.83247177e+02  4.30347040e+02  4.30347040e+02
  4.30347040e+02  1.28320735e+03  1.28320735e+03  1.28320735e+03
  1.91472980e+03  2.98455005e+03  2.98455005e+03  2.98455005e+03
  6.61280418e+03  6.61280418e+03  6.61280418e+03  8.27244346e+03
  2.46597122e+04  7.54558024e+04]
E1 = -727.4857620015765  E_coul = 201.94453039261705
cycle= 3 E= -525.541231608959  delta_E= -6.49e-06  |g|= 0.00223  |ddm|= 0.00388
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0045769
diis-c [-1.21920807e-07 -7.36452398e-04  1.23695077e-01  8.77041376e-01]
  HOMO = -0.572536044223981  LUMO = 0.921616210640119
  mo_energy =
[-1.18091436e+02 -1.21718963e+01 -9.52149261e+00 -9.52149261e+00
 -9.52149261e+00 -1.25005480e+00 -5.72536044e-01 -5.72536044e-01
 -5.72536044e-01  9.21616211e-01  9.21616211e-01  9.21616211e-01
  5.66989128e+00  5.66989128e+00  5.66989128e+00  2.46205125e+01
  2.46205125e+01  2.46205125e+01  9.79287881e+01  9.79287881e+01
  9.79287881e+01  1.83243100e+02  4.30342832e+02  4.30342832e+02
  4.30342832e+02  1.28320289e+03  1.28320289e+03  1.28320289e+03
  1.91472511e+03  2.98454544e+03  2.98454544e+03  2.98454544e+03
  6.61279944e+03  6.61279944e+03  6.61279944e+03  8.27243864e+03
  2.46597073e+04  7.54557975e+04]
E1 = -727.4927144726435  E_coul = 201.951482671817
cycle= 4 E= -525.541231800826  delta_E= -1.92e-07  |g|= 4.3e-05  |ddm|= 0.000619
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.85663e-05
diis-c [-3.93422797e-10 -2.88156620e-05  4.40482849e-03  4.66756807e-02
  9.48948307e-01]
  HOMO = -0.572512378634984  LUMO = 0.921631401985235
  mo_energy =
[-1.18091339e+02 -1.21718159e+01 -9.52141126e+00 -9.52141126e+00
 -9.52141126e+00 -1.25002370e+00 -5.72512379e-01 -5.72512379e-01
 -5.72512379e-01  9.21631402e-01  9.21631402e-01  9.21631402e-01
  5.66994013e+00  5.66994013e+00  5.66994013e+00  2.46205872e+01
  2.46205872e+01  2.46205872e+01  9.79288776e+01  9.79288776e+01
  9.79288776e+01  1.83243196e+02  4.30342928e+02  4.30342928e+02
  4.30342928e+02  1.28320298e+03  1.28320298e+03  1.28320298e+03
  1.91472521e+03  2.98454553e+03  2.98454553e+03  2.98454553e+03
  6.61279954e+03  6.61279954e+03  6.61279954e+03  8.27243874e+03
  2.46597074e+04  7.54557976e+04]
E1 = -727.4925016533998  E_coul = 201.951269852404
cycle= 5 E= -525.541231800996  delta_E= -1.69e-10  |g|= 2.44e-06  |ddm|= 2.37e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4925016533998  E_coul = 201.951269852404
  HOMO = -0.572513887255484  LUMO = 0.921630415889566
  mo_energy =
[-1.18091345e+02 -1.21718206e+01 -9.52141600e+00 -9.52141600e+00
 -9.52141600e+00 -1.25002562e+00 -5.72513887e-01 -5.72513887e-01
 -5.72513887e-01  9.21630416e-01  9.21630416e-01  9.21630416e-01
  5.66993717e+00  5.66993717e+00  5.66993717e+00  2.46205828e+01
  2.46205828e+01  2.46205828e+01  9.79288721e+01  9.79288721e+01
  9.79288721e+01  1.83243190e+02  4.30342922e+02  4.30342922e+02
  4.30342922e+02  1.28320298e+03  1.28320298e+03  1.28320298e+03
  1.91472520e+03  2.98454553e+03  2.98454553e+03  2.98454553e+03
  6.61279953e+03  6.61279953e+03  6.61279953e+03  8.27243873e+03
  2.46597074e+04  7.54557976e+04]
E1 = -727.4925138643067  E_coul = 201.95128206331043
Extra cycle  E= -525.541231800996  delta_E= -4.55e-13  |g|= 5.94e-07  |ddm|= 1.15e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 86562.8956564015
E1 = -727.4925138643067  E_coul = 201.95128206331043
init E= -525.541231800996
    CPU time for initialize scf      0.98 sec, wall time      0.20 sec
  HOMO = -0.572513658051393  LUMO = 0.921630564722812
  mo_energy =
[-1.18091344e+02 -1.21718197e+01 -9.52141508e+00 -9.52141508e+00
 -9.52141508e+00 -1.25002531e+00 -5.72513658e-01 -5.72513658e-01
 -5.72513658e-01  9.21630565e-01  9.21630565e-01  9.21630565e-01
  5.66993766e+00  5.66993766e+00  5.66993766e+00  2.46205836e+01
  2.46205836e+01  2.46205836e+01  9.79288732e+01  9.79288732e+01
  9.79288732e+01  1.83243192e+02  4.30342923e+02  4.30342923e+02
  4.30342923e+02  1.28320298e+03  1.28320298e+03  1.28320298e+03
  1.91472520e+03  2.98454553e+03  2.98454553e+03  2.98454553e+03
  6.61279953e+03  6.61279953e+03  6.61279953e+03  8.27243873e+03
  2.46597074e+04  7.54557976e+04]
E1 = -727.492511300023  E_coul = 201.95127949902596
cycle= 1 E= -525.541231800997  delta_E= -7.96e-13  |g|= 1.33e-07  |ddm|= 2.54e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.492511300023  E_coul = 201.95127949902596
  HOMO = -0.572513705799878  LUMO = 0.921630533389256
  mo_energy =
[-1.18091344e+02 -1.21718199e+01 -9.52141527e+00 -9.52141527e+00
 -9.52141527e+00 -1.25002538e+00 -5.72513706e-01 -5.72513706e-01
 -5.72513706e-01  9.21630533e-01  9.21630533e-01  9.21630533e-01
  5.66993756e+00  5.66993756e+00  5.66993756e+00  2.46205835e+01
  2.46205835e+01  2.46205835e+01  9.79288730e+01  9.79288730e+01
  9.79288730e+01  1.83243191e+02  4.30342923e+02  4.30342923e+02
  4.30342923e+02  1.28320298e+03  1.28320298e+03  1.28320298e+03
  1.91472520e+03  2.98454553e+03  2.98454553e+03  2.98454553e+03
  6.61279953e+03  6.61279953e+03  6.61279953e+03  8.27243873e+03
  2.46597074e+04  7.54557976e+04]
E1 = -727.4925118326321  E_coul = 201.9512800316365
Extra cycle  E= -525.541231800996  delta_E= 1.48e-12  |g|= 2.85e-08  |ddm|= 4.9e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.32 sec
exp = [2.61825089e+04 7.61823918e+03 3.61822746e+03 1.61789360e+03
 2.39781495e+02 5.20900855e+01 4.59905137e+00 3.98373719e-01
 1.36279220e+03 6.65169502e+02 3.03259496e+02 3.16092578e+02
 5.00539486e+01 5.72590641e+00 1.57511748e+01 7.09134490e-01
 2.21649914e+00 2.11138952e-01]
grad_E = [-1.98683792e-06  2.19560709e-05  4.39995495e-05  6.75409165e-04
  2.44946042e-04 -2.01032557e-03 -3.41889834e-03 -5.74448918e-03
  1.23852554e-06  1.93142537e-05  1.04431627e-04  9.19319047e-05
 -1.06177716e-03  1.68738861e-03 -3.75937273e-03  1.49178493e-02
 -1.12324584e-03  8.29246709e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5098702        1
[INPUT] 0    0    [1    /1   ]  7618.22834668        1
[INPUT] 0    0    [1    /1   ]  3618.20568765        1
[INPUT] 0    0    [1    /1   ]  1617.56011189        1
[INPUT] 0    0    [1    /1   ]  239.804540293        1
[INPUT] 0    0    [1    /1   ]  52.0812925881        1
[INPUT] 0    0    [1    /1   ]  4.59686834425        1
[INPUT] 0    0    [1    /1   ]  0.398020774901       1
[INPUT] 1    0    [1    /1   ]  1362.79136544        1
[INPUT] 1    0    [1    /1   ]  665.158445958        1
[INPUT] 1    0    [1    /1   ]  303.198881368        1
[INPUT] 1    0    [1    /1   ]  316.039164841        1
[INPUT] 1    0    [1    /1   ]  51.1343084176        1
[INPUT] 1    0    [1    /1   ]  5.80570827696        1
[INPUT] 1    0    [1    /1   ]  15.9787185415        1
[INPUT] 1    0    [1    /1   ]  0.72737947179        1
[INPUT] 1    0    [1    /1   ]  2.25984680777        1
[INPUT] 1    0    [1    /1   ]  0.215944318008       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.509870230642, 1.0]], [0, [7618.228346682137, 1.0]], [0, [3618.205687654557, 1.0]], [0, [1617.5601118873055, 1.0]], [0, [239.80454029339833, 1.0]], [0, [52.08129258805392, 1.0]], [0, [4.596868344254016, 1.0]], [0, [0.3980207749008326, 1.0]], [1, [1362.7913654383913, 1.0]], [1, [665.1584459583426, 1.0]], [1, [303.19888136806804, 1.0]], [1, [316.03916484128723, 1.0]], [1, [51.13430841756725, 1.0]], [1, [5.805708276956582, 1.0]], [1, [15.97871854148066, 1.0]], [1, [0.7273794717895251, 1.0]], [1, [2.2598468077736165, 1.0]], [1, [0.21594431800781277, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50987023]
bas 1, expnt(s) = [7618.22834668]
bas 2, expnt(s) = [3618.20568765]
bas 3, expnt(s) = [1617.56011189]
bas 4, expnt(s) = [239.80454029]
bas 5, expnt(s) = [52.08129259]
bas 6, expnt(s) = [4.59686834]
bas 7, expnt(s) = [0.39802077]
bas 8, expnt(s) = [1362.79136544]
bas 9, expnt(s) = [665.15844596]
bas 10, expnt(s) = [303.19888137]
bas 11, expnt(s) = [316.03916484]
bas 12, expnt(s) = [51.13430842]
bas 13, expnt(s) = [5.80570828]
bas 14, expnt(s) = [15.97871854]
bas 15, expnt(s) = [0.72737947]
bas 16, expnt(s) = [2.25984681]
bas 17, expnt(s) = [0.21594432]
CPU time:       241.20
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825099e+04 5.20024112e+03 7.61822835e+03 2.06018165e+03
 3.61820569e+03 1.17865028e+03 1.61756011e+03 6.44407143e+02
 2.39804540e+02 1.53960061e+02 5.20812926e+01 4.89808525e+01
 4.59686834e+00 7.93161405e+00 3.98020775e-01 1.26603097e+00
 1.36279137e+03 2.41557824e+04 6.65158446e+02 9.85464037e+03
 3.03198881e+02 3.69099865e+03 3.16039165e+02 3.88741158e+03
 5.11343084e+01 3.98909956e+02 5.80570828e+00 2.62907760e+01
 1.59787185e+01 9.31991231e+01 7.27379472e-01 1.95968240e+00
 2.25984681e+00 8.08319661e+00 2.15944318e-01 4.29449023e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.975139422269294
cond(S) = 87822.2596075594
E1 = -727.519358402611  E_coul = 203.10440574328305
init E= -524.414952659328
    CPU time for initialize scf      0.16 sec, wall time      0.04 sec
  HOMO = -0.560327317356177  LUMO = 0.958830955594797
  mo_energy =
[-1.17872136e+02 -1.20954497e+01 -9.44659964e+00 -9.44659964e+00
 -9.44659964e+00 -1.23023657e+00 -5.60327317e-01 -5.60327317e-01
 -5.60327317e-01  9.58830956e-01  9.58830956e-01  9.58830956e-01
  5.87570740e+00  5.87570740e+00  5.87570740e+00  2.52299785e+01
  2.52299785e+01  2.52299785e+01  1.00196995e+02  1.00196995e+02
  1.00196995e+02  1.83389594e+02  4.34817538e+02  4.34817538e+02
  4.34817538e+02  1.28790361e+03  1.28790361e+03  1.28790361e+03
  1.91494229e+03  2.98906321e+03  2.98906321e+03  2.98906321e+03
  6.61702419e+03  6.61702419e+03  6.61702419e+03  8.27227728e+03
  2.46592106e+04  7.54552275e+04]
E1 = -727.3398816131757  E_coul = 201.79740514350704
cycle= 1 E= -525.542476469669  delta_E= -1.13  |g|= 0.182  |ddm|= 0.321
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.457298
diis-c [-0.20912122  1.        ]
  HOMO = -0.573840058218965  LUMO = 0.952708352565238
  mo_energy =
[-1.18116763e+02 -1.21828241e+01 -9.53321023e+00 -9.53321023e+00
 -9.53321023e+00 -1.25191102e+00 -5.73840058e-01 -5.73840058e-01
 -5.73840058e-01  9.52708353e-01  9.52708353e-01  9.52708353e-01
  5.83548754e+00  5.83548754e+00  5.83548754e+00  2.51483196e+01
  2.51483196e+01  2.51483196e+01  1.00048537e+02  1.00048537e+02
  1.00048537e+02  1.83198015e+02  4.34586995e+02  4.34586995e+02
  4.34586995e+02  1.28762294e+03  1.28762294e+03  1.28762294e+03
  1.91454033e+03  2.98872102e+03  2.98872102e+03  2.98872102e+03
  6.61656623e+03  6.61656623e+03  6.61656623e+03  8.27173673e+03
  2.46585762e+04  7.54545016e+04]
E1 = -727.5480576107343  E_coul = 202.00539270752603
cycle= 2 E= -525.542664903208  delta_E= -0.000188  |g|= 0.0155  |ddm|= 0.0137
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0307849
diis-c [-7.35019482e-04  3.09585192e-02  9.69041481e-01]
  HOMO = -0.571241957912581  LUMO = 0.954514323458746
  mo_energy =
[-1.18086511e+02 -1.21681817e+01 -9.51834476e+00 -9.51834476e+00
 -9.51834476e+00 -1.24840663e+00 -5.71241958e-01 -5.71241958e-01
 -5.71241958e-01  9.54514323e-01  9.54514323e-01  9.54514323e-01
  5.84207935e+00  5.84207935e+00  5.84207935e+00  2.51618217e+01
  2.51618217e+01  2.51618217e+01  1.00071072e+02  1.00071072e+02
  1.00071072e+02  1.83227084e+02  4.34616811e+02  4.34616811e+02
  4.34616811e+02  1.28765490e+03  1.28765490e+03  1.28765490e+03
  1.91457369e+03  2.98875400e+03  2.98875400e+03  2.98875400e+03
  6.61659979e+03  6.61659979e+03  6.61659979e+03  8.27177050e+03
  2.46586100e+04  7.54545354e+04]
E1 = -727.503932398511  E_coul = 201.96126131633756
cycle= 3 E= -525.542671082173  delta_E= -6.18e-06  |g|= 0.00218  |ddm|= 0.00374
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00449769
diis-c [-1.19927054e-07 -7.37605468e-04  1.22885137e-01  8.77852468e-01]
  HOMO = -0.571796063486289  LUMO = 0.954136942325305
  mo_energy =
[-1.18090680e+02 -1.21705266e+01 -9.52073521e+00 -9.52073521e+00
 -9.52073521e+00 -1.24913225e+00 -5.71796063e-01 -5.71796063e-01
 -5.71796063e-01  9.54136942e-01  9.54136942e-01  9.54136942e-01
  5.84083941e+00  5.84083941e+00  5.84083941e+00  2.51596288e+01
  2.51596288e+01  2.51596288e+01  1.00067796e+02  1.00067796e+02
  1.00067796e+02  1.83223102e+02  4.34612698e+02  4.34612698e+02
  4.34612698e+02  1.28765054e+03  1.28765054e+03  1.28765054e+03
  1.91456910e+03  2.98874949e+03  2.98874949e+03  2.98874949e+03
  6.61659514e+03  6.61659514e+03  6.61659514e+03  8.27176579e+03
  2.46586052e+04  7.54545305e+04]
E1 = -727.5106645880269  E_coul = 201.96799332478864
cycle= 4 E= -525.542671263238  delta_E= -1.81e-07  |g|= 4.28e-05  |ddm|= 0.0006
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.80153e-05
diis-c [-3.97931559e-10 -2.90261942e-05  4.36990287e-03  4.68183178e-02
  9.48840806e-01]
  HOMO = -0.571772514394773  LUMO = 0.954152561134693
  mo_energy =
[-1.18090584e+02 -1.21704466e+01 -9.52065433e+00 -9.52065433e+00
 -9.52065433e+00 -1.24910133e+00 -5.71772514e-01 -5.71772514e-01
 -5.71772514e-01  9.54152561e-01  9.54152561e-01  9.54152561e-01
  5.84088860e+00  5.84088860e+00  5.84088860e+00  2.51597033e+01
  2.51597033e+01  2.51597033e+01  1.00067886e+02  1.00067886e+02
  1.00067886e+02  1.83223198e+02  4.34612794e+02  4.34612794e+02
  4.34612794e+02  1.28765063e+03  1.28765063e+03  1.28765063e+03
  1.91456920e+03  2.98874958e+03  2.98874958e+03  2.98874958e+03
  6.61659524e+03  6.61659524e+03  6.61659524e+03  8.27176588e+03
  2.46586053e+04  7.54545306e+04]
E1 = -727.510454978207  E_coul = 201.96778371480443
cycle= 5 E= -525.542671263403  delta_E= -1.64e-10  |g|= 2.44e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.510454978207  E_coul = 201.96778371480443
  HOMO = -0.571773992019676  LUMO = 0.95415156581525
  mo_energy =
[-1.18090590e+02 -1.21704513e+01 -9.52065904e+00 -9.52065904e+00
 -9.52065904e+00 -1.24910322e+00 -5.71773992e-01 -5.71773992e-01
 -5.71773992e-01  9.54151566e-01  9.54151566e-01  9.54151566e-01
  5.84088565e+00  5.84088565e+00  5.84088565e+00  2.51596989e+01
  2.51596989e+01  2.51596989e+01  1.00067880e+02  1.00067880e+02
  1.00067880e+02  1.83223191e+02  4.34612788e+02  4.34612788e+02
  4.34612788e+02  1.28765063e+03  1.28765063e+03  1.28765063e+03
  1.91456919e+03  2.98874958e+03  2.98874958e+03  2.98874958e+03
  6.61659523e+03  6.61659523e+03  6.61659523e+03  8.27176587e+03
  2.46586053e+04  7.54545306e+04]
E1 = -727.5104671017727  E_coul = 201.96779583836891
Extra cycle  E= -525.542671263404  delta_E= -1.25e-12  |g|= 5.93e-07  |ddm|= 1.15e-06
    CPU time for scf_cycle      0.35 sec, wall time      0.23 sec
exp = [2.61825099e+04 7.61822835e+03 3.61820569e+03 1.61756011e+03
 2.39804540e+02 5.20812926e+01 4.59686834e+00 3.98020775e-01
 1.36279137e+03 6.65158446e+02 3.03198881e+02 3.16039165e+02
 5.11343084e+01 5.80570828e+00 1.59787185e+01 7.27379472e-01
 2.25984681e+00 2.15944318e-01]
E = -525.5426712634038
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5098702        1
[INPUT] 0    0    [1    /1   ]  7618.22834668        1
[INPUT] 0    0    [1    /1   ]  3618.20568765        1
[INPUT] 0    0    [1    /1   ]  1617.56011189        1
[INPUT] 0    0    [1    /1   ]  239.804540293        1
[INPUT] 0    0    [1    /1   ]  52.0812925881        1
[INPUT] 0    0    [1    /1   ]  4.59686834425        1
[INPUT] 0    0    [1    /1   ]  0.398020774901       1
[INPUT] 1    0    [1    /1   ]  1362.79136544        1
[INPUT] 1    0    [1    /1   ]  665.158445958        1
[INPUT] 1    0    [1    /1   ]  303.198881368        1
[INPUT] 1    0    [1    /1   ]  316.039164841        1
[INPUT] 1    0    [1    /1   ]  51.1343084176        1
[INPUT] 1    0    [1    /1   ]  5.80570827696        1
[INPUT] 1    0    [1    /1   ]  15.9787185415        1
[INPUT] 1    0    [1    /1   ]  0.72737947179        1
[INPUT] 1    0    [1    /1   ]  2.25984680777        1
[INPUT] 1    0    [1    /1   ]  0.215944318008       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.509870230642, 1.0]], [0, [7618.228346682137, 1.0]], [0, [3618.205687654557, 1.0]], [0, [1617.5601118873055, 1.0]], [0, [239.80454029339833, 1.0]], [0, [52.08129258805392, 1.0]], [0, [4.596868344254016, 1.0]], [0, [0.3980207749008326, 1.0]], [1, [1362.7913654383913, 1.0]], [1, [665.1584459583426, 1.0]], [1, [303.19888136806804, 1.0]], [1, [316.03916484128723, 1.0]], [1, [51.13430841756725, 1.0]], [1, [5.805708276956582, 1.0]], [1, [15.97871854148066, 1.0]], [1, [0.7273794717895251, 1.0]], [1, [2.2598468077736165, 1.0]], [1, [0.21594431800781277, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50987023]
bas 1, expnt(s) = [7618.22834668]
bas 2, expnt(s) = [3618.20568765]
bas 3, expnt(s) = [1617.56011189]
bas 4, expnt(s) = [239.80454029]
bas 5, expnt(s) = [52.08129259]
bas 6, expnt(s) = [4.59686834]
bas 7, expnt(s) = [0.39802077]
bas 8, expnt(s) = [1362.79136544]
bas 9, expnt(s) = [665.15844596]
bas 10, expnt(s) = [303.19888137]
bas 11, expnt(s) = [316.03916484]
bas 12, expnt(s) = [51.13430842]
bas 13, expnt(s) = [5.80570828]
bas 14, expnt(s) = [15.97871854]
bas 15, expnt(s) = [0.72737947]
bas 16, expnt(s) = [2.25984681]
bas 17, expnt(s) = [0.21594432]
CPU time:       241.73
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825099e+04 5.20024112e+03 7.61822835e+03 2.06018165e+03
 3.61820569e+03 1.17865028e+03 1.61756011e+03 6.44407143e+02
 2.39804540e+02 1.53960061e+02 5.20812926e+01 4.89808525e+01
 4.59686834e+00 7.93161405e+00 3.98020775e-01 1.26603097e+00
 1.36279137e+03 2.41557824e+04 6.65158446e+02 9.85464037e+03
 3.03198881e+02 3.69099865e+03 3.16039165e+02 3.88741158e+03
 5.11343084e+01 3.98909956e+02 5.80570828e+00 2.62907760e+01
 1.59787185e+01 9.31991231e+01 7.27379472e-01 1.95968240e+00
 2.25984681e+00 8.08319661e+00 2.15944318e-01 4.29449023e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.975139422269294
cond(S) = 87822.2596075594
E1 = -727.519358402611  E_coul = 203.10440574328305
init E= -524.414952659328
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.560327317356177  LUMO = 0.958830955594797
  mo_energy =
[-1.17872136e+02 -1.20954497e+01 -9.44659964e+00 -9.44659964e+00
 -9.44659964e+00 -1.23023657e+00 -5.60327317e-01 -5.60327317e-01
 -5.60327317e-01  9.58830956e-01  9.58830956e-01  9.58830956e-01
  5.87570740e+00  5.87570740e+00  5.87570740e+00  2.52299785e+01
  2.52299785e+01  2.52299785e+01  1.00196995e+02  1.00196995e+02
  1.00196995e+02  1.83389594e+02  4.34817538e+02  4.34817538e+02
  4.34817538e+02  1.28790361e+03  1.28790361e+03  1.28790361e+03
  1.91494229e+03  2.98906321e+03  2.98906321e+03  2.98906321e+03
  6.61702419e+03  6.61702419e+03  6.61702419e+03  8.27227728e+03
  2.46592106e+04  7.54552275e+04]
E1 = -727.3398816131757  E_coul = 201.79740514350704
cycle= 1 E= -525.542476469669  delta_E= -1.13  |g|= 0.182  |ddm|= 0.321
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.457298
diis-c [-0.20912122  1.        ]
  HOMO = -0.573840058218965  LUMO = 0.952708352565238
  mo_energy =
[-1.18116763e+02 -1.21828241e+01 -9.53321023e+00 -9.53321023e+00
 -9.53321023e+00 -1.25191102e+00 -5.73840058e-01 -5.73840058e-01
 -5.73840058e-01  9.52708353e-01  9.52708353e-01  9.52708353e-01
  5.83548754e+00  5.83548754e+00  5.83548754e+00  2.51483196e+01
  2.51483196e+01  2.51483196e+01  1.00048537e+02  1.00048537e+02
  1.00048537e+02  1.83198015e+02  4.34586995e+02  4.34586995e+02
  4.34586995e+02  1.28762294e+03  1.28762294e+03  1.28762294e+03
  1.91454033e+03  2.98872102e+03  2.98872102e+03  2.98872102e+03
  6.61656623e+03  6.61656623e+03  6.61656623e+03  8.27173673e+03
  2.46585762e+04  7.54545016e+04]
E1 = -727.5480576107343  E_coul = 202.00539270752603
cycle= 2 E= -525.542664903208  delta_E= -0.000188  |g|= 0.0155  |ddm|= 0.0137
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0307849
diis-c [-7.35019482e-04  3.09585192e-02  9.69041481e-01]
  HOMO = -0.571241957912581  LUMO = 0.954514323458746
  mo_energy =
[-1.18086511e+02 -1.21681817e+01 -9.51834476e+00 -9.51834476e+00
 -9.51834476e+00 -1.24840663e+00 -5.71241958e-01 -5.71241958e-01
 -5.71241958e-01  9.54514323e-01  9.54514323e-01  9.54514323e-01
  5.84207935e+00  5.84207935e+00  5.84207935e+00  2.51618217e+01
  2.51618217e+01  2.51618217e+01  1.00071072e+02  1.00071072e+02
  1.00071072e+02  1.83227084e+02  4.34616811e+02  4.34616811e+02
  4.34616811e+02  1.28765490e+03  1.28765490e+03  1.28765490e+03
  1.91457369e+03  2.98875400e+03  2.98875400e+03  2.98875400e+03
  6.61659979e+03  6.61659979e+03  6.61659979e+03  8.27177050e+03
  2.46586100e+04  7.54545354e+04]
E1 = -727.503932398511  E_coul = 201.96126131633756
cycle= 3 E= -525.542671082173  delta_E= -6.18e-06  |g|= 0.00218  |ddm|= 0.00374
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00449769
diis-c [-1.19927054e-07 -7.37605468e-04  1.22885137e-01  8.77852468e-01]
  HOMO = -0.571796063486289  LUMO = 0.954136942325305
  mo_energy =
[-1.18090680e+02 -1.21705266e+01 -9.52073521e+00 -9.52073521e+00
 -9.52073521e+00 -1.24913225e+00 -5.71796063e-01 -5.71796063e-01
 -5.71796063e-01  9.54136942e-01  9.54136942e-01  9.54136942e-01
  5.84083941e+00  5.84083941e+00  5.84083941e+00  2.51596288e+01
  2.51596288e+01  2.51596288e+01  1.00067796e+02  1.00067796e+02
  1.00067796e+02  1.83223102e+02  4.34612698e+02  4.34612698e+02
  4.34612698e+02  1.28765054e+03  1.28765054e+03  1.28765054e+03
  1.91456910e+03  2.98874949e+03  2.98874949e+03  2.98874949e+03
  6.61659514e+03  6.61659514e+03  6.61659514e+03  8.27176579e+03
  2.46586052e+04  7.54545305e+04]
E1 = -727.5106645880269  E_coul = 201.96799332478864
cycle= 4 E= -525.542671263238  delta_E= -1.81e-07  |g|= 4.28e-05  |ddm|= 0.0006
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.80153e-05
diis-c [-3.97931559e-10 -2.90261942e-05  4.36990287e-03  4.68183178e-02
  9.48840806e-01]
  HOMO = -0.571772514394773  LUMO = 0.954152561134693
  mo_energy =
[-1.18090584e+02 -1.21704466e+01 -9.52065433e+00 -9.52065433e+00
 -9.52065433e+00 -1.24910133e+00 -5.71772514e-01 -5.71772514e-01
 -5.71772514e-01  9.54152561e-01  9.54152561e-01  9.54152561e-01
  5.84088860e+00  5.84088860e+00  5.84088860e+00  2.51597033e+01
  2.51597033e+01  2.51597033e+01  1.00067886e+02  1.00067886e+02
  1.00067886e+02  1.83223198e+02  4.34612794e+02  4.34612794e+02
  4.34612794e+02  1.28765063e+03  1.28765063e+03  1.28765063e+03
  1.91456920e+03  2.98874958e+03  2.98874958e+03  2.98874958e+03
  6.61659524e+03  6.61659524e+03  6.61659524e+03  8.27176588e+03
  2.46586053e+04  7.54545306e+04]
E1 = -727.510454978207  E_coul = 201.96778371480443
cycle= 5 E= -525.542671263403  delta_E= -1.64e-10  |g|= 2.44e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.510454978207  E_coul = 201.96778371480443
  HOMO = -0.571773992019676  LUMO = 0.95415156581525
  mo_energy =
[-1.18090590e+02 -1.21704513e+01 -9.52065904e+00 -9.52065904e+00
 -9.52065904e+00 -1.24910322e+00 -5.71773992e-01 -5.71773992e-01
 -5.71773992e-01  9.54151566e-01  9.54151566e-01  9.54151566e-01
  5.84088565e+00  5.84088565e+00  5.84088565e+00  2.51596989e+01
  2.51596989e+01  2.51596989e+01  1.00067880e+02  1.00067880e+02
  1.00067880e+02  1.83223191e+02  4.34612788e+02  4.34612788e+02
  4.34612788e+02  1.28765063e+03  1.28765063e+03  1.28765063e+03
  1.91456919e+03  2.98874958e+03  2.98874958e+03  2.98874958e+03
  6.61659523e+03  6.61659523e+03  6.61659523e+03  8.27176587e+03
  2.46586053e+04  7.54545306e+04]
E1 = -727.5104671017727  E_coul = 201.96779583836891
Extra cycle  E= -525.542671263404  delta_E= -1.25e-12  |g|= 5.93e-07  |ddm|= 1.15e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 87822.2596075594
E1 = -727.5104671017727  E_coul = 201.96779583836891
init E= -525.542671263404
    CPU time for initialize scf      0.94 sec, wall time      0.18 sec
  HOMO = -0.571773764783623  LUMO = 0.954151718406669
  mo_energy =
[-1.18090589e+02 -1.21704504e+01 -9.52065812e+00 -9.52065812e+00
 -9.52065812e+00 -1.24910292e+00 -5.71773765e-01 -5.71773765e-01
 -5.71773765e-01  9.54151718e-01  9.54151718e-01  9.54151718e-01
  5.84088615e+00  5.84088615e+00  5.84088615e+00  2.51596998e+01
  2.51596998e+01  2.51596998e+01  1.00067881e+02  1.00067881e+02
  1.00067881e+02  1.83223193e+02  4.34612789e+02  4.34612789e+02
  4.34612789e+02  1.28765063e+03  1.28765063e+03  1.28765063e+03
  1.91456919e+03  2.98874958e+03  2.98874958e+03  2.98874958e+03
  6.61659523e+03  6.61659523e+03  6.61659523e+03  8.27176587e+03
  2.46586053e+04  7.54545306e+04]
E1 = -727.5104645758588  E_coul = 201.96779331245554
cycle= 1 E= -525.542671263403  delta_E= 5.68e-13  |g|= 1.32e-07  |ddm|= 2.49e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.5104645758588  E_coul = 201.96779331245554
  HOMO = -0.571773811470884  LUMO = 0.954151686765357
  mo_energy =
[-1.18090589e+02 -1.21704506e+01 -9.52065831e+00 -9.52065831e+00
 -9.52065831e+00 -1.24910298e+00 -5.71773811e-01 -5.71773811e-01
 -5.71773811e-01  9.54151687e-01  9.54151687e-01  9.54151687e-01
  5.84088604e+00  5.84088604e+00  5.84088604e+00  2.51596996e+01
  2.51596996e+01  2.51596996e+01  1.00067881e+02  1.00067881e+02
  1.00067881e+02  1.83223193e+02  4.34612789e+02  4.34612789e+02
  4.34612789e+02  1.28765063e+03  1.28765063e+03  1.28765063e+03
  1.91456919e+03  2.98874958e+03  2.98874958e+03  2.98874958e+03
  6.61659523e+03  6.61659523e+03  6.61659523e+03  8.27176587e+03
  2.46586053e+04  7.54545306e+04]
E1 = -727.5104650981991  E_coul = 201.96779383479597
Extra cycle  E= -525.542671263403  delta_E= 1.14e-13  |g|= 2.81e-08  |ddm|= 4.82e-08
    CPU time for scf_cycle      1.07 sec, wall time      0.32 sec
exp = [2.61825099e+04 7.61822835e+03 3.61820569e+03 1.61756011e+03
 2.39804540e+02 5.20812926e+01 4.59686834e+00 3.98020775e-01
 1.36279137e+03 6.65158446e+02 3.03198881e+02 3.16039165e+02
 5.11343084e+01 5.80570828e+00 1.59787185e+01 7.27379472e-01
 2.25984681e+00 2.15944318e-01]
grad_E = [-1.98686366e-06  2.19136065e-05  4.38554321e-05  6.74306837e-04
  3.03352259e-04 -2.33564991e-03 -5.36646866e-03 -8.87380148e-03
  7.91929977e-07  1.60642531e-05  8.53631291e-05  7.50443994e-05
 -1.94857637e-04  3.15413621e-03 -5.82862536e-03  2.22666659e-02
 -2.04246795e-03  1.49935240e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5119791        1
[INPUT] 0    0    [1    /1   ]  7618.20491694        1
[INPUT] 0    0    [1    /1   ]  3618.15859059        1
[INPUT] 0    0    [1    /1   ]  1616.8388363         1
[INPUT] 0    0    [1    /1   ]  239.851196676        1
[INPUT] 0    0    [1    /1   ]  52.0858608002        1
[INPUT] 0    0    [1    /1   ]  4.59512270721        1
[INPUT] 0    0    [1    /1   ]  0.397698885872       1
[INPUT] 1    0    [1    /1   ]  1362.78957894        1
[INPUT] 1    0    [1    /1   ]  665.134639072        1
[INPUT] 1    0    [1    /1   ]  303.068419937        1
[INPUT] 1    0    [1    /1   ]  315.924204635        1
[INPUT] 1    0    [1    /1   ]  53.403215874         1
[INPUT] 1    0    [1    /1   ]  6.04897847853        1
[INPUT] 1    0    [1    /1   ]  16.6531854713        1
[INPUT] 1    0    [1    /1   ]  0.755538434947       1
[INPUT] 1    0    [1    /1   ]  2.36892067433        1
[INPUT] 1    0    [1    /1   ]  0.222301372324       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.511979134888, 1.0]], [0, [7618.204916935305, 1.0]], [0, [3618.1585905853567, 1.0]], [0, [1616.838836300129, 1.0]], [0, [239.8511966760337, 1.0]], [0, [52.08586080024215, 1.0]], [0, [4.595122707207771, 1.0]], [0, [0.39769888587245117, 1.0]], [1, [1362.7895789381046, 1.0]], [1, [665.134639071651, 1.0]], [1, [303.0684199366302, 1.0]], [1, [315.9242046348298, 1.0]], [1, [53.40321587398013, 1.0]], [1, [6.048978478532374, 1.0]], [1, [16.65318547131604, 1.0]], [1, [0.7555384349472156, 1.0]], [1, [2.368920674328474, 1.0]], [1, [0.22230137232395233, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51197913]
bas 1, expnt(s) = [7618.20491694]
bas 2, expnt(s) = [3618.15859059]
bas 3, expnt(s) = [1616.8388363]
bas 4, expnt(s) = [239.85119668]
bas 5, expnt(s) = [52.0858608]
bas 6, expnt(s) = [4.59512271]
bas 7, expnt(s) = [0.39769889]
bas 8, expnt(s) = [1362.78957894]
bas 9, expnt(s) = [665.13463907]
bas 10, expnt(s) = [303.06841994]
bas 11, expnt(s) = [315.92420463]
bas 12, expnt(s) = [53.40321587]
bas 13, expnt(s) = [6.04897848]
bas 14, expnt(s) = [16.65318547]
bas 15, expnt(s) = [0.75553843]
bas 16, expnt(s) = [2.36892067]
bas 17, expnt(s) = [0.22230137]
CPU time:       247.55
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825120e+04 5.20024144e+03 7.61820492e+03 2.06017689e+03
 3.61815859e+03 1.17863877e+03 1.61683884e+03 6.44191624e+02
 2.39851197e+02 1.53982527e+02 5.20858608e+01 4.89840747e+01
 4.59512271e+00 7.92935495e+00 3.97698886e-01 1.26526299e+00
 1.36278958e+03 2.41557428e+04 6.65134639e+02 9.85419948e+03
 3.03068420e+02 3.68901353e+03 3.15924205e+02 3.88564409e+03
 5.34032159e+01 4.21156643e+02 6.04897848e+00 2.76749562e+01
 1.66531855e+01 9.81422570e+01 7.55538435e-01 2.05496815e+00
 2.36892067e+00 8.57378404e+00 2.22301372e-01 4.45309615e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97426496274601
cond(S) = 90790.84092220858
E1 = -727.5138620449051  E_coul = 203.096564473174
init E= -524.417297571731
    CPU time for initialize scf      0.16 sec, wall time      0.04 sec
  HOMO = -0.560290997403927  LUMO = 1.00614462599583
  mo_energy =
[-1.17873108e+02 -1.20960617e+01 -9.44783394e+00 -9.44783394e+00
 -9.44783394e+00 -1.23035712e+00 -5.60290997e-01 -5.60290997e-01
 -5.60290997e-01  1.00614463e+00  1.00614463e+00  1.00614463e+00
  6.22828124e+00  6.22828124e+00  6.22828124e+00  2.66729657e+01
  2.66729657e+01  2.66729657e+01  1.05519029e+02  1.05519029e+02
  1.05519029e+02  1.83420408e+02  4.44619395e+02  4.44619395e+02
  4.44619395e+02  1.29806401e+03  1.29806401e+03  1.29806401e+03
  1.91468731e+03  2.99867816e+03  2.99867816e+03  2.99867816e+03
  6.62571993e+03  6.62571993e+03  6.62571993e+03  8.27089603e+03
  2.46568969e+04  7.54525525e+04]
E1 = -727.3731678103209  E_coul = 201.82789225347202
cycle= 1 E= -525.545275556849  delta_E= -1.13  |g|= 0.181  |ddm|= 0.24
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.458999
diis-c [-0.2106803  1.       ]
  HOMO = -0.572724317801776  LUMO = 1.0002041943263
  mo_energy =
[-1.18114109e+02 -1.21806479e+01 -9.53173888e+00 -9.53173888e+00
 -9.53173888e+00 -1.25065383e+00 -5.72724318e-01 -5.72724318e-01
 -5.72724318e-01  1.00020419e+00  1.00020419e+00  1.00020419e+00
  6.18833778e+00  6.18833778e+00  6.18833778e+00  2.65918773e+01
  2.65918773e+01  2.65918773e+01  1.05371176e+02  1.05371176e+02
  1.05371176e+02  1.83232518e+02  4.44392678e+02  4.44392678e+02
  4.44392678e+02  1.29778739e+03  1.29778739e+03  1.29778739e+03
  1.91428929e+03  2.99834003e+03  2.99834003e+03  2.99834003e+03
  6.62526602e+03  6.62526602e+03  6.62526602e+03  8.27035945e+03
  2.46562665e+04  7.54518305e+04]
E1 = -727.5735687581994  E_coul = 202.02811122170783
cycle= 2 E= -525.545457536492  delta_E= -0.000182  |g|= 0.0152  |ddm|= 0.013
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0303544
diis-c [-7.15201111e-04  3.03848410e-02  9.69615159e-01]
  HOMO = -0.570283810730552  LUMO = 1.00199698156768
  mo_energy =
[-1.18084646e+02 -1.21665592e+01 -9.51743481e+00 -9.51743481e+00
 -9.51743481e+00 -1.24735808e+00 -5.70283811e-01 -5.70283811e-01
 -5.70283811e-01  1.00199698e+00  1.00199698e+00  1.00199698e+00
  6.19484886e+00  6.19484886e+00  6.19484886e+00  2.66051746e+01
  2.66051746e+01  2.66051746e+01  1.05393314e+02  1.05393314e+02
  1.05393314e+02  1.83260825e+02  4.44421709e+02  4.44421709e+02
  4.44421709e+02  1.29781852e+03  1.29781852e+03  1.29781852e+03
  1.91432181e+03  2.99837217e+03  2.99837217e+03  2.99837217e+03
  6.62529872e+03  6.62529872e+03  6.62529872e+03  8.27039236e+03
  2.46562994e+04  7.54518634e+04]
E1 = -727.5312960590418  E_coul = 201.98583275231206
cycle= 3 E= -525.54546330673  delta_E= -5.77e-06  |g|= 0.00212  |ddm|= 0.00357
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00440152
diis-c [-1.15230379e-07 -7.39427867e-04  1.21945085e-01  8.78794343e-01]
  HOMO = -0.57081030478193  LUMO = 1.00161991567348
  mo_energy =
[-1.18088684e+02 -1.21688141e+01 -9.51973422e+00 -9.51973422e+00
 -9.51973422e+00 -1.24804794e+00 -5.70810305e-01 -5.70810305e-01
 -5.70810305e-01  1.00161992e+00  1.00161992e+00  1.00161992e+00
  6.19362462e+00  6.19362462e+00  6.19362462e+00  2.66030268e+01
  2.66030268e+01  2.66030268e+01  1.05390118e+02  1.05390118e+02
  1.05390118e+02  1.83256970e+02  4.44417727e+02  4.44417727e+02
  4.44417727e+02  1.29781429e+03  1.29781429e+03  1.29781429e+03
  1.91431736e+03  2.99836780e+03  2.99836780e+03  2.99836780e+03
  6.62529421e+03  6.62529421e+03  6.62529421e+03  8.27038778e+03
  2.46562947e+04  7.54518587e+04]
E1 = -727.5377342613306  E_coul = 201.99227078744846
cycle= 4 E= -525.545463473882  delta_E= -1.67e-07  |g|= 4.2e-05  |ddm|= 0.000577
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.66085e-05
diis-c [-3.98915975e-10 -2.88113095e-05  4.25945966e-03  4.63631685e-02
  9.49406183e-01]
  HOMO = -0.570787100719215  LUMO = 1.00163609427678
  mo_energy =
[-1.18088589e+02 -1.21687354e+01 -9.51965468e+00 -9.51965468e+00
 -9.51965468e+00 -1.24801752e+00 -5.70787101e-01 -5.70787101e-01
 -5.70787101e-01  1.00163609e+00  1.00163609e+00  1.00163609e+00
  6.19367442e+00  6.19367442e+00  6.19367442e+00  2.66031008e+01
  2.66031008e+01  2.66031008e+01  1.05390206e+02  1.05390206e+02
  1.05390206e+02  1.83257064e+02  4.44417821e+02  4.44417821e+02
  4.44417821e+02  1.29781439e+03  1.29781439e+03  1.29781439e+03
  1.91431746e+03  2.99836789e+03  2.99836789e+03  2.99836789e+03
  6.62529431e+03  6.62529431e+03  6.62529431e+03  8.27038787e+03
  2.46562948e+04  7.54518588e+04]
E1 = -727.5375308840374  E_coul = 201.99206741000094
cycle= 5 E= -525.545463474037  delta_E= -1.54e-10  |g|= 2.43e-06  |ddm|= 2.27e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5375308840374  E_coul = 201.99206741000094
  HOMO = -0.570788535821576  LUMO = 1.00163508226206
  mo_energy =
[-1.18088595e+02 -1.21687400e+01 -9.51965937e+00 -9.51965937e+00
 -9.51965937e+00 -1.24801936e+00 -5.70788536e-01 -5.70788536e-01
 -5.70788536e-01  1.00163508e+00  1.00163508e+00  1.00163508e+00
  6.19367145e+00  6.19367145e+00  6.19367145e+00  2.66030964e+01
  2.66030964e+01  2.66030964e+01  1.05390200e+02  1.05390200e+02
  1.05390200e+02  1.83257058e+02  4.44417815e+02  4.44417815e+02
  4.44417815e+02  1.29781438e+03  1.29781438e+03  1.29781438e+03
  1.91431745e+03  2.99836789e+03  2.99836789e+03  2.99836789e+03
  6.62529430e+03  6.62529430e+03  6.62529430e+03  8.27038787e+03
  2.46562948e+04  7.54518588e+04]
E1 = -727.537542920759  E_coul = 201.99207944672045
Extra cycle  E= -525.545463474039  delta_E= -2.05e-12  |g|= 5.92e-07  |ddm|= 1.16e-06
    CPU time for scf_cycle      0.35 sec, wall time      0.23 sec
exp = [2.61825120e+04 7.61820492e+03 3.61815859e+03 1.61683884e+03
 2.39851197e+02 5.20858608e+01 4.59512271e+00 3.97698886e-01
 1.36278958e+03 6.65134639e+02 3.03068420e+02 3.15924205e+02
 5.34032159e+01 6.04897848e+00 1.66531855e+01 7.55538435e-01
 2.36892067e+00 2.22301372e-01]
E = -525.5454634740386
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5119791        1
[INPUT] 0    0    [1    /1   ]  7618.20491694        1
[INPUT] 0    0    [1    /1   ]  3618.15859059        1
[INPUT] 0    0    [1    /1   ]  1616.8388363         1
[INPUT] 0    0    [1    /1   ]  239.851196676        1
[INPUT] 0    0    [1    /1   ]  52.0858608002        1
[INPUT] 0    0    [1    /1   ]  4.59512270721        1
[INPUT] 0    0    [1    /1   ]  0.397698885872       1
[INPUT] 1    0    [1    /1   ]  1362.78957894        1
[INPUT] 1    0    [1    /1   ]  665.134639072        1
[INPUT] 1    0    [1    /1   ]  303.068419937        1
[INPUT] 1    0    [1    /1   ]  315.924204635        1
[INPUT] 1    0    [1    /1   ]  53.403215874         1
[INPUT] 1    0    [1    /1   ]  6.04897847853        1
[INPUT] 1    0    [1    /1   ]  16.6531854713        1
[INPUT] 1    0    [1    /1   ]  0.755538434947       1
[INPUT] 1    0    [1    /1   ]  2.36892067433        1
[INPUT] 1    0    [1    /1   ]  0.222301372324       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.511979134888, 1.0]], [0, [7618.204916935305, 1.0]], [0, [3618.1585905853567, 1.0]], [0, [1616.838836300129, 1.0]], [0, [239.8511966760337, 1.0]], [0, [52.08586080024215, 1.0]], [0, [4.595122707207771, 1.0]], [0, [0.39769888587245117, 1.0]], [1, [1362.7895789381046, 1.0]], [1, [665.134639071651, 1.0]], [1, [303.0684199366302, 1.0]], [1, [315.9242046348298, 1.0]], [1, [53.40321587398013, 1.0]], [1, [6.048978478532374, 1.0]], [1, [16.65318547131604, 1.0]], [1, [0.7555384349472156, 1.0]], [1, [2.368920674328474, 1.0]], [1, [0.22230137232395233, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51197913]
bas 1, expnt(s) = [7618.20491694]
bas 2, expnt(s) = [3618.15859059]
bas 3, expnt(s) = [1616.8388363]
bas 4, expnt(s) = [239.85119668]
bas 5, expnt(s) = [52.0858608]
bas 6, expnt(s) = [4.59512271]
bas 7, expnt(s) = [0.39769889]
bas 8, expnt(s) = [1362.78957894]
bas 9, expnt(s) = [665.13463907]
bas 10, expnt(s) = [303.06841994]
bas 11, expnt(s) = [315.92420463]
bas 12, expnt(s) = [53.40321587]
bas 13, expnt(s) = [6.04897848]
bas 14, expnt(s) = [16.65318547]
bas 15, expnt(s) = [0.75553843]
bas 16, expnt(s) = [2.36892067]
bas 17, expnt(s) = [0.22230137]
CPU time:       248.08
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825120e+04 5.20024144e+03 7.61820492e+03 2.06017689e+03
 3.61815859e+03 1.17863877e+03 1.61683884e+03 6.44191624e+02
 2.39851197e+02 1.53982527e+02 5.20858608e+01 4.89840747e+01
 4.59512271e+00 7.92935495e+00 3.97698886e-01 1.26526299e+00
 1.36278958e+03 2.41557428e+04 6.65134639e+02 9.85419948e+03
 3.03068420e+02 3.68901353e+03 3.15924205e+02 3.88564409e+03
 5.34032159e+01 4.21156643e+02 6.04897848e+00 2.76749562e+01
 1.66531855e+01 9.81422570e+01 7.55538435e-01 2.05496815e+00
 2.36892067e+00 8.57378404e+00 2.22301372e-01 4.45309615e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97426496274601
cond(S) = 90790.84092220858
E1 = -727.5138620449051  E_coul = 203.096564473174
init E= -524.417297571731
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.560290997403927  LUMO = 1.00614462599583
  mo_energy =
[-1.17873108e+02 -1.20960617e+01 -9.44783394e+00 -9.44783394e+00
 -9.44783394e+00 -1.23035712e+00 -5.60290997e-01 -5.60290997e-01
 -5.60290997e-01  1.00614463e+00  1.00614463e+00  1.00614463e+00
  6.22828124e+00  6.22828124e+00  6.22828124e+00  2.66729657e+01
  2.66729657e+01  2.66729657e+01  1.05519029e+02  1.05519029e+02
  1.05519029e+02  1.83420408e+02  4.44619395e+02  4.44619395e+02
  4.44619395e+02  1.29806401e+03  1.29806401e+03  1.29806401e+03
  1.91468731e+03  2.99867816e+03  2.99867816e+03  2.99867816e+03
  6.62571993e+03  6.62571993e+03  6.62571993e+03  8.27089603e+03
  2.46568969e+04  7.54525525e+04]
E1 = -727.3731678103209  E_coul = 201.82789225347202
cycle= 1 E= -525.545275556849  delta_E= -1.13  |g|= 0.181  |ddm|= 0.24
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.458999
diis-c [-0.2106803  1.       ]
  HOMO = -0.572724317801776  LUMO = 1.0002041943263
  mo_energy =
[-1.18114109e+02 -1.21806479e+01 -9.53173888e+00 -9.53173888e+00
 -9.53173888e+00 -1.25065383e+00 -5.72724318e-01 -5.72724318e-01
 -5.72724318e-01  1.00020419e+00  1.00020419e+00  1.00020419e+00
  6.18833778e+00  6.18833778e+00  6.18833778e+00  2.65918773e+01
  2.65918773e+01  2.65918773e+01  1.05371176e+02  1.05371176e+02
  1.05371176e+02  1.83232518e+02  4.44392678e+02  4.44392678e+02
  4.44392678e+02  1.29778739e+03  1.29778739e+03  1.29778739e+03
  1.91428929e+03  2.99834003e+03  2.99834003e+03  2.99834003e+03
  6.62526602e+03  6.62526602e+03  6.62526602e+03  8.27035945e+03
  2.46562665e+04  7.54518305e+04]
E1 = -727.5735687581994  E_coul = 202.02811122170783
cycle= 2 E= -525.545457536492  delta_E= -0.000182  |g|= 0.0152  |ddm|= 0.013
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0303544
diis-c [-7.15201111e-04  3.03848410e-02  9.69615159e-01]
  HOMO = -0.570283810730552  LUMO = 1.00199698156768
  mo_energy =
[-1.18084646e+02 -1.21665592e+01 -9.51743481e+00 -9.51743481e+00
 -9.51743481e+00 -1.24735808e+00 -5.70283811e-01 -5.70283811e-01
 -5.70283811e-01  1.00199698e+00  1.00199698e+00  1.00199698e+00
  6.19484886e+00  6.19484886e+00  6.19484886e+00  2.66051746e+01
  2.66051746e+01  2.66051746e+01  1.05393314e+02  1.05393314e+02
  1.05393314e+02  1.83260825e+02  4.44421709e+02  4.44421709e+02
  4.44421709e+02  1.29781852e+03  1.29781852e+03  1.29781852e+03
  1.91432181e+03  2.99837217e+03  2.99837217e+03  2.99837217e+03
  6.62529872e+03  6.62529872e+03  6.62529872e+03  8.27039236e+03
  2.46562994e+04  7.54518634e+04]
E1 = -727.5312960590418  E_coul = 201.98583275231206
cycle= 3 E= -525.54546330673  delta_E= -5.77e-06  |g|= 0.00212  |ddm|= 0.00357
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00440152
diis-c [-1.15230379e-07 -7.39427867e-04  1.21945085e-01  8.78794343e-01]
  HOMO = -0.57081030478193  LUMO = 1.00161991567348
  mo_energy =
[-1.18088684e+02 -1.21688141e+01 -9.51973422e+00 -9.51973422e+00
 -9.51973422e+00 -1.24804794e+00 -5.70810305e-01 -5.70810305e-01
 -5.70810305e-01  1.00161992e+00  1.00161992e+00  1.00161992e+00
  6.19362462e+00  6.19362462e+00  6.19362462e+00  2.66030268e+01
  2.66030268e+01  2.66030268e+01  1.05390118e+02  1.05390118e+02
  1.05390118e+02  1.83256970e+02  4.44417727e+02  4.44417727e+02
  4.44417727e+02  1.29781429e+03  1.29781429e+03  1.29781429e+03
  1.91431736e+03  2.99836780e+03  2.99836780e+03  2.99836780e+03
  6.62529421e+03  6.62529421e+03  6.62529421e+03  8.27038778e+03
  2.46562947e+04  7.54518587e+04]
E1 = -727.5377342613306  E_coul = 201.99227078744846
cycle= 4 E= -525.545463473882  delta_E= -1.67e-07  |g|= 4.2e-05  |ddm|= 0.000577
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.66085e-05
diis-c [-3.98915975e-10 -2.88113095e-05  4.25945966e-03  4.63631685e-02
  9.49406183e-01]
  HOMO = -0.570787100719215  LUMO = 1.00163609427678
  mo_energy =
[-1.18088589e+02 -1.21687354e+01 -9.51965468e+00 -9.51965468e+00
 -9.51965468e+00 -1.24801752e+00 -5.70787101e-01 -5.70787101e-01
 -5.70787101e-01  1.00163609e+00  1.00163609e+00  1.00163609e+00
  6.19367442e+00  6.19367442e+00  6.19367442e+00  2.66031008e+01
  2.66031008e+01  2.66031008e+01  1.05390206e+02  1.05390206e+02
  1.05390206e+02  1.83257064e+02  4.44417821e+02  4.44417821e+02
  4.44417821e+02  1.29781439e+03  1.29781439e+03  1.29781439e+03
  1.91431746e+03  2.99836789e+03  2.99836789e+03  2.99836789e+03
  6.62529431e+03  6.62529431e+03  6.62529431e+03  8.27038787e+03
  2.46562948e+04  7.54518588e+04]
E1 = -727.5375308840374  E_coul = 201.99206741000094
cycle= 5 E= -525.545463474037  delta_E= -1.54e-10  |g|= 2.43e-06  |ddm|= 2.27e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5375308840374  E_coul = 201.99206741000094
  HOMO = -0.570788535821576  LUMO = 1.00163508226206
  mo_energy =
[-1.18088595e+02 -1.21687400e+01 -9.51965937e+00 -9.51965937e+00
 -9.51965937e+00 -1.24801936e+00 -5.70788536e-01 -5.70788536e-01
 -5.70788536e-01  1.00163508e+00  1.00163508e+00  1.00163508e+00
  6.19367145e+00  6.19367145e+00  6.19367145e+00  2.66030964e+01
  2.66030964e+01  2.66030964e+01  1.05390200e+02  1.05390200e+02
  1.05390200e+02  1.83257058e+02  4.44417815e+02  4.44417815e+02
  4.44417815e+02  1.29781438e+03  1.29781438e+03  1.29781438e+03
  1.91431745e+03  2.99836789e+03  2.99836789e+03  2.99836789e+03
  6.62529430e+03  6.62529430e+03  6.62529430e+03  8.27038787e+03
  2.46562948e+04  7.54518588e+04]
E1 = -727.537542920759  E_coul = 201.99207944672045
Extra cycle  E= -525.545463474039  delta_E= -2.05e-12  |g|= 5.92e-07  |ddm|= 1.16e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 90790.84092220858
E1 = -727.537542920759  E_coul = 201.99207944672045
init E= -525.545463474039
    CPU time for initialize scf      0.95 sec, wall time      0.19 sec
  HOMO = -0.570788310445356  LUMO = 1.0016352415587
  mo_energy =
[-1.18088594e+02 -1.21687391e+01 -9.51965846e+00 -9.51965846e+00
 -9.51965846e+00 -1.24801906e+00 -5.70788310e-01 -5.70788310e-01
 -5.70788310e-01  1.00163524e+00  1.00163524e+00  1.00163524e+00
  6.19367196e+00  6.19367196e+00  6.19367196e+00  2.66030973e+01
  2.66030973e+01  2.66030973e+01  1.05390201e+02  1.05390201e+02
  1.05390201e+02  1.83257059e+02  4.44417816e+02  4.44417816e+02
  4.44417816e+02  1.29781438e+03  1.29781438e+03  1.29781438e+03
  1.91431745e+03  2.99836789e+03  2.99836789e+03  2.99836789e+03
  6.62529430e+03  6.62529430e+03  6.62529430e+03  8.27038787e+03
  2.46562948e+04  7.54518588e+04]
E1 = -727.5375404409871  E_coul = 201.9920769669499
cycle= 1 E= -525.545463474037  delta_E= 1.36e-12  |g|= 1.31e-07  |ddm|= 2.44e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.5375404409871  E_coul = 201.9920769669499
  HOMO = -0.570788355788003  LUMO = 1.00163520927085
  mo_energy =
[-1.18088594e+02 -1.21687393e+01 -9.51965864e+00 -9.51965864e+00
 -9.51965864e+00 -1.24801912e+00 -5.70788356e-01 -5.70788356e-01
 -5.70788356e-01  1.00163521e+00  1.00163521e+00  1.00163521e+00
  6.19367185e+00  6.19367185e+00  6.19367185e+00  2.66030971e+01
  2.66030971e+01  2.66030971e+01  1.05390201e+02  1.05390201e+02
  1.05390201e+02  1.83257059e+02  4.44417816e+02  4.44417816e+02
  4.44417816e+02  1.29781438e+03  1.29781438e+03  1.29781438e+03
  1.91431745e+03  2.99836789e+03  2.99836789e+03  2.99836789e+03
  6.62529430e+03  6.62529430e+03  6.62529430e+03  8.27038787e+03
  2.46562948e+04  7.54518588e+04]
E1 = -727.5375409506818  E_coul = 201.99207747664568
Extra cycle  E= -525.545463474036  delta_E= 1.14e-12  |g|= 2.76e-08  |ddm|= 4.74e-08
    CPU time for scf_cycle      1.07 sec, wall time      0.31 sec
exp = [2.61825120e+04 7.61820492e+03 3.61815859e+03 1.61683884e+03
 2.39851197e+02 5.20858608e+01 4.59512271e+00 3.97698886e-01
 1.36278958e+03 6.65134639e+02 3.03068420e+02 3.15924205e+02
 5.34032159e+01 6.04897848e+00 1.66531855e+01 7.55538435e-01
 2.36892067e+00 2.22301372e-01]
grad_E = [-1.98708675e-06  2.18551094e-05  4.36448700e-05  6.73164493e-04
  3.41246849e-04 -2.40892729e-03 -6.85205856e-03 -1.14160769e-02
  1.93986797e-07  1.14232409e-05  5.85453656e-05  5.13243896e-05
  5.99018784e-04  3.80546636e-03 -6.76160057e-03  3.10495097e-02
 -2.63742376e-03  1.60796991e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.51531          1
[INPUT] 0    0    [1    /1   ]  7618.16791271        1
[INPUT] 0    0    [1    /1   ]  3618.08420852        1
[INPUT] 0    0    [1    /1   ]  1615.69968534        1
[INPUT] 0    0    [1    /1   ]  239.920898229        1
[INPUT] 0    0    [1    /1   ]  52.1216192042        1
[INPUT] 0    0    [1    /1   ]  4.59602881463        1
[INPUT] 0    0    [1    /1   ]  0.397733426158       1
[INPUT] 1    0    [1    /1   ]  1362.78676801        1
[INPUT] 1    0    [1    /1   ]  665.09711567         1
[INPUT] 1    0    [1    /1   ]  302.86283714         1
[INPUT] 1    0    [1    /1   ]  315.743049317        1
[INPUT] 1    0    [1    /1   ]  56.9407340218        1
[INPUT] 1    0    [1    /1   ]  6.45934570139        1
[INPUT] 1    0    [1    /1   ]  17.8518837896        1
[INPUT] 1    0    [1    /1   ]  0.776876055302       1
[INPUT] 1    0    [1    /1   ]  2.52049696711        1
[INPUT] 1    0    [1    /1   ]  0.225710782397       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.51531000448, 1.0]], [0, [7618.167912714346, 1.0]], [0, [3618.0842085187955, 1.0]], [0, [1615.6996853400713, 1.0]], [0, [239.9208982285641, 1.0]], [0, [52.12161920424907, 1.0]], [0, [4.596028814632371, 1.0]], [0, [0.3977334261582172, 1.0]], [1, [1362.7867680130926, 1.0]], [1, [665.0971156702888, 1.0]], [1, [302.86283714036045, 1.0]], [1, [315.7430493165925, 1.0]], [1, [56.94073402177876, 1.0]], [1, [6.459345701390006, 1.0]], [1, [17.851883789639082, 1.0]], [1, [0.7768760553020984, 1.0]], [1, [2.520496967111278, 1.0]], [1, [0.22571078239679945, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51531]
bas 1, expnt(s) = [7618.16791271]
bas 2, expnt(s) = [3618.08420852]
bas 3, expnt(s) = [1615.69968534]
bas 4, expnt(s) = [239.92089823]
bas 5, expnt(s) = [52.1216192]
bas 6, expnt(s) = [4.59602881]
bas 7, expnt(s) = [0.39773343]
bas 8, expnt(s) = [1362.78676801]
bas 9, expnt(s) = [665.09711567]
bas 10, expnt(s) = [302.86283714]
bas 11, expnt(s) = [315.74304932]
bas 12, expnt(s) = [56.94073402]
bas 13, expnt(s) = [6.4593457]
bas 14, expnt(s) = [17.85188379]
bas 15, expnt(s) = [0.77687606]
bas 16, expnt(s) = [2.52049697]
bas 17, expnt(s) = [0.22571078]
CPU time:       253.84
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825153e+04 5.20024193e+03 7.61816791e+03 2.06016939e+03
 3.61808421e+03 1.17862060e+03 1.61569969e+03 6.43851193e+02
 2.39920898e+02 1.54016086e+02 5.21216192e+01 4.90092942e+01
 4.59602881e+00 7.93052761e+00 3.97733426e-01 1.26534541e+00
 1.36278677e+03 2.41556806e+04 6.65097116e+02 9.85350459e+03
 3.02862837e+02 3.68588580e+03 3.15743049e+02 3.88285919e+03
 5.69407340e+01 4.56313397e+02 6.45934570e+00 3.00413921e+01
 1.78518838e+01 1.07050686e+02 7.76876055e-01 2.12776697e+00
 2.52049697e+00 9.26492945e+00 2.25710782e-01 4.53862996e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97362424942335
cond(S) = 95844.13476816416
E1 = -727.5202694699275  E_coul = 203.09988847579865
init E= -524.420380994129
    CPU time for initialize scf      0.67 sec, wall time      0.08 sec
  HOMO = -0.56015506792819  LUMO = 1.03833406698469
  mo_energy =
[-1.17872651e+02 -1.20960871e+01 -9.44815555e+00 -9.44815555e+00
 -9.44815555e+00 -1.23042693e+00 -5.60155068e-01 -5.60155068e-01
 -5.60155068e-01  1.03833407e+00  1.03833407e+00  1.03833407e+00
  6.65972235e+00  6.65972235e+00  6.65972235e+00  2.89490981e+01
  2.89490981e+01  2.89490981e+01  1.14184818e+02  1.14184818e+02
  1.14184818e+02  1.83564574e+02  4.60291448e+02  4.60291448e+02
  4.60291448e+02  1.31445667e+03  1.31445667e+03  1.31445667e+03
  1.91438830e+03  3.01426254e+03  3.01426254e+03  3.01426254e+03
  6.63985167e+03  6.63985167e+03  6.63985167e+03  8.26880731e+03
  2.46533306e+04  7.54484097e+04]
E1 = -727.392882522594  E_coul = 201.84385715809074
cycle= 1 E= -525.549025364503  delta_E= -1.13  |g|= 0.181  |ddm|= 0.218
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.460058
diis-c [-0.21165323  1.        ]
  HOMO = -0.572325900524334  LUMO = 1.03213292810458
  mo_energy =
[-1.18111214e+02 -1.21800206e+01 -9.53135133e+00 -9.53135133e+00
 -9.53135133e+00 -1.25042394e+00 -5.72325901e-01 -5.72325901e-01
 -5.72325901e-01  1.03213293e+00  1.03213293e+00  1.03213293e+00
  6.61799622e+00  6.61799622e+00  6.61799622e+00  2.88654051e+01
  2.88654051e+01  2.88654051e+01  1.14034812e+02  1.14034812e+02
  1.14034812e+02  1.83378854e+02  4.60067463e+02  4.60067463e+02
  4.60067463e+02  1.31418354e+03  1.31418354e+03  1.31418354e+03
  1.91399439e+03  3.01392837e+03  3.01392837e+03  3.01392837e+03
  6.63940215e+03  6.63940215e+03  6.63940215e+03  8.26827531e+03
  2.46527049e+04  7.54476926e+04]
E1 = -727.5900632767734  E_coul = 202.04086029216938
cycle= 2 E= -525.549202984604  delta_E= -0.000178  |g|= 0.015  |ddm|= 0.0127
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0301767
diis-c [-7.08320249e-04  3.00389374e-02  9.69961063e-01]
  HOMO = -0.56993168681487  LUMO = 1.03396786946939
  mo_energy =
[-1.18082166e+02 -1.21661561e+01 -9.51727576e+00 -9.51727576e+00
 -9.51727576e+00 -1.24718988e+00 -5.69931687e-01 -5.69931687e-01
 -5.69931687e-01  1.03396787e+00  1.03396787e+00  1.03396787e+00
  6.62473834e+00  6.62473834e+00  6.62473834e+00  2.88790096e+01
  2.88790096e+01  2.88790096e+01  1.14057036e+02  1.14057036e+02
  1.14057036e+02  1.83406766e+02  4.60096080e+02  4.60096080e+02
  4.60096080e+02  1.31421422e+03  1.31421422e+03  1.31421422e+03
  1.91402644e+03  3.01396004e+03  3.01396004e+03  3.01396004e+03
  6.63943437e+03  6.63943437e+03  6.63943437e+03  8.26830774e+03
  2.46527373e+04  7.54477250e+04]
E1 = -727.5486320835106  E_coul = 201.9994235167729
cycle= 3 E= -525.549208566738  delta_E= -5.58e-06  |g|= 0.00209  |ddm|= 0.00351
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00437417
diis-c [-1.09349930e-07 -7.41793011e-04  1.21875457e-01  8.78866336e-01]
  HOMO = -0.570445147807677  LUMO = 1.03358539575666
  mo_energy =
[-1.18086142e+02 -1.21683697e+01 -9.51953318e+00 -9.51953318e+00
 -9.51953318e+00 -1.24786337e+00 -5.70445148e-01 -5.70445148e-01
 -5.70445148e-01  1.03358540e+00  1.03358540e+00  1.03358540e+00
  6.62348687e+00  6.62348687e+00  6.62348687e+00  2.88768366e+01
  2.88768366e+01  2.88768366e+01  1.14053844e+02  1.14053844e+02
  1.14053844e+02  1.83402970e+02  4.60092159e+02  4.60092159e+02
  4.60092159e+02  1.31421005e+03  1.31421005e+03  1.31421005e+03
  1.91402206e+03  3.01395574e+03  3.01395574e+03  3.01395574e+03
  6.63942993e+03  6.63942993e+03  6.63942993e+03  8.26830323e+03
  2.46527327e+04  7.54477203e+04]
E1 = -727.5549336436417  E_coul = 202.00572491583907
cycle= 4 E= -525.549208727803  delta_E= -1.61e-07  |g|= 4.09e-05  |ddm|= 0.000569
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=7.457e-05
diis-c [-3.90774673e-10 -2.79451846e-05  4.10800583e-03  4.50031678e-02
  9.50916772e-01]
  HOMO = -0.570422399660492  LUMO = 1.03360189154469
  mo_energy =
[-1.18086049e+02 -1.21682928e+01 -9.51945551e+00 -9.51945551e+00
 -9.51945551e+00 -1.24783357e+00 -5.70422400e-01 -5.70422400e-01
 -5.70422400e-01  1.03360189e+00  1.03360189e+00  1.03360189e+00
  6.62353738e+00  6.62353738e+00  6.62353738e+00  2.88769101e+01
  2.88769101e+01  2.88769101e+01  1.14053930e+02  1.14053930e+02
  1.14053930e+02  1.83403063e+02  4.60092251e+02  4.60092251e+02
  4.60092251e+02  1.31421015e+03  1.31421015e+03  1.31421015e+03
  1.91402215e+03  3.01395583e+03  3.01395583e+03  3.01395583e+03
  6.63943002e+03  6.63943002e+03  6.63943002e+03  8.26830332e+03
  2.46527328e+04  7.54477204e+04]
E1 = -727.554736584182  E_coul = 202.00552785623424
cycle= 5 E= -525.549208727948  delta_E= -1.45e-10  |g|= 2.44e-06  |ddm|= 2.2e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.554736584182  E_coul = 202.00552785623424
  HOMO = -0.570423811646843  LUMO = 1.03360085936268
  mo_energy =
[-1.18086055e+02 -1.21682975e+01 -9.51946022e+00 -9.51946022e+00
 -9.51946022e+00 -1.24783538e+00 -5.70423812e-01 -5.70423812e-01
 -5.70423812e-01  1.03360086e+00  1.03360086e+00  1.03360086e+00
  6.62353432e+00  6.62353432e+00  6.62353432e+00  2.88769056e+01
  2.88769056e+01  2.88769056e+01  1.14053925e+02  1.14053925e+02
  1.14053925e+02  1.83403056e+02  4.60092245e+02  4.60092245e+02
  4.60092245e+02  1.31421014e+03  1.31421014e+03  1.31421014e+03
  1.91402214e+03  3.01395582e+03  3.01395582e+03  3.01395582e+03
  6.63943002e+03  6.63943002e+03  6.63943002e+03  8.26830331e+03
  2.46527328e+04  7.54477204e+04]
E1 = -727.5547486682229  E_coul = 202.00553994027385
Extra cycle  E= -525.549208727949  delta_E= -1.36e-12  |g|= 5.96e-07  |ddm|= 1.2e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
exp = [2.61825153e+04 7.61816791e+03 3.61808421e+03 1.61569969e+03
 2.39920898e+02 5.21216192e+01 4.59602881e+00 3.97733426e-01
 1.36278677e+03 6.65097116e+02 3.02862837e+02 3.15743049e+02
 5.69407340e+01 6.45934570e+00 1.78518838e+01 7.76876055e-01
 2.52049697e+00 2.25710782e-01]
E = -525.5492087279491
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.51531          1
[INPUT] 0    0    [1    /1   ]  7618.16791271        1
[INPUT] 0    0    [1    /1   ]  3618.08420852        1
[INPUT] 0    0    [1    /1   ]  1615.69968534        1
[INPUT] 0    0    [1    /1   ]  239.920898229        1
[INPUT] 0    0    [1    /1   ]  52.1216192042        1
[INPUT] 0    0    [1    /1   ]  4.59602881463        1
[INPUT] 0    0    [1    /1   ]  0.397733426158       1
[INPUT] 1    0    [1    /1   ]  1362.78676801        1
[INPUT] 1    0    [1    /1   ]  665.09711567         1
[INPUT] 1    0    [1    /1   ]  302.86283714         1
[INPUT] 1    0    [1    /1   ]  315.743049317        1
[INPUT] 1    0    [1    /1   ]  56.9407340218        1
[INPUT] 1    0    [1    /1   ]  6.45934570139        1
[INPUT] 1    0    [1    /1   ]  17.8518837896        1
[INPUT] 1    0    [1    /1   ]  0.776876055302       1
[INPUT] 1    0    [1    /1   ]  2.52049696711        1
[INPUT] 1    0    [1    /1   ]  0.225710782397       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.51531000448, 1.0]], [0, [7618.167912714346, 1.0]], [0, [3618.0842085187955, 1.0]], [0, [1615.6996853400713, 1.0]], [0, [239.9208982285641, 1.0]], [0, [52.12161920424907, 1.0]], [0, [4.596028814632371, 1.0]], [0, [0.3977334261582172, 1.0]], [1, [1362.7867680130926, 1.0]], [1, [665.0971156702888, 1.0]], [1, [302.86283714036045, 1.0]], [1, [315.7430493165925, 1.0]], [1, [56.94073402177876, 1.0]], [1, [6.459345701390006, 1.0]], [1, [17.851883789639082, 1.0]], [1, [0.7768760553020984, 1.0]], [1, [2.520496967111278, 1.0]], [1, [0.22571078239679945, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51531]
bas 1, expnt(s) = [7618.16791271]
bas 2, expnt(s) = [3618.08420852]
bas 3, expnt(s) = [1615.69968534]
bas 4, expnt(s) = [239.92089823]
bas 5, expnt(s) = [52.1216192]
bas 6, expnt(s) = [4.59602881]
bas 7, expnt(s) = [0.39773343]
bas 8, expnt(s) = [1362.78676801]
bas 9, expnt(s) = [665.09711567]
bas 10, expnt(s) = [302.86283714]
bas 11, expnt(s) = [315.74304932]
bas 12, expnt(s) = [56.94073402]
bas 13, expnt(s) = [6.4593457]
bas 14, expnt(s) = [17.85188379]
bas 15, expnt(s) = [0.77687606]
bas 16, expnt(s) = [2.52049697]
bas 17, expnt(s) = [0.22571078]
CPU time:       254.83
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825153e+04 5.20024193e+03 7.61816791e+03 2.06016939e+03
 3.61808421e+03 1.17862060e+03 1.61569969e+03 6.43851193e+02
 2.39920898e+02 1.54016086e+02 5.21216192e+01 4.90092942e+01
 4.59602881e+00 7.93052761e+00 3.97733426e-01 1.26534541e+00
 1.36278677e+03 2.41556806e+04 6.65097116e+02 9.85350459e+03
 3.02862837e+02 3.68588580e+03 3.15743049e+02 3.88285919e+03
 5.69407340e+01 4.56313397e+02 6.45934570e+00 3.00413921e+01
 1.78518838e+01 1.07050686e+02 7.76876055e-01 2.12776697e+00
 2.52049697e+00 9.26492945e+00 2.25710782e-01 4.53862996e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97362424942335
cond(S) = 95844.13476816416
E1 = -727.5202694699275  E_coul = 203.09988847579865
init E= -524.420380994129
    CPU time for initialize scf      0.28 sec, wall time      0.05 sec
  HOMO = -0.56015506792819  LUMO = 1.03833406698469
  mo_energy =
[-1.17872651e+02 -1.20960871e+01 -9.44815555e+00 -9.44815555e+00
 -9.44815555e+00 -1.23042693e+00 -5.60155068e-01 -5.60155068e-01
 -5.60155068e-01  1.03833407e+00  1.03833407e+00  1.03833407e+00
  6.65972235e+00  6.65972235e+00  6.65972235e+00  2.89490981e+01
  2.89490981e+01  2.89490981e+01  1.14184818e+02  1.14184818e+02
  1.14184818e+02  1.83564574e+02  4.60291448e+02  4.60291448e+02
  4.60291448e+02  1.31445667e+03  1.31445667e+03  1.31445667e+03
  1.91438830e+03  3.01426254e+03  3.01426254e+03  3.01426254e+03
  6.63985167e+03  6.63985167e+03  6.63985167e+03  8.26880731e+03
  2.46533306e+04  7.54484097e+04]
E1 = -727.392882522594  E_coul = 201.84385715809074
cycle= 1 E= -525.549025364503  delta_E= -1.13  |g|= 0.181  |ddm|= 0.218
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460058
diis-c [-0.21165323  1.        ]
  HOMO = -0.572325900524334  LUMO = 1.03213292810458
  mo_energy =
[-1.18111214e+02 -1.21800206e+01 -9.53135133e+00 -9.53135133e+00
 -9.53135133e+00 -1.25042394e+00 -5.72325901e-01 -5.72325901e-01
 -5.72325901e-01  1.03213293e+00  1.03213293e+00  1.03213293e+00
  6.61799622e+00  6.61799622e+00  6.61799622e+00  2.88654051e+01
  2.88654051e+01  2.88654051e+01  1.14034812e+02  1.14034812e+02
  1.14034812e+02  1.83378854e+02  4.60067463e+02  4.60067463e+02
  4.60067463e+02  1.31418354e+03  1.31418354e+03  1.31418354e+03
  1.91399439e+03  3.01392837e+03  3.01392837e+03  3.01392837e+03
  6.63940215e+03  6.63940215e+03  6.63940215e+03  8.26827531e+03
  2.46527049e+04  7.54476926e+04]
E1 = -727.5900632767734  E_coul = 202.04086029216938
cycle= 2 E= -525.549202984604  delta_E= -0.000178  |g|= 0.015  |ddm|= 0.0127
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0301767
diis-c [-7.08320249e-04  3.00389374e-02  9.69961063e-01]
  HOMO = -0.56993168681487  LUMO = 1.03396786946939
  mo_energy =
[-1.18082166e+02 -1.21661561e+01 -9.51727576e+00 -9.51727576e+00
 -9.51727576e+00 -1.24718988e+00 -5.69931687e-01 -5.69931687e-01
 -5.69931687e-01  1.03396787e+00  1.03396787e+00  1.03396787e+00
  6.62473834e+00  6.62473834e+00  6.62473834e+00  2.88790096e+01
  2.88790096e+01  2.88790096e+01  1.14057036e+02  1.14057036e+02
  1.14057036e+02  1.83406766e+02  4.60096080e+02  4.60096080e+02
  4.60096080e+02  1.31421422e+03  1.31421422e+03  1.31421422e+03
  1.91402644e+03  3.01396004e+03  3.01396004e+03  3.01396004e+03
  6.63943437e+03  6.63943437e+03  6.63943437e+03  8.26830774e+03
  2.46527373e+04  7.54477250e+04]
E1 = -727.5486320835106  E_coul = 201.9994235167729
cycle= 3 E= -525.549208566738  delta_E= -5.58e-06  |g|= 0.00209  |ddm|= 0.00351
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00437417
diis-c [-1.09349930e-07 -7.41793011e-04  1.21875457e-01  8.78866336e-01]
  HOMO = -0.570445147807677  LUMO = 1.03358539575666
  mo_energy =
[-1.18086142e+02 -1.21683697e+01 -9.51953318e+00 -9.51953318e+00
 -9.51953318e+00 -1.24786337e+00 -5.70445148e-01 -5.70445148e-01
 -5.70445148e-01  1.03358540e+00  1.03358540e+00  1.03358540e+00
  6.62348687e+00  6.62348687e+00  6.62348687e+00  2.88768366e+01
  2.88768366e+01  2.88768366e+01  1.14053844e+02  1.14053844e+02
  1.14053844e+02  1.83402970e+02  4.60092159e+02  4.60092159e+02
  4.60092159e+02  1.31421005e+03  1.31421005e+03  1.31421005e+03
  1.91402206e+03  3.01395574e+03  3.01395574e+03  3.01395574e+03
  6.63942993e+03  6.63942993e+03  6.63942993e+03  8.26830323e+03
  2.46527327e+04  7.54477203e+04]
E1 = -727.5549336436417  E_coul = 202.00572491583907
cycle= 4 E= -525.549208727803  delta_E= -1.61e-07  |g|= 4.09e-05  |ddm|= 0.000569
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.457e-05
diis-c [-3.90774673e-10 -2.79451846e-05  4.10800583e-03  4.50031678e-02
  9.50916772e-01]
  HOMO = -0.570422399660492  LUMO = 1.03360189154469
  mo_energy =
[-1.18086049e+02 -1.21682928e+01 -9.51945551e+00 -9.51945551e+00
 -9.51945551e+00 -1.24783357e+00 -5.70422400e-01 -5.70422400e-01
 -5.70422400e-01  1.03360189e+00  1.03360189e+00  1.03360189e+00
  6.62353738e+00  6.62353738e+00  6.62353738e+00  2.88769101e+01
  2.88769101e+01  2.88769101e+01  1.14053930e+02  1.14053930e+02
  1.14053930e+02  1.83403063e+02  4.60092251e+02  4.60092251e+02
  4.60092251e+02  1.31421015e+03  1.31421015e+03  1.31421015e+03
  1.91402215e+03  3.01395583e+03  3.01395583e+03  3.01395583e+03
  6.63943002e+03  6.63943002e+03  6.63943002e+03  8.26830332e+03
  2.46527328e+04  7.54477204e+04]
E1 = -727.554736584182  E_coul = 202.00552785623424
cycle= 5 E= -525.549208727948  delta_E= -1.45e-10  |g|= 2.44e-06  |ddm|= 2.2e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.554736584182  E_coul = 202.00552785623424
  HOMO = -0.570423811646843  LUMO = 1.03360085936268
  mo_energy =
[-1.18086055e+02 -1.21682975e+01 -9.51946022e+00 -9.51946022e+00
 -9.51946022e+00 -1.24783538e+00 -5.70423812e-01 -5.70423812e-01
 -5.70423812e-01  1.03360086e+00  1.03360086e+00  1.03360086e+00
  6.62353432e+00  6.62353432e+00  6.62353432e+00  2.88769056e+01
  2.88769056e+01  2.88769056e+01  1.14053925e+02  1.14053925e+02
  1.14053925e+02  1.83403056e+02  4.60092245e+02  4.60092245e+02
  4.60092245e+02  1.31421014e+03  1.31421014e+03  1.31421014e+03
  1.91402214e+03  3.01395582e+03  3.01395582e+03  3.01395582e+03
  6.63943002e+03  6.63943002e+03  6.63943002e+03  8.26830331e+03
  2.46527328e+04  7.54477204e+04]
E1 = -727.5547486682229  E_coul = 202.00553994027385
Extra cycle  E= -525.549208727949  delta_E= -1.36e-12  |g|= 5.96e-07  |ddm|= 1.2e-06
    CPU time for scf_cycle      0.47 sec, wall time      0.24 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 95844.13476816416
E1 = -727.5547486682229  E_coul = 202.00553994027385
init E= -525.549208727949
    CPU time for initialize scf      0.94 sec, wall time      0.19 sec
  HOMO = -0.570423585012815  LUMO = 1.03360102609937
  mo_energy =
[-1.18086054e+02 -1.21682966e+01 -9.51945930e+00 -9.51945930e+00
 -9.51945930e+00 -1.24783508e+00 -5.70423585e-01 -5.70423585e-01
 -5.70423585e-01  1.03360103e+00  1.03360103e+00  1.03360103e+00
  6.62353486e+00  6.62353486e+00  6.62353486e+00  2.88769064e+01
  2.88769064e+01  2.88769064e+01  1.14053926e+02  1.14053926e+02
  1.14053926e+02  1.83403058e+02  4.60092246e+02  4.60092246e+02
  4.60092246e+02  1.31421014e+03  1.31421014e+03  1.31421014e+03
  1.91402215e+03  3.01395583e+03  3.01395583e+03  3.01395583e+03
  6.63943002e+03  6.63943002e+03  6.63943002e+03  8.26830331e+03
  2.46527328e+04  7.54477204e+04]
E1 = -727.5547461953835  E_coul = 202.0055374674357
cycle= 1 E= -525.549208727948  delta_E= 1.36e-12  |g|= 1.31e-07  |ddm|= 2.43e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.5547461953835  E_coul = 202.0055374674357
  HOMO = -0.570423629932827  LUMO = 1.03360099284622
  mo_energy =
[-1.18086054e+02 -1.21682968e+01 -9.51945949e+00 -9.51945949e+00
 -9.51945949e+00 -1.24783514e+00 -5.70423630e-01 -5.70423630e-01
 -5.70423630e-01  1.03360099e+00  1.03360099e+00  1.03360099e+00
  6.62353475e+00  6.62353475e+00  6.62353475e+00  2.88769063e+01
  2.88769063e+01  2.88769063e+01  1.14053926e+02  1.14053926e+02
  1.14053926e+02  1.83403057e+02  4.60092246e+02  4.60092246e+02
  4.60092246e+02  1.31421014e+03  1.31421014e+03  1.31421014e+03
  1.91402214e+03  3.01395583e+03  3.01395583e+03  3.01395583e+03
  6.63943002e+03  6.63943002e+03  6.63943002e+03  8.26830331e+03
  2.46527328e+04  7.54477204e+04]
E1 = -727.5547467021756  E_coul = 202.00553797422774
Extra cycle  E= -525.549208727948  delta_E= -1.14e-13  |g|= 2.76e-08  |ddm|= 4.76e-08
    CPU time for scf_cycle      1.05 sec, wall time      0.30 sec
exp = [2.61825153e+04 7.61816791e+03 3.61808421e+03 1.61569969e+03
 2.39920898e+02 5.21216192e+01 4.59602881e+00 3.97733426e-01
 1.36278677e+03 6.65097116e+02 3.02862837e+02 3.15743049e+02
 5.69407340e+01 6.45934570e+00 1.78518838e+01 7.76876055e-01
 2.52049697e+00 2.25710782e-01]
grad_E = [-1.98764781e-06  2.18030936e-05  4.34346092e-05  6.72865834e-04
  2.94204458e-04 -1.76327692e-03 -5.90222796e-03 -1.09891096e-02
 -3.07070737e-07  6.97208556e-06  3.34538637e-05  2.91961021e-05
  9.03068291e-04  3.17790494e-03 -5.59837440e-03  3.58571090e-02
 -2.85050732e-03 -3.44874433e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5192078        1
[INPUT] 0    0    [1    /1   ]  7618.12461115        1
[INPUT] 0    0    [1    /1   ]  3617.99716924        1
[INPUT] 0    0    [1    /1   ]  1614.36667628        1
[INPUT] 0    0    [1    /1   ]  240.000550628        1
[INPUT] 0    0    [1    /1   ]  52.176417004         1
[INPUT] 0    0    [1    /1   ]  4.59954363248        1
[INPUT] 0    0    [1    /1   ]  0.39822253566        1
[INPUT] 1    0    [1    /1   ]  1362.78348614        1
[INPUT] 1    0    [1    /1   ]  665.05326168         1
[INPUT] 1    0    [1    /1   ]  302.622598394        1
[INPUT] 1    0    [1    /1   ]  315.531356253        1
[INPUT] 1    0    [1    /1   ]  61.0527231159        1
[INPUT] 1    0    [1    /1   ]  6.94453101678        1
[INPUT] 1    0    [1    /1   ]  19.335953828         1
[INPUT] 1    0    [1    /1   ]  0.777938813539       1
[INPUT] 1    0    [1    /1   ]  2.67384337457        1
[INPUT] 1    0    [1    /1   ]  0.224468878337       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.519207798083, 1.0]], [0, [7618.124611145006, 1.0]], [0, [3617.997169238358, 1.0]], [0, [1614.3666762822018, 1.0]], [0, [240.00055062830933, 1.0]], [0, [52.176417004028444, 1.0]], [0, [4.599543632483371, 1.0]], [0, [0.39822253566047267, 1.0]], [1, [1362.7834861374563, 1.0]], [1, [665.053261679717, 1.0]], [1, [302.62259839357455, 1.0]], [1, [315.5313562528823, 1.0]], [1, [61.05272311591536, 1.0]], [1, [6.9445310167771925, 1.0]], [1, [19.335953827982358, 1.0]], [1, [0.777938813539366, 1.0]], [1, [2.6738433745663026, 1.0]], [1, [0.2244688783373816, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5192078]
bas 1, expnt(s) = [7618.12461115]
bas 2, expnt(s) = [3617.99716924]
bas 3, expnt(s) = [1614.36667628]
bas 4, expnt(s) = [240.00055063]
bas 5, expnt(s) = [52.176417]
bas 6, expnt(s) = [4.59954363]
bas 7, expnt(s) = [0.39822254]
bas 8, expnt(s) = [1362.78348614]
bas 9, expnt(s) = [665.05326168]
bas 10, expnt(s) = [302.62259839]
bas 11, expnt(s) = [315.53135625]
bas 12, expnt(s) = [61.05272312]
bas 13, expnt(s) = [6.94453102]
bas 14, expnt(s) = [19.33595383]
bas 15, expnt(s) = [0.77793881]
bas 16, expnt(s) = [2.67384337]
bas 17, expnt(s) = [0.22446888]
CPU time:       260.55
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825192e+04 5.20024251e+03 7.61812461e+03 2.06016061e+03
 3.61799717e+03 1.17859933e+03 1.61436668e+03 6.43452752e+02
 2.40000551e+02 1.54054434e+02 5.21764170e+01 4.90479334e+01
 4.59954363e+00 7.93507583e+00 3.98222536e-01 1.26651226e+00
 1.36278349e+03 2.41556078e+04 6.65053262e+02 9.85269246e+03
 3.02622598e+02 3.68223149e+03 3.15531356e+02 3.87960533e+03
 6.10527231e+01 4.97869695e+02 6.94453102e+00 3.28880440e+01
 1.93359538e+01 1.18288192e+02 7.77938814e-01 2.13140604e+00
 2.67384337e+00 9.97480347e+00 2.24468878e-01 4.50743594e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97362433954938
cond(S) = 102295.51298410073
E1 = -727.5391130058287  E_coul = 203.11524051040564
init E= -524.423872495423
    CPU time for initialize scf      0.69 sec, wall time      0.19 sec
  HOMO = -0.559903488353105  LUMO = 1.03628388813386
  mo_energy =
[-1.17870788e+02 -1.20953694e+01 -9.44726152e+00 -9.44726152e+00
 -9.44726152e+00 -1.23036433e+00 -5.59903488e-01 -5.59903488e-01
 -5.59903488e-01  1.03628389e+00  1.03628389e+00  1.03628389e+00
  7.03419510e+00  7.03419510e+00  7.03419510e+00  3.15444077e+01
  3.15444077e+01  3.15444077e+01  1.24354027e+02  1.24354027e+02
  1.24354027e+02  1.83780877e+02  4.78581958e+02  4.78581958e+02
  4.78581958e+02  1.33387037e+03  1.33387037e+03  1.33387037e+03
  1.91408802e+03  3.03284203e+03  3.03284203e+03  3.03284203e+03
  6.65675677e+03  6.65675677e+03  6.65675677e+03  8.26640699e+03
  2.46491991e+04  7.54436013e+04]
E1 = -727.3925927689386  E_coul = 201.84037652171045
cycle= 1 E= -525.552216247228  delta_E= -1.13  |g|= 0.181  |ddm|= 0.25
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.460231
diis-c [-0.21181216  1.        ]
  HOMO = -0.572562872983656  LUMO = 1.02962850127868
  mo_energy =
[-1.18109367e+02 -1.21812399e+01 -9.53220757e+00 -9.53220757e+00
 -9.53220757e+00 -1.25110733e+00 -5.72562873e-01 -5.72562873e-01
 -5.72562873e-01  1.02962850e+00  1.02962850e+00  1.02962850e+00
  6.98903209e+00  6.98903209e+00  6.98903209e+00  3.14552876e+01
  3.14552876e+01  3.14552876e+01  1.24199253e+02  1.24199253e+02
  1.24199253e+02  1.83594637e+02  4.78358200e+02  4.78358200e+02
  4.78358200e+02  1.33359856e+03  1.33359856e+03  1.33359856e+03
  1.91369652e+03  3.03250991e+03  3.03250991e+03  3.03250991e+03
  6.65631005e+03  6.65631005e+03  6.65631005e+03  8.26587818e+03
  2.46485769e+04  7.54428880e+04]
E1 = -727.5926926006156  E_coul = 202.04029977611157
cycle= 2 E= -525.552392824504  delta_E= -0.000177  |g|= 0.015  |ddm|= 0.0132
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0303043
diis-c [-7.15897721e-04  3.00384399e-02  9.69961560e-01]
  HOMO = -0.570065523073643  LUMO = 1.03155761840042
  mo_energy =
[-1.18080177e+02 -1.21671668e+01 -9.51792350e+00 -9.51792350e+00
 -9.51792350e+00 -1.24774168e+00 -5.70065523e-01 -5.70065523e-01
 -5.70065523e-01  1.03155762e+00  1.03155762e+00  1.03155762e+00
  6.99631814e+00  6.99631814e+00  6.99631814e+00  3.14696927e+01
  3.14696927e+01  3.14696927e+01  1.24222084e+02  1.24222084e+02
  1.24222084e+02  1.83622696e+02  4.78386959e+02  4.78386959e+02
  4.78386959e+02  1.33362934e+03  1.33362934e+03  1.33362934e+03
  1.91372869e+03  3.03254170e+03  3.03254170e+03  3.03254170e+03
  6.65634239e+03  6.65634239e+03  6.65634239e+03  8.26591072e+03
  2.46486094e+04  7.54429205e+04]
E1 = -727.5508296110062  E_coul = 201.99843111696407
cycle= 3 E= -525.552398494042  delta_E= -5.67e-06  |g|= 0.0021  |ddm|= 0.00357
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00442327
diis-c [-9.96635057e-08 -7.43885684e-04  1.22710373e-01  8.78033512e-01]
  HOMO = -0.570583520017635  LUMO = 1.03116858069909
  mo_energy =
[-1.18084181e+02 -1.21694002e+01 -9.52020070e+00 -9.52020070e+00
 -9.52020070e+00 -1.24842216e+00 -5.70583520e-01 -5.70583520e-01
 -5.70583520e-01  1.03116858e+00  1.03116858e+00  1.03116858e+00
  6.99500124e+00  6.99500124e+00  6.99500124e+00  3.14674265e+01
  3.14674265e+01  3.14674265e+01  1.24218818e+02  1.24218818e+02
  1.24218818e+02  1.83618872e+02  4.78383012e+02  4.78383012e+02
  4.78383012e+02  1.33362515e+03  1.33362515e+03  1.33362515e+03
  1.91372428e+03  3.03253736e+03  3.03253736e+03  3.03253736e+03
  6.65633793e+03  6.65633793e+03  6.65633793e+03  8.26590618e+03
  2.46486048e+04  7.54429159e+04]
E1 = -727.5571817206438  E_coul = 202.00478306285328
cycle= 4 E= -525.55239865779  delta_E= -1.64e-07  |g|= 3.93e-05  |ddm|= 0.000581
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=7.12171e-05
diis-c [-3.74432404e-10 -2.76754486e-05  4.12098234e-03  4.40050552e-02
  9.51901638e-01]
  HOMO = -0.570561285597506  LUMO = 1.03118485907537
  mo_energy =
[-1.18084092e+02 -1.21693260e+01 -9.52012575e+00 -9.52012575e+00
 -9.52012575e+00 -1.24839308e+00 -5.70561286e-01 -5.70561286e-01
 -5.70561286e-01  1.03118486e+00  1.03118486e+00  1.03118486e+00
  6.99505193e+00  6.99505193e+00  6.99505193e+00  3.14674988e+01
  3.14674988e+01  3.14674988e+01  1.24218901e+02  1.24218901e+02
  1.24218901e+02  1.83618961e+02  4.78383100e+02  4.78383100e+02
  4.78383100e+02  1.33362524e+03  1.33362524e+03  1.33362524e+03
  1.91372437e+03  3.03253745e+03  3.03253745e+03  3.03253745e+03
  6.65633801e+03  6.65633801e+03  6.65633801e+03  8.26590627e+03
  2.46486049e+04  7.54429159e+04]
E1 = -727.5569922872949  E_coul = 202.0045936293695
cycle= 5 E= -525.552398657925  delta_E= -1.35e-10  |g|= 2.39e-06  |ddm|= 2.1e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5569922872949  E_coul = 202.0045936293695
  HOMO = -0.57056264077514  LUMO = 1.031183862259
  mo_energy =
[-1.18084098e+02 -1.21693306e+01 -9.52013036e+00 -9.52013036e+00
 -9.52013036e+00 -1.24839483e+00 -5.70562641e-01 -5.70562641e-01
 -5.70562641e-01  1.03118386e+00  1.03118386e+00  1.03118386e+00
  6.99504886e+00  6.99504886e+00  6.99504886e+00  3.14674943e+01
  3.14674943e+01  3.14674943e+01  1.24218896e+02  1.24218896e+02
  1.24218896e+02  1.83618955e+02  4.78383094e+02  4.78383094e+02
  4.78383094e+02  1.33362523e+03  1.33362523e+03  1.33362523e+03
  1.91372436e+03  3.03253745e+03  3.03253745e+03  3.03253745e+03
  6.65633801e+03  6.65633801e+03  6.65633801e+03  8.26590626e+03
  2.46486049e+04  7.54429159e+04]
E1 = -727.5570041556164  E_coul = 202.00460549769045
Extra cycle  E= -525.552398657926  delta_E= -5.68e-13  |g|= 5.86e-07  |ddm|= 1.21e-06
    CPU time for scf_cycle      0.84 sec, wall time      0.34 sec
exp = [2.61825192e+04 7.61812461e+03 3.61799717e+03 1.61436668e+03
 2.40000551e+02 5.21764170e+01 4.59954363e+00 3.98222536e-01
 1.36278349e+03 6.65053262e+02 3.02622598e+02 3.15531356e+02
 6.10527231e+01 6.94453102e+00 1.93359538e+01 7.77938814e-01
 2.67384337e+00 2.24468878e-01]
E = -525.5523986579259
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5192078        1
[INPUT] 0    0    [1    /1   ]  7618.12461115        1
[INPUT] 0    0    [1    /1   ]  3617.99716924        1
[INPUT] 0    0    [1    /1   ]  1614.36667628        1
[INPUT] 0    0    [1    /1   ]  240.000550628        1
[INPUT] 0    0    [1    /1   ]  52.176417004         1
[INPUT] 0    0    [1    /1   ]  4.59954363248        1
[INPUT] 0    0    [1    /1   ]  0.39822253566        1
[INPUT] 1    0    [1    /1   ]  1362.78348614        1
[INPUT] 1    0    [1    /1   ]  665.05326168         1
[INPUT] 1    0    [1    /1   ]  302.622598394        1
[INPUT] 1    0    [1    /1   ]  315.531356253        1
[INPUT] 1    0    [1    /1   ]  61.0527231159        1
[INPUT] 1    0    [1    /1   ]  6.94453101678        1
[INPUT] 1    0    [1    /1   ]  19.335953828         1
[INPUT] 1    0    [1    /1   ]  0.777938813539       1
[INPUT] 1    0    [1    /1   ]  2.67384337457        1
[INPUT] 1    0    [1    /1   ]  0.224468878337       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.519207798083, 1.0]], [0, [7618.124611145006, 1.0]], [0, [3617.997169238358, 1.0]], [0, [1614.3666762822018, 1.0]], [0, [240.00055062830933, 1.0]], [0, [52.176417004028444, 1.0]], [0, [4.599543632483371, 1.0]], [0, [0.39822253566047267, 1.0]], [1, [1362.7834861374563, 1.0]], [1, [665.053261679717, 1.0]], [1, [302.62259839357455, 1.0]], [1, [315.5313562528823, 1.0]], [1, [61.05272311591536, 1.0]], [1, [6.9445310167771925, 1.0]], [1, [19.335953827982358, 1.0]], [1, [0.777938813539366, 1.0]], [1, [2.6738433745663026, 1.0]], [1, [0.2244688783373816, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5192078]
bas 1, expnt(s) = [7618.12461115]
bas 2, expnt(s) = [3617.99716924]
bas 3, expnt(s) = [1614.36667628]
bas 4, expnt(s) = [240.00055063]
bas 5, expnt(s) = [52.176417]
bas 6, expnt(s) = [4.59954363]
bas 7, expnt(s) = [0.39822254]
bas 8, expnt(s) = [1362.78348614]
bas 9, expnt(s) = [665.05326168]
bas 10, expnt(s) = [302.62259839]
bas 11, expnt(s) = [315.53135625]
bas 12, expnt(s) = [61.05272312]
bas 13, expnt(s) = [6.94453102]
bas 14, expnt(s) = [19.33595383]
bas 15, expnt(s) = [0.77793881]
bas 16, expnt(s) = [2.67384337]
bas 17, expnt(s) = [0.22446888]
CPU time:       261.56
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825192e+04 5.20024251e+03 7.61812461e+03 2.06016061e+03
 3.61799717e+03 1.17859933e+03 1.61436668e+03 6.43452752e+02
 2.40000551e+02 1.54054434e+02 5.21764170e+01 4.90479334e+01
 4.59954363e+00 7.93507583e+00 3.98222536e-01 1.26651226e+00
 1.36278349e+03 2.41556078e+04 6.65053262e+02 9.85269246e+03
 3.02622598e+02 3.68223149e+03 3.15531356e+02 3.87960533e+03
 6.10527231e+01 4.97869695e+02 6.94453102e+00 3.28880440e+01
 1.93359538e+01 1.18288192e+02 7.77938814e-01 2.13140604e+00
 2.67384337e+00 9.97480347e+00 2.24468878e-01 4.50743594e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97362433954938
cond(S) = 102295.51298410073
E1 = -727.5391130058287  E_coul = 203.11524051040564
init E= -524.423872495423
    CPU time for initialize scf      0.68 sec, wall time      0.08 sec
  HOMO = -0.559903488353105  LUMO = 1.03628388813386
  mo_energy =
[-1.17870788e+02 -1.20953694e+01 -9.44726152e+00 -9.44726152e+00
 -9.44726152e+00 -1.23036433e+00 -5.59903488e-01 -5.59903488e-01
 -5.59903488e-01  1.03628389e+00  1.03628389e+00  1.03628389e+00
  7.03419510e+00  7.03419510e+00  7.03419510e+00  3.15444077e+01
  3.15444077e+01  3.15444077e+01  1.24354027e+02  1.24354027e+02
  1.24354027e+02  1.83780877e+02  4.78581958e+02  4.78581958e+02
  4.78581958e+02  1.33387037e+03  1.33387037e+03  1.33387037e+03
  1.91408802e+03  3.03284203e+03  3.03284203e+03  3.03284203e+03
  6.65675677e+03  6.65675677e+03  6.65675677e+03  8.26640699e+03
  2.46491991e+04  7.54436013e+04]
E1 = -727.3925927689386  E_coul = 201.84037652171045
cycle= 1 E= -525.552216247228  delta_E= -1.13  |g|= 0.181  |ddm|= 0.25
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.460231
diis-c [-0.21181216  1.        ]
  HOMO = -0.572562872983656  LUMO = 1.02962850127868
  mo_energy =
[-1.18109367e+02 -1.21812399e+01 -9.53220757e+00 -9.53220757e+00
 -9.53220757e+00 -1.25110733e+00 -5.72562873e-01 -5.72562873e-01
 -5.72562873e-01  1.02962850e+00  1.02962850e+00  1.02962850e+00
  6.98903209e+00  6.98903209e+00  6.98903209e+00  3.14552876e+01
  3.14552876e+01  3.14552876e+01  1.24199253e+02  1.24199253e+02
  1.24199253e+02  1.83594637e+02  4.78358200e+02  4.78358200e+02
  4.78358200e+02  1.33359856e+03  1.33359856e+03  1.33359856e+03
  1.91369652e+03  3.03250991e+03  3.03250991e+03  3.03250991e+03
  6.65631005e+03  6.65631005e+03  6.65631005e+03  8.26587818e+03
  2.46485769e+04  7.54428880e+04]
E1 = -727.5926926006156  E_coul = 202.04029977611157
cycle= 2 E= -525.552392824504  delta_E= -0.000177  |g|= 0.015  |ddm|= 0.0132
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0303043
diis-c [-7.15897721e-04  3.00384399e-02  9.69961560e-01]
  HOMO = -0.570065523073643  LUMO = 1.03155761840042
  mo_energy =
[-1.18080177e+02 -1.21671668e+01 -9.51792350e+00 -9.51792350e+00
 -9.51792350e+00 -1.24774168e+00 -5.70065523e-01 -5.70065523e-01
 -5.70065523e-01  1.03155762e+00  1.03155762e+00  1.03155762e+00
  6.99631814e+00  6.99631814e+00  6.99631814e+00  3.14696927e+01
  3.14696927e+01  3.14696927e+01  1.24222084e+02  1.24222084e+02
  1.24222084e+02  1.83622696e+02  4.78386959e+02  4.78386959e+02
  4.78386959e+02  1.33362934e+03  1.33362934e+03  1.33362934e+03
  1.91372869e+03  3.03254170e+03  3.03254170e+03  3.03254170e+03
  6.65634239e+03  6.65634239e+03  6.65634239e+03  8.26591072e+03
  2.46486094e+04  7.54429205e+04]
E1 = -727.5508296110062  E_coul = 201.99843111696407
cycle= 3 E= -525.552398494042  delta_E= -5.67e-06  |g|= 0.0021  |ddm|= 0.00357
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00442327
diis-c [-9.96635057e-08 -7.43885684e-04  1.22710373e-01  8.78033512e-01]
  HOMO = -0.570583520017635  LUMO = 1.03116858069909
  mo_energy =
[-1.18084181e+02 -1.21694002e+01 -9.52020070e+00 -9.52020070e+00
 -9.52020070e+00 -1.24842216e+00 -5.70583520e-01 -5.70583520e-01
 -5.70583520e-01  1.03116858e+00  1.03116858e+00  1.03116858e+00
  6.99500124e+00  6.99500124e+00  6.99500124e+00  3.14674265e+01
  3.14674265e+01  3.14674265e+01  1.24218818e+02  1.24218818e+02
  1.24218818e+02  1.83618872e+02  4.78383012e+02  4.78383012e+02
  4.78383012e+02  1.33362515e+03  1.33362515e+03  1.33362515e+03
  1.91372428e+03  3.03253736e+03  3.03253736e+03  3.03253736e+03
  6.65633793e+03  6.65633793e+03  6.65633793e+03  8.26590618e+03
  2.46486048e+04  7.54429159e+04]
E1 = -727.5571817206438  E_coul = 202.00478306285328
cycle= 4 E= -525.55239865779  delta_E= -1.64e-07  |g|= 3.93e-05  |ddm|= 0.000581
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=7.12171e-05
diis-c [-3.74432404e-10 -2.76754486e-05  4.12098234e-03  4.40050552e-02
  9.51901638e-01]
  HOMO = -0.570561285597506  LUMO = 1.03118485907537
  mo_energy =
[-1.18084092e+02 -1.21693260e+01 -9.52012575e+00 -9.52012575e+00
 -9.52012575e+00 -1.24839308e+00 -5.70561286e-01 -5.70561286e-01
 -5.70561286e-01  1.03118486e+00  1.03118486e+00  1.03118486e+00
  6.99505193e+00  6.99505193e+00  6.99505193e+00  3.14674988e+01
  3.14674988e+01  3.14674988e+01  1.24218901e+02  1.24218901e+02
  1.24218901e+02  1.83618961e+02  4.78383100e+02  4.78383100e+02
  4.78383100e+02  1.33362524e+03  1.33362524e+03  1.33362524e+03
  1.91372437e+03  3.03253745e+03  3.03253745e+03  3.03253745e+03
  6.65633801e+03  6.65633801e+03  6.65633801e+03  8.26590627e+03
  2.46486049e+04  7.54429159e+04]
E1 = -727.5569922872949  E_coul = 202.0045936293695
cycle= 5 E= -525.552398657925  delta_E= -1.35e-10  |g|= 2.39e-06  |ddm|= 2.1e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5569922872949  E_coul = 202.0045936293695
  HOMO = -0.57056264077514  LUMO = 1.031183862259
  mo_energy =
[-1.18084098e+02 -1.21693306e+01 -9.52013036e+00 -9.52013036e+00
 -9.52013036e+00 -1.24839483e+00 -5.70562641e-01 -5.70562641e-01
 -5.70562641e-01  1.03118386e+00  1.03118386e+00  1.03118386e+00
  6.99504886e+00  6.99504886e+00  6.99504886e+00  3.14674943e+01
  3.14674943e+01  3.14674943e+01  1.24218896e+02  1.24218896e+02
  1.24218896e+02  1.83618955e+02  4.78383094e+02  4.78383094e+02
  4.78383094e+02  1.33362523e+03  1.33362523e+03  1.33362523e+03
  1.91372436e+03  3.03253745e+03  3.03253745e+03  3.03253745e+03
  6.65633801e+03  6.65633801e+03  6.65633801e+03  8.26590626e+03
  2.46486049e+04  7.54429159e+04]
E1 = -727.5570041556164  E_coul = 202.00460549769045
Extra cycle  E= -525.552398657926  delta_E= -5.68e-13  |g|= 5.86e-07  |ddm|= 1.21e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102295.51298410073
E1 = -727.5570041556164  E_coul = 202.00460549769045
init E= -525.552398657926
    CPU time for initialize scf      1.77 sec, wall time      0.23 sec
  HOMO = -0.570562416854782  LUMO = 1.03118402859603
  mo_energy =
[-1.18084097e+02 -1.21693297e+01 -9.52012947e+00 -9.52012947e+00
 -9.52012947e+00 -1.24839454e+00 -5.70562417e-01 -5.70562417e-01
 -5.70562417e-01  1.03118403e+00  1.03118403e+00  1.03118403e+00
  6.99504941e+00  6.99504941e+00  6.99504941e+00  3.14674952e+01
  3.14674952e+01  3.14674952e+01  1.24218897e+02  1.24218897e+02
  1.24218897e+02  1.83618956e+02  4.78383096e+02  4.78383096e+02
  4.78383096e+02  1.33362523e+03  1.33362523e+03  1.33362523e+03
  1.91372436e+03  3.03253745e+03  3.03253745e+03  3.03253745e+03
  6.65633801e+03  6.65633801e+03  6.65633801e+03  8.26590626e+03
  2.46486049e+04  7.54429159e+04]
E1 = -727.5570017351158  E_coul = 202.00460307719024
cycle= 1 E= -525.552398657926  delta_E= 3.41e-13  |g|= 1.28e-07  |ddm|= 2.38e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.5570017351158  E_coul = 202.00460307719024
  HOMO = -0.570562460756981  LUMO = 1.03118399582196
  mo_energy =
[-1.18084097e+02 -1.21693299e+01 -9.52012965e+00 -9.52012965e+00
 -9.52012965e+00 -1.24839460e+00 -5.70562461e-01 -5.70562461e-01
 -5.70562461e-01  1.03118400e+00  1.03118400e+00  1.03118400e+00
  6.99504930e+00  6.99504930e+00  6.99504930e+00  3.14674950e+01
  3.14674950e+01  3.14674950e+01  1.24218897e+02  1.24218897e+02
  1.24218897e+02  1.83618956e+02  4.78383095e+02  4.78383095e+02
  4.78383095e+02  1.33362523e+03  1.33362523e+03  1.33362523e+03
  1.91372436e+03  3.03253745e+03  3.03253745e+03  3.03253745e+03
  6.65633801e+03  6.65633801e+03  6.65633801e+03  8.26590626e+03
  2.46486049e+04  7.54429159e+04]
E1 = -727.5570022311385  E_coul = 202.00460357321063
Extra cycle  E= -525.552398657928  delta_E= -2.39e-12  |g|= 2.7e-08  |ddm|= 4.71e-08
    CPU time for scf_cycle      1.88 sec, wall time      0.35 sec
exp = [2.61825192e+04 7.61812461e+03 3.61799717e+03 1.61436668e+03
 2.40000551e+02 5.21764170e+01 4.59954363e+00 3.98222536e-01
 1.36278349e+03 6.65053262e+02 3.02622598e+02 3.15531356e+02
 6.10527231e+01 6.94453102e+00 1.93359538e+01 7.77938814e-01
 2.67384337e+00 2.24468878e-01]
grad_E = [-1.98843011e-06  2.17606898e-05  4.32440903e-05  6.73204649e-04
  1.91501758e-04 -6.70053364e-04 -2.64357558e-03 -6.16845023e-03
 -5.61152153e-07  4.04985412e-06  1.76290159e-05  1.53016631e-05
  8.03678334e-04  2.64458350e-03 -3.55793185e-03  2.24943290e-02
 -3.23541768e-03 -5.06168810e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5225051        1
[INPUT] 0    0    [1    /1   ]  7618.08798013        1
[INPUT] 0    0    [1    /1   ]  3617.92353813        1
[INPUT] 0    0    [1    /1   ]  1613.23901011        1
[INPUT] 0    0    [1    /1   ]  240.06892354         1
[INPUT] 0    0    [1    /1   ]  52.2150470119        1
[INPUT] 0    0    [1    /1   ]  4.60213376126        1
[INPUT] 0    0    [1    /1   ]  0.398743298012       1
[INPUT] 1    0    [1    /1   ]  1362.78072102        1
[INPUT] 1    0    [1    /1   ]  665.016247062        1
[INPUT] 1    0    [1    /1   ]  302.419870488        1
[INPUT] 1    0    [1    /1   ]  315.352717289        1
[INPUT] 1    0    [1    /1   ]  64.4877843097        1
[INPUT] 1    0    [1    /1   ]  7.42529098046        1
[INPUT] 1    0    [1    /1   ]  20.6844049516        1
[INPUT] 1    0    [1    /1   ]  0.780469159297       1
[INPUT] 1    0    [1    /1   ]  2.86358129209        1
[INPUT] 1    0    [1    /1   ]  0.223729446958       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.522505124165, 1.0]], [0, [7618.087980126305, 1.0]], [0, [3617.923538133769, 1.0]], [0, [1613.2390101097371, 1.0]], [0, [240.06892353967496, 1.0]], [0, [52.215047011949785, 1.0]], [0, [4.602133761263829, 1.0]], [0, [0.398743298011916, 1.0]], [1, [1362.7807210166193, 1.0]], [1, [665.0162470615243, 1.0]], [1, [302.4198704882939, 1.0]], [1, [315.3527172894583, 1.0]], [1, [64.48778430965145, 1.0]], [1, [7.4252909804637515, 1.0]], [1, [20.684404951573434, 1.0]], [1, [0.7804691592970411, 1.0]], [1, [2.8635812920895494, 1.0]], [1, [0.22372944695756758, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52250512]
bas 1, expnt(s) = [7618.08798013]
bas 2, expnt(s) = [3617.92353813]
bas 3, expnt(s) = [1613.23901011]
bas 4, expnt(s) = [240.06892354]
bas 5, expnt(s) = [52.21504701]
bas 6, expnt(s) = [4.60213376]
bas 7, expnt(s) = [0.3987433]
bas 8, expnt(s) = [1362.78072102]
bas 9, expnt(s) = [665.01624706]
bas 10, expnt(s) = [302.41987049]
bas 11, expnt(s) = [315.35271729]
bas 12, expnt(s) = [64.48778431]
bas 13, expnt(s) = [7.42529098]
bas 14, expnt(s) = [20.68440495]
bas 15, expnt(s) = [0.78046916]
bas 16, expnt(s) = [2.86358129]
bas 17, expnt(s) = [0.22372945]
CPU time:       268.42
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825225e+04 5.20024300e+03 7.61808798e+03 2.06015318e+03
 3.61792354e+03 1.17858134e+03 1.61323901e+03 6.43115624e+02
 2.40068924e+02 1.54087349e+02 5.22150470e+01 4.90751662e+01
 4.60213376e+00 7.93842694e+00 3.98743298e-01 1.26775424e+00
 1.36278072e+03 2.41555466e+04 6.65016247e+02 9.85200701e+03
 3.02419870e+02 3.67914832e+03 3.15352717e+02 3.87685997e+03
 6.44877843e+01 5.33127656e+02 7.42529098e+00 3.57582486e+01
 2.06844050e+01 1.28688039e+02 7.80469159e-01 2.14007540e+00
 2.86358129e+00 1.08672908e+01 2.23729447e-01 4.48888344e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973513926693077
cond(S) = 108429.75944212847
E1 = -727.5534668593173  E_coul = 203.12828829420107
init E= -524.425178565116
    CPU time for initialize scf      0.69 sec, wall time      0.08 sec
  HOMO = -0.559589036846125  LUMO = 1.03740675196075
  mo_energy =
[-1.17869295e+02 -1.20947079e+01 -9.44638049e+00 -9.44638049e+00
 -9.44638049e+00 -1.23025064e+00 -5.59589037e-01 -5.59589037e-01
 -5.59589037e-01  1.03740675e+00  1.03740675e+00  1.03740675e+00
  7.49302003e+00  7.49302003e+00  7.49302003e+00  3.42356281e+01
  3.42356281e+01  3.42356281e+01  1.33580737e+02  1.33580737e+02
  1.33580737e+02  1.83941779e+02  4.94488010e+02  4.94488010e+02
  4.94488010e+02  1.35087754e+03  1.35087754e+03  1.35087754e+03
  1.91380792e+03  3.04920428e+03  3.04920428e+03  3.04920428e+03
  6.67169145e+03  6.67169145e+03  6.67169145e+03  8.26435236e+03
  2.46456817e+04  7.54395134e+04]
E1 = -727.3874640020056  E_coul = 201.83391362466787
cycle= 1 E= -525.553550377338  delta_E= -1.13  |g|= 0.181  |ddm|= 0.303
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.460741
diis-c [-0.21228195  1.        ]
  HOMO = -0.572709023564156  LUMO = 1.03028546203307
  mo_energy =
[-1.18108478e+02 -1.21824341e+01 -9.53305697e+00 -9.53305697e+00
 -9.53305697e+00 -1.25171535e+00 -5.72709024e-01 -5.72709024e-01
 -5.72709024e-01  1.03028546e+00  1.03028546e+00  1.03028546e+00
  7.44424037e+00  7.44424037e+00  7.44424037e+00  3.41415449e+01
  3.41415449e+01  3.41415449e+01  1.33421996e+02  1.33421996e+02
  1.33421996e+02  1.83754538e+02  4.94263814e+02  4.94263814e+02
  4.94263814e+02  1.35060609e+03  1.35060609e+03  1.35060609e+03
  1.91341746e+03  3.04887301e+03  3.04887301e+03  3.04887301e+03
  6.67124610e+03  6.67124610e+03  6.67124610e+03  8.26382517e+03
  2.46450613e+04  7.54388022e+04]
E1 = -727.5907623878845  E_coul = 202.0370347321551
cycle= 2 E= -525.553727655729  delta_E= -0.000177  |g|= 0.015  |ddm|= 0.0138
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0305447
diis-c [-7.26294513e-04  3.03091989e-02  9.69690801e-01]
  HOMO = -0.570111707251818  LUMO = 1.03231408844953
  mo_energy =
[-1.18079078e+02 -1.21681399e+01 -9.51855108e+00 -9.51855108e+00
 -9.51855108e+00 -1.24822274e+00 -5.70111707e-01 -5.70111707e-01
 -5.70111707e-01  1.03231409e+00  1.03231409e+00  1.03231409e+00
  7.45211231e+00  7.45211231e+00  7.45211231e+00  3.41566918e+01
  3.41566918e+01  3.41566918e+01  1.33445366e+02  1.33445366e+02
  1.33445366e+02  1.83782808e+02  4.94292782e+02  4.94292782e+02
  4.94292782e+02  1.35063705e+03  1.35063705e+03  1.35063705e+03
  1.91344983e+03  3.04890499e+03  3.04890499e+03  3.04890499e+03
  6.67127863e+03  6.67127863e+03  6.67127863e+03  8.26385791e+03
  2.46450940e+04  7.54388348e+04]
E1 = -727.5485136163015  E_coul = 201.99478019247616
cycle= 3 E= -525.553733423825  delta_E= -5.77e-06  |g|= 0.00211  |ddm|= 0.00364
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00446311
diis-c [-9.02718664e-08 -7.43651782e-04  1.22886892e-01  8.77856759e-01]
  HOMO = -0.570633096324987  LUMO = 1.03191824152164
  mo_energy =
[-1.18083099e+02 -1.21703869e+01 -9.52084208e+00 -9.52084208e+00
 -9.52084208e+00 -1.24890878e+00 -5.70633096e-01 -5.70633096e-01
 -5.70633096e-01  1.03191824e+00  1.03191824e+00  1.03191824e+00
  7.45072814e+00  7.45072814e+00  7.45072814e+00  3.41543479e+01
  3.41543479e+01  3.41543479e+01  1.33442047e+02  1.33442047e+02
  1.33442047e+02  1.83778967e+02  4.94288817e+02  4.94288817e+02
  4.94288817e+02  1.35063285e+03  1.35063285e+03  1.35063285e+03
  1.91344540e+03  3.04890064e+03  3.04890064e+03  3.04890064e+03
  6.67127415e+03  6.67127415e+03  6.67127415e+03  8.26385335e+03
  2.46450894e+04  7.54388302e+04]
E1 = -727.5548890492902  E_coul = 202.00115546027317
cycle= 4 E= -525.553733589017  delta_E= -1.65e-07  |g|= 3.8e-05  |ddm|= 0.000591
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.84928e-05
diis-c [-3.75217985e-10 -2.70504010e-05  4.06097242e-03  4.28366953e-02
  9.53129383e-01]
  HOMO = -0.570611273165894  LUMO = 1.03193441192775
  mo_energy =
[-1.18083013e+02 -1.21703150e+01 -9.52076946e+00 -9.52076946e+00
 -9.52076946e+00 -1.24888030e+00 -5.70611273e-01 -5.70611273e-01
 -5.70611273e-01  1.03193441e+00  1.03193441e+00  1.03193441e+00
  7.45077926e+00  7.45077926e+00  7.45077926e+00  3.41544190e+01
  3.41544190e+01  3.41544190e+01  1.33442128e+02  1.33442128e+02
  1.33442128e+02  1.83779053e+02  4.94288903e+02  4.94288903e+02
  4.94288903e+02  1.35063294e+03  1.35063294e+03  1.35063294e+03
  1.91344549e+03  3.04890073e+03  3.04890073e+03  3.04890073e+03
  6.67127423e+03  6.67127423e+03  6.67127423e+03  8.26385343e+03
  2.46450895e+04  7.54388302e+04]
E1 = -727.5547066357536  E_coul = 202.00097304661162
cycle= 5 E= -525.553733589142  delta_E= -1.25e-10  |g|= 2.33e-06  |ddm|= 2.02e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5547066357536  E_coul = 202.00097304661162
  HOMO = -0.570612579800338  LUMO = 1.03193344280512
  mo_energy =
[-1.18083019e+02 -1.21703195e+01 -9.52077398e+00 -9.52077398e+00
 -9.52077398e+00 -1.24888200e+00 -5.70612580e-01 -5.70612580e-01
 -5.70612580e-01  1.03193344e+00  1.03193344e+00  1.03193344e+00
  7.45077617e+00  7.45077617e+00  7.45077617e+00  3.41544145e+01
  3.41544145e+01  3.41544145e+01  1.33442123e+02  1.33442123e+02
  1.33442123e+02  1.83779047e+02  4.94288897e+02  4.94288897e+02
  4.94288897e+02  1.35063293e+03  1.35063293e+03  1.35063293e+03
  1.91344548e+03  3.04890072e+03  3.04890072e+03  3.04890072e+03
  6.67127423e+03  6.67127423e+03  6.67127423e+03  8.26385343e+03
  2.46450895e+04  7.54388302e+04]
E1 = -727.5547183173204  E_coul = 202.00098472817788
Extra cycle  E= -525.553733589143  delta_E= -5.68e-13  |g|= 5.77e-07  |ddm|= 1.22e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.22 sec
exp = [2.61825225e+04 7.61808798e+03 3.61792354e+03 1.61323901e+03
 2.40068924e+02 5.22150470e+01 4.60213376e+00 3.98743298e-01
 1.36278072e+03 6.65016247e+02 3.02419870e+02 3.15352717e+02
 6.44877843e+01 7.42529098e+00 2.06844050e+01 7.80469159e-01
 2.86358129e+00 2.23729447e-01]
E = -525.5537335891426
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:24:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5225051        1
[INPUT] 0    0    [1    /1   ]  7618.08798013        1
[INPUT] 0    0    [1    /1   ]  3617.92353813        1
[INPUT] 0    0    [1    /1   ]  1613.23901011        1
[INPUT] 0    0    [1    /1   ]  240.06892354         1
[INPUT] 0    0    [1    /1   ]  52.2150470119        1
[INPUT] 0    0    [1    /1   ]  4.60213376126        1
[INPUT] 0    0    [1    /1   ]  0.398743298012       1
[INPUT] 1    0    [1    /1   ]  1362.78072102        1
[INPUT] 1    0    [1    /1   ]  665.016247062        1
[INPUT] 1    0    [1    /1   ]  302.419870488        1
[INPUT] 1    0    [1    /1   ]  315.352717289        1
[INPUT] 1    0    [1    /1   ]  64.4877843097        1
[INPUT] 1    0    [1    /1   ]  7.42529098046        1
[INPUT] 1    0    [1    /1   ]  20.6844049516        1
[INPUT] 1    0    [1    /1   ]  0.780469159297       1
[INPUT] 1    0    [1    /1   ]  2.86358129209        1
[INPUT] 1    0    [1    /1   ]  0.223729446958       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.522505124165, 1.0]], [0, [7618.087980126305, 1.0]], [0, [3617.923538133769, 1.0]], [0, [1613.2390101097371, 1.0]], [0, [240.06892353967496, 1.0]], [0, [52.215047011949785, 1.0]], [0, [4.602133761263829, 1.0]], [0, [0.398743298011916, 1.0]], [1, [1362.7807210166193, 1.0]], [1, [665.0162470615243, 1.0]], [1, [302.4198704882939, 1.0]], [1, [315.3527172894583, 1.0]], [1, [64.48778430965145, 1.0]], [1, [7.4252909804637515, 1.0]], [1, [20.684404951573434, 1.0]], [1, [0.7804691592970411, 1.0]], [1, [2.8635812920895494, 1.0]], [1, [0.22372944695756758, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52250512]
bas 1, expnt(s) = [7618.08798013]
bas 2, expnt(s) = [3617.92353813]
bas 3, expnt(s) = [1613.23901011]
bas 4, expnt(s) = [240.06892354]
bas 5, expnt(s) = [52.21504701]
bas 6, expnt(s) = [4.60213376]
bas 7, expnt(s) = [0.3987433]
bas 8, expnt(s) = [1362.78072102]
bas 9, expnt(s) = [665.01624706]
bas 10, expnt(s) = [302.41987049]
bas 11, expnt(s) = [315.35271729]
bas 12, expnt(s) = [64.48778431]
bas 13, expnt(s) = [7.42529098]
bas 14, expnt(s) = [20.68440495]
bas 15, expnt(s) = [0.78046916]
bas 16, expnt(s) = [2.86358129]
bas 17, expnt(s) = [0.22372945]
CPU time:       269.43
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825225e+04 5.20024300e+03 7.61808798e+03 2.06015318e+03
 3.61792354e+03 1.17858134e+03 1.61323901e+03 6.43115624e+02
 2.40068924e+02 1.54087349e+02 5.22150470e+01 4.90751662e+01
 4.60213376e+00 7.93842694e+00 3.98743298e-01 1.26775424e+00
 1.36278072e+03 2.41555466e+04 6.65016247e+02 9.85200701e+03
 3.02419870e+02 3.67914832e+03 3.15352717e+02 3.87685997e+03
 6.44877843e+01 5.33127656e+02 7.42529098e+00 3.57582486e+01
 2.06844050e+01 1.28688039e+02 7.80469159e-01 2.14007540e+00
 2.86358129e+00 1.08672908e+01 2.23729447e-01 4.48888344e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973513926693077
cond(S) = 108429.75944212847
E1 = -727.5534668593173  E_coul = 203.12828829420107
init E= -524.425178565116
    CPU time for initialize scf      0.69 sec, wall time      0.08 sec
  HOMO = -0.559589036846125  LUMO = 1.03740675196075
  mo_energy =
[-1.17869295e+02 -1.20947079e+01 -9.44638049e+00 -9.44638049e+00
 -9.44638049e+00 -1.23025064e+00 -5.59589037e-01 -5.59589037e-01
 -5.59589037e-01  1.03740675e+00  1.03740675e+00  1.03740675e+00
  7.49302003e+00  7.49302003e+00  7.49302003e+00  3.42356281e+01
  3.42356281e+01  3.42356281e+01  1.33580737e+02  1.33580737e+02
  1.33580737e+02  1.83941779e+02  4.94488010e+02  4.94488010e+02
  4.94488010e+02  1.35087754e+03  1.35087754e+03  1.35087754e+03
  1.91380792e+03  3.04920428e+03  3.04920428e+03  3.04920428e+03
  6.67169145e+03  6.67169145e+03  6.67169145e+03  8.26435236e+03
  2.46456817e+04  7.54395134e+04]
E1 = -727.3874640020056  E_coul = 201.83391362466787
cycle= 1 E= -525.553550377338  delta_E= -1.13  |g|= 0.181  |ddm|= 0.303
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460741
diis-c [-0.21228195  1.        ]
  HOMO = -0.572709023564156  LUMO = 1.03028546203307
  mo_energy =
[-1.18108478e+02 -1.21824341e+01 -9.53305697e+00 -9.53305697e+00
 -9.53305697e+00 -1.25171535e+00 -5.72709024e-01 -5.72709024e-01
 -5.72709024e-01  1.03028546e+00  1.03028546e+00  1.03028546e+00
  7.44424037e+00  7.44424037e+00  7.44424037e+00  3.41415449e+01
  3.41415449e+01  3.41415449e+01  1.33421996e+02  1.33421996e+02
  1.33421996e+02  1.83754538e+02  4.94263814e+02  4.94263814e+02
  4.94263814e+02  1.35060609e+03  1.35060609e+03  1.35060609e+03
  1.91341746e+03  3.04887301e+03  3.04887301e+03  3.04887301e+03
  6.67124610e+03  6.67124610e+03  6.67124610e+03  8.26382517e+03
  2.46450613e+04  7.54388022e+04]
E1 = -727.5907623878845  E_coul = 202.0370347321551
cycle= 2 E= -525.553727655729  delta_E= -0.000177  |g|= 0.015  |ddm|= 0.0138
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0305447
diis-c [-7.26294513e-04  3.03091989e-02  9.69690801e-01]
  HOMO = -0.570111707251818  LUMO = 1.03231408844953
  mo_energy =
[-1.18079078e+02 -1.21681399e+01 -9.51855108e+00 -9.51855108e+00
 -9.51855108e+00 -1.24822274e+00 -5.70111707e-01 -5.70111707e-01
 -5.70111707e-01  1.03231409e+00  1.03231409e+00  1.03231409e+00
  7.45211231e+00  7.45211231e+00  7.45211231e+00  3.41566918e+01
  3.41566918e+01  3.41566918e+01  1.33445366e+02  1.33445366e+02
  1.33445366e+02  1.83782808e+02  4.94292782e+02  4.94292782e+02
  4.94292782e+02  1.35063705e+03  1.35063705e+03  1.35063705e+03
  1.91344983e+03  3.04890499e+03  3.04890499e+03  3.04890499e+03
  6.67127863e+03  6.67127863e+03  6.67127863e+03  8.26385791e+03
  2.46450940e+04  7.54388348e+04]
E1 = -727.5485136163015  E_coul = 201.99478019247616
cycle= 3 E= -525.553733423825  delta_E= -5.77e-06  |g|= 0.00211  |ddm|= 0.00364
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00446311
diis-c [-9.02718664e-08 -7.43651782e-04  1.22886892e-01  8.77856759e-01]
  HOMO = -0.570633096324987  LUMO = 1.03191824152164
  mo_energy =
[-1.18083099e+02 -1.21703869e+01 -9.52084208e+00 -9.52084208e+00
 -9.52084208e+00 -1.24890878e+00 -5.70633096e-01 -5.70633096e-01
 -5.70633096e-01  1.03191824e+00  1.03191824e+00  1.03191824e+00
  7.45072814e+00  7.45072814e+00  7.45072814e+00  3.41543479e+01
  3.41543479e+01  3.41543479e+01  1.33442047e+02  1.33442047e+02
  1.33442047e+02  1.83778967e+02  4.94288817e+02  4.94288817e+02
  4.94288817e+02  1.35063285e+03  1.35063285e+03  1.35063285e+03
  1.91344540e+03  3.04890064e+03  3.04890064e+03  3.04890064e+03
  6.67127415e+03  6.67127415e+03  6.67127415e+03  8.26385335e+03
  2.46450894e+04  7.54388302e+04]
E1 = -727.5548890492902  E_coul = 202.00115546027317
cycle= 4 E= -525.553733589017  delta_E= -1.65e-07  |g|= 3.8e-05  |ddm|= 0.000591
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.84928e-05
diis-c [-3.75217985e-10 -2.70504010e-05  4.06097242e-03  4.28366953e-02
  9.53129383e-01]
  HOMO = -0.570611273165894  LUMO = 1.03193441192775
  mo_energy =
[-1.18083013e+02 -1.21703150e+01 -9.52076946e+00 -9.52076946e+00
 -9.52076946e+00 -1.24888030e+00 -5.70611273e-01 -5.70611273e-01
 -5.70611273e-01  1.03193441e+00  1.03193441e+00  1.03193441e+00
  7.45077926e+00  7.45077926e+00  7.45077926e+00  3.41544190e+01
  3.41544190e+01  3.41544190e+01  1.33442128e+02  1.33442128e+02
  1.33442128e+02  1.83779053e+02  4.94288903e+02  4.94288903e+02
  4.94288903e+02  1.35063294e+03  1.35063294e+03  1.35063294e+03
  1.91344549e+03  3.04890073e+03  3.04890073e+03  3.04890073e+03
  6.67127423e+03  6.67127423e+03  6.67127423e+03  8.26385343e+03
  2.46450895e+04  7.54388302e+04]
E1 = -727.5547066357536  E_coul = 202.00097304661162
cycle= 5 E= -525.553733589142  delta_E= -1.25e-10  |g|= 2.33e-06  |ddm|= 2.02e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5547066357536  E_coul = 202.00097304661162
  HOMO = -0.570612579800338  LUMO = 1.03193344280512
  mo_energy =
[-1.18083019e+02 -1.21703195e+01 -9.52077398e+00 -9.52077398e+00
 -9.52077398e+00 -1.24888200e+00 -5.70612580e-01 -5.70612580e-01
 -5.70612580e-01  1.03193344e+00  1.03193344e+00  1.03193344e+00
  7.45077617e+00  7.45077617e+00  7.45077617e+00  3.41544145e+01
  3.41544145e+01  3.41544145e+01  1.33442123e+02  1.33442123e+02
  1.33442123e+02  1.83779047e+02  4.94288897e+02  4.94288897e+02
  4.94288897e+02  1.35063293e+03  1.35063293e+03  1.35063293e+03
  1.91344548e+03  3.04890072e+03  3.04890072e+03  3.04890072e+03
  6.67127423e+03  6.67127423e+03  6.67127423e+03  8.26385343e+03
  2.46450895e+04  7.54388302e+04]
E1 = -727.5547183173204  E_coul = 202.00098472817788
Extra cycle  E= -525.553733589143  delta_E= -5.68e-13  |g|= 5.77e-07  |ddm|= 1.22e-06
    CPU time for scf_cycle      0.88 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 108429.75944212847
E1 = -727.5547183173204  E_coul = 202.00098472817788
init E= -525.553733589143
    CPU time for initialize scf      0.94 sec, wall time      0.19 sec
  HOMO = -0.570612357866415  LUMO = 1.03193360966312
  mo_energy =
[-1.18083018e+02 -1.21703186e+01 -9.52077310e+00 -9.52077310e+00
 -9.52077310e+00 -1.24888171e+00 -5.70612358e-01 -5.70612358e-01
 -5.70612358e-01  1.03193361e+00  1.03193361e+00  1.03193361e+00
  7.45077673e+00  7.45077673e+00  7.45077673e+00  3.41544154e+01
  3.41544154e+01  3.41544154e+01  1.33442124e+02  1.33442124e+02
  1.33442124e+02  1.83779048e+02  4.94288898e+02  4.94288898e+02
  4.94288898e+02  1.35063293e+03  1.35063293e+03  1.35063293e+03
  1.91344548e+03  3.04890072e+03  3.04890072e+03  3.04890072e+03
  6.67127423e+03  6.67127423e+03  6.67127423e+03  8.26385343e+03
  2.46450895e+04  7.54388302e+04]
E1 = -727.55471594855  E_coul = 202.00098235940757
cycle= 1 E= -525.553733589142  delta_E= 1.14e-13  |g|= 1.25e-07  |ddm|= 2.33e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.55471594855  E_coul = 202.00098235940757
  HOMO = -0.570612400788098  LUMO = 1.03193357726808
  mo_energy =
[-1.18083018e+02 -1.21703188e+01 -9.52077328e+00 -9.52077328e+00
 -9.52077328e+00 -1.24888176e+00 -5.70612401e-01 -5.70612401e-01
 -5.70612401e-01  1.03193358e+00  1.03193358e+00  1.03193358e+00
  7.45077662e+00  7.45077662e+00  7.45077662e+00  3.41544152e+01
  3.41544152e+01  3.41544152e+01  1.33442124e+02  1.33442124e+02
  1.33442124e+02  1.83779048e+02  4.94288898e+02  4.94288898e+02
  4.94288898e+02  1.35063293e+03  1.35063293e+03  1.35063293e+03
  1.91344548e+03  3.04890072e+03  3.04890072e+03  3.04890072e+03
  6.67127423e+03  6.67127423e+03  6.67127423e+03  8.26385343e+03
  2.46450895e+04  7.54388302e+04]
E1 = -727.5547164329782  E_coul = 202.0009828438365
Extra cycle  E= -525.553733589142  delta_E= 6.82e-13  |g|= 2.63e-08  |ddm|= 4.66e-08
    CPU time for scf_cycle      1.06 sec, wall time      0.30 sec
exp = [2.61825225e+04 7.61808798e+03 3.61792354e+03 1.61323901e+03
 2.40068924e+02 5.22150470e+01 4.60213376e+00 3.98743298e-01
 1.36278072e+03 6.65016247e+02 3.02419870e+02 3.15352717e+02
 6.44877843e+01 7.42529098e+00 2.06844050e+01 7.80469159e-01
 2.86358129e+00 2.23729447e-01]
grad_E = [-1.98905544e-06  2.17140794e-05  4.30503277e-05  6.73085334e-04
  1.34220778e-04  4.22684416e-05 -2.33619785e-04 -2.61474160e-04
 -6.37207860e-07  2.73288558e-06  1.09511093e-05  9.45122516e-06
  5.55213645e-04 -7.40269831e-04 -1.45880210e-03  7.75244100e-03
  2.88734439e-03 -1.22280837e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5242945        1
[INPUT] 0    0    [1    /1   ]  7618.0681016         1
[INPUT] 0    0    [1    /1   ]  3617.88358068        1
[INPUT] 0    0    [1    /1   ]  1612.62704929        1
[INPUT] 0    0    [1    /1   ]  240.108057338        1
[INPUT] 0    0    [1    /1   ]  52.2198820804        1
[INPUT] 0    0    [1    /1   ]  4.60279974884        1
[INPUT] 0    0    [1    /1   ]  0.398752259866       1
[INPUT] 1    0    [1    /1   ]  1362.77922225        1
[INPUT] 1    0    [1    /1   ]  664.996177055        1
[INPUT] 1    0    [1    /1   ]  302.30994892         1
[INPUT] 1    0    [1    /1   ]  315.255857148        1
[INPUT] 1    0    [1    /1   ]  66.3510417841        1
[INPUT] 1    0    [1    /1   ]  7.64670951811        1
[INPUT] 1    0    [1    /1   ]  21.4366029168        1
[INPUT] 1    0    [1    /1   ]  0.774388622834       1
[INPUT] 1    0    [1    /1   ]  2.88520057376        1
[INPUT] 1    0    [1    /1   ]  0.223249928768       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.524294451447, 1.0]], [0, [7618.068101604869, 1.0]], [0, [3617.8835806776738, 1.0]], [0, [1612.6270492874849, 1.0]], [0, [240.1080573378806, 1.0]], [0, [52.21988208040116, 1.0]], [0, [4.602799748839613, 1.0]], [0, [0.3987522598663218, 1.0]], [1, [1362.7792222545995, 1.0]], [1, [664.9961770548326, 1.0]], [1, [302.3099489199378, 1.0]], [1, [315.25585714834114, 1.0]], [1, [66.35104178407424, 1.0]], [1, [7.646709518111396, 1.0]], [1, [21.43660291684658, 1.0]], [1, [0.7743886228335487, 1.0]], [1, [2.885200573762107, 1.0]], [1, [0.22324992876819186, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52429445]
bas 1, expnt(s) = [7618.0681016]
bas 2, expnt(s) = [3617.88358068]
bas 3, expnt(s) = [1612.62704929]
bas 4, expnt(s) = [240.10805734]
bas 5, expnt(s) = [52.21988208]
bas 6, expnt(s) = [4.60279975]
bas 7, expnt(s) = [0.39875226]
bas 8, expnt(s) = [1362.77922225]
bas 9, expnt(s) = [664.99617705]
bas 10, expnt(s) = [302.30994892]
bas 11, expnt(s) = [315.25585715]
bas 12, expnt(s) = [66.35104178]
bas 13, expnt(s) = [7.64670952]
bas 14, expnt(s) = [21.43660292]
bas 15, expnt(s) = [0.77438862]
bas 16, expnt(s) = [2.88520057]
bas 17, expnt(s) = [0.22324993]
CPU time:       275.60
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825243e+04 5.20024327e+03 7.61806810e+03 2.06014914e+03
 3.61788358e+03 1.17857158e+03 1.61262705e+03 6.42932647e+02
 2.40108057e+02 1.54106187e+02 5.22198821e+01 4.90785744e+01
 4.60279975e+00 7.93928852e+00 3.98752260e-01 1.26777561e+00
 1.36277922e+03 2.41555134e+04 6.64996177e+02 9.85163535e+03
 3.02309949e+02 3.67747681e+03 3.15255857e+02 3.87537156e+03
 6.63510418e+01 5.52451396e+02 7.64670952e+00 3.70960470e+01
 2.14366029e+01 1.34564142e+02 7.74388623e-01 2.11925442e+00
 2.88520057e+00 1.09699439e+01 2.23249929e-01 4.47686042e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97361771927864
cond(S) = 111850.65920630563
E1 = -727.5534350558006  E_coul = 203.1279010551502
init E= -524.42553400065
    CPU time for initialize scf      0.69 sec, wall time      0.08 sec
  HOMO = -0.559496014112239  LUMO = 1.03044165296374
  mo_energy =
[-1.17869476e+02 -1.20947578e+01 -9.44647234e+00 -9.44647234e+00
 -9.44647234e+00 -1.23032752e+00 -5.59496014e-01 -5.59496014e-01
 -5.59496014e-01  1.03044165e+00  1.03044165e+00  1.03044165e+00
  7.56791657e+00  7.56791657e+00  7.56791657e+00  3.53168642e+01
  3.53168642e+01  3.53168642e+01  1.38193686e+02  1.38193686e+02
  1.38193686e+02  1.83980788e+02  5.02785846e+02  5.02785846e+02
  5.02785846e+02  1.35989773e+03  1.35989773e+03  1.35989773e+03
  1.91360041e+03  3.05793478e+03  3.05793478e+03  3.05793478e+03
  6.67967999e+03  6.67967999e+03  6.67967999e+03  8.26318703e+03
  2.46437254e+04  7.54372510e+04]
E1 = -727.3889414859171  E_coul = 201.83518216393045
cycle= 1 E= -525.553759321987  delta_E= -1.13  |g|= 0.181  |ddm|= 0.371
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.460584
diis-c [-0.21213778  1.        ]
  HOMO = -0.572148032252036  LUMO = 1.02375184324449
  mo_energy =
[-1.18108850e+02 -1.21827205e+01 -9.53335936e+00 -9.53335936e+00
 -9.53335936e+00 -1.25130160e+00 -5.72148032e-01 -5.72148032e-01
 -5.72148032e-01  1.02375184e+00  1.02375184e+00  1.02375184e+00
  7.51881334e+00  7.51881334e+00  7.51881334e+00  3.52208657e+01
  3.52208657e+01  3.52208657e+01  1.38033158e+02  1.38033158e+02
  1.38033158e+02  1.83793306e+02  5.02561472e+02  5.02561472e+02
  5.02561472e+02  1.35962628e+03  1.35962628e+03  1.35962628e+03
  1.91320991e+03  3.05760354e+03  3.05760354e+03  3.05760354e+03
  6.67923470e+03  6.67923470e+03  6.67923470e+03  8.26265989e+03
  2.46431052e+04  7.54365399e+04]
E1 = -727.591788947708  E_coul = 202.03785344435698
cycle= 2 E= -525.553935503351  delta_E= -0.000176  |g|= 0.015  |ddm|= 0.014
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0304081
diis-c [-7.20216008e-04  3.01585022e-02  9.69841498e-01]
  HOMO = -0.569537003417658  LUMO = 1.02577685335575
  mo_energy =
[-1.18079515e+02 -1.21684720e+01 -9.51890191e+00 -9.51890191e+00
 -9.51890191e+00 -1.24779739e+00 -5.69537003e-01 -5.69537003e-01
 -5.69537003e-01  1.02577685e+00  1.02577685e+00  1.02577685e+00
  7.52678286e+00  7.52678286e+00  7.52678286e+00  3.52362293e+01
  3.52362293e+01  3.52362293e+01  1.38056642e+02  1.38056642e+02
  1.38056642e+02  1.83821512e+02  5.02590380e+02  5.02590380e+02
  5.02590380e+02  1.35965717e+03  1.35965717e+03  1.35965717e+03
  1.91324222e+03  3.05763544e+03  3.05763544e+03  3.05763544e+03
  6.67926717e+03  6.67926717e+03  6.67926717e+03  8.26269256e+03
  2.46431378e+04  7.54365725e+04]
E1 = -727.5498209613363  E_coul = 201.99587974259214
cycle= 3 E= -525.553941218744  delta_E= -5.72e-06  |g|= 0.0021  |ddm|= 0.00361
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00444428
diis-c [-8.44721959e-08 -7.44501970e-04  1.22906450e-01  8.77838052e-01]
  HOMO = -0.57005247234599  LUMO = 1.02538818731812
  mo_energy =
[-1.18083518e+02 -1.21707047e+01 -9.52117843e+00 -9.52117843e+00
 -9.52117843e+00 -1.24847609e+00 -5.70052472e-01 -5.70052472e-01
 -5.70052472e-01  1.02538819e+00  1.02538819e+00  1.02538819e+00
  7.52539596e+00  7.52539596e+00  7.52539596e+00  3.52338679e+01
  3.52338679e+01  3.52338679e+01  1.38053319e+02  1.38053319e+02
  1.38053319e+02  1.83817689e+02  5.02586433e+02  5.02586433e+02
  5.02586433e+02  1.35965299e+03  1.35965299e+03  1.35965299e+03
  1.91323781e+03  3.05763111e+03  3.05763111e+03  3.05763111e+03
  6.67926270e+03  6.67926270e+03  6.67926270e+03  8.26268802e+03
  2.46431332e+04  7.54365679e+04]
E1 = -727.556130673763  E_coul = 202.00218929265986
cycle= 4 E= -525.553941381103  delta_E= -1.62e-07  |g|= 3.67e-05  |ddm|= 0.000587
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.55959e-05
diis-c [-3.79869156e-10 -2.70725882e-05  4.05501068e-03  4.22142315e-02
  9.53757830e-01]
  HOMO = -0.570031058734292  LUMO = 1.02540395380904
  mo_energy =
[-1.18083434e+02 -1.21706349e+01 -9.52110798e+00 -9.52110798e+00
 -9.52110798e+00 -1.24844820e+00 -5.70031059e-01 -5.70031059e-01
 -5.70031059e-01  1.02540395e+00  1.02540395e+00  1.02540395e+00
  7.52544616e+00  7.52544616e+00  7.52544616e+00  3.52339374e+01
  3.52339374e+01  3.52339374e+01  1.38053398e+02  1.38053398e+02
  1.38053398e+02  1.83817772e+02  5.02586516e+02  5.02586516e+02
  5.02586516e+02  1.35965307e+03  1.35965307e+03  1.35965307e+03
  1.91323789e+03  3.05763120e+03  3.05763120e+03  3.05763120e+03
  6.67926279e+03  6.67926279e+03  6.67926279e+03  8.26268810e+03
  2.46431333e+04  7.54365680e+04]
E1 = -727.5559553316031  E_coul = 202.00201395038394
cycle= 5 E= -525.553941381219  delta_E= -1.16e-10  |g|= 2.29e-06  |ddm|= 1.93e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5559553316031  E_coul = 202.00201395038394
  HOMO = -0.570032315342753  LUMO = 1.02540302913154
  mo_energy =
[-1.18083440e+02 -1.21706392e+01 -9.52111241e+00 -9.52111241e+00
 -9.52111241e+00 -1.24844984e+00 -5.70032315e-01 -5.70032315e-01
 -5.70032315e-01  1.02540303e+00  1.02540303e+00  1.02540303e+00
  7.52544314e+00  7.52544314e+00  7.52544314e+00  3.52339330e+01
  3.52339330e+01  3.52339330e+01  1.38053393e+02  1.38053393e+02
  1.38053393e+02  1.83817766e+02  5.02586510e+02  5.02586510e+02
  5.02586510e+02  1.35965306e+03  1.35965306e+03  1.35965306e+03
  1.91323788e+03  3.05763119e+03  3.05763119e+03  3.05763119e+03
  6.67926278e+03  6.67926278e+03  6.67926278e+03  8.26268810e+03
  2.46431333e+04  7.54365679e+04]
E1 = -727.5559667243188  E_coul = 202.00202534310003
Extra cycle  E= -525.553941381219  delta_E= 4.55e-13  |g|= 5.66e-07  |ddm|= 1.21e-06
    CPU time for scf_cycle      0.84 sec, wall time      0.22 sec
exp = [2.61825243e+04 7.61806810e+03 3.61788358e+03 1.61262705e+03
 2.40108057e+02 5.22198821e+01 4.60279975e+00 3.98752260e-01
 1.36277922e+03 6.64996177e+02 3.02309949e+02 3.15255857e+02
 6.63510418e+01 7.64670952e+00 2.14366029e+01 7.74388623e-01
 2.88520057e+00 2.23249929e-01]
E = -525.5539413812187
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5242945        1
[INPUT] 0    0    [1    /1   ]  7618.0681016         1
[INPUT] 0    0    [1    /1   ]  3617.88358068        1
[INPUT] 0    0    [1    /1   ]  1612.62704929        1
[INPUT] 0    0    [1    /1   ]  240.108057338        1
[INPUT] 0    0    [1    /1   ]  52.2198820804        1
[INPUT] 0    0    [1    /1   ]  4.60279974884        1
[INPUT] 0    0    [1    /1   ]  0.398752259866       1
[INPUT] 1    0    [1    /1   ]  1362.77922225        1
[INPUT] 1    0    [1    /1   ]  664.996177055        1
[INPUT] 1    0    [1    /1   ]  302.30994892         1
[INPUT] 1    0    [1    /1   ]  315.255857148        1
[INPUT] 1    0    [1    /1   ]  66.3510417841        1
[INPUT] 1    0    [1    /1   ]  7.64670951811        1
[INPUT] 1    0    [1    /1   ]  21.4366029168        1
[INPUT] 1    0    [1    /1   ]  0.774388622834       1
[INPUT] 1    0    [1    /1   ]  2.88520057376        1
[INPUT] 1    0    [1    /1   ]  0.223249928768       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.524294451447, 1.0]], [0, [7618.068101604869, 1.0]], [0, [3617.8835806776738, 1.0]], [0, [1612.6270492874849, 1.0]], [0, [240.1080573378806, 1.0]], [0, [52.21988208040116, 1.0]], [0, [4.602799748839613, 1.0]], [0, [0.3987522598663218, 1.0]], [1, [1362.7792222545995, 1.0]], [1, [664.9961770548326, 1.0]], [1, [302.3099489199378, 1.0]], [1, [315.25585714834114, 1.0]], [1, [66.35104178407424, 1.0]], [1, [7.646709518111396, 1.0]], [1, [21.43660291684658, 1.0]], [1, [0.7743886228335487, 1.0]], [1, [2.885200573762107, 1.0]], [1, [0.22324992876819186, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52429445]
bas 1, expnt(s) = [7618.0681016]
bas 2, expnt(s) = [3617.88358068]
bas 3, expnt(s) = [1612.62704929]
bas 4, expnt(s) = [240.10805734]
bas 5, expnt(s) = [52.21988208]
bas 6, expnt(s) = [4.60279975]
bas 7, expnt(s) = [0.39875226]
bas 8, expnt(s) = [1362.77922225]
bas 9, expnt(s) = [664.99617705]
bas 10, expnt(s) = [302.30994892]
bas 11, expnt(s) = [315.25585715]
bas 12, expnt(s) = [66.35104178]
bas 13, expnt(s) = [7.64670952]
bas 14, expnt(s) = [21.43660292]
bas 15, expnt(s) = [0.77438862]
bas 16, expnt(s) = [2.88520057]
bas 17, expnt(s) = [0.22324993]
CPU time:       276.62
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825243e+04 5.20024327e+03 7.61806810e+03 2.06014914e+03
 3.61788358e+03 1.17857158e+03 1.61262705e+03 6.42932647e+02
 2.40108057e+02 1.54106187e+02 5.22198821e+01 4.90785744e+01
 4.60279975e+00 7.93928852e+00 3.98752260e-01 1.26777561e+00
 1.36277922e+03 2.41555134e+04 6.64996177e+02 9.85163535e+03
 3.02309949e+02 3.67747681e+03 3.15255857e+02 3.87537156e+03
 6.63510418e+01 5.52451396e+02 7.64670952e+00 3.70960470e+01
 2.14366029e+01 1.34564142e+02 7.74388623e-01 2.11925442e+00
 2.88520057e+00 1.09699439e+01 2.23249929e-01 4.47686042e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97361771927864
cond(S) = 111850.65920630563
E1 = -727.5534350558006  E_coul = 203.1279010551502
init E= -524.42553400065
    CPU time for initialize scf      0.69 sec, wall time      0.08 sec
  HOMO = -0.559496014112239  LUMO = 1.03044165296374
  mo_energy =
[-1.17869476e+02 -1.20947578e+01 -9.44647234e+00 -9.44647234e+00
 -9.44647234e+00 -1.23032752e+00 -5.59496014e-01 -5.59496014e-01
 -5.59496014e-01  1.03044165e+00  1.03044165e+00  1.03044165e+00
  7.56791657e+00  7.56791657e+00  7.56791657e+00  3.53168642e+01
  3.53168642e+01  3.53168642e+01  1.38193686e+02  1.38193686e+02
  1.38193686e+02  1.83980788e+02  5.02785846e+02  5.02785846e+02
  5.02785846e+02  1.35989773e+03  1.35989773e+03  1.35989773e+03
  1.91360041e+03  3.05793478e+03  3.05793478e+03  3.05793478e+03
  6.67967999e+03  6.67967999e+03  6.67967999e+03  8.26318703e+03
  2.46437254e+04  7.54372510e+04]
E1 = -727.3889414859171  E_coul = 201.83518216393045
cycle= 1 E= -525.553759321987  delta_E= -1.13  |g|= 0.181  |ddm|= 0.371
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460584
diis-c [-0.21213778  1.        ]
  HOMO = -0.572148032252036  LUMO = 1.02375184324449
  mo_energy =
[-1.18108850e+02 -1.21827205e+01 -9.53335936e+00 -9.53335936e+00
 -9.53335936e+00 -1.25130160e+00 -5.72148032e-01 -5.72148032e-01
 -5.72148032e-01  1.02375184e+00  1.02375184e+00  1.02375184e+00
  7.51881334e+00  7.51881334e+00  7.51881334e+00  3.52208657e+01
  3.52208657e+01  3.52208657e+01  1.38033158e+02  1.38033158e+02
  1.38033158e+02  1.83793306e+02  5.02561472e+02  5.02561472e+02
  5.02561472e+02  1.35962628e+03  1.35962628e+03  1.35962628e+03
  1.91320991e+03  3.05760354e+03  3.05760354e+03  3.05760354e+03
  6.67923470e+03  6.67923470e+03  6.67923470e+03  8.26265989e+03
  2.46431052e+04  7.54365399e+04]
E1 = -727.591788947708  E_coul = 202.03785344435698
cycle= 2 E= -525.553935503351  delta_E= -0.000176  |g|= 0.015  |ddm|= 0.014
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0304081
diis-c [-7.20216008e-04  3.01585022e-02  9.69841498e-01]
  HOMO = -0.569537003417658  LUMO = 1.02577685335575
  mo_energy =
[-1.18079515e+02 -1.21684720e+01 -9.51890191e+00 -9.51890191e+00
 -9.51890191e+00 -1.24779739e+00 -5.69537003e-01 -5.69537003e-01
 -5.69537003e-01  1.02577685e+00  1.02577685e+00  1.02577685e+00
  7.52678286e+00  7.52678286e+00  7.52678286e+00  3.52362293e+01
  3.52362293e+01  3.52362293e+01  1.38056642e+02  1.38056642e+02
  1.38056642e+02  1.83821512e+02  5.02590380e+02  5.02590380e+02
  5.02590380e+02  1.35965717e+03  1.35965717e+03  1.35965717e+03
  1.91324222e+03  3.05763544e+03  3.05763544e+03  3.05763544e+03
  6.67926717e+03  6.67926717e+03  6.67926717e+03  8.26269256e+03
  2.46431378e+04  7.54365725e+04]
E1 = -727.5498209613363  E_coul = 201.99587974259214
cycle= 3 E= -525.553941218744  delta_E= -5.72e-06  |g|= 0.0021  |ddm|= 0.00361
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00444428
diis-c [-8.44721959e-08 -7.44501970e-04  1.22906450e-01  8.77838052e-01]
  HOMO = -0.57005247234599  LUMO = 1.02538818731812
  mo_energy =
[-1.18083518e+02 -1.21707047e+01 -9.52117843e+00 -9.52117843e+00
 -9.52117843e+00 -1.24847609e+00 -5.70052472e-01 -5.70052472e-01
 -5.70052472e-01  1.02538819e+00  1.02538819e+00  1.02538819e+00
  7.52539596e+00  7.52539596e+00  7.52539596e+00  3.52338679e+01
  3.52338679e+01  3.52338679e+01  1.38053319e+02  1.38053319e+02
  1.38053319e+02  1.83817689e+02  5.02586433e+02  5.02586433e+02
  5.02586433e+02  1.35965299e+03  1.35965299e+03  1.35965299e+03
  1.91323781e+03  3.05763111e+03  3.05763111e+03  3.05763111e+03
  6.67926270e+03  6.67926270e+03  6.67926270e+03  8.26268802e+03
  2.46431332e+04  7.54365679e+04]
E1 = -727.556130673763  E_coul = 202.00218929265986
cycle= 4 E= -525.553941381103  delta_E= -1.62e-07  |g|= 3.67e-05  |ddm|= 0.000587
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.55959e-05
diis-c [-3.79869156e-10 -2.70725882e-05  4.05501068e-03  4.22142315e-02
  9.53757830e-01]
  HOMO = -0.570031058734292  LUMO = 1.02540395380904
  mo_energy =
[-1.18083434e+02 -1.21706349e+01 -9.52110798e+00 -9.52110798e+00
 -9.52110798e+00 -1.24844820e+00 -5.70031059e-01 -5.70031059e-01
 -5.70031059e-01  1.02540395e+00  1.02540395e+00  1.02540395e+00
  7.52544616e+00  7.52544616e+00  7.52544616e+00  3.52339374e+01
  3.52339374e+01  3.52339374e+01  1.38053398e+02  1.38053398e+02
  1.38053398e+02  1.83817772e+02  5.02586516e+02  5.02586516e+02
  5.02586516e+02  1.35965307e+03  1.35965307e+03  1.35965307e+03
  1.91323789e+03  3.05763120e+03  3.05763120e+03  3.05763120e+03
  6.67926279e+03  6.67926279e+03  6.67926279e+03  8.26268810e+03
  2.46431333e+04  7.54365680e+04]
E1 = -727.5559553316031  E_coul = 202.00201395038394
cycle= 5 E= -525.553941381219  delta_E= -1.16e-10  |g|= 2.29e-06  |ddm|= 1.93e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5559553316031  E_coul = 202.00201395038394
  HOMO = -0.570032315342753  LUMO = 1.02540302913154
  mo_energy =
[-1.18083440e+02 -1.21706392e+01 -9.52111241e+00 -9.52111241e+00
 -9.52111241e+00 -1.24844984e+00 -5.70032315e-01 -5.70032315e-01
 -5.70032315e-01  1.02540303e+00  1.02540303e+00  1.02540303e+00
  7.52544314e+00  7.52544314e+00  7.52544314e+00  3.52339330e+01
  3.52339330e+01  3.52339330e+01  1.38053393e+02  1.38053393e+02
  1.38053393e+02  1.83817766e+02  5.02586510e+02  5.02586510e+02
  5.02586510e+02  1.35965306e+03  1.35965306e+03  1.35965306e+03
  1.91323788e+03  3.05763119e+03  3.05763119e+03  3.05763119e+03
  6.67926278e+03  6.67926278e+03  6.67926278e+03  8.26268810e+03
  2.46431333e+04  7.54365679e+04]
E1 = -727.5559667243188  E_coul = 202.00202534310003
Extra cycle  E= -525.553941381219  delta_E= 4.55e-13  |g|= 5.66e-07  |ddm|= 1.21e-06
    CPU time for scf_cycle      0.88 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 111850.65920630563
E1 = -727.5559667243188  E_coul = 202.00202534310003
init E= -525.553941381219
    CPU time for initialize scf      1.41 sec, wall time      0.22 sec
  HOMO = -0.570032098733646  LUMO = 1.02540319097972
  mo_energy =
[-1.18083439e+02 -1.21706384e+01 -9.52111155e+00 -9.52111155e+00
 -9.52111155e+00 -1.24844956e+00 -5.70032099e-01 -5.70032099e-01
 -5.70032099e-01  1.02540319e+00  1.02540319e+00  1.02540319e+00
  7.52544369e+00  7.52544369e+00  7.52544369e+00  3.52339338e+01
  3.52339338e+01  3.52339338e+01  1.38053394e+02  1.38053394e+02
  1.38053394e+02  1.83817768e+02  5.02586511e+02  5.02586511e+02
  5.02586511e+02  1.35965307e+03  1.35965307e+03  1.35965307e+03
  1.91323789e+03  3.05763119e+03  3.05763119e+03  3.05763119e+03
  6.67926278e+03  6.67926278e+03  6.67926278e+03  8.26268810e+03
  2.46431333e+04  7.54365679e+04]
E1 = -727.5559644291988  E_coul = 202.00202304798057
cycle= 1 E= -525.553941381218  delta_E= 4.55e-13  |g|= 1.22e-07  |ddm|= 2.25e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.5559644291988  E_coul = 202.00202304798057
  HOMO = -0.570032140157981  LUMO = 1.02540315993038
  mo_energy =
[-1.18083439e+02 -1.21706386e+01 -9.52111172e+00 -9.52111172e+00
 -9.52111172e+00 -1.24844961e+00 -5.70032140e-01 -5.70032140e-01
 -5.70032140e-01  1.02540316e+00  1.02540316e+00  1.02540316e+00
  7.52544358e+00  7.52544358e+00  7.52544358e+00  3.52339337e+01
  3.52339337e+01  3.52339337e+01  1.38053394e+02  1.38053394e+02
  1.38053394e+02  1.83817767e+02  5.02586511e+02  5.02586511e+02
  5.02586511e+02  1.35965307e+03  1.35965307e+03  1.35965307e+03
  1.91323789e+03  3.05763119e+03  3.05763119e+03  3.05763119e+03
  6.67926278e+03  6.67926278e+03  6.67926278e+03  8.26268810e+03
  2.46431333e+04  7.54365679e+04]
E1 = -727.5559648965954  E_coul = 202.00202351537646
Extra cycle  E= -525.553941381219  delta_E= -6.82e-13  |g|= 2.55e-08  |ddm|= 4.5e-08
    CPU time for scf_cycle      1.53 sec, wall time      0.34 sec
exp = [2.61825243e+04 7.61806810e+03 3.61788358e+03 1.61262705e+03
 2.40108057e+02 5.22198821e+01 4.60279975e+00 3.98752260e-01
 1.36277922e+03 6.64996177e+02 3.02309949e+02 3.15255857e+02
 6.63510418e+01 7.64670952e+00 2.14366029e+01 7.74388623e-01
 2.88520057e+00 2.23249929e-01]
grad_E = [-1.98930832e-06  2.16664402e-05  4.28774499e-05  6.72175057e-04
  1.63638327e-04 -4.03766916e-06  3.09489004e-04 -3.70650687e-04
 -6.54829425e-07  2.21273848e-06  8.40069293e-06  7.22741322e-06
  4.72020508e-04  3.32900775e-03 -1.29451367e-03 -1.53861357e-02
 -4.79779392e-03  3.09999636e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5252213        1
[INPUT] 0    0    [1    /1   ]  7618.05780534        1
[INPUT] 0    0    [1    /1   ]  3617.8628846         1
[INPUT] 0    0    [1    /1   ]  1612.31007775        1
[INPUT] 0    0    [1    /1   ]  240.127980318        1
[INPUT] 0    0    [1    /1   ]  52.2245718175        1
[INPUT] 0    0    [1    /1   ]  4.60270380119        1
[INPUT] 0    0    [1    /1   ]  0.398826950646       1
[INPUT] 1    0    [1    /1   ]  1362.77845513        1
[INPUT] 1    0    [1    /1   ]  664.985849518        1
[INPUT] 1    0    [1    /1   ]  302.253423151        1
[INPUT] 1    0    [1    /1   ]  315.20604835         1
[INPUT] 1    0    [1    /1   ]  67.2790138254        1
[INPUT] 1    0    [1    /1   ]  7.84711044285        1
[INPUT] 1    0    [1    /1   ]  21.891933059         1
[INPUT] 1    0    [1    /1   ]  0.788350632099       1
[INPUT] 1    0    [1    /1   ]  2.98883643639        1
[INPUT] 1    0    [1    /1   ]  0.225477665604       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.525221267948, 1.0]], [0, [7618.057805338531, 1.0]], [0, [3617.8628845986004, 1.0]], [0, [1612.310077754695, 1.0]], [0, [240.12798031849985, 1.0]], [0, [52.224571817497335, 1.0]], [0, [4.602703801193759, 1.0]], [0, [0.3988269506464604, 1.0]], [1, [1362.778455126045, 1.0]], [1, [664.9858495179908, 1.0]], [1, [302.2534231511658, 1.0]], [1, [315.20604835025796, 1.0]], [1, [67.27901382544894, 1.0]], [1, [7.847110442850752, 1.0]], [1, [21.891933058985092, 1.0]], [1, [0.7883506320994172, 1.0]], [1, [2.9888364363899913, 1.0]], [1, [0.22547766560369234, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52522127]
bas 1, expnt(s) = [7618.05780534]
bas 2, expnt(s) = [3617.8628846]
bas 3, expnt(s) = [1612.31007775]
bas 4, expnt(s) = [240.12798032]
bas 5, expnt(s) = [52.22457182]
bas 6, expnt(s) = [4.6027038]
bas 7, expnt(s) = [0.39882695]
bas 8, expnt(s) = [1362.77845513]
bas 9, expnt(s) = [664.98584952]
bas 10, expnt(s) = [302.25342315]
bas 11, expnt(s) = [315.20604835]
bas 12, expnt(s) = [67.27901383]
bas 13, expnt(s) = [7.84711044]
bas 14, expnt(s) = [21.89193306]
bas 15, expnt(s) = [0.78835063]
bas 16, expnt(s) = [2.98883644]
bas 17, expnt(s) = [0.22547767]
CPU time:       283.47
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825252e+04 5.20024341e+03 7.61805781e+03 2.06014706e+03
 3.61786288e+03 1.17856653e+03 1.61231008e+03 6.42837866e+02
 2.40127980e+02 1.54115777e+02 5.22245718e+01 4.90818801e+01
 4.60270380e+00 7.93916439e+00 3.98826951e-01 1.26795371e+00
 1.36277846e+03 2.41554964e+04 6.64985850e+02 9.85144410e+03
 3.02253423e+02 3.67661731e+03 3.15206048e+02 3.87460621e+03
 6.72790138e+01 5.62126311e+02 7.84711044e+00 3.83152443e+01
 2.18919331e+01 1.38146387e+02 7.88350632e-01 2.16712353e+00
 2.98883644e+00 1.14646837e+01 2.25477666e-01 4.53277127e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973169727630495
cond(S) = 113929.62558995686
E1 = -727.5560673377577  E_coul = 203.13012116428794
init E= -524.42594617347
    CPU time for initialize scf      0.69 sec, wall time      0.08 sec
  HOMO = -0.559412671016773  LUMO = 1.05184786250069
  mo_energy =
[-1.17869286e+02 -1.20946195e+01 -9.44633596e+00 -9.44633596e+00
 -9.44633596e+00 -1.23026918e+00 -5.59412671e-01 -5.59412671e-01
 -5.59412671e-01  1.05184786e+00  1.05184786e+00  1.05184786e+00
  7.86966567e+00  7.86966567e+00  7.86966567e+00  3.65282650e+01
  3.65282650e+01  3.65282650e+01  1.41377514e+02  1.41377514e+02
  1.41377514e+02  1.84005539e+02  5.07733042e+02  5.07733042e+02
  5.07733042e+02  1.36514730e+03  1.36514730e+03  1.36514730e+03
  1.91349876e+03  3.06299576e+03  3.06299576e+03  3.06299576e+03
  6.68431165e+03  6.68431165e+03  6.68431165e+03  8.26258862e+03
  2.46427171e+04  7.54360839e+04]
E1 = -727.3965488337942  E_coul = 201.842643552495
cycle= 1 E= -525.553905281299  delta_E= -1.13  |g|= 0.181  |ddm|= 0.344
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.460712
diis-c [-0.21225595  1.        ]
  HOMO = -0.572134954358404  LUMO = 1.04480783899746
  mo_energy =
[-1.18107637e+02 -1.21821073e+01 -9.53275610e+00 -9.53275610e+00
 -9.53275610e+00 -1.25131840e+00 -5.72134954e-01 -5.72134954e-01
 -5.72134954e-01  1.04480784e+00  1.04480784e+00  1.04480784e+00
  7.81946855e+00  7.81946855e+00  7.81946855e+00  3.64316536e+01
  3.64316536e+01  3.64316536e+01  1.41217189e+02  1.41217189e+02
  1.41217189e+02  1.83818993e+02  5.07509746e+02  5.07509746e+02
  5.07509746e+02  1.36487709e+03  1.36487709e+03  1.36487709e+03
  1.91310949e+03  3.06266578e+03  3.06266578e+03  3.06266578e+03
  6.68386766e+03  6.68386766e+03  6.68386766e+03  8.26206278e+03
  2.46420982e+04  7.54353741e+04]
E1 = -727.5979656244341  E_coul = 202.04388533741806
cycle= 2 E= -525.554080287016  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.0139
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0303694
diis-c [-7.18245656e-04  3.01229354e-02  9.69877065e-01]
  HOMO = -0.56955607519707  LUMO = 1.0468600038121
  mo_energy =
[-1.18078468e+02 -1.21679550e+01 -9.51839566e+00 -9.51839566e+00
 -9.51839566e+00 -1.24785428e+00 -5.69556075e-01 -5.69556075e-01
 -5.69556075e-01  1.04686000e+00  1.04686000e+00  1.04686000e+00
  7.82756293e+00  7.82756293e+00  7.82756293e+00  3.64470849e+01
  3.64470849e+01  3.64470849e+01  1.41240608e+02  1.41240608e+02
  1.41240608e+02  1.83847041e+02  5.07538486e+02  5.07538486e+02
  5.07538486e+02  1.36490780e+03  1.36490780e+03  1.36490780e+03
  1.91314162e+03  3.06269750e+03  3.06269750e+03  3.06269750e+03
  6.68389994e+03  6.68389994e+03  6.68389994e+03  8.26209526e+03
  2.46421306e+04  7.54354065e+04]
E1 = -727.556343401424  E_coul = 202.00225747360992
cycle= 3 E= -525.554085927814  delta_E= -5.64e-06  |g|= 0.00208  |ddm|= 0.00359
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00442533
diis-c [-8.46299329e-08 -7.42432789e-04  1.22571688e-01  8.78170745e-01]
  HOMO = -0.57006726303176  LUMO = 1.04646510354565
  mo_energy =
[-1.18082442e+02 -1.21701699e+01 -9.52065415e+00 -9.52065415e+00
 -9.52065415e+00 -1.24852756e+00 -5.70067263e-01 -5.70067263e-01
 -5.70067263e-01  1.04646510e+00  1.04646510e+00  1.04646510e+00
  7.82615865e+00  7.82615865e+00  7.82615865e+00  3.64447215e+01
  3.64447215e+01  3.64447215e+01  1.41237302e+02  1.41237302e+02
  1.41237302e+02  1.83843246e+02  5.07534567e+02  5.07534567e+02
  5.07534567e+02  1.36490364e+03  1.36490364e+03  1.36490364e+03
  1.91313724e+03  3.06269320e+03  3.06269320e+03  3.06269320e+03
  6.68389551e+03  6.68389551e+03  6.68389551e+03  8.26209076e+03
  2.46421261e+04  7.54354019e+04]
E1 = -727.5625986402603  E_coul = 202.00851255255546
cycle= 4 E= -525.554086087705  delta_E= -1.6e-07  |g|= 3.7e-05  |ddm|= 0.000585
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.62176e-05
diis-c [-3.81450938e-10 -2.61996648e-05  3.92062418e-03  4.15599009e-02
  9.54545675e-01]
  HOMO = -0.570045848087896  LUMO = 1.04648124285542
  mo_energy =
[-1.18082358e+02 -1.21700999e+01 -9.52058340e+00 -9.52058340e+00
 -9.52058340e+00 -1.24849966e+00 -5.70045848e-01 -5.70045848e-01
 -5.70045848e-01  1.04648124e+00  1.04648124e+00  1.04648124e+00
  7.82620978e+00  7.82620978e+00  7.82620978e+00  3.64447916e+01
  3.64447916e+01  3.64447916e+01  1.41237382e+02  1.41237382e+02
  1.41237382e+02  1.83843330e+02  5.07534651e+02  5.07534651e+02
  5.07534651e+02  1.36490373e+03  1.36490373e+03  1.36490373e+03
  1.91313732e+03  3.06269329e+03  3.06269329e+03  3.06269329e+03
  6.68389559e+03  6.68389559e+03  6.68389559e+03  8.26209084e+03
  2.46421262e+04  7.54354020e+04]
E1 = -727.5624225682417  E_coul = 202.00833648042166
cycle= 5 E= -525.55408608782  delta_E= -1.15e-10  |g|= 2.32e-06  |ddm|= 1.95e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5624225682417  E_coul = 202.00833648042166
  HOMO = -0.570047130133556  LUMO = 1.04648027709927
  mo_energy =
[-1.18082364e+02 -1.21701043e+01 -9.52058791e+00 -9.52058791e+00
 -9.52058791e+00 -1.24850133e+00 -5.70047130e-01 -5.70047130e-01
 -5.70047130e-01  1.04648028e+00  1.04648028e+00  1.04648028e+00
  7.82620665e+00  7.82620665e+00  7.82620665e+00  3.64447870e+01
  3.64447870e+01  3.64447870e+01  1.41237376e+02  1.41237376e+02
  1.41237376e+02  1.83843324e+02  5.07534645e+02  5.07534645e+02
  5.07534645e+02  1.36490372e+03  1.36490372e+03  1.36490372e+03
  1.91313731e+03  3.06269328e+03  3.06269328e+03  3.06269328e+03
  6.68389559e+03  6.68389559e+03  6.68389559e+03  8.26209083e+03
  2.46421262e+04  7.54354020e+04]
E1 = -727.5624341479892  E_coul = 202.00834806016718
Extra cycle  E= -525.554086087822  delta_E= -2.05e-12  |g|= 5.74e-07  |ddm|= 1.24e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.22 sec
exp = [2.61825252e+04 7.61805781e+03 3.61786288e+03 1.61231008e+03
 2.40127980e+02 5.22245718e+01 4.60270380e+00 3.98826951e-01
 1.36277846e+03 6.64985850e+02 3.02253423e+02 3.15206048e+02
 6.72790138e+01 7.84711044e+00 2.18919331e+01 7.88350632e-01
 2.98883644e+00 2.25477666e-01]
E = -525.554086087822
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5252213        1
[INPUT] 0    0    [1    /1   ]  7618.05780534        1
[INPUT] 0    0    [1    /1   ]  3617.8628846         1
[INPUT] 0    0    [1    /1   ]  1612.31007775        1
[INPUT] 0    0    [1    /1   ]  240.127980318        1
[INPUT] 0    0    [1    /1   ]  52.2245718175        1
[INPUT] 0    0    [1    /1   ]  4.60270380119        1
[INPUT] 0    0    [1    /1   ]  0.398826950646       1
[INPUT] 1    0    [1    /1   ]  1362.77845513        1
[INPUT] 1    0    [1    /1   ]  664.985849518        1
[INPUT] 1    0    [1    /1   ]  302.253423151        1
[INPUT] 1    0    [1    /1   ]  315.20604835         1
[INPUT] 1    0    [1    /1   ]  67.2790138254        1
[INPUT] 1    0    [1    /1   ]  7.84711044285        1
[INPUT] 1    0    [1    /1   ]  21.891933059         1
[INPUT] 1    0    [1    /1   ]  0.788350632099       1
[INPUT] 1    0    [1    /1   ]  2.98883643639        1
[INPUT] 1    0    [1    /1   ]  0.225477665604       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.525221267948, 1.0]], [0, [7618.057805338531, 1.0]], [0, [3617.8628845986004, 1.0]], [0, [1612.310077754695, 1.0]], [0, [240.12798031849985, 1.0]], [0, [52.224571817497335, 1.0]], [0, [4.602703801193759, 1.0]], [0, [0.3988269506464604, 1.0]], [1, [1362.778455126045, 1.0]], [1, [664.9858495179908, 1.0]], [1, [302.2534231511658, 1.0]], [1, [315.20604835025796, 1.0]], [1, [67.27901382544894, 1.0]], [1, [7.847110442850752, 1.0]], [1, [21.891933058985092, 1.0]], [1, [0.7883506320994172, 1.0]], [1, [2.9888364363899913, 1.0]], [1, [0.22547766560369234, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52522127]
bas 1, expnt(s) = [7618.05780534]
bas 2, expnt(s) = [3617.8628846]
bas 3, expnt(s) = [1612.31007775]
bas 4, expnt(s) = [240.12798032]
bas 5, expnt(s) = [52.22457182]
bas 6, expnt(s) = [4.6027038]
bas 7, expnt(s) = [0.39882695]
bas 8, expnt(s) = [1362.77845513]
bas 9, expnt(s) = [664.98584952]
bas 10, expnt(s) = [302.25342315]
bas 11, expnt(s) = [315.20604835]
bas 12, expnt(s) = [67.27901383]
bas 13, expnt(s) = [7.84711044]
bas 14, expnt(s) = [21.89193306]
bas 15, expnt(s) = [0.78835063]
bas 16, expnt(s) = [2.98883644]
bas 17, expnt(s) = [0.22547767]
CPU time:       284.46
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825252e+04 5.20024341e+03 7.61805781e+03 2.06014706e+03
 3.61786288e+03 1.17856653e+03 1.61231008e+03 6.42837866e+02
 2.40127980e+02 1.54115777e+02 5.22245718e+01 4.90818801e+01
 4.60270380e+00 7.93916439e+00 3.98826951e-01 1.26795371e+00
 1.36277846e+03 2.41554964e+04 6.64985850e+02 9.85144410e+03
 3.02253423e+02 3.67661731e+03 3.15206048e+02 3.87460621e+03
 6.72790138e+01 5.62126311e+02 7.84711044e+00 3.83152443e+01
 2.18919331e+01 1.38146387e+02 7.88350632e-01 2.16712353e+00
 2.98883644e+00 1.14646837e+01 2.25477666e-01 4.53277127e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973169727630495
cond(S) = 113929.62558995686
E1 = -727.5560673377577  E_coul = 203.13012116428794
init E= -524.42594617347
    CPU time for initialize scf      0.69 sec, wall time      0.08 sec
  HOMO = -0.559412671016773  LUMO = 1.05184786250069
  mo_energy =
[-1.17869286e+02 -1.20946195e+01 -9.44633596e+00 -9.44633596e+00
 -9.44633596e+00 -1.23026918e+00 -5.59412671e-01 -5.59412671e-01
 -5.59412671e-01  1.05184786e+00  1.05184786e+00  1.05184786e+00
  7.86966567e+00  7.86966567e+00  7.86966567e+00  3.65282650e+01
  3.65282650e+01  3.65282650e+01  1.41377514e+02  1.41377514e+02
  1.41377514e+02  1.84005539e+02  5.07733042e+02  5.07733042e+02
  5.07733042e+02  1.36514730e+03  1.36514730e+03  1.36514730e+03
  1.91349876e+03  3.06299576e+03  3.06299576e+03  3.06299576e+03
  6.68431165e+03  6.68431165e+03  6.68431165e+03  8.26258862e+03
  2.46427171e+04  7.54360839e+04]
E1 = -727.3965488337942  E_coul = 201.842643552495
cycle= 1 E= -525.553905281299  delta_E= -1.13  |g|= 0.181  |ddm|= 0.344
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.460712
diis-c [-0.21225595  1.        ]
  HOMO = -0.572134954358404  LUMO = 1.04480783899746
  mo_energy =
[-1.18107637e+02 -1.21821073e+01 -9.53275610e+00 -9.53275610e+00
 -9.53275610e+00 -1.25131840e+00 -5.72134954e-01 -5.72134954e-01
 -5.72134954e-01  1.04480784e+00  1.04480784e+00  1.04480784e+00
  7.81946855e+00  7.81946855e+00  7.81946855e+00  3.64316536e+01
  3.64316536e+01  3.64316536e+01  1.41217189e+02  1.41217189e+02
  1.41217189e+02  1.83818993e+02  5.07509746e+02  5.07509746e+02
  5.07509746e+02  1.36487709e+03  1.36487709e+03  1.36487709e+03
  1.91310949e+03  3.06266578e+03  3.06266578e+03  3.06266578e+03
  6.68386766e+03  6.68386766e+03  6.68386766e+03  8.26206278e+03
  2.46420982e+04  7.54353741e+04]
E1 = -727.5979656244341  E_coul = 202.04388533741806
cycle= 2 E= -525.554080287016  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.0139
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0303694
diis-c [-7.18245656e-04  3.01229354e-02  9.69877065e-01]
  HOMO = -0.56955607519707  LUMO = 1.0468600038121
  mo_energy =
[-1.18078468e+02 -1.21679550e+01 -9.51839566e+00 -9.51839566e+00
 -9.51839566e+00 -1.24785428e+00 -5.69556075e-01 -5.69556075e-01
 -5.69556075e-01  1.04686000e+00  1.04686000e+00  1.04686000e+00
  7.82756293e+00  7.82756293e+00  7.82756293e+00  3.64470849e+01
  3.64470849e+01  3.64470849e+01  1.41240608e+02  1.41240608e+02
  1.41240608e+02  1.83847041e+02  5.07538486e+02  5.07538486e+02
  5.07538486e+02  1.36490780e+03  1.36490780e+03  1.36490780e+03
  1.91314162e+03  3.06269750e+03  3.06269750e+03  3.06269750e+03
  6.68389994e+03  6.68389994e+03  6.68389994e+03  8.26209526e+03
  2.46421306e+04  7.54354065e+04]
E1 = -727.556343401424  E_coul = 202.00225747360992
cycle= 3 E= -525.554085927814  delta_E= -5.64e-06  |g|= 0.00208  |ddm|= 0.00359
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00442533
diis-c [-8.46299329e-08 -7.42432789e-04  1.22571688e-01  8.78170745e-01]
  HOMO = -0.57006726303176  LUMO = 1.04646510354565
  mo_energy =
[-1.18082442e+02 -1.21701699e+01 -9.52065415e+00 -9.52065415e+00
 -9.52065415e+00 -1.24852756e+00 -5.70067263e-01 -5.70067263e-01
 -5.70067263e-01  1.04646510e+00  1.04646510e+00  1.04646510e+00
  7.82615865e+00  7.82615865e+00  7.82615865e+00  3.64447215e+01
  3.64447215e+01  3.64447215e+01  1.41237302e+02  1.41237302e+02
  1.41237302e+02  1.83843246e+02  5.07534567e+02  5.07534567e+02
  5.07534567e+02  1.36490364e+03  1.36490364e+03  1.36490364e+03
  1.91313724e+03  3.06269320e+03  3.06269320e+03  3.06269320e+03
  6.68389551e+03  6.68389551e+03  6.68389551e+03  8.26209076e+03
  2.46421261e+04  7.54354019e+04]
E1 = -727.5625986402603  E_coul = 202.00851255255546
cycle= 4 E= -525.554086087705  delta_E= -1.6e-07  |g|= 3.7e-05  |ddm|= 0.000585
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.62176e-05
diis-c [-3.81450938e-10 -2.61996648e-05  3.92062418e-03  4.15599009e-02
  9.54545675e-01]
  HOMO = -0.570045848087896  LUMO = 1.04648124285542
  mo_energy =
[-1.18082358e+02 -1.21700999e+01 -9.52058340e+00 -9.52058340e+00
 -9.52058340e+00 -1.24849966e+00 -5.70045848e-01 -5.70045848e-01
 -5.70045848e-01  1.04648124e+00  1.04648124e+00  1.04648124e+00
  7.82620978e+00  7.82620978e+00  7.82620978e+00  3.64447916e+01
  3.64447916e+01  3.64447916e+01  1.41237382e+02  1.41237382e+02
  1.41237382e+02  1.83843330e+02  5.07534651e+02  5.07534651e+02
  5.07534651e+02  1.36490373e+03  1.36490373e+03  1.36490373e+03
  1.91313732e+03  3.06269329e+03  3.06269329e+03  3.06269329e+03
  6.68389559e+03  6.68389559e+03  6.68389559e+03  8.26209084e+03
  2.46421262e+04  7.54354020e+04]
E1 = -727.5624225682417  E_coul = 202.00833648042166
cycle= 5 E= -525.55408608782  delta_E= -1.15e-10  |g|= 2.32e-06  |ddm|= 1.95e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5624225682417  E_coul = 202.00833648042166
  HOMO = -0.570047130133556  LUMO = 1.04648027709927
  mo_energy =
[-1.18082364e+02 -1.21701043e+01 -9.52058791e+00 -9.52058791e+00
 -9.52058791e+00 -1.24850133e+00 -5.70047130e-01 -5.70047130e-01
 -5.70047130e-01  1.04648028e+00  1.04648028e+00  1.04648028e+00
  7.82620665e+00  7.82620665e+00  7.82620665e+00  3.64447870e+01
  3.64447870e+01  3.64447870e+01  1.41237376e+02  1.41237376e+02
  1.41237376e+02  1.83843324e+02  5.07534645e+02  5.07534645e+02
  5.07534645e+02  1.36490372e+03  1.36490372e+03  1.36490372e+03
  1.91313731e+03  3.06269328e+03  3.06269328e+03  3.06269328e+03
  6.68389559e+03  6.68389559e+03  6.68389559e+03  8.26209083e+03
  2.46421262e+04  7.54354020e+04]
E1 = -727.5624341479892  E_coul = 202.00834806016718
Extra cycle  E= -525.554086087822  delta_E= -2.05e-12  |g|= 5.74e-07  |ddm|= 1.24e-06
    CPU time for scf_cycle      0.84 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 113929.62558995686
E1 = -727.5624341479892  E_coul = 202.00834806016718
init E= -525.554086087822
    CPU time for initialize scf      1.80 sec, wall time      0.26 sec
  HOMO = -0.570046909989668  LUMO = 1.04648044552871
  mo_energy =
[-1.18082363e+02 -1.21701034e+01 -9.52058704e+00 -9.52058704e+00
 -9.52058704e+00 -1.24850104e+00 -5.70046910e-01 -5.70046910e-01
 -5.70046910e-01  1.04648045e+00  1.04648045e+00  1.04648045e+00
  7.82620722e+00  7.82620722e+00  7.82620722e+00  3.64447879e+01
  3.64447879e+01  3.64447879e+01  1.41237378e+02  1.41237378e+02
  1.41237378e+02  1.83843325e+02  5.07534646e+02  5.07534646e+02
  5.07534646e+02  1.36490372e+03  1.36490372e+03  1.36490372e+03
  1.91313731e+03  3.06269328e+03  3.06269328e+03  3.06269328e+03
  6.68389559e+03  6.68389559e+03  6.68389559e+03  8.26209083e+03
  2.46421262e+04  7.54354020e+04]
E1 = -727.562431816875  E_coul = 202.00834572905356
cycle= 1 E= -525.554086087821  delta_E= 5.68e-13  |g|= 1.24e-07  |ddm|= 2.3e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.562431816875  E_coul = 202.00834572905356
  HOMO = -0.570046952062271  LUMO = 1.04648041322872
  mo_energy =
[-1.18082363e+02 -1.21701036e+01 -9.52058721e+00 -9.52058721e+00
 -9.52058721e+00 -1.24850110e+00 -5.70046952e-01 -5.70046952e-01
 -5.70046952e-01  1.04648041e+00  1.04648041e+00  1.04648041e+00
  7.82620711e+00  7.82620711e+00  7.82620711e+00  3.64447878e+01
  3.64447878e+01  3.64447878e+01  1.41237377e+02  1.41237377e+02
  1.41237377e+02  1.83843325e+02  5.07534646e+02  5.07534646e+02
  5.07534646e+02  1.36490372e+03  1.36490372e+03  1.36490372e+03
  1.91313731e+03  3.06269328e+03  3.06269328e+03  3.06269328e+03
  6.68389559e+03  6.68389559e+03  6.68389559e+03  8.26209083e+03
  2.46421262e+04  7.54354020e+04]
E1 = -727.5624322911294  E_coul = 202.00834620330818
Extra cycle  E= -525.554086087821  delta_E= 2.27e-13  |g|= 2.59e-08  |ddm|= 4.59e-08
    CPU time for scf_cycle      1.93 sec, wall time      0.38 sec
exp = [2.61825252e+04 7.61805781e+03 3.61786288e+03 1.61231008e+03
 2.40127980e+02 5.22245718e+01 4.60270380e+00 3.98826951e-01
 1.36277846e+03 6.64985850e+02 3.02253423e+02 3.15206048e+02
 6.72790138e+01 7.84711044e+00 2.18919331e+01 7.88350632e-01
 2.98883644e+00 2.25477666e-01]
grad_E = [-1.98943275e-06  2.16447975e-05  4.27973744e-05  6.71818407e-04
  1.70346551e-04  3.38780554e-05  3.25062897e-04  1.21784804e-03
 -6.59100669e-07  2.10444657e-06  7.99726364e-06  6.85719521e-06
  3.51027562e-04 -2.80940720e-04 -4.09595979e-04 -2.61329004e-03
  2.17855329e-03  3.65440739e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5249672        1
[INPUT] 0    0    [1    /1   ]  7618.06062789        1
[INPUT] 0    0    [1    /1   ]  3617.86855873        1
[INPUT] 0    0    [1    /1   ]  1612.39696301        1
[INPUT] 0    0    [1    /1   ]  240.122640278        1
[INPUT] 0    0    [1    /1   ]  52.2207034261        1
[INPUT] 0    0    [1    /1   ]  4.6023118534         1
[INPUT] 0    0    [1    /1   ]  0.398750072557       1
[INPUT] 1    0    [1    /1   ]  1362.77867211        1
[INPUT] 1    0    [1    /1   ]  664.988733053        1
[INPUT] 1    0    [1    /1   ]  302.26922728         1
[INPUT] 1    0    [1    /1   ]  315.219974779        1
[INPUT] 1    0    [1    /1   ]  67.0039063009        1
[INPUT] 1    0    [1    /1   ]  7.813535292          1
[INPUT] 1    0    [1    /1   ]  21.8122123725        1
[INPUT] 1    0    [1    /1   ]  0.788699296946       1
[INPUT] 1    0    [1    /1   ]  2.96784744167        1
[INPUT] 1    0    [1    /1   ]  0.225588726391       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.524967231046, 1.0]], [0, [7618.060627885328, 1.0]], [0, [3617.868558729947, 1.0]], [0, [1612.3969630113418, 1.0]], [0, [240.12264027797377, 1.0]], [0, [52.220703426135515, 1.0]], [0, [4.602311853399575, 1.0]], [0, [0.39875007255700623, 1.0]], [1, [1362.7786721071, 1.0]], [1, [664.9887330533435, 1.0]], [1, [302.2692272796643, 1.0]], [1, [315.2199747788435, 1.0]], [1, [67.00390630088778, 1.0]], [1, [7.81353529199753, 1.0]], [1, [21.812212372497022, 1.0]], [1, [0.7886992969458694, 1.0]], [1, [2.967847441665963, 1.0]], [1, [0.22558872639107796, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52496723]
bas 1, expnt(s) = [7618.06062789]
bas 2, expnt(s) = [3617.86855873]
bas 3, expnt(s) = [1612.39696301]
bas 4, expnt(s) = [240.12264028]
bas 5, expnt(s) = [52.22070343]
bas 6, expnt(s) = [4.60231185]
bas 7, expnt(s) = [0.39875007]
bas 8, expnt(s) = [1362.77867211]
bas 9, expnt(s) = [664.98873305]
bas 10, expnt(s) = [302.26922728]
bas 11, expnt(s) = [315.21997478]
bas 12, expnt(s) = [67.0039063]
bas 13, expnt(s) = [7.81353529]
bas 14, expnt(s) = [21.81221237]
bas 15, expnt(s) = [0.7886993]
bas 16, expnt(s) = [2.96784744]
bas 17, expnt(s) = [0.22558873]
CPU time:       291.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825250e+04 5.20024337e+03 7.61806063e+03 2.06014763e+03
 3.61786856e+03 1.17856791e+03 1.61239696e+03 6.42863847e+02
 2.40122640e+02 1.54113207e+02 5.22207034e+01 4.90791534e+01
 4.60231185e+00 7.93865734e+00 3.98750073e-01 1.26777039e+00
 1.36277867e+03 2.41555012e+04 6.64988733e+02 9.85149750e+03
 3.02269227e+02 3.67685761e+03 3.15219975e+02 3.87482020e+03
 6.70039063e+01 5.59254575e+02 7.81353529e+00 3.81104314e+01
 2.18122124e+01 1.37517839e+02 7.88699297e-01 2.16832167e+00
 2.96784744e+00 1.13641343e+01 2.25588726e-01 4.53556226e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973178181891043
cond(S) = 113418.23550569806
E1 = -727.5543160993151  E_coul = 203.12826936848015
init E= -524.426046730835
    CPU time for initialize scf      0.67 sec, wall time      0.08 sec
  HOMO = -0.559454723809913  LUMO = 1.0523617002132
  mo_energy =
[-1.17869501e+02 -1.20947183e+01 -9.44649380e+00 -9.44649380e+00
 -9.44649380e+00 -1.23029736e+00 -5.59454724e-01 -5.59454724e-01
 -5.59454724e-01  1.05236170e+00  1.05236170e+00  1.05236170e+00
  7.82430166e+00  7.82430166e+00  7.82430166e+00  3.63203801e+01
  3.63203801e+01  3.63203801e+01  1.40720813e+02  1.40720813e+02
  1.40720813e+02  1.83989622e+02  5.06566028e+02  5.06566028e+02
  5.06566028e+02  1.36386623e+03  1.36386623e+03  1.36386623e+03
  1.91351622e+03  3.06175051e+03  3.06175051e+03  3.06175051e+03
  6.68317015e+03  6.68317015e+03  6.68317015e+03  8.26274311e+03
  2.46429844e+04  7.54363954e+04]
E1 = -727.3953914346594  E_coul = 201.84145638333285
cycle= 1 E= -525.553935051327  delta_E= -1.13  |g|= 0.181  |ddm|= 0.335
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460703
diis-c [-0.21224718  1.        ]
  HOMO = -0.572154202203482  LUMO = 1.04533989932391
  mo_energy =
[-1.18107913e+02 -1.21821237e+01 -9.53284883e+00 -9.53284883e+00
 -9.53284883e+00 -1.25129880e+00 -5.72154202e-01 -5.72154202e-01
 -5.72154202e-01  1.04533990e+00  1.04533990e+00  1.04533990e+00
  7.77436866e+00  7.77436866e+00  7.77436866e+00  3.62240110e+01
  3.62240110e+01  3.62240110e+01  1.40560654e+02  1.40560654e+02
  1.40560654e+02  1.83803064e+02  5.06342670e+02  5.06342670e+02
  5.06342670e+02  1.36359587e+03  1.36359587e+03  1.36359587e+03
  1.91312671e+03  3.06142032e+03  3.06142032e+03  3.06142032e+03
  6.68272589e+03  6.68272589e+03  6.68272589e+03  8.26221697e+03
  2.46423652e+04  7.54356853e+04]
E1 = -727.596743355128  E_coul = 202.0426331842902
cycle= 2 E= -525.554110170838  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.0138
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0303726
diis-c [-7.18256398e-04  3.01366396e-02  9.69863360e-01]
  HOMO = -0.569580754464782  LUMO = 1.04738700481456
  mo_energy =
[-1.18078737e+02 -1.21679758e+01 -9.51849247e+00 -9.51849247e+00
 -9.51849247e+00 -1.24784129e+00 -5.69580754e-01 -5.69580754e-01
 -5.69580754e-01  1.04738700e+00  1.04738700e+00  1.04738700e+00
  7.78242030e+00  7.78242030e+00  7.78242030e+00  3.62394077e+01
  3.62394077e+01  3.62394077e+01  1.40584054e+02  1.40584054e+02
  1.40584054e+02  1.83831117e+02  5.06371416e+02  5.06371416e+02
  5.06371416e+02  1.36362659e+03  1.36362659e+03  1.36362659e+03
  1.91315884e+03  3.06145206e+03  3.06145206e+03  3.06145206e+03
  6.68275817e+03  6.68275817e+03  6.68275817e+03  8.26224946e+03
  2.46423977e+04  7.54357177e+04]
E1 = -727.5550979531965  E_coul = 202.00098213634467
cycle= 3 E= -525.554115816852  delta_E= -5.65e-06  |g|= 0.00209  |ddm|= 0.00359
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00442706
diis-c [-8.55612086e-08 -7.43259228e-04  1.22594870e-01  8.78148389e-01]
  HOMO = -0.570092220151788  LUMO = 1.04699200367416
  mo_energy =
[-1.18082714e+02 -1.21701921e+01 -9.52075235e+00 -9.52075235e+00
 -9.52075235e+00 -1.24851479e+00 -5.70092220e-01 -5.70092220e-01
 -5.70092220e-01  1.04699200e+00  1.04699200e+00  1.04699200e+00
  7.78102027e+00  7.78102027e+00  7.78102027e+00  3.62370465e+01
  3.62370465e+01  3.62370465e+01  1.40580748e+02  1.40580748e+02
  1.40580748e+02  1.83827319e+02  5.06367495e+02  5.06367495e+02
  5.06367495e+02  1.36362244e+03  1.36362244e+03  1.36362244e+03
  1.91315446e+03  3.06144775e+03  3.06144775e+03  3.06144775e+03
  6.68275374e+03  6.68275374e+03  6.68275374e+03  8.26224495e+03
  2.46423931e+04  7.54357131e+04]
E1 = -727.5613594715176  E_coul = 202.00724349446784
cycle= 4 E= -525.55411597705  delta_E= -1.6e-07  |g|= 3.7e-05  |ddm|= 0.000584
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.63678e-05
diis-c [-3.78027108e-10 -2.64148329e-05  3.94654001e-03  4.17666164e-02
  9.54313258e-01]
  HOMO = -0.570070781416866  LUMO = 1.04700815374172
  mo_energy =
[-1.18082630e+02 -1.21701218e+01 -9.52068144e+00 -9.52068144e+00
 -9.52068144e+00 -1.24848685e+00 -5.70070781e-01 -5.70070781e-01
 -5.70070781e-01  1.04700815e+00  1.04700815e+00  1.04700815e+00
  7.78107135e+00  7.78107135e+00  7.78107135e+00  3.62371166e+01
  3.62371166e+01  3.62371166e+01  1.40580828e+02  1.40580828e+02
  1.40580828e+02  1.83827403e+02  5.06367579e+02  5.06367579e+02
  5.06367579e+02  1.36362252e+03  1.36362252e+03  1.36362252e+03
  1.91315454e+03  3.06144784e+03  3.06144784e+03  3.06144784e+03
  6.68275382e+03  6.68275382e+03  6.68275382e+03  8.26224503e+03
  2.46423932e+04  7.54357131e+04]
E1 = -727.5611828253317  E_coul = 202.0070668481655
cycle= 5 E= -525.554115977166  delta_E= -1.17e-10  |g|= 2.33e-06  |ddm|= 1.96e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5611828253317  E_coul = 202.0070668481655
  HOMO = -0.570072065530471  LUMO = 1.04700718641902
  mo_energy =
[-1.18082636e+02 -1.21701263e+01 -9.52068595e+00 -9.52068595e+00
 -9.52068595e+00 -1.24848852e+00 -5.70072066e-01 -5.70072066e-01
 -5.70072066e-01  1.04700719e+00  1.04700719e+00  1.04700719e+00
  7.78106822e+00  7.78106822e+00  7.78106822e+00  3.62371121e+01
  3.62371121e+01  3.62371121e+01  1.40580823e+02  1.40580823e+02
  1.40580823e+02  1.83827397e+02  5.06367573e+02  5.06367573e+02
  5.06367573e+02  1.36362251e+03  1.36362251e+03  1.36362251e+03
  1.91315454e+03  3.06144783e+03  3.06144783e+03  3.06144783e+03
  6.68275382e+03  6.68275382e+03  6.68275382e+03  8.26224503e+03
  2.46423932e+04  7.54357131e+04]
E1 = -727.5611944074512  E_coul = 202.00707843028525
Extra cycle  E= -525.554115977166  delta_E= 2.27e-13  |g|= 5.75e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.86 sec, wall time      0.27 sec
exp = [2.61825250e+04 7.61806063e+03 3.61786856e+03 1.61239696e+03
 2.40122640e+02 5.22207034e+01 4.60231185e+00 3.98750073e-01
 1.36277867e+03 6.64988733e+02 3.02269227e+02 3.15219975e+02
 6.70039063e+01 7.81353529e+00 2.18122124e+01 7.88699297e-01
 2.96784744e+00 2.25588726e-01]
E = -525.554115977166
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5249672        1
[INPUT] 0    0    [1    /1   ]  7618.06062789        1
[INPUT] 0    0    [1    /1   ]  3617.86855873        1
[INPUT] 0    0    [1    /1   ]  1612.39696301        1
[INPUT] 0    0    [1    /1   ]  240.122640278        1
[INPUT] 0    0    [1    /1   ]  52.2207034261        1
[INPUT] 0    0    [1    /1   ]  4.6023118534         1
[INPUT] 0    0    [1    /1   ]  0.398750072557       1
[INPUT] 1    0    [1    /1   ]  1362.77867211        1
[INPUT] 1    0    [1    /1   ]  664.988733053        1
[INPUT] 1    0    [1    /1   ]  302.26922728         1
[INPUT] 1    0    [1    /1   ]  315.219974779        1
[INPUT] 1    0    [1    /1   ]  67.0039063009        1
[INPUT] 1    0    [1    /1   ]  7.813535292          1
[INPUT] 1    0    [1    /1   ]  21.8122123725        1
[INPUT] 1    0    [1    /1   ]  0.788699296946       1
[INPUT] 1    0    [1    /1   ]  2.96784744167        1
[INPUT] 1    0    [1    /1   ]  0.225588726391       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.524967231046, 1.0]], [0, [7618.060627885328, 1.0]], [0, [3617.868558729947, 1.0]], [0, [1612.3969630113418, 1.0]], [0, [240.12264027797377, 1.0]], [0, [52.220703426135515, 1.0]], [0, [4.602311853399575, 1.0]], [0, [0.39875007255700623, 1.0]], [1, [1362.7786721071, 1.0]], [1, [664.9887330533435, 1.0]], [1, [302.2692272796643, 1.0]], [1, [315.2199747788435, 1.0]], [1, [67.00390630088778, 1.0]], [1, [7.81353529199753, 1.0]], [1, [21.812212372497022, 1.0]], [1, [0.7886992969458694, 1.0]], [1, [2.967847441665963, 1.0]], [1, [0.22558872639107796, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52496723]
bas 1, expnt(s) = [7618.06062789]
bas 2, expnt(s) = [3617.86855873]
bas 3, expnt(s) = [1612.39696301]
bas 4, expnt(s) = [240.12264028]
bas 5, expnt(s) = [52.22070343]
bas 6, expnt(s) = [4.60231185]
bas 7, expnt(s) = [0.39875007]
bas 8, expnt(s) = [1362.77867211]
bas 9, expnt(s) = [664.98873305]
bas 10, expnt(s) = [302.26922728]
bas 11, expnt(s) = [315.21997478]
bas 12, expnt(s) = [67.0039063]
bas 13, expnt(s) = [7.81353529]
bas 14, expnt(s) = [21.81221237]
bas 15, expnt(s) = [0.7886993]
bas 16, expnt(s) = [2.96784744]
bas 17, expnt(s) = [0.22558873]
CPU time:       292.79
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825250e+04 5.20024337e+03 7.61806063e+03 2.06014763e+03
 3.61786856e+03 1.17856791e+03 1.61239696e+03 6.42863847e+02
 2.40122640e+02 1.54113207e+02 5.22207034e+01 4.90791534e+01
 4.60231185e+00 7.93865734e+00 3.98750073e-01 1.26777039e+00
 1.36277867e+03 2.41555012e+04 6.64988733e+02 9.85149750e+03
 3.02269227e+02 3.67685761e+03 3.15219975e+02 3.87482020e+03
 6.70039063e+01 5.59254575e+02 7.81353529e+00 3.81104314e+01
 2.18122124e+01 1.37517839e+02 7.88699297e-01 2.16832167e+00
 2.96784744e+00 1.13641343e+01 2.25588726e-01 4.53556226e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973178181891043
cond(S) = 113418.23550569806
E1 = -727.5543160993151  E_coul = 203.12826936848015
init E= -524.426046730835
    CPU time for initialize scf      0.65 sec, wall time      0.08 sec
  HOMO = -0.559454723809913  LUMO = 1.0523617002132
  mo_energy =
[-1.17869501e+02 -1.20947183e+01 -9.44649380e+00 -9.44649380e+00
 -9.44649380e+00 -1.23029736e+00 -5.59454724e-01 -5.59454724e-01
 -5.59454724e-01  1.05236170e+00  1.05236170e+00  1.05236170e+00
  7.82430166e+00  7.82430166e+00  7.82430166e+00  3.63203801e+01
  3.63203801e+01  3.63203801e+01  1.40720813e+02  1.40720813e+02
  1.40720813e+02  1.83989622e+02  5.06566028e+02  5.06566028e+02
  5.06566028e+02  1.36386623e+03  1.36386623e+03  1.36386623e+03
  1.91351622e+03  3.06175051e+03  3.06175051e+03  3.06175051e+03
  6.68317015e+03  6.68317015e+03  6.68317015e+03  8.26274311e+03
  2.46429844e+04  7.54363954e+04]
E1 = -727.3953914346594  E_coul = 201.84145638333285
cycle= 1 E= -525.553935051327  delta_E= -1.13  |g|= 0.181  |ddm|= 0.335
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460703
diis-c [-0.21224718  1.        ]
  HOMO = -0.572154202203482  LUMO = 1.04533989932391
  mo_energy =
[-1.18107913e+02 -1.21821237e+01 -9.53284883e+00 -9.53284883e+00
 -9.53284883e+00 -1.25129880e+00 -5.72154202e-01 -5.72154202e-01
 -5.72154202e-01  1.04533990e+00  1.04533990e+00  1.04533990e+00
  7.77436866e+00  7.77436866e+00  7.77436866e+00  3.62240110e+01
  3.62240110e+01  3.62240110e+01  1.40560654e+02  1.40560654e+02
  1.40560654e+02  1.83803064e+02  5.06342670e+02  5.06342670e+02
  5.06342670e+02  1.36359587e+03  1.36359587e+03  1.36359587e+03
  1.91312671e+03  3.06142032e+03  3.06142032e+03  3.06142032e+03
  6.68272589e+03  6.68272589e+03  6.68272589e+03  8.26221697e+03
  2.46423652e+04  7.54356853e+04]
E1 = -727.596743355128  E_coul = 202.0426331842902
cycle= 2 E= -525.554110170838  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.0138
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0303726
diis-c [-7.18256398e-04  3.01366396e-02  9.69863360e-01]
  HOMO = -0.569580754464782  LUMO = 1.04738700481456
  mo_energy =
[-1.18078737e+02 -1.21679758e+01 -9.51849247e+00 -9.51849247e+00
 -9.51849247e+00 -1.24784129e+00 -5.69580754e-01 -5.69580754e-01
 -5.69580754e-01  1.04738700e+00  1.04738700e+00  1.04738700e+00
  7.78242030e+00  7.78242030e+00  7.78242030e+00  3.62394077e+01
  3.62394077e+01  3.62394077e+01  1.40584054e+02  1.40584054e+02
  1.40584054e+02  1.83831117e+02  5.06371416e+02  5.06371416e+02
  5.06371416e+02  1.36362659e+03  1.36362659e+03  1.36362659e+03
  1.91315884e+03  3.06145206e+03  3.06145206e+03  3.06145206e+03
  6.68275817e+03  6.68275817e+03  6.68275817e+03  8.26224946e+03
  2.46423977e+04  7.54357177e+04]
E1 = -727.5550979531965  E_coul = 202.00098213634467
cycle= 3 E= -525.554115816852  delta_E= -5.65e-06  |g|= 0.00209  |ddm|= 0.00359
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00442706
diis-c [-8.55612086e-08 -7.43259228e-04  1.22594870e-01  8.78148389e-01]
  HOMO = -0.570092220151788  LUMO = 1.04699200367416
  mo_energy =
[-1.18082714e+02 -1.21701921e+01 -9.52075235e+00 -9.52075235e+00
 -9.52075235e+00 -1.24851479e+00 -5.70092220e-01 -5.70092220e-01
 -5.70092220e-01  1.04699200e+00  1.04699200e+00  1.04699200e+00
  7.78102027e+00  7.78102027e+00  7.78102027e+00  3.62370465e+01
  3.62370465e+01  3.62370465e+01  1.40580748e+02  1.40580748e+02
  1.40580748e+02  1.83827319e+02  5.06367495e+02  5.06367495e+02
  5.06367495e+02  1.36362244e+03  1.36362244e+03  1.36362244e+03
  1.91315446e+03  3.06144775e+03  3.06144775e+03  3.06144775e+03
  6.68275374e+03  6.68275374e+03  6.68275374e+03  8.26224495e+03
  2.46423931e+04  7.54357131e+04]
E1 = -727.5613594715176  E_coul = 202.00724349446784
cycle= 4 E= -525.55411597705  delta_E= -1.6e-07  |g|= 3.7e-05  |ddm|= 0.000584
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.63678e-05
diis-c [-3.78027108e-10 -2.64148329e-05  3.94654001e-03  4.17666164e-02
  9.54313258e-01]
  HOMO = -0.570070781416866  LUMO = 1.04700815374172
  mo_energy =
[-1.18082630e+02 -1.21701218e+01 -9.52068144e+00 -9.52068144e+00
 -9.52068144e+00 -1.24848685e+00 -5.70070781e-01 -5.70070781e-01
 -5.70070781e-01  1.04700815e+00  1.04700815e+00  1.04700815e+00
  7.78107135e+00  7.78107135e+00  7.78107135e+00  3.62371166e+01
  3.62371166e+01  3.62371166e+01  1.40580828e+02  1.40580828e+02
  1.40580828e+02  1.83827403e+02  5.06367579e+02  5.06367579e+02
  5.06367579e+02  1.36362252e+03  1.36362252e+03  1.36362252e+03
  1.91315454e+03  3.06144784e+03  3.06144784e+03  3.06144784e+03
  6.68275382e+03  6.68275382e+03  6.68275382e+03  8.26224503e+03
  2.46423932e+04  7.54357131e+04]
E1 = -727.5611828253317  E_coul = 202.0070668481655
cycle= 5 E= -525.554115977166  delta_E= -1.17e-10  |g|= 2.33e-06  |ddm|= 1.96e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5611828253317  E_coul = 202.0070668481655
  HOMO = -0.570072065530471  LUMO = 1.04700718641902
  mo_energy =
[-1.18082636e+02 -1.21701263e+01 -9.52068595e+00 -9.52068595e+00
 -9.52068595e+00 -1.24848852e+00 -5.70072066e-01 -5.70072066e-01
 -5.70072066e-01  1.04700719e+00  1.04700719e+00  1.04700719e+00
  7.78106822e+00  7.78106822e+00  7.78106822e+00  3.62371121e+01
  3.62371121e+01  3.62371121e+01  1.40580823e+02  1.40580823e+02
  1.40580823e+02  1.83827397e+02  5.06367573e+02  5.06367573e+02
  5.06367573e+02  1.36362251e+03  1.36362251e+03  1.36362251e+03
  1.91315454e+03  3.06144783e+03  3.06144783e+03  3.06144783e+03
  6.68275382e+03  6.68275382e+03  6.68275382e+03  8.26224503e+03
  2.46423932e+04  7.54357131e+04]
E1 = -727.5611944074512  E_coul = 202.00707843028525
Extra cycle  E= -525.554115977166  delta_E= 2.27e-13  |g|= 5.75e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.84 sec, wall time      0.26 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 113418.23550569806
E1 = -727.5611944074512  E_coul = 202.00707843028525
init E= -525.554115977166
    CPU time for initialize scf      1.20 sec, wall time      0.21 sec
  HOMO = -0.570071845568296  LUMO = 1.04700735464513
  mo_energy =
[-1.18082634e+02 -1.21701254e+01 -9.52068508e+00 -9.52068508e+00
 -9.52068508e+00 -1.24848824e+00 -5.70071846e-01 -5.70071846e-01
 -5.70071846e-01  1.04700735e+00  1.04700735e+00  1.04700735e+00
  7.78106879e+00  7.78106879e+00  7.78106879e+00  3.62371130e+01
  3.62371130e+01  3.62371130e+01  1.40580824e+02  1.40580824e+02
  1.40580824e+02  1.83827399e+02  5.06367574e+02  5.06367574e+02
  5.06367574e+02  1.36362251e+03  1.36362251e+03  1.36362251e+03
  1.91315454e+03  3.06144783e+03  3.06144783e+03  3.06144783e+03
  6.68275382e+03  6.68275382e+03  6.68275382e+03  8.26224503e+03
  2.46423932e+04  7.54357131e+04]
E1 = -727.5611920737581  E_coul = 202.00707609659
cycle= 1 E= -525.554115977168  delta_E= -2.05e-12  |g|= 1.24e-07  |ddm|= 2.3e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.5611920737581  E_coul = 202.00707609659
  HOMO = -0.570071887682825  LUMO = 1.04700732232168
  mo_energy =
[-1.18082635e+02 -1.21701256e+01 -9.52068525e+00 -9.52068525e+00
 -9.52068525e+00 -1.24848829e+00 -5.70071888e-01 -5.70071888e-01
 -5.70071888e-01  1.04700732e+00  1.04700732e+00  1.04700732e+00
  7.78106868e+00  7.78106868e+00  7.78106868e+00  3.62371128e+01
  3.62371128e+01  3.62371128e+01  1.40580824e+02  1.40580824e+02
  1.40580824e+02  1.83827398e+02  5.06367574e+02  5.06367574e+02
  5.06367574e+02  1.36362251e+03  1.36362251e+03  1.36362251e+03
  1.91315454e+03  3.06144783e+03  3.06144783e+03  3.06144783e+03
  6.68275382e+03  6.68275382e+03  6.68275382e+03  8.26224503e+03
  2.46423932e+04  7.54357131e+04]
E1 = -727.5611925487624  E_coul = 202.00707657159535
Extra cycle  E= -525.554115977167  delta_E= 1.02e-12  |g|= 2.59e-08  |ddm|= 4.59e-08
    CPU time for scf_cycle      1.32 sec, wall time      0.32 sec
exp = [2.61825250e+04 7.61806063e+03 3.61786856e+03 1.61239696e+03
 2.40122640e+02 5.22207034e+01 4.60231185e+00 3.98750073e-01
 1.36277867e+03 6.64988733e+02 3.02269227e+02 3.15219975e+02
 6.70039063e+01 7.81353529e+00 2.18122124e+01 7.88699297e-01
 2.96784744e+00 2.25588726e-01]
grad_E = [-1.98937518e-06  2.16472387e-05  4.28088669e-05  6.71784554e-04
  1.77882255e-04 -4.36196220e-05 -5.03430405e-05  1.72290731e-04
 -6.57459953e-07  2.20081827e-06  8.48896844e-06  7.28046927e-06
  3.43939934e-04  5.04117797e-04 -4.88496734e-04 -1.57673539e-04
  9.12874584e-05 -3.02367958e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5247744        1
[INPUT] 0    0    [1    /1   ]  7618.06277053        1
[INPUT] 0    0    [1    /1   ]  3617.87286707        1
[INPUT] 0    0    [1    /1   ]  1612.46291171        1
[INPUT] 0    0    [1    /1   ]  240.11817957         1
[INPUT] 0    0    [1    /1   ]  52.2185636951        1
[INPUT] 0    0    [1    /1   ]  4.60205816373        1
[INPUT] 0    0    [1    /1   ]  0.398689520896       1
[INPUT] 1    0    [1    /1   ]  1362.77884342        1
[INPUT] 1    0    [1    /1   ]  664.990974294        1
[INPUT] 1    0    [1    /1   ]  302.281530387        1
[INPUT] 1    0    [1    /1   ]  315.230816507        1
[INPUT] 1    0    [1    /1   ]  66.7768244961        1
[INPUT] 1    0    [1    /1   ]  7.80489117492        1
[INPUT] 1    0    [1    /1   ]  21.7890401585        1
[INPUT] 1    0    [1    /1   ]  0.789905106767       1
[INPUT] 1    0    [1    /1   ]  2.95979752637        1
[INPUT] 1    0    [1    /1   ]  0.225957943789       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.524774447524, 1.0]], [0, [7618.062770526134, 1.0]], [0, [3617.8728670730707, 1.0]], [0, [1612.4629117056031, 1.0]], [0, [240.1181795701796, 1.0]], [0, [52.21856369508998, 1.0]], [0, [4.602058163734653, 1.0]], [0, [0.39868952089612714, 1.0]], [1, [1362.7788434151769, 1.0]], [1, [664.9909742938399, 1.0]], [1, [302.28153038665425, 1.0]], [1, [315.23081650741835, 1.0]], [1, [66.776824496149, 1.0]], [1, [7.804891174924318, 1.0]], [1, [21.789040158525534, 1.0]], [1, [0.7899051067671995, 1.0]], [1, [2.9597975263736536, 1.0]], [1, [0.22595794378931922, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52477445]
bas 1, expnt(s) = [7618.06277053]
bas 2, expnt(s) = [3617.87286707]
bas 3, expnt(s) = [1612.46291171]
bas 4, expnt(s) = [240.11817957]
bas 5, expnt(s) = [52.2185637]
bas 6, expnt(s) = [4.60205816]
bas 7, expnt(s) = [0.39868952]
bas 8, expnt(s) = [1362.77884342]
bas 9, expnt(s) = [664.99097429]
bas 10, expnt(s) = [302.28153039]
bas 11, expnt(s) = [315.23081651]
bas 12, expnt(s) = [66.7768245]
bas 13, expnt(s) = [7.80489117]
bas 14, expnt(s) = [21.78904016]
bas 15, expnt(s) = [0.78990511]
bas 16, expnt(s) = [2.95979753]
bas 17, expnt(s) = [0.22595794]
CPU time:       299.29
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825248e+04 5.20024334e+03 7.61806277e+03 2.06014806e+03
 3.61787287e+03 1.17856896e+03 1.61246291e+03 6.42883567e+02
 2.40118180e+02 1.54111059e+02 5.22185637e+01 4.90776451e+01
 4.60205816e+00 7.93832914e+00 3.98689521e-01 1.26762600e+00
 1.36277884e+03 2.41555050e+04 6.64990974e+02 9.85153900e+03
 3.02281530e+02 3.67704469e+03 3.15230817e+02 3.87498679e+03
 6.67768245e+01 5.56886380e+02 7.80489117e+00 3.80577367e+01
 2.17890402e+01 1.37335248e+02 7.89905107e-01 2.17246628e+00
 2.95979753e+00 1.13256177e+01 2.25957944e-01 4.54484326e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973139442556523
cond(S) = 113081.19284196263
E1 = -727.5529726764671  E_coul = 203.1269754922811
init E= -524.425997184186
    CPU time for initialize scf      0.68 sec, wall time      0.08 sec
  HOMO = -0.559477000797501  LUMO = 1.05474414745041
  mo_energy =
[-1.17869639e+02 -1.20947964e+01 -9.44661184e+00 -9.44661184e+00
 -9.44661184e+00 -1.23031638e+00 -5.59477001e-01 -5.59477001e-01
 -5.59477001e-01  1.05474415e+00  1.05474415e+00  1.05474415e+00
  7.81315353e+00  7.81315353e+00  7.81315353e+00  3.62603826e+01
  3.62603826e+01  3.62603826e+01  1.40395070e+02  1.40395070e+02
  1.40395070e+02  1.83979704e+02  5.05829332e+02  5.05829332e+02
  5.05829332e+02  1.36301916e+03  1.36301916e+03  1.36301916e+03
  1.91353122e+03  3.06091877e+03  3.06091877e+03  3.06091877e+03
  6.68240644e+03  6.68240644e+03  6.68240644e+03  8.26286171e+03
  2.46431886e+04  7.54366329e+04]
E1 = -727.3975452095908  E_coul = 201.84358928943618
cycle= 1 E= -525.553955920155  delta_E= -1.13  |g|= 0.181  |ddm|= 0.328
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.460638
diis-c [-0.21218762  1.        ]
  HOMO = -0.572078614016076  LUMO = 1.04777411742607
  mo_energy =
[-1.18107800e+02 -1.21819356e+01 -9.53271121e+00 -9.53271121e+00
 -9.53271121e+00 -1.25118295e+00 -5.72078614e-01 -5.72078614e-01
 -5.72078614e-01  1.04777412e+00  1.04777412e+00  1.04777412e+00
  7.76349495e+00  7.76349495e+00  7.76349495e+00  3.61643240e+01
  3.61643240e+01  3.61643240e+01  1.40235309e+02  1.40235309e+02
  1.40235309e+02  1.83793416e+02  5.05606238e+02  5.05606238e+02
  5.05606238e+02  1.36274902e+03  1.36274902e+03  1.36274902e+03
  1.91314187e+03  3.06058876e+03  3.06058876e+03  3.06058876e+03
  6.68196233e+03  6.68196233e+03  6.68196233e+03  8.26233569e+03
  2.46425694e+04  7.54359229e+04]
E1 = -727.5982343698927  E_coul = 202.0441037972212
cycle= 2 E= -525.554130572672  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.0137
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0303299
diis-c [-7.16449703e-04  3.00842920e-02  9.69915708e-01]
  HOMO = -0.569520870171337  LUMO = 1.04981255522269
  mo_energy =
[-1.18078684e+02 -1.21678345e+01 -9.51840218e+00 -9.51840218e+00
 -9.51840218e+00 -1.24774586e+00 -5.69520870e-01 -5.69520870e-01
 -5.69520870e-01  1.04981256e+00  1.04981256e+00  1.04981256e+00
  7.77149959e+00  7.77149959e+00  7.77149959e+00  3.61796628e+01
  3.61796628e+01  3.61796628e+01  1.40258639e+02  1.40258639e+02
  1.40258639e+02  1.83821411e+02  5.05634923e+02  5.05634923e+02
  5.05634923e+02  1.36277968e+03  1.36277968e+03  1.36277968e+03
  1.91317395e+03  3.06062043e+03  3.06062043e+03  3.06062043e+03
  6.68199455e+03  6.68199455e+03  6.68199455e+03  8.26236812e+03
  2.46426019e+04  7.54359552e+04]
E1 = -727.5567112218728  E_coul = 202.00257503122666
cycle= 3 E= -525.554136190646  delta_E= -5.62e-06  |g|= 0.00208  |ddm|= 0.00358
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00441952
diis-c [-8.60092131e-08 -7.43350282e-04  1.22554599e-01  8.78188751e-01]
  HOMO = -0.570030688262983  LUMO = 1.04941817019335
  mo_energy =
[-1.18082653e+02 -1.21700453e+01 -9.52065647e+00 -9.52065647e+00
 -9.52065647e+00 -1.24841713e+00 -5.70030688e-01 -5.70030688e-01
 -5.70030688e-01  1.04941817e+00  1.04941817e+00  1.04941817e+00
  7.77010516e+00  7.77010516e+00  7.77010516e+00  3.61773084e+01
  3.61773084e+01  3.61773084e+01  1.40255342e+02  1.40255342e+02
  1.40255342e+02  1.83817621e+02  5.05631010e+02  5.05631010e+02
  5.05631010e+02  1.36277553e+03  1.36277553e+03  1.36277553e+03
  1.91316957e+03  3.06061614e+03  3.06061614e+03  3.06061614e+03
  6.68199013e+03  6.68199013e+03  6.68199013e+03  8.26236362e+03
  2.46425973e+04  7.54359506e+04]
E1 = -727.5629566385977  E_coul = 202.00882028850774
cycle= 4 E= -525.55413635009  delta_E= -1.59e-07  |g|= 3.71e-05  |ddm|= 0.000582
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.64756e-05
diis-c [-3.76882809e-10 -2.64814230e-05  3.95278595e-03  4.18681069e-02
  9.54205589e-01]
  HOMO = -0.570009247762516  LUMO = 1.04943434558587
  mo_energy =
[-1.18082568e+02 -1.21699750e+01 -9.52058549e+00 -9.52058549e+00
 -9.52058549e+00 -1.24838918e+00 -5.70009248e-01 -5.70009248e-01
 -5.70009248e-01  1.04943435e+00  1.04943435e+00  1.04943435e+00
  7.77015623e+00  7.77015623e+00  7.77015623e+00  3.61773786e+01
  3.61773786e+01  3.61773786e+01  1.40255422e+02  1.40255422e+02
  1.40255422e+02  1.83817705e+02  5.05631094e+02  5.05631094e+02
  5.05631094e+02  1.36277561e+03  1.36277561e+03  1.36277561e+03
  1.91316965e+03  3.06061622e+03  3.06061622e+03  3.06061622e+03
  6.68199021e+03  6.68199021e+03  6.68199021e+03  8.26236370e+03
  2.46425974e+04  7.54359507e+04]
E1 = -727.5627798269055  E_coul = 202.0086434766978
cycle= 5 E= -525.554136350208  delta_E= -1.18e-10  |g|= 2.33e-06  |ddm|= 1.96e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5627798269055  E_coul = 202.0086434766978
  HOMO = -0.570010532159738  LUMO = 1.04943337640788
  mo_energy =
[-1.18082575e+02 -1.21699794e+01 -9.52059000e+00 -9.52059000e+00
 -9.52059000e+00 -1.24839085e+00 -5.70010532e-01 -5.70010532e-01
 -5.70010532e-01  1.04943338e+00  1.04943338e+00  1.04943338e+00
  7.77015310e+00  7.77015310e+00  7.77015310e+00  3.61773741e+01
  3.61773741e+01  3.61773741e+01  1.40255416e+02  1.40255416e+02
  1.40255416e+02  1.83817699e+02  5.05631088e+02  5.05631088e+02
  5.05631088e+02  1.36277560e+03  1.36277560e+03  1.36277560e+03
  1.91316965e+03  3.06061621e+03  3.06061621e+03  3.06061621e+03
  6.68199020e+03  6.68199020e+03  6.68199020e+03  8.26236370e+03
  2.46425974e+04  7.54359507e+04]
E1 = -727.5627914020613  E_coul = 202.00865505185416
Extra cycle  E= -525.554136350207  delta_E= 5.68e-13  |g|= 5.75e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.22 sec
exp = [2.61825248e+04 7.61806277e+03 3.61787287e+03 1.61246291e+03
 2.40118180e+02 5.22185637e+01 4.60205816e+00 3.98689521e-01
 1.36277884e+03 6.64990974e+02 3.02281530e+02 3.15230817e+02
 6.67768245e+01 7.80489117e+00 2.17890402e+01 7.89905107e-01
 2.95979753e+00 2.25957944e-01]
E = -525.5541363502072
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5247744        1
[INPUT] 0    0    [1    /1   ]  7618.06277053        1
[INPUT] 0    0    [1    /1   ]  3617.87286707        1
[INPUT] 0    0    [1    /1   ]  1612.46291171        1
[INPUT] 0    0    [1    /1   ]  240.11817957         1
[INPUT] 0    0    [1    /1   ]  52.2185636951        1
[INPUT] 0    0    [1    /1   ]  4.60205816373        1
[INPUT] 0    0    [1    /1   ]  0.398689520896       1
[INPUT] 1    0    [1    /1   ]  1362.77884342        1
[INPUT] 1    0    [1    /1   ]  664.990974294        1
[INPUT] 1    0    [1    /1   ]  302.281530387        1
[INPUT] 1    0    [1    /1   ]  315.230816507        1
[INPUT] 1    0    [1    /1   ]  66.7768244961        1
[INPUT] 1    0    [1    /1   ]  7.80489117492        1
[INPUT] 1    0    [1    /1   ]  21.7890401585        1
[INPUT] 1    0    [1    /1   ]  0.789905106767       1
[INPUT] 1    0    [1    /1   ]  2.95979752637        1
[INPUT] 1    0    [1    /1   ]  0.225957943789       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.524774447524, 1.0]], [0, [7618.062770526134, 1.0]], [0, [3617.8728670730707, 1.0]], [0, [1612.4629117056031, 1.0]], [0, [240.1181795701796, 1.0]], [0, [52.21856369508998, 1.0]], [0, [4.602058163734653, 1.0]], [0, [0.39868952089612714, 1.0]], [1, [1362.7788434151769, 1.0]], [1, [664.9909742938399, 1.0]], [1, [302.28153038665425, 1.0]], [1, [315.23081650741835, 1.0]], [1, [66.776824496149, 1.0]], [1, [7.804891174924318, 1.0]], [1, [21.789040158525534, 1.0]], [1, [0.7899051067671995, 1.0]], [1, [2.9597975263736536, 1.0]], [1, [0.22595794378931922, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52477445]
bas 1, expnt(s) = [7618.06277053]
bas 2, expnt(s) = [3617.87286707]
bas 3, expnt(s) = [1612.46291171]
bas 4, expnt(s) = [240.11817957]
bas 5, expnt(s) = [52.2185637]
bas 6, expnt(s) = [4.60205816]
bas 7, expnt(s) = [0.39868952]
bas 8, expnt(s) = [1362.77884342]
bas 9, expnt(s) = [664.99097429]
bas 10, expnt(s) = [302.28153039]
bas 11, expnt(s) = [315.23081651]
bas 12, expnt(s) = [66.7768245]
bas 13, expnt(s) = [7.80489117]
bas 14, expnt(s) = [21.78904016]
bas 15, expnt(s) = [0.78990511]
bas 16, expnt(s) = [2.95979753]
bas 17, expnt(s) = [0.22595794]
CPU time:       300.29
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825248e+04 5.20024334e+03 7.61806277e+03 2.06014806e+03
 3.61787287e+03 1.17856896e+03 1.61246291e+03 6.42883567e+02
 2.40118180e+02 1.54111059e+02 5.22185637e+01 4.90776451e+01
 4.60205816e+00 7.93832914e+00 3.98689521e-01 1.26762600e+00
 1.36277884e+03 2.41555050e+04 6.64990974e+02 9.85153900e+03
 3.02281530e+02 3.67704469e+03 3.15230817e+02 3.87498679e+03
 6.67768245e+01 5.56886380e+02 7.80489117e+00 3.80577367e+01
 2.17890402e+01 1.37335248e+02 7.89905107e-01 2.17246628e+00
 2.95979753e+00 1.13256177e+01 2.25957944e-01 4.54484326e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973139442556523
cond(S) = 113081.19284196263
E1 = -727.5529726764671  E_coul = 203.1269754922811
init E= -524.425997184186
    CPU time for initialize scf      0.66 sec, wall time      0.07 sec
  HOMO = -0.559477000797501  LUMO = 1.05474414745041
  mo_energy =
[-1.17869639e+02 -1.20947964e+01 -9.44661184e+00 -9.44661184e+00
 -9.44661184e+00 -1.23031638e+00 -5.59477001e-01 -5.59477001e-01
 -5.59477001e-01  1.05474415e+00  1.05474415e+00  1.05474415e+00
  7.81315353e+00  7.81315353e+00  7.81315353e+00  3.62603826e+01
  3.62603826e+01  3.62603826e+01  1.40395070e+02  1.40395070e+02
  1.40395070e+02  1.83979704e+02  5.05829332e+02  5.05829332e+02
  5.05829332e+02  1.36301916e+03  1.36301916e+03  1.36301916e+03
  1.91353122e+03  3.06091877e+03  3.06091877e+03  3.06091877e+03
  6.68240644e+03  6.68240644e+03  6.68240644e+03  8.26286171e+03
  2.46431886e+04  7.54366329e+04]
E1 = -727.3975452095908  E_coul = 201.84358928943618
cycle= 1 E= -525.553955920155  delta_E= -1.13  |g|= 0.181  |ddm|= 0.328
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.460638
diis-c [-0.21218762  1.        ]
  HOMO = -0.572078614016076  LUMO = 1.04777411742607
  mo_energy =
[-1.18107800e+02 -1.21819356e+01 -9.53271121e+00 -9.53271121e+00
 -9.53271121e+00 -1.25118295e+00 -5.72078614e-01 -5.72078614e-01
 -5.72078614e-01  1.04777412e+00  1.04777412e+00  1.04777412e+00
  7.76349495e+00  7.76349495e+00  7.76349495e+00  3.61643240e+01
  3.61643240e+01  3.61643240e+01  1.40235309e+02  1.40235309e+02
  1.40235309e+02  1.83793416e+02  5.05606238e+02  5.05606238e+02
  5.05606238e+02  1.36274902e+03  1.36274902e+03  1.36274902e+03
  1.91314187e+03  3.06058876e+03  3.06058876e+03  3.06058876e+03
  6.68196233e+03  6.68196233e+03  6.68196233e+03  8.26233569e+03
  2.46425694e+04  7.54359229e+04]
E1 = -727.5982343698927  E_coul = 202.0441037972212
cycle= 2 E= -525.554130572672  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.0137
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0303299
diis-c [-7.16449703e-04  3.00842920e-02  9.69915708e-01]
  HOMO = -0.569520870171337  LUMO = 1.04981255522269
  mo_energy =
[-1.18078684e+02 -1.21678345e+01 -9.51840218e+00 -9.51840218e+00
 -9.51840218e+00 -1.24774586e+00 -5.69520870e-01 -5.69520870e-01
 -5.69520870e-01  1.04981256e+00  1.04981256e+00  1.04981256e+00
  7.77149959e+00  7.77149959e+00  7.77149959e+00  3.61796628e+01
  3.61796628e+01  3.61796628e+01  1.40258639e+02  1.40258639e+02
  1.40258639e+02  1.83821411e+02  5.05634923e+02  5.05634923e+02
  5.05634923e+02  1.36277968e+03  1.36277968e+03  1.36277968e+03
  1.91317395e+03  3.06062043e+03  3.06062043e+03  3.06062043e+03
  6.68199455e+03  6.68199455e+03  6.68199455e+03  8.26236812e+03
  2.46426019e+04  7.54359552e+04]
E1 = -727.5567112218728  E_coul = 202.00257503122666
cycle= 3 E= -525.554136190646  delta_E= -5.62e-06  |g|= 0.00208  |ddm|= 0.00358
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00441952
diis-c [-8.60092131e-08 -7.43350282e-04  1.22554599e-01  8.78188751e-01]
  HOMO = -0.570030688262983  LUMO = 1.04941817019335
  mo_energy =
[-1.18082653e+02 -1.21700453e+01 -9.52065647e+00 -9.52065647e+00
 -9.52065647e+00 -1.24841713e+00 -5.70030688e-01 -5.70030688e-01
 -5.70030688e-01  1.04941817e+00  1.04941817e+00  1.04941817e+00
  7.77010516e+00  7.77010516e+00  7.77010516e+00  3.61773084e+01
  3.61773084e+01  3.61773084e+01  1.40255342e+02  1.40255342e+02
  1.40255342e+02  1.83817621e+02  5.05631010e+02  5.05631010e+02
  5.05631010e+02  1.36277553e+03  1.36277553e+03  1.36277553e+03
  1.91316957e+03  3.06061614e+03  3.06061614e+03  3.06061614e+03
  6.68199013e+03  6.68199013e+03  6.68199013e+03  8.26236362e+03
  2.46425973e+04  7.54359506e+04]
E1 = -727.5629566385977  E_coul = 202.00882028850774
cycle= 4 E= -525.55413635009  delta_E= -1.59e-07  |g|= 3.71e-05  |ddm|= 0.000582
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.64756e-05
diis-c [-3.76882809e-10 -2.64814230e-05  3.95278595e-03  4.18681069e-02
  9.54205589e-01]
  HOMO = -0.570009247762516  LUMO = 1.04943434558587
  mo_energy =
[-1.18082568e+02 -1.21699750e+01 -9.52058549e+00 -9.52058549e+00
 -9.52058549e+00 -1.24838918e+00 -5.70009248e-01 -5.70009248e-01
 -5.70009248e-01  1.04943435e+00  1.04943435e+00  1.04943435e+00
  7.77015623e+00  7.77015623e+00  7.77015623e+00  3.61773786e+01
  3.61773786e+01  3.61773786e+01  1.40255422e+02  1.40255422e+02
  1.40255422e+02  1.83817705e+02  5.05631094e+02  5.05631094e+02
  5.05631094e+02  1.36277561e+03  1.36277561e+03  1.36277561e+03
  1.91316965e+03  3.06061622e+03  3.06061622e+03  3.06061622e+03
  6.68199021e+03  6.68199021e+03  6.68199021e+03  8.26236370e+03
  2.46425974e+04  7.54359507e+04]
E1 = -727.5627798269055  E_coul = 202.0086434766978
cycle= 5 E= -525.554136350208  delta_E= -1.18e-10  |g|= 2.33e-06  |ddm|= 1.96e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5627798269055  E_coul = 202.0086434766978
  HOMO = -0.570010532159738  LUMO = 1.04943337640788
  mo_energy =
[-1.18082575e+02 -1.21699794e+01 -9.52059000e+00 -9.52059000e+00
 -9.52059000e+00 -1.24839085e+00 -5.70010532e-01 -5.70010532e-01
 -5.70010532e-01  1.04943338e+00  1.04943338e+00  1.04943338e+00
  7.77015310e+00  7.77015310e+00  7.77015310e+00  3.61773741e+01
  3.61773741e+01  3.61773741e+01  1.40255416e+02  1.40255416e+02
  1.40255416e+02  1.83817699e+02  5.05631088e+02  5.05631088e+02
  5.05631088e+02  1.36277560e+03  1.36277560e+03  1.36277560e+03
  1.91316965e+03  3.06061621e+03  3.06061621e+03  3.06061621e+03
  6.68199020e+03  6.68199020e+03  6.68199020e+03  8.26236370e+03
  2.46425974e+04  7.54359507e+04]
E1 = -727.5627914020613  E_coul = 202.00865505185416
Extra cycle  E= -525.554136350207  delta_E= 5.68e-13  |g|= 5.75e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.81 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 113081.19284196263
E1 = -727.5627914020613  E_coul = 202.00865505185416
init E= -525.554136350207
    CPU time for initialize scf      1.82 sec, wall time      0.25 sec
  HOMO = -0.570010312517567  LUMO = 1.04943354465127
  mo_energy =
[-1.18082573e+02 -1.21699785e+01 -9.52058913e+00 -9.52058913e+00
 -9.52058913e+00 -1.24839057e+00 -5.70010313e-01 -5.70010313e-01
 -5.70010313e-01  1.04943354e+00  1.04943354e+00  1.04943354e+00
  7.77015367e+00  7.77015367e+00  7.77015367e+00  3.61773750e+01
  3.61773750e+01  3.61773750e+01  1.40255417e+02  1.40255417e+02
  1.40255417e+02  1.83817700e+02  5.05631089e+02  5.05631089e+02
  5.05631089e+02  1.36277561e+03  1.36277561e+03  1.36277561e+03
  1.91316965e+03  3.06061621e+03  3.06061621e+03  3.06061621e+03
  6.68199020e+03  6.68199020e+03  6.68199020e+03  8.26236370e+03
  2.46425974e+04  7.54359507e+04]
E1 = -727.5627890697174  E_coul = 202.00865271950852
cycle= 1 E= -525.554136350209  delta_E= -1.71e-12  |g|= 1.24e-07  |ddm|= 2.3e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.5627890697174  E_coul = 202.00865271950852
  HOMO = -0.570010354586422  LUMO = 1.04943351231042
  mo_energy =
[-1.18082574e+02 -1.21699787e+01 -9.52058930e+00 -9.52058930e+00
 -9.52058930e+00 -1.24839062e+00 -5.70010355e-01 -5.70010355e-01
 -5.70010355e-01  1.04943351e+00  1.04943351e+00  1.04943351e+00
  7.77015356e+00  7.77015356e+00  7.77015356e+00  3.61773748e+01
  3.61773748e+01  3.61773748e+01  1.40255417e+02  1.40255417e+02
  1.40255417e+02  1.83817700e+02  5.05631089e+02  5.05631089e+02
  5.05631089e+02  1.36277561e+03  1.36277561e+03  1.36277561e+03
  1.91316965e+03  3.06061621e+03  3.06061621e+03  3.06061621e+03
  6.68199020e+03  6.68199020e+03  6.68199020e+03  8.26236370e+03
  2.46425974e+04  7.54359507e+04]
E1 = -727.5627895443703  E_coul = 202.00865319416252
Extra cycle  E= -525.554136350208  delta_E= 1.14e-12  |g|= 2.59e-08  |ddm|= 4.59e-08
    CPU time for scf_cycle      1.93 sec, wall time      0.36 sec
exp = [2.61825248e+04 7.61806277e+03 3.61787287e+03 1.61246291e+03
 2.40118180e+02 5.22185637e+01 4.60205816e+00 3.98689521e-01
 1.36277884e+03 6.64990974e+02 3.02281530e+02 3.15230817e+02
 6.67768245e+01 7.80489117e+00 2.17890402e+01 7.89905107e-01
 2.95979753e+00 2.25957944e-01]
grad_E = [-1.98933528e-06  2.16503964e-05  4.28215634e-05  6.71807914e-04
  1.80319391e-04 -7.93838111e-05 -2.81448576e-04 -4.88679028e-04
 -6.54816480e-07  2.34332552e-06  9.25991877e-06  7.93911205e-06
  2.99337533e-04  6.62129131e-04 -3.44489136e-04  1.46510540e-03
 -8.57615018e-04  7.06668626e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:20 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5244862        1
[INPUT] 0    0    [1    /1   ]  7618.06597457        1
[INPUT] 0    0    [1    /1   ]  3617.87931003        1
[INPUT] 0    0    [1    /1   ]  1612.56152874        1
[INPUT] 0    0    [1    /1   ]  240.111034207        1
[INPUT] 0    0    [1    /1   ]  52.2182565523        1
[INPUT] 0    0    [1    /1   ]  4.60197259185        1
[INPUT] 0    0    [1    /1   ]  0.398663239653       1
[INPUT] 1    0    [1    /1   ]  1362.77909996        1
[INPUT] 1    0    [1    /1   ]  664.994329249        1
[INPUT] 1    0    [1    /1   ]  302.299946583        1
[INPUT] 1    0    [1    /1   ]  315.24704531         1
[INPUT] 1    0    [1    /1   ]  66.4384488597        1
[INPUT] 1    0    [1    /1   ]  7.79286038194        1
[INPUT] 1    0    [1    /1   ]  21.7469815715        1
[INPUT] 1    0    [1    /1   ]  0.789805071923       1
[INPUT] 1    0    [1    /1   ]  2.95390392866        1
[INPUT] 1    0    [1    /1   ]  0.225911180592       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.524486190938, 1.0]], [0, [7618.06597456943, 1.0]], [0, [3617.8793100313264, 1.0]], [0, [1612.5615287405908, 1.0]], [0, [240.11103420710108, 1.0]], [0, [52.21825655228945, 1.0]], [0, [4.601972591850524, 1.0]], [0, [0.39866323965293776, 1.0]], [1, [1362.7790999632562, 1.0]], [1, [664.994329249047, 1.0]], [1, [302.2999465825653, 1.0]], [1, [315.24704531038157, 1.0]], [1, [66.43844885966337, 1.0]], [1, [7.792860381941672, 1.0]], [1, [21.746981571497056, 1.0]], [1, [0.7898050719225427, 1.0]], [1, [2.9539039286647935, 1.0]], [1, [0.2259111805916187, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52448619]
bas 1, expnt(s) = [7618.06597457]
bas 2, expnt(s) = [3617.87931003]
bas 3, expnt(s) = [1612.56152874]
bas 4, expnt(s) = [240.11103421]
bas 5, expnt(s) = [52.21825655]
bas 6, expnt(s) = [4.60197259]
bas 7, expnt(s) = [0.39866324]
bas 8, expnt(s) = [1362.77909996]
bas 9, expnt(s) = [664.99432925]
bas 10, expnt(s) = [302.29994658]
bas 11, expnt(s) = [315.24704531]
bas 12, expnt(s) = [66.43844886]
bas 13, expnt(s) = [7.79286038]
bas 14, expnt(s) = [21.74698157]
bas 15, expnt(s) = [0.78980507]
bas 16, expnt(s) = [2.95390393]
bas 17, expnt(s) = [0.22591118]
CPU time:       307.48
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825245e+04 5.20024330e+03 7.61806597e+03 2.06014871e+03
 3.61787931e+03 1.17857054e+03 1.61256153e+03 6.42913056e+02
 2.40111034e+02 1.54107620e+02 5.22182566e+01 4.90774286e+01
 4.60197259e+00 7.93821843e+00 3.98663240e-01 1.26756333e+00
 1.36277910e+03 2.41555107e+04 6.64994329e+02 9.85160113e+03
 3.02299947e+02 3.67732471e+03 3.15247045e+02 3.87523616e+03
 6.64384489e+01 5.53361256e+02 7.79286038e+00 3.79844211e+01
 2.17469816e+01 1.37003962e+02 7.89805072e-01 2.17212238e+00
 2.95390393e+00 1.12974350e+01 2.25911181e-01 4.54366757e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973152597477608
cond(S) = 112577.85369480628
E1 = -727.5522339657153  E_coul = 203.12645671454652
init E= -524.425777251169
    CPU time for initialize scf      0.16 sec, wall time      0.05 sec
  HOMO = -0.559495960701884  LUMO = 1.05441565337793
  mo_energy =
[-1.17869655e+02 -1.20948348e+01 -9.44665982e+00 -9.44665982e+00
 -9.44665982e+00 -1.23032835e+00 -5.59495961e-01 -5.59495961e-01
 -5.59495961e-01  1.05441565e+00  1.05441565e+00  1.05441565e+00
  7.79804991e+00  7.79804991e+00  7.79804991e+00  3.61815764e+01
  3.61815764e+01  3.61815764e+01  1.39905625e+02  1.39905625e+02
  1.39905625e+02  1.83974198e+02  5.04719259e+02  5.04719259e+02
  5.04719259e+02  1.36174549e+03  1.36174549e+03  1.36174549e+03
  1.91356377e+03  3.05966923e+03  3.05966923e+03  3.05966923e+03
  6.68125950e+03  6.68125950e+03  6.68125950e+03  8.26304809e+03
  2.46435023e+04  7.54369961e+04]
E1 = -727.3967588240316  E_coul = 201.8427864061854
cycle= 1 E= -525.553972417846  delta_E= -1.13  |g|= 0.181  |ddm|= 0.324
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460588
diis-c [-0.21214141  1.        ]
  HOMO = -0.572117740558045  LUMO = 1.04743552708968
  mo_energy =
[-1.18107813e+02 -1.21819883e+01 -9.53277678e+00 -9.53277678e+00
 -9.53277678e+00 -1.25121298e+00 -5.72117741e-01 -5.72117741e-01
 -5.72117741e-01  1.04743553e+00  1.04743553e+00  1.04743553e+00
  7.74844424e+00  7.74844424e+00  7.74844424e+00  3.60856066e+01
  3.60856066e+01  3.60856066e+01  1.39746087e+02  1.39746087e+02
  1.39746087e+02  1.83787911e+02  5.04496191e+02  5.04496191e+02
  5.04496191e+02  1.36147534e+03  1.36147534e+03  1.36147534e+03
  1.91317442e+03  3.05933921e+03  3.05933921e+03  3.05933921e+03
  6.68081537e+03  6.68081537e+03  6.68081537e+03  8.26252206e+03
  2.46428832e+04  7.54362860e+04]
E1 = -727.5975158756285  E_coul = 202.04336872721203
cycle= 2 E= -525.554147148416  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.0137
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0303435
diis-c [-7.17146497e-04  3.00966922e-02  9.69903308e-01]
  HOMO = -0.569559574525912  LUMO = 1.04947328385377
  mo_energy =
[-1.18078689e+02 -1.21678820e+01 -9.51846233e+00 -9.51846233e+00
 -9.51846233e+00 -1.24777518e+00 -5.69559575e-01 -5.69559575e-01
 -5.69559575e-01  1.04947328e+00  1.04947328e+00  1.04947328e+00
  7.75644010e+00  7.75644010e+00  7.75644010e+00  3.61009348e+01
  3.61009348e+01  3.61009348e+01  1.39769400e+02  1.39769400e+02
  1.39769400e+02  1.83815914e+02  5.04524881e+02  5.04524881e+02
  5.04524881e+02  1.36150601e+03  1.36150601e+03  1.36150601e+03
  1.91320650e+03  3.05937089e+03  3.05937089e+03  3.05937089e+03
  6.68084760e+03  6.68084760e+03  6.68084760e+03  8.26255450e+03
  2.46429156e+04  7.54363184e+04]
E1 = -727.5559659421417  E_coul = 202.00181317042075
cycle= 3 E= -525.554152771721  delta_E= -5.62e-06  |g|= 0.00208  |ddm|= 0.00358
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00442212
diis-c [-8.63619132e-08 -7.43544488e-04  1.22571973e-01  8.78171572e-01]
  HOMO = -0.570069823091546  LUMO = 1.04907874357158
  mo_energy =
[-1.18082660e+02 -1.21700941e+01 -9.52071797e+00 -9.52071797e+00
 -9.52071797e+00 -1.24844696e+00 -5.70069823e-01 -5.70069823e-01
 -5.70069823e-01  1.04907874e+00  1.04907874e+00  1.04907874e+00
  7.75504637e+00  7.75504637e+00  7.75504637e+00  3.60985810e+01
  3.60985810e+01  3.60985810e+01  1.39766103e+02  1.39766103e+02
  1.39766103e+02  1.83812122e+02  5.04520967e+02  5.04520967e+02
  5.04520967e+02  1.36150186e+03  1.36150186e+03  1.36150186e+03
  1.91320212e+03  3.05936659e+03  3.05936659e+03  3.05936659e+03
  6.68084317e+03  6.68084317e+03  6.68084317e+03  8.26255000e+03
  2.46429110e+04  7.54363138e+04]
E1 = -727.562216597909  E_coul = 202.00806366651202
cycle= 4 E= -525.554152931397  delta_E= -1.6e-07  |g|= 3.71e-05  |ddm|= 0.000583
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.66027e-05
diis-c [-3.76577005e-10 -2.64908249e-05  3.95379601e-03  4.18907437e-02
  9.54181951e-01]
  HOMO = -0.57004836864719  LUMO = 1.04909492238821
  mo_energy =
[-1.18082575e+02 -1.21700237e+01 -9.52064691e+00 -9.52064691e+00
 -9.52064691e+00 -1.24841899e+00 -5.70048369e-01 -5.70048369e-01
 -5.70048369e-01  1.04909492e+00  1.04909492e+00  1.04909492e+00
  7.75509744e+00  7.75509744e+00  7.75509744e+00  3.60986512e+01
  3.60986512e+01  3.60986512e+01  1.39766183e+02  1.39766183e+02
  1.39766183e+02  1.83812206e+02  5.04521051e+02  5.04521051e+02
  5.04521051e+02  1.36150194e+03  1.36150194e+03  1.36150194e+03
  1.91320221e+03  3.05936668e+03  3.05936668e+03  3.05936668e+03
  6.68084326e+03  6.68084326e+03  6.68084326e+03  8.26255008e+03
  2.46429111e+04  7.54363138e+04]
E1 = -727.5620395050186  E_coul = 202.00788657350185
cycle= 5 E= -525.554152931517  delta_E= -1.2e-10  |g|= 2.33e-06  |ddm|= 1.96e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5620395050186  E_coul = 202.00788657350185
  HOMO = -0.570049654935253  LUMO = 1.04909395214514
  mo_energy =
[-1.18082581e+02 -1.21700281e+01 -9.52065142e+00 -9.52065142e+00
 -9.52065142e+00 -1.24842067e+00 -5.70049655e-01 -5.70049655e-01
 -5.70049655e-01  1.04909395e+00  1.04909395e+00  1.04909395e+00
  7.75509431e+00  7.75509431e+00  7.75509431e+00  3.60986467e+01
  3.60986467e+01  3.60986467e+01  1.39766178e+02  1.39766178e+02
  1.39766178e+02  1.83812200e+02  5.04521045e+02  5.04521045e+02
  5.04521045e+02  1.36150194e+03  1.36150194e+03  1.36150194e+03
  1.91320220e+03  3.05936667e+03  3.05936667e+03  3.05936667e+03
  6.68084325e+03  6.68084325e+03  6.68084325e+03  8.26255007e+03
  2.46429111e+04  7.54363138e+04]
E1 = -727.5620510892827  E_coul = 202.00789815776645
Extra cycle  E= -525.554152931516  delta_E= 4.55e-13  |g|= 5.75e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.36 sec, wall time      0.24 sec
exp = [2.61825245e+04 7.61806597e+03 3.61787931e+03 1.61256153e+03
 2.40111034e+02 5.22182566e+01 4.60197259e+00 3.98663240e-01
 1.36277910e+03 6.64994329e+02 3.02299947e+02 3.15247045e+02
 6.64384489e+01 7.79286038e+00 2.17469816e+01 7.89805072e-01
 2.95390393e+00 2.25911181e-01]
E = -525.5541529315162
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5244862        1
[INPUT] 0    0    [1    /1   ]  7618.06597457        1
[INPUT] 0    0    [1    /1   ]  3617.87931003        1
[INPUT] 0    0    [1    /1   ]  1612.56152874        1
[INPUT] 0    0    [1    /1   ]  240.111034207        1
[INPUT] 0    0    [1    /1   ]  52.2182565523        1
[INPUT] 0    0    [1    /1   ]  4.60197259185        1
[INPUT] 0    0    [1    /1   ]  0.398663239653       1
[INPUT] 1    0    [1    /1   ]  1362.77909996        1
[INPUT] 1    0    [1    /1   ]  664.994329249        1
[INPUT] 1    0    [1    /1   ]  302.299946583        1
[INPUT] 1    0    [1    /1   ]  315.24704531         1
[INPUT] 1    0    [1    /1   ]  66.4384488597        1
[INPUT] 1    0    [1    /1   ]  7.79286038194        1
[INPUT] 1    0    [1    /1   ]  21.7469815715        1
[INPUT] 1    0    [1    /1   ]  0.789805071923       1
[INPUT] 1    0    [1    /1   ]  2.95390392866        1
[INPUT] 1    0    [1    /1   ]  0.225911180592       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.524486190938, 1.0]], [0, [7618.06597456943, 1.0]], [0, [3617.8793100313264, 1.0]], [0, [1612.5615287405908, 1.0]], [0, [240.11103420710108, 1.0]], [0, [52.21825655228945, 1.0]], [0, [4.601972591850524, 1.0]], [0, [0.39866323965293776, 1.0]], [1, [1362.7790999632562, 1.0]], [1, [664.994329249047, 1.0]], [1, [302.2999465825653, 1.0]], [1, [315.24704531038157, 1.0]], [1, [66.43844885966337, 1.0]], [1, [7.792860381941672, 1.0]], [1, [21.746981571497056, 1.0]], [1, [0.7898050719225427, 1.0]], [1, [2.9539039286647935, 1.0]], [1, [0.2259111805916187, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52448619]
bas 1, expnt(s) = [7618.06597457]
bas 2, expnt(s) = [3617.87931003]
bas 3, expnt(s) = [1612.56152874]
bas 4, expnt(s) = [240.11103421]
bas 5, expnt(s) = [52.21825655]
bas 6, expnt(s) = [4.60197259]
bas 7, expnt(s) = [0.39866324]
bas 8, expnt(s) = [1362.77909996]
bas 9, expnt(s) = [664.99432925]
bas 10, expnt(s) = [302.29994658]
bas 11, expnt(s) = [315.24704531]
bas 12, expnt(s) = [66.43844886]
bas 13, expnt(s) = [7.79286038]
bas 14, expnt(s) = [21.74698157]
bas 15, expnt(s) = [0.78980507]
bas 16, expnt(s) = [2.95390393]
bas 17, expnt(s) = [0.22591118]
CPU time:       308.12
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825245e+04 5.20024330e+03 7.61806597e+03 2.06014871e+03
 3.61787931e+03 1.17857054e+03 1.61256153e+03 6.42913056e+02
 2.40111034e+02 1.54107620e+02 5.22182566e+01 4.90774286e+01
 4.60197259e+00 7.93821843e+00 3.98663240e-01 1.26756333e+00
 1.36277910e+03 2.41555107e+04 6.64994329e+02 9.85160113e+03
 3.02299947e+02 3.67732471e+03 3.15247045e+02 3.87523616e+03
 6.64384489e+01 5.53361256e+02 7.79286038e+00 3.79844211e+01
 2.17469816e+01 1.37003962e+02 7.89805072e-01 2.17212238e+00
 2.95390393e+00 1.12974350e+01 2.25911181e-01 4.54366757e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973152597477608
cond(S) = 112577.85369480628
E1 = -727.5522339657153  E_coul = 203.12645671454652
init E= -524.425777251169
    CPU time for initialize scf      0.15 sec, wall time      0.04 sec
  HOMO = -0.559495960701884  LUMO = 1.05441565337793
  mo_energy =
[-1.17869655e+02 -1.20948348e+01 -9.44665982e+00 -9.44665982e+00
 -9.44665982e+00 -1.23032835e+00 -5.59495961e-01 -5.59495961e-01
 -5.59495961e-01  1.05441565e+00  1.05441565e+00  1.05441565e+00
  7.79804991e+00  7.79804991e+00  7.79804991e+00  3.61815764e+01
  3.61815764e+01  3.61815764e+01  1.39905625e+02  1.39905625e+02
  1.39905625e+02  1.83974198e+02  5.04719259e+02  5.04719259e+02
  5.04719259e+02  1.36174549e+03  1.36174549e+03  1.36174549e+03
  1.91356377e+03  3.05966923e+03  3.05966923e+03  3.05966923e+03
  6.68125950e+03  6.68125950e+03  6.68125950e+03  8.26304809e+03
  2.46435023e+04  7.54369961e+04]
E1 = -727.3967588240316  E_coul = 201.8427864061854
cycle= 1 E= -525.553972417846  delta_E= -1.13  |g|= 0.181  |ddm|= 0.324
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460588
diis-c [-0.21214141  1.        ]
  HOMO = -0.572117740558045  LUMO = 1.04743552708968
  mo_energy =
[-1.18107813e+02 -1.21819883e+01 -9.53277678e+00 -9.53277678e+00
 -9.53277678e+00 -1.25121298e+00 -5.72117741e-01 -5.72117741e-01
 -5.72117741e-01  1.04743553e+00  1.04743553e+00  1.04743553e+00
  7.74844424e+00  7.74844424e+00  7.74844424e+00  3.60856066e+01
  3.60856066e+01  3.60856066e+01  1.39746087e+02  1.39746087e+02
  1.39746087e+02  1.83787911e+02  5.04496191e+02  5.04496191e+02
  5.04496191e+02  1.36147534e+03  1.36147534e+03  1.36147534e+03
  1.91317442e+03  3.05933921e+03  3.05933921e+03  3.05933921e+03
  6.68081537e+03  6.68081537e+03  6.68081537e+03  8.26252206e+03
  2.46428832e+04  7.54362860e+04]
E1 = -727.5975158756285  E_coul = 202.04336872721203
cycle= 2 E= -525.554147148416  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.0137
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0303435
diis-c [-7.17146497e-04  3.00966922e-02  9.69903308e-01]
  HOMO = -0.569559574525912  LUMO = 1.04947328385377
  mo_energy =
[-1.18078689e+02 -1.21678820e+01 -9.51846233e+00 -9.51846233e+00
 -9.51846233e+00 -1.24777518e+00 -5.69559575e-01 -5.69559575e-01
 -5.69559575e-01  1.04947328e+00  1.04947328e+00  1.04947328e+00
  7.75644010e+00  7.75644010e+00  7.75644010e+00  3.61009348e+01
  3.61009348e+01  3.61009348e+01  1.39769400e+02  1.39769400e+02
  1.39769400e+02  1.83815914e+02  5.04524881e+02  5.04524881e+02
  5.04524881e+02  1.36150601e+03  1.36150601e+03  1.36150601e+03
  1.91320650e+03  3.05937089e+03  3.05937089e+03  3.05937089e+03
  6.68084760e+03  6.68084760e+03  6.68084760e+03  8.26255450e+03
  2.46429156e+04  7.54363184e+04]
E1 = -727.5559659421417  E_coul = 202.00181317042075
cycle= 3 E= -525.554152771721  delta_E= -5.62e-06  |g|= 0.00208  |ddm|= 0.00358
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00442212
diis-c [-8.63619132e-08 -7.43544488e-04  1.22571973e-01  8.78171572e-01]
  HOMO = -0.570069823091546  LUMO = 1.04907874357158
  mo_energy =
[-1.18082660e+02 -1.21700941e+01 -9.52071797e+00 -9.52071797e+00
 -9.52071797e+00 -1.24844696e+00 -5.70069823e-01 -5.70069823e-01
 -5.70069823e-01  1.04907874e+00  1.04907874e+00  1.04907874e+00
  7.75504637e+00  7.75504637e+00  7.75504637e+00  3.60985810e+01
  3.60985810e+01  3.60985810e+01  1.39766103e+02  1.39766103e+02
  1.39766103e+02  1.83812122e+02  5.04520967e+02  5.04520967e+02
  5.04520967e+02  1.36150186e+03  1.36150186e+03  1.36150186e+03
  1.91320212e+03  3.05936659e+03  3.05936659e+03  3.05936659e+03
  6.68084317e+03  6.68084317e+03  6.68084317e+03  8.26255000e+03
  2.46429110e+04  7.54363138e+04]
E1 = -727.562216597909  E_coul = 202.00806366651202
cycle= 4 E= -525.554152931397  delta_E= -1.6e-07  |g|= 3.71e-05  |ddm|= 0.000583
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.66027e-05
diis-c [-3.76577005e-10 -2.64908249e-05  3.95379601e-03  4.18907437e-02
  9.54181951e-01]
  HOMO = -0.57004836864719  LUMO = 1.04909492238821
  mo_energy =
[-1.18082575e+02 -1.21700237e+01 -9.52064691e+00 -9.52064691e+00
 -9.52064691e+00 -1.24841899e+00 -5.70048369e-01 -5.70048369e-01
 -5.70048369e-01  1.04909492e+00  1.04909492e+00  1.04909492e+00
  7.75509744e+00  7.75509744e+00  7.75509744e+00  3.60986512e+01
  3.60986512e+01  3.60986512e+01  1.39766183e+02  1.39766183e+02
  1.39766183e+02  1.83812206e+02  5.04521051e+02  5.04521051e+02
  5.04521051e+02  1.36150194e+03  1.36150194e+03  1.36150194e+03
  1.91320221e+03  3.05936668e+03  3.05936668e+03  3.05936668e+03
  6.68084326e+03  6.68084326e+03  6.68084326e+03  8.26255008e+03
  2.46429111e+04  7.54363138e+04]
E1 = -727.5620395050186  E_coul = 202.00788657350185
cycle= 5 E= -525.554152931517  delta_E= -1.2e-10  |g|= 2.33e-06  |ddm|= 1.96e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5620395050186  E_coul = 202.00788657350185
  HOMO = -0.570049654935253  LUMO = 1.04909395214514
  mo_energy =
[-1.18082581e+02 -1.21700281e+01 -9.52065142e+00 -9.52065142e+00
 -9.52065142e+00 -1.24842067e+00 -5.70049655e-01 -5.70049655e-01
 -5.70049655e-01  1.04909395e+00  1.04909395e+00  1.04909395e+00
  7.75509431e+00  7.75509431e+00  7.75509431e+00  3.60986467e+01
  3.60986467e+01  3.60986467e+01  1.39766178e+02  1.39766178e+02
  1.39766178e+02  1.83812200e+02  5.04521045e+02  5.04521045e+02
  5.04521045e+02  1.36150194e+03  1.36150194e+03  1.36150194e+03
  1.91320220e+03  3.05936667e+03  3.05936667e+03  3.05936667e+03
  6.68084325e+03  6.68084325e+03  6.68084325e+03  8.26255007e+03
  2.46429111e+04  7.54363138e+04]
E1 = -727.5620510892827  E_coul = 202.00789815776645
Extra cycle  E= -525.554152931516  delta_E= 4.55e-13  |g|= 5.75e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.24 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 112577.85369480628
E1 = -727.5620510892827  E_coul = 202.00789815776645
init E= -525.554152931516
    CPU time for initialize scf      1.15 sec, wall time      0.21 sec
  HOMO = -0.570049435129493  LUMO = 1.0490941204363
  mo_energy =
[-1.18082580e+02 -1.21700273e+01 -9.52065055e+00 -9.52065055e+00
 -9.52065055e+00 -1.24842038e+00 -5.70049435e-01 -5.70049435e-01
 -5.70049435e-01  1.04909412e+00  1.04909412e+00  1.04909412e+00
  7.75509488e+00  7.75509488e+00  7.75509488e+00  3.60986476e+01
  3.60986476e+01  3.60986476e+01  1.39766179e+02  1.39766179e+02
  1.39766179e+02  1.83812201e+02  5.04521046e+02  5.04521046e+02
  5.04521046e+02  1.36150194e+03  1.36150194e+03  1.36150194e+03
  1.91320220e+03  3.05936667e+03  3.05936667e+03  3.05936667e+03
  6.68084325e+03  6.68084325e+03  6.68084325e+03  8.26255007e+03
  2.46429111e+04  7.54363138e+04]
E1 = -727.5620487542143  E_coul = 202.00789582269746
cycle= 1 E= -525.554152931517  delta_E= -5.68e-13  |g|= 1.24e-07  |ddm|= 2.3e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.5620487542143  E_coul = 202.00789582269746
  HOMO = -0.570049477254898  LUMO = 1.04909408806631
  mo_energy =
[-1.18082580e+02 -1.21700274e+01 -9.52065073e+00 -9.52065073e+00
 -9.52065073e+00 -1.24842044e+00 -5.70049477e-01 -5.70049477e-01
 -5.70049477e-01  1.04909409e+00  1.04909409e+00  1.04909409e+00
  7.75509477e+00  7.75509477e+00  7.75509477e+00  3.60986474e+01
  3.60986474e+01  3.60986474e+01  1.39766179e+02  1.39766179e+02
  1.39766179e+02  1.83812201e+02  5.04521046e+02  5.04521046e+02
  5.04521046e+02  1.36150194e+03  1.36150194e+03  1.36150194e+03
  1.91320220e+03  3.05936667e+03  3.05936667e+03  3.05936667e+03
  6.68084325e+03  6.68084325e+03  6.68084325e+03  8.26255007e+03
  2.46429111e+04  7.54363138e+04]
E1 = -727.5620492295543  E_coul = 202.00789629803853
Extra cycle  E= -525.554152931516  delta_E= 1.02e-12  |g|= 2.6e-08  |ddm|= 4.59e-08
    CPU time for scf_cycle      1.28 sec, wall time      0.34 sec
exp = [2.61825245e+04 7.61806597e+03 3.61787931e+03 1.61256153e+03
 2.40111034e+02 5.22182566e+01 4.60197259e+00 3.98663240e-01
 1.36277910e+03 6.64994329e+02 3.02299947e+02 3.15247045e+02
 6.64384489e+01 7.79286038e+00 2.17469816e+01 7.89805072e-01
 2.95390393e+00 2.25911181e-01]
grad_E = [-1.98929633e-06  2.16592187e-05  4.28529224e-05  6.71997426e-04
  1.73110852e-04 -5.57508072e-05 -3.61582345e-04 -9.02915033e-04
 -6.49173182e-07  2.56073074e-06  1.04412692e-05  8.95090786e-06
  2.32529239e-04  4.03138155e-04 -7.70937931e-05  2.28023589e-03
 -9.94112222e-04 -4.93332238e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5242507        1
[INPUT] 0    0    [1    /1   ]  7618.06859231        1
[INPUT] 0    0    [1    /1   ]  3617.88457441        1
[INPUT] 0    0    [1    /1   ]  1612.64209815        1
[INPUT] 0    0    [1    /1   ]  240.104887515        1
[INPUT] 0    0    [1    /1   ]  52.2195036394        1
[INPUT] 0    0    [1    /1   ]  4.60217363523        1
[INPUT] 0    0    [1    /1   ]  0.398700442181       1
[INPUT] 1    0    [1    /1   ]  1362.77931009        1
[INPUT] 1    0    [1    /1   ]  664.997075129        1
[INPUT] 1    0    [1    /1   ]  302.315018537        1
[INPUT] 1    0    [1    /1   ]  315.260327235        1
[INPUT] 1    0    [1    /1   ]  66.1637180811        1
[INPUT] 1    0    [1    /1   ]  7.78290691508        1
[INPUT] 1    0    [1    /1   ]  21.7031478892        1
[INPUT] 1    0    [1    /1   ]  0.78865100637        1
[INPUT] 1    0    [1    /1   ]  2.95271758232        1
[INPUT] 1    0    [1    /1   ]  0.225647282075       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.524250707127, 1.0]], [0, [7618.068592313202, 1.0]], [0, [3617.8845744134655, 1.0]], [0, [1612.6420981532106, 1.0]], [0, [240.10488751485906, 1.0]], [0, [52.21950363940619, 1.0]], [0, [4.602173635226568, 1.0]], [0, [0.3987004421806578, 1.0]], [1, [1362.7793100863682, 1.0]], [1, [664.9970751289598, 1.0]], [1, [302.3150185368005, 1.0]], [1, [315.2603272347981, 1.0]], [1, [66.16371808111347, 1.0]], [1, [7.782906915078521, 1.0]], [1, [21.70314788924966, 1.0]], [1, [0.788651006369815, 1.0]], [1, [2.9527175823206666, 1.0]], [1, [0.2256472820752705, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52425071]
bas 1, expnt(s) = [7618.06859231]
bas 2, expnt(s) = [3617.88457441]
bas 3, expnt(s) = [1612.64209815]
bas 4, expnt(s) = [240.10488751]
bas 5, expnt(s) = [52.21950364]
bas 6, expnt(s) = [4.60217364]
bas 7, expnt(s) = [0.39870044]
bas 8, expnt(s) = [1362.77931009]
bas 9, expnt(s) = [664.99707513]
bas 10, expnt(s) = [302.31501854]
bas 11, expnt(s) = [315.26032723]
bas 12, expnt(s) = [66.16371808]
bas 13, expnt(s) = [7.78290692]
bas 14, expnt(s) = [21.70314789]
bas 15, expnt(s) = [0.78865101]
bas 16, expnt(s) = [2.95271758]
bas 17, expnt(s) = [0.22564728]
CPU time:       314.29
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825243e+04 5.20024326e+03 7.61806859e+03 2.06014924e+03
 3.61788457e+03 1.17857182e+03 1.61264210e+03 6.42937147e+02
 2.40104888e+02 1.54104661e+02 5.22195036e+01 4.90783077e+01
 4.60217364e+00 7.93847853e+00 3.98700442e-01 1.26765205e+00
 1.36277931e+03 2.41555153e+04 6.64997075e+02 9.85165198e+03
 3.02315019e+02 3.67755389e+03 3.15260327e+02 3.87544025e+03
 6.61637181e+01 5.50502468e+02 7.78290692e+00 3.79237861e+01
 2.17031479e+01 1.36658864e+02 7.88651006e-01 2.16815572e+00
 2.95271758e+00 1.12917637e+01 2.25647282e-01 4.53703392e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973188213699572
cond(S) = 112162.58769402142
E1 = -727.553028733777  E_coul = 203.12739438375863
init E= -524.425634350018
    CPU time for initialize scf      0.53 sec, wall time      0.07 sec
  HOMO = -0.559486549624581  LUMO = 1.0524078646263
  mo_energy =
[-1.17869512e+02 -1.20947822e+01 -9.44658424e+00 -9.44658424e+00
 -9.44658424e+00 -1.23031463e+00 -5.59486550e-01 -5.59486550e-01
 -5.59486550e-01  1.05240786e+00  1.05240786e+00  1.05240786e+00
  7.78720420e+00  7.78720420e+00  7.78720420e+00  3.61192532e+01
  3.61192532e+01  3.61192532e+01  1.39489477e+02  1.39489477e+02
  1.39489477e+02  1.83975122e+02  5.03791097e+02  5.03791097e+02
  5.03791097e+02  1.36068649e+03  1.36068649e+03  1.36068649e+03
  1.91359586e+03  3.05863198e+03  3.05863198e+03  3.05863198e+03
  6.68030785e+03  6.68030785e+03  6.68030785e+03  8.26320522e+03
  2.46437632e+04  7.54372970e+04]
E1 = -727.3963118179754  E_coul = 201.84233159246455
cycle= 1 E= -525.553980225511  delta_E= -1.13  |g|= 0.181  |ddm|= 0.326
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460538
diis-c [-0.2120952  1.       ]
  HOMO = -0.572151583377514  LUMO = 1.04541882626448
  mo_energy =
[-1.18107730e+02 -1.21820543e+01 -9.53281037e+00 -9.53281037e+00
 -9.53281037e+00 -1.25125947e+00 -5.72151583e-01 -5.72151583e-01
 -5.72151583e-01  1.04541883e+00  1.04541883e+00  1.04541883e+00
  7.73755763e+00  7.73755763e+00  7.73755763e+00  3.60232841e+01
  3.60232841e+01  3.60232841e+01  1.39330052e+02  1.39330052e+02
  1.39330052e+02  1.83788748e+02  5.03567986e+02  5.03567986e+02
  5.03567986e+02  1.36041629e+03  1.36041629e+03  1.36041629e+03
  1.91320653e+03  3.05830194e+03  3.05830194e+03  3.05830194e+03
  6.67986374e+03  6.67986374e+03  6.67986374e+03  8.26267924e+03
  2.46431441e+04  7.54365870e+04]
E1 = -727.5973288138804  E_coul = 202.0431737246147
cycle= 2 E= -525.554155089266  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.0138
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0303642
diis-c [-7.18233110e-04  3.01124471e-02  9.69887553e-01]
  HOMO = -0.569586860568803  LUMO = 1.04745784739924
  mo_energy =
[-1.18078584e+02 -1.21679294e+01 -9.51847723e+00 -9.51847723e+00
 -9.51847723e+00 -1.24781309e+00 -5.69586861e-01 -5.69586861e-01
 -5.69586861e-01  1.04745785e+00  1.04745785e+00  1.04745785e+00
  7.74556189e+00  7.74556189e+00  7.74556189e+00  3.60386163e+01
  3.60386163e+01  3.60386163e+01  1.39353364e+02  1.39353364e+02
  1.39353364e+02  1.83816772e+02  5.03596696e+02  5.03596696e+02
  5.03596696e+02  1.36044698e+03  1.36044698e+03  1.36044698e+03
  1.91323863e+03  3.05833365e+03  3.05833365e+03  3.05833365e+03
  6.67989599e+03  6.67989599e+03  6.67989599e+03  8.26271170e+03
  2.46431766e+04  7.54366194e+04]
E1 = -727.5557262930079  E_coul = 202.00156556966212
cycle= 3 E= -525.554160723346  delta_E= -5.63e-06  |g|= 0.00208  |ddm|= 0.00359
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00442615
diis-c [-8.62230989e-08 -7.43403678e-04  1.22604505e-01  8.78138899e-01]
  HOMO = -0.570097898538402  LUMO = 1.04706341246502
  mo_energy =
[-1.18082558e+02 -1.21701440e+01 -9.52073537e+00 -9.52073537e+00
 -9.52073537e+00 -1.24848594e+00 -5.70097899e-01 -5.70097899e-01
 -5.70097899e-01  1.04706341e+00  1.04706341e+00  1.04706341e+00
  7.74416726e+00  7.74416726e+00  7.74416726e+00  3.60362618e+01
  3.60362618e+01  3.60362618e+01  1.39350067e+02  1.39350067e+02
  1.39350067e+02  1.83812977e+02  5.03592778e+02  5.03592778e+02
  5.03592778e+02  1.36044283e+03  1.36044283e+03  1.36044283e+03
  1.91323425e+03  3.05832935e+03  3.05832935e+03  3.05832935e+03
  6.67989156e+03  6.67989156e+03  6.67989156e+03  8.26270719e+03
  2.46431720e+04  7.54366148e+04]
E1 = -727.5619848486783  E_coul = 202.00782396531105
cycle= 4 E= -525.554160883367  delta_E= -1.6e-07  |g|= 3.71e-05  |ddm|= 0.000584
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.66312e-05
diis-c [-3.77512851e-10 -2.64630059e-05  3.95385159e-03  4.18752010e-02
  9.54197410e-01]
  HOMO = -0.570076440099883  LUMO = 1.04707956743549
  mo_energy =
[-1.18082474e+02 -1.21700736e+01 -9.52066432e+00 -9.52066432e+00
 -9.52066432e+00 -1.24845797e+00 -5.70076440e-01 -5.70076440e-01
 -5.70076440e-01  1.04707957e+00  1.04707957e+00  1.04707957e+00
  7.74421830e+00  7.74421830e+00  7.74421830e+00  3.60363320e+01
  3.60363320e+01  3.60363320e+01  1.39350147e+02  1.39350147e+02
  1.39350147e+02  1.83813061e+02  5.03592862e+02  5.03592862e+02
  5.03592862e+02  1.36044291e+03  1.36044291e+03  1.36044291e+03
  1.91323434e+03  3.05832943e+03  3.05832943e+03  3.05832943e+03
  6.67989164e+03  6.67989164e+03  6.67989164e+03  8.26270727e+03
  2.46431721e+04  7.54366149e+04]
E1 = -727.5618077574261  E_coul = 202.00764687394144
cycle= 5 E= -525.554160883485  delta_E= -1.17e-10  |g|= 2.32e-06  |ddm|= 1.96e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5618077574261  E_coul = 202.00764687394144
  HOMO = -0.570077725421226  LUMO = 1.04707859968746
  mo_energy =
[-1.18082480e+02 -1.21700781e+01 -9.52066883e+00 -9.52066883e+00
 -9.52066883e+00 -1.24845964e+00 -5.70077725e-01 -5.70077725e-01
 -5.70077725e-01  1.04707860e+00  1.04707860e+00  1.04707860e+00
  7.74421518e+00  7.74421518e+00  7.74421518e+00  3.60363275e+01
  3.60363275e+01  3.60363275e+01  1.39350141e+02  1.39350141e+02
  1.39350141e+02  1.83813055e+02  5.03592856e+02  5.03592856e+02
  5.03592856e+02  1.36044291e+03  1.36044291e+03  1.36044291e+03
  1.91323433e+03  3.05832943e+03  3.05832943e+03  3.05832943e+03
  6.67989164e+03  6.67989164e+03  6.67989164e+03  8.26270726e+03
  2.46431721e+04  7.54366148e+04]
E1 = -727.5618193350876  E_coul = 202.00765845160282
Extra cycle  E= -525.554160883485  delta_E= -2.27e-13  |g|= 5.74e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.72 sec, wall time      0.26 sec
exp = [2.61825243e+04 7.61806859e+03 3.61788457e+03 1.61264210e+03
 2.40104888e+02 5.22195036e+01 4.60217364e+00 3.98700442e-01
 1.36277931e+03 6.64997075e+02 3.02315019e+02 3.15260327e+02
 6.61637181e+01 7.78290692e+00 2.17031479e+01 7.88651006e-01
 2.95271758e+00 2.25647282e-01]
E = -525.5541608834849
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5242507        1
[INPUT] 0    0    [1    /1   ]  7618.06859231        1
[INPUT] 0    0    [1    /1   ]  3617.88457441        1
[INPUT] 0    0    [1    /1   ]  1612.64209815        1
[INPUT] 0    0    [1    /1   ]  240.104887515        1
[INPUT] 0    0    [1    /1   ]  52.2195036394        1
[INPUT] 0    0    [1    /1   ]  4.60217363523        1
[INPUT] 0    0    [1    /1   ]  0.398700442181       1
[INPUT] 1    0    [1    /1   ]  1362.77931009        1
[INPUT] 1    0    [1    /1   ]  664.997075129        1
[INPUT] 1    0    [1    /1   ]  302.315018537        1
[INPUT] 1    0    [1    /1   ]  315.260327235        1
[INPUT] 1    0    [1    /1   ]  66.1637180811        1
[INPUT] 1    0    [1    /1   ]  7.78290691508        1
[INPUT] 1    0    [1    /1   ]  21.7031478892        1
[INPUT] 1    0    [1    /1   ]  0.78865100637        1
[INPUT] 1    0    [1    /1   ]  2.95271758232        1
[INPUT] 1    0    [1    /1   ]  0.225647282075       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.524250707127, 1.0]], [0, [7618.068592313202, 1.0]], [0, [3617.8845744134655, 1.0]], [0, [1612.6420981532106, 1.0]], [0, [240.10488751485906, 1.0]], [0, [52.21950363940619, 1.0]], [0, [4.602173635226568, 1.0]], [0, [0.3987004421806578, 1.0]], [1, [1362.7793100863682, 1.0]], [1, [664.9970751289598, 1.0]], [1, [302.3150185368005, 1.0]], [1, [315.2603272347981, 1.0]], [1, [66.16371808111347, 1.0]], [1, [7.782906915078521, 1.0]], [1, [21.70314788924966, 1.0]], [1, [0.788651006369815, 1.0]], [1, [2.9527175823206666, 1.0]], [1, [0.2256472820752705, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52425071]
bas 1, expnt(s) = [7618.06859231]
bas 2, expnt(s) = [3617.88457441]
bas 3, expnt(s) = [1612.64209815]
bas 4, expnt(s) = [240.10488751]
bas 5, expnt(s) = [52.21950364]
bas 6, expnt(s) = [4.60217364]
bas 7, expnt(s) = [0.39870044]
bas 8, expnt(s) = [1362.77931009]
bas 9, expnt(s) = [664.99707513]
bas 10, expnt(s) = [302.31501854]
bas 11, expnt(s) = [315.26032723]
bas 12, expnt(s) = [66.16371808]
bas 13, expnt(s) = [7.78290692]
bas 14, expnt(s) = [21.70314789]
bas 15, expnt(s) = [0.78865101]
bas 16, expnt(s) = [2.95271758]
bas 17, expnt(s) = [0.22564728]
CPU time:       315.22
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825243e+04 5.20024326e+03 7.61806859e+03 2.06014924e+03
 3.61788457e+03 1.17857182e+03 1.61264210e+03 6.42937147e+02
 2.40104888e+02 1.54104661e+02 5.22195036e+01 4.90783077e+01
 4.60217364e+00 7.93847853e+00 3.98700442e-01 1.26765205e+00
 1.36277931e+03 2.41555153e+04 6.64997075e+02 9.85165198e+03
 3.02315019e+02 3.67755389e+03 3.15260327e+02 3.87544025e+03
 6.61637181e+01 5.50502468e+02 7.78290692e+00 3.79237861e+01
 2.17031479e+01 1.36658864e+02 7.88651006e-01 2.16815572e+00
 2.95271758e+00 1.12917637e+01 2.25647282e-01 4.53703392e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973188213699572
cond(S) = 112162.58769402142
E1 = -727.553028733777  E_coul = 203.12739438375863
init E= -524.425634350018
    CPU time for initialize scf      0.65 sec, wall time      0.07 sec
  HOMO = -0.559486549624581  LUMO = 1.0524078646263
  mo_energy =
[-1.17869512e+02 -1.20947822e+01 -9.44658424e+00 -9.44658424e+00
 -9.44658424e+00 -1.23031463e+00 -5.59486550e-01 -5.59486550e-01
 -5.59486550e-01  1.05240786e+00  1.05240786e+00  1.05240786e+00
  7.78720420e+00  7.78720420e+00  7.78720420e+00  3.61192532e+01
  3.61192532e+01  3.61192532e+01  1.39489477e+02  1.39489477e+02
  1.39489477e+02  1.83975122e+02  5.03791097e+02  5.03791097e+02
  5.03791097e+02  1.36068649e+03  1.36068649e+03  1.36068649e+03
  1.91359586e+03  3.05863198e+03  3.05863198e+03  3.05863198e+03
  6.68030785e+03  6.68030785e+03  6.68030785e+03  8.26320522e+03
  2.46437632e+04  7.54372970e+04]
E1 = -727.3963118179754  E_coul = 201.84233159246455
cycle= 1 E= -525.553980225511  delta_E= -1.13  |g|= 0.181  |ddm|= 0.326
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.460538
diis-c [-0.2120952  1.       ]
  HOMO = -0.572151583377514  LUMO = 1.04541882626448
  mo_energy =
[-1.18107730e+02 -1.21820543e+01 -9.53281037e+00 -9.53281037e+00
 -9.53281037e+00 -1.25125947e+00 -5.72151583e-01 -5.72151583e-01
 -5.72151583e-01  1.04541883e+00  1.04541883e+00  1.04541883e+00
  7.73755763e+00  7.73755763e+00  7.73755763e+00  3.60232841e+01
  3.60232841e+01  3.60232841e+01  1.39330052e+02  1.39330052e+02
  1.39330052e+02  1.83788748e+02  5.03567986e+02  5.03567986e+02
  5.03567986e+02  1.36041629e+03  1.36041629e+03  1.36041629e+03
  1.91320653e+03  3.05830194e+03  3.05830194e+03  3.05830194e+03
  6.67986374e+03  6.67986374e+03  6.67986374e+03  8.26267924e+03
  2.46431441e+04  7.54365870e+04]
E1 = -727.5973288138804  E_coul = 202.0431737246147
cycle= 2 E= -525.554155089266  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.0138
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0303642
diis-c [-7.18233110e-04  3.01124471e-02  9.69887553e-01]
  HOMO = -0.569586860568803  LUMO = 1.04745784739924
  mo_energy =
[-1.18078584e+02 -1.21679294e+01 -9.51847723e+00 -9.51847723e+00
 -9.51847723e+00 -1.24781309e+00 -5.69586861e-01 -5.69586861e-01
 -5.69586861e-01  1.04745785e+00  1.04745785e+00  1.04745785e+00
  7.74556189e+00  7.74556189e+00  7.74556189e+00  3.60386163e+01
  3.60386163e+01  3.60386163e+01  1.39353364e+02  1.39353364e+02
  1.39353364e+02  1.83816772e+02  5.03596696e+02  5.03596696e+02
  5.03596696e+02  1.36044698e+03  1.36044698e+03  1.36044698e+03
  1.91323863e+03  3.05833365e+03  3.05833365e+03  3.05833365e+03
  6.67989599e+03  6.67989599e+03  6.67989599e+03  8.26271170e+03
  2.46431766e+04  7.54366194e+04]
E1 = -727.5557262930079  E_coul = 202.00156556966212
cycle= 3 E= -525.554160723346  delta_E= -5.63e-06  |g|= 0.00208  |ddm|= 0.00359
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00442615
diis-c [-8.62230989e-08 -7.43403678e-04  1.22604505e-01  8.78138899e-01]
  HOMO = -0.570097898538402  LUMO = 1.04706341246502
  mo_energy =
[-1.18082558e+02 -1.21701440e+01 -9.52073537e+00 -9.52073537e+00
 -9.52073537e+00 -1.24848594e+00 -5.70097899e-01 -5.70097899e-01
 -5.70097899e-01  1.04706341e+00  1.04706341e+00  1.04706341e+00
  7.74416726e+00  7.74416726e+00  7.74416726e+00  3.60362618e+01
  3.60362618e+01  3.60362618e+01  1.39350067e+02  1.39350067e+02
  1.39350067e+02  1.83812977e+02  5.03592778e+02  5.03592778e+02
  5.03592778e+02  1.36044283e+03  1.36044283e+03  1.36044283e+03
  1.91323425e+03  3.05832935e+03  3.05832935e+03  3.05832935e+03
  6.67989156e+03  6.67989156e+03  6.67989156e+03  8.26270719e+03
  2.46431720e+04  7.54366148e+04]
E1 = -727.5619848486783  E_coul = 202.00782396531105
cycle= 4 E= -525.554160883367  delta_E= -1.6e-07  |g|= 3.71e-05  |ddm|= 0.000584
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.66312e-05
diis-c [-3.77512851e-10 -2.64630059e-05  3.95385159e-03  4.18752010e-02
  9.54197410e-01]
  HOMO = -0.570076440099883  LUMO = 1.04707956743549
  mo_energy =
[-1.18082474e+02 -1.21700736e+01 -9.52066432e+00 -9.52066432e+00
 -9.52066432e+00 -1.24845797e+00 -5.70076440e-01 -5.70076440e-01
 -5.70076440e-01  1.04707957e+00  1.04707957e+00  1.04707957e+00
  7.74421830e+00  7.74421830e+00  7.74421830e+00  3.60363320e+01
  3.60363320e+01  3.60363320e+01  1.39350147e+02  1.39350147e+02
  1.39350147e+02  1.83813061e+02  5.03592862e+02  5.03592862e+02
  5.03592862e+02  1.36044291e+03  1.36044291e+03  1.36044291e+03
  1.91323434e+03  3.05832943e+03  3.05832943e+03  3.05832943e+03
  6.67989164e+03  6.67989164e+03  6.67989164e+03  8.26270727e+03
  2.46431721e+04  7.54366149e+04]
E1 = -727.5618077574261  E_coul = 202.00764687394144
cycle= 5 E= -525.554160883485  delta_E= -1.17e-10  |g|= 2.32e-06  |ddm|= 1.96e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5618077574261  E_coul = 202.00764687394144
  HOMO = -0.570077725421226  LUMO = 1.04707859968746
  mo_energy =
[-1.18082480e+02 -1.21700781e+01 -9.52066883e+00 -9.52066883e+00
 -9.52066883e+00 -1.24845964e+00 -5.70077725e-01 -5.70077725e-01
 -5.70077725e-01  1.04707860e+00  1.04707860e+00  1.04707860e+00
  7.74421518e+00  7.74421518e+00  7.74421518e+00  3.60363275e+01
  3.60363275e+01  3.60363275e+01  1.39350141e+02  1.39350141e+02
  1.39350141e+02  1.83813055e+02  5.03592856e+02  5.03592856e+02
  5.03592856e+02  1.36044291e+03  1.36044291e+03  1.36044291e+03
  1.91323433e+03  3.05832943e+03  3.05832943e+03  3.05832943e+03
  6.67989164e+03  6.67989164e+03  6.67989164e+03  8.26270726e+03
  2.46431721e+04  7.54366148e+04]
E1 = -727.5618193350876  E_coul = 202.00765845160282
Extra cycle  E= -525.554160883485  delta_E= -2.27e-13  |g|= 5.74e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.79 sec, wall time      0.21 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 112162.58769402142
E1 = -727.5618193350876  E_coul = 202.00765845160282
init E= -525.554160883485
    CPU time for initialize scf      1.60 sec, wall time      0.22 sec
  HOMO = -0.570077505625306  LUMO = 1.04707876767839
  mo_energy =
[-1.18082478e+02 -1.21700772e+01 -9.52066796e+00 -9.52066796e+00
 -9.52066796e+00 -1.24845935e+00 -5.70077506e-01 -5.70077506e-01
 -5.70077506e-01  1.04707877e+00  1.04707877e+00  1.04707877e+00
  7.74421575e+00  7.74421575e+00  7.74421575e+00  3.60363284e+01
  3.60363284e+01  3.60363284e+01  1.39350143e+02  1.39350143e+02
  1.39350143e+02  1.83813056e+02  5.03592858e+02  5.03592858e+02
  5.03592858e+02  1.36044291e+03  1.36044291e+03  1.36044291e+03
  1.91323433e+03  3.05832943e+03  3.05832943e+03  3.05832943e+03
  6.67989164e+03  6.67989164e+03  6.67989164e+03  8.26270727e+03
  2.46431721e+04  7.54366148e+04]
E1 = -727.5618170011968  E_coul = 202.0076561177121
cycle= 1 E= -525.554160883485  delta_E= 2.27e-13  |g|= 1.24e-07  |ddm|= 2.3e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.5618170011968  E_coul = 202.0076561177121
  HOMO = -0.570077547742794  LUMO = 1.04707873537156
  mo_energy =
[-1.18082479e+02 -1.21700774e+01 -9.52066813e+00 -9.52066813e+00
 -9.52066813e+00 -1.24845941e+00 -5.70077548e-01 -5.70077548e-01
 -5.70077548e-01  1.04707874e+00  1.04707874e+00  1.04707874e+00
  7.74421564e+00  7.74421564e+00  7.74421564e+00  3.60363282e+01
  3.60363282e+01  3.60363282e+01  1.39350142e+02  1.39350142e+02
  1.39350142e+02  1.83813056e+02  5.03592857e+02  5.03592857e+02
  5.03592857e+02  1.36044291e+03  1.36044291e+03  1.36044291e+03
  1.91323433e+03  3.05832943e+03  3.05832943e+03  3.05832943e+03
  6.67989164e+03  6.67989164e+03  6.67989164e+03  8.26270727e+03
  2.46431721e+04  7.54366148e+04]
E1 = -727.561817476391  E_coul = 202.00765659290707
Extra cycle  E= -525.554160883484  delta_E= 7.96e-13  |g|= 2.59e-08  |ddm|= 4.59e-08
    CPU time for scf_cycle      1.70 sec, wall time      0.32 sec
exp = [2.61825243e+04 7.61806859e+03 3.61788457e+03 1.61264210e+03
 2.40104888e+02 5.22195036e+01 4.60217364e+00 3.98700442e-01
 1.36277931e+03 6.64997075e+02 3.02315019e+02 3.15260327e+02
 6.61637181e+01 7.78290692e+00 2.17031479e+01 7.88651006e-01
 2.95271758e+00 2.25647282e-01]
grad_E = [-1.98927929e-06  2.16686128e-05  4.28850941e-05  6.72234277e-04
  1.61591901e-04  3.22474714e-06 -1.77058306e-04 -4.74567190e-04
 -6.43463787e-07  2.73180733e-06  1.13706911e-05  9.74943098e-06
  1.84669767e-04  8.27291309e-07  1.25367320e-04  1.26178919e-03
 -4.20949714e-04 -1.72407809e-05]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5241716        1
[INPUT] 0    0    [1    /1   ]  7618.06947197        1
[INPUT] 0    0    [1    /1   ]  3617.88634415        1
[INPUT] 0    0    [1    /1   ]  1612.66916738        1
[INPUT] 0    0    [1    /1   ]  240.102538744        1
[INPUT] 0    0    [1    /1   ]  52.2204584658        1
[INPUT] 0    0    [1    /1   ]  4.60234921738        1
[INPUT] 0    0    [1    /1   ]  0.398736422834       1
[INPUT] 1    0    [1    /1   ]  1362.77938283        1
[INPUT] 1    0    [1    /1   ]  664.998015895        1
[INPUT] 1    0    [1    /1   ]  302.320184955        1
[INPUT] 1    0    [1    /1   ]  315.264880341        1
[INPUT] 1    0    [1    /1   ]  66.0700811312        1
[INPUT] 1    0    [1    /1   ]  7.78064073581        1
[INPUT] 1    0    [1    /1   ]  21.6838575894        1
[INPUT] 1    0    [1    /1   ]  0.787671531496       1
[INPUT] 1    0    [1    /1   ]  2.95442120937        1
[INPUT] 1    0    [1    /1   ]  0.225378834488       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.524171617737, 1.0]], [0, [7618.069471970828, 1.0]], [0, [3617.886344147235, 1.0]], [0, [1612.669167378953, 1.0]], [0, [240.10253874448532, 1.0]], [0, [52.22045846580306, 1.0]], [0, [4.6023492173779585, 1.0]], [0, [0.39873642283432437, 1.0]], [1, [1362.779382827651, 1.0]], [1, [664.9980158948182, 1.0]], [1, [302.3201849551934, 1.0]], [1, [315.264880340983, 1.0]], [1, [66.07008113117459, 1.0]], [1, [7.780640735809155, 1.0]], [1, [21.683857589399253, 1.0]], [1, [0.787671531496345, 1.0]], [1, [2.9544212093714672, 1.0]], [1, [0.22537883448795543, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52417162]
bas 1, expnt(s) = [7618.06947197]
bas 2, expnt(s) = [3617.88634415]
bas 3, expnt(s) = [1612.66916738]
bas 4, expnt(s) = [240.10253874]
bas 5, expnt(s) = [52.22045847]
bas 6, expnt(s) = [4.60234922]
bas 7, expnt(s) = [0.39873642]
bas 8, expnt(s) = [1362.77938283]
bas 9, expnt(s) = [664.99801589]
bas 10, expnt(s) = [302.32018496]
bas 11, expnt(s) = [315.26488034]
bas 12, expnt(s) = [66.07008113]
bas 13, expnt(s) = [7.78064074]
bas 14, expnt(s) = [21.68385759]
bas 15, expnt(s) = [0.78767153]
bas 16, expnt(s) = [2.95442121]
bas 17, expnt(s) = [0.22537883]
CPU time:       321.90
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825242e+04 5.20024325e+03 7.61806947e+03 2.06014942e+03
 3.61788634e+03 1.17857226e+03 1.61266917e+03 6.42945241e+02
 2.40102539e+02 1.54103530e+02 5.22204585e+01 4.90789807e+01
 4.60234922e+00 7.93870568e+00 3.98736423e-01 1.26773785e+00
 1.36277938e+03 2.41555169e+04 6.64998016e+02 9.85166940e+03
 3.02320185e+02 3.67763245e+03 3.15264880e+02 3.87551021e+03
 6.60700811e+01 5.49528780e+02 7.78064074e+00 3.79099835e+01
 2.16838576e+01 1.36507048e+02 7.87671531e-01 2.16479028e+00
 2.95442121e+00 1.12999080e+01 2.25378834e-01 4.53028791e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973220816709073
cond(S) = 112019.18951056604
E1 = -727.5538323675842  E_coul = 203.12822911458593
init E= -524.425603252998
    CPU time for initialize scf      0.19 sec, wall time      0.05 sec
  HOMO = -0.55947613298512  LUMO = 1.05054990943253
  mo_energy =
[-1.17869402e+02 -1.20947301e+01 -9.44651393e+00 -9.44651393e+00
 -9.44651393e+00 -1.23030316e+00 -5.59476133e-01 -5.59476133e-01
 -5.59476133e-01  1.05054991e+00  1.05054991e+00  1.05054991e+00
  7.78466702e+00  7.78466702e+00  7.78466702e+00  3.61028113e+01
  3.61028113e+01  3.61028113e+01  1.39344717e+02  1.39344717e+02
  1.39344717e+02  1.83977329e+02  5.03467622e+02  5.03467622e+02
  5.03467622e+02  1.36031848e+03  1.36031848e+03  1.36031848e+03
  1.91360813e+03  3.05827184e+03  3.05827184e+03  3.05827184e+03
  6.67997749e+03  6.67997749e+03  6.67997749e+03  8.26325918e+03
  2.46438520e+04  7.54373991e+04]
E1 = -727.3950418437997  E_coul = 201.8410594733295
cycle= 1 E= -525.55398237047  delta_E= -1.13  |g|= 0.181  |ddm|= 0.328
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460535
diis-c [-0.21209273  1.        ]
  HOMO = -0.57220295760235  LUMO = 1.043534037338
  mo_energy =
[-1.18107758e+02 -1.21821693e+01 -9.53289952e+00 -9.53289952e+00
 -9.53289952e+00 -1.25133193e+00 -5.72202958e-01 -5.72202958e-01
 -5.72202958e-01  1.04353404e+00  1.04353404e+00  1.04353404e+00
  7.73489546e+00  7.73489546e+00  7.73489546e+00  3.60067283e+01
  3.60067283e+01  3.60067283e+01  1.39185215e+02  1.39185215e+02
  1.39185215e+02  1.83790800e+02  5.03244380e+02  5.03244380e+02
  5.03244380e+02  1.36004817e+03  1.36004817e+03  1.36004817e+03
  1.91321872e+03  3.05794170e+03  3.05794170e+03  3.05794170e+03
  6.67953329e+03  6.67953329e+03  6.67953329e+03  8.26273313e+03
  2.46432328e+04  7.54366891e+04]
E1 = -727.5964622923793  E_coul = 202.0423047917914
cycle= 2 E= -525.554157500588  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.0138
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0303936
diis-c [-7.19570276e-04  3.01447757e-02  9.69855224e-01]
  HOMO = -0.569628700112966  LUMO = 1.04557723164835
  mo_energy =
[-1.18078576e+02 -1.21680158e+01 -9.51853748e+00 -9.51853748e+00
 -9.51853748e+00 -1.24787310e+00 -5.69628700e-01 -5.69628700e-01
 -5.69628700e-01  1.04557723e+00  1.04557723e+00  1.04557723e+00
  7.74292152e+00  7.74292152e+00  7.74292152e+00  3.60220842e+01
  3.60220842e+01  3.60220842e+01  1.39208553e+02  1.39208553e+02
  1.39208553e+02  1.83818859e+02  5.03273124e+02  5.03273124e+02
  5.03273124e+02  1.36007890e+03  1.36007890e+03  1.36007890e+03
  1.91325085e+03  3.05797344e+03  3.05797344e+03  3.05797344e+03
  6.67956559e+03  6.67956559e+03  6.67956559e+03  8.26276563e+03
  2.46432653e+04  7.54367215e+04]
E1 = -727.5547807148608  E_coul = 202.00061756265072
cycle= 3 E= -525.55416315221  delta_E= -5.65e-06  |g|= 0.00209  |ddm|= 0.0036
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00443159
diis-c [-8.60393668e-08 -7.43390683e-04  1.22639567e-01  8.78103824e-01]
  HOMO = -0.570140832795338  LUMO = 1.04518254762907
  mo_energy =
[-1.18082556e+02 -1.21702340e+01 -9.52079928e+00 -9.52079928e+00
 -9.52079928e+00 -1.24854742e+00 -5.70140833e-01 -5.70140833e-01
 -5.70140833e-01  1.04518255e+00  1.04518255e+00  1.04518255e+00
  7.74152429e+00  7.74152429e+00  7.74152429e+00  3.60197266e+01
  3.60197266e+01  3.60197266e+01  1.39205252e+02  1.39205252e+02
  1.39205252e+02  1.83815059e+02  5.03269202e+02  5.03269202e+02
  5.03269202e+02  1.36007473e+03  1.36007473e+03  1.36007473e+03
  1.91324647e+03  3.05796914e+03  3.05796914e+03  3.05796914e+03
  6.67956115e+03  6.67956115e+03  6.67956115e+03  8.26276112e+03
  2.46432607e+04  7.54367168e+04]
E1 = -727.5610502832549  E_coul = 202.00688697051666
cycle= 4 E= -525.554163312738  delta_E= -1.61e-07  |g|= 3.71e-05  |ddm|= 0.000585
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.66031e-05
diis-c [-3.78131274e-10 -2.64306698e-05  3.95164289e-03  4.18274143e-02
  9.54247373e-01]
  HOMO = -0.570119374018231  LUMO = 1.0451986806017
  mo_energy =
[-1.18082471e+02 -1.21701636e+01 -9.52072826e+00 -9.52072826e+00
 -9.52072826e+00 -1.24851945e+00 -5.70119374e-01 -5.70119374e-01
 -5.70119374e-01  1.04519868e+00  1.04519868e+00  1.04519868e+00
  7.74157532e+00  7.74157532e+00  7.74157532e+00  3.60197968e+01
  3.60197968e+01  3.60197968e+01  1.39205332e+02  1.39205332e+02
  1.39205332e+02  1.83815143e+02  5.03269286e+02  5.03269286e+02
  5.03269286e+02  1.36007482e+03  1.36007482e+03  1.36007482e+03
  1.91324655e+03  3.05796922e+03  3.05796922e+03  3.05796922e+03
  6.67956123e+03  6.67956123e+03  6.67956123e+03  8.26276120e+03
  2.46432608e+04  7.54367169e+04]
E1 = -727.5608732416431  E_coul = 202.00670992878548
cycle= 5 E= -525.554163312858  delta_E= -1.19e-10  |g|= 2.32e-06  |ddm|= 1.96e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5608732416431  E_coul = 202.00670992878548
  HOMO = -0.570120659103  LUMO = 1.04519771448508
  mo_energy =
[-1.18082477e+02 -1.21701681e+01 -9.52073277e+00 -9.52073277e+00
 -9.52073277e+00 -1.24852113e+00 -5.70120659e-01 -5.70120659e-01
 -5.70120659e-01  1.04519771e+00  1.04519771e+00  1.04519771e+00
  7.74157220e+00  7.74157220e+00  7.74157220e+00  3.60197923e+01
  3.60197923e+01  3.60197923e+01  1.39205327e+02  1.39205327e+02
  1.39205327e+02  1.83815137e+02  5.03269280e+02  5.03269280e+02
  5.03269280e+02  1.36007481e+03  1.36007481e+03  1.36007481e+03
  1.91324655e+03  3.05796922e+03  3.05796922e+03  3.05796922e+03
  6.67956123e+03  6.67956123e+03  6.67956123e+03  8.26276119e+03
  2.46432608e+04  7.54367169e+04]
E1 = -727.5608848206049  E_coul = 202.00672150774693
Extra cycle  E= -525.554163312858  delta_E= -4.55e-13  |g|= 5.74e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.38 sec, wall time      0.25 sec
exp = [2.61825242e+04 7.61806947e+03 3.61788634e+03 1.61266917e+03
 2.40102539e+02 5.22204585e+01 4.60234922e+00 3.98736423e-01
 1.36277938e+03 6.64998016e+02 3.02320185e+02 3.15264880e+02
 6.60700811e+01 7.78064074e+00 2.16838576e+01 7.87671531e-01
 2.95442121e+00 2.25378834e-01]
E = -525.554163312858
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5241716        1
[INPUT] 0    0    [1    /1   ]  7618.06947197        1
[INPUT] 0    0    [1    /1   ]  3617.88634415        1
[INPUT] 0    0    [1    /1   ]  1612.66916738        1
[INPUT] 0    0    [1    /1   ]  240.102538744        1
[INPUT] 0    0    [1    /1   ]  52.2204584658        1
[INPUT] 0    0    [1    /1   ]  4.60234921738        1
[INPUT] 0    0    [1    /1   ]  0.398736422834       1
[INPUT] 1    0    [1    /1   ]  1362.77938283        1
[INPUT] 1    0    [1    /1   ]  664.998015895        1
[INPUT] 1    0    [1    /1   ]  302.320184955        1
[INPUT] 1    0    [1    /1   ]  315.264880341        1
[INPUT] 1    0    [1    /1   ]  66.0700811312        1
[INPUT] 1    0    [1    /1   ]  7.78064073581        1
[INPUT] 1    0    [1    /1   ]  21.6838575894        1
[INPUT] 1    0    [1    /1   ]  0.787671531496       1
[INPUT] 1    0    [1    /1   ]  2.95442120937        1
[INPUT] 1    0    [1    /1   ]  0.225378834488       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.524171617737, 1.0]], [0, [7618.069471970828, 1.0]], [0, [3617.886344147235, 1.0]], [0, [1612.669167378953, 1.0]], [0, [240.10253874448532, 1.0]], [0, [52.22045846580306, 1.0]], [0, [4.6023492173779585, 1.0]], [0, [0.39873642283432437, 1.0]], [1, [1362.779382827651, 1.0]], [1, [664.9980158948182, 1.0]], [1, [302.3201849551934, 1.0]], [1, [315.264880340983, 1.0]], [1, [66.07008113117459, 1.0]], [1, [7.780640735809155, 1.0]], [1, [21.683857589399253, 1.0]], [1, [0.787671531496345, 1.0]], [1, [2.9544212093714672, 1.0]], [1, [0.22537883448795543, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52417162]
bas 1, expnt(s) = [7618.06947197]
bas 2, expnt(s) = [3617.88634415]
bas 3, expnt(s) = [1612.66916738]
bas 4, expnt(s) = [240.10253874]
bas 5, expnt(s) = [52.22045847]
bas 6, expnt(s) = [4.60234922]
bas 7, expnt(s) = [0.39873642]
bas 8, expnt(s) = [1362.77938283]
bas 9, expnt(s) = [664.99801589]
bas 10, expnt(s) = [302.32018496]
bas 11, expnt(s) = [315.26488034]
bas 12, expnt(s) = [66.07008113]
bas 13, expnt(s) = [7.78064074]
bas 14, expnt(s) = [21.68385759]
bas 15, expnt(s) = [0.78767153]
bas 16, expnt(s) = [2.95442121]
bas 17, expnt(s) = [0.22537883]
CPU time:       322.54
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825242e+04 5.20024325e+03 7.61806947e+03 2.06014942e+03
 3.61788634e+03 1.17857226e+03 1.61266917e+03 6.42945241e+02
 2.40102539e+02 1.54103530e+02 5.22204585e+01 4.90789807e+01
 4.60234922e+00 7.93870568e+00 3.98736423e-01 1.26773785e+00
 1.36277938e+03 2.41555169e+04 6.64998016e+02 9.85166940e+03
 3.02320185e+02 3.67763245e+03 3.15264880e+02 3.87551021e+03
 6.60700811e+01 5.49528780e+02 7.78064074e+00 3.79099835e+01
 2.16838576e+01 1.36507048e+02 7.87671531e-01 2.16479028e+00
 2.95442121e+00 1.12999080e+01 2.25378834e-01 4.53028791e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973220816709073
cond(S) = 112019.18951056604
E1 = -727.5538323675842  E_coul = 203.12822911458593
init E= -524.425603252998
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.55947613298512  LUMO = 1.05054990943253
  mo_energy =
[-1.17869402e+02 -1.20947301e+01 -9.44651393e+00 -9.44651393e+00
 -9.44651393e+00 -1.23030316e+00 -5.59476133e-01 -5.59476133e-01
 -5.59476133e-01  1.05054991e+00  1.05054991e+00  1.05054991e+00
  7.78466702e+00  7.78466702e+00  7.78466702e+00  3.61028113e+01
  3.61028113e+01  3.61028113e+01  1.39344717e+02  1.39344717e+02
  1.39344717e+02  1.83977329e+02  5.03467622e+02  5.03467622e+02
  5.03467622e+02  1.36031848e+03  1.36031848e+03  1.36031848e+03
  1.91360813e+03  3.05827184e+03  3.05827184e+03  3.05827184e+03
  6.67997749e+03  6.67997749e+03  6.67997749e+03  8.26325918e+03
  2.46438520e+04  7.54373991e+04]
E1 = -727.3950418437997  E_coul = 201.8410594733295
cycle= 1 E= -525.55398237047  delta_E= -1.13  |g|= 0.181  |ddm|= 0.328
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460535
diis-c [-0.21209273  1.        ]
  HOMO = -0.57220295760235  LUMO = 1.043534037338
  mo_energy =
[-1.18107758e+02 -1.21821693e+01 -9.53289952e+00 -9.53289952e+00
 -9.53289952e+00 -1.25133193e+00 -5.72202958e-01 -5.72202958e-01
 -5.72202958e-01  1.04353404e+00  1.04353404e+00  1.04353404e+00
  7.73489546e+00  7.73489546e+00  7.73489546e+00  3.60067283e+01
  3.60067283e+01  3.60067283e+01  1.39185215e+02  1.39185215e+02
  1.39185215e+02  1.83790800e+02  5.03244380e+02  5.03244380e+02
  5.03244380e+02  1.36004817e+03  1.36004817e+03  1.36004817e+03
  1.91321872e+03  3.05794170e+03  3.05794170e+03  3.05794170e+03
  6.67953329e+03  6.67953329e+03  6.67953329e+03  8.26273313e+03
  2.46432328e+04  7.54366891e+04]
E1 = -727.5964622923793  E_coul = 202.0423047917914
cycle= 2 E= -525.554157500588  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.0138
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0303936
diis-c [-7.19570276e-04  3.01447757e-02  9.69855224e-01]
  HOMO = -0.569628700112966  LUMO = 1.04557723164835
  mo_energy =
[-1.18078576e+02 -1.21680158e+01 -9.51853748e+00 -9.51853748e+00
 -9.51853748e+00 -1.24787310e+00 -5.69628700e-01 -5.69628700e-01
 -5.69628700e-01  1.04557723e+00  1.04557723e+00  1.04557723e+00
  7.74292152e+00  7.74292152e+00  7.74292152e+00  3.60220842e+01
  3.60220842e+01  3.60220842e+01  1.39208553e+02  1.39208553e+02
  1.39208553e+02  1.83818859e+02  5.03273124e+02  5.03273124e+02
  5.03273124e+02  1.36007890e+03  1.36007890e+03  1.36007890e+03
  1.91325085e+03  3.05797344e+03  3.05797344e+03  3.05797344e+03
  6.67956559e+03  6.67956559e+03  6.67956559e+03  8.26276563e+03
  2.46432653e+04  7.54367215e+04]
E1 = -727.5547807148608  E_coul = 202.00061756265072
cycle= 3 E= -525.55416315221  delta_E= -5.65e-06  |g|= 0.00209  |ddm|= 0.0036
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00443159
diis-c [-8.60393668e-08 -7.43390683e-04  1.22639567e-01  8.78103824e-01]
  HOMO = -0.570140832795338  LUMO = 1.04518254762907
  mo_energy =
[-1.18082556e+02 -1.21702340e+01 -9.52079928e+00 -9.52079928e+00
 -9.52079928e+00 -1.24854742e+00 -5.70140833e-01 -5.70140833e-01
 -5.70140833e-01  1.04518255e+00  1.04518255e+00  1.04518255e+00
  7.74152429e+00  7.74152429e+00  7.74152429e+00  3.60197266e+01
  3.60197266e+01  3.60197266e+01  1.39205252e+02  1.39205252e+02
  1.39205252e+02  1.83815059e+02  5.03269202e+02  5.03269202e+02
  5.03269202e+02  1.36007473e+03  1.36007473e+03  1.36007473e+03
  1.91324647e+03  3.05796914e+03  3.05796914e+03  3.05796914e+03
  6.67956115e+03  6.67956115e+03  6.67956115e+03  8.26276112e+03
  2.46432607e+04  7.54367168e+04]
E1 = -727.5610502832549  E_coul = 202.00688697051666
cycle= 4 E= -525.554163312738  delta_E= -1.61e-07  |g|= 3.71e-05  |ddm|= 0.000585
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.66031e-05
diis-c [-3.78131274e-10 -2.64306698e-05  3.95164289e-03  4.18274143e-02
  9.54247373e-01]
  HOMO = -0.570119374018231  LUMO = 1.0451986806017
  mo_energy =
[-1.18082471e+02 -1.21701636e+01 -9.52072826e+00 -9.52072826e+00
 -9.52072826e+00 -1.24851945e+00 -5.70119374e-01 -5.70119374e-01
 -5.70119374e-01  1.04519868e+00  1.04519868e+00  1.04519868e+00
  7.74157532e+00  7.74157532e+00  7.74157532e+00  3.60197968e+01
  3.60197968e+01  3.60197968e+01  1.39205332e+02  1.39205332e+02
  1.39205332e+02  1.83815143e+02  5.03269286e+02  5.03269286e+02
  5.03269286e+02  1.36007482e+03  1.36007482e+03  1.36007482e+03
  1.91324655e+03  3.05796922e+03  3.05796922e+03  3.05796922e+03
  6.67956123e+03  6.67956123e+03  6.67956123e+03  8.26276120e+03
  2.46432608e+04  7.54367169e+04]
E1 = -727.5608732416431  E_coul = 202.00670992878548
cycle= 5 E= -525.554163312858  delta_E= -1.19e-10  |g|= 2.32e-06  |ddm|= 1.96e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5608732416431  E_coul = 202.00670992878548
  HOMO = -0.570120659103  LUMO = 1.04519771448508
  mo_energy =
[-1.18082477e+02 -1.21701681e+01 -9.52073277e+00 -9.52073277e+00
 -9.52073277e+00 -1.24852113e+00 -5.70120659e-01 -5.70120659e-01
 -5.70120659e-01  1.04519771e+00  1.04519771e+00  1.04519771e+00
  7.74157220e+00  7.74157220e+00  7.74157220e+00  3.60197923e+01
  3.60197923e+01  3.60197923e+01  1.39205327e+02  1.39205327e+02
  1.39205327e+02  1.83815137e+02  5.03269280e+02  5.03269280e+02
  5.03269280e+02  1.36007481e+03  1.36007481e+03  1.36007481e+03
  1.91324655e+03  3.05796922e+03  3.05796922e+03  3.05796922e+03
  6.67956123e+03  6.67956123e+03  6.67956123e+03  8.26276119e+03
  2.46432608e+04  7.54367169e+04]
E1 = -727.5608848206049  E_coul = 202.00672150774693
Extra cycle  E= -525.554163312858  delta_E= -4.55e-13  |g|= 5.74e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.24 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 112019.18951056604
E1 = -727.5608848206049  E_coul = 202.00672150774693
init E= -525.554163312858
    CPU time for initialize scf      1.09 sec, wall time      0.20 sec
  HOMO = -0.570120439165491  LUMO = 1.04519788234124
  mo_energy =
[-1.18082476e+02 -1.21701672e+01 -9.52073190e+00 -9.52073190e+00
 -9.52073190e+00 -1.24852084e+00 -5.70120439e-01 -5.70120439e-01
 -5.70120439e-01  1.04519788e+00  1.04519788e+00  1.04519788e+00
  7.74157277e+00  7.74157277e+00  7.74157277e+00  3.60197932e+01
  3.60197932e+01  3.60197932e+01  1.39205328e+02  1.39205328e+02
  1.39205328e+02  1.83815138e+02  5.03269281e+02  5.03269281e+02
  5.03269281e+02  1.36007481e+03  1.36007481e+03  1.36007481e+03
  1.91324655e+03  3.05796922e+03  3.05796922e+03  3.05796922e+03
  6.67956123e+03  6.67956123e+03  6.67956123e+03  8.26276119e+03
  2.46432608e+04  7.54367169e+04]
E1 = -727.5608824862326  E_coul = 202.00671917337513
cycle= 1 E= -525.554163312857  delta_E= 5.68e-13  |g|= 1.24e-07  |ddm|= 2.3e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.5608824862326  E_coul = 202.00671917337513
  HOMO = -0.570120481306375  LUMO = 1.04519785006572
  mo_energy =
[-1.18082476e+02 -1.21701674e+01 -9.52073207e+00 -9.52073207e+00
 -9.52073207e+00 -1.24852089e+00 -5.70120481e-01 -5.70120481e-01
 -5.70120481e-01  1.04519785e+00  1.04519785e+00  1.04519785e+00
  7.74157266e+00  7.74157266e+00  7.74157266e+00  3.60197930e+01
  3.60197930e+01  3.60197930e+01  1.39205328e+02  1.39205328e+02
  1.39205328e+02  1.83815138e+02  5.03269281e+02  5.03269281e+02
  5.03269281e+02  1.36007481e+03  1.36007481e+03  1.36007481e+03
  1.91324655e+03  3.05796922e+03  3.05796922e+03  3.05796922e+03
  6.67956123e+03  6.67956123e+03  6.67956123e+03  8.26276119e+03
  2.46432608e+04  7.54367169e+04]
E1 = -727.5608829616097  E_coul = 202.00671964875178
Extra cycle  E= -525.554163312858  delta_E= -4.55e-13  |g|= 2.59e-08  |ddm|= 4.59e-08
    CPU time for scf_cycle      1.21 sec, wall time      0.33 sec
exp = [2.61825242e+04 7.61806947e+03 3.61788634e+03 1.61266917e+03
 2.40102539e+02 5.22204585e+01 4.60234922e+00 3.98736423e-01
 1.36277938e+03 6.64998016e+02 3.02320185e+02 3.15264880e+02
 6.60700811e+01 7.78064074e+00 2.16838576e+01 7.87671531e-01
 2.95442121e+00 2.25378834e-01]
grad_E = [-1.98927917e-06  2.16726617e-05  4.28985849e-05  6.72347168e-04
  1.55569905e-04  3.77737184e-05 -1.73112622e-05 -9.53011916e-05
 -6.41520257e-07  2.78198716e-06  1.16401605e-05  9.98184559e-06
  1.74238101e-04 -1.50870581e-04  1.62574134e-04  3.07377780e-04
  3.81698533e-05 -4.07233221e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5241427        1
[INPUT] 0    0    [1    /1   ]  7618.06979403        1
[INPUT] 0    0    [1    /1   ]  3617.88699294        1
[INPUT] 0    0    [1    /1   ]  1612.67907137        1
[INPUT] 0    0    [1    /1   ]  240.101444083        1
[INPUT] 0    0    [1    /1   ]  52.2206020831        1
[INPUT] 0    0    [1    /1   ]  4.60244803173        1
[INPUT] 0    0    [1    /1   ]  0.398757392783       1
[INPUT] 1    0    [1    /1   ]  1362.77941218        1
[INPUT] 1    0    [1    /1   ]  664.998383385        1
[INPUT] 1    0    [1    /1   ]  302.322206465        1
[INPUT] 1    0    [1    /1   ]  315.266662217        1
[INPUT] 1    0    [1    /1   ]  66.0339729136        1
[INPUT] 1    0    [1    /1   ]  7.77995780113        1
[INPUT] 1    0    [1    /1   ]  21.6721875659        1
[INPUT] 1    0    [1    /1   ]  0.787213222141       1
[INPUT] 1    0    [1    /1   ]  2.95574134287        1
[INPUT] 1    0    [1    /1   ]  0.22527202091        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.52414271012, 1.0]], [0, [7618.069794034224, 1.0]], [0, [3617.886992937461, 1.0]], [0, [1612.6790713690104, 1.0]], [0, [240.1014440828354, 1.0]], [0, [52.22060208309604, 1.0]], [0, [4.602448031732909, 1.0]], [0, [0.39875739278348155, 1.0]], [1, [1362.7794121822049, 1.0]], [1, [664.9983833853229, 1.0]], [1, [302.3222064648696, 1.0]], [1, [315.2666622174965, 1.0]], [1, [66.03397291359659, 1.0]], [1, [7.7799578011304, 1.0]], [1, [21.672187565878247, 1.0]], [1, [0.7872132221409632, 1.0]], [1, [2.9557413428738735, 1.0]], [1, [0.2252720209096534, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52414271]
bas 1, expnt(s) = [7618.06979403]
bas 2, expnt(s) = [3617.88699294]
bas 3, expnt(s) = [1612.67907137]
bas 4, expnt(s) = [240.10144408]
bas 5, expnt(s) = [52.22060208]
bas 6, expnt(s) = [4.60244803]
bas 7, expnt(s) = [0.39875739]
bas 8, expnt(s) = [1362.77941218]
bas 9, expnt(s) = [664.99838339]
bas 10, expnt(s) = [302.32220646]
bas 11, expnt(s) = [315.26666222]
bas 12, expnt(s) = [66.03397291]
bas 13, expnt(s) = [7.7799578]
bas 14, expnt(s) = [21.67218757]
bas 15, expnt(s) = [0.78721322]
bas 16, expnt(s) = [2.95574134]
bas 17, expnt(s) = [0.22527202]
CPU time:       328.49
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825241e+04 5.20024325e+03 7.61806979e+03 2.06014949e+03
 3.61788699e+03 1.17857242e+03 1.61267907e+03 6.42948203e+02
 2.40101444e+02 1.54103004e+02 5.22206021e+01 4.90790819e+01
 4.60244803e+00 7.93883351e+00 3.98757393e-01 1.26778785e+00
 1.36277941e+03 2.41555176e+04 6.64998383e+02 9.85167621e+03
 3.02322206e+02 3.67766319e+03 3.15266662e+02 3.87553759e+03
 6.60339729e+01 5.49153400e+02 7.77995780e+00 3.79058242e+01
 2.16721876e+01 1.36415221e+02 7.87213222e-01 2.16321591e+00
 2.95574134e+00 1.13062198e+01 2.25272021e-01 4.52760428e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97323332252885
cond(S) = 111959.80128687459
E1 = -727.5543472261674  E_coul = 203.12870728332618
init E= -524.425639942841
    CPU time for initialize scf      0.38 sec, wall time      0.06 sec
  HOMO = -0.559467746562199  LUMO = 1.04975994882323
  mo_energy =
[-1.17869347e+02 -1.20946967e+01 -9.44647486e+00 -9.44647486e+00
 -9.44647486e+00 -1.23029507e+00 -5.59467747e-01 -5.59467747e-01
 -5.59467747e-01  1.04975995e+00  1.04975995e+00  1.04975995e+00
  7.78463715e+00  7.78463715e+00  7.78463715e+00  3.60961782e+01
  3.60961782e+01  3.60961782e+01  1.39280001e+02  1.39280001e+02
  1.39280001e+02  1.83977613e+02  5.03330935e+02  5.03330935e+02
  5.03330935e+02  1.36016508e+03  1.36016508e+03  1.36016508e+03
  1.91361130e+03  3.05812214e+03  3.05812214e+03  3.05812214e+03
  6.67984018e+03  6.67984018e+03  6.67984018e+03  8.26327752e+03
  2.46438831e+04  7.54374351e+04]
E1 = -727.3948231390361  E_coul = 201.84083965251932
cycle= 1 E= -525.553983486517  delta_E= -1.13  |g|= 0.181  |ddm|= 0.33
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.460535
diis-c [-0.21209262  1.        ]
  HOMO = -0.572212050933857  LUMO = 1.04273962783323
  mo_energy =
[-1.18107751e+02 -1.21821945e+01 -9.53291509e+00 -9.53291509e+00
 -9.53291509e+00 -1.25135010e+00 -5.72212051e-01 -5.72212051e-01
 -5.72212051e-01  1.04273963e+00  1.04273963e+00  1.04273963e+00
  7.73482036e+00  7.73482036e+00  7.73482036e+00  3.60000642e+01
  3.60000642e+01  3.60000642e+01  1.39120479e+02  1.39120479e+02
  1.39120479e+02  1.83791028e+02  5.03107647e+02  5.03107647e+02
  5.03107647e+02  1.35989472e+03  1.35989472e+03  1.35989472e+03
  1.91322185e+03  3.05779196e+03  3.05779196e+03  3.05779196e+03
  6.67939596e+03  6.67939596e+03  6.67939596e+03  8.26275145e+03
  2.46432639e+04  7.54367251e+04]
E1 = -727.5963733767619  E_coul = 202.04221469168783
cycle= 2 E= -525.554158685074  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.0138
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.030402
diis-c [-7.19952302e-04  3.01539623e-02  9.69846038e-01]
  HOMO = -0.569634331602353  LUMO = 1.04478411971688
  mo_energy =
[-1.18078558e+02 -1.21680319e+01 -9.51854392e+00 -9.51854392e+00
 -9.51854392e+00 -1.24788679e+00 -5.69634332e-01 -5.69634332e-01
 -5.69634332e-01  1.04478412e+00  1.04478412e+00  1.04478412e+00
  7.74285450e+00  7.74285450e+00  7.74285450e+00  3.60154264e+01
  3.60154264e+01  3.60154264e+01  1.39143824e+02  1.39143824e+02
  1.39143824e+02  1.83819098e+02  5.03136402e+02  5.03136402e+02
  5.03136402e+02  1.35992546e+03  1.35992546e+03  1.35992546e+03
  1.91325400e+03  3.05782371e+03  3.05782371e+03  3.05782371e+03
  6.67942827e+03  6.67942827e+03  6.67942827e+03  8.26278396e+03
  2.46432964e+04  7.54367575e+04]
E1 = -727.5546692243627  E_coul = 202.00050488266865
cycle= 3 E= -525.554164341694  delta_E= -5.66e-06  |g|= 0.00209  |ddm|= 0.0036
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00443313
diis-c [-8.58918027e-08 -7.43344834e-04  1.22649803e-01  8.78093542e-01]
  HOMO = -0.570146767840489  LUMO = 1.04438946002874
  mo_energy =
[-1.18082540e+02 -1.21702511e+01 -9.52080673e+00 -9.52080673e+00
 -9.52080673e+00 -1.24856154e+00 -5.70146768e-01 -5.70146768e-01
 -5.70146768e-01  1.04438946e+00  1.04438946e+00  1.04438946e+00
  7.74145644e+00  7.74145644e+00  7.74145644e+00  3.60130682e+01
  3.60130682e+01  3.60130682e+01  1.39140523e+02  1.39140523e+02
  1.39140523e+02  1.83815296e+02  5.03132478e+02  5.03132478e+02
  5.03132478e+02  1.35992130e+03  1.35992130e+03  1.35992130e+03
  1.91324962e+03  3.05781941e+03  3.05781941e+03  3.05781941e+03
  6.67942383e+03  6.67942383e+03  6.67942383e+03  8.26277944e+03
  2.46432918e+04  7.54367529e+04]
E1 = -727.5609416169634  E_coul = 202.0067771146138
cycle= 4 E= -525.55416450235  delta_E= -1.61e-07  |g|= 3.71e-05  |ddm|= 0.000585
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.65676e-05
diis-c [-3.78516736e-10 -2.64167277e-05  3.95056450e-03  4.18044449e-02
  9.54271407e-01]
  HOMO = -0.570125312543581  LUMO = 1.04440558073247
  mo_energy =
[-1.18082455e+02 -1.21701808e+01 -9.52073575e+00 -9.52073575e+00
 -9.52073575e+00 -1.24853357e+00 -5.70125313e-01 -5.70125313e-01
 -5.70125313e-01  1.04440558e+00  1.04440558e+00  1.04440558e+00
  7.74150746e+00  7.74150746e+00  7.74150746e+00  3.60131383e+01
  3.60131383e+01  3.60131383e+01  1.39140603e+02  1.39140603e+02
  1.39140603e+02  1.83815380e+02  5.03132562e+02  5.03132562e+02
  5.03132562e+02  1.35992138e+03  1.35992138e+03  1.35992138e+03
  1.91324970e+03  3.05781949e+03  3.05781949e+03  3.05781949e+03
  6.67942391e+03  6.67942391e+03  6.67942391e+03  8.26277952e+03
  2.46432919e+04  7.54367530e+04]
E1 = -727.5607646656651  E_coul = 202.00660016319816
cycle= 5 E= -525.554164502467  delta_E= -1.17e-10  |g|= 2.32e-06  |ddm|= 1.96e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5607646656651  E_coul = 202.00660016319816
  HOMO = -0.570126596965366  LUMO = 1.04440461576118
  mo_energy =
[-1.18082461e+02 -1.21701853e+01 -9.52074026e+00 -9.52074026e+00
 -9.52074026e+00 -1.24853524e+00 -5.70126597e-01 -5.70126597e-01
 -5.70126597e-01  1.04440462e+00  1.04440462e+00  1.04440462e+00
  7.74150434e+00  7.74150434e+00  7.74150434e+00  3.60131338e+01
  3.60131338e+01  3.60131338e+01  1.39140597e+02  1.39140597e+02
  1.39140597e+02  1.83815374e+02  5.03132556e+02  5.03132556e+02
  5.03132556e+02  1.35992137e+03  1.35992137e+03  1.35992137e+03
  1.91324969e+03  3.05781949e+03  3.05781949e+03  3.05781949e+03
  6.67942390e+03  6.67942390e+03  6.67942390e+03  8.26277952e+03
  2.46432919e+04  7.54367530e+04]
E1 = -727.5607762415874  E_coul = 202.0066117391201
Extra cycle  E= -525.554164502467  delta_E= -3.41e-13  |g|= 5.74e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.53 sec, wall time      0.20 sec
exp = [2.61825241e+04 7.61806979e+03 3.61788699e+03 1.61267907e+03
 2.40101444e+02 5.22206021e+01 4.60244803e+00 3.98757393e-01
 1.36277941e+03 6.64998383e+02 3.02322206e+02 3.15266662e+02
 6.60339729e+01 7.77995780e+00 2.16721876e+01 7.87213222e-01
 2.95574134e+00 2.25272021e-01]
E = -525.5541645024673
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5241427        1
[INPUT] 0    0    [1    /1   ]  7618.06979403        1
[INPUT] 0    0    [1    /1   ]  3617.88699294        1
[INPUT] 0    0    [1    /1   ]  1612.67907137        1
[INPUT] 0    0    [1    /1   ]  240.101444083        1
[INPUT] 0    0    [1    /1   ]  52.2206020831        1
[INPUT] 0    0    [1    /1   ]  4.60244803173        1
[INPUT] 0    0    [1    /1   ]  0.398757392783       1
[INPUT] 1    0    [1    /1   ]  1362.77941218        1
[INPUT] 1    0    [1    /1   ]  664.998383385        1
[INPUT] 1    0    [1    /1   ]  302.322206465        1
[INPUT] 1    0    [1    /1   ]  315.266662217        1
[INPUT] 1    0    [1    /1   ]  66.0339729136        1
[INPUT] 1    0    [1    /1   ]  7.77995780113        1
[INPUT] 1    0    [1    /1   ]  21.6721875659        1
[INPUT] 1    0    [1    /1   ]  0.787213222141       1
[INPUT] 1    0    [1    /1   ]  2.95574134287        1
[INPUT] 1    0    [1    /1   ]  0.22527202091        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.52414271012, 1.0]], [0, [7618.069794034224, 1.0]], [0, [3617.886992937461, 1.0]], [0, [1612.6790713690104, 1.0]], [0, [240.1014440828354, 1.0]], [0, [52.22060208309604, 1.0]], [0, [4.602448031732909, 1.0]], [0, [0.39875739278348155, 1.0]], [1, [1362.7794121822049, 1.0]], [1, [664.9983833853229, 1.0]], [1, [302.3222064648696, 1.0]], [1, [315.2666622174965, 1.0]], [1, [66.03397291359659, 1.0]], [1, [7.7799578011304, 1.0]], [1, [21.672187565878247, 1.0]], [1, [0.7872132221409632, 1.0]], [1, [2.9557413428738735, 1.0]], [1, [0.2252720209096534, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52414271]
bas 1, expnt(s) = [7618.06979403]
bas 2, expnt(s) = [3617.88699294]
bas 3, expnt(s) = [1612.67907137]
bas 4, expnt(s) = [240.10144408]
bas 5, expnt(s) = [52.22060208]
bas 6, expnt(s) = [4.60244803]
bas 7, expnt(s) = [0.39875739]
bas 8, expnt(s) = [1362.77941218]
bas 9, expnt(s) = [664.99838339]
bas 10, expnt(s) = [302.32220646]
bas 11, expnt(s) = [315.26666222]
bas 12, expnt(s) = [66.03397291]
bas 13, expnt(s) = [7.7799578]
bas 14, expnt(s) = [21.67218757]
bas 15, expnt(s) = [0.78721322]
bas 16, expnt(s) = [2.95574134]
bas 17, expnt(s) = [0.22527202]
CPU time:       329.25
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825241e+04 5.20024325e+03 7.61806979e+03 2.06014949e+03
 3.61788699e+03 1.17857242e+03 1.61267907e+03 6.42948203e+02
 2.40101444e+02 1.54103004e+02 5.22206021e+01 4.90790819e+01
 4.60244803e+00 7.93883351e+00 3.98757393e-01 1.26778785e+00
 1.36277941e+03 2.41555176e+04 6.64998383e+02 9.85167621e+03
 3.02322206e+02 3.67766319e+03 3.15266662e+02 3.87553759e+03
 6.60339729e+01 5.49153400e+02 7.77995780e+00 3.79058242e+01
 2.16721876e+01 1.36415221e+02 7.87213222e-01 2.16321591e+00
 2.95574134e+00 1.13062198e+01 2.25272021e-01 4.52760428e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97323332252885
cond(S) = 111959.80128687459
E1 = -727.5543472261674  E_coul = 203.12870728332618
init E= -524.425639942841
    CPU time for initialize scf      0.13 sec, wall time      0.04 sec
  HOMO = -0.559467746562199  LUMO = 1.04975994882323
  mo_energy =
[-1.17869347e+02 -1.20946967e+01 -9.44647486e+00 -9.44647486e+00
 -9.44647486e+00 -1.23029507e+00 -5.59467747e-01 -5.59467747e-01
 -5.59467747e-01  1.04975995e+00  1.04975995e+00  1.04975995e+00
  7.78463715e+00  7.78463715e+00  7.78463715e+00  3.60961782e+01
  3.60961782e+01  3.60961782e+01  1.39280001e+02  1.39280001e+02
  1.39280001e+02  1.83977613e+02  5.03330935e+02  5.03330935e+02
  5.03330935e+02  1.36016508e+03  1.36016508e+03  1.36016508e+03
  1.91361130e+03  3.05812214e+03  3.05812214e+03  3.05812214e+03
  6.67984018e+03  6.67984018e+03  6.67984018e+03  8.26327752e+03
  2.46438831e+04  7.54374351e+04]
E1 = -727.3948231390361  E_coul = 201.84083965251932
cycle= 1 E= -525.553983486517  delta_E= -1.13  |g|= 0.181  |ddm|= 0.33
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.460535
diis-c [-0.21209262  1.        ]
  HOMO = -0.572212050933857  LUMO = 1.04273962783323
  mo_energy =
[-1.18107751e+02 -1.21821945e+01 -9.53291509e+00 -9.53291509e+00
 -9.53291509e+00 -1.25135010e+00 -5.72212051e-01 -5.72212051e-01
 -5.72212051e-01  1.04273963e+00  1.04273963e+00  1.04273963e+00
  7.73482036e+00  7.73482036e+00  7.73482036e+00  3.60000642e+01
  3.60000642e+01  3.60000642e+01  1.39120479e+02  1.39120479e+02
  1.39120479e+02  1.83791028e+02  5.03107647e+02  5.03107647e+02
  5.03107647e+02  1.35989472e+03  1.35989472e+03  1.35989472e+03
  1.91322185e+03  3.05779196e+03  3.05779196e+03  3.05779196e+03
  6.67939596e+03  6.67939596e+03  6.67939596e+03  8.26275145e+03
  2.46432639e+04  7.54367251e+04]
E1 = -727.5963733767619  E_coul = 202.04221469168783
cycle= 2 E= -525.554158685074  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.0138
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.030402
diis-c [-7.19952302e-04  3.01539623e-02  9.69846038e-01]
  HOMO = -0.569634331602353  LUMO = 1.04478411971688
  mo_energy =
[-1.18078558e+02 -1.21680319e+01 -9.51854392e+00 -9.51854392e+00
 -9.51854392e+00 -1.24788679e+00 -5.69634332e-01 -5.69634332e-01
 -5.69634332e-01  1.04478412e+00  1.04478412e+00  1.04478412e+00
  7.74285450e+00  7.74285450e+00  7.74285450e+00  3.60154264e+01
  3.60154264e+01  3.60154264e+01  1.39143824e+02  1.39143824e+02
  1.39143824e+02  1.83819098e+02  5.03136402e+02  5.03136402e+02
  5.03136402e+02  1.35992546e+03  1.35992546e+03  1.35992546e+03
  1.91325400e+03  3.05782371e+03  3.05782371e+03  3.05782371e+03
  6.67942827e+03  6.67942827e+03  6.67942827e+03  8.26278396e+03
  2.46432964e+04  7.54367575e+04]
E1 = -727.5546692243627  E_coul = 202.00050488266865
cycle= 3 E= -525.554164341694  delta_E= -5.66e-06  |g|= 0.00209  |ddm|= 0.0036
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00443313
diis-c [-8.58918027e-08 -7.43344834e-04  1.22649803e-01  8.78093542e-01]
  HOMO = -0.570146767840489  LUMO = 1.04438946002874
  mo_energy =
[-1.18082540e+02 -1.21702511e+01 -9.52080673e+00 -9.52080673e+00
 -9.52080673e+00 -1.24856154e+00 -5.70146768e-01 -5.70146768e-01
 -5.70146768e-01  1.04438946e+00  1.04438946e+00  1.04438946e+00
  7.74145644e+00  7.74145644e+00  7.74145644e+00  3.60130682e+01
  3.60130682e+01  3.60130682e+01  1.39140523e+02  1.39140523e+02
  1.39140523e+02  1.83815296e+02  5.03132478e+02  5.03132478e+02
  5.03132478e+02  1.35992130e+03  1.35992130e+03  1.35992130e+03
  1.91324962e+03  3.05781941e+03  3.05781941e+03  3.05781941e+03
  6.67942383e+03  6.67942383e+03  6.67942383e+03  8.26277944e+03
  2.46432918e+04  7.54367529e+04]
E1 = -727.5609416169634  E_coul = 202.0067771146138
cycle= 4 E= -525.55416450235  delta_E= -1.61e-07  |g|= 3.71e-05  |ddm|= 0.000585
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.65676e-05
diis-c [-3.78516736e-10 -2.64167277e-05  3.95056450e-03  4.18044449e-02
  9.54271407e-01]
  HOMO = -0.570125312543581  LUMO = 1.04440558073247
  mo_energy =
[-1.18082455e+02 -1.21701808e+01 -9.52073575e+00 -9.52073575e+00
 -9.52073575e+00 -1.24853357e+00 -5.70125313e-01 -5.70125313e-01
 -5.70125313e-01  1.04440558e+00  1.04440558e+00  1.04440558e+00
  7.74150746e+00  7.74150746e+00  7.74150746e+00  3.60131383e+01
  3.60131383e+01  3.60131383e+01  1.39140603e+02  1.39140603e+02
  1.39140603e+02  1.83815380e+02  5.03132562e+02  5.03132562e+02
  5.03132562e+02  1.35992138e+03  1.35992138e+03  1.35992138e+03
  1.91324970e+03  3.05781949e+03  3.05781949e+03  3.05781949e+03
  6.67942391e+03  6.67942391e+03  6.67942391e+03  8.26277952e+03
  2.46432919e+04  7.54367530e+04]
E1 = -727.5607646656651  E_coul = 202.00660016319816
cycle= 5 E= -525.554164502467  delta_E= -1.17e-10  |g|= 2.32e-06  |ddm|= 1.96e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5607646656651  E_coul = 202.00660016319816
  HOMO = -0.570126596965366  LUMO = 1.04440461576118
  mo_energy =
[-1.18082461e+02 -1.21701853e+01 -9.52074026e+00 -9.52074026e+00
 -9.52074026e+00 -1.24853524e+00 -5.70126597e-01 -5.70126597e-01
 -5.70126597e-01  1.04440462e+00  1.04440462e+00  1.04440462e+00
  7.74150434e+00  7.74150434e+00  7.74150434e+00  3.60131338e+01
  3.60131338e+01  3.60131338e+01  1.39140597e+02  1.39140597e+02
  1.39140597e+02  1.83815374e+02  5.03132556e+02  5.03132556e+02
  5.03132556e+02  1.35992137e+03  1.35992137e+03  1.35992137e+03
  1.91324969e+03  3.05781949e+03  3.05781949e+03  3.05781949e+03
  6.67942390e+03  6.67942390e+03  6.67942390e+03  8.26277952e+03
  2.46432919e+04  7.54367530e+04]
E1 = -727.5607762415874  E_coul = 202.0066117391201
Extra cycle  E= -525.554164502467  delta_E= -3.41e-13  |g|= 5.74e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.27 sec, wall time      0.18 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 111959.80128687459
E1 = -727.5607762415874  E_coul = 202.0066117391201
init E= -525.554164502467
    CPU time for initialize scf      0.97 sec, wall time      0.17 sec
  HOMO = -0.570126377033765  LUMO = 1.0444047835089
  mo_energy =
[-1.18082460e+02 -1.21701844e+01 -9.52073938e+00 -9.52073938e+00
 -9.52073938e+00 -1.24853495e+00 -5.70126377e-01 -5.70126377e-01
 -5.70126377e-01  1.04440478e+00  1.04440478e+00  1.04440478e+00
  7.74150491e+00  7.74150491e+00  7.74150491e+00  3.60131347e+01
  3.60131347e+01  3.60131347e+01  1.39140598e+02  1.39140598e+02
  1.39140598e+02  1.83815375e+02  5.03132557e+02  5.03132557e+02
  5.03132557e+02  1.35992137e+03  1.35992137e+03  1.35992137e+03
  1.91324969e+03  3.05781949e+03  3.05781949e+03  3.05781949e+03
  6.67942390e+03  6.67942390e+03  6.67942390e+03  8.26277952e+03
  2.46432919e+04  7.54367530e+04]
E1 = -727.560773907968  E_coul = 202.00660940550065
cycle= 1 E= -525.554164502467  delta_E= -1.14e-13  |g|= 1.24e-07  |ddm|= 2.3e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.560773907968  E_coul = 202.00660940550065
  HOMO = -0.570126419165638  LUMO = 1.04440475126004
  mo_energy =
[-1.18082460e+02 -1.21701846e+01 -9.52073956e+00 -9.52073956e+00
 -9.52073956e+00 -1.24853501e+00 -5.70126419e-01 -5.70126419e-01
 -5.70126419e-01  1.04440475e+00  1.04440475e+00  1.04440475e+00
  7.74150479e+00  7.74150479e+00  7.74150479e+00  3.60131345e+01
  3.60131345e+01  3.60131345e+01  1.39140598e+02  1.39140598e+02
  1.39140598e+02  1.83815375e+02  5.03132557e+02  5.03132557e+02
  5.03132557e+02  1.35992137e+03  1.35992137e+03  1.35992137e+03
  1.91324969e+03  3.05781949e+03  3.05781949e+03  3.05781949e+03
  6.67942390e+03  6.67942390e+03  6.67942390e+03  8.26277952e+03
  2.46432919e+04  7.54367530e+04]
E1 = -727.5607743831914  E_coul = 202.0066098807235
Extra cycle  E= -525.554164502468  delta_E= -5.68e-13  |g|= 2.59e-08  |ddm|= 4.59e-08
    CPU time for scf_cycle      1.07 sec, wall time      0.28 sec
exp = [2.61825241e+04 7.61806979e+03 3.61788699e+03 1.61267907e+03
 2.40101444e+02 5.22206021e+01 4.60244803e+00 3.98757393e-01
 1.36277941e+03 6.64998383e+02 3.02322206e+02 3.15266662e+02
 6.60339729e+01 7.77995780e+00 2.16721876e+01 7.87213222e-01
 2.95574134e+00 2.25272021e-01]
grad_E = [-1.98927950e-06  2.16740308e-05  4.29031715e-05  6.72383838e-04
  1.53936195e-04  4.56413593e-05  7.35478220e-05  1.64708465e-04
 -6.41049822e-07  2.79151310e-06  1.16864885e-05  1.00225923e-05
  1.76673514e-04 -1.40376202e-04  1.35334056e-04 -3.38575684e-04
  2.30846992e-04 -3.26265811e-05]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:39 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5241114        1
[INPUT] 0    0    [1    /1   ]  7618.07014389        1
[INPUT] 0    0    [1    /1   ]  3617.88769926        1
[INPUT] 0    0    [1    /1   ]  1612.68981782        1
[INPUT] 0    0    [1    /1   ]  240.099848145        1
[INPUT] 0    0    [1    /1   ]  52.2202389933        1
[INPUT] 0    0    [1    /1   ]  4.60252254319        1
[INPUT] 0    0    [1    /1   ]  0.398774218058       1
[INPUT] 1    0    [1    /1   ]  1362.77944939        1
[INPUT] 1    0    [1    /1   ]  664.998827279        1
[INPUT] 1    0    [1    /1   ]  302.324655515        1
[INPUT] 1    0    [1    /1   ]  315.268821518        1
[INPUT] 1    0    [1    /1   ]  65.9896801649        1
[INPUT] 1    0    [1    /1   ]  7.77938145018        1
[INPUT] 1    0    [1    /1   ]  21.6566983085        1
[INPUT] 1    0    [1    /1   ]  0.786794322116       1
[INPUT] 1    0    [1    /1   ]  2.95711525804        1
[INPUT] 1    0    [1    /1   ]  0.225163130045       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.524111396142, 1.0]], [0, [7618.070143891537, 1.0]], [0, [3617.887699256413, 1.0]], [0, [1612.6898178232937, 1.0]], [0, [240.0998481454533, 1.0]], [0, [52.22023899329029, 1.0]], [0, [4.602522543187579, 1.0]], [0, [0.3987742180575373, 1.0]], [1, [1362.7794493852273, 1.0]], [1, [664.9988272788156, 1.0]], [1, [302.3246555148047, 1.0]], [1, [315.2688215181548, 1.0]], [1, [65.98968016486239, 1.0]], [1, [7.779381450182839, 1.0]], [1, [21.656698308548513, 1.0]], [1, [0.7867943221162109, 1.0]], [1, [2.9571152580429434, 1.0]], [1, [0.22516313004469582, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5241114]
bas 1, expnt(s) = [7618.07014389]
bas 2, expnt(s) = [3617.88769926]
bas 3, expnt(s) = [1612.68981782]
bas 4, expnt(s) = [240.09984815]
bas 5, expnt(s) = [52.22023899]
bas 6, expnt(s) = [4.60252254]
bas 7, expnt(s) = [0.39877422]
bas 8, expnt(s) = [1362.77944939]
bas 9, expnt(s) = [664.99882728]
bas 10, expnt(s) = [302.32465551]
bas 11, expnt(s) = [315.26882152]
bas 12, expnt(s) = [65.98968016]
bas 13, expnt(s) = [7.77938145]
bas 14, expnt(s) = [21.65669831]
bas 15, expnt(s) = [0.78679432]
bas 16, expnt(s) = [2.95711526]
bas 17, expnt(s) = [0.22516313]
CPU time:       335.00
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825241e+04 5.20024324e+03 7.61807014e+03 2.06014956e+03
 3.61788770e+03 1.17857259e+03 1.61268982e+03 6.42951416e+02
 2.40099848e+02 1.54102235e+02 5.22202390e+01 4.90788260e+01
 4.60252254e+00 7.93892991e+00 3.98774218e-01 1.26782797e+00
 1.36277945e+03 2.41555184e+04 6.64998827e+02 9.85168443e+03
 3.02324656e+02 3.67770043e+03 3.15268822e+02 3.87557077e+03
 6.59896802e+01 5.48693003e+02 7.77938145e+00 3.79023141e+01
 2.16566983e+01 1.36293361e+02 7.86794322e-01 2.16177711e+00
 2.95711526e+00 1.13127895e+01 2.25163130e-01 4.52486878e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97324642906359
cond(S) = 111885.67110458473
E1 = -727.5547706893487  E_coul = 203.12906787553752
init E= -524.425702813811
    CPU time for initialize scf      0.23 sec, wall time      0.05 sec
  HOMO = -0.559461289101892  LUMO = 1.04899188138852
  mo_energy =
[-1.17869311e+02 -1.20946665e+01 -9.44644594e+00 -9.44644594e+00
 -9.44644594e+00 -1.23028877e+00 -5.59461289e-01 -5.59461289e-01
 -5.59461289e-01  1.04899188e+00  1.04899188e+00  1.04899188e+00
  7.78489133e+00  7.78489133e+00  7.78489133e+00  3.60875497e+01
  3.60875497e+01  3.60875497e+01  1.39197905e+02  1.39197905e+02
  1.39197905e+02  1.83976070e+02  5.03159755e+02  5.03159755e+02
  5.03159755e+02  1.35997349e+03  1.35997349e+03  1.35997349e+03
  1.91361149e+03  3.05793518e+03  3.05793518e+03  3.05793518e+03
  6.67966864e+03  6.67966864e+03  6.67966864e+03  8.26329412e+03
  2.46439136e+04  7.54374713e+04]
E1 = -727.3943036014861  E_coul = 201.84031841450562
cycle= 1 E= -525.55398518698  delta_E= -1.13  |g|= 0.181  |ddm|= 0.332
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460545
diis-c [-0.21210139  1.        ]
  HOMO = -0.572228351481586  LUMO = 1.04196252697454
  mo_energy =
[-1.18107785e+02 -1.21822338e+01 -9.53295299e+00 -9.53295299e+00
 -9.53295299e+00 -1.25137589e+00 -5.72228351e-01 -5.72228351e-01
 -5.72228351e-01  1.04196253e+00  1.04196253e+00  1.04196253e+00
  7.73501716e+00  7.73501716e+00  7.73501716e+00  3.59913973e+01
  3.59913973e+01  3.59913973e+01  1.39038353e+02  1.39038353e+02
  1.39038353e+02  1.83789412e+02  5.02936398e+02  5.02936398e+02
  5.02936398e+02  1.35970305e+03  1.35970305e+03  1.35970305e+03
  1.91322198e+03  3.05760493e+03  3.05760493e+03  3.05760493e+03
  6.67922434e+03  6.67922434e+03  6.67922434e+03  8.26276798e+03
  2.46432943e+04  7.54367612e+04]
E1 = -727.5960239281184  E_coul = 202.0418634323169
cycle= 2 E= -525.554160495802  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.0138
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0304143
diis-c [-7.20463511e-04  3.01701757e-02  9.69829824e-01]
  HOMO = -0.569646458547043  LUMO = 1.04400892692123
  mo_energy =
[-1.18078577e+02 -1.21680593e+01 -9.51856982e+00 -9.51856982e+00
 -9.51856982e+00 -1.24790718e+00 -5.69646459e-01 -5.69646459e-01
 -5.69646459e-01  1.04400893e+00  1.04400893e+00  1.04400893e+00
  7.74306128e+00  7.74306128e+00  7.74306128e+00  3.60067678e+01
  3.60067678e+01  3.60067678e+01  1.39061707e+02  1.39061707e+02
  1.39061707e+02  1.83817496e+02  5.02965167e+02  5.02965167e+02
  5.02965167e+02  1.35973380e+03  1.35973380e+03  1.35973380e+03
  1.91325414e+03  3.05763670e+03  3.05763670e+03  3.05763670e+03
  6.67925666e+03  6.67925666e+03  6.67925666e+03  8.26280050e+03
  2.46433269e+04  7.54367936e+04]
E1 = -727.5542884372487  E_coul = 202.0001222776539
cycle= 3 E= -525.554166159595  delta_E= -5.66e-06  |g|= 0.00209  |ddm|= 0.0036
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00443528
diis-c [-8.57746637e-08 -7.43377793e-04  1.22660509e-01  8.78082868e-01]
  HOMO = -0.570159301346698  LUMO = 1.04361419772276
  mo_energy =
[-1.18082560e+02 -1.21702799e+01 -9.52083403e+00 -9.52083403e+00
 -9.52083403e+00 -1.24858247e+00 -5.70159301e-01 -5.70159301e-01
 -5.70159301e-01  1.04361420e+00  1.04361420e+00  1.04361420e+00
  7.74166213e+00  7.74166213e+00  7.74166213e+00  3.60044086e+01
  3.60044086e+01  3.60044086e+01  1.39058405e+02  1.39058405e+02
  1.39058405e+02  1.83813692e+02  5.02961242e+02  5.02961242e+02
  5.02961242e+02  1.35972964e+03  1.35972964e+03  1.35972964e+03
  1.91324975e+03  3.05763239e+03  3.05763239e+03  3.05763239e+03
  6.67925222e+03  6.67925222e+03  6.67925222e+03  8.26279599e+03
  2.46433223e+04  7.54367890e+04]
E1 = -727.5605647855921  E_coul = 202.00639846515568
cycle= 4 E= -525.554166320436  delta_E= -1.61e-07  |g|= 3.71e-05  |ddm|= 0.000586
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.65273e-05
diis-c [-3.78752611e-10 -2.64066233e-05  3.94910502e-03  4.17761741e-02
  9.54301128e-01]
  HOMO = -0.570137849455935  LUMO = 1.04363030666825
  mo_energy =
[-1.18082476e+02 -1.21702096e+01 -9.52076308e+00 -9.52076308e+00
 -9.52076308e+00 -1.24855451e+00 -5.70137849e-01 -5.70137849e-01
 -5.70137849e-01  1.04363031e+00  1.04363031e+00  1.04363031e+00
  7.74171313e+00  7.74171313e+00  7.74171313e+00  3.60044787e+01
  3.60044787e+01  3.60044787e+01  1.39058485e+02  1.39058485e+02
  1.39058485e+02  1.83813776e+02  5.02961326e+02  5.02961326e+02
  5.02961326e+02  1.35972972e+03  1.35972972e+03  1.35972972e+03
  1.91324984e+03  3.05763247e+03  3.05763247e+03  3.05763247e+03
  6.67925231e+03  6.67925231e+03  6.67925231e+03  8.26279607e+03
  2.46433224e+04  7.54367891e+04]
E1 = -727.5603879137682  E_coul = 202.00622159321375
cycle= 5 E= -525.554166320554  delta_E= -1.18e-10  |g|= 2.32e-06  |ddm|= 1.96e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5603879137682  E_coul = 202.00622159321375
  HOMO = -0.570139133595648  LUMO = 1.04362934250398
  mo_energy =
[-1.18082482e+02 -1.21702140e+01 -9.52076758e+00 -9.52076758e+00
 -9.52076758e+00 -1.24855619e+00 -5.70139134e-01 -5.70139134e-01
 -5.70139134e-01  1.04362934e+00  1.04362934e+00  1.04362934e+00
  7.74171001e+00  7.74171001e+00  7.74171001e+00  3.60044742e+01
  3.60044742e+01  3.60044742e+01  1.39058479e+02  1.39058479e+02
  1.39058479e+02  1.83813770e+02  5.02961320e+02  5.02961320e+02
  5.02961320e+02  1.35972971e+03  1.35972971e+03  1.35972971e+03
  1.91324983e+03  3.05763247e+03  3.05763247e+03  3.05763247e+03
  6.67925230e+03  6.67925230e+03  6.67925230e+03  8.26279606e+03
  2.46433224e+04  7.54367891e+04]
E1 = -727.5603994895583  E_coul = 202.00623316900405
Extra cycle  E= -525.554166320554  delta_E= 2.27e-13  |g|= 5.74e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.42 sec, wall time      0.24 sec
exp = [2.61825241e+04 7.61807014e+03 3.61788770e+03 1.61268982e+03
 2.40099848e+02 5.22202390e+01 4.60252254e+00 3.98774218e-01
 1.36277945e+03 6.64998827e+02 3.02324656e+02 3.15268822e+02
 6.59896802e+01 7.77938145e+00 2.16566983e+01 7.86794322e-01
 2.95711526e+00 2.25163130e-01]
E = -525.5541663205543
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5241114        1
[INPUT] 0    0    [1    /1   ]  7618.07014389        1
[INPUT] 0    0    [1    /1   ]  3617.88769926        1
[INPUT] 0    0    [1    /1   ]  1612.68981782        1
[INPUT] 0    0    [1    /1   ]  240.099848145        1
[INPUT] 0    0    [1    /1   ]  52.2202389933        1
[INPUT] 0    0    [1    /1   ]  4.60252254319        1
[INPUT] 0    0    [1    /1   ]  0.398774218058       1
[INPUT] 1    0    [1    /1   ]  1362.77944939        1
[INPUT] 1    0    [1    /1   ]  664.998827279        1
[INPUT] 1    0    [1    /1   ]  302.324655515        1
[INPUT] 1    0    [1    /1   ]  315.268821518        1
[INPUT] 1    0    [1    /1   ]  65.9896801649        1
[INPUT] 1    0    [1    /1   ]  7.77938145018        1
[INPUT] 1    0    [1    /1   ]  21.6566983085        1
[INPUT] 1    0    [1    /1   ]  0.786794322116       1
[INPUT] 1    0    [1    /1   ]  2.95711525804        1
[INPUT] 1    0    [1    /1   ]  0.225163130045       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.524111396142, 1.0]], [0, [7618.070143891537, 1.0]], [0, [3617.887699256413, 1.0]], [0, [1612.6898178232937, 1.0]], [0, [240.0998481454533, 1.0]], [0, [52.22023899329029, 1.0]], [0, [4.602522543187579, 1.0]], [0, [0.3987742180575373, 1.0]], [1, [1362.7794493852273, 1.0]], [1, [664.9988272788156, 1.0]], [1, [302.3246555148047, 1.0]], [1, [315.2688215181548, 1.0]], [1, [65.98968016486239, 1.0]], [1, [7.779381450182839, 1.0]], [1, [21.656698308548513, 1.0]], [1, [0.7867943221162109, 1.0]], [1, [2.9571152580429434, 1.0]], [1, [0.22516313004469582, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5241114]
bas 1, expnt(s) = [7618.07014389]
bas 2, expnt(s) = [3617.88769926]
bas 3, expnt(s) = [1612.68981782]
bas 4, expnt(s) = [240.09984815]
bas 5, expnt(s) = [52.22023899]
bas 6, expnt(s) = [4.60252254]
bas 7, expnt(s) = [0.39877422]
bas 8, expnt(s) = [1362.77944939]
bas 9, expnt(s) = [664.99882728]
bas 10, expnt(s) = [302.32465551]
bas 11, expnt(s) = [315.26882152]
bas 12, expnt(s) = [65.98968016]
bas 13, expnt(s) = [7.77938145]
bas 14, expnt(s) = [21.65669831]
bas 15, expnt(s) = [0.78679432]
bas 16, expnt(s) = [2.95711526]
bas 17, expnt(s) = [0.22516313]
CPU time:       335.63
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825241e+04 5.20024324e+03 7.61807014e+03 2.06014956e+03
 3.61788770e+03 1.17857259e+03 1.61268982e+03 6.42951416e+02
 2.40099848e+02 1.54102235e+02 5.22202390e+01 4.90788260e+01
 4.60252254e+00 7.93892991e+00 3.98774218e-01 1.26782797e+00
 1.36277945e+03 2.41555184e+04 6.64998827e+02 9.85168443e+03
 3.02324656e+02 3.67770043e+03 3.15268822e+02 3.87557077e+03
 6.59896802e+01 5.48693003e+02 7.77938145e+00 3.79023141e+01
 2.16566983e+01 1.36293361e+02 7.86794322e-01 2.16177711e+00
 2.95711526e+00 1.13127895e+01 2.25163130e-01 4.52486878e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97324642906359
cond(S) = 111885.67110458473
E1 = -727.5547706893487  E_coul = 203.12906787553752
init E= -524.425702813811
    CPU time for initialize scf      0.19 sec, wall time      0.05 sec
  HOMO = -0.559461289101892  LUMO = 1.04899188138852
  mo_energy =
[-1.17869311e+02 -1.20946665e+01 -9.44644594e+00 -9.44644594e+00
 -9.44644594e+00 -1.23028877e+00 -5.59461289e-01 -5.59461289e-01
 -5.59461289e-01  1.04899188e+00  1.04899188e+00  1.04899188e+00
  7.78489133e+00  7.78489133e+00  7.78489133e+00  3.60875497e+01
  3.60875497e+01  3.60875497e+01  1.39197905e+02  1.39197905e+02
  1.39197905e+02  1.83976070e+02  5.03159755e+02  5.03159755e+02
  5.03159755e+02  1.35997349e+03  1.35997349e+03  1.35997349e+03
  1.91361149e+03  3.05793518e+03  3.05793518e+03  3.05793518e+03
  6.67966864e+03  6.67966864e+03  6.67966864e+03  8.26329412e+03
  2.46439136e+04  7.54374713e+04]
E1 = -727.3943036014861  E_coul = 201.84031841450562
cycle= 1 E= -525.55398518698  delta_E= -1.13  |g|= 0.181  |ddm|= 0.332
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460545
diis-c [-0.21210139  1.        ]
  HOMO = -0.572228351481586  LUMO = 1.04196252697454
  mo_energy =
[-1.18107785e+02 -1.21822338e+01 -9.53295299e+00 -9.53295299e+00
 -9.53295299e+00 -1.25137589e+00 -5.72228351e-01 -5.72228351e-01
 -5.72228351e-01  1.04196253e+00  1.04196253e+00  1.04196253e+00
  7.73501716e+00  7.73501716e+00  7.73501716e+00  3.59913973e+01
  3.59913973e+01  3.59913973e+01  1.39038353e+02  1.39038353e+02
  1.39038353e+02  1.83789412e+02  5.02936398e+02  5.02936398e+02
  5.02936398e+02  1.35970305e+03  1.35970305e+03  1.35970305e+03
  1.91322198e+03  3.05760493e+03  3.05760493e+03  3.05760493e+03
  6.67922434e+03  6.67922434e+03  6.67922434e+03  8.26276798e+03
  2.46432943e+04  7.54367612e+04]
E1 = -727.5960239281184  E_coul = 202.0418634323169
cycle= 2 E= -525.554160495802  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.0138
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0304143
diis-c [-7.20463511e-04  3.01701757e-02  9.69829824e-01]
  HOMO = -0.569646458547043  LUMO = 1.04400892692123
  mo_energy =
[-1.18078577e+02 -1.21680593e+01 -9.51856982e+00 -9.51856982e+00
 -9.51856982e+00 -1.24790718e+00 -5.69646459e-01 -5.69646459e-01
 -5.69646459e-01  1.04400893e+00  1.04400893e+00  1.04400893e+00
  7.74306128e+00  7.74306128e+00  7.74306128e+00  3.60067678e+01
  3.60067678e+01  3.60067678e+01  1.39061707e+02  1.39061707e+02
  1.39061707e+02  1.83817496e+02  5.02965167e+02  5.02965167e+02
  5.02965167e+02  1.35973380e+03  1.35973380e+03  1.35973380e+03
  1.91325414e+03  3.05763670e+03  3.05763670e+03  3.05763670e+03
  6.67925666e+03  6.67925666e+03  6.67925666e+03  8.26280050e+03
  2.46433269e+04  7.54367936e+04]
E1 = -727.5542884372487  E_coul = 202.0001222776539
cycle= 3 E= -525.554166159595  delta_E= -5.66e-06  |g|= 0.00209  |ddm|= 0.0036
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00443528
diis-c [-8.57746637e-08 -7.43377793e-04  1.22660509e-01  8.78082868e-01]
  HOMO = -0.570159301346698  LUMO = 1.04361419772276
  mo_energy =
[-1.18082560e+02 -1.21702799e+01 -9.52083403e+00 -9.52083403e+00
 -9.52083403e+00 -1.24858247e+00 -5.70159301e-01 -5.70159301e-01
 -5.70159301e-01  1.04361420e+00  1.04361420e+00  1.04361420e+00
  7.74166213e+00  7.74166213e+00  7.74166213e+00  3.60044086e+01
  3.60044086e+01  3.60044086e+01  1.39058405e+02  1.39058405e+02
  1.39058405e+02  1.83813692e+02  5.02961242e+02  5.02961242e+02
  5.02961242e+02  1.35972964e+03  1.35972964e+03  1.35972964e+03
  1.91324975e+03  3.05763239e+03  3.05763239e+03  3.05763239e+03
  6.67925222e+03  6.67925222e+03  6.67925222e+03  8.26279599e+03
  2.46433223e+04  7.54367890e+04]
E1 = -727.5605647855921  E_coul = 202.00639846515568
cycle= 4 E= -525.554166320436  delta_E= -1.61e-07  |g|= 3.71e-05  |ddm|= 0.000586
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.65273e-05
diis-c [-3.78752611e-10 -2.64066233e-05  3.94910502e-03  4.17761741e-02
  9.54301128e-01]
  HOMO = -0.570137849455935  LUMO = 1.04363030666825
  mo_energy =
[-1.18082476e+02 -1.21702096e+01 -9.52076308e+00 -9.52076308e+00
 -9.52076308e+00 -1.24855451e+00 -5.70137849e-01 -5.70137849e-01
 -5.70137849e-01  1.04363031e+00  1.04363031e+00  1.04363031e+00
  7.74171313e+00  7.74171313e+00  7.74171313e+00  3.60044787e+01
  3.60044787e+01  3.60044787e+01  1.39058485e+02  1.39058485e+02
  1.39058485e+02  1.83813776e+02  5.02961326e+02  5.02961326e+02
  5.02961326e+02  1.35972972e+03  1.35972972e+03  1.35972972e+03
  1.91324984e+03  3.05763247e+03  3.05763247e+03  3.05763247e+03
  6.67925231e+03  6.67925231e+03  6.67925231e+03  8.26279607e+03
  2.46433224e+04  7.54367891e+04]
E1 = -727.5603879137682  E_coul = 202.00622159321375
cycle= 5 E= -525.554166320554  delta_E= -1.18e-10  |g|= 2.32e-06  |ddm|= 1.96e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5603879137682  E_coul = 202.00622159321375
  HOMO = -0.570139133595648  LUMO = 1.04362934250398
  mo_energy =
[-1.18082482e+02 -1.21702140e+01 -9.52076758e+00 -9.52076758e+00
 -9.52076758e+00 -1.24855619e+00 -5.70139134e-01 -5.70139134e-01
 -5.70139134e-01  1.04362934e+00  1.04362934e+00  1.04362934e+00
  7.74171001e+00  7.74171001e+00  7.74171001e+00  3.60044742e+01
  3.60044742e+01  3.60044742e+01  1.39058479e+02  1.39058479e+02
  1.39058479e+02  1.83813770e+02  5.02961320e+02  5.02961320e+02
  5.02961320e+02  1.35972971e+03  1.35972971e+03  1.35972971e+03
  1.91324983e+03  3.05763247e+03  3.05763247e+03  3.05763247e+03
  6.67925230e+03  6.67925230e+03  6.67925230e+03  8.26279606e+03
  2.46433224e+04  7.54367891e+04]
E1 = -727.5603994895583  E_coul = 202.00623316900405
Extra cycle  E= -525.554166320554  delta_E= 2.27e-13  |g|= 5.74e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.38 sec, wall time      0.25 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 111885.67110458473
E1 = -727.5603994895583  E_coul = 202.00623316900405
init E= -525.554166320554
    CPU time for initialize scf      1.04 sec, wall time      0.20 sec
  HOMO = -0.570138913620878  LUMO = 1.04362951018631
  mo_energy =
[-1.18082481e+02 -1.21702132e+01 -9.52076671e+00 -9.52076671e+00
 -9.52076671e+00 -1.24855590e+00 -5.70138914e-01 -5.70138914e-01
 -5.70138914e-01  1.04362951e+00  1.04362951e+00  1.04362951e+00
  7.74171058e+00  7.74171058e+00  7.74171058e+00  3.60044751e+01
  3.60044751e+01  3.60044751e+01  1.39058480e+02  1.39058480e+02
  1.39058480e+02  1.83813772e+02  5.02961321e+02  5.02961321e+02
  5.02961321e+02  1.35972972e+03  1.35972972e+03  1.35972972e+03
  1.91324983e+03  3.05763247e+03  3.05763247e+03  3.05763247e+03
  6.67925230e+03  6.67925230e+03  6.67925230e+03  8.26279606e+03
  2.46433224e+04  7.54367891e+04]
E1 = -727.5603971559794  E_coul = 202.00623083542493
cycle= 1 E= -525.554166320554  delta_E= -2.27e-13  |g|= 1.24e-07  |ddm|= 2.3e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.5603971559794  E_coul = 202.00623083542493
  HOMO = -0.570138955756875  LUMO = 1.04362947795377
  mo_energy =
[-1.18082481e+02 -1.21702133e+01 -9.52076688e+00 -9.52076688e+00
 -9.52076688e+00 -1.24855595e+00 -5.70138956e-01 -5.70138956e-01
 -5.70138956e-01  1.04362948e+00  1.04362948e+00  1.04362948e+00
  7.74171047e+00  7.74171047e+00  7.74171047e+00  3.60044749e+01
  3.60044749e+01  3.60044749e+01  1.39058480e+02  1.39058480e+02
  1.39058480e+02  1.83813771e+02  5.02961321e+02  5.02961321e+02
  5.02961321e+02  1.35972972e+03  1.35972972e+03  1.35972972e+03
  1.91324983e+03  3.05763247e+03  3.05763247e+03  3.05763247e+03
  6.67925230e+03  6.67925230e+03  6.67925230e+03  8.26279606e+03
  2.46433224e+04  7.54367891e+04]
E1 = -727.560397631211  E_coul = 202.00623131065706
Extra cycle  E= -525.554166320554  delta_E= 5.68e-13  |g|= 2.59e-08  |ddm|= 4.59e-08
    CPU time for scf_cycle      1.17 sec, wall time      0.33 sec
exp = [2.61825241e+04 7.61807014e+03 3.61788770e+03 1.61268982e+03
 2.40099848e+02 5.22202390e+01 4.60252254e+00 3.98774218e-01
 1.36277945e+03 6.64998827e+02 3.02324656e+02 3.15268822e+02
 6.59896802e+01 7.77938145e+00 2.16566983e+01 7.86794322e-01
 2.95711526e+00 2.25163130e-01]
grad_E = [-1.98927665e-06  2.16750947e-05  4.29068931e-05  6.72407198e-04
  1.53708078e-04  4.20015807e-05  1.41586719e-04  3.60271545e-04
 -6.40623271e-07  2.79847871e-06  1.17153615e-05  1.00488447e-05
  1.83083745e-04 -3.08460614e-05  7.21740670e-05 -8.85691879e-04
  3.30505234e-04  6.10348973e-05]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5240765        1
[INPUT] 0    0    [1    /1   ]  7618.07053609        1
[INPUT] 0    0    [1    /1   ]  3617.888495          1
[INPUT] 0    0    [1    /1   ]  1612.70183399        1
[INPUT] 0    0    [1    /1   ]  240.096939233        1
[INPUT] 0    0    [1    /1   ]  52.2191394955        1
[INPUT] 0    0    [1    /1   ]  4.60258930255        1
[INPUT] 0    0    [1    /1   ]  0.398790422766       1
[INPUT] 1    0    [1    /1   ]  1362.77950483        1
[INPUT] 1    0    [1    /1   ]  664.999440178        1
[INPUT] 1    0    [1    /1   ]  302.328054601        1
[INPUT] 1    0    [1    /1   ]  315.271819728        1
[INPUT] 1    0    [1    /1   ]  65.9259788077        1
[INPUT] 1    0    [1    /1   ]  7.7795008957         1
[INPUT] 1    0    [1    /1   ]  21.635667126         1
[INPUT] 1    0    [1    /1   ]  0.786433431813       1
[INPUT] 1    0    [1    /1   ]  2.9589589091         1
[INPUT] 1    0    [1    /1   ]  0.225080567869       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.524076519527, 1.0]], [0, [7618.070536090377, 1.0]], [0, [3617.8884949978724, 1.0]], [0, [1612.7018339878707, 1.0]], [0, [240.09693923277774, 1.0]], [0, [52.21913949553256, 1.0]], [0, [4.602589302547013, 1.0]], [0, [0.3987904227660478, 1.0]], [1, [1362.7795048292498, 1.0]], [1, [664.999440178495, 1.0]], [1, [302.3280546006478, 1.0]], [1, [315.2718197275438, 1.0]], [1, [65.92597880774952, 1.0]], [1, [7.779500895696024, 1.0]], [1, [21.63566712604078, 1.0]], [1, [0.7864334318133447, 1.0]], [1, [2.958958909101123, 1.0]], [1, [0.22508056786949374, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52407652]
bas 1, expnt(s) = [7618.07053609]
bas 2, expnt(s) = [3617.888495]
bas 3, expnt(s) = [1612.70183399]
bas 4, expnt(s) = [240.09693923]
bas 5, expnt(s) = [52.2191395]
bas 6, expnt(s) = [4.6025893]
bas 7, expnt(s) = [0.39879042]
bas 8, expnt(s) = [1362.77950483]
bas 9, expnt(s) = [664.99944018]
bas 10, expnt(s) = [302.3280546]
bas 11, expnt(s) = [315.27181973]
bas 12, expnt(s) = [65.92597881]
bas 13, expnt(s) = [7.7795009]
bas 14, expnt(s) = [21.63566713]
bas 15, expnt(s) = [0.78643343]
bas 16, expnt(s) = [2.95895891]
bas 17, expnt(s) = [0.22508057]
CPU time:       341.68
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825241e+04 5.20024324e+03 7.61807054e+03 2.06014964e+03
 3.61788849e+03 1.17857278e+03 1.61270183e+03 6.42955009e+02
 2.40096939e+02 1.54100835e+02 5.22191395e+01 4.90780510e+01
 4.60258930e+00 7.93901627e+00 3.98790423e-01 1.26786661e+00
 1.36277950e+03 2.41555196e+04 6.64999440e+02 9.85169578e+03
 3.02328055e+02 3.67775212e+03 3.15271820e+02 3.87561684e+03
 6.59259788e+01 5.48031000e+02 7.77950090e+00 3.79030415e+01
 2.16356671e+01 1.36127935e+02 7.86433432e-01 2.16053771e+00
 2.95895891e+00 1.13216066e+01 2.25080568e-01 4.52279492e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973256428827344
cond(S) = 111781.48321166246
E1 = -727.5552083956077  E_coul = 203.1293948633994
init E= -524.425813532208
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.559453392528737  LUMO = 1.04837782210573
  mo_energy =
[-1.17869287e+02 -1.20946325e+01 -9.44642172e+00 -9.44642172e+00
 -9.44642172e+00 -1.23028172e+00 -5.59453393e-01 -5.59453393e-01
 -5.59453393e-01  1.04837782e+00  1.04837782e+00  1.04837782e+00
  7.78650763e+00  7.78650763e+00  7.78650763e+00  3.60788094e+01
  3.60788094e+01  3.60788094e+01  1.39086856e+02  1.39086856e+02
  1.39086856e+02  1.83971675e+02  5.02920740e+02  5.02920740e+02
  5.02920740e+02  1.35970439e+03  1.35970439e+03  1.35970439e+03
  1.91360572e+03  3.05767204e+03  3.05767204e+03  3.05767204e+03
  6.67942693e+03  6.67942693e+03  6.67942693e+03  8.26330632e+03
  2.46439415e+04  7.54375058e+04]
E1 = -727.3939934208845  E_coul = 201.84000470119392
cycle= 1 E= -525.553988719691  delta_E= -1.13  |g|= 0.181  |ddm|= 0.333
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460558
diis-c [-0.21211386  1.        ]
  HOMO = -0.572233155764849  LUMO = 1.041345403263
  mo_energy =
[-1.18107822e+02 -1.21822513e+01 -9.53297858e+00 -9.53297858e+00
 -9.53297858e+00 -1.25138878e+00 -5.72233156e-01 -5.72233156e-01
 -5.72233156e-01  1.04134540e+00  1.04134540e+00  1.04134540e+00
  7.73658621e+00  7.73658621e+00  7.73658621e+00  3.59826422e+01
  3.59826422e+01  3.59826422e+01  1.38927303e+02  1.38927303e+02
  1.38927303e+02  1.83784957e+02  5.02697323e+02  5.02697323e+02
  5.02697323e+02  1.35943387e+03  1.35943387e+03  1.35943387e+03
  1.91321612e+03  3.05734171e+03  3.05734171e+03  3.05734171e+03
  6.67898255e+03  6.67898255e+03  6.67898255e+03  8.26278008e+03
  2.46433222e+04  7.54367956e+04]
E1 = -727.5958366343988  E_coul = 202.04167253495467
cycle= 2 E= -525.554164099444  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.0139
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0304234
diis-c [-7.20807034e-04  3.01845115e-02  9.69815488e-01]
  HOMO = -0.569647964394855  LUMO = 1.0433933016464
  mo_energy =
[-1.18078604e+02 -1.21680685e+01 -9.51858700e+00 -9.51858700e+00
 -9.51858700e+00 -1.24791584e+00 -5.69647964e-01 -5.69647964e-01
 -5.69647964e-01  1.04339330e+00  1.04339330e+00  1.04339330e+00
  7.74463862e+00  7.74463862e+00  7.74463862e+00  3.59980163e+01
  3.59980163e+01  3.59980163e+01  1.38950661e+02  1.38950661e+02
  1.38950661e+02  1.83813051e+02  5.02726102e+02  5.02726102e+02
  5.02726102e+02  1.35946464e+03  1.35946464e+03  1.35946464e+03
  1.91324829e+03  3.05737349e+03  3.05737349e+03  3.05737349e+03
  6.67901488e+03  6.67901488e+03  6.67901488e+03  8.26281262e+03
  2.46433547e+04  7.54368281e+04]
E1 = -727.5540812793935  E_coul = 201.99991151140398
cycle= 3 E= -525.554169767989  delta_E= -5.67e-06  |g|= 0.00209  |ddm|= 0.00361
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00443672
diis-c [-8.56272516e-08 -7.43427576e-04  1.22663858e-01  8.78079570e-01]
  HOMO = -0.570161033521576  LUMO = 1.04299859265984
  mo_energy =
[-1.18082588e+02 -1.21702899e+01 -9.52085200e+00 -9.52085200e+00
 -9.52085200e+00 -1.24859146e+00 -5.70161034e-01 -5.70161034e-01
 -5.70161034e-01  1.04299859e+00  1.04299859e+00  1.04299859e+00
  7.74323868e+00  7.74323868e+00  7.74323868e+00  3.59956569e+01
  3.59956569e+01  3.59956569e+01  1.38947358e+02  1.38947358e+02
  1.38947358e+02  1.83809246e+02  5.02722175e+02  5.02722175e+02
  5.02722175e+02  1.35946047e+03  1.35946047e+03  1.35946047e+03
  1.91324390e+03  3.05736918e+03  3.05736918e+03  3.05736918e+03
  6.67901043e+03  6.67901043e+03  6.67901043e+03  8.26280810e+03
  2.46433501e+04  7.54368234e+04]
E1 = -727.5603595982994  E_coul = 202.00618966937412
cycle= 4 E= -525.554169928925  delta_E= -1.61e-07  |g|= 3.7e-05  |ddm|= 0.000586
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.64662e-05
diis-c [-3.78991236e-10 -2.63997318e-05  3.94714582e-03  4.17441219e-02
  9.54335132e-01]
  HOMO = -0.57013958865194  LUMO = 1.04301468891311
  mo_energy =
[-1.18082504e+02 -1.21702197e+01 -9.52078110e+00 -9.52078110e+00
 -9.52078110e+00 -1.24856351e+00 -5.70139589e-01 -5.70139589e-01
 -5.70139589e-01  1.04301469e+00  1.04301469e+00  1.04301469e+00
  7.74328966e+00  7.74328966e+00  7.74328966e+00  3.59957269e+01
  3.59957269e+01  3.59957269e+01  1.38947438e+02  1.38947438e+02
  1.38947438e+02  1.83809330e+02  5.02722259e+02  5.02722259e+02
  5.02722259e+02  1.35946055e+03  1.35946055e+03  1.35946055e+03
  1.91324399e+03  3.05736926e+03  3.05736926e+03  3.05736926e+03
  6.67901052e+03  6.67901052e+03  6.67901052e+03  8.26280818e+03
  2.46433502e+04  7.54368235e+04]
E1 = -727.5601828629678  E_coul = 202.00601293392523
cycle= 5 E= -525.554169929043  delta_E= -1.17e-10  |g|= 2.32e-06  |ddm|= 1.96e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5601828629678  E_coul = 202.00601293392523
  HOMO = -0.570140872229376  LUMO = 1.04301372565524
  mo_energy =
[-1.18082510e+02 -1.21702241e+01 -9.52078561e+00 -9.52078561e+00
 -9.52078561e+00 -1.24856518e+00 -5.70140872e-01 -5.70140872e-01
 -5.70140872e-01  1.04301373e+00  1.04301373e+00  1.04301373e+00
  7.74328654e+00  7.74328654e+00  7.74328654e+00  3.59957224e+01
  3.59957224e+01  3.59957224e+01  1.38947433e+02  1.38947433e+02
  1.38947433e+02  1.83809324e+02  5.02722253e+02  5.02722253e+02
  5.02722253e+02  1.35946055e+03  1.35946055e+03  1.35946055e+03
  1.91324398e+03  3.05736926e+03  3.05736926e+03  3.05736926e+03
  6.67901051e+03  6.67901051e+03  6.67901051e+03  8.26280817e+03
  2.46433502e+04  7.54368235e+04]
E1 = -727.5601944367469  E_coul = 202.00602450770415
Extra cycle  E= -525.554169929043  delta_E= -1.14e-13  |g|= 5.74e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
exp = [2.61825241e+04 7.61807054e+03 3.61788849e+03 1.61270183e+03
 2.40096939e+02 5.22191395e+01 4.60258930e+00 3.98790423e-01
 1.36277950e+03 6.64999440e+02 3.02328055e+02 3.15271820e+02
 6.59259788e+01 7.77950090e+00 2.16356671e+01 7.86433432e-01
 2.95895891e+00 2.25080568e-01]
E = -525.5541699290427
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5240765        1
[INPUT] 0    0    [1    /1   ]  7618.07053609        1
[INPUT] 0    0    [1    /1   ]  3617.888495          1
[INPUT] 0    0    [1    /1   ]  1612.70183399        1
[INPUT] 0    0    [1    /1   ]  240.096939233        1
[INPUT] 0    0    [1    /1   ]  52.2191394955        1
[INPUT] 0    0    [1    /1   ]  4.60258930255        1
[INPUT] 0    0    [1    /1   ]  0.398790422766       1
[INPUT] 1    0    [1    /1   ]  1362.77950483        1
[INPUT] 1    0    [1    /1   ]  664.999440178        1
[INPUT] 1    0    [1    /1   ]  302.328054601        1
[INPUT] 1    0    [1    /1   ]  315.271819728        1
[INPUT] 1    0    [1    /1   ]  65.9259788077        1
[INPUT] 1    0    [1    /1   ]  7.7795008957         1
[INPUT] 1    0    [1    /1   ]  21.635667126         1
[INPUT] 1    0    [1    /1   ]  0.786433431813       1
[INPUT] 1    0    [1    /1   ]  2.9589589091         1
[INPUT] 1    0    [1    /1   ]  0.225080567869       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.524076519527, 1.0]], [0, [7618.070536090377, 1.0]], [0, [3617.8884949978724, 1.0]], [0, [1612.7018339878707, 1.0]], [0, [240.09693923277774, 1.0]], [0, [52.21913949553256, 1.0]], [0, [4.602589302547013, 1.0]], [0, [0.3987904227660478, 1.0]], [1, [1362.7795048292498, 1.0]], [1, [664.999440178495, 1.0]], [1, [302.3280546006478, 1.0]], [1, [315.2718197275438, 1.0]], [1, [65.92597880774952, 1.0]], [1, [7.779500895696024, 1.0]], [1, [21.63566712604078, 1.0]], [1, [0.7864334318133447, 1.0]], [1, [2.958958909101123, 1.0]], [1, [0.22508056786949374, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52407652]
bas 1, expnt(s) = [7618.07053609]
bas 2, expnt(s) = [3617.888495]
bas 3, expnt(s) = [1612.70183399]
bas 4, expnt(s) = [240.09693923]
bas 5, expnt(s) = [52.2191395]
bas 6, expnt(s) = [4.6025893]
bas 7, expnt(s) = [0.39879042]
bas 8, expnt(s) = [1362.77950483]
bas 9, expnt(s) = [664.99944018]
bas 10, expnt(s) = [302.3280546]
bas 11, expnt(s) = [315.27181973]
bas 12, expnt(s) = [65.92597881]
bas 13, expnt(s) = [7.7795009]
bas 14, expnt(s) = [21.63566713]
bas 15, expnt(s) = [0.78643343]
bas 16, expnt(s) = [2.95895891]
bas 17, expnt(s) = [0.22508057]
CPU time:       342.21
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825241e+04 5.20024324e+03 7.61807054e+03 2.06014964e+03
 3.61788849e+03 1.17857278e+03 1.61270183e+03 6.42955009e+02
 2.40096939e+02 1.54100835e+02 5.22191395e+01 4.90780510e+01
 4.60258930e+00 7.93901627e+00 3.98790423e-01 1.26786661e+00
 1.36277950e+03 2.41555196e+04 6.64999440e+02 9.85169578e+03
 3.02328055e+02 3.67775212e+03 3.15271820e+02 3.87561684e+03
 6.59259788e+01 5.48031000e+02 7.77950090e+00 3.79030415e+01
 2.16356671e+01 1.36127935e+02 7.86433432e-01 2.16053771e+00
 2.95895891e+00 1.13216066e+01 2.25080568e-01 4.52279492e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973256428827344
cond(S) = 111781.48321166246
E1 = -727.5552083956077  E_coul = 203.1293948633994
init E= -524.425813532208
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.559453392528737  LUMO = 1.04837782210573
  mo_energy =
[-1.17869287e+02 -1.20946325e+01 -9.44642172e+00 -9.44642172e+00
 -9.44642172e+00 -1.23028172e+00 -5.59453393e-01 -5.59453393e-01
 -5.59453393e-01  1.04837782e+00  1.04837782e+00  1.04837782e+00
  7.78650763e+00  7.78650763e+00  7.78650763e+00  3.60788094e+01
  3.60788094e+01  3.60788094e+01  1.39086856e+02  1.39086856e+02
  1.39086856e+02  1.83971675e+02  5.02920740e+02  5.02920740e+02
  5.02920740e+02  1.35970439e+03  1.35970439e+03  1.35970439e+03
  1.91360572e+03  3.05767204e+03  3.05767204e+03  3.05767204e+03
  6.67942693e+03  6.67942693e+03  6.67942693e+03  8.26330632e+03
  2.46439415e+04  7.54375058e+04]
E1 = -727.3939934208845  E_coul = 201.84000470119392
cycle= 1 E= -525.553988719691  delta_E= -1.13  |g|= 0.181  |ddm|= 0.333
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460558
diis-c [-0.21211386  1.        ]
  HOMO = -0.572233155764849  LUMO = 1.041345403263
  mo_energy =
[-1.18107822e+02 -1.21822513e+01 -9.53297858e+00 -9.53297858e+00
 -9.53297858e+00 -1.25138878e+00 -5.72233156e-01 -5.72233156e-01
 -5.72233156e-01  1.04134540e+00  1.04134540e+00  1.04134540e+00
  7.73658621e+00  7.73658621e+00  7.73658621e+00  3.59826422e+01
  3.59826422e+01  3.59826422e+01  1.38927303e+02  1.38927303e+02
  1.38927303e+02  1.83784957e+02  5.02697323e+02  5.02697323e+02
  5.02697323e+02  1.35943387e+03  1.35943387e+03  1.35943387e+03
  1.91321612e+03  3.05734171e+03  3.05734171e+03  3.05734171e+03
  6.67898255e+03  6.67898255e+03  6.67898255e+03  8.26278008e+03
  2.46433222e+04  7.54367956e+04]
E1 = -727.5958366343988  E_coul = 202.04167253495467
cycle= 2 E= -525.554164099444  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.0139
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0304234
diis-c [-7.20807034e-04  3.01845115e-02  9.69815488e-01]
  HOMO = -0.569647964394855  LUMO = 1.0433933016464
  mo_energy =
[-1.18078604e+02 -1.21680685e+01 -9.51858700e+00 -9.51858700e+00
 -9.51858700e+00 -1.24791584e+00 -5.69647964e-01 -5.69647964e-01
 -5.69647964e-01  1.04339330e+00  1.04339330e+00  1.04339330e+00
  7.74463862e+00  7.74463862e+00  7.74463862e+00  3.59980163e+01
  3.59980163e+01  3.59980163e+01  1.38950661e+02  1.38950661e+02
  1.38950661e+02  1.83813051e+02  5.02726102e+02  5.02726102e+02
  5.02726102e+02  1.35946464e+03  1.35946464e+03  1.35946464e+03
  1.91324829e+03  3.05737349e+03  3.05737349e+03  3.05737349e+03
  6.67901488e+03  6.67901488e+03  6.67901488e+03  8.26281262e+03
  2.46433547e+04  7.54368281e+04]
E1 = -727.5540812793935  E_coul = 201.99991151140398
cycle= 3 E= -525.554169767989  delta_E= -5.67e-06  |g|= 0.00209  |ddm|= 0.00361
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00443672
diis-c [-8.56272516e-08 -7.43427576e-04  1.22663858e-01  8.78079570e-01]
  HOMO = -0.570161033521576  LUMO = 1.04299859265984
  mo_energy =
[-1.18082588e+02 -1.21702899e+01 -9.52085200e+00 -9.52085200e+00
 -9.52085200e+00 -1.24859146e+00 -5.70161034e-01 -5.70161034e-01
 -5.70161034e-01  1.04299859e+00  1.04299859e+00  1.04299859e+00
  7.74323868e+00  7.74323868e+00  7.74323868e+00  3.59956569e+01
  3.59956569e+01  3.59956569e+01  1.38947358e+02  1.38947358e+02
  1.38947358e+02  1.83809246e+02  5.02722175e+02  5.02722175e+02
  5.02722175e+02  1.35946047e+03  1.35946047e+03  1.35946047e+03
  1.91324390e+03  3.05736918e+03  3.05736918e+03  3.05736918e+03
  6.67901043e+03  6.67901043e+03  6.67901043e+03  8.26280810e+03
  2.46433501e+04  7.54368234e+04]
E1 = -727.5603595982994  E_coul = 202.00618966937412
cycle= 4 E= -525.554169928925  delta_E= -1.61e-07  |g|= 3.7e-05  |ddm|= 0.000586
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.64662e-05
diis-c [-3.78991236e-10 -2.63997318e-05  3.94714582e-03  4.17441219e-02
  9.54335132e-01]
  HOMO = -0.57013958865194  LUMO = 1.04301468891311
  mo_energy =
[-1.18082504e+02 -1.21702197e+01 -9.52078110e+00 -9.52078110e+00
 -9.52078110e+00 -1.24856351e+00 -5.70139589e-01 -5.70139589e-01
 -5.70139589e-01  1.04301469e+00  1.04301469e+00  1.04301469e+00
  7.74328966e+00  7.74328966e+00  7.74328966e+00  3.59957269e+01
  3.59957269e+01  3.59957269e+01  1.38947438e+02  1.38947438e+02
  1.38947438e+02  1.83809330e+02  5.02722259e+02  5.02722259e+02
  5.02722259e+02  1.35946055e+03  1.35946055e+03  1.35946055e+03
  1.91324399e+03  3.05736926e+03  3.05736926e+03  3.05736926e+03
  6.67901052e+03  6.67901052e+03  6.67901052e+03  8.26280818e+03
  2.46433502e+04  7.54368235e+04]
E1 = -727.5601828629678  E_coul = 202.00601293392523
cycle= 5 E= -525.554169929043  delta_E= -1.17e-10  |g|= 2.32e-06  |ddm|= 1.96e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5601828629678  E_coul = 202.00601293392523
  HOMO = -0.570140872229376  LUMO = 1.04301372565524
  mo_energy =
[-1.18082510e+02 -1.21702241e+01 -9.52078561e+00 -9.52078561e+00
 -9.52078561e+00 -1.24856518e+00 -5.70140872e-01 -5.70140872e-01
 -5.70140872e-01  1.04301373e+00  1.04301373e+00  1.04301373e+00
  7.74328654e+00  7.74328654e+00  7.74328654e+00  3.59957224e+01
  3.59957224e+01  3.59957224e+01  1.38947433e+02  1.38947433e+02
  1.38947433e+02  1.83809324e+02  5.02722253e+02  5.02722253e+02
  5.02722253e+02  1.35946055e+03  1.35946055e+03  1.35946055e+03
  1.91324398e+03  3.05736926e+03  3.05736926e+03  3.05736926e+03
  6.67901051e+03  6.67901051e+03  6.67901051e+03  8.26280817e+03
  2.46433502e+04  7.54368235e+04]
E1 = -727.5601944367469  E_coul = 202.00602450770415
Extra cycle  E= -525.554169929043  delta_E= -1.14e-13  |g|= 5.74e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 111781.48321166246
E1 = -727.5601944367469  E_coul = 202.00602450770415
init E= -525.554169929043
    CPU time for initialize scf      0.95 sec, wall time      0.19 sec
  HOMO = -0.570140652254518  LUMO = 1.04301389325932
  mo_energy =
[-1.18082508e+02 -1.21702232e+01 -9.52078473e+00 -9.52078473e+00
 -9.52078473e+00 -1.24856489e+00 -5.70140652e-01 -5.70140652e-01
 -5.70140652e-01  1.04301389e+00  1.04301389e+00  1.04301389e+00
  7.74328711e+00  7.74328711e+00  7.74328711e+00  3.59957233e+01
  3.59957233e+01  3.59957233e+01  1.38947434e+02  1.38947434e+02
  1.38947434e+02  1.83809326e+02  5.02722254e+02  5.02722254e+02
  5.02722254e+02  1.35946055e+03  1.35946055e+03  1.35946055e+03
  1.91324398e+03  3.05736926e+03  3.05736926e+03  3.05736926e+03
  6.67901051e+03  6.67901051e+03  6.67901051e+03  8.26280817e+03
  2.46433502e+04  7.54368235e+04]
E1 = -727.5601921037996  E_coul = 202.0060221747582
cycle= 1 E= -525.554169929041  delta_E= 1.25e-12  |g|= 1.24e-07  |ddm|= 2.3e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.5601921037996  E_coul = 202.0060221747582
  HOMO = -0.570140694381963  LUMO = 1.04301386104913
  mo_energy =
[-1.18082509e+02 -1.21702234e+01 -9.52078491e+00 -9.52078491e+00
 -9.52078491e+00 -1.24856495e+00 -5.70140694e-01 -5.70140694e-01
 -5.70140694e-01  1.04301386e+00  1.04301386e+00  1.04301386e+00
  7.74328700e+00  7.74328700e+00  7.74328700e+00  3.59957231e+01
  3.59957231e+01  3.59957231e+01  1.38947434e+02  1.38947434e+02
  1.38947434e+02  1.83809325e+02  5.02722254e+02  5.02722254e+02
  5.02722254e+02  1.35946055e+03  1.35946055e+03  1.35946055e+03
  1.91324398e+03  3.05736926e+03  3.05736926e+03  3.05736926e+03
  6.67901051e+03  6.67901051e+03  6.67901051e+03  8.26280817e+03
  2.46433502e+04  7.54368235e+04]
E1 = -727.560192578874  E_coul = 202.00602264983115
Extra cycle  E= -525.554169929043  delta_E= -1.36e-12  |g|= 2.59e-08  |ddm|= 4.59e-08
    CPU time for scf_cycle      1.07 sec, wall time      0.31 sec
exp = [2.61825241e+04 7.61807054e+03 3.61788849e+03 1.61270183e+03
 2.40096939e+02 5.22191395e+01 4.60258930e+00 3.98790423e-01
 1.36277950e+03 6.64999440e+02 3.02328055e+02 3.15271820e+02
 6.59259788e+01 7.77950090e+00 2.16356671e+01 7.86433432e-01
 2.95895891e+00 2.25080568e-01]
grad_E = [-1.98926981e-06  2.16760916e-05  4.29105156e-05  6.72424703e-04
  1.55038205e-04  2.36935249e-05  2.02987692e-04  5.71059486e-04
 -6.40033253e-07  2.80784038e-06  1.17525593e-05  1.00829653e-05
  1.93350134e-04  2.08327539e-04 -3.61508166e-05 -1.53045635e-03
  3.30567957e-04  5.39566403e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.524055         1
[INPUT] 0    0    [1    /1   ]  7618.07078623        1
[INPUT] 0    0    [1    /1   ]  3617.88901582        1
[INPUT] 0    0    [1    /1   ]  1612.70939383        1
[INPUT] 0    0    [1    /1   ]  240.091208158        1
[INPUT] 0    0    [1    /1   ]  52.2168464805        1
[INPUT] 0    0    [1    /1   ]  4.60263018486        1
[INPUT] 0    0    [1    /1   ]  0.398802775135       1
[INPUT] 1    0    [1    /1   ]  1362.77958641        1
[INPUT] 1    0    [1    /1   ]  665.000218968        1
[INPUT] 1    0    [1    /1   ]  302.332421597        1
[INPUT] 1    0    [1    /1   ]  315.275675157        1
[INPUT] 1    0    [1    /1   ]  65.838288281         1
[INPUT] 1    0    [1    /1   ]  7.78170092485        1
[INPUT] 1    0    [1    /1   ]  21.6092165527        1
[INPUT] 1    0    [1    /1   ]  0.786163057088       1
[INPUT] 1    0    [1    /1   ]  2.96177821625        1
[INPUT] 1    0    [1    /1   ]  0.225014443176       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.52405504459, 1.0]], [0, [7618.0707862256395, 1.0]], [0, [3617.889015817538, 1.0]], [0, [1612.7093938333592, 1.0]], [0, [240.09120815784445, 1.0]], [0, [52.21684648051255, 1.0]], [0, [4.60263018486486, 1.0]], [0, [0.3988027751350153, 1.0]], [1, [1362.7795864095272, 1.0]], [1, [665.0002189675141, 1.0]], [1, [302.3324215973343, 1.0]], [1, [315.2756751574626, 1.0]], [1, [65.83828828096917, 1.0]], [1, [7.781700924848009, 1.0]], [1, [21.60921655265136, 1.0]], [1, [0.7861630570876906, 1.0]], [1, [2.961778216250175, 1.0]], [1, [0.2250144431762727, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52405504]
bas 1, expnt(s) = [7618.07078623]
bas 2, expnt(s) = [3617.88901582]
bas 3, expnt(s) = [1612.70939383]
bas 4, expnt(s) = [240.09120816]
bas 5, expnt(s) = [52.21684648]
bas 6, expnt(s) = [4.60263018]
bas 7, expnt(s) = [0.39880278]
bas 8, expnt(s) = [1362.77958641]
bas 9, expnt(s) = [665.00021897]
bas 10, expnt(s) = [302.3324216]
bas 11, expnt(s) = [315.27567516]
bas 12, expnt(s) = [65.83828828]
bas 13, expnt(s) = [7.78170092]
bas 14, expnt(s) = [21.60921655]
bas 15, expnt(s) = [0.78616306]
bas 16, expnt(s) = [2.96177822]
bas 17, expnt(s) = [0.22501444]
CPU time:       348.05
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825241e+04 5.20024323e+03 7.61807079e+03 2.06014969e+03
 3.61788902e+03 1.17857291e+03 1.61270939e+03 6.42957270e+02
 2.40091208e+02 1.54098076e+02 5.22168465e+01 4.90764347e+01
 4.60263018e+00 7.93906916e+00 3.98802775e-01 1.26789606e+00
 1.36277959e+03 2.41555214e+04 6.65000219e+02 9.85171020e+03
 3.02332422e+02 3.67781852e+03 3.15275675e+02 3.87567608e+03
 6.58382883e+01 5.47119957e+02 7.78170092e+00 3.79164407e+01
 2.16092166e+01 1.35919939e+02 7.86163057e-01 2.15960927e+00
 2.96177822e+00 1.13350923e+01 2.25014443e-01 4.52113408e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973264444693346
cond(S) = 111643.06109062515
E1 = -727.5555725966251  E_coul = 203.12959447966804
init E= -524.425978116957
    CPU time for initialize scf      0.16 sec, wall time      0.04 sec
  HOMO = -0.559445651901987  LUMO = 1.04790701560846
  mo_energy =
[-1.17869291e+02 -1.20945974e+01 -9.44641001e+00 -9.44641001e+00
 -9.44641001e+00 -1.23027578e+00 -5.59445652e-01 -5.59445652e-01
 -5.59445652e-01  1.04790702e+00  1.04790702e+00  1.04790702e+00
  7.79086250e+00  7.79086250e+00  7.79086250e+00  3.60752271e+01
  3.60752271e+01  3.60752271e+01  1.38949472e+02  1.38949472e+02
  1.38949472e+02  1.83962180e+02  5.02607258e+02  5.02607258e+02
  5.02607258e+02  1.35934777e+03  1.35934777e+03  1.35934777e+03
  1.91358442e+03  3.05732196e+03  3.05732196e+03  3.05732196e+03
  6.67910467e+03  6.67910467e+03  6.67910467e+03  8.26329479e+03
  2.46439402e+04  7.54375098e+04]
E1 = -727.3934980562477  E_coul = 201.83950145867462
cycle= 1 E= -525.553996597573  delta_E= -1.13  |g|= 0.181  |ddm|= 0.335
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460587
diis-c [-0.21214038  1.        ]
  HOMO = -0.572237032478499  LUMO = 1.04087015058836
  mo_energy =
[-1.18107906e+02 -1.21822704e+01 -9.53302126e+00 -9.53302126e+00
 -9.53302126e+00 -1.25140133e+00 -5.72237032e-01 -5.72237032e-01
 -5.72237032e-01  1.04087015e+00  1.04087015e+00  1.04087015e+00
  7.74087888e+00  7.74087888e+00  7.74087888e+00  3.59790440e+01
  3.59790440e+01  3.59790440e+01  1.38789926e+02  1.38789926e+02
  1.38789926e+02  1.83775389e+02  5.02383763e+02  5.02383763e+02
  5.02383763e+02  1.35907714e+03  1.35907714e+03  1.35907714e+03
  1.91319467e+03  3.05699149e+03  3.05699149e+03  3.05699149e+03
  6.67866013e+03  6.67866013e+03  6.67866013e+03  8.26276839e+03
  2.46433207e+04  7.54367994e+04]
E1 = -727.5954793052888  E_coul = 202.04130723790917
cycle= 2 E= -525.55417206738  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.0139
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0304352
diis-c [-7.21199615e-04  3.02059165e-02  9.69794084e-01]
  HOMO = -0.569648199496389  LUMO = 1.04292014165624
  mo_energy =
[-1.18078676e+02 -1.21680784e+01 -9.51862038e+00 -9.51862038e+00
 -9.51862038e+00 -1.24792378e+00 -5.69648199e-01 -5.69648199e-01
 -5.69648199e-01  1.04292014e+00  1.04292014e+00  1.04292014e+00
  7.74894192e+00  7.74894192e+00  7.74894192e+00  3.59944218e+01
  3.59944218e+01  3.59944218e+01  1.38813287e+02  1.38813287e+02
  1.38813287e+02  1.83803495e+02  5.02412553e+02  5.02412553e+02
  5.02412553e+02  1.35910792e+03  1.35910792e+03  1.35910792e+03
  1.91322686e+03  3.05702328e+03  3.05702328e+03  3.05702328e+03
  6.67869247e+03  6.67869247e+03  6.67869247e+03  8.26280094e+03
  2.46433533e+04  7.54368319e+04]
E1 = -727.5537027512243  E_coul = 201.99952500983903
cycle= 3 E= -525.554177741385  delta_E= -5.67e-06  |g|= 0.00209  |ddm|= 0.00361
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00443836
diis-c [-8.54684893e-08 -7.43571856e-04  1.22661349e-01  8.78082223e-01]
  HOMO = -0.570161472155604  LUMO = 1.04252540717041
  mo_energy =
[-1.18082661e+02 -1.21703005e+01 -9.52088617e+00 -9.52088617e+00
 -9.52088617e+00 -1.24859967e+00 -5.70161472e-01 -5.70161472e-01
 -5.70161472e-01  1.04252541e+00  1.04252541e+00  1.04252541e+00
  7.74754097e+00  7.74754097e+00  7.74754097e+00  3.59920623e+01
  3.59920623e+01  3.59920623e+01  1.38809984e+02  1.38809984e+02
  1.38809984e+02  1.83799689e+02  5.02408626e+02  5.02408626e+02
  5.02408626e+02  1.35910375e+03  1.35910375e+03  1.35910375e+03
  1.91322247e+03  3.05701897e+03  3.05701897e+03  3.05701897e+03
  6.67868803e+03  6.67868803e+03  6.67868803e+03  8.26279642e+03
  2.46433487e+04  7.54368273e+04]
E1 = -727.559982714252  E_coul = 202.00580481184724
cycle= 4 E= -525.554177902405  delta_E= -1.61e-07  |g|= 3.7e-05  |ddm|= 0.000586
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.63789e-05
diis-c [-3.79127634e-10 -2.63948778e-05  3.94372029e-03  4.16974805e-02
  9.54385194e-01]
  HOMO = -0.570140037964255  LUMO = 1.04254149027062
  mo_energy =
[-1.18082577e+02 -1.21702304e+01 -9.52081533e+00 -9.52081533e+00
 -9.52081533e+00 -1.24857174e+00 -5.70140038e-01 -5.70140038e-01
 -5.70140038e-01  1.04254149e+00  1.04254149e+00  1.04254149e+00
  7.74759193e+00  7.74759193e+00  7.74759193e+00  3.59921323e+01
  3.59921323e+01  3.59921323e+01  1.38810064e+02  1.38810064e+02
  1.38810064e+02  1.83799773e+02  5.02408709e+02  5.02408709e+02
  5.02408709e+02  1.35910384e+03  1.35910384e+03  1.35910384e+03
  1.91322255e+03  3.05701905e+03  3.05701905e+03  3.05701905e+03
  6.67868811e+03  6.67868811e+03  6.67868811e+03  8.26279650e+03
  2.46433488e+04  7.54368274e+04]
E1 = -727.5598061649578  E_coul = 202.00562826243544
cycle= 5 E= -525.554177902522  delta_E= -1.18e-10  |g|= 2.32e-06  |ddm|= 1.96e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5598061649578  E_coul = 202.00562826243544
  HOMO = -0.570141321126015  LUMO = 1.04254052765333
  mo_energy =
[-1.18082583e+02 -1.21702348e+01 -9.52081983e+00 -9.52081983e+00
 -9.52081983e+00 -1.24857341e+00 -5.70141321e-01 -5.70141321e-01
 -5.70141321e-01  1.04254053e+00  1.04254053e+00  1.04254053e+00
  7.74758881e+00  7.74758881e+00  7.74758881e+00  3.59921277e+01
  3.59921277e+01  3.59921277e+01  1.38810059e+02  1.38810059e+02
  1.38810059e+02  1.83799767e+02  5.02408703e+02  5.02408703e+02
  5.02408703e+02  1.35910383e+03  1.35910383e+03  1.35910383e+03
  1.91322255e+03  3.05701905e+03  3.05701905e+03  3.05701905e+03
  6.67868811e+03  6.67868811e+03  6.67868811e+03  8.26279649e+03
  2.46433488e+04  7.54368274e+04]
E1 = -727.5598177383689  E_coul = 202.00563983584655
Extra cycle  E= -525.554177902522  delta_E= -1.14e-13  |g|= 5.74e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.35 sec, wall time      0.23 sec
exp = [2.61825241e+04 7.61807079e+03 3.61788902e+03 1.61270939e+03
 2.40091208e+02 5.22168465e+01 4.60263018e+00 3.98802775e-01
 1.36277959e+03 6.65000219e+02 3.02332422e+02 3.15275675e+02
 6.58382883e+01 7.78170092e+00 2.16092166e+01 7.86163057e-01
 2.96177822e+00 2.25014443e-01]
E = -525.5541779025224
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.524055         1
[INPUT] 0    0    [1    /1   ]  7618.07078623        1
[INPUT] 0    0    [1    /1   ]  3617.88901582        1
[INPUT] 0    0    [1    /1   ]  1612.70939383        1
[INPUT] 0    0    [1    /1   ]  240.091208158        1
[INPUT] 0    0    [1    /1   ]  52.2168464805        1
[INPUT] 0    0    [1    /1   ]  4.60263018486        1
[INPUT] 0    0    [1    /1   ]  0.398802775135       1
[INPUT] 1    0    [1    /1   ]  1362.77958641        1
[INPUT] 1    0    [1    /1   ]  665.000218968        1
[INPUT] 1    0    [1    /1   ]  302.332421597        1
[INPUT] 1    0    [1    /1   ]  315.275675157        1
[INPUT] 1    0    [1    /1   ]  65.838288281         1
[INPUT] 1    0    [1    /1   ]  7.78170092485        1
[INPUT] 1    0    [1    /1   ]  21.6092165527        1
[INPUT] 1    0    [1    /1   ]  0.786163057088       1
[INPUT] 1    0    [1    /1   ]  2.96177821625        1
[INPUT] 1    0    [1    /1   ]  0.225014443176       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.52405504459, 1.0]], [0, [7618.0707862256395, 1.0]], [0, [3617.889015817538, 1.0]], [0, [1612.7093938333592, 1.0]], [0, [240.09120815784445, 1.0]], [0, [52.21684648051255, 1.0]], [0, [4.60263018486486, 1.0]], [0, [0.3988027751350153, 1.0]], [1, [1362.7795864095272, 1.0]], [1, [665.0002189675141, 1.0]], [1, [302.3324215973343, 1.0]], [1, [315.2756751574626, 1.0]], [1, [65.83828828096917, 1.0]], [1, [7.781700924848009, 1.0]], [1, [21.60921655265136, 1.0]], [1, [0.7861630570876906, 1.0]], [1, [2.961778216250175, 1.0]], [1, [0.2250144431762727, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52405504]
bas 1, expnt(s) = [7618.07078623]
bas 2, expnt(s) = [3617.88901582]
bas 3, expnt(s) = [1612.70939383]
bas 4, expnt(s) = [240.09120816]
bas 5, expnt(s) = [52.21684648]
bas 6, expnt(s) = [4.60263018]
bas 7, expnt(s) = [0.39880278]
bas 8, expnt(s) = [1362.77958641]
bas 9, expnt(s) = [665.00021897]
bas 10, expnt(s) = [302.3324216]
bas 11, expnt(s) = [315.27567516]
bas 12, expnt(s) = [65.83828828]
bas 13, expnt(s) = [7.78170092]
bas 14, expnt(s) = [21.60921655]
bas 15, expnt(s) = [0.78616306]
bas 16, expnt(s) = [2.96177822]
bas 17, expnt(s) = [0.22501444]
CPU time:       348.61
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825241e+04 5.20024323e+03 7.61807079e+03 2.06014969e+03
 3.61788902e+03 1.17857291e+03 1.61270939e+03 6.42957270e+02
 2.40091208e+02 1.54098076e+02 5.22168465e+01 4.90764347e+01
 4.60263018e+00 7.93906916e+00 3.98802775e-01 1.26789606e+00
 1.36277959e+03 2.41555214e+04 6.65000219e+02 9.85171020e+03
 3.02332422e+02 3.67781852e+03 3.15275675e+02 3.87567608e+03
 6.58382883e+01 5.47119957e+02 7.78170092e+00 3.79164407e+01
 2.16092166e+01 1.35919939e+02 7.86163057e-01 2.15960927e+00
 2.96177822e+00 1.13350923e+01 2.25014443e-01 4.52113408e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973264444693346
cond(S) = 111643.06109062515
E1 = -727.5555725966251  E_coul = 203.12959447966804
init E= -524.425978116957
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.559445651901987  LUMO = 1.04790701560846
  mo_energy =
[-1.17869291e+02 -1.20945974e+01 -9.44641001e+00 -9.44641001e+00
 -9.44641001e+00 -1.23027578e+00 -5.59445652e-01 -5.59445652e-01
 -5.59445652e-01  1.04790702e+00  1.04790702e+00  1.04790702e+00
  7.79086250e+00  7.79086250e+00  7.79086250e+00  3.60752271e+01
  3.60752271e+01  3.60752271e+01  1.38949472e+02  1.38949472e+02
  1.38949472e+02  1.83962180e+02  5.02607258e+02  5.02607258e+02
  5.02607258e+02  1.35934777e+03  1.35934777e+03  1.35934777e+03
  1.91358442e+03  3.05732196e+03  3.05732196e+03  3.05732196e+03
  6.67910467e+03  6.67910467e+03  6.67910467e+03  8.26329479e+03
  2.46439402e+04  7.54375098e+04]
E1 = -727.3934980562477  E_coul = 201.83950145867462
cycle= 1 E= -525.553996597573  delta_E= -1.13  |g|= 0.181  |ddm|= 0.335
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460587
diis-c [-0.21214038  1.        ]
  HOMO = -0.572237032478499  LUMO = 1.04087015058836
  mo_energy =
[-1.18107906e+02 -1.21822704e+01 -9.53302126e+00 -9.53302126e+00
 -9.53302126e+00 -1.25140133e+00 -5.72237032e-01 -5.72237032e-01
 -5.72237032e-01  1.04087015e+00  1.04087015e+00  1.04087015e+00
  7.74087888e+00  7.74087888e+00  7.74087888e+00  3.59790440e+01
  3.59790440e+01  3.59790440e+01  1.38789926e+02  1.38789926e+02
  1.38789926e+02  1.83775389e+02  5.02383763e+02  5.02383763e+02
  5.02383763e+02  1.35907714e+03  1.35907714e+03  1.35907714e+03
  1.91319467e+03  3.05699149e+03  3.05699149e+03  3.05699149e+03
  6.67866013e+03  6.67866013e+03  6.67866013e+03  8.26276839e+03
  2.46433207e+04  7.54367994e+04]
E1 = -727.5954793052888  E_coul = 202.04130723790917
cycle= 2 E= -525.55417206738  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.0139
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0304352
diis-c [-7.21199615e-04  3.02059165e-02  9.69794084e-01]
  HOMO = -0.569648199496389  LUMO = 1.04292014165624
  mo_energy =
[-1.18078676e+02 -1.21680784e+01 -9.51862038e+00 -9.51862038e+00
 -9.51862038e+00 -1.24792378e+00 -5.69648199e-01 -5.69648199e-01
 -5.69648199e-01  1.04292014e+00  1.04292014e+00  1.04292014e+00
  7.74894192e+00  7.74894192e+00  7.74894192e+00  3.59944218e+01
  3.59944218e+01  3.59944218e+01  1.38813287e+02  1.38813287e+02
  1.38813287e+02  1.83803495e+02  5.02412553e+02  5.02412553e+02
  5.02412553e+02  1.35910792e+03  1.35910792e+03  1.35910792e+03
  1.91322686e+03  3.05702328e+03  3.05702328e+03  3.05702328e+03
  6.67869247e+03  6.67869247e+03  6.67869247e+03  8.26280094e+03
  2.46433533e+04  7.54368319e+04]
E1 = -727.5537027512243  E_coul = 201.99952500983903
cycle= 3 E= -525.554177741385  delta_E= -5.67e-06  |g|= 0.00209  |ddm|= 0.00361
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00443836
diis-c [-8.54684893e-08 -7.43571856e-04  1.22661349e-01  8.78082223e-01]
  HOMO = -0.570161472155604  LUMO = 1.04252540717041
  mo_energy =
[-1.18082661e+02 -1.21703005e+01 -9.52088617e+00 -9.52088617e+00
 -9.52088617e+00 -1.24859967e+00 -5.70161472e-01 -5.70161472e-01
 -5.70161472e-01  1.04252541e+00  1.04252541e+00  1.04252541e+00
  7.74754097e+00  7.74754097e+00  7.74754097e+00  3.59920623e+01
  3.59920623e+01  3.59920623e+01  1.38809984e+02  1.38809984e+02
  1.38809984e+02  1.83799689e+02  5.02408626e+02  5.02408626e+02
  5.02408626e+02  1.35910375e+03  1.35910375e+03  1.35910375e+03
  1.91322247e+03  3.05701897e+03  3.05701897e+03  3.05701897e+03
  6.67868803e+03  6.67868803e+03  6.67868803e+03  8.26279642e+03
  2.46433487e+04  7.54368273e+04]
E1 = -727.559982714252  E_coul = 202.00580481184724
cycle= 4 E= -525.554177902405  delta_E= -1.61e-07  |g|= 3.7e-05  |ddm|= 0.000586
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.63789e-05
diis-c [-3.79127634e-10 -2.63948778e-05  3.94372029e-03  4.16974805e-02
  9.54385194e-01]
  HOMO = -0.570140037964255  LUMO = 1.04254149027062
  mo_energy =
[-1.18082577e+02 -1.21702304e+01 -9.52081533e+00 -9.52081533e+00
 -9.52081533e+00 -1.24857174e+00 -5.70140038e-01 -5.70140038e-01
 -5.70140038e-01  1.04254149e+00  1.04254149e+00  1.04254149e+00
  7.74759193e+00  7.74759193e+00  7.74759193e+00  3.59921323e+01
  3.59921323e+01  3.59921323e+01  1.38810064e+02  1.38810064e+02
  1.38810064e+02  1.83799773e+02  5.02408709e+02  5.02408709e+02
  5.02408709e+02  1.35910384e+03  1.35910384e+03  1.35910384e+03
  1.91322255e+03  3.05701905e+03  3.05701905e+03  3.05701905e+03
  6.67868811e+03  6.67868811e+03  6.67868811e+03  8.26279650e+03
  2.46433488e+04  7.54368274e+04]
E1 = -727.5598061649578  E_coul = 202.00562826243544
cycle= 5 E= -525.554177902522  delta_E= -1.18e-10  |g|= 2.32e-06  |ddm|= 1.96e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5598061649578  E_coul = 202.00562826243544
  HOMO = -0.570141321126015  LUMO = 1.04254052765333
  mo_energy =
[-1.18082583e+02 -1.21702348e+01 -9.52081983e+00 -9.52081983e+00
 -9.52081983e+00 -1.24857341e+00 -5.70141321e-01 -5.70141321e-01
 -5.70141321e-01  1.04254053e+00  1.04254053e+00  1.04254053e+00
  7.74758881e+00  7.74758881e+00  7.74758881e+00  3.59921277e+01
  3.59921277e+01  3.59921277e+01  1.38810059e+02  1.38810059e+02
  1.38810059e+02  1.83799767e+02  5.02408703e+02  5.02408703e+02
  5.02408703e+02  1.35910383e+03  1.35910383e+03  1.35910383e+03
  1.91322255e+03  3.05701905e+03  3.05701905e+03  3.05701905e+03
  6.67868811e+03  6.67868811e+03  6.67868811e+03  8.26279649e+03
  2.46433488e+04  7.54368274e+04]
E1 = -727.5598177383689  E_coul = 202.00563983584655
Extra cycle  E= -525.554177902522  delta_E= -1.14e-13  |g|= 5.74e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 111643.06109062515
E1 = -727.5598177383689  E_coul = 202.00563983584655
init E= -525.554177902522
    CPU time for initialize scf      0.95 sec, wall time      0.19 sec
  HOMO = -0.570141101127691  LUMO = 1.04254069522167
  mo_energy =
[-1.18082582e+02 -1.21702339e+01 -9.52081896e+00 -9.52081896e+00
 -9.52081896e+00 -1.24857312e+00 -5.70141101e-01 -5.70141101e-01
 -5.70141101e-01  1.04254070e+00  1.04254070e+00  1.04254070e+00
  7.74758938e+00  7.74758938e+00  7.74758938e+00  3.59921286e+01
  3.59921286e+01  3.59921286e+01  1.38810060e+02  1.38810060e+02
  1.38810060e+02  1.83799768e+02  5.02408705e+02  5.02408705e+02
  5.02408705e+02  1.35910383e+03  1.35910383e+03  1.35910383e+03
  1.91322255e+03  3.05701905e+03  3.05701905e+03  3.05701905e+03
  6.67868811e+03  6.67868811e+03  6.67868811e+03  8.26279649e+03
  2.46433488e+04  7.54368274e+04]
E1 = -727.559815405752  E_coul = 202.0056375032296
cycle= 1 E= -525.554177902522  delta_E= -1.14e-13  |g|= 1.24e-07  |ddm|= 2.3e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.559815405752  E_coul = 202.0056375032296
  HOMO = -0.570141143250672  LUMO = 1.04254066302485
  mo_energy =
[-1.18082582e+02 -1.21702341e+01 -9.52081913e+00 -9.52081913e+00
 -9.52081913e+00 -1.24857318e+00 -5.70141143e-01 -5.70141143e-01
 -5.70141143e-01  1.04254066e+00  1.04254066e+00  1.04254066e+00
  7.74758927e+00  7.74758927e+00  7.74758927e+00  3.59921285e+01
  3.59921285e+01  3.59921285e+01  1.38810060e+02  1.38810060e+02
  1.38810060e+02  1.83799768e+02  5.02408704e+02  5.02408704e+02
  5.02408704e+02  1.35910383e+03  1.35910383e+03  1.35910383e+03
  1.91322255e+03  3.05701905e+03  3.05701905e+03  3.05701905e+03
  6.67868811e+03  6.67868811e+03  6.67868811e+03  8.26279649e+03
  2.46433488e+04  7.54368274e+04]
E1 = -727.559815880741  E_coul = 202.00563797821962
Extra cycle  E= -525.554177902521  delta_E= 1.14e-12  |g|= 2.59e-08  |ddm|= 4.59e-08
    CPU time for scf_cycle      1.08 sec, wall time      0.31 sec
exp = [2.61825241e+04 7.61807079e+03 3.61788902e+03 1.61270939e+03
 2.40091208e+02 5.22168465e+01 4.60263018e+00 3.98802775e-01
 1.36277959e+03 6.65000219e+02 3.02332422e+02 3.15275675e+02
 6.58382883e+01 7.78170092e+00 2.16092166e+01 7.86163057e-01
 2.96177822e+00 2.25014443e-01]
grad_E = [-1.98925773e-06  2.16771035e-05  4.29141087e-05  6.72445724e-04
  1.58454870e-04 -1.61216825e-05  2.40471680e-04  7.37217365e-04
 -6.39224326e-07  2.82052336e-06  1.18017809e-05  1.01283279e-05
  2.08671539e-04  6.40828051e-04 -2.08528449e-04 -2.19481506e-03
  1.75604804e-04  1.00733304e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:54 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5240936        1
[INPUT] 0    0    [1    /1   ]  7618.07038671        1
[INPUT] 0    0    [1    /1   ]  3617.88825799        1
[INPUT] 0    0    [1    /1   ]  1612.69674273        1
[INPUT] 0    0    [1    /1   ]  240.078722417        1
[INPUT] 0    0    [1    /1   ]  52.2123931427        1
[INPUT] 0    0    [1    /1   ]  4.60263991115        1
[INPUT] 0    0    [1    /1   ]  0.398810566213       1
[INPUT] 1    0    [1    /1   ]  1362.77971274        1
[INPUT] 1    0    [1    /1   ]  665.001129087        1
[INPUT] 1    0    [1    /1   ]  302.337657954        1
[INPUT] 1    0    [1    /1   ]  315.280307669        1
[INPUT] 1    0    [1    /1   ]  65.7177246366        1
[INPUT] 1    0    [1    /1   ]  7.78826049549        1
[INPUT] 1    0    [1    /1   ]  21.5768777624        1
[INPUT] 1    0    [1    /1   ]  0.786104932368       1
[INPUT] 1    0    [1    /1   ]  2.96654083439        1
[INPUT] 1    0    [1    /1   ]  0.225009651705       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.52409361852, 1.0]], [0, [7618.070386709326, 1.0]], [0, [3617.8882579924207, 1.0]], [0, [1612.6967427334514, 1.0]], [0, [240.0787224170107, 1.0]], [0, [52.212393142692925, 1.0]], [0, [4.602639911152605, 1.0]], [0, [0.39881056621279204, 1.0]], [1, [1362.779712743799, 1.0]], [1, [665.0011290865489, 1.0]], [1, [302.33765795404076, 1.0]], [1, [315.2803076687407, 1.0]], [1, [65.71772463663294, 1.0]], [1, [7.7882604954901495, 1.0]], [1, [21.576877762378697, 1.0]], [1, [0.7861049323676497, 1.0]], [1, [2.966540834387479, 1.0]], [1, [0.22500965170452444, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52409362]
bas 1, expnt(s) = [7618.07038671]
bas 2, expnt(s) = [3617.88825799]
bas 3, expnt(s) = [1612.69674273]
bas 4, expnt(s) = [240.07872242]
bas 5, expnt(s) = [52.21239314]
bas 6, expnt(s) = [4.60263991]
bas 7, expnt(s) = [0.39881057]
bas 8, expnt(s) = [1362.77971274]
bas 9, expnt(s) = [665.00112909]
bas 10, expnt(s) = [302.33765795]
bas 11, expnt(s) = [315.28030767]
bas 12, expnt(s) = [65.71772464]
bas 13, expnt(s) = [7.7882605]
bas 14, expnt(s) = [21.57687776]
bas 15, expnt(s) = [0.78610493]
bas 16, expnt(s) = [2.96654083]
bas 17, expnt(s) = [0.22500965]
CPU time:       354.47
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825241e+04 5.20024324e+03 7.61807039e+03 2.06014961e+03
 3.61788826e+03 1.17857272e+03 1.61269674e+03 6.42953487e+02
 2.40078722e+02 1.54092066e+02 5.22123931e+01 4.90732955e+01
 4.60263991e+00 7.93908174e+00 3.98810566e-01 1.26791464e+00
 1.36277971e+03 2.41555242e+04 6.65001129e+02 9.85172705e+03
 3.02337658e+02 3.67789815e+03 3.15280308e+02 3.87574727e+03
 6.57177246e+01 5.45867880e+02 7.78826050e+00 3.79563969e+01
 2.15768778e+01 1.35665726e+02 7.86104932e-01 2.15940968e+00
 2.96654083e+00 1.13578808e+01 2.25009652e-01 4.52101374e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973264552717506
cond(S) = 111460.61111801003
E1 = -727.5558628931859  E_coul = 203.12963554615294
init E= -524.426227347033
    CPU time for initialize scf      0.17 sec, wall time      0.05 sec
  HOMO = -0.559435826375087  LUMO = 1.04786468625014
  mo_energy =
[-1.17869341e+02 -1.20945574e+01 -9.44641492e+00 -9.44641492e+00
 -9.44641492e+00 -1.23027007e+00 -5.59435826e-01 -5.59435826e-01
 -5.59435826e-01  1.04786469e+00  1.04786469e+00  1.04786469e+00
  7.80096420e+00  7.80096420e+00  7.80096420e+00  3.60859120e+01
  3.60859120e+01  3.60859120e+01  1.38787752e+02  1.38787752e+02
  1.38787752e+02  1.83942567e+02  5.02202956e+02  5.02202956e+02
  5.02202956e+02  1.35888068e+03  1.35888068e+03  1.35888068e+03
  1.91352317e+03  3.05686031e+03  3.05686031e+03  3.05686031e+03
  6.67867799e+03  6.67867799e+03  6.67867799e+03  8.26320829e+03
  2.46438384e+04  7.54374053e+04]
E1 = -727.3931800610084  E_coul = 201.83916452185701
cycle= 1 E= -525.554015539151  delta_E= -1.13  |g|= 0.181  |ddm|= 0.338
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460638
diis-c [-0.21218756  1.        ]
  HOMO = -0.572222799405934  LUMO = 1.04083000821062
  mo_energy =
[-1.18108034e+02 -1.21822595e+01 -9.53305821e+00 -9.53305821e+00
 -9.53305821e+00 -1.25139459e+00 -5.72222799e-01 -5.72222799e-01
 -5.72222799e-01  1.04083001e+00  1.04083001e+00  1.04083001e+00
  7.75091545e+00  7.75091545e+00  7.75091545e+00  3.59897344e+01
  3.59897344e+01  3.59897344e+01  1.38628256e+02  1.38628256e+02
  1.38628256e+02  1.83755716e+02  5.01979387e+02  5.01979387e+02
  5.01979387e+02  1.35860991e+03  1.35860991e+03  1.35860991e+03
  1.91313322e+03  3.05652967e+03  3.05652967e+03  3.05652967e+03
  6.67823323e+03  6.67823323e+03  6.67823323e+03  8.26268165e+03
  2.46432186e+04  7.54366946e+04]
E1 = -727.5952371027704  E_coul = 202.0410460464583
cycle= 2 E= -525.554191056312  delta_E= -0.000176  |g|= 0.0149  |ddm|= 0.0139
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0304445
diis-c [-7.21389453e-04  3.02295259e-02  9.69770474e-01]
  HOMO = -0.569631463199689  LUMO = 1.04288209407914
  mo_energy =
[-1.18078797e+02 -1.21680632e+01 -9.51865292e+00 -9.51865292e+00
 -9.51865292e+00 -1.24791400e+00 -5.69631463e-01 -5.69631463e-01
 -5.69631463e-01  1.04288209e+00  1.04288209e+00  1.04288209e+00
  7.75898940e+00  7.75898940e+00  7.75898940e+00  3.60051109e+01
  3.60051109e+01  3.60051109e+01  1.38651611e+02  1.38651611e+02
  1.38651611e+02  1.83783827e+02  5.02008183e+02  5.02008183e+02
  5.02008183e+02  1.35864070e+03  1.35864070e+03  1.35864070e+03
  1.91316542e+03  3.05656147e+03  3.05656147e+03  3.05656147e+03
  6.67826558e+03  6.67826558e+03  6.67826558e+03  8.26271421e+03
  2.46432512e+04  7.54367271e+04]
E1 = -727.5534566078647  E_coul = 201.99925987536292
cycle= 3 E= -525.554196732502  delta_E= -5.68e-06  |g|= 0.00209  |ddm|= 0.00361
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00443904
diis-c [-8.52524070e-08 -7.43807433e-04  1.22641643e-01  8.78102165e-01]
  HOMO = -0.570144636495257  LUMO = 1.04248740438688
  mo_energy =
[-1.18082782e+02 -1.21702851e+01 -9.52091854e+00 -9.52091854e+00
 -9.52091854e+00 -1.24858979e+00 -5.70144636e-01 -5.70144636e-01
 -5.70144636e-01  1.04248740e+00  1.04248740e+00  1.04248740e+00
  7.75758760e+00  7.75758760e+00  7.75758760e+00  3.60027522e+01
  3.60027522e+01  3.60027522e+01  1.38648309e+02  1.38648309e+02
  1.38648309e+02  1.83780022e+02  5.02004255e+02  5.02004255e+02
  5.02004255e+02  1.35863653e+03  1.35863653e+03  1.35863653e+03
  1.91316103e+03  3.05655716e+03  3.05655716e+03  3.05655716e+03
  6.67826114e+03  6.67826114e+03  6.67826114e+03  8.26270969e+03
  2.46432466e+04  7.54367225e+04]
E1 = -727.5597348002053  E_coul = 202.00553790674982
cycle= 4 E= -525.554196893455  delta_E= -1.61e-07  |g|= 3.69e-05  |ddm|= 0.000586
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.62432e-05
diis-c [-3.79242268e-10 -2.63916065e-05  3.93779750e-03  4.16306878e-02
  9.54457906e-01]
  HOMO = -0.570123220945279  LUMO = 1.04250347437828
  mo_energy =
[-1.18082698e+02 -1.21702151e+01 -9.52084781e+00 -9.52084781e+00
 -9.52084781e+00 -1.24856188e+00 -5.70123221e-01 -5.70123221e-01
 -5.70123221e-01  1.04250347e+00  1.04250347e+00  1.04250347e+00
  7.75763854e+00  7.75763854e+00  7.75763854e+00  3.60028221e+01
  3.60028221e+01  3.60028221e+01  1.38648389e+02  1.38648389e+02
  1.38648389e+02  1.83780106e+02  5.02004339e+02  5.02004339e+02
  5.02004339e+02  1.35863662e+03  1.35863662e+03  1.35863662e+03
  1.91316111e+03  3.05655724e+03  3.05655724e+03  3.05655724e+03
  6.67826122e+03  6.67826122e+03  6.67826122e+03  8.26270977e+03
  2.46432467e+04  7.54367225e+04]
E1 = -727.5595585586984  E_coul = 202.00536166512512
cycle= 5 E= -525.554196893573  delta_E= -1.18e-10  |g|= 2.32e-06  |ddm|= 1.95e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5595585586984  E_coul = 202.00536166512512
  HOMO = -0.570124503446796  LUMO = 1.042502512206
  mo_energy =
[-1.18082704e+02 -1.21702195e+01 -9.52085231e+00 -9.52085231e+00
 -9.52085231e+00 -1.24856355e+00 -5.70124503e-01 -5.70124503e-01
 -5.70124503e-01  1.04250251e+00  1.04250251e+00  1.04250251e+00
  7.75763542e+00  7.75763542e+00  7.75763542e+00  3.60028176e+01
  3.60028176e+01  3.60028176e+01  1.38648384e+02  1.38648384e+02
  1.38648384e+02  1.83780100e+02  5.02004333e+02  5.02004333e+02
  5.02004333e+02  1.35863661e+03  1.35863661e+03  1.35863661e+03
  1.91316110e+03  3.05655723e+03  3.05655723e+03  3.05655723e+03
  6.67826121e+03  6.67826121e+03  6.67826121e+03  8.26270976e+03
  2.46432467e+04  7.54367225e+04]
E1 = -727.5595701307775  E_coul = 202.00537323720437
Extra cycle  E= -525.554196893573  delta_E= 2.27e-13  |g|= 5.74e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.36 sec, wall time      0.23 sec
exp = [2.61825241e+04 7.61807039e+03 3.61788826e+03 1.61269674e+03
 2.40078722e+02 5.22123931e+01 4.60263991e+00 3.98810566e-01
 1.36277971e+03 6.65001129e+02 3.02337658e+02 3.15280308e+02
 6.57177246e+01 7.78826050e+00 2.15768778e+01 7.86104932e-01
 2.96654083e+00 2.25009652e-01]
E = -525.5541968935731
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:54 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5240936        1
[INPUT] 0    0    [1    /1   ]  7618.07038671        1
[INPUT] 0    0    [1    /1   ]  3617.88825799        1
[INPUT] 0    0    [1    /1   ]  1612.69674273        1
[INPUT] 0    0    [1    /1   ]  240.078722417        1
[INPUT] 0    0    [1    /1   ]  52.2123931427        1
[INPUT] 0    0    [1    /1   ]  4.60263991115        1
[INPUT] 0    0    [1    /1   ]  0.398810566213       1
[INPUT] 1    0    [1    /1   ]  1362.77971274        1
[INPUT] 1    0    [1    /1   ]  665.001129087        1
[INPUT] 1    0    [1    /1   ]  302.337657954        1
[INPUT] 1    0    [1    /1   ]  315.280307669        1
[INPUT] 1    0    [1    /1   ]  65.7177246366        1
[INPUT] 1    0    [1    /1   ]  7.78826049549        1
[INPUT] 1    0    [1    /1   ]  21.5768777624        1
[INPUT] 1    0    [1    /1   ]  0.786104932368       1
[INPUT] 1    0    [1    /1   ]  2.96654083439        1
[INPUT] 1    0    [1    /1   ]  0.225009651705       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.52409361852, 1.0]], [0, [7618.070386709326, 1.0]], [0, [3617.8882579924207, 1.0]], [0, [1612.6967427334514, 1.0]], [0, [240.0787224170107, 1.0]], [0, [52.212393142692925, 1.0]], [0, [4.602639911152605, 1.0]], [0, [0.39881056621279204, 1.0]], [1, [1362.779712743799, 1.0]], [1, [665.0011290865489, 1.0]], [1, [302.33765795404076, 1.0]], [1, [315.2803076687407, 1.0]], [1, [65.71772463663294, 1.0]], [1, [7.7882604954901495, 1.0]], [1, [21.576877762378697, 1.0]], [1, [0.7861049323676497, 1.0]], [1, [2.966540834387479, 1.0]], [1, [0.22500965170452444, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52409362]
bas 1, expnt(s) = [7618.07038671]
bas 2, expnt(s) = [3617.88825799]
bas 3, expnt(s) = [1612.69674273]
bas 4, expnt(s) = [240.07872242]
bas 5, expnt(s) = [52.21239314]
bas 6, expnt(s) = [4.60263991]
bas 7, expnt(s) = [0.39881057]
bas 8, expnt(s) = [1362.77971274]
bas 9, expnt(s) = [665.00112909]
bas 10, expnt(s) = [302.33765795]
bas 11, expnt(s) = [315.28030767]
bas 12, expnt(s) = [65.71772464]
bas 13, expnt(s) = [7.7882605]
bas 14, expnt(s) = [21.57687776]
bas 15, expnt(s) = [0.78610493]
bas 16, expnt(s) = [2.96654083]
bas 17, expnt(s) = [0.22500965]
CPU time:       355.04
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825241e+04 5.20024324e+03 7.61807039e+03 2.06014961e+03
 3.61788826e+03 1.17857272e+03 1.61269674e+03 6.42953487e+02
 2.40078722e+02 1.54092066e+02 5.22123931e+01 4.90732955e+01
 4.60263991e+00 7.93908174e+00 3.98810566e-01 1.26791464e+00
 1.36277971e+03 2.41555242e+04 6.65001129e+02 9.85172705e+03
 3.02337658e+02 3.67789815e+03 3.15280308e+02 3.87574727e+03
 6.57177246e+01 5.45867880e+02 7.78826050e+00 3.79563969e+01
 2.15768778e+01 1.35665726e+02 7.86104932e-01 2.15940968e+00
 2.96654083e+00 1.13578808e+01 2.25009652e-01 4.52101374e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973264552717506
cond(S) = 111460.61111801003
E1 = -727.5558628931859  E_coul = 203.12963554615294
init E= -524.426227347033
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.559435826375087  LUMO = 1.04786468625014
  mo_energy =
[-1.17869341e+02 -1.20945574e+01 -9.44641492e+00 -9.44641492e+00
 -9.44641492e+00 -1.23027007e+00 -5.59435826e-01 -5.59435826e-01
 -5.59435826e-01  1.04786469e+00  1.04786469e+00  1.04786469e+00
  7.80096420e+00  7.80096420e+00  7.80096420e+00  3.60859120e+01
  3.60859120e+01  3.60859120e+01  1.38787752e+02  1.38787752e+02
  1.38787752e+02  1.83942567e+02  5.02202956e+02  5.02202956e+02
  5.02202956e+02  1.35888068e+03  1.35888068e+03  1.35888068e+03
  1.91352317e+03  3.05686031e+03  3.05686031e+03  3.05686031e+03
  6.67867799e+03  6.67867799e+03  6.67867799e+03  8.26320829e+03
  2.46438384e+04  7.54374053e+04]
E1 = -727.3931800610084  E_coul = 201.83916452185701
cycle= 1 E= -525.554015539151  delta_E= -1.13  |g|= 0.181  |ddm|= 0.338
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460638
diis-c [-0.21218756  1.        ]
  HOMO = -0.572222799405934  LUMO = 1.04083000821062
  mo_energy =
[-1.18108034e+02 -1.21822595e+01 -9.53305821e+00 -9.53305821e+00
 -9.53305821e+00 -1.25139459e+00 -5.72222799e-01 -5.72222799e-01
 -5.72222799e-01  1.04083001e+00  1.04083001e+00  1.04083001e+00
  7.75091545e+00  7.75091545e+00  7.75091545e+00  3.59897344e+01
  3.59897344e+01  3.59897344e+01  1.38628256e+02  1.38628256e+02
  1.38628256e+02  1.83755716e+02  5.01979387e+02  5.01979387e+02
  5.01979387e+02  1.35860991e+03  1.35860991e+03  1.35860991e+03
  1.91313322e+03  3.05652967e+03  3.05652967e+03  3.05652967e+03
  6.67823323e+03  6.67823323e+03  6.67823323e+03  8.26268165e+03
  2.46432186e+04  7.54366946e+04]
E1 = -727.5952371027704  E_coul = 202.0410460464583
cycle= 2 E= -525.554191056312  delta_E= -0.000176  |g|= 0.0149  |ddm|= 0.0139
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0304445
diis-c [-7.21389453e-04  3.02295259e-02  9.69770474e-01]
  HOMO = -0.569631463199689  LUMO = 1.04288209407914
  mo_energy =
[-1.18078797e+02 -1.21680632e+01 -9.51865292e+00 -9.51865292e+00
 -9.51865292e+00 -1.24791400e+00 -5.69631463e-01 -5.69631463e-01
 -5.69631463e-01  1.04288209e+00  1.04288209e+00  1.04288209e+00
  7.75898940e+00  7.75898940e+00  7.75898940e+00  3.60051109e+01
  3.60051109e+01  3.60051109e+01  1.38651611e+02  1.38651611e+02
  1.38651611e+02  1.83783827e+02  5.02008183e+02  5.02008183e+02
  5.02008183e+02  1.35864070e+03  1.35864070e+03  1.35864070e+03
  1.91316542e+03  3.05656147e+03  3.05656147e+03  3.05656147e+03
  6.67826558e+03  6.67826558e+03  6.67826558e+03  8.26271421e+03
  2.46432512e+04  7.54367271e+04]
E1 = -727.5534566078647  E_coul = 201.99925987536292
cycle= 3 E= -525.554196732502  delta_E= -5.68e-06  |g|= 0.00209  |ddm|= 0.00361
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00443904
diis-c [-8.52524070e-08 -7.43807433e-04  1.22641643e-01  8.78102165e-01]
  HOMO = -0.570144636495257  LUMO = 1.04248740438688
  mo_energy =
[-1.18082782e+02 -1.21702851e+01 -9.52091854e+00 -9.52091854e+00
 -9.52091854e+00 -1.24858979e+00 -5.70144636e-01 -5.70144636e-01
 -5.70144636e-01  1.04248740e+00  1.04248740e+00  1.04248740e+00
  7.75758760e+00  7.75758760e+00  7.75758760e+00  3.60027522e+01
  3.60027522e+01  3.60027522e+01  1.38648309e+02  1.38648309e+02
  1.38648309e+02  1.83780022e+02  5.02004255e+02  5.02004255e+02
  5.02004255e+02  1.35863653e+03  1.35863653e+03  1.35863653e+03
  1.91316103e+03  3.05655716e+03  3.05655716e+03  3.05655716e+03
  6.67826114e+03  6.67826114e+03  6.67826114e+03  8.26270969e+03
  2.46432466e+04  7.54367225e+04]
E1 = -727.5597348002053  E_coul = 202.00553790674982
cycle= 4 E= -525.554196893455  delta_E= -1.61e-07  |g|= 3.69e-05  |ddm|= 0.000586
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.62432e-05
diis-c [-3.79242268e-10 -2.63916065e-05  3.93779750e-03  4.16306878e-02
  9.54457906e-01]
  HOMO = -0.570123220945279  LUMO = 1.04250347437828
  mo_energy =
[-1.18082698e+02 -1.21702151e+01 -9.52084781e+00 -9.52084781e+00
 -9.52084781e+00 -1.24856188e+00 -5.70123221e-01 -5.70123221e-01
 -5.70123221e-01  1.04250347e+00  1.04250347e+00  1.04250347e+00
  7.75763854e+00  7.75763854e+00  7.75763854e+00  3.60028221e+01
  3.60028221e+01  3.60028221e+01  1.38648389e+02  1.38648389e+02
  1.38648389e+02  1.83780106e+02  5.02004339e+02  5.02004339e+02
  5.02004339e+02  1.35863662e+03  1.35863662e+03  1.35863662e+03
  1.91316111e+03  3.05655724e+03  3.05655724e+03  3.05655724e+03
  6.67826122e+03  6.67826122e+03  6.67826122e+03  8.26270977e+03
  2.46432467e+04  7.54367225e+04]
E1 = -727.5595585586984  E_coul = 202.00536166512512
cycle= 5 E= -525.554196893573  delta_E= -1.18e-10  |g|= 2.32e-06  |ddm|= 1.95e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5595585586984  E_coul = 202.00536166512512
  HOMO = -0.570124503446796  LUMO = 1.042502512206
  mo_energy =
[-1.18082704e+02 -1.21702195e+01 -9.52085231e+00 -9.52085231e+00
 -9.52085231e+00 -1.24856355e+00 -5.70124503e-01 -5.70124503e-01
 -5.70124503e-01  1.04250251e+00  1.04250251e+00  1.04250251e+00
  7.75763542e+00  7.75763542e+00  7.75763542e+00  3.60028176e+01
  3.60028176e+01  3.60028176e+01  1.38648384e+02  1.38648384e+02
  1.38648384e+02  1.83780100e+02  5.02004333e+02  5.02004333e+02
  5.02004333e+02  1.35863661e+03  1.35863661e+03  1.35863661e+03
  1.91316110e+03  3.05655723e+03  3.05655723e+03  3.05655723e+03
  6.67826121e+03  6.67826121e+03  6.67826121e+03  8.26270976e+03
  2.46432467e+04  7.54367225e+04]
E1 = -727.5595701307775  E_coul = 202.00537323720437
Extra cycle  E= -525.554196893573  delta_E= 2.27e-13  |g|= 5.74e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 111460.61111801003
E1 = -727.5595701307775  E_coul = 202.00537323720437
init E= -525.554196893573
    CPU time for initialize scf      0.96 sec, wall time      0.19 sec
  HOMO = -0.570124283461918  LUMO = 1.0425026797778
  mo_energy =
[-1.18082703e+02 -1.21702186e+01 -9.52085144e+00 -9.52085144e+00
 -9.52085144e+00 -1.24856326e+00 -5.70124283e-01 -5.70124283e-01
 -5.70124283e-01  1.04250268e+00  1.04250268e+00  1.04250268e+00
  7.75763599e+00  7.75763599e+00  7.75763599e+00  3.60028185e+01
  3.60028185e+01  3.60028185e+01  1.38648385e+02  1.38648385e+02
  1.38648385e+02  1.83780101e+02  5.02004334e+02  5.02004334e+02
  5.02004334e+02  1.35863661e+03  1.35863661e+03  1.35863661e+03
  1.91316110e+03  3.05655723e+03  3.05655723e+03  3.05655723e+03
  6.67826122e+03  6.67826122e+03  6.67826122e+03  8.26270976e+03
  2.46432467e+04  7.54367225e+04]
E1 = -727.5595677990294  E_coul = 202.00537090545612
cycle= 1 E= -525.554196893573  delta_E= -2.27e-13  |g|= 1.24e-07  |ddm|= 2.3e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.5595677990294  E_coul = 202.00537090545612
  HOMO = -0.570124325565804  LUMO = 1.04250264759342
  mo_energy =
[-1.18082703e+02 -1.21702188e+01 -9.52085161e+00 -9.52085161e+00
 -9.52085161e+00 -1.24856332e+00 -5.70124326e-01 -5.70124326e-01
 -5.70124326e-01  1.04250265e+00  1.04250265e+00  1.04250265e+00
  7.75763588e+00  7.75763588e+00  7.75763588e+00  3.60028183e+01
  3.60028183e+01  3.60028183e+01  1.38648385e+02  1.38648385e+02
  1.38648385e+02  1.83780101e+02  5.02004334e+02  5.02004334e+02
  5.02004334e+02  1.35863661e+03  1.35863661e+03  1.35863661e+03
  1.91316110e+03  3.05655723e+03  3.05655723e+03  3.05655723e+03
  6.67826121e+03  6.67826121e+03  6.67826121e+03  8.26270976e+03
  2.46432467e+04  7.54367225e+04]
E1 = -727.5595682737446  E_coul = 202.0053713801703
Extra cycle  E= -525.554196893574  delta_E= -9.09e-13  |g|= 2.59e-08  |ddm|= 4.59e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.32 sec
exp = [2.61825241e+04 7.61807039e+03 3.61788826e+03 1.61269674e+03
 2.40078722e+02 5.22123931e+01 4.60263991e+00 3.98810566e-01
 1.36277971e+03 6.65001129e+02 3.02337658e+02 3.15280308e+02
 6.57177246e+01 7.78826050e+00 2.15768778e+01 7.86104932e-01
 2.96654083e+00 2.25009652e-01]
grad_E = [-1.98923960e-06  2.16786036e-05  4.29185903e-05  6.72505605e-04
  1.64545749e-04 -8.94805118e-05  2.49881334e-04  8.83167600e-04
 -6.38098276e-07  2.83805254e-06  1.18687736e-05  1.01902430e-05
  2.31356310e-04  1.36753688e-03 -4.77310224e-04 -2.99070896e-03
 -2.13950317e-04  1.95105673e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:58 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5243281        1
[INPUT] 0    0    [1    /1   ]  7618.06785653        1
[INPUT] 0    0    [1    /1   ]  3617.8832879         1
[INPUT] 0    0    [1    /1   ]  1612.61795219        1
[INPUT] 0    0    [1    /1   ]  240.049449541        1
[INPUT] 0    0    [1    /1   ]  52.2037566761        1
[INPUT] 0    0    [1    /1   ]  4.60258812765        1
[INPUT] 0    0    [1    /1   ]  0.398807949635       1
[INPUT] 1    0    [1    /1   ]  1362.77992052        1
[INPUT] 1    0    [1    /1   ]  665.001921812        1
[INPUT] 1    0    [1    /1   ]  302.342637277        1
[INPUT] 1    0    [1    /1   ]  315.284742212        1
[INPUT] 1    0    [1    /1   ]  65.556812114         1
[INPUT] 1    0    [1    /1   ]  7.80400173937        1
[INPUT] 1    0    [1    /1   ]  21.5407184643        1
[INPUT] 1    0    [1    /1   ]  0.786458681816       1
[INPUT] 1    0    [1    /1   ]  2.97511158134        1
[INPUT] 1    0    [1    /1   ]  0.225102497603       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.52432805523, 1.0]], [0, [7618.067856534924, 1.0]], [0, [3617.8832878969038, 1.0]], [0, [1612.6179521878046, 1.0]], [0, [240.04944954130798, 1.0]], [0, [52.20375667610296, 1.0]], [0, [4.602588127652958, 1.0]], [0, [0.3988079496347552, 1.0]], [1, [1362.7799205152764, 1.0]], [1, [665.0019218115722, 1.0]], [1, [302.3426372771184, 1.0]], [1, [315.28474221231903, 1.0]], [1, [65.55681211403774, 1.0]], [1, [7.804001739373531, 1.0]], [1, [21.540718464280502, 1.0]], [1, [0.7864586818163953, 1.0]], [1, [2.9751115813413143, 1.0]], [1, [0.22510249760306325, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52432806]
bas 1, expnt(s) = [7618.06785653]
bas 2, expnt(s) = [3617.8832879]
bas 3, expnt(s) = [1612.61795219]
bas 4, expnt(s) = [240.04944954]
bas 5, expnt(s) = [52.20375668]
bas 6, expnt(s) = [4.60258813]
bas 7, expnt(s) = [0.39880795]
bas 8, expnt(s) = [1362.77992052]
bas 9, expnt(s) = [665.00192181]
bas 10, expnt(s) = [302.34263728]
bas 11, expnt(s) = [315.28474221]
bas 12, expnt(s) = [65.55681211]
bas 13, expnt(s) = [7.80400174]
bas 14, expnt(s) = [21.54071846]
bas 15, expnt(s) = [0.78645868]
bas 16, expnt(s) = [2.97511158]
bas 17, expnt(s) = [0.2251025]
CPU time:       360.95
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825243e+04 5.20024328e+03 7.61806786e+03 2.06014909e+03
 3.61788329e+03 1.17857151e+03 1.61261795e+03 6.42929927e+02
 2.40049450e+02 1.54077974e+02 5.22037567e+01 4.90672075e+01
 4.60258813e+00 7.93901475e+00 3.98807950e-01 1.26790840e+00
 1.36277992e+03 2.41555288e+04 6.65001922e+02 9.85174173e+03
 3.02342637e+02 3.67797386e+03 3.15284742e+02 3.87581541e+03
 6.55568121e+01 5.44197667e+02 7.80400174e+00 3.80523155e+01
 2.15407185e+01 1.35381594e+02 7.86458682e-01 2.16062443e+00
 2.97511158e+00 1.13989137e+01 2.25102498e-01 4.52334575e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973251397124095
cond(S) = 111229.85460465265
E1 = -727.5559247146043  E_coul = 203.1293435174959
init E= -524.426581197108
    CPU time for initialize scf      0.16 sec, wall time      0.04 sec
  HOMO = -0.559424004465392  LUMO = 1.04857123142136
  mo_energy =
[-1.17869485e+02 -1.20945133e+01 -9.44645136e+00 -9.44645136e+00
 -9.44645136e+00 -1.23026652e+00 -5.59424004e-01 -5.59424004e-01
 -5.59424004e-01  1.04857123e+00  1.04857123e+00  1.04857123e+00
  7.82241156e+00  7.82241156e+00  7.82241156e+00  3.61311393e+01
  3.61311393e+01  3.61311393e+01  1.38623900e+02  1.38623900e+02
  1.38623900e+02  1.83901174e+02  5.01713371e+02  5.01713371e+02
  5.01713371e+02  1.35829941e+03  1.35829941e+03  1.35829941e+03
  1.91335793e+03  3.05627813e+03  3.05627813e+03  3.05627813e+03
  6.67813527e+03  6.67813527e+03  6.67813527e+03  8.26290512e+03
  2.46434357e+04  7.54369719e+04]
E1 = -727.3928419408978  E_coul = 201.83877930262454
cycle= 1 E= -525.554062638273  delta_E= -1.13  |g|= 0.181  |ddm|= 0.342
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460743
diis-c [-0.21228372  1.        ]
  HOMO = -0.572188341696888  LUMO = 1.04154228505689
  mo_energy =
[-1.18108272e+02 -1.21822199e+01 -9.53310759e+00 -9.53310759e+00
 -9.53310759e+00 -1.25136744e+00 -5.72188342e-01 -5.72188342e-01
 -5.72188342e-01  1.04154229e+00  1.04154229e+00  1.04154229e+00
  7.77226904e+00  7.77226904e+00  7.77226904e+00  3.60349712e+01
  3.60349712e+01  3.60349712e+01  1.38464491e+02  1.38464491e+02
  1.38464491e+02  1.83714266e+02  5.01489712e+02  5.01489712e+02
  5.01489712e+02  1.35802845e+03  1.35802845e+03  1.35802845e+03
  1.91296767e+03  3.05594721e+03  3.05594721e+03  3.05594721e+03
  6.67769016e+03  6.67769016e+03  6.67769016e+03  8.26237808e+03
  2.46428155e+04  7.54362608e+04]
E1 = -727.5949235112702  E_coul = 202.04068532291666
cycle= 2 E= -525.554238188354  delta_E= -0.000176  |g|= 0.0149  |ddm|= 0.0139
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0304548
diis-c [-7.21450752e-04  3.02632534e-02  9.69736747e-01]
  HOMO = -0.569595464278856  LUMO = 1.04359736208141
  mo_energy =
[-1.18079033e+02 -1.21680236e+01 -9.51870226e+00 -9.51870226e+00
 -9.51870226e+00 -1.24788524e+00 -5.69595464e-01 -5.69595464e-01
 -5.69595464e-01  1.04359736e+00  1.04359736e+00  1.04359736e+00
  7.78035822e+00  7.78035822e+00  7.78035822e+00  3.60503439e+01
  3.60503439e+01  3.60503439e+01  1.38487832e+02  1.38487832e+02
  1.38487832e+02  1.83742379e+02  5.01518508e+02  5.01518508e+02
  5.01518508e+02  1.35805924e+03  1.35805924e+03  1.35805924e+03
  1.91299987e+03  3.05597902e+03  3.05597902e+03  3.05597902e+03
  6.67772251e+03  6.67772251e+03  6.67772251e+03  8.26241064e+03
  2.46428480e+04  7.54362932e+04]
E1 = -727.5531567731551  E_coul = 201.99891290917438
cycle= 3 E= -525.554243863981  delta_E= -5.68e-06  |g|= 0.00209  |ddm|= 0.00361
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00443891
diis-c [-8.49676649e-08 -7.44247029e-04  1.22594074e-01  8.78150173e-01]
  HOMO = -0.570108178620954  LUMO = 1.04320269089901
  mo_energy =
[-1.18083016e+02 -1.21702442e+01 -9.52096662e+00 -9.52096662e+00
 -9.52096662e+00 -1.24856045e+00 -5.70108179e-01 -5.70108179e-01
 -5.70108179e-01  1.04320269e+00  1.04320269e+00  1.04320269e+00
  7.77895531e+00  7.77895531e+00  7.77895531e+00  3.60479869e+01
  3.60479869e+01  3.60479869e+01  1.38484534e+02  1.38484534e+02
  1.38484534e+02  1.83738575e+02  5.01514583e+02  5.01514583e+02
  5.01514583e+02  1.35805507e+03  1.35805507e+03  1.35805507e+03
  1.91299548e+03  3.05597471e+03  3.05597471e+03  3.05597471e+03
  6.67771807e+03  6.67771807e+03  6.67771807e+03  8.26240612e+03
  2.46428435e+04  7.54362886e+04]
E1 = -727.55942904646  E_coul = 202.00518502176632
cycle= 4 E= -525.554244024694  delta_E= -1.61e-07  |g|= 3.68e-05  |ddm|= 0.000586
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.60342e-05
diis-c [-3.79305230e-10 -2.63864078e-05  3.92672977e-03  4.15224827e-02
  9.54577174e-01]
  HOMO = -0.570086793087819  LUMO = 1.04321875052624
  mo_energy =
[-1.18082932e+02 -1.21701743e+01 -9.52089604e+00 -9.52089604e+00
 -9.52089604e+00 -1.24853258e+00 -5.70086793e-01 -5.70086793e-01
 -5.70086793e-01  1.04321875e+00  1.04321875e+00  1.04321875e+00
  7.77900621e+00  7.77900621e+00  7.77900621e+00  3.60480567e+01
  3.60480567e+01  3.60480567e+01  1.38484614e+02  1.38484614e+02
  1.38484614e+02  1.83738659e+02  5.01514666e+02  5.01514666e+02
  5.01514666e+02  1.35805516e+03  1.35805516e+03  1.35805516e+03
  1.91299556e+03  3.05597479e+03  3.05597479e+03  3.05597479e+03
  6.67771816e+03  6.67771816e+03  6.67771816e+03  8.26240620e+03
  2.46428435e+04  7.54362887e+04]
E1 = -727.5592532848389  E_coul = 202.0050092600314
cycle= 5 E= -525.554244024808  delta_E= -1.14e-10  |g|= 2.32e-06  |ddm|= 1.95e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5592532848389  E_coul = 202.0050092600314
  HOMO = -0.570088075008087  LUMO = 1.04321778802611
  mo_energy =
[-1.18082939e+02 -1.21701787e+01 -9.52090054e+00 -9.52090054e+00
 -9.52090054e+00 -1.24853425e+00 -5.70088075e-01 -5.70088075e-01
 -5.70088075e-01  1.04321779e+00  1.04321779e+00  1.04321779e+00
  7.77900308e+00  7.77900308e+00  7.77900308e+00  3.60480521e+01
  3.60480521e+01  3.60480521e+01  1.38484608e+02  1.38484608e+02
  1.38484608e+02  1.83738653e+02  5.01514660e+02  5.01514660e+02
  5.01514660e+02  1.35805515e+03  1.35805515e+03  1.35805515e+03
  1.91299556e+03  3.05597478e+03  3.05597478e+03  3.05597478e+03
  6.67771815e+03  6.67771815e+03  6.67771815e+03  8.26240619e+03
  2.46428435e+04  7.54362887e+04]
E1 = -727.5592648577734  E_coul = 202.00502083296368
Extra cycle  E= -525.55424402481  delta_E= -2.27e-12  |g|= 5.74e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.35 sec, wall time      0.24 sec
exp = [2.61825243e+04 7.61806786e+03 3.61788329e+03 1.61261795e+03
 2.40049450e+02 5.22037567e+01 4.60258813e+00 3.98807950e-01
 1.36277992e+03 6.65001922e+02 3.02342637e+02 3.15284742e+02
 6.55568121e+01 7.80400174e+00 2.15407185e+01 7.86458682e-01
 2.97511158e+00 2.25102498e-01]
E = -525.5542440248098
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:25:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5243281        1
[INPUT] 0    0    [1    /1   ]  7618.06785653        1
[INPUT] 0    0    [1    /1   ]  3617.8832879         1
[INPUT] 0    0    [1    /1   ]  1612.61795219        1
[INPUT] 0    0    [1    /1   ]  240.049449541        1
[INPUT] 0    0    [1    /1   ]  52.2037566761        1
[INPUT] 0    0    [1    /1   ]  4.60258812765        1
[INPUT] 0    0    [1    /1   ]  0.398807949635       1
[INPUT] 1    0    [1    /1   ]  1362.77992052        1
[INPUT] 1    0    [1    /1   ]  665.001921812        1
[INPUT] 1    0    [1    /1   ]  302.342637277        1
[INPUT] 1    0    [1    /1   ]  315.284742212        1
[INPUT] 1    0    [1    /1   ]  65.556812114         1
[INPUT] 1    0    [1    /1   ]  7.80400173937        1
[INPUT] 1    0    [1    /1   ]  21.5407184643        1
[INPUT] 1    0    [1    /1   ]  0.786458681816       1
[INPUT] 1    0    [1    /1   ]  2.97511158134        1
[INPUT] 1    0    [1    /1   ]  0.225102497603       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.52432805523, 1.0]], [0, [7618.067856534924, 1.0]], [0, [3617.8832878969038, 1.0]], [0, [1612.6179521878046, 1.0]], [0, [240.04944954130798, 1.0]], [0, [52.20375667610296, 1.0]], [0, [4.602588127652958, 1.0]], [0, [0.3988079496347552, 1.0]], [1, [1362.7799205152764, 1.0]], [1, [665.0019218115722, 1.0]], [1, [302.3426372771184, 1.0]], [1, [315.28474221231903, 1.0]], [1, [65.55681211403774, 1.0]], [1, [7.804001739373531, 1.0]], [1, [21.540718464280502, 1.0]], [1, [0.7864586818163953, 1.0]], [1, [2.9751115813413143, 1.0]], [1, [0.22510249760306325, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52432806]
bas 1, expnt(s) = [7618.06785653]
bas 2, expnt(s) = [3617.8832879]
bas 3, expnt(s) = [1612.61795219]
bas 4, expnt(s) = [240.04944954]
bas 5, expnt(s) = [52.20375668]
bas 6, expnt(s) = [4.60258813]
bas 7, expnt(s) = [0.39880795]
bas 8, expnt(s) = [1362.77992052]
bas 9, expnt(s) = [665.00192181]
bas 10, expnt(s) = [302.34263728]
bas 11, expnt(s) = [315.28474221]
bas 12, expnt(s) = [65.55681211]
bas 13, expnt(s) = [7.80400174]
bas 14, expnt(s) = [21.54071846]
bas 15, expnt(s) = [0.78645868]
bas 16, expnt(s) = [2.97511158]
bas 17, expnt(s) = [0.2251025]
CPU time:       361.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825243e+04 5.20024328e+03 7.61806786e+03 2.06014909e+03
 3.61788329e+03 1.17857151e+03 1.61261795e+03 6.42929927e+02
 2.40049450e+02 1.54077974e+02 5.22037567e+01 4.90672075e+01
 4.60258813e+00 7.93901475e+00 3.98807950e-01 1.26790840e+00
 1.36277992e+03 2.41555288e+04 6.65001922e+02 9.85174173e+03
 3.02342637e+02 3.67797386e+03 3.15284742e+02 3.87581541e+03
 6.55568121e+01 5.44197667e+02 7.80400174e+00 3.80523155e+01
 2.15407185e+01 1.35381594e+02 7.86458682e-01 2.16062443e+00
 2.97511158e+00 1.13989137e+01 2.25102498e-01 4.52334575e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973251397124095
cond(S) = 111229.85460465265
E1 = -727.5559247146043  E_coul = 203.1293435174959
init E= -524.426581197108
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.559424004465392  LUMO = 1.04857123142136
  mo_energy =
[-1.17869485e+02 -1.20945133e+01 -9.44645136e+00 -9.44645136e+00
 -9.44645136e+00 -1.23026652e+00 -5.59424004e-01 -5.59424004e-01
 -5.59424004e-01  1.04857123e+00  1.04857123e+00  1.04857123e+00
  7.82241156e+00  7.82241156e+00  7.82241156e+00  3.61311393e+01
  3.61311393e+01  3.61311393e+01  1.38623900e+02  1.38623900e+02
  1.38623900e+02  1.83901174e+02  5.01713371e+02  5.01713371e+02
  5.01713371e+02  1.35829941e+03  1.35829941e+03  1.35829941e+03
  1.91335793e+03  3.05627813e+03  3.05627813e+03  3.05627813e+03
  6.67813527e+03  6.67813527e+03  6.67813527e+03  8.26290512e+03
  2.46434357e+04  7.54369719e+04]
E1 = -727.3928419408978  E_coul = 201.83877930262454
cycle= 1 E= -525.554062638273  delta_E= -1.13  |g|= 0.181  |ddm|= 0.342
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460743
diis-c [-0.21228372  1.        ]
  HOMO = -0.572188341696888  LUMO = 1.04154228505689
  mo_energy =
[-1.18108272e+02 -1.21822199e+01 -9.53310759e+00 -9.53310759e+00
 -9.53310759e+00 -1.25136744e+00 -5.72188342e-01 -5.72188342e-01
 -5.72188342e-01  1.04154229e+00  1.04154229e+00  1.04154229e+00
  7.77226904e+00  7.77226904e+00  7.77226904e+00  3.60349712e+01
  3.60349712e+01  3.60349712e+01  1.38464491e+02  1.38464491e+02
  1.38464491e+02  1.83714266e+02  5.01489712e+02  5.01489712e+02
  5.01489712e+02  1.35802845e+03  1.35802845e+03  1.35802845e+03
  1.91296767e+03  3.05594721e+03  3.05594721e+03  3.05594721e+03
  6.67769016e+03  6.67769016e+03  6.67769016e+03  8.26237808e+03
  2.46428155e+04  7.54362608e+04]
E1 = -727.5949235112702  E_coul = 202.04068532291666
cycle= 2 E= -525.554238188354  delta_E= -0.000176  |g|= 0.0149  |ddm|= 0.0139
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0304548
diis-c [-7.21450752e-04  3.02632534e-02  9.69736747e-01]
  HOMO = -0.569595464278856  LUMO = 1.04359736208141
  mo_energy =
[-1.18079033e+02 -1.21680236e+01 -9.51870226e+00 -9.51870226e+00
 -9.51870226e+00 -1.24788524e+00 -5.69595464e-01 -5.69595464e-01
 -5.69595464e-01  1.04359736e+00  1.04359736e+00  1.04359736e+00
  7.78035822e+00  7.78035822e+00  7.78035822e+00  3.60503439e+01
  3.60503439e+01  3.60503439e+01  1.38487832e+02  1.38487832e+02
  1.38487832e+02  1.83742379e+02  5.01518508e+02  5.01518508e+02
  5.01518508e+02  1.35805924e+03  1.35805924e+03  1.35805924e+03
  1.91299987e+03  3.05597902e+03  3.05597902e+03  3.05597902e+03
  6.67772251e+03  6.67772251e+03  6.67772251e+03  8.26241064e+03
  2.46428480e+04  7.54362932e+04]
E1 = -727.5531567731551  E_coul = 201.99891290917438
cycle= 3 E= -525.554243863981  delta_E= -5.68e-06  |g|= 0.00209  |ddm|= 0.00361
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00443891
diis-c [-8.49676649e-08 -7.44247029e-04  1.22594074e-01  8.78150173e-01]
  HOMO = -0.570108178620954  LUMO = 1.04320269089901
  mo_energy =
[-1.18083016e+02 -1.21702442e+01 -9.52096662e+00 -9.52096662e+00
 -9.52096662e+00 -1.24856045e+00 -5.70108179e-01 -5.70108179e-01
 -5.70108179e-01  1.04320269e+00  1.04320269e+00  1.04320269e+00
  7.77895531e+00  7.77895531e+00  7.77895531e+00  3.60479869e+01
  3.60479869e+01  3.60479869e+01  1.38484534e+02  1.38484534e+02
  1.38484534e+02  1.83738575e+02  5.01514583e+02  5.01514583e+02
  5.01514583e+02  1.35805507e+03  1.35805507e+03  1.35805507e+03
  1.91299548e+03  3.05597471e+03  3.05597471e+03  3.05597471e+03
  6.67771807e+03  6.67771807e+03  6.67771807e+03  8.26240612e+03
  2.46428435e+04  7.54362886e+04]
E1 = -727.55942904646  E_coul = 202.00518502176632
cycle= 4 E= -525.554244024694  delta_E= -1.61e-07  |g|= 3.68e-05  |ddm|= 0.000586
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.60342e-05
diis-c [-3.79305230e-10 -2.63864078e-05  3.92672977e-03  4.15224827e-02
  9.54577174e-01]
  HOMO = -0.570086793087819  LUMO = 1.04321875052624
  mo_energy =
[-1.18082932e+02 -1.21701743e+01 -9.52089604e+00 -9.52089604e+00
 -9.52089604e+00 -1.24853258e+00 -5.70086793e-01 -5.70086793e-01
 -5.70086793e-01  1.04321875e+00  1.04321875e+00  1.04321875e+00
  7.77900621e+00  7.77900621e+00  7.77900621e+00  3.60480567e+01
  3.60480567e+01  3.60480567e+01  1.38484614e+02  1.38484614e+02
  1.38484614e+02  1.83738659e+02  5.01514666e+02  5.01514666e+02
  5.01514666e+02  1.35805516e+03  1.35805516e+03  1.35805516e+03
  1.91299556e+03  3.05597479e+03  3.05597479e+03  3.05597479e+03
  6.67771816e+03  6.67771816e+03  6.67771816e+03  8.26240620e+03
  2.46428435e+04  7.54362887e+04]
E1 = -727.5592532848389  E_coul = 202.0050092600314
cycle= 5 E= -525.554244024808  delta_E= -1.14e-10  |g|= 2.32e-06  |ddm|= 1.95e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5592532848389  E_coul = 202.0050092600314
  HOMO = -0.570088075008087  LUMO = 1.04321778802611
  mo_energy =
[-1.18082939e+02 -1.21701787e+01 -9.52090054e+00 -9.52090054e+00
 -9.52090054e+00 -1.24853425e+00 -5.70088075e-01 -5.70088075e-01
 -5.70088075e-01  1.04321779e+00  1.04321779e+00  1.04321779e+00
  7.77900308e+00  7.77900308e+00  7.77900308e+00  3.60480521e+01
  3.60480521e+01  3.60480521e+01  1.38484608e+02  1.38484608e+02
  1.38484608e+02  1.83738653e+02  5.01514660e+02  5.01514660e+02
  5.01514660e+02  1.35805515e+03  1.35805515e+03  1.35805515e+03
  1.91299556e+03  3.05597478e+03  3.05597478e+03  3.05597478e+03
  6.67771815e+03  6.67771815e+03  6.67771815e+03  8.26240619e+03
  2.46428435e+04  7.54362887e+04]
E1 = -727.5592648577734  E_coul = 202.00502083296368
Extra cycle  E= -525.55424402481  delta_E= -2.27e-12  |g|= 5.74e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 111229.85460465265
E1 = -727.5592648577734  E_coul = 202.00502083296368
init E= -525.55424402481
    CPU time for initialize scf      1.18 sec, wall time      0.21 sec
  HOMO = -0.570087855022103  LUMO = 1.04321795573711
  mo_energy =
[-1.18082937e+02 -1.21701779e+01 -9.52089967e+00 -9.52089967e+00
 -9.52089967e+00 -1.24853396e+00 -5.70087855e-01 -5.70087855e-01
 -5.70087855e-01  1.04321796e+00  1.04321796e+00  1.04321796e+00
  7.77900365e+00  7.77900365e+00  7.77900365e+00  3.60480530e+01
  3.60480530e+01  3.60480530e+01  1.38484609e+02  1.38484609e+02
  1.38484609e+02  1.83738654e+02  5.01514662e+02  5.01514662e+02
  5.01514662e+02  1.35805515e+03  1.35805515e+03  1.35805515e+03
  1.91299556e+03  3.05597478e+03  3.05597478e+03  3.05597478e+03
  6.67771815e+03  6.67771815e+03  6.67771815e+03  8.26240619e+03
  2.46428435e+04  7.54362887e+04]
E1 = -727.5592625269303  E_coul = 202.00501850211876
cycle= 1 E= -525.554244024812  delta_E= -1.71e-12  |g|= 1.24e-07  |ddm|= 2.3e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.5592625269303  E_coul = 202.00501850211876
  HOMO = -0.570087897099586  LUMO = 1.04321792354646
  mo_energy =
[-1.18082937e+02 -1.21701781e+01 -9.52089984e+00 -9.52089984e+00
 -9.52089984e+00 -1.24853402e+00 -5.70087897e-01 -5.70087897e-01
 -5.70087897e-01  1.04321792e+00  1.04321792e+00  1.04321792e+00
  7.77900354e+00  7.77900354e+00  7.77900354e+00  3.60480529e+01
  3.60480529e+01  3.60480529e+01  1.38484609e+02  1.38484609e+02
  1.38484609e+02  1.83738654e+02  5.01514661e+02  5.01514661e+02
  5.01514661e+02  1.35805515e+03  1.35805515e+03  1.35805515e+03
  1.91299556e+03  3.05597478e+03  3.05597478e+03  3.05597478e+03
  6.67771815e+03  6.67771815e+03  6.67771815e+03  8.26240619e+03
  2.46428435e+04  7.54362887e+04]
E1 = -727.5592630012667  E_coul = 202.00501897645705
Extra cycle  E= -525.55424402481  delta_E= 1.93e-12  |g|= 2.59e-08  |ddm|= 4.59e-08
    CPU time for scf_cycle      1.31 sec, wall time      0.34 sec
exp = [2.61825243e+04 7.61806786e+03 3.61788329e+03 1.61261795e+03
 2.40049450e+02 5.22037567e+01 4.60258813e+00 3.98807950e-01
 1.36277992e+03 6.65001922e+02 3.02342637e+02 3.15284742e+02
 6.55568121e+01 7.80400174e+00 2.15407185e+01 7.86458682e-01
 2.97511158e+00 2.25102498e-01]
grad_E = [-1.98921619e-06  2.16820972e-05  4.29269751e-05  6.72713925e-04
  1.73313316e-04 -2.15540485e-04  2.02951099e-04  9.43892132e-04
 -6.36597581e-07  2.86064312e-06  1.19513024e-05  1.02672454e-05
  2.65185673e-04  2.55149463e-03 -8.93437272e-04 -3.88485451e-03
 -9.78047973e-04  3.22689784e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:03 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.525127         1
[INPUT] 0    0    [1    /1   ]  7618.05917247        1
[INPUT] 0    0    [1    /1   ]  3617.86613124        1
[INPUT] 0    0    [1    /1   ]  1612.34829351        1
[INPUT] 0    0    [1    /1   ]  239.977516346        1
[INPUT] 0    0    [1    /1   ]  52.1865212783        1
[INPUT] 0    0    [1    /1   ]  4.60244328963        1
[INPUT] 0    0    [1    /1   ]  0.398787476545       1
[INPUT] 1    0    [1    /1   ]  1362.78029194        1
[INPUT] 1    0    [1    /1   ]  665.001775363        1
[INPUT] 1    0    [1    /1   ]  302.343470677        1
[INPUT] 1    0    [1    /1   ]  315.285597516        1
[INPUT] 1    0    [1    /1   ]  65.3537474488        1
[INPUT] 1    0    [1    /1   ]  7.83898391592        1
[INPUT] 1    0    [1    /1   ]  21.509126495         1
[INPUT] 1    0    [1    /1   ]  0.787687446611       1
[INPUT] 1    0    [1    /1   ]  2.99138545063        1
[INPUT] 1    0    [1    /1   ]  0.225413718253       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.525127016448, 1.0]], [0, [7618.059172465838, 1.0]], [0, [3617.866131242564, 1.0]], [0, [1612.348293512567, 1.0]], [0, [239.97751634624257, 1.0]], [0, [52.186521278317606, 1.0]], [0, [4.602443289633977, 1.0]], [0, [0.3987874765453469, 1.0]], [1, [1362.7802919392348, 1.0]], [1, [665.0017753627864, 1.0]], [1, [302.3434706770634, 1.0]], [1, [315.2855975162525, 1.0]], [1, [65.35374744879653, 1.0]], [1, [7.83898391592322, 1.0]], [1, [21.50912649502399, 1.0]], [1, [0.7876874466114481, 1.0]], [1, [2.9913854506331985, 1.0]], [1, [0.22541371825312567, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52512702]
bas 1, expnt(s) = [7618.05917247]
bas 2, expnt(s) = [3617.86613124]
bas 3, expnt(s) = [1612.34829351]
bas 4, expnt(s) = [239.97751635]
bas 5, expnt(s) = [52.18652128]
bas 6, expnt(s) = [4.60244329]
bas 7, expnt(s) = [0.39878748]
bas 8, expnt(s) = [1362.78029194]
bas 9, expnt(s) = [665.00177536]
bas 10, expnt(s) = [302.34347068]
bas 11, expnt(s) = [315.28559752]
bas 12, expnt(s) = [65.35374745]
bas 13, expnt(s) = [7.83898392]
bas 14, expnt(s) = [21.5091265]
bas 15, expnt(s) = [0.78768745]
bas 16, expnt(s) = [2.99138545]
bas 17, expnt(s) = [0.22541372]
CPU time:       367.67
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825251e+04 5.20024339e+03 7.61805917e+03 2.06014733e+03
 3.61786613e+03 1.17856732e+03 1.61234829e+03 6.42849294e+02
 2.39977516e+02 1.54043345e+02 5.21865213e+01 4.90550571e+01
 4.60244329e+00 7.93882738e+00 3.98787477e-01 1.26785958e+00
 1.36278029e+03 2.41555371e+04 6.65001775e+02 9.85173902e+03
 3.02343471e+02 3.67798654e+03 3.15285598e+02 3.87582855e+03
 6.53537474e+01 5.42091393e+02 7.83898392e+00 3.82656513e+01
 2.15091265e+01 1.35133448e+02 7.87687447e-01 2.16484495e+00
 2.99138545e+00 1.14769070e+01 2.25413718e-01 4.53116442e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97320741937148
cond(S) = 110961.11397177873
E1 = -727.5555472411012  E_coul = 203.12849535322218
init E= -524.427051887879
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.559406527640569  LUMO = 1.05091894177759
  mo_energy =
[-1.17869817e+02 -1.20944600e+01 -9.44653769e+00 -9.44653769e+00
 -9.44653769e+00 -1.23026571e+00 -5.59406528e-01 -5.59406528e-01
 -5.59406528e-01  1.05091894e+00  1.05091894e+00  1.05091894e+00
  7.86728059e+00  7.86728059e+00  7.86728059e+00  3.62561817e+01
  3.62561817e+01  3.62561817e+01  1.38528440e+02  1.38528440e+02
  1.38528440e+02  1.83810394e+02  5.01201025e+02  5.01201025e+02
  5.01201025e+02  1.35765188e+03  1.35765188e+03  1.35765188e+03
  1.91292309e+03  3.05560880e+03  3.05560880e+03  3.05560880e+03
  6.67749836e+03  6.67749836e+03  6.67749836e+03  8.26200905e+03
  2.46421963e+04  7.54356194e+04]
E1 = -727.3929236199068  E_coul = 201.838741847388
cycle= 1 E= -525.554181772519  delta_E= -1.13  |g|= 0.181  |ddm|= 0.348
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460958
diis-c [-0.21248214  1.        ]
  HOMO = -0.57210324139704  LUMO = 1.04390804959238
  mo_energy =
[-1.18108694e+02 -1.21820996e+01 -9.53314502e+00 -9.53314502e+00
 -9.53314502e+00 -1.25128753e+00 -5.72103241e-01 -5.72103241e-01
 -5.72103241e-01  1.04390805e+00  1.04390805e+00  1.04390805e+00
  7.81700554e+00  7.81700554e+00  7.81700554e+00  3.61600347e+01
  3.61600347e+01  3.61600347e+01  1.38369194e+02  1.38369194e+02
  1.38369194e+02  1.83623470e+02  5.00977285e+02  5.00977285e+02
  5.00977285e+02  1.35738067e+03  1.35738067e+03  1.35738067e+03
  1.91253236e+03  3.05527749e+03  3.05527749e+03  3.05527749e+03
  6.67705270e+03  6.67705270e+03  6.67705270e+03  8.26148137e+03
  2.46415754e+04  7.54349075e+04]
E1 = -727.5948573425561  E_coul = 202.04050006376093
cycle= 2 E= -525.554357278795  delta_E= -0.000176  |g|= 0.0149  |ddm|= 0.014
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0304617
diis-c [-7.21076538e-04  3.03057208e-02  9.69694279e-01]
  HOMO = -0.569512286625422  LUMO = 1.04596699054444
  mo_energy =
[-1.18079468e+02 -1.21679167e+01 -9.51875325e+00 -9.51875325e+00
 -9.51875325e+00 -1.24780853e+00 -5.69512287e-01 -5.69512287e-01
 -5.69512287e-01  1.04596699e+00  1.04596699e+00  1.04596699e+00
  7.82511552e+00  7.82511552e+00  7.82511552e+00  3.61753968e+01
  3.61753968e+01  3.61753968e+01  1.38392502e+02  1.38392502e+02
  1.38392502e+02  1.83651570e+02  5.01006065e+02  5.01006065e+02
  5.01006065e+02  1.35741145e+03  1.35741145e+03  1.35741145e+03
  1.91256454e+03  3.05530928e+03  3.05530928e+03  3.05530928e+03
  6.67708504e+03  6.67708504e+03  6.67708504e+03  8.26151392e+03
  2.46416079e+04  7.54349400e+04]
E1 = -727.553153949074  E_coul = 201.99879100409717
cycle= 3 E= -525.554362944977  delta_E= -5.67e-06  |g|= 0.00209  |ddm|= 0.0036
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00443616
diis-c [-8.45447161e-08 -7.44995913e-04  1.22486618e-01  8.78258378e-01]
  HOMO = -0.570023662194197  LUMO = 1.04557236709578
  mo_energy =
[-1.18083445e+02 -1.21701333e+01 -9.52101360e+00 -9.52101360e+00
 -9.52101360e+00 -1.24848201e+00 -5.70023662e-01 -5.70023662e-01
 -5.70023662e-01  1.04557237e+00  1.04557237e+00  1.04557237e+00
  7.82371130e+00  7.82371130e+00  7.82371130e+00  3.61730434e+01
  3.61730434e+01  3.61730434e+01  1.38389211e+02  1.38389211e+02
  1.38389211e+02  1.83647772e+02  5.01002146e+02  5.01002146e+02
  5.01002146e+02  1.35740729e+03  1.35740729e+03  1.35740729e+03
  1.91256016e+03  3.05530498e+03  3.05530498e+03  3.05530498e+03
  6.67708060e+03  6.67708060e+03  6.67708060e+03  8.26150940e+03
  2.46416034e+04  7.54349354e+04]
E1 = -727.5594103025522  E_coul = 202.00504719753846
cycle= 4 E= -525.554363105014  delta_E= -1.6e-07  |g|= 3.67e-05  |ddm|= 0.000585
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.57065e-05
diis-c [-3.79555564e-10 -2.63688911e-05  3.90546276e-03  4.13412835e-02
  9.54779623e-01]
  HOMO = -0.570002325931973  LUMO = 1.04558842627913
  mo_energy =
[-1.18083361e+02 -1.21700637e+01 -9.52094324e+00 -9.52094324e+00
 -9.52094324e+00 -1.24845421e+00 -5.70002326e-01 -5.70002326e-01
 -5.70002326e-01  1.04558843e+00  1.04558843e+00  1.04558843e+00
  7.82376217e+00  7.82376217e+00  7.82376217e+00  3.61731129e+01
  3.61731129e+01  3.61731129e+01  1.38389290e+02  1.38389290e+02
  1.38389290e+02  1.83647855e+02  5.01002229e+02  5.01002229e+02
  5.01002229e+02  1.35740737e+03  1.35740737e+03  1.35740737e+03
  1.91256024e+03  3.05530506e+03  3.05530506e+03  3.05530506e+03
  6.67708069e+03  6.67708069e+03  6.67708069e+03  8.26150949e+03
  2.46416034e+04  7.54349355e+04]
E1 = -727.5592353308833  E_coul = 202.00487222575512
cycle= 5 E= -525.554363105128  delta_E= -1.14e-10  |g|= 2.33e-06  |ddm|= 1.94e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5592353308833  E_coul = 202.00487222575512
  HOMO = -0.570003607264582  LUMO = 1.04558746194108
  mo_energy =
[-1.18083367e+02 -1.21700681e+01 -9.52094775e+00 -9.52094775e+00
 -9.52094775e+00 -1.24845588e+00 -5.70003607e-01 -5.70003607e-01
 -5.70003607e-01  1.04558746e+00  1.04558746e+00  1.04558746e+00
  7.82375904e+00  7.82375904e+00  7.82375904e+00  3.61731084e+01
  3.61731084e+01  3.61731084e+01  1.38389285e+02  1.38389285e+02
  1.38389285e+02  1.83647849e+02  5.01002223e+02  5.01002223e+02
  5.01002223e+02  1.35740736e+03  1.35740736e+03  1.35740736e+03
  1.91256023e+03  3.05530505e+03  3.05530505e+03  3.05530505e+03
  6.67708068e+03  6.67708068e+03  6.67708068e+03  8.26150948e+03
  2.46416034e+04  7.54349354e+04]
E1 = -727.5592469074742  E_coul = 202.00488380234543
Extra cycle  E= -525.554363105129  delta_E= -4.55e-13  |g|= 5.74e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
exp = [2.61825251e+04 7.61805917e+03 3.61786613e+03 1.61234829e+03
 2.39977516e+02 5.21865213e+01 4.60244329e+00 3.98787477e-01
 1.36278029e+03 6.65001775e+02 3.02343471e+02 3.15285598e+02
 6.53537474e+01 7.83898392e+00 2.15091265e+01 7.87687447e-01
 2.99138545e+00 2.25413718e-01]
E = -525.5543631051287
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:04 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.525127         1
[INPUT] 0    0    [1    /1   ]  7618.05917247        1
[INPUT] 0    0    [1    /1   ]  3617.86613124        1
[INPUT] 0    0    [1    /1   ]  1612.34829351        1
[INPUT] 0    0    [1    /1   ]  239.977516346        1
[INPUT] 0    0    [1    /1   ]  52.1865212783        1
[INPUT] 0    0    [1    /1   ]  4.60244328963        1
[INPUT] 0    0    [1    /1   ]  0.398787476545       1
[INPUT] 1    0    [1    /1   ]  1362.78029194        1
[INPUT] 1    0    [1    /1   ]  665.001775363        1
[INPUT] 1    0    [1    /1   ]  302.343470677        1
[INPUT] 1    0    [1    /1   ]  315.285597516        1
[INPUT] 1    0    [1    /1   ]  65.3537474488        1
[INPUT] 1    0    [1    /1   ]  7.83898391592        1
[INPUT] 1    0    [1    /1   ]  21.509126495         1
[INPUT] 1    0    [1    /1   ]  0.787687446611       1
[INPUT] 1    0    [1    /1   ]  2.99138545063        1
[INPUT] 1    0    [1    /1   ]  0.225413718253       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.525127016448, 1.0]], [0, [7618.059172465838, 1.0]], [0, [3617.866131242564, 1.0]], [0, [1612.348293512567, 1.0]], [0, [239.97751634624257, 1.0]], [0, [52.186521278317606, 1.0]], [0, [4.602443289633977, 1.0]], [0, [0.3987874765453469, 1.0]], [1, [1362.7802919392348, 1.0]], [1, [665.0017753627864, 1.0]], [1, [302.3434706770634, 1.0]], [1, [315.2855975162525, 1.0]], [1, [65.35374744879653, 1.0]], [1, [7.83898391592322, 1.0]], [1, [21.50912649502399, 1.0]], [1, [0.7876874466114481, 1.0]], [1, [2.9913854506331985, 1.0]], [1, [0.22541371825312567, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52512702]
bas 1, expnt(s) = [7618.05917247]
bas 2, expnt(s) = [3617.86613124]
bas 3, expnt(s) = [1612.34829351]
bas 4, expnt(s) = [239.97751635]
bas 5, expnt(s) = [52.18652128]
bas 6, expnt(s) = [4.60244329]
bas 7, expnt(s) = [0.39878748]
bas 8, expnt(s) = [1362.78029194]
bas 9, expnt(s) = [665.00177536]
bas 10, expnt(s) = [302.34347068]
bas 11, expnt(s) = [315.28559752]
bas 12, expnt(s) = [65.35374745]
bas 13, expnt(s) = [7.83898392]
bas 14, expnt(s) = [21.5091265]
bas 15, expnt(s) = [0.78768745]
bas 16, expnt(s) = [2.99138545]
bas 17, expnt(s) = [0.22541372]
CPU time:       368.22
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825251e+04 5.20024339e+03 7.61805917e+03 2.06014733e+03
 3.61786613e+03 1.17856732e+03 1.61234829e+03 6.42849294e+02
 2.39977516e+02 1.54043345e+02 5.21865213e+01 4.90550571e+01
 4.60244329e+00 7.93882738e+00 3.98787477e-01 1.26785958e+00
 1.36278029e+03 2.41555371e+04 6.65001775e+02 9.85173902e+03
 3.02343471e+02 3.67798654e+03 3.15285598e+02 3.87582855e+03
 6.53537474e+01 5.42091393e+02 7.83898392e+00 3.82656513e+01
 2.15091265e+01 1.35133448e+02 7.87687447e-01 2.16484495e+00
 2.99138545e+00 1.14769070e+01 2.25413718e-01 4.53116442e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97320741937148
cond(S) = 110961.11397177873
E1 = -727.5555472411012  E_coul = 203.12849535322218
init E= -524.427051887879
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.559406527640569  LUMO = 1.05091894177759
  mo_energy =
[-1.17869817e+02 -1.20944600e+01 -9.44653769e+00 -9.44653769e+00
 -9.44653769e+00 -1.23026571e+00 -5.59406528e-01 -5.59406528e-01
 -5.59406528e-01  1.05091894e+00  1.05091894e+00  1.05091894e+00
  7.86728059e+00  7.86728059e+00  7.86728059e+00  3.62561817e+01
  3.62561817e+01  3.62561817e+01  1.38528440e+02  1.38528440e+02
  1.38528440e+02  1.83810394e+02  5.01201025e+02  5.01201025e+02
  5.01201025e+02  1.35765188e+03  1.35765188e+03  1.35765188e+03
  1.91292309e+03  3.05560880e+03  3.05560880e+03  3.05560880e+03
  6.67749836e+03  6.67749836e+03  6.67749836e+03  8.26200905e+03
  2.46421963e+04  7.54356194e+04]
E1 = -727.3929236199068  E_coul = 201.838741847388
cycle= 1 E= -525.554181772519  delta_E= -1.13  |g|= 0.181  |ddm|= 0.348
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.460958
diis-c [-0.21248214  1.        ]
  HOMO = -0.57210324139704  LUMO = 1.04390804959238
  mo_energy =
[-1.18108694e+02 -1.21820996e+01 -9.53314502e+00 -9.53314502e+00
 -9.53314502e+00 -1.25128753e+00 -5.72103241e-01 -5.72103241e-01
 -5.72103241e-01  1.04390805e+00  1.04390805e+00  1.04390805e+00
  7.81700554e+00  7.81700554e+00  7.81700554e+00  3.61600347e+01
  3.61600347e+01  3.61600347e+01  1.38369194e+02  1.38369194e+02
  1.38369194e+02  1.83623470e+02  5.00977285e+02  5.00977285e+02
  5.00977285e+02  1.35738067e+03  1.35738067e+03  1.35738067e+03
  1.91253236e+03  3.05527749e+03  3.05527749e+03  3.05527749e+03
  6.67705270e+03  6.67705270e+03  6.67705270e+03  8.26148137e+03
  2.46415754e+04  7.54349075e+04]
E1 = -727.5948573425561  E_coul = 202.04050006376093
cycle= 2 E= -525.554357278795  delta_E= -0.000176  |g|= 0.0149  |ddm|= 0.014
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0304617
diis-c [-7.21076538e-04  3.03057208e-02  9.69694279e-01]
  HOMO = -0.569512286625422  LUMO = 1.04596699054444
  mo_energy =
[-1.18079468e+02 -1.21679167e+01 -9.51875325e+00 -9.51875325e+00
 -9.51875325e+00 -1.24780853e+00 -5.69512287e-01 -5.69512287e-01
 -5.69512287e-01  1.04596699e+00  1.04596699e+00  1.04596699e+00
  7.82511552e+00  7.82511552e+00  7.82511552e+00  3.61753968e+01
  3.61753968e+01  3.61753968e+01  1.38392502e+02  1.38392502e+02
  1.38392502e+02  1.83651570e+02  5.01006065e+02  5.01006065e+02
  5.01006065e+02  1.35741145e+03  1.35741145e+03  1.35741145e+03
  1.91256454e+03  3.05530928e+03  3.05530928e+03  3.05530928e+03
  6.67708504e+03  6.67708504e+03  6.67708504e+03  8.26151392e+03
  2.46416079e+04  7.54349400e+04]
E1 = -727.553153949074  E_coul = 201.99879100409717
cycle= 3 E= -525.554362944977  delta_E= -5.67e-06  |g|= 0.00209  |ddm|= 0.0036
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00443616
diis-c [-8.45447161e-08 -7.44995913e-04  1.22486618e-01  8.78258378e-01]
  HOMO = -0.570023662194197  LUMO = 1.04557236709578
  mo_energy =
[-1.18083445e+02 -1.21701333e+01 -9.52101360e+00 -9.52101360e+00
 -9.52101360e+00 -1.24848201e+00 -5.70023662e-01 -5.70023662e-01
 -5.70023662e-01  1.04557237e+00  1.04557237e+00  1.04557237e+00
  7.82371130e+00  7.82371130e+00  7.82371130e+00  3.61730434e+01
  3.61730434e+01  3.61730434e+01  1.38389211e+02  1.38389211e+02
  1.38389211e+02  1.83647772e+02  5.01002146e+02  5.01002146e+02
  5.01002146e+02  1.35740729e+03  1.35740729e+03  1.35740729e+03
  1.91256016e+03  3.05530498e+03  3.05530498e+03  3.05530498e+03
  6.67708060e+03  6.67708060e+03  6.67708060e+03  8.26150940e+03
  2.46416034e+04  7.54349354e+04]
E1 = -727.5594103025522  E_coul = 202.00504719753846
cycle= 4 E= -525.554363105014  delta_E= -1.6e-07  |g|= 3.67e-05  |ddm|= 0.000585
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.57065e-05
diis-c [-3.79555564e-10 -2.63688911e-05  3.90546276e-03  4.13412835e-02
  9.54779623e-01]
  HOMO = -0.570002325931973  LUMO = 1.04558842627913
  mo_energy =
[-1.18083361e+02 -1.21700637e+01 -9.52094324e+00 -9.52094324e+00
 -9.52094324e+00 -1.24845421e+00 -5.70002326e-01 -5.70002326e-01
 -5.70002326e-01  1.04558843e+00  1.04558843e+00  1.04558843e+00
  7.82376217e+00  7.82376217e+00  7.82376217e+00  3.61731129e+01
  3.61731129e+01  3.61731129e+01  1.38389290e+02  1.38389290e+02
  1.38389290e+02  1.83647855e+02  5.01002229e+02  5.01002229e+02
  5.01002229e+02  1.35740737e+03  1.35740737e+03  1.35740737e+03
  1.91256024e+03  3.05530506e+03  3.05530506e+03  3.05530506e+03
  6.67708069e+03  6.67708069e+03  6.67708069e+03  8.26150949e+03
  2.46416034e+04  7.54349355e+04]
E1 = -727.5592353308833  E_coul = 202.00487222575512
cycle= 5 E= -525.554363105128  delta_E= -1.14e-10  |g|= 2.33e-06  |ddm|= 1.94e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5592353308833  E_coul = 202.00487222575512
  HOMO = -0.570003607264582  LUMO = 1.04558746194108
  mo_energy =
[-1.18083367e+02 -1.21700681e+01 -9.52094775e+00 -9.52094775e+00
 -9.52094775e+00 -1.24845588e+00 -5.70003607e-01 -5.70003607e-01
 -5.70003607e-01  1.04558746e+00  1.04558746e+00  1.04558746e+00
  7.82375904e+00  7.82375904e+00  7.82375904e+00  3.61731084e+01
  3.61731084e+01  3.61731084e+01  1.38389285e+02  1.38389285e+02
  1.38389285e+02  1.83647849e+02  5.01002223e+02  5.01002223e+02
  5.01002223e+02  1.35740736e+03  1.35740736e+03  1.35740736e+03
  1.91256023e+03  3.05530505e+03  3.05530505e+03  3.05530505e+03
  6.67708068e+03  6.67708068e+03  6.67708068e+03  8.26150948e+03
  2.46416034e+04  7.54349354e+04]
E1 = -727.5592469074742  E_coul = 202.00488380234543
Extra cycle  E= -525.554363105129  delta_E= -4.55e-13  |g|= 5.74e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 110961.11397177873
E1 = -727.5592469074742  E_coul = 202.00488380234543
init E= -525.554363105129
    CPU time for initialize scf      0.95 sec, wall time      0.19 sec
  HOMO = -0.570003387277464  LUMO = 1.04558763006097
  mo_energy =
[-1.18083366e+02 -1.21700672e+01 -9.52094688e+00 -9.52094688e+00
 -9.52094688e+00 -1.24845559e+00 -5.70003387e-01 -5.70003387e-01
 -5.70003387e-01  1.04558763e+00  1.04558763e+00  1.04558763e+00
  7.82375961e+00  7.82375961e+00  7.82375961e+00  3.61731093e+01
  3.61731093e+01  3.61731093e+01  1.38389286e+02  1.38389286e+02
  1.38389286e+02  1.83647850e+02  5.01002224e+02  5.01002224e+02
  5.01002224e+02  1.35740737e+03  1.35740737e+03  1.35740737e+03
  1.91256024e+03  3.05530506e+03  3.05530506e+03  3.05530506e+03
  6.67708068e+03  6.67708068e+03  6.67708068e+03  8.26150948e+03
  2.46416034e+04  7.54349354e+04]
E1 = -727.5592445779611  E_coul = 202.0048814728342
cycle= 1 E= -525.554363105127  delta_E= 1.82e-12  |g|= 1.24e-07  |ddm|= 2.3e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.5592445779611  E_coul = 202.0048814728342
  HOMO = -0.570003429307112  LUMO = 1.0455875978279
  mo_energy =
[-1.18083366e+02 -1.21700674e+01 -9.52094706e+00 -9.52094706e+00
 -9.52094706e+00 -1.24845565e+00 -5.70003429e-01 -5.70003429e-01
 -5.70003429e-01  1.04558760e+00  1.04558760e+00  1.04558760e+00
  7.82375950e+00  7.82375950e+00  7.82375950e+00  3.61731091e+01
  3.61731091e+01  3.61731091e+01  1.38389286e+02  1.38389286e+02
  1.38389286e+02  1.83647850e+02  5.01002224e+02  5.01002224e+02
  5.01002224e+02  1.35740737e+03  1.35740737e+03  1.35740737e+03
  1.91256024e+03  3.05530506e+03  3.05530506e+03  3.05530506e+03
  6.67708068e+03  6.67708068e+03  6.67708068e+03  8.26150948e+03
  2.46416034e+04  7.54349354e+04]
E1 = -727.5592450516617  E_coul = 202.00488194653462
Extra cycle  E= -525.554363105127  delta_E= -2.27e-13  |g|= 2.59e-08  |ddm|= 4.58e-08
    CPU time for scf_cycle      1.07 sec, wall time      0.31 sec
exp = [2.61825251e+04 7.61805917e+03 3.61786613e+03 1.61234829e+03
 2.39977516e+02 5.21865213e+01 4.60244329e+00 3.98787477e-01
 1.36278029e+03 6.65001775e+02 3.02343471e+02 3.15285598e+02
 6.53537474e+01 7.83898392e+00 2.15091265e+01 7.87687447e-01
 2.99138545e+00 2.25413718e-01]
grad_E = [-1.98919582e-06  2.16922191e-05  4.29490412e-05  6.73390877e-04
  1.81982518e-04 -4.22846557e-04  7.11856675e-05  8.95103833e-04
 -6.34745586e-07  2.88660871e-06  1.20364692e-05  1.03486575e-05
  3.15256419e-04  4.41575063e-03 -1.52584388e-03 -4.95564533e-03
 -2.31027856e-03  5.33159686e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.527462         1
[INPUT] 0    0    [1    /1   ]  7618.03372779        1
[INPUT] 0    0    [1    /1   ]  3617.81575723        1
[INPUT] 0    0    [1    /1   ]  1611.55899647        1
[INPUT] 0    0    [1    /1   ]  239.796857385        1
[INPUT] 0    0    [1    /1   ]  52.15080204          1
[INPUT] 0    0    [1    /1   ]  4.6021474907         1
[INPUT] 0    0    [1    /1   ]  0.398732200533       1
[INPUT] 1    0    [1    /1   ]  1362.7810166         1
[INPUT] 1    0    [1    /1   ]  664.998295604        1
[INPUT] 1    0    [1    /1   ]  302.328614053        1
[INPUT] 1    0    [1    /1   ]  315.272818067        1
[INPUT] 1    0    [1    /1   ]  65.1326945136        1
[INPUT] 1    0    [1    /1   ]  7.91484540235        1
[INPUT] 1    0    [1    /1   ]  21.5082782143        1
[INPUT] 1    0    [1    /1   ]  0.790710800393       1
[INPUT] 1    0    [1    /1   ]  3.02355013026        1
[INPUT] 1    0    [1    /1   ]  0.226148142559       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.527461985796, 1.0]], [0, [7618.033727786182, 1.0]], [0, [3617.8157572293335, 1.0]], [0, [1611.5589964703267, 1.0]], [0, [239.7968573851921, 1.0]], [0, [52.150802040037746, 1.0]], [0, [4.602147490703575, 1.0]], [0, [0.39873220053300934, 1.0]], [1, [1362.7810165958153, 1.0]], [1, [664.9982956038699, 1.0]], [1, [302.32861405335046, 1.0]], [1, [315.2728180671364, 1.0]], [1, [65.13269451359113, 1.0]], [1, [7.914845402348865, 1.0]], [1, [21.50827821434458, 1.0]], [1, [0.7907108003934762, 1.0]], [1, [3.0235501302599275, 1.0]], [1, [0.22614814255918755, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52746199]
bas 1, expnt(s) = [7618.03372779]
bas 2, expnt(s) = [3617.81575723]
bas 3, expnt(s) = [1611.55899647]
bas 4, expnt(s) = [239.79685739]
bas 5, expnt(s) = [52.15080204]
bas 6, expnt(s) = [4.60214749]
bas 7, expnt(s) = [0.3987322]
bas 8, expnt(s) = [1362.7810166]
bas 9, expnt(s) = [664.9982956]
bas 10, expnt(s) = [302.32861405]
bas 11, expnt(s) = [315.27281807]
bas 12, expnt(s) = [65.13269451]
bas 13, expnt(s) = [7.9148454]
bas 14, expnt(s) = [21.50827821]
bas 15, expnt(s) = [0.7907108]
bas 16, expnt(s) = [3.02355013]
bas 17, expnt(s) = [0.22614814]
CPU time:       374.02
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825275e+04 5.20024374e+03 7.61803373e+03 2.06014217e+03
 3.61781576e+03 1.17855501e+03 1.61155900e+03 6.42613257e+02
 2.39796857e+02 1.53956362e+02 5.21508020e+01 4.90298730e+01
 4.60214749e+00 7.93844470e+00 3.98732201e-01 1.26772778e+00
 1.36278102e+03 2.41555531e+04 6.64998296e+02 9.85167458e+03
 3.02328614e+02 3.67776063e+03 3.15272818e+02 3.87563218e+03
 6.51326945e+01 5.39800396e+02 7.91484540e+00 3.87291030e+01
 2.15082782e+01 1.35126787e+02 7.90710800e-01 2.17523650e+00
 3.02355013e+00 1.16313697e+01 2.26148143e-01 4.54962576e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97309988087806
cond(S) = 110714.56462943878
E1 = -727.5541750244263  E_coul = 203.1266189439184
init E= -524.427556080508
    CPU time for initialize scf      0.69 sec, wall time      0.08 sec
  HOMO = -0.559379058359171  LUMO = 1.05655681276006
  mo_energy =
[-1.17870545e+02 -1.20943911e+01 -9.44670652e+00 -9.44670652e+00
 -9.44670652e+00 -1.23027088e+00 -5.59379058e-01 -5.59379058e-01
 -5.59379058e-01  1.05655681e+00  1.05655681e+00  1.05655681e+00
  7.96086957e+00  7.96086957e+00  7.96086957e+00  3.65626162e+01
  3.65626162e+01  3.65626162e+01  1.38700447e+02  1.38700447e+02
  1.38700447e+02  1.83603735e+02  5.00902819e+02  5.00902819e+02
  5.00902819e+02  1.35715294e+03  1.35715294e+03  1.35715294e+03
  1.91179489e+03  3.05502859e+03  3.05502859e+03  3.05502859e+03
  6.67690634e+03  6.67690634e+03  6.67690634e+03  8.25954174e+03
  2.46387211e+04  7.54318043e+04]
E1 = -727.3937346672735  E_coul = 201.83925193427115
cycle= 1 E= -525.554482733002  delta_E= -1.13  |g|= 0.181  |ddm|= 0.361
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.461427
diis-c [-0.2129151  1.       ]
  HOMO = -0.571930783967265  LUMO = 1.04957895375836
  mo_energy =
[-1.18109502e+02 -1.21818375e+01 -9.53315705e+00 -9.53315705e+00
 -9.53315705e+00 -1.25111739e+00 -5.71930784e-01 -5.71930784e-01
 -5.71930784e-01  1.04957895e+00  1.04957895e+00  1.04957895e+00
  7.91036413e+00  7.91036413e+00  7.91036413e+00  3.64664604e+01
  3.64664604e+01  3.64664604e+01  1.38541452e+02  1.38541452e+02
  1.38541452e+02  1.83416877e+02  5.00679013e+02  5.00679013e+02
  5.00679013e+02  1.35688139e+03  1.35688139e+03  1.35688139e+03
  1.91140340e+03  3.05469669e+03  3.05469669e+03  3.05469669e+03
  6.67645977e+03  6.67645977e+03  6.67645977e+03  8.25901297e+03
  2.46380990e+04  7.54310911e+04]
E1 = -727.595218835231  E_coul = 202.04056072203164
cycle= 2 E= -525.554658113199  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.014
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0304659
diis-c [-7.20100888e-04  3.03632294e-02  9.69636771e-01]
  HOMO = -0.569348231127542  LUMO = 1.05164396676334
  mo_energy =
[-1.18080314e+02 -1.21676917e+01 -9.51880260e+00 -9.51880260e+00
 -9.51880260e+00 -1.24765055e+00 -5.69348231e-01 -5.69348231e-01
 -5.69348231e-01  1.05164397e+00  1.05164397e+00  1.05164397e+00
  7.91850927e+00  7.91850927e+00  7.91850927e+00  3.64818078e+01
  3.64818078e+01  3.64818078e+01  1.38564699e+02  1.38564699e+02
  1.38564699e+02  1.83444936e+02  5.00707751e+02  5.00707751e+02
  5.00707751e+02  1.35691213e+03  1.35691213e+03  1.35691213e+03
  1.91143554e+03  3.05472844e+03  3.05472844e+03  3.05472844e+03
  6.67649208e+03  6.67649208e+03  6.67649208e+03  8.25904548e+03
  2.46381315e+04  7.54311235e+04]
E1 = -727.553666357253  E_coul = 201.99900260253278
cycle= 3 E= -525.55466375472  delta_E= -5.64e-06  |g|= 0.00208  |ddm|= 0.00359
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00442892
diis-c [-8.39270462e-08 -7.46331093e-04  1.22262692e-01  8.78483639e-01]
  HOMO = -0.569856730090268  LUMO = 1.05124926825494
  mo_energy =
[-1.18084278e+02 -1.21698994e+01 -9.52105409e+00 -9.52105409e+00
 -9.52105409e+00 -1.24832029e+00 -5.69856730e-01 -5.69856730e-01
 -5.69856730e-01  1.05124927e+00  1.05124927e+00  1.05124927e+00
  7.91710270e+00  7.91710270e+00  7.91710270e+00  3.64794606e+01
  3.64794606e+01  3.64794606e+01  1.38561422e+02  1.38561422e+02
  1.38561422e+02  1.83441151e+02  5.00703845e+02  5.00703845e+02
  5.00703845e+02  1.35690798e+03  1.35690798e+03  1.35690798e+03
  1.91143117e+03  3.05472415e+03  3.05472415e+03  3.05472415e+03
  6.67648765e+03  6.67648765e+03  6.67648765e+03  8.25904098e+03
  2.46381269e+04  7.54311189e+04]
E1 = -727.5598891734815  E_coul = 202.00522526015956
cycle= 4 E= -525.554663913322  delta_E= -1.59e-07  |g|= 3.64e-05  |ddm|= 0.000583
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.52094e-05
diis-c [-3.80554748e-10 -2.63069915e-05  3.86268950e-03  4.10163908e-02
  9.55147227e-01]
  HOMO = -0.569835470297738  LUMO = 1.05126535629858
  mo_energy =
[-1.18084195e+02 -1.21698301e+01 -9.52098408e+00 -9.52098408e+00
 -9.52098408e+00 -1.24829260e+00 -5.69835470e-01 -5.69835470e-01
 -5.69835470e-01  1.05126536e+00  1.05126536e+00  1.05126536e+00
  7.91715360e+00  7.91715360e+00  7.91715360e+00  3.64795299e+01
  3.64795299e+01  3.64795299e+01  1.38561501e+02  1.38561501e+02
  1.38561501e+02  1.83441234e+02  5.00703927e+02  5.00703927e+02
  5.00703927e+02  1.35690806e+03  1.35690806e+03  1.35690806e+03
  1.91143126e+03  3.05472423e+03  3.05472423e+03  3.05472423e+03
  6.67648774e+03  6.67648774e+03  6.67648774e+03  8.25904106e+03
  2.46381270e+04  7.54311190e+04]
E1 = -727.5597154592241  E_coul = 202.0050515457885
cycle= 5 E= -525.554663913436  delta_E= -1.14e-10  |g|= 2.34e-06  |ddm|= 1.93e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5597154592241  E_coul = 202.0050515457885
  HOMO = -0.569836751990668  LUMO = 1.05126438632099
  mo_energy =
[-1.18084201e+02 -1.21698345e+01 -9.52098860e+00 -9.52098860e+00
 -9.52098860e+00 -1.24829427e+00 -5.69836752e-01 -5.69836752e-01
 -5.69836752e-01  1.05126439e+00  1.05126439e+00  1.05126439e+00
  7.91715044e+00  7.91715044e+00  7.91715044e+00  3.64795253e+01
  3.64795253e+01  3.64795253e+01  1.38561495e+02  1.38561495e+02
  1.38561495e+02  1.83441228e+02  5.00703921e+02  5.00703921e+02
  5.00703921e+02  1.35690806e+03  1.35690806e+03  1.35690806e+03
  1.91143125e+03  3.05472422e+03  3.05472422e+03  3.05472422e+03
  6.67648773e+03  6.67648773e+03  6.67648773e+03  8.25904105e+03
  2.46381270e+04  7.54311190e+04]
E1 = -727.5597270512648  E_coul = 202.00506313782728
Extra cycle  E= -525.554663913437  delta_E= -1.82e-12  |g|= 5.76e-07  |ddm|= 1.24e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.22 sec
exp = [2.61825275e+04 7.61803373e+03 3.61781576e+03 1.61155900e+03
 2.39796857e+02 5.21508020e+01 4.60214749e+00 3.98732201e-01
 1.36278102e+03 6.64998296e+02 3.02328614e+02 3.15272818e+02
 6.51326945e+01 7.91484540e+00 2.15082782e+01 7.90710800e-01
 3.02355013e+00 2.26148143e-01]
E = -525.5546639134375
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.527462         1
[INPUT] 0    0    [1    /1   ]  7618.03372779        1
[INPUT] 0    0    [1    /1   ]  3617.81575723        1
[INPUT] 0    0    [1    /1   ]  1611.55899647        1
[INPUT] 0    0    [1    /1   ]  239.796857385        1
[INPUT] 0    0    [1    /1   ]  52.15080204          1
[INPUT] 0    0    [1    /1   ]  4.6021474907         1
[INPUT] 0    0    [1    /1   ]  0.398732200533       1
[INPUT] 1    0    [1    /1   ]  1362.7810166         1
[INPUT] 1    0    [1    /1   ]  664.998295604        1
[INPUT] 1    0    [1    /1   ]  302.328614053        1
[INPUT] 1    0    [1    /1   ]  315.272818067        1
[INPUT] 1    0    [1    /1   ]  65.1326945136        1
[INPUT] 1    0    [1    /1   ]  7.91484540235        1
[INPUT] 1    0    [1    /1   ]  21.5082782143        1
[INPUT] 1    0    [1    /1   ]  0.790710800393       1
[INPUT] 1    0    [1    /1   ]  3.02355013026        1
[INPUT] 1    0    [1    /1   ]  0.226148142559       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.527461985796, 1.0]], [0, [7618.033727786182, 1.0]], [0, [3617.8157572293335, 1.0]], [0, [1611.5589964703267, 1.0]], [0, [239.7968573851921, 1.0]], [0, [52.150802040037746, 1.0]], [0, [4.602147490703575, 1.0]], [0, [0.39873220053300934, 1.0]], [1, [1362.7810165958153, 1.0]], [1, [664.9982956038699, 1.0]], [1, [302.32861405335046, 1.0]], [1, [315.2728180671364, 1.0]], [1, [65.13269451359113, 1.0]], [1, [7.914845402348865, 1.0]], [1, [21.50827821434458, 1.0]], [1, [0.7907108003934762, 1.0]], [1, [3.0235501302599275, 1.0]], [1, [0.22614814255918755, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52746199]
bas 1, expnt(s) = [7618.03372779]
bas 2, expnt(s) = [3617.81575723]
bas 3, expnt(s) = [1611.55899647]
bas 4, expnt(s) = [239.79685739]
bas 5, expnt(s) = [52.15080204]
bas 6, expnt(s) = [4.60214749]
bas 7, expnt(s) = [0.3987322]
bas 8, expnt(s) = [1362.7810166]
bas 9, expnt(s) = [664.9982956]
bas 10, expnt(s) = [302.32861405]
bas 11, expnt(s) = [315.27281807]
bas 12, expnt(s) = [65.13269451]
bas 13, expnt(s) = [7.9148454]
bas 14, expnt(s) = [21.50827821]
bas 15, expnt(s) = [0.7907108]
bas 16, expnt(s) = [3.02355013]
bas 17, expnt(s) = [0.22614814]
CPU time:       375.12
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825275e+04 5.20024374e+03 7.61803373e+03 2.06014217e+03
 3.61781576e+03 1.17855501e+03 1.61155900e+03 6.42613257e+02
 2.39796857e+02 1.53956362e+02 5.21508020e+01 4.90298730e+01
 4.60214749e+00 7.93844470e+00 3.98732201e-01 1.26772778e+00
 1.36278102e+03 2.41555531e+04 6.64998296e+02 9.85167458e+03
 3.02328614e+02 3.67776063e+03 3.15272818e+02 3.87563218e+03
 6.51326945e+01 5.39800396e+02 7.91484540e+00 3.87291030e+01
 2.15082782e+01 1.35126787e+02 7.90710800e-01 2.17523650e+00
 3.02355013e+00 1.16313697e+01 2.26148143e-01 4.54962576e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97309988087806
cond(S) = 110714.56462943878
E1 = -727.5541750244263  E_coul = 203.1266189439184
init E= -524.427556080508
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.559379058359171  LUMO = 1.05655681276006
  mo_energy =
[-1.17870545e+02 -1.20943911e+01 -9.44670652e+00 -9.44670652e+00
 -9.44670652e+00 -1.23027088e+00 -5.59379058e-01 -5.59379058e-01
 -5.59379058e-01  1.05655681e+00  1.05655681e+00  1.05655681e+00
  7.96086957e+00  7.96086957e+00  7.96086957e+00  3.65626162e+01
  3.65626162e+01  3.65626162e+01  1.38700447e+02  1.38700447e+02
  1.38700447e+02  1.83603735e+02  5.00902819e+02  5.00902819e+02
  5.00902819e+02  1.35715294e+03  1.35715294e+03  1.35715294e+03
  1.91179489e+03  3.05502859e+03  3.05502859e+03  3.05502859e+03
  6.67690634e+03  6.67690634e+03  6.67690634e+03  8.25954174e+03
  2.46387211e+04  7.54318043e+04]
E1 = -727.3937346672735  E_coul = 201.83925193427115
cycle= 1 E= -525.554482733002  delta_E= -1.13  |g|= 0.181  |ddm|= 0.361
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.461427
diis-c [-0.2129151  1.       ]
  HOMO = -0.571930783967265  LUMO = 1.04957895375836
  mo_energy =
[-1.18109502e+02 -1.21818375e+01 -9.53315705e+00 -9.53315705e+00
 -9.53315705e+00 -1.25111739e+00 -5.71930784e-01 -5.71930784e-01
 -5.71930784e-01  1.04957895e+00  1.04957895e+00  1.04957895e+00
  7.91036413e+00  7.91036413e+00  7.91036413e+00  3.64664604e+01
  3.64664604e+01  3.64664604e+01  1.38541452e+02  1.38541452e+02
  1.38541452e+02  1.83416877e+02  5.00679013e+02  5.00679013e+02
  5.00679013e+02  1.35688139e+03  1.35688139e+03  1.35688139e+03
  1.91140340e+03  3.05469669e+03  3.05469669e+03  3.05469669e+03
  6.67645977e+03  6.67645977e+03  6.67645977e+03  8.25901297e+03
  2.46380990e+04  7.54310911e+04]
E1 = -727.595218835231  E_coul = 202.04056072203164
cycle= 2 E= -525.554658113199  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.014
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0304659
diis-c [-7.20100888e-04  3.03632294e-02  9.69636771e-01]
  HOMO = -0.569348231127542  LUMO = 1.05164396676334
  mo_energy =
[-1.18080314e+02 -1.21676917e+01 -9.51880260e+00 -9.51880260e+00
 -9.51880260e+00 -1.24765055e+00 -5.69348231e-01 -5.69348231e-01
 -5.69348231e-01  1.05164397e+00  1.05164397e+00  1.05164397e+00
  7.91850927e+00  7.91850927e+00  7.91850927e+00  3.64818078e+01
  3.64818078e+01  3.64818078e+01  1.38564699e+02  1.38564699e+02
  1.38564699e+02  1.83444936e+02  5.00707751e+02  5.00707751e+02
  5.00707751e+02  1.35691213e+03  1.35691213e+03  1.35691213e+03
  1.91143554e+03  3.05472844e+03  3.05472844e+03  3.05472844e+03
  6.67649208e+03  6.67649208e+03  6.67649208e+03  8.25904548e+03
  2.46381315e+04  7.54311235e+04]
E1 = -727.553666357253  E_coul = 201.99900260253278
cycle= 3 E= -525.55466375472  delta_E= -5.64e-06  |g|= 0.00208  |ddm|= 0.00359
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00442892
diis-c [-8.39270462e-08 -7.46331093e-04  1.22262692e-01  8.78483639e-01]
  HOMO = -0.569856730090268  LUMO = 1.05124926825494
  mo_energy =
[-1.18084278e+02 -1.21698994e+01 -9.52105409e+00 -9.52105409e+00
 -9.52105409e+00 -1.24832029e+00 -5.69856730e-01 -5.69856730e-01
 -5.69856730e-01  1.05124927e+00  1.05124927e+00  1.05124927e+00
  7.91710270e+00  7.91710270e+00  7.91710270e+00  3.64794606e+01
  3.64794606e+01  3.64794606e+01  1.38561422e+02  1.38561422e+02
  1.38561422e+02  1.83441151e+02  5.00703845e+02  5.00703845e+02
  5.00703845e+02  1.35690798e+03  1.35690798e+03  1.35690798e+03
  1.91143117e+03  3.05472415e+03  3.05472415e+03  3.05472415e+03
  6.67648765e+03  6.67648765e+03  6.67648765e+03  8.25904098e+03
  2.46381269e+04  7.54311189e+04]
E1 = -727.5598891734815  E_coul = 202.00522526015956
cycle= 4 E= -525.554663913322  delta_E= -1.59e-07  |g|= 3.64e-05  |ddm|= 0.000583
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.52094e-05
diis-c [-3.80554748e-10 -2.63069915e-05  3.86268950e-03  4.10163908e-02
  9.55147227e-01]
  HOMO = -0.569835470297738  LUMO = 1.05126535629858
  mo_energy =
[-1.18084195e+02 -1.21698301e+01 -9.52098408e+00 -9.52098408e+00
 -9.52098408e+00 -1.24829260e+00 -5.69835470e-01 -5.69835470e-01
 -5.69835470e-01  1.05126536e+00  1.05126536e+00  1.05126536e+00
  7.91715360e+00  7.91715360e+00  7.91715360e+00  3.64795299e+01
  3.64795299e+01  3.64795299e+01  1.38561501e+02  1.38561501e+02
  1.38561501e+02  1.83441234e+02  5.00703927e+02  5.00703927e+02
  5.00703927e+02  1.35690806e+03  1.35690806e+03  1.35690806e+03
  1.91143126e+03  3.05472423e+03  3.05472423e+03  3.05472423e+03
  6.67648774e+03  6.67648774e+03  6.67648774e+03  8.25904106e+03
  2.46381270e+04  7.54311190e+04]
E1 = -727.5597154592241  E_coul = 202.0050515457885
cycle= 5 E= -525.554663913436  delta_E= -1.14e-10  |g|= 2.34e-06  |ddm|= 1.93e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5597154592241  E_coul = 202.0050515457885
  HOMO = -0.569836751990668  LUMO = 1.05126438632099
  mo_energy =
[-1.18084201e+02 -1.21698345e+01 -9.52098860e+00 -9.52098860e+00
 -9.52098860e+00 -1.24829427e+00 -5.69836752e-01 -5.69836752e-01
 -5.69836752e-01  1.05126439e+00  1.05126439e+00  1.05126439e+00
  7.91715044e+00  7.91715044e+00  7.91715044e+00  3.64795253e+01
  3.64795253e+01  3.64795253e+01  1.38561495e+02  1.38561495e+02
  1.38561495e+02  1.83441228e+02  5.00703921e+02  5.00703921e+02
  5.00703921e+02  1.35690806e+03  1.35690806e+03  1.35690806e+03
  1.91143125e+03  3.05472422e+03  3.05472422e+03  3.05472422e+03
  6.67648773e+03  6.67648773e+03  6.67648773e+03  8.25904105e+03
  2.46381270e+04  7.54311190e+04]
E1 = -727.5597270512648  E_coul = 202.00506313782728
Extra cycle  E= -525.554663913437  delta_E= -1.82e-12  |g|= 5.76e-07  |ddm|= 1.24e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 110714.56462943878
E1 = -727.5597270512648  E_coul = 202.00506313782728
init E= -525.554663913437
    CPU time for initialize scf      1.37 sec, wall time      0.21 sec
  HOMO = -0.569836531869078  LUMO = 1.05126455550185
  mo_energy =
[-1.18084200e+02 -1.21698337e+01 -9.52098773e+00 -9.52098773e+00
 -9.52098773e+00 -1.24829398e+00 -5.69836532e-01 -5.69836532e-01
 -5.69836532e-01  1.05126456e+00  1.05126456e+00  1.05126456e+00
  7.91715102e+00  7.91715102e+00  7.91715102e+00  3.64795262e+01
  3.64795262e+01  3.64795262e+01  1.38561496e+02  1.38561496e+02
  1.38561496e+02  1.83441230e+02  5.00703923e+02  5.00703923e+02
  5.00703923e+02  1.35690806e+03  1.35690806e+03  1.35690806e+03
  1.91143125e+03  3.05472423e+03  3.05472423e+03  3.05472423e+03
  6.67648773e+03  6.67648773e+03  6.67648773e+03  8.25904106e+03
  2.46381270e+04  7.54311190e+04]
E1 = -727.5597247225816  E_coul = 202.00506080914428
cycle= 1 E= -525.554663913437  delta_E= 2.27e-13  |g|= 1.24e-07  |ddm|= 2.3e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.5597247225816  E_coul = 202.00506080914428
  HOMO = -0.569836573834205  LUMO = 1.05126452313287
  mo_energy =
[-1.18084200e+02 -1.21698339e+01 -9.52098790e+00 -9.52098790e+00
 -9.52098790e+00 -1.24829403e+00 -5.69836574e-01 -5.69836574e-01
 -5.69836574e-01  1.05126452e+00  1.05126452e+00  1.05126452e+00
  7.91715090e+00  7.91715090e+00  7.91715090e+00  3.64795260e+01
  3.64795260e+01  3.64795260e+01  1.38561496e+02  1.38561496e+02
  1.38561496e+02  1.83441229e+02  5.00703922e+02  5.00703922e+02
  5.00703922e+02  1.35690806e+03  1.35690806e+03  1.35690806e+03
  1.91143125e+03  3.05472423e+03  3.05472423e+03  3.05472423e+03
  6.67648773e+03  6.67648773e+03  6.67648773e+03  8.25904106e+03
  2.46381270e+04  7.54311190e+04]
E1 = -727.5597251953714  E_coul = 202.00506128193535
Extra cycle  E= -525.554663913436  delta_E= 1.25e-12  |g|= 2.58e-08  |ddm|= 4.58e-08
    CPU time for scf_cycle      1.48 sec, wall time      0.31 sec
exp = [2.61825275e+04 7.61803373e+03 3.61781576e+03 1.61155900e+03
 2.39796857e+02 5.21508020e+01 4.60214749e+00 3.98732201e-01
 1.36278102e+03 6.64998296e+02 3.02328614e+02 3.15272818e+02
 6.51326945e+01 7.91484540e+00 2.15082782e+01 7.90710800e-01
 3.02355013e+00 2.26148143e-01]
grad_E = [-1.98920813e-06  2.17221510e-05  4.30133963e-05  6.75422349e-04
  1.78547910e-04 -7.47634985e-04 -1.98857760e-04  6.30505920e-04
 -6.32943061e-07  2.90666945e-06  1.20725083e-05  1.03897757e-05
  3.86950113e-04  7.20268449e-03 -2.44549972e-03 -6.10876836e-03
 -4.43134467e-03  8.25098077e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5337666        1
[INPUT] 0    0    [1    /1   ]  7617.96494995        1
[INPUT] 0    0    [1    /1   ]  3617.67947535        1
[INPUT] 0    0    [1    /1   ]  1609.42643044        1
[INPUT] 0    0    [1    /1   ]  239.34260894         1
[INPUT] 0    0    [1    /1   ]  52.0743047944        1
[INPUT] 0    0    [1    /1   ]  4.60165204091        1
[INPUT] 0    0    [1    /1   ]  0.398614671575       1
[INPUT] 1    0    [1    /1   ]  1362.78255788        1
[INPUT] 1    0    [1    /1   ]  664.985388596        1
[INPUT] 1    0    [1    /1   ]  302.268599599        1
[INPUT] 1    0    [1    /1   ]  315.220729056        1
[INPUT] 1    0    [1    /1   ]  64.9688823556        1
[INPUT] 1    0    [1    /1   ]  8.07511284593        1
[INPUT] 1    0    [1    /1   ]  21.5993005242        1
[INPUT] 1    0    [1    /1   ]  0.797318398204       1
[INPUT] 1    0    [1    /1   ]  3.08801058808        1
[INPUT] 1    0    [1    /1   ]  0.227724114135       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.53376660799, 1.0]], [0, [7617.964949950345, 1.0]], [0, [3617.6794753453614, 1.0]], [0, [1609.4264304369412, 1.0]], [0, [239.3426089396568, 1.0]], [0, [52.074304794433935, 1.0]], [0, [4.601652040912469, 1.0]], [0, [0.39861467157501157, 1.0]], [1, [1362.7825578773732, 1.0]], [1, [664.985388595612, 1.0]], [1, [302.26859959934535, 1.0]], [1, [315.220729055613, 1.0]], [1, [64.96888235556153, 1.0]], [1, [8.075112845927011, 1.0]], [1, [21.599300524205052, 1.0]], [1, [0.7973183982035257, 1.0]], [1, [3.0880105880837774, 1.0]], [1, [0.22772411413455232, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53376661]
bas 1, expnt(s) = [7617.96494995]
bas 2, expnt(s) = [3617.67947535]
bas 3, expnt(s) = [1609.42643044]
bas 4, expnt(s) = [239.34260894]
bas 5, expnt(s) = [52.07430479]
bas 6, expnt(s) = [4.60165204]
bas 7, expnt(s) = [0.39861467]
bas 8, expnt(s) = [1362.78255788]
bas 9, expnt(s) = [664.9853886]
bas 10, expnt(s) = [302.2685996]
bas 11, expnt(s) = [315.22072906]
bas 12, expnt(s) = [64.96888236]
bas 13, expnt(s) = [8.07511285]
bas 14, expnt(s) = [21.59930052]
bas 15, expnt(s) = [0.7973184]
bas 16, expnt(s) = [3.08801059]
bas 17, expnt(s) = [0.22772411]
CPU time:       381.85
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825338e+04 5.20024468e+03 7.61796495e+03 2.06012822e+03
 3.61767948e+03 1.17852171e+03 1.60942643e+03 6.41975377e+02
 2.39342609e+02 1.53737580e+02 5.20743048e+01 4.89759236e+01
 4.60165204e+00 7.93780373e+00 3.98614672e-01 1.26744751e+00
 1.36278256e+03 2.41555873e+04 6.64985389e+02 9.85143557e+03
 3.02268600e+02 3.67684807e+03 3.15220729e+02 3.87483179e+03
 6.49688824e+01 5.38103897e+02 8.07511285e+00 3.97118521e+01
 2.15993005e+01 1.35841979e+02 7.97318398e-01 2.19798196e+00
 3.08801059e+00 1.19421595e+01 2.27724114e-01 4.58929177e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972856277386967
cond(S) = 110637.17022581487
E1 = -727.550769598787  E_coul = 203.12301894832802
init E= -524.427750650459
    CPU time for initialize scf      0.20 sec, wall time      0.04 sec
  HOMO = -0.55933105452579  LUMO = 1.06882560171666
  mo_energy =
[-1.17872099e+02 -1.20942818e+01 -9.44699140e+00 -9.44699140e+00
 -9.44699140e+00 -1.23028434e+00 -5.59331055e-01 -5.59331055e-01
 -5.59331055e-01  1.06882560e+00  1.06882560e+00  1.06882560e+00
  8.15450983e+00  8.15450983e+00  8.15450983e+00  3.72596959e+01
  3.72596959e+01  3.72596959e+01  1.39587875e+02  1.39587875e+02
  1.39587875e+02  1.83122507e+02  5.01395096e+02  5.01395096e+02
  5.01395096e+02  1.35733654e+03  1.35733654e+03  1.35733654e+03
  1.90892227e+03  3.05497784e+03  3.05497784e+03  3.05497784e+03
  6.67670696e+03  6.67670696e+03  6.67670696e+03  8.25306146e+03
  2.46295147e+04  7.54216696e+04]
E1 = -727.3967678654541  E_coul = 201.84154109009577
cycle= 1 E= -525.555226775358  delta_E= -1.13  |g|= 0.181  |ddm|= 0.382
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.462452
diis-c [-0.21386209  1.        ]
  HOMO = -0.571584625428462  LUMO = 1.06191186668373
  mo_energy =
[-1.18111048e+02 -1.21812574e+01 -9.53304165e+00 -9.53304165e+00
 -9.53304165e+00 -1.25076423e+00 -5.71584625e-01 -5.71584625e-01
 -5.71584625e-01  1.06191187e+00  1.06191187e+00  1.06191187e+00
  8.10359901e+00  8.10359901e+00  8.10359901e+00  3.71634557e+01
  3.71634557e+01  3.71634557e+01  1.39429279e+02  1.39429279e+02
  1.39429279e+02  1.82935951e+02  5.01171321e+02  5.01171321e+02
  5.01171321e+02  1.35706456e+03  1.35706456e+03  1.35706456e+03
  1.90852962e+03  3.05464505e+03  3.05464505e+03  3.05464505e+03
  6.67625891e+03  6.67625891e+03  6.67625891e+03  8.25253086e+03
  2.46288904e+04  7.54209541e+04]
E1 = -727.597118526366  E_coul = 202.04171667608935
cycle= 2 E= -525.555401850277  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.0139
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.030458
diis-c [-7.17850914e-04  3.04220200e-02  9.69577980e-01]
  HOMO = -0.569025692296161  LUMO = 1.06398554170617
  mo_energy =
[-1.18081952e+02 -1.21672008e+01 -9.51877709e+00 -9.51877709e+00
 -9.51877709e+00 -1.24733020e+00 -5.69025692e-01 -5.69025692e-01
 -5.69025692e-01  1.06398554e+00  1.06398554e+00  1.06398554e+00
  8.11180395e+00  8.11180395e+00  8.11180395e+00  3.71787824e+01
  3.71787824e+01  3.71787824e+01  1.39452413e+02  1.39452413e+02
  1.39452413e+02  1.82963910e+02  5.01199957e+02  5.01199957e+02
  5.01199957e+02  1.35709521e+03  1.35709521e+03  1.35709521e+03
  1.90856168e+03  3.05467671e+03  3.05467671e+03  3.05467671e+03
  6.67629113e+03  6.67629113e+03  6.67629113e+03  8.25256328e+03
  2.46289228e+04  7.54209864e+04]
E1 = -727.5559027583117  E_coul = 202.00049532471851
cycle= 3 E= -525.555407433593  delta_E= -5.58e-06  |g|= 0.00207  |ddm|= 0.00356
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00441171
diis-c [-8.30599195e-08 -7.48669272e-04  1.21808269e-01  8.78940401e-01]
  HOMO = -0.569528280823438  LUMO = 1.06359053365886
  mo_energy =
[-1.18085890e+02 -1.21693897e+01 -9.52100986e+00 -9.52100986e+00
 -9.52100986e+00 -1.24799224e+00 -5.69528281e-01 -5.69528281e-01
 -5.69528281e-01  1.06359053e+00  1.06359053e+00  1.06359053e+00
  8.11039307e+00  8.11039307e+00  8.11039307e+00  3.71764458e+01
  3.71764458e+01  3.71764458e+01  1.39449162e+02  1.39449162e+02
  1.39449162e+02  1.82960153e+02  5.01196078e+02  5.01196078e+02
  5.01196078e+02  1.35709109e+03  1.35709109e+03  1.35709109e+03
  1.90855734e+03  3.05467245e+03  3.05467245e+03  3.05467245e+03
  6.67628673e+03  6.67628673e+03  6.67628673e+03  8.25255881e+03
  2.46289183e+04  7.54209818e+04]
E1 = -727.5620571978935  E_coul = 202.0066496086341
cycle= 4 E= -525.555407589259  delta_E= -1.56e-07  |g|= 3.61e-05  |ddm|= 0.000577
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.4515e-05
diis-c [-3.84057074e-10 -2.61153907e-05  3.77539891e-03  4.04214213e-02
  9.55829295e-01]
  HOMO = -0.569507130812347  LUMO = 1.06360672534629
  mo_energy =
[-1.18085807e+02 -1.21693208e+01 -9.52094032e+00 -9.52094032e+00
 -9.52094032e+00 -1.24796470e+00 -5.69507131e-01 -5.69507131e-01
 -5.69507131e-01  1.06360673e+00  1.06360673e+00  1.06360673e+00
  8.11044415e+00  8.11044415e+00  8.11044415e+00  3.71765147e+01
  3.71765147e+01  3.71765147e+01  1.39449240e+02  1.39449240e+02
  1.39449240e+02  1.82960235e+02  5.01196160e+02  5.01196160e+02
  5.01196160e+02  1.35709117e+03  1.35709117e+03  1.35709117e+03
  1.90855742e+03  3.05467253e+03  3.05467253e+03  3.05467253e+03
  6.67628681e+03  6.67628681e+03  6.67628681e+03  8.25255889e+03
  2.46289184e+04  7.54209819e+04]
E1 = -727.5618853982984  E_coul = 202.0064778089274
cycle= 5 E= -525.555407589371  delta_E= -1.12e-10  |g|= 2.36e-06  |ddm|= 1.91e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5618853982984  E_coul = 202.0064778089274
  HOMO = -0.569508416082692  LUMO = 1.06360574106321
  mo_energy =
[-1.18085813e+02 -1.21693253e+01 -9.52094488e+00 -9.52094488e+00
 -9.52094488e+00 -1.24796638e+00 -5.69508416e-01 -5.69508416e-01
 -5.69508416e-01  1.06360574e+00  1.06360574e+00  1.06360574e+00
  8.11044095e+00  8.11044095e+00  8.11044095e+00  3.71765101e+01
  3.71765101e+01  3.71765101e+01  1.39449235e+02  1.39449235e+02
  1.39449235e+02  1.82960229e+02  5.01196154e+02  5.01196154e+02
  5.01196154e+02  1.35709117e+03  1.35709117e+03  1.35709117e+03
  1.90855741e+03  3.05467253e+03  3.05467253e+03  3.05467253e+03
  6.67628681e+03  6.67628681e+03  6.67628681e+03  8.25255888e+03
  2.46289184e+04  7.54209819e+04]
E1 = -727.5618970359521  E_coul = 202.0064894465818
Extra cycle  E= -525.55540758937  delta_E= 6.82e-13  |g|= 5.79e-07  |ddm|= 1.25e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.19 sec
exp = [2.61825338e+04 7.61796495e+03 3.61767948e+03 1.60942643e+03
 2.39342609e+02 5.20743048e+01 4.60165204e+00 3.98614672e-01
 1.36278256e+03 6.64985389e+02 3.02268600e+02 3.15220729e+02
 6.49688824e+01 8.07511285e+00 2.15993005e+01 7.97318398e-01
 3.08801059e+00 2.27724114e-01]
E = -525.5554075893704
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5337666        1
[INPUT] 0    0    [1    /1   ]  7617.96494995        1
[INPUT] 0    0    [1    /1   ]  3617.67947535        1
[INPUT] 0    0    [1    /1   ]  1609.42643044        1
[INPUT] 0    0    [1    /1   ]  239.34260894         1
[INPUT] 0    0    [1    /1   ]  52.0743047944        1
[INPUT] 0    0    [1    /1   ]  4.60165204091        1
[INPUT] 0    0    [1    /1   ]  0.398614671575       1
[INPUT] 1    0    [1    /1   ]  1362.78255788        1
[INPUT] 1    0    [1    /1   ]  664.985388596        1
[INPUT] 1    0    [1    /1   ]  302.268599599        1
[INPUT] 1    0    [1    /1   ]  315.220729056        1
[INPUT] 1    0    [1    /1   ]  64.9688823556        1
[INPUT] 1    0    [1    /1   ]  8.07511284593        1
[INPUT] 1    0    [1    /1   ]  21.5993005242        1
[INPUT] 1    0    [1    /1   ]  0.797318398204       1
[INPUT] 1    0    [1    /1   ]  3.08801058808        1
[INPUT] 1    0    [1    /1   ]  0.227724114135       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.53376660799, 1.0]], [0, [7617.964949950345, 1.0]], [0, [3617.6794753453614, 1.0]], [0, [1609.4264304369412, 1.0]], [0, [239.3426089396568, 1.0]], [0, [52.074304794433935, 1.0]], [0, [4.601652040912469, 1.0]], [0, [0.39861467157501157, 1.0]], [1, [1362.7825578773732, 1.0]], [1, [664.985388595612, 1.0]], [1, [302.26859959934535, 1.0]], [1, [315.220729055613, 1.0]], [1, [64.96888235556153, 1.0]], [1, [8.075112845927011, 1.0]], [1, [21.599300524205052, 1.0]], [1, [0.7973183982035257, 1.0]], [1, [3.0880105880837774, 1.0]], [1, [0.22772411413455232, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53376661]
bas 1, expnt(s) = [7617.96494995]
bas 2, expnt(s) = [3617.67947535]
bas 3, expnt(s) = [1609.42643044]
bas 4, expnt(s) = [239.34260894]
bas 5, expnt(s) = [52.07430479]
bas 6, expnt(s) = [4.60165204]
bas 7, expnt(s) = [0.39861467]
bas 8, expnt(s) = [1362.78255788]
bas 9, expnt(s) = [664.9853886]
bas 10, expnt(s) = [302.2685996]
bas 11, expnt(s) = [315.22072906]
bas 12, expnt(s) = [64.96888236]
bas 13, expnt(s) = [8.07511285]
bas 14, expnt(s) = [21.59930052]
bas 15, expnt(s) = [0.7973184]
bas 16, expnt(s) = [3.08801059]
bas 17, expnt(s) = [0.22772411]
CPU time:       382.46
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825338e+04 5.20024468e+03 7.61796495e+03 2.06012822e+03
 3.61767948e+03 1.17852171e+03 1.60942643e+03 6.41975377e+02
 2.39342609e+02 1.53737580e+02 5.20743048e+01 4.89759236e+01
 4.60165204e+00 7.93780373e+00 3.98614672e-01 1.26744751e+00
 1.36278256e+03 2.41555873e+04 6.64985389e+02 9.85143557e+03
 3.02268600e+02 3.67684807e+03 3.15220729e+02 3.87483179e+03
 6.49688824e+01 5.38103897e+02 8.07511285e+00 3.97118521e+01
 2.15993005e+01 1.35841979e+02 7.97318398e-01 2.19798196e+00
 3.08801059e+00 1.19421595e+01 2.27724114e-01 4.58929177e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972856277386967
cond(S) = 110637.17022581487
E1 = -727.550769598787  E_coul = 203.12301894832802
init E= -524.427750650459
    CPU time for initialize scf      0.13 sec, wall time      0.04 sec
  HOMO = -0.55933105452579  LUMO = 1.06882560171666
  mo_energy =
[-1.17872099e+02 -1.20942818e+01 -9.44699140e+00 -9.44699140e+00
 -9.44699140e+00 -1.23028434e+00 -5.59331055e-01 -5.59331055e-01
 -5.59331055e-01  1.06882560e+00  1.06882560e+00  1.06882560e+00
  8.15450983e+00  8.15450983e+00  8.15450983e+00  3.72596959e+01
  3.72596959e+01  3.72596959e+01  1.39587875e+02  1.39587875e+02
  1.39587875e+02  1.83122507e+02  5.01395096e+02  5.01395096e+02
  5.01395096e+02  1.35733654e+03  1.35733654e+03  1.35733654e+03
  1.90892227e+03  3.05497784e+03  3.05497784e+03  3.05497784e+03
  6.67670696e+03  6.67670696e+03  6.67670696e+03  8.25306146e+03
  2.46295147e+04  7.54216696e+04]
E1 = -727.3967678654541  E_coul = 201.84154109009577
cycle= 1 E= -525.555226775358  delta_E= -1.13  |g|= 0.181  |ddm|= 0.382
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.462452
diis-c [-0.21386209  1.        ]
  HOMO = -0.571584625428462  LUMO = 1.06191186668373
  mo_energy =
[-1.18111048e+02 -1.21812574e+01 -9.53304165e+00 -9.53304165e+00
 -9.53304165e+00 -1.25076423e+00 -5.71584625e-01 -5.71584625e-01
 -5.71584625e-01  1.06191187e+00  1.06191187e+00  1.06191187e+00
  8.10359901e+00  8.10359901e+00  8.10359901e+00  3.71634557e+01
  3.71634557e+01  3.71634557e+01  1.39429279e+02  1.39429279e+02
  1.39429279e+02  1.82935951e+02  5.01171321e+02  5.01171321e+02
  5.01171321e+02  1.35706456e+03  1.35706456e+03  1.35706456e+03
  1.90852962e+03  3.05464505e+03  3.05464505e+03  3.05464505e+03
  6.67625891e+03  6.67625891e+03  6.67625891e+03  8.25253086e+03
  2.46288904e+04  7.54209541e+04]
E1 = -727.597118526366  E_coul = 202.04171667608935
cycle= 2 E= -525.555401850277  delta_E= -0.000175  |g|= 0.0149  |ddm|= 0.0139
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.030458
diis-c [-7.17850914e-04  3.04220200e-02  9.69577980e-01]
  HOMO = -0.569025692296161  LUMO = 1.06398554170617
  mo_energy =
[-1.18081952e+02 -1.21672008e+01 -9.51877709e+00 -9.51877709e+00
 -9.51877709e+00 -1.24733020e+00 -5.69025692e-01 -5.69025692e-01
 -5.69025692e-01  1.06398554e+00  1.06398554e+00  1.06398554e+00
  8.11180395e+00  8.11180395e+00  8.11180395e+00  3.71787824e+01
  3.71787824e+01  3.71787824e+01  1.39452413e+02  1.39452413e+02
  1.39452413e+02  1.82963910e+02  5.01199957e+02  5.01199957e+02
  5.01199957e+02  1.35709521e+03  1.35709521e+03  1.35709521e+03
  1.90856168e+03  3.05467671e+03  3.05467671e+03  3.05467671e+03
  6.67629113e+03  6.67629113e+03  6.67629113e+03  8.25256328e+03
  2.46289228e+04  7.54209864e+04]
E1 = -727.5559027583117  E_coul = 202.00049532471851
cycle= 3 E= -525.555407433593  delta_E= -5.58e-06  |g|= 0.00207  |ddm|= 0.00356
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00441171
diis-c [-8.30599195e-08 -7.48669272e-04  1.21808269e-01  8.78940401e-01]
  HOMO = -0.569528280823438  LUMO = 1.06359053365886
  mo_energy =
[-1.18085890e+02 -1.21693897e+01 -9.52100986e+00 -9.52100986e+00
 -9.52100986e+00 -1.24799224e+00 -5.69528281e-01 -5.69528281e-01
 -5.69528281e-01  1.06359053e+00  1.06359053e+00  1.06359053e+00
  8.11039307e+00  8.11039307e+00  8.11039307e+00  3.71764458e+01
  3.71764458e+01  3.71764458e+01  1.39449162e+02  1.39449162e+02
  1.39449162e+02  1.82960153e+02  5.01196078e+02  5.01196078e+02
  5.01196078e+02  1.35709109e+03  1.35709109e+03  1.35709109e+03
  1.90855734e+03  3.05467245e+03  3.05467245e+03  3.05467245e+03
  6.67628673e+03  6.67628673e+03  6.67628673e+03  8.25255881e+03
  2.46289183e+04  7.54209818e+04]
E1 = -727.5620571978935  E_coul = 202.0066496086341
cycle= 4 E= -525.555407589259  delta_E= -1.56e-07  |g|= 3.61e-05  |ddm|= 0.000577
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.4515e-05
diis-c [-3.84057074e-10 -2.61153907e-05  3.77539891e-03  4.04214213e-02
  9.55829295e-01]
  HOMO = -0.569507130812347  LUMO = 1.06360672534629
  mo_energy =
[-1.18085807e+02 -1.21693208e+01 -9.52094032e+00 -9.52094032e+00
 -9.52094032e+00 -1.24796470e+00 -5.69507131e-01 -5.69507131e-01
 -5.69507131e-01  1.06360673e+00  1.06360673e+00  1.06360673e+00
  8.11044415e+00  8.11044415e+00  8.11044415e+00  3.71765147e+01
  3.71765147e+01  3.71765147e+01  1.39449240e+02  1.39449240e+02
  1.39449240e+02  1.82960235e+02  5.01196160e+02  5.01196160e+02
  5.01196160e+02  1.35709117e+03  1.35709117e+03  1.35709117e+03
  1.90855742e+03  3.05467253e+03  3.05467253e+03  3.05467253e+03
  6.67628681e+03  6.67628681e+03  6.67628681e+03  8.25255889e+03
  2.46289184e+04  7.54209819e+04]
E1 = -727.5618853982984  E_coul = 202.0064778089274
cycle= 5 E= -525.555407589371  delta_E= -1.12e-10  |g|= 2.36e-06  |ddm|= 1.91e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5618853982984  E_coul = 202.0064778089274
  HOMO = -0.569508416082692  LUMO = 1.06360574106321
  mo_energy =
[-1.18085813e+02 -1.21693253e+01 -9.52094488e+00 -9.52094488e+00
 -9.52094488e+00 -1.24796638e+00 -5.69508416e-01 -5.69508416e-01
 -5.69508416e-01  1.06360574e+00  1.06360574e+00  1.06360574e+00
  8.11044095e+00  8.11044095e+00  8.11044095e+00  3.71765101e+01
  3.71765101e+01  3.71765101e+01  1.39449235e+02  1.39449235e+02
  1.39449235e+02  1.82960229e+02  5.01196154e+02  5.01196154e+02
  5.01196154e+02  1.35709117e+03  1.35709117e+03  1.35709117e+03
  1.90855741e+03  3.05467253e+03  3.05467253e+03  3.05467253e+03
  6.67628681e+03  6.67628681e+03  6.67628681e+03  8.25255888e+03
  2.46289184e+04  7.54209819e+04]
E1 = -727.5618970359521  E_coul = 202.0064894465818
Extra cycle  E= -525.55540758937  delta_E= 6.82e-13  |g|= 5.79e-07  |ddm|= 1.25e-06
    CPU time for scf_cycle      0.27 sec, wall time      0.18 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 110637.17022581487
E1 = -727.5618970359521  E_coul = 202.0064894465818
init E= -525.55540758937
    CPU time for initialize scf      0.93 sec, wall time      0.17 sec
  HOMO = -0.569508195412963  LUMO = 1.06360591273721
  mo_energy =
[-1.18085812e+02 -1.21693245e+01 -9.52094400e+00 -9.52094400e+00
 -9.52094400e+00 -1.24796609e+00 -5.69508195e-01 -5.69508195e-01
 -5.69508195e-01  1.06360591e+00  1.06360591e+00  1.06360591e+00
  8.11044153e+00  8.11044153e+00  8.11044153e+00  3.71765110e+01
  3.71765110e+01  3.71765110e+01  1.39449236e+02  1.39449236e+02
  1.39449236e+02  1.82960230e+02  5.01196156e+02  5.01196156e+02
  5.01196156e+02  1.35709117e+03  1.35709117e+03  1.35709117e+03
  1.90855741e+03  3.05467253e+03  3.05467253e+03  3.05467253e+03
  6.67628681e+03  6.67628681e+03  6.67628681e+03  8.25255889e+03
  2.46289184e+04  7.54209819e+04]
E1 = -727.5618947056026  E_coul = 202.0064871162309
cycle= 1 E= -525.555407589372  delta_E= -1.36e-12  |g|= 1.24e-07  |ddm|= 2.3e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.5618947056026  E_coul = 202.0064871162309
  HOMO = -0.569508237316849  LUMO = 1.06360588001682
  mo_energy =
[-1.18085812e+02 -1.21693246e+01 -9.52094418e+00 -9.52094418e+00
 -9.52094418e+00 -1.24796615e+00 -5.69508237e-01 -5.69508237e-01
 -5.69508237e-01  1.06360588e+00  1.06360588e+00  1.06360588e+00
  8.11044142e+00  8.11044142e+00  8.11044142e+00  3.71765108e+01
  3.71765108e+01  3.71765108e+01  1.39449236e+02  1.39449236e+02
  1.39449236e+02  1.82960230e+02  5.01196155e+02  5.01196155e+02
  5.01196155e+02  1.35709117e+03  1.35709117e+03  1.35709117e+03
  1.90855741e+03  3.05467253e+03  3.05467253e+03  3.05467253e+03
  6.67628681e+03  6.67628681e+03  6.67628681e+03  8.25255888e+03
  2.46289184e+04  7.54209819e+04]
E1 = -727.561895177349  E_coul = 202.00648758797723
Extra cycle  E= -525.555407589372  delta_E=    0  |g|= 2.58e-08  |ddm|= 4.58e-08
    CPU time for scf_cycle      1.04 sec, wall time      0.28 sec
exp = [2.61825338e+04 7.61796495e+03 3.61767948e+03 1.60942643e+03
 2.39342609e+02 5.20743048e+01 4.60165204e+00 3.98614672e-01
 1.36278256e+03 6.64985389e+02 3.02268600e+02 3.15220729e+02
 6.49688824e+01 8.07511285e+00 2.15993005e+01 7.97318398e-01
 3.08801059e+00 2.27724114e-01]
grad_E = [-1.98933526e-06  2.18079253e-05  4.32006870e-05  6.81163344e-04
  1.23914869e-04 -1.21581556e-03 -6.50613974e-04  7.99849755e-05
 -6.32249842e-07  2.90005783e-06  1.19537033e-05  1.02978282e-05
  4.80313316e-04  1.09351959e-02 -3.64924468e-03 -7.12930943e-03
 -7.33341920e-03  1.20596397e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5494877        1
[INPUT] 0    0    [1    /1   ]  7617.7933813         1
[INPUT] 0    0    [1    /1   ]  3617.33941207        1
[INPUT] 0    0    [1    /1   ]  1604.10748061        1
[INPUT] 0    0    [1    /1   ]  238.238114229        1
[INPUT] 0    0    [1    /1   ]  51.9101666836        1
[INPUT] 0    0    [1    /1   ]  4.60097884112        1
[INPUT] 0    0    [1    /1   ]  0.398393090222       1
[INPUT] 1    0    [1    /1   ]  1362.78603426        1
[INPUT] 1    0    [1    /1   ]  664.950106785        1
[INPUT] 1    0    [1    /1   ]  302.101383801        1
[INPUT] 1    0    [1    /1   ]  315.075321297        1
[INPUT] 1    0    [1    /1   ]  64.9568143255        1
[INPUT] 1    0    [1    /1   ]  8.38565074271        1
[INPUT] 1    0    [1    /1   ]  21.8730614414        1
[INPUT] 1    0    [1    /1   ]  0.809823997069       1
[INPUT] 1    0    [1    /1   ]  3.20878129787        1
[INPUT] 1    0    [1    /1   ]  0.230661004811       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.54948772901, 1.0]], [0, [7617.793381304054, 1.0]], [0, [3617.339412073976, 1.0]], [0, [1604.1074806124072, 1.0]], [0, [238.23811422945803, 1.0]], [0, [51.91016668361228, 1.0]], [0, [4.600978841123628, 1.0]], [0, [0.3983930902215382, 1.0]], [1, [1362.7860342580614, 1.0]], [1, [664.9501067845166, 1.0]], [1, [302.10138380147265, 1.0]], [1, [315.0753212969587, 1.0]], [1, [64.95681432552394, 1.0]], [1, [8.38565074271403, 1.0]], [1, [21.873061441378372, 1.0]], [1, [0.8098239970685865, 1.0]], [1, [3.2087812978656816, 1.0]], [1, [0.23066100481060092, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54948773]
bas 1, expnt(s) = [7617.7933813]
bas 2, expnt(s) = [3617.33941207]
bas 3, expnt(s) = [1604.10748061]
bas 4, expnt(s) = [238.23811423]
bas 5, expnt(s) = [51.91016668]
bas 6, expnt(s) = [4.60097884]
bas 7, expnt(s) = [0.39839309]
bas 8, expnt(s) = [1362.78603426]
bas 9, expnt(s) = [664.95010678]
bas 10, expnt(s) = [302.1013838]
bas 11, expnt(s) = [315.0753213]
bas 12, expnt(s) = [64.95681433]
bas 13, expnt(s) = [8.38565074]
bas 14, expnt(s) = [21.87306144]
bas 15, expnt(s) = [0.809824]
bas 16, expnt(s) = [3.2087813]
bas 17, expnt(s) = [0.230661]
CPU time:       387.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825495e+04 5.20024702e+03 7.61779338e+03 2.06009342e+03
 3.61733941e+03 1.17843863e+03 1.60410748e+03 6.40383484e+02
 2.38238114e+02 1.53205182e+02 5.19101667e+01 4.88600989e+01
 4.60097884e+00 7.93693276e+00 3.98393090e-01 1.26691907e+00
 1.36278603e+03 2.41556643e+04 6.64950107e+02 9.85078222e+03
 3.02101384e+02 3.67430569e+03 3.15075321e+02 3.87259765e+03
 6.49568143e+01 5.37978958e+02 8.38565074e+00 4.16298988e+01
 2.18730614e+01 1.37997544e+02 8.09823997e-01 2.24115913e+00
 3.20878130e+00 1.25288018e+01 2.30661005e-01 4.66339408e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972365046680284
cond(S) = 110863.67540751287
E1 = -727.5433838553657  E_coul = 203.1168365057105
init E= -524.426547349655
    CPU time for initialize scf      0.13 sec, wall time      0.04 sec
  HOMO = -0.559256059531384  LUMO = 1.09213864272571
  mo_energy =
[-1.17875262e+02 -1.20940597e+01 -9.44739022e+00 -9.44739022e+00
 -9.44739022e+00 -1.23030882e+00 -5.59256060e-01 -5.59256060e-01
 -5.59256060e-01  1.09213864e+00  1.09213864e+00  1.09213864e+00
  8.52532554e+00  8.52532554e+00  8.52532554e+00  3.86574158e+01
  3.86574158e+01  3.86574158e+01  1.41840939e+02  1.41840939e+02
  1.41840939e+02  1.82017065e+02  5.03482878e+02  5.03482878e+02
  5.03482878e+02  1.35889844e+03  1.35889844e+03  1.35889844e+03
  1.90193687e+03  3.05596251e+03  3.05596251e+03  3.05596251e+03
  6.67723881e+03  6.67723881e+03  6.67723881e+03  8.23707740e+03
  2.46067326e+04  7.53965691e+04]
E1 = -727.404598843763  E_coul = 201.8476620555688
cycle= 1 E= -525.556936788194  delta_E= -1.13  |g|= 0.182  |ddm|= 0.412
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.464572
diis-c [-0.21582743  1.        ]
  HOMO = -0.570968083419195  LUMO = 1.085341172724
  mo_energy =
[-1.18113934e+02 -1.21800458e+01 -9.53258116e+00 -9.53258116e+00
 -9.53258116e+00 -1.25011393e+00 -5.70968083e-01 -5.70968083e-01
 -5.70968083e-01  1.08534117e+00  1.08534117e+00  1.08534117e+00
  8.47374413e+00  8.47374413e+00  8.47374413e+00  3.85609841e+01
  3.85609841e+01  3.85609841e+01  1.41683027e+02  1.41683027e+02
  1.41683027e+02  1.81831368e+02  5.03259408e+02  5.03259408e+02
  5.03259408e+02  1.35862606e+03  1.35862606e+03  1.35862606e+03
  1.90154257e+03  3.05562851e+03  3.05562851e+03  3.05562851e+03
  6.67678838e+03  6.67678838e+03  6.67678838e+03  8.23654376e+03
  2.46061046e+04  7.53958495e+04]
E1 = -727.6025650106005  E_coul = 202.04545372754538
cycle= 2 E= -525.557111283055  delta_E= -0.000174  |g|= 0.0149  |ddm|= 0.0138
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0304173
diis-c [-7.13440006e-04  3.04216584e-02  9.69578342e-01]
  HOMO = -0.568461436811395  LUMO = 1.08742431517036
  mo_energy =
[-1.18085032e+02 -1.21661717e+01 -9.51850054e+00 -9.51850054e+00
 -9.51850054e+00 -1.24675119e+00 -5.68461437e-01 -5.68461437e-01
 -5.68461437e-01  1.08742432e+00  1.08742432e+00  1.08742432e+00
  8.48204386e+00  8.48204386e+00  8.48204386e+00  3.85762793e+01
  3.85762793e+01  3.85762793e+01  1.41705962e+02  1.41705962e+02
  1.41705962e+02  1.81859115e+02  5.03287836e+02  5.03287836e+02
  5.03287836e+02  1.35865651e+03  1.35865651e+03  1.35865651e+03
  1.90157444e+03  3.05565998e+03  3.05565998e+03  3.05565998e+03
  6.67682040e+03  6.67682040e+03  6.67682040e+03  8.23657599e+03
  2.46061368e+04  7.53958816e+04]
E1 = -727.562003202521  E_coul = 202.00488645326348
cycle= 3 E= -525.557116749258  delta_E= -5.47e-06  |g|= 0.00204  |ddm|= 0.00351
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00437689
diis-c [-8.21859012e-08 -7.52763689e-04  1.20987437e-01  8.79765327e-01]
  HOMO = -0.568953377769003  LUMO = 1.08702856918728
  mo_energy =
[-1.18088921e+02 -1.21683259e+01 -9.52069860e+00 -9.52069860e+00
 -9.52069860e+00 -1.24739933e+00 -5.68953378e-01 -5.68953378e-01
 -5.68953378e-01  1.08702857e+00  1.08702857e+00  1.08702857e+00
  8.48062527e+00  8.48062527e+00  8.48062527e+00  3.85739598e+01
  3.85739598e+01  3.85739598e+01  1.41702755e+02  1.41702755e+02
  1.41702755e+02  1.81855409e+02  5.03284008e+02  5.03284008e+02
  5.03284008e+02  1.35865244e+03  1.35865244e+03  1.35865244e+03
  1.90157015e+03  3.05565577e+03  3.05565577e+03  3.05565577e+03
  6.67681606e+03  6.67681606e+03  6.67681606e+03  8.23657157e+03
  2.46061323e+04  7.53958771e+04]
E1 = -727.5680345369891  E_coul = 202.0109176373284
cycle= 4 E= -525.557116899661  delta_E= -1.5e-07  |g|= 3.57e-05  |ddm|= 0.000568
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.37628e-05
diis-c [-3.93582255e-10 -2.56255418e-05  3.60744485e-03  3.93749969e-02
  9.57043184e-01]
  HOMO = -0.568932351750924  LUMO = 1.08704501916143
  mo_energy =
[-1.18088839e+02 -1.21682574e+01 -9.52062955e+00 -9.52062955e+00
 -9.52062955e+00 -1.24737197e+00 -5.68932352e-01 -5.68932352e-01
 -5.68932352e-01  1.08704502e+00  1.08704502e+00  1.08704502e+00
  8.48067691e+00  8.48067691e+00  8.48067691e+00  3.85740285e+01
  3.85740285e+01  3.85740285e+01  1.41702833e+02  1.41702833e+02
  1.41702833e+02  1.81855490e+02  5.03284089e+02  5.03284089e+02
  5.03284089e+02  1.35865252e+03  1.35865252e+03  1.35865252e+03
  1.90157023e+03  3.05565585e+03  3.05565585e+03  3.05565585e+03
  6.67681614e+03  6.67681614e+03  6.67681614e+03  8.23657164e+03
  2.46061324e+04  7.53958772e+04]
E1 = -727.5678651667757  E_coul = 202.0107482670068
cycle= 5 E= -525.557116899769  delta_E= -1.08e-10  |g|= 2.4e-06  |ddm|= 1.89e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5678651667757  E_coul = 202.0107482670068
  HOMO = -0.568933650296866  LUMO = 1.08704400252303
  mo_energy =
[-1.18088845e+02 -1.21682620e+01 -9.52063418e+00 -9.52063418e+00
 -9.52063418e+00 -1.24737367e+00 -5.68933650e-01 -5.68933650e-01
 -5.68933650e-01  1.08704400e+00  1.08704400e+00  1.08704400e+00
  8.48067360e+00  8.48067360e+00  8.48067360e+00  3.85740238e+01
  3.85740238e+01  3.85740238e+01  1.41702827e+02  1.41702827e+02
  1.41702827e+02  1.81855484e+02  5.03284083e+02  5.03284083e+02
  5.03284083e+02  1.35865251e+03  1.35865251e+03  1.35865251e+03
  1.90157022e+03  3.05565584e+03  3.05565584e+03  3.05565584e+03
  6.67681613e+03  6.67681613e+03  6.67681613e+03  8.23657164e+03
  2.46061324e+04  7.53958771e+04]
E1 = -727.567876924554  E_coul = 202.0107600247847
Extra cycle  E= -525.557116899769  delta_E= -2.27e-13  |g|= 5.88e-07  |ddm|= 1.27e-06
    CPU time for scf_cycle      0.27 sec, wall time      0.18 sec
exp = [2.61825495e+04 7.61779338e+03 3.61733941e+03 1.60410748e+03
 2.38238114e+02 5.19101667e+01 4.60097884e+00 3.98393090e-01
 1.36278603e+03 6.64950107e+02 3.02101384e+02 3.15075321e+02
 6.49568143e+01 8.38565074e+00 2.18730614e+01 8.09823997e-01
 3.20878130e+00 2.30661005e-01]
E = -525.5571168997692
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:18 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5494877        1
[INPUT] 0    0    [1    /1   ]  7617.7933813         1
[INPUT] 0    0    [1    /1   ]  3617.33941207        1
[INPUT] 0    0    [1    /1   ]  1604.10748061        1
[INPUT] 0    0    [1    /1   ]  238.238114229        1
[INPUT] 0    0    [1    /1   ]  51.9101666836        1
[INPUT] 0    0    [1    /1   ]  4.60097884112        1
[INPUT] 0    0    [1    /1   ]  0.398393090222       1
[INPUT] 1    0    [1    /1   ]  1362.78603426        1
[INPUT] 1    0    [1    /1   ]  664.950106785        1
[INPUT] 1    0    [1    /1   ]  302.101383801        1
[INPUT] 1    0    [1    /1   ]  315.075321297        1
[INPUT] 1    0    [1    /1   ]  64.9568143255        1
[INPUT] 1    0    [1    /1   ]  8.38565074271        1
[INPUT] 1    0    [1    /1   ]  21.8730614414        1
[INPUT] 1    0    [1    /1   ]  0.809823997069       1
[INPUT] 1    0    [1    /1   ]  3.20878129787        1
[INPUT] 1    0    [1    /1   ]  0.230661004811       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.54948772901, 1.0]], [0, [7617.793381304054, 1.0]], [0, [3617.339412073976, 1.0]], [0, [1604.1074806124072, 1.0]], [0, [238.23811422945803, 1.0]], [0, [51.91016668361228, 1.0]], [0, [4.600978841123628, 1.0]], [0, [0.3983930902215382, 1.0]], [1, [1362.7860342580614, 1.0]], [1, [664.9501067845166, 1.0]], [1, [302.10138380147265, 1.0]], [1, [315.0753212969587, 1.0]], [1, [64.95681432552394, 1.0]], [1, [8.38565074271403, 1.0]], [1, [21.873061441378372, 1.0]], [1, [0.8098239970685865, 1.0]], [1, [3.2087812978656816, 1.0]], [1, [0.23066100481060092, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54948773]
bas 1, expnt(s) = [7617.7933813]
bas 2, expnt(s) = [3617.33941207]
bas 3, expnt(s) = [1604.10748061]
bas 4, expnt(s) = [238.23811423]
bas 5, expnt(s) = [51.91016668]
bas 6, expnt(s) = [4.60097884]
bas 7, expnt(s) = [0.39839309]
bas 8, expnt(s) = [1362.78603426]
bas 9, expnt(s) = [664.95010678]
bas 10, expnt(s) = [302.1013838]
bas 11, expnt(s) = [315.0753213]
bas 12, expnt(s) = [64.95681433]
bas 13, expnt(s) = [8.38565074]
bas 14, expnt(s) = [21.87306144]
bas 15, expnt(s) = [0.809824]
bas 16, expnt(s) = [3.2087813]
bas 17, expnt(s) = [0.230661]
CPU time:       388.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825495e+04 5.20024702e+03 7.61779338e+03 2.06009342e+03
 3.61733941e+03 1.17843863e+03 1.60410748e+03 6.40383484e+02
 2.38238114e+02 1.53205182e+02 5.19101667e+01 4.88600989e+01
 4.60097884e+00 7.93693276e+00 3.98393090e-01 1.26691907e+00
 1.36278603e+03 2.41556643e+04 6.64950107e+02 9.85078222e+03
 3.02101384e+02 3.67430569e+03 3.15075321e+02 3.87259765e+03
 6.49568143e+01 5.37978958e+02 8.38565074e+00 4.16298988e+01
 2.18730614e+01 1.37997544e+02 8.09823997e-01 2.24115913e+00
 3.20878130e+00 1.25288018e+01 2.30661005e-01 4.66339408e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972365046680284
cond(S) = 110863.67540751287
E1 = -727.5433838553657  E_coul = 203.1168365057105
init E= -524.426547349655
    CPU time for initialize scf      0.13 sec, wall time      0.04 sec
  HOMO = -0.559256059531384  LUMO = 1.09213864272571
  mo_energy =
[-1.17875262e+02 -1.20940597e+01 -9.44739022e+00 -9.44739022e+00
 -9.44739022e+00 -1.23030882e+00 -5.59256060e-01 -5.59256060e-01
 -5.59256060e-01  1.09213864e+00  1.09213864e+00  1.09213864e+00
  8.52532554e+00  8.52532554e+00  8.52532554e+00  3.86574158e+01
  3.86574158e+01  3.86574158e+01  1.41840939e+02  1.41840939e+02
  1.41840939e+02  1.82017065e+02  5.03482878e+02  5.03482878e+02
  5.03482878e+02  1.35889844e+03  1.35889844e+03  1.35889844e+03
  1.90193687e+03  3.05596251e+03  3.05596251e+03  3.05596251e+03
  6.67723881e+03  6.67723881e+03  6.67723881e+03  8.23707740e+03
  2.46067326e+04  7.53965691e+04]
E1 = -727.404598843763  E_coul = 201.8476620555688
cycle= 1 E= -525.556936788194  delta_E= -1.13  |g|= 0.182  |ddm|= 0.412
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.464572
diis-c [-0.21582743  1.        ]
  HOMO = -0.570968083419195  LUMO = 1.085341172724
  mo_energy =
[-1.18113934e+02 -1.21800458e+01 -9.53258116e+00 -9.53258116e+00
 -9.53258116e+00 -1.25011393e+00 -5.70968083e-01 -5.70968083e-01
 -5.70968083e-01  1.08534117e+00  1.08534117e+00  1.08534117e+00
  8.47374413e+00  8.47374413e+00  8.47374413e+00  3.85609841e+01
  3.85609841e+01  3.85609841e+01  1.41683027e+02  1.41683027e+02
  1.41683027e+02  1.81831368e+02  5.03259408e+02  5.03259408e+02
  5.03259408e+02  1.35862606e+03  1.35862606e+03  1.35862606e+03
  1.90154257e+03  3.05562851e+03  3.05562851e+03  3.05562851e+03
  6.67678838e+03  6.67678838e+03  6.67678838e+03  8.23654376e+03
  2.46061046e+04  7.53958495e+04]
E1 = -727.6025650106005  E_coul = 202.04545372754538
cycle= 2 E= -525.557111283055  delta_E= -0.000174  |g|= 0.0149  |ddm|= 0.0138
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0304173
diis-c [-7.13440006e-04  3.04216584e-02  9.69578342e-01]
  HOMO = -0.568461436811395  LUMO = 1.08742431517036
  mo_energy =
[-1.18085032e+02 -1.21661717e+01 -9.51850054e+00 -9.51850054e+00
 -9.51850054e+00 -1.24675119e+00 -5.68461437e-01 -5.68461437e-01
 -5.68461437e-01  1.08742432e+00  1.08742432e+00  1.08742432e+00
  8.48204386e+00  8.48204386e+00  8.48204386e+00  3.85762793e+01
  3.85762793e+01  3.85762793e+01  1.41705962e+02  1.41705962e+02
  1.41705962e+02  1.81859115e+02  5.03287836e+02  5.03287836e+02
  5.03287836e+02  1.35865651e+03  1.35865651e+03  1.35865651e+03
  1.90157444e+03  3.05565998e+03  3.05565998e+03  3.05565998e+03
  6.67682040e+03  6.67682040e+03  6.67682040e+03  8.23657599e+03
  2.46061368e+04  7.53958816e+04]
E1 = -727.562003202521  E_coul = 202.00488645326348
cycle= 3 E= -525.557116749258  delta_E= -5.47e-06  |g|= 0.00204  |ddm|= 0.00351
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00437689
diis-c [-8.21859012e-08 -7.52763689e-04  1.20987437e-01  8.79765327e-01]
  HOMO = -0.568953377769003  LUMO = 1.08702856918728
  mo_energy =
[-1.18088921e+02 -1.21683259e+01 -9.52069860e+00 -9.52069860e+00
 -9.52069860e+00 -1.24739933e+00 -5.68953378e-01 -5.68953378e-01
 -5.68953378e-01  1.08702857e+00  1.08702857e+00  1.08702857e+00
  8.48062527e+00  8.48062527e+00  8.48062527e+00  3.85739598e+01
  3.85739598e+01  3.85739598e+01  1.41702755e+02  1.41702755e+02
  1.41702755e+02  1.81855409e+02  5.03284008e+02  5.03284008e+02
  5.03284008e+02  1.35865244e+03  1.35865244e+03  1.35865244e+03
  1.90157015e+03  3.05565577e+03  3.05565577e+03  3.05565577e+03
  6.67681606e+03  6.67681606e+03  6.67681606e+03  8.23657157e+03
  2.46061323e+04  7.53958771e+04]
E1 = -727.5680345369891  E_coul = 202.0109176373284
cycle= 4 E= -525.557116899661  delta_E= -1.5e-07  |g|= 3.57e-05  |ddm|= 0.000568
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.37628e-05
diis-c [-3.93582255e-10 -2.56255418e-05  3.60744485e-03  3.93749969e-02
  9.57043184e-01]
  HOMO = -0.568932351750924  LUMO = 1.08704501916143
  mo_energy =
[-1.18088839e+02 -1.21682574e+01 -9.52062955e+00 -9.52062955e+00
 -9.52062955e+00 -1.24737197e+00 -5.68932352e-01 -5.68932352e-01
 -5.68932352e-01  1.08704502e+00  1.08704502e+00  1.08704502e+00
  8.48067691e+00  8.48067691e+00  8.48067691e+00  3.85740285e+01
  3.85740285e+01  3.85740285e+01  1.41702833e+02  1.41702833e+02
  1.41702833e+02  1.81855490e+02  5.03284089e+02  5.03284089e+02
  5.03284089e+02  1.35865252e+03  1.35865252e+03  1.35865252e+03
  1.90157023e+03  3.05565585e+03  3.05565585e+03  3.05565585e+03
  6.67681614e+03  6.67681614e+03  6.67681614e+03  8.23657164e+03
  2.46061324e+04  7.53958772e+04]
E1 = -727.5678651667757  E_coul = 202.0107482670068
cycle= 5 E= -525.557116899769  delta_E= -1.08e-10  |g|= 2.4e-06  |ddm|= 1.89e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5678651667757  E_coul = 202.0107482670068
  HOMO = -0.568933650296866  LUMO = 1.08704400252303
  mo_energy =
[-1.18088845e+02 -1.21682620e+01 -9.52063418e+00 -9.52063418e+00
 -9.52063418e+00 -1.24737367e+00 -5.68933650e-01 -5.68933650e-01
 -5.68933650e-01  1.08704400e+00  1.08704400e+00  1.08704400e+00
  8.48067360e+00  8.48067360e+00  8.48067360e+00  3.85740238e+01
  3.85740238e+01  3.85740238e+01  1.41702827e+02  1.41702827e+02
  1.41702827e+02  1.81855484e+02  5.03284083e+02  5.03284083e+02
  5.03284083e+02  1.35865251e+03  1.35865251e+03  1.35865251e+03
  1.90157022e+03  3.05565584e+03  3.05565584e+03  3.05565584e+03
  6.67681613e+03  6.67681613e+03  6.67681613e+03  8.23657164e+03
  2.46061324e+04  7.53958771e+04]
E1 = -727.567876924554  E_coul = 202.0107600247847
Extra cycle  E= -525.557116899769  delta_E= -2.27e-13  |g|= 5.88e-07  |ddm|= 1.27e-06
    CPU time for scf_cycle      0.27 sec, wall time      0.18 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 110863.67540751287
E1 = -727.567876924554  E_coul = 202.0107600247847
init E= -525.557116899769
    CPU time for initialize scf      1.12 sec, wall time      0.18 sec
  HOMO = -0.568933427901855  LUMO = 1.08704417949651
  mo_energy =
[-1.18088844e+02 -1.21682611e+01 -9.52063329e+00 -9.52063329e+00
 -9.52063329e+00 -1.24737338e+00 -5.68933428e-01 -5.68933428e-01
 -5.68933428e-01  1.08704418e+00  1.08704418e+00  1.08704418e+00
  8.48067420e+00  8.48067420e+00  8.48067420e+00  3.85740247e+01
  3.85740247e+01  3.85740247e+01  1.41702829e+02  1.41702829e+02
  1.41702829e+02  1.81855486e+02  5.03284084e+02  5.03284084e+02
  5.03284084e+02  1.35865251e+03  1.35865251e+03  1.35865251e+03
  1.90157022e+03  3.05565584e+03  3.05565584e+03  3.05565584e+03
  6.67681613e+03  6.67681613e+03  6.67681613e+03  8.23657164e+03
  2.46061324e+04  7.53958771e+04]
E1 = -727.5678745830843  E_coul = 202.01075768331376
cycle= 1 E= -525.557116899771  delta_E= -1.36e-12  |g|= 1.25e-07  |ddm|= 2.32e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.5678745830843  E_coul = 202.01075768331376
  HOMO = -0.568933469853376  LUMO = 1.08704414598389
  mo_energy =
[-1.18088844e+02 -1.21682613e+01 -9.52063347e+00 -9.52063347e+00
 -9.52063347e+00 -1.24737343e+00 -5.68933470e-01 -5.68933470e-01
 -5.68933470e-01  1.08704415e+00  1.08704415e+00  1.08704415e+00
  8.48067409e+00  8.48067409e+00  8.48067409e+00  3.85740245e+01
  3.85740245e+01  3.85740245e+01  1.41702828e+02  1.41702828e+02
  1.41702828e+02  1.81855485e+02  5.03284084e+02  5.03284084e+02
  5.03284084e+02  1.35865251e+03  1.35865251e+03  1.35865251e+03
  1.90157022e+03  3.05565584e+03  3.05565584e+03  3.05565584e+03
  6.67681613e+03  6.67681613e+03  6.67681613e+03  8.23657164e+03
  2.46061324e+04  7.53958771e+04]
E1 = -727.5678750546618  E_coul = 202.01075815489259
Extra cycle  E= -525.557116899769  delta_E= 1.36e-12  |g|= 2.59e-08  |ddm|= 4.6e-08
    CPU time for scf_cycle      1.22 sec, wall time      0.29 sec
exp = [2.61825495e+04 7.61779338e+03 3.61733941e+03 1.60410748e+03
 2.38238114e+02 5.19101667e+01 4.60097884e+00 3.98393090e-01
 1.36278603e+03 6.64950107e+02 3.02101384e+02 3.15075321e+02
 6.49568143e+01 8.38565074e+00 2.18730614e+01 8.09823997e-01
 3.20878130e+00 2.30661005e-01]
grad_E = [-1.98973777e-06  2.20402247e-05  4.37215090e-05  6.96393333e-04
 -9.06439987e-05 -1.76566234e-03 -1.26247169e-03 -7.93771894e-04
 -6.33498830e-07  2.85697734e-06  1.16475201e-05  1.00407415e-05
  5.76982704e-04  1.48589721e-02 -4.88872250e-03 -7.39423534e-03
 -1.00559698e-02  1.51658257e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5826393        1
[INPUT] 0    0    [1    /1   ]  7617.43163278        1
[INPUT] 0    0    [1    /1   ]  3616.62246477        1
[INPUT] 0    0    [1    /1   ]  1592.89206591        1
[INPUT] 0    0    [1    /1   ]  235.886042912        1
[INPUT] 0    0    [1    /1   ]  51.5900941801        1
[INPUT] 0    0    [1    /1   ]  4.60046134343        1
[INPUT] 0    0    [1    /1   ]  0.398058915757       1
[INPUT] 1    0    [1    /1   ]  1362.79357633        1
[INPUT] 1    0    [1    /1   ]  664.877516855        1
[INPUT] 1    0    [1    /1   ]  301.758971257        1
[INPUT] 1    0    [1    /1   ]  314.777709853        1
[INPUT] 1    0    [1    /1   ]  64.7753993742        1
[INPUT] 1    0    [1    /1   ]  8.826461284          1
[INPUT] 1    0    [1    /1   ]  22.2398575431        1
[INPUT] 1    0    [1    /1   ]  0.826008054982       1
[INPUT] 1    0    [1    /1   ]  3.37280549884        1
[INPUT] 1    0    [1    /1   ]  0.234509318683       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.58263928104, 1.0]], [0, [7617.4316327789065, 1.0]], [0, [3616.6224647721024, 1.0]], [0, [1592.8920659061025, 1.0]], [0, [235.8860429116432, 1.0]], [0, [51.59009418010091, 1.0]], [0, [4.600461343434636, 1.0]], [0, [0.39805891575684055, 1.0]], [1, [1362.7935763319742, 1.0]], [1, [664.8775168553607, 1.0]], [1, [301.75897125731643, 1.0]], [1, [314.777709853089, 1.0]], [1, [64.77539937423639, 1.0]], [1, [8.826461284004361, 1.0]], [1, [22.239857543124792, 1.0]], [1, [0.8260080549816506, 1.0]], [1, [3.372805498835374, 1.0]], [1, [0.23450931868257316, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.58263928]
bas 1, expnt(s) = [7617.43163278]
bas 2, expnt(s) = [3616.62246477]
bas 3, expnt(s) = [1592.89206591]
bas 4, expnt(s) = [235.88604291]
bas 5, expnt(s) = [51.59009418]
bas 6, expnt(s) = [4.60046134]
bas 7, expnt(s) = [0.39805892]
bas 8, expnt(s) = [1362.79357633]
bas 9, expnt(s) = [664.87751686]
bas 10, expnt(s) = [301.75897126]
bas 11, expnt(s) = [314.77770985]
bas 12, expnt(s) = [64.77539937]
bas 13, expnt(s) = [8.82646128]
bas 14, expnt(s) = [22.23985754]
bas 15, expnt(s) = [0.82600805]
bas 16, expnt(s) = [3.3728055]
bas 17, expnt(s) = [0.23450932]
CPU time:       394.23
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825826e+04 5.20025196e+03 7.61743163e+03 2.06002005e+03
 3.61662246e+03 1.17826345e+03 1.59289207e+03 6.37022520e+02
 2.35886043e+02 1.52069356e+02 5.15900942e+01 4.86339747e+01
 4.60046134e+00 7.93626322e+00 3.98058916e-01 1.26612196e+00
 1.36279358e+03 2.41558314e+04 6.64877517e+02 9.84943802e+03
 3.01758971e+02 3.66910069e+03 3.14777710e+02 3.86802575e+03
 6.47753994e+01 5.36101493e+02 8.82646128e+00 4.43831036e+01
 2.22398575e+01 1.40896237e+02 8.26008055e-01 2.29728431e+00
 3.37280550e+00 1.33344011e+01 2.34509319e-01 4.76085028e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.971669022415572
cond(S) = 110561.1395499204
E1 = -727.529281450459  E_coul = 203.10815450055983
init E= -524.421126949899
    CPU time for initialize scf      0.16 sec, wall time      0.04 sec
  HOMO = -0.559179206619262  LUMO = 1.12301701254767
  mo_energy =
[-1.17880713e+02 -1.20935555e+01 -9.44778017e+00 -9.44778017e+00
 -9.44778017e+00 -1.23033724e+00 -5.59179207e-01 -5.59179207e-01
 -5.59179207e-01  1.12301701e+00  1.12301701e+00  1.12301701e+00
  9.03976302e+00  9.03976302e+00  9.03976302e+00  4.05853412e+01
  4.05853412e+01  4.05853412e+01  1.44791663e+02  1.44791663e+02
  1.44791663e+02  1.79755330e+02  5.05845191e+02  5.05845191e+02
  5.05845191e+02  1.36021351e+03  1.36021351e+03  1.36021351e+03
  1.88720758e+03  3.05616828e+03  3.05616828e+03  3.05616828e+03
  6.67665119e+03  6.67665119e+03  6.67665119e+03  8.20331893e+03
  2.45586667e+04  7.53436522e+04]
E1 = -727.4167967821032  E_coul = 201.8566692370019
cycle= 1 E= -525.560127545101  delta_E= -1.14  |g|= 0.184  |ddm|= 0.439
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.468407
diis-c [-0.21940535  1.        ]
  HOMO = -0.570149948635723  LUMO = 1.11641739418116
  mo_energy =
[-1.18118981e+02 -1.21780740e+01 -9.53170729e+00 -9.53170729e+00
 -9.53170729e+00 -1.24920670e+00 -5.70149949e-01 -5.70149949e-01
 -5.70149949e-01  1.11641739e+00  1.11641739e+00  1.11641739e+00
  8.98741589e+00  8.98741589e+00  8.98741589e+00  4.04887875e+01
  4.04887875e+01  4.04887875e+01  1.44634854e+02  1.44634854e+02
  1.44634854e+02  1.79571125e+02  5.05622135e+02  5.05622135e+02
  5.05622135e+02  1.35994050e+03  1.35994050e+03  1.35994050e+03
  1.88681081e+03  3.05583238e+03  3.05583238e+03  3.05583238e+03
  6.67619676e+03  6.67619676e+03  6.67619676e+03  8.20278016e+03
  2.45580323e+04  7.53429253e+04]
E1 = -727.6114825431974  E_coul = 202.05118071192183
cycle= 2 E= -525.560301831276  delta_E= -0.000174  |g|= 0.0148  |ddm|= 0.0136
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.030373
diis-c [-7.09053639e-04  3.02957947e-02  9.69704205e-01]
  HOMO = -0.567719414639457  LUMO = 1.1185046734258
  mo_energy =
[-1.18090323e+02 -1.21644492e+01 -9.51787767e+00 -9.51787767e+00
 -9.51787767e+00 -1.24594702e+00 -5.67719415e-01 -5.67719415e-01
 -5.67719415e-01  1.11850467e+00  1.11850467e+00  1.11850467e+00
  8.99582649e+00  8.99582649e+00  8.99582649e+00  4.05040331e+01
  4.05040331e+01  4.05040331e+01  1.44657520e+02  1.44657520e+02
  1.44657520e+02  1.79598586e+02  5.05650297e+02  5.05650297e+02
  5.05650297e+02  1.35997071e+03  1.35997071e+03  1.35997071e+03
  1.88684243e+03  3.05586361e+03  3.05586361e+03  3.05586361e+03
  6.67622855e+03  6.67622855e+03  6.67622855e+03  8.20281215e+03
  2.45580643e+04  7.53429572e+04]
E1 = -727.571781319207  E_coul = 202.01147417388094
cycle= 3 E= -525.560307145326  delta_E= -5.31e-06  |g|= 0.00202  |ddm|= 0.00344
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00433278
diis-c [-8.21867181e-08 -7.60010393e-04  1.19895176e-01  8.80864834e-01]
  HOMO = -0.56819798632744  LUMO = 1.11810798883336
  mo_energy =
[-1.18094151e+02 -1.21665594e+01 -9.52003187e+00 -9.52003187e+00
 -9.52003187e+00 -1.24657764e+00 -5.68197986e-01 -5.68197986e-01
 -5.68197986e-01  1.11810799e+00  1.11810799e+00  1.11810799e+00
  8.99439752e+00  8.99439752e+00  8.99439752e+00  4.05017348e+01
  4.05017348e+01  4.05017348e+01  1.44654370e+02  1.44654370e+02
  1.44654370e+02  1.79594945e+02  5.05646532e+02  5.05646532e+02
  5.05646532e+02  1.35996670e+03  1.35996670e+03  1.35996670e+03
  1.88683821e+03  3.05585946e+03  3.05585946e+03  3.05585946e+03
  6.67622426e+03  6.67622426e+03  6.67622426e+03  8.20280779e+03
  2.45580599e+04  7.53429527e+04]
E1 = -727.5776588728963  E_coul = 202.0173515836176
cycle= 4 E= -525.560307289279  delta_E= -1.44e-07  |g|= 3.56e-05  |ddm|= 0.000556
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.33568e-05
diis-c [-4.11976360e-10 -2.48893952e-05  3.37145123e-03  3.79831164e-02
  9.58670322e-01]
  HOMO = -0.568177014936782  LUMO = 1.1181248589581
  mo_energy =
[-1.18094069e+02 -1.21664911e+01 -9.51996298e+00 -9.51996298e+00
 -9.51996298e+00 -1.24655038e+00 -5.68177015e-01 -5.68177015e-01
 -5.68177015e-01  1.11812486e+00  1.11812486e+00  1.11812486e+00
  8.99445019e+00  8.99445019e+00  8.99445019e+00  4.05018037e+01
  4.05018037e+01  4.05018037e+01  1.44654447e+02  1.44654447e+02
  1.44654447e+02  1.79595026e+02  5.05646613e+02  5.05646613e+02
  5.05646613e+02  1.35996678e+03  1.35996678e+03  1.35996678e+03
  1.88683829e+03  3.05585954e+03  3.05585954e+03  3.05585954e+03
  6.67622434e+03  6.67622434e+03  6.67622434e+03  8.20280787e+03
  2.45580599e+04  7.53429528e+04]
E1 = -727.5774914347243  E_coul = 202.01718414533772
cycle= 5 E= -525.560307289387  delta_E= -1.08e-10  |g|= 2.47e-06  |ddm|= 1.88e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5774914347243  E_coul = 202.01718414533772
  HOMO = -0.568178341434572  LUMO = 1.11812379066581
  mo_energy =
[-1.18094075e+02 -1.21664958e+01 -9.51996774e+00 -9.51996774e+00
 -9.51996774e+00 -1.24655211e+00 -5.68178341e-01 -5.68178341e-01
 -5.68178341e-01  1.11812379e+00  1.11812379e+00  1.11812379e+00
  8.99444671e+00  8.99444671e+00  8.99444671e+00  4.05017988e+01
  4.05017988e+01  4.05017988e+01  1.44654441e+02  1.44654441e+02
  1.44654441e+02  1.79595020e+02  5.05646607e+02  5.05646607e+02
  5.05646607e+02  1.35996678e+03  1.35996678e+03  1.35996678e+03
  1.88683828e+03  3.05585954e+03  3.05585954e+03  3.05585954e+03
  6.67622434e+03  6.67622434e+03  6.67622434e+03  8.20280786e+03
  2.45580599e+04  7.53429528e+04]
E1 = -727.5775034151204  E_coul = 202.0171961257349
Extra cycle  E= -525.560307289385  delta_E= 1.02e-12  |g|= 6.01e-07  |ddm|= 1.3e-06
    CPU time for scf_cycle      0.35 sec, wall time      0.23 sec
exp = [2.61825826e+04 7.61743163e+03 3.61662246e+03 1.59289207e+03
 2.35886043e+02 5.15900942e+01 4.60046134e+00 3.98058916e-01
 1.36279358e+03 6.64877517e+02 3.01758971e+02 3.14777710e+02
 6.47753994e+01 8.82646128e+00 2.22398575e+01 8.26008055e-01
 3.37280550e+00 2.34509319e-01]
E = -525.5603072893855
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5826393        1
[INPUT] 0    0    [1    /1   ]  7617.43163278        1
[INPUT] 0    0    [1    /1   ]  3616.62246477        1
[INPUT] 0    0    [1    /1   ]  1592.89206591        1
[INPUT] 0    0    [1    /1   ]  235.886042912        1
[INPUT] 0    0    [1    /1   ]  51.5900941801        1
[INPUT] 0    0    [1    /1   ]  4.60046134343        1
[INPUT] 0    0    [1    /1   ]  0.398058915757       1
[INPUT] 1    0    [1    /1   ]  1362.79357633        1
[INPUT] 1    0    [1    /1   ]  664.877516855        1
[INPUT] 1    0    [1    /1   ]  301.758971257        1
[INPUT] 1    0    [1    /1   ]  314.777709853        1
[INPUT] 1    0    [1    /1   ]  64.7753993742        1
[INPUT] 1    0    [1    /1   ]  8.826461284          1
[INPUT] 1    0    [1    /1   ]  22.2398575431        1
[INPUT] 1    0    [1    /1   ]  0.826008054982       1
[INPUT] 1    0    [1    /1   ]  3.37280549884        1
[INPUT] 1    0    [1    /1   ]  0.234509318683       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.58263928104, 1.0]], [0, [7617.4316327789065, 1.0]], [0, [3616.6224647721024, 1.0]], [0, [1592.8920659061025, 1.0]], [0, [235.8860429116432, 1.0]], [0, [51.59009418010091, 1.0]], [0, [4.600461343434636, 1.0]], [0, [0.39805891575684055, 1.0]], [1, [1362.7935763319742, 1.0]], [1, [664.8775168553607, 1.0]], [1, [301.75897125731643, 1.0]], [1, [314.777709853089, 1.0]], [1, [64.77539937423639, 1.0]], [1, [8.826461284004361, 1.0]], [1, [22.239857543124792, 1.0]], [1, [0.8260080549816506, 1.0]], [1, [3.372805498835374, 1.0]], [1, [0.23450931868257316, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.58263928]
bas 1, expnt(s) = [7617.43163278]
bas 2, expnt(s) = [3616.62246477]
bas 3, expnt(s) = [1592.89206591]
bas 4, expnt(s) = [235.88604291]
bas 5, expnt(s) = [51.59009418]
bas 6, expnt(s) = [4.60046134]
bas 7, expnt(s) = [0.39805892]
bas 8, expnt(s) = [1362.79357633]
bas 9, expnt(s) = [664.87751686]
bas 10, expnt(s) = [301.75897126]
bas 11, expnt(s) = [314.77770985]
bas 12, expnt(s) = [64.77539937]
bas 13, expnt(s) = [8.82646128]
bas 14, expnt(s) = [22.23985754]
bas 15, expnt(s) = [0.82600805]
bas 16, expnt(s) = [3.3728055]
bas 17, expnt(s) = [0.23450932]
CPU time:       394.81
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825826e+04 5.20025196e+03 7.61743163e+03 2.06002005e+03
 3.61662246e+03 1.17826345e+03 1.59289207e+03 6.37022520e+02
 2.35886043e+02 1.52069356e+02 5.15900942e+01 4.86339747e+01
 4.60046134e+00 7.93626322e+00 3.98058916e-01 1.26612196e+00
 1.36279358e+03 2.41558314e+04 6.64877517e+02 9.84943802e+03
 3.01758971e+02 3.66910069e+03 3.14777710e+02 3.86802575e+03
 6.47753994e+01 5.36101493e+02 8.82646128e+00 4.43831036e+01
 2.22398575e+01 1.40896237e+02 8.26008055e-01 2.29728431e+00
 3.37280550e+00 1.33344011e+01 2.34509319e-01 4.76085028e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.971669022415572
cond(S) = 110561.1395499204
E1 = -727.529281450459  E_coul = 203.10815450055983
init E= -524.421126949899
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.559179206619262  LUMO = 1.12301701254767
  mo_energy =
[-1.17880713e+02 -1.20935555e+01 -9.44778017e+00 -9.44778017e+00
 -9.44778017e+00 -1.23033724e+00 -5.59179207e-01 -5.59179207e-01
 -5.59179207e-01  1.12301701e+00  1.12301701e+00  1.12301701e+00
  9.03976302e+00  9.03976302e+00  9.03976302e+00  4.05853412e+01
  4.05853412e+01  4.05853412e+01  1.44791663e+02  1.44791663e+02
  1.44791663e+02  1.79755330e+02  5.05845191e+02  5.05845191e+02
  5.05845191e+02  1.36021351e+03  1.36021351e+03  1.36021351e+03
  1.88720758e+03  3.05616828e+03  3.05616828e+03  3.05616828e+03
  6.67665119e+03  6.67665119e+03  6.67665119e+03  8.20331893e+03
  2.45586667e+04  7.53436522e+04]
E1 = -727.4167967821032  E_coul = 201.8566692370019
cycle= 1 E= -525.560127545101  delta_E= -1.14  |g|= 0.184  |ddm|= 0.439
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.468407
diis-c [-0.21940535  1.        ]
  HOMO = -0.570149948635723  LUMO = 1.11641739418116
  mo_energy =
[-1.18118981e+02 -1.21780740e+01 -9.53170729e+00 -9.53170729e+00
 -9.53170729e+00 -1.24920670e+00 -5.70149949e-01 -5.70149949e-01
 -5.70149949e-01  1.11641739e+00  1.11641739e+00  1.11641739e+00
  8.98741589e+00  8.98741589e+00  8.98741589e+00  4.04887875e+01
  4.04887875e+01  4.04887875e+01  1.44634854e+02  1.44634854e+02
  1.44634854e+02  1.79571125e+02  5.05622135e+02  5.05622135e+02
  5.05622135e+02  1.35994050e+03  1.35994050e+03  1.35994050e+03
  1.88681081e+03  3.05583238e+03  3.05583238e+03  3.05583238e+03
  6.67619676e+03  6.67619676e+03  6.67619676e+03  8.20278016e+03
  2.45580323e+04  7.53429253e+04]
E1 = -727.6114825431974  E_coul = 202.05118071192183
cycle= 2 E= -525.560301831276  delta_E= -0.000174  |g|= 0.0148  |ddm|= 0.0136
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.030373
diis-c [-7.09053639e-04  3.02957947e-02  9.69704205e-01]
  HOMO = -0.567719414639457  LUMO = 1.1185046734258
  mo_energy =
[-1.18090323e+02 -1.21644492e+01 -9.51787767e+00 -9.51787767e+00
 -9.51787767e+00 -1.24594702e+00 -5.67719415e-01 -5.67719415e-01
 -5.67719415e-01  1.11850467e+00  1.11850467e+00  1.11850467e+00
  8.99582649e+00  8.99582649e+00  8.99582649e+00  4.05040331e+01
  4.05040331e+01  4.05040331e+01  1.44657520e+02  1.44657520e+02
  1.44657520e+02  1.79598586e+02  5.05650297e+02  5.05650297e+02
  5.05650297e+02  1.35997071e+03  1.35997071e+03  1.35997071e+03
  1.88684243e+03  3.05586361e+03  3.05586361e+03  3.05586361e+03
  6.67622855e+03  6.67622855e+03  6.67622855e+03  8.20281215e+03
  2.45580643e+04  7.53429572e+04]
E1 = -727.571781319207  E_coul = 202.01147417388094
cycle= 3 E= -525.560307145326  delta_E= -5.31e-06  |g|= 0.00202  |ddm|= 0.00344
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00433278
diis-c [-8.21867181e-08 -7.60010393e-04  1.19895176e-01  8.80864834e-01]
  HOMO = -0.56819798632744  LUMO = 1.11810798883336
  mo_energy =
[-1.18094151e+02 -1.21665594e+01 -9.52003187e+00 -9.52003187e+00
 -9.52003187e+00 -1.24657764e+00 -5.68197986e-01 -5.68197986e-01
 -5.68197986e-01  1.11810799e+00  1.11810799e+00  1.11810799e+00
  8.99439752e+00  8.99439752e+00  8.99439752e+00  4.05017348e+01
  4.05017348e+01  4.05017348e+01  1.44654370e+02  1.44654370e+02
  1.44654370e+02  1.79594945e+02  5.05646532e+02  5.05646532e+02
  5.05646532e+02  1.35996670e+03  1.35996670e+03  1.35996670e+03
  1.88683821e+03  3.05585946e+03  3.05585946e+03  3.05585946e+03
  6.67622426e+03  6.67622426e+03  6.67622426e+03  8.20280779e+03
  2.45580599e+04  7.53429527e+04]
E1 = -727.5776588728963  E_coul = 202.0173515836176
cycle= 4 E= -525.560307289279  delta_E= -1.44e-07  |g|= 3.56e-05  |ddm|= 0.000556
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.33568e-05
diis-c [-4.11976360e-10 -2.48893952e-05  3.37145123e-03  3.79831164e-02
  9.58670322e-01]
  HOMO = -0.568177014936782  LUMO = 1.1181248589581
  mo_energy =
[-1.18094069e+02 -1.21664911e+01 -9.51996298e+00 -9.51996298e+00
 -9.51996298e+00 -1.24655038e+00 -5.68177015e-01 -5.68177015e-01
 -5.68177015e-01  1.11812486e+00  1.11812486e+00  1.11812486e+00
  8.99445019e+00  8.99445019e+00  8.99445019e+00  4.05018037e+01
  4.05018037e+01  4.05018037e+01  1.44654447e+02  1.44654447e+02
  1.44654447e+02  1.79595026e+02  5.05646613e+02  5.05646613e+02
  5.05646613e+02  1.35996678e+03  1.35996678e+03  1.35996678e+03
  1.88683829e+03  3.05585954e+03  3.05585954e+03  3.05585954e+03
  6.67622434e+03  6.67622434e+03  6.67622434e+03  8.20280787e+03
  2.45580599e+04  7.53429528e+04]
E1 = -727.5774914347243  E_coul = 202.01718414533772
cycle= 5 E= -525.560307289387  delta_E= -1.08e-10  |g|= 2.47e-06  |ddm|= 1.88e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5774914347243  E_coul = 202.01718414533772
  HOMO = -0.568178341434572  LUMO = 1.11812379066581
  mo_energy =
[-1.18094075e+02 -1.21664958e+01 -9.51996774e+00 -9.51996774e+00
 -9.51996774e+00 -1.24655211e+00 -5.68178341e-01 -5.68178341e-01
 -5.68178341e-01  1.11812379e+00  1.11812379e+00  1.11812379e+00
  8.99444671e+00  8.99444671e+00  8.99444671e+00  4.05017988e+01
  4.05017988e+01  4.05017988e+01  1.44654441e+02  1.44654441e+02
  1.44654441e+02  1.79595020e+02  5.05646607e+02  5.05646607e+02
  5.05646607e+02  1.35996678e+03  1.35996678e+03  1.35996678e+03
  1.88683828e+03  3.05585954e+03  3.05585954e+03  3.05585954e+03
  6.67622434e+03  6.67622434e+03  6.67622434e+03  8.20280786e+03
  2.45580599e+04  7.53429528e+04]
E1 = -727.5775034151204  E_coul = 202.0171961257349
Extra cycle  E= -525.560307289385  delta_E= 1.02e-12  |g|= 6.01e-07  |ddm|= 1.3e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 110561.1395499204
E1 = -727.5775034151204  E_coul = 202.0171961257349
init E= -525.560307289385
    CPU time for initialize scf      0.97 sec, wall time      0.20 sec
  HOMO = -0.568178115561318  LUMO = 1.11812397568604
  mo_energy =
[-1.18094074e+02 -1.21664949e+01 -9.51996684e+00 -9.51996684e+00
 -9.51996684e+00 -1.24655182e+00 -5.68178116e-01 -5.68178116e-01
 -5.68178116e-01  1.11812398e+00  1.11812398e+00  1.11812398e+00
  8.99444734e+00  8.99444734e+00  8.99444734e+00  4.05017998e+01
  4.05017998e+01  4.05017998e+01  1.44654443e+02  1.44654443e+02
  1.44654443e+02  1.79595021e+02  5.05646608e+02  5.05646608e+02
  5.05646608e+02  1.35996678e+03  1.35996678e+03  1.35996678e+03
  1.88683828e+03  3.05585954e+03  3.05585954e+03  3.05585954e+03
  6.67622434e+03  6.67622434e+03  6.67622434e+03  8.20280786e+03
  2.45580599e+04  7.53429528e+04]
E1 = -727.5775010460709  E_coul = 202.01719375668455
cycle= 1 E= -525.560307289386  delta_E= -9.09e-13  |g|= 1.28e-07  |ddm|= 2.36e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.5775010460709  E_coul = 202.01719375668455
  HOMO = -0.568178157820942  LUMO = 1.11812394092407
  mo_energy =
[-1.18094074e+02 -1.21664951e+01 -9.51996701e+00 -9.51996701e+00
 -9.51996701e+00 -1.24655187e+00 -5.68178158e-01 -5.68178158e-01
 -5.68178158e-01  1.11812394e+00  1.11812394e+00  1.11812394e+00
  8.99444722e+00  8.99444722e+00  8.99444722e+00  4.05017996e+01
  4.05017996e+01  4.05017996e+01  1.44654442e+02  1.44654442e+02
  1.44654442e+02  1.79595021e+02  5.05646608e+02  5.05646608e+02
  5.05646608e+02  1.35996678e+03  1.35996678e+03  1.35996678e+03
  1.88683828e+03  3.05585954e+03  3.05585954e+03  3.05585954e+03
  6.67622434e+03  6.67622434e+03  6.67622434e+03  8.20280786e+03
  2.45580599e+04  7.53429528e+04]
E1 = -727.5775015200379  E_coul = 202.01719423065163
Extra cycle  E= -525.560307289386  delta_E= 1.14e-13  |g|= 2.62e-08  |ddm|= 4.65e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.33 sec
exp = [2.61825826e+04 7.61743163e+03 3.61662246e+03 1.59289207e+03
 2.35886043e+02 5.15900942e+01 4.60046134e+00 3.98058916e-01
 1.36279358e+03 6.64877517e+02 3.01758971e+02 3.14777710e+02
 6.47753994e+01 8.82646128e+00 2.22398575e+01 8.26008055e-01
 3.37280550e+00 2.34509319e-01]
grad_E = [-1.99043462e-06  2.25873110e-05  4.49906916e-05  7.31584519e-04
 -6.83364744e-04 -2.07787584e-03 -1.77064333e-03 -1.78900170e-03
 -6.30602134e-07  2.93040134e-06  1.19744437e-05  1.03248149e-05
  6.46155627e-04  1.78351164e-02 -5.76937227e-03 -7.73561986e-03
 -1.15433567e-02  1.72893955e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6316241        1
[INPUT] 0    0    [1    /1   ]  7616.89725999        1
[INPUT] 0    0    [1    /1   ]  3615.5636305         1
[INPUT] 0    0    [1    /1   ]  1576.32285389        1
[INPUT] 0    0    [1    /1   ]  232.339728171        1
[INPUT] 0    0    [1    /1   ]  51.1286211538        1
[INPUT] 0    0    [1    /1   ]  4.60065766217        1
[INPUT] 0    0    [1    /1   ]  0.397734155245       1
[INPUT] 1    0    [1    /1   ]  1362.8054977         1
[INPUT] 1    0    [1    /1   ]  664.776871259        1
[INPUT] 1    0    [1    /1   ]  301.290395155        1
[INPUT] 1    0    [1    /1   ]  314.370983584        1
[INPUT] 1    0    [1    /1   ]  63.8197663237        1
[INPUT] 1    0    [1    /1   ]  9.12608387054        1
[INPUT] 1    0    [1    /1   ]  22.2899069774        1
[INPUT] 1    0    [1    /1   ]  0.834686819943       1
[INPUT] 1    0    [1    /1   ]  3.46834371731        1
[INPUT] 1    0    [1    /1   ]  0.236768642857       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.631624120306, 1.0]], [0, [7616.8972599938, 1.0]], [0, [3615.5636304960954, 1.0]], [0, [1576.322853894684, 1.0]], [0, [232.33972817081172, 1.0]], [0, [51.128621153842, 1.0]], [0, [4.600657662173397, 1.0]], [0, [0.3977341552447602, 1.0]], [1, [1362.8054977011893, 1.0]], [1, [664.7768712587547, 1.0]], [1, [301.29039515485897, 1.0]], [1, [314.37098358436066, 1.0]], [1, [63.81976632366752, 1.0]], [1, [9.126083870540674, 1.0]], [1, [22.289906977366872, 1.0]], [1, [0.8346868199432669, 1.0]], [1, [3.4683437173132043, 1.0]], [1, [0.23676864285680643, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.63162412]
bas 1, expnt(s) = [7616.89725999]
bas 2, expnt(s) = [3615.5636305]
bas 3, expnt(s) = [1576.32285389]
bas 4, expnt(s) = [232.33972817]
bas 5, expnt(s) = [51.12862115]
bas 6, expnt(s) = [4.60065766]
bas 7, expnt(s) = [0.39773416]
bas 8, expnt(s) = [1362.8054977]
bas 9, expnt(s) = [664.77687126]
bas 10, expnt(s) = [301.29039515]
bas 11, expnt(s) = [314.37098358]
bas 12, expnt(s) = [63.81976632]
bas 13, expnt(s) = [9.12608387]
bas 14, expnt(s) = [22.28990698]
bas 15, expnt(s) = [0.83468682]
bas 16, expnt(s) = [3.46834372]
bas 17, expnt(s) = [0.23676864]
CPU time:       400.74
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826316e+04 5.20025926e+03 7.61689726e+03 2.05991167e+03
 3.61556363e+03 1.17800472e+03 1.57632285e+03 6.32046315e+02
 2.32339728e+02 1.50351454e+02 5.11286212e+01 4.83073356e+01
 4.60065766e+00 7.93651722e+00 3.97734155e-01 1.26534715e+00
 1.36280550e+03 2.41560955e+04 6.64776871e+02 9.84757436e+03
 3.01290395e+02 3.66198028e+03 3.14370984e+02 3.86177939e+03
 6.38197663e+01 5.26233394e+02 9.12608387e+00 4.62743111e+01
 2.22899070e+01 1.41292696e+02 8.34686820e-01 2.32749543e+00
 3.46834372e+00 1.38081996e+01 2.36768643e-01 4.81825326e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.971299025854375
cond(S) = 108119.17132025231
E1 = -727.5081343493162  E_coul = 203.09941384227076
init E= -524.408720507045
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.559129246786464  LUMO = 1.14053111091213
  mo_energy =
[-1.17887087e+02 -1.20926855e+01 -9.44811541e+00 -9.44811541e+00
 -9.44811541e+00 -1.23031735e+00 -5.59129247e-01 -5.59129247e-01
 -5.59129247e-01  1.14053111e+00  1.14053111e+00  1.14053111e+00
  9.35160192e+00  9.35160192e+00  9.35160192e+00  4.16751240e+01
  4.16751240e+01  4.16751240e+01  1.45408872e+02  1.45408872e+02
  1.45408872e+02  1.76423712e+02  5.04277244e+02  5.04277244e+02
  5.04277244e+02  1.35699374e+03  1.35699374e+03  1.35699374e+03
  1.86520703e+03  3.05152999e+03  3.05152999e+03  3.05152999e+03
  6.67125561e+03  6.67125561e+03  6.67125561e+03  8.15307656e+03
  2.44873646e+04  7.52652910e+04]
E1 = -727.4158803662041  E_coul = 201.85176571179576
cycle= 1 E= -525.564114654408  delta_E= -1.16  |g|= 0.187  |ddm|= 0.465
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.474232
diis-c [-0.22489603  1.        ]
  HOMO = -0.569614888375381  LUMO = 1.13409802240263
  mo_energy =
[-1.18126826e+02 -1.21767116e+01 -9.53177878e+00 -9.53177878e+00
 -9.53177878e+00 -1.24856230e+00 -5.69614888e-01 -5.69614888e-01
 -5.69614888e-01  1.13409802e+00  1.13409802e+00  1.13409802e+00
  9.29862037e+00  9.29862037e+00  9.29862037e+00  4.15781407e+01
  4.15781407e+01  4.15781407e+01  1.45252205e+02  1.45252205e+02
  1.45252205e+02  1.76239664e+02  5.04052657e+02  5.04052657e+02
  5.04052657e+02  1.35671792e+03  1.35671792e+03  1.35671792e+03
  1.86480532e+03  3.05118968e+03  3.05118968e+03  3.05118968e+03
  6.67079390e+03  6.67079390e+03  6.67079390e+03  8.15252900e+03
  2.44867195e+04  7.52645524e+04]
E1 = -727.610572963983  E_coul = 202.04628012235372
cycle= 2 E= -525.564292841629  delta_E= -0.000178  |g|= 0.015  |ddm|= 0.0136
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0306844
diis-c [-7.19970385e-04  3.04796174e-02  9.69520383e-01]
  HOMO = -0.567206348294216  LUMO = 1.13620374386232
  mo_energy =
[-1.18098012e+02 -1.21631075e+01 -9.51796729e+00 -9.51796729e+00
 -9.51796729e+00 -1.24533384e+00 -5.67206348e-01 -5.67206348e-01
 -5.67206348e-01  1.13620374e+00  1.13620374e+00  1.13620374e+00
  9.30717143e+00  9.30717143e+00  9.30717143e+00  4.15934681e+01
  4.15934681e+01  4.15934681e+01  1.45274869e+02  1.45274869e+02
  1.45274869e+02  1.76267196e+02  5.04080947e+02  5.04080947e+02
  5.04080947e+02  1.35674830e+03  1.35674830e+03  1.35674830e+03
  1.86483716e+03  3.05122112e+03  3.05122112e+03  3.05122112e+03
  6.67082591e+03  6.67082591e+03  6.67082591e+03  8.15256121e+03
  2.44867517e+04  7.52645845e+04]
E1 = -727.5709940625086  E_coul = 202.0066958833649
cycle= 3 E= -525.564298179144  delta_E= -5.34e-06  |g|= 0.00202  |ddm|= 0.00342
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00434621
diis-c [-8.39162182e-08 -7.72240224e-04  1.18973254e-01  8.81798986e-01]
  HOMO = -0.567680816795595  LUMO = 1.1358040657565
  mo_energy =
[-1.18101836e+02 -1.21652087e+01 -9.52011340e+00 -9.52011340e+00
 -9.52011340e+00 -1.24595896e+00 -5.67680817e-01 -5.67680817e-01
 -5.67680817e-01  1.13580407e+00  1.13580407e+00  1.13580407e+00
  9.30572554e+00  9.30572554e+00  9.30572554e+00  4.15911674e+01
  4.15911674e+01  4.15911674e+01  1.45271734e+02  1.45271734e+02
  1.45271734e+02  1.76263568e+02  5.04077188e+02  5.04077188e+02
  5.04077188e+02  1.35674430e+03  1.35674430e+03  1.35674430e+03
  1.86483293e+03  3.05121697e+03  3.05121697e+03  3.05121697e+03
  6.67082162e+03  6.67082162e+03  6.67082162e+03  8.15255685e+03
  2.44867473e+04  7.52645800e+04]
E1 = -727.5768269442253  E_coul = 202.0125286225553
cycle= 4 E= -525.56429832167  delta_E= -1.43e-07  |g|= 3.58e-05  |ddm|= 0.000553
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.35035e-05
diis-c [-4.33881552e-10 -2.48109175e-05  3.22553358e-03  3.71193634e-02
  9.59679914e-01]
  HOMO = -0.56765969676951  LUMO = 1.13582130831411
  mo_energy =
[-1.18101754e+02 -1.21651400e+01 -9.52004405e+00 -9.52004405e+00
 -9.52004405e+00 -1.24593151e+00 -5.67659697e-01 -5.67659697e-01
 -5.67659697e-01  1.13582131e+00  1.13582131e+00  1.13582131e+00
  9.30577923e+00  9.30577923e+00  9.30577923e+00  4.15912369e+01
  4.15912369e+01  4.15912369e+01  1.45271812e+02  1.45271812e+02
  1.45271812e+02  1.76263650e+02  5.04077270e+02  5.04077270e+02
  5.04077270e+02  1.35674438e+03  1.35674438e+03  1.35674438e+03
  1.86483301e+03  3.05121705e+03  3.05121705e+03  3.05121705e+03
  6.67082170e+03  6.67082170e+03  6.67082170e+03  8.15255693e+03
  2.44867474e+04  7.52645801e+04]
E1 = -727.5766594706175  E_coul = 202.01236114883957
cycle= 5 E= -525.564298321778  delta_E= -1.08e-10  |g|= 2.54e-06  |ddm|= 1.88e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5766594706175  E_coul = 202.01236114883957
  HOMO = -0.567661052659822  LUMO = 1.13582019963759
  mo_energy =
[-1.18101761e+02 -1.21651448e+01 -9.52004893e+00 -9.52004893e+00
 -9.52004893e+00 -1.24593328e+00 -5.67661053e-01 -5.67661053e-01
 -5.67661053e-01  1.13582020e+00  1.13582020e+00  1.13582020e+00
  9.30577562e+00  9.30577562e+00  9.30577562e+00  4.15912319e+01
  4.15912319e+01  4.15912319e+01  1.45271806e+02  1.45271806e+02
  1.45271806e+02  1.76263644e+02  5.04077264e+02  5.04077264e+02
  5.04077264e+02  1.35674438e+03  1.35674438e+03  1.35674438e+03
  1.86483300e+03  3.05121705e+03  3.05121705e+03  3.05121705e+03
  6.67082170e+03  6.67082170e+03  6.67082170e+03  8.15255692e+03
  2.44867474e+04  7.52645801e+04]
E1 = -727.5766716898454  E_coul = 202.0123733680674
Extra cycle  E= -525.564298321778  delta_E=    0  |g|= 6.16e-07  |ddm|= 1.33e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.24 sec
exp = [2.61826316e+04 7.61689726e+03 3.61556363e+03 1.57632285e+03
 2.32339728e+02 5.11286212e+01 4.60065766e+00 3.97734155e-01
 1.36280550e+03 6.64776871e+02 3.01290395e+02 3.14370984e+02
 6.38197663e+01 9.12608387e+00 2.22899070e+01 8.34686820e-01
 3.46834372e+00 2.36768643e-01]
E = -525.564298321778
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6316241        1
[INPUT] 0    0    [1    /1   ]  7616.89725999        1
[INPUT] 0    0    [1    /1   ]  3615.5636305         1
[INPUT] 0    0    [1    /1   ]  1576.32285389        1
[INPUT] 0    0    [1    /1   ]  232.339728171        1
[INPUT] 0    0    [1    /1   ]  51.1286211538        1
[INPUT] 0    0    [1    /1   ]  4.60065766217        1
[INPUT] 0    0    [1    /1   ]  0.397734155245       1
[INPUT] 1    0    [1    /1   ]  1362.8054977         1
[INPUT] 1    0    [1    /1   ]  664.776871259        1
[INPUT] 1    0    [1    /1   ]  301.290395155        1
[INPUT] 1    0    [1    /1   ]  314.370983584        1
[INPUT] 1    0    [1    /1   ]  63.8197663237        1
[INPUT] 1    0    [1    /1   ]  9.12608387054        1
[INPUT] 1    0    [1    /1   ]  22.2899069774        1
[INPUT] 1    0    [1    /1   ]  0.834686819943       1
[INPUT] 1    0    [1    /1   ]  3.46834371731        1
[INPUT] 1    0    [1    /1   ]  0.236768642857       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.631624120306, 1.0]], [0, [7616.8972599938, 1.0]], [0, [3615.5636304960954, 1.0]], [0, [1576.322853894684, 1.0]], [0, [232.33972817081172, 1.0]], [0, [51.128621153842, 1.0]], [0, [4.600657662173397, 1.0]], [0, [0.3977341552447602, 1.0]], [1, [1362.8054977011893, 1.0]], [1, [664.7768712587547, 1.0]], [1, [301.29039515485897, 1.0]], [1, [314.37098358436066, 1.0]], [1, [63.81976632366752, 1.0]], [1, [9.126083870540674, 1.0]], [1, [22.289906977366872, 1.0]], [1, [0.8346868199432669, 1.0]], [1, [3.4683437173132043, 1.0]], [1, [0.23676864285680643, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.63162412]
bas 1, expnt(s) = [7616.89725999]
bas 2, expnt(s) = [3615.5636305]
bas 3, expnt(s) = [1576.32285389]
bas 4, expnt(s) = [232.33972817]
bas 5, expnt(s) = [51.12862115]
bas 6, expnt(s) = [4.60065766]
bas 7, expnt(s) = [0.39773416]
bas 8, expnt(s) = [1362.8054977]
bas 9, expnt(s) = [664.77687126]
bas 10, expnt(s) = [301.29039515]
bas 11, expnt(s) = [314.37098358]
bas 12, expnt(s) = [63.81976632]
bas 13, expnt(s) = [9.12608387]
bas 14, expnt(s) = [22.28990698]
bas 15, expnt(s) = [0.83468682]
bas 16, expnt(s) = [3.46834372]
bas 17, expnt(s) = [0.23676864]
CPU time:       401.33
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826316e+04 5.20025926e+03 7.61689726e+03 2.05991167e+03
 3.61556363e+03 1.17800472e+03 1.57632285e+03 6.32046315e+02
 2.32339728e+02 1.50351454e+02 5.11286212e+01 4.83073356e+01
 4.60065766e+00 7.93651722e+00 3.97734155e-01 1.26534715e+00
 1.36280550e+03 2.41560955e+04 6.64776871e+02 9.84757436e+03
 3.01290395e+02 3.66198028e+03 3.14370984e+02 3.86177939e+03
 6.38197663e+01 5.26233394e+02 9.12608387e+00 4.62743111e+01
 2.22899070e+01 1.41292696e+02 8.34686820e-01 2.32749543e+00
 3.46834372e+00 1.38081996e+01 2.36768643e-01 4.81825326e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.971299025854375
cond(S) = 108119.17132025231
E1 = -727.5081343493162  E_coul = 203.09941384227076
init E= -524.408720507045
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.559129246786464  LUMO = 1.14053111091213
  mo_energy =
[-1.17887087e+02 -1.20926855e+01 -9.44811541e+00 -9.44811541e+00
 -9.44811541e+00 -1.23031735e+00 -5.59129247e-01 -5.59129247e-01
 -5.59129247e-01  1.14053111e+00  1.14053111e+00  1.14053111e+00
  9.35160192e+00  9.35160192e+00  9.35160192e+00  4.16751240e+01
  4.16751240e+01  4.16751240e+01  1.45408872e+02  1.45408872e+02
  1.45408872e+02  1.76423712e+02  5.04277244e+02  5.04277244e+02
  5.04277244e+02  1.35699374e+03  1.35699374e+03  1.35699374e+03
  1.86520703e+03  3.05152999e+03  3.05152999e+03  3.05152999e+03
  6.67125561e+03  6.67125561e+03  6.67125561e+03  8.15307656e+03
  2.44873646e+04  7.52652910e+04]
E1 = -727.4158803662041  E_coul = 201.85176571179576
cycle= 1 E= -525.564114654408  delta_E= -1.16  |g|= 0.187  |ddm|= 0.465
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.474232
diis-c [-0.22489603  1.        ]
  HOMO = -0.569614888375381  LUMO = 1.13409802240263
  mo_energy =
[-1.18126826e+02 -1.21767116e+01 -9.53177878e+00 -9.53177878e+00
 -9.53177878e+00 -1.24856230e+00 -5.69614888e-01 -5.69614888e-01
 -5.69614888e-01  1.13409802e+00  1.13409802e+00  1.13409802e+00
  9.29862037e+00  9.29862037e+00  9.29862037e+00  4.15781407e+01
  4.15781407e+01  4.15781407e+01  1.45252205e+02  1.45252205e+02
  1.45252205e+02  1.76239664e+02  5.04052657e+02  5.04052657e+02
  5.04052657e+02  1.35671792e+03  1.35671792e+03  1.35671792e+03
  1.86480532e+03  3.05118968e+03  3.05118968e+03  3.05118968e+03
  6.67079390e+03  6.67079390e+03  6.67079390e+03  8.15252900e+03
  2.44867195e+04  7.52645524e+04]
E1 = -727.610572963983  E_coul = 202.04628012235372
cycle= 2 E= -525.564292841629  delta_E= -0.000178  |g|= 0.015  |ddm|= 0.0136
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0306844
diis-c [-7.19970385e-04  3.04796174e-02  9.69520383e-01]
  HOMO = -0.567206348294216  LUMO = 1.13620374386232
  mo_energy =
[-1.18098012e+02 -1.21631075e+01 -9.51796729e+00 -9.51796729e+00
 -9.51796729e+00 -1.24533384e+00 -5.67206348e-01 -5.67206348e-01
 -5.67206348e-01  1.13620374e+00  1.13620374e+00  1.13620374e+00
  9.30717143e+00  9.30717143e+00  9.30717143e+00  4.15934681e+01
  4.15934681e+01  4.15934681e+01  1.45274869e+02  1.45274869e+02
  1.45274869e+02  1.76267196e+02  5.04080947e+02  5.04080947e+02
  5.04080947e+02  1.35674830e+03  1.35674830e+03  1.35674830e+03
  1.86483716e+03  3.05122112e+03  3.05122112e+03  3.05122112e+03
  6.67082591e+03  6.67082591e+03  6.67082591e+03  8.15256121e+03
  2.44867517e+04  7.52645845e+04]
E1 = -727.5709940625086  E_coul = 202.0066958833649
cycle= 3 E= -525.564298179144  delta_E= -5.34e-06  |g|= 0.00202  |ddm|= 0.00342
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00434621
diis-c [-8.39162182e-08 -7.72240224e-04  1.18973254e-01  8.81798986e-01]
  HOMO = -0.567680816795595  LUMO = 1.1358040657565
  mo_energy =
[-1.18101836e+02 -1.21652087e+01 -9.52011340e+00 -9.52011340e+00
 -9.52011340e+00 -1.24595896e+00 -5.67680817e-01 -5.67680817e-01
 -5.67680817e-01  1.13580407e+00  1.13580407e+00  1.13580407e+00
  9.30572554e+00  9.30572554e+00  9.30572554e+00  4.15911674e+01
  4.15911674e+01  4.15911674e+01  1.45271734e+02  1.45271734e+02
  1.45271734e+02  1.76263568e+02  5.04077188e+02  5.04077188e+02
  5.04077188e+02  1.35674430e+03  1.35674430e+03  1.35674430e+03
  1.86483293e+03  3.05121697e+03  3.05121697e+03  3.05121697e+03
  6.67082162e+03  6.67082162e+03  6.67082162e+03  8.15255685e+03
  2.44867473e+04  7.52645800e+04]
E1 = -727.5768269442253  E_coul = 202.0125286225553
cycle= 4 E= -525.56429832167  delta_E= -1.43e-07  |g|= 3.58e-05  |ddm|= 0.000553
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.35035e-05
diis-c [-4.33881552e-10 -2.48109175e-05  3.22553358e-03  3.71193634e-02
  9.59679914e-01]
  HOMO = -0.56765969676951  LUMO = 1.13582130831411
  mo_energy =
[-1.18101754e+02 -1.21651400e+01 -9.52004405e+00 -9.52004405e+00
 -9.52004405e+00 -1.24593151e+00 -5.67659697e-01 -5.67659697e-01
 -5.67659697e-01  1.13582131e+00  1.13582131e+00  1.13582131e+00
  9.30577923e+00  9.30577923e+00  9.30577923e+00  4.15912369e+01
  4.15912369e+01  4.15912369e+01  1.45271812e+02  1.45271812e+02
  1.45271812e+02  1.76263650e+02  5.04077270e+02  5.04077270e+02
  5.04077270e+02  1.35674438e+03  1.35674438e+03  1.35674438e+03
  1.86483301e+03  3.05121705e+03  3.05121705e+03  3.05121705e+03
  6.67082170e+03  6.67082170e+03  6.67082170e+03  8.15255693e+03
  2.44867474e+04  7.52645801e+04]
E1 = -727.5766594706175  E_coul = 202.01236114883957
cycle= 5 E= -525.564298321778  delta_E= -1.08e-10  |g|= 2.54e-06  |ddm|= 1.88e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5766594706175  E_coul = 202.01236114883957
  HOMO = -0.567661052659822  LUMO = 1.13582019963759
  mo_energy =
[-1.18101761e+02 -1.21651448e+01 -9.52004893e+00 -9.52004893e+00
 -9.52004893e+00 -1.24593328e+00 -5.67661053e-01 -5.67661053e-01
 -5.67661053e-01  1.13582020e+00  1.13582020e+00  1.13582020e+00
  9.30577562e+00  9.30577562e+00  9.30577562e+00  4.15912319e+01
  4.15912319e+01  4.15912319e+01  1.45271806e+02  1.45271806e+02
  1.45271806e+02  1.76263644e+02  5.04077264e+02  5.04077264e+02
  5.04077264e+02  1.35674438e+03  1.35674438e+03  1.35674438e+03
  1.86483300e+03  3.05121705e+03  3.05121705e+03  3.05121705e+03
  6.67082170e+03  6.67082170e+03  6.67082170e+03  8.15255692e+03
  2.44867474e+04  7.52645801e+04]
E1 = -727.5766716898454  E_coul = 202.0123733680674
Extra cycle  E= -525.564298321778  delta_E=    0  |g|= 6.16e-07  |ddm|= 1.33e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 108119.17132025231
E1 = -727.5766716898454  E_coul = 202.0123733680674
init E= -525.564298321778
    CPU time for initialize scf      0.96 sec, wall time      0.19 sec
  HOMO = -0.567660822868178  LUMO = 1.1358203908147
  mo_energy =
[-1.18101759e+02 -1.21651439e+01 -9.52004801e+00 -9.52004801e+00
 -9.52004801e+00 -1.24593298e+00 -5.67660823e-01 -5.67660823e-01
 -5.67660823e-01  1.13582039e+00  1.13582039e+00  1.13582039e+00
  9.30577627e+00  9.30577627e+00  9.30577627e+00  4.15912329e+01
  4.15912329e+01  4.15912329e+01  1.45271807e+02  1.45271807e+02
  1.45271807e+02  1.76263645e+02  5.04077265e+02  5.04077265e+02
  5.04077265e+02  1.35674438e+03  1.35674438e+03  1.35674438e+03
  1.86483301e+03  3.05121705e+03  3.05121705e+03  3.05121705e+03
  6.67082170e+03  6.67082170e+03  6.67082170e+03  8.15255692e+03
  2.44867474e+04  7.52645801e+04]
E1 = -727.5766692848524  E_coul = 202.01237096307466
cycle= 1 E= -525.564298321778  delta_E= 2.27e-13  |g|= 1.3e-07  |ddm|= 2.41e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.5766692848524  E_coul = 202.01237096307466
  HOMO = -0.567660865638774  LUMO = 1.1358203550758
  mo_energy =
[-1.18101759e+02 -1.21651440e+01 -9.52004819e+00 -9.52004819e+00
 -9.52004819e+00 -1.24593304e+00 -5.67660866e-01 -5.67660866e-01
 -5.67660866e-01  1.13582036e+00  1.13582036e+00  1.13582036e+00
  9.30577614e+00  9.30577614e+00  9.30577614e+00  4.15912327e+01
  4.15912327e+01  4.15912327e+01  1.45271807e+02  1.45271807e+02
  1.45271807e+02  1.76263645e+02  5.04077265e+02  5.04077265e+02
  5.04077265e+02  1.35674438e+03  1.35674438e+03  1.35674438e+03
  1.86483301e+03  3.05121705e+03  3.05121705e+03  3.05121705e+03
  6.67082170e+03  6.67082170e+03  6.67082170e+03  8.15255692e+03
  2.44867474e+04  7.52645801e+04]
E1 = -727.5766697638626  E_coul = 202.01237144208477
Extra cycle  E= -525.564298321778  delta_E= -1.14e-13  |g|= 2.66e-08  |ddm|= 4.71e-08
    CPU time for scf_cycle      1.08 sec, wall time      0.32 sec
exp = [2.61826316e+04 7.61689726e+03 3.61556363e+03 1.57632285e+03
 2.32339728e+02 5.11286212e+01 4.60065766e+00 3.97734155e-01
 1.36280550e+03 6.64776871e+02 3.01290395e+02 3.14370984e+02
 6.38197663e+01 9.12608387e+00 2.22899070e+01 8.34686820e-01
 3.46834372e+00 2.36768643e-01]
grad_E = [-1.99069955e-06  2.34805187e-05  4.71189026e-05  7.89290330e-04
 -1.73353596e-03 -1.78716012e-03 -1.82360998e-03 -2.61625950e-03
 -6.12293982e-07  3.32087088e-06  1.39713133e-05  1.20532697e-05
  7.10443916e-04  2.09497001e-02 -6.49764384e-03 -1.03953781e-02
 -1.64250703e-02  2.51923463e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6792887        1
[INPUT] 0    0    [1    /1   ]  7616.37697686        1
[INPUT] 0    0    [1    /1   ]  3614.53222055        1
[INPUT] 0    0    [1    /1   ]  1560.19424285        1
[INPUT] 0    0    [1    /1   ]  229.037937572        1
[INPUT] 0    0    [1    /1   ]  50.700248668         1
[INPUT] 0    0    [1    /1   ]  4.60140243155        1
[INPUT] 0    0    [1    /1   ]  0.397526349733       1
[INPUT] 1    0    [1    /1   ]  1362.81539381        1
[INPUT] 1    0    [1    /1   ]  664.664528596        1
[INPUT] 1    0    [1    /1   ]  300.752789432        1
[INPUT] 1    0    [1    /1   ]  313.903068151        1
[INPUT] 1    0    [1    /1   ]  64.6613096268        1
[INPUT] 1    0    [1    /1   ]  9.33776630746        1
[INPUT] 1    0    [1    /1   ]  22.6978154766        1
[INPUT] 1    0    [1    /1   ]  0.842743933599       1
[INPUT] 1    0    [1    /1   ]  3.53135280094        1
[INPUT] 1    0    [1    /1   ]  0.238534296793       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.679288667146, 1.0]], [0, [7616.376976856836, 1.0]], [0, [3614.532220553109, 1.0]], [0, [1560.1942428471884, 1.0]], [0, [229.03793757219077, 1.0]], [0, [50.70024866801518, 1.0]], [0, [4.601402431546742, 1.0]], [0, [0.3975263497325424, 1.0]], [1, [1362.8153938125556, 1.0]], [1, [664.6645285955279, 1.0]], [1, [300.7527894317721, 1.0]], [1, [313.90306815086416, 1.0]], [1, [64.6613096268369, 1.0]], [1, [9.33776630745727, 1.0]], [1, [22.697815476627447, 1.0]], [1, [0.8427439335994228, 1.0]], [1, [3.53135280094192, 1.0]], [1, [0.23853429679276783, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.67928867]
bas 1, expnt(s) = [7616.37697686]
bas 2, expnt(s) = [3614.53222055]
bas 3, expnt(s) = [1560.19424285]
bas 4, expnt(s) = [229.03793757]
bas 5, expnt(s) = [50.70024867]
bas 6, expnt(s) = [4.60140243]
bas 7, expnt(s) = [0.39752635]
bas 8, expnt(s) = [1362.81539381]
bas 9, expnt(s) = [664.6645286]
bas 10, expnt(s) = [300.75278943]
bas 11, expnt(s) = [313.90306815]
bas 12, expnt(s) = [64.66130963]
bas 13, expnt(s) = [9.33776631]
bas 14, expnt(s) = [22.69781548]
bas 15, expnt(s) = [0.84274393]
bas 16, expnt(s) = [3.5313528]
bas 17, expnt(s) = [0.2385343]
CPU time:       407.16
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826793e+04 5.20026636e+03 7.61637698e+03 2.05980614e+03
 3.61453222e+03 1.17775268e+03 1.56019424e+03 6.27189859e+02
 2.29037938e+02 1.48746102e+02 5.07002487e+01 4.80034655e+01
 4.60140243e+00 7.93748079e+00 3.97526350e-01 1.26485128e+00
 1.36281539e+03 2.41563148e+04 6.64664529e+02 9.84549419e+03
 3.00752789e+02 3.65381431e+03 3.13903068e+02 3.85459580e+03
 6.46613096e+01 5.34921450e+02 9.33776631e+00 4.76198632e+01
 2.26978155e+01 1.44532152e+02 8.42743934e-01 2.35561297e+00
 3.53135280e+00 1.41224738e+01 2.38534297e-01 4.86320897e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97098591670388
cond(S) = 108265.60835341885
E1 = -727.4909250804444  E_coul = 203.09502827761116
init E= -524.395896802833
    CPU time for initialize scf      0.64 sec, wall time      0.07 sec
  HOMO = -0.559114772271117  LUMO = 1.15549550276041
  mo_energy =
[-1.17891686e+02 -1.20915930e+01 -9.44833932e+00 -9.44833932e+00
 -9.44833932e+00 -1.23024665e+00 -5.59114772e-01 -5.59114772e-01
 -5.59114772e-01  1.15549550e+00  1.15549550e+00  1.15549550e+00
  9.58019092e+00  9.58019092e+00  9.58019092e+00  4.27118327e+01
  4.27118327e+01  4.27118327e+01  1.48255944e+02  1.48255944e+02
  1.48255944e+02  1.73344909e+02  5.08478891e+02  5.08478891e+02
  5.08478891e+02  1.36048722e+03  1.36048722e+03  1.36048722e+03
  1.84425357e+03  3.05354357e+03  3.05354357e+03  3.05354357e+03
  6.67202006e+03  6.67202006e+03  6.67202006e+03  8.10459371e+03
  2.44184644e+04  7.51895957e+04]
E1 = -727.4195638130319  E_coul = 201.85165428449153
cycle= 1 E= -525.56790952854  delta_E= -1.17  |g|= 0.191  |ddm|= 0.468
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.479155
diis-c [-0.22958995  1.        ]
  HOMO = -0.569350318714067  LUMO = 1.14908208442125
  mo_energy =
[-1.18132124e+02 -1.21750568e+01 -9.53162046e+00 -9.53162046e+00
 -9.53162046e+00 -1.24814200e+00 -5.69350319e-01 -5.69350319e-01
 -5.69350319e-01  1.14908208e+00  1.14908208e+00  1.14908208e+00
  9.52677356e+00  9.52677356e+00  9.52677356e+00  4.26141314e+01
  4.26141314e+01  4.26141314e+01  1.48098459e+02  1.48098459e+02
  1.48098459e+02  1.73161622e+02  5.08253397e+02  5.08253397e+02
  5.08253397e+02  1.36020973e+03  1.36020973e+03  1.36020973e+03
  1.84384838e+03  3.05320022e+03  3.05320022e+03  3.05320022e+03
  6.67155267e+03  6.67155267e+03  6.67155267e+03  8.10403910e+03
  2.44178106e+04  7.51888473e+04]
E1 = -727.6142116680898  E_coul = 202.04612105007345
cycle= 2 E= -525.568090618016  delta_E= -0.000181  |g|= 0.0151  |ddm|= 0.0135
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0308937
diis-c [-7.28310447e-04  3.04743746e-02  9.69525625e-01]
  HOMO = -0.566962300442807  LUMO = 1.1512019404965
  mo_energy =
[-1.18103200e+02 -1.21614658e+01 -9.51781948e+00 -9.51781948e+00
 -9.51781948e+00 -1.24494075e+00 -5.66962300e-01 -5.66962300e-01
 -5.66962300e-01  1.15120194e+00  1.15120194e+00  1.15120194e+00
  9.53542703e+00  9.53542703e+00  9.53542703e+00  4.26296056e+01
  4.26296056e+01  4.26296056e+01  1.48121258e+02  1.48121258e+02
  1.48121258e+02  1.73189188e+02  5.08281791e+02  5.08281791e+02
  5.08281791e+02  1.36024024e+03  1.36024024e+03  1.36024024e+03
  1.84388037e+03  3.05323180e+03  3.05323180e+03  3.05323180e+03
  6.67158483e+03  6.67158483e+03  6.67158483e+03  8.10407147e+03
  2.44178429e+04  7.51888795e+04]
E1 = -727.5746799237452  E_coul = 202.00658394721714
cycle= 3 E= -525.568095976528  delta_E= -5.36e-06  |g|= 0.00202  |ddm|= 0.00342
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00436215
diis-c [-8.63253621e-08 -7.84044431e-04  1.18505240e-01  8.82278804e-01]
  HOMO = -0.567434968585787  LUMO = 1.15079826078169
  mo_energy =
[-1.18107029e+02 -1.21635644e+01 -9.51996380e+00 -9.51996380e+00
 -9.51996380e+00 -1.24556341e+00 -5.67434969e-01 -5.67434969e-01
 -5.67434969e-01  1.15079826e+00  1.15079826e+00  1.15079826e+00
  9.53396571e+00  9.53396571e+00  9.53396571e+00  4.26272891e+01
  4.26272891e+01  4.26272891e+01  1.48118112e+02  1.48118112e+02
  1.48118112e+02  1.73185565e+02  5.08278028e+02  5.08278028e+02
  5.08278028e+02  1.36023623e+03  1.36023623e+03  1.36023623e+03
  1.84387613e+03  3.05322765e+03  3.05322765e+03  3.05322765e+03
  6.67158054e+03  6.67158054e+03  6.67158054e+03  8.10406710e+03
  2.44178385e+04  7.51888750e+04]
E1 = -727.5804993747544  E_coul = 202.0124032558937
cycle= 4 E= -525.568096118861  delta_E= -1.42e-07  |g|= 3.61e-05  |ddm|= 0.000553
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.40003e-05
diis-c [-4.51192999e-10 -2.47049598e-05  3.11600949e-03  3.64782574e-02
  9.60430438e-01]
  HOMO = -0.567413663944004  LUMO = 1.15081587768274
  mo_energy =
[-1.18106945e+02 -1.21634949e+01 -9.51989371e+00 -9.51989371e+00
 -9.51989371e+00 -1.24553572e+00 -5.67413664e-01 -5.67413664e-01
 -5.67413664e-01  1.15081588e+00  1.15081588e+00  1.15081588e+00
  9.53402041e+00  9.53402041e+00  9.53402041e+00  4.26273596e+01
  4.26273596e+01  4.26273596e+01  1.48118191e+02  1.48118191e+02
  1.48118191e+02  1.73185648e+02  5.08278111e+02  5.08278111e+02
  5.08278111e+02  1.36023631e+03  1.36023631e+03  1.36023631e+03
  1.84387621e+03  3.05322773e+03  3.05322773e+03  3.05322773e+03
  6.67158062e+03  6.67158062e+03  6.67158062e+03  8.10406718e+03
  2.44178386e+04  7.51888751e+04]
E1 = -727.5803306071484  E_coul = 202.01223448817947
cycle= 5 E= -525.568096118969  delta_E= -1.08e-10  |g|= 2.61e-06  |ddm|= 1.9e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5803306071484  E_coul = 202.01223448817947
  HOMO = -0.567415054712039  LUMO = 1.15081472540526
  mo_energy =
[-1.18106952e+02 -1.21634998e+01 -9.51989872e+00 -9.51989872e+00
 -9.51989872e+00 -1.24553754e+00 -5.67415055e-01 -5.67415055e-01
 -5.67415055e-01  1.15081473e+00  1.15081473e+00  1.15081473e+00
  9.53401666e+00  9.53401666e+00  9.53401666e+00  4.26273545e+01
  4.26273545e+01  4.26273545e+01  1.48118185e+02  1.48118185e+02
  1.48118185e+02  1.73185641e+02  5.08278104e+02  5.08278104e+02
  5.08278104e+02  1.36023631e+03  1.36023631e+03  1.36023631e+03
  1.84387621e+03  3.05322772e+03  3.05322772e+03  3.05322772e+03
  6.67158061e+03  6.67158061e+03  6.67158061e+03  8.10406717e+03
  2.44178386e+04  7.51888751e+04]
E1 = -727.5803431220847  E_coul = 202.01224700311482
Extra cycle  E= -525.56809611897  delta_E= -1.02e-12  |g|= 6.33e-07  |ddm|= 1.37e-06
    CPU time for scf_cycle      0.79 sec, wall time      0.22 sec
exp = [2.61826793e+04 7.61637698e+03 3.61453222e+03 1.56019424e+03
 2.29037938e+02 5.07002487e+01 4.60140243e+00 3.97526350e-01
 1.36281539e+03 6.64664529e+02 3.00752789e+02 3.13903068e+02
 6.46613096e+01 9.33776631e+00 2.26978155e+01 8.42743934e-01
 3.53135280e+00 2.38534297e-01]
E = -525.56809611897
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6792887        1
[INPUT] 0    0    [1    /1   ]  7616.37697686        1
[INPUT] 0    0    [1    /1   ]  3614.53222055        1
[INPUT] 0    0    [1    /1   ]  1560.19424285        1
[INPUT] 0    0    [1    /1   ]  229.037937572        1
[INPUT] 0    0    [1    /1   ]  50.700248668         1
[INPUT] 0    0    [1    /1   ]  4.60140243155        1
[INPUT] 0    0    [1    /1   ]  0.397526349733       1
[INPUT] 1    0    [1    /1   ]  1362.81539381        1
[INPUT] 1    0    [1    /1   ]  664.664528596        1
[INPUT] 1    0    [1    /1   ]  300.752789432        1
[INPUT] 1    0    [1    /1   ]  313.903068151        1
[INPUT] 1    0    [1    /1   ]  64.6613096268        1
[INPUT] 1    0    [1    /1   ]  9.33776630746        1
[INPUT] 1    0    [1    /1   ]  22.6978154766        1
[INPUT] 1    0    [1    /1   ]  0.842743933599       1
[INPUT] 1    0    [1    /1   ]  3.53135280094        1
[INPUT] 1    0    [1    /1   ]  0.238534296793       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.679288667146, 1.0]], [0, [7616.376976856836, 1.0]], [0, [3614.532220553109, 1.0]], [0, [1560.1942428471884, 1.0]], [0, [229.03793757219077, 1.0]], [0, [50.70024866801518, 1.0]], [0, [4.601402431546742, 1.0]], [0, [0.3975263497325424, 1.0]], [1, [1362.8153938125556, 1.0]], [1, [664.6645285955279, 1.0]], [1, [300.7527894317721, 1.0]], [1, [313.90306815086416, 1.0]], [1, [64.6613096268369, 1.0]], [1, [9.33776630745727, 1.0]], [1, [22.697815476627447, 1.0]], [1, [0.8427439335994228, 1.0]], [1, [3.53135280094192, 1.0]], [1, [0.23853429679276783, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.67928867]
bas 1, expnt(s) = [7616.37697686]
bas 2, expnt(s) = [3614.53222055]
bas 3, expnt(s) = [1560.19424285]
bas 4, expnt(s) = [229.03793757]
bas 5, expnt(s) = [50.70024867]
bas 6, expnt(s) = [4.60140243]
bas 7, expnt(s) = [0.39752635]
bas 8, expnt(s) = [1362.81539381]
bas 9, expnt(s) = [664.6645286]
bas 10, expnt(s) = [300.75278943]
bas 11, expnt(s) = [313.90306815]
bas 12, expnt(s) = [64.66130963]
bas 13, expnt(s) = [9.33776631]
bas 14, expnt(s) = [22.69781548]
bas 15, expnt(s) = [0.84274393]
bas 16, expnt(s) = [3.5313528]
bas 17, expnt(s) = [0.2385343]
CPU time:       408.24
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826793e+04 5.20026636e+03 7.61637698e+03 2.05980614e+03
 3.61453222e+03 1.17775268e+03 1.56019424e+03 6.27189859e+02
 2.29037938e+02 1.48746102e+02 5.07002487e+01 4.80034655e+01
 4.60140243e+00 7.93748079e+00 3.97526350e-01 1.26485128e+00
 1.36281539e+03 2.41563148e+04 6.64664529e+02 9.84549419e+03
 3.00752789e+02 3.65381431e+03 3.13903068e+02 3.85459580e+03
 6.46613096e+01 5.34921450e+02 9.33776631e+00 4.76198632e+01
 2.26978155e+01 1.44532152e+02 8.42743934e-01 2.35561297e+00
 3.53135280e+00 1.41224738e+01 2.38534297e-01 4.86320897e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97098591670388
cond(S) = 108265.60835341885
E1 = -727.4909250804444  E_coul = 203.09502827761116
init E= -524.395896802833
    CPU time for initialize scf      0.69 sec, wall time      0.08 sec
  HOMO = -0.559114772271117  LUMO = 1.15549550276041
  mo_energy =
[-1.17891686e+02 -1.20915930e+01 -9.44833932e+00 -9.44833932e+00
 -9.44833932e+00 -1.23024665e+00 -5.59114772e-01 -5.59114772e-01
 -5.59114772e-01  1.15549550e+00  1.15549550e+00  1.15549550e+00
  9.58019092e+00  9.58019092e+00  9.58019092e+00  4.27118327e+01
  4.27118327e+01  4.27118327e+01  1.48255944e+02  1.48255944e+02
  1.48255944e+02  1.73344909e+02  5.08478891e+02  5.08478891e+02
  5.08478891e+02  1.36048722e+03  1.36048722e+03  1.36048722e+03
  1.84425357e+03  3.05354357e+03  3.05354357e+03  3.05354357e+03
  6.67202006e+03  6.67202006e+03  6.67202006e+03  8.10459371e+03
  2.44184644e+04  7.51895957e+04]
E1 = -727.4195638130319  E_coul = 201.85165428449153
cycle= 1 E= -525.56790952854  delta_E= -1.17  |g|= 0.191  |ddm|= 0.468
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.479155
diis-c [-0.22958995  1.        ]
  HOMO = -0.569350318714067  LUMO = 1.14908208442125
  mo_energy =
[-1.18132124e+02 -1.21750568e+01 -9.53162046e+00 -9.53162046e+00
 -9.53162046e+00 -1.24814200e+00 -5.69350319e-01 -5.69350319e-01
 -5.69350319e-01  1.14908208e+00  1.14908208e+00  1.14908208e+00
  9.52677356e+00  9.52677356e+00  9.52677356e+00  4.26141314e+01
  4.26141314e+01  4.26141314e+01  1.48098459e+02  1.48098459e+02
  1.48098459e+02  1.73161622e+02  5.08253397e+02  5.08253397e+02
  5.08253397e+02  1.36020973e+03  1.36020973e+03  1.36020973e+03
  1.84384838e+03  3.05320022e+03  3.05320022e+03  3.05320022e+03
  6.67155267e+03  6.67155267e+03  6.67155267e+03  8.10403910e+03
  2.44178106e+04  7.51888473e+04]
E1 = -727.6142116680898  E_coul = 202.04612105007345
cycle= 2 E= -525.568090618016  delta_E= -0.000181  |g|= 0.0151  |ddm|= 0.0135
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0308937
diis-c [-7.28310447e-04  3.04743746e-02  9.69525625e-01]
  HOMO = -0.566962300442807  LUMO = 1.1512019404965
  mo_energy =
[-1.18103200e+02 -1.21614658e+01 -9.51781948e+00 -9.51781948e+00
 -9.51781948e+00 -1.24494075e+00 -5.66962300e-01 -5.66962300e-01
 -5.66962300e-01  1.15120194e+00  1.15120194e+00  1.15120194e+00
  9.53542703e+00  9.53542703e+00  9.53542703e+00  4.26296056e+01
  4.26296056e+01  4.26296056e+01  1.48121258e+02  1.48121258e+02
  1.48121258e+02  1.73189188e+02  5.08281791e+02  5.08281791e+02
  5.08281791e+02  1.36024024e+03  1.36024024e+03  1.36024024e+03
  1.84388037e+03  3.05323180e+03  3.05323180e+03  3.05323180e+03
  6.67158483e+03  6.67158483e+03  6.67158483e+03  8.10407147e+03
  2.44178429e+04  7.51888795e+04]
E1 = -727.5746799237452  E_coul = 202.00658394721714
cycle= 3 E= -525.568095976528  delta_E= -5.36e-06  |g|= 0.00202  |ddm|= 0.00342
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00436215
diis-c [-8.63253621e-08 -7.84044431e-04  1.18505240e-01  8.82278804e-01]
  HOMO = -0.567434968585787  LUMO = 1.15079826078169
  mo_energy =
[-1.18107029e+02 -1.21635644e+01 -9.51996380e+00 -9.51996380e+00
 -9.51996380e+00 -1.24556341e+00 -5.67434969e-01 -5.67434969e-01
 -5.67434969e-01  1.15079826e+00  1.15079826e+00  1.15079826e+00
  9.53396571e+00  9.53396571e+00  9.53396571e+00  4.26272891e+01
  4.26272891e+01  4.26272891e+01  1.48118112e+02  1.48118112e+02
  1.48118112e+02  1.73185565e+02  5.08278028e+02  5.08278028e+02
  5.08278028e+02  1.36023623e+03  1.36023623e+03  1.36023623e+03
  1.84387613e+03  3.05322765e+03  3.05322765e+03  3.05322765e+03
  6.67158054e+03  6.67158054e+03  6.67158054e+03  8.10406710e+03
  2.44178385e+04  7.51888750e+04]
E1 = -727.5804993747544  E_coul = 202.0124032558937
cycle= 4 E= -525.568096118861  delta_E= -1.42e-07  |g|= 3.61e-05  |ddm|= 0.000553
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.40003e-05
diis-c [-4.51192999e-10 -2.47049598e-05  3.11600949e-03  3.64782574e-02
  9.60430438e-01]
  HOMO = -0.567413663944004  LUMO = 1.15081587768274
  mo_energy =
[-1.18106945e+02 -1.21634949e+01 -9.51989371e+00 -9.51989371e+00
 -9.51989371e+00 -1.24553572e+00 -5.67413664e-01 -5.67413664e-01
 -5.67413664e-01  1.15081588e+00  1.15081588e+00  1.15081588e+00
  9.53402041e+00  9.53402041e+00  9.53402041e+00  4.26273596e+01
  4.26273596e+01  4.26273596e+01  1.48118191e+02  1.48118191e+02
  1.48118191e+02  1.73185648e+02  5.08278111e+02  5.08278111e+02
  5.08278111e+02  1.36023631e+03  1.36023631e+03  1.36023631e+03
  1.84387621e+03  3.05322773e+03  3.05322773e+03  3.05322773e+03
  6.67158062e+03  6.67158062e+03  6.67158062e+03  8.10406718e+03
  2.44178386e+04  7.51888751e+04]
E1 = -727.5803306071484  E_coul = 202.01223448817947
cycle= 5 E= -525.568096118969  delta_E= -1.08e-10  |g|= 2.61e-06  |ddm|= 1.9e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5803306071484  E_coul = 202.01223448817947
  HOMO = -0.567415054712039  LUMO = 1.15081472540526
  mo_energy =
[-1.18106952e+02 -1.21634998e+01 -9.51989872e+00 -9.51989872e+00
 -9.51989872e+00 -1.24553754e+00 -5.67415055e-01 -5.67415055e-01
 -5.67415055e-01  1.15081473e+00  1.15081473e+00  1.15081473e+00
  9.53401666e+00  9.53401666e+00  9.53401666e+00  4.26273545e+01
  4.26273545e+01  4.26273545e+01  1.48118185e+02  1.48118185e+02
  1.48118185e+02  1.73185641e+02  5.08278104e+02  5.08278104e+02
  5.08278104e+02  1.36023631e+03  1.36023631e+03  1.36023631e+03
  1.84387621e+03  3.05322772e+03  3.05322772e+03  3.05322772e+03
  6.67158061e+03  6.67158061e+03  6.67158061e+03  8.10406717e+03
  2.44178386e+04  7.51888751e+04]
E1 = -727.5803431220847  E_coul = 202.01224700311482
Extra cycle  E= -525.56809611897  delta_E= -1.02e-12  |g|= 6.33e-07  |ddm|= 1.37e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 108265.60835341885
E1 = -727.5803431220847  E_coul = 202.01224700311482
init E= -525.56809611897
    CPU time for initialize scf      1.80 sec, wall time      0.24 sec
  HOMO = -0.567414819839147  LUMO = 1.15081492342099
  mo_energy =
[-1.18106951e+02 -1.21634989e+01 -9.51989778e+00 -9.51989778e+00
 -9.51989778e+00 -1.24553724e+00 -5.67414820e-01 -5.67414820e-01
 -5.67414820e-01  1.15081492e+00  1.15081492e+00  1.15081492e+00
  9.53401734e+00  9.53401734e+00  9.53401734e+00  4.26273555e+01
  4.26273555e+01  4.26273555e+01  1.48118186e+02  1.48118186e+02
  1.48118186e+02  1.73185643e+02  5.08278105e+02  5.08278105e+02
  5.08278105e+02  1.36023631e+03  1.36023631e+03  1.36023631e+03
  1.84387621e+03  3.05322772e+03  3.05322772e+03  3.05322772e+03
  6.67158061e+03  6.67158061e+03  6.67158061e+03  8.10406717e+03
  2.44178386e+04  7.51888751e+04]
E1 = -727.58034066355  E_coul = 202.0122445445795
cycle= 1 E= -525.568096118971  delta_E= -5.68e-13  |g|= 1.33e-07  |ddm|= 2.46e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.58034066355  E_coul = 202.0122445445795
  HOMO = -0.567414863476399  LUMO = 1.15081488646295
  mo_energy =
[-1.18106951e+02 -1.21634991e+01 -9.51989797e+00 -9.51989797e+00
 -9.51989797e+00 -1.24553729e+00 -5.67414863e-01 -5.67414863e-01
 -5.67414863e-01  1.15081489e+00  1.15081489e+00  1.15081489e+00
  9.53401721e+00  9.53401721e+00  9.53401721e+00  4.26273553e+01
  4.26273553e+01  4.26273553e+01  1.48118186e+02  1.48118186e+02
  1.48118186e+02  1.73185642e+02  5.08278105e+02  5.08278105e+02
  5.08278105e+02  1.36023631e+03  1.36023631e+03  1.36023631e+03
  1.84387621e+03  3.05322772e+03  3.05322772e+03  3.05322772e+03
  6.67158061e+03  6.67158061e+03  6.67158061e+03  8.10406717e+03
  2.44178386e+04  7.51888751e+04]
E1 = -727.5803411522762  E_coul = 202.01224503330687
Extra cycle  E= -525.568096118969  delta_E= 1.14e-12  |g|= 2.73e-08  |ddm|= 4.81e-08
    CPU time for scf_cycle      1.90 sec, wall time      0.35 sec
exp = [2.61826793e+04 7.61637698e+03 3.61453222e+03 1.56019424e+03
 2.29037938e+02 5.07002487e+01 4.60140243e+00 3.97526350e-01
 1.36281539e+03 6.64664529e+02 3.00752789e+02 3.13903068e+02
 6.46613096e+01 9.33776631e+00 2.26978155e+01 8.42743934e-01
 3.53135280e+00 2.38534297e-01]
grad_E = [-1.99047427e-06  2.43020716e-05  4.90249946e-05  8.46739616e-04
 -2.77849416e-03 -1.31104593e-03 -1.32180995e-03 -2.18182237e-03
 -6.33705745e-07  2.91087141e-06  1.17934406e-05  1.01575499e-05
  7.38709869e-04  2.11040794e-02 -6.43364691e-03 -7.54684433e-03
 -1.60454258e-02  1.99251691e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:36 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7343901        1
[INPUT] 0    0    [1    /1   ]  7615.77556602        1
[INPUT] 0    0    [1    /1   ]  3613.34006867        1
[INPUT] 0    0    [1    /1   ]  1541.54981717        1
[INPUT] 0    0    [1    /1   ]  225.202433377        1
[INPUT] 0    0    [1    /1   ]  50.1944926079        1
[INPUT] 0    0    [1    /1   ]  4.60269982813        1
[INPUT] 0    0    [1    /1   ]  0.397400894648       1
[INPUT] 1    0    [1    /1   ]  1362.82707935        1
[INPUT] 1    0    [1    /1   ]  664.536799103        1
[INPUT] 1    0    [1    /1   ]  300.143271971        1
[INPUT] 1    0    [1    /1   ]  313.372725604        1
[INPUT] 1    0    [1    /1   ]  65.5711737031        1
[INPUT] 1    0    [1    /1   ]  8.96398006168        1
[INPUT] 1    0    [1    /1   ]  22.5957125778        1
[INPUT] 1    0    [1    /1   ]  0.828235928405       1
[INPUT] 1    0    [1    /1   ]  3.3601531938         1
[INPUT] 1    0    [1    /1   ]  0.235322327676       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.73439008779, 1.0]], [0, [7615.775566017474, 1.0]], [0, [3613.3400686736722, 1.0]], [0, [1541.5498171736788, 1.0]], [0, [225.20243337672326, 1.0]], [0, [50.19449260789008, 1.0]], [0, [4.602699828129484, 1.0]], [0, [0.39740089464773243, 1.0]], [1, [1362.82707934619, 1.0]], [1, [664.5367991030835, 1.0]], [1, [300.1432719711368, 1.0]], [1, [313.3727256037759, 1.0]], [1, [65.57117370313142, 1.0]], [1, [8.963980061684751, 1.0]], [1, [22.59571257784376, 1.0]], [1, [0.8282359284047501, 1.0]], [1, [3.3601531937963096, 1.0]], [1, [0.23532232767623912, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.73439009]
bas 1, expnt(s) = [7615.77556602]
bas 2, expnt(s) = [3613.34006867]
bas 3, expnt(s) = [1541.54981717]
bas 4, expnt(s) = [225.20243338]
bas 5, expnt(s) = [50.19449261]
bas 6, expnt(s) = [4.60269983]
bas 7, expnt(s) = [0.39740089]
bas 8, expnt(s) = [1362.82707935]
bas 9, expnt(s) = [664.5367991]
bas 10, expnt(s) = [300.14327197]
bas 11, expnt(s) = [313.3727256]
bas 12, expnt(s) = [65.5711737]
bas 13, expnt(s) = [8.96398006]
bas 14, expnt(s) = [22.59571258]
bas 15, expnt(s) = [0.82823593]
bas 16, expnt(s) = [3.36015319]
bas 17, expnt(s) = [0.23532233]
CPU time:       415.24
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827344e+04 5.20027457e+03 7.61577557e+03 2.05968415e+03
 3.61334007e+03 1.17746133e+03 1.54154982e+03 6.21560199e+02
 2.25202433e+02 1.46873970e+02 5.01944926e+01 4.76438749e+01
 4.60269983e+00 7.93915926e+00 3.97400895e-01 1.26455189e+00
 1.36282708e+03 2.41565737e+04 6.64536799e+02 9.84312922e+03
 3.00143272e+02 3.64456045e+03 3.13372726e+02 3.84645704e+03
 6.55711737e+01 5.44346694e+02 8.96398006e+00 4.52491572e+01
 2.25957126e+01 1.43719913e+02 8.28235928e-01 2.30503209e+00
 3.36015319e+00 1.32719043e+01 2.35322328e-01 4.78149066e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.971908334079004
cond(S) = 106693.69240241444
E1 = -727.4712814247569  E_coul = 203.09043281470852
init E= -524.380848610048
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.559202033141806  LUMO = 1.12784605183068
  mo_energy =
[-1.17895685e+02 -1.20902555e+01 -9.44924858e+00 -9.44924858e+00
 -9.44924858e+00 -1.23004931e+00 -5.59202033e-01 -5.59202033e-01
 -5.59202033e-01  1.12784605e+00  1.12784605e+00  1.12784605e+00
  9.07476817e+00  9.07476817e+00  9.07476817e+00  4.11204747e+01
  4.11204747e+01  4.11204747e+01  1.46894848e+02  1.46894848e+02
  1.46894848e+02  1.69768832e+02  5.08523759e+02  5.08523759e+02
  5.08523759e+02  1.36007213e+03  1.36007213e+03  1.36007213e+03
  1.81984513e+03  3.05172005e+03  3.05172005e+03  3.05172005e+03
  6.66912301e+03  6.66912301e+03  6.66912301e+03  8.04822382e+03
  2.43386076e+04  7.51020263e+04]
E1 = -727.3821092619615  E_coul = 201.8078801213844
cycle= 1 E= -525.574229140577  delta_E= -1.19  |g|= 0.196  |ddm|= 0.509
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.48637
diis-c [-0.23655551  1.        ]
  HOMO = -0.570120109331985  LUMO = 1.12117677165115
  mo_energy =
[-1.18142033e+02 -1.21762933e+01 -9.53528921e+00 -9.53528921e+00
 -9.53528921e+00 -1.24873617e+00 -5.70120109e-01 -5.70120109e-01
 -5.70120109e-01  1.12117677e+00  1.12117677e+00  1.12117677e+00
  9.02122068e+00  9.02122068e+00  9.02122068e+00  4.10203197e+01
  4.10203197e+01  4.10203197e+01  1.46731908e+02  1.46731908e+02
  1.46731908e+02  1.69581592e+02  5.08291838e+02  5.08291838e+02
  5.08291838e+02  1.35978728e+03  1.35978728e+03  1.35978728e+03
  1.81943056e+03  3.05136772e+03  3.05136772e+03  3.05136772e+03
  6.66864349e+03  6.66864349e+03  6.66864349e+03  8.04765547e+03
  2.43379380e+04  7.51012608e+04]
E1 = -727.5868731016874  E_coul = 202.01244915905653
cycle= 2 E= -525.574423942631  delta_E= -0.000195  |g|= 0.0157  |ddm|= 0.0143
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0320989
diis-c [-7.76443869e-04  3.17723810e-02  9.68227619e-01]
  HOMO = -0.567573858691794  LUMO = 1.12336991365888
  mo_energy =
[-1.18111846e+02 -1.21620082e+01 -9.52077966e+00 -9.52077966e+00
 -9.52077966e+00 -1.24532620e+00 -5.67573859e-01 -5.67573859e-01
 -5.67573859e-01  1.12336991e+00  1.12336991e+00  1.12336991e+00
  9.03007488e+00  9.03007488e+00  9.03007488e+00  4.10364465e+01
  4.10364465e+01  4.10364465e+01  1.46755828e+02  1.46755828e+02
  1.46755828e+02  1.69610276e+02  5.08321501e+02  5.08321501e+02
  5.08321501e+02  1.35981912e+03  1.35981912e+03  1.35981912e+03
  1.81946393e+03  3.05140068e+03  3.05140068e+03  3.05140068e+03
  6.66867706e+03  6.66867706e+03  6.66867706e+03  8.04768926e+03
  2.43379718e+04  7.51012945e+04]
E1 = -727.5451682356235  E_coul = 201.97073837915755
cycle= 3 E= -525.574429856466  delta_E= -5.91e-06  |g|= 0.00211  |ddm|= 0.0036
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00453977
diis-c [-9.18021543e-08 -8.06748048e-04  1.18570293e-01  8.82236456e-01]
  HOMO = -0.568071038682403  LUMO = 1.12295665405119
  mo_energy =
[-1.18115838e+02 -1.21642040e+01 -9.52302377e+00 -9.52302377e+00
 -9.52302377e+00 -1.24598053e+00 -5.68071039e-01 -5.68071039e-01
 -5.68071039e-01  1.12295665e+00  1.12295665e+00  1.12295665e+00
  9.02858256e+00  9.02858256e+00  9.02858256e+00  4.10340372e+01
  4.10340372e+01  4.10340372e+01  1.46752535e+02  1.46752535e+02
  1.46752535e+02  1.69606508e+02  5.08317575e+02  5.08317575e+02
  5.08317575e+02  1.35981494e+03  1.35981494e+03  1.35981494e+03
  1.81945952e+03  3.05139635e+03  3.05139635e+03  3.05139635e+03
  6.66867258e+03  6.66867258e+03  6.66867258e+03  8.04768470e+03
  2.43379672e+04  7.51012898e+04]
E1 = -727.5512829839934  E_coul = 201.97685297121788
cycle= 4 E= -525.574430012775  delta_E= -1.56e-07  |g|= 3.69e-05  |ddm|= 0.000578
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.48406e-05
diis-c [-4.70040468e-10 -2.64248276e-05  3.23389560e-03  3.69721633e-02
  9.59820366e-01]
  HOMO = -0.568049129791152  LUMO = 1.12297431482271
  mo_energy =
[-1.18115753e+02 -1.21641329e+01 -9.52295201e+00 -9.52295201e+00
 -9.52295201e+00 -1.24595207e+00 -5.68049130e-01 -5.68049130e-01
 -5.68049130e-01  1.12297431e+00  1.12297431e+00  1.12297431e+00
  9.02863758e+00  9.02863758e+00  9.02863758e+00  4.10341091e+01
  4.10341091e+01  4.10341091e+01  1.46752615e+02  1.46752615e+02
  1.46752615e+02  1.69606593e+02  5.08317659e+02  5.08317659e+02
  5.08317659e+02  1.35981503e+03  1.35981503e+03  1.35981503e+03
  1.81945960e+03  3.05139643e+03  3.05139643e+03  3.05139643e+03
  6.66867266e+03  6.66867266e+03  6.66867266e+03  8.04768479e+03
  2.43379673e+04  7.51012899e+04]
E1 = -727.5511093187334  E_coul = 201.97667930584427
cycle= 5 E= -525.574430012889  delta_E= -1.14e-10  |g|= 2.69e-06  |ddm|= 1.95e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5511093187334  E_coul = 201.97667930584427
  HOMO = -0.568050554964725  LUMO = 1.12297316343692
  mo_energy =
[-1.18115760e+02 -1.21641379e+01 -9.52295715e+00 -9.52295715e+00
 -9.52295715e+00 -1.24595393e+00 -5.68050555e-01 -5.68050555e-01
 -5.68050555e-01  1.12297316e+00  1.12297316e+00  1.12297316e+00
  9.02863382e+00  9.02863382e+00  9.02863382e+00  4.10341038e+01
  4.10341038e+01  4.10341038e+01  1.46752609e+02  1.46752609e+02
  1.46752609e+02  1.69606586e+02  5.08317652e+02  5.08317652e+02
  5.08317652e+02  1.35981502e+03  1.35981502e+03  1.35981502e+03
  1.81945960e+03  3.05139642e+03  3.05139642e+03  3.05139642e+03
  6.66867266e+03  6.66867266e+03  6.66867266e+03  8.04768478e+03
  2.43379673e+04  7.51012899e+04]
E1 = -727.5511222148665  E_coul = 201.9766922019772
Extra cycle  E= -525.574430012889  delta_E= -1.14e-13  |g|= 6.54e-07  |ddm|= 1.4e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.24 sec
exp = [2.61827344e+04 7.61577557e+03 3.61334007e+03 1.54154982e+03
 2.25202433e+02 5.01944926e+01 4.60269983e+00 3.97400895e-01
 1.36282708e+03 6.64536799e+02 3.00143272e+02 3.13372726e+02
 6.55711737e+01 8.96398006e+00 2.25957126e+01 8.28235928e-01
 3.36015319e+00 2.35322328e-01]
E = -525.5744300128893
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7343901        1
[INPUT] 0    0    [1    /1   ]  7615.77556602        1
[INPUT] 0    0    [1    /1   ]  3613.34006867        1
[INPUT] 0    0    [1    /1   ]  1541.54981717        1
[INPUT] 0    0    [1    /1   ]  225.202433377        1
[INPUT] 0    0    [1    /1   ]  50.1944926079        1
[INPUT] 0    0    [1    /1   ]  4.60269982813        1
[INPUT] 0    0    [1    /1   ]  0.397400894648       1
[INPUT] 1    0    [1    /1   ]  1362.82707935        1
[INPUT] 1    0    [1    /1   ]  664.536799103        1
[INPUT] 1    0    [1    /1   ]  300.143271971        1
[INPUT] 1    0    [1    /1   ]  313.372725604        1
[INPUT] 1    0    [1    /1   ]  65.5711737031        1
[INPUT] 1    0    [1    /1   ]  8.96398006168        1
[INPUT] 1    0    [1    /1   ]  22.5957125778        1
[INPUT] 1    0    [1    /1   ]  0.828235928405       1
[INPUT] 1    0    [1    /1   ]  3.3601531938         1
[INPUT] 1    0    [1    /1   ]  0.235322327676       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.73439008779, 1.0]], [0, [7615.775566017474, 1.0]], [0, [3613.3400686736722, 1.0]], [0, [1541.5498171736788, 1.0]], [0, [225.20243337672326, 1.0]], [0, [50.19449260789008, 1.0]], [0, [4.602699828129484, 1.0]], [0, [0.39740089464773243, 1.0]], [1, [1362.82707934619, 1.0]], [1, [664.5367991030835, 1.0]], [1, [300.1432719711368, 1.0]], [1, [313.3727256037759, 1.0]], [1, [65.57117370313142, 1.0]], [1, [8.963980061684751, 1.0]], [1, [22.59571257784376, 1.0]], [1, [0.8282359284047501, 1.0]], [1, [3.3601531937963096, 1.0]], [1, [0.23532232767623912, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.73439009]
bas 1, expnt(s) = [7615.77556602]
bas 2, expnt(s) = [3613.34006867]
bas 3, expnt(s) = [1541.54981717]
bas 4, expnt(s) = [225.20243338]
bas 5, expnt(s) = [50.19449261]
bas 6, expnt(s) = [4.60269983]
bas 7, expnt(s) = [0.39740089]
bas 8, expnt(s) = [1362.82707935]
bas 9, expnt(s) = [664.5367991]
bas 10, expnt(s) = [300.14327197]
bas 11, expnt(s) = [313.3727256]
bas 12, expnt(s) = [65.5711737]
bas 13, expnt(s) = [8.96398006]
bas 14, expnt(s) = [22.59571258]
bas 15, expnt(s) = [0.82823593]
bas 16, expnt(s) = [3.36015319]
bas 17, expnt(s) = [0.23532233]
CPU time:       415.82
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827344e+04 5.20027457e+03 7.61577557e+03 2.05968415e+03
 3.61334007e+03 1.17746133e+03 1.54154982e+03 6.21560199e+02
 2.25202433e+02 1.46873970e+02 5.01944926e+01 4.76438749e+01
 4.60269983e+00 7.93915926e+00 3.97400895e-01 1.26455189e+00
 1.36282708e+03 2.41565737e+04 6.64536799e+02 9.84312922e+03
 3.00143272e+02 3.64456045e+03 3.13372726e+02 3.84645704e+03
 6.55711737e+01 5.44346694e+02 8.96398006e+00 4.52491572e+01
 2.25957126e+01 1.43719913e+02 8.28235928e-01 2.30503209e+00
 3.36015319e+00 1.32719043e+01 2.35322328e-01 4.78149066e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.971908334079004
cond(S) = 106693.69240241444
E1 = -727.4712814247569  E_coul = 203.09043281470852
init E= -524.380848610048
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.559202033141806  LUMO = 1.12784605183068
  mo_energy =
[-1.17895685e+02 -1.20902555e+01 -9.44924858e+00 -9.44924858e+00
 -9.44924858e+00 -1.23004931e+00 -5.59202033e-01 -5.59202033e-01
 -5.59202033e-01  1.12784605e+00  1.12784605e+00  1.12784605e+00
  9.07476817e+00  9.07476817e+00  9.07476817e+00  4.11204747e+01
  4.11204747e+01  4.11204747e+01  1.46894848e+02  1.46894848e+02
  1.46894848e+02  1.69768832e+02  5.08523759e+02  5.08523759e+02
  5.08523759e+02  1.36007213e+03  1.36007213e+03  1.36007213e+03
  1.81984513e+03  3.05172005e+03  3.05172005e+03  3.05172005e+03
  6.66912301e+03  6.66912301e+03  6.66912301e+03  8.04822382e+03
  2.43386076e+04  7.51020263e+04]
E1 = -727.3821092619615  E_coul = 201.8078801213844
cycle= 1 E= -525.574229140577  delta_E= -1.19  |g|= 0.196  |ddm|= 0.509
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.48637
diis-c [-0.23655551  1.        ]
  HOMO = -0.570120109331985  LUMO = 1.12117677165115
  mo_energy =
[-1.18142033e+02 -1.21762933e+01 -9.53528921e+00 -9.53528921e+00
 -9.53528921e+00 -1.24873617e+00 -5.70120109e-01 -5.70120109e-01
 -5.70120109e-01  1.12117677e+00  1.12117677e+00  1.12117677e+00
  9.02122068e+00  9.02122068e+00  9.02122068e+00  4.10203197e+01
  4.10203197e+01  4.10203197e+01  1.46731908e+02  1.46731908e+02
  1.46731908e+02  1.69581592e+02  5.08291838e+02  5.08291838e+02
  5.08291838e+02  1.35978728e+03  1.35978728e+03  1.35978728e+03
  1.81943056e+03  3.05136772e+03  3.05136772e+03  3.05136772e+03
  6.66864349e+03  6.66864349e+03  6.66864349e+03  8.04765547e+03
  2.43379380e+04  7.51012608e+04]
E1 = -727.5868731016874  E_coul = 202.01244915905653
cycle= 2 E= -525.574423942631  delta_E= -0.000195  |g|= 0.0157  |ddm|= 0.0143
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0320989
diis-c [-7.76443869e-04  3.17723810e-02  9.68227619e-01]
  HOMO = -0.567573858691794  LUMO = 1.12336991365888
  mo_energy =
[-1.18111846e+02 -1.21620082e+01 -9.52077966e+00 -9.52077966e+00
 -9.52077966e+00 -1.24532620e+00 -5.67573859e-01 -5.67573859e-01
 -5.67573859e-01  1.12336991e+00  1.12336991e+00  1.12336991e+00
  9.03007488e+00  9.03007488e+00  9.03007488e+00  4.10364465e+01
  4.10364465e+01  4.10364465e+01  1.46755828e+02  1.46755828e+02
  1.46755828e+02  1.69610276e+02  5.08321501e+02  5.08321501e+02
  5.08321501e+02  1.35981912e+03  1.35981912e+03  1.35981912e+03
  1.81946393e+03  3.05140068e+03  3.05140068e+03  3.05140068e+03
  6.66867706e+03  6.66867706e+03  6.66867706e+03  8.04768926e+03
  2.43379718e+04  7.51012945e+04]
E1 = -727.5451682356235  E_coul = 201.97073837915755
cycle= 3 E= -525.574429856466  delta_E= -5.91e-06  |g|= 0.00211  |ddm|= 0.0036
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00453977
diis-c [-9.18021543e-08 -8.06748048e-04  1.18570293e-01  8.82236456e-01]
  HOMO = -0.568071038682403  LUMO = 1.12295665405119
  mo_energy =
[-1.18115838e+02 -1.21642040e+01 -9.52302377e+00 -9.52302377e+00
 -9.52302377e+00 -1.24598053e+00 -5.68071039e-01 -5.68071039e-01
 -5.68071039e-01  1.12295665e+00  1.12295665e+00  1.12295665e+00
  9.02858256e+00  9.02858256e+00  9.02858256e+00  4.10340372e+01
  4.10340372e+01  4.10340372e+01  1.46752535e+02  1.46752535e+02
  1.46752535e+02  1.69606508e+02  5.08317575e+02  5.08317575e+02
  5.08317575e+02  1.35981494e+03  1.35981494e+03  1.35981494e+03
  1.81945952e+03  3.05139635e+03  3.05139635e+03  3.05139635e+03
  6.66867258e+03  6.66867258e+03  6.66867258e+03  8.04768470e+03
  2.43379672e+04  7.51012898e+04]
E1 = -727.5512829839934  E_coul = 201.97685297121788
cycle= 4 E= -525.574430012775  delta_E= -1.56e-07  |g|= 3.69e-05  |ddm|= 0.000578
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.48406e-05
diis-c [-4.70040468e-10 -2.64248276e-05  3.23389560e-03  3.69721633e-02
  9.59820366e-01]
  HOMO = -0.568049129791152  LUMO = 1.12297431482271
  mo_energy =
[-1.18115753e+02 -1.21641329e+01 -9.52295201e+00 -9.52295201e+00
 -9.52295201e+00 -1.24595207e+00 -5.68049130e-01 -5.68049130e-01
 -5.68049130e-01  1.12297431e+00  1.12297431e+00  1.12297431e+00
  9.02863758e+00  9.02863758e+00  9.02863758e+00  4.10341091e+01
  4.10341091e+01  4.10341091e+01  1.46752615e+02  1.46752615e+02
  1.46752615e+02  1.69606593e+02  5.08317659e+02  5.08317659e+02
  5.08317659e+02  1.35981503e+03  1.35981503e+03  1.35981503e+03
  1.81945960e+03  3.05139643e+03  3.05139643e+03  3.05139643e+03
  6.66867266e+03  6.66867266e+03  6.66867266e+03  8.04768479e+03
  2.43379673e+04  7.51012899e+04]
E1 = -727.5511093187334  E_coul = 201.97667930584427
cycle= 5 E= -525.574430012889  delta_E= -1.14e-10  |g|= 2.69e-06  |ddm|= 1.95e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5511093187334  E_coul = 201.97667930584427
  HOMO = -0.568050554964725  LUMO = 1.12297316343692
  mo_energy =
[-1.18115760e+02 -1.21641379e+01 -9.52295715e+00 -9.52295715e+00
 -9.52295715e+00 -1.24595393e+00 -5.68050555e-01 -5.68050555e-01
 -5.68050555e-01  1.12297316e+00  1.12297316e+00  1.12297316e+00
  9.02863382e+00  9.02863382e+00  9.02863382e+00  4.10341038e+01
  4.10341038e+01  4.10341038e+01  1.46752609e+02  1.46752609e+02
  1.46752609e+02  1.69606586e+02  5.08317652e+02  5.08317652e+02
  5.08317652e+02  1.35981502e+03  1.35981502e+03  1.35981502e+03
  1.81945960e+03  3.05139642e+03  3.05139642e+03  3.05139642e+03
  6.66867266e+03  6.66867266e+03  6.66867266e+03  8.04768478e+03
  2.43379673e+04  7.51012899e+04]
E1 = -727.5511222148665  E_coul = 201.9766922019772
Extra cycle  E= -525.574430012889  delta_E= -1.14e-13  |g|= 6.54e-07  |ddm|= 1.4e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.24 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 106693.69240241444
E1 = -727.5511222148665  E_coul = 201.9766922019772
init E= -525.574430012889
    CPU time for initialize scf      0.96 sec, wall time      0.20 sec
  HOMO = -0.568050312726585  LUMO = 1.12297336240552
  mo_energy =
[-1.18115759e+02 -1.21641370e+01 -9.52295618e+00 -9.52295618e+00
 -9.52295618e+00 -1.24595361e+00 -5.68050313e-01 -5.68050313e-01
 -5.68050313e-01  1.12297336e+00  1.12297336e+00  1.12297336e+00
  9.02863450e+00  9.02863450e+00  9.02863450e+00  4.10341048e+01
  4.10341048e+01  4.10341048e+01  1.46752610e+02  1.46752610e+02
  1.46752610e+02  1.69606587e+02  5.08317654e+02  5.08317654e+02
  5.08317654e+02  1.35981502e+03  1.35981502e+03  1.35981502e+03
  1.81945960e+03  3.05139643e+03  3.05139643e+03  3.05139643e+03
  6.66867266e+03  6.66867266e+03  6.66867266e+03  8.04768478e+03
  2.43379673e+04  7.51012899e+04]
E1 = -727.5511196677168  E_coul = 201.97668965482669
cycle= 1 E= -525.57443001289  delta_E= -7.96e-13  |g|= 1.39e-07  |ddm|= 2.54e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.5511196677168  E_coul = 201.97668965482669
  HOMO = -0.568050358008823  LUMO = 1.12297332505008
  mo_energy =
[-1.18115759e+02 -1.21641372e+01 -9.52295637e+00 -9.52295637e+00
 -9.52295637e+00 -1.24595367e+00 -5.68050358e-01 -5.68050358e-01
 -5.68050358e-01  1.12297333e+00  1.12297333e+00  1.12297333e+00
  9.02863437e+00  9.02863437e+00  9.02863437e+00  4.10341046e+01
  4.10341046e+01  4.10341046e+01  1.46752610e+02  1.46752610e+02
  1.46752610e+02  1.69606587e+02  5.08317653e+02  5.08317653e+02
  5.08317653e+02  1.35981502e+03  1.35981502e+03  1.35981502e+03
  1.81945960e+03  3.05139642e+03  3.05139642e+03  3.05139642e+03
  6.66867266e+03  6.66867266e+03  6.66867266e+03  8.04768478e+03
  2.43379673e+04  7.51012899e+04]
E1 = -727.5511201767279  E_coul = 201.97669016383847
Extra cycle  E= -525.574430012889  delta_E= 6.82e-13  |g|= 2.84e-08  |ddm|= 4.98e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.33 sec
exp = [2.61827344e+04 7.61577557e+03 3.61334007e+03 1.54154982e+03
 2.25202433e+02 5.01944926e+01 4.60269983e+00 3.97400895e-01
 1.36282708e+03 6.64536799e+02 3.00143272e+02 3.13372726e+02
 6.55711737e+01 8.96398006e+00 2.25957126e+01 8.28235928e-01
 3.36015319e+00 2.35322328e-01]
grad_E = [-1.98923350e-06  2.52796636e-05  5.12982575e-05  9.18223558e-04
 -4.06558575e-03 -7.20237457e-04 -7.06994547e-04 -2.73557225e-03
 -6.52963589e-07  2.40354045e-06  9.10255601e-06  7.83321172e-06
  7.94991904e-04  2.43697326e-02 -6.88035282e-03 -9.80988812e-03
 -2.65238536e-02  3.37455236e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8138055        1
[INPUT] 0    0    [1    /1   ]  7614.9075213         1
[INPUT] 0    0    [1    /1   ]  3611.61740296        1
[INPUT] 0    0    [1    /1   ]  1514.65431008        1
[INPUT] 0    0    [1    /1   ]  220.274497174        1
[INPUT] 0    0    [1    /1   ]  49.5240304224        1
[INPUT] 0    0    [1    /1   ]  4.60451777661        1
[INPUT] 0    0    [1    /1   ]  0.397330211357       1
[INPUT] 1    0    [1    /1   ]  1362.83712081        1
[INPUT] 1    0    [1    /1   ]  664.295176921        1
[INPUT] 1    0    [1    /1   ]  298.938835577        1
[INPUT] 1    0    [1    /1   ]  312.320350266        1
[INPUT] 1    0    [1    /1   ]  73.8816871414        1
[INPUT] 1    0    [1    /1   ]  8.31197122597        1
[INPUT] 1    0    [1    /1   ]  24.0796494007        1
[INPUT] 1    0    [1    /1   ]  0.812759726625       1
[INPUT] 1    0    [1    /1   ]  3.10414292534        1
[INPUT] 1    0    [1    /1   ]  0.230834965747       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.813805519654, 1.0]], [0, [7614.907521297112, 1.0]], [0, [3611.6174029562176, 1.0]], [0, [1514.6543100797032, 1.0]], [0, [220.27449717354315, 1.0]], [0, [49.524030422356915, 1.0]], [0, [4.60451777660842, 1.0]], [0, [0.39733021135712326, 1.0]], [1, [1362.8371208067674, 1.0]], [1, [664.2951769211858, 1.0]], [1, [298.93883557734074, 1.0]], [1, [312.3203502664781, 1.0]], [1, [73.88168714141362, 1.0]], [1, [8.311971225967415, 1.0]], [1, [24.07964940070228, 1.0]], [1, [0.8127597266254796, 1.0]], [1, [3.104142925341708, 1.0]], [1, [0.23083496574743695, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.81380552]
bas 1, expnt(s) = [7614.9075213]
bas 2, expnt(s) = [3611.61740296]
bas 3, expnt(s) = [1514.65431008]
bas 4, expnt(s) = [220.27449717]
bas 5, expnt(s) = [49.52403042]
bas 6, expnt(s) = [4.60451778]
bas 7, expnt(s) = [0.39733021]
bas 8, expnt(s) = [1362.83712081]
bas 9, expnt(s) = [664.29517692]
bas 10, expnt(s) = [298.93883558]
bas 11, expnt(s) = [312.32035027]
bas 12, expnt(s) = [73.88168714]
bas 13, expnt(s) = [8.31197123]
bas 14, expnt(s) = [24.0796494]
bas 15, expnt(s) = [0.81275973]
bas 16, expnt(s) = [3.10414293]
bas 17, expnt(s) = [0.23083497]
CPU time:       421.71
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828138e+04 5.20028640e+03 7.61490752e+03 2.05950808e+03
 3.61161740e+03 1.17704028e+03 1.51465431e+03 6.13409034e+02
 2.20274497e+02 1.44456866e+02 4.95240304e+01 4.71657789e+01
 4.60451778e+00 7.94151096e+00 3.97330211e-01 1.26438320e+00
 1.36283712e+03 2.41567962e+04 6.64295177e+02 9.83865579e+03
 2.98938836e+02 3.62628819e+03 3.12320350e+02 3.83031725e+03
 7.38816871e+01 6.31910247e+02 8.31197123e+00 4.11731819e+01
 2.40796494e+01 1.55613436e+02 8.12759727e-01 2.25131939e+00
 3.10414293e+00 1.20201954e+01 2.30834966e-01 4.66779082e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972961940724726
cond(S) = 115596.64303978319
E1 = -727.4507999072317  E_coul = 203.08788217424737
init E= -524.362917732984
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.559655709713046  LUMO = 1.09499791723853
  mo_energy =
[-1.17899281e+02 -1.20882767e+01 -9.44976606e+00 -9.44976606e+00
 -9.44976606e+00 -1.22969648e+00 -5.59655710e-01 -5.59655710e-01
 -5.59655710e-01  1.09499792e+00  1.09499792e+00  1.09499792e+00
  8.32814668e+00  8.32814668e+00  8.32814668e+00  3.96601279e+01
  3.96601279e+01  3.96601279e+01  1.55295827e+02  1.55295827e+02
  1.55295827e+02  1.65154363e+02  5.32257547e+02  5.32257547e+02
  5.32257547e+02  1.38713040e+03  1.38713040e+03  1.38713040e+03
  1.78653713e+03  3.07660195e+03  3.07660195e+03  3.07660195e+03
  6.69042769e+03  6.69042769e+03  6.69042769e+03  7.96882159e+03
  2.42255085e+04  7.49779243e+04]
E1 = -727.3525832216943  E_coul = 201.77251878357293
cycle= 1 E= -525.580064438121  delta_E= -1.22  |g|= 0.202  |ddm|= 0.352
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.495103
diis-c [-0.24512661  1.        ]
  HOMO = -0.572037715415002  LUMO = 1.08756803932503
  mo_energy =
[-1.18150388e+02 -1.21754799e+01 -9.53732024e+00 -9.53732024e+00
 -9.53732024e+00 -1.24995886e+00 -5.72037715e-01 -5.72037715e-01
 -5.72037715e-01  1.08756804e+00  1.08756804e+00  1.08756804e+00
  8.27611821e+00  8.27611821e+00  8.27611821e+00  3.95563940e+01
  3.95563940e+01  3.95563940e+01  1.55122928e+02  1.55122928e+02
  1.55122928e+02  1.64964562e+02  5.32019387e+02  5.32019387e+02
  5.32019387e+02  1.38683965e+03  1.38683965e+03  1.38683965e+03
  1.78611377e+03  3.07624156e+03  3.07624156e+03  3.07624156e+03
  6.68993596e+03  6.68993596e+03  6.68993596e+03  7.96823879e+03
  2.42248218e+04  7.49771402e+04]
E1 = -727.5688444387104  E_coul = 201.98856625157057
cycle= 2 E= -525.58027818714  delta_E= -0.000214  |g|= 0.0166  |ddm|= 0.0146
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0334423
diis-c [-8.31364374e-04  3.31407826e-02  9.66859217e-01]
  HOMO = -0.569362623776565  LUMO = 1.08979705468216
  mo_energy =
[-1.18118673e+02 -1.21603800e+01 -9.52197638e+00 -9.52197638e+00
 -9.52197638e+00 -1.24637007e+00 -5.69362624e-01 -5.69362624e-01
 -5.69362624e-01  1.08979705e+00  1.08979705e+00  1.08979705e+00
  8.28500825e+00  8.28500825e+00  8.28500825e+00  3.95736365e+01
  3.95736365e+01  3.95736365e+01  1.55148828e+02  1.55148828e+02
  1.55148828e+02  1.64994580e+02  5.32050661e+02  5.32050661e+02
  5.32050661e+02  1.38687308e+03  1.38687308e+03  1.38687308e+03
  1.78614878e+03  3.07627615e+03  3.07627615e+03  3.07627615e+03
  6.68997118e+03  6.68997118e+03  6.68997118e+03  7.96827425e+03
  2.42248573e+04  7.49771756e+04]
E1 = -727.5243364993935  E_coul = 201.94405168330152
cycle= 3 E= -525.580284816092  delta_E= -6.63e-06  |g|= 0.00223  |ddm|= 0.00382
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00472884
diis-c [-1.10825496e-07 -8.37887133e-04  1.18342179e-01  8.82495708e-01]
  HOMO = -0.569897346081039  LUMO = 1.08936680796985
  mo_energy =
[-1.18122877e+02 -1.21627062e+01 -9.52435430e+00 -9.52435430e+00
 -9.52435430e+00 -1.24707274e+00 -5.69897346e-01 -5.69897346e-01
 -5.69897346e-01  1.08936681e+00  1.08936681e+00  1.08936681e+00
  8.28348589e+00  8.28348589e+00  8.28348589e+00  3.95710646e+01
  3.95710646e+01  3.95710646e+01  1.55145275e+02  1.55145275e+02
  1.55145275e+02  1.64990626e+02  5.32046515e+02  5.32046515e+02
  5.32046515e+02  1.38686868e+03  1.38686868e+03  1.38686868e+03
  1.78614414e+03  3.07627159e+03  3.07627159e+03  3.07627159e+03
  6.68996647e+03  6.68996647e+03  6.68996647e+03  7.96826945e+03
  2.42248524e+04  7.49771707e+04]
E1 = -727.5309058473111  E_coul = 201.950620853676
cycle= 4 E= -525.580284993635  delta_E= -1.78e-07  |g|= 4.16e-05  |ddm|= 0.000616
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=7.29141e-05
diis-c [-5.63974255e-10 -2.78163798e-05  3.27590790e-03  3.83774858e-02
  9.58374423e-01]
  HOMO = -0.569873198397375  LUMO = 1.08938572821167
  mo_energy =
[-1.18122782e+02 -1.21626271e+01 -9.52427444e+00 -9.52427444e+00
 -9.52427444e+00 -1.24704134e+00 -5.69873198e-01 -5.69873198e-01
 -5.69873198e-01  1.08938573e+00  1.08938573e+00  1.08938573e+00
  8.28354494e+00  8.28354494e+00  8.28354494e+00  3.95711448e+01
  3.95711448e+01  3.95711448e+01  1.55145366e+02  1.55145366e+02
  1.55145366e+02  1.64990721e+02  5.32046609e+02  5.32046609e+02
  5.32046609e+02  1.38686878e+03  1.38686878e+03  1.38686878e+03
  1.78614423e+03  3.07627169e+03  3.07627169e+03  3.07627169e+03
  6.68996656e+03  6.68996656e+03  6.68996656e+03  7.96826954e+03
  2.42248525e+04  7.49771708e+04]
E1 = -727.5307089421115  E_coul = 201.9504239483303
cycle= 5 E= -525.580284993781  delta_E= -1.46e-10  |g|= 2.95e-06  |ddm|= 2.19e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5307089421115  E_coul = 201.9504239483303
  HOMO = -0.569874789410037  LUMO = 1.0893844808824
  mo_energy =
[-1.18122790e+02 -1.21626326e+01 -9.52428009e+00 -9.52428009e+00
 -9.52428009e+00 -1.24704342e+00 -5.69874789e-01 -5.69874789e-01
 -5.69874789e-01  1.08938448e+00  1.08938448e+00  1.08938448e+00
  8.28354092e+00  8.28354092e+00  8.28354092e+00  3.95711390e+01
  3.95711390e+01  3.95711390e+01  1.55145359e+02  1.55145359e+02
  1.55145359e+02  1.64990713e+02  5.32046601e+02  5.32046601e+02
  5.32046601e+02  1.38686877e+03  1.38686877e+03  1.38686877e+03
  1.78614422e+03  3.07627168e+03  3.07627168e+03  3.07627168e+03
  6.68996655e+03  6.68996655e+03  6.68996655e+03  7.96826953e+03
  2.42248525e+04  7.49771708e+04]
E1 = -727.5307234089098  E_coul = 201.95043841512702
Extra cycle  E= -525.580284993783  delta_E= -1.71e-12  |g|= 7.29e-07  |ddm|= 1.55e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
exp = [2.61828138e+04 7.61490752e+03 3.61161740e+03 1.51465431e+03
 2.20274497e+02 4.95240304e+01 4.60451778e+00 3.97330211e-01
 1.36283712e+03 6.64295177e+02 2.98938836e+02 3.12320350e+02
 7.38816871e+01 8.31197123e+00 2.40796494e+01 8.12759727e-01
 3.10414293e+00 2.30834966e-01]
E = -525.5802849937828
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8138055        1
[INPUT] 0    0    [1    /1   ]  7614.9075213         1
[INPUT] 0    0    [1    /1   ]  3611.61740296        1
[INPUT] 0    0    [1    /1   ]  1514.65431008        1
[INPUT] 0    0    [1    /1   ]  220.274497174        1
[INPUT] 0    0    [1    /1   ]  49.5240304224        1
[INPUT] 0    0    [1    /1   ]  4.60451777661        1
[INPUT] 0    0    [1    /1   ]  0.397330211357       1
[INPUT] 1    0    [1    /1   ]  1362.83712081        1
[INPUT] 1    0    [1    /1   ]  664.295176921        1
[INPUT] 1    0    [1    /1   ]  298.938835577        1
[INPUT] 1    0    [1    /1   ]  312.320350266        1
[INPUT] 1    0    [1    /1   ]  73.8816871414        1
[INPUT] 1    0    [1    /1   ]  8.31197122597        1
[INPUT] 1    0    [1    /1   ]  24.0796494007        1
[INPUT] 1    0    [1    /1   ]  0.812759726625       1
[INPUT] 1    0    [1    /1   ]  3.10414292534        1
[INPUT] 1    0    [1    /1   ]  0.230834965747       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.813805519654, 1.0]], [0, [7614.907521297112, 1.0]], [0, [3611.6174029562176, 1.0]], [0, [1514.6543100797032, 1.0]], [0, [220.27449717354315, 1.0]], [0, [49.524030422356915, 1.0]], [0, [4.60451777660842, 1.0]], [0, [0.39733021135712326, 1.0]], [1, [1362.8371208067674, 1.0]], [1, [664.2951769211858, 1.0]], [1, [298.93883557734074, 1.0]], [1, [312.3203502664781, 1.0]], [1, [73.88168714141362, 1.0]], [1, [8.311971225967415, 1.0]], [1, [24.07964940070228, 1.0]], [1, [0.8127597266254796, 1.0]], [1, [3.104142925341708, 1.0]], [1, [0.23083496574743695, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.81380552]
bas 1, expnt(s) = [7614.9075213]
bas 2, expnt(s) = [3611.61740296]
bas 3, expnt(s) = [1514.65431008]
bas 4, expnt(s) = [220.27449717]
bas 5, expnt(s) = [49.52403042]
bas 6, expnt(s) = [4.60451778]
bas 7, expnt(s) = [0.39733021]
bas 8, expnt(s) = [1362.83712081]
bas 9, expnt(s) = [664.29517692]
bas 10, expnt(s) = [298.93883558]
bas 11, expnt(s) = [312.32035027]
bas 12, expnt(s) = [73.88168714]
bas 13, expnt(s) = [8.31197123]
bas 14, expnt(s) = [24.0796494]
bas 15, expnt(s) = [0.81275973]
bas 16, expnt(s) = [3.10414293]
bas 17, expnt(s) = [0.23083497]
CPU time:       422.84
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828138e+04 5.20028640e+03 7.61490752e+03 2.05950808e+03
 3.61161740e+03 1.17704028e+03 1.51465431e+03 6.13409034e+02
 2.20274497e+02 1.44456866e+02 4.95240304e+01 4.71657789e+01
 4.60451778e+00 7.94151096e+00 3.97330211e-01 1.26438320e+00
 1.36283712e+03 2.41567962e+04 6.64295177e+02 9.83865579e+03
 2.98938836e+02 3.62628819e+03 3.12320350e+02 3.83031725e+03
 7.38816871e+01 6.31910247e+02 8.31197123e+00 4.11731819e+01
 2.40796494e+01 1.55613436e+02 8.12759727e-01 2.25131939e+00
 3.10414293e+00 1.20201954e+01 2.30834966e-01 4.66779082e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972961940724726
cond(S) = 115596.64303978319
E1 = -727.4507999072317  E_coul = 203.08788217424737
init E= -524.362917732984
    CPU time for initialize scf      0.68 sec, wall time      0.08 sec
  HOMO = -0.559655709713046  LUMO = 1.09499791723853
  mo_energy =
[-1.17899281e+02 -1.20882767e+01 -9.44976606e+00 -9.44976606e+00
 -9.44976606e+00 -1.22969648e+00 -5.59655710e-01 -5.59655710e-01
 -5.59655710e-01  1.09499792e+00  1.09499792e+00  1.09499792e+00
  8.32814668e+00  8.32814668e+00  8.32814668e+00  3.96601279e+01
  3.96601279e+01  3.96601279e+01  1.55295827e+02  1.55295827e+02
  1.55295827e+02  1.65154363e+02  5.32257547e+02  5.32257547e+02
  5.32257547e+02  1.38713040e+03  1.38713040e+03  1.38713040e+03
  1.78653713e+03  3.07660195e+03  3.07660195e+03  3.07660195e+03
  6.69042769e+03  6.69042769e+03  6.69042769e+03  7.96882159e+03
  2.42255085e+04  7.49779243e+04]
E1 = -727.3525832216943  E_coul = 201.77251878357293
cycle= 1 E= -525.580064438121  delta_E= -1.22  |g|= 0.202  |ddm|= 0.352
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.495103
diis-c [-0.24512661  1.        ]
  HOMO = -0.572037715415002  LUMO = 1.08756803932503
  mo_energy =
[-1.18150388e+02 -1.21754799e+01 -9.53732024e+00 -9.53732024e+00
 -9.53732024e+00 -1.24995886e+00 -5.72037715e-01 -5.72037715e-01
 -5.72037715e-01  1.08756804e+00  1.08756804e+00  1.08756804e+00
  8.27611821e+00  8.27611821e+00  8.27611821e+00  3.95563940e+01
  3.95563940e+01  3.95563940e+01  1.55122928e+02  1.55122928e+02
  1.55122928e+02  1.64964562e+02  5.32019387e+02  5.32019387e+02
  5.32019387e+02  1.38683965e+03  1.38683965e+03  1.38683965e+03
  1.78611377e+03  3.07624156e+03  3.07624156e+03  3.07624156e+03
  6.68993596e+03  6.68993596e+03  6.68993596e+03  7.96823879e+03
  2.42248218e+04  7.49771402e+04]
E1 = -727.5688444387104  E_coul = 201.98856625157057
cycle= 2 E= -525.58027818714  delta_E= -0.000214  |g|= 0.0166  |ddm|= 0.0146
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0334423
diis-c [-8.31364374e-04  3.31407826e-02  9.66859217e-01]
  HOMO = -0.569362623776565  LUMO = 1.08979705468216
  mo_energy =
[-1.18118673e+02 -1.21603800e+01 -9.52197638e+00 -9.52197638e+00
 -9.52197638e+00 -1.24637007e+00 -5.69362624e-01 -5.69362624e-01
 -5.69362624e-01  1.08979705e+00  1.08979705e+00  1.08979705e+00
  8.28500825e+00  8.28500825e+00  8.28500825e+00  3.95736365e+01
  3.95736365e+01  3.95736365e+01  1.55148828e+02  1.55148828e+02
  1.55148828e+02  1.64994580e+02  5.32050661e+02  5.32050661e+02
  5.32050661e+02  1.38687308e+03  1.38687308e+03  1.38687308e+03
  1.78614878e+03  3.07627615e+03  3.07627615e+03  3.07627615e+03
  6.68997118e+03  6.68997118e+03  6.68997118e+03  7.96827425e+03
  2.42248573e+04  7.49771756e+04]
E1 = -727.5243364993935  E_coul = 201.94405168330152
cycle= 3 E= -525.580284816092  delta_E= -6.63e-06  |g|= 0.00223  |ddm|= 0.00382
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00472884
diis-c [-1.10825496e-07 -8.37887133e-04  1.18342179e-01  8.82495708e-01]
  HOMO = -0.569897346081039  LUMO = 1.08936680796985
  mo_energy =
[-1.18122877e+02 -1.21627062e+01 -9.52435430e+00 -9.52435430e+00
 -9.52435430e+00 -1.24707274e+00 -5.69897346e-01 -5.69897346e-01
 -5.69897346e-01  1.08936681e+00  1.08936681e+00  1.08936681e+00
  8.28348589e+00  8.28348589e+00  8.28348589e+00  3.95710646e+01
  3.95710646e+01  3.95710646e+01  1.55145275e+02  1.55145275e+02
  1.55145275e+02  1.64990626e+02  5.32046515e+02  5.32046515e+02
  5.32046515e+02  1.38686868e+03  1.38686868e+03  1.38686868e+03
  1.78614414e+03  3.07627159e+03  3.07627159e+03  3.07627159e+03
  6.68996647e+03  6.68996647e+03  6.68996647e+03  7.96826945e+03
  2.42248524e+04  7.49771707e+04]
E1 = -727.5309058473111  E_coul = 201.950620853676
cycle= 4 E= -525.580284993635  delta_E= -1.78e-07  |g|= 4.16e-05  |ddm|= 0.000616
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=7.29141e-05
diis-c [-5.63974255e-10 -2.78163798e-05  3.27590790e-03  3.83774858e-02
  9.58374423e-01]
  HOMO = -0.569873198397375  LUMO = 1.08938572821167
  mo_energy =
[-1.18122782e+02 -1.21626271e+01 -9.52427444e+00 -9.52427444e+00
 -9.52427444e+00 -1.24704134e+00 -5.69873198e-01 -5.69873198e-01
 -5.69873198e-01  1.08938573e+00  1.08938573e+00  1.08938573e+00
  8.28354494e+00  8.28354494e+00  8.28354494e+00  3.95711448e+01
  3.95711448e+01  3.95711448e+01  1.55145366e+02  1.55145366e+02
  1.55145366e+02  1.64990721e+02  5.32046609e+02  5.32046609e+02
  5.32046609e+02  1.38686878e+03  1.38686878e+03  1.38686878e+03
  1.78614423e+03  3.07627169e+03  3.07627169e+03  3.07627169e+03
  6.68996656e+03  6.68996656e+03  6.68996656e+03  7.96826954e+03
  2.42248525e+04  7.49771708e+04]
E1 = -727.5307089421115  E_coul = 201.9504239483303
cycle= 5 E= -525.580284993781  delta_E= -1.46e-10  |g|= 2.95e-06  |ddm|= 2.19e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5307089421115  E_coul = 201.9504239483303
  HOMO = -0.569874789410037  LUMO = 1.0893844808824
  mo_energy =
[-1.18122790e+02 -1.21626326e+01 -9.52428009e+00 -9.52428009e+00
 -9.52428009e+00 -1.24704342e+00 -5.69874789e-01 -5.69874789e-01
 -5.69874789e-01  1.08938448e+00  1.08938448e+00  1.08938448e+00
  8.28354092e+00  8.28354092e+00  8.28354092e+00  3.95711390e+01
  3.95711390e+01  3.95711390e+01  1.55145359e+02  1.55145359e+02
  1.55145359e+02  1.64990713e+02  5.32046601e+02  5.32046601e+02
  5.32046601e+02  1.38686877e+03  1.38686877e+03  1.38686877e+03
  1.78614422e+03  3.07627168e+03  3.07627168e+03  3.07627168e+03
  6.68996655e+03  6.68996655e+03  6.68996655e+03  7.96826953e+03
  2.42248525e+04  7.49771708e+04]
E1 = -727.5307234089098  E_coul = 201.95043841512702
Extra cycle  E= -525.580284993783  delta_E= -1.71e-12  |g|= 7.29e-07  |ddm|= 1.55e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 115596.64303978319
E1 = -727.5307234089098  E_coul = 201.95043841512702
init E= -525.580284993783
    CPU time for initialize scf      1.78 sec, wall time      0.23 sec
  HOMO = -0.569874515896446  LUMO = 1.08938469870634
  mo_energy =
[-1.18122788e+02 -1.21626315e+01 -9.52427900e+00 -9.52427900e+00
 -9.52427900e+00 -1.24704306e+00 -5.69874516e-01 -5.69874516e-01
 -5.69874516e-01  1.08938470e+00  1.08938470e+00  1.08938470e+00
  8.28354166e+00  8.28354166e+00  8.28354166e+00  3.95711402e+01
  3.95711402e+01  3.95711402e+01  1.55145360e+02  1.55145360e+02
  1.55145360e+02  1.64990715e+02  5.32046603e+02  5.32046603e+02
  5.32046603e+02  1.38686877e+03  1.38686877e+03  1.38686877e+03
  1.78614422e+03  3.07627168e+03  3.07627168e+03  3.07627168e+03
  6.68996656e+03  6.68996656e+03  6.68996656e+03  7.96826953e+03
  2.42248525e+04  7.49771708e+04]
E1 = -727.5307205087721  E_coul = 201.9504355149895
cycle= 1 E= -525.580284993783  delta_E= 2.27e-13  |g|= 1.57e-07  |ddm|= 2.87e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.5307205087721  E_coul = 201.9504355149895
  HOMO = -0.569874567875205  LUMO = 1.08938465714904
  mo_energy =
[-1.18122789e+02 -1.21626318e+01 -9.52427922e+00 -9.52427922e+00
 -9.52427922e+00 -1.24704313e+00 -5.69874568e-01 -5.69874568e-01
 -5.69874568e-01  1.08938466e+00  1.08938466e+00  1.08938466e+00
  8.28354151e+00  8.28354151e+00  8.28354151e+00  3.95711400e+01
  3.95711400e+01  3.95711400e+01  1.55145360e+02  1.55145360e+02
  1.55145360e+02  1.64990715e+02  5.32046603e+02  5.32046603e+02
  5.32046603e+02  1.38686877e+03  1.38686877e+03  1.38686877e+03
  1.78614422e+03  3.07627168e+03  3.07627168e+03  3.07627168e+03
  6.68996655e+03  6.68996655e+03  6.68996655e+03  7.96826953e+03
  2.42248525e+04  7.49771708e+04]
E1 = -727.5307210968049  E_coul = 201.95043610302184
Extra cycle  E= -525.580284993783  delta_E= -4.55e-13  |g|= 3.27e-08  |ddm|= 5.71e-08
    CPU time for scf_cycle      1.88 sec, wall time      0.34 sec
exp = [2.61828138e+04 7.61490752e+03 3.61161740e+03 1.51465431e+03
 2.20274497e+02 4.95240304e+01 4.60451778e+00 3.97330211e-01
 1.36283712e+03 6.64295177e+02 2.98938836e+02 3.12320350e+02
 7.38816871e+01 8.31197123e+00 2.40796494e+01 8.12759727e-01
 3.10414293e+00 2.30834966e-01]
grad_E = [-1.98828243e-06  2.63755255e-05  5.35329943e-05  1.01627429e-03
 -5.71884745e-03 -2.49948170e-04  4.47886670e-04 -4.59943718e-04
 -6.62661026e-07  1.11159181e-06  3.64134774e-06  3.01290983e-06
 -4.55507888e-06 -1.28779335e-02  4.10259969e-03  1.19466842e-02
  1.10214819e-02 -1.50150708e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7666843        1
[INPUT] 0    0    [1    /1   ]  7615.42202136        1
[INPUT] 0    0    [1    /1   ]  3612.63757744        1
[INPUT] 0    0    [1    /1   ]  1530.60203131        1
[INPUT] 0    0    [1    /1   ]  223.464659581        1
[INPUT] 0    0    [1    /1   ]  49.9537997878        1
[INPUT] 0    0    [1    /1   ]  4.60369489313        1
[INPUT] 0    0    [1    /1   ]  0.397510349115       1
[INPUT] 1    0    [1    /1   ]  1362.82816664        1
[INPUT] 1    0    [1    /1   ]  664.413199483        1
[INPUT] 1    0    [1    /1   ]  299.509884921        1
[INPUT] 1    0    [1    /1   ]  312.817893097        1
[INPUT] 1    0    [1    /1   ]  72.0422300672        1
[INPUT] 1    0    [1    /1   ]  8.66674420341        1
[INPUT] 1    0    [1    /1   ]  23.8824842756        1
[INPUT] 1    0    [1    /1   ]  0.818781563117       1
[INPUT] 1    0    [1    /1   ]  3.23614771176        1
[INPUT] 1    0    [1    /1   ]  0.232230050082       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.766684318103, 1.0]], [0, [7615.422021360039, 1.0]], [0, [3612.6375774394237, 1.0]], [0, [1530.6020313053243, 1.0]], [0, [223.46465958077846, 1.0]], [0, [49.953799787789585, 1.0]], [0, [4.60369489313289, 1.0]], [0, [0.3975103491153873, 1.0]], [1, [1362.8281666404887, 1.0]], [1, [664.4131994828201, 1.0]], [1, [299.5098849212755, 1.0]], [1, [312.8178930965219, 1.0]], [1, [72.04223006715955, 1.0]], [1, [8.666744203405676, 1.0]], [1, [23.88248427564713, 1.0]], [1, [0.8187815631168422, 1.0]], [1, [3.236147711761111, 1.0]], [1, [0.23223005008249187, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.76668432]
bas 1, expnt(s) = [7615.42202136]
bas 2, expnt(s) = [3612.63757744]
bas 3, expnt(s) = [1530.60203131]
bas 4, expnt(s) = [223.46465958]
bas 5, expnt(s) = [49.95379979]
bas 6, expnt(s) = [4.60369489]
bas 7, expnt(s) = [0.39751035]
bas 8, expnt(s) = [1362.82816664]
bas 9, expnt(s) = [664.41319948]
bas 10, expnt(s) = [299.50988492]
bas 11, expnt(s) = [312.8178931]
bas 12, expnt(s) = [72.04223007]
bas 13, expnt(s) = [8.6667442]
bas 14, expnt(s) = [23.88248428]
bas 15, expnt(s) = [0.81878156]
bas 16, expnt(s) = [3.23614771]
bas 17, expnt(s) = [0.23223005]
CPU time:       429.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827667e+04 5.20027938e+03 7.61542202e+03 2.05961244e+03
 3.61263758e+03 1.17728964e+03 1.53060203e+03 6.18246602e+02
 2.23464660e+02 1.46023133e+02 4.99537998e+01 4.74724254e+01
 4.60369489e+00 7.94044650e+00 3.97510349e-01 1.26481310e+00
 1.36282817e+03 2.41565978e+04 6.64413199e+02 9.84084083e+03
 2.99509885e+02 3.63494918e+03 3.12817893e+02 3.83794614e+03
 7.20422301e+01 6.12305735e+02 8.66674420e+00 4.33814802e+01
 2.38824843e+01 1.54022358e+02 8.18781563e-01 2.27218904e+00
 3.23614771e+00 1.26625103e+01 2.32230050e-01 4.70308050e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972563812604708
cond(S) = 115087.80902372101
E1 = -727.4800251230962  E_coul = 203.0932629573466
init E= -524.38676216575
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.559428794499967  LUMO = 1.10652786857005
  mo_energy =
[-1.17897568e+02 -1.20892845e+01 -9.44958950e+00 -9.44958950e+00
 -9.44958950e+00 -1.22985109e+00 -5.59428795e-01 -5.59428795e-01
 -5.59428794e-01  1.10652787e+00  1.10652787e+00  1.10652787e+00
  8.71265761e+00  8.71265761e+00  8.71265761e+00  4.08772948e+01
  4.08772948e+01  4.08772948e+01  1.54813682e+02  1.54813682e+02
  1.54813682e+02  1.68128110e+02  5.28609544e+02  5.28609544e+02
  5.28609544e+02  1.38317691e+03  1.38317691e+03  1.38317691e+03
  1.80725404e+03  3.07381544e+03  3.07381544e+03  3.07381544e+03
  6.68885268e+03  6.68885268e+03  6.68885268e+03  8.01702392e+03
  2.42936450e+04  7.50524871e+04]
E1 = -727.371615324238  E_coul = 201.78973216854732
cycle= 1 E= -525.581883155691  delta_E= -1.2  |g|= 0.198  |ddm|= 0.387
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.488841
diis-c [-0.23896584  1.        ]
  HOMO = -0.571395953119882  LUMO = 1.09926476515974
  mo_energy =
[-1.18145775e+02 -1.21763011e+01 -9.53673207e+00 -9.53673207e+00
 -9.53673207e+00 -1.24973686e+00 -5.71395953e-01 -5.71395953e-01
 -5.71395953e-01  1.09926477e+00  1.09926477e+00  1.09926477e+00
  8.65920710e+00  8.65920710e+00  8.65920710e+00  4.07740942e+01
  4.07740942e+01  4.07740942e+01  1.54644195e+02  1.54644195e+02
  1.54644195e+02  1.67939658e+02  5.28374872e+02  5.28374872e+02
  5.28374872e+02  1.38289002e+03  1.38289002e+03  1.38289002e+03
  1.80683628e+03  3.07346033e+03  3.07346033e+03  3.07346033e+03
  6.68836892e+03  6.68836892e+03  6.68836892e+03  8.01645049e+03
  2.42929695e+04  7.50517152e+04]
E1 = -727.5828068032368  E_coul = 202.00072100151112
cycle= 2 E= -525.582085801726  delta_E= -0.000203  |g|= 0.0161  |ddm|= 0.0145
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0326419
diis-c [-7.98769771e-04  3.23811701e-02  9.67618830e-01]
  HOMO = -0.568755379507499  LUMO = 1.10149356970958
  mo_energy =
[-1.18114837e+02 -1.21615527e+01 -9.52174935e+00 -9.52174935e+00
 -9.52174935e+00 -1.24619841e+00 -5.68755380e-01 -5.68755380e-01
 -5.68755380e-01  1.10149357e+00  1.10149357e+00  1.10149357e+00
  8.66817635e+00  8.66817635e+00  8.66817635e+00  4.07909715e+01
  4.07909715e+01  4.07909715e+01  1.54669307e+02  1.54669307e+02
  1.54669307e+02  1.67969023e+02  5.28405349e+02  5.28405349e+02
  5.28405349e+02  1.38292263e+03  1.38292263e+03  1.38292263e+03
  1.80687044e+03  3.07349406e+03  3.07349406e+03  3.07349406e+03
  6.68840327e+03  6.68840327e+03  6.68840327e+03  8.01648507e+03
  2.42930040e+04  7.50517496e+04]
E1 = -727.5395602393173  E_coul = 201.95746815724303
cycle= 3 E= -525.582092082074  delta_E= -6.28e-06  |g|= 0.00217  |ddm|= 0.00373
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00463562
diis-c [-9.93916475e-08 -8.21006500e-04  1.18944826e-01  8.81876180e-01]
  HOMO = -0.569273939288999  LUMO = 1.10107066428385
  mo_energy =
[-1.18118943e+02 -1.21638213e+01 -9.52406797e+00 -9.52406797e+00
 -9.52406797e+00 -1.24688049e+00 -5.69273939e-01 -5.69273939e-01
 -5.69273939e-01  1.10107066e+00  1.10107066e+00  1.10107066e+00
  8.66665761e+00  8.66665761e+00  8.66665761e+00  4.07884563e+01
  4.07884563e+01  4.07884563e+01  1.54665855e+02  1.54665855e+02
  1.54665855e+02  1.67965152e+02  5.28401302e+02  5.28401302e+02
  5.28401302e+02  1.38291833e+03  1.38291833e+03  1.38291833e+03
  1.80686590e+03  3.07348961e+03  3.07348961e+03  3.07348961e+03
  6.68839867e+03  6.68839867e+03  6.68839867e+03  8.01648038e+03
  2.42929993e+04  7.50517449e+04]
E1 = -727.5459287373608  E_coul = 201.96383648731222
cycle= 4 E= -525.582092250049  delta_E= -1.68e-07  |g|= 3.88e-05  |ddm|= 0.0006
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.78267e-05
diis-c [-5.06218032e-10 -2.66389974e-05  3.21915466e-03  3.70991358e-02
  9.59708349e-01]
  HOMO = -0.569251102708689  LUMO = 1.10108876846793
  mo_energy =
[-1.18118854e+02 -1.21637469e+01 -9.52399293e+00 -9.52399293e+00
 -9.52399293e+00 -1.24685081e+00 -5.69251103e-01 -5.69251103e-01
 -5.69251103e-01  1.10108877e+00  1.10108877e+00  1.10108877e+00
  8.66671427e+00  8.66671427e+00  8.66671427e+00  4.07885317e+01
  4.07885317e+01  4.07885317e+01  1.54665940e+02  1.54665940e+02
  1.54665940e+02  1.67965240e+02  5.28401391e+02  5.28401391e+02
  5.28401391e+02  1.38291842e+03  1.38291842e+03  1.38291842e+03
  1.80686599e+03  3.07348970e+03  3.07348970e+03  3.07348970e+03
  6.68839876e+03  6.68839876e+03  6.68839876e+03  8.01648047e+03
  2.42929994e+04  7.50517449e+04]
E1 = -727.5457451030514  E_coul = 201.96365285287473
cycle= 5 E= -525.582092250177  delta_E= -1.28e-10  |g|= 2.82e-06  |ddm|= 2.06e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5457451030514  E_coul = 201.96365285287473
  HOMO = -0.569252614223375  LUMO = 1.10108756852297
  mo_energy =
[-1.18118862e+02 -1.21637522e+01 -9.52399834e+00 -9.52399834e+00
 -9.52399834e+00 -1.24685278e+00 -5.69252614e-01 -5.69252614e-01
 -5.69252614e-01  1.10108757e+00  1.10108757e+00  1.10108757e+00
  8.66671037e+00  8.66671037e+00  8.66671037e+00  4.07885262e+01
  4.07885262e+01  4.07885262e+01  1.54665933e+02  1.54665933e+02
  1.54665933e+02  1.67965233e+02  5.28401383e+02  5.28401383e+02
  5.28401383e+02  1.38291841e+03  1.38291841e+03  1.38291841e+03
  1.80686598e+03  3.07348969e+03  3.07348969e+03  3.07348969e+03
  6.68839875e+03  6.68839875e+03  6.68839875e+03  8.01648046e+03
  2.42929994e+04  7.50517449e+04]
E1 = -727.5457588303037  E_coul = 201.96366658012712
Extra cycle  E= -525.582092250177  delta_E= 1.14e-13  |g|= 6.92e-07  |ddm|= 1.48e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
exp = [2.61827667e+04 7.61542202e+03 3.61263758e+03 1.53060203e+03
 2.23464660e+02 4.99537998e+01 4.60369489e+00 3.97510349e-01
 1.36282817e+03 6.64413199e+02 2.99509885e+02 3.12817893e+02
 7.20422301e+01 8.66674420e+00 2.38824843e+01 8.18781563e-01
 3.23614771e+00 2.32230050e-01]
E = -525.5820922501766
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7666843        1
[INPUT] 0    0    [1    /1   ]  7615.42202136        1
[INPUT] 0    0    [1    /1   ]  3612.63757744        1
[INPUT] 0    0    [1    /1   ]  1530.60203131        1
[INPUT] 0    0    [1    /1   ]  223.464659581        1
[INPUT] 0    0    [1    /1   ]  49.9537997878        1
[INPUT] 0    0    [1    /1   ]  4.60369489313        1
[INPUT] 0    0    [1    /1   ]  0.397510349115       1
[INPUT] 1    0    [1    /1   ]  1362.82816664        1
[INPUT] 1    0    [1    /1   ]  664.413199483        1
[INPUT] 1    0    [1    /1   ]  299.509884921        1
[INPUT] 1    0    [1    /1   ]  312.817893097        1
[INPUT] 1    0    [1    /1   ]  72.0422300672        1
[INPUT] 1    0    [1    /1   ]  8.66674420341        1
[INPUT] 1    0    [1    /1   ]  23.8824842756        1
[INPUT] 1    0    [1    /1   ]  0.818781563117       1
[INPUT] 1    0    [1    /1   ]  3.23614771176        1
[INPUT] 1    0    [1    /1   ]  0.232230050082       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.766684318103, 1.0]], [0, [7615.422021360039, 1.0]], [0, [3612.6375774394237, 1.0]], [0, [1530.6020313053243, 1.0]], [0, [223.46465958077846, 1.0]], [0, [49.953799787789585, 1.0]], [0, [4.60369489313289, 1.0]], [0, [0.3975103491153873, 1.0]], [1, [1362.8281666404887, 1.0]], [1, [664.4131994828201, 1.0]], [1, [299.5098849212755, 1.0]], [1, [312.8178930965219, 1.0]], [1, [72.04223006715955, 1.0]], [1, [8.666744203405676, 1.0]], [1, [23.88248427564713, 1.0]], [1, [0.8187815631168422, 1.0]], [1, [3.236147711761111, 1.0]], [1, [0.23223005008249187, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.76668432]
bas 1, expnt(s) = [7615.42202136]
bas 2, expnt(s) = [3612.63757744]
bas 3, expnt(s) = [1530.60203131]
bas 4, expnt(s) = [223.46465958]
bas 5, expnt(s) = [49.95379979]
bas 6, expnt(s) = [4.60369489]
bas 7, expnt(s) = [0.39751035]
bas 8, expnt(s) = [1362.82816664]
bas 9, expnt(s) = [664.41319948]
bas 10, expnt(s) = [299.50988492]
bas 11, expnt(s) = [312.8178931]
bas 12, expnt(s) = [72.04223007]
bas 13, expnt(s) = [8.6667442]
bas 14, expnt(s) = [23.88248428]
bas 15, expnt(s) = [0.81878156]
bas 16, expnt(s) = [3.23614771]
bas 17, expnt(s) = [0.23223005]
CPU time:       430.45
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827667e+04 5.20027938e+03 7.61542202e+03 2.05961244e+03
 3.61263758e+03 1.17728964e+03 1.53060203e+03 6.18246602e+02
 2.23464660e+02 1.46023133e+02 4.99537998e+01 4.74724254e+01
 4.60369489e+00 7.94044650e+00 3.97510349e-01 1.26481310e+00
 1.36282817e+03 2.41565978e+04 6.64413199e+02 9.84084083e+03
 2.99509885e+02 3.63494918e+03 3.12817893e+02 3.83794614e+03
 7.20422301e+01 6.12305735e+02 8.66674420e+00 4.33814802e+01
 2.38824843e+01 1.54022358e+02 8.18781563e-01 2.27218904e+00
 3.23614771e+00 1.26625103e+01 2.32230050e-01 4.70308050e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972563812604708
cond(S) = 115087.80902372101
E1 = -727.4800251230962  E_coul = 203.0932629573466
init E= -524.38676216575
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.559428794499967  LUMO = 1.10652786857005
  mo_energy =
[-1.17897568e+02 -1.20892845e+01 -9.44958950e+00 -9.44958950e+00
 -9.44958950e+00 -1.22985109e+00 -5.59428795e-01 -5.59428795e-01
 -5.59428794e-01  1.10652787e+00  1.10652787e+00  1.10652787e+00
  8.71265761e+00  8.71265761e+00  8.71265761e+00  4.08772948e+01
  4.08772948e+01  4.08772948e+01  1.54813682e+02  1.54813682e+02
  1.54813682e+02  1.68128110e+02  5.28609544e+02  5.28609544e+02
  5.28609544e+02  1.38317691e+03  1.38317691e+03  1.38317691e+03
  1.80725404e+03  3.07381544e+03  3.07381544e+03  3.07381544e+03
  6.68885268e+03  6.68885268e+03  6.68885268e+03  8.01702392e+03
  2.42936450e+04  7.50524871e+04]
E1 = -727.371615324238  E_coul = 201.78973216854732
cycle= 1 E= -525.581883155691  delta_E= -1.2  |g|= 0.198  |ddm|= 0.387
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.488841
diis-c [-0.23896584  1.        ]
  HOMO = -0.571395953119882  LUMO = 1.09926476515974
  mo_energy =
[-1.18145775e+02 -1.21763011e+01 -9.53673207e+00 -9.53673207e+00
 -9.53673207e+00 -1.24973686e+00 -5.71395953e-01 -5.71395953e-01
 -5.71395953e-01  1.09926477e+00  1.09926477e+00  1.09926477e+00
  8.65920710e+00  8.65920710e+00  8.65920710e+00  4.07740942e+01
  4.07740942e+01  4.07740942e+01  1.54644195e+02  1.54644195e+02
  1.54644195e+02  1.67939658e+02  5.28374872e+02  5.28374872e+02
  5.28374872e+02  1.38289002e+03  1.38289002e+03  1.38289002e+03
  1.80683628e+03  3.07346033e+03  3.07346033e+03  3.07346033e+03
  6.68836892e+03  6.68836892e+03  6.68836892e+03  8.01645049e+03
  2.42929695e+04  7.50517152e+04]
E1 = -727.5828068032368  E_coul = 202.00072100151112
cycle= 2 E= -525.582085801726  delta_E= -0.000203  |g|= 0.0161  |ddm|= 0.0145
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0326419
diis-c [-7.98769771e-04  3.23811701e-02  9.67618830e-01]
  HOMO = -0.568755379507499  LUMO = 1.10149356970958
  mo_energy =
[-1.18114837e+02 -1.21615527e+01 -9.52174935e+00 -9.52174935e+00
 -9.52174935e+00 -1.24619841e+00 -5.68755380e-01 -5.68755380e-01
 -5.68755380e-01  1.10149357e+00  1.10149357e+00  1.10149357e+00
  8.66817635e+00  8.66817635e+00  8.66817635e+00  4.07909715e+01
  4.07909715e+01  4.07909715e+01  1.54669307e+02  1.54669307e+02
  1.54669307e+02  1.67969023e+02  5.28405349e+02  5.28405349e+02
  5.28405349e+02  1.38292263e+03  1.38292263e+03  1.38292263e+03
  1.80687044e+03  3.07349406e+03  3.07349406e+03  3.07349406e+03
  6.68840327e+03  6.68840327e+03  6.68840327e+03  8.01648507e+03
  2.42930040e+04  7.50517496e+04]
E1 = -727.5395602393173  E_coul = 201.95746815724303
cycle= 3 E= -525.582092082074  delta_E= -6.28e-06  |g|= 0.00217  |ddm|= 0.00373
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00463562
diis-c [-9.93916475e-08 -8.21006500e-04  1.18944826e-01  8.81876180e-01]
  HOMO = -0.569273939288999  LUMO = 1.10107066428385
  mo_energy =
[-1.18118943e+02 -1.21638213e+01 -9.52406797e+00 -9.52406797e+00
 -9.52406797e+00 -1.24688049e+00 -5.69273939e-01 -5.69273939e-01
 -5.69273939e-01  1.10107066e+00  1.10107066e+00  1.10107066e+00
  8.66665761e+00  8.66665761e+00  8.66665761e+00  4.07884563e+01
  4.07884563e+01  4.07884563e+01  1.54665855e+02  1.54665855e+02
  1.54665855e+02  1.67965152e+02  5.28401302e+02  5.28401302e+02
  5.28401302e+02  1.38291833e+03  1.38291833e+03  1.38291833e+03
  1.80686590e+03  3.07348961e+03  3.07348961e+03  3.07348961e+03
  6.68839867e+03  6.68839867e+03  6.68839867e+03  8.01648038e+03
  2.42929993e+04  7.50517449e+04]
E1 = -727.5459287373608  E_coul = 201.96383648731222
cycle= 4 E= -525.582092250049  delta_E= -1.68e-07  |g|= 3.88e-05  |ddm|= 0.0006
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.78267e-05
diis-c [-5.06218032e-10 -2.66389974e-05  3.21915466e-03  3.70991358e-02
  9.59708349e-01]
  HOMO = -0.569251102708689  LUMO = 1.10108876846793
  mo_energy =
[-1.18118854e+02 -1.21637469e+01 -9.52399293e+00 -9.52399293e+00
 -9.52399293e+00 -1.24685081e+00 -5.69251103e-01 -5.69251103e-01
 -5.69251103e-01  1.10108877e+00  1.10108877e+00  1.10108877e+00
  8.66671427e+00  8.66671427e+00  8.66671427e+00  4.07885317e+01
  4.07885317e+01  4.07885317e+01  1.54665940e+02  1.54665940e+02
  1.54665940e+02  1.67965240e+02  5.28401391e+02  5.28401391e+02
  5.28401391e+02  1.38291842e+03  1.38291842e+03  1.38291842e+03
  1.80686599e+03  3.07348970e+03  3.07348970e+03  3.07348970e+03
  6.68839876e+03  6.68839876e+03  6.68839876e+03  8.01648047e+03
  2.42929994e+04  7.50517449e+04]
E1 = -727.5457451030514  E_coul = 201.96365285287473
cycle= 5 E= -525.582092250177  delta_E= -1.28e-10  |g|= 2.82e-06  |ddm|= 2.06e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5457451030514  E_coul = 201.96365285287473
  HOMO = -0.569252614223375  LUMO = 1.10108756852297
  mo_energy =
[-1.18118862e+02 -1.21637522e+01 -9.52399834e+00 -9.52399834e+00
 -9.52399834e+00 -1.24685278e+00 -5.69252614e-01 -5.69252614e-01
 -5.69252614e-01  1.10108757e+00  1.10108757e+00  1.10108757e+00
  8.66671037e+00  8.66671037e+00  8.66671037e+00  4.07885262e+01
  4.07885262e+01  4.07885262e+01  1.54665933e+02  1.54665933e+02
  1.54665933e+02  1.67965233e+02  5.28401383e+02  5.28401383e+02
  5.28401383e+02  1.38291841e+03  1.38291841e+03  1.38291841e+03
  1.80686598e+03  3.07348969e+03  3.07348969e+03  3.07348969e+03
  6.68839875e+03  6.68839875e+03  6.68839875e+03  8.01648046e+03
  2.42929994e+04  7.50517449e+04]
E1 = -727.5457588303037  E_coul = 201.96366658012712
Extra cycle  E= -525.582092250177  delta_E= 1.14e-13  |g|= 6.92e-07  |ddm|= 1.48e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 115087.80902372101
E1 = -727.5457588303037  E_coul = 201.96366658012712
init E= -525.582092250177
    CPU time for initialize scf      0.96 sec, wall time      0.19 sec
  HOMO = -0.569252355153474  LUMO = 1.10108777750332
  mo_energy =
[-1.18118860e+02 -1.21637512e+01 -9.52399730e+00 -9.52399730e+00
 -9.52399730e+00 -1.24685244e+00 -5.69252355e-01 -5.69252355e-01
 -5.69252355e-01  1.10108778e+00  1.10108778e+00  1.10108778e+00
  8.66671108e+00  8.66671108e+00  8.66671108e+00  4.07885273e+01
  4.07885273e+01  4.07885273e+01  1.54665935e+02  1.54665935e+02
  1.54665935e+02  1.67965234e+02  5.28401385e+02  5.28401385e+02
  5.28401385e+02  1.38291842e+03  1.38291842e+03  1.38291842e+03
  1.80686598e+03  3.07348969e+03  3.07348969e+03  3.07348969e+03
  6.68839875e+03  6.68839875e+03  6.68839875e+03  8.01648046e+03
  2.42929994e+04  7.50517449e+04]
E1 = -727.5457560950027  E_coul = 201.9636638448255
cycle= 1 E= -525.582092250177  delta_E= -5.68e-13  |g|= 1.48e-07  |ddm|= 2.72e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.5457560950027  E_coul = 201.9636638448255
  HOMO = -0.569252404050738  LUMO = 1.10108773789682
  mo_energy =
[-1.18118861e+02 -1.21637514e+01 -9.52399751e+00 -9.52399751e+00
 -9.52399751e+00 -1.24685250e+00 -5.69252404e-01 -5.69252404e-01
 -5.69252404e-01  1.10108774e+00  1.10108774e+00  1.10108774e+00
  8.66671094e+00  8.66671094e+00  8.66671094e+00  4.07885271e+01
  4.07885271e+01  4.07885271e+01  1.54665935e+02  1.54665935e+02
  1.54665935e+02  1.67965234e+02  5.28401385e+02  5.28401385e+02
  5.28401385e+02  1.38291842e+03  1.38291842e+03  1.38291842e+03
  1.80686598e+03  3.07348969e+03  3.07348969e+03  3.07348969e+03
  6.68839875e+03  6.68839875e+03  6.68839875e+03  8.01648046e+03
  2.42929994e+04  7.50517449e+04]
E1 = -727.5457566463615  E_coul = 201.96366439618527
Extra cycle  E= -525.582092250176  delta_E= 1.02e-12  |g|= 3.07e-08  |ddm|= 5.37e-08
    CPU time for scf_cycle      1.08 sec, wall time      0.32 sec
exp = [2.61827667e+04 7.61542202e+03 3.61263758e+03 1.53060203e+03
 2.23464660e+02 4.99537998e+01 4.60369489e+00 3.97510349e-01
 1.36282817e+03 6.64413199e+02 2.99509885e+02 3.12817893e+02
 7.20422301e+01 8.66674420e+00 2.38824843e+01 8.18781563e-01
 3.23614771e+00 2.32230050e-01]
grad_E = [-1.98999433e-06  2.55709930e-05  5.17213879e-05  9.50702234e-04
 -4.56613715e-03 -8.04786009e-04  5.39469658e-05 -5.54049328e-04
 -6.48390778e-07  1.03558485e-06  2.81488920e-06  2.40530742e-06
  3.85690057e-04  7.08335078e-03 -1.66426546e-03  4.95211903e-04
 -5.17803122e-03  4.17014012e-05]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7602669        1
[INPUT] 0    0    [1    /1   ]  7615.49195579        1
[INPUT] 0    0    [1    /1   ]  3612.77604012        1
[INPUT] 0    0    [1    /1   ]  1532.77112097        1
[INPUT] 0    0    [1    /1   ]  223.966553986        1
[INPUT] 0    0    [1    /1   ]  50.0232306146        1
[INPUT] 0    0    [1    /1   ]  4.60370309221        1
[INPUT] 0    0    [1    /1   ]  0.397616709313       1
[INPUT] 1    0    [1    /1   ]  1362.82620853        1
[INPUT] 1    0    [1    /1   ]  664.42306016         1
[INPUT] 1    0    [1    /1   ]  299.55236332         1
[INPUT] 1    0    [1    /1   ]  312.854472153        1
[INPUT] 1    0    [1    /1   ]  72.657631537         1
[INPUT] 1    0    [1    /1   ]  8.41215499237        1
[INPUT] 1    0    [1    /1   ]  23.724990125         1
[INPUT] 1    0    [1    /1   ]  0.807556957604       1
[INPUT] 1    0    [1    /1   ]  3.13270116035        1
[INPUT] 1    0    [1    /1   ]  0.229764547285       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.760266911566, 1.0]], [0, [7615.491955787286, 1.0]], [0, [3612.7760401239066, 1.0]], [0, [1532.771120969562, 1.0]], [0, [223.96655398644504, 1.0]], [0, [50.0232306146353, 1.0]], [0, [4.603703092205439, 1.0]], [0, [0.3976167093133533, 1.0]], [1, [1362.8262085349643, 1.0]], [1, [664.4230601604045, 1.0]], [1, [299.55236332018603, 1.0]], [1, [312.8544721529298, 1.0]], [1, [72.65763153703988, 1.0]], [1, [8.412154992371871, 1.0]], [1, [23.724990124954992, 1.0]], [1, [0.8075569576042795, 1.0]], [1, [3.132701160346187, 1.0]], [1, [0.2297645472850948, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.76026691]
bas 1, expnt(s) = [7615.49195579]
bas 2, expnt(s) = [3612.77604012]
bas 3, expnt(s) = [1532.77112097]
bas 4, expnt(s) = [223.96655399]
bas 5, expnt(s) = [50.02323061]
bas 6, expnt(s) = [4.60370309]
bas 7, expnt(s) = [0.39761671]
bas 8, expnt(s) = [1362.82620853]
bas 9, expnt(s) = [664.42306016]
bas 10, expnt(s) = [299.55236332]
bas 11, expnt(s) = [312.85447215]
bas 12, expnt(s) = [72.65763154]
bas 13, expnt(s) = [8.41215499]
bas 14, expnt(s) = [23.72499012]
bas 15, expnt(s) = [0.80755696]
bas 16, expnt(s) = [3.13270116]
bas 17, expnt(s) = [0.22976455]
CPU time:       436.40
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827603e+04 5.20027842e+03 7.61549196e+03 2.05962662e+03
 3.61277604e+03 1.17732348e+03 1.53277112e+03 6.18903596e+02
 2.23966554e+02 1.46269036e+02 5.00232306e+01 4.75219033e+01
 4.60370309e+00 7.94045711e+00 3.97616709e-01 1.26506690e+00
 1.36282621e+03 2.41565544e+04 6.64423060e+02 9.84102339e+03
 2.99552363e+02 3.63559360e+03 3.12854472e+02 3.83850713e+03
 7.26576315e+01 6.18850774e+02 8.41215499e+00 4.17944366e+01
 2.37249901e+01 1.52753772e+02 8.07556958e-01 2.23331944e+00
 3.13270116e+00 1.21585869e+01 2.29764547e-01 4.64074991e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97303518788341
cond(S) = 115553.15411756933
E1 = -727.4861540270199  E_coul = 203.0944939168395
init E= -524.39166011018
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.559510911224952  LUMO = 1.08614532776746
  mo_energy =
[-1.17897246e+02 -1.20895192e+01 -9.44944690e+00 -9.44944690e+00
 -9.44944690e+00 -1.22983287e+00 -5.59510911e-01 -5.59510911e-01
 -5.59510911e-01  1.08614533e+00  1.08614533e+00  1.08614533e+00
  8.39007895e+00  8.39007895e+00  8.39007895e+00  3.97402281e+01
  3.97402281e+01  3.97402281e+01  1.53682904e+02  1.53682904e+02
  1.53682904e+02  1.68603374e+02  5.28643566e+02  5.28643566e+02
  5.28643566e+02  1.38385638e+03  1.38385638e+03  1.38385638e+03
  1.81031552e+03  3.07479649e+03  3.07479649e+03  3.07479649e+03
  6.68993417e+03  6.68993417e+03  6.68993417e+03  8.02384445e+03
  2.43031796e+04  7.50628879e+04]
E1 = -727.3598245740772  E_coul = 201.77731498204753
cycle= 1 E= -525.58250959203  delta_E= -1.19  |g|= 0.197  |ddm|= 0.371
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.488444
diis-c [-0.23857735  1.        ]
  HOMO = -0.571882812075677  LUMO = 1.07882601435954
  mo_energy =
[-1.18146817e+02 -1.21774843e+01 -9.53752030e+00 -9.53752030e+00
 -9.53752030e+00 -1.25021022e+00 -5.71882812e-01 -5.71882812e-01
 -5.71882812e-01  1.07882601e+00  1.07882601e+00  1.07882601e+00
  8.33721404e+00  8.33721404e+00  8.33721404e+00  3.96366742e+01
  3.96366742e+01  3.96366742e+01  1.53511637e+02  1.53511637e+02
  1.53511637e+02  1.68413313e+02  5.28407375e+02  5.28407375e+02
  5.28407375e+02  1.38356829e+03  1.38356829e+03  1.38356829e+03
  1.80989692e+03  3.07444044e+03  3.07444044e+03  3.07444044e+03
  6.68944995e+03  6.68944995e+03  6.68944995e+03  8.02327080e+03
  2.43025041e+04  7.50621163e+04]
E1 = -727.5742646013321  E_coul = 201.9915489809436
cycle= 2 E= -525.582715620388  delta_E= -0.000206  |g|= 0.0163  |ddm|= 0.0147
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0328752
diis-c [-8.08426949e-04  3.27363451e-02  9.67263655e-01]
  HOMO = -0.569187370629459  LUMO = 1.08105244171778
  mo_energy =
[-1.18115518e+02 -1.21625051e+01 -9.52230354e+00 -9.52230354e+00
 -9.52230354e+00 -1.24659821e+00 -5.69187371e-01 -5.69187371e-01
 -5.69187371e-01  1.08105244e+00  1.08105244e+00  1.08105244e+00
  8.34613471e+00  8.34613471e+00  8.34613471e+00  3.96536982e+01
  3.96536982e+01  3.96536982e+01  1.53537117e+02  1.53537117e+02
  1.53537117e+02  1.68443035e+02  5.28438228e+02  5.28438228e+02
  5.28438228e+02  1.38360127e+03  1.38360127e+03  1.38360127e+03
  1.80993145e+03  3.07447456e+03  3.07447456e+03  3.07447456e+03
  6.68948468e+03  6.68948468e+03  6.68948468e+03  8.02330577e+03
  2.43025391e+04  7.50621511e+04]
E1 = -727.5302356108836  E_coul = 201.94751352568346
cycle= 3 E= -525.5827220852  delta_E= -6.46e-06  |g|= 0.0022  |ddm|= 0.00379
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00467712
diis-c [-1.01639010e-07 -8.21742128e-04  1.19166618e-01  8.81655124e-01]
  HOMO = -0.569716627995649  LUMO = 1.08062948425387
  mo_energy =
[-1.18119679e+02 -1.21648103e+01 -9.52465909e+00 -9.52465909e+00
 -9.52465909e+00 -1.24729416e+00 -5.69716628e-01 -5.69716628e-01
 -5.69716628e-01  1.08062948e+00  1.08062948e+00  1.08062948e+00
  8.34461859e+00  8.34461859e+00  8.34461859e+00  3.96511565e+01
  3.96511565e+01  3.96511565e+01  1.53533611e+02  1.53533611e+02
  1.53533611e+02  1.68439109e+02  5.28434125e+02  5.28434125e+02
  5.28434125e+02  1.38359692e+03  1.38359692e+03  1.38359692e+03
  1.80992686e+03  3.07447004e+03  3.07447004e+03  3.07447004e+03
  6.68948002e+03  6.68948002e+03  6.68948002e+03  8.02330102e+03
  2.43025342e+04  7.50621463e+04]
E1 = -727.5367271348329  E_coul = 201.9540048759955
cycle= 4 E= -525.582722258837  delta_E= -1.74e-07  |g|= 3.94e-05  |ddm|= 0.00061
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.89383e-05
diis-c [-5.13478764e-10 -2.73565560e-05  3.33279849e-03  3.79710616e-02
  9.58723496e-01]
  HOMO = -0.569693445140669  LUMO = 1.08064752064254
  mo_energy =
[-1.18119589e+02 -1.21647348e+01 -9.52458294e+00 -9.52458294e+00
 -9.52458294e+00 -1.24726402e+00 -5.69693445e-01 -5.69693445e-01
 -5.69693445e-01  1.08064752e+00  1.08064752e+00  1.08064752e+00
  8.34467528e+00  8.34467528e+00  8.34467528e+00  3.96512329e+01
  3.96512329e+01  3.96512329e+01  1.53533697e+02  1.53533697e+02
  1.53533697e+02  1.68439199e+02  5.28434215e+02  5.28434215e+02
  5.28434215e+02  1.38359701e+03  1.38359701e+03  1.38359701e+03
  1.80992695e+03  3.07447013e+03  3.07447013e+03  3.07447013e+03
  6.68948011e+03  6.68948011e+03  6.68948011e+03  8.02330110e+03
  2.43025343e+04  7.50621464e+04]
E1 = -727.5365398913821  E_coul = 201.9538176324139
cycle= 5 E= -525.582722258968  delta_E= -1.31e-10  |g|= 2.82e-06  |ddm|= 2.09e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5365398913821  E_coul = 201.9538176324139
  HOMO = -0.569694959614249  LUMO = 1.08064634134565
  mo_energy =
[-1.18119596e+02 -1.21647401e+01 -9.52458834e+00 -9.52458834e+00
 -9.52458834e+00 -1.24726600e+00 -5.69694960e-01 -5.69694960e-01
 -5.69694960e-01  1.08064634e+00  1.08064634e+00  1.08064634e+00
  8.34467144e+00  8.34467144e+00  8.34467144e+00  3.96512274e+01
  3.96512274e+01  3.96512274e+01  1.53533691e+02  1.53533691e+02
  1.53533691e+02  1.68439192e+02  5.28434207e+02  5.28434207e+02
  5.28434207e+02  1.38359700e+03  1.38359700e+03  1.38359700e+03
  1.80992694e+03  3.07447013e+03  3.07447013e+03  3.07447013e+03
  6.68948010e+03  6.68948010e+03  6.68948010e+03  8.02330110e+03
  2.43025343e+04  7.50621464e+04]
E1 = -727.5365536736026  E_coul = 201.95383141463256
Extra cycle  E= -525.58272225897  delta_E= -1.93e-12  |g|= 6.94e-07  |ddm|= 1.48e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
exp = [2.61827603e+04 7.61549196e+03 3.61277604e+03 1.53277112e+03
 2.23966554e+02 5.00232306e+01 4.60370309e+00 3.97616709e-01
 1.36282621e+03 6.64423060e+02 2.99552363e+02 3.12854472e+02
 7.26576315e+01 8.41215499e+00 2.37249901e+01 8.07556958e-01
 3.13270116e+00 2.29764547e-01]
E = -525.5827222589701
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7602669        1
[INPUT] 0    0    [1    /1   ]  7615.49195579        1
[INPUT] 0    0    [1    /1   ]  3612.77604012        1
[INPUT] 0    0    [1    /1   ]  1532.77112097        1
[INPUT] 0    0    [1    /1   ]  223.966553986        1
[INPUT] 0    0    [1    /1   ]  50.0232306146        1
[INPUT] 0    0    [1    /1   ]  4.60370309221        1
[INPUT] 0    0    [1    /1   ]  0.397616709313       1
[INPUT] 1    0    [1    /1   ]  1362.82620853        1
[INPUT] 1    0    [1    /1   ]  664.42306016         1
[INPUT] 1    0    [1    /1   ]  299.55236332         1
[INPUT] 1    0    [1    /1   ]  312.854472153        1
[INPUT] 1    0    [1    /1   ]  72.657631537         1
[INPUT] 1    0    [1    /1   ]  8.41215499237        1
[INPUT] 1    0    [1    /1   ]  23.724990125         1
[INPUT] 1    0    [1    /1   ]  0.807556957604       1
[INPUT] 1    0    [1    /1   ]  3.13270116035        1
[INPUT] 1    0    [1    /1   ]  0.229764547285       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.760266911566, 1.0]], [0, [7615.491955787286, 1.0]], [0, [3612.7760401239066, 1.0]], [0, [1532.771120969562, 1.0]], [0, [223.96655398644504, 1.0]], [0, [50.0232306146353, 1.0]], [0, [4.603703092205439, 1.0]], [0, [0.3976167093133533, 1.0]], [1, [1362.8262085349643, 1.0]], [1, [664.4230601604045, 1.0]], [1, [299.55236332018603, 1.0]], [1, [312.8544721529298, 1.0]], [1, [72.65763153703988, 1.0]], [1, [8.412154992371871, 1.0]], [1, [23.724990124954992, 1.0]], [1, [0.8075569576042795, 1.0]], [1, [3.132701160346187, 1.0]], [1, [0.2297645472850948, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.76026691]
bas 1, expnt(s) = [7615.49195579]
bas 2, expnt(s) = [3612.77604012]
bas 3, expnt(s) = [1532.77112097]
bas 4, expnt(s) = [223.96655399]
bas 5, expnt(s) = [50.02323061]
bas 6, expnt(s) = [4.60370309]
bas 7, expnt(s) = [0.39761671]
bas 8, expnt(s) = [1362.82620853]
bas 9, expnt(s) = [664.42306016]
bas 10, expnt(s) = [299.55236332]
bas 11, expnt(s) = [312.85447215]
bas 12, expnt(s) = [72.65763154]
bas 13, expnt(s) = [8.41215499]
bas 14, expnt(s) = [23.72499012]
bas 15, expnt(s) = [0.80755696]
bas 16, expnt(s) = [3.13270116]
bas 17, expnt(s) = [0.22976455]
CPU time:       436.99
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827603e+04 5.20027842e+03 7.61549196e+03 2.05962662e+03
 3.61277604e+03 1.17732348e+03 1.53277112e+03 6.18903596e+02
 2.23966554e+02 1.46269036e+02 5.00232306e+01 4.75219033e+01
 4.60370309e+00 7.94045711e+00 3.97616709e-01 1.26506690e+00
 1.36282621e+03 2.41565544e+04 6.64423060e+02 9.84102339e+03
 2.99552363e+02 3.63559360e+03 3.12854472e+02 3.83850713e+03
 7.26576315e+01 6.18850774e+02 8.41215499e+00 4.17944366e+01
 2.37249901e+01 1.52753772e+02 8.07556958e-01 2.23331944e+00
 3.13270116e+00 1.21585869e+01 2.29764547e-01 4.64074991e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97303518788341
cond(S) = 115553.15411756933
E1 = -727.4861540270199  E_coul = 203.0944939168395
init E= -524.39166011018
    CPU time for initialize scf      0.15 sec, wall time      0.04 sec
  HOMO = -0.559510911224952  LUMO = 1.08614532776746
  mo_energy =
[-1.17897246e+02 -1.20895192e+01 -9.44944690e+00 -9.44944690e+00
 -9.44944690e+00 -1.22983287e+00 -5.59510911e-01 -5.59510911e-01
 -5.59510911e-01  1.08614533e+00  1.08614533e+00  1.08614533e+00
  8.39007895e+00  8.39007895e+00  8.39007895e+00  3.97402281e+01
  3.97402281e+01  3.97402281e+01  1.53682904e+02  1.53682904e+02
  1.53682904e+02  1.68603374e+02  5.28643566e+02  5.28643566e+02
  5.28643566e+02  1.38385638e+03  1.38385638e+03  1.38385638e+03
  1.81031552e+03  3.07479649e+03  3.07479649e+03  3.07479649e+03
  6.68993417e+03  6.68993417e+03  6.68993417e+03  8.02384445e+03
  2.43031796e+04  7.50628879e+04]
E1 = -727.3598245740772  E_coul = 201.77731498204753
cycle= 1 E= -525.58250959203  delta_E= -1.19  |g|= 0.197  |ddm|= 0.371
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.488444
diis-c [-0.23857735  1.        ]
  HOMO = -0.571882812075677  LUMO = 1.07882601435954
  mo_energy =
[-1.18146817e+02 -1.21774843e+01 -9.53752030e+00 -9.53752030e+00
 -9.53752030e+00 -1.25021022e+00 -5.71882812e-01 -5.71882812e-01
 -5.71882812e-01  1.07882601e+00  1.07882601e+00  1.07882601e+00
  8.33721404e+00  8.33721404e+00  8.33721404e+00  3.96366742e+01
  3.96366742e+01  3.96366742e+01  1.53511637e+02  1.53511637e+02
  1.53511637e+02  1.68413313e+02  5.28407375e+02  5.28407375e+02
  5.28407375e+02  1.38356829e+03  1.38356829e+03  1.38356829e+03
  1.80989692e+03  3.07444044e+03  3.07444044e+03  3.07444044e+03
  6.68944995e+03  6.68944995e+03  6.68944995e+03  8.02327080e+03
  2.43025041e+04  7.50621163e+04]
E1 = -727.5742646013321  E_coul = 201.9915489809436
cycle= 2 E= -525.582715620388  delta_E= -0.000206  |g|= 0.0163  |ddm|= 0.0147
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0328752
diis-c [-8.08426949e-04  3.27363451e-02  9.67263655e-01]
  HOMO = -0.569187370629459  LUMO = 1.08105244171778
  mo_energy =
[-1.18115518e+02 -1.21625051e+01 -9.52230354e+00 -9.52230354e+00
 -9.52230354e+00 -1.24659821e+00 -5.69187371e-01 -5.69187371e-01
 -5.69187371e-01  1.08105244e+00  1.08105244e+00  1.08105244e+00
  8.34613471e+00  8.34613471e+00  8.34613471e+00  3.96536982e+01
  3.96536982e+01  3.96536982e+01  1.53537117e+02  1.53537117e+02
  1.53537117e+02  1.68443035e+02  5.28438228e+02  5.28438228e+02
  5.28438228e+02  1.38360127e+03  1.38360127e+03  1.38360127e+03
  1.80993145e+03  3.07447456e+03  3.07447456e+03  3.07447456e+03
  6.68948468e+03  6.68948468e+03  6.68948468e+03  8.02330577e+03
  2.43025391e+04  7.50621511e+04]
E1 = -727.5302356108836  E_coul = 201.94751352568346
cycle= 3 E= -525.5827220852  delta_E= -6.46e-06  |g|= 0.0022  |ddm|= 0.00379
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00467712
diis-c [-1.01639010e-07 -8.21742128e-04  1.19166618e-01  8.81655124e-01]
  HOMO = -0.569716627995649  LUMO = 1.08062948425387
  mo_energy =
[-1.18119679e+02 -1.21648103e+01 -9.52465909e+00 -9.52465909e+00
 -9.52465909e+00 -1.24729416e+00 -5.69716628e-01 -5.69716628e-01
 -5.69716628e-01  1.08062948e+00  1.08062948e+00  1.08062948e+00
  8.34461859e+00  8.34461859e+00  8.34461859e+00  3.96511565e+01
  3.96511565e+01  3.96511565e+01  1.53533611e+02  1.53533611e+02
  1.53533611e+02  1.68439109e+02  5.28434125e+02  5.28434125e+02
  5.28434125e+02  1.38359692e+03  1.38359692e+03  1.38359692e+03
  1.80992686e+03  3.07447004e+03  3.07447004e+03  3.07447004e+03
  6.68948002e+03  6.68948002e+03  6.68948002e+03  8.02330102e+03
  2.43025342e+04  7.50621463e+04]
E1 = -727.5367271348329  E_coul = 201.9540048759955
cycle= 4 E= -525.582722258837  delta_E= -1.74e-07  |g|= 3.94e-05  |ddm|= 0.00061
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.89383e-05
diis-c [-5.13478764e-10 -2.73565560e-05  3.33279849e-03  3.79710616e-02
  9.58723496e-01]
  HOMO = -0.569693445140669  LUMO = 1.08064752064254
  mo_energy =
[-1.18119589e+02 -1.21647348e+01 -9.52458294e+00 -9.52458294e+00
 -9.52458294e+00 -1.24726402e+00 -5.69693445e-01 -5.69693445e-01
 -5.69693445e-01  1.08064752e+00  1.08064752e+00  1.08064752e+00
  8.34467528e+00  8.34467528e+00  8.34467528e+00  3.96512329e+01
  3.96512329e+01  3.96512329e+01  1.53533697e+02  1.53533697e+02
  1.53533697e+02  1.68439199e+02  5.28434215e+02  5.28434215e+02
  5.28434215e+02  1.38359701e+03  1.38359701e+03  1.38359701e+03
  1.80992695e+03  3.07447013e+03  3.07447013e+03  3.07447013e+03
  6.68948011e+03  6.68948011e+03  6.68948011e+03  8.02330110e+03
  2.43025343e+04  7.50621464e+04]
E1 = -727.5365398913821  E_coul = 201.9538176324139
cycle= 5 E= -525.582722258968  delta_E= -1.31e-10  |g|= 2.82e-06  |ddm|= 2.09e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5365398913821  E_coul = 201.9538176324139
  HOMO = -0.569694959614249  LUMO = 1.08064634134565
  mo_energy =
[-1.18119596e+02 -1.21647401e+01 -9.52458834e+00 -9.52458834e+00
 -9.52458834e+00 -1.24726600e+00 -5.69694960e-01 -5.69694960e-01
 -5.69694960e-01  1.08064634e+00  1.08064634e+00  1.08064634e+00
  8.34467144e+00  8.34467144e+00  8.34467144e+00  3.96512274e+01
  3.96512274e+01  3.96512274e+01  1.53533691e+02  1.53533691e+02
  1.53533691e+02  1.68439192e+02  5.28434207e+02  5.28434207e+02
  5.28434207e+02  1.38359700e+03  1.38359700e+03  1.38359700e+03
  1.80992694e+03  3.07447013e+03  3.07447013e+03  3.07447013e+03
  6.68948010e+03  6.68948010e+03  6.68948010e+03  8.02330110e+03
  2.43025343e+04  7.50621464e+04]
E1 = -727.5365536736026  E_coul = 201.95383141463256
Extra cycle  E= -525.58272225897  delta_E= -1.93e-12  |g|= 6.94e-07  |ddm|= 1.48e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.24 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 115553.15411756933
E1 = -727.5365536736026  E_coul = 201.95383141463256
init E= -525.58272225897
    CPU time for initialize scf      1.27 sec, wall time      0.22 sec
  HOMO = -0.569694698914712  LUMO = 1.08064654755877
  mo_energy =
[-1.18119595e+02 -1.21647391e+01 -9.52458730e+00 -9.52458730e+00
 -9.52458730e+00 -1.24726566e+00 -5.69694699e-01 -5.69694699e-01
 -5.69694699e-01  1.08064655e+00  1.08064655e+00  1.08064655e+00
  8.34467214e+00  8.34467214e+00  8.34467214e+00  3.96512285e+01
  3.96512285e+01  3.96512285e+01  1.53533692e+02  1.53533692e+02
  1.53533692e+02  1.68439193e+02  5.28434209e+02  5.28434209e+02
  5.28434209e+02  1.38359700e+03  1.38359700e+03  1.38359700e+03
  1.80992694e+03  3.07447013e+03  3.07447013e+03  3.07447013e+03
  6.68948010e+03  6.68948010e+03  6.68948010e+03  8.02330110e+03
  2.43025343e+04  7.50621464e+04]
E1 = -727.5365509168166  E_coul = 201.95382865784782
cycle= 1 E= -525.582722258969  delta_E= 1.25e-12  |g|= 1.49e-07  |ddm|= 2.73e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.5365509168166  E_coul = 201.95382865784782
  HOMO = -0.569694748328865  LUMO = 1.08064650832163
  mo_energy =
[-1.18119595e+02 -1.21647393e+01 -9.52458751e+00 -9.52458751e+00
 -9.52458751e+00 -1.24726572e+00 -5.69694748e-01 -5.69694748e-01
 -5.69694748e-01  1.08064651e+00  1.08064651e+00  1.08064651e+00
  8.34467200e+00  8.34467200e+00  8.34467200e+00  3.96512282e+01
  3.96512282e+01  3.96512282e+01  1.53533692e+02  1.53533692e+02
  1.53533692e+02  1.68439193e+02  5.28434209e+02  5.28434209e+02
  5.28434209e+02  1.38359700e+03  1.38359700e+03  1.38359700e+03
  1.80992694e+03  3.07447013e+03  3.07447013e+03  3.07447013e+03
  6.68948010e+03  6.68948010e+03  6.68948010e+03  8.02330110e+03
  2.43025343e+04  7.50621464e+04]
E1 = -727.536551474623  E_coul = 201.95382921565363
Extra cycle  E= -525.582722258969  delta_E= -5.68e-13  |g|= 3.09e-08  |ddm|= 5.42e-08
    CPU time for scf_cycle      1.40 sec, wall time      0.35 sec
exp = [2.61827603e+04 7.61549196e+03 3.61277604e+03 1.53277112e+03
 2.23966554e+02 5.00232306e+01 4.60370309e+00 3.97616709e-01
 1.36282621e+03 6.64423060e+02 2.99552363e+02 3.12854472e+02
 7.26576315e+01 8.41215499e+00 2.37249901e+01 8.07556958e-01
 3.13270116e+00 2.29764547e-01]
grad_E = [-1.99041967e-06  2.54288395e-05  5.13690430e-05  9.40724948e-04
 -4.38915545e-03 -8.49465519e-04 -9.94199750e-07 -2.84301849e-04
 -6.41521431e-07  9.27549592e-07  2.37701123e-06  2.03165763e-06
  3.30791739e-04  1.87115132e-03 -1.41746783e-04 -1.40647990e-03
 -2.78614990e-03  3.08350931e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7617844        1
[INPUT] 0    0    [1    /1   ]  7615.47530872        1
[INPUT] 0    0    [1    /1   ]  3612.74291401        1
[INPUT] 0    0    [1    /1   ]  1532.25582383        1
[INPUT] 0    0    [1    /1   ]  223.903487782        1
[INPUT] 0    0    [1    /1   ]  50.0216812862        1
[INPUT] 0    0    [1    /1   ]  4.60364784979        1
[INPUT] 0    0    [1    /1   ]  0.3976181784         1
[INPUT] 1    0    [1    /1   ]  1362.82609124        1
[INPUT] 1    0    [1    /1   ]  664.415833182        1
[INPUT] 1    0    [1    /1   ]  299.514548664        1
[INPUT] 1    0    [1    /1   ]  312.821286369        1
[INPUT] 1    0    [1    /1   ]  73.147485674         1
[INPUT] 1    0    [1    /1   ]  8.38779403785        1
[INPUT] 1    0    [1    /1   ]  23.7776399329        1
[INPUT] 1    0    [1    /1   ]  0.808347173206       1
[INPUT] 1    0    [1    /1   ]  3.12976445517        1
[INPUT] 1    0    [1    /1   ]  0.229949550468       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.761784394123, 1.0]], [0, [7615.475308724938, 1.0]], [0, [3612.742914012956, 1.0]], [0, [1532.2558238282322, 1.0]], [0, [223.90348778187484, 1.0]], [0, [50.02168128616056, 1.0]], [0, [4.6036478497857605, 1.0]], [0, [0.39761817839972396, 1.0]], [1, [1362.8260912409, 1.0]], [1, [664.4158331817196, 1.0]], [1, [299.51454866390924, 1.0]], [1, [312.8212863694902, 1.0]], [1, [73.14748567395513, 1.0]], [1, [8.387794037851563, 1.0]], [1, [23.777639932925638, 1.0]], [1, [0.8083471732057186, 1.0]], [1, [3.1297644551660175, 1.0]], [1, [0.22994955046847843, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.76178439]
bas 1, expnt(s) = [7615.47530872]
bas 2, expnt(s) = [3612.74291401]
bas 3, expnt(s) = [1532.25582383]
bas 4, expnt(s) = [223.90348778]
bas 5, expnt(s) = [50.02168129]
bas 6, expnt(s) = [4.60364785]
bas 7, expnt(s) = [0.39761818]
bas 8, expnt(s) = [1362.82609124]
bas 9, expnt(s) = [664.41583318]
bas 10, expnt(s) = [299.51454866]
bas 11, expnt(s) = [312.82128637]
bas 12, expnt(s) = [73.14748567]
bas 13, expnt(s) = [8.38779404]
bas 14, expnt(s) = [23.77763993]
bas 15, expnt(s) = [0.80834717]
bas 16, expnt(s) = [3.12976446]
bas 17, expnt(s) = [0.22994955]
CPU time:       443.26
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827618e+04 5.20027865e+03 7.61547531e+03 2.05962325e+03
 3.61274291e+03 1.17731538e+03 1.53225582e+03 6.18747539e+02
 2.23903488e+02 1.46238145e+02 5.00216813e+01 4.75207994e+01
 4.60364785e+00 7.94038565e+00 3.97618178e-01 1.26507041e+00
 1.36282609e+03 2.41565518e+04 6.64415833e+02 9.84088959e+03
 2.99514549e+02 3.63501993e+03 3.12821286e+02 3.83799818e+03
 7.31474857e+01 6.24070488e+02 8.38779404e+00 4.16431995e+01
 2.37776399e+01 1.53177623e+02 8.08347173e-01 2.23605148e+00
 3.12976446e+00 1.21443412e+01 2.29949550e-01 4.64542121e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973004196944594
cond(S) = 116221.84938320435
E1 = -727.4852488564585  E_coul = 203.094624872018
init E= -524.39062398444
    CPU time for initialize scf      0.68 sec, wall time      0.08 sec
  HOMO = -0.559522851364006  LUMO = 1.08762387551508
  mo_energy =
[-1.17897273e+02 -1.20895694e+01 -9.44939872e+00 -9.44939872e+00
 -9.44939872e+00 -1.22982218e+00 -5.59522851e-01 -5.59522851e-01
 -5.59522851e-01  1.08762388e+00  1.08762388e+00  1.08762388e+00
  8.38117246e+00  8.38117246e+00  8.38117246e+00  3.97118400e+01
  3.97118400e+01  3.97118400e+01  1.54172278e+02  1.54172278e+02
  1.54172278e+02  1.68563049e+02  5.30009180e+02  5.30009180e+02
  5.30009180e+02  1.38549663e+03  1.38549663e+03  1.38549663e+03
  1.80981495e+03  3.07640900e+03  3.07640900e+03  3.07640900e+03
  6.69140093e+03  6.69140093e+03  6.69140093e+03  8.02247341e+03
  2.43011591e+04  7.50606469e+04]
E1 = -727.3630693480712  E_coul = 201.78050618309632
cycle= 1 E= -525.582563164975  delta_E= -1.19  |g|= 0.197  |ddm|= 0.36
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.488497
diis-c [-0.23862952  1.        ]
  HOMO = -0.571874392155274  LUMO = 1.08030701137388
  mo_energy =
[-1.18146508e+02 -1.21772632e+01 -9.53719817e+00 -9.53719817e+00
 -9.53719817e+00 -1.25016228e+00 -5.71874392e-01 -5.71874392e-01
 -5.71874392e-01  1.08030701e+00  1.08030701e+00  1.08030701e+00
  8.32854683e+00  8.32854683e+00  8.32854683e+00  3.96085072e+01
  3.96085072e+01  3.96085072e+01  1.54000999e+02  1.54000999e+02
  1.54000999e+02  1.68373318e+02  5.29773268e+02  5.29773268e+02
  5.29773268e+02  1.38520897e+03  1.38520897e+03  1.38520897e+03
  1.80939687e+03  3.07605343e+03  3.07605343e+03  3.07605343e+03
  6.69091722e+03  6.69091722e+03  6.69091722e+03  8.02190028e+03
  2.43004841e+04  7.50598758e+04]
E1 = -727.5770251384071  E_coul = 201.99425621020794
cycle= 2 E= -525.582768928199  delta_E= -0.000206  |g|= 0.0163  |ddm|= 0.0146
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.032837
diis-c [-8.07136643e-04  3.26618959e-02  9.67338104e-01]
  HOMO = -0.569192006580164  LUMO = 1.08252603510597
  mo_energy =
[-1.18115253e+02 -1.21623156e+01 -9.52201334e+00 -9.52201334e+00
 -9.52201334e+00 -1.24656681e+00 -5.69192007e-01 -5.69192007e-01
 -5.69192007e-01  1.08252604e+00  1.08252604e+00  1.08252604e+00
  8.33743124e+00  8.33743124e+00  8.33743124e+00  3.96255070e+01
  3.96255070e+01  3.96255070e+01  1.54026476e+02  1.54026476e+02
  1.54026476e+02  1.68402997e+02  5.29804084e+02  5.29804084e+02
  5.29804084e+02  1.38524191e+03  1.38524191e+03  1.38524191e+03
  1.80943136e+03  3.07608750e+03  3.07608750e+03  3.07608750e+03
  6.69095191e+03  6.69095191e+03  6.69095191e+03  8.02193520e+03
  2.43005190e+04  7.50599106e+04]
E1 = -727.5330769841344  E_coul = 201.9503016135821
cycle= 3 E= -525.582775370552  delta_E= -6.44e-06  |g|= 0.0022  |ddm|= 0.00378
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00467023
diis-c [-1.02128512e-07 -8.20701438e-04  1.19135505e-01  8.81685197e-01]
  HOMO = -0.569720633064281  LUMO = 1.08210307808564
  mo_energy =
[-1.18119410e+02 -1.21646179e+01 -9.52436594e+00 -9.52436594e+00
 -9.52436594e+00 -1.24726192e+00 -5.69720633e-01 -5.69720633e-01
 -5.69720633e-01  1.08210308e+00  1.08210308e+00  1.08210308e+00
  8.33591840e+00  8.33591840e+00  8.33591840e+00  3.96229676e+01
  3.96229676e+01  3.96229676e+01  1.54022970e+02  1.54022970e+02
  1.54022970e+02  1.68399076e+02  5.29799985e+02  5.29799985e+02
  5.29799985e+02  1.38523756e+03  1.38523756e+03  1.38523756e+03
  1.80942677e+03  3.07608300e+03  3.07608300e+03  3.07608300e+03
  6.69094725e+03  6.69094725e+03  6.69094725e+03  8.02193046e+03
  2.43005142e+04  7.50599057e+04]
E1 = -727.5395628280656  E_coul = 201.95678728423005
cycle= 4 E= -525.582775543836  delta_E= -1.73e-07  |g|= 3.97e-05  |ddm|= 0.000609
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.94511e-05
diis-c [-5.16352362e-10 -2.73456280e-05  3.34239359e-03  3.81683901e-02
  9.58516562e-01]
  HOMO = -0.569697365288569  LUMO = 1.08212120322646
  mo_energy =
[-1.18119319e+02 -1.21645421e+01 -9.52428941e+00 -9.52428941e+00
 -9.52428941e+00 -1.24723167e+00 -5.69697365e-01 -5.69697365e-01
 -5.69697365e-01  1.08212120e+00  1.08212120e+00  1.08212120e+00
  8.33597531e+00  8.33597531e+00  8.33597531e+00  3.96230444e+01
  3.96230444e+01  3.96230444e+01  1.54023056e+02  1.54023056e+02
  1.54023056e+02  1.68399166e+02  5.29800075e+02  5.29800075e+02
  5.29800075e+02  1.38523765e+03  1.38523765e+03  1.38523765e+03
  1.80942686e+03  3.07608309e+03  3.07608309e+03  3.07608309e+03
  6.69094734e+03  6.69094734e+03  6.69094734e+03  8.02193055e+03
  2.43005143e+04  7.50599058e+04]
E1 = -727.5393745454654  E_coul = 201.95659900149704
cycle= 5 E= -525.582775543968  delta_E= -1.33e-10  |g|= 2.82e-06  |ddm|= 2.1e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5393745454654  E_coul = 201.95659900149704
  HOMO = -0.569698882138601  LUMO = 1.08212002074768
  mo_energy =
[-1.18119326e+02 -1.21645474e+01 -9.52429481e+00 -9.52429481e+00
 -9.52429481e+00 -1.24723365e+00 -5.69698882e-01 -5.69698882e-01
 -5.69698882e-01  1.08212002e+00  1.08212002e+00  1.08212002e+00
  8.33597146e+00  8.33597146e+00  8.33597146e+00  3.96230389e+01
  3.96230389e+01  3.96230389e+01  1.54023050e+02  1.54023050e+02
  1.54023050e+02  1.68399159e+02  5.29800068e+02  5.29800068e+02
  5.29800068e+02  1.38523764e+03  1.38523764e+03  1.38523764e+03
  1.80942685e+03  3.07608308e+03  3.07608308e+03  3.07608308e+03
  6.69094733e+03  6.69094733e+03  6.69094733e+03  8.02193054e+03
  2.43005143e+04  7.50599058e+04]
E1 = -727.5393883474579  E_coul = 201.95661280348787
Extra cycle  E= -525.58277554397  delta_E= -1.59e-12  |g|= 6.95e-07  |ddm|= 1.48e-06
    CPU time for scf_cycle      0.87 sec, wall time      0.27 sec
exp = [2.61827618e+04 7.61547531e+03 3.61274291e+03 1.53225582e+03
 2.23903488e+02 5.00216813e+01 4.60364785e+00 3.97618178e-01
 1.36282609e+03 6.64415833e+02 2.99514549e+02 3.12821286e+02
 7.31474857e+01 8.38779404e+00 2.37776399e+01 8.08347173e-01
 3.12976446e+00 2.29949550e-01]
E = -525.58277554397
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:26:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7617844        1
[INPUT] 0    0    [1    /1   ]  7615.47530872        1
[INPUT] 0    0    [1    /1   ]  3612.74291401        1
[INPUT] 0    0    [1    /1   ]  1532.25582383        1
[INPUT] 0    0    [1    /1   ]  223.903487782        1
[INPUT] 0    0    [1    /1   ]  50.0216812862        1
[INPUT] 0    0    [1    /1   ]  4.60364784979        1
[INPUT] 0    0    [1    /1   ]  0.3976181784         1
[INPUT] 1    0    [1    /1   ]  1362.82609124        1
[INPUT] 1    0    [1    /1   ]  664.415833182        1
[INPUT] 1    0    [1    /1   ]  299.514548664        1
[INPUT] 1    0    [1    /1   ]  312.821286369        1
[INPUT] 1    0    [1    /1   ]  73.147485674         1
[INPUT] 1    0    [1    /1   ]  8.38779403785        1
[INPUT] 1    0    [1    /1   ]  23.7776399329        1
[INPUT] 1    0    [1    /1   ]  0.808347173206       1
[INPUT] 1    0    [1    /1   ]  3.12976445517        1
[INPUT] 1    0    [1    /1   ]  0.229949550468       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.761784394123, 1.0]], [0, [7615.475308724938, 1.0]], [0, [3612.742914012956, 1.0]], [0, [1532.2558238282322, 1.0]], [0, [223.90348778187484, 1.0]], [0, [50.02168128616056, 1.0]], [0, [4.6036478497857605, 1.0]], [0, [0.39761817839972396, 1.0]], [1, [1362.8260912409, 1.0]], [1, [664.4158331817196, 1.0]], [1, [299.51454866390924, 1.0]], [1, [312.8212863694902, 1.0]], [1, [73.14748567395513, 1.0]], [1, [8.387794037851563, 1.0]], [1, [23.777639932925638, 1.0]], [1, [0.8083471732057186, 1.0]], [1, [3.1297644551660175, 1.0]], [1, [0.22994955046847843, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.76178439]
bas 1, expnt(s) = [7615.47530872]
bas 2, expnt(s) = [3612.74291401]
bas 3, expnt(s) = [1532.25582383]
bas 4, expnt(s) = [223.90348778]
bas 5, expnt(s) = [50.02168129]
bas 6, expnt(s) = [4.60364785]
bas 7, expnt(s) = [0.39761818]
bas 8, expnt(s) = [1362.82609124]
bas 9, expnt(s) = [664.41583318]
bas 10, expnt(s) = [299.51454866]
bas 11, expnt(s) = [312.82128637]
bas 12, expnt(s) = [73.14748567]
bas 13, expnt(s) = [8.38779404]
bas 14, expnt(s) = [23.77763993]
bas 15, expnt(s) = [0.80834717]
bas 16, expnt(s) = [3.12976446]
bas 17, expnt(s) = [0.22994955]
CPU time:       444.38
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827618e+04 5.20027865e+03 7.61547531e+03 2.05962325e+03
 3.61274291e+03 1.17731538e+03 1.53225582e+03 6.18747539e+02
 2.23903488e+02 1.46238145e+02 5.00216813e+01 4.75207994e+01
 4.60364785e+00 7.94038565e+00 3.97618178e-01 1.26507041e+00
 1.36282609e+03 2.41565518e+04 6.64415833e+02 9.84088959e+03
 2.99514549e+02 3.63501993e+03 3.12821286e+02 3.83799818e+03
 7.31474857e+01 6.24070488e+02 8.38779404e+00 4.16431995e+01
 2.37776399e+01 1.53177623e+02 8.08347173e-01 2.23605148e+00
 3.12976446e+00 1.21443412e+01 2.29949550e-01 4.64542121e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973004196944594
cond(S) = 116221.84938320435
E1 = -727.4852488564585  E_coul = 203.094624872018
init E= -524.39062398444
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.559522851364006  LUMO = 1.08762387551508
  mo_energy =
[-1.17897273e+02 -1.20895694e+01 -9.44939872e+00 -9.44939872e+00
 -9.44939872e+00 -1.22982218e+00 -5.59522851e-01 -5.59522851e-01
 -5.59522851e-01  1.08762388e+00  1.08762388e+00  1.08762388e+00
  8.38117246e+00  8.38117246e+00  8.38117246e+00  3.97118400e+01
  3.97118400e+01  3.97118400e+01  1.54172278e+02  1.54172278e+02
  1.54172278e+02  1.68563049e+02  5.30009180e+02  5.30009180e+02
  5.30009180e+02  1.38549663e+03  1.38549663e+03  1.38549663e+03
  1.80981495e+03  3.07640900e+03  3.07640900e+03  3.07640900e+03
  6.69140093e+03  6.69140093e+03  6.69140093e+03  8.02247341e+03
  2.43011591e+04  7.50606469e+04]
E1 = -727.3630693480712  E_coul = 201.78050618309632
cycle= 1 E= -525.582563164975  delta_E= -1.19  |g|= 0.197  |ddm|= 0.36
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.488497
diis-c [-0.23862952  1.        ]
  HOMO = -0.571874392155274  LUMO = 1.08030701137388
  mo_energy =
[-1.18146508e+02 -1.21772632e+01 -9.53719817e+00 -9.53719817e+00
 -9.53719817e+00 -1.25016228e+00 -5.71874392e-01 -5.71874392e-01
 -5.71874392e-01  1.08030701e+00  1.08030701e+00  1.08030701e+00
  8.32854683e+00  8.32854683e+00  8.32854683e+00  3.96085072e+01
  3.96085072e+01  3.96085072e+01  1.54000999e+02  1.54000999e+02
  1.54000999e+02  1.68373318e+02  5.29773268e+02  5.29773268e+02
  5.29773268e+02  1.38520897e+03  1.38520897e+03  1.38520897e+03
  1.80939687e+03  3.07605343e+03  3.07605343e+03  3.07605343e+03
  6.69091722e+03  6.69091722e+03  6.69091722e+03  8.02190028e+03
  2.43004841e+04  7.50598758e+04]
E1 = -727.5770251384071  E_coul = 201.99425621020794
cycle= 2 E= -525.582768928199  delta_E= -0.000206  |g|= 0.0163  |ddm|= 0.0146
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.032837
diis-c [-8.07136643e-04  3.26618959e-02  9.67338104e-01]
  HOMO = -0.569192006580164  LUMO = 1.08252603510597
  mo_energy =
[-1.18115253e+02 -1.21623156e+01 -9.52201334e+00 -9.52201334e+00
 -9.52201334e+00 -1.24656681e+00 -5.69192007e-01 -5.69192007e-01
 -5.69192007e-01  1.08252604e+00  1.08252604e+00  1.08252604e+00
  8.33743124e+00  8.33743124e+00  8.33743124e+00  3.96255070e+01
  3.96255070e+01  3.96255070e+01  1.54026476e+02  1.54026476e+02
  1.54026476e+02  1.68402997e+02  5.29804084e+02  5.29804084e+02
  5.29804084e+02  1.38524191e+03  1.38524191e+03  1.38524191e+03
  1.80943136e+03  3.07608750e+03  3.07608750e+03  3.07608750e+03
  6.69095191e+03  6.69095191e+03  6.69095191e+03  8.02193520e+03
  2.43005190e+04  7.50599106e+04]
E1 = -727.5330769841344  E_coul = 201.9503016135821
cycle= 3 E= -525.582775370552  delta_E= -6.44e-06  |g|= 0.0022  |ddm|= 0.00378
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00467023
diis-c [-1.02128512e-07 -8.20701438e-04  1.19135505e-01  8.81685197e-01]
  HOMO = -0.569720633064281  LUMO = 1.08210307808564
  mo_energy =
[-1.18119410e+02 -1.21646179e+01 -9.52436594e+00 -9.52436594e+00
 -9.52436594e+00 -1.24726192e+00 -5.69720633e-01 -5.69720633e-01
 -5.69720633e-01  1.08210308e+00  1.08210308e+00  1.08210308e+00
  8.33591840e+00  8.33591840e+00  8.33591840e+00  3.96229676e+01
  3.96229676e+01  3.96229676e+01  1.54022970e+02  1.54022970e+02
  1.54022970e+02  1.68399076e+02  5.29799985e+02  5.29799985e+02
  5.29799985e+02  1.38523756e+03  1.38523756e+03  1.38523756e+03
  1.80942677e+03  3.07608300e+03  3.07608300e+03  3.07608300e+03
  6.69094725e+03  6.69094725e+03  6.69094725e+03  8.02193046e+03
  2.43005142e+04  7.50599057e+04]
E1 = -727.5395628280656  E_coul = 201.95678728423005
cycle= 4 E= -525.582775543836  delta_E= -1.73e-07  |g|= 3.97e-05  |ddm|= 0.000609
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.94511e-05
diis-c [-5.16352362e-10 -2.73456280e-05  3.34239359e-03  3.81683901e-02
  9.58516562e-01]
  HOMO = -0.569697365288569  LUMO = 1.08212120322646
  mo_energy =
[-1.18119319e+02 -1.21645421e+01 -9.52428941e+00 -9.52428941e+00
 -9.52428941e+00 -1.24723167e+00 -5.69697365e-01 -5.69697365e-01
 -5.69697365e-01  1.08212120e+00  1.08212120e+00  1.08212120e+00
  8.33597531e+00  8.33597531e+00  8.33597531e+00  3.96230444e+01
  3.96230444e+01  3.96230444e+01  1.54023056e+02  1.54023056e+02
  1.54023056e+02  1.68399166e+02  5.29800075e+02  5.29800075e+02
  5.29800075e+02  1.38523765e+03  1.38523765e+03  1.38523765e+03
  1.80942686e+03  3.07608309e+03  3.07608309e+03  3.07608309e+03
  6.69094734e+03  6.69094734e+03  6.69094734e+03  8.02193055e+03
  2.43005143e+04  7.50599058e+04]
E1 = -727.5393745454654  E_coul = 201.95659900149704
cycle= 5 E= -525.582775543968  delta_E= -1.33e-10  |g|= 2.82e-06  |ddm|= 2.1e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5393745454654  E_coul = 201.95659900149704
  HOMO = -0.569698882138601  LUMO = 1.08212002074768
  mo_energy =
[-1.18119326e+02 -1.21645474e+01 -9.52429481e+00 -9.52429481e+00
 -9.52429481e+00 -1.24723365e+00 -5.69698882e-01 -5.69698882e-01
 -5.69698882e-01  1.08212002e+00  1.08212002e+00  1.08212002e+00
  8.33597146e+00  8.33597146e+00  8.33597146e+00  3.96230389e+01
  3.96230389e+01  3.96230389e+01  1.54023050e+02  1.54023050e+02
  1.54023050e+02  1.68399159e+02  5.29800068e+02  5.29800068e+02
  5.29800068e+02  1.38523764e+03  1.38523764e+03  1.38523764e+03
  1.80942685e+03  3.07608308e+03  3.07608308e+03  3.07608308e+03
  6.69094733e+03  6.69094733e+03  6.69094733e+03  8.02193054e+03
  2.43005143e+04  7.50599058e+04]
E1 = -727.5393883474579  E_coul = 201.95661280348787
Extra cycle  E= -525.58277554397  delta_E= -1.59e-12  |g|= 6.95e-07  |ddm|= 1.48e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 116221.84938320435
E1 = -727.5393883474579  E_coul = 201.95661280348787
init E= -525.58277554397
    CPU time for initialize scf      0.96 sec, wall time      0.20 sec
  HOMO = -0.569698621061283  LUMO = 1.0821202275044
  mo_energy =
[-1.18119325e+02 -1.21645464e+01 -9.52429378e+00 -9.52429378e+00
 -9.52429378e+00 -1.24723331e+00 -5.69698621e-01 -5.69698621e-01
 -5.69698621e-01  1.08212023e+00  1.08212023e+00  1.08212023e+00
  8.33597216e+00  8.33597216e+00  8.33597216e+00  3.96230400e+01
  3.96230400e+01  3.96230400e+01  1.54023051e+02  1.54023051e+02
  1.54023051e+02  1.68399161e+02  5.29800069e+02  5.29800069e+02
  5.29800069e+02  1.38523764e+03  1.38523764e+03  1.38523764e+03
  1.80942685e+03  3.07608308e+03  3.07608308e+03  3.07608308e+03
  6.69094733e+03  6.69094733e+03  6.69094733e+03  8.02193054e+03
  2.43005143e+04  7.50599058e+04]
E1 = -727.5393855859705  E_coul = 201.95661004200042
cycle= 1 E= -525.58277554397  delta_E= -1.14e-13  |g|= 1.49e-07  |ddm|= 2.73e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.5393855859705  E_coul = 201.95661004200042
  HOMO = -0.569698670560596  LUMO = 1.08212018815289
  mo_energy =
[-1.18119325e+02 -1.21645466e+01 -9.52429398e+00 -9.52429398e+00
 -9.52429398e+00 -1.24723337e+00 -5.69698671e-01 -5.69698671e-01
 -5.69698671e-01  1.08212019e+00  1.08212019e+00  1.08212019e+00
  8.33597203e+00  8.33597203e+00  8.33597203e+00  3.96230398e+01
  3.96230398e+01  3.96230398e+01  1.54023051e+02  1.54023051e+02
  1.54023051e+02  1.68399160e+02  5.29800069e+02  5.29800069e+02
  5.29800069e+02  1.38523764e+03  1.38523764e+03  1.38523764e+03
  1.80942685e+03  3.07608308e+03  3.07608308e+03  3.07608308e+03
  6.69094733e+03  6.69094733e+03  6.69094733e+03  8.02193054e+03
  2.43005143e+04  7.50599058e+04]
E1 = -727.5393861448721  E_coul = 201.95661060090333
Extra cycle  E= -525.582775543969  delta_E= 1.36e-12  |g|= 3.1e-08  |ddm|= 5.43e-08
    CPU time for scf_cycle      1.08 sec, wall time      0.32 sec
exp = [2.61827618e+04 7.61547531e+03 3.61274291e+03 1.53225582e+03
 2.23903488e+02 5.00216813e+01 4.60364785e+00 3.97618178e-01
 1.36282609e+03 6.64415833e+02 2.99514549e+02 3.12821286e+02
 7.31474857e+01 8.38779404e+00 2.37776399e+01 8.08347173e-01
 3.12976446e+00 2.29949550e-01]
grad_E = [-1.99049934e-06  2.54420447e-05  5.13864649e-05  9.42274194e-04
 -4.43240764e-03 -6.70080650e-04 -3.78974487e-05 -6.66207328e-05
 -6.34939323e-07  8.46551312e-07  2.02903259e-06  1.74001155e-06
  3.17319435e-04 -7.26678906e-04  3.99180230e-04  6.90812086e-04
  4.40401127e-04  2.30762071e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7622923        1
[INPUT] 0    0    [1    /1   ]  7615.4696986         1
[INPUT] 0    0    [1    /1   ]  3612.73169531        1
[INPUT] 0    0    [1    /1   ]  1532.08240233        1
[INPUT] 0    0    [1    /1   ]  223.903664166        1
[INPUT] 0    0    [1    /1   ]  50.026365303         1
[INPUT] 0    0    [1    /1   ]  4.60362960279        1
[INPUT] 0    0    [1    /1   ]  0.397624521716       1
[INPUT] 1    0    [1    /1   ]  1362.82586614        1
[INPUT] 1    0    [1    /1   ]  664.411842798        1
[INPUT] 1    0    [1    /1   ]  299.492990085        1
[INPUT] 1    0    [1    /1   ]  312.802313137        1
[INPUT] 1    0    [1    /1   ]  73.4986644792        1
[INPUT] 1    0    [1    /1   ]  8.40508524378        1
[INPUT] 1    0    [1    /1   ]  23.8444677065        1
[INPUT] 1    0    [1    /1   ]  0.808915233306       1
[INPUT] 1    0    [1    /1   ]  3.13772299608        1
[INPUT] 1    0    [1    /1   ]  0.230004547243       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.76229226942, 1.0]], [0, [7615.4696986021645, 1.0]], [0, [3612.7316953105487, 1.0]], [0, [1532.0824023343557, 1.0]], [0, [223.90366416636138, 1.0]], [0, [50.026365302992815, 1.0]], [0, [4.603629602785356, 1.0]], [0, [0.3976245217155924, 1.0]], [1, [1362.825866141494, 1.0]], [1, [664.4118427976131, 1.0]], [1, [299.49299008473906, 1.0]], [1, [312.8023131369164, 1.0]], [1, [73.49866447917675, 1.0]], [1, [8.405085243783954, 1.0]], [1, [23.844467706491013, 1.0]], [1, [0.8089152333062086, 1.0]], [1, [3.137722996075895, 1.0]], [1, [0.23000454724287392, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.76229227]
bas 1, expnt(s) = [7615.4696986]
bas 2, expnt(s) = [3612.73169531]
bas 3, expnt(s) = [1532.08240233]
bas 4, expnt(s) = [223.90366417]
bas 5, expnt(s) = [50.0263653]
bas 6, expnt(s) = [4.6036296]
bas 7, expnt(s) = [0.39762452]
bas 8, expnt(s) = [1362.82586614]
bas 9, expnt(s) = [664.4118428]
bas 10, expnt(s) = [299.49299008]
bas 11, expnt(s) = [312.80231314]
bas 12, expnt(s) = [73.49866448]
bas 13, expnt(s) = [8.40508524]
bas 14, expnt(s) = [23.84446771]
bas 15, expnt(s) = [0.80891523]
bas 16, expnt(s) = [3.137723]
bas 17, expnt(s) = [0.23000455]
CPU time:       450.22
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827623e+04 5.20027872e+03 7.61546970e+03 2.05962211e+03
 3.61273170e+03 1.17731264e+03 1.53208240e+03 6.18695016e+02
 2.23903664e+02 1.46238231e+02 5.00263653e+01 4.75241367e+01
 4.60362960e+00 7.94036205e+00 3.97624522e-01 1.26508555e+00
 1.36282587e+03 2.41565468e+04 6.64411843e+02 9.84081571e+03
 2.99492990e+02 3.63469288e+03 3.12802313e+02 3.83770720e+03
 7.34986645e+01 6.27817912e+02 8.40508524e+00 4.17505351e+01
 2.38444677e+01 1.53715950e+02 8.08915233e-01 2.23801586e+00
 3.13772300e+00 1.21829551e+01 2.30004547e-01 4.64681005e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972983938512186
cond(S) = 116816.40295524464
E1 = -727.484946791008  E_coul = 203.09481265053242
init E= -524.390134140476
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.559518991245762  LUMO = 1.08841790128116
  mo_energy =
[-1.17897273e+02 -1.20896050e+01 -9.44936369e+00 -9.44936369e+00
 -9.44936369e+00 -1.22982567e+00 -5.59518991e-01 -5.59518991e-01
 -5.59518991e-01  1.08841790e+00  1.08841790e+00  1.08841790e+00
  8.40386840e+00  8.40386840e+00  8.40386840e+00  3.98320074e+01
  3.98320074e+01  3.98320074e+01  1.54754965e+02  1.54754965e+02
  1.54754965e+02  1.68575875e+02  5.31222633e+02  5.31222633e+02
  5.31222633e+02  1.38690309e+03  1.38690309e+03  1.38690309e+03
  1.80973110e+03  3.07779821e+03  3.07779821e+03  3.07779821e+03
  6.69267893e+03  6.69267893e+03  6.69267893e+03  8.02210525e+03
  2.43005707e+04  7.50599790e+04]
E1 = -727.3632368179566  E_coul = 201.78063791766888
cycle= 1 E= -525.582598900288  delta_E= -1.19  |g|= 0.197  |ddm|= 0.361
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.488446
diis-c [-0.23857982  1.        ]
  HOMO = -0.571893805450595  LUMO = 1.08107013550975
  mo_energy =
[-1.18146426e+02 -1.21773070e+01 -9.53716433e+00 -9.53716433e+00
 -9.53716433e+00 -1.25019627e+00 -5.71893805e-01 -5.71893805e-01
 -5.71893805e-01  1.08107014e+00  1.08107014e+00  1.08107014e+00
  8.35112228e+00  8.35112228e+00  8.35112228e+00  3.97285363e+01
  3.97285363e+01  3.97285363e+01  1.54583515e+02  1.54583515e+02
  1.54583515e+02  1.68386210e+02  5.30986785e+02  5.30986785e+02
  5.30986785e+02  1.38661558e+03  1.38661558e+03  1.38661558e+03
  1.80931326e+03  3.07744287e+03  3.07744287e+03  3.07744287e+03
  6.69219548e+03  6.69219548e+03  6.69219548e+03  8.02153241e+03
  2.42998961e+04  7.50592082e+04]
E1 = -727.5771663489791  E_coul = 201.99436181069677
cycle= 2 E= -525.582804538282  delta_E= -0.000206  |g|= 0.0163  |ddm|= 0.0146
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0328207
diis-c [-8.06679295e-04  3.26293228e-02  9.67370677e-01]
  HOMO = -0.569210797262851  LUMO = 1.08329208291612
  mo_energy =
[-1.18115179e+02 -1.21623601e+01 -9.52198023e+00 -9.52198023e+00
 -9.52198023e+00 -1.24659999e+00 -5.69210797e-01 -5.69210797e-01
 -5.69210797e-01  1.08329208e+00  1.08329208e+00  1.08329208e+00
  8.36002387e+00  8.36002387e+00  8.36002387e+00  3.97455573e+01
  3.97455573e+01  3.97455573e+01  1.54609011e+02  1.54609011e+02
  1.54609011e+02  1.68415882e+02  5.31017595e+02  5.31017595e+02
  5.31017595e+02  1.38664851e+03  1.38664851e+03  1.38664851e+03
  1.80934774e+03  3.07747693e+03  3.07747693e+03  3.07747693e+03
  6.69223016e+03  6.69223016e+03  6.69223016e+03  8.02156732e+03
  2.42999310e+04  7.50592430e+04]
E1 = -727.5332288384695  E_coul = 201.95041786160417
cycle= 3 E= -525.582810976865  delta_E= -6.44e-06  |g|= 0.0022  |ddm|= 0.00378
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00466869
diis-c [-1.01868731e-07 -8.19960533e-04  1.19160443e-01  8.81659518e-01]
  HOMO = -0.569739428267227  LUMO = 1.08286867510816
  mo_energy =
[-1.18119335e+02 -1.21646622e+01 -9.52433262e+00 -9.52433262e+00
 -9.52433262e+00 -1.24729512e+00 -5.69739428e-01 -5.69739428e-01
 -5.69739428e-01  1.08286868e+00  1.08286868e+00  1.08286868e+00
  8.35850877e+00  8.35850877e+00  8.35850877e+00  3.97430155e+01
  3.97430155e+01  3.97430155e+01  1.54605502e+02  1.54605502e+02
  1.54605502e+02  1.68411961e+02  5.31013496e+02  5.31013496e+02
  5.31013496e+02  1.38664416e+03  1.38664416e+03  1.38664416e+03
  1.80934315e+03  3.07747242e+03  3.07747242e+03  3.07747242e+03
  6.69222551e+03  6.69222551e+03  6.69222551e+03  8.02156258e+03
  2.42999262e+04  7.50592381e+04]
E1 = -727.5397140472064  E_coul = 201.9569028970814
cycle= 4 E= -525.582811150125  delta_E= -1.73e-07  |g|= 3.97e-05  |ddm|= 0.000609
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.94374e-05
diis-c [-5.15672157e-10 -2.72660527e-05  3.33976863e-03  3.81449454e-02
  9.58542552e-01]
  HOMO = -0.569716170544123  LUMO = 1.08288681114775
  mo_energy =
[-1.18119245e+02 -1.21645864e+01 -9.52425611e+00 -9.52425611e+00
 -9.52425611e+00 -1.24726489e+00 -5.69716171e-01 -5.69716171e-01
 -5.69716171e-01  1.08288681e+00  1.08288681e+00  1.08288681e+00
  8.35856572e+00  8.35856572e+00  8.35856572e+00  3.97430923e+01
  3.97430923e+01  3.97430923e+01  1.54605589e+02  1.54605589e+02
  1.54605589e+02  1.68412051e+02  5.31013586e+02  5.31013586e+02
  5.31013586e+02  1.38664425e+03  1.38664425e+03  1.38664425e+03
  1.80934324e+03  3.07747251e+03  3.07747251e+03  3.07747251e+03
  6.69222560e+03  6.69222560e+03  6.69222560e+03  8.02156267e+03
  2.42999262e+04  7.50592382e+04]
E1 = -727.5395258108973  E_coul = 201.95671466064033
cycle= 5 E= -525.582811150257  delta_E= -1.32e-10  |g|= 2.82e-06  |ddm|= 2.1e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5395258108973  E_coul = 201.95671466064033
  HOMO = -0.569717687199929  LUMO = 1.08288562762834
  mo_energy =
[-1.18119252e+02 -1.21645917e+01 -9.52426151e+00 -9.52426151e+00
 -9.52426151e+00 -1.24726687e+00 -5.69717687e-01 -5.69717687e-01
 -5.69717687e-01  1.08288563e+00  1.08288563e+00  1.08288563e+00
  8.35856187e+00  8.35856187e+00  8.35856187e+00  3.97430868e+01
  3.97430868e+01  3.97430868e+01  1.54605582e+02  1.54605582e+02
  1.54605582e+02  1.68412044e+02  5.31013579e+02  5.31013579e+02
  5.31013579e+02  1.38664425e+03  1.38664425e+03  1.38664425e+03
  1.80934323e+03  3.07747250e+03  3.07747250e+03  3.07747250e+03
  6.69222559e+03  6.69222559e+03  6.69222559e+03  8.02156266e+03
  2.42999262e+04  7.50592382e+04]
E1 = -727.5395396106817  E_coul = 201.95672846042427
Extra cycle  E= -525.582811150257  delta_E= -4.55e-13  |g|= 6.94e-07  |ddm|= 1.48e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
exp = [2.61827623e+04 7.61546970e+03 3.61273170e+03 1.53208240e+03
 2.23903664e+02 5.00263653e+01 4.60362960e+00 3.97624522e-01
 1.36282587e+03 6.64411843e+02 2.99492990e+02 3.12802313e+02
 7.34986645e+01 8.40508524e+00 2.38444677e+01 8.08915233e-01
 3.13772300e+00 2.30004547e-01]
E = -525.5828111502574
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7622923        1
[INPUT] 0    0    [1    /1   ]  7615.4696986         1
[INPUT] 0    0    [1    /1   ]  3612.73169531        1
[INPUT] 0    0    [1    /1   ]  1532.08240233        1
[INPUT] 0    0    [1    /1   ]  223.903664166        1
[INPUT] 0    0    [1    /1   ]  50.026365303         1
[INPUT] 0    0    [1    /1   ]  4.60362960279        1
[INPUT] 0    0    [1    /1   ]  0.397624521716       1
[INPUT] 1    0    [1    /1   ]  1362.82586614        1
[INPUT] 1    0    [1    /1   ]  664.411842798        1
[INPUT] 1    0    [1    /1   ]  299.492990085        1
[INPUT] 1    0    [1    /1   ]  312.802313137        1
[INPUT] 1    0    [1    /1   ]  73.4986644792        1
[INPUT] 1    0    [1    /1   ]  8.40508524378        1
[INPUT] 1    0    [1    /1   ]  23.8444677065        1
[INPUT] 1    0    [1    /1   ]  0.808915233306       1
[INPUT] 1    0    [1    /1   ]  3.13772299608        1
[INPUT] 1    0    [1    /1   ]  0.230004547243       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.76229226942, 1.0]], [0, [7615.4696986021645, 1.0]], [0, [3612.7316953105487, 1.0]], [0, [1532.0824023343557, 1.0]], [0, [223.90366416636138, 1.0]], [0, [50.026365302992815, 1.0]], [0, [4.603629602785356, 1.0]], [0, [0.3976245217155924, 1.0]], [1, [1362.825866141494, 1.0]], [1, [664.4118427976131, 1.0]], [1, [299.49299008473906, 1.0]], [1, [312.8023131369164, 1.0]], [1, [73.49866447917675, 1.0]], [1, [8.405085243783954, 1.0]], [1, [23.844467706491013, 1.0]], [1, [0.8089152333062086, 1.0]], [1, [3.137722996075895, 1.0]], [1, [0.23000454724287392, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.76229227]
bas 1, expnt(s) = [7615.4696986]
bas 2, expnt(s) = [3612.73169531]
bas 3, expnt(s) = [1532.08240233]
bas 4, expnt(s) = [223.90366417]
bas 5, expnt(s) = [50.0263653]
bas 6, expnt(s) = [4.6036296]
bas 7, expnt(s) = [0.39762452]
bas 8, expnt(s) = [1362.82586614]
bas 9, expnt(s) = [664.4118428]
bas 10, expnt(s) = [299.49299008]
bas 11, expnt(s) = [312.80231314]
bas 12, expnt(s) = [73.49866448]
bas 13, expnt(s) = [8.40508524]
bas 14, expnt(s) = [23.84446771]
bas 15, expnt(s) = [0.80891523]
bas 16, expnt(s) = [3.137723]
bas 17, expnt(s) = [0.23000455]
CPU time:       451.39
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827623e+04 5.20027872e+03 7.61546970e+03 2.05962211e+03
 3.61273170e+03 1.17731264e+03 1.53208240e+03 6.18695016e+02
 2.23903664e+02 1.46238231e+02 5.00263653e+01 4.75241367e+01
 4.60362960e+00 7.94036205e+00 3.97624522e-01 1.26508555e+00
 1.36282587e+03 2.41565468e+04 6.64411843e+02 9.84081571e+03
 2.99492990e+02 3.63469288e+03 3.12802313e+02 3.83770720e+03
 7.34986645e+01 6.27817912e+02 8.40508524e+00 4.17505351e+01
 2.38444677e+01 1.53715950e+02 8.08915233e-01 2.23801586e+00
 3.13772300e+00 1.21829551e+01 2.30004547e-01 4.64681005e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972983938512186
cond(S) = 116816.40295524464
E1 = -727.484946791008  E_coul = 203.09481265053242
init E= -524.390134140476
    CPU time for initialize scf      0.69 sec, wall time      0.08 sec
  HOMO = -0.559518991245762  LUMO = 1.08841790128116
  mo_energy =
[-1.17897273e+02 -1.20896050e+01 -9.44936369e+00 -9.44936369e+00
 -9.44936369e+00 -1.22982567e+00 -5.59518991e-01 -5.59518991e-01
 -5.59518991e-01  1.08841790e+00  1.08841790e+00  1.08841790e+00
  8.40386840e+00  8.40386840e+00  8.40386840e+00  3.98320074e+01
  3.98320074e+01  3.98320074e+01  1.54754965e+02  1.54754965e+02
  1.54754965e+02  1.68575875e+02  5.31222633e+02  5.31222633e+02
  5.31222633e+02  1.38690309e+03  1.38690309e+03  1.38690309e+03
  1.80973110e+03  3.07779821e+03  3.07779821e+03  3.07779821e+03
  6.69267893e+03  6.69267893e+03  6.69267893e+03  8.02210525e+03
  2.43005707e+04  7.50599790e+04]
E1 = -727.3632368179566  E_coul = 201.78063791766888
cycle= 1 E= -525.582598900288  delta_E= -1.19  |g|= 0.197  |ddm|= 0.361
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.488446
diis-c [-0.23857982  1.        ]
  HOMO = -0.571893805450595  LUMO = 1.08107013550975
  mo_energy =
[-1.18146426e+02 -1.21773070e+01 -9.53716433e+00 -9.53716433e+00
 -9.53716433e+00 -1.25019627e+00 -5.71893805e-01 -5.71893805e-01
 -5.71893805e-01  1.08107014e+00  1.08107014e+00  1.08107014e+00
  8.35112228e+00  8.35112228e+00  8.35112228e+00  3.97285363e+01
  3.97285363e+01  3.97285363e+01  1.54583515e+02  1.54583515e+02
  1.54583515e+02  1.68386210e+02  5.30986785e+02  5.30986785e+02
  5.30986785e+02  1.38661558e+03  1.38661558e+03  1.38661558e+03
  1.80931326e+03  3.07744287e+03  3.07744287e+03  3.07744287e+03
  6.69219548e+03  6.69219548e+03  6.69219548e+03  8.02153241e+03
  2.42998961e+04  7.50592082e+04]
E1 = -727.5771663489791  E_coul = 201.99436181069677
cycle= 2 E= -525.582804538282  delta_E= -0.000206  |g|= 0.0163  |ddm|= 0.0146
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0328207
diis-c [-8.06679295e-04  3.26293228e-02  9.67370677e-01]
  HOMO = -0.569210797262851  LUMO = 1.08329208291612
  mo_energy =
[-1.18115179e+02 -1.21623601e+01 -9.52198023e+00 -9.52198023e+00
 -9.52198023e+00 -1.24659999e+00 -5.69210797e-01 -5.69210797e-01
 -5.69210797e-01  1.08329208e+00  1.08329208e+00  1.08329208e+00
  8.36002387e+00  8.36002387e+00  8.36002387e+00  3.97455573e+01
  3.97455573e+01  3.97455573e+01  1.54609011e+02  1.54609011e+02
  1.54609011e+02  1.68415882e+02  5.31017595e+02  5.31017595e+02
  5.31017595e+02  1.38664851e+03  1.38664851e+03  1.38664851e+03
  1.80934774e+03  3.07747693e+03  3.07747693e+03  3.07747693e+03
  6.69223016e+03  6.69223016e+03  6.69223016e+03  8.02156732e+03
  2.42999310e+04  7.50592430e+04]
E1 = -727.5332288384695  E_coul = 201.95041786160417
cycle= 3 E= -525.582810976865  delta_E= -6.44e-06  |g|= 0.0022  |ddm|= 0.00378
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00466869
diis-c [-1.01868731e-07 -8.19960533e-04  1.19160443e-01  8.81659518e-01]
  HOMO = -0.569739428267227  LUMO = 1.08286867510816
  mo_energy =
[-1.18119335e+02 -1.21646622e+01 -9.52433262e+00 -9.52433262e+00
 -9.52433262e+00 -1.24729512e+00 -5.69739428e-01 -5.69739428e-01
 -5.69739428e-01  1.08286868e+00  1.08286868e+00  1.08286868e+00
  8.35850877e+00  8.35850877e+00  8.35850877e+00  3.97430155e+01
  3.97430155e+01  3.97430155e+01  1.54605502e+02  1.54605502e+02
  1.54605502e+02  1.68411961e+02  5.31013496e+02  5.31013496e+02
  5.31013496e+02  1.38664416e+03  1.38664416e+03  1.38664416e+03
  1.80934315e+03  3.07747242e+03  3.07747242e+03  3.07747242e+03
  6.69222551e+03  6.69222551e+03  6.69222551e+03  8.02156258e+03
  2.42999262e+04  7.50592381e+04]
E1 = -727.5397140472064  E_coul = 201.9569028970814
cycle= 4 E= -525.582811150125  delta_E= -1.73e-07  |g|= 3.97e-05  |ddm|= 0.000609
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.94374e-05
diis-c [-5.15672157e-10 -2.72660527e-05  3.33976863e-03  3.81449454e-02
  9.58542552e-01]
  HOMO = -0.569716170544123  LUMO = 1.08288681114775
  mo_energy =
[-1.18119245e+02 -1.21645864e+01 -9.52425611e+00 -9.52425611e+00
 -9.52425611e+00 -1.24726489e+00 -5.69716171e-01 -5.69716171e-01
 -5.69716171e-01  1.08288681e+00  1.08288681e+00  1.08288681e+00
  8.35856572e+00  8.35856572e+00  8.35856572e+00  3.97430923e+01
  3.97430923e+01  3.97430923e+01  1.54605589e+02  1.54605589e+02
  1.54605589e+02  1.68412051e+02  5.31013586e+02  5.31013586e+02
  5.31013586e+02  1.38664425e+03  1.38664425e+03  1.38664425e+03
  1.80934324e+03  3.07747251e+03  3.07747251e+03  3.07747251e+03
  6.69222560e+03  6.69222560e+03  6.69222560e+03  8.02156267e+03
  2.42999262e+04  7.50592382e+04]
E1 = -727.5395258108973  E_coul = 201.95671466064033
cycle= 5 E= -525.582811150257  delta_E= -1.32e-10  |g|= 2.82e-06  |ddm|= 2.1e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5395258108973  E_coul = 201.95671466064033
  HOMO = -0.569717687199929  LUMO = 1.08288562762834
  mo_energy =
[-1.18119252e+02 -1.21645917e+01 -9.52426151e+00 -9.52426151e+00
 -9.52426151e+00 -1.24726687e+00 -5.69717687e-01 -5.69717687e-01
 -5.69717687e-01  1.08288563e+00  1.08288563e+00  1.08288563e+00
  8.35856187e+00  8.35856187e+00  8.35856187e+00  3.97430868e+01
  3.97430868e+01  3.97430868e+01  1.54605582e+02  1.54605582e+02
  1.54605582e+02  1.68412044e+02  5.31013579e+02  5.31013579e+02
  5.31013579e+02  1.38664425e+03  1.38664425e+03  1.38664425e+03
  1.80934323e+03  3.07747250e+03  3.07747250e+03  3.07747250e+03
  6.69222559e+03  6.69222559e+03  6.69222559e+03  8.02156266e+03
  2.42999262e+04  7.50592382e+04]
E1 = -727.5395396106817  E_coul = 201.95672846042427
Extra cycle  E= -525.582811150257  delta_E= -4.55e-13  |g|= 6.94e-07  |ddm|= 1.48e-06
    CPU time for scf_cycle      0.89 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 116816.40295524464
E1 = -727.5395396106817  E_coul = 201.95672846042427
init E= -525.582811150257
    CPU time for initialize scf      1.32 sec, wall time      0.22 sec
  HOMO = -0.569717426131332  LUMO = 1.08288583459374
  mo_energy =
[-1.18119250e+02 -1.21645907e+01 -9.52426047e+00 -9.52426047e+00
 -9.52426047e+00 -1.24726652e+00 -5.69717426e-01 -5.69717426e-01
 -5.69717426e-01  1.08288583e+00  1.08288583e+00  1.08288583e+00
  8.35856257e+00  8.35856257e+00  8.35856257e+00  3.97430879e+01
  3.97430879e+01  3.97430879e+01  1.54605584e+02  1.54605584e+02
  1.54605584e+02  1.68412046e+02  5.31013580e+02  5.31013580e+02
  5.31013580e+02  1.38664425e+03  1.38664425e+03  1.38664425e+03
  1.80934323e+03  3.07747250e+03  3.07747250e+03  3.07747250e+03
  6.69222559e+03  6.69222559e+03  6.69222559e+03  8.02156266e+03
  2.42999262e+04  7.50592382e+04]
E1 = -727.5395368497141  E_coul = 201.95672569945643
cycle= 1 E= -525.582811150258  delta_E= -2.27e-13  |g|= 1.49e-07  |ddm|= 2.73e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.5395368497141  E_coul = 201.95672569945643
  HOMO = -0.569717475626777  LUMO = 1.0828857952042
  mo_energy =
[-1.18119251e+02 -1.21645909e+01 -9.52426068e+00 -9.52426068e+00
 -9.52426068e+00 -1.24726659e+00 -5.69717476e-01 -5.69717476e-01
 -5.69717476e-01  1.08288580e+00  1.08288580e+00  1.08288580e+00
  8.35856244e+00  8.35856244e+00  8.35856244e+00  3.97430877e+01
  3.97430877e+01  3.97430877e+01  1.54605583e+02  1.54605583e+02
  1.54605583e+02  1.68412046e+02  5.31013580e+02  5.31013580e+02
  5.31013580e+02  1.38664425e+03  1.38664425e+03  1.38664425e+03
  1.80934323e+03  3.07747250e+03  3.07747250e+03  3.07747250e+03
  6.69222559e+03  6.69222559e+03  6.69222559e+03  8.02156266e+03
  2.42999262e+04  7.50592382e+04]
E1 = -727.5395374084945  E_coul = 201.9567262582376
Extra cycle  E= -525.582811150257  delta_E= 6.82e-13  |g|= 3.1e-08  |ddm|= 5.43e-08
    CPU time for scf_cycle      1.45 sec, wall time      0.35 sec
exp = [2.61827623e+04 7.61546970e+03 3.61273170e+03 1.53208240e+03
 2.23903664e+02 5.00263653e+01 4.60362960e+00 3.97624522e-01
 1.36282587e+03 6.64411843e+02 2.99492990e+02 3.12802313e+02
 7.34986645e+01 8.40508524e+00 2.38444677e+01 8.08915233e-01
 3.13772300e+00 2.30004547e-01]
grad_E = [-1.99059596e-06  2.54380308e-05  5.13651280e-05  9.42458599e-04
 -4.44556905e-03 -5.57939420e-04 -4.68623009e-05 -3.81845418e-05
 -6.27437838e-07  7.73442863e-07  1.68995682e-06  1.46228437e-06
  3.32361856e-04 -1.07311617e-03  3.94711477e-04  1.07480794e-03
  1.25947066e-03 -2.00197834e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7653522        1
[INPUT] 0    0    [1    /1   ]  7615.43595089        1
[INPUT] 0    0    [1    /1   ]  3612.66429674        1
[INPUT] 0    0    [1    /1   ]  1531.03838188        1
[INPUT] 0    0    [1    /1   ]  223.883092613        1
[INPUT] 0    0    [1    /1   ]  50.0383716908        1
[INPUT] 0    0    [1    /1   ]  4.60380210803        1
[INPUT] 0    0    [1    /1   ]  0.397681911275       1
[INPUT] 1    0    [1    /1   ]  1362.8248227         1
[INPUT] 1    0    [1    /1   ]  664.390446195        1
[INPUT] 1    0    [1    /1   ]  299.37809629         1
[INPUT] 1    0    [1    /1   ]  312.701249373        1
[INPUT] 1    0    [1    /1   ]  75.2808779515        1
[INPUT] 1    0    [1    /1   ]  8.51202967474        1
[INPUT] 1    0    [1    /1   ]  24.2198838133        1
[INPUT] 1    0    [1    /1   ]  0.811330781467       1
[INPUT] 1    0    [1    /1   ]  3.17643086392        1
[INPUT] 1    0    [1    /1   ]  0.230449313829       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.765352236456, 1.0]], [0, [7615.43595089107, 1.0]], [0, [3612.664296736207, 1.0]], [0, [1531.038381881512, 1.0]], [0, [223.8830926127006, 1.0]], [0, [50.0383716907677, 1.0]], [0, [4.603802108030559, 1.0]], [0, [0.39768191127535607, 1.0]], [1, [1362.824822697988, 1.0]], [1, [664.390446194736, 1.0]], [1, [299.3780962902369, 1.0]], [1, [312.7012493728933, 1.0]], [1, [75.28087795150702, 1.0]], [1, [8.512029674743337, 1.0]], [1, [24.219883813311316, 1.0]], [1, [0.8113307814670948, 1.0]], [1, [3.176430863921441, 1.0]], [1, [0.23044931382900666, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.76535224]
bas 1, expnt(s) = [7615.43595089]
bas 2, expnt(s) = [3612.66429674]
bas 3, expnt(s) = [1531.03838188]
bas 4, expnt(s) = [223.88309261]
bas 5, expnt(s) = [50.03837169]
bas 6, expnt(s) = [4.60380211]
bas 7, expnt(s) = [0.39768191]
bas 8, expnt(s) = [1362.8248227]
bas 9, expnt(s) = [664.39044619]
bas 10, expnt(s) = [299.37809629]
bas 11, expnt(s) = [312.70124937]
bas 12, expnt(s) = [75.28087795]
bas 13, expnt(s) = [8.51202967]
bas 14, expnt(s) = [24.21988381]
bas 15, expnt(s) = [0.81133078]
bas 16, expnt(s) = [3.17643086]
bas 17, expnt(s) = [0.23044931]
CPU time:       458.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827654e+04 5.20027918e+03 7.61543595e+03 2.05961526e+03
 3.61266430e+03 1.17729617e+03 1.53103838e+03 6.18378787e+02
 2.23883093e+02 1.46228154e+02 5.00383717e+01 4.75326909e+01
 4.60380211e+00 7.94058520e+00 3.97681911e-01 1.26522249e+00
 1.36282482e+03 2.41565237e+04 6.64390446e+02 9.84041957e+03
 2.99378096e+02 3.63295000e+03 3.12701249e+02 3.83615735e+03
 7.52808780e+01 6.46904596e+02 8.51202967e+00 4.24156185e+01
 2.42198838e+01 1.56747081e+02 8.11330781e-01 2.24637281e+00
 3.17643086e+00 1.23711095e+01 2.30449314e-01 4.65804486e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972864248224674
cond(S) = 119946.02517375253
E1 = -727.485287836374  E_coul = 203.09627150900712
init E= -524.389016327367
    CPU time for initialize scf      0.17 sec, wall time      0.05 sec
  HOMO = -0.559463433498195  LUMO = 1.09265577508927
  mo_energy =
[-1.17897372e+02 -1.20896548e+01 -9.44915712e+00 -9.44915712e+00
 -9.44915712e+00 -1.22982401e+00 -5.59463433e-01 -5.59463433e-01
 -5.59463433e-01  1.09265578e+00  1.09265578e+00  1.09265578e+00
  8.52125277e+00  8.52125277e+00  8.52125277e+00  4.05083388e+01
  4.05083388e+01  4.05083388e+01  1.57860293e+02  1.57860293e+02
  1.57860293e+02  1.68597988e+02  5.37525866e+02  5.37525866e+02
  5.37525866e+02  1.39418896e+03  1.39418896e+03  1.39418896e+03
  1.80910216e+03  3.08498828e+03  3.08498828e+03  3.08498828e+03
  6.69928820e+03  6.69928820e+03  6.69928820e+03  8.01975852e+03
  2.42969022e+04  7.50558396e+04]
E1 = -727.3670606979363  E_coul = 201.7842720192008
cycle= 1 E= -525.582788678735  delta_E= -1.19  |g|= 0.198  |ddm|= 0.376
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.48821
diis-c [-0.23834881  1.        ]
  HOMO = -0.571795886689136  LUMO = 1.08527938130808
  mo_energy =
[-1.18146102e+02 -1.21772538e+01 -9.53682452e+00 -9.53682452e+00
 -9.53682452e+00 -1.25016335e+00 -5.71795887e-01 -5.71795887e-01
 -5.71795887e-01  1.08527938e+00  1.08527938e+00  1.08527938e+00
  8.46806502e+00  8.46806502e+00  8.46806502e+00  4.04041923e+01
  4.04041923e+01  4.04041923e+01  1.57688044e+02  1.57688044e+02
  1.57688044e+02  1.68408689e+02  5.37290334e+02  5.37290334e+02
  5.37290334e+02  1.39390216e+03  1.39390216e+03  1.39390216e+03
  1.80868529e+03  3.08463383e+03  3.08463383e+03  3.08463383e+03
  6.69880580e+03  6.69880580e+03  6.69880580e+03  8.01918679e+03
  2.42962288e+04  7.50550700e+04]
E1 = -727.5803213469941  E_coul = 201.997328016852
cycle= 2 E= -525.582993330142  delta_E= -0.000205  |g|= 0.0162  |ddm|= 0.0146
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0326985
diis-c [-8.02055256e-04  3.24463050e-02  9.67553695e-01]
  HOMO = -0.569119938564784  LUMO = 1.08750724747434
  mo_energy =
[-1.18114946e+02 -1.21623520e+01 -9.52168639e+00 -9.52168639e+00
 -9.52168639e+00 -1.24657687e+00 -5.69119939e-01 -5.69119939e-01
 -5.69119939e-01  1.08750725e+00  1.08750725e+00  1.08750725e+00
  8.47702875e+00  8.47702875e+00  8.47702875e+00  4.04212918e+01
  4.04212918e+01  4.04212918e+01  1.57713586e+02  1.57713586e+02
  1.57713586e+02  1.68438276e+02  5.37321068e+02  5.37321068e+02
  5.37321068e+02  1.39393499e+03  1.39393499e+03  1.39393499e+03
  1.80871967e+03  3.08466779e+03  3.08466779e+03  3.08466779e+03
  6.69884038e+03  6.69884038e+03  6.69884038e+03  8.01922160e+03
  2.42962636e+04  7.50551047e+04]
E1 = -727.5365699922326  E_coul = 201.95357027066794
cycle= 3 E= -525.582999721565  delta_E= -6.39e-06  |g|= 0.00219  |ddm|= 0.00377
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00465194
diis-c [-1.00143153e-07 -8.16863844e-04  1.19192744e-01  8.81624119e-01]
  HOMO = -0.569646403260965  LUMO = 1.08708345707465
  mo_energy =
[-1.18119090e+02 -1.21646464e+01 -9.52403098e+00 -9.52403098e+00
 -9.52403098e+00 -1.24726934e+00 -5.69646403e-01 -5.69646403e-01
 -5.69646403e-01  1.08708346e+00  1.08708346e+00  1.08708346e+00
  8.47550679e+00  8.47550679e+00  8.47550679e+00  4.04187433e+01
  4.04187433e+01  4.04187433e+01  1.57710075e+02  1.57710075e+02
  1.57710075e+02  1.68434366e+02  5.37316979e+02  5.37316979e+02
  5.37316979e+02  1.39393066e+03  1.39393066e+03  1.39393066e+03
  1.80871509e+03  3.08466330e+03  3.08466330e+03  3.08466330e+03
  6.69883574e+03  6.69883574e+03  6.69883574e+03  8.01921688e+03
  2.42962588e+04  7.50550999e+04]
E1 = -727.5430280249636  E_coul = 201.96002813139464
cycle= 4 E= -525.582999893569  delta_E= -1.72e-07  |g|= 3.95e-05  |ddm|= 0.000608
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.90119e-05
diis-c [-5.13837797e-10 -2.68608607e-05  3.31259204e-03  3.78979515e-02
  9.58816317e-01]
  HOMO = -0.569623245949583  LUMO = 1.08710160158532
  mo_energy =
[-1.18119000e+02 -1.21645710e+01 -9.52395483e+00 -9.52395483e+00
 -9.52395483e+00 -1.24723924e+00 -5.69623246e-01 -5.69623246e-01
 -5.69623246e-01  1.08710160e+00  1.08710160e+00  1.08710160e+00
  8.47556382e+00  8.47556382e+00  8.47556382e+00  4.04188199e+01
  4.04188199e+01  4.04188199e+01  1.57710161e+02  1.57710161e+02
  1.57710161e+02  1.68434456e+02  5.37317069e+02  5.37317069e+02
  5.37317069e+02  1.39393075e+03  1.39393075e+03  1.39393075e+03
  1.80871518e+03  3.08466339e+03  3.08466339e+03  3.08466339e+03
  6.69883583e+03  6.69883583e+03  6.69883583e+03  8.01921696e+03
  2.42962589e+04  7.50550999e+04]
E1 = -727.5428409313039  E_coul = 201.95984103760466
cycle= 5 E= -525.582999893699  delta_E= -1.3e-10  |g|= 2.81e-06  |ddm|= 2.09e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5428409313039  E_coul = 201.95984103760466
  HOMO = -0.569624758177246  LUMO = 1.08710041600527
  mo_energy =
[-1.18119007e+02 -1.21645763e+01 -9.52396023e+00 -9.52396023e+00
 -9.52396023e+00 -1.24724121e+00 -5.69624758e-01 -5.69624758e-01
 -5.69624758e-01  1.08710042e+00  1.08710042e+00  1.08710042e+00
  8.47555995e+00  8.47555995e+00  8.47555995e+00  4.04188144e+01
  4.04188144e+01  4.04188144e+01  1.57710154e+02  1.57710154e+02
  1.57710154e+02  1.68434449e+02  5.37317061e+02  5.37317061e+02
  5.37317061e+02  1.39393074e+03  1.39393074e+03  1.39393074e+03
  1.80871517e+03  3.08466338e+03  3.08466338e+03  3.08466338e+03
  6.69883582e+03  6.69883582e+03  6.69883582e+03  8.01921696e+03
  2.42962588e+04  7.50550999e+04]
E1 = -727.5428546941026  E_coul = 201.95985480040449
Extra cycle  E= -525.582999893698  delta_E= 1.14e-12  |g|= 6.93e-07  |ddm|= 1.48e-06
    CPU time for scf_cycle      0.37 sec, wall time      0.25 sec
exp = [2.61827654e+04 7.61543595e+03 3.61266430e+03 1.53103838e+03
 2.23883093e+02 5.00383717e+01 4.60380211e+00 3.97681911e-01
 1.36282482e+03 6.64390446e+02 2.99378096e+02 3.12701249e+02
 7.52808780e+01 8.51202967e+00 2.42198838e+01 8.11330781e-01
 3.17643086e+00 2.30449314e-01]
E = -525.5829998936981
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7653522        1
[INPUT] 0    0    [1    /1   ]  7615.43595089        1
[INPUT] 0    0    [1    /1   ]  3612.66429674        1
[INPUT] 0    0    [1    /1   ]  1531.03838188        1
[INPUT] 0    0    [1    /1   ]  223.883092613        1
[INPUT] 0    0    [1    /1   ]  50.0383716908        1
[INPUT] 0    0    [1    /1   ]  4.60380210803        1
[INPUT] 0    0    [1    /1   ]  0.397681911275       1
[INPUT] 1    0    [1    /1   ]  1362.8248227         1
[INPUT] 1    0    [1    /1   ]  664.390446195        1
[INPUT] 1    0    [1    /1   ]  299.37809629         1
[INPUT] 1    0    [1    /1   ]  312.701249373        1
[INPUT] 1    0    [1    /1   ]  75.2808779515        1
[INPUT] 1    0    [1    /1   ]  8.51202967474        1
[INPUT] 1    0    [1    /1   ]  24.2198838133        1
[INPUT] 1    0    [1    /1   ]  0.811330781467       1
[INPUT] 1    0    [1    /1   ]  3.17643086392        1
[INPUT] 1    0    [1    /1   ]  0.230449313829       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.765352236456, 1.0]], [0, [7615.43595089107, 1.0]], [0, [3612.664296736207, 1.0]], [0, [1531.038381881512, 1.0]], [0, [223.8830926127006, 1.0]], [0, [50.0383716907677, 1.0]], [0, [4.603802108030559, 1.0]], [0, [0.39768191127535607, 1.0]], [1, [1362.824822697988, 1.0]], [1, [664.390446194736, 1.0]], [1, [299.3780962902369, 1.0]], [1, [312.7012493728933, 1.0]], [1, [75.28087795150702, 1.0]], [1, [8.512029674743337, 1.0]], [1, [24.219883813311316, 1.0]], [1, [0.8113307814670948, 1.0]], [1, [3.176430863921441, 1.0]], [1, [0.23044931382900666, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.76535224]
bas 1, expnt(s) = [7615.43595089]
bas 2, expnt(s) = [3612.66429674]
bas 3, expnt(s) = [1531.03838188]
bas 4, expnt(s) = [223.88309261]
bas 5, expnt(s) = [50.03837169]
bas 6, expnt(s) = [4.60380211]
bas 7, expnt(s) = [0.39768191]
bas 8, expnt(s) = [1362.8248227]
bas 9, expnt(s) = [664.39044619]
bas 10, expnt(s) = [299.37809629]
bas 11, expnt(s) = [312.70124937]
bas 12, expnt(s) = [75.28087795]
bas 13, expnt(s) = [8.51202967]
bas 14, expnt(s) = [24.21988381]
bas 15, expnt(s) = [0.81133078]
bas 16, expnt(s) = [3.17643086]
bas 17, expnt(s) = [0.23044931]
CPU time:       459.32
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827654e+04 5.20027918e+03 7.61543595e+03 2.05961526e+03
 3.61266430e+03 1.17729617e+03 1.53103838e+03 6.18378787e+02
 2.23883093e+02 1.46228154e+02 5.00383717e+01 4.75326909e+01
 4.60380211e+00 7.94058520e+00 3.97681911e-01 1.26522249e+00
 1.36282482e+03 2.41565237e+04 6.64390446e+02 9.84041957e+03
 2.99378096e+02 3.63295000e+03 3.12701249e+02 3.83615735e+03
 7.52808780e+01 6.46904596e+02 8.51202967e+00 4.24156185e+01
 2.42198838e+01 1.56747081e+02 8.11330781e-01 2.24637281e+00
 3.17643086e+00 1.23711095e+01 2.30449314e-01 4.65804486e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972864248224674
cond(S) = 119946.02517375253
E1 = -727.485287836374  E_coul = 203.09627150900712
init E= -524.389016327367
    CPU time for initialize scf      0.15 sec, wall time      0.04 sec
  HOMO = -0.559463433498195  LUMO = 1.09265577508927
  mo_energy =
[-1.17897372e+02 -1.20896548e+01 -9.44915712e+00 -9.44915712e+00
 -9.44915712e+00 -1.22982401e+00 -5.59463433e-01 -5.59463433e-01
 -5.59463433e-01  1.09265578e+00  1.09265578e+00  1.09265578e+00
  8.52125277e+00  8.52125277e+00  8.52125277e+00  4.05083388e+01
  4.05083388e+01  4.05083388e+01  1.57860293e+02  1.57860293e+02
  1.57860293e+02  1.68597988e+02  5.37525866e+02  5.37525866e+02
  5.37525866e+02  1.39418896e+03  1.39418896e+03  1.39418896e+03
  1.80910216e+03  3.08498828e+03  3.08498828e+03  3.08498828e+03
  6.69928820e+03  6.69928820e+03  6.69928820e+03  8.01975852e+03
  2.42969022e+04  7.50558396e+04]
E1 = -727.3670606979363  E_coul = 201.7842720192008
cycle= 1 E= -525.582788678735  delta_E= -1.19  |g|= 0.198  |ddm|= 0.376
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.48821
diis-c [-0.23834881  1.        ]
  HOMO = -0.571795886689136  LUMO = 1.08527938130808
  mo_energy =
[-1.18146102e+02 -1.21772538e+01 -9.53682452e+00 -9.53682452e+00
 -9.53682452e+00 -1.25016335e+00 -5.71795887e-01 -5.71795887e-01
 -5.71795887e-01  1.08527938e+00  1.08527938e+00  1.08527938e+00
  8.46806502e+00  8.46806502e+00  8.46806502e+00  4.04041923e+01
  4.04041923e+01  4.04041923e+01  1.57688044e+02  1.57688044e+02
  1.57688044e+02  1.68408689e+02  5.37290334e+02  5.37290334e+02
  5.37290334e+02  1.39390216e+03  1.39390216e+03  1.39390216e+03
  1.80868529e+03  3.08463383e+03  3.08463383e+03  3.08463383e+03
  6.69880580e+03  6.69880580e+03  6.69880580e+03  8.01918679e+03
  2.42962288e+04  7.50550700e+04]
E1 = -727.5803213469941  E_coul = 201.997328016852
cycle= 2 E= -525.582993330142  delta_E= -0.000205  |g|= 0.0162  |ddm|= 0.0146
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0326985
diis-c [-8.02055256e-04  3.24463050e-02  9.67553695e-01]
  HOMO = -0.569119938564784  LUMO = 1.08750724747434
  mo_energy =
[-1.18114946e+02 -1.21623520e+01 -9.52168639e+00 -9.52168639e+00
 -9.52168639e+00 -1.24657687e+00 -5.69119939e-01 -5.69119939e-01
 -5.69119939e-01  1.08750725e+00  1.08750725e+00  1.08750725e+00
  8.47702875e+00  8.47702875e+00  8.47702875e+00  4.04212918e+01
  4.04212918e+01  4.04212918e+01  1.57713586e+02  1.57713586e+02
  1.57713586e+02  1.68438276e+02  5.37321068e+02  5.37321068e+02
  5.37321068e+02  1.39393499e+03  1.39393499e+03  1.39393499e+03
  1.80871967e+03  3.08466779e+03  3.08466779e+03  3.08466779e+03
  6.69884038e+03  6.69884038e+03  6.69884038e+03  8.01922160e+03
  2.42962636e+04  7.50551047e+04]
E1 = -727.5365699922326  E_coul = 201.95357027066794
cycle= 3 E= -525.582999721565  delta_E= -6.39e-06  |g|= 0.00219  |ddm|= 0.00377
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00465194
diis-c [-1.00143153e-07 -8.16863844e-04  1.19192744e-01  8.81624119e-01]
  HOMO = -0.569646403260965  LUMO = 1.08708345707465
  mo_energy =
[-1.18119090e+02 -1.21646464e+01 -9.52403098e+00 -9.52403098e+00
 -9.52403098e+00 -1.24726934e+00 -5.69646403e-01 -5.69646403e-01
 -5.69646403e-01  1.08708346e+00  1.08708346e+00  1.08708346e+00
  8.47550679e+00  8.47550679e+00  8.47550679e+00  4.04187433e+01
  4.04187433e+01  4.04187433e+01  1.57710075e+02  1.57710075e+02
  1.57710075e+02  1.68434366e+02  5.37316979e+02  5.37316979e+02
  5.37316979e+02  1.39393066e+03  1.39393066e+03  1.39393066e+03
  1.80871509e+03  3.08466330e+03  3.08466330e+03  3.08466330e+03
  6.69883574e+03  6.69883574e+03  6.69883574e+03  8.01921688e+03
  2.42962588e+04  7.50550999e+04]
E1 = -727.5430280249636  E_coul = 201.96002813139464
cycle= 4 E= -525.582999893569  delta_E= -1.72e-07  |g|= 3.95e-05  |ddm|= 0.000608
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.90119e-05
diis-c [-5.13837797e-10 -2.68608607e-05  3.31259204e-03  3.78979515e-02
  9.58816317e-01]
  HOMO = -0.569623245949583  LUMO = 1.08710160158532
  mo_energy =
[-1.18119000e+02 -1.21645710e+01 -9.52395483e+00 -9.52395483e+00
 -9.52395483e+00 -1.24723924e+00 -5.69623246e-01 -5.69623246e-01
 -5.69623246e-01  1.08710160e+00  1.08710160e+00  1.08710160e+00
  8.47556382e+00  8.47556382e+00  8.47556382e+00  4.04188199e+01
  4.04188199e+01  4.04188199e+01  1.57710161e+02  1.57710161e+02
  1.57710161e+02  1.68434456e+02  5.37317069e+02  5.37317069e+02
  5.37317069e+02  1.39393075e+03  1.39393075e+03  1.39393075e+03
  1.80871518e+03  3.08466339e+03  3.08466339e+03  3.08466339e+03
  6.69883583e+03  6.69883583e+03  6.69883583e+03  8.01921696e+03
  2.42962589e+04  7.50550999e+04]
E1 = -727.5428409313039  E_coul = 201.95984103760466
cycle= 5 E= -525.582999893699  delta_E= -1.3e-10  |g|= 2.81e-06  |ddm|= 2.09e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5428409313039  E_coul = 201.95984103760466
  HOMO = -0.569624758177246  LUMO = 1.08710041600527
  mo_energy =
[-1.18119007e+02 -1.21645763e+01 -9.52396023e+00 -9.52396023e+00
 -9.52396023e+00 -1.24724121e+00 -5.69624758e-01 -5.69624758e-01
 -5.69624758e-01  1.08710042e+00  1.08710042e+00  1.08710042e+00
  8.47555995e+00  8.47555995e+00  8.47555995e+00  4.04188144e+01
  4.04188144e+01  4.04188144e+01  1.57710154e+02  1.57710154e+02
  1.57710154e+02  1.68434449e+02  5.37317061e+02  5.37317061e+02
  5.37317061e+02  1.39393074e+03  1.39393074e+03  1.39393074e+03
  1.80871517e+03  3.08466338e+03  3.08466338e+03  3.08466338e+03
  6.69883582e+03  6.69883582e+03  6.69883582e+03  8.01921696e+03
  2.42962588e+04  7.50550999e+04]
E1 = -727.5428546941026  E_coul = 201.95985480040449
Extra cycle  E= -525.582999893698  delta_E= 1.14e-12  |g|= 6.93e-07  |ddm|= 1.48e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.24 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 119946.02517375253
E1 = -727.5428546941026  E_coul = 201.95985480040449
init E= -525.582999893698
    CPU time for initialize scf      1.27 sec, wall time      0.23 sec
  HOMO = -0.569624497780756  LUMO = 1.08710062345246
  mo_energy =
[-1.18119005e+02 -1.21645753e+01 -9.52395919e+00 -9.52395919e+00
 -9.52395919e+00 -1.24724087e+00 -5.69624498e-01 -5.69624498e-01
 -5.69624498e-01  1.08710062e+00  1.08710062e+00  1.08710062e+00
  8.47556066e+00  8.47556066e+00  8.47556066e+00  4.04188155e+01
  4.04188155e+01  4.04188155e+01  1.57710156e+02  1.57710156e+02
  1.57710156e+02  1.68434451e+02  5.37317063e+02  5.37317063e+02
  5.37317063e+02  1.39393074e+03  1.39393074e+03  1.39393074e+03
  1.80871518e+03  3.08466338e+03  3.08466338e+03  3.08466338e+03
  6.69883582e+03  6.69883582e+03  6.69883582e+03  8.01921696e+03
  2.42962589e+04  7.50550999e+04]
E1 = -727.5428519439621  E_coul = 201.95985205026278
cycle= 1 E= -525.582999893699  delta_E= -1.14e-12  |g|= 1.48e-07  |ddm|= 2.73e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.5428519439621  E_coul = 201.95985205026278
  HOMO = -0.569624547067795  LUMO = 1.08710058403628
  mo_energy =
[-1.18119006e+02 -1.21645755e+01 -9.52395940e+00 -9.52395940e+00
 -9.52395940e+00 -1.24724093e+00 -5.69624547e-01 -5.69624547e-01
 -5.69624547e-01  1.08710058e+00  1.08710058e+00  1.08710058e+00
  8.47556052e+00  8.47556052e+00  8.47556052e+00  4.04188153e+01
  4.04188153e+01  4.04188153e+01  1.57710156e+02  1.57710156e+02
  1.57710156e+02  1.68434450e+02  5.37317063e+02  5.37317063e+02
  5.37317063e+02  1.39393074e+03  1.39393074e+03  1.39393074e+03
  1.80871518e+03  3.08466338e+03  3.08466338e+03  3.08466338e+03
  6.69883582e+03  6.69883582e+03  6.69883582e+03  8.01921696e+03
  2.42962589e+04  7.50550999e+04]
E1 = -727.5428524999611  E_coul = 201.95985260626136
Extra cycle  E= -525.5829998937  delta_E= -4.55e-13  |g|= 3.08e-08  |ddm|= 5.41e-08
    CPU time for scf_cycle      1.41 sec, wall time      0.36 sec
exp = [2.61827654e+04 7.61543595e+03 3.61266430e+03 1.53103838e+03
 2.23883093e+02 5.00383717e+01 4.60380211e+00 3.97681911e-01
 1.36282482e+03 6.64390446e+02 2.99378096e+02 3.12701249e+02
 7.52808780e+01 8.51202967e+00 2.42198838e+01 8.11330781e-01
 3.17643086e+00 2.30449314e-01]
grad_E = [-1.99114618e-06  2.54078724e-05  5.12188952e-05  9.43275944e-04
 -4.48279130e-03 -2.23071022e-04  1.31984597e-04  7.45514791e-04
 -5.82716889e-07  4.70912330e-07  3.63085935e-07  3.95965237e-07
  3.99089009e-04 -1.52715540e-03  2.00845191e-04  1.65428780e-05
  3.23798304e-03 -4.08067467e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7749024        1
[INPUT] 0    0    [1    /1   ]  7615.33078958        1
[INPUT] 0    0    [1    /1   ]  3612.45453404        1
[INPUT] 0    0    [1    /1   ]  1527.78312641        1
[INPUT] 0    0    [1    /1   ]  223.743316714        1
[INPUT] 0    0    [1    /1   ]  50.0420596589        1
[INPUT] 0    0    [1    /1   ]  4.60417250182        1
[INPUT] 0    0    [1    /1   ]  0.39775896304        1
[INPUT] 1    0    [1    /1   ]  1362.8224692         1
[INPUT] 1    0    [1    /1   ]  664.331308364        1
[INPUT] 1    0    [1    /1   ]  299.062811729        1
[INPUT] 1    0    [1    /1   ]  312.424086483        1
[INPUT] 1    0    [1    /1   ]  79.9030051923        1
[INPUT] 1    0    [1    /1   ]  8.79699357849        1
[INPUT] 1    0    [1    /1   ]  25.2418419588        1
[INPUT] 1    0    [1    /1   ]  0.81765865256        1
[INPUT] 1    0    [1    /1   ]  3.2655033178         1
[INPUT] 1    0    [1    /1   ]  0.231612556706       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.774902361674, 1.0]], [0, [7615.330789575421, 1.0]], [0, [3612.4545340357868, 1.0]], [0, [1527.7831264108856, 1.0]], [0, [223.7433167137212, 1.0]], [0, [50.042059658931244, 1.0]], [0, [4.604172501821824, 1.0]], [0, [0.3977589630395717, 1.0]], [1, [1362.8224692007504, 1.0]], [1, [664.3313083643109, 1.0]], [1, [299.0628117288628, 1.0]], [1, [312.4240864825471, 1.0]], [1, [79.90300519232886, 1.0]], [1, [8.796993578489811, 1.0]], [1, [25.241841958795316, 1.0]], [1, [0.8176586525595202, 1.0]], [1, [3.265503317797749, 1.0]], [1, [0.2316125567061752, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.77490236]
bas 1, expnt(s) = [7615.33078958]
bas 2, expnt(s) = [3612.45453404]
bas 3, expnt(s) = [1527.78312641]
bas 4, expnt(s) = [223.74331671]
bas 5, expnt(s) = [50.04205966]
bas 6, expnt(s) = [4.6041725]
bas 7, expnt(s) = [0.39775896]
bas 8, expnt(s) = [1362.8224692]
bas 9, expnt(s) = [664.33130836]
bas 10, expnt(s) = [299.06281173]
bas 11, expnt(s) = [312.42408648]
bas 12, expnt(s) = [79.90300519]
bas 13, expnt(s) = [8.79699358]
bas 14, expnt(s) = [25.24184196]
bas 15, expnt(s) = [0.81765865]
bas 16, expnt(s) = [3.26550332]
bas 17, expnt(s) = [0.23161256]
CPU time:       465.56
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827749e+04 5.20028060e+03 7.61533079e+03 2.05959393e+03
 3.61245453e+03 1.17724490e+03 1.52778313e+03 6.17392438e+02
 2.23743317e+02 1.46159678e+02 5.00420597e+01 4.75353183e+01
 4.60417250e+00 7.94106433e+00 3.97758963e-01 1.26540634e+00
 1.36282247e+03 2.41564716e+04 6.64331308e+02 9.83932470e+03
 2.99062812e+02 3.62816816e+03 3.12424086e+02 3.83190760e+03
 7.99030052e+01 6.96928596e+02 8.79699358e+00 4.41979612e+01
 2.52418420e+01 1.65057665e+02 8.17658653e-01 2.26829449e+00
 3.26550332e+00 1.28062523e+01 2.31612557e-01 4.68745399e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97256212316397
cond(S) = 128581.99413100105
E1 = -727.48614398181  E_coul = 203.09830987366672
init E= -524.387834108143
    CPU time for initialize scf      0.65 sec, wall time      0.08 sec
  HOMO = -0.559353499103955  LUMO = 1.10362162747035
  mo_energy =
[-1.17898083e+02 -1.20897068e+01 -9.44873972e+00 -9.44873972e+00
 -9.44873972e+00 -1.22984298e+00 -5.59353499e-01 -5.59353499e-01
 -5.59353499e-01  1.10362163e+00  1.10362163e+00  1.10362163e+00
  8.81074119e+00  8.81074119e+00  8.81074119e+00  4.22887112e+01
  4.22887112e+01  4.22887112e+01  1.65951347e+02  1.65951347e+02
  1.65951347e+02  1.68530751e+02  5.53802475e+02  5.53802475e+02
  5.53802475e+02  1.41314824e+03  1.41314824e+03  1.41314824e+03
  1.80678412e+03  3.10376681e+03  3.10376681e+03  3.10376681e+03
  6.71656668e+03  6.71656668e+03  6.71656668e+03  8.01205483e+03
  2.42850882e+04  7.50425827e+04]
E1 = -727.3735666052287  E_coul = 201.79032257626102
cycle= 1 E= -525.583244028968  delta_E= -1.2  |g|= 0.198  |ddm|= 0.409
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.487745
diis-c [-0.23789491  1.        ]
  HOMO = -0.571575709168955  LUMO = 1.09617414198476
  mo_energy =
[-1.18146139e+02 -1.21771105e+01 -9.53617270e+00 -9.53617270e+00
 -9.53617270e+00 -1.25008780e+00 -5.71575709e-01 -5.71575709e-01
 -5.71575709e-01  1.09617414e+00  1.09617414e+00  1.09617414e+00
  8.75643326e+00  8.75643326e+00  8.75643326e+00  4.21826138e+01
  4.21826138e+01  4.21826138e+01  1.65776878e+02  1.65776878e+02
  1.65776878e+02  1.68342084e+02  5.53567284e+02  5.53567284e+02
  5.53567284e+02  1.41286260e+03  1.41286260e+03  1.41286260e+03
  1.80636872e+03  3.10341377e+03  3.10341377e+03  3.10341377e+03
  6.71608584e+03  6.71608584e+03  6.71608584e+03  8.01148472e+03
  2.42844164e+04  7.50418148e+04]
E1 = -727.5855206539622  E_coul = 202.00207363685075
cycle= 2 E= -525.583447017111  delta_E= -0.000203  |g|= 0.0161  |ddm|= 0.0146
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0324366
diis-c [-7.91411678e-04  3.20958795e-02  9.67904121e-01]
  HOMO = -0.568914691553742  LUMO = 1.09841885770684
  mo_energy =
[-1.18115147e+02 -1.21622981e+01 -9.52112585e+00 -9.52112585e+00
 -9.52112585e+00 -1.24652209e+00 -5.68914692e-01 -5.68914692e-01
 -5.68914692e-01  1.09841886e+00  1.09841886e+00  1.09841886e+00
  8.76555931e+00  8.76555931e+00  8.76555931e+00  4.21999501e+01
  4.21999501e+01  4.21999501e+01  1.65802574e+02  1.65802574e+02
  1.65802574e+02  1.68371512e+02  5.53597889e+02  5.53597889e+02
  5.53597889e+02  1.41289525e+03  1.41289525e+03  1.41289525e+03
  1.80640293e+03  3.10344755e+03  3.10344755e+03  3.10344755e+03
  6.71612025e+03  6.71612025e+03  6.71612025e+03  8.01151936e+03
  2.42844510e+04  7.50418494e+04]
E1 = -727.542147635172  E_coul = 201.95869431677588
cycle= 3 E= -525.583453318396  delta_E= -6.3e-06  |g|= 0.00218  |ddm|= 0.00375
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00461434
diis-c [-9.68961708e-08 -8.11545505e-04  1.19203633e-01  8.81607912e-01]
  HOMO = -0.569436498844698  LUMO = 1.09799354681214
  mo_energy =
[-1.18119268e+02 -1.21645766e+01 -9.52345425e+00 -9.52345425e+00
 -9.52345425e+00 -1.24720880e+00 -5.69436499e-01 -5.69436499e-01
 -5.69436499e-01  1.09799355e+00  1.09799355e+00  1.09799355e+00
  8.76401897e+00  8.76401897e+00  8.76401897e+00  4.21973794e+01
  4.21973794e+01  4.21973794e+01  1.65799051e+02  1.65799051e+02
  1.65799051e+02  1.68367626e+02  5.53593819e+02  5.53593819e+02
  5.53593819e+02  1.41289094e+03  1.41289094e+03  1.41289094e+03
  1.80639838e+03  3.10344308e+03  3.10344308e+03  3.10344308e+03
  6.71611563e+03  6.71611563e+03  6.71611563e+03  8.01151466e+03
  2.42844463e+04  7.50418446e+04]
E1 = -727.548547291597  E_coul = 201.96509380379996
cycle= 4 E= -525.583453487797  delta_E= -1.69e-07  |g|= 3.91e-05  |ddm|= 0.000605
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.79408e-05
diis-c [-5.10488319e-10 -2.59772261e-05  3.23516920e-03  3.72146830e-02
  9.59576125e-01]
  HOMO = -0.569413555285738  LUMO = 1.09801173738012
  mo_energy =
[-1.18119179e+02 -1.21645019e+01 -9.52337887e+00 -9.52337887e+00
 -9.52337887e+00 -1.24717898e+00 -5.69413555e-01 -5.69413555e-01
 -5.69413555e-01  1.09801174e+00  1.09801174e+00  1.09801174e+00
  8.76407624e+00  8.76407624e+00  8.76407624e+00  4.21974558e+01
  4.21974558e+01  4.21974558e+01  1.65799137e+02  1.65799137e+02
  1.65799137e+02  1.68367715e+02  5.53593908e+02  5.53593908e+02
  5.53593908e+02  1.41289102e+03  1.41289102e+03  1.41289102e+03
  1.80639847e+03  3.10344317e+03  3.10344317e+03  3.10344317e+03
  6.71611572e+03  6.71611572e+03  6.71611572e+03  8.01151474e+03
  2.42844464e+04  7.50418447e+04]
E1 = -727.5483626732969  E_coul = 201.96490918536975
cycle= 5 E= -525.583453487927  delta_E= -1.3e-10  |g|= 2.81e-06  |ddm|= 2.06e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5483626732969  E_coul = 201.96490918536975
  HOMO = -0.569415064563808  LUMO = 1.098010540123
  mo_energy =
[-1.18119186e+02 -1.21645072e+01 -9.52338427e+00 -9.52338427e+00
 -9.52338427e+00 -1.24718096e+00 -5.69415065e-01 -5.69415065e-01
 -5.69415065e-01  1.09801054e+00  1.09801054e+00  1.09801054e+00
  8.76407232e+00  8.76407232e+00  8.76407232e+00  4.21974503e+01
  4.21974503e+01  4.21974503e+01  1.65799130e+02  1.65799130e+02
  1.65799130e+02  1.68367708e+02  5.53593901e+02  5.53593901e+02
  5.53593901e+02  1.41289102e+03  1.41289102e+03  1.41289102e+03
  1.80639846e+03  3.10344316e+03  3.10344316e+03  3.10344316e+03
  6.71611571e+03  6.71611571e+03  6.71611571e+03  8.01151474e+03
  2.42844464e+04  7.50418446e+04]
E1 = -727.54837640896  E_coul = 201.96492292103434
Extra cycle  E= -525.583453487926  delta_E= 1.48e-12  |g|= 6.92e-07  |ddm|= 1.49e-06
    CPU time for scf_cycle      0.80 sec, wall time      0.22 sec
exp = [2.61827749e+04 7.61533079e+03 3.61245453e+03 1.52778313e+03
 2.23743317e+02 5.00420597e+01 4.60417250e+00 3.97758963e-01
 1.36282247e+03 6.64331308e+02 2.99062812e+02 3.12424086e+02
 7.99030052e+01 8.79699358e+00 2.52418420e+01 8.17658653e-01
 3.26550332e+00 2.31612557e-01]
E = -525.5834534879257
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7749024        1
[INPUT] 0    0    [1    /1   ]  7615.33078958        1
[INPUT] 0    0    [1    /1   ]  3612.45453404        1
[INPUT] 0    0    [1    /1   ]  1527.78312641        1
[INPUT] 0    0    [1    /1   ]  223.743316714        1
[INPUT] 0    0    [1    /1   ]  50.0420596589        1
[INPUT] 0    0    [1    /1   ]  4.60417250182        1
[INPUT] 0    0    [1    /1   ]  0.39775896304        1
[INPUT] 1    0    [1    /1   ]  1362.8224692         1
[INPUT] 1    0    [1    /1   ]  664.331308364        1
[INPUT] 1    0    [1    /1   ]  299.062811729        1
[INPUT] 1    0    [1    /1   ]  312.424086483        1
[INPUT] 1    0    [1    /1   ]  79.9030051923        1
[INPUT] 1    0    [1    /1   ]  8.79699357849        1
[INPUT] 1    0    [1    /1   ]  25.2418419588        1
[INPUT] 1    0    [1    /1   ]  0.81765865256        1
[INPUT] 1    0    [1    /1   ]  3.2655033178         1
[INPUT] 1    0    [1    /1   ]  0.231612556706       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.774902361674, 1.0]], [0, [7615.330789575421, 1.0]], [0, [3612.4545340357868, 1.0]], [0, [1527.7831264108856, 1.0]], [0, [223.7433167137212, 1.0]], [0, [50.042059658931244, 1.0]], [0, [4.604172501821824, 1.0]], [0, [0.3977589630395717, 1.0]], [1, [1362.8224692007504, 1.0]], [1, [664.3313083643109, 1.0]], [1, [299.0628117288628, 1.0]], [1, [312.4240864825471, 1.0]], [1, [79.90300519232886, 1.0]], [1, [8.796993578489811, 1.0]], [1, [25.241841958795316, 1.0]], [1, [0.8176586525595202, 1.0]], [1, [3.265503317797749, 1.0]], [1, [0.2316125567061752, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.77490236]
bas 1, expnt(s) = [7615.33078958]
bas 2, expnt(s) = [3612.45453404]
bas 3, expnt(s) = [1527.78312641]
bas 4, expnt(s) = [223.74331671]
bas 5, expnt(s) = [50.04205966]
bas 6, expnt(s) = [4.6041725]
bas 7, expnt(s) = [0.39775896]
bas 8, expnt(s) = [1362.8224692]
bas 9, expnt(s) = [664.33130836]
bas 10, expnt(s) = [299.06281173]
bas 11, expnt(s) = [312.42408648]
bas 12, expnt(s) = [79.90300519]
bas 13, expnt(s) = [8.79699358]
bas 14, expnt(s) = [25.24184196]
bas 15, expnt(s) = [0.81765865]
bas 16, expnt(s) = [3.26550332]
bas 17, expnt(s) = [0.23161256]
CPU time:       466.69
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827749e+04 5.20028060e+03 7.61533079e+03 2.05959393e+03
 3.61245453e+03 1.17724490e+03 1.52778313e+03 6.17392438e+02
 2.23743317e+02 1.46159678e+02 5.00420597e+01 4.75353183e+01
 4.60417250e+00 7.94106433e+00 3.97758963e-01 1.26540634e+00
 1.36282247e+03 2.41564716e+04 6.64331308e+02 9.83932470e+03
 2.99062812e+02 3.62816816e+03 3.12424086e+02 3.83190760e+03
 7.99030052e+01 6.96928596e+02 8.79699358e+00 4.41979612e+01
 2.52418420e+01 1.65057665e+02 8.17658653e-01 2.26829449e+00
 3.26550332e+00 1.28062523e+01 2.31612557e-01 4.68745399e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97256212316397
cond(S) = 128581.99413100105
E1 = -727.48614398181  E_coul = 203.09830987366672
init E= -524.387834108143
    CPU time for initialize scf      0.66 sec, wall time      0.08 sec
  HOMO = -0.559353499103955  LUMO = 1.10362162747035
  mo_energy =
[-1.17898083e+02 -1.20897068e+01 -9.44873972e+00 -9.44873972e+00
 -9.44873972e+00 -1.22984298e+00 -5.59353499e-01 -5.59353499e-01
 -5.59353499e-01  1.10362163e+00  1.10362163e+00  1.10362163e+00
  8.81074119e+00  8.81074119e+00  8.81074119e+00  4.22887112e+01
  4.22887112e+01  4.22887112e+01  1.65951347e+02  1.65951347e+02
  1.65951347e+02  1.68530751e+02  5.53802475e+02  5.53802475e+02
  5.53802475e+02  1.41314824e+03  1.41314824e+03  1.41314824e+03
  1.80678412e+03  3.10376681e+03  3.10376681e+03  3.10376681e+03
  6.71656668e+03  6.71656668e+03  6.71656668e+03  8.01205483e+03
  2.42850882e+04  7.50425827e+04]
E1 = -727.3735666052287  E_coul = 201.79032257626102
cycle= 1 E= -525.583244028968  delta_E= -1.2  |g|= 0.198  |ddm|= 0.409
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.487745
diis-c [-0.23789491  1.        ]
  HOMO = -0.571575709168955  LUMO = 1.09617414198476
  mo_energy =
[-1.18146139e+02 -1.21771105e+01 -9.53617270e+00 -9.53617270e+00
 -9.53617270e+00 -1.25008780e+00 -5.71575709e-01 -5.71575709e-01
 -5.71575709e-01  1.09617414e+00  1.09617414e+00  1.09617414e+00
  8.75643326e+00  8.75643326e+00  8.75643326e+00  4.21826138e+01
  4.21826138e+01  4.21826138e+01  1.65776878e+02  1.65776878e+02
  1.65776878e+02  1.68342084e+02  5.53567284e+02  5.53567284e+02
  5.53567284e+02  1.41286260e+03  1.41286260e+03  1.41286260e+03
  1.80636872e+03  3.10341377e+03  3.10341377e+03  3.10341377e+03
  6.71608584e+03  6.71608584e+03  6.71608584e+03  8.01148472e+03
  2.42844164e+04  7.50418148e+04]
E1 = -727.5855206539622  E_coul = 202.00207363685075
cycle= 2 E= -525.583447017111  delta_E= -0.000203  |g|= 0.0161  |ddm|= 0.0146
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0324366
diis-c [-7.91411678e-04  3.20958795e-02  9.67904121e-01]
  HOMO = -0.568914691553742  LUMO = 1.09841885770684
  mo_energy =
[-1.18115147e+02 -1.21622981e+01 -9.52112585e+00 -9.52112585e+00
 -9.52112585e+00 -1.24652209e+00 -5.68914692e-01 -5.68914692e-01
 -5.68914692e-01  1.09841886e+00  1.09841886e+00  1.09841886e+00
  8.76555931e+00  8.76555931e+00  8.76555931e+00  4.21999501e+01
  4.21999501e+01  4.21999501e+01  1.65802574e+02  1.65802574e+02
  1.65802574e+02  1.68371512e+02  5.53597889e+02  5.53597889e+02
  5.53597889e+02  1.41289525e+03  1.41289525e+03  1.41289525e+03
  1.80640293e+03  3.10344755e+03  3.10344755e+03  3.10344755e+03
  6.71612025e+03  6.71612025e+03  6.71612025e+03  8.01151936e+03
  2.42844510e+04  7.50418494e+04]
E1 = -727.542147635172  E_coul = 201.95869431677588
cycle= 3 E= -525.583453318396  delta_E= -6.3e-06  |g|= 0.00218  |ddm|= 0.00375
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00461434
diis-c [-9.68961708e-08 -8.11545505e-04  1.19203633e-01  8.81607912e-01]
  HOMO = -0.569436498844698  LUMO = 1.09799354681214
  mo_energy =
[-1.18119268e+02 -1.21645766e+01 -9.52345425e+00 -9.52345425e+00
 -9.52345425e+00 -1.24720880e+00 -5.69436499e-01 -5.69436499e-01
 -5.69436499e-01  1.09799355e+00  1.09799355e+00  1.09799355e+00
  8.76401897e+00  8.76401897e+00  8.76401897e+00  4.21973794e+01
  4.21973794e+01  4.21973794e+01  1.65799051e+02  1.65799051e+02
  1.65799051e+02  1.68367626e+02  5.53593819e+02  5.53593819e+02
  5.53593819e+02  1.41289094e+03  1.41289094e+03  1.41289094e+03
  1.80639838e+03  3.10344308e+03  3.10344308e+03  3.10344308e+03
  6.71611563e+03  6.71611563e+03  6.71611563e+03  8.01151466e+03
  2.42844463e+04  7.50418446e+04]
E1 = -727.548547291597  E_coul = 201.96509380379996
cycle= 4 E= -525.583453487797  delta_E= -1.69e-07  |g|= 3.91e-05  |ddm|= 0.000605
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.79408e-05
diis-c [-5.10488319e-10 -2.59772261e-05  3.23516920e-03  3.72146830e-02
  9.59576125e-01]
  HOMO = -0.569413555285738  LUMO = 1.09801173738012
  mo_energy =
[-1.18119179e+02 -1.21645019e+01 -9.52337887e+00 -9.52337887e+00
 -9.52337887e+00 -1.24717898e+00 -5.69413555e-01 -5.69413555e-01
 -5.69413555e-01  1.09801174e+00  1.09801174e+00  1.09801174e+00
  8.76407624e+00  8.76407624e+00  8.76407624e+00  4.21974558e+01
  4.21974558e+01  4.21974558e+01  1.65799137e+02  1.65799137e+02
  1.65799137e+02  1.68367715e+02  5.53593908e+02  5.53593908e+02
  5.53593908e+02  1.41289102e+03  1.41289102e+03  1.41289102e+03
  1.80639847e+03  3.10344317e+03  3.10344317e+03  3.10344317e+03
  6.71611572e+03  6.71611572e+03  6.71611572e+03  8.01151474e+03
  2.42844464e+04  7.50418447e+04]
E1 = -727.5483626732969  E_coul = 201.96490918536975
cycle= 5 E= -525.583453487927  delta_E= -1.3e-10  |g|= 2.81e-06  |ddm|= 2.06e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5483626732969  E_coul = 201.96490918536975
  HOMO = -0.569415064563808  LUMO = 1.098010540123
  mo_energy =
[-1.18119186e+02 -1.21645072e+01 -9.52338427e+00 -9.52338427e+00
 -9.52338427e+00 -1.24718096e+00 -5.69415065e-01 -5.69415065e-01
 -5.69415065e-01  1.09801054e+00  1.09801054e+00  1.09801054e+00
  8.76407232e+00  8.76407232e+00  8.76407232e+00  4.21974503e+01
  4.21974503e+01  4.21974503e+01  1.65799130e+02  1.65799130e+02
  1.65799130e+02  1.68367708e+02  5.53593901e+02  5.53593901e+02
  5.53593901e+02  1.41289102e+03  1.41289102e+03  1.41289102e+03
  1.80639846e+03  3.10344316e+03  3.10344316e+03  3.10344316e+03
  6.71611571e+03  6.71611571e+03  6.71611571e+03  8.01151474e+03
  2.42844464e+04  7.50418446e+04]
E1 = -727.54837640896  E_coul = 201.96492292103434
Extra cycle  E= -525.583453487926  delta_E= 1.48e-12  |g|= 6.92e-07  |ddm|= 1.49e-06
    CPU time for scf_cycle      0.85 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 128581.99413100105
E1 = -727.54837640896  E_coul = 201.96492292103434
init E= -525.583453487926
    CPU time for initialize scf      1.81 sec, wall time      0.26 sec
  HOMO = -0.569414804742086  LUMO = 1.09801074964332
  mo_energy =
[-1.18119184e+02 -1.21645062e+01 -9.52338324e+00 -9.52338324e+00
 -9.52338324e+00 -1.24718062e+00 -5.69414805e-01 -5.69414805e-01
 -5.69414805e-01  1.09801075e+00  1.09801075e+00  1.09801075e+00
  8.76407304e+00  8.76407304e+00  8.76407304e+00  4.21974514e+01
  4.21974514e+01  4.21974514e+01  1.65799132e+02  1.65799132e+02
  1.65799132e+02  1.68367709e+02  5.53593903e+02  5.53593903e+02
  5.53593903e+02  1.41289102e+03  1.41289102e+03  1.41289102e+03
  1.80639846e+03  3.10344316e+03  3.10344316e+03  3.10344316e+03
  6.71611571e+03  6.71611571e+03  6.71611571e+03  8.01151474e+03
  2.42844464e+04  7.50418446e+04]
E1 = -727.5483736719102  E_coul = 201.964920183983
cycle= 1 E= -525.583453487927  delta_E= -1.59e-12  |g|= 1.48e-07  |ddm|= 2.72e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.5483736719102  E_coul = 201.964920183983
  HOMO = -0.569414853749911  LUMO = 1.0980107099672
  mo_energy =
[-1.18119185e+02 -1.21645064e+01 -9.52338344e+00 -9.52338344e+00
 -9.52338344e+00 -1.24718068e+00 -5.69414854e-01 -5.69414854e-01
 -5.69414854e-01  1.09801071e+00  1.09801071e+00  1.09801071e+00
  8.76407290e+00  8.76407290e+00  8.76407290e+00  4.21974511e+01
  4.21974511e+01  4.21974511e+01  1.65799131e+02  1.65799131e+02
  1.65799131e+02  1.68367709e+02  5.53593902e+02  5.53593902e+02
  5.53593902e+02  1.41289102e+03  1.41289102e+03  1.41289102e+03
  1.80639846e+03  3.10344316e+03  3.10344316e+03  3.10344316e+03
  6.71611571e+03  6.71611571e+03  6.71611571e+03  8.01151474e+03
  2.42844464e+04  7.50418446e+04]
E1 = -727.5483742238314  E_coul = 201.96492073590426
Extra cycle  E= -525.583453487927  delta_E= 1.14e-13  |g|= 3.06e-08  |ddm|= 5.4e-08
    CPU time for scf_cycle      1.93 sec, wall time      0.38 sec
exp = [2.61827749e+04 7.61533079e+03 3.61245453e+03 1.52778313e+03
 2.23743317e+02 5.00420597e+01 4.60417250e+00 3.97758963e-01
 1.36282247e+03 6.64331308e+02 2.99062812e+02 3.12424086e+02
 7.99030052e+01 8.79699358e+00 2.52418420e+01 8.17658653e-01
 3.26550332e+00 2.31612557e-01]
grad_E = [-1.99264433e-06  2.53228159e-05  5.07944021e-05  9.46120626e-04
 -4.54280244e-03  2.35072431e-04  4.92536556e-04  1.93227294e-03
 -4.40041107e-07  7.83342882e-08 -8.31969784e-07 -4.37023345e-07
  4.73468698e-04 -2.14305025e-03 -3.16256674e-05 -1.84711466e-03
  6.28823387e-03 -9.76380977e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8016117        1
[INPUT] 0    0    [1    /1   ]  7615.03682228        1
[INPUT] 0    0    [1    /1   ]  3611.86839741        1
[INPUT] 0    0    [1    /1   ]  1518.68135396        1
[INPUT] 0    0    [1    /1   ]  223.292257587        1
[INPUT] 0    0    [1    /1   ]  50.0152662603        1
[INPUT] 0    0    [1    /1   ]  4.60487116378        1
[INPUT] 0    0    [1    /1   ]  0.397831742949       1
[INPUT] 1    0    [1    /1   ]  1362.81669932        1
[INPUT] 1    0    [1    /1   ]  664.172798283        1
[INPUT] 1    0    [1    /1   ]  298.220028124        1
[INPUT] 1    0    [1    /1   ]  311.683379497        1
[INPUT] 1    0    [1    /1   ]  92.0014881053        1
[INPUT] 1    0    [1    /1   ]  9.50294244378        1
[INPUT] 1    0    [1    /1   ]  27.9139208046        1
[INPUT] 1    0    [1    /1   ]  0.834954767658       1
[INPUT] 1    0    [1    /1   ]  3.45977653712        1
[INPUT] 1    0    [1    /1   ]  0.235359116998       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.80161173574, 1.0]], [0, [7615.036822283141, 1.0]], [0, [3611.868397405861, 1.0]], [0, [1518.6813539591437, 1.0]], [0, [223.2922575873119, 1.0]], [0, [50.01526626029272, 1.0]], [0, [4.6048711637755915, 1.0]], [0, [0.3978317429491384, 1.0]], [1, [1362.8166993195264, 1.0]], [1, [664.1727982825416, 1.0]], [1, [298.2200281239686, 1.0]], [1, [311.6833794966352, 1.0]], [1, [92.0014881052525, 1.0]], [1, [9.502942443775595, 1.0]], [1, [27.913920804647738, 1.0]], [1, [0.8349547676580186, 1.0]], [1, [3.459776537122814, 1.0]], [1, [0.235359116997696, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.80161174]
bas 1, expnt(s) = [7615.03682228]
bas 2, expnt(s) = [3611.86839741]
bas 3, expnt(s) = [1518.68135396]
bas 4, expnt(s) = [223.29225759]
bas 5, expnt(s) = [50.01526626]
bas 6, expnt(s) = [4.60487116]
bas 7, expnt(s) = [0.39783174]
bas 8, expnt(s) = [1362.81669932]
bas 9, expnt(s) = [664.17279828]
bas 10, expnt(s) = [298.22002812]
bas 11, expnt(s) = [311.6833795]
bas 12, expnt(s) = [92.00148811]
bas 13, expnt(s) = [9.50294244]
bas 14, expnt(s) = [27.9139208]
bas 15, expnt(s) = [0.83495477]
bas 16, expnt(s) = [3.45977654]
bas 17, expnt(s) = [0.23535912]
CPU time:       473.96
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828016e+04 5.20028458e+03 7.61503682e+03 2.05953430e+03
 3.61186840e+03 1.17710163e+03 1.51868135e+03 6.14631791e+02
 2.23292258e+02 1.45938633e+02 5.00152663e+01 4.75162286e+01
 4.60487116e+00 7.94196808e+00 3.97831743e-01 1.26557999e+00
 1.36281670e+03 2.41563437e+04 6.64172798e+02 9.83639020e+03
 2.98220028e+02 3.61539207e+03 3.11683379e+02 3.82055493e+03
 9.20014881e+01 8.31242917e+02 9.50294244e+00 4.86751184e+01
 2.79139208e+01 1.87180432e+02 8.34954768e-01 2.32842942e+00
 3.45977654e+00 1.37655781e+01 2.35359117e-01 4.78242508e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.971665045281206
cond(S) = 155029.8213298396
E1 = -727.4890362618906  E_coul = 203.10086121501976
init E= -524.388175046871
    CPU time for initialize scf      0.66 sec, wall time      0.08 sec
  HOMO = -0.559133435725153  LUMO = 1.13574447916145
  mo_energy =
[-1.17900661e+02 -1.20897643e+01 -9.44784058e+00 -9.44784058e+00
 -9.44784058e+00 -1.22991620e+00 -5.59133436e-01 -5.59133436e-01
 -5.59133436e-01  1.13574448e+00  1.13574448e+00  1.13574448e+00
  9.50709160e+00  9.50709160e+00  9.50709160e+00  4.68023856e+01
  4.68023856e+01  4.68023856e+01  1.68205501e+02  1.86267678e+02
  1.86267678e+02  1.86267678e+02  5.94693299e+02  5.94693299e+02
  5.94693299e+02  1.46208628e+03  1.46208628e+03  1.46208628e+03
  1.79996786e+03  3.15302547e+03  3.15302547e+03  3.15302547e+03
  6.76223399e+03  6.76223399e+03  6.76223399e+03  7.99013652e+03
  2.42517041e+04  7.50052075e+04]
E1 = -727.4007948100898  E_coul = 201.81625492884285
cycle= 1 E= -525.584539881247  delta_E= -1.2  |g|= 0.197  |ddm|= 0.465
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.486039
diis-c [-0.23623357  1.        ]
  HOMO = -0.570693723086235  LUMO = 1.1284121556613
  mo_energy =
[-1.18146105e+02 -1.21756152e+01 -9.53368233e+00 -9.53368233e+00
 -9.53368233e+00 -1.24941151e+00 -5.70693723e-01 -5.70693723e-01
 -5.70693723e-01  1.12841216e+00  1.12841216e+00  1.12841216e+00
  9.45113019e+00  9.45113019e+00  9.45113019e+00  4.66925224e+01
  4.66925224e+01  4.66925224e+01  1.68019413e+02  1.86089340e+02
  1.86089340e+02  1.86089340e+02  5.94459616e+02  5.94459616e+02
  5.94459616e+02  1.46180403e+03  1.46180403e+03  1.46180403e+03
  1.79955630e+03  3.15267626e+03  3.15267626e+03  3.15267626e+03
  6.76175710e+03  6.76175710e+03  6.76175710e+03  7.98957030e+03
  2.42510361e+04  7.50044436e+04]
E1 = -727.6069723330093  E_coul = 202.02223522845426
cycle= 2 E= -525.584737104555  delta_E= -0.000197  |g|= 0.0158  |ddm|= 0.0144
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0315578
diis-c [-7.55224338e-04  3.09791682e-02  9.69020832e-01]
  HOMO = -0.568128413033228  LUMO = 1.13065349351212
  mo_energy =
[-1.18115749e+02 -1.21612047e+01 -9.51904446e+00 -9.51904446e+00
 -9.51904446e+00 -1.24597367e+00 -5.68128413e-01 -5.68128413e-01
 -5.68128413e-01  1.13065349e+00  1.13065349e+00  1.13065349e+00
  9.46046616e+00  9.46046616e+00  9.46046616e+00  4.67102183e+01
  4.67102183e+01  4.67102183e+01  1.68048224e+02  1.86115112e+02
  1.86115112e+02  1.86115112e+02  5.94489681e+02  5.94489681e+02
  5.94489681e+02  1.46183599e+03  1.46183599e+03  1.46183599e+03
  1.79958983e+03  3.15270935e+03  3.15270935e+03  3.15270935e+03
  6.76179082e+03  6.76179082e+03  6.76179082e+03  7.98960426e+03
  2.42510701e+04  7.50044774e+04]
E1 = -727.564994711416  E_coul = 201.98025163794222
cycle= 3 E= -525.584743073474  delta_E= -5.97e-06  |g|= 0.00213  |ddm|= 0.00366
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00448475
diis-c [-9.12525643e-08 -8.00497222e-04  1.19088348e-01  8.81712149e-01]
  HOMO = -0.568632992816547  LUMO = 1.13022861257972
  mo_energy =
[-1.18119782e+02 -1.21634238e+01 -9.52131251e+00 -9.52131251e+00
 -9.52131251e+00 -1.24663844e+00 -5.68632993e-01 -5.68632993e-01
 -5.68632993e-01  1.13022861e+00  1.13022861e+00  1.13022861e+00
  9.45890305e+00  9.45890305e+00  9.45890305e+00  4.67076193e+01
  4.67076193e+01  4.67076193e+01  1.68044423e+02  1.86111598e+02
  1.86111598e+02  1.86111598e+02  5.94485688e+02  5.94485688e+02
  5.94485688e+02  1.46183177e+03  1.46183177e+03  1.46183177e+03
  1.79958537e+03  3.15270498e+03  3.15270498e+03  3.15270498e+03
  6.76178630e+03  6.76178630e+03  6.76178630e+03  7.98959966e+03
  2.42510654e+04  7.50044727e+04]
E1 = -727.5711929495113  E_coul = 201.9864497157824
cycle= 4 E= -525.584743233729  delta_E= -1.6e-07  |g|= 3.84e-05  |ddm|= 0.000592
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.56491e-05
diis-c [-5.04986693e-10 -2.39749297e-05  3.03060444e-03  3.56319204e-02
  9.61361450e-01]
  HOMO = -0.568610519104916  LUMO = 1.13024698078624
  mo_energy =
[-1.18119694e+02 -1.21633506e+01 -9.52123864e+00 -9.52123864e+00
 -9.52123864e+00 -1.24660925e+00 -5.68610519e-01 -5.68610519e-01
 -5.68610519e-01  1.13024698e+00  1.13024698e+00  1.13024698e+00
  9.45896088e+00  9.45896088e+00  9.45896088e+00  4.67076954e+01
  4.67076954e+01  4.67076954e+01  1.68044511e+02  1.86111683e+02
  1.86111683e+02  1.86111683e+02  5.94485776e+02  5.94485776e+02
  5.94485776e+02  1.46183186e+03  1.46183186e+03  1.46183186e+03
  1.79958546e+03  3.15270507e+03  3.15270507e+03  3.15270507e+03
  6.76178639e+03  6.76178639e+03  6.76178639e+03  7.98959974e+03
  2.42510655e+04  7.50044728e+04]
E1 = -727.5710135753166  E_coul = 201.9862703414661
cycle= 5 E= -525.58474323385  delta_E= -1.22e-10  |g|= 2.83e-06  |ddm|= 2.02e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5710135753166  E_coul = 201.9862703414661
  HOMO = -0.568612030724462  LUMO = 1.13024574420566
  mo_energy =
[-1.18119701e+02 -1.21633560e+01 -9.52124407e+00 -9.52124407e+00
 -9.52124407e+00 -1.24661122e+00 -5.68612031e-01 -5.68612031e-01
 -5.68612031e-01  1.13024574e+00  1.13024574e+00  1.13024574e+00
  9.45895680e+00  9.45895680e+00  9.45895680e+00  4.67076897e+01
  4.67076897e+01  4.67076897e+01  1.68044504e+02  1.86111676e+02
  1.86111676e+02  1.86111676e+02  5.94485768e+02  5.94485768e+02
  5.94485768e+02  1.46183186e+03  1.46183186e+03  1.46183186e+03
  1.79958545e+03  3.15270506e+03  3.15270506e+03  3.15270506e+03
  6.76178638e+03  6.76178638e+03  6.76178638e+03  7.98959974e+03
  2.42510655e+04  7.50044728e+04]
E1 = -727.5710272944691  E_coul = 201.98628406061835
Extra cycle  E= -525.584743233851  delta_E= -3.41e-13  |g|= 6.93e-07  |ddm|= 1.51e-06
    CPU time for scf_cycle      0.80 sec, wall time      0.23 sec
exp = [2.61828016e+04 7.61503682e+03 3.61186840e+03 1.51868135e+03
 2.23292258e+02 5.00152663e+01 4.60487116e+00 3.97831743e-01
 1.36281670e+03 6.64172798e+02 2.98220028e+02 3.11683379e+02
 9.20014881e+01 9.50294244e+00 2.79139208e+01 8.34954768e-01
 3.45977654e+00 2.35359117e-01]
E = -525.5847432338508
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8016117        1
[INPUT] 0    0    [1    /1   ]  7615.03682228        1
[INPUT] 0    0    [1    /1   ]  3611.86839741        1
[INPUT] 0    0    [1    /1   ]  1518.68135396        1
[INPUT] 0    0    [1    /1   ]  223.292257587        1
[INPUT] 0    0    [1    /1   ]  50.0152662603        1
[INPUT] 0    0    [1    /1   ]  4.60487116378        1
[INPUT] 0    0    [1    /1   ]  0.397831742949       1
[INPUT] 1    0    [1    /1   ]  1362.81669932        1
[INPUT] 1    0    [1    /1   ]  664.172798283        1
[INPUT] 1    0    [1    /1   ]  298.220028124        1
[INPUT] 1    0    [1    /1   ]  311.683379497        1
[INPUT] 1    0    [1    /1   ]  92.0014881053        1
[INPUT] 1    0    [1    /1   ]  9.50294244378        1
[INPUT] 1    0    [1    /1   ]  27.9139208046        1
[INPUT] 1    0    [1    /1   ]  0.834954767658       1
[INPUT] 1    0    [1    /1   ]  3.45977653712        1
[INPUT] 1    0    [1    /1   ]  0.235359116998       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.80161173574, 1.0]], [0, [7615.036822283141, 1.0]], [0, [3611.868397405861, 1.0]], [0, [1518.6813539591437, 1.0]], [0, [223.2922575873119, 1.0]], [0, [50.01526626029272, 1.0]], [0, [4.6048711637755915, 1.0]], [0, [0.3978317429491384, 1.0]], [1, [1362.8166993195264, 1.0]], [1, [664.1727982825416, 1.0]], [1, [298.2200281239686, 1.0]], [1, [311.6833794966352, 1.0]], [1, [92.0014881052525, 1.0]], [1, [9.502942443775595, 1.0]], [1, [27.913920804647738, 1.0]], [1, [0.8349547676580186, 1.0]], [1, [3.459776537122814, 1.0]], [1, [0.235359116997696, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.80161174]
bas 1, expnt(s) = [7615.03682228]
bas 2, expnt(s) = [3611.86839741]
bas 3, expnt(s) = [1518.68135396]
bas 4, expnt(s) = [223.29225759]
bas 5, expnt(s) = [50.01526626]
bas 6, expnt(s) = [4.60487116]
bas 7, expnt(s) = [0.39783174]
bas 8, expnt(s) = [1362.81669932]
bas 9, expnt(s) = [664.17279828]
bas 10, expnt(s) = [298.22002812]
bas 11, expnt(s) = [311.6833795]
bas 12, expnt(s) = [92.00148811]
bas 13, expnt(s) = [9.50294244]
bas 14, expnt(s) = [27.9139208]
bas 15, expnt(s) = [0.83495477]
bas 16, expnt(s) = [3.45977654]
bas 17, expnt(s) = [0.23535912]
CPU time:       475.11
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828016e+04 5.20028458e+03 7.61503682e+03 2.05953430e+03
 3.61186840e+03 1.17710163e+03 1.51868135e+03 6.14631791e+02
 2.23292258e+02 1.45938633e+02 5.00152663e+01 4.75162286e+01
 4.60487116e+00 7.94196808e+00 3.97831743e-01 1.26557999e+00
 1.36281670e+03 2.41563437e+04 6.64172798e+02 9.83639020e+03
 2.98220028e+02 3.61539207e+03 3.11683379e+02 3.82055493e+03
 9.20014881e+01 8.31242917e+02 9.50294244e+00 4.86751184e+01
 2.79139208e+01 1.87180432e+02 8.34954768e-01 2.32842942e+00
 3.45977654e+00 1.37655781e+01 2.35359117e-01 4.78242508e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.971665045281206
cond(S) = 155029.8213298396
E1 = -727.4890362618906  E_coul = 203.10086121501976
init E= -524.388175046871
    CPU time for initialize scf      0.65 sec, wall time      0.08 sec
  HOMO = -0.559133435725153  LUMO = 1.13574447916145
  mo_energy =
[-1.17900661e+02 -1.20897643e+01 -9.44784058e+00 -9.44784058e+00
 -9.44784058e+00 -1.22991620e+00 -5.59133436e-01 -5.59133436e-01
 -5.59133436e-01  1.13574448e+00  1.13574448e+00  1.13574448e+00
  9.50709160e+00  9.50709160e+00  9.50709160e+00  4.68023856e+01
  4.68023856e+01  4.68023856e+01  1.68205501e+02  1.86267678e+02
  1.86267678e+02  1.86267678e+02  5.94693299e+02  5.94693299e+02
  5.94693299e+02  1.46208628e+03  1.46208628e+03  1.46208628e+03
  1.79996786e+03  3.15302547e+03  3.15302547e+03  3.15302547e+03
  6.76223399e+03  6.76223399e+03  6.76223399e+03  7.99013652e+03
  2.42517041e+04  7.50052075e+04]
E1 = -727.4007948100898  E_coul = 201.81625492884285
cycle= 1 E= -525.584539881247  delta_E= -1.2  |g|= 0.197  |ddm|= 0.465
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.486039
diis-c [-0.23623357  1.        ]
  HOMO = -0.570693723086235  LUMO = 1.1284121556613
  mo_energy =
[-1.18146105e+02 -1.21756152e+01 -9.53368233e+00 -9.53368233e+00
 -9.53368233e+00 -1.24941151e+00 -5.70693723e-01 -5.70693723e-01
 -5.70693723e-01  1.12841216e+00  1.12841216e+00  1.12841216e+00
  9.45113019e+00  9.45113019e+00  9.45113019e+00  4.66925224e+01
  4.66925224e+01  4.66925224e+01  1.68019413e+02  1.86089340e+02
  1.86089340e+02  1.86089340e+02  5.94459616e+02  5.94459616e+02
  5.94459616e+02  1.46180403e+03  1.46180403e+03  1.46180403e+03
  1.79955630e+03  3.15267626e+03  3.15267626e+03  3.15267626e+03
  6.76175710e+03  6.76175710e+03  6.76175710e+03  7.98957030e+03
  2.42510361e+04  7.50044436e+04]
E1 = -727.6069723330093  E_coul = 202.02223522845426
cycle= 2 E= -525.584737104555  delta_E= -0.000197  |g|= 0.0158  |ddm|= 0.0144
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0315578
diis-c [-7.55224338e-04  3.09791682e-02  9.69020832e-01]
  HOMO = -0.568128413033228  LUMO = 1.13065349351212
  mo_energy =
[-1.18115749e+02 -1.21612047e+01 -9.51904446e+00 -9.51904446e+00
 -9.51904446e+00 -1.24597367e+00 -5.68128413e-01 -5.68128413e-01
 -5.68128413e-01  1.13065349e+00  1.13065349e+00  1.13065349e+00
  9.46046616e+00  9.46046616e+00  9.46046616e+00  4.67102183e+01
  4.67102183e+01  4.67102183e+01  1.68048224e+02  1.86115112e+02
  1.86115112e+02  1.86115112e+02  5.94489681e+02  5.94489681e+02
  5.94489681e+02  1.46183599e+03  1.46183599e+03  1.46183599e+03
  1.79958983e+03  3.15270935e+03  3.15270935e+03  3.15270935e+03
  6.76179082e+03  6.76179082e+03  6.76179082e+03  7.98960426e+03
  2.42510701e+04  7.50044774e+04]
E1 = -727.564994711416  E_coul = 201.98025163794222
cycle= 3 E= -525.584743073474  delta_E= -5.97e-06  |g|= 0.00213  |ddm|= 0.00366
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00448475
diis-c [-9.12525643e-08 -8.00497222e-04  1.19088348e-01  8.81712149e-01]
  HOMO = -0.568632992816547  LUMO = 1.13022861257972
  mo_energy =
[-1.18119782e+02 -1.21634238e+01 -9.52131251e+00 -9.52131251e+00
 -9.52131251e+00 -1.24663844e+00 -5.68632993e-01 -5.68632993e-01
 -5.68632993e-01  1.13022861e+00  1.13022861e+00  1.13022861e+00
  9.45890305e+00  9.45890305e+00  9.45890305e+00  4.67076193e+01
  4.67076193e+01  4.67076193e+01  1.68044423e+02  1.86111598e+02
  1.86111598e+02  1.86111598e+02  5.94485688e+02  5.94485688e+02
  5.94485688e+02  1.46183177e+03  1.46183177e+03  1.46183177e+03
  1.79958537e+03  3.15270498e+03  3.15270498e+03  3.15270498e+03
  6.76178630e+03  6.76178630e+03  6.76178630e+03  7.98959966e+03
  2.42510654e+04  7.50044727e+04]
E1 = -727.5711929495113  E_coul = 201.9864497157824
cycle= 4 E= -525.584743233729  delta_E= -1.6e-07  |g|= 3.84e-05  |ddm|= 0.000592
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.56491e-05
diis-c [-5.04986693e-10 -2.39749297e-05  3.03060444e-03  3.56319204e-02
  9.61361450e-01]
  HOMO = -0.568610519104916  LUMO = 1.13024698078624
  mo_energy =
[-1.18119694e+02 -1.21633506e+01 -9.52123864e+00 -9.52123864e+00
 -9.52123864e+00 -1.24660925e+00 -5.68610519e-01 -5.68610519e-01
 -5.68610519e-01  1.13024698e+00  1.13024698e+00  1.13024698e+00
  9.45896088e+00  9.45896088e+00  9.45896088e+00  4.67076954e+01
  4.67076954e+01  4.67076954e+01  1.68044511e+02  1.86111683e+02
  1.86111683e+02  1.86111683e+02  5.94485776e+02  5.94485776e+02
  5.94485776e+02  1.46183186e+03  1.46183186e+03  1.46183186e+03
  1.79958546e+03  3.15270507e+03  3.15270507e+03  3.15270507e+03
  6.76178639e+03  6.76178639e+03  6.76178639e+03  7.98959974e+03
  2.42510655e+04  7.50044728e+04]
E1 = -727.5710135753166  E_coul = 201.9862703414661
cycle= 5 E= -525.58474323385  delta_E= -1.22e-10  |g|= 2.83e-06  |ddm|= 2.02e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.5710135753166  E_coul = 201.9862703414661
  HOMO = -0.568612030724462  LUMO = 1.13024574420566
  mo_energy =
[-1.18119701e+02 -1.21633560e+01 -9.52124407e+00 -9.52124407e+00
 -9.52124407e+00 -1.24661122e+00 -5.68612031e-01 -5.68612031e-01
 -5.68612031e-01  1.13024574e+00  1.13024574e+00  1.13024574e+00
  9.45895680e+00  9.45895680e+00  9.45895680e+00  4.67076897e+01
  4.67076897e+01  4.67076897e+01  1.68044504e+02  1.86111676e+02
  1.86111676e+02  1.86111676e+02  5.94485768e+02  5.94485768e+02
  5.94485768e+02  1.46183186e+03  1.46183186e+03  1.46183186e+03
  1.79958545e+03  3.15270506e+03  3.15270506e+03  3.15270506e+03
  6.76178638e+03  6.76178638e+03  6.76178638e+03  7.98959974e+03
  2.42510655e+04  7.50044728e+04]
E1 = -727.5710272944691  E_coul = 201.98628406061835
Extra cycle  E= -525.584743233851  delta_E= -3.41e-13  |g|= 6.93e-07  |ddm|= 1.51e-06
    CPU time for scf_cycle      0.79 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 155029.8213298396
E1 = -727.5710272944691  E_coul = 201.98628406061835
init E= -525.584743233851
    CPU time for initialize scf      1.74 sec, wall time      0.25 sec
  HOMO = -0.568611771962081  LUMO = 1.13024595954133
  mo_energy =
[-1.18119699e+02 -1.21633549e+01 -9.52124304e+00 -9.52124304e+00
 -9.52124304e+00 -1.24661089e+00 -5.68611772e-01 -5.68611772e-01
 -5.68611772e-01  1.13024596e+00  1.13024596e+00  1.13024596e+00
  9.45895754e+00  9.45895754e+00  9.45895754e+00  4.67076908e+01
  4.67076908e+01  4.67076908e+01  1.68044505e+02  1.86111677e+02
  1.86111677e+02  1.86111677e+02  5.94485770e+02  5.94485770e+02
  5.94485770e+02  1.46183186e+03  1.46183186e+03  1.46183186e+03
  1.79958545e+03  3.15270506e+03  3.15270506e+03  3.15270506e+03
  6.76178638e+03  6.76178638e+03  6.76178638e+03  7.98959974e+03
  2.42510655e+04  7.50044728e+04]
E1 = -727.5710245804029  E_coul = 201.9862813465515
cycle= 1 E= -525.584743233851  delta_E= -6.82e-13  |g|= 1.47e-07  |ddm|= 2.73e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.5710245804029  E_coul = 201.9862813465515
  HOMO = -0.568611820381274  LUMO = 1.13024591907556
  mo_energy =
[-1.18119700e+02 -1.21633551e+01 -9.52124324e+00 -9.52124324e+00
 -9.52124324e+00 -1.24661095e+00 -5.68611820e-01 -5.68611820e-01
 -5.68611820e-01  1.13024592e+00  1.13024592e+00  1.13024592e+00
  9.45895740e+00  9.45895740e+00  9.45895740e+00  4.67076906e+01
  4.67076906e+01  4.67076906e+01  1.68044505e+02  1.86111677e+02
  1.86111677e+02  1.86111677e+02  5.94485770e+02  5.94485770e+02
  5.94485770e+02  1.46183186e+03  1.46183186e+03  1.46183186e+03
  1.79958545e+03  3.15270506e+03  3.15270506e+03  3.15270506e+03
  6.76178638e+03  6.76178638e+03  6.76178638e+03  7.98959974e+03
  2.42510655e+04  7.50044728e+04]
E1 = -727.5710251238407  E_coul = 201.98628188998927
Extra cycle  E= -525.584743233851  delta_E=    0  |g|= 3.03e-08  |ddm|= 5.37e-08
    CPU time for scf_cycle      1.87 sec, wall time      0.38 sec
exp = [2.61828016e+04 7.61503682e+03 3.61186840e+03 1.51868135e+03
 2.23292258e+02 5.00152663e+01 4.60487116e+00 3.97831743e-01
 1.36281670e+03 6.64172798e+02 2.98220028e+02 3.11683379e+02
 9.20014881e+01 9.50294244e+00 2.79139208e+01 8.34954768e-01
 3.45977654e+00 2.35359117e-01]
grad_E = [-1.99662654e-06  2.50759425e-05  4.95840206e-05  9.53702877e-04
 -4.62455010e-03  7.82266602e-04  1.18234888e-03  4.28770477e-03
 -7.88660217e-08  1.56439458e-07  1.94634303e-06  2.32616894e-06
  3.98130431e-04 -4.50681273e-03  5.38508006e-04 -4.60878735e-03
  1.25075039e-02 -1.61406575e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.9859267        1
[INPUT] 0    0    [1    /1   ]  7613.00800201        1
[INPUT] 0    0    [1    /1   ]  3607.82293356        1
[INPUT] 0    0    [1    /1   ]  1455.86326015        1
[INPUT] 0    0    [1    /1   ]  220.35573556         1
[INPUT] 0    0    [1    /1   ]  49.8184874374        1
[INPUT] 0    0    [1    /1   ]  4.6077823872         1
[INPUT] 0    0    [1    /1   ]  0.397902335309       1
[INPUT] 1    0    [1    /1   ]  1362.77607445        1
[INPUT] 1    0    [1    /1   ]  663.072257675        1
[INPUT] 1    0    [1    /1   ]  292.365955041        1
[INPUT] 1    0    [1    /1   ]  306.53816385         1
[INPUT] 1    0    [1    /1   ]  176.57912226         1
[INPUT] 1    0    [1    /1   ]  13.9474368855        1
[INPUT] 1    0    [1    /1   ]  45.6684697562        1
[INPUT] 1    0    [1    /1   ]  0.94198051568        1
[INPUT] 1    0    [1    /1   ]  4.58075826961        1
[INPUT] 1    0    [1    /1   ]  0.259012559807       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.985926706955, 1.0]], [0, [7613.008002009596, 1.0]], [0, [3607.822933561608, 1.0]], [0, [1455.8632601528689, 1.0]], [0, [220.35573556047572, 1.0]], [0, [49.818487437448, 1.0]], [0, [4.607782387197121, 1.0]], [0, [0.39790233530933133, 1.0]], [1, [1362.7760744458872, 1.0]], [1, [663.0722576745711, 1.0]], [1, [292.3659550407207, 1.0]], [1, [306.5381638497539, 1.0]], [1, [176.57912226042177, 1.0]], [1, [13.947436885465375, 1.0]], [1, [45.668469756218286, 1.0]], [1, [0.9419805156801158, 1.0]], [1, [4.580758269605031, 1.0]], [1, [0.2590125598066534, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.98592671]
bas 1, expnt(s) = [7613.00800201]
bas 2, expnt(s) = [3607.82293356]
bas 3, expnt(s) = [1455.86326015]
bas 4, expnt(s) = [220.35573556]
bas 5, expnt(s) = [49.81848744]
bas 6, expnt(s) = [4.60778239]
bas 7, expnt(s) = [0.39790234]
bas 8, expnt(s) = [1362.77607445]
bas 9, expnt(s) = [663.07225767]
bas 10, expnt(s) = [292.36595504]
bas 11, expnt(s) = [306.53816385]
bas 12, expnt(s) = [176.57912226]
bas 13, expnt(s) = [13.94743689]
bas 14, expnt(s) = [45.66846976]
bas 15, expnt(s) = [0.94198052]
bas 16, expnt(s) = [4.58075827]
bas 17, expnt(s) = [0.25901256]
CPU time:       482.30
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61829859e+04 5.20031204e+03 7.61300800e+03 2.05912276e+03
 3.60782293e+03 1.17611269e+03 1.45586326e+03 5.95463936e+02
 2.20355736e+02 1.44496821e+02 4.98184874e+01 4.73759495e+01
 4.60778239e+00 7.94573350e+00 3.97902335e-01 1.26574841e+00
 1.36277607e+03 2.41554436e+04 6.63072258e+02 9.81602068e+03
 2.92365955e+02 3.52689793e+03 3.06538164e+02 3.74188195e+03
 1.76579122e+02 1.87784000e+03 1.39474369e+01 7.86325570e+01
 4.56684698e+01 3.46341846e+02 9.41980516e-01 2.70730255e+00
 4.58075827e+00 1.95504208e+01 2.59012560e-01 5.39057909e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.963139729435298
cond(S) = 756025.5767298399
E1 = -727.4588431157214  E_coul = 203.11641195395111
init E= -524.34243116177
    CPU time for initialize scf      0.66 sec, wall time      0.08 sec
  HOMO = -0.559402478689382  LUMO = 1.34839310476342
  mo_energy =
[-1.17919735e+02 -1.20887809e+01 -9.43646101e+00 -9.43646101e+00
 -9.43646101e+00 -1.23201491e+00 -5.59402479e-01 -5.59402479e-01
 -5.59402479e-01  1.34839310e+00  1.34839310e+00  1.34839310e+00
  1.42314102e+01  1.42314102e+01  1.42314102e+01  7.75010168e+01
  7.75010168e+01  7.75010168e+01  1.66026907e+02  3.01279592e+02
  3.01279592e+02  3.01279592e+02  8.23421552e+02  8.23421552e+02
  8.23421552e+02  1.75283269e+03  1.76832457e+03  1.76832457e+03
  1.76832457e+03  3.49138868e+03  3.49138868e+03  3.49138868e+03
  7.09275431e+03  7.09275431e+03  7.09275431e+03  7.83782606e+03
  2.40210003e+04  7.47478482e+04]
E1 = -727.7528216393092  E_coul = 202.17816853502285
cycle= 1 E= -525.574653104286  delta_E= -1.23  |g|= 0.191  |ddm|= 2.34
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.455571
diis-c [-0.20754449  1.        ]
  HOMO = -0.564984518994397  LUMO = 1.34435241096552
  mo_energy =
[-1.18116886e+02 -1.21499786e+01 -9.49739049e+00 -9.49739049e+00
 -9.49739049e+00 -1.24431728e+00 -5.64984519e-01 -5.64984519e-01
 -5.64984519e-01  1.34435241e+00  1.34435241e+00  1.34435241e+00
  1.41803208e+01  1.41803208e+01  1.41803208e+01  7.73987677e+01
  7.73987677e+01  7.73987677e+01  1.65887416e+02  3.01123569e+02
  3.01123569e+02  3.01123569e+02  8.23227598e+02  8.23227598e+02
  8.23227598e+02  1.75247892e+03  1.76809243e+03  1.76809243e+03
  1.76809243e+03  3.49109503e+03  3.49109503e+03  3.49109503e+03
  7.09233562e+03  7.09233562e+03  7.09233562e+03  7.83731855e+03
  2.40203911e+04  7.47471440e+04]
E1 = -727.878977110586  E_coul = 202.304210792198
cycle= 2 E= -525.574766318388  delta_E= -0.000113  |g|= 0.0111  |ddm|= 0.0146
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0205209
diis-c [-3.70649927e-04  1.53666022e-02  9.84633398e-01]
  HOMO = -0.563662382661128  LUMO = 1.34579724095616
  mo_energy =
[-1.18096433e+02 -1.21411147e+01 -9.48839532e+00 -9.48839532e+00
 -9.48839532e+00 -1.24252656e+00 -5.63662383e-01 -5.63662383e-01
 -5.63662383e-01  1.34579724e+00  1.34579724e+00  1.34579724e+00
  1.41875629e+01  1.41875629e+01  1.41875629e+01  7.74127082e+01
  7.74127082e+01  7.74127082e+01  1.65906801e+02  3.01142227e+02
  3.01142227e+02  3.01142227e+02  8.23248224e+02  8.23248224e+02
  8.23248224e+02  1.75250170e+03  1.76811409e+03  1.76811409e+03
  1.76811409e+03  3.49111746e+03  3.49111746e+03  3.49111746e+03
  7.09235847e+03  7.09235847e+03  7.09235847e+03  7.83734154e+03
  2.40204140e+04  7.47471668e+04]
E1 = -727.8532664717973  E_coul = 202.27849774984216
cycle= 3 E= -525.574768721955  delta_E= -2.4e-06  |g|= 0.00153  |ddm|= 0.00226
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00303212
diis-c [-6.55658422e-08 -7.29745163e-04  1.23306972e-01  8.77422773e-01]
  HOMO = -0.563978693799294  LUMO = 1.34547448262362
  mo_energy =
[-1.18099277e+02 -1.21426020e+01 -9.48991771e+00 -9.48991771e+00
 -9.48991771e+00 -1.24294588e+00 -5.63978694e-01 -5.63978694e-01
 -5.63978694e-01  1.34547448e+00  1.34547448e+00  1.34547448e+00
  1.41862880e+01  1.41862880e+01  1.41862880e+01  7.74106201e+01
  7.74106201e+01  7.74106201e+01  1.65904138e+02  3.01139599e+02
  3.01139599e+02  3.01139599e+02  8.23245367e+02  8.23245367e+02
  8.23245367e+02  1.75249853e+03  1.76811111e+03  1.76811111e+03
  1.76811111e+03  3.49111436e+03  3.49111436e+03  3.49111436e+03
  7.09235526e+03  7.09235526e+03  7.09235526e+03  7.83733826e+03
  2.40204107e+04  7.47471634e+04]
E1 = -727.8573690253465  E_coul = 202.2826002298758
cycle= 4 E= -525.574768795471  delta_E= -7.35e-08  |g|= 3.15e-05  |ddm|= 0.000402
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=5.02798e-05
diis-c [-3.30406804e-10 -1.42164675e-05  2.09742143e-03  2.98136496e-02
  9.68103145e-01]
  HOMO = -0.563960864046376  LUMO = 1.34549175384741
  mo_energy =
[-1.18099203e+02 -1.21425420e+01 -9.48985715e+00 -9.48985715e+00
 -9.48985715e+00 -1.24292261e+00 -5.63960864e-01 -5.63960864e-01
 -5.63960864e-01  1.34549175e+00  1.34549175e+00  1.34549175e+00
  1.41863414e+01  1.41863414e+01  1.41863414e+01  7.74106866e+01
  7.74106866e+01  7.74106866e+01  1.65904210e+02  3.01139671e+02
  3.01139671e+02  3.01139671e+02  8.23245440e+02  8.23245440e+02
  8.23245440e+02  1.75249860e+03  1.76811118e+03  1.76811118e+03
  1.76811118e+03  3.49111443e+03  3.49111443e+03  3.49111443e+03
  7.09235533e+03  7.09235533e+03  7.09235533e+03  7.83733833e+03
  2.40204107e+04  7.47471635e+04]
E1 = -727.8572272003308  E_coul = 202.28245840478337
cycle= 5 E= -525.574768795547  delta_E= -7.67e-11  |g|= 2.72e-06  |ddm|= 1.66e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.8572272003308  E_coul = 202.28245840478337
  HOMO = -0.563962243118946  LUMO = 1.3454904040853
  mo_energy =
[-1.18099210e+02 -1.21425470e+01 -9.48986224e+00 -9.48986224e+00
 -9.48986224e+00 -1.24292442e+00 -5.63962243e-01 -5.63962243e-01
 -5.63962243e-01  1.34549040e+00  1.34549040e+00  1.34549040e+00
  1.41863370e+01  1.41863370e+01  1.41863370e+01  7.74106807e+01
  7.74106807e+01  7.74106807e+01  1.65904204e+02  3.01139664e+02
  3.01139664e+02  3.01139664e+02  8.23245433e+02  8.23245433e+02
  8.23245433e+02  1.75249860e+03  1.76811117e+03  1.76811117e+03
  1.76811117e+03  3.49111443e+03  3.49111443e+03  3.49111443e+03
  7.09235532e+03  7.09235532e+03  7.09235532e+03  7.83733833e+03
  2.40204107e+04  7.47471635e+04]
E1 = -727.857239661589  E_coul = 202.28247086604097
Extra cycle  E= -525.574768795548  delta_E= -5.68e-13  |g|= 6.39e-07  |ddm|= 1.4e-06
    CPU time for scf_cycle      0.80 sec, wall time      0.23 sec
exp = [2.61829859e+04 7.61300800e+03 3.60782293e+03 1.45586326e+03
 2.20355736e+02 4.98184874e+01 4.60778239e+00 3.97902335e-01
 1.36277607e+03 6.63072258e+02 2.92365955e+02 3.06538164e+02
 1.76579122e+02 1.39474369e+01 4.56684698e+01 9.41980516e-01
 4.58075827e+00 2.59012560e-01]
E = -525.574768795548
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8486667        1
[INPUT] 0    0    [1    /1   ]  7614.51887159        1
[INPUT] 0    0    [1    /1   ]  3610.83560469        1
[INPUT] 0    0    [1    /1   ]  1502.64411523        1
[INPUT] 0    0    [1    /1   ]  222.542573827        1
[INPUT] 0    0    [1    /1   ]  49.9650293179        1
[INPUT] 0    0    [1    /1   ]  4.60561438889        1
[INPUT] 0    0    [1    /1   ]  0.397849764931       1
[INPUT] 1    0    [1    /1   ]  1362.80632793        1
[INPUT] 1    0    [1    /1   ]  663.89183413         1
[INPUT] 1    0    [1    /1   ]  296.725503826        1
[INPUT] 1    0    [1    /1   ]  310.369824012        1
[INPUT] 1    0    [1    /1   ]  113.593861064        1
[INPUT] 1    0    [1    /1   ]  10.6376062655        1
[INPUT] 1    0    [1    /1   ]  32.4465947972        1
[INPUT] 1    0    [1    /1   ]  0.862278065249       1
[INPUT] 1    0    [1    /1   ]  3.74595923649        1
[INPUT] 1    0    [1    /1   ]  0.241397757875       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.848666700567, 1.0]], [0, [7614.518871592617, 1.0]], [0, [3610.8356046942818, 1.0]], [0, [1502.6441152304894, 1.0]], [0, [222.5425738270635, 1.0]], [0, [49.96502931791691, 1.0]], [0, [4.605614388890755, 1.0]], [0, [0.397849764930772, 1.0]], [1, [1362.8063279319629, 1.0]], [1, [663.8918341304769, 1.0]], [1, [296.7255038255943, 1.0]], [1, [310.36982401222474, 1.0]], [1, [113.59386106445457, 1.0]], [1, [10.637606265466342, 1.0]], [1, [32.44659479717618, 1.0]], [1, [0.8622780652486199, 1.0]], [1, [3.745959236485174, 1.0]], [1, [0.24139775787482376, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.8486667]
bas 1, expnt(s) = [7614.51887159]
bas 2, expnt(s) = [3610.83560469]
bas 3, expnt(s) = [1502.64411523]
bas 4, expnt(s) = [222.54257383]
bas 5, expnt(s) = [49.96502932]
bas 6, expnt(s) = [4.60561439]
bas 7, expnt(s) = [0.39784976]
bas 8, expnt(s) = [1362.80632793]
bas 9, expnt(s) = [663.89183413]
bas 10, expnt(s) = [296.72550383]
bas 11, expnt(s) = [310.36982401]
bas 12, expnt(s) = [113.59386106]
bas 13, expnt(s) = [10.63760627]
bas 14, expnt(s) = [32.4465948]
bas 15, expnt(s) = [0.86227807]
bas 16, expnt(s) = [3.74595924]
bas 17, expnt(s) = [0.24139776]
CPU time:       483.45
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828487e+04 5.20029159e+03 7.61451887e+03 2.05942924e+03
 3.61083560e+03 1.17684919e+03 1.50264412e+03 6.09757464e+02
 2.22542574e+02 1.45570996e+02 4.99650293e+01 4.74804290e+01
 4.60561439e+00 7.94292943e+00 3.97849765e-01 1.26562299e+00
 1.36280633e+03 2.41561139e+04 6.63891834e+02 9.83118913e+03
 2.96725504e+02 3.59275818e+03 3.10369824e+02 3.80043890e+03
 1.13593861e+02 1.08187720e+03 1.06376063e+01 5.60453108e+01
 3.24465948e+01 2.25915381e+02 8.62278065e-01 2.42406112e+00
 3.74595924e+00 1.52033118e+01 2.41397758e-01 4.93629303e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.970047549635176
cond(S) = 220368.0662016818
E1 = -727.493375825631  E_coul = 203.10339540986163
init E= -524.389980415769
    CPU time for initialize scf      0.66 sec, wall time      0.09 sec
  HOMO = -0.558927303471766  LUMO = 1.18787997713875
  mo_energy =
[-1.17905632e+02 -1.20898797e+01 -9.44625297e+00 -9.44625297e+00
 -9.44625297e+00 -1.23014420e+00 -5.58927303e-01 -5.58927303e-01
 -5.58927303e-01  1.18787998e+00  1.18787998e+00  1.18787998e+00
  1.06259312e+01  1.06259312e+01  1.06259312e+01  5.43834540e+01
  5.43834540e+01  5.43834540e+01  1.67647924e+02  2.19089849e+02
  2.19089849e+02  2.19089849e+02  6.61211452e+02  6.61211452e+02
  6.61211452e+02  1.54586832e+03  1.54586832e+03  1.54586832e+03
  1.78803178e+03  3.24036084e+03  3.24036084e+03  3.24036084e+03
  6.84465701e+03  6.84465701e+03  6.84465701e+03  7.95152166e+03
  2.41929508e+04  7.49394958e+04]
E1 = -727.4583010546331  E_coul = 201.87125870513268
cycle= 1 E= -525.587042349501  delta_E= -1.2  |g|= 0.196  |ddm|= 0.536
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.481667
diis-c [-0.23200313  1.        ]
  HOMO = -0.569275643405571  LUMO = 1.18093941185781
  mo_energy =
[-1.18144720e+02 -1.21720542e+01 -9.52839667e+00 -9.52839667e+00
 -9.52839667e+00 -1.24820987e+00 -5.69275643e-01 -5.69275643e-01
 -5.69275643e-01  1.18093941e+00  1.18093941e+00  1.18093941e+00
  1.05685425e+01  1.05685425e+01  1.05685425e+01  5.42695228e+01
  5.42695228e+01  5.42695228e+01  1.67468030e+02  2.18908888e+02
  2.18908888e+02  2.18908888e+02  6.60981832e+02  6.60981832e+02
  6.60981832e+02  1.54559329e+03  1.54559329e+03  1.54559329e+03
  1.78762861e+03  3.24001987e+03  3.24001987e+03  3.24001987e+03
  6.84418870e+03  6.84418870e+03  6.84418870e+03  7.95096399e+03
  2.41922913e+04  7.49387406e+04]
E1 = -727.6522229635085  E_coul = 202.06499600667678
cycle= 2 E= -525.587226956832  delta_E= -0.000185  |g|= 0.0152  |ddm|= 0.0139
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0297208
diis-c [-6.84164261e-04  2.85060224e-02  9.71493978e-01]
  HOMO = -0.566915701652871  LUMO = 1.18311650500453
  mo_energy =
[-1.18115741e+02 -1.21584895e+01 -9.51461935e+00 -9.51461935e+00
 -9.51461935e+00 -1.24504430e+00 -5.66915702e-01 -5.66915702e-01
 -5.66915702e-01  1.18311651e+00  1.18311651e+00  1.18311651e+00
  1.05779657e+01  1.05779657e+01  1.05779657e+01  5.42874036e+01
  5.42874036e+01  5.42874036e+01  1.67495512e+02  2.18934227e+02
  2.18934227e+02  2.18934227e+02  6.61010680e+02  6.61010680e+02
  6.61010680e+02  1.54562381e+03  1.54562381e+03  1.54562381e+03
  1.78766067e+03  3.24005148e+03  3.24005148e+03  3.24005148e+03
  6.84422093e+03  6.84422093e+03  6.84422093e+03  7.95099645e+03
  2.41923238e+04  7.49387730e+04]
E1 = -727.6129426500663  E_coul = 202.025710377593
cycle= 3 E= -525.587232272473  delta_E= -5.32e-06  |g|= 0.00205  |ddm|= 0.00346
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00423537
diis-c [-8.49866424e-08 -7.85226784e-04  1.19359978e-01  8.81425249e-01]
  HOMO = -0.567389015720229  LUMO = 1.18269768768088
  mo_energy =
[-1.18119604e+02 -1.21605962e+01 -9.51677316e+00 -9.51677316e+00
 -9.51677316e+00 -1.24566879e+00 -5.67389016e-01 -5.67389016e-01
 -5.67389016e-01  1.18269769e+00  1.18269769e+00  1.18269769e+00
  1.05763933e+01  1.05763933e+01  1.05763933e+01  5.42847979e+01
  5.42847979e+01  5.42847979e+01  1.67491876e+02  2.18930779e+02
  2.18930779e+02  2.18930779e+02  6.61006839e+02  6.61006839e+02
  6.61006839e+02  1.54561977e+03  1.54561977e+03  1.54561977e+03
  1.78765640e+03  3.24004729e+03  3.24004729e+03  3.24004729e+03
  6.84421660e+03  6.84421660e+03  6.84421660e+03  7.95099203e+03
  2.41923193e+04  7.49387685e+04]
E1 = -727.6187844442472  E_coul = 202.03155202756133
cycle= 4 E= -525.587232416686  delta_E= -1.44e-07  |g|= 3.73e-05  |ddm|= 0.000565
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.23393e-05
diis-c [-4.86586398e-10 -2.10799403e-05  2.72556257e-03  3.33734904e-02
  9.63922027e-01]
  HOMO = -0.567367296099671  LUMO = 1.18271626889543
  mo_energy =
[-1.18119519e+02 -1.21605251e+01 -9.51670142e+00 -9.51670142e+00
 -9.51670142e+00 -1.24564056e+00 -5.67367296e-01 -5.67367296e-01
 -5.67367296e-01  1.18271627e+00  1.18271627e+00  1.18271627e+00
  1.05764517e+01  1.05764517e+01  1.05764517e+01  5.42848734e+01
  5.42848734e+01  5.42848734e+01  1.67491961e+02  2.18930862e+02
  2.18930862e+02  2.18930862e+02  6.61006924e+02  6.61006924e+02
  6.61006924e+02  1.54561986e+03  1.54561986e+03  1.54561986e+03
  1.78765648e+03  3.24004738e+03  3.24004738e+03  3.24004738e+03
  6.84421668e+03  6.84421668e+03  6.84421668e+03  7.95099212e+03
  2.41923194e+04  7.49387686e+04]
E1 = -727.6186122239103  E_coul = 202.0313798071118
cycle= 5 E= -525.587232416799  delta_E= -1.13e-10  |g|= 2.87e-06  |ddm|= 1.97e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.6186122239103  E_coul = 202.0313798071118
  HOMO = -0.56736881738729  LUMO = 1.18271496474037
  mo_energy =
[-1.18119526e+02 -1.21605305e+01 -9.51670692e+00 -9.51670692e+00
 -9.51670692e+00 -1.24564255e+00 -5.67368817e-01 -5.67368817e-01
 -5.67368817e-01  1.18271496e+00  1.18271496e+00  1.18271496e+00
  1.05764474e+01  1.05764474e+01  1.05764474e+01  5.42848675e+01
  5.42848675e+01  5.42848675e+01  1.67491954e+02  2.18930855e+02
  2.18930855e+02  2.18930855e+02  6.61006917e+02  6.61006917e+02
  6.61006917e+02  1.54561985e+03  1.54561985e+03  1.54561985e+03
  1.78765647e+03  3.24004737e+03  3.24004737e+03  3.24004737e+03
  6.84421667e+03  6.84421667e+03  6.84421667e+03  7.95099211e+03
  2.41923194e+04  7.49387686e+04]
E1 = -727.6186259344921  E_coul = 202.03139351769315
Extra cycle  E= -525.587232416799  delta_E= -4.55e-13  |g|= 6.95e-07  |ddm|= 1.52e-06
    CPU time for scf_cycle      0.81 sec, wall time      0.24 sec
exp = [2.61828487e+04 7.61451887e+03 3.61083560e+03 1.50264412e+03
 2.22542574e+02 4.99650293e+01 4.60561439e+00 3.97849765e-01
 1.36280633e+03 6.63891834e+02 2.96725504e+02 3.10369824e+02
 1.13593861e+02 1.06376063e+01 3.24465948e+01 8.62278065e-01
 3.74595924e+00 2.41397758e-01]
E = -525.587232416799
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8486667        1
[INPUT] 0    0    [1    /1   ]  7614.51887159        1
[INPUT] 0    0    [1    /1   ]  3610.83560469        1
[INPUT] 0    0    [1    /1   ]  1502.64411523        1
[INPUT] 0    0    [1    /1   ]  222.542573827        1
[INPUT] 0    0    [1    /1   ]  49.9650293179        1
[INPUT] 0    0    [1    /1   ]  4.60561438889        1
[INPUT] 0    0    [1    /1   ]  0.397849764931       1
[INPUT] 1    0    [1    /1   ]  1362.80632793        1
[INPUT] 1    0    [1    /1   ]  663.89183413         1
[INPUT] 1    0    [1    /1   ]  296.725503826        1
[INPUT] 1    0    [1    /1   ]  310.369824012        1
[INPUT] 1    0    [1    /1   ]  113.593861064        1
[INPUT] 1    0    [1    /1   ]  10.6376062655        1
[INPUT] 1    0    [1    /1   ]  32.4465947972        1
[INPUT] 1    0    [1    /1   ]  0.862278065249       1
[INPUT] 1    0    [1    /1   ]  3.74595923649        1
[INPUT] 1    0    [1    /1   ]  0.241397757875       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.848666700567, 1.0]], [0, [7614.518871592617, 1.0]], [0, [3610.8356046942818, 1.0]], [0, [1502.6441152304894, 1.0]], [0, [222.5425738270635, 1.0]], [0, [49.96502931791691, 1.0]], [0, [4.605614388890755, 1.0]], [0, [0.397849764930772, 1.0]], [1, [1362.8063279319629, 1.0]], [1, [663.8918341304769, 1.0]], [1, [296.7255038255943, 1.0]], [1, [310.36982401222474, 1.0]], [1, [113.59386106445457, 1.0]], [1, [10.637606265466342, 1.0]], [1, [32.44659479717618, 1.0]], [1, [0.8622780652486199, 1.0]], [1, [3.745959236485174, 1.0]], [1, [0.24139775787482376, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.8486667]
bas 1, expnt(s) = [7614.51887159]
bas 2, expnt(s) = [3610.83560469]
bas 3, expnt(s) = [1502.64411523]
bas 4, expnt(s) = [222.54257383]
bas 5, expnt(s) = [49.96502932]
bas 6, expnt(s) = [4.60561439]
bas 7, expnt(s) = [0.39784976]
bas 8, expnt(s) = [1362.80632793]
bas 9, expnt(s) = [663.89183413]
bas 10, expnt(s) = [296.72550383]
bas 11, expnt(s) = [310.36982401]
bas 12, expnt(s) = [113.59386106]
bas 13, expnt(s) = [10.63760627]
bas 14, expnt(s) = [32.4465948]
bas 15, expnt(s) = [0.86227807]
bas 16, expnt(s) = [3.74595924]
bas 17, expnt(s) = [0.24139776]
CPU time:       484.63
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828487e+04 5.20029159e+03 7.61451887e+03 2.05942924e+03
 3.61083560e+03 1.17684919e+03 1.50264412e+03 6.09757464e+02
 2.22542574e+02 1.45570996e+02 4.99650293e+01 4.74804290e+01
 4.60561439e+00 7.94292943e+00 3.97849765e-01 1.26562299e+00
 1.36280633e+03 2.41561139e+04 6.63891834e+02 9.83118913e+03
 2.96725504e+02 3.59275818e+03 3.10369824e+02 3.80043890e+03
 1.13593861e+02 1.08187720e+03 1.06376063e+01 5.60453108e+01
 3.24465948e+01 2.25915381e+02 8.62278065e-01 2.42406112e+00
 3.74595924e+00 1.52033118e+01 2.41397758e-01 4.93629303e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.970047549635176
cond(S) = 220368.0662016818
E1 = -727.493375825631  E_coul = 203.10339540986163
init E= -524.389980415769
    CPU time for initialize scf      0.65 sec, wall time      0.08 sec
  HOMO = -0.558927303471766  LUMO = 1.18787997713875
  mo_energy =
[-1.17905632e+02 -1.20898797e+01 -9.44625297e+00 -9.44625297e+00
 -9.44625297e+00 -1.23014420e+00 -5.58927303e-01 -5.58927303e-01
 -5.58927303e-01  1.18787998e+00  1.18787998e+00  1.18787998e+00
  1.06259312e+01  1.06259312e+01  1.06259312e+01  5.43834540e+01
  5.43834540e+01  5.43834540e+01  1.67647924e+02  2.19089849e+02
  2.19089849e+02  2.19089849e+02  6.61211452e+02  6.61211452e+02
  6.61211452e+02  1.54586832e+03  1.54586832e+03  1.54586832e+03
  1.78803178e+03  3.24036084e+03  3.24036084e+03  3.24036084e+03
  6.84465701e+03  6.84465701e+03  6.84465701e+03  7.95152166e+03
  2.41929508e+04  7.49394958e+04]
E1 = -727.4583010546331  E_coul = 201.87125870513268
cycle= 1 E= -525.587042349501  delta_E= -1.2  |g|= 0.196  |ddm|= 0.536
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.481667
diis-c [-0.23200313  1.        ]
  HOMO = -0.569275643405571  LUMO = 1.18093941185781
  mo_energy =
[-1.18144720e+02 -1.21720542e+01 -9.52839667e+00 -9.52839667e+00
 -9.52839667e+00 -1.24820987e+00 -5.69275643e-01 -5.69275643e-01
 -5.69275643e-01  1.18093941e+00  1.18093941e+00  1.18093941e+00
  1.05685425e+01  1.05685425e+01  1.05685425e+01  5.42695228e+01
  5.42695228e+01  5.42695228e+01  1.67468030e+02  2.18908888e+02
  2.18908888e+02  2.18908888e+02  6.60981832e+02  6.60981832e+02
  6.60981832e+02  1.54559329e+03  1.54559329e+03  1.54559329e+03
  1.78762861e+03  3.24001987e+03  3.24001987e+03  3.24001987e+03
  6.84418870e+03  6.84418870e+03  6.84418870e+03  7.95096399e+03
  2.41922913e+04  7.49387406e+04]
E1 = -727.6522229635085  E_coul = 202.06499600667678
cycle= 2 E= -525.587226956832  delta_E= -0.000185  |g|= 0.0152  |ddm|= 0.0139
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297208
diis-c [-6.84164261e-04  2.85060224e-02  9.71493978e-01]
  HOMO = -0.566915701652871  LUMO = 1.18311650500453
  mo_energy =
[-1.18115741e+02 -1.21584895e+01 -9.51461935e+00 -9.51461935e+00
 -9.51461935e+00 -1.24504430e+00 -5.66915702e-01 -5.66915702e-01
 -5.66915702e-01  1.18311651e+00  1.18311651e+00  1.18311651e+00
  1.05779657e+01  1.05779657e+01  1.05779657e+01  5.42874036e+01
  5.42874036e+01  5.42874036e+01  1.67495512e+02  2.18934227e+02
  2.18934227e+02  2.18934227e+02  6.61010680e+02  6.61010680e+02
  6.61010680e+02  1.54562381e+03  1.54562381e+03  1.54562381e+03
  1.78766067e+03  3.24005148e+03  3.24005148e+03  3.24005148e+03
  6.84422093e+03  6.84422093e+03  6.84422093e+03  7.95099645e+03
  2.41923238e+04  7.49387730e+04]
E1 = -727.6129426500663  E_coul = 202.025710377593
cycle= 3 E= -525.587232272473  delta_E= -5.32e-06  |g|= 0.00205  |ddm|= 0.00346
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00423537
diis-c [-8.49866424e-08 -7.85226784e-04  1.19359978e-01  8.81425249e-01]
  HOMO = -0.567389015720229  LUMO = 1.18269768768088
  mo_energy =
[-1.18119604e+02 -1.21605962e+01 -9.51677316e+00 -9.51677316e+00
 -9.51677316e+00 -1.24566879e+00 -5.67389016e-01 -5.67389016e-01
 -5.67389016e-01  1.18269769e+00  1.18269769e+00  1.18269769e+00
  1.05763933e+01  1.05763933e+01  1.05763933e+01  5.42847979e+01
  5.42847979e+01  5.42847979e+01  1.67491876e+02  2.18930779e+02
  2.18930779e+02  2.18930779e+02  6.61006839e+02  6.61006839e+02
  6.61006839e+02  1.54561977e+03  1.54561977e+03  1.54561977e+03
  1.78765640e+03  3.24004729e+03  3.24004729e+03  3.24004729e+03
  6.84421660e+03  6.84421660e+03  6.84421660e+03  7.95099203e+03
  2.41923193e+04  7.49387685e+04]
E1 = -727.6187844442472  E_coul = 202.03155202756133
cycle= 4 E= -525.587232416686  delta_E= -1.44e-07  |g|= 3.73e-05  |ddm|= 0.000565
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.23393e-05
diis-c [-4.86586398e-10 -2.10799403e-05  2.72556257e-03  3.33734904e-02
  9.63922027e-01]
  HOMO = -0.567367296099671  LUMO = 1.18271626889543
  mo_energy =
[-1.18119519e+02 -1.21605251e+01 -9.51670142e+00 -9.51670142e+00
 -9.51670142e+00 -1.24564056e+00 -5.67367296e-01 -5.67367296e-01
 -5.67367296e-01  1.18271627e+00  1.18271627e+00  1.18271627e+00
  1.05764517e+01  1.05764517e+01  1.05764517e+01  5.42848734e+01
  5.42848734e+01  5.42848734e+01  1.67491961e+02  2.18930862e+02
  2.18930862e+02  2.18930862e+02  6.61006924e+02  6.61006924e+02
  6.61006924e+02  1.54561986e+03  1.54561986e+03  1.54561986e+03
  1.78765648e+03  3.24004738e+03  3.24004738e+03  3.24004738e+03
  6.84421668e+03  6.84421668e+03  6.84421668e+03  7.95099212e+03
  2.41923194e+04  7.49387686e+04]
E1 = -727.6186122239103  E_coul = 202.0313798071118
cycle= 5 E= -525.587232416799  delta_E= -1.13e-10  |g|= 2.87e-06  |ddm|= 1.97e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.6186122239103  E_coul = 202.0313798071118
  HOMO = -0.56736881738729  LUMO = 1.18271496474037
  mo_energy =
[-1.18119526e+02 -1.21605305e+01 -9.51670692e+00 -9.51670692e+00
 -9.51670692e+00 -1.24564255e+00 -5.67368817e-01 -5.67368817e-01
 -5.67368817e-01  1.18271496e+00  1.18271496e+00  1.18271496e+00
  1.05764474e+01  1.05764474e+01  1.05764474e+01  5.42848675e+01
  5.42848675e+01  5.42848675e+01  1.67491954e+02  2.18930855e+02
  2.18930855e+02  2.18930855e+02  6.61006917e+02  6.61006917e+02
  6.61006917e+02  1.54561985e+03  1.54561985e+03  1.54561985e+03
  1.78765647e+03  3.24004737e+03  3.24004737e+03  3.24004737e+03
  6.84421667e+03  6.84421667e+03  6.84421667e+03  7.95099211e+03
  2.41923194e+04  7.49387686e+04]
E1 = -727.6186259344921  E_coul = 202.03139351769315
Extra cycle  E= -525.587232416799  delta_E= -4.55e-13  |g|= 6.95e-07  |ddm|= 1.52e-06
    CPU time for scf_cycle      0.81 sec, wall time      0.24 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 220368.0662016818
E1 = -727.6186259344921  E_coul = 202.03139351769315
init E= -525.587232416799
    CPU time for initialize scf      1.83 sec, wall time      0.26 sec
  HOMO = -0.56736856024163  LUMO = 1.18271518912053
  mo_energy =
[-1.18119524e+02 -1.21605295e+01 -9.51670588e+00 -9.51670588e+00
 -9.51670588e+00 -1.24564222e+00 -5.67368560e-01 -5.67368560e-01
 -5.67368560e-01  1.18271519e+00  1.18271519e+00  1.18271519e+00
  1.05764482e+01  1.05764482e+01  1.05764482e+01  5.42848687e+01
  5.42848687e+01  5.42848687e+01  1.67491955e+02  2.18930857e+02
  2.18930857e+02  2.18930857e+02  6.61006919e+02  6.61006919e+02
  6.61006919e+02  1.54561985e+03  1.54561985e+03  1.54561985e+03
  1.78765648e+03  3.24004737e+03  3.24004737e+03  3.24004737e+03
  6.84421667e+03  6.84421667e+03  6.84421667e+03  7.95099211e+03
  2.41923194e+04  7.49387686e+04]
E1 = -727.6186232482236  E_coul = 202.03139083142483
cycle= 1 E= -525.587232416799  delta_E= 2.27e-13  |g|= 1.46e-07  |ddm|= 2.74e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.6186232482236  E_coul = 202.03139083142483
  HOMO = -0.567368607909185  LUMO = 1.18271514732499
  mo_energy =
[-1.18119525e+02 -1.21605297e+01 -9.51670608e+00 -9.51670608e+00
 -9.51670608e+00 -1.24564228e+00 -5.67368608e-01 -5.67368608e-01
 -5.67368608e-01  1.18271515e+00  1.18271515e+00  1.18271515e+00
  1.05764480e+01  1.05764480e+01  1.05764480e+01  5.42848684e+01
  5.42848684e+01  5.42848684e+01  1.67491955e+02  2.18930857e+02
  2.18930857e+02  2.18930857e+02  6.61006918e+02  6.61006918e+02
  6.61006918e+02  1.54561985e+03  1.54561985e+03  1.54561985e+03
  1.78765647e+03  3.24004737e+03  3.24004737e+03  3.24004737e+03
  6.84421667e+03  6.84421667e+03  6.84421667e+03  7.95099211e+03
  2.41923194e+04  7.49387686e+04]
E1 = -727.6186237807609  E_coul = 202.03139136396237
Extra cycle  E= -525.587232416799  delta_E= 2.27e-13  |g|= 2.98e-08  |ddm|= 5.34e-08
    CPU time for scf_cycle      2.15 sec, wall time      0.58 sec
exp = [2.61828487e+04 7.61451887e+03 3.61083560e+03 1.50264412e+03
 2.22542574e+02 4.99650293e+01 4.60561439e+00 3.97849765e-01
 1.36280633e+03 6.63891834e+02 2.96725504e+02 3.10369824e+02
 1.13593861e+02 1.06376063e+01 3.24465948e+01 8.62278065e-01
 3.74595924e+00 2.41397758e-01]
grad_E = [-2.00353379e-06  2.45948825e-05  4.73160429e-05  9.65422189e-04
 -4.70527471e-03  1.48522285e-03  2.01521203e-03  7.16436696e-03
  1.55245214e-07  5.60569605e-07  6.04210206e-06  5.90661726e-06
  1.56053833e-04 -9.83196244e-03  2.49016733e-03 -6.42981181e-03
  2.51296653e-02 -3.43661050e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26183.1562295        1
[INPUT] 0    0    [1    /1   ]  7611.13287411        1
[INPUT] 0    0    [1    /1   ]  3604.08353543        1
[INPUT] 0    0    [1    /1   ]  1397.79198724        1
[INPUT] 0    0    [1    /1   ]  218.163333317        1
[INPUT] 0    0    [1    /1   ]  49.7043883104        1
[INPUT] 0    0    [1    /1   ]  4.60945104653        1
[INPUT] 0    0    [1    /1   ]  0.397821211211       1
[INPUT] 1    0    [1    /1   ]  1362.73729386        1
[INPUT] 1    0    [1    /1   ]  662.045219967        1
[INPUT] 1    0    [1    /1   ]  286.898727687        1
[INPUT] 1    0    [1    /1   ]  301.732674459        1
[INPUT] 1    0    [1    /1   ]  256.570829638        1
[INPUT] 1    0    [1    /1   ]  17.1990131033        1
[INPUT] 1    0    [1    /1   ]  60.3895372052        1
[INPUT] 1    0    [1    /1   ]  1.00961179063        1
[INPUT] 1    0    [1    /1   ]  5.23697905539        1
[INPUT] 1    0    [1    /1   ]  0.275787849775       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26183.1562294558, 1.0]], [0, [7611.132874109856, 1.0]], [0, [3604.0835354282763, 1.0]], [0, [1397.7919872358648, 1.0]], [0, [218.1633333169428, 1.0]], [0, [49.704388310362916, 1.0]], [0, [4.60945104652662, 1.0]], [0, [0.39782121121115643, 1.0]], [1, [1362.7372938649764, 1.0]], [1, [662.045219966573, 1.0]], [1, [286.89872768655647, 1.0]], [1, [301.7326744592946, 1.0]], [1, [256.57082963837, 1.0]], [1, [17.19901310334792, 1.0]], [1, [60.3895372052195, 1.0]], [1, [1.0096117906272268, 1.0]], [1, [5.236979055387264, 1.0]], [1, [0.27578784977493886, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26183.15622946]
bas 1, expnt(s) = [7611.13287411]
bas 2, expnt(s) = [3604.08353543]
bas 3, expnt(s) = [1397.79198724]
bas 4, expnt(s) = [218.16333332]
bas 5, expnt(s) = [49.70438831]
bas 6, expnt(s) = [4.60945105]
bas 7, expnt(s) = [0.39782121]
bas 8, expnt(s) = [1362.73729386]
bas 9, expnt(s) = [662.04521997]
bas 10, expnt(s) = [286.89872769]
bas 11, expnt(s) = [301.73267446]
bas 12, expnt(s) = [256.57082964]
bas 13, expnt(s) = [17.1990131]
bas 14, expnt(s) = [60.38953721]
bas 15, expnt(s) = [1.00961179]
bas 16, expnt(s) = [5.23697906]
bas 17, expnt(s) = [0.27578785]
CPU time:       492.29
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61831562e+04 5.20033740e+03 7.61113287e+03 2.05874237e+03
 3.60408354e+03 1.17519832e+03 1.39779199e+03 5.77559769e+02
 2.18163333e+02 1.43417235e+02 4.97043883e+01 4.72945475e+01
 4.60945105e+00 7.94789150e+00 3.97821211e-01 1.26555486e+00
 1.36273729e+03 2.41545844e+04 6.62045220e+02 9.79701923e+03
 2.86898728e+02 3.44465055e+03 3.01732674e+02 3.66870102e+03
 2.56570830e+02 2.99566669e+03 1.71990131e+01 1.02179507e+02
 6.03895372e+01 4.91118755e+02 1.00961179e+00 2.95241505e+00
 5.23697906e+00 2.31118888e+01 2.75787850e-01 5.83046649e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.954068519401943
cond(S) = 13579514.08515804
E1 = -727.4041801059237  E_coul = 203.12114871365716
init E= -524.283031392267
    CPU time for initialize scf      0.67 sec, wall time      0.08 sec
  HOMO = -0.560285328440252  LUMO = 1.50137493548794
  mo_energy =
[-1.17939236e+02 -1.20885356e+01 -9.42201415e+00 -9.42201415e+00
 -9.42201415e+00 -1.23536755e+00 -5.60285328e-01 -5.60285328e-01
 -5.60285328e-01  1.50137494e+00  1.50137494e+00  1.50137494e+00
  1.77657575e+01  1.77657575e+01  1.77657575e+01  1.01641139e+02
  1.01641139e+02  1.01641139e+02  1.64497222e+02  3.76250537e+02
  3.76250537e+02  3.76250538e+02  9.69686996e+02  9.69686996e+02
  9.69686996e+02  1.71016853e+03  1.99253648e+03  1.99253648e+03
  1.99253648e+03  3.77871412e+03  3.77871412e+03  3.77871412e+03
  7.40192055e+03  7.40192055e+03  7.40192055e+03  7.69653588e+03
  2.38084357e+04  7.45119711e+04]
E1 = -728.0670882732978  E_coul = 202.52334276023385
cycle= 1 E= -525.543745513064  delta_E= -1.26  |g|= 0.184  |ddm|= 47.2
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.429632
diis-c [-0.1845838  1.       ]
  HOMO = -0.558799482196281  LUMO = 1.50350715337371
  mo_energy =
[-1.18088790e+02 -1.21267311e+01 -9.45971606e+00 -9.45971606e+00
 -9.45971606e+00 -1.23916677e+00 -5.58799482e-01 -5.58799482e-01
 -5.58799482e-01  1.50350715e+00  1.50350715e+00  1.50350715e+00
  1.77298674e+01  1.77298674e+01  1.77298674e+01  1.01562958e+02
  1.01562958e+02  1.01562958e+02  1.64403205e+02  3.76131047e+02
  3.76131047e+02  3.76131047e+02  9.69535246e+02  9.69535246e+02
  9.69535246e+02  1.70987192e+03  1.99235104e+03  1.99235104e+03
  1.99235104e+03  3.77847262e+03  3.77847262e+03  3.77847262e+03
  7.40155862e+03  7.40155862e+03  7.40155862e+03  7.69608719e+03
  2.38078857e+04  7.45113272e+04]
E1 = -728.1116817644464  E_coul = 202.56787331319467
cycle= 2 E= -525.543808451252  delta_E= -6.29e-05  |g|= 0.00627  |ddm|= 0.0623
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0108414
diis-c [-1.15630140e-04  3.20423595e-03  9.96795764e-01]
  HOMO = -0.558749812357855  LUMO = 1.50368510749668
  mo_energy =
[-1.18078845e+02 -1.21237491e+01 -9.45671024e+00 -9.45671024e+00
 -9.45671024e+00 -1.23906528e+00 -5.58749812e-01 -5.58749812e-01
 -5.58749812e-01  1.50368511e+00  1.50368511e+00  1.50368511e+00
  1.77326169e+01  1.77326169e+01  1.77326169e+01  1.01569730e+02
  1.01569730e+02  1.01569730e+02  1.64412618e+02  3.76140251e+02
  3.76140251e+02  3.76140251e+02  9.69545467e+02  9.69545467e+02
  9.69545467e+02  1.70988331e+03  1.99236182e+03  1.99236182e+03
  1.99236182e+03  3.77848383e+03  3.77848383e+03  3.77848383e+03
  7.40156998e+03  7.40156998e+03  7.40156998e+03  7.69609856e+03
  2.38078969e+04  7.45113382e+04]
E1 = -728.1018163871821  E_coul = 202.55800744241384
cycle= 3 E= -525.543808944768  delta_E= -4.94e-07  |g|= 0.00076  |ddm|= 0.000926
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00147636
diis-c [-4.51147270e-08 -6.32728021e-04  1.14266154e-01  8.86366574e-01]
  HOMO = -0.558855428484202  LUMO = 1.50355954117957
  mo_energy =
[-1.18080190e+02 -1.21243569e+01 -9.45733541e+00 -9.45733541e+00
 -9.45733541e+00 -1.23920671e+00 -5.58855428e-01 -5.58855428e-01
 -5.58855428e-01  1.50355954e+00  1.50355954e+00  1.50355954e+00
  1.77320345e+01  1.77320345e+01  1.77320345e+01  1.01568714e+02
  1.01568714e+02  1.01568714e+02  1.64411375e+02  3.76138989e+02
  3.76138989e+02  3.76138989e+02  9.69544098e+02  9.69544098e+02
  9.69544098e+02  1.70988177e+03  1.99236039e+03  1.99236039e+03
  1.99236039e+03  3.77848233e+03  3.77848233e+03  3.77848233e+03
  7.40156841e+03  7.40156841e+03  7.40156841e+03  7.69609695e+03
  2.38078952e+04  7.45113366e+04]
E1 = -728.1035642755496  E_coul = 202.5597553167577
cycle= 4 E= -525.543808958792  delta_E= -1.4e-08  |g|= 2.25e-05  |ddm|= 0.000169
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=3.37563e-05
diis-c [-2.03098872e-10 -5.39906376e-06  7.46321667e-04  2.59172129e-02
  9.73341865e-01]
  HOMO = -0.558842941395709  LUMO = 1.50357284987619
  mo_energy =
[-1.18080137e+02 -1.21243140e+01 -9.45729205e+00 -9.45729205e+00
 -9.45729205e+00 -1.23919033e+00 -5.58842941e-01 -5.58842941e-01
 -5.58842941e-01  1.50357285e+00  1.50357285e+00  1.50357285e+00
  1.77320746e+01  1.77320746e+01  1.77320746e+01  1.01568763e+02
  1.01568763e+02  1.01568763e+02  1.64411428e+02  3.76139041e+02
  3.76139041e+02  3.76139041e+02  9.69544151e+02  9.69544151e+02
  9.69544151e+02  1.70988183e+03  1.99236044e+03  1.99236044e+03
  1.99236044e+03  3.77848238e+03  3.77848238e+03  3.77848238e+03
  7.40156846e+03  7.40156846e+03  7.40156846e+03  7.69609700e+03
  2.38078953e+04  7.45113366e+04]
E1 = -728.1034662547058  E_coul = 202.55965729587768
cycle= 5 E= -525.543808958828  delta_E= -3.62e-11  |g|= 2.55e-06  |ddm|= 1.16e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.1034662547058  E_coul = 202.55965729587768
  HOMO = -0.558844122434487  LUMO = 1.50357156109768
  mo_energy =
[-1.18080143e+02 -1.21243184e+01 -9.45729659e+00 -9.45729659e+00
 -9.45729659e+00 -1.23919189e+00 -5.58844122e-01 -5.58844122e-01
 -5.58844122e-01  1.50357156e+00  1.50357156e+00  1.50357156e+00
  1.77320704e+01  1.77320704e+01  1.77320704e+01  1.01568757e+02
  1.01568757e+02  1.01568757e+02  1.64411421e+02  3.76139035e+02
  3.76139035e+02  3.76139035e+02  9.69544145e+02  9.69544145e+02
  9.69544145e+02  1.70988182e+03  1.99236044e+03  1.99236044e+03
  1.99236044e+03  3.77848238e+03  3.77848238e+03  3.77848238e+03
  7.40156846e+03  7.40156846e+03  7.40156846e+03  7.69609699e+03
  2.38078953e+04  7.45113366e+04]
E1 = -728.1034771479125  E_coul = 202.5596681890848
Extra cycle  E= -525.543808958828  delta_E= 4.55e-13  |g|= 5.73e-07  |ddm|= 1.26e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.23 sec
exp = [2.61831562e+04 7.61113287e+03 3.60408354e+03 1.39779199e+03
 2.18163333e+02 4.97043883e+01 4.60945105e+00 3.97821211e-01
 1.36273729e+03 6.62045220e+02 2.86898728e+02 3.01732674e+02
 2.56570830e+02 1.71990131e+01 6.03895372e+01 1.00961179e+00
 5.23697906e+00 2.75787850e-01]
E = -525.5438089588276
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:28 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8951169        1
[INPUT] 0    0    [1    /1   ]  7614.00749502        1
[INPUT] 0    0    [1    /1   ]  3609.81586087        1
[INPUT] 0    0    [1    /1   ]  1486.80862751        1
[INPUT] 0    0    [1    /1   ]  221.881190881        1
[INPUT] 0    0    [1    /1   ]  49.9256655248        1
[INPUT] 0    0    [1    /1   ]  4.60619382725        1
[INPUT] 0    0    [1    /1   ]  0.397845452552       1
[INPUT] 1    0    [1    /1   ]  1362.79590193        1
[INPUT] 1    0    [1    /1   ]  663.612945791        1
[INPUT] 1    0    [1    /1   ]  295.241396675        1
[INPUT] 1    0    [1    /1   ]  309.06538243         1
[INPUT] 1    0    [1    /1   ]  135.18722377         1
[INPUT] 1    0    [1    /1   ]  11.6285549415        1
[INPUT] 1    0    [1    /1   ]  36.6667296657        1
[INPUT] 1    0    [1    /1   ]  0.884529415257       1
[INPUT] 1    0    [1    /1   ]  3.97114327887        1
[INPUT] 1    0    [1    /1   ]  0.246591585491       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.895116937936, 1.0]], [0, [7614.007495022707, 1.0]], [0, [3609.815860870305, 1.0]], [0, [1486.8086275094684, 1.0]], [0, [221.8811908808922, 1.0]], [0, [49.92566552479554, 1.0]], [0, [4.606193827248798, 1.0]], [0, [0.39784545255213927, 1.0]], [1, [1362.7959019335497, 1.0]], [1, [663.6129457905143, 1.0]], [1, [295.2413966752374, 1.0]], [1, [309.0653824304854, 1.0]], [1, [135.1872237700462, 1.0]], [1, [11.628554941483902, 1.0]], [1, [36.66672966572603, 1.0]], [1, [0.8845294152569366, 1.0]], [1, [3.9711432788656347, 1.0]], [1, [0.24659158549115, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.89511694]
bas 1, expnt(s) = [7614.00749502]
bas 2, expnt(s) = [3609.81586087]
bas 3, expnt(s) = [1486.80862751]
bas 4, expnt(s) = [221.88119088]
bas 5, expnt(s) = [49.92566552]
bas 6, expnt(s) = [4.60619383]
bas 7, expnt(s) = [0.39784545]
bas 8, expnt(s) = [1362.79590193]
bas 9, expnt(s) = [663.61294579]
bas 10, expnt(s) = [295.24139668]
bas 11, expnt(s) = [309.06538243]
bas 12, expnt(s) = [135.18722377]
bas 13, expnt(s) = [11.62855494]
bas 14, expnt(s) = [36.66672967]
bas 15, expnt(s) = [0.88452942]
bas 16, expnt(s) = [3.97114328]
bas 17, expnt(s) = [0.24659159]
CPU time:       493.40
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828951e+04 5.20029851e+03 7.61400750e+03 2.05932551e+03
 3.60981586e+03 1.17659991e+03 1.48680863e+03 6.04931680e+02
 2.21881191e+02 1.45246404e+02 4.99256655e+01 4.74523715e+01
 4.60619383e+00 7.94367890e+00 3.97845453e-01 1.26561270e+00
 1.36279590e+03 2.41558829e+04 6.63612946e+02 9.82602703e+03
 2.95241397e+02 3.57031025e+03 3.09065382e+02 3.78048350e+03
 1.35187224e+02 1.34478840e+03 1.16285549e+01 6.26457451e+01
 3.66667297e+01 2.63223472e+02 8.84529415e-01 2.50250378e+00
 3.97114328e+00 1.63541824e+01 2.46591585e-01 5.06940757e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9684758487671
cond(S) = 321145.5399123251
E1 = -727.4959695380137  E_coul = 203.10550591553942
init E= -524.390463622474
    CPU time for initialize scf      0.69 sec, wall time      0.08 sec
  HOMO = -0.558800915576049  LUMO = 1.23240248191235
  mo_energy =
[-1.17910829e+02 -1.20900231e+01 -9.44446516e+00 -9.44446516e+00
 -9.44446516e+00 -1.23043653e+00 -5.58800916e-01 -5.58800916e-01
 -5.58800916e-01  1.23240248e+00  1.23240248e+00  1.23240248e+00
  1.15932664e+01  1.15932664e+01  1.15932664e+01  6.13283427e+01
  6.13283427e+01  6.13283427e+01  1.67169935e+02  2.47800110e+02
  2.47800110e+02  2.47800110e+02  7.20034586e+02  7.20034586e+02
  7.20034586e+02  1.62434043e+03  1.62434043e+03  1.62434043e+03
  1.77645908e+03  3.32591409e+03  3.32591409e+03  3.32591409e+03
  6.92736821e+03  6.92736821e+03  6.92736821e+03  7.91352585e+03
  2.41351487e+04  7.48749082e+04]
E1 = -727.518045760453  E_coul = 201.92900676173363
cycle= 1 E= -525.589038998719  delta_E= -1.2  |g|= 0.195  |ddm|= 0.727
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.476975
diis-c [-0.2275055  1.       ]
  HOMO = -0.567871725520509  LUMO = 1.22609113381771
  mo_energy =
[-1.18143133e+02 -1.21682984e+01 -9.52269880e+00 -9.52269880e+00
 -9.52269880e+00 -1.24697424e+00 -5.67871726e-01 -5.67871726e-01
 -5.67871726e-01  1.22609113e+00  1.22609113e+00  1.22609113e+00
  1.15356681e+01  1.15356681e+01  1.15356681e+01  6.12123417e+01
  6.12123417e+01  6.12123417e+01  1.66996623e+02  2.47619246e+02
  2.47619246e+02  2.47619246e+02  7.19809412e+02  7.19809412e+02
  7.19809412e+02  1.62407257e+03  1.62407257e+03  1.62407257e+03
  1.77606489e+03  3.32558162e+03  3.32558162e+03  3.32558162e+03
  6.92690902e+03  6.92690902e+03  6.92690902e+03  7.91297742e+03
  2.41344985e+04  7.48741626e+04]
E1 = -727.6991080099915  E_coul = 202.1098974394747
cycle= 2 E= -525.589210570517  delta_E= -0.000172  |g|= 0.0145  |ddm|= 0.0135
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0278723
diis-c [-6.16012801e-04  2.59354038e-02  9.74064596e-01]
  HOMO = -0.565727351184756  LUMO = 1.22816012421315
  mo_energy =
[-1.18115619e+02 -1.21556250e+01 -9.50982858e+00 -9.50982858e+00
 -9.50982858e+00 -1.24409374e+00 -5.65727351e-01 -5.65727351e-01
 -5.65727351e-01  1.22816012e+00  1.22816012e+00  1.22816012e+00
  1.15449483e+01  1.15449483e+01  1.15449483e+01  6.12300429e+01
  6.12300429e+01  6.12300429e+01  1.67022695e+02  2.47643786e+02
  2.47643786e+02  2.47643786e+02  7.19836935e+02  7.19836935e+02
  7.19836935e+02  1.62410158e+03  1.62410158e+03  1.62410158e+03
  1.77609538e+03  3.32561166e+03  3.32561166e+03  3.32561166e+03
  6.92693966e+03  6.92693966e+03  6.92693966e+03  7.91300829e+03
  2.41345294e+04  7.48741934e+04]
E1 = -727.6625210283149  E_coul = 202.07330577332868
cycle= 3 E= -525.589215254986  delta_E= -4.68e-06  |g|= 0.00196  |ddm|= 0.00324
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00398814
diis-c [-8.04612559e-08 -7.73679219e-04  1.19762093e-01  8.81011586e-01]
  HOMO = -0.566169581247965  LUMO = 1.22775296383884
  mo_energy =
[-1.18119305e+02 -1.21576175e+01 -9.51186609e+00 -9.51186609e+00
 -9.51186609e+00 -1.24467789e+00 -5.66169581e-01 -5.66169581e-01
 -5.66169581e-01  1.22775296e+00  1.22775296e+00  1.22775296e+00
  1.15433945e+01  1.15433945e+01  1.15433945e+01  6.12274689e+01
  6.12274689e+01  6.12274689e+01  1.67019229e+02  2.47640441e+02
  2.47640441e+02  2.47640441e+02  7.19833254e+02  7.19833254e+02
  7.19833254e+02  1.62409773e+03  1.62409773e+03  1.62409773e+03
  1.77609129e+03  3.32560766e+03  3.32560766e+03  3.32560766e+03
  6.92693552e+03  6.92693552e+03  6.92693552e+03  7.91300406e+03
  2.41345251e+04  7.48741890e+04]
E1 = -727.6680149728192  E_coul = 202.0787995888376
cycle= 4 E= -525.589215383982  delta_E= -1.29e-07  |g|= 3.63e-05  |ddm|= 0.000536
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=5.95006e-05
diis-c [-4.61039429e-10 -1.92027484e-05  2.53322367e-03  3.20413901e-02
  9.65444589e-01]
  HOMO = -0.566148565567426  LUMO = 1.22777160009531
  mo_energy =
[-1.18119222e+02 -1.21575483e+01 -9.51179626e+00 -9.51179626e+00
 -9.51179626e+00 -1.24465056e+00 -5.66148566e-01 -5.66148566e-01
 -5.66148566e-01  1.22777160e+00  1.22777160e+00  1.22777160e+00
  1.15434529e+01  1.15434529e+01  1.15434529e+01  6.12275436e+01
  6.12275436e+01  6.12275436e+01  1.67019313e+02  2.47640523e+02
  2.47640523e+02  2.47640523e+02  7.19833338e+02  7.19833338e+02
  7.19833338e+02  1.62409781e+03  1.62409781e+03  1.62409781e+03
  1.77609137e+03  3.32560774e+03  3.32560774e+03  3.32560774e+03
  6.92693560e+03  6.92693560e+03  6.92693560e+03  7.91300414e+03
  2.41345252e+04  7.48741891e+04]
E1 = -727.667848944032  E_coul = 202.07863355994496
cycle= 5 E= -525.589215384087  delta_E= -1.06e-10  |g|= 2.88e-06  |ddm|= 1.92e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.667848944032  E_coul = 202.07863355994496
  HOMO = -0.566150077701975  LUMO = 1.22777025469786
  mo_energy =
[-1.18119229e+02 -1.21575536e+01 -9.51180174e+00 -9.51180174e+00
 -9.51180174e+00 -1.24465254e+00 -5.66150078e-01 -5.66150078e-01
 -5.66150078e-01  1.22777025e+00  1.22777025e+00  1.22777025e+00
  1.15434484e+01  1.15434484e+01  1.15434484e+01  6.12275375e+01
  6.12275375e+01  6.12275375e+01  1.67019305e+02  2.47640516e+02
  2.47640516e+02  2.47640516e+02  7.19833330e+02  7.19833330e+02
  7.19833330e+02  1.62409780e+03  1.62409780e+03  1.62409780e+03
  1.77609137e+03  3.32560774e+03  3.32560774e+03  3.32560774e+03
  6.92693559e+03  6.92693559e+03  6.92693559e+03  7.91300413e+03
  2.41345252e+04  7.48741891e+04]
E1 = -727.6678624993423  E_coul = 202.07864711525409
Extra cycle  E= -525.589215384088  delta_E= -1.14e-12  |g|= 6.91e-07  |ddm|= 1.52e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.22 sec
exp = [2.61828951e+04 7.61400750e+03 3.60981586e+03 1.48680863e+03
 2.21881191e+02 4.99256655e+01 4.60619383e+00 3.97845453e-01
 1.36279590e+03 6.63612946e+02 2.95241397e+02 3.09065382e+02
 1.35187224e+02 1.16285549e+01 3.66667297e+01 8.84529415e-01
 3.97114328e+00 2.46591585e-01]
E = -525.5892153840882
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:28 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8951169        1
[INPUT] 0    0    [1    /1   ]  7614.00749502        1
[INPUT] 0    0    [1    /1   ]  3609.81586087        1
[INPUT] 0    0    [1    /1   ]  1486.80862751        1
[INPUT] 0    0    [1    /1   ]  221.881190881        1
[INPUT] 0    0    [1    /1   ]  49.9256655248        1
[INPUT] 0    0    [1    /1   ]  4.60619382725        1
[INPUT] 0    0    [1    /1   ]  0.397845452552       1
[INPUT] 1    0    [1    /1   ]  1362.79590193        1
[INPUT] 1    0    [1    /1   ]  663.612945791        1
[INPUT] 1    0    [1    /1   ]  295.241396675        1
[INPUT] 1    0    [1    /1   ]  309.06538243         1
[INPUT] 1    0    [1    /1   ]  135.18722377         1
[INPUT] 1    0    [1    /1   ]  11.6285549415        1
[INPUT] 1    0    [1    /1   ]  36.6667296657        1
[INPUT] 1    0    [1    /1   ]  0.884529415257       1
[INPUT] 1    0    [1    /1   ]  3.97114327887        1
[INPUT] 1    0    [1    /1   ]  0.246591585491       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.895116937936, 1.0]], [0, [7614.007495022707, 1.0]], [0, [3609.815860870305, 1.0]], [0, [1486.8086275094684, 1.0]], [0, [221.8811908808922, 1.0]], [0, [49.92566552479554, 1.0]], [0, [4.606193827248798, 1.0]], [0, [0.39784545255213927, 1.0]], [1, [1362.7959019335497, 1.0]], [1, [663.6129457905143, 1.0]], [1, [295.2413966752374, 1.0]], [1, [309.0653824304854, 1.0]], [1, [135.1872237700462, 1.0]], [1, [11.628554941483902, 1.0]], [1, [36.66672966572603, 1.0]], [1, [0.8845294152569366, 1.0]], [1, [3.9711432788656347, 1.0]], [1, [0.24659158549115, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.89511694]
bas 1, expnt(s) = [7614.00749502]
bas 2, expnt(s) = [3609.81586087]
bas 3, expnt(s) = [1486.80862751]
bas 4, expnt(s) = [221.88119088]
bas 5, expnt(s) = [49.92566552]
bas 6, expnt(s) = [4.60619383]
bas 7, expnt(s) = [0.39784545]
bas 8, expnt(s) = [1362.79590193]
bas 9, expnt(s) = [663.61294579]
bas 10, expnt(s) = [295.24139668]
bas 11, expnt(s) = [309.06538243]
bas 12, expnt(s) = [135.18722377]
bas 13, expnt(s) = [11.62855494]
bas 14, expnt(s) = [36.66672967]
bas 15, expnt(s) = [0.88452942]
bas 16, expnt(s) = [3.97114328]
bas 17, expnt(s) = [0.24659159]
CPU time:       494.51
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828951e+04 5.20029851e+03 7.61400750e+03 2.05932551e+03
 3.60981586e+03 1.17659991e+03 1.48680863e+03 6.04931680e+02
 2.21881191e+02 1.45246404e+02 4.99256655e+01 4.74523715e+01
 4.60619383e+00 7.94367890e+00 3.97845453e-01 1.26561270e+00
 1.36279590e+03 2.41558829e+04 6.63612946e+02 9.82602703e+03
 2.95241397e+02 3.57031025e+03 3.09065382e+02 3.78048350e+03
 1.35187224e+02 1.34478840e+03 1.16285549e+01 6.26457451e+01
 3.66667297e+01 2.63223472e+02 8.84529415e-01 2.50250378e+00
 3.97114328e+00 1.63541824e+01 2.46591585e-01 5.06940757e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9684758487671
cond(S) = 321145.5399123251
E1 = -727.4959695380137  E_coul = 203.10550591553942
init E= -524.390463622474
    CPU time for initialize scf      0.65 sec, wall time      0.07 sec
  HOMO = -0.558800915576049  LUMO = 1.23240248191235
  mo_energy =
[-1.17910829e+02 -1.20900231e+01 -9.44446516e+00 -9.44446516e+00
 -9.44446516e+00 -1.23043653e+00 -5.58800916e-01 -5.58800916e-01
 -5.58800916e-01  1.23240248e+00  1.23240248e+00  1.23240248e+00
  1.15932664e+01  1.15932664e+01  1.15932664e+01  6.13283427e+01
  6.13283427e+01  6.13283427e+01  1.67169935e+02  2.47800110e+02
  2.47800110e+02  2.47800110e+02  7.20034586e+02  7.20034586e+02
  7.20034586e+02  1.62434043e+03  1.62434043e+03  1.62434043e+03
  1.77645908e+03  3.32591409e+03  3.32591409e+03  3.32591409e+03
  6.92736821e+03  6.92736821e+03  6.92736821e+03  7.91352585e+03
  2.41351487e+04  7.48749082e+04]
E1 = -727.518045760453  E_coul = 201.92900676173363
cycle= 1 E= -525.589038998719  delta_E= -1.2  |g|= 0.195  |ddm|= 0.727
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.476975
diis-c [-0.2275055  1.       ]
  HOMO = -0.567871725520509  LUMO = 1.22609113381771
  mo_energy =
[-1.18143133e+02 -1.21682984e+01 -9.52269880e+00 -9.52269880e+00
 -9.52269880e+00 -1.24697424e+00 -5.67871726e-01 -5.67871726e-01
 -5.67871726e-01  1.22609113e+00  1.22609113e+00  1.22609113e+00
  1.15356681e+01  1.15356681e+01  1.15356681e+01  6.12123417e+01
  6.12123417e+01  6.12123417e+01  1.66996623e+02  2.47619246e+02
  2.47619246e+02  2.47619246e+02  7.19809412e+02  7.19809412e+02
  7.19809412e+02  1.62407257e+03  1.62407257e+03  1.62407257e+03
  1.77606489e+03  3.32558162e+03  3.32558162e+03  3.32558162e+03
  6.92690902e+03  6.92690902e+03  6.92690902e+03  7.91297742e+03
  2.41344985e+04  7.48741626e+04]
E1 = -727.6991080099915  E_coul = 202.1098974394747
cycle= 2 E= -525.589210570517  delta_E= -0.000172  |g|= 0.0145  |ddm|= 0.0135
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0278723
diis-c [-6.16012801e-04  2.59354038e-02  9.74064596e-01]
  HOMO = -0.565727351184756  LUMO = 1.22816012421315
  mo_energy =
[-1.18115619e+02 -1.21556250e+01 -9.50982858e+00 -9.50982858e+00
 -9.50982858e+00 -1.24409374e+00 -5.65727351e-01 -5.65727351e-01
 -5.65727351e-01  1.22816012e+00  1.22816012e+00  1.22816012e+00
  1.15449483e+01  1.15449483e+01  1.15449483e+01  6.12300429e+01
  6.12300429e+01  6.12300429e+01  1.67022695e+02  2.47643786e+02
  2.47643786e+02  2.47643786e+02  7.19836935e+02  7.19836935e+02
  7.19836935e+02  1.62410158e+03  1.62410158e+03  1.62410158e+03
  1.77609538e+03  3.32561166e+03  3.32561166e+03  3.32561166e+03
  6.92693966e+03  6.92693966e+03  6.92693966e+03  7.91300829e+03
  2.41345294e+04  7.48741934e+04]
E1 = -727.6625210283149  E_coul = 202.07330577332868
cycle= 3 E= -525.589215254986  delta_E= -4.68e-06  |g|= 0.00196  |ddm|= 0.00324
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00398814
diis-c [-8.04612559e-08 -7.73679219e-04  1.19762093e-01  8.81011586e-01]
  HOMO = -0.566169581247965  LUMO = 1.22775296383884
  mo_energy =
[-1.18119305e+02 -1.21576175e+01 -9.51186609e+00 -9.51186609e+00
 -9.51186609e+00 -1.24467789e+00 -5.66169581e-01 -5.66169581e-01
 -5.66169581e-01  1.22775296e+00  1.22775296e+00  1.22775296e+00
  1.15433945e+01  1.15433945e+01  1.15433945e+01  6.12274689e+01
  6.12274689e+01  6.12274689e+01  1.67019229e+02  2.47640441e+02
  2.47640441e+02  2.47640441e+02  7.19833254e+02  7.19833254e+02
  7.19833254e+02  1.62409773e+03  1.62409773e+03  1.62409773e+03
  1.77609129e+03  3.32560766e+03  3.32560766e+03  3.32560766e+03
  6.92693552e+03  6.92693552e+03  6.92693552e+03  7.91300406e+03
  2.41345251e+04  7.48741890e+04]
E1 = -727.6680149728192  E_coul = 202.0787995888376
cycle= 4 E= -525.589215383982  delta_E= -1.29e-07  |g|= 3.63e-05  |ddm|= 0.000536
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=5.95006e-05
diis-c [-4.61039429e-10 -1.92027484e-05  2.53322367e-03  3.20413901e-02
  9.65444589e-01]
  HOMO = -0.566148565567426  LUMO = 1.22777160009531
  mo_energy =
[-1.18119222e+02 -1.21575483e+01 -9.51179626e+00 -9.51179626e+00
 -9.51179626e+00 -1.24465056e+00 -5.66148566e-01 -5.66148566e-01
 -5.66148566e-01  1.22777160e+00  1.22777160e+00  1.22777160e+00
  1.15434529e+01  1.15434529e+01  1.15434529e+01  6.12275436e+01
  6.12275436e+01  6.12275436e+01  1.67019313e+02  2.47640523e+02
  2.47640523e+02  2.47640523e+02  7.19833338e+02  7.19833338e+02
  7.19833338e+02  1.62409781e+03  1.62409781e+03  1.62409781e+03
  1.77609137e+03  3.32560774e+03  3.32560774e+03  3.32560774e+03
  6.92693560e+03  6.92693560e+03  6.92693560e+03  7.91300414e+03
  2.41345252e+04  7.48741891e+04]
E1 = -727.667848944032  E_coul = 202.07863355994496
cycle= 5 E= -525.589215384087  delta_E= -1.06e-10  |g|= 2.88e-06  |ddm|= 1.92e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.667848944032  E_coul = 202.07863355994496
  HOMO = -0.566150077701975  LUMO = 1.22777025469786
  mo_energy =
[-1.18119229e+02 -1.21575536e+01 -9.51180174e+00 -9.51180174e+00
 -9.51180174e+00 -1.24465254e+00 -5.66150078e-01 -5.66150078e-01
 -5.66150078e-01  1.22777025e+00  1.22777025e+00  1.22777025e+00
  1.15434484e+01  1.15434484e+01  1.15434484e+01  6.12275375e+01
  6.12275375e+01  6.12275375e+01  1.67019305e+02  2.47640516e+02
  2.47640516e+02  2.47640516e+02  7.19833330e+02  7.19833330e+02
  7.19833330e+02  1.62409780e+03  1.62409780e+03  1.62409780e+03
  1.77609137e+03  3.32560774e+03  3.32560774e+03  3.32560774e+03
  6.92693559e+03  6.92693559e+03  6.92693559e+03  7.91300413e+03
  2.41345252e+04  7.48741891e+04]
E1 = -727.6678624993423  E_coul = 202.07864711525409
Extra cycle  E= -525.589215384088  delta_E= -1.14e-12  |g|= 6.91e-07  |ddm|= 1.52e-06
    CPU time for scf_cycle      0.80 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 321145.5399123251
E1 = -727.6678624993423  E_coul = 202.07864711525409
init E= -525.589215384088
    CPU time for initialize scf      1.40 sec, wall time      0.25 sec
  HOMO = -0.566149825008833  LUMO = 1.22777048362505
  mo_energy =
[-1.18119228e+02 -1.21575526e+01 -9.51180072e+00 -9.51180072e+00
 -9.51180072e+00 -1.24465221e+00 -5.66149825e-01 -5.66149825e-01
 -5.66149825e-01  1.22777048e+00  1.22777048e+00  1.22777048e+00
  1.15434493e+01  1.15434493e+01  1.15434493e+01  6.12275387e+01
  6.12275387e+01  6.12275387e+01  1.67019307e+02  2.47640517e+02
  2.47640517e+02  2.47640517e+02  7.19833332e+02  7.19833332e+02
  7.19833332e+02  1.62409780e+03  1.62409780e+03  1.62409780e+03
  1.77609137e+03  3.32560774e+03  3.32560774e+03  3.32560774e+03
  6.92693559e+03  6.92693559e+03  6.92693559e+03  7.91300413e+03
  2.41345252e+04  7.48741891e+04]
E1 = -727.6678598646503  E_coul = 202.07864448056293
cycle= 1 E= -525.589215384087  delta_E= 9.09e-13  |g|= 1.44e-07  |ddm|= 2.72e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.6678598646503  E_coul = 202.07864448056293
  HOMO = -0.566149871511298  LUMO = 1.2277704412693
  mo_energy =
[-1.18119228e+02 -1.21575528e+01 -9.51180092e+00 -9.51180092e+00
 -9.51180092e+00 -1.24465227e+00 -5.66149872e-01 -5.66149872e-01
 -5.66149872e-01  1.22777044e+00  1.22777044e+00  1.22777044e+00
  1.15434491e+01  1.15434491e+01  1.15434491e+01  6.12275385e+01
  6.12275385e+01  6.12275385e+01  1.67019307e+02  2.47640517e+02
  2.47640517e+02  2.47640517e+02  7.19833332e+02  7.19833332e+02
  7.19833332e+02  1.62409780e+03  1.62409780e+03  1.62409780e+03
  1.77609137e+03  3.32560774e+03  3.32560774e+03  3.32560774e+03
  6.92693559e+03  6.92693559e+03  6.92693559e+03  7.91300413e+03
  2.41345252e+04  7.48741891e+04]
E1 = -727.6678603826692  E_coul = 202.07864499858212
Extra cycle  E= -525.589215384087  delta_E= 2.27e-13  |g|= 2.91e-08  |ddm|= 5.25e-08
    CPU time for scf_cycle      1.78 sec, wall time      0.63 sec
exp = [2.61828951e+04 7.61400750e+03 3.60981586e+03 1.48680863e+03
 2.21881191e+02 4.99256655e+01 4.60619383e+00 3.97845453e-01
 1.36279590e+03 6.63612946e+02 2.95241397e+02 3.09065382e+02
 1.35187224e+02 1.16285549e+01 3.66667297e+01 8.84529415e-01
 3.97114328e+00 2.46591585e-01]
grad_E = [-2.01016899e-06  2.40657880e-05  4.49225473e-05  9.74960872e-04
 -4.73621252e-03  2.11870264e-03  2.69562233e-03  9.57153377e-03
  1.16129353e-08  3.71581047e-07  4.31504712e-06  4.11594418e-06
  2.97862582e-05 -1.31100402e-02  3.94378350e-03 -1.00627223e-02
  3.42249274e-02 -4.70038163e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.9520417        1
[INPUT] 0    0    [1    /1   ]  7613.38095874        1
[INPUT] 0    0    [1    /1   ]  3608.56687885        1
[INPUT] 0    0    [1    /1   ]  1467.39876901        1
[INPUT] 0    0    [1    /1   ]  221.089690563        1
[INPUT] 0    0    [1    /1   ]  49.8636074069        1
[INPUT] 0    0    [1    /1   ]  4.60629166544        1
[INPUT] 0    0    [1    /1   ]  0.39768291331        1
[INPUT] 1    0    [1    /1   ]  1362.78456715        1
[INPUT] 1    0    [1    /1   ]  663.283501967        1
[INPUT] 1    0    [1    /1   ]  293.492278636        1
[INPUT] 1    0    [1    /1   ]  307.5283332          1
[INPUT] 1    0    [1    /1   ]  160.377476592        1
[INPUT] 1    0    [1    /1   ]  12.4176439021        1
[INPUT] 1    0    [1    /1   ]  40.7972591072        1
[INPUT] 1    0    [1    /1   ]  0.900366474933       1
[INPUT] 1    0    [1    /1   ]  4.08048131323        1
[INPUT] 1    0    [1    /1   ]  0.251185986283       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.952041736287, 1.0]], [0, [7613.380958742936, 1.0]], [0, [3608.5668788512967, 1.0]], [0, [1467.3987690101778, 1.0]], [0, [221.08969056284275, 1.0]], [0, [49.86360740688864, 1.0]], [0, [4.606291665441137, 1.0]], [0, [0.3976829133095721, 1.0]], [1, [1362.7845671454288, 1.0]], [1, [663.2835019667417, 1.0]], [1, [293.49227863649077, 1.0]], [1, [307.52833319970733, 1.0]], [1, [160.3774765915737, 1.0]], [1, [12.417643902084247, 1.0]], [1, [40.797259107193945, 1.0]], [1, [0.9003664749327099, 1.0]], [1, [4.080481313234563, 1.0]], [1, [0.25118598628316247, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.95204174]
bas 1, expnt(s) = [7613.38095874]
bas 2, expnt(s) = [3608.56687885]
bas 3, expnt(s) = [1467.39876901]
bas 4, expnt(s) = [221.08969056]
bas 5, expnt(s) = [49.86360741]
bas 6, expnt(s) = [4.60629167]
bas 7, expnt(s) = [0.39768291]
bas 8, expnt(s) = [1362.78456715]
bas 9, expnt(s) = [663.28350197]
bas 10, expnt(s) = [293.49227864]
bas 11, expnt(s) = [307.5283332]
bas 12, expnt(s) = [160.37747659]
bas 13, expnt(s) = [12.4176439]
bas 14, expnt(s) = [40.79725911]
bas 15, expnt(s) = [0.90036647]
bas 16, expnt(s) = [4.08048131]
bas 17, expnt(s) = [0.25118599]
CPU time:       501.69
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61829520e+04 5.20030699e+03 7.61338096e+03 2.05919842e+03
 3.60856688e+03 1.17629457e+03 1.46739877e+03 5.98999055e+02
 2.21089691e+02 1.44857636e+02 4.98636074e+01 4.74081267e+01
 4.60629167e+00 7.94380545e+00 3.97682913e-01 1.26522488e+00
 1.36278457e+03 2.41556318e+04 6.63283502e+02 9.81992987e+03
 2.93492279e+02 3.54389008e+03 3.07528333e+02 3.75699667e+03
 1.60377477e+02 1.66499760e+03 1.24176439e+01 6.80038334e+01
 4.07972591e+01 3.00796741e+02 9.00366475e-01 2.55863618e+00
 4.08048131e+00 1.69189589e+01 2.51185986e-01 5.18774536e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.967229513511604
cond(S) = 514739.966304479
E1 = -727.5017021310232  E_coul = 203.10152129405947
init E= -524.400180836964
    CPU time for initialize scf      0.38 sec, wall time      0.06 sec
  HOMO = -0.558487291094028  LUMO = 1.267622919678
  mo_energy =
[-1.17918287e+02 -1.20907916e+01 -9.44329155e+00 -9.44329155e+00
 -9.44329155e+00 -1.23066994e+00 -5.58487291e-01 -5.58487291e-01
 -5.58487291e-01  1.26762292e+00  1.26762292e+00  1.26762292e+00
  1.22303154e+01  1.22303154e+01  1.22303154e+01  6.74036963e+01
  6.74036963e+01  6.74036963e+01  1.66554654e+02  2.74670489e+02
  2.74670489e+02  2.74670489e+02  7.77721872e+02  7.77721872e+02
  7.77721872e+02  1.70643786e+03  1.70643786e+03  1.70643786e+03
  1.76219048e+03  3.42013620e+03  3.42013620e+03  3.42013620e+03
  7.02110003e+03  7.02110003e+03  7.02110003e+03  7.86672699e+03
  2.40641913e+04  7.47957745e+04]
E1 = -727.5424694777846  E_coul = 201.94946033373301
cycle= 1 E= -525.593009144052  delta_E= -1.19  |g|= 0.195  |ddm|= 0.978
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.476487
diis-c [-0.22703995  1.        ]
  HOMO = -0.566058934004438  LUMO = 1.26226668411197
  mo_energy =
[-1.18150387e+02 -1.21675592e+01 -9.52011767e+00 -9.52011767e+00
 -9.52011767e+00 -1.24539851e+00 -5.66058934e-01 -5.66058934e-01
 -5.66058934e-01  1.26226668e+00  1.26226668e+00  1.26226668e+00
  1.21723234e+01  1.21723234e+01  1.21723234e+01  6.72822885e+01
  6.72822885e+01  6.72822885e+01  1.66381819e+02  2.74484444e+02
  2.74484444e+02  2.74484444e+02  7.77494244e+02  7.77494244e+02
  7.77494244e+02  1.70616974e+03  1.70616974e+03  1.70616974e+03
  1.76179821e+03  3.41980488e+03  3.41980488e+03  3.41980488e+03
  7.02064269e+03  7.02064269e+03  7.02064269e+03  7.86618057e+03
  2.40635431e+04  7.47950311e+04]
E1 = -727.7177974175908  E_coul = 202.1246174064672
cycle= 2 E= -525.593180011124  delta_E= -0.000171  |g|= 0.0144  |ddm|= 0.0135
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0271935
diis-c [-5.88546655e-04  2.51676738e-02  9.74832326e-01]
  HOMO = -0.564054912037076  LUMO = 1.26426609519715
  mo_energy =
[-1.18123260e+02 -1.21553127e+01 -9.50768287e+00 -9.50768287e+00
 -9.50768287e+00 -1.24270228e+00 -5.64054912e-01 -5.64054912e-01
 -5.64054912e-01  1.26426610e+00  1.26426610e+00  1.26426610e+00
  1.21815949e+01  1.21815949e+01  1.21815949e+01  6.73003149e+01
  6.73003149e+01  6.73003149e+01  1.66407479e+02  2.74509033e+02
  2.74509033e+02  2.74509033e+02  7.77521523e+02  7.77521523e+02
  7.77521523e+02  1.70619840e+03  1.70619840e+03  1.70619840e+03
  1.76182834e+03  3.41983455e+03  3.41983455e+03  3.41983455e+03
  7.02067297e+03  7.02067297e+03  7.02067297e+03  7.86621109e+03
  2.40635736e+04  7.47950615e+04]
E1 = -727.6824474463955  E_coul = 202.08926296351845
cycle= 3 E= -525.593184482877  delta_E= -4.47e-06  |g|= 0.00193  |ddm|= 0.00313
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00385548
diis-c [-7.98190273e-08 -7.73785465e-04  1.18622104e-01  8.82151682e-01]
  HOMO = -0.564479079810145  LUMO = 1.26386485579087
  mo_energy =
[-1.18126873e+02 -1.21572485e+01 -9.50966275e+00 -9.50966275e+00
 -9.50966275e+00 -1.24326286e+00 -5.64479080e-01 -5.64479080e-01
 -5.64479080e-01  1.26386486e+00  1.26386486e+00  1.26386486e+00
  1.21800430e+01  1.21800430e+01  1.21800430e+01  6.72977190e+01
  6.72977190e+01  6.72977190e+01  1.66404086e+02  2.74505709e+02
  2.74505709e+02  2.74505709e+02  7.77517899e+02  7.77517899e+02
  7.77517899e+02  1.70619461e+03  1.70619461e+03  1.70619461e+03
  1.76182433e+03  3.41983062e+03  3.41983062e+03  3.41983062e+03
  7.02066890e+03  7.02066890e+03  7.02066890e+03  7.86620694e+03
  2.40635694e+04  7.47950573e+04]
E1 = -727.6877445725578  E_coul = 202.09455996833609
cycle= 4 E= -525.593184604222  delta_E= -1.21e-07  |g|= 3.62e-05  |ddm|= 0.000519
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=5.80466e-05
diis-c [-4.60175158e-10 -1.90388566e-05  2.46837787e-03  3.18441530e-02
  9.65706508e-01]
  HOMO = -0.564458196654973  LUMO = 1.26388382855626
  mo_energy =
[-1.18126789e+02 -1.21571793e+01 -9.50959304e+00 -9.50959304e+00
 -9.50959304e+00 -1.24323569e+00 -5.64458197e-01 -5.64458197e-01
 -5.64458197e-01  1.26388383e+00  1.26388383e+00  1.26388383e+00
  1.21801023e+01  1.21801023e+01  1.21801023e+01  6.72977946e+01
  6.72977946e+01  6.72977946e+01  1.66404169e+02  2.74505791e+02
  2.74505791e+02  2.74505791e+02  7.77517983e+02  7.77517983e+02
  7.77517983e+02  1.70619469e+03  1.70619469e+03  1.70619469e+03
  1.76182441e+03  3.41983070e+03  3.41983070e+03  3.41983070e+03
  7.02066898e+03  7.02066898e+03  7.02066898e+03  7.86620702e+03
  2.40635695e+04  7.47950574e+04]
E1 = -727.6875809356445  E_coul = 202.09439633131967
cycle= 5 E= -525.593184604325  delta_E= -1.03e-10  |g|= 2.91e-06  |ddm|= 1.9e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.6875809356445  E_coul = 202.09439633131967
  HOMO = -0.564459704161473  LUMO = 1.26388245374255
  mo_energy =
[-1.18126797e+02 -1.21571848e+01 -9.50959855e+00 -9.50959855e+00
 -9.50959855e+00 -1.24323766e+00 -5.64459704e-01 -5.64459704e-01
 -5.64459704e-01  1.26388245e+00  1.26388245e+00  1.26388245e+00
  1.21800978e+01  1.21800978e+01  1.21800978e+01  6.72977883e+01
  6.72977883e+01  6.72977883e+01  1.66404162e+02  2.74505784e+02
  2.74505784e+02  2.74505784e+02  7.77517975e+02  7.77517975e+02
  7.77517975e+02  1.70619468e+03  1.70619468e+03  1.70619468e+03
  1.76182440e+03  3.41983069e+03  3.41983069e+03  3.41983069e+03
  7.02066898e+03  7.02066898e+03  7.02066898e+03  7.86620701e+03
  2.40635695e+04  7.47950574e+04]
E1 = -727.6875943687521  E_coul = 202.09440976442605
Extra cycle  E= -525.593184604326  delta_E= -1.25e-12  |g|= 6.91e-07  |ddm|= 1.51e-06
    CPU time for scf_cycle      0.53 sec, wall time      0.20 sec
exp = [2.61829520e+04 7.61338096e+03 3.60856688e+03 1.46739877e+03
 2.21089691e+02 4.98636074e+01 4.60629167e+00 3.97682913e-01
 1.36278457e+03 6.63283502e+02 2.93492279e+02 3.07528333e+02
 1.60377477e+02 1.24176439e+01 4.07972591e+01 9.00366475e-01
 4.08048131e+00 2.51185986e-01]
E = -525.5931846043261
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.9520417        1
[INPUT] 0    0    [1    /1   ]  7613.38095874        1
[INPUT] 0    0    [1    /1   ]  3608.56687885        1
[INPUT] 0    0    [1    /1   ]  1467.39876901        1
[INPUT] 0    0    [1    /1   ]  221.089690563        1
[INPUT] 0    0    [1    /1   ]  49.8636074069        1
[INPUT] 0    0    [1    /1   ]  4.60629166544        1
[INPUT] 0    0    [1    /1   ]  0.39768291331        1
[INPUT] 1    0    [1    /1   ]  1362.78456715        1
[INPUT] 1    0    [1    /1   ]  663.283501967        1
[INPUT] 1    0    [1    /1   ]  293.492278636        1
[INPUT] 1    0    [1    /1   ]  307.5283332          1
[INPUT] 1    0    [1    /1   ]  160.377476592        1
[INPUT] 1    0    [1    /1   ]  12.4176439021        1
[INPUT] 1    0    [1    /1   ]  40.7972591072        1
[INPUT] 1    0    [1    /1   ]  0.900366474933       1
[INPUT] 1    0    [1    /1   ]  4.08048131323        1
[INPUT] 1    0    [1    /1   ]  0.251185986283       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26182.952041736287, 1.0]], [0, [7613.380958742936, 1.0]], [0, [3608.5668788512967, 1.0]], [0, [1467.3987690101778, 1.0]], [0, [221.08969056284275, 1.0]], [0, [49.86360740688864, 1.0]], [0, [4.606291665441137, 1.0]], [0, [0.3976829133095721, 1.0]], [1, [1362.7845671454288, 1.0]], [1, [663.2835019667417, 1.0]], [1, [293.49227863649077, 1.0]], [1, [307.52833319970733, 1.0]], [1, [160.3774765915737, 1.0]], [1, [12.417643902084247, 1.0]], [1, [40.797259107193945, 1.0]], [1, [0.9003664749327099, 1.0]], [1, [4.080481313234563, 1.0]], [1, [0.25118598628316247, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.95204174]
bas 1, expnt(s) = [7613.38095874]
bas 2, expnt(s) = [3608.56687885]
bas 3, expnt(s) = [1467.39876901]
bas 4, expnt(s) = [221.08969056]
bas 5, expnt(s) = [49.86360741]
bas 6, expnt(s) = [4.60629167]
bas 7, expnt(s) = [0.39768291]
bas 8, expnt(s) = [1362.78456715]
bas 9, expnt(s) = [663.28350197]
bas 10, expnt(s) = [293.49227864]
bas 11, expnt(s) = [307.5283332]
bas 12, expnt(s) = [160.37747659]
bas 13, expnt(s) = [12.4176439]
bas 14, expnt(s) = [40.79725911]
bas 15, expnt(s) = [0.90036647]
bas 16, expnt(s) = [4.08048131]
bas 17, expnt(s) = [0.25118599]
CPU time:       502.48
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61829520e+04 5.20030699e+03 7.61338096e+03 2.05919842e+03
 3.60856688e+03 1.17629457e+03 1.46739877e+03 5.98999055e+02
 2.21089691e+02 1.44857636e+02 4.98636074e+01 4.74081267e+01
 4.60629167e+00 7.94380545e+00 3.97682913e-01 1.26522488e+00
 1.36278457e+03 2.41556318e+04 6.63283502e+02 9.81992987e+03
 2.93492279e+02 3.54389008e+03 3.07528333e+02 3.75699667e+03
 1.60377477e+02 1.66499760e+03 1.24176439e+01 6.80038334e+01
 4.07972591e+01 3.00796741e+02 9.00366475e-01 2.55863618e+00
 4.08048131e+00 1.69189589e+01 2.51185986e-01 5.18774536e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.967229513511604
cond(S) = 514739.966304479
E1 = -727.5017021310232  E_coul = 203.10152129405947
init E= -524.400180836964
    CPU time for initialize scf      0.13 sec, wall time      0.04 sec
  HOMO = -0.558487291094028  LUMO = 1.267622919678
  mo_energy =
[-1.17918287e+02 -1.20907916e+01 -9.44329155e+00 -9.44329155e+00
 -9.44329155e+00 -1.23066994e+00 -5.58487291e-01 -5.58487291e-01
 -5.58487291e-01  1.26762292e+00  1.26762292e+00  1.26762292e+00
  1.22303154e+01  1.22303154e+01  1.22303154e+01  6.74036963e+01
  6.74036963e+01  6.74036963e+01  1.66554654e+02  2.74670489e+02
  2.74670489e+02  2.74670489e+02  7.77721872e+02  7.77721872e+02
  7.77721872e+02  1.70643786e+03  1.70643786e+03  1.70643786e+03
  1.76219048e+03  3.42013620e+03  3.42013620e+03  3.42013620e+03
  7.02110003e+03  7.02110003e+03  7.02110003e+03  7.86672699e+03
  2.40641913e+04  7.47957745e+04]
E1 = -727.5424694777846  E_coul = 201.94946033373301
cycle= 1 E= -525.593009144052  delta_E= -1.19  |g|= 0.195  |ddm|= 0.978
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.476487
diis-c [-0.22703995  1.        ]
  HOMO = -0.566058934004438  LUMO = 1.26226668411197
  mo_energy =
[-1.18150387e+02 -1.21675592e+01 -9.52011767e+00 -9.52011767e+00
 -9.52011767e+00 -1.24539851e+00 -5.66058934e-01 -5.66058934e-01
 -5.66058934e-01  1.26226668e+00  1.26226668e+00  1.26226668e+00
  1.21723234e+01  1.21723234e+01  1.21723234e+01  6.72822885e+01
  6.72822885e+01  6.72822885e+01  1.66381819e+02  2.74484444e+02
  2.74484444e+02  2.74484444e+02  7.77494244e+02  7.77494244e+02
  7.77494244e+02  1.70616974e+03  1.70616974e+03  1.70616974e+03
  1.76179821e+03  3.41980488e+03  3.41980488e+03  3.41980488e+03
  7.02064269e+03  7.02064269e+03  7.02064269e+03  7.86618057e+03
  2.40635431e+04  7.47950311e+04]
E1 = -727.7177974175908  E_coul = 202.1246174064672
cycle= 2 E= -525.593180011124  delta_E= -0.000171  |g|= 0.0144  |ddm|= 0.0135
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0271935
diis-c [-5.88546655e-04  2.51676738e-02  9.74832326e-01]
  HOMO = -0.564054912037076  LUMO = 1.26426609519715
  mo_energy =
[-1.18123260e+02 -1.21553127e+01 -9.50768287e+00 -9.50768287e+00
 -9.50768287e+00 -1.24270228e+00 -5.64054912e-01 -5.64054912e-01
 -5.64054912e-01  1.26426610e+00  1.26426610e+00  1.26426610e+00
  1.21815949e+01  1.21815949e+01  1.21815949e+01  6.73003149e+01
  6.73003149e+01  6.73003149e+01  1.66407479e+02  2.74509033e+02
  2.74509033e+02  2.74509033e+02  7.77521523e+02  7.77521523e+02
  7.77521523e+02  1.70619840e+03  1.70619840e+03  1.70619840e+03
  1.76182834e+03  3.41983455e+03  3.41983455e+03  3.41983455e+03
  7.02067297e+03  7.02067297e+03  7.02067297e+03  7.86621109e+03
  2.40635736e+04  7.47950615e+04]
E1 = -727.6824474463955  E_coul = 202.08926296351845
cycle= 3 E= -525.593184482877  delta_E= -4.47e-06  |g|= 0.00193  |ddm|= 0.00313
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00385548
diis-c [-7.98190273e-08 -7.73785465e-04  1.18622104e-01  8.82151682e-01]
  HOMO = -0.564479079810145  LUMO = 1.26386485579087
  mo_energy =
[-1.18126873e+02 -1.21572485e+01 -9.50966275e+00 -9.50966275e+00
 -9.50966275e+00 -1.24326286e+00 -5.64479080e-01 -5.64479080e-01
 -5.64479080e-01  1.26386486e+00  1.26386486e+00  1.26386486e+00
  1.21800430e+01  1.21800430e+01  1.21800430e+01  6.72977190e+01
  6.72977190e+01  6.72977190e+01  1.66404086e+02  2.74505709e+02
  2.74505709e+02  2.74505709e+02  7.77517899e+02  7.77517899e+02
  7.77517899e+02  1.70619461e+03  1.70619461e+03  1.70619461e+03
  1.76182433e+03  3.41983062e+03  3.41983062e+03  3.41983062e+03
  7.02066890e+03  7.02066890e+03  7.02066890e+03  7.86620694e+03
  2.40635694e+04  7.47950573e+04]
E1 = -727.6877445725578  E_coul = 202.09455996833609
cycle= 4 E= -525.593184604222  delta_E= -1.21e-07  |g|= 3.62e-05  |ddm|= 0.000519
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=5.80466e-05
diis-c [-4.60175158e-10 -1.90388566e-05  2.46837787e-03  3.18441530e-02
  9.65706508e-01]
  HOMO = -0.564458196654973  LUMO = 1.26388382855626
  mo_energy =
[-1.18126789e+02 -1.21571793e+01 -9.50959304e+00 -9.50959304e+00
 -9.50959304e+00 -1.24323569e+00 -5.64458197e-01 -5.64458197e-01
 -5.64458197e-01  1.26388383e+00  1.26388383e+00  1.26388383e+00
  1.21801023e+01  1.21801023e+01  1.21801023e+01  6.72977946e+01
  6.72977946e+01  6.72977946e+01  1.66404169e+02  2.74505791e+02
  2.74505791e+02  2.74505791e+02  7.77517983e+02  7.77517983e+02
  7.77517983e+02  1.70619469e+03  1.70619469e+03  1.70619469e+03
  1.76182441e+03  3.41983070e+03  3.41983070e+03  3.41983070e+03
  7.02066898e+03  7.02066898e+03  7.02066898e+03  7.86620702e+03
  2.40635695e+04  7.47950574e+04]
E1 = -727.6875809356445  E_coul = 202.09439633131967
cycle= 5 E= -525.593184604325  delta_E= -1.03e-10  |g|= 2.91e-06  |ddm|= 1.9e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.6875809356445  E_coul = 202.09439633131967
  HOMO = -0.564459704161473  LUMO = 1.26388245374255
  mo_energy =
[-1.18126797e+02 -1.21571848e+01 -9.50959855e+00 -9.50959855e+00
 -9.50959855e+00 -1.24323766e+00 -5.64459704e-01 -5.64459704e-01
 -5.64459704e-01  1.26388245e+00  1.26388245e+00  1.26388245e+00
  1.21800978e+01  1.21800978e+01  1.21800978e+01  6.72977883e+01
  6.72977883e+01  6.72977883e+01  1.66404162e+02  2.74505784e+02
  2.74505784e+02  2.74505784e+02  7.77517975e+02  7.77517975e+02
  7.77517975e+02  1.70619468e+03  1.70619468e+03  1.70619468e+03
  1.76182440e+03  3.41983069e+03  3.41983069e+03  3.41983069e+03
  7.02066898e+03  7.02066898e+03  7.02066898e+03  7.86620701e+03
  2.40635695e+04  7.47950574e+04]
E1 = -727.6875943687521  E_coul = 202.09440976442605
Extra cycle  E= -525.593184604326  delta_E= -1.25e-12  |g|= 6.91e-07  |ddm|= 1.51e-06
    CPU time for scf_cycle      0.27 sec, wall time      0.18 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 514739.966304479
E1 = -727.6875943687521  E_coul = 202.09440976442605
init E= -525.593184604326
    CPU time for initialize scf      1.21 sec, wall time      0.20 sec
  HOMO = -0.564459455930519  LUMO = 1.26388268449104
  mo_energy =
[-1.18126795e+02 -1.21571838e+01 -9.50959754e+00 -9.50959754e+00
 -9.50959754e+00 -1.24323734e+00 -5.64459456e-01 -5.64459456e-01
 -5.64459456e-01  1.26388268e+00  1.26388268e+00  1.26388268e+00
  1.21800986e+01  1.21800986e+01  1.21800986e+01  6.72977895e+01
  6.72977895e+01  6.72977895e+01  1.66404164e+02  2.74505785e+02
  2.74505785e+02  2.74505785e+02  7.77517977e+02  7.77517977e+02
  7.77517977e+02  1.70619469e+03  1.70619469e+03  1.70619469e+03
  1.76182440e+03  3.41983069e+03  3.41983069e+03  3.41983069e+03
  7.02066898e+03  7.02066898e+03  7.02066898e+03  7.86620702e+03
  2.40635695e+04  7.47950574e+04]
E1 = -727.6875917826097  E_coul = 202.0944071782827
cycle= 1 E= -525.593184604327  delta_E= -9.09e-13  |g|= 1.43e-07  |ddm|= 2.69e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -727.6875917826097  E_coul = 202.0944071782827
  HOMO = -0.564459501198184  LUMO = 1.26388264217993
  mo_energy =
[-1.18126796e+02 -1.21571839e+01 -9.50959773e+00 -9.50959773e+00
 -9.50959773e+00 -1.24323740e+00 -5.64459501e-01 -5.64459501e-01
 -5.64459501e-01  1.26388264e+00  1.26388264e+00  1.26388264e+00
  1.21800985e+01  1.21800985e+01  1.21800985e+01  6.72977893e+01
  6.72977893e+01  6.72977893e+01  1.66404163e+02  2.74505785e+02
  2.74505785e+02  2.74505785e+02  7.77517977e+02  7.77517977e+02
  7.77517977e+02  1.70619469e+03  1.70619469e+03  1.70619469e+03
  1.76182440e+03  3.41983069e+03  3.41983069e+03  3.41983069e+03
  7.02066898e+03  7.02066898e+03  7.02066898e+03  7.86620702e+03
  2.40635695e+04  7.47950574e+04]
E1 = -727.6875922862241  E_coul = 202.09440768189705
Extra cycle  E= -525.593184604327  delta_E=    0  |g|= 2.86e-08  |ddm|= 5.13e-08
    CPU time for scf_cycle      1.32 sec, wall time      0.31 sec
exp = [2.61829520e+04 7.61338096e+03 3.60856688e+03 1.46739877e+03
 2.21089691e+02 4.98636074e+01 4.60629167e+00 3.97682913e-01
 1.36278457e+03 6.63283502e+02 2.93492279e+02 3.07528333e+02
 1.60377477e+02 1.24176439e+01 4.07972591e+01 9.00366475e-01
 4.08048131e+00 2.51185986e-01]
grad_E = [-2.01764856e-06  2.33709122e-05  4.18737945e-05  9.84768048e-04
 -4.68656185e-03  2.41917754e-03  2.47106047e-03  9.27674989e-03
 -2.34151041e-07  5.73854554e-08  5.63294978e-07  6.01126661e-07
 -1.55610694e-05 -1.01167194e-02  4.88401512e-03 -1.38353855e-02
  1.44374575e-02 -1.43442148e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26183.0759533        1
[INPUT] 0    0    [1    /1   ]  7612.01946415        1
[INPUT] 0    0    [1    /1   ]  3605.85622863        1
[INPUT] 0    0    [1    /1   ]  1425.20006484        1
[INPUT] 0    0    [1    /1   ]  218.167739431        1
[INPUT] 0    0    [1    /1   ]  49.4472080095        1
[INPUT] 0    0    [1    /1   ]  4.60343091538        1
[INPUT] 0    0    [1    /1   ]  0.396229011194       1
[INPUT] 1    0    [1    /1   ]  1362.77170829        1
[INPUT] 1    0    [1    /1   ]  662.666284831        1
[INPUT] 1    0    [1    /1   ]  290.250891623        1
[INPUT] 1    0    [1    /1   ]  304.682682021        1
[INPUT] 1    0    [1    /1   ]  203.133568779        1
[INPUT] 1    0    [1    /1   ]  13.6847283766        1
[INPUT] 1    0    [1    /1   ]  46.8664152524        1
[INPUT] 1    0    [1    /1   ]  0.948274397201       1
[INPUT] 1    0    [1    /1   ]  4.31574952296        1
[INPUT] 1    0    [1    /1   ]  0.265277186619       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26183.07595334333, 1.0]], [0, [7612.019464153345, 1.0]], [0, [3605.8562286278793, 1.0]], [0, [1425.2000648377548, 1.0]], [0, [218.1677394313614, 1.0]], [0, [49.44720800950395, 1.0]], [0, [4.603430915382962, 1.0]], [0, [0.3962290111942137, 1.0]], [1, [1362.7717082900203, 1.0]], [1, [662.666284831177, 1.0]], [1, [290.250891623152, 1.0]], [1, [304.68268202066855, 1.0]], [1, [203.13356877910363, 1.0]], [1, [13.68472837657992, 1.0]], [1, [46.86641525241269, 1.0]], [1, [0.9482743972010041, 1.0]], [1, [4.315749522961345, 1.0]], [1, [0.26527718661902805, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26183.07595334]
bas 1, expnt(s) = [7612.01946415]
bas 2, expnt(s) = [3605.85622863]
bas 3, expnt(s) = [1425.20006484]
bas 4, expnt(s) = [218.16773943]
bas 5, expnt(s) = [49.44720801]
bas 6, expnt(s) = [4.60343092]
bas 7, expnt(s) = [0.39622901]
bas 8, expnt(s) = [1362.77170829]
bas 9, expnt(s) = [662.66628483]
bas 10, expnt(s) = [290.25089162]
bas 11, expnt(s) = [304.68268202]
bas 12, expnt(s) = [203.13356878]
bas 13, expnt(s) = [13.68472838]
bas 14, expnt(s) = [46.86641525]
bas 15, expnt(s) = [0.9482744]
bas 16, expnt(s) = [4.31574952]
bas 17, expnt(s) = [0.26527719]
CPU time:       508.59
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61830760e+04 5.20032545e+03 7.61201946e+03 2.05892223e+03
 3.60585623e+03 1.17563181e+03 1.42520006e+03 5.86032767e+02
 2.18167739e+02 1.43419407e+02 4.94472080e+01 4.71108950e+01
 4.60343092e+00 7.94010502e+00 3.96229011e-01 1.26175411e+00
 1.36277171e+03 2.41553469e+04 6.62666285e+02 9.80850881e+03
 2.90250892e+02 3.49503352e+03 3.04682682e+02 3.71359129e+03
 2.03133569e+02 2.23723454e+03 1.36847284e+01 7.67855713e+01
 4.68664153e+01 3.57735107e+02 9.48274397e-01 2.72993259e+00
 4.31574952e+00 1.81469934e+01 2.65277187e-01 5.55404343e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.963063160433435
cond(S) = 1363679.378740405
E1 = -727.4895774334817  E_coul = 203.06946240279268
init E= -524.420115030689
    CPU time for initialize scf      0.16 sec, wall time      0.05 sec
  HOMO = -0.558238729365252  LUMO = 1.37686017358591
  mo_energy =
[-1.17936823e+02 -1.20923751e+01 -9.44334552e+00 -9.44334552e+00
 -9.44334552e+00 -1.23142017e+00 -5.58238729e-01 -5.58238729e-01
 -5.58238729e-01  1.37686017e+00  1.37686017e+00  1.37686017e+00
  1.35365407e+01  1.35365407e+01  1.35365407e+01  7.71677265e+01
  7.71677265e+01  7.71677265e+01  1.63764250e+02  3.12414929e+02
  3.12414929e+02  3.12414929e+02  8.58625693e+02  8.58625693e+02
  8.58625693e+02  1.72611388e+03  1.82898843e+03  1.82898843e+03
  1.82898843e+03  3.57003519e+03  3.57003519e+03  3.57003519e+03
  7.17624671e+03  7.17624671e+03  7.17624671e+03  7.75881532e+03
  2.39043083e+04  7.46189584e+04]
E1 = -727.6677027288883  E_coul = 202.0661861952079
cycle= 1 E= -525.60151653368  delta_E= -1.18  |g|= 0.194  |ddm|= 1.64
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.476048
diis-c [-0.22662217  1.        ]
  HOMO = -0.56064790900834  LUMO = 1.37540846584576
  mo_energy =
[-1.18159772e+02 -1.21579850e+01 -9.50948698e+00 -9.50948698e+00
 -9.50948698e+00 -1.23959565e+00 -5.60647909e-01 -5.60647909e-01
 -5.60647909e-01  1.37540847e+00  1.37540847e+00  1.37540847e+00
  1.34847196e+01  1.34847196e+01  1.34847196e+01  7.70479541e+01
  7.70479541e+01  7.70479541e+01  1.63602266e+02  3.12231719e+02
  3.12231719e+02  3.12231719e+02  8.58402612e+02  8.58402612e+02
  8.58402612e+02  1.72572949e+03  1.82872626e+03  1.82872626e+03
  1.82872626e+03  3.56971057e+03  3.56971057e+03  3.56971057e+03
  7.17579536e+03  7.17579536e+03  7.17579536e+03  7.75827419e+03
  2.39036641e+04  7.46182188e+04]
E1 = -727.8151731655956  E_coul = 202.21349698915486
cycle= 2 E= -525.601676176441  delta_E= -0.00016  |g|= 0.0136  |ddm|= 0.0133
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0249207
diis-c [-5.00196736e-04  2.25952258e-02  9.77404774e-01]
  HOMO = -0.559246215085936  LUMO = 1.37697859407626
  mo_energy =
[-1.18135195e+02 -1.21477740e+01 -9.49911849e+00 -9.49911849e+00
 -9.49911849e+00 -1.23769353e+00 -5.59246215e-01 -5.59246215e-01
 -5.59246215e-01  1.37697859e+00  1.37697859e+00  1.37697859e+00
  1.34927989e+01  1.34927989e+01  1.34927989e+01  7.70646336e+01
  7.70646336e+01  7.70646336e+01  1.63625373e+02  3.12254319e+02
  3.12254319e+02  3.12254319e+02  8.58427533e+02  8.58427533e+02
  8.58427533e+02  1.72575699e+03  1.82875239e+03  1.82875239e+03
  1.82875239e+03  3.56973764e+03  3.56973764e+03  3.56973764e+03
  7.17582302e+03  7.17582302e+03  7.17582302e+03  7.75830209e+03
  2.39036920e+04  7.46182466e+04]
E1 = -727.7852263255759  E_coul = 202.18354667526938
cycle= 3 E= -525.601679650307  delta_E= -3.47e-06  |g|= 0.00174  |ddm|= 0.00258
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00342758
diis-c [-8.24826641e-08 -7.77520419e-04  1.14756817e-01  8.86020703e-01]
  HOMO = -0.559596309797468  LUMO = 1.37662031258372
  mo_energy =
[-1.18138419e+02 -1.21494457e+01 -9.50083101e+00 -9.50083101e+00
 -9.50083101e+00 -1.23815602e+00 -5.59596310e-01 -5.59596310e-01
 -5.59596310e-01  1.37662031e+00  1.37662031e+00  1.37662031e+00
  1.34913991e+01  1.34913991e+01  1.34913991e+01  7.70622521e+01
  7.70622521e+01  7.70622521e+01  1.63622363e+02  3.12251311e+02
  3.12251311e+02  3.12251311e+02  8.58424277e+02  8.58424277e+02
  8.58424277e+02  1.72575339e+03  1.82874899e+03  1.82874899e+03
  1.82874899e+03  3.56973412e+03  3.56973412e+03  3.56973412e+03
  7.17581936e+03  7.17581936e+03  7.17581936e+03  7.75829834e+03
  2.39036882e+04  7.46182427e+04]
E1 = -727.7897433327887  E_coul = 202.1880635914397
cycle= 4 E= -525.601679741349  delta_E= -9.1e-08  |g|= 3.64e-05  |ddm|= 0.000442
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.69421e-05
diis-c [-4.62631895e-10 -1.88585459e-05  2.24972028e-03  3.22361237e-02
  9.65533015e-01]
  HOMO = -0.559575825855264  LUMO = 1.37664024721627
  mo_energy =
[-1.18138334e+02 -1.21493764e+01 -9.50076116e+00 -9.50076116e+00
 -9.50076116e+00 -1.23812937e+00 -5.59575826e-01 -5.59575826e-01
 -5.59575826e-01  1.37664025e+00  1.37664025e+00  1.37664025e+00
  1.34914600e+01  1.34914600e+01  1.34914600e+01  7.70623292e+01
  7.70623292e+01  7.70623292e+01  1.63622446e+02  3.12251394e+02
  3.12251394e+02  3.12251394e+02  8.58424362e+02  8.58424362e+02
  8.58424362e+02  1.72575347e+03  1.82874908e+03  1.82874908e+03
  1.82874908e+03  3.56973420e+03  3.56973420e+03  3.56973420e+03
  7.17581944e+03  7.17581944e+03  7.17581944e+03  7.75829842e+03
  2.39036883e+04  7.46182428e+04]
E1 = -727.7895848737173  E_coul = 202.18790513227012
cycle= 5 E= -525.601679741447  delta_E= -9.82e-11  |g|= 3.01e-06  |ddm|= 1.87e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7895848737173  E_coul = 202.18790513227012
  HOMO = -0.559577312209913  LUMO = 1.37663879243045
  mo_energy =
[-1.18138342e+02 -1.21493819e+01 -9.50076670e+00 -9.50076670e+00
 -9.50076670e+00 -1.23813131e+00 -5.59577312e-01 -5.59577312e-01
 -5.59577312e-01  1.37663879e+00  1.37663879e+00  1.37663879e+00
  1.34914553e+01  1.34914553e+01  1.34914553e+01  7.70623227e+01
  7.70623227e+01  7.70623227e+01  1.63622439e+02  3.12251387e+02
  3.12251387e+02  3.12251387e+02  8.58424354e+02  8.58424354e+02
  8.58424354e+02  1.72575346e+03  1.82874907e+03  1.82874907e+03
  1.82874907e+03  3.56973419e+03  3.56973419e+03  3.56973419e+03
  7.17581943e+03  7.17581943e+03  7.17581943e+03  7.75829842e+03
  2.39036883e+04  7.46182428e+04]
E1 = -727.7895979917812  E_coul = 202.18791825033273
Extra cycle  E= -525.601679741448  delta_E= -1.25e-12  |g|= 6.94e-07  |ddm|= 1.49e-06
    CPU time for scf_cycle      0.36 sec, wall time      0.24 sec
exp = [2.61830760e+04 7.61201946e+03 3.60585623e+03 1.42520006e+03
 2.18167739e+02 4.94472080e+01 4.60343092e+00 3.96229011e-01
 1.36277171e+03 6.62666285e+02 2.90250892e+02 3.04682682e+02
 2.03133569e+02 1.36847284e+01 4.68664153e+01 9.48274397e-01
 4.31574952e+00 2.65277187e-01]
E = -525.6016797414485
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26183.0759533        1
[INPUT] 0    0    [1    /1   ]  7612.01946415        1
[INPUT] 0    0    [1    /1   ]  3605.85622863        1
[INPUT] 0    0    [1    /1   ]  1425.20006484        1
[INPUT] 0    0    [1    /1   ]  218.167739431        1
[INPUT] 0    0    [1    /1   ]  49.4472080095        1
[INPUT] 0    0    [1    /1   ]  4.60343091538        1
[INPUT] 0    0    [1    /1   ]  0.396229011194       1
[INPUT] 1    0    [1    /1   ]  1362.77170829        1
[INPUT] 1    0    [1    /1   ]  662.666284831        1
[INPUT] 1    0    [1    /1   ]  290.250891623        1
[INPUT] 1    0    [1    /1   ]  304.682682021        1
[INPUT] 1    0    [1    /1   ]  203.133568779        1
[INPUT] 1    0    [1    /1   ]  13.6847283766        1
[INPUT] 1    0    [1    /1   ]  46.8664152524        1
[INPUT] 1    0    [1    /1   ]  0.948274397201       1
[INPUT] 1    0    [1    /1   ]  4.31574952296        1
[INPUT] 1    0    [1    /1   ]  0.265277186619       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26183.07595334333, 1.0]], [0, [7612.019464153345, 1.0]], [0, [3605.8562286278793, 1.0]], [0, [1425.2000648377548, 1.0]], [0, [218.1677394313614, 1.0]], [0, [49.44720800950395, 1.0]], [0, [4.603430915382962, 1.0]], [0, [0.3962290111942137, 1.0]], [1, [1362.7717082900203, 1.0]], [1, [662.666284831177, 1.0]], [1, [290.250891623152, 1.0]], [1, [304.68268202066855, 1.0]], [1, [203.13356877910363, 1.0]], [1, [13.68472837657992, 1.0]], [1, [46.86641525241269, 1.0]], [1, [0.9482743972010041, 1.0]], [1, [4.315749522961345, 1.0]], [1, [0.26527718661902805, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26183.07595334]
bas 1, expnt(s) = [7612.01946415]
bas 2, expnt(s) = [3605.85622863]
bas 3, expnt(s) = [1425.20006484]
bas 4, expnt(s) = [218.16773943]
bas 5, expnt(s) = [49.44720801]
bas 6, expnt(s) = [4.60343092]
bas 7, expnt(s) = [0.39622901]
bas 8, expnt(s) = [1362.77170829]
bas 9, expnt(s) = [662.66628483]
bas 10, expnt(s) = [290.25089162]
bas 11, expnt(s) = [304.68268202]
bas 12, expnt(s) = [203.13356878]
bas 13, expnt(s) = [13.68472838]
bas 14, expnt(s) = [46.86641525]
bas 15, expnt(s) = [0.9482744]
bas 16, expnt(s) = [4.31574952]
bas 17, expnt(s) = [0.26527719]
CPU time:       509.32
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61830760e+04 5.20032545e+03 7.61201946e+03 2.05892223e+03
 3.60585623e+03 1.17563181e+03 1.42520006e+03 5.86032767e+02
 2.18167739e+02 1.43419407e+02 4.94472080e+01 4.71108950e+01
 4.60343092e+00 7.94010502e+00 3.96229011e-01 1.26175411e+00
 1.36277171e+03 2.41553469e+04 6.62666285e+02 9.80850881e+03
 2.90250892e+02 3.49503352e+03 3.04682682e+02 3.71359129e+03
 2.03133569e+02 2.23723454e+03 1.36847284e+01 7.67855713e+01
 4.68664153e+01 3.57735107e+02 9.48274397e-01 2.72993259e+00
 4.31574952e+00 1.81469934e+01 2.65277187e-01 5.55404343e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.963063160433435
cond(S) = 1363679.378740405
E1 = -727.4895774334817  E_coul = 203.06946240279268
init E= -524.420115030689
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.558238729365252  LUMO = 1.37686017358591
  mo_energy =
[-1.17936823e+02 -1.20923751e+01 -9.44334552e+00 -9.44334552e+00
 -9.44334552e+00 -1.23142017e+00 -5.58238729e-01 -5.58238729e-01
 -5.58238729e-01  1.37686017e+00  1.37686017e+00  1.37686017e+00
  1.35365407e+01  1.35365407e+01  1.35365407e+01  7.71677265e+01
  7.71677265e+01  7.71677265e+01  1.63764250e+02  3.12414929e+02
  3.12414929e+02  3.12414929e+02  8.58625693e+02  8.58625693e+02
  8.58625693e+02  1.72611388e+03  1.82898843e+03  1.82898843e+03
  1.82898843e+03  3.57003519e+03  3.57003519e+03  3.57003519e+03
  7.17624671e+03  7.17624671e+03  7.17624671e+03  7.75881532e+03
  2.39043083e+04  7.46189584e+04]
E1 = -727.6677027288883  E_coul = 202.0661861952079
cycle= 1 E= -525.60151653368  delta_E= -1.18  |g|= 0.194  |ddm|= 1.64
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.476048
diis-c [-0.22662217  1.        ]
  HOMO = -0.56064790900834  LUMO = 1.37540846584576
  mo_energy =
[-1.18159772e+02 -1.21579850e+01 -9.50948698e+00 -9.50948698e+00
 -9.50948698e+00 -1.23959565e+00 -5.60647909e-01 -5.60647909e-01
 -5.60647909e-01  1.37540847e+00  1.37540847e+00  1.37540847e+00
  1.34847196e+01  1.34847196e+01  1.34847196e+01  7.70479541e+01
  7.70479541e+01  7.70479541e+01  1.63602266e+02  3.12231719e+02
  3.12231719e+02  3.12231719e+02  8.58402612e+02  8.58402612e+02
  8.58402612e+02  1.72572949e+03  1.82872626e+03  1.82872626e+03
  1.82872626e+03  3.56971057e+03  3.56971057e+03  3.56971057e+03
  7.17579536e+03  7.17579536e+03  7.17579536e+03  7.75827419e+03
  2.39036641e+04  7.46182188e+04]
E1 = -727.8151731655956  E_coul = 202.21349698915486
cycle= 2 E= -525.601676176441  delta_E= -0.00016  |g|= 0.0136  |ddm|= 0.0133
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0249207
diis-c [-5.00196736e-04  2.25952258e-02  9.77404774e-01]
  HOMO = -0.559246215085936  LUMO = 1.37697859407626
  mo_energy =
[-1.18135195e+02 -1.21477740e+01 -9.49911849e+00 -9.49911849e+00
 -9.49911849e+00 -1.23769353e+00 -5.59246215e-01 -5.59246215e-01
 -5.59246215e-01  1.37697859e+00  1.37697859e+00  1.37697859e+00
  1.34927989e+01  1.34927989e+01  1.34927989e+01  7.70646336e+01
  7.70646336e+01  7.70646336e+01  1.63625373e+02  3.12254319e+02
  3.12254319e+02  3.12254319e+02  8.58427533e+02  8.58427533e+02
  8.58427533e+02  1.72575699e+03  1.82875239e+03  1.82875239e+03
  1.82875239e+03  3.56973764e+03  3.56973764e+03  3.56973764e+03
  7.17582302e+03  7.17582302e+03  7.17582302e+03  7.75830209e+03
  2.39036920e+04  7.46182466e+04]
E1 = -727.7852263255759  E_coul = 202.18354667526938
cycle= 3 E= -525.601679650307  delta_E= -3.47e-06  |g|= 0.00174  |ddm|= 0.00258
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00342758
diis-c [-8.24826641e-08 -7.77520419e-04  1.14756817e-01  8.86020703e-01]
  HOMO = -0.559596309797468  LUMO = 1.37662031258372
  mo_energy =
[-1.18138419e+02 -1.21494457e+01 -9.50083101e+00 -9.50083101e+00
 -9.50083101e+00 -1.23815602e+00 -5.59596310e-01 -5.59596310e-01
 -5.59596310e-01  1.37662031e+00  1.37662031e+00  1.37662031e+00
  1.34913991e+01  1.34913991e+01  1.34913991e+01  7.70622521e+01
  7.70622521e+01  7.70622521e+01  1.63622363e+02  3.12251311e+02
  3.12251311e+02  3.12251311e+02  8.58424277e+02  8.58424277e+02
  8.58424277e+02  1.72575339e+03  1.82874899e+03  1.82874899e+03
  1.82874899e+03  3.56973412e+03  3.56973412e+03  3.56973412e+03
  7.17581936e+03  7.17581936e+03  7.17581936e+03  7.75829834e+03
  2.39036882e+04  7.46182427e+04]
E1 = -727.7897433327887  E_coul = 202.1880635914397
cycle= 4 E= -525.601679741349  delta_E= -9.1e-08  |g|= 3.64e-05  |ddm|= 0.000442
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.69421e-05
diis-c [-4.62631895e-10 -1.88585459e-05  2.24972028e-03  3.22361237e-02
  9.65533015e-01]
  HOMO = -0.559575825855264  LUMO = 1.37664024721627
  mo_energy =
[-1.18138334e+02 -1.21493764e+01 -9.50076116e+00 -9.50076116e+00
 -9.50076116e+00 -1.23812937e+00 -5.59575826e-01 -5.59575826e-01
 -5.59575826e-01  1.37664025e+00  1.37664025e+00  1.37664025e+00
  1.34914600e+01  1.34914600e+01  1.34914600e+01  7.70623292e+01
  7.70623292e+01  7.70623292e+01  1.63622446e+02  3.12251394e+02
  3.12251394e+02  3.12251394e+02  8.58424362e+02  8.58424362e+02
  8.58424362e+02  1.72575347e+03  1.82874908e+03  1.82874908e+03
  1.82874908e+03  3.56973420e+03  3.56973420e+03  3.56973420e+03
  7.17581944e+03  7.17581944e+03  7.17581944e+03  7.75829842e+03
  2.39036883e+04  7.46182428e+04]
E1 = -727.7895848737173  E_coul = 202.18790513227012
cycle= 5 E= -525.601679741447  delta_E= -9.82e-11  |g|= 3.01e-06  |ddm|= 1.87e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7895848737173  E_coul = 202.18790513227012
  HOMO = -0.559577312209913  LUMO = 1.37663879243045
  mo_energy =
[-1.18138342e+02 -1.21493819e+01 -9.50076670e+00 -9.50076670e+00
 -9.50076670e+00 -1.23813131e+00 -5.59577312e-01 -5.59577312e-01
 -5.59577312e-01  1.37663879e+00  1.37663879e+00  1.37663879e+00
  1.34914553e+01  1.34914553e+01  1.34914553e+01  7.70623227e+01
  7.70623227e+01  7.70623227e+01  1.63622439e+02  3.12251387e+02
  3.12251387e+02  3.12251387e+02  8.58424354e+02  8.58424354e+02
  8.58424354e+02  1.72575346e+03  1.82874907e+03  1.82874907e+03
  1.82874907e+03  3.56973419e+03  3.56973419e+03  3.56973419e+03
  7.17581943e+03  7.17581943e+03  7.17581943e+03  7.75829842e+03
  2.39036883e+04  7.46182428e+04]
E1 = -727.7895979917812  E_coul = 202.18791825033273
Extra cycle  E= -525.601679741448  delta_E= -1.25e-12  |g|= 6.94e-07  |ddm|= 1.49e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.24 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1363679.378740405
E1 = -727.7895979917812  E_coul = 202.18791825033273
init E= -525.601679741448
    CPU time for initialize scf      0.97 sec, wall time      0.20 sec
  HOMO = -0.559577076357975  LUMO = 1.3766390282945
  mo_energy =
[-1.18138340e+02 -1.21493809e+01 -9.50076572e+00 -9.50076572e+00
 -9.50076572e+00 -1.23813100e+00 -5.59577076e-01 -5.59577076e-01
 -5.59577076e-01  1.37663903e+00  1.37663903e+00  1.37663903e+00
  1.34914562e+01  1.34914562e+01  1.34914562e+01  7.70623239e+01
  7.70623239e+01  7.70623239e+01  1.63622440e+02  3.12251388e+02
  3.12251388e+02  3.12251388e+02  8.58424355e+02  8.58424355e+02
  8.58424355e+02  1.72575346e+03  1.82874907e+03  1.82874907e+03
  1.82874907e+03  3.56973419e+03  3.56973419e+03  3.56973419e+03
  7.17581944e+03  7.17581944e+03  7.17581944e+03  7.75829842e+03
  2.39036883e+04  7.46182428e+04]
E1 = -727.7895955242475  E_coul = 202.18791578280013
cycle= 1 E= -525.601679741447  delta_E= 1.14e-12  |g|= 1.4e-07  |ddm|= 2.58e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.7895955242475  E_coul = 202.18791578280013
  HOMO = -0.559577118408316  LUMO = 1.37663898598185
  mo_energy =
[-1.18138341e+02 -1.21493811e+01 -9.50076590e+00 -9.50076590e+00
 -9.50076590e+00 -1.23813106e+00 -5.59577118e-01 -5.59577118e-01
 -5.59577118e-01  1.37663899e+00  1.37663899e+00  1.37663899e+00
  1.34914560e+01  1.34914560e+01  1.34914560e+01  7.70623237e+01
  7.70623237e+01  7.70623237e+01  1.63622440e+02  3.12251388e+02
  3.12251388e+02  3.12251388e+02  8.58424355e+02  8.58424355e+02
  8.58424355e+02  1.72575346e+03  1.82874907e+03  1.82874907e+03
  1.82874907e+03  3.56973419e+03  3.56973419e+03  3.56973419e+03
  7.17581944e+03  7.17581944e+03  7.17581944e+03  7.75829842e+03
  2.39036883e+04  7.46182428e+04]
E1 = -727.7895959940001  E_coul = 202.18791625255258
Extra cycle  E= -525.601679741448  delta_E= -2.27e-13  |g|= 2.74e-08  |ddm|= 4.82e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.32 sec
exp = [2.61830760e+04 7.61201946e+03 3.60585623e+03 1.42520006e+03
 2.18167739e+02 4.94472080e+01 4.60343092e+00 3.96229011e-01
 1.36277171e+03 6.62666285e+02 2.90250892e+02 3.04682682e+02
 2.03133569e+02 1.36847284e+01 4.68664153e+01 9.48274397e-01
 4.31574952e+00 2.65277187e-01]
grad_E = [-2.02954972e-06  2.22647491e-05  3.65539697e-05  1.02672916e-03
 -4.68177720e-03  5.42037080e-04 -3.70815625e-04 -6.95039106e-05
 -5.32042571e-07 -7.40411675e-08 -3.70315499e-06 -3.18451085e-06
 -1.89620891e-05 -3.86562878e-03  4.95237268e-03 -1.56104316e-02
 -5.62596556e-03  6.78531288e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26183.42064          1
[INPUT] 0    0    [1    /1   ]  7608.23355739        1
[INPUT] 0    0    [1    /1   ]  3598.32137092        1
[INPUT] 0    0    [1    /1   ]  1307.82233313        1
[INPUT] 0    0    [1    /1   ]  209.662130597        1
[INPUT] 0    0    [1    /1   ]  48.200665365         1
[INPUT] 0    0    [1    /1   ]  4.59402352424        1
[INPUT] 0    0    [1    /1   ]  0.39228919243        1
[INPUT] 1    0    [1    /1   ]  1362.7451933         1
[INPUT] 1    0    [1    /1   ]  661.028047003        1
[INPUT] 1    0    [1    /1   ]  281.679455892        1
[INPUT] 1    0    [1    /1   ]  297.16023261         1
[INPUT] 1    0    [1    /1   ]  313.127084924        1
[INPUT] 1    0    [1    /1   ]  16.1071606411        1
[INPUT] 1    0    [1    /1   ]  59.5802975856        1
[INPUT] 1    0    [1    /1   ]  1.04720306485        1
[INPUT] 1    0    [1    /1   ]  4.72857262379        1
[INPUT] 1    0    [1    /1   ]  0.28985951026        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26183.420640025986, 1.0]], [0, [7608.233557385366, 1.0]], [0, [3598.321370920528, 1.0]], [0, [1307.8223331348054, 1.0]], [0, [209.66213059672978, 1.0]], [0, [48.20066536500274, 1.0]], [0, [4.594023524235738, 1.0]], [0, [0.39228919242963367, 1.0]], [1, [1362.7451932958154, 1.0]], [1, [661.0280470033157, 1.0]], [1, [281.6794558924339, 1.0]], [1, [297.1602326098611, 1.0]], [1, [313.12708492355983, 1.0]], [1, [16.107160641073612, 1.0]], [1, [59.580297585587246, 1.0]], [1, [1.0472030648472357, 1.0]], [1, [4.728572623794091, 1.0]], [1, [0.2898595102596077, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26183.42064003]
bas 1, expnt(s) = [7608.23355739]
bas 2, expnt(s) = [3598.32137092]
bas 3, expnt(s) = [1307.82233313]
bas 4, expnt(s) = [209.6621306]
bas 5, expnt(s) = [48.20066537]
bas 6, expnt(s) = [4.59402352]
bas 7, expnt(s) = [0.39228919]
bas 8, expnt(s) = [1362.7451933]
bas 9, expnt(s) = [661.028047]
bas 10, expnt(s) = [281.67945589]
bas 11, expnt(s) = [297.16023261]
bas 12, expnt(s) = [313.12708492]
bas 13, expnt(s) = [16.10716064]
bas 14, expnt(s) = [59.58029759]
bas 15, expnt(s) = [1.04720306]
bas 16, expnt(s) = [4.72857262]
bas 17, expnt(s) = [0.28985951]
CPU time:       515.13
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61834206e+04 5.20037679e+03 7.60823356e+03 2.05815416e+03
 3.59832137e+03 1.17378887e+03 1.30782233e+03 5.49447987e+02
 2.09662131e+02 1.39205060e+02 4.82006654e+01 4.62173243e+01
 4.59402352e+00 7.92793234e+00 3.92289192e-01 1.25233288e+00
 1.36274519e+03 2.41547594e+04 6.61028047e+02 9.77820754e+03
 2.81679456e+02 3.36649799e+03 2.97160233e+02 3.59933902e+03
 3.13127085e+02 3.84268855e+03 1.61071606e+01 9.41365180e+01
 5.95802976e+01 4.82906140e+02 1.04720306e+00 3.09045926e+00
 4.72857262e+00 2.03421556e+01 2.89859510e-01 6.20467210e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.953164011050074
cond(S) = 54240174.103290305
E1 = -727.4605646713054  E_coul = 202.97184914973232
init E= -524.488715521573
    CPU time for initialize scf      0.68 sec, wall time      0.08 sec
  HOMO = -0.558039432276896  LUMO = 1.59320157626379
  mo_energy =
[-1.17990553e+02 -1.20970525e+01 -9.44438497e+00 -9.44438497e+00
 -9.44438497e+00 -1.23374421e+00 -5.58039432e-01 -5.58039432e-01
 -5.58039432e-01  1.59320158e+00  1.59320158e+00  1.59320158e+00
  1.61020966e+01  1.61020966e+01  1.61020966e+01  9.69140256e+01
  9.69140256e+01  9.69140256e+01  1.55644083e+02  3.79390782e+02
  3.79390782e+02  3.79390782e+02  9.99873019e+02  9.99873019e+02
  9.99873019e+02  1.62178908e+03  2.06724510e+03  2.06724510e+03
  2.06724510e+03  3.90408090e+03  3.90408090e+03  3.90408090e+03
  7.44993956e+03  7.55764463e+03  7.55764463e+03  7.55764463e+03
  2.34544800e+04  7.41260638e+04]
E1 = -727.807631285847  E_coul = 202.17753020041565
cycle= 1 E= -525.630101085431  delta_E= -1.14  |g|= 0.192  |ddm|= 20.3
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.48152
diis-c [-0.23186108  1.        ]
  HOMO = -0.551570065504157  LUMO = 1.59936983388189
  mo_energy =
[-1.18208072e+02 -1.21462201e+01 -9.49560697e+00 -9.49560697e+00
 -9.49560697e+00 -1.23055895e+00 -5.51570066e-01 -5.51570066e-01
 -5.51570066e-01  1.59936983e+00  1.59936983e+00  1.59936983e+00
  1.60575945e+01  1.60575945e+01  1.60575945e+01  9.67894406e+01
  9.67894406e+01  9.67894406e+01  1.55493402e+02  3.79204237e+02
  3.79204237e+02  3.79204237e+02  9.99645300e+02  9.99645301e+02
  9.99645301e+02  1.62140646e+03  2.06697723e+03  2.06697723e+03
  2.06697723e+03  3.90375115e+03  3.90375115e+03  3.90375115e+03
  7.44939241e+03  7.55718747e+03  7.55718748e+03  7.55718748e+03
  2.34538262e+04  7.41253141e+04]
E1 = -727.9231361500748  E_coul = 202.2928616891723
cycle= 2 E= -525.630274460902  delta_E= -0.000173  |g|= 0.0133  |ddm|= 0.0305
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0232892
diis-c [-4.28698012e-04  2.16833220e-02  9.78316678e-01]
  HOMO = -0.550958936862209  LUMO = 1.60032412751618
  mo_energy =
[-1.18185799e+02 -1.21384508e+01 -9.48771183e+00 -9.48771183e+00
 -9.48771183e+00 -1.22969633e+00 -5.50958937e-01 -5.50958937e-01
 -5.50958937e-01  1.60032413e+00  1.60032413e+00  1.60032413e+00
  1.60643914e+01  1.60643914e+01  1.60643914e+01  9.68051487e+01
  9.68051487e+01  9.68051488e+01  1.55513990e+02  3.79225152e+02
  3.79225152e+02  3.79225152e+02  9.99668255e+02  9.99668255e+02
  9.99668256e+02  1.62143171e+03  2.06700127e+03  2.06700127e+03
  2.06700127e+03  3.90377605e+03  3.90377605e+03  3.90377605e+03
  7.44941812e+03  7.55721294e+03  7.55721294e+03  7.55721294e+03
  2.34538519e+04  7.41253397e+04]
E1 = -727.8988213451814  E_coul = 202.26854416965622
cycle= 3 E= -525.630277175525  delta_E= -2.71e-06  |g|= 0.00155  |ddm|= 0.00266
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00298771
diis-c [-1.00864704e-07 -8.25094133e-04  1.05953046e-01  8.94872048e-01]
  HOMO = -0.551226312059081  LUMO = 1.60000835249233
  mo_energy =
[-1.18188605e+02 -1.21398273e+01 -9.48912715e+00 -9.48912715e+00
 -9.48912715e+00 -1.23004785e+00 -5.51226312e-01 -5.51226312e-01
 -5.51226312e-01  1.60000835e+00  1.60000835e+00  1.60000835e+00
  1.60631401e+01  1.60631401e+01  1.60631401e+01  9.68029749e+01
  9.68029749e+01  9.68029749e+01  1.55511407e+02  3.79222483e+02
  3.79222483e+02  3.79222483e+02  9.99665385e+02  9.99665385e+02
  9.99665385e+02  1.62142854e+03  2.06699828e+03  2.06699828e+03
  2.06699828e+03  3.90377294e+03  3.90377294e+03  3.90377294e+03
  7.44941480e+03  7.55720970e+03  7.55720970e+03  7.55720970e+03
  2.34538485e+04  7.41253363e+04]
E1 = -727.9024778687661  E_coul = 202.27220062986248
cycle= 4 E= -525.630277238904  delta_E= -6.34e-08  |g|= 3.83e-05  |ddm|= 0.000359
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=5.73271e-05
diis-c [-4.99899787e-10 -1.82451626e-05  1.60097327e-03  3.08486187e-02
  9.67568653e-01]
  HOMO = -0.551206087039683  LUMO = 1.60003065244259
  mo_energy =
[-1.18188517e+02 -1.21397557e+01 -9.48905492e+00 -9.48905492e+00
 -9.48905492e+00 -1.23002155e+00 -5.51206087e-01 -5.51206087e-01
 -5.51206087e-01  1.60003065e+00  1.60003065e+00  1.60003065e+00
  1.60632055e+01  1.60632055e+01  1.60632055e+01  9.68030569e+01
  9.68030569e+01  9.68030569e+01  1.55511494e+02  3.79222570e+02
  3.79222570e+02  3.79222570e+02  9.99665473e+02  9.99665473e+02
  9.99665473e+02  1.62142863e+03  2.06699837e+03  2.06699837e+03
  2.06699837e+03  3.90377303e+03  3.90377303e+03  3.90377303e+03
  7.44941489e+03  7.55720979e+03  7.55720979e+03  7.55720979e+03
  2.34538486e+04  7.41253364e+04]
E1 = -727.902323941379  E_coul = 202.27204670237884
cycle= 5 E= -525.630277239  delta_E= -9.65e-11  |g|= 3.32e-06  |ddm|= 1.86e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -727.902323941379  E_coul = 202.27204670237884
  HOMO = -0.551207587587531  LUMO = 1.60002898493718
  mo_energy =
[-1.18188525e+02 -1.21397614e+01 -9.48906075e+00 -9.48906075e+00
 -9.48906075e+00 -1.23002351e+00 -5.51207588e-01 -5.51207588e-01
 -5.51207588e-01  1.60002898e+00  1.60002898e+00  1.60002898e+00
  1.60632003e+01  1.60632003e+01  1.60632003e+01  9.68030497e+01
  9.68030497e+01  9.68030497e+01  1.55511486e+02  3.79222562e+02
  3.79222562e+02  3.79222562e+02  9.99665465e+02  9.99665465e+02
  9.99665465e+02  1.62142862e+03  2.06699836e+03  2.06699836e+03
  2.06699836e+03  3.90377302e+03  3.90377302e+03  3.90377302e+03
  7.44941488e+03  7.55720978e+03  7.55720978e+03  7.55720978e+03
  2.34538486e+04  7.41253364e+04]
E1 = -727.9023370148667  E_coul = 202.27205977586675
Extra cycle  E= -525.630277239  delta_E= 2.27e-13  |g|= 7.33e-07  |ddm|= 1.45e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
exp = [2.61834206e+04 7.60823356e+03 3.59832137e+03 1.30782233e+03
 2.09662131e+02 4.82006654e+01 4.59402352e+00 3.92289192e-01
 1.36274519e+03 6.61028047e+02 2.81679456e+02 2.97160233e+02
 3.13127085e+02 1.61071606e+01 5.95802976e+01 1.04720306e+00
 4.72857262e+00 2.89859510e-01]
E = -525.630277239
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26183.42064          1
[INPUT] 0    0    [1    /1   ]  7608.23355739        1
[INPUT] 0    0    [1    /1   ]  3598.32137092        1
[INPUT] 0    0    [1    /1   ]  1307.82233313        1
[INPUT] 0    0    [1    /1   ]  209.662130597        1
[INPUT] 0    0    [1    /1   ]  48.200665365         1
[INPUT] 0    0    [1    /1   ]  4.59402352424        1
[INPUT] 0    0    [1    /1   ]  0.39228919243        1
[INPUT] 1    0    [1    /1   ]  1362.7451933         1
[INPUT] 1    0    [1    /1   ]  661.028047003        1
[INPUT] 1    0    [1    /1   ]  281.679455892        1
[INPUT] 1    0    [1    /1   ]  297.16023261         1
[INPUT] 1    0    [1    /1   ]  313.127084924        1
[INPUT] 1    0    [1    /1   ]  16.1071606411        1
[INPUT] 1    0    [1    /1   ]  59.5802975856        1
[INPUT] 1    0    [1    /1   ]  1.04720306485        1
[INPUT] 1    0    [1    /1   ]  4.72857262379        1
[INPUT] 1    0    [1    /1   ]  0.28985951026        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26183.420640025986, 1.0]], [0, [7608.233557385366, 1.0]], [0, [3598.321370920528, 1.0]], [0, [1307.8223331348054, 1.0]], [0, [209.66213059672978, 1.0]], [0, [48.20066536500274, 1.0]], [0, [4.594023524235738, 1.0]], [0, [0.39228919242963367, 1.0]], [1, [1362.7451932958154, 1.0]], [1, [661.0280470033157, 1.0]], [1, [281.6794558924339, 1.0]], [1, [297.1602326098611, 1.0]], [1, [313.12708492355983, 1.0]], [1, [16.107160641073612, 1.0]], [1, [59.580297585587246, 1.0]], [1, [1.0472030648472357, 1.0]], [1, [4.728572623794091, 1.0]], [1, [0.2898595102596077, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26183.42064003]
bas 1, expnt(s) = [7608.23355739]
bas 2, expnt(s) = [3598.32137092]
bas 3, expnt(s) = [1307.82233313]
bas 4, expnt(s) = [209.6621306]
bas 5, expnt(s) = [48.20066537]
bas 6, expnt(s) = [4.59402352]
bas 7, expnt(s) = [0.39228919]
bas 8, expnt(s) = [1362.7451933]
bas 9, expnt(s) = [661.028047]
bas 10, expnt(s) = [281.67945589]
bas 11, expnt(s) = [297.16023261]
bas 12, expnt(s) = [313.12708492]
bas 13, expnt(s) = [16.10716064]
bas 14, expnt(s) = [59.58029759]
bas 15, expnt(s) = [1.04720306]
bas 16, expnt(s) = [4.72857262]
bas 17, expnt(s) = [0.28985951]
CPU time:       516.24
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61834206e+04 5.20037679e+03 7.60823356e+03 2.05815416e+03
 3.59832137e+03 1.17378887e+03 1.30782233e+03 5.49447987e+02
 2.09662131e+02 1.39205060e+02 4.82006654e+01 4.62173243e+01
 4.59402352e+00 7.92793234e+00 3.92289192e-01 1.25233288e+00
 1.36274519e+03 2.41547594e+04 6.61028047e+02 9.77820754e+03
 2.81679456e+02 3.36649799e+03 2.97160233e+02 3.59933902e+03
 3.13127085e+02 3.84268855e+03 1.61071606e+01 9.41365180e+01
 5.95802976e+01 4.82906140e+02 1.04720306e+00 3.09045926e+00
 4.72857262e+00 2.03421556e+01 2.89859510e-01 6.20467210e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.953164011050074
cond(S) = 54240174.103290305
E1 = -727.4605646713054  E_coul = 202.97184914973232
init E= -524.488715521573
    CPU time for initialize scf      0.68 sec, wall time      0.08 sec
  HOMO = -0.558039432276896  LUMO = 1.59320157626379
  mo_energy =
[-1.17990553e+02 -1.20970525e+01 -9.44438497e+00 -9.44438497e+00
 -9.44438497e+00 -1.23374421e+00 -5.58039432e-01 -5.58039432e-01
 -5.58039432e-01  1.59320158e+00  1.59320158e+00  1.59320158e+00
  1.61020966e+01  1.61020966e+01  1.61020966e+01  9.69140256e+01
  9.69140256e+01  9.69140256e+01  1.55644083e+02  3.79390782e+02
  3.79390782e+02  3.79390782e+02  9.99873019e+02  9.99873019e+02
  9.99873019e+02  1.62178908e+03  2.06724510e+03  2.06724510e+03
  2.06724510e+03  3.90408090e+03  3.90408090e+03  3.90408090e+03
  7.44993956e+03  7.55764463e+03  7.55764463e+03  7.55764463e+03
  2.34544800e+04  7.41260638e+04]
E1 = -727.807631285847  E_coul = 202.17753020041565
cycle= 1 E= -525.630101085431  delta_E= -1.14  |g|= 0.192  |ddm|= 20.3
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.48152
diis-c [-0.23186108  1.        ]
  HOMO = -0.551570065504157  LUMO = 1.59936983388189
  mo_energy =
[-1.18208072e+02 -1.21462201e+01 -9.49560697e+00 -9.49560697e+00
 -9.49560697e+00 -1.23055895e+00 -5.51570066e-01 -5.51570066e-01
 -5.51570066e-01  1.59936983e+00  1.59936983e+00  1.59936983e+00
  1.60575945e+01  1.60575945e+01  1.60575945e+01  9.67894406e+01
  9.67894406e+01  9.67894406e+01  1.55493402e+02  3.79204237e+02
  3.79204237e+02  3.79204237e+02  9.99645300e+02  9.99645301e+02
  9.99645301e+02  1.62140646e+03  2.06697723e+03  2.06697723e+03
  2.06697723e+03  3.90375115e+03  3.90375115e+03  3.90375115e+03
  7.44939241e+03  7.55718747e+03  7.55718748e+03  7.55718748e+03
  2.34538262e+04  7.41253141e+04]
E1 = -727.9231361500748  E_coul = 202.2928616891723
cycle= 2 E= -525.630274460902  delta_E= -0.000173  |g|= 0.0133  |ddm|= 0.0305
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0232892
diis-c [-4.28698012e-04  2.16833220e-02  9.78316678e-01]
  HOMO = -0.550958936862209  LUMO = 1.60032412751618
  mo_energy =
[-1.18185799e+02 -1.21384508e+01 -9.48771183e+00 -9.48771183e+00
 -9.48771183e+00 -1.22969633e+00 -5.50958937e-01 -5.50958937e-01
 -5.50958937e-01  1.60032413e+00  1.60032413e+00  1.60032413e+00
  1.60643914e+01  1.60643914e+01  1.60643914e+01  9.68051487e+01
  9.68051487e+01  9.68051488e+01  1.55513990e+02  3.79225152e+02
  3.79225152e+02  3.79225152e+02  9.99668255e+02  9.99668255e+02
  9.99668256e+02  1.62143171e+03  2.06700127e+03  2.06700127e+03
  2.06700127e+03  3.90377605e+03  3.90377605e+03  3.90377605e+03
  7.44941812e+03  7.55721294e+03  7.55721294e+03  7.55721294e+03
  2.34538519e+04  7.41253397e+04]
E1 = -727.8988213451814  E_coul = 202.26854416965622
cycle= 3 E= -525.630277175525  delta_E= -2.71e-06  |g|= 0.00155  |ddm|= 0.00266
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00298771
diis-c [-1.00864704e-07 -8.25094133e-04  1.05953046e-01  8.94872048e-01]
  HOMO = -0.551226312059081  LUMO = 1.60000835249233
  mo_energy =
[-1.18188605e+02 -1.21398273e+01 -9.48912715e+00 -9.48912715e+00
 -9.48912715e+00 -1.23004785e+00 -5.51226312e-01 -5.51226312e-01
 -5.51226312e-01  1.60000835e+00  1.60000835e+00  1.60000835e+00
  1.60631401e+01  1.60631401e+01  1.60631401e+01  9.68029749e+01
  9.68029749e+01  9.68029749e+01  1.55511407e+02  3.79222483e+02
  3.79222483e+02  3.79222483e+02  9.99665385e+02  9.99665385e+02
  9.99665385e+02  1.62142854e+03  2.06699828e+03  2.06699828e+03
  2.06699828e+03  3.90377294e+03  3.90377294e+03  3.90377294e+03
  7.44941480e+03  7.55720970e+03  7.55720970e+03  7.55720970e+03
  2.34538485e+04  7.41253363e+04]
E1 = -727.9024778687661  E_coul = 202.27220062986248
cycle= 4 E= -525.630277238904  delta_E= -6.34e-08  |g|= 3.83e-05  |ddm|= 0.000359
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.73271e-05
diis-c [-4.99899787e-10 -1.82451626e-05  1.60097327e-03  3.08486187e-02
  9.67568653e-01]
  HOMO = -0.551206087039683  LUMO = 1.60003065244259
  mo_energy =
[-1.18188517e+02 -1.21397557e+01 -9.48905492e+00 -9.48905492e+00
 -9.48905492e+00 -1.23002155e+00 -5.51206087e-01 -5.51206087e-01
 -5.51206087e-01  1.60003065e+00  1.60003065e+00  1.60003065e+00
  1.60632055e+01  1.60632055e+01  1.60632055e+01  9.68030569e+01
  9.68030569e+01  9.68030569e+01  1.55511494e+02  3.79222570e+02
  3.79222570e+02  3.79222570e+02  9.99665473e+02  9.99665473e+02
  9.99665473e+02  1.62142863e+03  2.06699837e+03  2.06699837e+03
  2.06699837e+03  3.90377303e+03  3.90377303e+03  3.90377303e+03
  7.44941489e+03  7.55720979e+03  7.55720979e+03  7.55720979e+03
  2.34538486e+04  7.41253364e+04]
E1 = -727.902323941379  E_coul = 202.27204670237884
cycle= 5 E= -525.630277239  delta_E= -9.65e-11  |g|= 3.32e-06  |ddm|= 1.86e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.902323941379  E_coul = 202.27204670237884
  HOMO = -0.551207587587531  LUMO = 1.60002898493718
  mo_energy =
[-1.18188525e+02 -1.21397614e+01 -9.48906075e+00 -9.48906075e+00
 -9.48906075e+00 -1.23002351e+00 -5.51207588e-01 -5.51207588e-01
 -5.51207588e-01  1.60002898e+00  1.60002898e+00  1.60002898e+00
  1.60632003e+01  1.60632003e+01  1.60632003e+01  9.68030497e+01
  9.68030497e+01  9.68030497e+01  1.55511486e+02  3.79222562e+02
  3.79222562e+02  3.79222562e+02  9.99665465e+02  9.99665465e+02
  9.99665465e+02  1.62142862e+03  2.06699836e+03  2.06699836e+03
  2.06699836e+03  3.90377302e+03  3.90377302e+03  3.90377302e+03
  7.44941488e+03  7.55720978e+03  7.55720978e+03  7.55720978e+03
  2.34538486e+04  7.41253364e+04]
E1 = -727.9023370148667  E_coul = 202.27205977586675
Extra cycle  E= -525.630277239  delta_E= 2.27e-13  |g|= 7.33e-07  |ddm|= 1.45e-06
    CPU time for scf_cycle      0.87 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 54240174.103290305
E1 = -727.9023370148667  E_coul = 202.27205977586675
init E= -525.630277239
    CPU time for initialize scf      0.96 sec, wall time      0.19 sec
  HOMO = -0.551207364886695  LUMO = 1.60002923934239
  mo_energy =
[-1.18188524e+02 -1.21397604e+01 -9.48905976e+00 -9.48905976e+00
 -9.48905976e+00 -1.23002322e+00 -5.51207365e-01 -5.51207365e-01
 -5.51207365e-01  1.60002924e+00  1.60002924e+00  1.60002924e+00
  1.60632012e+01  1.60632012e+01  1.60632012e+01  9.68030510e+01
  9.68030510e+01  9.68030510e+01  1.55511488e+02  3.79222564e+02
  3.79222564e+02  3.79222564e+02  9.99665467e+02  9.99665467e+02
  9.99665467e+02  1.62142862e+03  2.06699836e+03  2.06699836e+03
  2.06699836e+03  3.90377302e+03  3.90377302e+03  3.90377302e+03
  7.44941488e+03  7.55720978e+03  7.55720978e+03  7.55720978e+03
  2.34538486e+04  7.41253364e+04]
E1 = -727.9023346475018  E_coul = 202.27205740850087
cycle= 1 E= -525.630277239001  delta_E= -9.09e-13  |g|= 1.42e-07  |ddm|= 2.48e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.9023346475018  E_coul = 202.27205740850087
  HOMO = -0.551207403146695  LUMO = 1.60002919531197
  mo_energy =
[-1.18188524e+02 -1.21397606e+01 -9.48905994e+00 -9.48905994e+00
 -9.48905994e+00 -1.23002327e+00 -5.51207403e-01 -5.51207403e-01
 -5.51207403e-01  1.60002920e+00  1.60002920e+00  1.60002920e+00
  1.60632010e+01  1.60632010e+01  1.60632010e+01  9.68030508e+01
  9.68030508e+01  9.68030508e+01  1.55511487e+02  3.79222564e+02
  3.79222564e+02  3.79222564e+02  9.99665466e+02  9.99665466e+02
  9.99665466e+02  1.62142862e+03  2.06699836e+03  2.06699836e+03
  2.06699836e+03  3.90377302e+03  3.90377302e+03  3.90377302e+03
  7.44941488e+03  7.55720978e+03  7.55720978e+03  7.55720978e+03
  2.34538486e+04  7.41253364e+04]
E1 = -727.9023350821094  E_coul = 202.27205784311045
Extra cycle  E= -525.630277238999  delta_E= 1.93e-12  |g|= 2.68e-08  |ddm|= 4.47e-08
    CPU time for scf_cycle      1.35 sec, wall time      0.59 sec
exp = [2.61834206e+04 7.60823356e+03 3.59832137e+03 1.30782233e+03
 2.09662131e+02 4.82006654e+01 4.59402352e+00 3.92289192e-01
 1.36274519e+03 6.61028047e+02 2.81679456e+02 2.97160233e+02
 3.13127085e+02 1.61071606e+01 5.95802976e+01 1.04720306e+00
 4.72857262e+00 2.89859510e-01]
grad_E = [-2.04657976e-06  1.88308368e-05  2.12214387e-05  1.14780300e-03
 -4.45904375e-03 -5.41049172e-03 -1.05647931e-02 -3.56766610e-02
 -6.22372672e-07  1.69505512e-06  1.39856022e-06  2.07838765e-06
  2.37118651e-06  1.56275079e-02  3.91979553e-03 -2.40185594e-03
 -6.85706478e-02  1.58247470e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26186.4631217        1
[INPUT] 0    0    [1    /1   ]  7574.81736707        1
[INPUT] 0    0    [1    /1   ]  3531.81681433        1
[INPUT] 0    0    [1    /1   ]  271.790099147        1
[INPUT] 0    0    [1    /1   ]  133.735186035        1
[INPUT] 0    0    [1    /1   ]  37.5763017329        1
[INPUT] 0    0    [1    /1   ]  4.54138070919        1
[INPUT] 0    0    [1    /1   ]  0.365572879748       1
[INPUT] 1    0    [1    /1   ]  1362.51643127        1
[INPUT] 1    0    [1    /1   ]  646.612098511        1
[INPUT] 1    0    [1    /1   ]  206.273289205        1
[INPUT] 1    0    [1    /1   ]  230.983902955        1
[INPUT] 1    0    [1    /1   ]  1278.30964104        1
[INPUT] 1    0    [1    /1   ]  38.0191380863        1
[INPUT] 1    0    [1    /1   ]  171.436292252        1
[INPUT] 1    0    [1    /1   ]  1.942139492          1
[INPUT] 1    0    [1    /1   ]  9.00584606029        1
[INPUT] 1    0    [1    /1   ]  0.512789153634       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26186.463121739496, 1.0]], [0, [7574.817367070579, 1.0]], [0, [3531.816814329503, 1.0]], [0, [271.7900991469787, 1.0]], [0, [133.73518603548047, 1.0]], [0, [37.57630173291293, 1.0]], [0, [4.5413807091873295, 1.0]], [0, [0.36557287974776503, 1.0]], [1, [1362.5164312695624, 1.0]], [1, [646.6120985106053, 1.0]], [1, [206.27328920521143, 1.0]], [1, [230.9839029549525, 1.0]], [1, [1278.3096410355533, 1.0]], [1, [38.019138086336525, 1.0]], [1, [171.43629225171287, 1.0]], [1, [1.94213949199983, 1.0]], [1, [9.005846060289052, 1.0]], [1, [0.5127891536342748, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26186.46312174]
bas 1, expnt(s) = [7574.81736707]
bas 2, expnt(s) = [3531.81681433]
bas 3, expnt(s) = [271.79009915]
bas 4, expnt(s) = [133.73518604]
bas 5, expnt(s) = [37.57630173]
bas 6, expnt(s) = [4.54138071]
bas 7, expnt(s) = [0.36557288]
bas 8, expnt(s) = [1362.51643127]
bas 9, expnt(s) = [646.61209851]
bas 10, expnt(s) = [206.27328921]
bas 11, expnt(s) = [230.98390295]
bas 12, expnt(s) = [1278.30964104]
bas 13, expnt(s) = [38.01913809]
bas 14, expnt(s) = [171.43629225]
bas 15, expnt(s) = [1.94213949]
bas 16, expnt(s) = [9.00584606]
bas 17, expnt(s) = [0.51278915]
CPU time:       523.06
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61864631e+04 5.20082999e+03 7.57481737e+03 2.05137070e+03
 3.53181681e+03 1.15748042e+03 2.71790099e+02 1.69118161e+02
 1.33735186e+02 9.93571874e+01 3.75763017e+01 3.83442767e+01
 4.54138071e+00 7.85969978e+00 3.65572880e-01 1.18780596e+00
 1.36251643e+03 2.41496910e+04 6.46612099e+02 9.51237966e+03
 2.06273289e+02 2.28054231e+03 2.30983903e+02 2.62700886e+03
 1.27830964e+03 2.22986963e+04 3.80191381e+01 2.75414770e+02
 1.71436292e+02 1.80972610e+03 1.94213949e+00 6.68859526e+00
 9.00584606e+00 4.55134798e+01 5.12789154e-01 1.26592487e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.674827736144287
cond(S) = 688873.7218544945
E1 = -712.0745316513157  E_coul = 201.8343365209503
init E= -510.240195130365
    CPU time for initialize scf      0.16 sec, wall time      0.05 sec
  HOMO = -0.544950770794475  LUMO = 4.25146790631615
  mo_energy =
[-1.16722554e+02 -1.19955443e+01 -9.43996632e+00 -9.43996632e+00
 -9.43996632e+00 -1.26870328e+00 -5.44950771e-01 -5.44950771e-01
 -5.44950771e-01  4.25146791e+00  4.25146791e+00  4.25146791e+00
  4.60655505e+01  4.60655505e+01  4.60655505e+01  9.24774529e+01
  2.27622877e+02  2.27622877e+02  2.27622877e+02  5.43407179e+02
  6.48221303e+02  6.48221303e+02  6.48221303e+02  1.39437982e+03
  1.39437982e+03  1.39437982e+03  2.73791707e+03  2.73791707e+03
  2.73791707e+03  4.18200533e+03  5.35351537e+03  5.35351537e+03
  5.35351537e+03  1.02429837e+04  1.02429837e+04  1.02429837e+04
  1.93578710e+04  6.99105997e+04]
E1 = -727.3421590340997  E_coul = 205.64052397049974
cycle= 1 E= -521.7016350636  delta_E= -11.5  |g|= 0.577  |ddm|=  4.3
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.08816
diis-c [-1.18408136  1.        ]
  HOMO = -0.363740162219363  LUMO = 4.49559396846973
  mo_energy =
[-1.16673674e+02 -1.16976840e+01 -9.16791418e+00 -9.16791418e+00
 -9.16791418e+00 -1.06468758e+00 -3.63740162e-01 -3.63740162e-01
 -3.63740162e-01  4.49559397e+00  4.49559397e+00  4.49559397e+00
  4.62640906e+01  4.62640906e+01  4.62640906e+01  9.26864799e+01
  2.27756654e+02  2.27756654e+02  2.27756654e+02  5.43373708e+02
  6.48273810e+02  6.48273810e+02  6.48273810e+02  1.39434369e+03
  1.39434369e+03  1.39434369e+03  2.73776928e+03  2.73776928e+03
  2.73776928e+03  4.18145586e+03  5.35322896e+03  5.35322896e+03
  5.35322896e+03  1.02424602e+04  1.02424602e+04  1.02424602e+04
  1.93569839e+04  6.99095350e+04]
E1 = -727.2190779264379  E_coul = 205.51653066618414
cycle= 2 E= -521.702547260254  delta_E= -0.000912  |g|= 0.00942  |ddm|= 0.043
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.014253
diis-c [-1.16788999e-04 -8.61415870e-03  1.00861416e+00]
  HOMO = -0.366824151840002  LUMO = 4.4892712353939
  mo_energy =
[-1.16678219e+02 -1.17084114e+01 -9.17936148e+00 -9.17936148e+00
 -9.17936148e+00 -1.06835506e+00 -3.66824152e-01 -3.66824152e-01
 -3.66824152e-01  4.48927124e+00  4.48927124e+00  4.48927124e+00
  4.62539918e+01  4.62539918e+01  4.62539918e+01  9.26800795e+01
  2.27750148e+02  2.27750148e+02  2.27750148e+02  5.43369288e+02
  6.48268882e+02  6.48268882e+02  6.48268882e+02  1.39433947e+03
  1.39433947e+03  1.39433947e+03  2.73776548e+03  2.73776548e+03
  2.73776548e+03  4.18145143e+03  5.35322517e+03  5.35322517e+03
  5.35322517e+03  1.02424559e+04  1.02424559e+04  1.02424559e+04
  1.93569786e+04  6.99095292e+04]
E1 = -727.2230977375665  E_coul = 205.52055000775624
cycle= 3 E= -521.70254772981  delta_E= -4.7e-07  |g|= 0.000452  |ddm|= 0.000577
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000488982
diis-c [-2.01091317e-07  2.26584394e-04 -1.63443033e-02  1.01611772e+00]
  HOMO = -0.36676181021259  LUMO = 4.48944362075037
  mo_energy =
[-1.16677546e+02 -1.17079917e+01 -9.17894982e+00 -9.17894982e+00
 -9.17894982e+00 -1.06828009e+00 -3.66761810e-01 -3.66761810e-01
 -3.66761810e-01  4.48944362e+00  4.48944362e+00  4.48944362e+00
  4.62545065e+01  4.62545065e+01  4.62545065e+01  9.26807429e+01
  2.27750794e+02  2.27750794e+02  2.27750794e+02  5.43369899e+02
  6.48269543e+02  6.48269543e+02  6.48269543e+02  1.39434011e+03
  1.39434011e+03  1.39434011e+03  2.73776606e+03  2.73776606e+03
  2.73776606e+03  4.18145181e+03  5.35322567e+03  5.35322567e+03
  5.35322567e+03  1.02424563e+04  1.02424563e+04  1.02424563e+04
  1.93569789e+04  6.99095295e+04]
E1 = -727.2224383242395  E_coul = 205.51989059190794
cycle= 4 E= -521.702547732332  delta_E= -2.52e-09  |g|= 6.33e-05  |ddm|= 9.7e-05
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000116859
diis-c [-2.75020360e-09  6.93550848e-06 -3.75804913e-03  1.71152380e-01
  8.32598734e-01]
  HOMO = -0.366769026276201  LUMO = 4.48942381417965
  mo_energy =
[-1.16677642e+02 -1.17080367e+01 -9.17899710e+00 -9.17899710e+00
 -9.17899710e+00 -1.06828851e+00 -3.66769026e-01 -3.66769026e-01
 -3.66769026e-01  4.48942381e+00  4.48942381e+00  4.48942381e+00
  4.62544423e+01  4.62544423e+01  4.62544423e+01  9.26806636e+01
  2.27750707e+02  2.27750707e+02  2.27750707e+02  5.43369800e+02
  6.48269448e+02  6.48269448e+02  6.48269448e+02  1.39434001e+03
  1.39434001e+03  1.39434001e+03  2.73776595e+03  2.73776595e+03
  2.73776595e+03  4.18145170e+03  5.35322556e+03  5.35322556e+03
  5.35322556e+03  1.02424562e+04  1.02424562e+04  1.02424562e+04
  1.93569788e+04  6.99095293e+04]
E1 = -727.2225287256055  E_coul = 205.51998099320082
cycle= 5 E= -521.702547732405  delta_E= -7.3e-11  |g|= 2.53e-06  |ddm|= 1.01e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.2225287256055  E_coul = 205.51998099320082
  HOMO = -0.366769511812911  LUMO = 4.48942258735476
  mo_energy =
[-1.16677647e+02 -1.17080394e+01 -9.17899989e+00 -9.17899989e+00
 -9.17899989e+00 -1.06828909e+00 -3.66769512e-01 -3.66769512e-01
 -3.66769512e-01  4.48942259e+00  4.48942259e+00  4.48942259e+00
  4.62544388e+01  4.62544388e+01  4.62544388e+01  9.26806594e+01
  2.27750703e+02  2.27750703e+02  2.27750703e+02  5.43369795e+02
  6.48269443e+02  6.48269443e+02  6.48269443e+02  1.39434000e+03
  1.39434000e+03  1.39434000e+03  2.73776595e+03  2.73776595e+03
  2.73776595e+03  4.18145170e+03  5.35322555e+03  5.35322555e+03
  5.35322555e+03  1.02424562e+04  1.02424562e+04  1.02424562e+04
  1.93569788e+04  6.99095293e+04]
E1 = -727.2225332678528  E_coul = 205.5199855354477
Extra cycle  E= -521.702547732405  delta_E= -4.55e-13  |g|= 4.36e-07  |ddm|= 4.79e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.25 sec
exp = [2.61864631e+04 7.57481737e+03 3.53181681e+03 2.71790099e+02
 1.33735186e+02 3.75763017e+01 4.54138071e+00 3.65572880e-01
 1.36251643e+03 6.46612099e+02 2.06273289e+02 2.30983903e+02
 1.27830964e+03 3.80191381e+01 1.71436292e+02 1.94213949e+00
 9.00584606e+00 5.12789154e-01]
E = -521.702547732405
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26183.7248882        1
[INPUT] 0    0    [1    /1   ]  7604.89193835        1
[INPUT] 0    0    [1    /1   ]  3591.67091526        1
[INPUT] 0    0    [1    /1   ]  1204.21910974        1
[INPUT] 0    0    [1    /1   ]  202.069436141        1
[INPUT] 0    0    [1    /1   ]  47.1382290018        1
[INPUT] 0    0    [1    /1   ]  4.58875924273        1
[INPUT] 0    0    [1    /1   ]  0.389617561161       1
[INPUT] 1    0    [1    /1   ]  1362.72231709        1
[INPUT] 1    0    [1    /1   ]  659.586452154        1
[INPUT] 1    0    [1    /1   ]  274.138839224        1
[INPUT] 1    0    [1    /1   ]  290.542599644        1
[INPUT] 1    0    [1    /1   ]  409.645340535        1
[INPUT] 1    0    [1    /1   ]  18.2983583856        1
[INPUT] 1    0    [1    /1   ]  70.7658970522        1
[INPUT] 1    0    [1    /1   ]  1.13669670756        1
[INPUT] 1    0    [1    /1   ]  5.15629996744        1
[INPUT] 1    0    [1    /1   ]  0.312152474597       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26183.72488819734, 1.0]], [0, [7604.891938353888, 1.0]], [0, [3591.6709152614253, 1.0]], [0, [1204.2191097360228, 1.0]], [0, [202.06943614060486, 1.0]], [0, [47.13822900179376, 1.0]], [0, [4.588759242730897, 1.0]], [0, [0.3896175611614468, 1.0]], [1, [1362.7223170931902, 1.0]], [1, [659.5864521540447, 1.0]], [1, [274.13883922371167, 1.0]], [1, [290.5425996443702, 1.0]], [1, [409.6453405347592, 1.0]], [1, [18.298358385599904, 1.0]], [1, [70.7658970521998, 1.0]], [1, [1.1366967075624952, 1.0]], [1, [5.156299967443587, 1.0]], [1, [0.3121524745970744, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26183.7248882]
bas 1, expnt(s) = [7604.89193835]
bas 2, expnt(s) = [3591.67091526]
bas 3, expnt(s) = [1204.21910974]
bas 4, expnt(s) = [202.06943614]
bas 5, expnt(s) = [47.138229]
bas 6, expnt(s) = [4.58875924]
bas 7, expnt(s) = [0.38961756]
bas 8, expnt(s) = [1362.72231709]
bas 9, expnt(s) = [659.58645215]
bas 10, expnt(s) = [274.13883922]
bas 11, expnt(s) = [290.54259964]
bas 12, expnt(s) = [409.64534053]
bas 13, expnt(s) = [18.29835839]
bas 14, expnt(s) = [70.76589705]
bas 15, expnt(s) = [1.13669671]
bas 16, expnt(s) = [5.15629997]
bas 17, expnt(s) = [0.31215247]
CPU time:       523.81
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61837249e+04 5.20042211e+03 7.60489194e+03 2.05747615e+03
 3.59167092e+03 1.17216143e+03 1.20421911e+03 5.16468883e+02
 2.02069436e+02 1.35406807e+02 4.71382290e+01 4.54511599e+01
 4.58875924e+00 7.92111792e+00 3.89617561e-01 1.24593079e+00
 1.36272232e+03 2.41542526e+04 6.59586452e+02 9.75155896e+03
 2.74138839e+02 3.25422520e+03 2.90542600e+02 3.49942480e+03
 4.09645341e+02 5.37643521e+03 1.82983584e+01 1.10407749e+02
 7.07658971e+01 5.98776039e+02 1.13669671e+00 3.42405037e+00
 5.15629997e+00 2.26676820e+01 3.12152475e-01 6.80679812e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.940590384132125
cond(S) = 1460147.8736154041
E1 = -727.450468568338  E_coul = 202.90235519546928
init E= -524.548113372869
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.55735876557757  LUMO = 1.80345761900945
  mo_energy =
[-1.18038807e+02 -1.21006370e+01 -9.44341886e+00 -9.44341886e+00
 -9.44341886e+00 -1.23611161e+00 -5.57358766e-01 -5.57358766e-01
 -5.57358766e-01  1.80345762e+00  1.80345762e+00  1.80345762e+00
  1.87120589e+01  1.87120589e+01  1.87120589e+01  1.14204718e+02
  1.14204718e+02  1.14204718e+02  1.48677254e+02  4.25866478e+02
  4.25866478e+02  4.25866478e+02  1.08580559e+03  1.08580559e+03
  1.08580559e+03  1.52646342e+03  2.22078000e+03  2.22078000e+03
  2.22078000e+03  4.15415372e+03  4.15415372e+03  4.15415372e+03
  7.16810349e+03  7.88099032e+03  7.88099032e+03  7.88099032e+03
  2.30531345e+04  7.36916088e+04]
E1 = -728.0665632496126  E_coul = 202.40772304770957
cycle= 1 E= -525.658840201903  delta_E= -1.11  |g|= 0.188  |ddm|= 0.785
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.477866
diis-c [-0.22835624  1.        ]
  HOMO = -0.540815703203206  LUMO = 1.82008195973649
  mo_energy =
[-1.18235373e+02 -1.21274484e+01 -9.47333372e+00 -9.47333372e+00
 -9.47333372e+00 -1.22038504e+00 -5.40815703e-01 -5.40815703e-01
 -5.40815703e-01  1.82008196e+00  1.82008196e+00  1.82008196e+00
  1.86812173e+01  1.86812173e+01  1.86812173e+01  1.14091371e+02
  1.14091371e+02  1.14091371e+02  1.48551579e+02  4.25696063e+02
  4.25696063e+02  4.25696063e+02  1.08559274e+03  1.08559274e+03
  1.08559274e+03  1.52610360e+03  2.22052448e+03  2.22052448e+03
  2.22052448e+03  4.15383651e+03  4.15383651e+03  4.15383651e+03
  7.16757354e+03  7.88054763e+03  7.88054763e+03  7.88054763e+03
  2.30524955e+04  7.36908740e+04]
E1 = -728.1367057849277  E_coul = 202.4776888203458
cycle= 2 E= -525.659016964582  delta_E= -0.000177  |g|= 0.0118  |ddm|= 0.0083
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0198744
diis-c [-3.19050646e-04  1.79219303e-02  9.82078070e-01]
  HOMO = -0.541072541720169  LUMO = 1.82010473387868
  mo_energy =
[-1.18217708e+02 -1.21230626e+01 -9.46888041e+00 -9.46888041e+00
 -9.46888041e+00 -1.22066225e+00 -5.41072542e-01 -5.41072542e-01
 -5.41072542e-01  1.82010473e+00  1.82010473e+00  1.82010473e+00
  1.86855981e+01  1.86855981e+01  1.86855981e+01  1.14103782e+02
  1.14103782e+02  1.14103782e+02  1.48567549e+02  4.25712744e+02
  4.25712744e+02  4.25712744e+02  1.08561120e+03  1.08561120e+03
  1.08561120e+03  1.52612402e+03  2.22054392e+03  2.22054392e+03
  2.22054392e+03  4.15385670e+03  4.15385670e+03  4.15385670e+03
  7.16759440e+03  7.88056829e+03  7.88056829e+03  7.88056829e+03
  2.30525163e+04  7.36908947e+04]
E1 = -728.1199013991646  E_coul = 202.46088275826583
cycle= 3 E= -525.659018640899  delta_E= -1.68e-06  |g|= 0.00123  |ddm|= 0.00126
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00237908
diis-c [-1.04956938e-07 -8.25922331e-04  9.75470951e-02  9.03278827e-01]
  HOMO = -0.541244056595366  LUMO = 1.81987288974144
  mo_energy =
[-1.18219879e+02 -1.21240438e+01 -9.46989485e+00 -9.46989485e+00
 -9.46989485e+00 -1.22088686e+00 -5.41244057e-01 -5.41244057e-01
 -5.41244057e-01  1.81987289e+00  1.81987289e+00  1.81987289e+00
  1.86846330e+01  1.86846330e+01  1.86846330e+01  1.14102067e+02
  1.14102067e+02  1.14102067e+02  1.48565586e+02  4.25710666e+02
  4.25710666e+02  4.25710666e+02  1.08560896e+03  1.08560896e+03
  1.08560896e+03  1.52612153e+03  2.22054158e+03  2.22054158e+03
  2.22054158e+03  4.15385426e+03  4.15385426e+03  4.15385426e+03
  7.16759176e+03  7.88056573e+03  7.88056573e+03  7.88056573e+03
  2.30525136e+04  7.36908920e+04]
E1 = -728.1225222226058  E_coul = 202.46350354695585
cycle= 4 E= -525.65901867565  delta_E= -3.48e-08  |g|= 3.75e-05  |ddm|= 0.000247
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.51528e-05
diis-c [-4.81243021e-10 -1.45724756e-05  9.52262751e-04  2.98928221e-02
  9.69169488e-01]
  HOMO = -0.541225809304159  LUMO = 1.81989526424921
  mo_energy =
[-1.18219794e+02 -1.21239760e+01 -9.46982643e+00 -9.46982643e+00
 -9.46982643e+00 -1.22086315e+00 -5.41225809e-01 -5.41225809e-01
 -5.41225809e-01  1.81989526e+00  1.81989526e+00  1.81989526e+00
  1.86846970e+01  1.86846970e+01  1.86846970e+01  1.14102147e+02
  1.14102147e+02  1.14102147e+02  1.48565671e+02  4.25710750e+02
  4.25710750e+02  4.25710750e+02  1.08560904e+03  1.08560904e+03
  1.08560904e+03  1.52612161e+03  2.22054166e+03  2.22054166e+03
  2.22054166e+03  4.15385434e+03  4.15385434e+03  4.15385434e+03
  7.16759184e+03  7.88056581e+03  7.88056581e+03  7.88056581e+03
  2.30525137e+04  7.36908921e+04]
E1 = -728.1223850517746  E_coul = 202.46336637604617
cycle= 5 E= -525.659018675728  delta_E= -7.86e-11  |g|= 3.36e-06  |ddm|= 1.6e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.1223850517746  E_coul = 202.46336637604617
  HOMO = -0.541227197670713  LUMO = 1.81989354589032
  mo_energy =
[-1.18219802e+02 -1.21239815e+01 -9.46983206e+00 -9.46983206e+00
 -9.46983206e+00 -1.22086496e+00 -5.41227198e-01 -5.41227198e-01
 -5.41227198e-01  1.81989355e+00  1.81989355e+00  1.81989355e+00
  1.86846918e+01  1.86846918e+01  1.86846918e+01  1.14102140e+02
  1.14102140e+02  1.14102140e+02  1.48565663e+02  4.25710742e+02
  4.25710742e+02  4.25710742e+02  1.08560904e+03  1.08560904e+03
  1.08560904e+03  1.52612160e+03  2.22054165e+03  2.22054165e+03
  2.22054165e+03  4.15385433e+03  4.15385433e+03  4.15385433e+03
  7.16759183e+03  7.88056580e+03  7.88056580e+03  7.88056580e+03
  2.30525137e+04  7.36908921e+04]
E1 = -728.1223970502057  E_coul = 202.46337837447663
Extra cycle  E= -525.659018675729  delta_E= -5.68e-13  |g|= 7.12e-07  |ddm|= 1.33e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.24 sec
exp = [2.61837249e+04 7.60489194e+03 3.59167092e+03 1.20421911e+03
 2.02069436e+02 4.71382290e+01 4.58875924e+00 3.89617561e-01
 1.36272232e+03 6.59586452e+02 2.74138839e+02 2.90542600e+02
 4.09645341e+02 1.82983584e+01 7.07658971e+01 1.13669671e+00
 5.15629997e+00 3.12152475e-01]
E = -525.659018675729
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26183.7248882        1
[INPUT] 0    0    [1    /1   ]  7604.89193835        1
[INPUT] 0    0    [1    /1   ]  3591.67091526        1
[INPUT] 0    0    [1    /1   ]  1204.21910974        1
[INPUT] 0    0    [1    /1   ]  202.069436141        1
[INPUT] 0    0    [1    /1   ]  47.1382290018        1
[INPUT] 0    0    [1    /1   ]  4.58875924273        1
[INPUT] 0    0    [1    /1   ]  0.389617561161       1
[INPUT] 1    0    [1    /1   ]  1362.72231709        1
[INPUT] 1    0    [1    /1   ]  659.586452154        1
[INPUT] 1    0    [1    /1   ]  274.138839224        1
[INPUT] 1    0    [1    /1   ]  290.542599644        1
[INPUT] 1    0    [1    /1   ]  409.645340535        1
[INPUT] 1    0    [1    /1   ]  18.2983583856        1
[INPUT] 1    0    [1    /1   ]  70.7658970522        1
[INPUT] 1    0    [1    /1   ]  1.13669670756        1
[INPUT] 1    0    [1    /1   ]  5.15629996744        1
[INPUT] 1    0    [1    /1   ]  0.312152474597       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26183.72488819734, 1.0]], [0, [7604.891938353888, 1.0]], [0, [3591.6709152614253, 1.0]], [0, [1204.2191097360228, 1.0]], [0, [202.06943614060486, 1.0]], [0, [47.13822900179376, 1.0]], [0, [4.588759242730897, 1.0]], [0, [0.3896175611614468, 1.0]], [1, [1362.7223170931902, 1.0]], [1, [659.5864521540447, 1.0]], [1, [274.13883922371167, 1.0]], [1, [290.5425996443702, 1.0]], [1, [409.6453405347592, 1.0]], [1, [18.298358385599904, 1.0]], [1, [70.7658970521998, 1.0]], [1, [1.1366967075624952, 1.0]], [1, [5.156299967443587, 1.0]], [1, [0.3121524745970744, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26183.7248882]
bas 1, expnt(s) = [7604.89193835]
bas 2, expnt(s) = [3591.67091526]
bas 3, expnt(s) = [1204.21910974]
bas 4, expnt(s) = [202.06943614]
bas 5, expnt(s) = [47.138229]
bas 6, expnt(s) = [4.58875924]
bas 7, expnt(s) = [0.38961756]
bas 8, expnt(s) = [1362.72231709]
bas 9, expnt(s) = [659.58645215]
bas 10, expnt(s) = [274.13883922]
bas 11, expnt(s) = [290.54259964]
bas 12, expnt(s) = [409.64534053]
bas 13, expnt(s) = [18.29835839]
bas 14, expnt(s) = [70.76589705]
bas 15, expnt(s) = [1.13669671]
bas 16, expnt(s) = [5.15629997]
bas 17, expnt(s) = [0.31215247]
CPU time:       524.57
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61837249e+04 5.20042211e+03 7.60489194e+03 2.05747615e+03
 3.59167092e+03 1.17216143e+03 1.20421911e+03 5.16468883e+02
 2.02069436e+02 1.35406807e+02 4.71382290e+01 4.54511599e+01
 4.58875924e+00 7.92111792e+00 3.89617561e-01 1.24593079e+00
 1.36272232e+03 2.41542526e+04 6.59586452e+02 9.75155896e+03
 2.74138839e+02 3.25422520e+03 2.90542600e+02 3.49942480e+03
 4.09645341e+02 5.37643521e+03 1.82983584e+01 1.10407749e+02
 7.07658971e+01 5.98776039e+02 1.13669671e+00 3.42405037e+00
 5.15629997e+00 2.26676820e+01 3.12152475e-01 6.80679812e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.940590384132125
cond(S) = 1460147.8736154041
E1 = -727.450468568338  E_coul = 202.90235519546928
init E= -524.548113372869
    CPU time for initialize scf      0.17 sec, wall time      0.05 sec
  HOMO = -0.55735876557757  LUMO = 1.80345761900945
  mo_energy =
[-1.18038807e+02 -1.21006370e+01 -9.44341886e+00 -9.44341886e+00
 -9.44341886e+00 -1.23611161e+00 -5.57358766e-01 -5.57358766e-01
 -5.57358766e-01  1.80345762e+00  1.80345762e+00  1.80345762e+00
  1.87120589e+01  1.87120589e+01  1.87120589e+01  1.14204718e+02
  1.14204718e+02  1.14204718e+02  1.48677254e+02  4.25866478e+02
  4.25866478e+02  4.25866478e+02  1.08580559e+03  1.08580559e+03
  1.08580559e+03  1.52646342e+03  2.22078000e+03  2.22078000e+03
  2.22078000e+03  4.15415372e+03  4.15415372e+03  4.15415372e+03
  7.16810349e+03  7.88099032e+03  7.88099032e+03  7.88099032e+03
  2.30531345e+04  7.36916088e+04]
E1 = -728.0665632496126  E_coul = 202.40772304770957
cycle= 1 E= -525.658840201903  delta_E= -1.11  |g|= 0.188  |ddm|= 0.785
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.477866
diis-c [-0.22835624  1.        ]
  HOMO = -0.540815703203206  LUMO = 1.82008195973649
  mo_energy =
[-1.18235373e+02 -1.21274484e+01 -9.47333372e+00 -9.47333372e+00
 -9.47333372e+00 -1.22038504e+00 -5.40815703e-01 -5.40815703e-01
 -5.40815703e-01  1.82008196e+00  1.82008196e+00  1.82008196e+00
  1.86812173e+01  1.86812173e+01  1.86812173e+01  1.14091371e+02
  1.14091371e+02  1.14091371e+02  1.48551579e+02  4.25696063e+02
  4.25696063e+02  4.25696063e+02  1.08559274e+03  1.08559274e+03
  1.08559274e+03  1.52610360e+03  2.22052448e+03  2.22052448e+03
  2.22052448e+03  4.15383651e+03  4.15383651e+03  4.15383651e+03
  7.16757354e+03  7.88054763e+03  7.88054763e+03  7.88054763e+03
  2.30524955e+04  7.36908740e+04]
E1 = -728.1367057849277  E_coul = 202.4776888203458
cycle= 2 E= -525.659016964582  delta_E= -0.000177  |g|= 0.0118  |ddm|= 0.0083
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0198744
diis-c [-3.19050646e-04  1.79219303e-02  9.82078070e-01]
  HOMO = -0.541072541720169  LUMO = 1.82010473387868
  mo_energy =
[-1.18217708e+02 -1.21230626e+01 -9.46888041e+00 -9.46888041e+00
 -9.46888041e+00 -1.22066225e+00 -5.41072542e-01 -5.41072542e-01
 -5.41072542e-01  1.82010473e+00  1.82010473e+00  1.82010473e+00
  1.86855981e+01  1.86855981e+01  1.86855981e+01  1.14103782e+02
  1.14103782e+02  1.14103782e+02  1.48567549e+02  4.25712744e+02
  4.25712744e+02  4.25712744e+02  1.08561120e+03  1.08561120e+03
  1.08561120e+03  1.52612402e+03  2.22054392e+03  2.22054392e+03
  2.22054392e+03  4.15385670e+03  4.15385670e+03  4.15385670e+03
  7.16759440e+03  7.88056829e+03  7.88056829e+03  7.88056829e+03
  2.30525163e+04  7.36908947e+04]
E1 = -728.1199013991646  E_coul = 202.46088275826583
cycle= 3 E= -525.659018640899  delta_E= -1.68e-06  |g|= 0.00123  |ddm|= 0.00126
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00237908
diis-c [-1.04956938e-07 -8.25922331e-04  9.75470951e-02  9.03278827e-01]
  HOMO = -0.541244056595366  LUMO = 1.81987288974144
  mo_energy =
[-1.18219879e+02 -1.21240438e+01 -9.46989485e+00 -9.46989485e+00
 -9.46989485e+00 -1.22088686e+00 -5.41244057e-01 -5.41244057e-01
 -5.41244057e-01  1.81987289e+00  1.81987289e+00  1.81987289e+00
  1.86846330e+01  1.86846330e+01  1.86846330e+01  1.14102067e+02
  1.14102067e+02  1.14102067e+02  1.48565586e+02  4.25710666e+02
  4.25710666e+02  4.25710666e+02  1.08560896e+03  1.08560896e+03
  1.08560896e+03  1.52612153e+03  2.22054158e+03  2.22054158e+03
  2.22054158e+03  4.15385426e+03  4.15385426e+03  4.15385426e+03
  7.16759176e+03  7.88056573e+03  7.88056573e+03  7.88056573e+03
  2.30525136e+04  7.36908920e+04]
E1 = -728.1225222226058  E_coul = 202.46350354695585
cycle= 4 E= -525.65901867565  delta_E= -3.48e-08  |g|= 3.75e-05  |ddm|= 0.000247
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.51528e-05
diis-c [-4.81243021e-10 -1.45724756e-05  9.52262751e-04  2.98928221e-02
  9.69169488e-01]
  HOMO = -0.541225809304159  LUMO = 1.81989526424921
  mo_energy =
[-1.18219794e+02 -1.21239760e+01 -9.46982643e+00 -9.46982643e+00
 -9.46982643e+00 -1.22086315e+00 -5.41225809e-01 -5.41225809e-01
 -5.41225809e-01  1.81989526e+00  1.81989526e+00  1.81989526e+00
  1.86846970e+01  1.86846970e+01  1.86846970e+01  1.14102147e+02
  1.14102147e+02  1.14102147e+02  1.48565671e+02  4.25710750e+02
  4.25710750e+02  4.25710750e+02  1.08560904e+03  1.08560904e+03
  1.08560904e+03  1.52612161e+03  2.22054166e+03  2.22054166e+03
  2.22054166e+03  4.15385434e+03  4.15385434e+03  4.15385434e+03
  7.16759184e+03  7.88056581e+03  7.88056581e+03  7.88056581e+03
  2.30525137e+04  7.36908921e+04]
E1 = -728.1223850517746  E_coul = 202.46336637604617
cycle= 5 E= -525.659018675728  delta_E= -7.86e-11  |g|= 3.36e-06  |ddm|= 1.6e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.1223850517746  E_coul = 202.46336637604617
  HOMO = -0.541227197670713  LUMO = 1.81989354589032
  mo_energy =
[-1.18219802e+02 -1.21239815e+01 -9.46983206e+00 -9.46983206e+00
 -9.46983206e+00 -1.22086496e+00 -5.41227198e-01 -5.41227198e-01
 -5.41227198e-01  1.81989355e+00  1.81989355e+00  1.81989355e+00
  1.86846918e+01  1.86846918e+01  1.86846918e+01  1.14102140e+02
  1.14102140e+02  1.14102140e+02  1.48565663e+02  4.25710742e+02
  4.25710742e+02  4.25710742e+02  1.08560904e+03  1.08560904e+03
  1.08560904e+03  1.52612160e+03  2.22054165e+03  2.22054165e+03
  2.22054165e+03  4.15385433e+03  4.15385433e+03  4.15385433e+03
  7.16759183e+03  7.88056580e+03  7.88056580e+03  7.88056580e+03
  2.30525137e+04  7.36908921e+04]
E1 = -728.1223970502057  E_coul = 202.46337837447663
Extra cycle  E= -525.659018675729  delta_E= -5.68e-13  |g|= 7.12e-07  |ddm|= 1.33e-06
    CPU time for scf_cycle      0.37 sec, wall time      0.25 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1460147.8736154041
E1 = -728.1223970502057  E_coul = 202.46337837447663
init E= -525.659018675729
    CPU time for initialize scf      1.01 sec, wall time      0.22 sec
  HOMO = -0.541227003929631  LUMO = 1.81989379401198
  mo_energy =
[-1.18219800e+02 -1.21239806e+01 -9.46983116e+00 -9.46983116e+00
 -9.46983116e+00 -1.22086471e+00 -5.41227004e-01 -5.41227004e-01
 -5.41227004e-01  1.81989379e+00  1.81989379e+00  1.81989379e+00
  1.86846926e+01  1.86846926e+01  1.86846926e+01  1.14102141e+02
  1.14102141e+02  1.14102141e+02  1.48565664e+02  4.25710744e+02
  4.25710744e+02  4.25710744e+02  1.08560904e+03  1.08560904e+03
  1.08560904e+03  1.52612160e+03  2.22054165e+03  2.22054165e+03
  2.22054165e+03  4.15385433e+03  4.15385433e+03  4.15385433e+03
  7.16759183e+03  7.88056580e+03  7.88056580e+03  7.88056580e+03
  2.30525137e+04  7.36908921e+04]
E1 = -728.1223949538476  E_coul = 202.4633762781191
cycle= 1 E= -525.659018675728  delta_E= 5.68e-13  |g|= 1.33e-07  |ddm|= 2.16e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.1223949538476  E_coul = 202.4633762781191
  HOMO = -0.541227036068824  LUMO = 1.81989375249781
  mo_energy =
[-1.18219801e+02 -1.21239808e+01 -9.46983131e+00 -9.46983131e+00
 -9.46983131e+00 -1.22086475e+00 -5.41227036e-01 -5.41227036e-01
 -5.41227036e-01  1.81989375e+00  1.81989375e+00  1.81989375e+00
  1.86846925e+01  1.86846925e+01  1.86846925e+01  1.14102141e+02
  1.14102141e+02  1.14102141e+02  1.48565664e+02  4.25710743e+02
  4.25710743e+02  4.25710743e+02  1.08560904e+03  1.08560904e+03
  1.08560904e+03  1.52612160e+03  2.22054165e+03  2.22054165e+03
  2.22054165e+03  4.15385433e+03  4.15385433e+03  4.15385433e+03
  7.16759183e+03  7.88056580e+03  7.88056580e+03  7.88056580e+03
  2.30525137e+04  7.36908921e+04]
E1 = -728.1223953260708  E_coul = 202.46337665034193
Extra cycle  E= -525.659018675729  delta_E= -3.41e-13  |g|= 2.41e-08  |ddm|= 3.76e-08
    CPU time for scf_cycle      1.15 sec, wall time      0.36 sec
/localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/scipy/optimize/_optimize.py:353: RuntimeWarning: Values in x were outside bounds during a minimize step, clipping to bounds
  warnings.warn("Values in x were outside bounds during a "
exp = [2.61837249e+04 7.60489194e+03 3.59167092e+03 1.20421911e+03
 2.02069436e+02 4.71382290e+01 4.58875924e+00 3.89617561e-01
 1.36272232e+03 6.59586452e+02 2.74138839e+02 2.90542600e+02
 4.09645341e+02 1.82983584e+01 7.07658971e+01 1.13669671e+00
 5.15629997e+00 3.12152475e-01]
grad_E = [-2.03021350e-06  1.52866573e-05  7.39145948e-06  1.24732316e-03
 -4.09799424e-03 -9.38029427e-03 -1.64551235e-02 -5.44158417e-02
 -2.95729694e-07  3.75114891e-06  1.60967627e-05  1.55286297e-05
  8.35035377e-06  2.88792162e-02  2.39677881e-03 -2.59482223e-02
 -8.52806006e-02  2.60021585e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:54 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26187.2612361        1
[INPUT] 0    0    [1    /1   ]  7566.05306692        1
[INPUT] 0    0    [1    /1   ]  3514.37771782        1
[INPUT] 0    0    [1    /1   ]  1e-09                1
[INPUT] 0    0    [1    /1   ]  113.697634915        1
[INPUT] 0    0    [1    /1   ]  34.8898583199        1
[INPUT] 0    0    [1    /1   ]  4.53618342447        1
[INPUT] 0    0    [1    /1   ]  0.361261351285       1
[INPUT] 1    0    [1    /1   ]  1362.46878352        1
[INPUT] 1    0    [1    /1   ]  642.935949659        1
[INPUT] 1    0    [1    /1   ]  187.088665956        1
[INPUT] 1    0    [1    /1   ]  214.151053777        1
[INPUT] 1    0    [1    /1   ]  1520.16652064        1
[INPUT] 1    0    [1    /1   ]  41.0576946337        1
[INPUT] 1    0    [1    /1   ]  193.169240434        1
[INPUT] 1    0    [1    /1   ]  2.12470958909        1
[INPUT] 1    0    [1    /1   ]  9.39806991852        1
[INPUT] 1    0    [1    /1   ]  0.550885587056       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26187.261236148235, 1.0]], [0, [7566.053066915416, 1.0]], [0, [3514.3777178234404, 1.0]], [0, [1e-09, 1.0]], [0, [113.6976349145833, 1.0]], [0, [34.889858319859144, 1.0]], [0, [4.536183424466288, 1.0]], [0, [0.3612613512849349, 1.0]], [1, [1362.4687835222874, 1.0]], [1, [642.9359496587233, 1.0]], [1, [187.08866595554065, 1.0]], [1, [214.15105377657864, 1.0]], [1, [1520.1665206368016, 1.0]], [1, [41.05769463366171, 1.0]], [1, [193.16924043406598, 1.0]], [1, [2.124709589085533, 1.0]], [1, [9.398069918518605, 1.0]], [1, [0.5508855870564423, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26187.26123615]
bas 1, expnt(s) = [7566.05306692]
bas 2, expnt(s) = [3514.37771782]
bas 3, expnt(s) = [1.e-09]
bas 4, expnt(s) = [113.69763491]
bas 5, expnt(s) = [34.88985832]
bas 6, expnt(s) = [4.53618342]
bas 7, expnt(s) = [0.36126135]
bas 8, expnt(s) = [1362.46878352]
bas 9, expnt(s) = [642.93594966]
bas 10, expnt(s) = [187.08866596]
bas 11, expnt(s) = [214.15105378]
bas 12, expnt(s) = [1520.16652064]
bas 13, expnt(s) = [41.05769463]
bas 14, expnt(s) = [193.16924043]
bas 15, expnt(s) = [2.12470959]
bas 16, expnt(s) = [9.39806992]
bas 17, expnt(s) = [0.55088559]
CPU time:       530.81
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61872612e+04 5.20094887e+03 7.56605307e+03 2.04959032e+03
 3.51437772e+03 1.15319129e+03 1.00000000e-09 4.49277867e-07
 1.13697635e+02 8.79687857e+01 3.48898583e+01 3.62693213e+01
 4.53618342e+00 7.85295267e+00 3.61261351e-01 1.17728375e+00
 1.36246878e+03 2.41486353e+04 6.42935950e+02 9.44482749e+03
 1.87088666e+02 2.01856966e+03 2.14151054e+02 2.38992715e+03
 1.52016652e+03 2.76916190e+04 4.10576946e+01 3.03198880e+02
 1.93169240e+02 2.10090714e+03 2.12470959e+00 7.48357068e+00
 9.39806992e+00 4.80045864e+01 5.50885587e-01 1.38455801e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.586073805846556
cond(S) = 23853868.994705953
E1 = -621.4624701406727  E_coul = 200.60777843786573
init E= -420.854691702807
    CPU time for initialize scf      0.71 sec, wall time      0.08 sec
  HOMO = -0.552286042670393  LUMO = -2.08863120846452e-05
  mo_energy =
[-1.08942129e+02 -1.14748358e+01 -9.50007141e+00 -9.50007141e+00
 -9.50007141e+00 -1.24038994e+00 -5.52286043e-01 -5.52286043e-01
 -5.52286043e-01 -2.08863121e-05  4.81188528e+00  4.81188528e+00
  4.81188528e+00  4.98794773e+01  4.98794773e+01  4.98794773e+01
  7.93166973e+01  2.36276850e+02  2.36276850e+02  2.36276850e+02
  6.56409557e+02  6.56409557e+02  6.56409557e+02  1.39514723e+03
  1.39514723e+03  1.39514723e+03  2.74652938e+03  2.74652938e+03
  2.74652938e+03  3.22487079e+03  5.47800440e+03  5.47800440e+03
  5.47800441e+03  1.07470272e+04  1.07470272e+04  1.07470272e+04
  1.84144445e+04  6.90011394e+04]
E1 = -710.4327804098307  E_coul = 206.1504080954118
cycle= 1 E= -504.282372314419  delta_E= -83.4  |g|= 1.47  |ddm|=  250
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=2.488
diis-c [-6.19015751  1.        ]
  HOMO = -0.311085946052872  LUMO = 1.50055363357445e-09
  mo_energy =
[-1.08860606e+02 -1.10520723e+01 -9.08217046e+00 -9.08217046e+00
 -9.08217046e+00 -9.74325499e-01 -3.11085946e-01 -3.11085946e-01
 -3.11085946e-01  1.50055363e-09  5.15819549e+00  5.15819549e+00
  5.15819549e+00  5.02345908e+01  5.02345908e+01  5.02345908e+01
  7.97022146e+01  2.36536323e+02  2.36536323e+02  2.36536323e+02
  6.56565891e+02  6.56565891e+02  6.56565891e+02  1.39515928e+03
  1.39515928e+03  1.39515928e+03  2.74626793e+03  2.74626793e+03
  2.74626793e+03  3.22362744e+03  5.47732862e+03  5.47732862e+03
  5.47732862e+03  1.07456177e+04  1.07456177e+04  1.07456177e+04
  1.84120117e+04  6.89982317e+04]
E1 = -710.0955617301537  E_coul = 205.81166258689936
cycle= 2 E= -504.283899143254  delta_E= -0.00153  |g|= 0.0205  |ddm|= 0.103
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0443428
diis-c [-0.00161765 -0.00756248  1.00756248]
  HOMO = -0.316195213814577  LUMO = 1.50049778871949e-09
  mo_energy =
[-1.08901390e+02 -1.10781938e+01 -9.10964586e+00 -9.10964586e+00
 -9.10964586e+00 -9.80296721e-01 -3.16195214e-01 -3.16195214e-01
 -3.16195214e-01  1.50049779e-09  5.14486015e+00  5.14486015e+00
  5.14486015e+00  5.02011198e+01  5.02011198e+01  5.02011198e+01
  7.96669242e+01  2.36497427e+02  2.36497427e+02  2.36497427e+02
  6.56525311e+02  6.56525311e+02  6.56525311e+02  1.39511774e+03
  1.39511774e+03  1.39511774e+03  2.74622533e+03  2.74622533e+03
  2.74622533e+03  3.22358180e+03  5.47728469e+03  5.47728469e+03
  5.47728470e+03  1.07455716e+04  1.07455716e+04  1.07455716e+04
  1.84119624e+04  6.89981809e+04]
E1 = -710.1305170472838  E_coul = 205.84660956352255
cycle= 3 E= -504.283907483761  delta_E= -8.34e-06  |g|= 0.00362  |ddm|= 0.0724
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00614681
diis-c [-8.81543905e-07 -7.20323845e-04  1.31086637e-01  8.69633687e-01]
  HOMO = -0.315886215084678  LUMO = 1.50051702930359e-09
  mo_energy =
[-1.08895912e+02 -1.10758556e+01 -9.10722904e+00 -9.10722904e+00
 -9.10722904e+00 -9.79935465e-01 -3.15886215e-01 -3.15886215e-01
 -3.15886215e-01  1.50051703e-09  5.14589080e+00  5.14589080e+00
  5.14589080e+00  5.02046955e+01  5.02046955e+01  5.02046955e+01
  7.96712559e+01  2.36502330e+02  2.36502330e+02  2.36502330e+02
  6.56530729e+02  6.56530729e+02  6.56530729e+02  1.39512345e+03
  1.39512345e+03  1.39512345e+03  2.74623130e+03  2.74623130e+03
  2.74623130e+03  3.22358807e+03  5.47729084e+03  5.47729084e+03
  5.47729084e+03  1.07455779e+04  1.07455779e+04  1.07455779e+04
  1.84119688e+04  6.89981873e+04]
E1 = -710.1255405678518  E_coul = 205.84163286830267
cycle= 4 E= -504.283907699549  delta_E= -2.16e-07  |g|= 3.53e-05  |ddm|= 0.0128
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=8.07344e-05
diis-c [-7.91669920e-10  2.21486524e-05 -4.63472019e-03 -1.87864484e-02
  1.02339902e+00]
  HOMO = -0.315889141300052  LUMO = 1.50054523240193e-09
  mo_energy =
[-1.08895935e+02 -1.10758591e+01 -9.10723698e+00 -9.10723698e+00
 -9.10723698e+00 -9.79938615e-01 -3.15889141e-01 -3.15889141e-01
 -3.15889141e-01  1.50054523e-09  5.14588572e+00  5.14588572e+00
  5.14588572e+00  5.02046839e+01  5.02046839e+01  5.02046839e+01
  7.96712503e+01  2.36502313e+02  2.36502313e+02  2.36502313e+02
  6.56530705e+02  6.56530705e+02  6.56530705e+02  1.39512342e+03
  1.39512342e+03  1.39512342e+03  2.74623125e+03  2.74623125e+03
  2.74623125e+03  3.22358800e+03  5.47729078e+03  5.47729078e+03
  5.47729078e+03  1.07455778e+04  1.07455778e+04  1.07455778e+04
  1.84119687e+04  6.89981872e+04]
E1 = -710.1255548869565  E_coul = 205.84164718738563
cycle= 5 E= -504.283907699571  delta_E= -2.17e-11  |g|= 2.92e-06  |ddm|= 0.000111
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -710.1255548869565  E_coul = 205.84164718738563
  HOMO = -0.315889614469285  LUMO = 1.50051922478293e-09
  mo_energy =
[-1.08895941e+02 -1.10758619e+01 -9.10723988e+00 -9.10723988e+00
 -9.10723988e+00 -9.79939171e-01 -3.15889614e-01 -3.15889614e-01
 -3.15889614e-01  1.50051922e-09  5.14588439e+00  5.14588439e+00
  5.14588439e+00  5.02046800e+01  5.02046800e+01  5.02046800e+01
  7.96712459e+01  2.36502308e+02  2.36502308e+02  2.36502308e+02
  6.56530699e+02  6.56530699e+02  6.56530700e+02  1.39512342e+03
  1.39512342e+03  1.39512342e+03  2.74623125e+03  2.74623125e+03
  2.74623125e+03  3.22358799e+03  5.47729078e+03  5.47729078e+03
  5.47729078e+03  1.07455778e+04  1.07455778e+04  1.07455778e+04
  1.84119687e+04  6.89981872e+04]
E1 = -710.1255596775628  E_coul = 205.84165197799072
Extra cycle  E= -504.283907699572  delta_E= -1.25e-12  |g|= 4.74e-07  |ddm|= 9.22e-06
    CPU time for scf_cycle      0.86 sec, wall time      0.23 sec
exp = [2.61872612e+04 7.56605307e+03 3.51437772e+03 1.00000000e-09
 1.13697635e+02 3.48898583e+01 4.53618342e+00 3.61261351e-01
 1.36246878e+03 6.42935950e+02 1.87088666e+02 2.14151054e+02
 1.52016652e+03 4.10576946e+01 1.93169240e+02 2.12470959e+00
 9.39806992e+00 5.50885587e-01]
E = -504.28390769957207
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:54 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26184.078523         1
[INPUT] 0    0    [1    /1   ]  7601.00805121        1
[INPUT] 0    0    [1    /1   ]  3583.94159552        1
[INPUT] 0    0    [1    /1   ]  1083.79719876        1
[INPUT] 0    0    [1    /1   ]  193.232256018        1
[INPUT] 0    0    [1    /1   ]  45.9133919336        1
[INPUT] 0    0    [1    /1   ]  4.5835016609         1
[INPUT] 0    0    [1    /1   ]  0.386781940174       1
[INPUT] 1    0    [1    /1   ]  1362.69696374        1
[INPUT] 1    0    [1    /1   ]  657.921401905        1
[INPUT] 1    0    [1    /1   ]  265.433821897        1
[INPUT] 1    0    [1    /1   ]  282.903445058        1
[INPUT] 1    0    [1    /1   ]  520.697458545        1
[INPUT] 1    0    [1    /1   ]  20.5742920104        1
[INPUT] 1    0    [1    /1   ]  83.0062313904        1
[INPUT] 1    0    [1    /1   ]  1.23549799571        1
[INPUT] 1    0    [1    /1   ]  5.58047696255        1
[INPUT] 1    0    [1    /1   ]  0.336025785843       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26184.07852299243, 1.0]], [0, [7601.00805121004, 1.0]], [0, [3583.941595517627, 1.0]], [0, [1083.7971987625206, 1.0]], [0, [193.23225601800272, 1.0]], [0, [45.9133919336003, 1.0]], [0, [4.583501660904436, 1.0]], [0, [0.38678194017379564, 1.0]], [1, [1362.6969637360999, 1.0]], [1, [657.9214019045125, 1.0]], [1, [265.4338218968946, 1.0]], [1, [282.90344505759106, 1.0]], [1, [520.6974585449634, 1.0]], [1, [20.574292010406086, 1.0]], [1, [83.00623139038642, 1.0]], [1, [1.235497995714799, 1.0]], [1, [5.580476962551089, 1.0]], [1, [0.3360257858430112, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26184.07852299]
bas 1, expnt(s) = [7601.00805121]
bas 2, expnt(s) = [3583.94159552]
bas 3, expnt(s) = [1083.79719876]
bas 4, expnt(s) = [193.23225602]
bas 5, expnt(s) = [45.91339193]
bas 6, expnt(s) = [4.58350166]
bas 7, expnt(s) = [0.38678194]
bas 8, expnt(s) = [1362.69696374]
bas 9, expnt(s) = [657.9214019]
bas 10, expnt(s) = [265.4338219]
bas 11, expnt(s) = [282.90344506]
bas 12, expnt(s) = [520.69745854]
bas 13, expnt(s) = [20.57429201]
bas 14, expnt(s) = [83.00623139]
bas 15, expnt(s) = [1.235498]
bas 16, expnt(s) = [5.58047696]
bas 17, expnt(s) = [0.33602579]
CPU time:       531.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61840785e+04 5.20047479e+03 7.60100805e+03 2.05668802e+03
 3.58394160e+03 1.17026904e+03 1.08379720e+03 4.77228138e+02
 1.93232256e+02 1.30940725e+02 4.59133919e+01 4.45625011e+01
 4.58350166e+00 7.91431021e+00 3.86781940e-01 1.23912370e+00
 1.36269696e+03 2.41536908e+04 6.57921402e+02 9.72079781e+03
 2.65433822e+02 3.12557351e+03 2.82903445e+02 3.38479357e+03
 5.20697459e+02 7.25631646e+03 2.05742920e+01 1.27832275e+02
 8.30062314e+01 7.30924911e+02 1.23549800e+00 3.80002933e+00
 5.58047696e+00 2.50220877e+01 3.36025786e-01 7.46363082e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.923647484457835
cond(S) = 535300.1667856483
E1 = -727.447936877682  E_coul = 202.8217699723685
init E= -524.626166905314
    CPU time for initialize scf      0.69 sec, wall time      0.08 sec
  HOMO = -0.556060438261767  LUMO = 2.04511948235029
  mo_energy =
[-1.18099411e+02 -1.21055149e+01 -9.44252069e+00 -9.44252069e+00
 -9.44252069e+00 -1.23900222e+00 -5.56060438e-01 -5.56060438e-01
 -5.56060438e-01  2.04511948e+00  2.04511948e+00  2.04511948e+00
  2.15335293e+01  2.15335293e+01  2.15335293e+01  1.31746956e+02
  1.31746956e+02  1.31746956e+02  1.40767253e+02  4.68295393e+02
  4.68295393e+02  4.68295393e+02  1.15677974e+03  1.15677974e+03
  1.15677974e+03  1.41187746e+03  2.35054592e+03  2.35054592e+03
  2.35054592e+03  4.39563271e+03  4.39563271e+03  4.39563271e+03
  6.82922560e+03  8.23265632e+03  8.23265632e+03  8.23265632e+03
  2.25820679e+04  7.31879437e+04]
E1 = -728.3791250085403  E_coul = 202.678020931814
cycle= 1 E= -525.701104076726  delta_E= -1.07  |g|= 0.183  |ddm|= 0.534
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.477247
diis-c [-0.22776449  1.        ]
  HOMO = -0.52712786231449  LUMO = 2.0761145527775
  mo_energy =
[-1.18272318e+02 -1.21064197e+01 -9.44781107e+00 -9.44781107e+00
 -9.44781107e+00 -1.20809376e+00 -5.27127862e-01 -5.27127862e-01
 -5.27127862e-01  2.07611455e+00  2.07611455e+00  2.07611455e+00
  2.15198520e+01  2.15198520e+01  2.15198520e+01  1.31648974e+02
  1.31648974e+02  1.31648974e+02  1.40669731e+02  4.68144864e+02
  4.68144864e+02  4.68144864e+02  1.15658547e+03  1.15658547e+03
  1.15658547e+03  1.41154701e+03  2.35030533e+03  2.35030533e+03
  2.35030533e+03  4.39532983e+03  4.39532983e+03  4.39532983e+03
  6.82871954e+03  8.23223168e+03  8.23223168e+03  8.23223168e+03
  2.25814505e+04  7.31872315e+04]
E1 = -728.4064467874595  E_coul = 202.70513984383965
cycle= 2 E= -525.70130694362  delta_E= -0.000203  |g|= 0.0104  |ddm|= 0.0128
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0168077
diis-c [-2.32936844e-04  1.45444449e-02  9.85455555e-01]
  HOMO = -0.52817242453856  LUMO = 2.07510602567491
  mo_energy =
[-1.18259056e+02 -1.21052845e+01 -9.44667468e+00 -9.44667468e+00
 -9.44667468e+00 -1.20939943e+00 -5.28172425e-01 -5.28172425e-01
 -5.28172425e-01  2.07510603e+00  2.07510603e+00  2.07510603e+00
  2.15216908e+01  2.15216908e+01  2.15216908e+01  1.31657962e+02
  1.31657962e+02  1.31657962e+02  1.40681264e+02  4.68157396e+02
  4.68157396e+02  4.68157396e+02  1.15659957e+03  1.15659957e+03
  1.15659957e+03  1.41156280e+03  2.35032036e+03  2.35032036e+03
  2.35032036e+03  4.39534553e+03  4.39534553e+03  4.39534553e+03
  6.82873577e+03  8.23224776e+03  8.23224776e+03  8.23224776e+03
  2.25814667e+04  7.31872476e+04]
E1 = -728.39588280985  E_coul = 202.69457483921144
cycle= 3 E= -525.701307970639  delta_E= -1.03e-06  |g|= 0.000922  |ddm|= 0.000676
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00183025
diis-c [-1.08814835e-07 -8.22461257e-04  8.64625126e-02  9.14359949e-01]
  HOMO = -0.528267395170308  LUMO = 2.07495562052309
  mo_energy =
[-1.18260642e+02 -1.21059204e+01 -9.44733848e+00 -9.44733848e+00
 -9.44733848e+00 -1.20952282e+00 -5.28267395e-01 -5.28267395e-01
 -5.28267395e-01  2.07495562e+00  2.07495562e+00  2.07495562e+00
  2.15210042e+01  2.15210042e+01  2.15210042e+01  1.31656698e+02
  1.31656698e+02  1.31656698e+02  1.40679868e+02  4.68155871e+02
  4.68155871e+02  4.68155871e+02  1.15659792e+03  1.15659792e+03
  1.15659792e+03  1.41156093e+03  2.35031862e+03  2.35031862e+03
  2.35031862e+03  4.39534369e+03  4.39534369e+03  4.39534369e+03
  6.82873375e+03  8.23224581e+03  8.23224581e+03  8.23224581e+03
  2.25814646e+04  7.31872454e+04]
E1 = -728.3976446101271  E_coul = 202.69633662241398
cycle= 4 E= -525.701307987713  delta_E= -1.71e-08  |g|= 3.58e-05  |ddm|= 0.00016
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.17065e-05
diis-c [-4.61450985e-10 -8.85692348e-06  1.66405492e-04  2.77141444e-02
  9.72128307e-01]
  HOMO = -0.528251790382572  LUMO = 2.07497693334991
  mo_energy =
[-1.18260563e+02 -1.21058590e+01 -9.44727649e+00 -9.44727649e+00
 -9.44727649e+00 -1.20950259e+00 -5.28251790e-01 -5.28251790e-01
 -5.28251790e-01  2.07497693e+00  2.07497693e+00  2.07497693e+00
  2.15210642e+01  2.15210642e+01  2.15210642e+01  1.31656772e+02
  1.31656772e+02  1.31656772e+02  1.40679947e+02  4.68155950e+02
  4.68155950e+02  4.68155950e+02  1.15659800e+03  1.15659800e+03
  1.15659800e+03  1.41156101e+03  2.35031869e+03  2.35031870e+03
  2.35031870e+03  4.39534377e+03  4.39534377e+03  4.39534377e+03
  6.82873383e+03  8.23224589e+03  8.23224589e+03  8.23224589e+03
  2.25814646e+04  7.31872455e+04]
E1 = -728.3975284333919  E_coul = 202.69622044562036
cycle= 5 E= -525.701307987772  delta_E= -5.84e-11  |g|= 3.35e-06  |ddm|= 1.34e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3975284333919  E_coul = 202.69622044562036
  HOMO = -0.5282530410841  LUMO = 2.07497521048134
  mo_energy =
[-1.18260571e+02 -1.21058642e+01 -9.44728181e+00 -9.44728181e+00
 -9.44728181e+00 -1.20950421e+00 -5.28253041e-01 -5.28253041e-01
 -5.28253041e-01  2.07497521e+00  2.07497521e+00  2.07497521e+00
  2.15210590e+01  2.15210590e+01  2.15210590e+01  1.31656765e+02
  1.31656765e+02  1.31656765e+02  1.40679939e+02  4.68155942e+02
  4.68155942e+02  4.68155942e+02  1.15659799e+03  1.15659799e+03
  1.15659799e+03  1.41156100e+03  2.35031869e+03  2.35031869e+03
  2.35031869e+03  4.39534376e+03  4.39534376e+03  4.39534376e+03
  6.82873382e+03  8.23224588e+03  8.23224588e+03  8.23224588e+03
  2.25814646e+04  7.31872455e+04]
E1 = -728.3975391408653  E_coul = 202.69623115309318
Extra cycle  E= -525.701307987772  delta_E= -5.68e-13  |g|= 6.79e-07  |ddm|= 1.17e-06
    CPU time for scf_cycle      0.87 sec, wall time      0.25 sec
exp = [2.61840785e+04 7.60100805e+03 3.58394160e+03 1.08379720e+03
 1.93232256e+02 4.59133919e+01 4.58350166e+00 3.86781940e-01
 1.36269696e+03 6.57921402e+02 2.65433822e+02 2.82903445e+02
 5.20697459e+02 2.05742920e+01 8.30062314e+01 1.23549800e+00
 5.58047696e+00 3.36025786e-01]
E = -525.7013079877721
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:27:55 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26184.078523         1
[INPUT] 0    0    [1    /1   ]  7601.00805121        1
[INPUT] 0    0    [1    /1   ]  3583.94159552        1
[INPUT] 0    0    [1    /1   ]  1083.79719876        1
[INPUT] 0    0    [1    /1   ]  193.232256018        1
[INPUT] 0    0    [1    /1   ]  45.9133919336        1
[INPUT] 0    0    [1    /1   ]  4.5835016609         1
[INPUT] 0    0    [1    /1   ]  0.386781940174       1
[INPUT] 1    0    [1    /1   ]  1362.69696374        1
[INPUT] 1    0    [1    /1   ]  657.921401905        1
[INPUT] 1    0    [1    /1   ]  265.433821897        1
[INPUT] 1    0    [1    /1   ]  282.903445058        1
[INPUT] 1    0    [1    /1   ]  520.697458545        1
[INPUT] 1    0    [1    /1   ]  20.5742920104        1
[INPUT] 1    0    [1    /1   ]  83.0062313904        1
[INPUT] 1    0    [1    /1   ]  1.23549799571        1
[INPUT] 1    0    [1    /1   ]  5.58047696255        1
[INPUT] 1    0    [1    /1   ]  0.336025785843       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26184.07852299243, 1.0]], [0, [7601.00805121004, 1.0]], [0, [3583.941595517627, 1.0]], [0, [1083.7971987625206, 1.0]], [0, [193.23225601800272, 1.0]], [0, [45.9133919336003, 1.0]], [0, [4.583501660904436, 1.0]], [0, [0.38678194017379564, 1.0]], [1, [1362.6969637360999, 1.0]], [1, [657.9214019045125, 1.0]], [1, [265.4338218968946, 1.0]], [1, [282.90344505759106, 1.0]], [1, [520.6974585449634, 1.0]], [1, [20.574292010406086, 1.0]], [1, [83.00623139038642, 1.0]], [1, [1.235497995714799, 1.0]], [1, [5.580476962551089, 1.0]], [1, [0.3360257858430112, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26184.07852299]
bas 1, expnt(s) = [7601.00805121]
bas 2, expnt(s) = [3583.94159552]
bas 3, expnt(s) = [1083.79719876]
bas 4, expnt(s) = [193.23225602]
bas 5, expnt(s) = [45.91339193]
bas 6, expnt(s) = [4.58350166]
bas 7, expnt(s) = [0.38678194]
bas 8, expnt(s) = [1362.69696374]
bas 9, expnt(s) = [657.9214019]
bas 10, expnt(s) = [265.4338219]
bas 11, expnt(s) = [282.90344506]
bas 12, expnt(s) = [520.69745854]
bas 13, expnt(s) = [20.57429201]
bas 14, expnt(s) = [83.00623139]
bas 15, expnt(s) = [1.235498]
bas 16, expnt(s) = [5.58047696]
bas 17, expnt(s) = [0.33602579]
CPU time:       533.16
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61840785e+04 5.20047479e+03 7.60100805e+03 2.05668802e+03
 3.58394160e+03 1.17026904e+03 1.08379720e+03 4.77228138e+02
 1.93232256e+02 1.30940725e+02 4.59133919e+01 4.45625011e+01
 4.58350166e+00 7.91431021e+00 3.86781940e-01 1.23912370e+00
 1.36269696e+03 2.41536908e+04 6.57921402e+02 9.72079781e+03
 2.65433822e+02 3.12557351e+03 2.82903445e+02 3.38479357e+03
 5.20697459e+02 7.25631646e+03 2.05742920e+01 1.27832275e+02
 8.30062314e+01 7.30924911e+02 1.23549800e+00 3.80002933e+00
 5.58047696e+00 2.50220877e+01 3.36025786e-01 7.46363082e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.923647484457835
cond(S) = 535300.1667856483
E1 = -727.447936877682  E_coul = 202.8217699723685
init E= -524.626166905314
    CPU time for initialize scf      0.66 sec, wall time      0.08 sec
  HOMO = -0.556060438261767  LUMO = 2.04511948235029
  mo_energy =
[-1.18099411e+02 -1.21055149e+01 -9.44252069e+00 -9.44252069e+00
 -9.44252069e+00 -1.23900222e+00 -5.56060438e-01 -5.56060438e-01
 -5.56060438e-01  2.04511948e+00  2.04511948e+00  2.04511948e+00
  2.15335293e+01  2.15335293e+01  2.15335293e+01  1.31746956e+02
  1.31746956e+02  1.31746956e+02  1.40767253e+02  4.68295393e+02
  4.68295393e+02  4.68295393e+02  1.15677974e+03  1.15677974e+03
  1.15677974e+03  1.41187746e+03  2.35054592e+03  2.35054592e+03
  2.35054592e+03  4.39563271e+03  4.39563271e+03  4.39563271e+03
  6.82922560e+03  8.23265632e+03  8.23265632e+03  8.23265632e+03
  2.25820679e+04  7.31879437e+04]
E1 = -728.3791250085403  E_coul = 202.678020931814
cycle= 1 E= -525.701104076726  delta_E= -1.07  |g|= 0.183  |ddm|= 0.534
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.477247
diis-c [-0.22776449  1.        ]
  HOMO = -0.52712786231449  LUMO = 2.0761145527775
  mo_energy =
[-1.18272318e+02 -1.21064197e+01 -9.44781107e+00 -9.44781107e+00
 -9.44781107e+00 -1.20809376e+00 -5.27127862e-01 -5.27127862e-01
 -5.27127862e-01  2.07611455e+00  2.07611455e+00  2.07611455e+00
  2.15198520e+01  2.15198520e+01  2.15198520e+01  1.31648974e+02
  1.31648974e+02  1.31648974e+02  1.40669731e+02  4.68144864e+02
  4.68144864e+02  4.68144864e+02  1.15658547e+03  1.15658547e+03
  1.15658547e+03  1.41154701e+03  2.35030533e+03  2.35030533e+03
  2.35030533e+03  4.39532983e+03  4.39532983e+03  4.39532983e+03
  6.82871954e+03  8.23223168e+03  8.23223168e+03  8.23223168e+03
  2.25814505e+04  7.31872315e+04]
E1 = -728.4064467874595  E_coul = 202.70513984383965
cycle= 2 E= -525.70130694362  delta_E= -0.000203  |g|= 0.0104  |ddm|= 0.0128
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0168077
diis-c [-2.32936844e-04  1.45444449e-02  9.85455555e-01]
  HOMO = -0.52817242453856  LUMO = 2.07510602567491
  mo_energy =
[-1.18259056e+02 -1.21052845e+01 -9.44667468e+00 -9.44667468e+00
 -9.44667468e+00 -1.20939943e+00 -5.28172425e-01 -5.28172425e-01
 -5.28172425e-01  2.07510603e+00  2.07510603e+00  2.07510603e+00
  2.15216908e+01  2.15216908e+01  2.15216908e+01  1.31657962e+02
  1.31657962e+02  1.31657962e+02  1.40681264e+02  4.68157396e+02
  4.68157396e+02  4.68157396e+02  1.15659957e+03  1.15659957e+03
  1.15659957e+03  1.41156280e+03  2.35032036e+03  2.35032036e+03
  2.35032036e+03  4.39534553e+03  4.39534553e+03  4.39534553e+03
  6.82873577e+03  8.23224776e+03  8.23224776e+03  8.23224776e+03
  2.25814667e+04  7.31872476e+04]
E1 = -728.39588280985  E_coul = 202.69457483921144
cycle= 3 E= -525.701307970639  delta_E= -1.03e-06  |g|= 0.000922  |ddm|= 0.000676
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00183025
diis-c [-1.08814835e-07 -8.22461257e-04  8.64625126e-02  9.14359949e-01]
  HOMO = -0.528267395170308  LUMO = 2.07495562052309
  mo_energy =
[-1.18260642e+02 -1.21059204e+01 -9.44733848e+00 -9.44733848e+00
 -9.44733848e+00 -1.20952282e+00 -5.28267395e-01 -5.28267395e-01
 -5.28267395e-01  2.07495562e+00  2.07495562e+00  2.07495562e+00
  2.15210042e+01  2.15210042e+01  2.15210042e+01  1.31656698e+02
  1.31656698e+02  1.31656698e+02  1.40679868e+02  4.68155871e+02
  4.68155871e+02  4.68155871e+02  1.15659792e+03  1.15659792e+03
  1.15659792e+03  1.41156093e+03  2.35031862e+03  2.35031862e+03
  2.35031862e+03  4.39534369e+03  4.39534369e+03  4.39534369e+03
  6.82873375e+03  8.23224581e+03  8.23224581e+03  8.23224581e+03
  2.25814646e+04  7.31872454e+04]
E1 = -728.3976446101271  E_coul = 202.69633662241398
cycle= 4 E= -525.701307987713  delta_E= -1.71e-08  |g|= 3.58e-05  |ddm|= 0.00016
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.17065e-05
diis-c [-4.61450985e-10 -8.85692348e-06  1.66405492e-04  2.77141444e-02
  9.72128307e-01]
  HOMO = -0.528251790382572  LUMO = 2.07497693334991
  mo_energy =
[-1.18260563e+02 -1.21058590e+01 -9.44727649e+00 -9.44727649e+00
 -9.44727649e+00 -1.20950259e+00 -5.28251790e-01 -5.28251790e-01
 -5.28251790e-01  2.07497693e+00  2.07497693e+00  2.07497693e+00
  2.15210642e+01  2.15210642e+01  2.15210642e+01  1.31656772e+02
  1.31656772e+02  1.31656772e+02  1.40679947e+02  4.68155950e+02
  4.68155950e+02  4.68155950e+02  1.15659800e+03  1.15659800e+03
  1.15659800e+03  1.41156101e+03  2.35031869e+03  2.35031870e+03
  2.35031870e+03  4.39534377e+03  4.39534377e+03  4.39534377e+03
  6.82873383e+03  8.23224589e+03  8.23224589e+03  8.23224589e+03
  2.25814646e+04  7.31872455e+04]
E1 = -728.3975284333919  E_coul = 202.69622044562036
cycle= 5 E= -525.701307987772  delta_E= -5.84e-11  |g|= 3.35e-06  |ddm|= 1.34e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3975284333919  E_coul = 202.69622044562036
  HOMO = -0.5282530410841  LUMO = 2.07497521048134
  mo_energy =
[-1.18260571e+02 -1.21058642e+01 -9.44728181e+00 -9.44728181e+00
 -9.44728181e+00 -1.20950421e+00 -5.28253041e-01 -5.28253041e-01
 -5.28253041e-01  2.07497521e+00  2.07497521e+00  2.07497521e+00
  2.15210590e+01  2.15210590e+01  2.15210590e+01  1.31656765e+02
  1.31656765e+02  1.31656765e+02  1.40679939e+02  4.68155942e+02
  4.68155942e+02  4.68155942e+02  1.15659799e+03  1.15659799e+03
  1.15659799e+03  1.41156100e+03  2.35031869e+03  2.35031869e+03
  2.35031869e+03  4.39534376e+03  4.39534376e+03  4.39534376e+03
  6.82873382e+03  8.23224588e+03  8.23224588e+03  8.23224588e+03
  2.25814646e+04  7.31872455e+04]
E1 = -728.3975391408653  E_coul = 202.69623115309318
Extra cycle  E= -525.701307987772  delta_E= -5.68e-13  |g|= 6.79e-07  |ddm|= 1.17e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.24 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 535300.1667856483
E1 = -728.3975391408653  E_coul = 202.69623115309318
init E= -525.701307987772
    CPU time for initialize scf      1.96 sec, wall time      0.27 sec
  HOMO = -0.52825287889574  LUMO = 2.07497544399257
  mo_energy =
[-1.18260569e+02 -1.21058634e+01 -9.44728101e+00 -9.44728101e+00
 -9.44728101e+00 -1.20950400e+00 -5.28252879e-01 -5.28252879e-01
 -5.28252879e-01  2.07497544e+00  2.07497544e+00  2.07497544e+00
  2.15210598e+01  2.15210598e+01  2.15210598e+01  1.31656767e+02
  1.31656767e+02  1.31656767e+02  1.40679940e+02  4.68155944e+02
  4.68155944e+02  4.68155944e+02  1.15659799e+03  1.15659799e+03
  1.15659799e+03  1.41156100e+03  2.35031869e+03  2.35031869e+03
  2.35031869e+03  4.39534376e+03  4.39534376e+03  4.39534376e+03
  6.82873382e+03  8.23224588e+03  8.23224588e+03  8.23224588e+03
  2.25814646e+04  7.31872455e+04]
E1 = -728.3975373377616  E_coul = 202.69622934998876
cycle= 1 E= -525.701307987773  delta_E= -7.96e-13  |g|= 1.21e-07  |ddm|= 1.83e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3975373377616  E_coul = 202.69622934998876
  HOMO = -0.528252904892518  LUMO = 2.07497540622243
  mo_energy =
[-1.18260570e+02 -1.21058635e+01 -9.44728114e+00 -9.44728114e+00
 -9.44728114e+00 -1.20950404e+00 -5.28252905e-01 -5.28252905e-01
 -5.28252905e-01  2.07497541e+00  2.07497541e+00  2.07497541e+00
  2.15210597e+01  2.15210597e+01  2.15210597e+01  1.31656766e+02
  1.31656766e+02  1.31656766e+02  1.40679940e+02  4.68155943e+02
  4.68155943e+02  4.68155943e+02  1.15659799e+03  1.15659799e+03
  1.15659799e+03  1.41156100e+03  2.35031869e+03  2.35031869e+03
  2.35031869e+03  4.39534376e+03  4.39534376e+03  4.39534376e+03
  6.82873382e+03  8.23224588e+03  8.23224588e+03  8.23224588e+03
  2.25814646e+04  7.31872455e+04]
E1 = -728.3975376469598  E_coul = 202.6962296591871
Extra cycle  E= -525.701307987773  delta_E= 2.27e-13  |g|= 2.13e-08  |ddm|= 3.09e-08
    CPU time for scf_cycle      2.29 sec, wall time      0.61 sec
exp = [2.61840785e+04 7.60100805e+03 3.58394160e+03 1.08379720e+03
 1.93232256e+02 4.59133919e+01 4.58350166e+00 3.86781940e-01
 1.36269696e+03 6.57921402e+02 2.65433822e+02 2.82903445e+02
 5.20697459e+02 2.05742920e+01 8.30062314e+01 1.23549800e+00
 5.58047696e+00 3.36025786e-01]
grad_E = [-1.94074053e-06  1.05789759e-05 -7.37579539e-06  1.31615047e-03
 -3.00207418e-03 -1.41296214e-02 -2.30249188e-02 -7.45362571e-02
 -4.17428925e-08  4.41396968e-06  2.65724072e-05  2.46868908e-05
  6.77084389e-06  4.24099651e-02  1.14691396e-03 -6.36459601e-02
 -1.05785023e-01  4.09197071e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26187.2615687        1
[INPUT] 0    0    [1    /1   ]  7566.05391287        1
[INPUT] 0    0    [1    /1   ]  3514.38577201        1
[INPUT] 0    0    [1    /1   ]  1e-09                1
[INPUT] 0    0    [1    /1   ]  111.156907526        1
[INPUT] 0    0    [1    /1   ]  34.6110613788        1
[INPUT] 0    0    [1    /1   ]  4.54004997009        1
[INPUT] 0    0    [1    /1   ]  0.362456966009       1
[INPUT] 1    0    [1    /1   ]  1362.49027347        1
[INPUT] 1    0    [1    /1   ]  643.116174904        1
[INPUT] 1    0    [1    /1   ]  188.110543497        1
[INPUT] 1    0    [1    /1   ]  215.054046961        1
[INPUT] 1    0    [1    /1   ]  1498.2752501         1
[INPUT] 1    0    [1    /1   ]  39.6802541326        1
[INPUT] 1    0    [1    /1   ]  188.15893915         1
[INPUT] 1    0    [1    /1   ]  2.10017789316        1
[INPUT] 1    0    [1    /1   ]  9.06950054085        1
[INPUT] 1    0    [1    /1   ]  0.538019981847       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26187.261568682698, 1.0]], [0, [7566.053912870389, 1.0]], [0, [3514.38577200536, 1.0]], [0, [1e-09, 1.0]], [0, [111.1569075264964, 1.0]], [0, [34.61106137878352, 1.0]], [0, [4.54004997008632, 1.0]], [0, [0.36245696600885596, 1.0]], [1, [1362.4902734704688, 1.0]], [1, [643.1161749042292, 1.0]], [1, [188.11054349660236, 1.0]], [1, [215.0540469611849, 1.0]], [1, [1498.2752500960269, 1.0]], [1, [39.68025413256686, 1.0]], [1, [188.15893914988402, 1.0]], [1, [2.100177893162843, 1.0]], [1, [9.0695005408503, 1.0]], [1, [0.538019981847217, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26187.26156868]
bas 1, expnt(s) = [7566.05391287]
bas 2, expnt(s) = [3514.38577201]
bas 3, expnt(s) = [1.e-09]
bas 4, expnt(s) = [111.15690753]
bas 5, expnt(s) = [34.61106138]
bas 6, expnt(s) = [4.54004997]
bas 7, expnt(s) = [0.36245697]
bas 8, expnt(s) = [1362.49027347]
bas 9, expnt(s) = [643.1161749]
bas 10, expnt(s) = [188.1105435]
bas 11, expnt(s) = [215.05404696]
bas 12, expnt(s) = [1498.2752501]
bas 13, expnt(s) = [39.68025413]
bas 14, expnt(s) = [188.15893915]
bas 15, expnt(s) = [2.10017789]
bas 16, expnt(s) = [9.06950054]
bas 17, expnt(s) = [0.53801998]
CPU time:       540.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61872616e+04 5.20094892e+03 7.56605391e+03 2.04959049e+03
 3.51438577e+03 1.15319327e+03 1.00000000e-09 4.49277867e-07
 1.11156908e+02 8.64902926e+01 3.46110614e+01 3.60517385e+01
 4.54004997e+00 7.85797240e+00 3.62456966e-01 1.18020476e+00
 1.36249027e+03 2.41491115e+04 6.43116175e+02 9.44813703e+03
 1.88110543e+02 2.03236083e+03 2.15054047e+02 2.40253054e+03
 1.49827525e+03 2.71940505e+04 3.96802541e+01 2.90537670e+02
 1.88158939e+02 2.03301444e+03 2.10017789e+00 7.37572126e+00
 9.06950054e+00 4.59159534e+01 5.38019982e-01 1.34425729e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.613032524572578
cond(S) = 254174055792.76828

WARN: Singularity detected in overlap matrix (condition number = 2.54e+11). SCF may be inaccurate and hard to converge.

E1 = -616.3083566202364  E_coul = 200.7182430071612
init E= -415.590113613075
    CPU time for initialize scf      0.21 sec, wall time      0.05 sec
  HOMO = -0.552350272077454  LUMO = -1.95259035040971e-05
  mo_energy =
[-1.08557315e+02 -1.14359498e+01 -9.50290058e+00 -9.50285832e+00
 -9.50285732e+00 -1.23050951e+00 -5.52354319e-01 -5.52350367e-01
 -5.52350272e-01 -1.95259035e-05  4.65845744e+00  4.65846254e+00
  4.65846260e+00  4.83369924e+01  4.83677614e+01  4.83684190e+01
  7.78391782e+01  2.50605109e+02  2.51815220e+02  2.51839910e+02
  7.34744469e+02  7.40552454e+02  7.40673268e+02  1.62289785e+03
  1.64429487e+03  1.64476649e+03  3.03973395e+03  3.07891289e+03
  3.07983302e+03  3.21639110e+03  5.62327137e+03  5.64689580e+03
  5.64747051e+03  1.07609281e+04  1.07707929e+04  1.07710397e+04
  1.84066572e+04  6.89940045e+04]
E1 = -709.216430159415  E_coul = 205.71629014583
cycle= 1 E= -503.500140013585  delta_E= -87.9  |g|= 2.65  |ddm|= 3.76e+06
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=2.55426
diis-c [-6.52422978  1.        ]
  HOMO = -0.327635702865586  LUMO = 1.50055618424723e-09
  mo_energy =
[-1.08532573e+02 -1.10449708e+01 -9.11721653e+00 -9.11719647e+00
 -9.11719438e+00 -9.81471685e-01 -3.27638070e-01 -3.27635899e-01
 -3.27635703e-01  1.50055618e-09  4.97940315e+00  4.97941448e+00
  4.97941460e+00  4.81649475e+01  4.81725186e+01  4.81743784e+01
  7.81845155e+01  2.31632399e+02  2.31925133e+02  2.31997060e+02
  6.50030609e+02  6.51189691e+02  6.51475106e+02  1.38687426e+03
  1.38928532e+03  1.38988140e+03  2.73267041e+03  2.73502826e+03
  2.73561266e+03  3.21506295e+03  5.44981470e+03  5.45112113e+03
  5.45144488e+03  1.06816643e+04  1.06822995e+04  1.06824568e+04
  1.84041066e+04  6.89909678e+04]
E1 = -708.9266615349777  E_coul = 205.42349671591248
cycle= 2 E= -503.503164819065  delta_E= -0.00302  |g|= 0.224  |ddm|= 1.63e+05
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.032451
diis-c [-7.81070352e-04 -6.49916391e-03  1.00649916e+00]
  HOMO = -0.332519655986084  LUMO = 1.50054130348546e-09
  mo_energy =
[-1.08564449e+02 -1.10679173e+01 -9.14121035e+00 -9.14120800e+00
 -9.14119922e+00 -9.87250474e-01 -3.32520726e-01 -3.32520720e-01
 -3.32519656e-01  1.50054130e-09  4.96739273e+00  4.96739530e+00
  4.96739645e+00  4.81901467e+01  4.81950668e+01  4.81993827e+01
  7.81563962e+01  2.33640493e+02  2.33831794e+02  2.33999484e+02
  6.58169953e+02  6.58948220e+02  6.59632209e+02  1.40423160e+03
  1.40593622e+03  1.40744211e+03  2.74988816e+03  2.75161113e+03
  2.75313613e+03  3.21502673e+03  5.45932563e+03  5.46027860e+03
  5.46111933e+03  1.06862490e+04  1.06867090e+04  1.06871124e+04
  1.84040667e+04  6.89909265e+04]
E1 = -708.9508313454172  E_coul = 205.4476375259489
cycle= 3 E= -503.503193819468  delta_E= -2.9e-05  |g|= 0.0385  |ddm|= 1.92e+04
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00380447
diis-c [-6.45608586e-07 -6.25621099e-04  1.17541332e-01  8.83084289e-01]
  HOMO = -0.33228528686625  LUMO = 1.50056116410854e-09
  mo_energy =
[-1.08560690e+02 -1.10662463e+01 -9.13951175e+00 -9.13951030e+00
 -9.13949182e+00 -9.86971278e-01 -3.32287253e-01 -3.32287182e-01
 -3.32285287e-01  1.50056116e-09  4.96813030e+00  4.96813104e+00
  4.96813512e+00  4.81854589e+01  4.81862382e+01  4.81993644e+01
  7.81593636e+01  2.33367403e+02  2.33397715e+02  2.33907801e+02
  6.57052473e+02  6.57175005e+02  6.59247745e+02  1.40179537e+03
  1.40206048e+03  1.40658893e+03  2.74743761e+03  2.74770408e+03
  2.75226990e+03  3.21503106e+03  5.45797375e+03  5.45812204e+03
  5.46064308e+03  1.06855997e+04  1.06856723e+04  1.06868861e+04
  1.84040711e+04  6.89909309e+04]
E1 = -708.9477313303427  E_coul = 205.44449732675767
cycle= 4 E= -503.503234003585  delta_E= -4.02e-05  |g|= 0.049  |ddm|= 2.9e+03
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.6839e-05
diis-c [-1.44812987e-09  1.78134878e-05 -3.90515162e-03 -1.52334419e-02
  1.01912078e+00]
  HOMO = -0.332288908784312  LUMO = 1.50053628218053e-09
  mo_energy =
[-1.08560703e+02 -1.10662450e+01 -9.13952556e+00 -9.13952024e+00
 -9.13951429e+00 -9.86973042e-01 -3.32290120e-01 -3.32289614e-01
 -3.32288909e-01  1.50053628e-09  4.96812595e+00  4.96812647e+00
  4.96813097e+00  4.81769088e+01  4.81812958e+01  4.81824321e+01
  7.81593653e+01  2.33035832e+02  2.33206100e+02  2.33250242e+02
  6.55713658e+02  6.56400103e+02  6.56578585e+02  1.39890653e+03
  1.40038274e+03  1.40076857e+03  2.74454831e+03  2.74602108e+03
  2.74640744e+03  3.21503100e+03  5.45637744e+03  5.45719046e+03
  5.45740402e+03  1.06848292e+04  1.06852213e+04  1.06853244e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9480168033725  E_coul = 205.4447974846591
cycle= 5 E= -503.503219318713  delta_E= 1.47e-05  |g|= 0.0229  |ddm|= 4.44e+03
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000133399
diis-c [-2.69893645e-10  7.55308974e-06 -9.27786016e-04 -8.35565023e-03
  6.52585197e-01  3.56690686e-01]
  HOMO = -0.332289032814756  LUMO = 1.50054012049861e-09
  mo_energy =
[-1.08560689e+02 -1.10662420e+01 -9.13951878e+00 -9.13951471e+00
 -9.13950782e+00 -9.86973470e-01 -3.32290209e-01 -3.32289811e-01
 -3.32289033e-01  1.50054012e-09  4.96812621e+00  4.96812701e+00
  4.96813055e+00  4.81790366e+01  4.81819711e+01  4.81849127e+01
  7.81593766e+01  2.33118042e+02  2.33231959e+02  2.33346167e+02
  6.56044935e+02  6.56504582e+02  6.56966509e+02  1.39961858e+03
  1.40060855e+03  1.40160835e+03  2.74525884e+03  2.74624740e+03
  2.74724936e+03  3.21503101e+03  5.45677019e+03  5.45731589e+03
  5.45786946e+03  1.06850190e+04  1.06852823e+04  1.06855492e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9479491896248  E_coul = 205.44469001105506
cycle= 6 E= -503.50325917857  delta_E= -3.99e-05  |g|= 0.0366  |ddm|=  743
    CPU time for cycle= 6      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.36454e-05
diis-c [-1.36293693e-11  2.45551317e-06 -4.53916964e-04 -2.62455712e-03
  1.51995641e-01 -6.78684911e-01  1.52976529e+00]
  HOMO = -0.332290017165699  LUMO = 1.50054167762897e-09
  mo_energy =
[-1.08560679e+02 -1.10662395e+01 -9.13954359e+00 -9.13952397e+00
 -9.13951274e+00 -9.86973609e-01 -3.32293013e-01 -3.32291022e-01
 -3.32290017e-01  1.50054168e-09  4.96812256e+00  4.96812734e+00
  4.96812736e+00  4.81566680e+01  4.81702583e+01  4.81807433e+01
  7.81593847e+01  2.32251072e+02  2.32777537e+02  2.33184155e+02
  6.52567406e+02  6.54673678e+02  6.56310852e+02  1.39220705e+03
  1.39667239e+03  1.40018690e+03  2.73790127e+03  2.74231825e+03
  2.74582220e+03  3.21503102e+03  5.45269951e+03  5.45514310e+03
  5.45707965e+03  1.06830490e+04  1.06842331e+04  1.06851680e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9482837013705  E_coul = 205.4451037151778
cycle= 7 E= -503.503179986193  delta_E= 7.92e-05  |g|= 0.128  |ddm|= 6.1e+03
    CPU time for cycle= 7      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000208127
diis-c [-7.88918366e-12  7.86370892e-07 -1.90944756e-04 -9.88451755e-04
  4.00011282e-02 -1.00789903e+00  1.89477645e+00  7.43000527e-02]
  HOMO = -0.33229002479523  LUMO = 1.50051963289042e-09
  mo_energy =
[-1.08560674e+02 -1.10662381e+01 -9.13954787e+00 -9.13952538e+00
 -9.13951059e+00 -9.86973669e-01 -3.32293654e-01 -3.32291390e-01
 -3.32290025e-01  1.50051963e-09  4.96812168e+00  4.96812684e+00
  4.96812781e+00  4.81519166e+01  4.81678430e+01  4.81807310e+01
  7.81593893e+01  2.32067086e+02  2.32683800e+02  2.33183561e+02
  6.51834744e+02  6.54297375e+02  6.56308282e+02  1.39066677e+03
  1.39586913e+03  1.40018052e+03  2.73638512e+03  2.74151999e+03
  2.74581498e+03  3.21503103e+03  5.45185996e+03  5.45470149e+03
  5.45707528e+03  1.06826417e+04  1.06840196e+04  1.06851657e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9483410171022  E_coul = 205.44510963425228
cycle= 8 E= -503.50323138285  delta_E= -5.14e-05  |g|= 0.0981  |ddm|= 1.23e+03
    CPU time for cycle= 8      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000224782
diis-c [-7.47574196e-12  8.63919753e-07 -2.03448203e-04 -9.84829947e-04
  4.36902270e-02 -9.11141570e-01  1.90355212e+00 -6.22101965e-01
  5.87188601e-01]
  HOMO = -0.332290811367167  LUMO = 1.50052168433921e-09
  mo_energy =
[-1.08560673e+02 -1.10662379e+01 -9.13955406e+00 -9.13954288e+00
 -9.13951853e+00 -9.86973670e-01 -3.32294280e-01 -3.32293100e-01
 -3.32290811e-01  1.50052168e-09  4.96812070e+00  4.96812436e+00
  4.96812672e+00  4.81469084e+01  4.81537138e+01  4.81741755e+01
  7.81593899e+01  2.31873505e+02  2.32136695e+02  2.32929210e+02
  6.51065778e+02  6.52111362e+02  6.55283158e+02  1.38905719e+03
  1.39124462e+03  1.39797645e+03  2.73480472e+03  2.73695079e+03
  2.74361529e+03  3.21503103e+03  5.45098394e+03  5.45217244e+03
  5.45585947e+03  1.06822156e+04  1.06827936e+04  1.06845786e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9485721098195  E_coul = 205.44533415835718
cycle= 9 E= -503.503237951462  delta_E= -6.57e-06  |g|= 0.103  |ddm|= 3.74e+03
    CPU time for cycle= 9      0.02 sec, wall time      0.03 sec
diis-norm(errvec)=0.000329263
diis-c [-7.19550806e-12  9.89923628e-02 -4.07008358e-05 -3.28758031e-04
  1.88170291e-02 -1.16016006e+00  2.15146182e+00 -7.23632597e-01
  6.14890902e-01]
  HOMO = -0.332290830267593  LUMO = 1.50055880287219e-09
  mo_energy =
[-1.08560668e+02 -1.10662364e+01 -9.13955970e+00 -9.13954840e+00
 -9.13951664e+00 -9.86973711e-01 -3.32295035e-01 -3.32293850e-01
 -3.32290830e-01  1.50055880e-09  4.96811976e+00  4.96812331e+00
  4.96812706e+00  4.81409677e+01  4.81480100e+01  4.81740554e+01
  7.81593944e+01  2.31643767e+02  2.31915938e+02  2.32924414e+02
  6.50156003e+02  6.51233855e+02  6.55263786e+02  1.38716410e+03
  1.38940598e+03  1.39793466e+03  2.73295277e+03  2.73514463e+03
  2.74357332e+03  3.21503103e+03  5.44995757e+03  5.45117208e+03
  5.45583609e+03  1.06817164e+04  1.06823081e+04  1.06845672e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9486701429354  E_coul = 205.44539469899453
cycle= 10 E= -503.503275443941  delta_E= -3.75e-05  |g|= 0.103  |ddm|= 1.91e+03
    CPU time for cycle= 10      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000366984
diis-c [-2.61975424e-12  7.33243481e-01 -1.12186639e+00  4.90209124e-04
 -1.16626762e-02 -7.65269209e-02  9.00816715e-01  3.67259297e-01
  2.08246285e-01]
  HOMO = -0.3322878734765  LUMO = 1.50055653408927e-09
  mo_energy =
[-1.08560695e+02 -1.10662440e+01 -9.13951777e+00 -9.13950278e+00
 -9.13949585e+00 -9.86973582e-01 -3.32289859e-01 -3.32288542e-01
 -3.32287873e-01  1.50055653e-09  4.96812845e+00  4.96812901e+00
  4.96812944e+00  4.81788435e+01  4.81934229e+01  4.81989562e+01
  7.81593717e+01  2.33110896e+02  2.33676964e+02  2.33891962e+02
  6.56015745e+02  6.58307947e+02  6.59183141e+02  1.39955243e+03
  1.40452705e+03  1.40644705e+03  2.74518941e+03  2.75018420e+03
  2.75212611e+03  3.21503101e+03  5.45673122e+03  5.45949047e+03
  5.46056319e+03  1.06850012e+04  1.06863308e+04  1.06868469e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9477246684265  E_coul = 205.44451006028402
cycle= 11 E= -503.503214608143  delta_E= 6.08e-05  |g|= 0.026  |ddm|= 1.56e+04
    CPU time for cycle= 11      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000104922
diis-c [-2.99183380e-12  2.46985684e-01 -5.55964362e-01 -3.46799392e-02
 -5.42205134e-03 -3.00989662e-01  1.24305726e+00  4.17271792e-01
 -1.02587228e-02]
  HOMO = -0.332289232024637  LUMO = 1.50051965157487e-09
  mo_energy =
[-1.08560689e+02 -1.10662424e+01 -9.13951712e+00 -9.13951392e+00
 -9.13950778e+00 -9.86973619e-01 -3.32290140e-01 -3.32289709e-01
 -3.32289232e-01  1.50051965e-09  4.96812628e+00  4.96812778e+00
  4.96812931e+00  4.81805272e+01  4.81805806e+01  4.81877840e+01
  7.81593764e+01  2.33176074e+02  2.33178061e+02  2.33457771e+02
  6.56278645e+02  6.56286771e+02  6.57417931e+02  1.40011861e+03
  1.40013763e+03  1.40258525e+03  2.74575510e+03  2.74577575e+03
  2.74822763e+03  3.21503101e+03  5.45704376e+03  5.45705545e+03
  5.45840918e+03  1.06851520e+04  1.06851569e+04  1.06858095e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.94792210669  E_coul = 205.44470151456994
cycle= 12 E= -503.50322059212  delta_E= -5.98e-06  |g|= 0.0125  |ddm|= 4.33e+03
    CPU time for cycle= 12      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.79612e-05
diis-c [-2.66809678e-12  1.79852754e-01 -3.38054070e-01 -5.07039856e-01
  1.05245627e+00 -2.24013013e-01  9.51876111e-01  5.86877809e-01
 -7.01956008e-01]
  HOMO = -0.332288545597481  LUMO = 1.50053389200825e-09
  mo_energy =
[-1.08560693e+02 -1.10662435e+01 -9.13952498e+00 -9.13950340e+00
 -9.13950298e+00 -9.86973599e-01 -3.32290756e-01 -3.32288636e-01
 -3.32288546e-01  1.50053389e-09  4.96812523e+00  4.96812832e+00
  4.96813106e+00  4.81753578e+01  4.81897002e+01  4.81927853e+01
  7.81593733e+01  2.32975497e+02  2.33532240e+02  2.33652035e+02
  6.55469970e+02  6.57719988e+02  6.58206700e+02  1.39837952e+03
  1.40324230e+03  1.40430587e+03  2.74401998e+03  2.74888872e+03
  2.74996111e+03  3.21503101e+03  5.45608506e+03  5.45877559e+03
  5.45936701e+03  1.06846886e+04  1.06859880e+04  1.06862710e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.947844648614  E_coul = 205.44461866195718
cycle= 13 E= -503.503225986657  delta_E= -5.39e-06  |g|= 0.0369  |ddm|= 2.63e+03
    CPU time for cycle= 13      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=5.93848e-05
diis-c [-2.22277260e-12 -3.89804036e-01 -3.39069560e-01 -4.94375677e-01
  1.44721057e+00 -5.16663118e-01  5.62673006e-01  1.25540540e+00
 -5.25376578e-01]
  HOMO = -0.332285934773763  LUMO = 1.50054631647516e-09
  mo_energy =
[-1.08560695e+02 -1.10662440e+01 -9.13950643e+00 -9.13950221e+00
 -9.13947690e+00 -9.86973594e-01 -3.32288911e-01 -3.32288493e-01
 -3.32285935e-01  1.50054632e-09  4.96812776e+00  4.96812864e+00
  4.96813481e+00  4.81905873e+01  4.81937300e+01  4.82111881e+01
  7.81593718e+01  2.33566671e+02  2.33688801e+02  2.34367807e+02
  6.57860206e+02  6.58356148e+02  6.61129137e+02  1.40355018e+03
  1.40463370e+03  1.41075256e+03  2.74920002e+03  2.75029411e+03
  2.75650404e+03  3.21503101e+03  5.45894657e+03  5.45955279e+03
  5.46298002e+03  1.06860681e+04  1.06863619e+04  1.06880093e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9475005215246  E_coul = 205.4442661820259
cycle= 14 E= -503.503234339499  delta_E= -8.35e-06  |g|= 0.0895  |ddm|= 6.35e+03
    CPU time for cycle= 14      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000143964
diis-c [-4.15814389e-13  2.20366220e-01 -9.28021712e-02 -2.01426589e-01
  8.27355979e-01 -4.46456543e-01  5.99521694e-01  7.09858899e-01
 -6.16417489e-01]
  HOMO = -0.332287381278627  LUMO = 1.50052517386676e-09
  mo_energy =
[-1.08560691e+02 -1.10662429e+01 -9.13951604e+00 -9.13950468e+00
 -9.13949040e+00 -9.86973604e-01 -3.32289965e-01 -3.32288873e-01
 -3.32287381e-01  1.50052517e-09  4.96812662e+00  4.96812813e+00
  4.96813266e+00  4.81816941e+01  4.81907219e+01  4.81996046e+01
  7.81593751e+01  2.33221125e+02  2.33571708e+02  2.33917045e+02
  6.56461043e+02  6.57880759e+02  6.59285390e+02  1.40051602e+03
  1.40359630e+03  1.40667091e+03  2.74615618e+03  2.74924770e+03
  2.75235206e+03  3.21503101e+03  5.45726612e+03  5.45897352e+03
  5.46068810e+03  1.06852586e+04  1.06860814e+04  1.06869077e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9477115890667  E_coul = 205.44445764749932
cycle= 15 E= -503.503253941567  delta_E= -1.96e-05  |g|= 0.068  |ddm|= 3.74e+03
    CPU time for cycle= 15      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=5.97082e-05
diis-c [-2.73505790e-13  7.08290668e-01 -4.58060974e-01  3.85169747e-01
 -2.68828249e-01 -8.61028840e-01  2.98768450e-01  8.95550108e-01
  3.00139090e-01]
  HOMO = -0.332289412229558  LUMO = 1.50053569076611e-09
  mo_energy =
[-1.08560685e+02 -1.10662413e+01 -9.13952625e+00 -9.13951291e+00
 -9.13950916e+00 -9.86973632e-01 -3.32291157e-01 -3.32289859e-01
 -3.32289412e-01  1.50053569e-09  4.96812507e+00  4.96812719e+00
  4.96812955e+00  4.81720522e+01  4.81823573e+01  4.81835513e+01
  7.81593798e+01  2.32846966e+02  2.33246796e+02  2.33293306e+02
  6.54953070e+02  6.56564810e+02  6.56752449e+02  1.39727320e+03
  1.40073992e+03  1.40114326e+03  2.74291856e+03  2.74637969e+03
  2.74678178e+03  3.21503102e+03  5.45547490e+03  5.45738943e+03
  5.45761087e+03  1.06843916e+04  1.06853181e+04  1.06854246e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9480159708773  E_coul = 205.4447540983112
cycle= 16 E= -503.503261872566  delta_E= -7.93e-06  |g|= 0.0807  |ddm|= 4.62e+03
    CPU time for cycle= 16      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=8.62986e-05
diis-c [-1.65133775e-13  5.27741214e-01 -2.97160428e-01  1.77323719e-01
  2.50363696e-02 -5.41906233e-01  3.45026355e-01  4.77565782e-01
  2.86373220e-01]
  HOMO = -0.332289795767009  LUMO = 1.50052720656493e-09
  mo_energy =
[-1.08560688e+02 -1.10662420e+01 -9.13952085e+00 -9.13951981e+00
 -9.13951315e+00 -9.86973620e-01 -3.32290546e-01 -3.32290343e-01
 -3.32289796e-01  1.50052721e-09  4.96812587e+00  4.96812708e+00
  4.96812818e+00  4.81756505e+01  4.81770226e+01  4.81829479e+01
  7.81593778e+01  2.32986783e+02  2.33039832e+02  2.33269784e+02
  6.55515413e+02  6.55729323e+02  6.56657651e+02  1.39847617e+03
  1.39893797e+03  1.40094013e+03  2.74411498e+03  2.74457769e+03
  2.74657985e+03  3.21503101e+03  5.45613654e+03  5.45639261e+03
  5.45749981e+03  1.06847126e+04  1.06848356e+04  1.06853711e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9480406699315  E_coul = 205.44477440325863
cycle= 17 E= -503.503266266673  delta_E= -4.39e-06  |g|= 0.0288  |ddm|= 2.12e+03
    CPU time for cycle= 17      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000108473
diis-c [-2.93164033e-13  3.46676416e-01  4.62376290e-04 -8.00395162e-02
  3.43053204e-01 -4.57325293e-01  3.93047730e-01  2.02991883e-01
  2.51133199e-01]
  HOMO = -0.332290229333056  LUMO = 1.50055323109764e-09
  mo_energy =
[-1.08560688e+02 -1.10662421e+01 -9.13952722e+00 -9.13952198e+00
 -9.13951775e+00 -9.86973618e-01 -3.32291146e-01 -3.32290539e-01
 -3.32290229e-01  1.50055323e-09  4.96812499e+00  4.96812638e+00
  4.96812789e+00  4.81720267e+01  4.81740040e+01  4.81794266e+01
  7.81593775e+01  2.32846120e+02  2.32922916e+02  2.33133124e+02
  6.54949869e+02  6.55258332e+02  6.56105725e+02  1.39726691e+03
  1.39792455e+03  1.39974849e+03  2.74291322e+03  2.74356523e+03
  2.74538718e+03  3.21503101e+03  5.45547288e+03  5.45583250e+03
  5.45684029e+03  1.06843916e+04  1.06845654e+04  1.06850524e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.948133584522  E_coul = 205.44486956886956
cycle= 18 E= -503.503264015652  delta_E= 2.25e-06  |g|= 0.0184  |ddm|= 1.43e+03
    CPU time for cycle= 18      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000148003
diis-c [-1.70043586e-13 -1.71345113e-01  4.83294050e-01  3.75233587e-02
  2.18500386e-01 -3.85426816e-01  4.06780133e-01  2.32288293e-01
  1.78385708e-01]
  HOMO = -0.332289759238407  LUMO = 1.50056405736861e-09
  mo_energy =
[-1.08560690e+02 -1.10662425e+01 -9.13952506e+00 -9.13952473e+00
 -9.13951449e+00 -9.86973609e-01 -3.32290884e-01 -3.32290852e-01
 -3.32289759e-01  1.50056406e-09  4.96812532e+00  4.96812534e+00
  4.96812907e+00  4.81741322e+01  4.81743596e+01  4.81802683e+01
  7.81593763e+01  2.32927873e+02  2.32936598e+02  2.33165980e+02
  6.55278532e+02  6.55313705e+02  6.56238047e+02  1.39797026e+03
  1.39804565e+03  1.40003183e+03  2.74361303e+03  2.74368768e+03
  2.74566887e+03  3.21503101e+03  5.45585968e+03  5.45590084e+03
  5.45699541e+03  1.06845786e+04  1.06845987e+04  1.06851271e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9481055746976  E_coul = 205.44490721154295
cycle= 19 E= -503.503198363155  delta_E= 6.57e-05  |g|= 0.0647  |ddm|= 1.89e+03
    CPU time for cycle= 19      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000132931
diis-c [-1.57135122e-13 -3.23778229e-02  2.97139086e-01  1.18256581e-01
  2.74375052e-01 -3.65429900e-01  3.50057898e-01  3.14081475e-01
  4.38976320e-02]
  HOMO = -0.332289311184894  LUMO = 1.50051162766694e-09
  mo_energy =
[-1.08560690e+02 -1.10662425e+01 -9.13952697e+00 -9.13952057e+00
 -9.13950996e+00 -9.86973608e-01 -3.32291058e-01 -3.32290442e-01
 -3.32289311e-01  1.50051163e-09  4.96812506e+00  4.96812590e+00
  4.96812975e+00  4.81726988e+01  4.81777554e+01  4.81839047e+01
  7.81593760e+01  2.32872258e+02  2.33068321e+02  2.33307109e+02
  6.55054864e+02  6.55844334e+02  6.56808319e+02  1.39749130e+03
  1.39918562e+03  1.40126433e+03  2.74313626e+03  2.74482491e+03
  2.74690324e+03  3.21503101e+03  5.45559612e+03  5.45652962e+03
  5.45767783e+03  1.06844512e+04  1.06849025e+04  1.06854567e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9480548472071  E_coul = 205.4448589312426
cycle= 20 E= -503.503195915965  delta_E= 2.45e-06  |g|= 0.057  |ddm|= 1.17e+03
    CPU time for cycle= 20      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000110476
diis-c [-2.63691519e-13  2.82648709e-01  2.14583034e-01  2.09657239e-01
 -9.87858813e-02 -2.49313821e-01  3.72879817e-01  3.09681185e-01
 -4.13502819e-02]
  HOMO = -0.332289746659437  LUMO = 1.50052324076931e-09
  mo_energy =
[-1.08560690e+02 -1.10662427e+01 -9.13953166e+00 -9.13951949e+00
 -9.13951464e+00 -9.86973605e-01 -3.32291493e-01 -3.32290322e-01
 -3.32289747e-01  1.50052324e-09  4.96812442e+00  4.96812605e+00
  4.96812908e+00  4.81690652e+01  4.81787572e+01  4.81803136e+01
  7.81593757e+01  2.32731338e+02  2.33107230e+02  2.33167728e+02
  6.54488978e+02  6.56001163e+02  6.56245132e+02  1.39628304e+03
  1.39952293e+03  1.40004739e+03  2.74193573e+03  2.74516158e+03
  2.74568487e+03  3.21503101e+03  5.45493249e+03  5.45671565e+03
  5.45700465e+03  1.06841305e+04  1.06849924e+04  1.06851319e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9481120506584  E_coul = 205.44486193873837
cycle= 21 E= -503.50325011192  delta_E= -5.42e-05  |g|= 0.0321  |ddm|= 1.18e+03
    CPU time for cycle= 21      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000140855
diis-c [-1.91282388e-13 -1.59269432e-01  5.43802994e-01  7.95375147e-01
 -2.30603317e-01 -8.60247478e-01  1.82978783e-01  4.39217190e-01
  2.88746114e-01]
  HOMO = -0.33228888636489  LUMO = 1.50052850786221e-09
  mo_energy =
[-1.08560689e+02 -1.10662422e+01 -9.13952205e+00 -9.13951457e+00
 -9.13950507e+00 -9.86973614e-01 -3.32290626e-01 -3.32289909e-01
 -3.32288886e-01  1.50052851e-09  4.96812572e+00  4.96812680e+00
  4.96813040e+00  4.81761808e+01  4.81822237e+01  4.81874839e+01
  7.81593771e+01  2.33007221e+02  2.33241713e+02  2.33446112e+02
  6.55598202e+02  6.56544136e+02  6.57371031e+02  1.39865673e+03
  1.40069490e+03  1.40248477e+03  2.74429728e+03  2.74633497e+03
  2.74812795e+03  3.21503101e+03  5.45623819e+03  5.45736517e+03
  5.45835430e+03  1.06847621e+04  1.06853068e+04  1.06857827e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9479480236395  E_coul = 205.4447158196546
cycle= 22 E= -503.503232203985  delta_E= 1.79e-05  |g|= 0.0374  |ddm|= 3.44e+03
    CPU time for cycle= 22      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=5.92849e-05
diis-c [-1.35726897e-13 -1.74201340e-01  5.43992430e-01  4.78624039e-01
 -8.80350166e-02 -8.94657404e-01  2.83677638e-01  5.83724886e-01
  2.66874767e-01]
  HOMO = -0.332288723314903  LUMO = 1.50053504544698e-09
  mo_energy =
[-1.08560688e+02 -1.10662420e+01 -9.13952236e+00 -9.13952092e+00
 -9.13950302e+00 -9.86973619e-01 -3.32290693e-01 -3.32290549e-01
 -3.32288723e-01  1.50053505e-09  4.96812566e+00  4.96812591e+00
  4.96813065e+00  4.81758152e+01  4.81767982e+01  4.81888981e+01
  7.81593778e+01  2.32993065e+02  2.33031163e+02  2.33501026e+02
  6.55541016e+02  6.55694673e+02  6.57593555e+02  1.39853374e+03
  1.39886410e+03  1.40296830e+03  2.74417519e+03  2.74450424e+03
  2.74861373e+03  3.21503101e+03  5.45617134e+03  5.45635252e+03
  5.45862257e+03  1.06847302e+04  1.06848171e+04  1.06859120e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9479866884725  E_coul = 205.44475695461148
cycle= 23 E= -503.503229733861  delta_E= 2.47e-06  |g|= 0.0549  |ddm|= 1.49e+03
    CPU time for cycle= 23      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=7.4561e-05
diis-c [-6.04386340e-13  1.47541683e-01  5.74825154e-01 -6.07264822e-01
  3.39869134e-01 -1.49772862e+00  2.56751161e-01  7.84246097e-01
  1.00176021e+00]
  HOMO = -0.332290145199056  LUMO = 1.50053628921455e-09
  mo_energy =
[-1.08560682e+02 -1.10662403e+01 -9.13953326e+00 -9.13951731e+00
 -9.13951529e+00 -9.86973652e-01 -3.32291972e-01 -3.32290410e-01
 -3.32290145e-01  1.50053629e-09  4.96812394e+00  4.96812666e+00
  4.96812847e+00  4.81655499e+01  4.81776572e+01  4.81777909e+01
  7.81593829e+01  2.32595094e+02  2.33064272e+02  2.33069699e+02
  6.53942773e+02  6.55828403e+02  6.55849158e+02  1.39511972e+03
  1.39915293e+03  1.39919185e+03  2.74078156e+03  2.74479335e+03
  2.74482740e+03  3.21503102e+03  5.45429461e+03  5.45651221e+03
  5.45652910e+03  1.06838226e+04  1.06848938e+04  1.06849010e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9481651027487  E_coul = 205.44491777623767
cycle= 24 E= -503.503247326511  delta_E= -1.76e-05  |g|= 0.0459  |ddm|= 3.43e+03
    CPU time for cycle= 24      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000146305
diis-c [-1.20606813e-12  6.26589259e-01 -4.91827275e-02 -1.44706589e+00
  8.79157207e-01 -5.69814832e-01  7.42391471e-01  5.53848045e-01
  2.64077472e-01]
  HOMO = -0.332289011060022  LUMO = 1.50056385433816e-09
  mo_energy =
[-1.08560684e+02 -1.10662410e+01 -9.13955598e+00 -9.13950683e+00
 -9.13950381e+00 -9.86973636e-01 -3.32294059e-01 -3.32289216e-01
 -3.32289011e-01  1.50056385e-09  4.96812070e+00  4.96812851e+00
  4.96812991e+00  4.81482517e+01  4.81851028e+01  4.81893166e+01
  7.81593805e+01  2.31925514e+02  2.33353491e+02  2.33516998e+02
  6.51273365e+02  6.56995516e+02  6.57658910e+02  1.38949691e+03
  1.40166803e+03  1.40311410e+03  2.73524069e+03  2.74730644e+03
  2.74876303e+03  3.21503102e+03  5.45122735e+03  5.45789980e+03
  5.45870517e+03  1.06823346e+04  1.06855631e+04  1.06859508e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9481513648714  E_coul = 205.44485873554015
cycle= 25 E= -503.503292629331  delta_E= -4.53e-05  |g|= 0.0404  |ddm|= 5.04e+03
    CPU time for cycle= 25      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000191765
diis-c [-1.11736811e-12  5.79491901e-01  9.37245217e-01 -5.40952288e-01
  2.96128505e-01 -1.69199249e+00  1.87136554e+00 -2.03384893e-01
 -2.47901496e-01]
  HOMO = -0.332288561715891  LUMO = 1.50051213709573e-09
  mo_energy =
[-1.08560685e+02 -1.10662411e+01 -9.13955806e+00 -9.13951781e+00
 -9.13950008e+00 -9.86973634e-01 -3.32294260e-01 -3.32290360e-01
 -3.32288562e-01  1.50051214e-09  4.96812038e+00  4.96812646e+00
  4.96813097e+00  4.81466285e+01  4.81782377e+01  4.81904494e+01
  7.81593805e+01  2.31862846e+02  2.33087006e+02  2.33561457e+02
  6.51024403e+02  6.55919872e+02  6.57838240e+02  1.38897584e+03
  1.39934915e+03  1.40349845e+03  2.73472919e+03  2.74498872e+03
  2.74914502e+03  3.21503102e+03  5.45094409e+03  5.45661971e+03
  5.45891518e+03  1.06821974e+04  1.06849449e+04  1.06860525e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9482184176932  E_coul = 205.44500223684489
cycle= 26 E= -503.503216180848  delta_E= 7.64e-05  |g|= 0.0751  |ddm|= 2.79e+03
    CPU time for cycle= 26      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000212278
diis-c [-1.36309194e-12  5.97110808e-01 -4.76547281e-01 -5.98097041e-01
  8.49493104e-01 -9.83040274e-01  1.10882961e+00  2.07411722e-01
  2.94839354e-01]
  HOMO = -0.332288453327618  LUMO = 1.50052276986608e-09
  mo_energy =
[-1.08560685e+02 -1.10662411e+01 -9.13954602e+00 -9.13951223e+00
 -9.13949894e+00 -9.86973635e-01 -3.32293097e-01 -3.32289822e-01
 -3.32288453e-01  1.50052277e-09  4.96812213e+00  4.96812729e+00
  4.96813108e+00  4.81561801e+01  4.81826574e+01  4.81913679e+01
  7.81593805e+01  2.32232258e+02  2.33258470e+02  2.33596939e+02
  6.52493060e+02  6.56611971e+02  6.57982365e+02  1.39205424e+03
  1.40084176e+03  1.40381379e+03  2.73775341e+03  2.74648134e+03
  2.74946349e+03  3.21503102e+03  5.45261788e+03  5.45744414e+03
  5.45909082e+03  1.06830084e+04  1.06853422e+04  1.06861361e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9480839221233  E_coul = 205.44486921321362
cycle= 27 E= -503.50321470891  delta_E= 1.47e-06  |g|= 0.0618  |ddm|= 2.43e+03
    CPU time for cycle= 27      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000145818
diis-c [-2.18415439e-13  3.43803982e-01 -8.60116546e-01  9.11897379e-01
  3.68275348e-01 -7.76598276e-01  9.66247257e-01 -7.69214515e-02
  1.23412308e-01]
  HOMO = -0.332288589713672  LUMO = 1.50055699591825e-09
  mo_energy =
[-1.08560685e+02 -1.10662412e+01 -9.13952034e+00 -9.13951299e+00
 -9.13950061e+00 -9.86973631e-01 -3.32290594e-01 -3.32289872e-01
 -3.32288590e-01  1.50055700e-09  4.96812586e+00  4.96812716e+00
  4.96813087e+00  4.81767649e+01  4.81822726e+01  4.81902202e+01
  7.81593799e+01  2.33029843e+02  2.33243561e+02  2.33552331e+02
  6.55689309e+02  6.56551742e+02  6.57801897e+02  1.39885369e+03
  1.40071171e+03  1.40342326e+03  2.74449496e+03  2.74635157e+03
  2.74907231e+03  3.21503102e+03  5.45634735e+03  5.45737346e+03
  5.45887528e+03  1.06848137e+04  1.06853095e+04  1.06860324e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.947912851287  E_coul = 205.444676866198
cycle= 28 E= -503.503235985089  delta_E= -2.13e-05  |g|= 0.0221  |ddm|= 4.7e+03
    CPU time for cycle= 28      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=3.72205e-05
diis-c [-2.24378909e-13  2.54919913e-01 -7.37249740e-01  7.11069541e-01
  2.92249588e-01 -4.38765636e-01  6.50798963e-01  1.47846761e-01
  1.19130610e-01]
  HOMO = -0.332288887328388  LUMO = 1.50054848985349e-09
  mo_energy =
[-1.08560685e+02 -1.10662412e+01 -9.13952612e+00 -9.13951846e+00
 -9.13950358e+00 -9.86973634e-01 -3.32291162e-01 -3.32290409e-01
 -3.32288887e-01  1.50054849e-09  4.96812504e+00  4.96812639e+00
  4.96813041e+00  4.81721042e+01  4.81778514e+01  4.81878119e+01
  7.81593802e+01  2.32849123e+02  2.33071973e+02  2.33458699e+02
  6.54961943e+02  6.55859005e+02  6.57422182e+02  1.39729331e+03
  1.39921705e+03  1.40259693e+03  2.74293979e+03  2.74485642e+03
  2.74824132e+03  3.21503102e+03  5.45548740e+03  5.45654707e+03
  5.45841664e+03  1.06843982e+04  1.06849109e+04  1.06858120e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9480172501295  E_coul = 205.4447834144007
cycle= 29 E= -503.503233835729  delta_E= 2.15e-06  |g|= 0.0207  |ddm|= 1.55e+03
    CPU time for cycle= 29      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=8.43773e-05
diis-c [-2.88299018e-13  1.79223787e-01 -6.89399073e-01  6.73049182e-01
  3.71006658e-01  1.11105609e-01  4.45093434e-01  1.83565184e-01
 -2.73644781e-01]
  HOMO = -0.332288682939185  LUMO = 1.500543876541e-09
  mo_energy =
[-1.08560688e+02 -1.10662420e+01 -9.13952637e+00 -9.13952023e+00
 -9.13950270e+00 -9.86973618e-01 -3.32291071e-01 -3.32290474e-01
 -3.32288683e-01  1.50054388e-09  4.96812509e+00  4.96812602e+00
  4.96813070e+00  4.81727024e+01  4.81774513e+01  4.81892266e+01
  7.81593776e+01  2.32872388e+02  2.33056533e+02  2.33513668e+02
  6.55055463e+02  6.55796690e+02  6.57645192e+02  1.39749328e+03
  1.39908275e+03  1.40308283e+03  2.74313863e+03  2.74472236e+03
  2.74873078e+03  3.21503101e+03  5.45559716e+03  5.45647325e+03
  5.45868760e+03  1.06844511e+04  1.06848756e+04  1.06859431e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9480065817789  E_coul = 205.44477331119228
cycle= 30 E= -503.503233270587  delta_E= 5.65e-07  |g|= 0.0458  |ddm|=  360
    CPU time for cycle= 30      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=8.66415e-05
diis-c [-3.15555044e-13  1.91577495e-01 -7.62652229e-01  5.71748325e-01
  3.96992386e-01  8.06314950e-02  2.07877241e-01  5.51505490e-01
 -2.37680203e-01]
  HOMO = -0.332288315575852  LUMO = 1.50051610672196e-09
  mo_energy =
[-1.08560688e+02 -1.10662420e+01 -9.13952935e+00 -9.13952420e+00
 -9.13949889e+00 -9.86973618e-01 -3.32291356e-01 -3.32290856e-01
 -3.32288316e-01  1.50051611e-09  4.96812468e+00  4.96812545e+00
  4.96813123e+00  4.81703402e+01  4.81743012e+01  4.81922434e+01
  7.81593776e+01  2.32780806e+02  2.32934288e+02  2.33630771e+02
  6.54687487e+02  6.55304483e+02  6.58120525e+02  1.39670645e+03
  1.39802646e+03  1.40411944e+03  2.74235599e+03  2.74366944e+03
  2.74977497e+03  3.21503101e+03  5.45516427e+03  5.45589134e+03
  5.45926453e+03  1.06842416e+04  1.06845947e+04  1.06862212e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9480288863119  E_coul = 205.44482538286735
cycle= 31 E= -503.503203503445  delta_E= 2.98e-05  |g|= 0.0479  |ddm|= 1.12e+03
    CPU time for cycle= 31      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00010307
diis-c [-3.71284796e-13  2.59525539e-01 -1.07624471e+00  6.88178813e-01
  6.78563445e-01 -1.05714010e-01 -4.65297341e-01  9.20713543e-01
  1.00274722e-01]
  HOMO = -0.332288557702661  LUMO = 1.50055070767705e-09
  mo_energy =
[-1.08560686e+02 -1.10662415e+01 -9.13952114e+00 -9.13951672e+00
 -9.13950064e+00 -9.86973627e-01 -3.32290625e-01 -3.32290208e-01
 -3.32288558e-01  1.50055071e-09  4.96812598e+00  4.96812645e+00
  4.96813087e+00  4.81761239e+01  4.81798517e+01  4.81904639e+01
  7.81593791e+01  2.33004966e+02  2.33149597e+02  2.33561684e+02
  6.55588837e+02  6.56172409e+02  6.57840016e+02  1.39863585e+03
  1.39989457e+03  1.40350718e+03  2.74427598e+03  2.74553498e+03
  2.74915778e+03  3.21503102e+03  5.45622565e+03  5.45692166e+03
  5.45892321e+03  1.06847549e+04  1.06850904e+04  1.06860563e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9479398865166  E_coul = 205.44472037054038
cycle= 32 E= -503.503219515976  delta_E= -1.6e-05  |g|= 0.06  |ddm|= 2.23e+03
    CPU time for cycle= 32      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=5.23599e-05
diis-c [-3.13269814e-13  4.27388776e-01 -9.22281213e-01  4.32873278e-01
  5.31206443e-01 -9.28682956e-02 -5.84266786e-01  7.37475529e-01
  4.70472270e-01]
  HOMO = -0.332289385139896  LUMO = 1.50047772208958e-09
  mo_energy =
[-1.08560686e+02 -1.10662415e+01 -9.13952103e+00 -9.13951662e+00
 -9.13950920e+00 -9.86973628e-01 -3.32290615e-01 -3.32290199e-01
 -3.32289385e-01  1.50047772e-09  4.96812599e+00  4.96812646e+00
  4.96812963e+00  4.81761946e+01  4.81799154e+01  4.81836800e+01
  7.81593792e+01  2.33007718e+02  2.33152087e+02  2.33298275e+02
  6.55599959e+02  6.56182449e+02  6.56772888e+02  1.39865993e+03
  1.39991590e+03  1.40118896e+03  2.74430007e+03  2.74555613e+03
  2.74682864e+03  3.21503102e+03  5.45623881e+03  5.45693327e+03
  5.45763637e+03  1.06847610e+04  1.06850958e+04  1.06854358e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9480006669943  E_coul = 205.4447209999907
cycle= 33 E= -503.503279667004  delta_E= -6.02e-05  |g|= 0.0757  |ddm|= 1.53e+03
    CPU time for cycle= 33      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=7.69052e-05
diis-c [-6.10499878e-13 -9.23880757e-02 -8.38650037e-01  7.32386013e-01
  6.34200040e-01  6.53981988e-01 -1.67879782e-01  2.05094401e-01
 -1.26744547e-01]
  HOMO = -0.332287992576857  LUMO = 1.50055186910897e-09
  mo_energy =
[-1.08560685e+02 -1.10662412e+01 -9.13952886e+00 -9.13951206e+00
 -9.13949432e+00 -9.86973634e-01 -3.32291409e-01 -3.32289803e-01
 -3.32287993e-01  1.50055187e-09  4.96812490e+00  4.96812707e+00
  4.96813174e+00  4.81696330e+01  4.81832757e+01  4.81951754e+01
  7.81593801e+01  2.32753313e+02  2.33282539e+02  2.33744781e+02
  6.54576922e+02  6.56709249e+02  6.58583958e+02  1.39646901e+03
  1.40105304e+03  1.40513223e+03  2.74211887e+03  2.74669418e+03
  2.75079621e+03  3.21503102e+03  5.45503326e+03  5.45756279e+03
  5.45982811e+03  1.06841793e+04  1.06854006e+04  1.06864922e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.947922772315  E_coul = 205.44470135761236
cycle= 34 E= -503.503221414703  delta_E= 5.83e-05  |g|= 0.0129  |ddm|= 3.07e+03
    CPU time for cycle= 34      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=7.07146e-05
diis-c [-1.22540003e-12 -1.46695673e-01 -3.44103671e-01 -1.67358673e-01
  1.19254422e+00  2.74601287e-01 -9.59563406e-01  1.36640400e-01
  1.01393552e+00]
  HOMO = -0.332289186912413  LUMO = 1.50053563278783e-09
  mo_energy =
[-1.08560684e+02 -1.10662410e+01 -9.13951425e+00 -9.13950731e+00
 -9.13950533e+00 -9.86973641e-01 -3.32290031e-01 -3.32289280e-01
 -3.32289187e-01  1.50053563e-09  4.96812702e+00  4.96812800e+00
  4.96812981e+00  4.81809393e+01  4.81847253e+01  4.81883785e+01
  7.81593808e+01  2.33191756e+02  2.33338934e+02  2.33480689e+02
  6.56342170e+02  6.56937027e+02  6.57511674e+02  1.40025740e+03
  1.40154194e+03  1.40279392e+03  2.74589529e+03  2.74718065e+03
  2.74844174e+03  3.21503102e+03  5.45712062e+03  5.45783072e+03
  5.45852830e+03  1.06851874e+04  1.06855302e+04  1.06858660e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9478679371114  E_coul = 205.44455062878703
cycle= 35 E= -503.503317308324  delta_E= -9.59e-05  |g|= 0.107  |ddm|= 3.66e+03
    CPU time for cycle= 35      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=3.71304e-05
diis-c [-2.90532052e-13 -5.75208430e-01 -4.05147703e-01  7.95778548e-01
  5.75914441e-01 -1.29003705e-01 -7.26490869e-01  7.45307658e-01
  7.18850058e-01]
  HOMO = -0.332290147731959  LUMO = 1.50054279409075e-09
  mo_energy =
[-1.08560685e+02 -1.10662411e+01 -9.13952078e+00 -9.13951690e+00
 -9.13951656e+00 -9.86973635e-01 -3.32290640e-01 -3.32290279e-01
 -3.32290148e-01  1.50054279e-09  4.96812606e+00  4.96812637e+00
  4.96812851e+00  4.81759370e+01  4.81774988e+01  4.81793482e+01
  7.81593803e+01  2.32997641e+02  2.33058446e+02  2.33130109e+02
  6.55559379e+02  6.55804389e+02  6.56093712e+02  1.39857240e+03
  1.39909803e+03  1.39972351e+03  2.74421216e+03  2.74473611e+03
  2.74536318e+03  3.21503102e+03  5.45619008e+03  5.45648007e+03
  5.45682717e+03  1.06847378e+04  1.06848784e+04  1.06850458e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9480626403923  E_coul = 205.4448069840997
cycle= 36 E= -503.503255656293  delta_E= 6.17e-05  |g|= 0.0242  |ddm|= 2.84e+03
    CPU time for cycle= 36      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000105527
diis-c [-6.86482161e-13 -1.17245727e+00 -4.60637226e-01  1.09659927e+00
  1.03565683e-02  2.65200659e-01 -2.43862955e-01  4.97596975e-01
  1.00720398e+00]
  HOMO = -0.332289477861618  LUMO = 1.50055880074172e-09
  mo_energy =
[-1.08560685e+02 -1.10662411e+01 -9.13953245e+00 -9.13951402e+00
 -9.13950855e+00 -9.86973634e-01 -3.32291769e-01 -3.32289905e-01
 -3.32289478e-01  1.50055880e-09  4.96812438e+00  4.96812757e+00
  4.96812887e+00  4.81666361e+01  4.81794796e+01  4.81859436e+01
  7.81593804e+01  2.32637088e+02  2.33135330e+02  2.33386156e+02
  6.54110940e+02  6.56114607e+02  6.57128447e+02  1.39547678e+03
  1.39976670e+03  1.40195991e+03  2.74113409e+03  2.74540469e+03
  2.74760293e+03  3.21503102e+03  5.45448794e+03  5.45684989e+03
  5.45806519e+03  1.06839147e+04  1.06850572e+04  1.06856436e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9480685598431  E_coul = 205.44483518470625
cycle= 37 E= -503.503233375137  delta_E= 2.23e-05  |g|= 0.067  |ddm|= 2.62e+03
    CPU time for cycle= 37      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000122266
diis-c [-7.06729761e-13 -1.26670470e+00 -4.97882772e-01  1.15039398e+00
  8.11694247e-02 -1.32541903e-02 -1.44054911e-01  6.42426056e-01
  1.04790711e+00]
  HOMO = -0.332289201035716  LUMO = 1.50052940238089e-09
  mo_energy =
[-1.08560685e+02 -1.10662413e+01 -9.13953197e+00 -9.13951530e+00
 -9.13950592e+00 -9.86973631e-01 -3.32291701e-01 -3.32290005e-01
 -3.32289201e-01  1.50052940e-09  4.96812443e+00  4.96812797e+00
  4.96812872e+00  4.81672185e+01  4.81786055e+01  4.81881870e+01
  7.81593799e+01  2.32659651e+02  2.33101408e+02  2.33473267e+02
  6.54201394e+02  6.55977780e+02  6.57481384e+02  1.39566940e+03
  1.39947209e+03  1.40272665e+03  2.74132520e+03  2.74511037e+03
  2.74837329e+03  3.21503102e+03  5.45459372e+03  5.45668729e+03
  5.45849085e+03  1.06839660e+04  1.06849787e+04  1.06858488e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.948051529812  E_coul = 205.44483533681736
cycle= 38 E= -503.503216192995  delta_E= 1.72e-05  |g|= 0.0675  |ddm|=  558
    CPU time for cycle= 38      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000120461
diis-c [-7.01051883e-13 -1.30778072e+00 -5.67350622e-01  1.18132255e+00
 -5.50420033e-02 -6.05407355e-02  1.43813377e-01  6.28950780e-01
  1.03662738e+00]
  HOMO = -0.332289212092617  LUMO = 1.50054273527689e-09
  mo_energy =
[-1.08560686e+02 -1.10662414e+01 -9.13953322e+00 -9.13951124e+00
 -9.13950618e+00 -9.86973629e-01 -3.32291808e-01 -3.32289598e-01
 -3.32289212e-01  1.50054274e-09  4.96812423e+00  4.96812794e+00
  4.96812933e+00  4.81663520e+01  4.81819140e+01  4.81880780e+01
  7.81593796e+01  2.32626060e+02  2.33229786e+02  2.33469045e+02
  6.54066835e+02  6.56496006e+02  6.57464240e+02  1.39538349e+03
  1.40059000e+03  1.40268922e+03  2.74104200e+03  2.74622855e+03
  2.74833559e+03  3.21503102e+03  5.45443725e+03  5.45730549e+03
  5.45847006e+03  1.06838905e+04  1.06852774e+04  1.06858389e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9480306917494  E_coul = 205.4448014841778
cycle= 39 E= -503.503229207572  delta_E= -1.3e-05  |g|= 0.0448  |ddm|=  774
    CPU time for cycle= 39      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000112891
diis-c [-1.09218131e-12 -1.15133327e+00  1.53141431e-02  7.98631664e-01
  6.41162142e-01  2.10586785e-01 -4.27100381e-01 -2.11025233e-01
  1.12376415e+00]
  HOMO = -0.332288173102326  LUMO = 1.50052698385528e-09
  mo_energy =
[-1.08560684e+02 -1.10662409e+01 -9.13953574e+00 -9.13952901e+00
 -9.13949472e+00 -9.86973639e-01 -3.32292112e-01 -3.32291381e-01
 -3.32288173e-01  1.50052698e-09  4.96812394e+00  4.96812667e+00
  4.96812954e+00  4.81637792e+01  4.81674073e+01  4.81967112e+01
  7.81593811e+01  2.32526438e+02  2.32667149e+02  2.33804464e+02
  6.53667599e+02  6.54231569e+02  6.58826853e+02  1.39453379e+03
  1.39573317e+03  1.40566520e+03  2.74019929e+03  2.74138800e+03
  2.75133619e+03  3.21503102e+03  5.45397078e+03  5.45462835e+03
  5.46012767e+03  1.06836645e+04  1.06839827e+04  1.06866375e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9481042453685  E_coul = 205.44486031901613
cycle= 40 E= -503.503243926352  delta_E= -1.47e-05  |g|= 0.0599  |ddm|= 3.86e+03
    CPU time for cycle= 40      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000174286
diis-c [-1.37461377e-12 -6.46827451e-01  2.17673455e-01  9.89004608e-01
  8.06773050e-01 -5.05813951e-02 -4.06877861e-01  4.81560171e-01
 -3.90724577e-01]
  HOMO = -0.332290791105329  LUMO = 1.50057446960983e-09
  mo_energy =
[-1.08560684e+02 -1.10662408e+01 -9.13954205e+00 -9.13953971e+00
 -9.13952183e+00 -9.86973638e-01 -3.32292725e-01 -3.32292418e-01
 -3.32290791e-01  1.50057447e-09  4.96812304e+00  4.96812513e+00
  4.96812564e+00  4.81587281e+01  4.81588376e+01  4.81751970e+01
  7.81593812e+01  2.32330814e+02  2.32335197e+02  2.32969116e+02
  6.52885415e+02  6.52903148e+02  6.55444463e+02  1.39287687e+03
  1.39291489e+03  1.39832537e+03  2.73856070e+03  2.73859834e+03
  2.74396674e+03  3.21503102e+03  5.45306393e+03  5.45308476e+03
  5.45605596e+03  1.06832255e+04  1.06832356e+04  1.06846745e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9484237920323  E_coul = 205.44517082112623
cycle= 41 E= -503.503252970906  delta_E= -9.04e-06  |g|= 0.079  |ddm|= 5.35e+03
    CPU time for cycle= 41      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0002808
diis-c [-1.14961366e-12 -4.21129114e-01  2.67048957e-01  2.54175142e-01
  1.04998010e+00  7.28286147e-01 -6.47304930e-01 -3.35884098e-01
  1.04827799e-01]
  HOMO = -0.332290032510167  LUMO = 1.50055517202163e-09
  mo_energy =
[-1.08560684e+02 -1.10662410e+01 -9.13954962e+00 -9.13951941e+00
 -9.13951415e+00 -9.86973636e-01 -3.32293356e-01 -3.32290524e-01
 -3.32290033e-01  1.50055517e-09  4.96812371e+00  4.96812630e+00
  4.96812676e+00  4.81511013e+01  4.81768669e+01  4.81813943e+01
  7.81593808e+01  2.32035787e+02  2.33033901e+02  2.33209435e+02
  6.51710884e+02  6.55705070e+02  6.56413935e+02  1.39040896e+03
  1.39888324e+03  1.40041454e+03  2.73613204e+03  2.74452067e+03
  2.74605483e+03  3.21503102e+03  5.45171834e+03  5.45636000e+03
  5.45721013e+03  1.06825711e+04  1.06848193e+04  1.06852314e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9482733344913  E_coul = 205.44505429269643
cycle= 42 E= -503.503219041795  delta_E= 3.39e-05  |g|= 0.122  |ddm|= 4.71e+03
    CPU time for cycle= 42      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000236463
diis-c [-8.37328434e-13 -5.05221901e-01  3.43356446e-01  3.66384160e-01
  2.84747180e-01  7.54209356e-01 -1.56196168e-01  5.45425637e-01
 -6.32704710e-01]
  HOMO = -0.33228908473857  LUMO = 1.50051208411347e-09
  mo_energy =
[-1.08560686e+02 -1.10662414e+01 -9.13952913e+00 -9.13952263e+00
 -9.13950498e+00 -9.86973629e-01 -3.32291424e-01 -3.32290697e-01
 -3.32289085e-01  1.50051208e-09  4.96812466e+00  4.96812767e+00
  4.96812830e+00  4.81698729e+01  4.81728832e+01  4.81887512e+01
  7.81593796e+01  2.32762667e+02  2.32879424e+02  2.33495107e+02
  6.54614624e+02  6.55083614e+02  6.57569620e+02  1.39655010e+03
  1.39755161e+03  1.40291727e+03  2.74220013e+03  2.74319470e+03
  2.74856365e+03  3.21503102e+03  5.45507841e+03  5.45562776e+03
  5.45859528e+03  1.06842009e+04  1.06844665e+04  1.06858987e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9480748610418  E_coul = 205.44482685760266
cycle= 43 E= -503.503248003439  delta_E= -2.9e-05  |g|= 0.039  |ddm|= 6.23e+03
    CPU time for cycle= 43      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000132258
diis-c [-3.27005045e-13 -5.14181145e-01 -1.46202156e-01  8.74896818e-01
 -5.50492341e-01  5.34112221e-01  3.39408360e-01  5.05549412e-01
 -4.30911701e-02]
  HOMO = -0.332288506141526  LUMO = 1.50056340661007e-09
  mo_energy =
[-1.08560687e+02 -1.10662417e+01 -9.13952006e+00 -9.13950887e+00
 -9.13949934e+00 -9.86973625e-01 -3.32290511e-01 -3.32289331e-01
 -3.32288506e-01  1.50056341e-09  4.96812598e+00  4.96812907e+00
  4.96812970e+00  4.81773262e+01  4.81840296e+01  4.81935396e+01
  7.81593787e+01  2.33051762e+02  2.33311883e+02  2.33681129e+02
  6.55777693e+02  6.56827678e+02  6.58325379e+02  1.39904276e+03
  1.40130701e+03  1.40456830e+03  2.74468309e+03  2.74694653e+03
  2.75022853e+03  3.21503102e+03  5.45645151e+03  5.45770195e+03
  5.45951519e+03  1.06848645e+04  1.06854684e+04  1.06863416e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9478628106891  E_coul = 205.44458281222472
cycle= 44 E= -503.503279998464  delta_E= -3.2e-05  |g|= 0.0884  |ddm|= 3.22e+03
    CPU time for cycle= 44      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=5.91412e-05
diis-c [-2.78415815e-13 -3.54114032e-01 -7.66747880e-02  2.70181021e-01
  3.29129407e-01  4.40837410e-01 -6.86294883e-03  4.85969029e-01
 -8.84650985e-02]
  HOMO = -0.332289865737256  LUMO = 1.50048414404139e-09
  mo_energy =
[-1.08560686e+02 -1.10662416e+01 -9.13952270e+00 -9.13951510e+00
 -9.13951431e+00 -9.86973626e-01 -3.32290776e-01 -3.32290035e-01
 -3.32289866e-01  1.50048414e-09  4.96812559e+00  4.96812682e+00
  4.96812892e+00  4.81751714e+01  4.81796545e+01  4.81809785e+01
  7.81593789e+01  2.32968086e+02  2.33142061e+02  2.33193366e+02
  6.55440642e+02  6.56141610e+02  6.56348856e+02  1.39831910e+03
  1.39982480e+03  1.40027286e+03  2.74396163e+03  2.74546266e+03
  2.74591151e+03  3.21503102e+03  5.45605294e+03  5.45688191e+03
  5.45712967e+03  1.06846723e+04  1.06850727e+04  1.06851914e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9480371987212  E_coul = 205.44479876784303
cycle= 45 E= -503.503238430878  delta_E= 4.16e-05  |g|= 0.0278  |ddm|= 3.03e+03
    CPU time for cycle= 45      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=9.74482e-05
diis-c [-3.30871650e-13 -2.55869717e-01 -1.63699531e-01  1.79112058e-01
  3.86523076e-01  1.74569262e-01  3.25759365e-02  6.13868666e-01
  3.29202496e-02]
  HOMO = -0.332289932323469  LUMO = 1.50050856795396e-09
  mo_energy =
[-1.08560687e+02 -1.10662417e+01 -9.13952184e+00 -9.13952037e+00
 -9.13951515e+00 -9.86973624e-01 -3.32290671e-01 -3.32290538e-01
 -3.32289932e-01  1.50050857e-09  4.96812584e+00  4.96812593e+00
  4.96812882e+00  4.81757713e+01  4.81771212e+01  4.81790785e+01
  7.81593786e+01  2.32991348e+02  2.33043728e+02  2.33119705e+02
  6.55534140e+02  6.55745287e+02  6.56051286e+02  1.39851872e+03
  1.39897323e+03  1.39962944e+03  2.74415909e+03  2.74461408e+03
  2.74526692e+03  3.21503102e+03  5.45616102e+03  5.45641383e+03
  5.45677385e+03  1.06847239e+04  1.06848469e+04  1.06850209e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9480727231427  E_coul = 205.4448043542328
cycle= 46 E= -503.50326836891  delta_E= -2.99e-05  |g|= 0.0322  |ddm|= 1.27e+03
    CPU time for cycle= 46      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000112676
diis-c [-3.28734112e-13 -2.85998997e-01 -1.25375704e-01  1.53189457e-01
  3.78543219e-01  1.10669226e-01  1.13333977e-01  6.49395265e-01
  6.24355685e-03]
  HOMO = -0.332290043784457  LUMO = 1.50053873495193e-09
  mo_energy =
[-1.08560687e+02 -1.10662417e+01 -9.13952238e+00 -9.13952051e+00
 -9.13951637e+00 -9.86973624e-01 -3.32290719e-01 -3.32290546e-01
 -3.32290044e-01  1.50053873e-09  4.96812575e+00  4.96812592e+00
  4.96812865e+00  4.81753840e+01  4.81770506e+01  4.81781502e+01
  7.81593785e+01  2.32976322e+02  2.33040985e+02  2.33083686e+02
  6.55473638e+02  6.55734238e+02  6.55906011e+02  1.39838886e+03
  1.39894950e+03  1.39931660e+03  2.74402965e+03  2.74459040e+03
  2.74495437e+03  3.21503102e+03  5.45608951e+03  5.45640075e+03
  5.45660104e+03  1.06846894e+04  1.06848406e+04  1.06849374e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9480855259145  E_coul = 205.44481075246222
cycle= 47 E= -503.503274773452  delta_E= -6.4e-06  |g|= 0.0305  |ddm|=  228
    CPU time for cycle= 47      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000119184
diis-c [-4.97008487e-13 -2.71473440e-01 -4.60705733e-01  2.27705033e-01
  2.35209465e-01  5.67953710e-01 -2.15587262e-01  3.98212130e-01
  5.18686096e-01]
  HOMO = -0.332290399551641  LUMO = 1.50052984186272e-09
  mo_energy =
[-1.08560687e+02 -1.10662417e+01 -9.13953030e+00 -9.13952279e+00
 -9.13951905e+00 -9.86973624e-01 -3.32291390e-01 -3.32290767e-01
 -3.32290400e-01  1.50052984e-09  4.96812558e+00  4.96812624e+00
  4.96812665e+00  4.81670883e+01  4.81752264e+01  4.81780183e+01
  7.81593785e+01  2.32654740e+02  2.32970213e+02  2.33078550e+02
  6.54181490e+02  6.55449210e+02  6.55885540e+02  1.39562550e+03
  1.39833734e+03  1.39927413e+03  2.74128071e+03  2.74397973e+03
  2.74491287e+03  3.21503102e+03  5.45456918e+03  5.45606291e+03
  5.45657738e+03  1.06839545e+04  1.06846771e+04  1.06849245e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9481785726921  E_coul = 205.4449464035676
cycle= 48 E= -503.503232169124  delta_E= 4.26e-05  |g|= 0.0515  |ddm|= 2.62e+03
    CPU time for cycle= 48      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000172264
diis-c [-9.75079505e-13 -1.71506524e-01 -2.60715885e-02 -1.01998286e+00
  8.22814831e-01  5.41920326e-01  1.28803484e+00 -6.84734746e-01
  2.49525725e-01]
  HOMO = -0.332290686693401  LUMO = 1.50052652873795e-09
  mo_energy =
[-1.08560688e+02 -1.10662421e+01 -9.13952883e+00 -9.13952857e+00
 -9.13952356e+00 -9.86973618e-01 -3.32291299e-01 -3.32291270e-01
 -3.32290687e-01  1.50052653e-09  4.96812473e+00  4.96812484e+00
  4.96812769e+00  4.81708034e+01  4.81709102e+01  4.81727560e+01
  7.81593774e+01  2.32798565e+02  2.32802853e+02  2.32874373e+02
  6.54758722e+02  6.54775855e+02  6.55063154e+02  1.39685855e+03
  1.39689382e+03  1.39750727e+03  2.74250741e+03  2.74254059e+03
  2.74315038e+03  3.21503101e+03  5.45524902e+03  5.45526585e+03
  5.45560338e+03  1.06842842e+04  1.06842911e+04  1.06844549e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.948233773188  E_coul = 205.44501045626038
cycle= 49 E= -503.503223316928  delta_E= 8.85e-06  |g|= 0.0668  |ddm|= 2.3e+03
    CPU time for cycle= 49      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000191512
diis-c [-9.99862479e-13 -1.41950051e-02 -9.81185278e-02 -1.11309776e+00
  1.01049020e+00  6.46572357e-01  1.27283792e+00 -1.00614558e+00
  3.01656393e-01]
  HOMO = -0.332290377153099  LUMO = 1.50051452370554e-09
  mo_energy =
[-1.08560688e+02 -1.10662420e+01 -9.13953168e+00 -9.13952762e+00
 -9.13952020e+00 -9.86973620e-01 -3.32291583e-01 -3.32291197e-01
 -3.32290377e-01  1.50051452e-09  4.96812441e+00  4.96812489e+00
  4.96812816e+00  4.81683237e+01  4.81716659e+01  4.81753312e+01
  7.81593777e+01  2.32702597e+02  2.32831981e+02  2.32974247e+02
  6.54373389e+02  6.54892985e+02  6.55464941e+02  1.39603484e+03
  1.39714572e+03  1.39836818e+03  2.74168715e+03  2.74279321e+03
  2.74400774e+03  3.21503101e+03  5.45479368e+03  5.45540719e+03
  5.45607746e+03  1.06840625e+04  1.06843608e+04  1.06846841e+04
  1.84040711e+04  6.89909308e+04]
E1 = -708.9482255372683  E_coul = 205.44492349444764
cycle= 50 E= -503.503302042821  delta_E= -7.87e-05  |g|= 0.0531  |ddm|=  852
    CPU time for cycle= 50      0.02 sec, wall time      0.02 sec
E1 = -708.9482255372683  E_coul = 205.44492349444764

WARN: 	An extra scf cycle is going to be run
	in order to restore the mo_energy derivatives
	missing in implicit differentiation.

  HOMO = -0.332290213068352  LUMO = 1.50052677637921e-09
  mo_energy =
[-1.08560607e+02 -1.10662179e+01 -9.13951981e+00 -9.13950458e+00
 -9.13949288e+00 -9.86973213e-01 -3.32292792e-01 -3.32291248e-01
 -3.32290213e-01  1.50052678e-09  4.96812726e+00  4.96813026e+00
  4.96813051e+00  4.81546565e+01  4.81655927e+01  4.81767668e+01
  7.81594437e+01  2.32171229e+02  2.32594698e+02  2.33027803e+02
  6.52249285e+02  6.53940559e+02  6.55680657e+02  1.39153860e+03
  1.39511264e+03  1.39883311e+03  2.73724326e+03  2.74077183e+03
  2.74447241e+03  3.21503109e+03  5.45233461e+03  5.45428740e+03
  5.45633436e+03  1.06828711e+04  1.06838180e+04  1.06848082e+04
  1.84040711e+04  6.89909309e+04]
E1 = -708.9482909866562  E_coul = 205.44508094499608
Extra cycle  E= -503.50321004166  delta_E= 9.2e-05  |g|= 0.129  |ddm|= 4.89e+03
    CPU time for scf_cycle      1.46 sec, wall time      1.30 sec
exp = [2.61872616e+04 7.56605391e+03 3.51438577e+03 1.00000000e-09
 1.11156908e+02 3.46110614e+01 4.54004997e+00 3.62456966e-01
 1.36249027e+03 6.43116175e+02 1.88110543e+02 2.15054047e+02
 1.49827525e+03 3.96802541e+01 1.88158939e+02 2.10017789e+00
 9.06950054e+00 5.38019982e-01]
E = -503.50321004166005
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26184.3968276        1
[INPUT] 0    0    [1    /1   ]  7597.51263738        1
[INPUT] 0    0    [1    /1   ]  3576.98601317        1
[INPUT] 0    0    [1    /1   ]  975.417478886        1
[INPUT] 0    0    [1    /1   ]  185.024721169        1
[INPUT] 0    0    [1    /1   ]  44.7831588781        1
[INPUT] 0    0    [1    /1   ]  4.57915649182        1
[INPUT] 0    0    [1    /1   ]  0.384349442757       1
[INPUT] 1    0    [1    /1   ]  1362.67629471        1
[INPUT] 1    0    [1    /1   ]  656.440879204        1
[INPUT] 1    0    [1    /1   ]  257.701494057        1
[INPUT] 1    0    [1    /1   ]  276.118505248        1
[INPUT] 1    0    [1    /1   ]  618.4552377          1
[INPUT] 1    0    [1    /1   ]  22.4848882226        1
[INPUT] 1    0    [1    /1   ]  93.5215021663        1
[INPUT] 1    0    [1    /1   ]  1.32196598546        1
[INPUT] 1    0    [1    /1   ]  5.92937932038        1
[INPUT] 1    0    [1    /1   ]  0.356225205443       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26184.396827561457, 1.0]], [0, [7597.512637376075, 1.0]], [0, [3576.9860131664, 1.0]], [0, [975.4174788863685, 1.0]], [0, [185.0247211688521, 1.0]], [0, [44.78315887811862, 1.0]], [0, [4.579156491822625, 1.0]], [0, [0.38434944275730165, 1.0]], [1, [1362.6762947095367, 1.0]], [1, [656.4408792044842, 1.0]], [1, [257.7014940568654, 1.0]], [1, [276.11850524795045, 1.0]], [1, [618.4552377000698, 1.0]], [1, [22.484888222622164, 1.0]], [1, [93.52150216633618, 1.0]], [1, [1.3219659854596033, 1.0]], [1, [5.92937932038101, 1.0]], [1, [0.3562252054434318, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26184.39682756]
bas 1, expnt(s) = [7597.51263738]
bas 2, expnt(s) = [3576.98601317]
bas 3, expnt(s) = [975.41747889]
bas 4, expnt(s) = [185.02472117]
bas 5, expnt(s) = [44.78315888]
bas 6, expnt(s) = [4.57915649]
bas 7, expnt(s) = [0.38434944]
bas 8, expnt(s) = [1362.67629471]
bas 9, expnt(s) = [656.4408792]
bas 10, expnt(s) = [257.70149406]
bas 11, expnt(s) = [276.11850525]
bas 12, expnt(s) = [618.4552377]
bas 13, expnt(s) = [22.48488822]
bas 14, expnt(s) = [93.52150217]
bas 15, expnt(s) = [1.32196599]
bas 16, expnt(s) = [5.92937932]
bas 17, expnt(s) = [0.35622521]
CPU time:       542.71
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61843968e+04 5.20052220e+03 7.59751264e+03 2.05597864e+03
 3.57698601e+03 1.16856522e+03 9.75417479e+02 4.40968863e+02
 1.85024721e+02 1.26746899e+02 4.47831589e+01 4.37372091e+01
 4.57915649e+00 7.90868246e+00 3.84349443e-01 1.23327440e+00
 1.36267629e+03 2.41532329e+04 6.56440879e+02 9.69346208e+03
 2.57701494e+02 3.01217752e+03 2.76118505e+02 3.28362675e+03
 6.18455238e+02 8.99745602e+03 2.24848882e+01 1.42839331e+02
 9.35215022e+01 8.48445079e+02 1.32196599e+00 4.13532592e+00
 5.92937932e+00 2.69926756e+01 3.56225205e-01 8.02860700e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.906434100125942
cond(S) = 782978.9050752034
E1 = -727.4381921366991  E_coul = 202.74916172742516
init E= -524.689030409274
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.554554040826349  LUMO = 2.26438403303419
  mo_energy =
[-1.18157216e+02 -1.21102496e+01 -9.44184270e+00 -9.44184270e+00
 -9.44184270e+00 -1.24171285e+00 -5.54554041e-01 -5.54554041e-01
 -5.54554041e-01  2.26438403e+00  2.26438403e+00  2.26438403e+00
  2.39902572e+01  2.39902572e+01  2.39902572e+01  1.33608719e+02
  1.45705427e+02  1.45705427e+02  1.45705427e+02  4.99418359e+02
  4.99418359e+02  4.99418359e+02  1.20410538e+03  1.20410538e+03
  1.20410538e+03  1.30437327e+03  2.43623140e+03  2.43623140e+03
  2.43623140e+03  4.57508203e+03  4.57508203e+03  4.57508203e+03
  6.51228424e+03  8.52503269e+03  8.52503269e+03  8.52503269e+03
  2.21533458e+04  7.27354377e+04]
E1 = -728.6721064813579  E_coul = 202.9272019892067
cycle= 1 E= -525.744904492151  delta_E= -1.06  |g|= 0.18  |ddm|= 1.17
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.480877
diis-c [-0.23124272  1.        ]
  HOMO = -0.513902387060663  LUMO = 2.31003834999417
  mo_energy =
[-1.18308995e+02 -1.20874891e+01 -9.42471067e+00 -9.42471067e+00
 -9.42471067e+00 -1.19665316e+00 -5.13902387e-01 -5.13902387e-01
 -5.13902387e-01  2.31003835e+00  2.31003835e+00  2.31003835e+00
  2.39927772e+01  2.39927772e+01  2.39927772e+01  1.33536388e+02
  1.45622928e+02  1.45622928e+02  1.45622928e+02  4.99286451e+02
  4.99286451e+02  4.99286451e+02  1.20392878e+03  1.20392878e+03
  1.20392878e+03  1.30407191e+03  2.43600534e+03  2.43600534e+03
  2.43600534e+03  4.57479277e+03  4.57479277e+03  4.57479277e+03
  6.51180293e+03  8.52462576e+03  8.52462576e+03  8.52462576e+03
  2.21527514e+04  7.27347499e+04]
E1 = -728.669251296386  E_coul = 202.9241065883458
cycle= 2 E= -525.74514470804  delta_E= -0.00024  |g|= 0.00952  |ddm|= 0.0171
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.014683
diis-c [-1.81447736e-04  1.20096701e-02  9.87990330e-01]
  HOMO = -0.515475292978644  LUMO = 2.30820252245662
  mo_energy =
[-1.18298875e+02 -1.20886814e+01 -9.42595871e+00 -9.42595871e+00
 -9.42595871e+00 -1.19864212e+00 -5.15475293e-01 -5.15475293e-01
 -5.15475293e-01  2.30820252e+00  2.30820252e+00  2.30820252e+00
  2.39926997e+01  2.39926997e+01  2.39926997e+01  1.33544715e+02
  1.45629356e+02  1.45629356e+02  1.45629356e+02  4.99295981e+02
  4.99295981e+02  4.99295981e+02  1.20393976e+03  1.20393976e+03
  1.20393976e+03  1.30408436e+03  2.43601721e+03  2.43601721e+03
  2.43601721e+03  4.57480526e+03  4.57480526e+03  4.57480526e+03
  6.51181584e+03  8.52463856e+03  8.52463856e+03  8.52463856e+03
  2.21527643e+04  7.27347626e+04]
E1 = -728.6624443594941  E_coul = 202.91729893180295
cycle= 3 E= -525.745145427691  delta_E= -7.2e-07  |g|= 0.000711  |ddm|= 0.000442
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00146237
diis-c [-1.12913885e-07 -8.17201293e-04  7.61740587e-02  9.24643143e-01]
  HOMO = -0.515527315804589  LUMO = 2.30810570735845
  mo_energy =
[-1.18300070e+02 -1.20891004e+01 -9.42640223e+00 -9.42640223e+00
 -9.42640223e+00 -1.19870877e+00 -5.15527316e-01 -5.15527316e-01
 -5.15527316e-01  2.30810571e+00  2.30810571e+00  2.30810571e+00
  2.39922014e+01  2.39922014e+01  2.39922014e+01  1.33543698e+02
  1.45628403e+02  1.45628403e+02  1.45628403e+02  4.99294831e+02
  4.99294831e+02  4.99294831e+02  1.20393849e+03  1.20393849e+03
  1.20393849e+03  1.30408292e+03  2.43601586e+03  2.43601586e+03
  2.43601586e+03  4.57480383e+03  4.57480383e+03  4.57480383e+03
  6.51181424e+03  8.52463703e+03  8.52463703e+03  8.52463703e+03
  2.21527626e+04  7.27347609e+04]
E1 = -728.6636865497558  E_coul = 202.91854111286352
cycle= 4 E= -525.745145436892  delta_E= -9.2e-09  |g|= 3.37e-05  |ddm|= 0.000109
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=4.80089e-05
diis-c [-4.39266030e-10 -3.09749317e-06 -4.65513311e-04  2.49849497e-02
  9.75483661e-01]
  HOMO = -0.515514171794121  LUMO = 2.30812532920698
  mo_energy =
[-1.18299998e+02 -1.20890457e+01 -9.42634708e+00 -9.42634708e+00
 -9.42634708e+00 -1.19869179e+00 -5.15514172e-01 -5.15514172e-01
 -5.15514172e-01  2.30812533e+00  2.30812533e+00  2.30812533e+00
  2.39922563e+01  2.39922563e+01  2.39922563e+01  1.33543769e+02
  1.45628472e+02  1.45628472e+02  1.45628472e+02  4.99294903e+02
  4.99294903e+02  4.99294903e+02  1.20393857e+03  1.20393857e+03
  1.20393857e+03  1.30408299e+03  2.43601593e+03  2.43601593e+03
  2.43601593e+03  4.57480390e+03  4.57480390e+03  4.57480390e+03
  6.51181431e+03  8.52463710e+03  8.52463710e+03  8.52463710e+03
  2.21527627e+04  7.27347609e+04]
E1 = -728.6635885947202  E_coul = 202.91844315778332
cycle= 5 E= -525.745145436937  delta_E= -4.46e-11  |g|= 3.28e-06  |ddm|= 1.12e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -728.6635885947202  E_coul = 202.91844315778332
  HOMO = -0.515515291845366  LUMO = 2.30812364830388
  mo_energy =
[-1.18300005e+02 -1.20890506e+01 -9.42635205e+00 -9.42635205e+00
 -9.42635205e+00 -1.19869324e+00 -5.15515292e-01 -5.15515292e-01
 -5.15515292e-01  2.30812365e+00  2.30812365e+00  2.30812365e+00
  2.39922513e+01  2.39922513e+01  2.39922513e+01  1.33543762e+02
  1.45628465e+02  1.45628465e+02  1.45628465e+02  4.99294895e+02
  4.99294895e+02  4.99294895e+02  1.20393856e+03  1.20393856e+03
  1.20393856e+03  1.30408298e+03  2.43601592e+03  2.43601592e+03
  2.43601592e+03  4.57480389e+03  4.57480389e+03  4.57480389e+03
  6.51181430e+03  8.52463709e+03  8.52463709e+03  8.52463709e+03
  2.21527627e+04  7.27347609e+04]
E1 = -728.6635981256388  E_coul = 202.91845268870168
Extra cycle  E= -525.745145436937  delta_E= -3.41e-13  |g|= 6.42e-07  |ddm|= 1.02e-06
    CPU time for scf_cycle      0.29 sec, wall time      0.19 sec
exp = [2.61843968e+04 7.59751264e+03 3.57698601e+03 9.75417479e+02
 1.85024721e+02 4.47831589e+01 4.57915649e+00 3.84349443e-01
 1.36267629e+03 6.56440879e+02 2.57701494e+02 2.76118505e+02
 6.18455238e+02 2.24848882e+01 9.35215022e+01 1.32196599e+00
 5.92937932e+00 3.56225205e-01]
E = -525.7451454369372
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26184.3968276        1
[INPUT] 0    0    [1    /1   ]  7597.51263738        1
[INPUT] 0    0    [1    /1   ]  3576.98601317        1
[INPUT] 0    0    [1    /1   ]  975.417478886        1
[INPUT] 0    0    [1    /1   ]  185.024721169        1
[INPUT] 0    0    [1    /1   ]  44.7831588781        1
[INPUT] 0    0    [1    /1   ]  4.57915649182        1
[INPUT] 0    0    [1    /1   ]  0.384349442757       1
[INPUT] 1    0    [1    /1   ]  1362.67629471        1
[INPUT] 1    0    [1    /1   ]  656.440879204        1
[INPUT] 1    0    [1    /1   ]  257.701494057        1
[INPUT] 1    0    [1    /1   ]  276.118505248        1
[INPUT] 1    0    [1    /1   ]  618.4552377          1
[INPUT] 1    0    [1    /1   ]  22.4848882226        1
[INPUT] 1    0    [1    /1   ]  93.5215021663        1
[INPUT] 1    0    [1    /1   ]  1.32196598546        1
[INPUT] 1    0    [1    /1   ]  5.92937932038        1
[INPUT] 1    0    [1    /1   ]  0.356225205443       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26184.396827561457, 1.0]], [0, [7597.512637376075, 1.0]], [0, [3576.9860131664, 1.0]], [0, [975.4174788863685, 1.0]], [0, [185.0247211688521, 1.0]], [0, [44.78315887811862, 1.0]], [0, [4.579156491822625, 1.0]], [0, [0.38434944275730165, 1.0]], [1, [1362.6762947095367, 1.0]], [1, [656.4408792044842, 1.0]], [1, [257.7014940568654, 1.0]], [1, [276.11850524795045, 1.0]], [1, [618.4552377000698, 1.0]], [1, [22.484888222622164, 1.0]], [1, [93.52150216633618, 1.0]], [1, [1.3219659854596033, 1.0]], [1, [5.92937932038101, 1.0]], [1, [0.3562252054434318, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26184.39682756]
bas 1, expnt(s) = [7597.51263738]
bas 2, expnt(s) = [3576.98601317]
bas 3, expnt(s) = [975.41747889]
bas 4, expnt(s) = [185.02472117]
bas 5, expnt(s) = [44.78315888]
bas 6, expnt(s) = [4.57915649]
bas 7, expnt(s) = [0.38434944]
bas 8, expnt(s) = [1362.67629471]
bas 9, expnt(s) = [656.4408792]
bas 10, expnt(s) = [257.70149406]
bas 11, expnt(s) = [276.11850525]
bas 12, expnt(s) = [618.4552377]
bas 13, expnt(s) = [22.48488822]
bas 14, expnt(s) = [93.52150217]
bas 15, expnt(s) = [1.32196599]
bas 16, expnt(s) = [5.92937932]
bas 17, expnt(s) = [0.35622521]
CPU time:       543.28
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61843968e+04 5.20052220e+03 7.59751264e+03 2.05597864e+03
 3.57698601e+03 1.16856522e+03 9.75417479e+02 4.40968863e+02
 1.85024721e+02 1.26746899e+02 4.47831589e+01 4.37372091e+01
 4.57915649e+00 7.90868246e+00 3.84349443e-01 1.23327440e+00
 1.36267629e+03 2.41532329e+04 6.56440879e+02 9.69346208e+03
 2.57701494e+02 3.01217752e+03 2.76118505e+02 3.28362675e+03
 6.18455238e+02 8.99745602e+03 2.24848882e+01 1.42839331e+02
 9.35215022e+01 8.48445079e+02 1.32196599e+00 4.13532592e+00
 5.92937932e+00 2.69926756e+01 3.56225205e-01 8.02860700e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.906434100125942
cond(S) = 782978.9050752034
E1 = -727.4381921366991  E_coul = 202.74916172742516
init E= -524.689030409274
    CPU time for initialize scf      0.13 sec, wall time      0.04 sec
  HOMO = -0.554554040826349  LUMO = 2.26438403303419
  mo_energy =
[-1.18157216e+02 -1.21102496e+01 -9.44184270e+00 -9.44184270e+00
 -9.44184270e+00 -1.24171285e+00 -5.54554041e-01 -5.54554041e-01
 -5.54554041e-01  2.26438403e+00  2.26438403e+00  2.26438403e+00
  2.39902572e+01  2.39902572e+01  2.39902572e+01  1.33608719e+02
  1.45705427e+02  1.45705427e+02  1.45705427e+02  4.99418359e+02
  4.99418359e+02  4.99418359e+02  1.20410538e+03  1.20410538e+03
  1.20410538e+03  1.30437327e+03  2.43623140e+03  2.43623140e+03
  2.43623140e+03  4.57508203e+03  4.57508203e+03  4.57508203e+03
  6.51228424e+03  8.52503269e+03  8.52503269e+03  8.52503269e+03
  2.21533458e+04  7.27354377e+04]
E1 = -728.6721064813579  E_coul = 202.9272019892067
cycle= 1 E= -525.744904492151  delta_E= -1.06  |g|= 0.18  |ddm|= 1.17
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.480877
diis-c [-0.23124272  1.        ]
  HOMO = -0.513902387060663  LUMO = 2.31003834999417
  mo_energy =
[-1.18308995e+02 -1.20874891e+01 -9.42471067e+00 -9.42471067e+00
 -9.42471067e+00 -1.19665316e+00 -5.13902387e-01 -5.13902387e-01
 -5.13902387e-01  2.31003835e+00  2.31003835e+00  2.31003835e+00
  2.39927772e+01  2.39927772e+01  2.39927772e+01  1.33536388e+02
  1.45622928e+02  1.45622928e+02  1.45622928e+02  4.99286451e+02
  4.99286451e+02  4.99286451e+02  1.20392878e+03  1.20392878e+03
  1.20392878e+03  1.30407191e+03  2.43600534e+03  2.43600534e+03
  2.43600534e+03  4.57479277e+03  4.57479277e+03  4.57479277e+03
  6.51180293e+03  8.52462576e+03  8.52462576e+03  8.52462576e+03
  2.21527514e+04  7.27347499e+04]
E1 = -728.669251296386  E_coul = 202.9241065883458
cycle= 2 E= -525.74514470804  delta_E= -0.00024  |g|= 0.00952  |ddm|= 0.0171
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.014683
diis-c [-1.81447736e-04  1.20096701e-02  9.87990330e-01]
  HOMO = -0.515475292978644  LUMO = 2.30820252245662
  mo_energy =
[-1.18298875e+02 -1.20886814e+01 -9.42595871e+00 -9.42595871e+00
 -9.42595871e+00 -1.19864212e+00 -5.15475293e-01 -5.15475293e-01
 -5.15475293e-01  2.30820252e+00  2.30820252e+00  2.30820252e+00
  2.39926997e+01  2.39926997e+01  2.39926997e+01  1.33544715e+02
  1.45629356e+02  1.45629356e+02  1.45629356e+02  4.99295981e+02
  4.99295981e+02  4.99295981e+02  1.20393976e+03  1.20393976e+03
  1.20393976e+03  1.30408436e+03  2.43601721e+03  2.43601721e+03
  2.43601721e+03  4.57480526e+03  4.57480526e+03  4.57480526e+03
  6.51181584e+03  8.52463856e+03  8.52463856e+03  8.52463856e+03
  2.21527643e+04  7.27347626e+04]
E1 = -728.6624443594941  E_coul = 202.91729893180295
cycle= 3 E= -525.745145427691  delta_E= -7.2e-07  |g|= 0.000711  |ddm|= 0.000442
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00146237
diis-c [-1.12913885e-07 -8.17201293e-04  7.61740587e-02  9.24643143e-01]
  HOMO = -0.515527315804589  LUMO = 2.30810570735845
  mo_energy =
[-1.18300070e+02 -1.20891004e+01 -9.42640223e+00 -9.42640223e+00
 -9.42640223e+00 -1.19870877e+00 -5.15527316e-01 -5.15527316e-01
 -5.15527316e-01  2.30810571e+00  2.30810571e+00  2.30810571e+00
  2.39922014e+01  2.39922014e+01  2.39922014e+01  1.33543698e+02
  1.45628403e+02  1.45628403e+02  1.45628403e+02  4.99294831e+02
  4.99294831e+02  4.99294831e+02  1.20393849e+03  1.20393849e+03
  1.20393849e+03  1.30408292e+03  2.43601586e+03  2.43601586e+03
  2.43601586e+03  4.57480383e+03  4.57480383e+03  4.57480383e+03
  6.51181424e+03  8.52463703e+03  8.52463703e+03  8.52463703e+03
  2.21527626e+04  7.27347609e+04]
E1 = -728.6636865497558  E_coul = 202.91854111286352
cycle= 4 E= -525.745145436892  delta_E= -9.2e-09  |g|= 3.37e-05  |ddm|= 0.000109
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=4.80089e-05
diis-c [-4.39266030e-10 -3.09749317e-06 -4.65513311e-04  2.49849497e-02
  9.75483661e-01]
  HOMO = -0.515514171794121  LUMO = 2.30812532920698
  mo_energy =
[-1.18299998e+02 -1.20890457e+01 -9.42634708e+00 -9.42634708e+00
 -9.42634708e+00 -1.19869179e+00 -5.15514172e-01 -5.15514172e-01
 -5.15514172e-01  2.30812533e+00  2.30812533e+00  2.30812533e+00
  2.39922563e+01  2.39922563e+01  2.39922563e+01  1.33543769e+02
  1.45628472e+02  1.45628472e+02  1.45628472e+02  4.99294903e+02
  4.99294903e+02  4.99294903e+02  1.20393857e+03  1.20393857e+03
  1.20393857e+03  1.30408299e+03  2.43601593e+03  2.43601593e+03
  2.43601593e+03  4.57480390e+03  4.57480390e+03  4.57480390e+03
  6.51181431e+03  8.52463710e+03  8.52463710e+03  8.52463710e+03
  2.21527627e+04  7.27347609e+04]
E1 = -728.6635885947202  E_coul = 202.91844315778332
cycle= 5 E= -525.745145436937  delta_E= -4.46e-11  |g|= 3.28e-06  |ddm|= 1.12e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -728.6635885947202  E_coul = 202.91844315778332
  HOMO = -0.515515291845366  LUMO = 2.30812364830388
  mo_energy =
[-1.18300005e+02 -1.20890506e+01 -9.42635205e+00 -9.42635205e+00
 -9.42635205e+00 -1.19869324e+00 -5.15515292e-01 -5.15515292e-01
 -5.15515292e-01  2.30812365e+00  2.30812365e+00  2.30812365e+00
  2.39922513e+01  2.39922513e+01  2.39922513e+01  1.33543762e+02
  1.45628465e+02  1.45628465e+02  1.45628465e+02  4.99294895e+02
  4.99294895e+02  4.99294895e+02  1.20393856e+03  1.20393856e+03
  1.20393856e+03  1.30408298e+03  2.43601592e+03  2.43601592e+03
  2.43601592e+03  4.57480389e+03  4.57480389e+03  4.57480389e+03
  6.51181430e+03  8.52463709e+03  8.52463709e+03  8.52463709e+03
  2.21527627e+04  7.27347609e+04]
E1 = -728.6635981256388  E_coul = 202.91845268870168
Extra cycle  E= -525.745145436937  delta_E= -3.41e-13  |g|= 6.42e-07  |ddm|= 1.02e-06
    CPU time for scf_cycle      0.28 sec, wall time      0.18 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 782978.9050752034
E1 = -728.6635981256388  E_coul = 202.91845268870168
init E= -525.745145436937
    CPU time for initialize scf      1.11 sec, wall time      0.20 sec
  HOMO = -0.515515155669975  LUMO = 2.30812386427797
  mo_energy =
[-1.18300004e+02 -1.20890499e+01 -9.42635133e+00 -9.42635133e+00
 -9.42635133e+00 -1.19869306e+00 -5.15515156e-01 -5.15515156e-01
 -5.15515156e-01  2.30812386e+00  2.30812386e+00  2.30812386e+00
  2.39922520e+01  2.39922520e+01  2.39922520e+01  1.33543763e+02
  1.45628466e+02  1.45628466e+02  1.45628466e+02  4.99294896e+02
  4.99294896e+02  4.99294896e+02  1.20393856e+03  1.20393856e+03
  1.20393856e+03  1.30408298e+03  2.43601593e+03  2.43601593e+03
  2.43601593e+03  4.57480389e+03  4.57480389e+03  4.57480389e+03
  6.51181430e+03  8.52463709e+03  8.52463709e+03  8.52463709e+03
  2.21527627e+04  7.27347609e+04]
E1 = -728.6635965643213  E_coul = 202.91845112738443
cycle= 1 E= -525.745145436937  delta_E= 2.27e-13  |g|= 1.11e-07  |ddm|= 1.57e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.6635965643213  E_coul = 202.91845112738443
  HOMO = -0.515515177001588  LUMO = 2.30812383015216
  mo_energy =
[-1.18300004e+02 -1.20890500e+01 -9.42635145e+00 -9.42635145e+00
 -9.42635145e+00 -1.19869309e+00 -5.15515177e-01 -5.15515177e-01
 -5.15515177e-01  2.30812383e+00  2.30812383e+00  2.30812383e+00
  2.39922519e+01  2.39922519e+01  2.39922519e+01  1.33543763e+02
  1.45628466e+02  1.45628466e+02  1.45628466e+02  4.99294896e+02
  4.99294896e+02  4.99294896e+02  1.20393856e+03  1.20393856e+03
  1.20393856e+03  1.30408298e+03  2.43601593e+03  2.43601593e+03
  2.43601593e+03  4.57480389e+03  4.57480389e+03  4.57480389e+03
  6.51181430e+03  8.52463709e+03  8.52463709e+03  8.52463709e+03
  2.21527627e+04  7.27347609e+04]
E1 = -728.6635968249435  E_coul = 202.9184513880066
Extra cycle  E= -525.745145436937  delta_E=    0  |g|= 1.89e-08  |ddm|= 2.57e-08
    CPU time for scf_cycle      1.22 sec, wall time      0.32 sec
exp = [2.61843968e+04 7.59751264e+03 3.57698601e+03 9.75417479e+02
 1.85024721e+02 4.47831589e+01 4.57915649e+00 3.84349443e-01
 1.36267629e+03 6.56440879e+02 2.57701494e+02 2.76118505e+02
 6.18455238e+02 2.24848882e+01 9.35215022e+01 1.32196599e+00
 5.92937932e+00 3.56225205e-01]
grad_E = [-1.74956104e-06  6.17719916e-06 -1.61589792e-05  1.29050997e-03
 -1.24724337e-03 -1.88269899e-02 -2.88520261e-02 -9.23069706e-02
 -3.30572878e-08  3.52499189e-06  2.56782773e-05  2.35502816e-05
  3.93448916e-06  5.15521280e-02  4.53095931e-04 -1.02991619e-01
 -1.19861587e-01  5.62747606e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26187.2632454        1
[INPUT] 0    0    [1    /1   ]  7566.05766274        1
[INPUT] 0    0    [1    /1   ]  3514.42430348        1
[INPUT] 0    0    [1    /1   ]  4.89243348056e-08      1
[INPUT] 0    0    [1    /1   ]  98.4572288336        1
[INPUT] 0    0    [1    /1   ]  33.1532851538        1
[INPUT] 0    0    [1    /1   ]  4.5543031869         1
[INPUT] 0    0    [1    /1   ]  0.367150348172       1
[INPUT] 1    0    [1    /1   ]  1362.59508307        1
[INPUT] 1    0    [1    /1   ]  643.994625568        1
[INPUT] 1    0    [1    /1   ]  193.092027675        1
[INPUT] 1    0    [1    /1   ]  219.456001671        1
[INPUT] 1    0    [1    /1   ]  1391.03308944        1
[INPUT] 1    0    [1    /1   ]  33.9330290939        1
[INPUT] 1    0    [1    /1   ]  165.368736665        1
[INPUT] 1    0    [1    /1   ]  1.99144781905        1
[INPUT] 1    0    [1    /1   ]  7.74982468008        1
[INPUT] 1    0    [1    /1   ]  0.481963153855       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26187.263245364316, 1.0]], [0, [7566.057662735457, 1.0]], [0, [3514.424303481338, 1.0]], [0, [4.892433480563341e-08, 1.0]], [0, [98.45722883363474, 1.0]], [0, [33.153285153775876, 1.0]], [0, [4.554303186902005, 1.0]], [0, [0.36715034817156583, 1.0]], [1, [1362.5950830725408, 1.0]], [1, [643.994625568159, 1.0]], [1, [193.09202767548817, 1.0]], [1, [219.4560016710329, 1.0]], [1, [1391.0330894420592, 1.0]], [1, [33.93302909385003, 1.0]], [1, [165.3687366645679, 1.0]], [1, [1.991447819050658, 1.0]], [1, [7.749824680081381, 1.0]], [1, [0.48196315385549016, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26187.26324536]
bas 1, expnt(s) = [7566.05766274]
bas 2, expnt(s) = [3514.42430348]
bas 3, expnt(s) = [4.89243348e-08]
bas 4, expnt(s) = [98.45722883]
bas 5, expnt(s) = [33.15328515]
bas 6, expnt(s) = [4.55430319]
bas 7, expnt(s) = [0.36715035]
bas 8, expnt(s) = [1362.59508307]
bas 9, expnt(s) = [643.99462557]
bas 10, expnt(s) = [193.09202768]
bas 11, expnt(s) = [219.45600167]
bas 12, expnt(s) = [1391.03308944]
bas 13, expnt(s) = [33.93302909]
bas 14, expnt(s) = [165.36873666]
bas 15, expnt(s) = [1.99144782]
bas 16, expnt(s) = [7.74982468]
bas 17, expnt(s) = [0.48196315]
CPU time:       549.54
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61872632e+04 5.20094917e+03 7.56605766e+03 2.04959125e+03
 3.51442430e+03 1.15320275e+03 4.89243348e-08 8.31110409e-06
 9.84572288e+01 7.89679257e+01 3.31532852e+01 3.49067930e+01
 4.55430319e+00 7.87646737e+00 3.67150348e-01 1.19164798e+00
 1.36259508e+03 2.41514336e+04 6.43994626e+02 9.46427163e+03
 1.93092028e+02 2.09985749e+03 2.19456002e+02 2.46415896e+03
 1.39103309e+03 2.47831336e+04 3.39330291e+01 2.38925597e+02
 1.65368737e+02 1.73002012e+03 1.99144782e+00 6.90153280e+00
 7.74982468e+00 3.77223934e+01 4.81963154e-01 1.17152535e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.71549499382109
cond(S) = 807870.3868421721
E1 = -585.3106703410132  E_coul = 200.54659854566535
init E= -384.764071795348
    CPU time for initialize scf      0.21 sec, wall time      0.04 sec
  HOMO = -0.55945478085354  LUMO = -0.000100346899170528
  mo_energy =
[-1.06409910e+02 -1.12353526e+01 -9.52152718e+00 -9.52152718e+00
 -9.52152718e+00 -1.19231317e+00 -5.59454781e-01 -5.59454781e-01
 -5.59454781e-01 -1.00346899e-04  4.01807356e+00  4.01807356e+00
  4.01807356e+00  3.93780458e+01  3.93780458e+01  3.93780458e+01
  7.05227183e+01  2.07008593e+02  2.07008593e+02  2.07008593e+02
  6.08285463e+02  6.08285463e+02  6.08285463e+02  1.32473709e+03
  1.32473709e+03  1.32473709e+03  2.64773032e+03  2.64773032e+03
  2.64773032e+03  3.17422628e+03  5.30748156e+03  5.30748156e+03
  5.30748156e+03  1.03701135e+04  1.03701135e+04  1.03701135e+04
  1.83681243e+04  6.89587316e+04]
E1 = -702.557443116417  E_coul = 203.73916723137393
cycle= 1 E= -498.818275885043  delta_E= -114  |g|= 1.68  |ddm|= 24.7
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=2.88672
diis-c [-8.33317588  1.        ]
  HOMO = -0.397173348769686  LUMO = 7.35628150997771e-08
  mo_energy =
[-1.06601014e+02 -1.09673154e+01 -9.25693177e+00 -9.25693177e+00
 -9.25693177e+00 -1.00961255e+00 -3.97173349e-01 -3.97173349e-01
 -3.97173349e-01  7.35628151e-08  4.24330663e+00  4.24330663e+00
  4.24330663e+00  3.95675109e+01  3.95675109e+01  3.95675109e+01
  7.07315756e+01  2.07054846e+02  2.07054846e+02  2.07054846e+02
  6.08203209e+02  6.08203209e+02  6.08203209e+02  1.32448261e+03
  1.32448261e+03  1.32448261e+03  2.64715793e+03  2.64715793e+03
  2.64715793e+03  3.17253974e+03  5.30644553e+03  5.30644553e+03
  5.30644553e+03  1.03682451e+04  1.03682451e+04  1.03682451e+04
  1.83650357e+04  6.89550975e+04]
E1 = -702.3356999006581  E_coul = 203.51602209192677
cycle= 2 E= -498.819677808731  delta_E= -0.0014  |g|= 0.0106  |ddm|= 0.0697
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0252175
diis-c [-2.94655354e-04 -6.44075387e-03  1.00644075e+00]
  HOMO = -0.401687225924479  LUMO = 7.35619082725966e-08
  mo_energy =
[-1.06619710e+02 -1.09850664e+01 -9.27585398e+00 -9.27585398e+00
 -9.27585398e+00 -1.01514797e+00 -4.01687226e-01 -4.01687226e-01
 -4.01687226e-01  7.35619083e-08  4.23388621e+00  4.23388621e+00
  4.23388621e+00  3.95483153e+01  3.95483153e+01  3.95483153e+01
  7.07137100e+01  2.07035635e+02  2.07035635e+02  2.07035635e+02
  6.08184488e+02  6.08184488e+02  6.08184488e+02  1.32446410e+03
  1.32446410e+03  1.32446410e+03  2.64713928e+03  2.64713928e+03
  2.64713928e+03  3.17251892e+03  5.30642616e+03  5.30642616e+03
  5.30642616e+03  1.03682237e+04  1.03682237e+04  1.03682237e+04
  1.83650110e+04  6.89550712e+04]
E1 = -702.3508189700947  E_coul = 203.53113923303417
cycle= 3 E= -498.81967973706  delta_E= -1.93e-06  |g|= 0.00151  |ddm|= 0.00159
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00228948
diis-c [-9.16647311e-07 -5.78972069e-04  1.07409918e-01  8.93169054e-01]
  HOMO = -0.401534431199934  LUMO = 7.3561995389043e-08
  mo_energy =
[-1.06617410e+02 -1.09839632e+01 -9.27473758e+00 -9.27473758e+00
 -9.27473758e+00 -1.01495308e+00 -4.01534431e-01 -4.01534431e-01
 -4.01534431e-01  7.35619954e-08  4.23431467e+00  4.23431467e+00
  4.23431467e+00  3.95497727e+01  3.95497727e+01  3.95497727e+01
  7.07155593e+01  2.07037711e+02  2.07037711e+02  2.07037711e+02
  6.08186764e+02  6.08186764e+02  6.08186764e+02  1.32446646e+03
  1.32446646e+03  1.32446646e+03  2.64714170e+03  2.64714170e+03
  2.64714170e+03  3.17252135e+03  5.30642860e+03  5.30642860e+03
  5.30642860e+03  1.03682262e+04  1.03682262e+04  1.03682262e+04
  1.83650135e+04  6.89550737e+04]
E1 = -702.3487437699231  E_coul = 203.52906399827373
cycle= 4 E= -498.819679771649  delta_E= -3.46e-08  |g|= 4.81e-05  |ddm|= 0.000245
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00012612
diis-c [-9.69903313e-10  2.99999791e-05 -6.15397143e-03  6.63429049e-03
  9.99489681e-01]
  HOMO = -0.401537261162796  LUMO = 7.35619651341223e-08
  mo_energy =
[-1.06617462e+02 -1.09839717e+01 -9.27475196e+00 -9.27475196e+00
 -9.27475196e+00 -1.01495612e+00 -4.01537261e-01 -4.01537261e-01
 -4.01537261e-01  7.35619651e-08  4.23430878e+00  4.23430878e+00
  4.23430878e+00  3.95497492e+01  3.95497492e+01  3.95497492e+01
  7.07155376e+01  2.07037670e+02  2.07037670e+02  2.07037670e+02
  6.08186711e+02  6.08186711e+02  6.08186711e+02  1.32446640e+03
  1.32446640e+03  1.32446640e+03  2.64714162e+03  2.64714162e+03
  2.64714162e+03  3.17252125e+03  5.30642851e+03  5.30642851e+03
  5.30642851e+03  1.03682261e+04  1.03682261e+04  1.03682261e+04
  1.83650133e+04  6.89550735e+04]
E1 = -702.3487895525783  E_coul = 203.52910978088124
cycle= 5 E= -498.819679771697  delta_E= -4.77e-11  |g|= 3.6e-06  |ddm|= 6.9e-06
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -702.3487895525783  E_coul = 203.52910978088124
  HOMO = -0.401538023459755  LUMO = 7.35619442611649e-08
  mo_energy =
[-1.06617469e+02 -1.09839758e+01 -9.27475620e+00 -9.27475620e+00
 -9.27475620e+00 -1.01495707e+00 -4.01538023e-01 -4.01538023e-01
 -4.01538023e-01  7.35619443e-08  4.23430696e+00  4.23430696e+00
  4.23430696e+00  3.95497442e+01  3.95497442e+01  3.95497442e+01
  7.07155316e+01  2.07037663e+02  2.07037663e+02  2.07037663e+02
  6.08186704e+02  6.08186704e+02  6.08186704e+02  1.32446639e+03
  1.32446639e+03  1.32446639e+03  2.64714162e+03  2.64714162e+03
  2.64714162e+03  3.17252124e+03  5.30642850e+03  5.30642850e+03
  5.30642850e+03  1.03682261e+04  1.03682261e+04  1.03682261e+04
  1.83650133e+04  6.89550735e+04]
E1 = -702.3487957658083  E_coul = 203.529115994111
Extra cycle  E= -498.819679771697  delta_E= -2.27e-13  |g|= 5.78e-07  |ddm|= 6.36e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.19 sec
exp = [2.61872632e+04 7.56605766e+03 3.51442430e+03 4.89243348e-08
 9.84572288e+01 3.31532852e+01 4.55430319e+00 3.67150348e-01
 1.36259508e+03 6.43994626e+02 1.93092028e+02 2.19456002e+02
 1.39103309e+03 3.39330291e+01 1.65368737e+02 1.99144782e+00
 7.74982468e+00 4.81963154e-01]
E = -498.8196797716973
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26184.6834693        1
[INPUT] 0    0    [1    /1   ]  7594.36713991        1
[INPUT] 0    0    [1    /1   ]  3570.7298422         1
[INPUT] 0    0    [1    /1   ]  877.875731003        1
[INPUT] 0    0    [1    /1   ]  176.367971935        1
[INPUT] 0    0    [1    /1   ]  43.6201715057        1
[INPUT] 0    0    [1    /1   ]  4.57667116133        1
[INPUT] 0    0    [1    /1   ]  0.382629533299       1
[INPUT] 1    0    [1    /1   ]  1362.66817355        1
[INPUT] 1    0    [1    /1   ]  655.196253841        1
[INPUT] 1    0    [1    /1   ]  251.240547419        1
[INPUT] 1    0    [1    /1   ]  270.45225489         1
[INPUT] 1    0    [1    /1   ]  695.713022874        1
[INPUT] 1    0    [1    /1   ]  23.6297023097        1
[INPUT] 1    0    [1    /1   ]  100.706225616        1
[INPUT] 1    0    [1    /1   ]  1.38891416882        1
[INPUT] 1    0    [1    /1   ]  6.11142385635        1
[INPUT] 1    0    [1    /1   ]  0.368799000285       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26184.683469341744, 1.0]], [0, [7594.367139912013, 1.0]], [0, [3570.729842197894, 1.0]], [0, [877.8757310026241, 1.0]], [0, [176.36797193533036, 1.0]], [0, [43.62017150568435, 1.0]], [0, [4.576671161330562, 1.0]], [0, [0.38262953329872806, 1.0]], [1, [1362.6681735458371, 1.0]], [1, [655.1962538408517, 1.0]], [1, [251.24054741872766, 1.0]], [1, [270.4522548902587, 1.0]], [1, [695.7130228742687, 1.0]], [1, [23.62970230974495, 1.0]], [1, [100.70622561615934, 1.0]], [1, [1.3889141688187088, 1.0]], [1, [6.111423856351047, 1.0]], [1, [0.36879900028463763, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26184.68346934]
bas 1, expnt(s) = [7594.36713991]
bas 2, expnt(s) = [3570.7298422]
bas 3, expnt(s) = [877.875731]
bas 4, expnt(s) = [176.36797194]
bas 5, expnt(s) = [43.62017151]
bas 6, expnt(s) = [4.57667116]
bas 7, expnt(s) = [0.38262953]
bas 8, expnt(s) = [1362.66817355]
bas 9, expnt(s) = [655.19625384]
bas 10, expnt(s) = [251.24054742]
bas 11, expnt(s) = [270.45225489]
bas 12, expnt(s) = [695.71302287]
bas 13, expnt(s) = [23.62970231]
bas 14, expnt(s) = [100.70622562]
bas 15, expnt(s) = [1.38891417]
bas 16, expnt(s) = [6.11142386]
bas 17, expnt(s) = [0.368799]
CPU time:       550.17
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61846835e+04 5.20056490e+03 7.59436714e+03 2.05534020e+03
 3.57072984e+03 1.16703201e+03 8.77875731e+02 4.07464528e+02
 1.76367972e+02 1.22272788e+02 4.36201715e+01 4.28825449e+01
 4.57667116e+00 7.90546292e+00 3.82629533e-01 1.22913303e+00
 1.36266817e+03 2.41530529e+04 6.55196254e+02 9.67049377e+03
 2.51240547e+02 2.91807571e+03 2.70452255e+02 3.19961446e+03
 6.95713023e+02 1.04237037e+04 2.36297023e+01 1.51987267e+02
 1.00706226e+02 9.30689452e+02 1.38891417e+00 4.39874365e+00
 6.11142386e+00 2.80325367e+01 3.68799000e-01 8.38439174e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.89486821383165
cond(S) = 635781.0018762043
E1 = -727.4442189776425  E_coul = 202.7001413062803
init E= -524.744077671362
    CPU time for initialize scf      0.13 sec, wall time      0.04 sec
  HOMO = -0.553115275245049  LUMO = 2.42376312051607
  mo_energy =
[-1.18207227e+02 -1.21137436e+01 -9.44197246e+00 -9.44197246e+00
 -9.44197246e+00 -1.24328799e+00 -5.53115275e-01 -5.53115275e-01
 -5.53115275e-01  2.42376312e+00  2.42376312e+00  2.42376312e+00
  2.54786796e+01  2.54786796e+01  2.54786796e+01  1.26312635e+02
  1.54023881e+02  1.54023881e+02  1.54023881e+02  5.17352068e+02
  5.17352068e+02  5.17352068e+02  1.20054198e+03  1.22952812e+03
  1.22952812e+03  1.22952812e+03  2.48401393e+03  2.48401393e+03
  2.48401393e+03  4.69190865e+03  4.69190865e+03  4.69190865e+03
  6.21269948e+03  8.73845713e+03  8.73845713e+03  8.73845713e+03
  2.17600318e+04  7.23255324e+04]
E1 = -728.8118923483597  E_coul = 203.01456705096695
cycle= 1 E= -525.797325297393  delta_E= -1.05  |g|= 0.183  |ddm|= 1.64
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.494564
diis-c [-0.24459365  1.        ]
  HOMO = -0.505670418964648  LUMO = 2.47805396927507
  mo_energy =
[-1.18356721e+02 -1.20806818e+01 -9.41568154e+00 -9.41568154e+00
 -9.41568154e+00 -1.19006522e+00 -5.05670419e-01 -5.05670419e-01
 -5.05670419e-01  2.47805397e+00  2.47805397e+00  2.47805397e+00
  2.54858538e+01  2.54858538e+01  2.54858538e+01  1.26247604e+02
  1.53941809e+02  1.53941809e+02  1.53941809e+02  5.17221026e+02
  5.17221026e+02  5.17221026e+02  1.20025200e+03  1.22935124e+03
  1.22935124e+03  1.22935124e+03  2.48378516e+03  2.48378516e+03
  2.48378516e+03  4.69161585e+03  4.69161585e+03  4.69161585e+03
  6.21222468e+03  8.73805000e+03  8.73805000e+03  8.73805000e+03
  2.17594420e+04  7.23248503e+04]
E1 = -728.8092972799046  E_coul = 203.01169359054347
cycle= 2 E= -525.797603689361  delta_E= -0.000278  |g|= 0.0102  |ddm|= 0.0187
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0156342
diis-c [-1.98756311e-04  1.34860227e-02  9.86513977e-01]
  HOMO = -0.507302851492424  LUMO = 2.47608724838086
  mo_energy =
[-1.18345919e+02 -1.20819474e+01 -9.41701071e+00 -9.41701071e+00
 -9.41701071e+00 -1.19212916e+00 -5.07302851e-01 -5.07302851e-01
 -5.07302851e-01  2.47608725e+00  2.47608725e+00  2.47608725e+00
  2.54860155e+01  2.54860155e+01  2.54860155e+01  1.26256240e+02
  1.53948881e+02  1.53948881e+02  1.53948881e+02  5.17231251e+02
  5.17231251e+02  5.17231251e+02  1.20026521e+03  1.22936298e+03
  1.22936298e+03  1.22936298e+03  2.48379786e+03  2.48379786e+03
  2.48379786e+03  4.69162923e+03  4.69162923e+03  4.69162923e+03
  6.21223851e+03  8.73806370e+03  8.73806370e+03  8.73806370e+03
  2.17594558e+04  7.23248639e+04]
E1 = -728.8014814200056  E_coul = 203.0038769120089
cycle= 3 E= -525.797604507997  delta_E= -8.19e-07  |g|= 0.000764  |ddm|= 0.000493
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00157939
diis-c [-1.44897945e-07 -8.87096778e-04  7.56316235e-02  9.25255473e-01]
  HOMO = -0.507372322497143  LUMO = 2.47595743796235
  mo_energy =
[-1.18347225e+02 -1.20824347e+01 -9.41752620e+00 -9.41752620e+00
 -9.41752620e+00 -1.19221746e+00 -5.07372322e-01 -5.07372322e-01
 -5.07372322e-01  2.47595744e+00  2.47595744e+00  2.47595744e+00
  2.54854265e+01  2.54854265e+01  2.54854265e+01  1.26255140e+02
  1.53947816e+02  1.53947816e+02  1.53947816e+02  5.17229988e+02
  5.17229988e+02  5.17229988e+02  1.20026365e+03  1.22936160e+03
  1.22936160e+03  1.22936160e+03  2.48379639e+03  2.48379639e+03
  2.48379639e+03  4.69162766e+03  4.69162766e+03  4.69162766e+03
  6.21223676e+03  8.73806203e+03  8.73806203e+03  8.73806203e+03
  2.17594540e+04  7.23248621e+04]
E1 = -728.8028357244297  E_coul = 203.00523120535178
cycle= 4 E= -525.797604519078  delta_E= -1.11e-08  |g|= 3.76e-05  |ddm|= 0.000121
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=5.33549e-05
diis-c [-5.06789961e-10 -1.09014536e-06 -7.66940452e-04  2.29865790e-02
  9.77781452e-01]
  HOMO = -0.507358987208684  LUMO = 2.47597862579435
  mo_energy =
[-1.18347147e+02 -1.20823769e+01 -9.41746787e+00 -9.41746787e+00
 -9.41746787e+00 -1.19220027e+00 -5.07358987e-01 -5.07358987e-01
 -5.07358987e-01  2.47597863e+00  2.47597863e+00  2.47597863e+00
  2.54854855e+01  2.54854855e+01  2.54854855e+01  1.26255217e+02
  1.53947890e+02  1.53947890e+02  1.53947890e+02  5.17230066e+02
  5.17230066e+02  5.17230066e+02  1.20026372e+03  1.22936167e+03
  1.22936167e+03  1.22936167e+03  2.48379647e+03  2.48379647e+03
  2.48379647e+03  4.69162773e+03  4.69162773e+03  4.69162773e+03
  6.21223684e+03  8.73806210e+03  8.73806210e+03  8.73806210e+03
  2.17594540e+04  7.23248621e+04]
E1 = -728.8027354868631  E_coul = 203.0051309677378
cycle= 5 E= -525.797604519125  delta_E= -4.74e-11  |g|= 3.38e-06  |ddm|= 1.12e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -728.8027354868631  E_coul = 203.0051309677378
  HOMO = -0.507360077350219  LUMO = 2.47597689550092
  mo_energy =
[-1.18347155e+02 -1.20823817e+01 -9.41747282e+00 -9.41747282e+00
 -9.41747282e+00 -1.19220167e+00 -5.07360077e-01 -5.07360077e-01
 -5.07360077e-01  2.47597690e+00  2.47597690e+00  2.47597690e+00
  2.54854804e+01  2.54854804e+01  2.54854804e+01  1.26255210e+02
  1.53947883e+02  1.53947883e+02  1.53947883e+02  5.17230058e+02
  5.17230058e+02  5.17230058e+02  1.20026372e+03  1.22936167e+03
  1.22936167e+03  1.22936167e+03  2.48379646e+03  2.48379646e+03
  2.48379646e+03  4.69162773e+03  4.69162773e+03  4.69162773e+03
  6.21223683e+03  8.73806209e+03  8.73806209e+03  8.73806209e+03
  2.17594540e+04  7.23248621e+04]
E1 = -728.8027446940027  E_coul = 203.00514017487671
Extra cycle  E= -525.797604519126  delta_E= -7.96e-13  |g|= 6.48e-07  |ddm|= 9.72e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.18 sec
exp = [2.61846835e+04 7.59436714e+03 3.57072984e+03 8.77875731e+02
 1.76367972e+02 4.36201715e+01 4.57667116e+00 3.82629533e-01
 1.36266817e+03 6.55196254e+02 2.51240547e+02 2.70452255e+02
 6.95713023e+02 2.36297023e+01 1.00706226e+02 1.38891417e+00
 6.11142386e+00 3.68799000e-01]
E = -525.797604519126
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26184.6834693        1
[INPUT] 0    0    [1    /1   ]  7594.36713991        1
[INPUT] 0    0    [1    /1   ]  3570.7298422         1
[INPUT] 0    0    [1    /1   ]  877.875731003        1
[INPUT] 0    0    [1    /1   ]  176.367971935        1
[INPUT] 0    0    [1    /1   ]  43.6201715057        1
[INPUT] 0    0    [1    /1   ]  4.57667116133        1
[INPUT] 0    0    [1    /1   ]  0.382629533299       1
[INPUT] 1    0    [1    /1   ]  1362.66817355        1
[INPUT] 1    0    [1    /1   ]  655.196253841        1
[INPUT] 1    0    [1    /1   ]  251.240547419        1
[INPUT] 1    0    [1    /1   ]  270.45225489         1
[INPUT] 1    0    [1    /1   ]  695.713022874        1
[INPUT] 1    0    [1    /1   ]  23.6297023097        1
[INPUT] 1    0    [1    /1   ]  100.706225616        1
[INPUT] 1    0    [1    /1   ]  1.38891416882        1
[INPUT] 1    0    [1    /1   ]  6.11142385635        1
[INPUT] 1    0    [1    /1   ]  0.368799000285       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26184.683469341744, 1.0]], [0, [7594.367139912013, 1.0]], [0, [3570.729842197894, 1.0]], [0, [877.8757310026241, 1.0]], [0, [176.36797193533036, 1.0]], [0, [43.62017150568435, 1.0]], [0, [4.576671161330562, 1.0]], [0, [0.38262953329872806, 1.0]], [1, [1362.6681735458371, 1.0]], [1, [655.1962538408517, 1.0]], [1, [251.24054741872766, 1.0]], [1, [270.4522548902587, 1.0]], [1, [695.7130228742687, 1.0]], [1, [23.62970230974495, 1.0]], [1, [100.70622561615934, 1.0]], [1, [1.3889141688187088, 1.0]], [1, [6.111423856351047, 1.0]], [1, [0.36879900028463763, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26184.68346934]
bas 1, expnt(s) = [7594.36713991]
bas 2, expnt(s) = [3570.7298422]
bas 3, expnt(s) = [877.875731]
bas 4, expnt(s) = [176.36797194]
bas 5, expnt(s) = [43.62017151]
bas 6, expnt(s) = [4.57667116]
bas 7, expnt(s) = [0.38262953]
bas 8, expnt(s) = [1362.66817355]
bas 9, expnt(s) = [655.19625384]
bas 10, expnt(s) = [251.24054742]
bas 11, expnt(s) = [270.45225489]
bas 12, expnt(s) = [695.71302287]
bas 13, expnt(s) = [23.62970231]
bas 14, expnt(s) = [100.70622562]
bas 15, expnt(s) = [1.38891417]
bas 16, expnt(s) = [6.11142386]
bas 17, expnt(s) = [0.368799]
CPU time:       550.71
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61846835e+04 5.20056490e+03 7.59436714e+03 2.05534020e+03
 3.57072984e+03 1.16703201e+03 8.77875731e+02 4.07464528e+02
 1.76367972e+02 1.22272788e+02 4.36201715e+01 4.28825449e+01
 4.57667116e+00 7.90546292e+00 3.82629533e-01 1.22913303e+00
 1.36266817e+03 2.41530529e+04 6.55196254e+02 9.67049377e+03
 2.51240547e+02 2.91807571e+03 2.70452255e+02 3.19961446e+03
 6.95713023e+02 1.04237037e+04 2.36297023e+01 1.51987267e+02
 1.00706226e+02 9.30689452e+02 1.38891417e+00 4.39874365e+00
 6.11142386e+00 2.80325367e+01 3.68799000e-01 8.38439174e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.89486821383165
cond(S) = 635781.0018762043
E1 = -727.4442189776425  E_coul = 202.7001413062803
init E= -524.744077671362
    CPU time for initialize scf      0.15 sec, wall time      0.04 sec
  HOMO = -0.553115275245049  LUMO = 2.42376312051607
  mo_energy =
[-1.18207227e+02 -1.21137436e+01 -9.44197246e+00 -9.44197246e+00
 -9.44197246e+00 -1.24328799e+00 -5.53115275e-01 -5.53115275e-01
 -5.53115275e-01  2.42376312e+00  2.42376312e+00  2.42376312e+00
  2.54786796e+01  2.54786796e+01  2.54786796e+01  1.26312635e+02
  1.54023881e+02  1.54023881e+02  1.54023881e+02  5.17352068e+02
  5.17352068e+02  5.17352068e+02  1.20054198e+03  1.22952812e+03
  1.22952812e+03  1.22952812e+03  2.48401393e+03  2.48401393e+03
  2.48401393e+03  4.69190865e+03  4.69190865e+03  4.69190865e+03
  6.21269948e+03  8.73845713e+03  8.73845713e+03  8.73845713e+03
  2.17600318e+04  7.23255324e+04]
E1 = -728.8118923483597  E_coul = 203.01456705096695
cycle= 1 E= -525.797325297393  delta_E= -1.05  |g|= 0.183  |ddm|= 1.64
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.494564
diis-c [-0.24459365  1.        ]
  HOMO = -0.505670418964648  LUMO = 2.47805396927507
  mo_energy =
[-1.18356721e+02 -1.20806818e+01 -9.41568154e+00 -9.41568154e+00
 -9.41568154e+00 -1.19006522e+00 -5.05670419e-01 -5.05670419e-01
 -5.05670419e-01  2.47805397e+00  2.47805397e+00  2.47805397e+00
  2.54858538e+01  2.54858538e+01  2.54858538e+01  1.26247604e+02
  1.53941809e+02  1.53941809e+02  1.53941809e+02  5.17221026e+02
  5.17221026e+02  5.17221026e+02  1.20025200e+03  1.22935124e+03
  1.22935124e+03  1.22935124e+03  2.48378516e+03  2.48378516e+03
  2.48378516e+03  4.69161585e+03  4.69161585e+03  4.69161585e+03
  6.21222468e+03  8.73805000e+03  8.73805000e+03  8.73805000e+03
  2.17594420e+04  7.23248503e+04]
E1 = -728.8092972799046  E_coul = 203.01169359054347
cycle= 2 E= -525.797603689361  delta_E= -0.000278  |g|= 0.0102  |ddm|= 0.0187
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0156342
diis-c [-1.98756311e-04  1.34860227e-02  9.86513977e-01]
  HOMO = -0.507302851492424  LUMO = 2.47608724838086
  mo_energy =
[-1.18345919e+02 -1.20819474e+01 -9.41701071e+00 -9.41701071e+00
 -9.41701071e+00 -1.19212916e+00 -5.07302851e-01 -5.07302851e-01
 -5.07302851e-01  2.47608725e+00  2.47608725e+00  2.47608725e+00
  2.54860155e+01  2.54860155e+01  2.54860155e+01  1.26256240e+02
  1.53948881e+02  1.53948881e+02  1.53948881e+02  5.17231251e+02
  5.17231251e+02  5.17231251e+02  1.20026521e+03  1.22936298e+03
  1.22936298e+03  1.22936298e+03  2.48379786e+03  2.48379786e+03
  2.48379786e+03  4.69162923e+03  4.69162923e+03  4.69162923e+03
  6.21223851e+03  8.73806370e+03  8.73806370e+03  8.73806370e+03
  2.17594558e+04  7.23248639e+04]
E1 = -728.8014814200056  E_coul = 203.0038769120089
cycle= 3 E= -525.797604507997  delta_E= -8.19e-07  |g|= 0.000764  |ddm|= 0.000493
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00157939
diis-c [-1.44897945e-07 -8.87096778e-04  7.56316235e-02  9.25255473e-01]
  HOMO = -0.507372322497143  LUMO = 2.47595743796235
  mo_energy =
[-1.18347225e+02 -1.20824347e+01 -9.41752620e+00 -9.41752620e+00
 -9.41752620e+00 -1.19221746e+00 -5.07372322e-01 -5.07372322e-01
 -5.07372322e-01  2.47595744e+00  2.47595744e+00  2.47595744e+00
  2.54854265e+01  2.54854265e+01  2.54854265e+01  1.26255140e+02
  1.53947816e+02  1.53947816e+02  1.53947816e+02  5.17229988e+02
  5.17229988e+02  5.17229988e+02  1.20026365e+03  1.22936160e+03
  1.22936160e+03  1.22936160e+03  2.48379639e+03  2.48379639e+03
  2.48379639e+03  4.69162766e+03  4.69162766e+03  4.69162766e+03
  6.21223676e+03  8.73806203e+03  8.73806203e+03  8.73806203e+03
  2.17594540e+04  7.23248621e+04]
E1 = -728.8028357244297  E_coul = 203.00523120535178
cycle= 4 E= -525.797604519078  delta_E= -1.11e-08  |g|= 3.76e-05  |ddm|= 0.000121
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=5.33549e-05
diis-c [-5.06789961e-10 -1.09014536e-06 -7.66940452e-04  2.29865790e-02
  9.77781452e-01]
  HOMO = -0.507358987208684  LUMO = 2.47597862579435
  mo_energy =
[-1.18347147e+02 -1.20823769e+01 -9.41746787e+00 -9.41746787e+00
 -9.41746787e+00 -1.19220027e+00 -5.07358987e-01 -5.07358987e-01
 -5.07358987e-01  2.47597863e+00  2.47597863e+00  2.47597863e+00
  2.54854855e+01  2.54854855e+01  2.54854855e+01  1.26255217e+02
  1.53947890e+02  1.53947890e+02  1.53947890e+02  5.17230066e+02
  5.17230066e+02  5.17230066e+02  1.20026372e+03  1.22936167e+03
  1.22936167e+03  1.22936167e+03  2.48379647e+03  2.48379647e+03
  2.48379647e+03  4.69162773e+03  4.69162773e+03  4.69162773e+03
  6.21223684e+03  8.73806210e+03  8.73806210e+03  8.73806210e+03
  2.17594540e+04  7.23248621e+04]
E1 = -728.8027354868631  E_coul = 203.0051309677378
cycle= 5 E= -525.797604519125  delta_E= -4.74e-11  |g|= 3.38e-06  |ddm|= 1.12e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.8027354868631  E_coul = 203.0051309677378
  HOMO = -0.507360077350219  LUMO = 2.47597689550092
  mo_energy =
[-1.18347155e+02 -1.20823817e+01 -9.41747282e+00 -9.41747282e+00
 -9.41747282e+00 -1.19220167e+00 -5.07360077e-01 -5.07360077e-01
 -5.07360077e-01  2.47597690e+00  2.47597690e+00  2.47597690e+00
  2.54854804e+01  2.54854804e+01  2.54854804e+01  1.26255210e+02
  1.53947883e+02  1.53947883e+02  1.53947883e+02  5.17230058e+02
  5.17230058e+02  5.17230058e+02  1.20026372e+03  1.22936167e+03
  1.22936167e+03  1.22936167e+03  2.48379646e+03  2.48379646e+03
  2.48379646e+03  4.69162773e+03  4.69162773e+03  4.69162773e+03
  6.21223683e+03  8.73806209e+03  8.73806209e+03  8.73806209e+03
  2.17594540e+04  7.23248621e+04]
E1 = -728.8027446940027  E_coul = 203.00514017487671
Extra cycle  E= -525.797604519126  delta_E= -7.96e-13  |g|= 6.48e-07  |ddm|= 9.72e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.20 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 635781.0018762043
E1 = -728.8027446940027  E_coul = 203.00514017487671
init E= -525.797604519126
    CPU time for initialize scf      0.96 sec, wall time      0.18 sec
  HOMO = -0.507359951454947  LUMO = 2.47597710913658
  mo_energy =
[-1.18347153e+02 -1.20823810e+01 -9.41747213e+00 -9.41747213e+00
 -9.41747213e+00 -1.19220151e+00 -5.07359951e-01 -5.07359951e-01
 -5.07359951e-01  2.47597711e+00  2.47597711e+00  2.47597711e+00
  2.54854812e+01  2.54854812e+01  2.54854812e+01  1.26255211e+02
  1.53947884e+02  1.53947884e+02  1.53947884e+02  5.17230060e+02
  5.17230060e+02  5.17230060e+02  1.20026372e+03  1.22936167e+03
  1.22936167e+03  1.22936167e+03  2.48379646e+03  2.48379646e+03
  2.48379646e+03  4.69162773e+03  4.69162773e+03  4.69162773e+03
  6.21223683e+03  8.73806209e+03  8.73806209e+03  8.73806209e+03
  2.17594540e+04  7.23248621e+04]
E1 = -728.8027432084298  E_coul = 203.0051386893037
cycle= 1 E= -525.797604519126  delta_E=    0  |g|= 1.09e-07  |ddm|= 1.47e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.8027432084298  E_coul = 203.0051386893037
  HOMO = -0.507359970996634  LUMO = 2.47597707575714
  mo_energy =
[-1.18347154e+02 -1.20823811e+01 -9.41747224e+00 -9.41747224e+00
 -9.41747224e+00 -1.19220154e+00 -5.07359971e-01 -5.07359971e-01
 -5.07359971e-01  2.47597708e+00  2.47597708e+00  2.47597708e+00
  2.54854810e+01  2.54854810e+01  2.54854810e+01  1.26255211e+02
  1.53947884e+02  1.53947884e+02  1.53947884e+02  5.17230059e+02
  5.17230059e+02  5.17230059e+02  1.20026372e+03  1.22936167e+03
  1.22936167e+03  1.22936167e+03  2.48379646e+03  2.48379646e+03
  2.48379646e+03  4.69162773e+03  4.69162773e+03  4.69162773e+03
  6.21223683e+03  8.73806209e+03  8.73806209e+03  8.73806209e+03
  2.17594540e+04  7.23248621e+04]
E1 = -728.8027434524457  E_coul = 203.00513893331984
Extra cycle  E= -525.797604519126  delta_E= 1.14e-13  |g|= 1.83e-08  |ddm|= 2.37e-08
    CPU time for scf_cycle      1.06 sec, wall time      0.29 sec
exp = [2.61846835e+04 7.59436714e+03 3.57072984e+03 8.77875731e+02
 1.76367972e+02 4.36201715e+01 4.57667116e+00 3.82629533e-01
 1.36266817e+03 6.55196254e+02 2.51240547e+02 2.70452255e+02
 6.95713023e+02 2.36297023e+01 1.00706226e+02 1.38891417e+00
 6.11142386e+00 3.68799000e-01]
grad_E = [-1.45343665e-06  2.75883966e-06 -1.67946143e-05  1.19230983e-03
  3.49910157e-04 -2.19087568e-02 -3.32900988e-02 -1.06558900e-01
 -6.98023006e-08  2.64104451e-06  2.20526173e-05  2.01575441e-05
  2.36619379e-06  5.90266000e-02  1.66461661e-04 -1.04872788e-01
 -1.51284952e-01  6.55166541e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26187.2669792        1
[INPUT] 0    0    [1    /1   ]  7566.07072848        1
[INPUT] 0    0    [1    /1   ]  3514.52913737        1
[INPUT] 0    0    [1    /1   ]  2.45293335865e-07      1
[INPUT] 0    0    [1    /1   ]  69.2141028097        1
[INPUT] 0    0    [1    /1   ]  29.8525020324        1
[INPUT] 0    0    [1    /1   ]  4.59193977871        1
[INPUT] 0    0    [1    /1   ]  0.380005389916       1
[INPUT] 1    0    [1    /1   ]  1362.86212043        1
[INPUT] 1    0    [1    /1   ]  646.237325222        1
[INPUT] 1    0    [1    /1   ]  205.805184145        1
[INPUT] 1    0    [1    /1   ]  230.68998209         1
[INPUT] 1    0    [1    /1   ]  1120.62011408        1
[INPUT] 1    0    [1    /1   ]  14.9338401563        1
[INPUT] 1    0    [1    /1   ]  96.6592619095        1
[INPUT] 1    0    [1    /1   ]  1.67423050485        1
[INPUT] 1    0    [1    /1   ]  2.92546589365        1
[INPUT] 1    0    [1    /1   ]  0.324471030261       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26187.266979171538, 1.0]], [0, [7566.070728484108, 1.0]], [0, [3514.529137370765, 1.0]], [0, [2.4529333586542634e-07, 1.0]], [0, [69.21410280970434, 1.0]], [0, [29.85250203239132, 1.0]], [0, [4.591939778714671, 1.0]], [0, [0.3800053899161792, 1.0]], [1, [1362.862120425839, 1.0]], [1, [646.237325221816, 1.0]], [1, [205.80518414462617, 1.0]], [1, [230.6899820904832, 1.0]], [1, [1120.620114080057, 1.0]], [1, [14.933840156255377, 1.0]], [1, [96.6592619094529, 1.0]], [1, [1.6742305048520156, 1.0]], [1, [2.925465893648332, 1.0]], [1, [0.3244710302607453, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26187.26697917]
bas 1, expnt(s) = [7566.07072848]
bas 2, expnt(s) = [3514.52913737]
bas 3, expnt(s) = [2.45293336e-07]
bas 4, expnt(s) = [69.21410281]
bas 5, expnt(s) = [29.85250203]
bas 6, expnt(s) = [4.59193978]
bas 7, expnt(s) = [0.38000539]
bas 8, expnt(s) = [1362.86212043]
bas 9, expnt(s) = [646.23732522]
bas 10, expnt(s) = [205.80518414]
bas 11, expnt(s) = [230.68998209]
bas 12, expnt(s) = [1120.62011408]
bas 13, expnt(s) = [14.93384016]
bas 14, expnt(s) = [96.65926191]
bas 15, expnt(s) = [1.6742305]
bas 16, expnt(s) = [2.92546589]
bas 17, expnt(s) = [0.32447103]
CPU time:       556.45
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61872670e+04 5.20094973e+03 7.56607073e+03 2.04959391e+03
 3.51452914e+03 1.15322855e+03 2.45293336e-07 2.78470591e-05
 6.92141028e+01 6.06262868e+01 2.98525020e+01 3.22664047e+01
 4.59193978e+00 7.92523524e+00 3.80005390e-01 1.22280538e+00
 1.36286212e+03 2.41573501e+04 6.46237325e+02 9.50548849e+03
 2.05805184e+02 2.27407498e+03 2.30689982e+02 2.62283102e+03
 1.12062011e+03 1.89150463e+04 1.49338402e+01 8.56443595e+01
 9.66592619e+01 8.84176027e+02 1.67423050e+00 5.55588766e+00
 2.92546589e+00 1.11616446e+01 3.24471030e-01 7.14421149e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.846186721061294
cond(S) = 39908.347374332705
E1 = -471.5407260990862  E_coul = 198.28383113182878
init E= -273.256894967257
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.623197281434089  LUMO = -0.00012119438298731
  mo_energy =
[-9.95517799e+01 -1.06032697e+01 -9.53469748e+00 -9.53469748e+00
 -9.53469748e+00 -1.13981918e+00 -6.23197281e-01 -6.23197281e-01
 -6.23197281e-01 -1.21194383e-04  2.14458099e+00  2.14458099e+00
  2.14458099e+00  1.31413285e+01  1.31413285e+01  1.31413285e+01
  5.51315209e+01  1.12106371e+02  1.12106371e+02  1.12106371e+02
  4.44512508e+02  4.44512508e+02  4.44512508e+02  1.10098562e+03
  1.10098562e+03  1.10098562e+03  2.36471501e+03  2.36471501e+03
  2.36471501e+03  3.08063560e+03  4.85849817e+03  4.85849817e+03
  4.85849817e+03  9.50253137e+03  9.50253137e+03  9.50253137e+03
  1.82837582e+04  6.88817327e+04]
E1 = -681.2242206913704  E_coul = 199.15760024666935
cycle= 1 E= -482.066620444701  delta_E= -209  |g|= 2.12  |ddm|= 1.64
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=3.65594
diis-c [-13.36586948   1.        ]
  HOMO = -0.542786537302414  LUMO = 3.69823141093148e-07
  mo_energy =
[-1.00025618e+02 -1.04932636e+01 -9.41977214e+00 -9.41977214e+00
 -9.41977214e+00 -1.04930406e+00 -5.42786537e-01 -5.42786537e-01
 -5.42786537e-01  3.69823141e-07  2.23979509e+00  2.23979509e+00
  2.23979509e+00  1.32422365e+01  1.32422365e+01  1.32422365e+01
  5.52466756e+01  1.12016681e+02  1.12016681e+02  1.12016681e+02
  4.44276410e+02  4.44276410e+02  4.44276410e+02  1.10050665e+03
  1.10050665e+03  1.10050665e+03  2.36382656e+03  2.36382656e+03
  2.36382656e+03  3.07836810e+03  4.85705680e+03  4.85705680e+03
  4.85705680e+03  9.50004404e+03  9.50004404e+03  9.50004404e+03
  1.82795742e+04  6.88768402e+04]
E1 = -680.7103029431205  E_coul = 198.64113322755654
cycle= 2 E= -482.069169715564  delta_E= -0.00255  |g|= 0.0248  |ddm|= 0.124
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0564106
diis-c [-0.00251411 -0.00712077  1.00712077]
  HOMO = -0.55282549805095  LUMO = 3.69790834886471e-07
  mo_energy =
[-1.00080466e+02 -1.05319336e+01 -9.46077958e+00 -9.46077958e+00
 -9.46077958e+00 -1.06265580e+00 -5.52825498e-01 -5.52825498e-01
 -5.52825498e-01  3.69790835e-07  2.22547854e+00  2.22547854e+00
  2.22547854e+00  1.32090975e+01  1.32090975e+01  1.32090975e+01
  5.52013592e+01  1.11964730e+02  1.11964730e+02  1.11964730e+02
  4.44221678e+02  4.44221678e+02  4.44221678e+02  1.10044999e+03
  1.10044999e+03  1.10044999e+03  2.36376798e+03  2.36376798e+03
  2.36376798e+03  3.07830431e+03  4.85699608e+03  4.85699608e+03
  4.85699608e+03  9.49998006e+03  9.49998006e+03  9.49998006e+03
  1.82795049e+04  6.88767687e+04]
E1 = -680.7865642030417  E_coul = 198.71737159981296
cycle= 3 E= -482.069192603229  delta_E= -2.29e-05  |g|= 0.00533  |ddm|= 0.0127
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00876096
diis-c [-1.88728731e-06 -8.29643895e-04  1.47350691e-01  8.53478953e-01]
  HOMO = -0.551827728647798  LUMO = 3.69794216917552e-07
  mo_energy =
[-1.00071458e+02 -1.05268564e+01 -9.45555026e+00 -9.45555026e+00
 -9.45555026e+00 -1.06126261e+00 -5.51827729e-01 -5.51827729e-01
 -5.51827729e-01  3.69794217e-07  2.22699210e+00  2.22699210e+00
  2.22699210e+00  1.32131050e+01  1.32131050e+01  1.32131050e+01
  5.52083322e+01  1.11972716e+02  1.11972716e+02  1.11972716e+02
  4.44230684e+02  4.44230684e+02  4.44230684e+02  1.10045942e+03
  1.10045942e+03  1.10045942e+03  2.36377770e+03  2.36377770e+03
  2.36377770e+03  3.07831433e+03  4.85700597e+03  4.85700597e+03
  4.85700597e+03  9.49999006e+03  9.49999006e+03  9.49999006e+03
  1.82795150e+04  6.88767788e+04]
E1 = -680.7753151821613  E_coul = 198.70612184939887
cycle= 4 E= -482.069193332762  delta_E= -7.3e-07  |g|= 0.000104  |ddm|= 0.00153
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000274543
diis-c [-8.95262716e-09  2.92029396e-05 -6.65840872e-03 -9.03283932e-03
  1.01566205e+00]
  HOMO = -0.551800602975342  LUMO = 3.69794320418376e-07
  mo_energy =
[-1.00071485e+02 -1.05267834e+01 -9.45548926e+00 -9.45548926e+00
 -9.45548926e+00 -1.06122511e+00 -5.51800603e-01 -5.51800603e-01
 -5.51800603e-01  3.69794320e-07  2.22702851e+00  2.22702851e+00
  2.22702851e+00  1.32131618e+01  1.32131618e+01  1.32131618e+01
  5.52083755e+01  1.11972712e+02  1.11972712e+02  1.11972712e+02
  4.44230654e+02  4.44230654e+02  4.44230654e+02  1.10045937e+03
  1.10045937e+03  1.10045937e+03  2.36377762e+03  2.36377762e+03
  2.36377762e+03  3.07831420e+03  4.85700588e+03  4.85700588e+03
  4.85700588e+03  9.49998994e+03  9.49998994e+03  9.49998994e+03
  1.82795149e+04  6.88767787e+04]
E1 = -680.7753148989559  E_coul = 198.7061215660388
cycle= 5 E= -482.069193332917  delta_E= -1.55e-10  |g|= 1.57e-05  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -680.7753148989559  E_coul = 198.7061215660388
  HOMO = -0.551807036640635  LUMO = 3.69794280346908e-07
  mo_energy =
[-1.00071523e+02 -1.05268096e+01 -9.45551622e+00 -9.45551622e+00
 -9.45551622e+00 -1.06123387e+00 -5.51807037e-01 -5.51807037e-01
 -5.51807037e-01  3.69794280e-07  2.22701922e+00  2.22701922e+00
  2.22701922e+00  1.32131402e+01  1.32131402e+01  1.32131402e+01
  5.52083441e+01  1.11972677e+02  1.11972677e+02  1.11972677e+02
  4.44230617e+02  4.44230617e+02  4.44230617e+02  1.10045933e+03
  1.10045933e+03  1.10045933e+03  2.36377758e+03  2.36377758e+03
  2.36377758e+03  3.07831417e+03  4.85700584e+03  4.85700584e+03
  4.85700584e+03  9.49998990e+03  9.49998990e+03  9.49998990e+03
  1.82795148e+04  6.88767786e+04]
E1 = -680.7753649105001  E_coul = 198.70617157757133
Extra cycle  E= -482.069193332929  delta_E= -1.17e-11  |g|= 3.36e-06  |ddm|= 8.18e-06
    CPU time for scf_cycle      0.28 sec, wall time      0.19 sec
exp = [2.61872670e+04 7.56607073e+03 3.51452914e+03 2.45293336e-07
 6.92141028e+01 2.98525020e+01 4.59193978e+00 3.80005390e-01
 1.36286212e+03 6.46237325e+02 2.05805184e+02 2.30689982e+02
 1.12062011e+03 1.49338402e+01 9.66592619e+01 1.67423050e+00
 2.92546589e+00 3.24471030e-01]
E = -482.06919333292876
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26184.9418203        1
[INPUT] 0    0    [1    /1   ]  7591.53749877        1
[INPUT] 0    0    [1    /1   ]  3565.10977172        1
[INPUT] 0    0    [1    /1   ]  790.088157927        1
[INPUT] 0    0    [1    /1   ]  165.652585023        1
[INPUT] 0    0    [1    /1   ]  42.2434045584        1
[INPUT] 0    0    [1    /1   ]  4.57819802307        1
[INPUT] 0    0    [1    /1   ]  0.38236711896        1
[INPUT] 1    0    [1    /1   ]  1362.68756823        1
[INPUT] 1    0    [1    /1   ]  654.300360979        1
[INPUT] 1    0    [1    /1   ]  246.697011091        1
[INPUT] 1    0    [1    /1   ]  266.47602761         1
[INPUT] 1    0    [1    /1   ]  738.203731995        1
[INPUT] 1    0    [1    /1   ]  22.7601160944        1
[INPUT] 1    0    [1    /1   ]  100.301529245        1
[INPUT] 1    0    [1    /1   ]  1.41744580242        1
[INPUT] 1    0    [1    /1   ]  5.79282806008        1
[INPUT] 1    0    [1    /1   ]  0.364366203282       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26184.941820324722, 1.0]], [0, [7591.537498769222, 1.0]], [0, [3565.109771715181, 1.0]], [0, [790.088157926891, 1.0]], [0, [165.65258502276777, 1.0]], [0, [42.243404558355046, 1.0]], [0, [4.578198023068973, 1.0]], [0, [0.38236711896047315, 1.0]], [1, [1362.6875682338373, 1.0]], [1, [654.3003609789481, 1.0]], [1, [246.6970110913175, 1.0]], [1, [266.47602761028116, 1.0]], [1, [738.2037319948475, 1.0]], [1, [22.760116094395993, 1.0]], [1, [100.3015292454887, 1.0]], [1, [1.4174458024220395, 1.0]], [1, [5.792828060080776, 1.0]], [1, [0.3643662032822484, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26184.94182032]
bas 1, expnt(s) = [7591.53749877]
bas 2, expnt(s) = [3565.10977172]
bas 3, expnt(s) = [790.08815793]
bas 4, expnt(s) = [165.65258502]
bas 5, expnt(s) = [42.24340456]
bas 6, expnt(s) = [4.57819802]
bas 7, expnt(s) = [0.38236712]
bas 8, expnt(s) = [1362.68756823]
bas 9, expnt(s) = [654.30036098]
bas 10, expnt(s) = [246.69701109]
bas 11, expnt(s) = [266.47602761]
bas 12, expnt(s) = [738.20373199]
bas 13, expnt(s) = [22.76011609]
bas 14, expnt(s) = [100.30152925]
bas 15, expnt(s) = [1.4174458]
bas 16, expnt(s) = [5.79282806]
bas 17, expnt(s) = [0.3643662]
CPU time:       557.01
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61849418e+04 5.20060338e+03 7.59153750e+03 2.05476581e+03
 3.56510977e+03 1.16565412e+03 7.90088158e+02 3.76505815e+02
 1.65652585e+02 1.16657775e+02 4.22434046e+01 4.18633722e+01
 4.57819802e+00 7.90744089e+00 3.82367119e-01 1.22850076e+00
 1.36268757e+03 2.41534827e+04 6.54300361e+02 9.65396772e+03
 2.46697011e+02 2.85226092e+03 2.66476028e+02 3.14092144e+03
 7.38203732e+02 1.12254740e+04 2.27601161e+01 1.45028209e+02
 1.00301529e+02 9.26016736e+02 1.41744580e+00 4.51198316e+00
 5.79282806e+00 2.62178872e+01 3.64366203e-01 8.25861084e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.901023047381592
cond(S) = 264220.017352224
E1 = -727.4895661347667  E_coul = 202.6869437986081
init E= -524.802622336159
    CPU time for initialize scf      0.13 sec, wall time      0.04 sec
  HOMO = -0.552210626737767  LUMO = 2.42763716095488
  mo_energy =
[-1.18245195e+02 -1.21169862e+01 -9.44328871e+00 -9.44328871e+00
 -9.44328871e+00 -1.24183279e+00 -5.52210627e-01 -5.52210627e-01
 -5.52210627e-01  2.42763716e+00  2.42763716e+00  2.42763716e+00
  2.41456254e+01  2.41456254e+01  2.41456254e+01  1.17675498e+02
  1.50082263e+02  1.50082263e+02  1.50082263e+02  5.11119601e+02
  5.11119601e+02  5.11119601e+02  1.09526022e+03  1.22039942e+03
  1.22039942e+03  1.22039942e+03  2.48094926e+03  2.48094926e+03
  2.48094926e+03  4.72266149e+03  4.72266149e+03  4.72266149e+03
  5.92371364e+03  8.82399921e+03  8.82399921e+03  8.82399921e+03
  2.13933440e+04  7.19483240e+04]
E1 = -728.4603766306325  E_coul = 202.5944443097625
cycle= 1 E= -525.86593232087  delta_E= -1.06  |g|= 0.202  |ddm|= 2.07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.54068
diis-c [-0.29233481  1.        ]
  HOMO = -0.511356368631  LUMO = 2.47217955627887
  mo_energy =
[-1.18453248e+02 -1.21124894e+01 -9.44661314e+00 -9.44661314e+00
 -9.44661314e+00 -1.19629128e+00 -5.11356369e-01 -5.11356369e-01
 -5.11356369e-01  2.47217956e+00  2.47217956e+00  2.47217956e+00
  2.41236344e+01  2.41236344e+01  2.41236344e+01  1.17561579e+02
  1.49948430e+02  1.49948430e+02  1.49948430e+02  5.10930407e+02
  5.10930407e+02  5.10930407e+02  1.09492136e+03  1.22016201e+03
  1.22016201e+03  1.22016201e+03  2.48065791e+03  2.48065791e+03
  2.48065791e+03  4.72230537e+03  4.72230537e+03  4.72230537e+03
  5.92318214e+03  8.82353040e+03  8.82353040e+03  8.82353040e+03
  2.13926948e+04  7.19475832e+04]
E1 = -728.5345781610459  E_coul = 202.66828419443294
cycle= 2 E= -525.866293966613  delta_E= -0.000362  |g|= 0.0162  |ddm|= 0.0175
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0263061
diis-c [-4.50214933e-04  2.79765662e-02  9.72023434e-01]
  HOMO = -0.512077801220506  LUMO = 2.47181003504461
  mo_energy =
[-1.18431245e+02 -1.21083068e+01 -9.44235869e+00 -9.44235869e+00
 -9.44235869e+00 -1.19717807e+00 -5.12077801e-01 -5.12077801e-01
 -5.12077801e-01  2.47181004e+00  2.47181004e+00  2.47181004e+00
  2.41295496e+01  2.41295496e+01  2.41295496e+01  1.17579808e+02
  1.49965076e+02  1.49965076e+02  1.49965076e+02  5.10951562e+02
  5.10951562e+02  5.10951562e+02  1.09494666e+03  1.22018532e+03
  1.22018532e+03  1.22018532e+03  2.48068263e+03  2.48068263e+03
  2.48068263e+03  4.72233109e+03  4.72233109e+03  4.72233109e+03
  5.92320874e+03  8.82355675e+03  8.82355675e+03  8.82355675e+03
  2.13927216e+04  7.19476099e+04]
E1 = -728.51414398491  E_coul = 202.647847127578
cycle= 3 E= -525.866296857332  delta_E= -2.89e-06  |g|= 0.00144  |ddm|= 0.00151
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00286101
diis-c [-2.46761009e-07 -1.06833143e-03  8.42348718e-02  9.16833460e-01]
  HOMO = -0.512290462648111  LUMO = 2.47144757650499
  mo_energy =
[-1.18433793e+02 -1.21094791e+01 -9.44358055e+00 -9.44358055e+00
 -9.44358055e+00 -1.19745042e+00 -5.12290463e-01 -5.12290463e-01
 -5.12290463e-01  2.47144758e+00  2.47144758e+00  2.47144758e+00
  2.41282497e+01  2.41282497e+01  2.41282497e+01  1.17577626e+02
  1.49962927e+02  1.49962927e+02  1.49962927e+02  5.10949085e+02
  5.10949085e+02  5.10949085e+02  1.09494376e+03  1.22018265e+03
  1.22018265e+03  1.22018265e+03  2.48067983e+03  2.48067983e+03
  2.48067983e+03  4.72232816e+03  4.72232816e+03  4.72232816e+03
  5.92320557e+03  8.82355366e+03  8.82355366e+03  8.82355366e+03
  2.13927183e+04  7.19476066e+04]
E1 = -728.5169155221181  E_coul = 202.6506186192448
cycle= 4 E= -525.866296902873  delta_E= -4.55e-08  |g|= 4.85e-05  |ddm|= 0.000261
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.72222e-05
diis-c [-7.64199075e-10  3.68748070e-07 -1.08822242e-03  1.13383715e-02
  9.89749482e-01]
  HOMO = -0.512273361087669  LUMO = 2.47147491824261
  mo_energy =
[-1.18433695e+02 -1.21094046e+01 -9.44350561e+00 -9.44350561e+00
 -9.44350561e+00 -1.19742830e+00 -5.12273361e-01 -5.12273361e-01
 -5.12273361e-01  2.47147492e+00  2.47147492e+00  2.47147492e+00
  2.41283244e+01  2.41283244e+01  2.41283244e+01  1.17577723e+02
  1.49963020e+02  1.49963020e+02  1.49963020e+02  5.10949182e+02
  5.10949182e+02  5.10949182e+02  1.09494385e+03  1.22018275e+03
  1.22018275e+03  1.22018275e+03  2.48067993e+03  2.48067993e+03
  2.48067993e+03  4.72232825e+03  4.72232825e+03  4.72232825e+03
  5.92320566e+03  8.82355375e+03  8.82355375e+03  8.82355375e+03
  2.13927184e+04  7.19476066e+04]
E1 = -728.5167887888152  E_coul = 202.65049188586275
cycle= 5 E= -525.866296902953  delta_E= -7.92e-11  |g|= 3.89e-06  |ddm|= 1.42e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.5167887888152  E_coul = 202.65049188586275
  HOMO = -0.512274683871913  LUMO = 2.47147283399199
  mo_energy =
[-1.18433704e+02 -1.21094104e+01 -9.44351149e+00 -9.44351149e+00
 -9.44351149e+00 -1.19743000e+00 -5.12274684e-01 -5.12274684e-01
 -5.12274684e-01  2.47147283e+00  2.47147283e+00  2.47147283e+00
  2.41283185e+01  2.41283185e+01  2.41283185e+01  1.17577714e+02
  1.49963012e+02  1.49963012e+02  1.49963012e+02  5.10949174e+02
  5.10949174e+02  5.10949174e+02  1.09494384e+03  1.22018274e+03
  1.22018274e+03  1.22018274e+03  2.48067992e+03  2.48067992e+03
  2.48067992e+03  4.72232824e+03  4.72232824e+03  4.72232824e+03
  5.92320565e+03  8.82355374e+03  8.82355374e+03  8.82355374e+03
  2.13927184e+04  7.19476066e+04]
E1 = -728.5167994877143  E_coul = 202.6505025847618
Extra cycle  E= -525.866296902952  delta_E= 1.14e-13  |g|= 7.61e-07  |ddm|= 1.13e-06
    CPU time for scf_cycle      0.29 sec, wall time      0.20 sec
exp = [2.61849418e+04 7.59153750e+03 3.56510977e+03 7.90088158e+02
 1.65652585e+02 4.22434046e+01 4.57819802e+00 3.82367119e-01
 1.36268757e+03 6.54300361e+02 2.46697011e+02 2.66476028e+02
 7.38203732e+02 2.27601161e+01 1.00301529e+02 1.41744580e+00
 5.79282806e+00 3.64366203e-01]
E = -525.8662969029524
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26184.9418203        1
[INPUT] 0    0    [1    /1   ]  7591.53749877        1
[INPUT] 0    0    [1    /1   ]  3565.10977172        1
[INPUT] 0    0    [1    /1   ]  790.088157927        1
[INPUT] 0    0    [1    /1   ]  165.652585023        1
[INPUT] 0    0    [1    /1   ]  42.2434045584        1
[INPUT] 0    0    [1    /1   ]  4.57819802307        1
[INPUT] 0    0    [1    /1   ]  0.38236711896        1
[INPUT] 1    0    [1    /1   ]  1362.68756823        1
[INPUT] 1    0    [1    /1   ]  654.300360979        1
[INPUT] 1    0    [1    /1   ]  246.697011091        1
[INPUT] 1    0    [1    /1   ]  266.47602761         1
[INPUT] 1    0    [1    /1   ]  738.203731995        1
[INPUT] 1    0    [1    /1   ]  22.7601160944        1
[INPUT] 1    0    [1    /1   ]  100.301529245        1
[INPUT] 1    0    [1    /1   ]  1.41744580242        1
[INPUT] 1    0    [1    /1   ]  5.79282806008        1
[INPUT] 1    0    [1    /1   ]  0.364366203282       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26184.941820324722, 1.0]], [0, [7591.537498769222, 1.0]], [0, [3565.109771715181, 1.0]], [0, [790.088157926891, 1.0]], [0, [165.65258502276777, 1.0]], [0, [42.243404558355046, 1.0]], [0, [4.578198023068973, 1.0]], [0, [0.38236711896047315, 1.0]], [1, [1362.6875682338373, 1.0]], [1, [654.3003609789481, 1.0]], [1, [246.6970110913175, 1.0]], [1, [266.47602761028116, 1.0]], [1, [738.2037319948475, 1.0]], [1, [22.760116094395993, 1.0]], [1, [100.3015292454887, 1.0]], [1, [1.4174458024220395, 1.0]], [1, [5.792828060080776, 1.0]], [1, [0.3643662032822484, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26184.94182032]
bas 1, expnt(s) = [7591.53749877]
bas 2, expnt(s) = [3565.10977172]
bas 3, expnt(s) = [790.08815793]
bas 4, expnt(s) = [165.65258502]
bas 5, expnt(s) = [42.24340456]
bas 6, expnt(s) = [4.57819802]
bas 7, expnt(s) = [0.38236712]
bas 8, expnt(s) = [1362.68756823]
bas 9, expnt(s) = [654.30036098]
bas 10, expnt(s) = [246.69701109]
bas 11, expnt(s) = [266.47602761]
bas 12, expnt(s) = [738.20373199]
bas 13, expnt(s) = [22.76011609]
bas 14, expnt(s) = [100.30152925]
bas 15, expnt(s) = [1.4174458]
bas 16, expnt(s) = [5.79282806]
bas 17, expnt(s) = [0.3643662]
CPU time:       557.59
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61849418e+04 5.20060338e+03 7.59153750e+03 2.05476581e+03
 3.56510977e+03 1.16565412e+03 7.90088158e+02 3.76505815e+02
 1.65652585e+02 1.16657775e+02 4.22434046e+01 4.18633722e+01
 4.57819802e+00 7.90744089e+00 3.82367119e-01 1.22850076e+00
 1.36268757e+03 2.41534827e+04 6.54300361e+02 9.65396772e+03
 2.46697011e+02 2.85226092e+03 2.66476028e+02 3.14092144e+03
 7.38203732e+02 1.12254740e+04 2.27601161e+01 1.45028209e+02
 1.00301529e+02 9.26016736e+02 1.41744580e+00 4.51198316e+00
 5.79282806e+00 2.62178872e+01 3.64366203e-01 8.25861084e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.901023047381592
cond(S) = 264220.017352224
E1 = -727.4895661347667  E_coul = 202.6869437986081
init E= -524.802622336159
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.552210626737767  LUMO = 2.42763716095488
  mo_energy =
[-1.18245195e+02 -1.21169862e+01 -9.44328871e+00 -9.44328871e+00
 -9.44328871e+00 -1.24183279e+00 -5.52210627e-01 -5.52210627e-01
 -5.52210627e-01  2.42763716e+00  2.42763716e+00  2.42763716e+00
  2.41456254e+01  2.41456254e+01  2.41456254e+01  1.17675498e+02
  1.50082263e+02  1.50082263e+02  1.50082263e+02  5.11119601e+02
  5.11119601e+02  5.11119601e+02  1.09526022e+03  1.22039942e+03
  1.22039942e+03  1.22039942e+03  2.48094926e+03  2.48094926e+03
  2.48094926e+03  4.72266149e+03  4.72266149e+03  4.72266149e+03
  5.92371364e+03  8.82399921e+03  8.82399921e+03  8.82399921e+03
  2.13933440e+04  7.19483240e+04]
E1 = -728.4603766306325  E_coul = 202.5944443097625
cycle= 1 E= -525.86593232087  delta_E= -1.06  |g|= 0.202  |ddm|= 2.07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.54068
diis-c [-0.29233481  1.        ]
  HOMO = -0.511356368631  LUMO = 2.47217955627887
  mo_energy =
[-1.18453248e+02 -1.21124894e+01 -9.44661314e+00 -9.44661314e+00
 -9.44661314e+00 -1.19629128e+00 -5.11356369e-01 -5.11356369e-01
 -5.11356369e-01  2.47217956e+00  2.47217956e+00  2.47217956e+00
  2.41236344e+01  2.41236344e+01  2.41236344e+01  1.17561579e+02
  1.49948430e+02  1.49948430e+02  1.49948430e+02  5.10930407e+02
  5.10930407e+02  5.10930407e+02  1.09492136e+03  1.22016201e+03
  1.22016201e+03  1.22016201e+03  2.48065791e+03  2.48065791e+03
  2.48065791e+03  4.72230537e+03  4.72230537e+03  4.72230537e+03
  5.92318214e+03  8.82353040e+03  8.82353040e+03  8.82353040e+03
  2.13926948e+04  7.19475832e+04]
E1 = -728.5345781610459  E_coul = 202.66828419443294
cycle= 2 E= -525.866293966613  delta_E= -0.000362  |g|= 0.0162  |ddm|= 0.0175
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0263061
diis-c [-4.50214933e-04  2.79765662e-02  9.72023434e-01]
  HOMO = -0.512077801220506  LUMO = 2.47181003504461
  mo_energy =
[-1.18431245e+02 -1.21083068e+01 -9.44235869e+00 -9.44235869e+00
 -9.44235869e+00 -1.19717807e+00 -5.12077801e-01 -5.12077801e-01
 -5.12077801e-01  2.47181004e+00  2.47181004e+00  2.47181004e+00
  2.41295496e+01  2.41295496e+01  2.41295496e+01  1.17579808e+02
  1.49965076e+02  1.49965076e+02  1.49965076e+02  5.10951562e+02
  5.10951562e+02  5.10951562e+02  1.09494666e+03  1.22018532e+03
  1.22018532e+03  1.22018532e+03  2.48068263e+03  2.48068263e+03
  2.48068263e+03  4.72233109e+03  4.72233109e+03  4.72233109e+03
  5.92320874e+03  8.82355675e+03  8.82355675e+03  8.82355675e+03
  2.13927216e+04  7.19476099e+04]
E1 = -728.51414398491  E_coul = 202.647847127578
cycle= 3 E= -525.866296857332  delta_E= -2.89e-06  |g|= 0.00144  |ddm|= 0.00151
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00286101
diis-c [-2.46761009e-07 -1.06833143e-03  8.42348718e-02  9.16833460e-01]
  HOMO = -0.512290462648111  LUMO = 2.47144757650499
  mo_energy =
[-1.18433793e+02 -1.21094791e+01 -9.44358055e+00 -9.44358055e+00
 -9.44358055e+00 -1.19745042e+00 -5.12290463e-01 -5.12290463e-01
 -5.12290463e-01  2.47144758e+00  2.47144758e+00  2.47144758e+00
  2.41282497e+01  2.41282497e+01  2.41282497e+01  1.17577626e+02
  1.49962927e+02  1.49962927e+02  1.49962927e+02  5.10949085e+02
  5.10949085e+02  5.10949085e+02  1.09494376e+03  1.22018265e+03
  1.22018265e+03  1.22018265e+03  2.48067983e+03  2.48067983e+03
  2.48067983e+03  4.72232816e+03  4.72232816e+03  4.72232816e+03
  5.92320557e+03  8.82355366e+03  8.82355366e+03  8.82355366e+03
  2.13927183e+04  7.19476066e+04]
E1 = -728.5169155221181  E_coul = 202.6506186192448
cycle= 4 E= -525.866296902873  delta_E= -4.55e-08  |g|= 4.85e-05  |ddm|= 0.000261
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.72222e-05
diis-c [-7.64199075e-10  3.68748070e-07 -1.08822242e-03  1.13383715e-02
  9.89749482e-01]
  HOMO = -0.512273361087669  LUMO = 2.47147491824261
  mo_energy =
[-1.18433695e+02 -1.21094046e+01 -9.44350561e+00 -9.44350561e+00
 -9.44350561e+00 -1.19742830e+00 -5.12273361e-01 -5.12273361e-01
 -5.12273361e-01  2.47147492e+00  2.47147492e+00  2.47147492e+00
  2.41283244e+01  2.41283244e+01  2.41283244e+01  1.17577723e+02
  1.49963020e+02  1.49963020e+02  1.49963020e+02  5.10949182e+02
  5.10949182e+02  5.10949182e+02  1.09494385e+03  1.22018275e+03
  1.22018275e+03  1.22018275e+03  2.48067993e+03  2.48067993e+03
  2.48067993e+03  4.72232825e+03  4.72232825e+03  4.72232825e+03
  5.92320566e+03  8.82355375e+03  8.82355375e+03  8.82355375e+03
  2.13927184e+04  7.19476066e+04]
E1 = -728.5167887888152  E_coul = 202.65049188586275
cycle= 5 E= -525.866296902953  delta_E= -7.92e-11  |g|= 3.89e-06  |ddm|= 1.42e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -728.5167887888152  E_coul = 202.65049188586275
  HOMO = -0.512274683871913  LUMO = 2.47147283399199
  mo_energy =
[-1.18433704e+02 -1.21094104e+01 -9.44351149e+00 -9.44351149e+00
 -9.44351149e+00 -1.19743000e+00 -5.12274684e-01 -5.12274684e-01
 -5.12274684e-01  2.47147283e+00  2.47147283e+00  2.47147283e+00
  2.41283185e+01  2.41283185e+01  2.41283185e+01  1.17577714e+02
  1.49963012e+02  1.49963012e+02  1.49963012e+02  5.10949174e+02
  5.10949174e+02  5.10949174e+02  1.09494384e+03  1.22018274e+03
  1.22018274e+03  1.22018274e+03  2.48067992e+03  2.48067992e+03
  2.48067992e+03  4.72232824e+03  4.72232824e+03  4.72232824e+03
  5.92320565e+03  8.82355374e+03  8.82355374e+03  8.82355374e+03
  2.13927184e+04  7.19476066e+04]
E1 = -728.5167994877143  E_coul = 202.6505025847618
Extra cycle  E= -525.866296902952  delta_E= 1.14e-13  |g|= 7.61e-07  |ddm|= 1.13e-06
    CPU time for scf_cycle      0.28 sec, wall time      0.19 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 264220.017352224
E1 = -728.5167994877143  E_coul = 202.6505025847618
init E= -525.866296902952
    CPU time for initialize scf      0.96 sec, wall time      0.18 sec
  HOMO = -0.512274538472581  LUMO = 2.47147308166503
  mo_energy =
[-1.18433702e+02 -1.21094096e+01 -9.44351069e+00 -9.44351069e+00
 -9.44351069e+00 -1.19742982e+00 -5.12274538e-01 -5.12274538e-01
 -5.12274538e-01  2.47147308e+00  2.47147308e+00  2.47147308e+00
  2.41283194e+01  2.41283194e+01  2.41283194e+01  1.17577716e+02
  1.49963014e+02  1.49963014e+02  1.49963014e+02  5.10949175e+02
  5.10949175e+02  5.10949175e+02  1.09494385e+03  1.22018274e+03
  1.22018274e+03  1.22018274e+03  2.48067992e+03  2.48067992e+03
  2.48067992e+03  4.72232824e+03  4.72232824e+03  4.72232824e+03
  5.92320565e+03  8.82355374e+03  8.82355374e+03  8.82355374e+03
  2.13927184e+04  7.19476066e+04]
E1 = -728.5167977652359  E_coul = 202.6505008622825
cycle= 1 E= -525.866296902953  delta_E= -9.09e-13  |g|= 1.29e-07  |ddm|= 1.67e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.5167977652359  E_coul = 202.6505008622825
  HOMO = -0.512274560960392  LUMO = 2.4714730431862
  mo_energy =
[-1.18433702e+02 -1.21094097e+01 -9.44351082e+00 -9.44351082e+00
 -9.44351082e+00 -1.19742985e+00 -5.12274561e-01 -5.12274561e-01
 -5.12274561e-01  2.47147304e+00  2.47147304e+00  2.47147304e+00
  2.41283193e+01  2.41283193e+01  2.41283193e+01  1.17577716e+02
  1.49963013e+02  1.49963013e+02  1.49963013e+02  5.10949175e+02
  5.10949175e+02  5.10949175e+02  1.09494385e+03  1.22018274e+03
  1.22018274e+03  1.22018274e+03  2.48067992e+03  2.48067992e+03
  2.48067992e+03  4.72232824e+03  4.72232824e+03  4.72232824e+03
  5.92320565e+03  8.82355374e+03  8.82355374e+03  8.82355374e+03
  2.13927184e+04  7.19476066e+04]
E1 = -728.5167980479101  E_coul = 202.6505011449567
Extra cycle  E= -525.866296902953  delta_E= -1.14e-13  |g|= 2.16e-08  |ddm|= 2.7e-08
    CPU time for scf_cycle      1.07 sec, wall time      0.29 sec
exp = [2.61849418e+04 7.59153750e+03 3.56510977e+03 7.90088158e+02
 1.65652585e+02 4.22434046e+01 4.57819802e+00 3.82367119e-01
 1.36268757e+03 6.54300361e+02 2.46697011e+02 2.66476028e+02
 7.38203732e+02 2.27601161e+01 1.00301529e+02 1.41744580e+00
 5.79282806e+00 3.64366203e-01]
grad_E = [-1.09181318e-06  7.01417041e-07 -1.00875281e-05  1.14185922e-03
  1.68490378e-04 -1.98021648e-02 -3.52126558e-02 -1.14474365e-01
  1.15731867e-07  3.55850065e-06  3.16729866e-05  2.86233567e-05
  2.84034465e-06  7.84738826e-02  2.59742071e-04  2.18589453e-02
 -3.00621719e-01  5.89053473e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26187.2638782        1
[INPUT] 0    0    [1    /1   ]  7566.0584728         1
[INPUT] 0    0    [1    /1   ]  3514.43640061        1
[INPUT] 0    0    [1    /1   ]  1e-09                1
[INPUT] 0    0    [1    /1   ]  93.7923782313        1
[INPUT] 0    0    [1    /1   ]  32.5799249915        1
[INPUT] 0    0    [1    /1   ]  4.55954467108        1
[INPUT] 0    0    [1    /1   ]  0.368380428226       1
[INPUT] 1    0    [1    /1   ]  1362.63029526        1
[INPUT] 1    0    [1    /1   ]  644.289160387        1
[INPUT] 1    0    [1    /1   ]  194.762876346        1
[INPUT] 1    0    [1    /1   ]  220.932490224        1
[INPUT] 1    0    [1    /1   ]  1354.58732309        1
[INPUT] 1    0    [1    /1   ]  32.8178152489        1
[INPUT] 1    0    [1    /1   ]  159.164824348        1
[INPUT] 1    0    [1    /1   ]  1.98572338126        1
[INPUT] 1    0    [1    /1   ]  7.73749617775        1
[INPUT] 1    0    [1    /1   ]  0.46933537922        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26187.263878169844, 1.0]], [0, [7566.058472801352, 1.0]], [0, [3514.436400609188, 1.0]], [0, [1e-09, 1.0]], [0, [93.79237823129485, 1.0]], [0, [32.57992499146247, 1.0]], [0, [4.559544671081304, 1.0]], [0, [0.3683804282260158, 1.0]], [1, [1362.6302952551912, 1.0]], [1, [644.2891603866735, 1.0]], [1, [194.76287634566322, 1.0]], [1, [220.93249022387684, 1.0]], [1, [1354.587323091238, 1.0]], [1, [32.81781524894004, 1.0]], [1, [159.16482434790166, 1.0]], [1, [1.985723381257595, 1.0]], [1, [7.7374961777475075, 1.0]], [1, [0.46933537921983776, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26187.26387817]
bas 1, expnt(s) = [7566.0584728]
bas 2, expnt(s) = [3514.43640061]
bas 3, expnt(s) = [1.e-09]
bas 4, expnt(s) = [93.79237823]
bas 5, expnt(s) = [32.57992499]
bas 6, expnt(s) = [4.55954467]
bas 7, expnt(s) = [0.36838043]
bas 8, expnt(s) = [1362.63029526]
bas 9, expnt(s) = [644.28916039]
bas 10, expnt(s) = [194.76287635]
bas 11, expnt(s) = [220.93249022]
bas 12, expnt(s) = [1354.58732309]
bas 13, expnt(s) = [32.81781525]
bas 14, expnt(s) = [159.16482435]
bas 15, expnt(s) = [1.98572338]
bas 16, expnt(s) = [7.73749618]
bas 17, expnt(s) = [0.46933538]
CPU time:       563.25
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61872639e+04 5.20094927e+03 7.56605847e+03 2.04959142e+03
 3.51443640e+03 1.15320573e+03 1.00000000e-09 4.49277867e-07
 9.37923782e+01 7.61448763e+01 3.25799250e+01 3.44530429e+01
 4.55954467e+00 7.88326508e+00 3.68380428e-01 1.19464105e+00
 1.36263030e+03 2.41522137e+04 6.44289160e+02 9.46968262e+03
 1.94762876e+02 2.12259490e+03 2.20932490e+02 2.48489978e+03
 1.35458732e+03 2.39741463e+04 3.28178152e+01 2.29150851e+02
 1.59164824e+02 1.64927570e+03 1.98572338e+00 6.87674356e+00
 7.73749618e+00 3.76473968e+01 4.69335379e-01 1.13328335e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.733369146354775
cond(S) = 6026021.49473319
E1 = -571.9299628588741  E_coul = 200.41530234485919
init E= -371.514660514015
    CPU time for initialize scf      0.13 sec, wall time      0.04 sec
  HOMO = -0.564405859215154  LUMO = -1.34533988823948e-05
  mo_energy =
[-1.05508181e+02 -1.11494095e+01 -9.53795269e+00 -9.53795269e+00
 -9.53795269e+00 -1.18338490e+00 -5.64405859e-01 -5.64405859e-01
 -5.64405859e-01 -1.34533989e-05  3.95001116e+00  3.95001116e+00
  3.95001116e+00  3.84889221e+01  3.84889221e+01  3.84889221e+01
  6.78676272e+01  2.02595899e+02  2.02595899e+02  2.02595899e+02
  5.99549806e+02  5.99549806e+02  5.99549806e+02  1.31132775e+03
  1.31132775e+03  1.31132775e+03  2.62786911e+03  2.62786911e+03
  2.62786911e+03  3.15883196e+03  5.26698300e+03  5.26698300e+03
  5.26698300e+03  1.02717999e+04  1.02717999e+04  1.02717999e+04
  1.83541332e+04  6.89459356e+04]
E1 = -700.2111012172953  E_coul = 203.37163148516575
cycle= 1 E= -496.83946973213  delta_E= -125  |g|= 1.74  |ddm|= 26.8
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=2.99962
diis-c [-8.99774731  1.        ]
  HOMO = -0.414406337774382  LUMO = 1.50052312378112e-09
  mo_energy =
[-1.05711206e+02 -1.08985671e+01 -9.28926430e+00 -9.28926430e+00
 -9.28926430e+00 -1.01387245e+00 -4.14406338e-01 -4.14406338e-01
 -4.14406338e-01  1.50052312e-09  4.15822449e+00  4.15822449e+00
  4.15822449e+00  3.86692729e+01  3.86692729e+01  3.86692729e+01
  6.80800026e+01  2.02642098e+02  2.02642098e+02  2.02642098e+02
  5.99467561e+02  5.99467561e+02  5.99467561e+02  1.31106686e+03
  1.31106686e+03  1.31106686e+03  2.62727848e+03  2.62727848e+03
  2.62727848e+03  3.15708628e+03  5.26591419e+03  5.26591419e+03
  5.26591419e+03  1.02698662e+04  1.02698662e+04  1.02698662e+04
  1.83509133e+04  6.89421468e+04]
E1 = -699.955444971254  E_coul = 203.11451257847546
cycle= 2 E= -496.840932392779  delta_E= -0.00146  |g|= 0.0128  |ddm|= 0.0624
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0314996
diis-c [-5.90060050e-04 -6.73073533e-03  1.00673074e+00]
  HOMO = -0.419180777041556  LUMO = 1.50052214770845e-09
  mo_energy =
[-1.05735967e+02 -1.09186386e+01 -9.31070617e+00 -9.31070617e+00
 -9.31070617e+00 -1.01981014e+00 -4.19180777e-01 -4.19180777e-01
 -4.19180777e-01  1.50052215e-09  4.14788912e+00  4.14788912e+00
  4.14788912e+00  3.86465807e+01  3.86465807e+01  3.86465807e+01
  6.80578351e+01  2.02617569e+02  2.02617569e+02  2.02617569e+02
  5.99442800e+02  5.99442800e+02  5.99442800e+02  1.31104183e+03
  1.31104183e+03  1.31104183e+03  2.62725284e+03  2.62725284e+03
  2.62725284e+03  3.15705763e+03  5.26588742e+03  5.26588742e+03
  5.26588742e+03  1.02698371e+04  1.02698371e+04  1.02698371e+04
  1.83508804e+04  6.89421122e+04]
E1 = -699.9771713701006  E_coul = 203.13623571968964
cycle= 3 E= -496.840935650411  delta_E= -3.26e-06  |g|= 0.00211  |ddm|= 0.0021
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00337845
diis-c [-1.00886594e-06 -6.41980379e-04  1.16838777e-01  8.83803203e-01]
  HOMO = -0.418964343581604  LUMO = 1.50056668445524e-09
  mo_energy =
[-1.05732725e+02 -1.09171097e+01 -9.30914549e+00 -9.30914549e+00
 -9.30914549e+00 -1.01953007e+00 -4.18964344e-01 -4.18964344e-01
 -4.18964344e-01  1.50056668e-09  4.14849002e+00  4.14849002e+00
  4.14849002e+00  3.86485946e+01  3.86485946e+01  3.86485946e+01
  6.80603735e+01  2.02620478e+02  2.02620478e+02  2.02620478e+02
  5.99446014e+02  5.99446014e+02  5.99446014e+02  1.31104520e+03
  1.31104520e+03  1.31104520e+03  2.62725631e+03  2.62725631e+03
  2.62725631e+03  3.15706118e+03  5.26589095e+03  5.26589095e+03
  5.26589095e+03  1.02698407e+04  1.02698407e+04  1.02698407e+04
  1.83508840e+04  6.89421158e+04]
E1 = -699.9741764416435  E_coul = 203.1332407194743
cycle= 4 E= -496.840935722169  delta_E= -7.18e-08  |g|= 5.27e-05  |ddm|= 0.000315
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000140487
diis-c [-9.88165632e-10  3.06342278e-05 -6.32111941e-03 -5.77299857e-03
  1.01206348e+00]
  HOMO = -0.418966058646164  LUMO = 1.50053535816371e-09
  mo_energy =
[-1.05732778e+02 -1.09171145e+01 -9.30915709e+00 -9.30915709e+00
 -9.30915709e+00 -1.01953163e+00 -4.18966059e-01 -4.18966059e-01
 -4.18966059e-01  1.50053536e-09  4.14848597e+00  4.14848597e+00
  4.14848597e+00  3.86485728e+01  3.86485728e+01  3.86485728e+01
  6.80603551e+01  2.02620438e+02  2.02620438e+02  2.02620438e+02
  5.99445961e+02  5.99445961e+02  5.99445961e+02  1.31104513e+03
  1.31104513e+03  1.31104513e+03  2.62725623e+03  2.62725623e+03
  2.62725623e+03  3.15706107e+03  5.26589085e+03  5.26589085e+03
  5.26589085e+03  1.02698406e+04  1.02698406e+04  1.02698406e+04
  1.83508839e+04  6.89421157e+04]
E1 = -699.9742257465264  E_coul = 203.13329002430496
cycle= 5 E= -496.840935722221  delta_E= -5.22e-11  |g|= 3.91e-06  |ddm|= 6.36e-06
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -699.9742257465264  E_coul = 203.13329002430496
  HOMO = -0.418966878257459  LUMO = 1.50053983075908e-09
  mo_energy =
[-1.05732785e+02 -1.09171190e+01 -9.30916170e+00 -9.30916170e+00
 -9.30916170e+00 -1.01953267e+00 -4.18966878e-01 -4.18966878e-01
 -4.18966878e-01  1.50053983e-09  4.14848399e+00  4.14848399e+00
  4.14848399e+00  3.86485674e+01  3.86485674e+01  3.86485674e+01
  6.80603487e+01  2.02620430e+02  2.02620430e+02  2.02620430e+02
  5.99445953e+02  5.99445953e+02  5.99445953e+02  1.31104512e+03
  1.31104512e+03  1.31104512e+03  2.62725622e+03  2.62725622e+03
  2.62725622e+03  3.15706106e+03  5.26589084e+03  5.26589084e+03
  5.26589084e+03  1.02698405e+04  1.02698405e+04  1.02698405e+04
  1.83508839e+04  6.89421157e+04]
E1 = -699.974232672528  E_coul = 203.13329695030646
Extra cycle  E= -496.840935722222  delta_E= -2.27e-13  |g|= 6.36e-07  |ddm|= 6.85e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.18 sec
exp = [2.61872639e+04 7.56605847e+03 3.51443640e+03 1.00000000e-09
 9.37923782e+01 3.25799250e+01 4.55954467e+00 3.68380428e-01
 1.36263030e+03 6.44289160e+02 1.94762876e+02 2.20932490e+02
 1.35458732e+03 3.28178152e+01 1.59164824e+02 1.98572338e+00
 7.73749618e+00 4.69335379e-01]
E = -496.8409357222216
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.1740261        1
[INPUT] 0    0    [1    /1   ]  7588.98959617        1
[INPUT] 0    0    [1    /1   ]  3560.0424346         1
[INPUT] 0    0    [1    /1   ]  711.079342134        1
[INPUT] 0    0    [1    /1   ]  158.466564344        1
[INPUT] 0    0    [1    /1   ]  41.2770566017        1
[INPUT] 0    0    [1    /1   ]  4.57633268787        1
[INPUT] 0    0    [1    /1   ]  0.380968449887       1
[INPUT] 1    0    [1    /1   ]  1362.68184094        1
[INPUT] 1    0    [1    /1   ]  653.29924092         1
[INPUT] 1    0    [1    /1   ]  241.503597617        1
[INPUT] 1    0    [1    /1   ]  261.921673872        1
[INPUT] 1    0    [1    /1   ]  799.842091104        1
[INPUT] 1    0    [1    /1   ]  23.7658860099        1
[INPUT] 1    0    [1    /1   ]  106.187858756        1
[INPUT] 1    0    [1    /1   ]  1.47427356031        1
[INPUT] 1    0    [1    /1   ]  5.98729487185        1
[INPUT] 1    0    [1    /1   ]  0.374863120876       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.174026109235, 1.0]], [0, [7588.989596172435, 1.0]], [0, [3560.0424346045816, 1.0]], [0, [711.0793421343019, 1.0]], [0, [158.46656434362046, 1.0]], [0, [41.27705660166579, 1.0]], [0, [4.576332687870206, 1.0]], [0, [0.38096844988702744, 1.0]], [1, [1362.6818409359726, 1.0]], [1, [653.2992409197207, 1.0]], [1, [241.50359761675207, 1.0]], [1, [261.92167387164073, 1.0]], [1, [799.8420911044866, 1.0]], [1, [23.765886009850398, 1.0]], [1, [106.18785875572999, 1.0]], [1, [1.474273560305595, 1.0]], [1, [5.987294871847449, 1.0]], [1, [0.3748631208760073, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.17402611]
bas 1, expnt(s) = [7588.98959617]
bas 2, expnt(s) = [3560.0424346]
bas 3, expnt(s) = [711.07934213]
bas 4, expnt(s) = [158.46656434]
bas 5, expnt(s) = [41.2770566]
bas 6, expnt(s) = [4.57633269]
bas 7, expnt(s) = [0.38096845]
bas 8, expnt(s) = [1362.68184094]
bas 9, expnt(s) = [653.29924092]
bas 10, expnt(s) = [241.50359762]
bas 11, expnt(s) = [261.92167387]
bas 12, expnt(s) = [799.8420911]
bas 13, expnt(s) = [23.76588601]
bas 14, expnt(s) = [106.18785876]
bas 15, expnt(s) = [1.47427356]
bas 16, expnt(s) = [5.98729487]
bas 17, expnt(s) = [0.37486312]
CPU time:       563.79
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61851740e+04 5.20063797e+03 7.58898960e+03 2.05424857e+03
 3.56004243e+03 1.16441128e+03 7.11079342e+02 3.47899313e+02
 1.58466564e+02 1.12841345e+02 4.12770566e+01 4.11430577e+01
 4.57633269e+00 7.90502442e+00 3.80968450e-01 1.22512889e+00
 1.36268184e+03 2.41533558e+04 6.53299241e+02 9.63550729e+03
 2.41503598e+02 2.77740299e+03 2.61921674e+02 3.07396338e+03
 7.99842091e+02 1.24090836e+04 2.37658860e+01 1.53082979e+02
 1.06187859e+02 9.94438596e+02 1.47427356e+00 4.73922130e+00
 5.98729487e+00 2.73226426e+01 3.74863121e-01 8.55707401e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.890779786184815
cond(S) = 187438.26270591962
E1 = -727.4340953897728  E_coul = 202.65590621153288
init E= -524.77818917824
    CPU time for initialize scf      0.13 sec, wall time      0.04 sec
  HOMO = -0.551041226696197  LUMO = 2.56771118470938
  mo_energy =
[-1.18278110e+02 -1.21187530e+01 -9.44314280e+00 -9.44314280e+00
 -9.44314280e+00 -1.24315398e+00 -5.51041227e-01 -5.51041227e-01
 -5.51041227e-01  2.56771118e+00  2.56771118e+00  2.56771118e+00
  2.55400746e+01  2.55400746e+01  2.55400746e+01  1.11970605e+02
  1.56809681e+02  1.56809681e+02  1.56809681e+02  5.24333654e+02
  5.24333654e+02  5.24333654e+02  1.00727600e+03  1.23690685e+03
  1.23690685e+03  1.23690685e+03  2.50978512e+03  2.50978512e+03
  2.50978512e+03  4.80173657e+03  4.80173657e+03  4.80173657e+03
  5.66665797e+03  8.98578060e+03  8.98578060e+03  8.98578060e+03
  2.10717721e+04  7.16196219e+04]
E1 = -728.6202747352654  E_coul = 202.72190767322243
cycle= 1 E= -525.898367062043  delta_E= -1.12  |g|= 0.205  |ddm|= 2.11
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.553996
diis-c [-0.30691196  1.        ]
  HOMO = -0.504062709690726  LUMO = 2.62008987837234
  mo_energy =
[-1.18476680e+02 -1.21024278e+01 -9.43562581e+00 -9.43562581e+00
 -9.43562581e+00 -1.19026140e+00 -5.04062710e-01 -5.04062710e-01
 -5.04062710e-01  2.62008988e+00  2.62008988e+00  2.62008988e+00
  2.55243270e+01  2.55243270e+01  2.55243270e+01  1.11870044e+02
  1.56682810e+02  1.56682810e+02  1.56682810e+02  5.24152731e+02
  5.24152731e+02  5.24152731e+02  1.00695721e+03  1.23667699e+03
  1.23667699e+03  1.23667699e+03  2.50950006e+03  2.50950006e+03
  2.50950006e+03  4.80138688e+03  4.80138688e+03  4.80138688e+03
  5.66614230e+03  8.98532132e+03  8.98532132e+03  8.98532132e+03
  2.10711362e+04  7.16188950e+04]
E1 = -728.6876343389683  E_coul = 202.7888809117251
cycle= 2 E= -525.898753427243  delta_E= -0.000386  |g|= 0.0163  |ddm|= 0.0183
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0261629
diis-c [-4.45520626e-04  2.71660776e-02  9.72833922e-01]
  HOMO = -0.504918950948493  LUMO = 2.61952914279998
  mo_energy =
[-1.18455144e+02 -1.20987964e+01 -9.43194145e+00 -9.43194145e+00
 -9.43194145e+00 -1.19132619e+00 -5.04918951e-01 -5.04918951e-01
 -5.04918951e-01  2.61952914e+00  2.61952914e+00  2.61952914e+00
  2.55300546e+01  2.55300546e+01  2.55300546e+01  1.11887467e+02
  1.56699156e+02  1.56699156e+02  1.56699156e+02  5.24173455e+02
  5.24173455e+02  5.24173455e+02  1.00698188e+03  1.23669985e+03
  1.23669985e+03  1.23669985e+03  2.50952436e+03  2.50952436e+03
  2.50952436e+03  4.80141220e+03  4.80141220e+03  4.80141220e+03
  5.66616846e+03  8.98534725e+03  8.98534725e+03  8.98534725e+03
  2.10711625e+04  7.16189213e+04]
E1 = -728.6677627210746  E_coul = 202.76900647668143
cycle= 3 E= -525.898756244393  delta_E= -2.82e-06  |g|= 0.00142  |ddm|= 0.00147
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00286258
diis-c [-2.86138235e-07 -1.09027105e-03  8.38138451e-02  9.17276426e-01]
  HOMO = -0.505127062793184  LUMO = 2.61915752155128
  mo_energy =
[-1.18457660e+02 -1.20999483e+01 -9.43314505e+00 -9.43314505e+00
 -9.43314505e+00 -1.19159146e+00 -5.05127063e-01 -5.05127063e-01
 -5.05127063e-01  2.61915752e+00  2.61915752e+00  2.61915752e+00
  2.55287434e+01  2.55287434e+01  2.55287434e+01  1.11885343e+02
  1.56697020e+02  1.56697020e+02  1.56697020e+02  5.24171005e+02
  5.24171005e+02  5.24171005e+02  1.00697903e+03  1.23669721e+03
  1.23669721e+03  1.23669721e+03  2.50952158e+03  2.50952158e+03
  2.50952158e+03  4.80140928e+03  4.80140928e+03  4.80140928e+03
  5.66616530e+03  8.98534417e+03  8.98534417e+03  8.98534417e+03
  2.10711592e+04  7.16189179e+04]
E1 = -728.6704361497879  E_coul = 202.77167986148908
cycle= 4 E= -525.898756288299  delta_E= -4.39e-08  |g|= 4.9e-05  |ddm|= 0.000249
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.67919e-05
diis-c [-7.81786201e-10  3.85058247e-06 -1.39694919e-03  8.01223067e-03
  9.93380868e-01]
  HOMO = -0.505111071162486  LUMO = 2.61918446531288
  mo_energy =
[-1.18457564e+02 -1.20998760e+01 -9.43307245e+00 -9.43307245e+00
 -9.43307245e+00 -1.19157081e+00 -5.05111071e-01 -5.05111071e-01
 -5.05111071e-01  2.61918447e+00  2.61918447e+00  2.61918447e+00
  2.55288170e+01  2.55288170e+01  2.55288170e+01  1.11885437e+02
  1.56697112e+02  1.56697112e+02  1.56697112e+02  5.24171101e+02
  5.24171101e+02  5.24171101e+02  1.00697912e+03  1.23669731e+03
  1.23669731e+03  1.23669731e+03  2.50952167e+03  2.50952167e+03
  2.50952167e+03  4.80140937e+03  4.80140937e+03  4.80140937e+03
  5.66616539e+03  8.98534426e+03  8.98534426e+03  8.98534426e+03
  2.10711593e+04  7.16189180e+04]
E1 = -728.6703169472296  E_coul = 202.77156065885973
cycle= 5 E= -525.89875628837  delta_E= -7.12e-11  |g|= 3.88e-06  |ddm|= 1.32e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -728.6703169472296  E_coul = 202.77156065885973
  HOMO = -0.505112320342119  LUMO = 2.61918240080974
  mo_energy =
[-1.18457572e+02 -1.20998816e+01 -9.43307814e+00 -9.43307814e+00
 -9.43307814e+00 -1.19157242e+00 -5.05112320e-01 -5.05112320e-01
 -5.05112320e-01  2.61918240e+00  2.61918240e+00  2.61918240e+00
  2.55288112e+01  2.55288112e+01  2.55288112e+01  1.11885429e+02
  1.56697104e+02  1.56697104e+02  1.56697104e+02  5.24171092e+02
  5.24171092e+02  5.24171092e+02  1.00697911e+03  1.23669730e+03
  1.23669730e+03  1.23669730e+03  2.50952167e+03  2.50952167e+03
  2.50952167e+03  4.80140936e+03  4.80140936e+03  4.80140936e+03
  5.66616538e+03  8.98534425e+03  8.98534425e+03  8.98534425e+03
  2.10711593e+04  7.16189180e+04]
E1 = -728.6703270412335  E_coul = 202.7715707528628
Extra cycle  E= -525.898756288371  delta_E= -7.96e-13  |g|= 7.45e-07  |ddm|= 1.05e-06
    CPU time for scf_cycle      0.27 sec, wall time      0.18 sec
exp = [2.61851740e+04 7.58898960e+03 3.56004243e+03 7.11079342e+02
 1.58466564e+02 4.12770566e+01 4.57633269e+00 3.80968450e-01
 1.36268184e+03 6.53299241e+02 2.41503598e+02 2.61921674e+02
 7.99842091e+02 2.37658860e+01 1.06187859e+02 1.47427356e+00
 5.98729487e+00 3.74863121e-01]
E = -525.8987562883707
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.1740261        1
[INPUT] 0    0    [1    /1   ]  7588.98959617        1
[INPUT] 0    0    [1    /1   ]  3560.0424346         1
[INPUT] 0    0    [1    /1   ]  711.079342134        1
[INPUT] 0    0    [1    /1   ]  158.466564344        1
[INPUT] 0    0    [1    /1   ]  41.2770566017        1
[INPUT] 0    0    [1    /1   ]  4.57633268787        1
[INPUT] 0    0    [1    /1   ]  0.380968449887       1
[INPUT] 1    0    [1    /1   ]  1362.68184094        1
[INPUT] 1    0    [1    /1   ]  653.29924092         1
[INPUT] 1    0    [1    /1   ]  241.503597617        1
[INPUT] 1    0    [1    /1   ]  261.921673872        1
[INPUT] 1    0    [1    /1   ]  799.842091104        1
[INPUT] 1    0    [1    /1   ]  23.7658860099        1
[INPUT] 1    0    [1    /1   ]  106.187858756        1
[INPUT] 1    0    [1    /1   ]  1.47427356031        1
[INPUT] 1    0    [1    /1   ]  5.98729487185        1
[INPUT] 1    0    [1    /1   ]  0.374863120876       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.174026109235, 1.0]], [0, [7588.989596172435, 1.0]], [0, [3560.0424346045816, 1.0]], [0, [711.0793421343019, 1.0]], [0, [158.46656434362046, 1.0]], [0, [41.27705660166579, 1.0]], [0, [4.576332687870206, 1.0]], [0, [0.38096844988702744, 1.0]], [1, [1362.6818409359726, 1.0]], [1, [653.2992409197207, 1.0]], [1, [241.50359761675207, 1.0]], [1, [261.92167387164073, 1.0]], [1, [799.8420911044866, 1.0]], [1, [23.765886009850398, 1.0]], [1, [106.18785875572999, 1.0]], [1, [1.474273560305595, 1.0]], [1, [5.987294871847449, 1.0]], [1, [0.3748631208760073, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.17402611]
bas 1, expnt(s) = [7588.98959617]
bas 2, expnt(s) = [3560.0424346]
bas 3, expnt(s) = [711.07934213]
bas 4, expnt(s) = [158.46656434]
bas 5, expnt(s) = [41.2770566]
bas 6, expnt(s) = [4.57633269]
bas 7, expnt(s) = [0.38096845]
bas 8, expnt(s) = [1362.68184094]
bas 9, expnt(s) = [653.29924092]
bas 10, expnt(s) = [241.50359762]
bas 11, expnt(s) = [261.92167387]
bas 12, expnt(s) = [799.8420911]
bas 13, expnt(s) = [23.76588601]
bas 14, expnt(s) = [106.18785876]
bas 15, expnt(s) = [1.47427356]
bas 16, expnt(s) = [5.98729487]
bas 17, expnt(s) = [0.37486312]
CPU time:       564.33
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61851740e+04 5.20063797e+03 7.58898960e+03 2.05424857e+03
 3.56004243e+03 1.16441128e+03 7.11079342e+02 3.47899313e+02
 1.58466564e+02 1.12841345e+02 4.12770566e+01 4.11430577e+01
 4.57633269e+00 7.90502442e+00 3.80968450e-01 1.22512889e+00
 1.36268184e+03 2.41533558e+04 6.53299241e+02 9.63550729e+03
 2.41503598e+02 2.77740299e+03 2.61921674e+02 3.07396338e+03
 7.99842091e+02 1.24090836e+04 2.37658860e+01 1.53082979e+02
 1.06187859e+02 9.94438596e+02 1.47427356e+00 4.73922130e+00
 5.98729487e+00 2.73226426e+01 3.74863121e-01 8.55707401e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.890779786184815
cond(S) = 187438.26270591962
E1 = -727.4340953897728  E_coul = 202.65590621153288
init E= -524.77818917824
    CPU time for initialize scf      0.15 sec, wall time      0.04 sec
  HOMO = -0.551041226696197  LUMO = 2.56771118470938
  mo_energy =
[-1.18278110e+02 -1.21187530e+01 -9.44314280e+00 -9.44314280e+00
 -9.44314280e+00 -1.24315398e+00 -5.51041227e-01 -5.51041227e-01
 -5.51041227e-01  2.56771118e+00  2.56771118e+00  2.56771118e+00
  2.55400746e+01  2.55400746e+01  2.55400746e+01  1.11970605e+02
  1.56809681e+02  1.56809681e+02  1.56809681e+02  5.24333654e+02
  5.24333654e+02  5.24333654e+02  1.00727600e+03  1.23690685e+03
  1.23690685e+03  1.23690685e+03  2.50978512e+03  2.50978512e+03
  2.50978512e+03  4.80173657e+03  4.80173657e+03  4.80173657e+03
  5.66665797e+03  8.98578060e+03  8.98578060e+03  8.98578060e+03
  2.10717721e+04  7.16196219e+04]
E1 = -728.6202747352654  E_coul = 202.72190767322243
cycle= 1 E= -525.898367062043  delta_E= -1.12  |g|= 0.205  |ddm|= 2.11
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.553996
diis-c [-0.30691196  1.        ]
  HOMO = -0.504062709690726  LUMO = 2.62008987837234
  mo_energy =
[-1.18476680e+02 -1.21024278e+01 -9.43562581e+00 -9.43562581e+00
 -9.43562581e+00 -1.19026140e+00 -5.04062710e-01 -5.04062710e-01
 -5.04062710e-01  2.62008988e+00  2.62008988e+00  2.62008988e+00
  2.55243270e+01  2.55243270e+01  2.55243270e+01  1.11870044e+02
  1.56682810e+02  1.56682810e+02  1.56682810e+02  5.24152731e+02
  5.24152731e+02  5.24152731e+02  1.00695721e+03  1.23667699e+03
  1.23667699e+03  1.23667699e+03  2.50950006e+03  2.50950006e+03
  2.50950006e+03  4.80138688e+03  4.80138688e+03  4.80138688e+03
  5.66614230e+03  8.98532132e+03  8.98532132e+03  8.98532132e+03
  2.10711362e+04  7.16188950e+04]
E1 = -728.6876343389683  E_coul = 202.7888809117251
cycle= 2 E= -525.898753427243  delta_E= -0.000386  |g|= 0.0163  |ddm|= 0.0183
    CPU time for cycle= 2      0.02 sec, wall time      0.03 sec
diis-norm(errvec)=0.0261629
diis-c [-4.45520626e-04  2.71660776e-02  9.72833922e-01]
  HOMO = -0.504918950948493  LUMO = 2.61952914279998
  mo_energy =
[-1.18455144e+02 -1.20987964e+01 -9.43194145e+00 -9.43194145e+00
 -9.43194145e+00 -1.19132619e+00 -5.04918951e-01 -5.04918951e-01
 -5.04918951e-01  2.61952914e+00  2.61952914e+00  2.61952914e+00
  2.55300546e+01  2.55300546e+01  2.55300546e+01  1.11887467e+02
  1.56699156e+02  1.56699156e+02  1.56699156e+02  5.24173455e+02
  5.24173455e+02  5.24173455e+02  1.00698188e+03  1.23669985e+03
  1.23669985e+03  1.23669985e+03  2.50952436e+03  2.50952436e+03
  2.50952436e+03  4.80141220e+03  4.80141220e+03  4.80141220e+03
  5.66616846e+03  8.98534725e+03  8.98534725e+03  8.98534725e+03
  2.10711625e+04  7.16189213e+04]
E1 = -728.6677627210746  E_coul = 202.76900647668143
cycle= 3 E= -525.898756244393  delta_E= -2.82e-06  |g|= 0.00142  |ddm|= 0.00147
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00286258
diis-c [-2.86138235e-07 -1.09027105e-03  8.38138451e-02  9.17276426e-01]
  HOMO = -0.505127062793184  LUMO = 2.61915752155128
  mo_energy =
[-1.18457660e+02 -1.20999483e+01 -9.43314505e+00 -9.43314505e+00
 -9.43314505e+00 -1.19159146e+00 -5.05127063e-01 -5.05127063e-01
 -5.05127063e-01  2.61915752e+00  2.61915752e+00  2.61915752e+00
  2.55287434e+01  2.55287434e+01  2.55287434e+01  1.11885343e+02
  1.56697020e+02  1.56697020e+02  1.56697020e+02  5.24171005e+02
  5.24171005e+02  5.24171005e+02  1.00697903e+03  1.23669721e+03
  1.23669721e+03  1.23669721e+03  2.50952158e+03  2.50952158e+03
  2.50952158e+03  4.80140928e+03  4.80140928e+03  4.80140928e+03
  5.66616530e+03  8.98534417e+03  8.98534417e+03  8.98534417e+03
  2.10711592e+04  7.16189179e+04]
E1 = -728.6704361497879  E_coul = 202.77167986148908
cycle= 4 E= -525.898756288299  delta_E= -4.39e-08  |g|= 4.9e-05  |ddm|= 0.000249
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.67919e-05
diis-c [-7.81786201e-10  3.85058247e-06 -1.39694919e-03  8.01223067e-03
  9.93380868e-01]
  HOMO = -0.505111071162486  LUMO = 2.61918446531288
  mo_energy =
[-1.18457564e+02 -1.20998760e+01 -9.43307245e+00 -9.43307245e+00
 -9.43307245e+00 -1.19157081e+00 -5.05111071e-01 -5.05111071e-01
 -5.05111071e-01  2.61918447e+00  2.61918447e+00  2.61918447e+00
  2.55288170e+01  2.55288170e+01  2.55288170e+01  1.11885437e+02
  1.56697112e+02  1.56697112e+02  1.56697112e+02  5.24171101e+02
  5.24171101e+02  5.24171101e+02  1.00697912e+03  1.23669731e+03
  1.23669731e+03  1.23669731e+03  2.50952167e+03  2.50952167e+03
  2.50952167e+03  4.80140937e+03  4.80140937e+03  4.80140937e+03
  5.66616539e+03  8.98534426e+03  8.98534426e+03  8.98534426e+03
  2.10711593e+04  7.16189180e+04]
E1 = -728.6703169472296  E_coul = 202.77156065885973
cycle= 5 E= -525.89875628837  delta_E= -7.12e-11  |g|= 3.88e-06  |ddm|= 1.32e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -728.6703169472296  E_coul = 202.77156065885973
  HOMO = -0.505112320342119  LUMO = 2.61918240080974
  mo_energy =
[-1.18457572e+02 -1.20998816e+01 -9.43307814e+00 -9.43307814e+00
 -9.43307814e+00 -1.19157242e+00 -5.05112320e-01 -5.05112320e-01
 -5.05112320e-01  2.61918240e+00  2.61918240e+00  2.61918240e+00
  2.55288112e+01  2.55288112e+01  2.55288112e+01  1.11885429e+02
  1.56697104e+02  1.56697104e+02  1.56697104e+02  5.24171092e+02
  5.24171092e+02  5.24171092e+02  1.00697911e+03  1.23669730e+03
  1.23669730e+03  1.23669730e+03  2.50952167e+03  2.50952167e+03
  2.50952167e+03  4.80140936e+03  4.80140936e+03  4.80140936e+03
  5.66616538e+03  8.98534425e+03  8.98534425e+03  8.98534425e+03
  2.10711593e+04  7.16189180e+04]
E1 = -728.6703270412335  E_coul = 202.7715707528628
Extra cycle  E= -525.898756288371  delta_E= -7.96e-13  |g|= 7.45e-07  |ddm|= 1.05e-06
    CPU time for scf_cycle      0.30 sec, wall time      0.19 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 187438.26270591962
E1 = -728.6703270412335  E_coul = 202.7715707528628
init E= -525.898756288371
    CPU time for initialize scf      1.21 sec, wall time      0.20 sec
  HOMO = -0.50511218821554  LUMO = 2.61918263906883
  mo_energy =
[-1.18457571e+02 -1.20998808e+01 -9.43307738e+00 -9.43307738e+00
 -9.43307738e+00 -1.19157225e+00 -5.05112188e-01 -5.05112188e-01
 -5.05112188e-01  2.61918264e+00  2.61918264e+00  2.61918264e+00
  2.55288120e+01  2.55288120e+01  2.55288120e+01  1.11885431e+02
  1.56697105e+02  1.56697105e+02  1.56697105e+02  5.24171094e+02
  5.24171094e+02  5.24171094e+02  1.00697911e+03  1.23669730e+03
  1.23669730e+03  1.23669730e+03  2.50952167e+03  2.50952167e+03
  2.50952167e+03  4.80140936e+03  4.80140936e+03  4.80140936e+03
  5.66616538e+03  8.98534425e+03  8.98534425e+03  8.98534425e+03
  2.10711593e+04  7.16189180e+04]
E1 = -728.6703254341994  E_coul = 202.77156914582832
cycle= 1 E= -525.898756288371  delta_E= -3.41e-13  |g|= 1.24e-07  |ddm|= 1.54e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.6703254341994  E_coul = 202.77156914582832
  HOMO = -0.505112208532108  LUMO = 2.61918260232363
  mo_energy =
[-1.18457571e+02 -1.20998810e+01 -9.43307750e+00 -9.43307750e+00
 -9.43307750e+00 -1.19157227e+00 -5.05112209e-01 -5.05112209e-01
 -5.05112209e-01  2.61918260e+00  2.61918260e+00  2.61918260e+00
  2.55288119e+01  2.55288119e+01  2.55288119e+01  1.11885430e+02
  1.56697105e+02  1.56697105e+02  1.56697105e+02  5.24171094e+02
  5.24171094e+02  5.24171094e+02  1.00697911e+03  1.23669730e+03
  1.23669730e+03  1.23669730e+03  2.50952167e+03  2.50952167e+03
  2.50952167e+03  4.80140936e+03  4.80140936e+03  4.80140936e+03
  5.66616538e+03  8.98534425e+03  8.98534425e+03  8.98534425e+03
  2.10711593e+04  7.16189180e+04]
E1 = -728.6703256948045  E_coul = 202.77156940643314
Extra cycle  E= -525.898756288371  delta_E= -3.41e-13  |g|= 2.05e-08  |ddm|= 2.46e-08
    CPU time for scf_cycle      1.32 sec, wall time      0.31 sec
exp = [2.61851740e+04 7.58898960e+03 3.56004243e+03 7.11079342e+02
 1.58466564e+02 4.12770566e+01 4.57633269e+00 3.80968450e-01
 1.36268184e+03 6.53299241e+02 2.41503598e+02 2.61921674e+02
 7.99842091e+02 2.37658860e+01 1.06187859e+02 1.47427356e+00
 5.98729487e+00 3.74863121e-01]
grad_E = [-4.75230691e-07 -3.64776420e-07  1.23225788e-05  5.83546931e-04
  3.54999140e-03 -2.42676274e-02 -3.74191234e-02 -1.25635042e-01
  9.25993689e-09  2.44552726e-06  2.41292463e-05  2.19047756e-05
  1.68456223e-06  7.99635458e-02  5.96941160e-05  8.00591340e-03
 -2.99920697e-01  6.67464126e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26187.2711775        1
[INPUT] 0    0    [1    /1   ]  7566.08390034        1
[INPUT] 0    0    [1    /1   ]  3514.64085382        1
[INPUT] 0    0    [1    /1   ]  1.0078338164e-09      1
[INPUT] 0    0    [1    /1   ]  36.6924104848        1
[INPUT] 0    0    [1    /1   ]  26.1100944599        1
[INPUT] 0    0    [1    /1   ]  4.65776975447        1
[INPUT] 0    0    [1    /1   ]  0.393891058685       1
[INPUT] 1    0    [1    /1   ]  1363.15071738        1
[INPUT] 1    0    [1    /1   ]  648.659732298        1
[INPUT] 1    0    [1    /1   ]  219.53836594         1
[INPUT] 1    0    [1    /1   ]  242.825350917        1
[INPUT] 1    0    [1    /1   ]  826.744126139        1
[INPUT] 1    0    [1    /1   ]  1.00030561612e-09      1
[INPUT] 1    0    [1    /1   ]  26.4507734015        1
[INPUT] 1    0    [1    /1   ]  1.94187168961        1
[INPUT] 1    0    [1    /1   ]  2.64391812384        1
[INPUT] 1    0    [1    /1   ]  0.231107481144       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26187.271177503662, 1.0]], [0, [7566.083900342328, 1.0]], [0, [3514.6408538156975, 1.0]], [0, [1.0078338164021261e-09, 1.0]], [0, [36.69241048481554, 1.0]], [0, [26.11009445986753, 1.0]], [0, [4.657769754471492, 1.0]], [0, [0.39389105868534835, 1.0]], [1, [1363.1507173754244, 1.0]], [1, [648.6597322978339, 1.0]], [1, [219.53836594027348, 1.0]], [1, [242.8253509168175, 1.0]], [1, [826.7441261386473, 1.0]], [1, [1.0003056161167478e-09, 1.0]], [1, [26.450773401472162, 1.0]], [1, [1.941871689611174, 1.0]], [1, [2.643918123837817, 1.0]], [1, [0.23110748114429125, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26187.2711775]
bas 1, expnt(s) = [7566.08390034]
bas 2, expnt(s) = [3514.64085382]
bas 3, expnt(s) = [1.00783382e-09]
bas 4, expnt(s) = [36.69241048]
bas 5, expnt(s) = [26.11009446]
bas 6, expnt(s) = [4.65776975]
bas 7, expnt(s) = [0.39389106]
bas 8, expnt(s) = [1363.15071738]
bas 9, expnt(s) = [648.6597323]
bas 10, expnt(s) = [219.53836594]
bas 11, expnt(s) = [242.82535092]
bas 12, expnt(s) = [826.74412614]
bas 13, expnt(s) = [1.00030562e-09]
bas 14, expnt(s) = [26.4507734]
bas 15, expnt(s) = [1.94187169]
bas 16, expnt(s) = [2.64391812]
bas 17, expnt(s) = [0.23110748]
CPU time:       570.31
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61872712e+04 5.20095036e+03 7.56608390e+03 2.04959659e+03
 3.51464085e+03 1.15325604e+03 1.00783382e-09 4.51914961e-07
 3.66924105e+01 3.76658009e+01 2.61100945e+01 2.91824236e+01
 4.65776975e+00 8.01029548e+00 3.93891059e-01 1.25616624e+00
 1.36315072e+03 2.41637447e+04 6.48659732e+02 9.55004825e+03
 2.19538366e+02 2.46531505e+03 2.42825351e+02 2.79641694e+03
 8.26744126e+02 1.29329706e+04 1.00030562e-09 1.64115756e-11
 2.64507734e+01 1.74997708e+02 1.94187169e+00 6.68744241e+00
 2.64391812e+00 9.83545362e+00 2.31107481e-01 4.67468012e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.434803873749154
cond(S) = 24378.989730536072
E1 = -194.1895278196861  E_coul = 183.78276367672166
init E= -10.4067641429644
    CPU time for initialize scf      0.60 sec, wall time      0.07 sec
  HOMO = -0.836256214225554  LUMO = -0.000605641831320806
  mo_energy =
[-8.82420539e+01 -9.87012265e+00 -9.21214396e+00 -9.21214396e+00
 -9.21214396e+00 -1.28948792e+00 -8.36256214e-01 -8.36256214e-01
 -8.36256214e-01 -6.05641831e-04 -6.05641831e-04 -6.05641831e-04
 -2.86312794e-05  1.46906792e+00  1.46906792e+00  1.46906792e+00
  1.66742781e+01  1.66742781e+01  1.66742781e+01  3.80415190e+01
  2.31599815e+02  2.31599815e+02  2.31599815e+02  8.52227243e+02
  8.52227243e+02  8.52227243e+02  2.06959925e+03  2.06959925e+03
  2.06959925e+03  2.98360781e+03  4.34966018e+03  4.34966018e+03
  4.34966018e+03  8.56421506e+03  8.56421506e+03  8.56421506e+03
  1.81979285e+04  6.88035941e+04]
E1 = -630.230297578904  E_coul = 186.81842259011478
cycle= 1 E= -443.411874988789  delta_E= -433  |g|=  2.7  |ddm|= 32.5
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=4.51
diis-c [-20.34006474   1.        ]
  HOMO = -0.579469029011096  LUMO = -0.000605641830844955
  mo_energy =
[-8.90457149e+01 -9.63163078e+00 -8.96703190e+00 -8.96703190e+00
 -8.96703190e+00 -9.92775126e-01 -5.79469029e-01 -5.79469029e-01
 -5.79469029e-01 -6.05641831e-04 -6.05641831e-04 -6.05641830e-04
  1.51223721e-09  1.77614476e+00  1.77614476e+00  1.77614476e+00
  1.68941653e+01  1.68941653e+01  1.68941653e+01  3.83671859e+01
  2.31333589e+02  2.31333589e+02  2.31333589e+02  8.51623032e+02
  8.51623032e+02  8.51623032e+02  2.06853557e+03  2.06853557e+03
  2.06853557e+03  2.98091849e+03  4.34797652e+03  4.34797652e+03
  4.34797652e+03  8.56121195e+03  8.56121195e+03  8.56121195e+03
  1.81925582e+04  6.87972894e+04]
E1 = -628.205325743422  E_coul = 184.77126610954343
cycle= 2 E= -443.434059633879  delta_E= -0.0222  |g|= 0.0935  |ddm|= 1.89
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.14923
diis-c [-0.02126046 -0.00709769  1.00709769]
  HOMO = -0.62119952058032  LUMO = -0.000605641830822261
  mo_energy =
[-8.92510973e+01 -9.78634144e+00 -9.12683415e+00 -9.12683415e+00
 -9.12683415e+00 -1.05745872e+00 -6.21199521e-01 -6.21199521e-01
 -6.21199521e-01 -6.05641831e-04 -6.05641830e-04 -6.05641830e-04
  1.51218684e-09  1.71338925e+00  1.71338925e+00  1.71338925e+00
  1.67374633e+01  1.67374633e+01  1.67374633e+01  3.81983381e+01
  2.31126648e+02  2.31126648e+02  2.31126648e+02  8.51409423e+02
  8.51409423e+02  8.51409423e+02  2.06831869e+03  2.06831869e+03
  2.06831869e+03  2.98069534e+03  4.34775693e+03  4.34775693e+03
  4.34775693e+03  8.56098869e+03  8.56098869e+03  8.56098869e+03
  1.81923289e+04  6.87970579e+04]
E1 = -628.6182337594981  E_coul = 185.1836339175023
cycle= 3 E= -443.434599841996  delta_E= -0.00054  |g|= 0.0294  |ddm|= 0.28
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0443365
diis-c [-4.28001750e-05 -1.23217341e-03  2.32357966e-01  7.68874207e-01]
  HOMO = -0.615838207519599  LUMO = -0.000605641830614374
  mo_energy =
[-8.92105879e+01 -9.76192434e+00 -9.10187641e+00 -9.10187641e+00
 -9.10187641e+00 -1.04876914e+00 -6.15838208e-01 -6.15838208e-01
 -6.15838208e-01 -6.05641831e-04 -6.05641830e-04 -6.05641830e-04
  1.51217758e-09  1.72197502e+00  1.72197502e+00  1.72197502e+00
  1.67630949e+01  1.67630949e+01  1.67630949e+01  3.82275183e+01
  2.31168140e+02  2.31168140e+02  2.31168140e+02  8.51453486e+02
  8.51453486e+02  8.51453486e+02  2.06836387e+03  2.06836387e+03
  2.06836387e+03  2.98074181e+03  4.34780280e+03  4.34780280e+03
  4.34780280e+03  8.56103502e+03  8.56103502e+03  8.56103502e+03
  1.81923757e+04  6.87971047e+04]
E1 = -628.5460940637308  E_coul = 185.11146478476712
cycle= 4 E= -443.434629278964  delta_E= -2.94e-05  |g|= 0.000985  |ddm|= 0.0393
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0011157
diis-c [-1.14905344e-07 -1.22623407e-04  1.79980668e-02  3.81956358e-02
  9.43928921e-01]
  HOMO = -0.61535039469084  LUMO = -0.000605641830657203
  mo_energy =
[-8.92087198e+01 -9.76018492e+00 -9.10013901e+00 -9.10013901e+00
 -9.10013901e+00 -1.04799801e+00 -6.15350395e-01 -6.15350395e-01
 -6.15350395e-01 -6.05641831e-04 -6.05641831e-04 -6.05641830e-04
  1.51217747e-09  1.72271789e+00  1.72271789e+00  1.72271789e+00
  1.67647173e+01  1.67647173e+01  1.67647173e+01  3.82293310e+01
  2.31170008e+02  2.31170008e+02  2.31170008e+02  8.51455329e+02
  8.51455329e+02  8.51455329e+02  2.06836569e+03  2.06836569e+03
  2.06836569e+03  2.98074357e+03  4.34780459e+03  4.34780459e+03
  4.34780459e+03  8.56103678e+03  8.56103678e+03  8.56103678e+03
  1.81923774e+04  6.87971065e+04]
E1 = -628.5421531767964  E_coul = 185.10752381668354
cycle= 5 E= -443.434629360113  delta_E= -8.11e-08  |g|= 4.36e-05  |ddm|= 0.003
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=8.50556e-05
diis-c [-2.06248556e-11  3.03378928e-06 -6.80377038e-04  9.57912705e-04
 -5.84910341e-02  1.05821046e+00]
  HOMO = -0.615354310727597  LUMO = -0.000605641830602917
  mo_energy =
[-8.92087655e+01 -9.76020156e+00 -9.10016042e+00 -9.10016042e+00
 -9.10016042e+00 -1.04800326e+00 -6.15354311e-01 -6.15354311e-01
 -6.15354311e-01 -6.05641831e-04 -6.05641830e-04 -6.05641830e-04
  1.51217710e-09  1.72271198e+00  1.72271198e+00  1.72271198e+00
  1.67646923e+01  1.67646923e+01  1.67646923e+01  3.82293095e+01
  2.31169961e+02  2.31169961e+02  2.31169961e+02  8.51455274e+02
  8.51455274e+02  8.51455274e+02  2.06836563e+03  2.06836563e+03
  2.06836563e+03  2.98074350e+03  4.34780453e+03  4.34780453e+03
  4.34780453e+03  8.56103672e+03  8.56103672e+03  8.56103672e+03
  1.81923773e+04  6.87971064e+04]
E1 = -628.5422393676832  E_coul = 185.10761000751788
cycle= 6 E= -443.434629360165  delta_E= -5.24e-11  |g|= 6.08e-07  |ddm|= 5.13e-05
    CPU time for cycle= 6      0.02 sec, wall time      0.02 sec
E1 = -628.5422393676832  E_coul = 185.10761000751788
  HOMO = -0.615354095349629  LUMO = -0.000605641831934282
  mo_energy =
[-8.92087647e+01 -9.76020076e+00 -9.10015967e+00 -9.10015967e+00
 -9.10015967e+00 -1.04800292e+00 -6.15354095e-01 -6.15354095e-01
 -6.15354095e-01 -6.05641832e-04 -6.05641831e-04 -6.05641831e-04
  1.51218532e-09  1.72271229e+00  1.72271229e+00  1.72271229e+00
  1.67646930e+01  1.67646930e+01  1.67646930e+01  3.82293103e+01
  2.31169962e+02  2.31169962e+02  2.31169962e+02  8.51455275e+02
  8.51455275e+02  8.51455275e+02  2.06836563e+03  2.06836563e+03
  2.06836563e+03  2.98074350e+03  4.34780453e+03  4.34780453e+03
  4.34780453e+03  8.56103672e+03  8.56103672e+03  8.56103672e+03
  1.81923773e+04  6.87971064e+04]
E1 = -628.5422377771212  E_coul = 185.10760841695526
Extra cycle  E= -443.434629360166  delta_E= -5.68e-13  |g|= 8.51e-08  |ddm|= 9.22e-07
    CPU time for scf_cycle      0.77 sec, wall time      0.24 sec
exp = [2.61872712e+04 7.56608390e+03 3.51464085e+03 1.00783382e-09
 3.66924105e+01 2.61100945e+01 4.65776975e+00 3.93891059e-01
 1.36315072e+03 6.48659732e+02 2.19538366e+02 2.42825351e+02
 8.26744126e+02 1.00030562e-09 2.64507734e+01 1.94187169e+00
 2.64391812e+00 2.31107481e-01]
E = -443.4346293601659
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.3837412        1
[INPUT] 0    0    [1    /1   ]  7586.69902659        1
[INPUT] 0    0    [1    /1   ]  3555.50227653        1
[INPUT] 0    0    [1    /1   ]  639.971407921        1
[INPUT] 0    0    [1    /1   ]  146.289148958        1
[INPUT] 0    0    [1    /1   ]  39.7603603875        1
[INPUT] 0    0    [1    /1   ]  4.58447639453        1
[INPUT] 0    0    [1    /1   ]  0.382260710767       1
[INPUT] 1    0    [1    /1   ]  1362.72872858        1
[INPUT] 1    0    [1    /1   ]  652.835290058        1
[INPUT] 1    0    [1    /1   ]  239.307074449        1
[INPUT] 1    0    [1    /1   ]  260.012041576        1
[INPUT] 1    0    [1    /1   ]  802.532294608        1
[INPUT] 1    0    [1    /1   ]  21.389297409         1
[INPUT] 1    0    [1    /1   ]  98.2141502203        1
[INPUT] 1    0    [1    /1   ]  1.52103337324        1
[INPUT] 1    0    [1    /1   ]  5.65295719705        1
[INPUT] 1    0    [1    /1   ]  0.360487556903       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.383741248676, 1.0]], [0, [7586.699026589425, 1.0]], [0, [3555.502276525693, 1.0]], [0, [639.9714079209725, 1.0]], [0, [146.28914895773997, 1.0]], [0, [39.76036038748597, 1.0]], [0, [4.584476394530335, 1.0]], [0, [0.3822607107668595, 1.0]], [1, [1362.7287285799177, 1.0]], [1, [652.835290057532, 1.0]], [1, [239.30707444910422, 1.0]], [1, [260.0120415761584, 1.0]], [1, [802.5322946079027, 1.0]], [1, [21.38929740896539, 1.0]], [1, [98.2141502203042, 1.0]], [1, [1.521033373236153, 1.0]], [1, [5.652957197046486, 1.0]], [1, [0.36048755690283574, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.38374125]
bas 1, expnt(s) = [7586.69902659]
bas 2, expnt(s) = [3555.50227653]
bas 3, expnt(s) = [639.97140792]
bas 4, expnt(s) = [146.28914896]
bas 5, expnt(s) = [39.76036039]
bas 6, expnt(s) = [4.58447639]
bas 7, expnt(s) = [0.38226071]
bas 8, expnt(s) = [1362.72872858]
bas 9, expnt(s) = [652.83529006]
bas 10, expnt(s) = [239.30707445]
bas 11, expnt(s) = [260.01204158]
bas 12, expnt(s) = [802.53229461]
bas 13, expnt(s) = [21.38929741]
bas 14, expnt(s) = [98.21415022]
bas 15, expnt(s) = [1.52103337]
bas 16, expnt(s) = [5.6529572]
bas 17, expnt(s) = [0.36048756]
CPU time:       571.33
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61853837e+04 5.20066921e+03 7.58669903e+03 2.05378353e+03
 3.55550228e+03 1.16329737e+03 6.39971408e+02 3.21466301e+02
 1.46289149e+02 1.06273286e+02 3.97603604e+01 4.00039392e+01
 4.58447639e+00 7.91557248e+00 3.82260711e-01 1.22824434e+00
 1.36272873e+03 2.41543946e+04 6.52835290e+02 9.62695454e+03
 2.39307074e+02 2.74586268e+03 2.60012042e+02 3.04597419e+03
 8.02532295e+02 1.24612767e+04 2.13892974e+01 1.34193055e+02
 9.82141502e+01 9.01990517e+02 1.52103337e+00 4.92785388e+00
 5.65295720e+00 2.54289843e+01 3.60487557e-01 8.14886721e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.906127864658025
cond(S) = 148411.0577291918
E1 = -727.7302399510729  E_coul = 202.7246071399229
init E= -525.00563281115
    CPU time for initialize scf      0.13 sec, wall time      0.04 sec
  HOMO = -0.552253069336594  LUMO = 2.55395275514282
  mo_energy =
[-1.18286526e+02 -1.21147431e+01 -9.44827408e+00 -9.44827408e+00
 -9.44827408e+00 -1.24301253e+00 -5.52253069e-01 -5.52253069e-01
 -5.52253069e-01  2.55395276e+00  2.55395276e+00  2.55395276e+00
  2.33044626e+01  2.33044626e+01  2.33044626e+01  1.02814915e+02
  1.44222411e+02  1.44222411e+02  1.44222411e+02  4.98795843e+02
  4.98795843e+02  4.98795843e+02  9.08426590e+02  1.19977899e+03
  1.19977899e+03  1.19977899e+03  2.46490954e+03  2.46490954e+03
  2.46490954e+03  4.75435407e+03  4.75435407e+03  4.75435407e+03
  5.40753556e+03  8.94087058e+03  8.94087058e+03  8.94087058e+03
  2.07607444e+04  7.13060589e+04]
E1 = -728.2752432660242  E_coul = 202.26030638763024
cycle= 1 E= -526.014936878394  delta_E= -1.01  |g|= 0.203  |ddm|= 0.904
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.551847
diis-c [-0.30453505  1.        ]
  HOMO = -0.522408310330194  LUMO = 2.58252537322536
  mo_energy =
[-1.18522649e+02 -1.21381858e+01 -9.47962795e+00 -9.47962795e+00
 -9.47962795e+00 -1.21057374e+00 -5.22408310e-01 -5.22408310e-01
 -5.22408310e-01  2.58252537e+00  2.58252537e+00  2.58252537e+00
  2.32593482e+01  2.32593482e+01  2.32593482e+01  1.02682713e+02
  1.44061963e+02  1.44061963e+02  1.44061963e+02  4.98578683e+02
  4.98578683e+02  4.98578683e+02  9.08084323e+02  1.19951191e+03
  1.19951191e+03  1.19951191e+03  2.46458743e+03  2.46458743e+03
  2.46458743e+03  4.75396786e+03  4.75396786e+03  4.75396786e+03
  5.40698663e+03  8.94037516e+03  8.94037516e+03  8.94037516e+03
  2.07600714e+04  7.13052948e+04]
E1 = -728.4045240128889  E_coul = 202.38921887913696
cycle= 2 E= -526.015305133752  delta_E= -0.000368  |g|= 0.0192  |ddm|= 0.0138
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0321694
diis-c [-6.31148459e-04  3.51662153e-02  9.64833785e-01]
  HOMO = -0.522256463891968  LUMO = 2.58363066975387
  mo_energy =
[-1.18494423e+02 -1.21299993e+01 -9.47126370e+00 -9.47126370e+00
 -9.47126370e+00 -1.21033020e+00 -5.22256464e-01 -5.22256464e-01
 -5.22256464e-01  2.58363067e+00  2.58363067e+00  2.58363067e+00
  2.32688472e+01  2.32688472e+01  2.32688472e+01  1.02705717e+02
  1.44084071e+02  1.44084071e+02  1.44084071e+02  4.98605926e+02
  4.98605926e+02  4.98605926e+02  9.08115751e+02  1.19954158e+03
  1.19954158e+03  1.19954158e+03  2.46461871e+03  2.46461871e+03
  2.46461871e+03  4.75400027e+03  4.75400027e+03  4.75400027e+03
  5.40702004e+03  8.94040830e+03  8.94040830e+03  8.94040830e+03
  2.07601051e+04  7.13053285e+04]
E1 = -728.376241886196  E_coul = 202.36093194149666
cycle= 3 E= -526.015309944699  delta_E= -4.81e-06  |g|= 0.00182  |ddm|= 0.00224
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00365594
diis-c [-2.79823410e-07 -1.05680813e-03  9.06630803e-02  9.10393728e-01]
  HOMO = -0.522527461770767  LUMO = 2.58313948431973
  mo_energy =
[-1.18497603e+02 -1.21315006e+01 -9.47282905e+00 -9.47282905e+00
 -9.47282905e+00 -1.21068066e+00 -5.22527462e-01 -5.22527462e-01
 -5.22527462e-01  2.58313948e+00  2.58313948e+00  2.58313948e+00
  2.32672366e+01  2.32672366e+01  2.32672366e+01  1.02703062e+02
  1.44081387e+02  1.44081387e+02  1.44081387e+02  4.98602836e+02
  4.98602836e+02  4.98602836e+02  9.08112226e+02  1.19953826e+03
  1.19953826e+03  1.19953826e+03  2.46461522e+03  2.46461522e+03
  2.46461522e+03  4.75399663e+03  4.75399663e+03  4.75399663e+03
  5.40701615e+03  8.94040449e+03  8.94040449e+03  8.94040449e+03
  2.07601011e+04  7.13053244e+04]
E1 = -728.3797477621191  E_coul = 202.36443774275907
cycle= 4 E= -526.01531001936  delta_E= -7.47e-08  |g|= 4.05e-05  |ddm|= 0.000324
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.13729e-05
diis-c [-6.78650985e-10  6.01645875e-06 -1.53249488e-03 -1.92324491e-03
  1.00344972e+00]
  HOMO = -0.522512880124712  LUMO = 2.58316423652782
  mo_energy =
[-1.18497522e+02 -1.21314361e+01 -9.47276454e+00 -9.47276454e+00
 -9.47276454e+00 -1.21066149e+00 -5.22512880e-01 -5.22512880e-01
 -5.22512880e-01  2.58316424e+00  2.58316424e+00  2.58316424e+00
  2.32672994e+01  2.32672994e+01  2.32672994e+01  1.02703143e+02
  1.44081465e+02  1.44081465e+02  1.44081465e+02  4.98602917e+02
  4.98602917e+02  4.98602917e+02  9.08112301e+02  1.19953834e+03
  1.19953834e+03  1.19953834e+03  2.46461530e+03  2.46461530e+03
  2.46461530e+03  4.75399671e+03  4.75399671e+03  4.75399671e+03
  5.40701621e+03  8.94040456e+03  8.94040456e+03  8.94040456e+03
  2.07601011e+04  7.13053245e+04]
E1 = -728.3796423900293  E_coul = 202.364332370615
cycle= 5 E= -526.015310019414  delta_E= -5.42e-11  |g|= 3.86e-06  |ddm|= 1.18e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -728.3796423900293  E_coul = 202.364332370615
  HOMO = -0.5225141195509  LUMO = 2.58316214782006
  mo_energy =
[-1.18497531e+02 -1.21314417e+01 -9.47277025e+00 -9.47277025e+00
 -9.47277025e+00 -1.21066310e+00 -5.22514120e-01 -5.22514120e-01
 -5.22514120e-01  2.58316215e+00  2.58316215e+00  2.58316215e+00
  2.32672938e+01  2.32672938e+01  2.32672938e+01  1.02703135e+02
  1.44081457e+02  1.44081457e+02  1.44081457e+02  4.98602908e+02
  4.98602908e+02  4.98602908e+02  9.08112292e+02  1.19953833e+03
  1.19953833e+03  1.19953833e+03  2.46461529e+03  2.46461529e+03
  2.46461529e+03  4.75399670e+03  4.75399670e+03  4.75399670e+03
  5.40701620e+03  8.94040455e+03  8.94040455e+03  8.94040455e+03
  2.07601011e+04  7.13053245e+04]
E1 = -728.379652816166  E_coul = 202.36434279675154
Extra cycle  E= -526.015310019414  delta_E= -1.14e-13  |g|= 7.6e-07  |ddm|= 1.07e-06
    CPU time for scf_cycle      0.28 sec, wall time      0.19 sec
exp = [2.61853837e+04 7.58669903e+03 3.55550228e+03 6.39971408e+02
 1.46289149e+02 3.97603604e+01 4.58447639e+00 3.82260711e-01
 1.36272873e+03 6.52835290e+02 2.39307074e+02 2.60012042e+02
 8.02532295e+02 2.13892974e+01 9.82141502e+01 1.52103337e+00
 5.65295720e+00 3.60487557e-01]
E = -526.0153100194144
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.3837412        1
[INPUT] 0    0    [1    /1   ]  7586.69902659        1
[INPUT] 0    0    [1    /1   ]  3555.50227653        1
[INPUT] 0    0    [1    /1   ]  639.971407921        1
[INPUT] 0    0    [1    /1   ]  146.289148958        1
[INPUT] 0    0    [1    /1   ]  39.7603603875        1
[INPUT] 0    0    [1    /1   ]  4.58447639453        1
[INPUT] 0    0    [1    /1   ]  0.382260710767       1
[INPUT] 1    0    [1    /1   ]  1362.72872858        1
[INPUT] 1    0    [1    /1   ]  652.835290058        1
[INPUT] 1    0    [1    /1   ]  239.307074449        1
[INPUT] 1    0    [1    /1   ]  260.012041576        1
[INPUT] 1    0    [1    /1   ]  802.532294608        1
[INPUT] 1    0    [1    /1   ]  21.389297409         1
[INPUT] 1    0    [1    /1   ]  98.2141502203        1
[INPUT] 1    0    [1    /1   ]  1.52103337324        1
[INPUT] 1    0    [1    /1   ]  5.65295719705        1
[INPUT] 1    0    [1    /1   ]  0.360487556903       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.383741248676, 1.0]], [0, [7586.699026589425, 1.0]], [0, [3555.502276525693, 1.0]], [0, [639.9714079209725, 1.0]], [0, [146.28914895773997, 1.0]], [0, [39.76036038748597, 1.0]], [0, [4.584476394530335, 1.0]], [0, [0.3822607107668595, 1.0]], [1, [1362.7287285799177, 1.0]], [1, [652.835290057532, 1.0]], [1, [239.30707444910422, 1.0]], [1, [260.0120415761584, 1.0]], [1, [802.5322946079027, 1.0]], [1, [21.38929740896539, 1.0]], [1, [98.2141502203042, 1.0]], [1, [1.521033373236153, 1.0]], [1, [5.652957197046486, 1.0]], [1, [0.36048755690283574, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.38374125]
bas 1, expnt(s) = [7586.69902659]
bas 2, expnt(s) = [3555.50227653]
bas 3, expnt(s) = [639.97140792]
bas 4, expnt(s) = [146.28914896]
bas 5, expnt(s) = [39.76036039]
bas 6, expnt(s) = [4.58447639]
bas 7, expnt(s) = [0.38226071]
bas 8, expnt(s) = [1362.72872858]
bas 9, expnt(s) = [652.83529006]
bas 10, expnt(s) = [239.30707445]
bas 11, expnt(s) = [260.01204158]
bas 12, expnt(s) = [802.53229461]
bas 13, expnt(s) = [21.38929741]
bas 14, expnt(s) = [98.21415022]
bas 15, expnt(s) = [1.52103337]
bas 16, expnt(s) = [5.6529572]
bas 17, expnt(s) = [0.36048756]
CPU time:       571.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61853837e+04 5.20066921e+03 7.58669903e+03 2.05378353e+03
 3.55550228e+03 1.16329737e+03 6.39971408e+02 3.21466301e+02
 1.46289149e+02 1.06273286e+02 3.97603604e+01 4.00039392e+01
 4.58447639e+00 7.91557248e+00 3.82260711e-01 1.22824434e+00
 1.36272873e+03 2.41543946e+04 6.52835290e+02 9.62695454e+03
 2.39307074e+02 2.74586268e+03 2.60012042e+02 3.04597419e+03
 8.02532295e+02 1.24612767e+04 2.13892974e+01 1.34193055e+02
 9.82141502e+01 9.01990517e+02 1.52103337e+00 4.92785388e+00
 5.65295720e+00 2.54289843e+01 3.60487557e-01 8.14886721e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.906127864658025
cond(S) = 148411.0577291918
E1 = -727.7302399510729  E_coul = 202.7246071399229
init E= -525.00563281115
    CPU time for initialize scf      0.13 sec, wall time      0.04 sec
  HOMO = -0.552253069336594  LUMO = 2.55395275514282
  mo_energy =
[-1.18286526e+02 -1.21147431e+01 -9.44827408e+00 -9.44827408e+00
 -9.44827408e+00 -1.24301253e+00 -5.52253069e-01 -5.52253069e-01
 -5.52253069e-01  2.55395276e+00  2.55395276e+00  2.55395276e+00
  2.33044626e+01  2.33044626e+01  2.33044626e+01  1.02814915e+02
  1.44222411e+02  1.44222411e+02  1.44222411e+02  4.98795843e+02
  4.98795843e+02  4.98795843e+02  9.08426590e+02  1.19977899e+03
  1.19977899e+03  1.19977899e+03  2.46490954e+03  2.46490954e+03
  2.46490954e+03  4.75435407e+03  4.75435407e+03  4.75435407e+03
  5.40753556e+03  8.94087058e+03  8.94087058e+03  8.94087058e+03
  2.07607444e+04  7.13060589e+04]
E1 = -728.2752432660242  E_coul = 202.26030638763024
cycle= 1 E= -526.014936878394  delta_E= -1.01  |g|= 0.203  |ddm|= 0.904
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.551847
diis-c [-0.30453505  1.        ]
  HOMO = -0.522408310330194  LUMO = 2.58252537322536
  mo_energy =
[-1.18522649e+02 -1.21381858e+01 -9.47962795e+00 -9.47962795e+00
 -9.47962795e+00 -1.21057374e+00 -5.22408310e-01 -5.22408310e-01
 -5.22408310e-01  2.58252537e+00  2.58252537e+00  2.58252537e+00
  2.32593482e+01  2.32593482e+01  2.32593482e+01  1.02682713e+02
  1.44061963e+02  1.44061963e+02  1.44061963e+02  4.98578683e+02
  4.98578683e+02  4.98578683e+02  9.08084323e+02  1.19951191e+03
  1.19951191e+03  1.19951191e+03  2.46458743e+03  2.46458743e+03
  2.46458743e+03  4.75396786e+03  4.75396786e+03  4.75396786e+03
  5.40698663e+03  8.94037516e+03  8.94037516e+03  8.94037516e+03
  2.07600714e+04  7.13052948e+04]
E1 = -728.4045240128889  E_coul = 202.38921887913696
cycle= 2 E= -526.015305133752  delta_E= -0.000368  |g|= 0.0192  |ddm|= 0.0138
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0321694
diis-c [-6.31148459e-04  3.51662153e-02  9.64833785e-01]
  HOMO = -0.522256463891968  LUMO = 2.58363066975387
  mo_energy =
[-1.18494423e+02 -1.21299993e+01 -9.47126370e+00 -9.47126370e+00
 -9.47126370e+00 -1.21033020e+00 -5.22256464e-01 -5.22256464e-01
 -5.22256464e-01  2.58363067e+00  2.58363067e+00  2.58363067e+00
  2.32688472e+01  2.32688472e+01  2.32688472e+01  1.02705717e+02
  1.44084071e+02  1.44084071e+02  1.44084071e+02  4.98605926e+02
  4.98605926e+02  4.98605926e+02  9.08115751e+02  1.19954158e+03
  1.19954158e+03  1.19954158e+03  2.46461871e+03  2.46461871e+03
  2.46461871e+03  4.75400027e+03  4.75400027e+03  4.75400027e+03
  5.40702004e+03  8.94040830e+03  8.94040830e+03  8.94040830e+03
  2.07601051e+04  7.13053285e+04]
E1 = -728.376241886196  E_coul = 202.36093194149666
cycle= 3 E= -526.015309944699  delta_E= -4.81e-06  |g|= 0.00182  |ddm|= 0.00224
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00365594
diis-c [-2.79823410e-07 -1.05680813e-03  9.06630803e-02  9.10393728e-01]
  HOMO = -0.522527461770767  LUMO = 2.58313948431973
  mo_energy =
[-1.18497603e+02 -1.21315006e+01 -9.47282905e+00 -9.47282905e+00
 -9.47282905e+00 -1.21068066e+00 -5.22527462e-01 -5.22527462e-01
 -5.22527462e-01  2.58313948e+00  2.58313948e+00  2.58313948e+00
  2.32672366e+01  2.32672366e+01  2.32672366e+01  1.02703062e+02
  1.44081387e+02  1.44081387e+02  1.44081387e+02  4.98602836e+02
  4.98602836e+02  4.98602836e+02  9.08112226e+02  1.19953826e+03
  1.19953826e+03  1.19953826e+03  2.46461522e+03  2.46461522e+03
  2.46461522e+03  4.75399663e+03  4.75399663e+03  4.75399663e+03
  5.40701615e+03  8.94040449e+03  8.94040449e+03  8.94040449e+03
  2.07601011e+04  7.13053244e+04]
E1 = -728.3797477621191  E_coul = 202.36443774275907
cycle= 4 E= -526.01531001936  delta_E= -7.47e-08  |g|= 4.05e-05  |ddm|= 0.000324
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=5.13729e-05
diis-c [-6.78650985e-10  6.01645875e-06 -1.53249488e-03 -1.92324491e-03
  1.00344972e+00]
  HOMO = -0.522512880124712  LUMO = 2.58316423652782
  mo_energy =
[-1.18497522e+02 -1.21314361e+01 -9.47276454e+00 -9.47276454e+00
 -9.47276454e+00 -1.21066149e+00 -5.22512880e-01 -5.22512880e-01
 -5.22512880e-01  2.58316424e+00  2.58316424e+00  2.58316424e+00
  2.32672994e+01  2.32672994e+01  2.32672994e+01  1.02703143e+02
  1.44081465e+02  1.44081465e+02  1.44081465e+02  4.98602917e+02
  4.98602917e+02  4.98602917e+02  9.08112301e+02  1.19953834e+03
  1.19953834e+03  1.19953834e+03  2.46461530e+03  2.46461530e+03
  2.46461530e+03  4.75399671e+03  4.75399671e+03  4.75399671e+03
  5.40701621e+03  8.94040456e+03  8.94040456e+03  8.94040456e+03
  2.07601011e+04  7.13053245e+04]
E1 = -728.3796423900293  E_coul = 202.364332370615
cycle= 5 E= -526.015310019414  delta_E= -5.42e-11  |g|= 3.86e-06  |ddm|= 1.18e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -728.3796423900293  E_coul = 202.364332370615
  HOMO = -0.5225141195509  LUMO = 2.58316214782006
  mo_energy =
[-1.18497531e+02 -1.21314417e+01 -9.47277025e+00 -9.47277025e+00
 -9.47277025e+00 -1.21066310e+00 -5.22514120e-01 -5.22514120e-01
 -5.22514120e-01  2.58316215e+00  2.58316215e+00  2.58316215e+00
  2.32672938e+01  2.32672938e+01  2.32672938e+01  1.02703135e+02
  1.44081457e+02  1.44081457e+02  1.44081457e+02  4.98602908e+02
  4.98602908e+02  4.98602908e+02  9.08112292e+02  1.19953833e+03
  1.19953833e+03  1.19953833e+03  2.46461529e+03  2.46461529e+03
  2.46461529e+03  4.75399670e+03  4.75399670e+03  4.75399670e+03
  5.40701620e+03  8.94040455e+03  8.94040455e+03  8.94040455e+03
  2.07601011e+04  7.13053245e+04]
E1 = -728.379652816166  E_coul = 202.36434279675154
Extra cycle  E= -526.015310019414  delta_E= -1.14e-13  |g|= 7.6e-07  |ddm|= 1.07e-06
    CPU time for scf_cycle      0.27 sec, wall time      0.18 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 148411.0577291918
E1 = -728.379652816166  E_coul = 202.36434279675154
init E= -526.015310019414
    CPU time for initialize scf      1.19 sec, wall time      0.20 sec
  HOMO = -0.522513982331431  LUMO = 2.58316239795315
  mo_energy =
[-1.18497529e+02 -1.21314409e+01 -9.47276946e+00 -9.47276946e+00
 -9.47276946e+00 -1.21066292e+00 -5.22513982e-01 -5.22513982e-01
 -5.22513982e-01  2.58316240e+00  2.58316240e+00  2.58316240e+00
  2.32672946e+01  2.32672946e+01  2.32672946e+01  1.02703137e+02
  1.44081458e+02  1.44081458e+02  1.44081458e+02  4.98602910e+02
  4.98602910e+02  4.98602910e+02  9.08112294e+02  1.19953834e+03
  1.19953834e+03  1.19953834e+03  2.46461529e+03  2.46461529e+03
  2.46461529e+03  4.75399670e+03  4.75399670e+03  4.75399670e+03
  5.40701621e+03  8.94040455e+03  8.94040455e+03  8.94040455e+03
  2.07601011e+04  7.13053245e+04]
E1 = -728.3796511208529  E_coul = 202.3643411014389
cycle= 1 E= -526.015310019414  delta_E= 3.41e-13  |g|= 1.3e-07  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3796511208529  E_coul = 202.3643411014389
  HOMO = -0.522514003603195  LUMO = 2.58316235885502
  mo_energy =
[-1.18497530e+02 -1.21314411e+01 -9.47276959e+00 -9.47276959e+00
 -9.47276959e+00 -1.21066295e+00 -5.22514004e-01 -5.22514004e-01
 -5.22514004e-01  2.58316236e+00  2.58316236e+00  2.58316236e+00
  2.32672944e+01  2.32672944e+01  2.32672944e+01  1.02703136e+02
  1.44081458e+02  1.44081458e+02  1.44081458e+02  4.98602909e+02
  4.98602909e+02  4.98602909e+02  9.08112294e+02  1.19953834e+03
  1.19953834e+03  1.19953834e+03  2.46461529e+03  2.46461529e+03
  2.46461529e+03  4.75399670e+03  4.75399670e+03  4.75399670e+03
  5.40701621e+03  8.94040455e+03  8.94040455e+03  8.94040455e+03
  2.07601011e+04  7.13053245e+04]
E1 = -728.3796514028858  E_coul = 202.36434138347158
Extra cycle  E= -526.015310019414  delta_E= -1.14e-13  |g|= 2.22e-08  |ddm|= 2.61e-08
    CPU time for scf_cycle      1.30 sec, wall time      0.30 sec
exp = [2.61853837e+04 7.58669903e+03 3.55550228e+03 6.39971408e+02
 1.46289149e+02 3.97603604e+01 4.58447639e+00 3.82260711e-01
 1.36272873e+03 6.52835290e+02 2.39307074e+02 2.60012042e+02
 8.02532295e+02 2.13892974e+01 9.82141502e+01 1.52103337e+00
 5.65295720e+00 3.60487557e-01]
grad_E = [ 1.10348364e-07  2.28867627e-07  3.82496637e-05  3.62983734e-04
  1.74514685e-03 -1.61921604e-02 -2.82569007e-02 -1.31963807e-01
  1.30241133e-06  9.94016427e-06  9.72075902e-05  8.48495966e-05
  6.61904801e-06  5.29545272e-02  1.26890188e-03  1.11058346e-01
 -2.31394332e-01  1.60932075e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.5073529        1
[INPUT] 0    0    [1    /1   ]  7585.35637737        1
[INPUT] 0    0    [1    /1   ]  3552.85188428        1
[INPUT] 0    0    [1    /1   ]  598.234859563        1
[INPUT] 0    0    [1    /1   ]  135.056494852        1
[INPUT] 0    0    [1    /1   ]  38.5578510412        1
[INPUT] 0    0    [1    /1   ]  4.61116765831        1
[INPUT] 0    0    [1    /1   ]  0.391708786059       1
[INPUT] 1    0    [1    /1   ]  1362.79316022        1
[INPUT] 1    0    [1    /1   ]  652.872921186        1
[INPUT] 1    0    [1    /1   ]  239.774820739        1
[INPUT] 1    0    [1    /1   ]  260.443754389        1
[INPUT] 1    0    [1    /1   ]  766.566692508        1
[INPUT] 1    0    [1    /1   ]  18.0260721311        1
[INPUT] 1    0    [1    /1   ]  84.3814770926        1
[INPUT] 1    0    [1    /1   ]  1.57746717262        1
[INPUT] 1    0    [1    /1   ]  5.35582941099        1
[INPUT] 1    0    [1    /1   ]  0.360816063372       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.507352864017, 1.0]], [0, [7585.356377373308, 1.0]], [0, [3552.8518842792196, 1.0]], [0, [598.2348595628152, 1.0]], [0, [135.0564948516839, 1.0]], [0, [38.55785104116476, 1.0]], [0, [4.611167658313912, 1.0]], [0, [0.3917087860586975, 1.0]], [1, [1362.7931602161962, 1.0]], [1, [652.8729211862861, 1.0]], [1, [239.7748207394809, 1.0]], [1, [260.44375438946224, 1.0]], [1, [766.5666925081274, 1.0]], [1, [18.026072131079257, 1.0]], [1, [84.38147709256725, 1.0]], [1, [1.5774671726156413, 1.0]], [1, [5.355829410986076, 1.0]], [1, [0.3608160633716908, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.50735286]
bas 1, expnt(s) = [7585.35637737]
bas 2, expnt(s) = [3552.85188428]
bas 3, expnt(s) = [598.23485956]
bas 4, expnt(s) = [135.05649485]
bas 5, expnt(s) = [38.55785104]
bas 6, expnt(s) = [4.61116766]
bas 7, expnt(s) = [0.39170879]
bas 8, expnt(s) = [1362.79316022]
bas 9, expnt(s) = [652.87292119]
bas 10, expnt(s) = [239.77482074]
bas 11, expnt(s) = [260.44375439]
bas 12, expnt(s) = [766.56669251]
bas 13, expnt(s) = [18.02607213]
bas 14, expnt(s) = [84.38147709]
bas 15, expnt(s) = [1.57746717]
bas 16, expnt(s) = [5.35582941]
bas 17, expnt(s) = [0.36081606]
CPU time:       578.04
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61855074e+04 5.20068762e+03 7.58535638e+03 2.05351092e+03
 3.55285188e+03 1.16264694e+03 5.98234860e+02 3.05610880e+02
 1.35056495e+02 1.00092521e+02 3.85578510e+01 3.90930577e+01
 4.61116766e+00 7.95011131e+00 3.91708786e-01 1.25094296e+00
 1.36279316e+03 2.41558222e+04 6.52872921e+02 9.62764820e+03
 2.39774821e+02 2.75257310e+03 2.60443754e+02 3.05229726e+03
 7.66566693e+02 1.17671645e+04 1.80260721e+01 1.08357948e+02
 8.43814771e+01 7.46093569e+02 1.57746717e+00 5.15744738e+00
 5.35582941e+00 2.37693777e+01 3.60816063e-01 8.15815068e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.906506256655362
cond(S) = 135808.52307920696
E1 = -727.9846794341032  E_coul = 202.96022215388345
init E= -525.02445728022
    CPU time for initialize scf      0.17 sec, wall time      0.04 sec
  HOMO = -0.545961832289164  LUMO = 2.63720816858919
  mo_energy =
[-1.18262880e+02 -1.21009946e+01 -9.43374446e+00 -9.43374446e+00
 -9.43374446e+00 -1.23964069e+00 -5.45961832e-01 -5.45961832e-01
 -5.45961832e-01  2.63720817e+00  2.63720817e+00  2.63720817e+00
  2.08305412e+01  2.08305412e+01  2.08305412e+01  9.51440649e+01
  1.24960623e+02  1.24960623e+02  1.24960623e+02  4.57858652e+02
  4.57858652e+02  4.57858652e+02  8.37520309e+02  1.14297386e+03
  1.14297386e+03  1.14297386e+03  2.39190004e+03  2.39190004e+03
  2.39190004e+03  4.64692864e+03  4.64692864e+03  4.64692864e+03
  5.23772525e+03  8.78334299e+03  8.78334299e+03  8.78334299e+03
  2.05638067e+04  7.11097358e+04]
E1 = -728.5500892117216  E_coul = 202.50502505792457
cycle= 1 E= -526.045064153797  delta_E= -1.02  |g|= 0.195  |ddm|= 3.87
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.503687
diis-c [-0.25370077  1.        ]
  HOMO = -0.520325072155314  LUMO = 2.66013502397303
  mo_energy =
[-1.18483223e+02 -1.21256272e+01 -9.46245189e+00 -9.46245189e+00
 -9.46245189e+00 -1.21299128e+00 -5.20325072e-01 -5.20325072e-01
 -5.20325072e-01  2.66013502e+00  2.66013502e+00  2.66013502e+00
  2.07992321e+01  2.07992321e+01  2.07992321e+01  9.50302083e+01
  1.24823332e+02  1.24823332e+02  1.24823332e+02  4.57660038e+02
  4.57660038e+02  4.57660038e+02  8.37207248e+02  1.14272504e+03
  1.14272504e+03  1.14272504e+03  2.39159791e+03  2.39159791e+03
  2.39159791e+03  4.64656306e+03  4.64656306e+03  4.64656306e+03
  5.23719582e+03  8.78286724e+03  8.78286724e+03  8.78286724e+03
  2.05631513e+04  7.11089897e+04]
E1 = -728.6642980574053  E_coul = 202.61895589413393
cycle= 2 E= -526.045342163271  delta_E= -0.000278  |g|= 0.0165  |ddm|= 0.0116
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0293388
diis-c [-5.72373972e-04  3.26515794e-02  9.67348421e-01]
  HOMO = -0.520180391824519  LUMO = 2.66111581466514
  mo_energy =
[-1.18458492e+02 -1.21183418e+01 -9.45498005e+00 -9.45498005e+00
 -9.45498005e+00 -1.21274092e+00 -5.20180392e-01 -5.20180392e-01
 -5.20180392e-01  2.66111581e+00  2.66111581e+00  2.66111581e+00
  2.08064862e+01  2.08064862e+01  2.08064862e+01  9.50498518e+01
  1.24842003e+02  1.24842003e+02  1.24842003e+02  4.57683785e+02
  4.57683785e+02  4.57683785e+02  8.37234873e+02  1.14275112e+03
  1.14275112e+03  1.14275112e+03  2.39162551e+03  2.39162551e+03
  2.39162551e+03  4.64659177e+03  4.64659177e+03  4.64659177e+03
  5.23722562e+03  8.78289674e+03  8.78289674e+03  8.78289674e+03
  2.05631814e+04  7.11090199e+04]
E1 = -728.6394450156864  E_coul = 202.59409916422678
cycle= 3 E= -526.04534585146  delta_E= -3.69e-06  |g|= 0.00166  |ddm|= 0.00205
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00333722
diis-c [-1.53992891e-07 -8.30971156e-04  9.40353007e-02  9.06795670e-01]
  HOMO = -0.520408176234734  LUMO = 2.66068342987421
  mo_energy =
[-1.18461363e+02 -1.21196775e+01 -9.45637035e+00 -9.45637035e+00
 -9.45637035e+00 -1.21304207e+00 -5.20408176e-01 -5.20408176e-01
 -5.20408176e-01  2.66068343e+00  2.66068343e+00  2.66068343e+00
  2.08051634e+01  2.08051634e+01  2.08051634e+01  9.50475025e+01
  1.24839650e+02  1.24839650e+02  1.24839650e+02  4.57681012e+02
  4.57681012e+02  4.57681012e+02  8.37231732e+02  1.14274814e+03
  1.14274814e+03  1.14274814e+03  2.39162238e+03  2.39162238e+03
  2.39162238e+03  4.64658851e+03  4.64658851e+03  4.64658851e+03
  5.23722215e+03  8.78289333e+03  8.78289333e+03  8.78289333e+03
  2.05631779e+04  7.11090162e+04]
E1 = -728.6425947443264  E_coul = 202.5972488324132
cycle= 4 E= -526.045345911913  delta_E= -6.05e-08  |g|= 3.54e-05  |ddm|= 0.000288
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=4.86618e-05
diis-c [-4.41178768e-10 -5.17173458e-07 -6.65477919e-04  7.31179221e-03
  9.93354203e-01]
  HOMO = -0.520395572609428  LUMO = 2.66070522031096
  mo_energy =
[-1.18461291e+02 -1.21196215e+01 -9.45631434e+00 -9.45631434e+00
 -9.45631434e+00 -1.21302513e+00 -5.20395573e-01 -5.20395573e-01
 -5.20395573e-01  2.66070522e+00  2.66070522e+00  2.66070522e+00
  2.08052153e+01  2.08052153e+01  2.08052153e+01  9.50475731e+01
  1.24839718e+02  1.24839718e+02  1.24839718e+02  4.57681084e+02
  4.57681084e+02  4.57681084e+02  8.37231800e+02  1.14274821e+03
  1.14274821e+03  1.14274821e+03  2.39162245e+03  2.39162245e+03
  2.39162245e+03  4.64658858e+03  4.64658858e+03  4.64658858e+03
  5.23722222e+03  8.78289340e+03  8.78289340e+03  8.78289340e+03
  2.05631779e+04  7.11090163e+04]
E1 = -728.642503485661  E_coul = 202.59715757370694
cycle= 5 E= -526.045345911954  delta_E= -4.08e-11  |g|= 2.97e-06  |ddm|= 1e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -728.642503485661  E_coul = 202.59715757370694
  HOMO = -0.520396432164384  LUMO = 2.66070370653559
  mo_energy =
[-1.18461298e+02 -1.21196255e+01 -9.45631851e+00 -9.45631851e+00
 -9.45631851e+00 -1.21302628e+00 -5.20396432e-01 -5.20396432e-01
 -5.20396432e-01  2.66070371e+00  2.66070371e+00  2.66070371e+00
  2.08052114e+01  2.08052114e+01  2.08052114e+01  9.50475672e+01
  1.24839712e+02  1.24839712e+02  1.24839712e+02  4.57681077e+02
  4.57681077e+02  4.57681077e+02  8.37231794e+02  1.14274820e+03
  1.14274820e+03  1.14274820e+03  2.39162244e+03  2.39162244e+03
  2.39162244e+03  4.64658857e+03  4.64658857e+03  4.64658857e+03
  5.23722221e+03  8.78289339e+03  8.78289339e+03  8.78289339e+03
  2.05631779e+04  7.11090163e+04]
E1 = -728.6425112898694  E_coul = 202.5971653779147
Extra cycle  E= -526.045345911955  delta_E= -5.68e-13  |g|= 5.75e-07  |ddm|= 7.87e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.19 sec
exp = [2.61855074e+04 7.58535638e+03 3.55285188e+03 5.98234860e+02
 1.35056495e+02 3.85578510e+01 4.61116766e+00 3.91708786e-01
 1.36279316e+03 6.52872921e+02 2.39774821e+02 2.60443754e+02
 7.66566693e+02 1.80260721e+01 8.43814771e+01 1.57746717e+00
 5.35582941e+00 3.60816063e-01]
E = -526.0453459119547
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.5073529        1
[INPUT] 0    0    [1    /1   ]  7585.35637737        1
[INPUT] 0    0    [1    /1   ]  3552.85188428        1
[INPUT] 0    0    [1    /1   ]  598.234859563        1
[INPUT] 0    0    [1    /1   ]  135.056494852        1
[INPUT] 0    0    [1    /1   ]  38.5578510412        1
[INPUT] 0    0    [1    /1   ]  4.61116765831        1
[INPUT] 0    0    [1    /1   ]  0.391708786059       1
[INPUT] 1    0    [1    /1   ]  1362.79316022        1
[INPUT] 1    0    [1    /1   ]  652.872921186        1
[INPUT] 1    0    [1    /1   ]  239.774820739        1
[INPUT] 1    0    [1    /1   ]  260.443754389        1
[INPUT] 1    0    [1    /1   ]  766.566692508        1
[INPUT] 1    0    [1    /1   ]  18.0260721311        1
[INPUT] 1    0    [1    /1   ]  84.3814770926        1
[INPUT] 1    0    [1    /1   ]  1.57746717262        1
[INPUT] 1    0    [1    /1   ]  5.35582941099        1
[INPUT] 1    0    [1    /1   ]  0.360816063372       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.507352864017, 1.0]], [0, [7585.356377373308, 1.0]], [0, [3552.8518842792196, 1.0]], [0, [598.2348595628152, 1.0]], [0, [135.0564948516839, 1.0]], [0, [38.55785104116476, 1.0]], [0, [4.611167658313912, 1.0]], [0, [0.3917087860586975, 1.0]], [1, [1362.7931602161962, 1.0]], [1, [652.8729211862861, 1.0]], [1, [239.7748207394809, 1.0]], [1, [260.44375438946224, 1.0]], [1, [766.5666925081274, 1.0]], [1, [18.026072131079257, 1.0]], [1, [84.38147709256725, 1.0]], [1, [1.5774671726156413, 1.0]], [1, [5.355829410986076, 1.0]], [1, [0.3608160633716908, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.50735286]
bas 1, expnt(s) = [7585.35637737]
bas 2, expnt(s) = [3552.85188428]
bas 3, expnt(s) = [598.23485956]
bas 4, expnt(s) = [135.05649485]
bas 5, expnt(s) = [38.55785104]
bas 6, expnt(s) = [4.61116766]
bas 7, expnt(s) = [0.39170879]
bas 8, expnt(s) = [1362.79316022]
bas 9, expnt(s) = [652.87292119]
bas 10, expnt(s) = [239.77482074]
bas 11, expnt(s) = [260.44375439]
bas 12, expnt(s) = [766.56669251]
bas 13, expnt(s) = [18.02607213]
bas 14, expnt(s) = [84.38147709]
bas 15, expnt(s) = [1.57746717]
bas 16, expnt(s) = [5.35582941]
bas 17, expnt(s) = [0.36081606]
CPU time:       578.67
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61855074e+04 5.20068762e+03 7.58535638e+03 2.05351092e+03
 3.55285188e+03 1.16264694e+03 5.98234860e+02 3.05610880e+02
 1.35056495e+02 1.00092521e+02 3.85578510e+01 3.90930577e+01
 4.61116766e+00 7.95011131e+00 3.91708786e-01 1.25094296e+00
 1.36279316e+03 2.41558222e+04 6.52872921e+02 9.62764820e+03
 2.39774821e+02 2.75257310e+03 2.60443754e+02 3.05229726e+03
 7.66566693e+02 1.17671645e+04 1.80260721e+01 1.08357948e+02
 8.43814771e+01 7.46093569e+02 1.57746717e+00 5.15744738e+00
 5.35582941e+00 2.37693777e+01 3.60816063e-01 8.15815068e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.906506256655362
cond(S) = 135808.52307920696
E1 = -727.9846794341032  E_coul = 202.96022215388345
init E= -525.02445728022
    CPU time for initialize scf      0.13 sec, wall time      0.04 sec
  HOMO = -0.545961832289164  LUMO = 2.63720816858919
  mo_energy =
[-1.18262880e+02 -1.21009946e+01 -9.43374446e+00 -9.43374446e+00
 -9.43374446e+00 -1.23964069e+00 -5.45961832e-01 -5.45961832e-01
 -5.45961832e-01  2.63720817e+00  2.63720817e+00  2.63720817e+00
  2.08305412e+01  2.08305412e+01  2.08305412e+01  9.51440649e+01
  1.24960623e+02  1.24960623e+02  1.24960623e+02  4.57858652e+02
  4.57858652e+02  4.57858652e+02  8.37520309e+02  1.14297386e+03
  1.14297386e+03  1.14297386e+03  2.39190004e+03  2.39190004e+03
  2.39190004e+03  4.64692864e+03  4.64692864e+03  4.64692864e+03
  5.23772525e+03  8.78334299e+03  8.78334299e+03  8.78334299e+03
  2.05638067e+04  7.11097358e+04]
E1 = -728.5500892117216  E_coul = 202.50502505792457
cycle= 1 E= -526.045064153797  delta_E= -1.02  |g|= 0.195  |ddm|= 3.87
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.503687
diis-c [-0.25370077  1.        ]
  HOMO = -0.520325072155314  LUMO = 2.66013502397303
  mo_energy =
[-1.18483223e+02 -1.21256272e+01 -9.46245189e+00 -9.46245189e+00
 -9.46245189e+00 -1.21299128e+00 -5.20325072e-01 -5.20325072e-01
 -5.20325072e-01  2.66013502e+00  2.66013502e+00  2.66013502e+00
  2.07992321e+01  2.07992321e+01  2.07992321e+01  9.50302083e+01
  1.24823332e+02  1.24823332e+02  1.24823332e+02  4.57660038e+02
  4.57660038e+02  4.57660038e+02  8.37207248e+02  1.14272504e+03
  1.14272504e+03  1.14272504e+03  2.39159791e+03  2.39159791e+03
  2.39159791e+03  4.64656306e+03  4.64656306e+03  4.64656306e+03
  5.23719582e+03  8.78286724e+03  8.78286724e+03  8.78286724e+03
  2.05631513e+04  7.11089897e+04]
E1 = -728.6642980574053  E_coul = 202.61895589413393
cycle= 2 E= -526.045342163271  delta_E= -0.000278  |g|= 0.0165  |ddm|= 0.0116
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0293388
diis-c [-5.72373972e-04  3.26515794e-02  9.67348421e-01]
  HOMO = -0.520180391824519  LUMO = 2.66111581466514
  mo_energy =
[-1.18458492e+02 -1.21183418e+01 -9.45498005e+00 -9.45498005e+00
 -9.45498005e+00 -1.21274092e+00 -5.20180392e-01 -5.20180392e-01
 -5.20180392e-01  2.66111581e+00  2.66111581e+00  2.66111581e+00
  2.08064862e+01  2.08064862e+01  2.08064862e+01  9.50498518e+01
  1.24842003e+02  1.24842003e+02  1.24842003e+02  4.57683785e+02
  4.57683785e+02  4.57683785e+02  8.37234873e+02  1.14275112e+03
  1.14275112e+03  1.14275112e+03  2.39162551e+03  2.39162551e+03
  2.39162551e+03  4.64659177e+03  4.64659177e+03  4.64659177e+03
  5.23722562e+03  8.78289674e+03  8.78289674e+03  8.78289674e+03
  2.05631814e+04  7.11090199e+04]
E1 = -728.6394450156864  E_coul = 202.59409916422678
cycle= 3 E= -526.04534585146  delta_E= -3.69e-06  |g|= 0.00166  |ddm|= 0.00205
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00333722
diis-c [-1.53992891e-07 -8.30971156e-04  9.40353007e-02  9.06795670e-01]
  HOMO = -0.520408176234734  LUMO = 2.66068342987421
  mo_energy =
[-1.18461363e+02 -1.21196775e+01 -9.45637035e+00 -9.45637035e+00
 -9.45637035e+00 -1.21304207e+00 -5.20408176e-01 -5.20408176e-01
 -5.20408176e-01  2.66068343e+00  2.66068343e+00  2.66068343e+00
  2.08051634e+01  2.08051634e+01  2.08051634e+01  9.50475025e+01
  1.24839650e+02  1.24839650e+02  1.24839650e+02  4.57681012e+02
  4.57681012e+02  4.57681012e+02  8.37231732e+02  1.14274814e+03
  1.14274814e+03  1.14274814e+03  2.39162238e+03  2.39162238e+03
  2.39162238e+03  4.64658851e+03  4.64658851e+03  4.64658851e+03
  5.23722215e+03  8.78289333e+03  8.78289333e+03  8.78289333e+03
  2.05631779e+04  7.11090162e+04]
E1 = -728.6425947443264  E_coul = 202.5972488324132
cycle= 4 E= -526.045345911913  delta_E= -6.05e-08  |g|= 3.54e-05  |ddm|= 0.000288
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=4.86618e-05
diis-c [-4.41178768e-10 -5.17173458e-07 -6.65477919e-04  7.31179221e-03
  9.93354203e-01]
  HOMO = -0.520395572609428  LUMO = 2.66070522031096
  mo_energy =
[-1.18461291e+02 -1.21196215e+01 -9.45631434e+00 -9.45631434e+00
 -9.45631434e+00 -1.21302513e+00 -5.20395573e-01 -5.20395573e-01
 -5.20395573e-01  2.66070522e+00  2.66070522e+00  2.66070522e+00
  2.08052153e+01  2.08052153e+01  2.08052153e+01  9.50475731e+01
  1.24839718e+02  1.24839718e+02  1.24839718e+02  4.57681084e+02
  4.57681084e+02  4.57681084e+02  8.37231800e+02  1.14274821e+03
  1.14274821e+03  1.14274821e+03  2.39162245e+03  2.39162245e+03
  2.39162245e+03  4.64658858e+03  4.64658858e+03  4.64658858e+03
  5.23722222e+03  8.78289340e+03  8.78289340e+03  8.78289340e+03
  2.05631779e+04  7.11090163e+04]
E1 = -728.642503485661  E_coul = 202.59715757370694
cycle= 5 E= -526.045345911954  delta_E= -4.08e-11  |g|= 2.97e-06  |ddm|= 1e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -728.642503485661  E_coul = 202.59715757370694
  HOMO = -0.520396432164384  LUMO = 2.66070370653559
  mo_energy =
[-1.18461298e+02 -1.21196255e+01 -9.45631851e+00 -9.45631851e+00
 -9.45631851e+00 -1.21302628e+00 -5.20396432e-01 -5.20396432e-01
 -5.20396432e-01  2.66070371e+00  2.66070371e+00  2.66070371e+00
  2.08052114e+01  2.08052114e+01  2.08052114e+01  9.50475672e+01
  1.24839712e+02  1.24839712e+02  1.24839712e+02  4.57681077e+02
  4.57681077e+02  4.57681077e+02  8.37231794e+02  1.14274820e+03
  1.14274820e+03  1.14274820e+03  2.39162244e+03  2.39162244e+03
  2.39162244e+03  4.64658857e+03  4.64658857e+03  4.64658857e+03
  5.23722221e+03  8.78289339e+03  8.78289339e+03  8.78289339e+03
  2.05631779e+04  7.11090163e+04]
E1 = -728.6425112898694  E_coul = 202.5971653779147
Extra cycle  E= -526.045345911955  delta_E= -5.68e-13  |g|= 5.75e-07  |ddm|= 7.87e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.18 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 135808.52307920696
E1 = -728.6425112898694  E_coul = 202.5971653779147
init E= -526.045345911955
    CPU time for initialize scf      0.94 sec, wall time      0.18 sec
  HOMO = -0.520396332517184  LUMO = 2.6607038940068
  mo_energy =
[-1.18461296e+02 -1.21196250e+01 -9.45631792e+00 -9.45631792e+00
 -9.45631792e+00 -1.21302614e+00 -5.20396333e-01 -5.20396333e-01
 -5.20396333e-01  2.66070389e+00  2.66070389e+00  2.66070389e+00
  2.08052119e+01  2.08052119e+01  2.08052119e+01  9.50475682e+01
  1.24839713e+02  1.24839713e+02  1.24839713e+02  4.57681078e+02
  4.57681078e+02  4.57681078e+02  8.37231795e+02  1.14274820e+03
  1.14274820e+03  1.14274820e+03  2.39162245e+03  2.39162245e+03
  2.39162245e+03  4.64658857e+03  4.64658857e+03  4.64658857e+03
  5.23722221e+03  8.78289339e+03  8.78289339e+03  8.78289339e+03
  2.05631779e+04  7.11090163e+04]
E1 = -728.6425100183375  E_coul = 202.59716410638384
cycle= 1 E= -526.045345911954  delta_E= 1.02e-12  |g|= 9.86e-08  |ddm|= 1.19e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.6425100183375  E_coul = 202.59716410638384
  HOMO = -0.520396347919735  LUMO = 2.66070386465297
  mo_energy =
[-1.18461297e+02 -1.21196251e+01 -9.45631802e+00 -9.45631802e+00
 -9.45631802e+00 -1.21302616e+00 -5.20396348e-01 -5.20396348e-01
 -5.20396348e-01  2.66070386e+00  2.66070386e+00  2.66070386e+00
  2.08052119e+01  2.08052119e+01  2.08052119e+01  9.50475680e+01
  1.24839713e+02  1.24839713e+02  1.24839713e+02  4.57681078e+02
  4.57681078e+02  4.57681078e+02  8.37231795e+02  1.14274820e+03
  1.14274820e+03  1.14274820e+03  2.39162245e+03  2.39162245e+03
  2.39162245e+03  4.64658857e+03  4.64658857e+03  4.64658857e+03
  5.23722221e+03  8.78289339e+03  8.78289339e+03  8.78289339e+03
  2.05631779e+04  7.11090163e+04]
E1 = -728.6425102305778  E_coul = 202.59716431862387
Extra cycle  E= -526.045345911954  delta_E= -3.41e-13  |g|= 1.67e-08  |ddm|= 1.96e-08
    CPU time for scf_cycle      1.04 sec, wall time      0.28 sec
exp = [2.61855074e+04 7.58535638e+03 3.55285188e+03 5.98234860e+02
 1.35056495e+02 3.85578510e+01 4.61116766e+00 3.91708786e-01
 1.36279316e+03 6.52872921e+02 2.39774821e+02 2.60443754e+02
 7.66566693e+02 1.80260721e+01 8.43814771e+01 1.57746717e+00
 5.35582941e+00 3.60816063e-01]
grad_E = [ 3.84595555e-07  8.72845125e-07  5.06246374e-05  8.20840847e-04
 -5.40600486e-03  1.62715615e-03  9.53045134e-04  2.35213786e-03
  5.01733319e-06  3.03280904e-05  2.78630570e-04  2.41128724e-04
  2.18787480e-05 -4.88354804e-02  6.49466289e-03  1.04235983e-01
  2.68715955e-02  3.44514950e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.6170265        1
[INPUT] 0    0    [1    /1   ]  7584.14580908        1
[INPUT] 0    0    [1    /1   ]  3550.43390755        1
[INPUT] 0    0    [1    /1   ]  560.744224261        1
[INPUT] 0    0    [1    /1   ]  135.553430954        1
[INPUT] 0    0    [1    /1   ]  38.9609574302        1
[INPUT] 0    0    [1    /1   ]  4.61504642489        1
[INPUT] 0    0    [1    /1   ]  0.394364310052       1
[INPUT] 1    0    [1    /1   ]  1362.75554017        1
[INPUT] 1    0    [1    /1   ]  652.104906798        1
[INPUT] 1    0    [1    /1   ]  235.649586902        1
[INPUT] 1    0    [1    /1   ]  256.814998121        1
[INPUT] 1    0    [1    /1   ]  831.12024387         1
[INPUT] 1    0    [1    /1   ]  21.1550658125        1
[INPUT] 1    0    [1    /1   ]  96.2035132147        1
[INPUT] 1    0    [1    /1   ]  1.60419893821        1
[INPUT] 1    0    [1    /1   ]  6.02829322035        1
[INPUT] 1    0    [1    /1   ]  0.357659896216       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.617026492797, 1.0]], [0, [7584.145809078724, 1.0]], [0, [3550.43390754799, 1.0]], [0, [560.7442242608455, 1.0]], [0, [135.5534309543871, 1.0]], [0, [38.96095743016349, 1.0]], [0, [4.615046424894941, 1.0]], [0, [0.3943643100521237, 1.0]], [1, [1362.7555401686107, 1.0]], [1, [652.1049067983328, 1.0]], [1, [235.64958690247698, 1.0]], [1, [256.8149981209849, 1.0]], [1, [831.1202438699588, 1.0]], [1, [21.155065812492733, 1.0]], [1, [96.20351321468524, 1.0]], [1, [1.6041989382064452, 1.0]], [1, [6.028293220353314, 1.0]], [1, [0.35765989621613714, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.61702649]
bas 1, expnt(s) = [7584.14580908]
bas 2, expnt(s) = [3550.43390755]
bas 3, expnt(s) = [560.74422426]
bas 4, expnt(s) = [135.55343095]
bas 5, expnt(s) = [38.96095743]
bas 6, expnt(s) = [4.61504642]
bas 7, expnt(s) = [0.39436431]
bas 8, expnt(s) = [1362.75554017]
bas 9, expnt(s) = [652.1049068]
bas 10, expnt(s) = [235.6495869]
bas 11, expnt(s) = [256.81499812]
bas 12, expnt(s) = [831.12024387]
bas 13, expnt(s) = [21.15506581]
bas 14, expnt(s) = [96.20351321]
bas 15, expnt(s) = [1.60419894]
bas 16, expnt(s) = [6.02829322]
bas 17, expnt(s) = [0.3576599]
CPU time:       584.21
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61856170e+04 5.20070396e+03 7.58414581e+03 2.05326512e+03
 3.55043391e+03 1.16205343e+03 5.60744224e+02 2.91131120e+02
 1.35553431e+02 1.00368610e+02 3.89609574e+01 3.93991851e+01
 4.61504642e+00 7.95512631e+00 3.94364310e-01 1.25729801e+00
 1.36275554e+03 2.41549887e+04 6.52104907e+02 9.61349329e+03
 2.35649587e+02 2.69350475e+03 2.56814998e+02 2.99923069e+03
 8.31120244e+02 1.30185981e+04 2.11550658e+01 1.32358662e+02
 9.62035132e+01 8.78967987e+02 1.60419894e+00 5.26692547e+00
 6.02829322e+00 2.75567092e+01 3.57659896e-01 8.06904617e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.905418160515122
cond(S) = 120613.92934492172
E1 = -727.9433390950518  E_coul = 202.97007678755566
init E= -524.973262307496
    CPU time for initialize scf      0.15 sec, wall time      0.04 sec
  HOMO = -0.547252303279867  LUMO = 2.71043148960064
  mo_energy =
[-1.18259059e+02 -1.20975774e+01 -9.43333370e+00 -9.43333370e+00
 -9.43333370e+00 -1.24391752e+00 -5.47252303e-01 -5.47252303e-01
 -5.47252303e-01  2.71043149e+00  2.71043149e+00  2.71043149e+00
  2.44793535e+01  2.44793535e+01  2.44793535e+01  9.64819903e+01
  1.43559484e+02  1.43559484e+02  1.43559484e+02  4.93318268e+02
  4.93318268e+02  4.93318268e+02  8.09492880e+02  1.18822239e+03
  1.18822239e+03  1.18822239e+03  2.45296329e+03  2.45296329e+03
  2.45296329e+03  4.76183947e+03  4.76183947e+03  4.76183947e+03
  5.12589703e+03  8.98675880e+03  8.98675880e+03  8.98675880e+03
  2.04272233e+04  7.09714643e+04]
E1 = -728.4058503543524  E_coul = 202.35082127079764
cycle= 1 E= -526.055029083555  delta_E= -1.08  |g|= 0.187  |ddm|= 2.65
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.503224
diis-c [-0.25323434  1.        ]
  HOMO = -0.526707821696007  LUMO = 2.72375600344403
  mo_energy =
[-1.18473428e+02 -1.21383328e+01 -9.47873844e+00 -9.47873844e+00
 -9.47873844e+00 -1.22413542e+00 -5.26707822e-01 -5.26707822e-01
 -5.26707822e-01  2.72375600e+00  2.72375600e+00  2.72375600e+00
  2.44227558e+01  2.44227558e+01  2.44227558e+01  9.63632839e+01
  1.43413247e+02  1.43413247e+02  1.43413247e+02  4.93122228e+02
  4.93122228e+02  4.93122228e+02  8.09194811e+02  1.18797988e+03
  1.18797988e+03  1.18797988e+03  2.45266893e+03  2.45266893e+03
  2.45266893e+03  4.76148416e+03  4.76148416e+03  4.76148416e+03
  5.12538711e+03  8.98629700e+03  8.98629700e+03  8.98629700e+03
  2.04265847e+04  7.09707345e+04]
E1 = -728.5250063092174  E_coul = 202.46973966876536
cycle= 2 E= -526.055266640452  delta_E= -0.000238  |g|= 0.0158  |ddm|= 0.00946
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0271618
diis-c [-5.40660000e-04  2.71696485e-02  9.72830351e-01]
  HOMO = -0.526268119791181  LUMO = 2.72527507734438
  mo_energy =
[-1.18449263e+02 -1.21305260e+01 -9.47076637e+00 -9.47076637e+00
 -9.47076637e+00 -1.22348912e+00 -5.26268120e-01 -5.26268120e-01
 -5.26268120e-01  2.72527508e+00  2.72527508e+00  2.72527508e+00
  2.44316073e+01  2.44316073e+01  2.44316073e+01  9.63827799e+01
  1.43432275e+02  1.43432275e+02  1.43432275e+02  4.93145547e+02
  4.93145547e+02  4.93145547e+02  8.09221370e+02  1.18800523e+03
  1.18800523e+03  1.18800523e+03  2.45269564e+03  2.45269564e+03
  2.45269564e+03  4.76151181e+03  4.76151181e+03  4.76151181e+03
  5.12541552e+03  8.98632522e+03  8.98632522e+03  8.98632522e+03
  2.04266133e+04  7.09707630e+04]
E1 = -728.5000294003524  E_coul = 202.44475926473157
cycle= 3 E= -526.055270135621  delta_E= -3.5e-06  |g|= 0.00175  |ddm|= 0.00203
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00346355
diis-c [-1.88864063e-07 -8.72763487e-04  1.04772297e-01  8.96100466e-01]
  HOMO = -0.52649298157483  LUMO = 2.7248179482894
  mo_energy =
[-1.18452210e+02 -1.21318846e+01 -9.47218070e+00 -9.47218070e+00
 -9.47218070e+00 -1.22379031e+00 -5.26492982e-01 -5.26492982e-01
 -5.26492982e-01  2.72481795e+00  2.72481795e+00  2.72481795e+00
  2.44301301e+01  2.44301301e+01  2.44301301e+01  9.63803603e+01
  1.43429809e+02  1.43429809e+02  1.43429809e+02  4.93142691e+02
  4.93142691e+02  4.93142691e+02  8.09218152e+02  1.18800217e+03
  1.18800217e+03  1.18800217e+03  2.45269241e+03  2.45269241e+03
  2.45269241e+03  4.76150845e+03  4.76150845e+03  4.76150845e+03
  5.12541195e+03  8.98632172e+03  8.98632172e+03  8.98632172e+03
  2.04266096e+04  7.09707593e+04]
E1 = -728.5033141617033  E_coul = 202.44804395969015
cycle= 4 E= -526.055270202013  delta_E= -6.64e-08  |g|= 2.73e-05  |ddm|= 0.000292
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=3.36816e-05
diis-c [-3.86049341e-10  8.05914348e-06 -1.81021768e-03 -6.97238285e-03
  1.00877454e+00]
  HOMO = -0.526482532525155  LUMO = 2.72483672469175
  mo_energy =
[-1.18452155e+02 -1.21318386e+01 -9.47213490e+00 -9.47213490e+00
 -9.47213490e+00 -1.22377602e+00 -5.26482533e-01 -5.26482533e-01
 -5.26482533e-01  2.72483672e+00  2.72483672e+00  2.72483672e+00
  2.44301741e+01  2.44301741e+01  2.44301741e+01  9.63804164e+01
  1.43429862e+02  1.43429862e+02  1.43429862e+02  4.93142746e+02
  4.93142746e+02  4.93142746e+02  8.09218203e+02  1.18800222e+03
  1.18800222e+03  1.18800222e+03  2.45269247e+03  2.45269247e+03
  2.45269247e+03  4.76150849e+03  4.76150849e+03  4.76150849e+03
  5.12541200e+03  8.98632176e+03  8.98632176e+03  8.98632176e+03
  2.04266096e+04  7.09707593e+04]
E1 = -728.5032417012483  E_coul = 202.44797149921095
cycle= 5 E= -526.055270202037  delta_E= -2.41e-11  |g|= 3.12e-06  |ddm|= 7.91e-06
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -728.5032417012483  E_coul = 202.44797149921095
  HOMO = -0.526483396629313  LUMO = 2.72483510673718
  mo_energy =
[-1.18452162e+02 -1.21318428e+01 -9.47213921e+00 -9.47213921e+00
 -9.47213921e+00 -1.22377719e+00 -5.26483397e-01 -5.26483397e-01
 -5.26483397e-01  2.72483511e+00  2.72483511e+00  2.72483511e+00
  2.44301698e+01  2.44301698e+01  2.44301698e+01  9.63804103e+01
  1.43429856e+02  1.43429856e+02  1.43429856e+02  4.93142739e+02
  4.93142739e+02  4.93142739e+02  8.09218196e+02  1.18800221e+03
  1.18800221e+03  1.18800221e+03  2.45269246e+03  2.45269246e+03
  2.45269246e+03  4.76150849e+03  4.76150849e+03  4.76150849e+03
  5.12541199e+03  8.98632175e+03  8.98632175e+03  8.98632175e+03
  2.04266096e+04  7.09707593e+04]
E1 = -728.5032498825044  E_coul = 202.44797968046817
Extra cycle  E= -526.055270202036  delta_E= 1.02e-12  |g|= 6.04e-07  |ddm|= 8.02e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.19 sec
exp = [2.61856170e+04 7.58414581e+03 3.55043391e+03 5.60744224e+02
 1.35553431e+02 3.89609574e+01 4.61504642e+00 3.94364310e-01
 1.36275554e+03 6.52104907e+02 2.35649587e+02 2.56814998e+02
 8.31120244e+02 2.11550658e+01 9.62035132e+01 1.60419894e+00
 6.02829322e+00 3.57659896e-01]
E = -526.0552702020362
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.6170265        1
[INPUT] 0    0    [1    /1   ]  7584.14580908        1
[INPUT] 0    0    [1    /1   ]  3550.43390755        1
[INPUT] 0    0    [1    /1   ]  560.744224261        1
[INPUT] 0    0    [1    /1   ]  135.553430954        1
[INPUT] 0    0    [1    /1   ]  38.9609574302        1
[INPUT] 0    0    [1    /1   ]  4.61504642489        1
[INPUT] 0    0    [1    /1   ]  0.394364310052       1
[INPUT] 1    0    [1    /1   ]  1362.75554017        1
[INPUT] 1    0    [1    /1   ]  652.104906798        1
[INPUT] 1    0    [1    /1   ]  235.649586902        1
[INPUT] 1    0    [1    /1   ]  256.814998121        1
[INPUT] 1    0    [1    /1   ]  831.12024387         1
[INPUT] 1    0    [1    /1   ]  21.1550658125        1
[INPUT] 1    0    [1    /1   ]  96.2035132147        1
[INPUT] 1    0    [1    /1   ]  1.60419893821        1
[INPUT] 1    0    [1    /1   ]  6.02829322035        1
[INPUT] 1    0    [1    /1   ]  0.357659896216       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.617026492797, 1.0]], [0, [7584.145809078724, 1.0]], [0, [3550.43390754799, 1.0]], [0, [560.7442242608455, 1.0]], [0, [135.5534309543871, 1.0]], [0, [38.96095743016349, 1.0]], [0, [4.615046424894941, 1.0]], [0, [0.3943643100521237, 1.0]], [1, [1362.7555401686107, 1.0]], [1, [652.1049067983328, 1.0]], [1, [235.64958690247698, 1.0]], [1, [256.8149981209849, 1.0]], [1, [831.1202438699588, 1.0]], [1, [21.155065812492733, 1.0]], [1, [96.20351321468524, 1.0]], [1, [1.6041989382064452, 1.0]], [1, [6.028293220353314, 1.0]], [1, [0.35765989621613714, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.61702649]
bas 1, expnt(s) = [7584.14580908]
bas 2, expnt(s) = [3550.43390755]
bas 3, expnt(s) = [560.74422426]
bas 4, expnt(s) = [135.55343095]
bas 5, expnt(s) = [38.96095743]
bas 6, expnt(s) = [4.61504642]
bas 7, expnt(s) = [0.39436431]
bas 8, expnt(s) = [1362.75554017]
bas 9, expnt(s) = [652.1049068]
bas 10, expnt(s) = [235.6495869]
bas 11, expnt(s) = [256.81499812]
bas 12, expnt(s) = [831.12024387]
bas 13, expnt(s) = [21.15506581]
bas 14, expnt(s) = [96.20351321]
bas 15, expnt(s) = [1.60419894]
bas 16, expnt(s) = [6.02829322]
bas 17, expnt(s) = [0.3576599]
CPU time:       584.76
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61856170e+04 5.20070396e+03 7.58414581e+03 2.05326512e+03
 3.55043391e+03 1.16205343e+03 5.60744224e+02 2.91131120e+02
 1.35553431e+02 1.00368610e+02 3.89609574e+01 3.93991851e+01
 4.61504642e+00 7.95512631e+00 3.94364310e-01 1.25729801e+00
 1.36275554e+03 2.41549887e+04 6.52104907e+02 9.61349329e+03
 2.35649587e+02 2.69350475e+03 2.56814998e+02 2.99923069e+03
 8.31120244e+02 1.30185981e+04 2.11550658e+01 1.32358662e+02
 9.62035132e+01 8.78967987e+02 1.60419894e+00 5.26692547e+00
 6.02829322e+00 2.75567092e+01 3.57659896e-01 8.06904617e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.905418160515122
cond(S) = 120613.92934492172
E1 = -727.9433390950518  E_coul = 202.97007678755566
init E= -524.973262307496
    CPU time for initialize scf      0.13 sec, wall time      0.04 sec
  HOMO = -0.547252303279867  LUMO = 2.71043148960064
  mo_energy =
[-1.18259059e+02 -1.20975774e+01 -9.43333370e+00 -9.43333370e+00
 -9.43333370e+00 -1.24391752e+00 -5.47252303e-01 -5.47252303e-01
 -5.47252303e-01  2.71043149e+00  2.71043149e+00  2.71043149e+00
  2.44793535e+01  2.44793535e+01  2.44793535e+01  9.64819903e+01
  1.43559484e+02  1.43559484e+02  1.43559484e+02  4.93318268e+02
  4.93318268e+02  4.93318268e+02  8.09492880e+02  1.18822239e+03
  1.18822239e+03  1.18822239e+03  2.45296329e+03  2.45296329e+03
  2.45296329e+03  4.76183947e+03  4.76183947e+03  4.76183947e+03
  5.12589703e+03  8.98675880e+03  8.98675880e+03  8.98675880e+03
  2.04272233e+04  7.09714643e+04]
E1 = -728.4058503543524  E_coul = 202.35082127079764
cycle= 1 E= -526.055029083555  delta_E= -1.08  |g|= 0.187  |ddm|= 2.65
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.503224
diis-c [-0.25323434  1.        ]
  HOMO = -0.526707821696007  LUMO = 2.72375600344403
  mo_energy =
[-1.18473428e+02 -1.21383328e+01 -9.47873844e+00 -9.47873844e+00
 -9.47873844e+00 -1.22413542e+00 -5.26707822e-01 -5.26707822e-01
 -5.26707822e-01  2.72375600e+00  2.72375600e+00  2.72375600e+00
  2.44227558e+01  2.44227558e+01  2.44227558e+01  9.63632839e+01
  1.43413247e+02  1.43413247e+02  1.43413247e+02  4.93122228e+02
  4.93122228e+02  4.93122228e+02  8.09194811e+02  1.18797988e+03
  1.18797988e+03  1.18797988e+03  2.45266893e+03  2.45266893e+03
  2.45266893e+03  4.76148416e+03  4.76148416e+03  4.76148416e+03
  5.12538711e+03  8.98629700e+03  8.98629700e+03  8.98629700e+03
  2.04265847e+04  7.09707345e+04]
E1 = -728.5250063092174  E_coul = 202.46973966876536
cycle= 2 E= -526.055266640452  delta_E= -0.000238  |g|= 0.0158  |ddm|= 0.00946
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0271618
diis-c [-5.40660000e-04  2.71696485e-02  9.72830351e-01]
  HOMO = -0.526268119791181  LUMO = 2.72527507734438
  mo_energy =
[-1.18449263e+02 -1.21305260e+01 -9.47076637e+00 -9.47076637e+00
 -9.47076637e+00 -1.22348912e+00 -5.26268120e-01 -5.26268120e-01
 -5.26268120e-01  2.72527508e+00  2.72527508e+00  2.72527508e+00
  2.44316073e+01  2.44316073e+01  2.44316073e+01  9.63827799e+01
  1.43432275e+02  1.43432275e+02  1.43432275e+02  4.93145547e+02
  4.93145547e+02  4.93145547e+02  8.09221370e+02  1.18800523e+03
  1.18800523e+03  1.18800523e+03  2.45269564e+03  2.45269564e+03
  2.45269564e+03  4.76151181e+03  4.76151181e+03  4.76151181e+03
  5.12541552e+03  8.98632522e+03  8.98632522e+03  8.98632522e+03
  2.04266133e+04  7.09707630e+04]
E1 = -728.5000294003524  E_coul = 202.44475926473157
cycle= 3 E= -526.055270135621  delta_E= -3.5e-06  |g|= 0.00175  |ddm|= 0.00203
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00346355
diis-c [-1.88864063e-07 -8.72763487e-04  1.04772297e-01  8.96100466e-01]
  HOMO = -0.52649298157483  LUMO = 2.7248179482894
  mo_energy =
[-1.18452210e+02 -1.21318846e+01 -9.47218070e+00 -9.47218070e+00
 -9.47218070e+00 -1.22379031e+00 -5.26492982e-01 -5.26492982e-01
 -5.26492982e-01  2.72481795e+00  2.72481795e+00  2.72481795e+00
  2.44301301e+01  2.44301301e+01  2.44301301e+01  9.63803603e+01
  1.43429809e+02  1.43429809e+02  1.43429809e+02  4.93142691e+02
  4.93142691e+02  4.93142691e+02  8.09218152e+02  1.18800217e+03
  1.18800217e+03  1.18800217e+03  2.45269241e+03  2.45269241e+03
  2.45269241e+03  4.76150845e+03  4.76150845e+03  4.76150845e+03
  5.12541195e+03  8.98632172e+03  8.98632172e+03  8.98632172e+03
  2.04266096e+04  7.09707593e+04]
E1 = -728.5033141617033  E_coul = 202.44804395969015
cycle= 4 E= -526.055270202013  delta_E= -6.64e-08  |g|= 2.73e-05  |ddm|= 0.000292
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=3.36816e-05
diis-c [-3.86049341e-10  8.05914348e-06 -1.81021768e-03 -6.97238285e-03
  1.00877454e+00]
  HOMO = -0.526482532525155  LUMO = 2.72483672469175
  mo_energy =
[-1.18452155e+02 -1.21318386e+01 -9.47213490e+00 -9.47213490e+00
 -9.47213490e+00 -1.22377602e+00 -5.26482533e-01 -5.26482533e-01
 -5.26482533e-01  2.72483672e+00  2.72483672e+00  2.72483672e+00
  2.44301741e+01  2.44301741e+01  2.44301741e+01  9.63804164e+01
  1.43429862e+02  1.43429862e+02  1.43429862e+02  4.93142746e+02
  4.93142746e+02  4.93142746e+02  8.09218203e+02  1.18800222e+03
  1.18800222e+03  1.18800222e+03  2.45269247e+03  2.45269247e+03
  2.45269247e+03  4.76150849e+03  4.76150849e+03  4.76150849e+03
  5.12541200e+03  8.98632176e+03  8.98632176e+03  8.98632176e+03
  2.04266096e+04  7.09707593e+04]
E1 = -728.5032417012483  E_coul = 202.44797149921095
cycle= 5 E= -526.055270202037  delta_E= -2.41e-11  |g|= 3.12e-06  |ddm|= 7.91e-06
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -728.5032417012483  E_coul = 202.44797149921095
  HOMO = -0.526483396629313  LUMO = 2.72483510673718
  mo_energy =
[-1.18452162e+02 -1.21318428e+01 -9.47213921e+00 -9.47213921e+00
 -9.47213921e+00 -1.22377719e+00 -5.26483397e-01 -5.26483397e-01
 -5.26483397e-01  2.72483511e+00  2.72483511e+00  2.72483511e+00
  2.44301698e+01  2.44301698e+01  2.44301698e+01  9.63804103e+01
  1.43429856e+02  1.43429856e+02  1.43429856e+02  4.93142739e+02
  4.93142739e+02  4.93142739e+02  8.09218196e+02  1.18800221e+03
  1.18800221e+03  1.18800221e+03  2.45269246e+03  2.45269246e+03
  2.45269246e+03  4.76150849e+03  4.76150849e+03  4.76150849e+03
  5.12541199e+03  8.98632175e+03  8.98632175e+03  8.98632175e+03
  2.04266096e+04  7.09707593e+04]
E1 = -728.5032498825044  E_coul = 202.44797968046817
Extra cycle  E= -526.055270202036  delta_E= 1.02e-12  |g|= 6.04e-07  |ddm|= 8.02e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.18 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 120613.92934492172
E1 = -728.5032498825044  E_coul = 202.44797968046817
init E= -526.055270202036
    CPU time for initialize scf      0.96 sec, wall time      0.18 sec
  HOMO = -0.526483292265997  LUMO = 2.72483531387456
  mo_energy =
[-1.18452160e+02 -1.21318422e+01 -9.47213859e+00 -9.47213859e+00
 -9.47213859e+00 -1.22377704e+00 -5.26483292e-01 -5.26483292e-01
 -5.26483292e-01  2.72483531e+00  2.72483531e+00  2.72483531e+00
  2.44301704e+01  2.44301704e+01  2.44301704e+01  9.63804113e+01
  1.43429857e+02  1.43429857e+02  1.43429857e+02  4.93142741e+02
  4.93142741e+02  4.93142741e+02  8.09218197e+02  1.18800221e+03
  1.18800221e+03  1.18800221e+03  2.45269246e+03  2.45269246e+03
  2.45269246e+03  4.76150849e+03  4.76150849e+03  4.76150849e+03
  5.12541199e+03  8.98632175e+03  8.98632175e+03  8.98632175e+03
  2.04266096e+04  7.09707593e+04]
E1 = -728.5032485318809  E_coul = 202.44797832984355
cycle= 1 E= -526.055270202037  delta_E= -1.14e-12  |g|= 1.06e-07  |ddm|= 1.24e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.5032485318809  E_coul = 202.44797832984355
  HOMO = -0.526483308501823  LUMO = 2.72483528103637
  mo_energy =
[-1.18452161e+02 -1.21318423e+01 -9.47213869e+00 -9.47213869e+00
 -9.47213869e+00 -1.22377707e+00 -5.26483309e-01 -5.26483309e-01
 -5.26483309e-01  2.72483528e+00  2.72483528e+00  2.72483528e+00
  2.44301703e+01  2.44301703e+01  2.44301703e+01  9.63804112e+01
  1.43429857e+02  1.43429857e+02  1.43429857e+02  4.93142740e+02
  4.93142740e+02  4.93142740e+02  8.09218197e+02  1.18800221e+03
  1.18800221e+03  1.18800221e+03  2.45269246e+03  2.45269246e+03
  2.45269246e+03  4.76150849e+03  4.76150849e+03  4.76150849e+03
  5.12541199e+03  8.98632175e+03  8.98632175e+03  8.98632175e+03
  2.04266096e+04  7.09707593e+04]
E1 = -728.5032487610943  E_coul = 202.44797855905765
Extra cycle  E= -526.055270202037  delta_E= 7.96e-13  |g|= 1.82e-08  |ddm|= 2.07e-08
    CPU time for scf_cycle      1.25 sec, wall time      0.47 sec
exp = [2.61856170e+04 7.58414581e+03 3.55043391e+03 5.60744224e+02
 1.35553431e+02 3.89609574e+01 4.61504642e+00 3.94364310e-01
 1.36275554e+03 6.52104907e+02 2.35649587e+02 2.56814998e+02
 8.31120244e+02 2.11550658e+01 9.62035132e+01 1.60419894e+00
 6.02829322e+00 3.57659896e-01]
grad_E = [ 1.23502477e-06  3.78471258e-06  9.86229532e-05 -7.52518346e-04
  1.95381470e-03 -6.30524738e-03  4.89444502e-03  2.30455706e-02
  2.44872519e-06  1.58997625e-05  1.61667723e-04  1.39227379e-04
  9.77929638e-06 -2.89133899e-03  2.31684662e-03  5.27589355e-02
  2.53109887e-02 -3.82543261e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:36 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.3360059        1
[INPUT] 0    0    [1    /1   ]  7587.22488698        1
[INPUT] 0    0    [1    /1   ]  3556.55131905        1
[INPUT] 0    0    [1    /1   ]  656.2501614          1
[INPUT] 0    0    [1    /1   ]  146.743945786        1
[INPUT] 0    0    [1    /1   ]  40.4907934774        1
[INPUT] 0    0    [1    /1   ]  4.61014630843        1
[INPUT] 0    0    [1    /1   ]  0.392381695356       1
[INPUT] 1    0    [1    /1   ]  1362.74121455        1
[INPUT] 1    0    [1    /1   ]  653.136862625        1
[INPUT] 1    0    [1    /1   ]  240.916961764        1
[INPUT] 1    0    [1    /1   ]  261.427431597        1
[INPUT] 1    0    [1    /1   ]  778.259223322        1
[INPUT] 1    0    [1    /1   ]  21.2156380062        1
[INPUT] 1    0    [1    /1   ]  94.0792286799        1
[INPUT] 1    0    [1    /1   ]  1.53894699816        1
[INPUT] 1    0    [1    /1   ]  5.97958701645        1
[INPUT] 1    0    [1    /1   ]  0.354396147268       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.336005852787, 1.0]], [0, [7587.224886981947, 1.0]], [0, [3556.5513190532106, 1.0]], [0, [656.2501613995283, 1.0]], [0, [146.74394578603656, 1.0]], [0, [40.49079347743547, 1.0]], [0, [4.6101463084333325, 1.0]], [0, [0.392381695356343, 1.0]], [1, [1362.741214550167, 1.0]], [1, [653.1368626250464, 1.0]], [1, [240.916961764431, 1.0]], [1, [261.42743159704804, 1.0]], [1, [778.2592233223844, 1.0]], [1, [21.215638006152744, 1.0]], [1, [94.07922867989824, 1.0]], [1, [1.5389469981559276, 1.0]], [1, [5.979587016454054, 1.0]], [1, [0.354396147268144, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.33600585]
bas 1, expnt(s) = [7587.22488698]
bas 2, expnt(s) = [3556.55131905]
bas 3, expnt(s) = [656.2501614]
bas 4, expnt(s) = [146.74394579]
bas 5, expnt(s) = [40.49079348]
bas 6, expnt(s) = [4.61014631]
bas 7, expnt(s) = [0.3923817]
bas 8, expnt(s) = [1362.74121455]
bas 9, expnt(s) = [653.13686263]
bas 10, expnt(s) = [240.91696176]
bas 11, expnt(s) = [261.4274316]
bas 12, expnt(s) = [778.25922332]
bas 13, expnt(s) = [21.21563801]
bas 14, expnt(s) = [94.07922868]
bas 15, expnt(s) = [1.538947]
bas 16, expnt(s) = [5.97958702]
bas 17, expnt(s) = [0.35439615]
CPU time:       590.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61853360e+04 5.20066210e+03 7.58722489e+03 2.05389029e+03
 3.55655132e+03 1.16355478e+03 6.56250161e+02 3.27579784e+02
 1.46743946e+02 1.06520984e+02 4.04907935e+01 4.05538640e+01
 4.61014631e+00 7.94879059e+00 3.92381695e-01 1.25255435e+00
 1.36274121e+03 2.41546713e+04 6.53136863e+02 9.63251374e+03
 2.40916962e+02 2.76897232e+03 2.61427432e+02 3.06671444e+03
 7.78259223e+02 1.19919480e+04 2.12156380e+01 1.32832551e+02
 9.40792287e+01 8.54774540e+02 1.53894700e+00 5.00050621e+00
 5.97958702e+00 2.72786818e+01 3.54396147e-01 7.97711095e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.90868223611904
cond(S) = 158736.61310445564
E1 = -728.0567499186648  E_coul = 202.94781274153638
init E= -525.108937177128
    CPU time for initialize scf      0.18 sec, wall time      0.05 sec
  HOMO = -0.549185931409289  LUMO = 2.59019046629519
  mo_energy =
[-1.18258019e+02 -1.21014869e+01 -9.43459461e+00 -9.43459461e+00
 -9.43459461e+00 -1.24349069e+00 -5.49185931e-01 -5.49185931e-01
 -5.49185931e-01  2.59019047e+00  2.59019047e+00  2.59019047e+00
  2.41399209e+01  2.41399209e+01  2.41399209e+01  1.04832820e+02
  1.42457603e+02  1.42457603e+02  1.42457603e+02  4.91534290e+02
  4.91534290e+02  4.91534290e+02  9.25961210e+02  1.18883509e+03
  1.18883509e+03  1.18883509e+03  2.44771201e+03  2.44771201e+03
  2.44771201e+03  4.71661875e+03  4.71661875e+03  4.71661875e+03
  5.46048773e+03  8.86977449e+03  8.86977449e+03  8.86977449e+03
  2.08253263e+04  7.13714748e+04]
E1 = -728.4941870987107  E_coul = 202.4373295129857
cycle= 1 E= -526.056857585725  delta_E= -0.948  |g|= 0.179  |ddm|= 2.32
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.473902
diis-c [-0.22458279  1.        ]
  HOMO = -0.527421091566599  LUMO = 2.60726633351853
  mo_energy =
[-1.18458508e+02 -1.21339831e+01 -9.47105682e+00 -9.47105682e+00
 -9.47105682e+00 -1.22195239e+00 -5.27421092e-01 -5.27421092e-01
 -5.27421092e-01  2.60726633e+00  2.60726633e+00  2.60726633e+00
  2.40928550e+01  2.40928550e+01  2.40928550e+01  1.04722434e+02
  1.42324640e+02  1.42324640e+02  1.42324640e+02  4.91352595e+02
  4.91352595e+02  4.91352595e+02  9.25663564e+02  1.18860943e+03
  1.18860943e+03  1.18860943e+03  2.44743629e+03  2.44743629e+03
  2.44743629e+03  4.71628213e+03  4.71628213e+03  4.71628213e+03
  5.45999003e+03  8.86933075e+03  8.86933075e+03  8.86933075e+03
  2.08247081e+04  7.13707668e+04]
E1 = -728.5906339141166  E_coul = 202.53356855932088
cycle= 2 E= -526.057065354796  delta_E= -0.000208  |g|= 0.0139  |ddm|= 0.00918
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.023794
diis-c [-4.25857558e-04  2.44070414e-02  9.75592959e-01]
  HOMO = -0.527247669615744  LUMO = 2.60819462440354
  mo_energy =
[-1.18437559e+02 -1.21277765e+01 -9.46472509e+00 -9.46472509e+00
 -9.46472509e+00 -1.22167103e+00 -5.27247670e-01 -5.27247670e-01
 -5.27247670e-01  2.60819462e+00  2.60819462e+00  2.60819462e+00
  2.41000223e+01  2.41000223e+01  2.41000223e+01  1.04739673e+02
  1.42340893e+02  1.42340893e+02  1.42340893e+02  4.91372780e+02
  4.91372780e+02  4.91372780e+02  9.25687013e+02  1.18863147e+03
  1.18863147e+03  1.18863147e+03  2.44745956e+03  2.44745956e+03
  2.44745956e+03  4.71630625e+03  4.71630625e+03  4.71630625e+03
  5.46001483e+03  8.86935537e+03  8.86935537e+03  8.86935537e+03
  2.08247330e+04  7.13707917e+04]
E1 = -728.5693118380153  E_coul = 202.5122439020417
cycle= 3 E= -526.057067935974  delta_E= -2.58e-06  |g|= 0.00152  |ddm|= 0.0017
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00298924
diis-c [-1.56554676e-07 -8.98292775e-04  1.02525962e-01  8.98372330e-01]
  HOMO = -0.527446835312435  LUMO = 2.60780801483482
  mo_energy =
[-1.18440151e+02 -1.21289676e+01 -9.46596330e+00 -9.46596330e+00
 -9.46596330e+00 -1.22193581e+00 -5.27446835e-01 -5.27446835e-01
 -5.27446835e-01  2.60780801e+00  2.60780801e+00  2.60780801e+00
  2.40987287e+01  2.40987287e+01  2.40987287e+01  1.04737503e+02
  1.42338730e+02  1.42338730e+02  1.42338730e+02  4.91370269e+02
  4.91370269e+02  4.91370269e+02  9.25684147e+02  1.18862878e+03
  1.18862878e+03  1.18862878e+03  2.44745673e+03  2.44745673e+03
  2.44745673e+03  4.71630330e+03  4.71630330e+03  4.71630330e+03
  5.46001168e+03  8.86935228e+03  8.86935228e+03  8.86935228e+03
  2.08247297e+04  7.13707884e+04]
E1 = -728.5722332764118  E_coul = 202.51516528969117
cycle= 4 E= -526.057067986721  delta_E= -5.07e-08  |g|= 3.1e-05  |ddm|= 0.000262
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.15505e-05
diis-c [-3.84414232e-10  2.69167876e-06 -1.12289187e-03  3.12620976e-03
  9.97993990e-01]
  HOMO = -0.52743510448215  LUMO = 2.60782826996125
  mo_energy =
[-1.18440088e+02 -1.21289166e+01 -9.46591227e+00 -9.46591227e+00
 -9.46591227e+00 -1.22191996e+00 -5.27435104e-01 -5.27435104e-01
 -5.27435104e-01  2.60782827e+00  2.60782827e+00  2.60782827e+00
  2.40987781e+01  2.40987781e+01  2.40987781e+01  1.04737566e+02
  1.42338791e+02  1.42338791e+02  1.42338791e+02  4.91370332e+02
  4.91370332e+02  4.91370332e+02  9.25684207e+02  1.18862884e+03
  1.18862884e+03  1.18862884e+03  2.44745679e+03  2.44745679e+03
  2.44745679e+03  4.71630336e+03  4.71630336e+03  4.71630336e+03
  5.46001174e+03  8.86935234e+03  8.86935234e+03  8.86935234e+03
  2.08247298e+04  7.13707885e+04]
E1 = -728.5721478717592  E_coul = 202.51507988500398
cycle= 5 E= -526.057067986755  delta_E= -3.46e-11  |g|= 3.06e-06  |ddm|= 9.28e-06
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.5721478717592  E_coul = 202.51507988500398
  HOMO = -0.527435989851888  LUMO = 2.60782668896362
  mo_energy =
[-1.18440094e+02 -1.21289208e+01 -9.46591658e+00 -9.46591658e+00
 -9.46591658e+00 -1.22192115e+00 -5.27435990e-01 -5.27435990e-01
 -5.27435990e-01  2.60782669e+00  2.60782669e+00  2.60782669e+00
  2.40987738e+01  2.40987738e+01  2.40987738e+01  1.04737560e+02
  1.42338785e+02  1.42338785e+02  1.42338785e+02  4.91370326e+02
  4.91370326e+02  4.91370326e+02  9.25684200e+02  1.18862884e+03
  1.18862884e+03  1.18862884e+03  2.44745679e+03  2.44745679e+03
  2.44745679e+03  4.71630335e+03  4.71630335e+03  4.71630335e+03
  5.46001173e+03  8.86935233e+03  8.86935233e+03  8.86935233e+03
  2.08247298e+04  7.13707885e+04]
E1 = -728.5721561996671  E_coul = 202.51508821291216
Extra cycle  E= -526.057067986755  delta_E= 2.27e-13  |g|= 5.98e-07  |ddm|= 8.28e-07
    CPU time for scf_cycle      0.37 sec, wall time      0.24 sec
exp = [2.61853360e+04 7.58722489e+03 3.55655132e+03 6.56250161e+02
 1.46743946e+02 4.04907935e+01 4.61014631e+00 3.92381695e-01
 1.36274121e+03 6.53136863e+02 2.40916962e+02 2.61427432e+02
 7.78259223e+02 2.12156380e+01 9.40792287e+01 1.53894700e+00
 5.97958702e+00 3.54396147e-01]
E = -526.057067986755
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.4726203        1
[INPUT] 0    0    [1    /1   ]  7585.72803432        1
[INPUT] 0    0    [1    /1   ]  3553.57742103        1
[INPUT] 0    0    [1    /1   ]  609.821223707        1
[INPUT] 0    0    [1    /1   ]  141.303826235        1
[INPUT] 0    0    [1    /1   ]  39.7470840846        1
[INPUT] 0    0    [1    /1   ]  4.6125284347         1
[INPUT] 0    0    [1    /1   ]  0.393345517051       1
[INPUT] 1    0    [1    /1   ]  1362.74817876        1
[INPUT] 1    0    [1    /1   ]  652.635191062        1
[INPUT] 1    0    [1    /1   ]  238.35629772         1
[INPUT] 1    0    [1    /1   ]  259.185158573        1
[INPUT] 1    0    [1    /1   ]  803.956903518        1
[INPUT] 1    0    [1    /1   ]  21.186191642         1
[INPUT] 1    0    [1    /1   ]  95.1119212775        1
[INPUT] 1    0    [1    /1   ]  1.57066835863        1
[INPUT] 1    0    [1    /1   ]  6.00326488794        1
[INPUT] 1    0    [1    /1   ]  0.355982775295       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.472620289296, 1.0]], [0, [7585.72803432124, 1.0]], [0, [3553.5774210304794, 1.0]], [0, [609.8212237069329, 1.0]], [0, [141.3038262350157, 1.0]], [0, [39.74708408463052, 1.0]], [0, [4.612528434704206, 1.0]], [0, [0.39334551705095827, 1.0]], [1, [1362.7481787585298, 1.0]], [1, [652.6351910618384, 1.0]], [1, [238.35629771991105, 1.0]], [1, [259.18515857311644, 1.0]], [1, [803.956903517978, 1.0]], [1, [21.186191641983143, 1.0]], [1, [95.11192127746683, 1.0]], [1, [1.5706683586251438, 1.0]], [1, [6.003264887943843, 1.0]], [1, [0.3559827752945316, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.47262029]
bas 1, expnt(s) = [7585.72803432]
bas 2, expnt(s) = [3553.57742103]
bas 3, expnt(s) = [609.82122371]
bas 4, expnt(s) = [141.30382624]
bas 5, expnt(s) = [39.74708408]
bas 6, expnt(s) = [4.61252843]
bas 7, expnt(s) = [0.39334552]
bas 8, expnt(s) = [1362.74817876]
bas 9, expnt(s) = [652.63519106]
bas 10, expnt(s) = [238.35629772]
bas 11, expnt(s) = [259.18515857]
bas 12, expnt(s) = [803.95690352]
bas 13, expnt(s) = [21.18619164]
bas 14, expnt(s) = [95.11192128]
bas 15, expnt(s) = [1.57066836]
bas 16, expnt(s) = [6.00326489]
bas 17, expnt(s) = [0.35598278]
CPU time:       591.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61854726e+04 5.20068245e+03 7.58572803e+03 2.05358638e+03
 3.55357742e+03 1.16282500e+03 6.09821224e+02 3.10039427e+02
 1.41303826e+02 1.03545318e+02 3.97470841e+01 3.99939205e+01
 4.61252843e+00 7.95187083e+00 3.93345517e-01 1.25486116e+00
 1.36274818e+03 2.41548256e+04 6.52635191e+02 9.62326627e+03
 2.38356298e+02 2.73223268e+03 2.59185159e+02 3.03387061e+03
 8.03956904e+02 1.24889335e+04 2.11861916e+01 1.32602134e+02
 9.51119213e+01 8.66518992e+02 1.57066836e+00 5.12967690e+00
 6.00326489e+00 2.74137707e+01 3.55982775e-01 8.02177771e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.90711999019031
cond(S) = 137001.5822699252
E1 = -728.0444218057748  E_coul = 202.9590128791659
init E= -525.085408926609
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.548245977833417  LUMO = 2.64835689286127
  mo_energy =
[-1.18264506e+02 -1.21000604e+01 -9.43398928e+00 -9.43398928e+00
 -9.43398928e+00 -1.24374431e+00 -5.48245978e-01 -5.48245978e-01
 -5.48245978e-01  2.64835689e+00  2.64835689e+00  2.64835689e+00
  2.43049830e+01  2.43049830e+01  2.43049830e+01  1.00721986e+02
  1.43006617e+02  1.43006617e+02  1.43006617e+02  4.92462235e+02
  4.92462235e+02  4.92462235e+02  8.69413670e+02  1.18870946e+03
  1.18870946e+03  1.18870946e+03  2.45066690e+03  2.45066690e+03
  2.45066690e+03  4.73924342e+03  4.73924342e+03  4.73924342e+03
  5.29899359e+03  8.92705985e+03  8.92705985e+03  8.92705985e+03
  2.06316606e+04  7.11763835e+04]
E1 = -728.4651070989137  E_coul = 202.39572868654963
cycle= 1 E= -526.069378412364  delta_E= -0.984  |g|= 0.181  |ddm|= 2.48
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.485086
diis-c [-0.23530857  1.        ]
  HOMO = -0.527117839893033  LUMO = 2.66359867074096
  mo_energy =
[-1.18471477e+02 -1.21366175e+01 -9.47479627e+00 -9.47479627e+00
 -9.47479627e+00 -1.22310983e+00 -5.27117840e-01 -5.27117840e-01
 -5.27117840e-01  2.66359867e+00  2.66359867e+00  2.66359867e+00
  2.42533298e+01  2.42533298e+01  2.42533298e+01  1.00607674e+02
  1.42867333e+02  1.42867333e+02  1.42867333e+02  4.92273834e+02
  4.92273834e+02  4.92273834e+02  8.69116079e+02  1.18847605e+03
  1.18847605e+03  1.18847605e+03  2.45038265e+03  2.45038265e+03
  2.45038265e+03  4.73889831e+03  4.73889831e+03  4.73889831e+03
  5.29849107e+03  8.92660837e+03  8.92660837e+03  8.92660837e+03
  2.06310345e+04  7.11756673e+04]
E1 = -728.572409036374  E_coul = 202.50281002858966
cycle= 2 E= -526.069599007784  delta_E= -0.000221  |g|= 0.0148  |ddm|= 0.00926
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0253584
diis-c [-4.75949374e-04  2.59820133e-02  9.74017987e-01]
  HOMO = -0.526812342725763  LUMO = 2.66481058275567
  mo_energy =
[-1.18449021e+02 -1.21296444e+01 -9.46767877e+00 -9.46767877e+00
 -9.46767877e+00 -1.22264842e+00 -5.26812343e-01 -5.26812343e-01
 -5.26812343e-01  2.66481058e+00  2.66481058e+00  2.66481058e+00
  2.42613013e+01  2.42613013e+01  2.42613013e+01  1.00625984e+02
  1.42884892e+02  1.42884892e+02  1.42884892e+02  4.92295487e+02
  4.92295487e+02  4.92295487e+02  8.69140996e+02  1.18849965e+03
  1.18849965e+03  1.18849965e+03  2.45040753e+03  2.45040753e+03
  2.45040753e+03  4.73892408e+03  4.73892408e+03  4.73892408e+03
  5.29851756e+03  8.92663467e+03  8.92663467e+03  8.92663467e+03
  2.06310611e+04  7.11756939e+04]
E1 = -728.5493487122122  E_coul = 202.47974671123464
cycle= 3 E= -526.069602000978  delta_E= -2.99e-06  |g|= 0.00163  |ddm|= 0.00185
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00320532
diis-c [-1.70206166e-07 -8.90744339e-04  1.03475844e-01  8.97414900e-01]
  HOMO = -0.527024093725292  LUMO = 2.66439037450805
  mo_energy =
[-1.18451778e+02 -1.21309149e+01 -9.46900028e+00 -9.46900028e+00
 -9.46900028e+00 -1.22293094e+00 -5.27024094e-01 -5.27024094e-01
 -5.27024094e-01  2.66439037e+00  2.66439037e+00  2.66439037e+00
  2.42599211e+01  2.42599211e+01  2.42599211e+01  1.00623697e+02
  1.42882588e+02  1.42882588e+02  1.42882588e+02  4.92292817e+02
  4.92292817e+02  4.92292817e+02  8.69137966e+02  1.18849678e+03
  1.18849678e+03  1.18849678e+03  2.45040451e+03  2.45040451e+03
  2.45040451e+03  4.73892093e+03  4.73892093e+03  4.73892093e+03
  5.29851422e+03  8.92663139e+03  8.92663139e+03  8.92663139e+03
  2.06310576e+04  7.11756904e+04]
E1 = -728.5524400831432  E_coul = 202.48283802442552
cycle= 4 E= -526.069602058718  delta_E= -5.77e-08  |g|= 2.93e-05  |ddm|= 0.000276
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79519e-05
diis-c [-3.84791958e-10  5.26071197e-06 -1.44693626e-03 -1.70099284e-03
  1.00314267e+00]
  HOMO = -0.527012966722466  LUMO = 2.66440997458947
  mo_energy =
[-1.18451718e+02 -1.21308662e+01 -9.46895165e+00 -9.46895165e+00
 -9.46895165e+00 -1.22291582e+00 -5.27012967e-01 -5.27012967e-01
 -5.27012967e-01  2.66440997e+00  2.66440997e+00  2.66440997e+00
  2.42599681e+01  2.42599681e+01  2.42599681e+01  1.00623757e+02
  1.42882645e+02  1.42882645e+02  1.42882645e+02  4.92292876e+02
  4.92292876e+02  4.92292876e+02  8.69138022e+02  1.18849684e+03
  1.18849684e+03  1.18849684e+03  2.45040457e+03  2.45040457e+03
  2.45040457e+03  4.73892099e+03  4.73892099e+03  4.73892099e+03
  5.29851427e+03  8.92663144e+03  8.92663144e+03  8.92663144e+03
  2.06310577e+04  7.11756905e+04]
E1 = -728.5523606696344  E_coul = 202.4827586108869
cycle= 5 E= -526.069602058747  delta_E= -2.98e-11  |g|= 3.08e-06  |ddm|= 8.63e-06
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.5523606696344  E_coul = 202.4827586108869
  HOMO = -0.527013840985212  LUMO = 2.66440837657255
  mo_energy =
[-1.18451725e+02 -1.21308704e+01 -9.46895595e+00 -9.46895595e+00
 -9.46895595e+00 -1.22291699e+00 -5.27013841e-01 -5.27013841e-01
 -5.27013841e-01  2.66440838e+00  2.66440838e+00  2.66440838e+00
  2.42599638e+01  2.42599638e+01  2.42599638e+01  1.00623751e+02
  1.42882639e+02  1.42882639e+02  1.42882639e+02  4.92292870e+02
  4.92292870e+02  4.92292870e+02  8.69138015e+02  1.18849683e+03
  1.18849683e+03  1.18849683e+03  2.45040456e+03  2.45040456e+03
  2.45040456e+03  4.73892098e+03  4.73892098e+03  4.73892098e+03
  5.29851426e+03  8.92663144e+03  8.92663144e+03  8.92663144e+03
  2.06310577e+04  7.11756904e+04]
E1 = -728.5523689228276  E_coul = 202.48276686407925
Extra cycle  E= -526.069602058748  delta_E= -7.96e-13  |g|= 6e-07  |ddm|= 8.15e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.24 sec
exp = [2.61854726e+04 7.58572803e+03 3.55357742e+03 6.09821224e+02
 1.41303826e+02 3.97470841e+01 4.61252843e+00 3.93345517e-01
 1.36274818e+03 6.52635191e+02 2.38356298e+02 2.59185159e+02
 8.03956904e+02 2.11861916e+01 9.51119213e+01 1.57066836e+00
 6.00326489e+00 3.55982775e-01]
E = -526.0696020587483
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.4726203        1
[INPUT] 0    0    [1    /1   ]  7585.72803432        1
[INPUT] 0    0    [1    /1   ]  3553.57742103        1
[INPUT] 0    0    [1    /1   ]  609.821223707        1
[INPUT] 0    0    [1    /1   ]  141.303826235        1
[INPUT] 0    0    [1    /1   ]  39.7470840846        1
[INPUT] 0    0    [1    /1   ]  4.6125284347         1
[INPUT] 0    0    [1    /1   ]  0.393345517051       1
[INPUT] 1    0    [1    /1   ]  1362.74817876        1
[INPUT] 1    0    [1    /1   ]  652.635191062        1
[INPUT] 1    0    [1    /1   ]  238.35629772         1
[INPUT] 1    0    [1    /1   ]  259.185158573        1
[INPUT] 1    0    [1    /1   ]  803.956903518        1
[INPUT] 1    0    [1    /1   ]  21.186191642         1
[INPUT] 1    0    [1    /1   ]  95.1119212775        1
[INPUT] 1    0    [1    /1   ]  1.57066835863        1
[INPUT] 1    0    [1    /1   ]  6.00326488794        1
[INPUT] 1    0    [1    /1   ]  0.355982775295       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.472620289296, 1.0]], [0, [7585.72803432124, 1.0]], [0, [3553.5774210304794, 1.0]], [0, [609.8212237069329, 1.0]], [0, [141.3038262350157, 1.0]], [0, [39.74708408463052, 1.0]], [0, [4.612528434704206, 1.0]], [0, [0.39334551705095827, 1.0]], [1, [1362.7481787585298, 1.0]], [1, [652.6351910618384, 1.0]], [1, [238.35629771991105, 1.0]], [1, [259.18515857311644, 1.0]], [1, [803.956903517978, 1.0]], [1, [21.186191641983143, 1.0]], [1, [95.11192127746683, 1.0]], [1, [1.5706683586251438, 1.0]], [1, [6.003264887943843, 1.0]], [1, [0.3559827752945316, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.47262029]
bas 1, expnt(s) = [7585.72803432]
bas 2, expnt(s) = [3553.57742103]
bas 3, expnt(s) = [609.82122371]
bas 4, expnt(s) = [141.30382624]
bas 5, expnt(s) = [39.74708408]
bas 6, expnt(s) = [4.61252843]
bas 7, expnt(s) = [0.39334552]
bas 8, expnt(s) = [1362.74817876]
bas 9, expnt(s) = [652.63519106]
bas 10, expnt(s) = [238.35629772]
bas 11, expnt(s) = [259.18515857]
bas 12, expnt(s) = [803.95690352]
bas 13, expnt(s) = [21.18619164]
bas 14, expnt(s) = [95.11192128]
bas 15, expnt(s) = [1.57066836]
bas 16, expnt(s) = [6.00326489]
bas 17, expnt(s) = [0.35598278]
CPU time:       592.48
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61854726e+04 5.20068245e+03 7.58572803e+03 2.05358638e+03
 3.55357742e+03 1.16282500e+03 6.09821224e+02 3.10039427e+02
 1.41303826e+02 1.03545318e+02 3.97470841e+01 3.99939205e+01
 4.61252843e+00 7.95187083e+00 3.93345517e-01 1.25486116e+00
 1.36274818e+03 2.41548256e+04 6.52635191e+02 9.62326627e+03
 2.38356298e+02 2.73223268e+03 2.59185159e+02 3.03387061e+03
 8.03956904e+02 1.24889335e+04 2.11861916e+01 1.32602134e+02
 9.51119213e+01 8.66518992e+02 1.57066836e+00 5.12967690e+00
 6.00326489e+00 2.74137707e+01 3.55982775e-01 8.02177771e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.90711999019031
cond(S) = 137001.5822699252
E1 = -728.0444218057748  E_coul = 202.9590128791659
init E= -525.085408926609
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.548245977833417  LUMO = 2.64835689286127
  mo_energy =
[-1.18264506e+02 -1.21000604e+01 -9.43398928e+00 -9.43398928e+00
 -9.43398928e+00 -1.24374431e+00 -5.48245978e-01 -5.48245978e-01
 -5.48245978e-01  2.64835689e+00  2.64835689e+00  2.64835689e+00
  2.43049830e+01  2.43049830e+01  2.43049830e+01  1.00721986e+02
  1.43006617e+02  1.43006617e+02  1.43006617e+02  4.92462235e+02
  4.92462235e+02  4.92462235e+02  8.69413670e+02  1.18870946e+03
  1.18870946e+03  1.18870946e+03  2.45066690e+03  2.45066690e+03
  2.45066690e+03  4.73924342e+03  4.73924342e+03  4.73924342e+03
  5.29899359e+03  8.92705985e+03  8.92705985e+03  8.92705985e+03
  2.06316606e+04  7.11763835e+04]
E1 = -728.4651070989137  E_coul = 202.39572868654963
cycle= 1 E= -526.069378412364  delta_E= -0.984  |g|= 0.181  |ddm|= 2.48
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.485086
diis-c [-0.23530857  1.        ]
  HOMO = -0.527117839893033  LUMO = 2.66359867074096
  mo_energy =
[-1.18471477e+02 -1.21366175e+01 -9.47479627e+00 -9.47479627e+00
 -9.47479627e+00 -1.22310983e+00 -5.27117840e-01 -5.27117840e-01
 -5.27117840e-01  2.66359867e+00  2.66359867e+00  2.66359867e+00
  2.42533298e+01  2.42533298e+01  2.42533298e+01  1.00607674e+02
  1.42867333e+02  1.42867333e+02  1.42867333e+02  4.92273834e+02
  4.92273834e+02  4.92273834e+02  8.69116079e+02  1.18847605e+03
  1.18847605e+03  1.18847605e+03  2.45038265e+03  2.45038265e+03
  2.45038265e+03  4.73889831e+03  4.73889831e+03  4.73889831e+03
  5.29849107e+03  8.92660837e+03  8.92660837e+03  8.92660837e+03
  2.06310345e+04  7.11756673e+04]
E1 = -728.572409036374  E_coul = 202.50281002858966
cycle= 2 E= -526.069599007784  delta_E= -0.000221  |g|= 0.0148  |ddm|= 0.00926
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0253584
diis-c [-4.75949374e-04  2.59820133e-02  9.74017987e-01]
  HOMO = -0.526812342725763  LUMO = 2.66481058275567
  mo_energy =
[-1.18449021e+02 -1.21296444e+01 -9.46767877e+00 -9.46767877e+00
 -9.46767877e+00 -1.22264842e+00 -5.26812343e-01 -5.26812343e-01
 -5.26812343e-01  2.66481058e+00  2.66481058e+00  2.66481058e+00
  2.42613013e+01  2.42613013e+01  2.42613013e+01  1.00625984e+02
  1.42884892e+02  1.42884892e+02  1.42884892e+02  4.92295487e+02
  4.92295487e+02  4.92295487e+02  8.69140996e+02  1.18849965e+03
  1.18849965e+03  1.18849965e+03  2.45040753e+03  2.45040753e+03
  2.45040753e+03  4.73892408e+03  4.73892408e+03  4.73892408e+03
  5.29851756e+03  8.92663467e+03  8.92663467e+03  8.92663467e+03
  2.06310611e+04  7.11756939e+04]
E1 = -728.5493487122122  E_coul = 202.47974671123464
cycle= 3 E= -526.069602000978  delta_E= -2.99e-06  |g|= 0.00163  |ddm|= 0.00185
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00320532
diis-c [-1.70206166e-07 -8.90744339e-04  1.03475844e-01  8.97414900e-01]
  HOMO = -0.527024093725292  LUMO = 2.66439037450805
  mo_energy =
[-1.18451778e+02 -1.21309149e+01 -9.46900028e+00 -9.46900028e+00
 -9.46900028e+00 -1.22293094e+00 -5.27024094e-01 -5.27024094e-01
 -5.27024094e-01  2.66439037e+00  2.66439037e+00  2.66439037e+00
  2.42599211e+01  2.42599211e+01  2.42599211e+01  1.00623697e+02
  1.42882588e+02  1.42882588e+02  1.42882588e+02  4.92292817e+02
  4.92292817e+02  4.92292817e+02  8.69137966e+02  1.18849678e+03
  1.18849678e+03  1.18849678e+03  2.45040451e+03  2.45040451e+03
  2.45040451e+03  4.73892093e+03  4.73892093e+03  4.73892093e+03
  5.29851422e+03  8.92663139e+03  8.92663139e+03  8.92663139e+03
  2.06310576e+04  7.11756904e+04]
E1 = -728.5524400831432  E_coul = 202.48283802442552
cycle= 4 E= -526.069602058718  delta_E= -5.77e-08  |g|= 2.93e-05  |ddm|= 0.000276
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79519e-05
diis-c [-3.84791958e-10  5.26071197e-06 -1.44693626e-03 -1.70099284e-03
  1.00314267e+00]
  HOMO = -0.527012966722466  LUMO = 2.66440997458947
  mo_energy =
[-1.18451718e+02 -1.21308662e+01 -9.46895165e+00 -9.46895165e+00
 -9.46895165e+00 -1.22291582e+00 -5.27012967e-01 -5.27012967e-01
 -5.27012967e-01  2.66440997e+00  2.66440997e+00  2.66440997e+00
  2.42599681e+01  2.42599681e+01  2.42599681e+01  1.00623757e+02
  1.42882645e+02  1.42882645e+02  1.42882645e+02  4.92292876e+02
  4.92292876e+02  4.92292876e+02  8.69138022e+02  1.18849684e+03
  1.18849684e+03  1.18849684e+03  2.45040457e+03  2.45040457e+03
  2.45040457e+03  4.73892099e+03  4.73892099e+03  4.73892099e+03
  5.29851427e+03  8.92663144e+03  8.92663144e+03  8.92663144e+03
  2.06310577e+04  7.11756905e+04]
E1 = -728.5523606696344  E_coul = 202.4827586108869
cycle= 5 E= -526.069602058747  delta_E= -2.98e-11  |g|= 3.08e-06  |ddm|= 8.63e-06
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.5523606696344  E_coul = 202.4827586108869
  HOMO = -0.527013840985212  LUMO = 2.66440837657255
  mo_energy =
[-1.18451725e+02 -1.21308704e+01 -9.46895595e+00 -9.46895595e+00
 -9.46895595e+00 -1.22291699e+00 -5.27013841e-01 -5.27013841e-01
 -5.27013841e-01  2.66440838e+00  2.66440838e+00  2.66440838e+00
  2.42599638e+01  2.42599638e+01  2.42599638e+01  1.00623751e+02
  1.42882639e+02  1.42882639e+02  1.42882639e+02  4.92292870e+02
  4.92292870e+02  4.92292870e+02  8.69138015e+02  1.18849683e+03
  1.18849683e+03  1.18849683e+03  2.45040456e+03  2.45040456e+03
  2.45040456e+03  4.73892098e+03  4.73892098e+03  4.73892098e+03
  5.29851426e+03  8.92663144e+03  8.92663144e+03  8.92663144e+03
  2.06310577e+04  7.11756904e+04]
E1 = -728.5523689228276  E_coul = 202.48276686407925
Extra cycle  E= -526.069602058748  delta_E= -7.96e-13  |g|= 6e-07  |ddm|= 8.15e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.24 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 137001.5822699252
E1 = -728.5523689228276  E_coul = 202.48276686407925
init E= -526.069602058748
    CPU time for initialize scf      0.97 sec, wall time      0.19 sec
  HOMO = -0.527013733917377  LUMO = 2.66440858347952
  mo_energy =
[-1.18451724e+02 -1.21308698e+01 -9.46895533e+00 -9.46895533e+00
 -9.46895533e+00 -1.22291685e+00 -5.27013734e-01 -5.27013734e-01
 -5.27013734e-01  2.66440858e+00  2.66440858e+00  2.66440858e+00
  2.42599644e+01  2.42599644e+01  2.42599644e+01  1.00623752e+02
  1.42882640e+02  1.42882640e+02  1.42882640e+02  4.92292871e+02
  4.92292871e+02  4.92292871e+02  8.69138017e+02  1.18849683e+03
  1.18849683e+03  1.18849683e+03  2.45040457e+03  2.45040457e+03
  2.45040457e+03  4.73892098e+03  4.73892098e+03  4.73892098e+03
  5.29851426e+03  8.92663144e+03  8.92663144e+03  8.92663144e+03
  2.06310577e+04  7.11756905e+04]
E1 = -728.5523675563011  E_coul = 202.48276549755255
cycle= 1 E= -526.069602058749  delta_E= -2.27e-13  |g|= 1.05e-07  |ddm|= 1.26e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.5523675563011  E_coul = 202.48276549755255
  HOMO = -0.527013750643932  LUMO = 2.66440855057107
  mo_energy =
[-1.18451724e+02 -1.21308699e+01 -9.46895543e+00 -9.46895543e+00
 -9.46895543e+00 -1.22291687e+00 -5.27013751e-01 -5.27013751e-01
 -5.27013751e-01  2.66440855e+00  2.66440855e+00  2.66440855e+00
  2.42599643e+01  2.42599643e+01  2.42599643e+01  1.00623751e+02
  1.42882640e+02  1.42882640e+02  1.42882640e+02  4.92292871e+02
  4.92292871e+02  4.92292871e+02  8.69138017e+02  1.18849683e+03
  1.18849683e+03  1.18849683e+03  2.45040457e+03  2.45040457e+03
  2.45040457e+03  4.73892098e+03  4.73892098e+03  4.73892098e+03
  5.29851426e+03  8.92663144e+03  8.92663144e+03  8.92663144e+03
  2.06310577e+04  7.11756904e+04]
E1 = -728.552367788668  E_coul = 202.48276572991875
Extra cycle  E= -526.069602058749  delta_E= -7.96e-13  |g|= 1.82e-08  |ddm|= 2.11e-08
    CPU time for scf_cycle      1.07 sec, wall time      0.29 sec
exp = [2.61854726e+04 7.58572803e+03 3.55357742e+03 6.09821224e+02
 1.41303826e+02 3.97470841e+01 4.61252843e+00 3.93345517e-01
 1.36274818e+03 6.52635191e+02 2.38356298e+02 2.59185159e+02
 8.03956904e+02 2.11861916e+01 9.51119213e+01 1.57066836e+00
 6.00326489e+00 3.55982775e-01]
grad_E = [ 4.07660748e-07  9.16753301e-07  5.28226948e-05  3.13783330e-04
 -1.36557836e-03 -2.61135118e-03  1.39098889e-03  8.21308226e-03
  2.11087264e-06  1.43660339e-05  1.40682709e-04  1.21980509e-04
  9.47698756e-06  1.35097598e-03  2.20191212e-03  4.55434358e-02
  1.69967743e-02 -3.24917871e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.4968643        1
[INPUT] 0    0    [1    /1   ]  7585.46595919        1
[INPUT] 0    0    [1    /1   ]  3553.06196952        1
[INPUT] 0    0    [1    /1   ]  601.662019502        1
[INPUT] 0    0    [1    /1   ]  138.467684274        1
[INPUT] 0    0    [1    /1   ]  39.3165213424        1
[INPUT] 0    0    [1    /1   ]  4.6109648826         1
[INPUT] 0    0    [1    /1   ]  0.391232825155       1
[INPUT] 1    0    [1    /1   ]  1362.76738247        1
[INPUT] 1    0    [1    /1   ]  652.698137745        1
[INPUT] 1    0    [1    /1   ]  238.762734709        1
[INPUT] 1    0    [1    /1   ]  259.547900016        1
[INPUT] 1    0    [1    /1   ]  790.29476893         1
[INPUT] 1    0    [1    /1   ]  19.9185466192        1
[INPUT] 1    0    [1    /1   ]  90.5073704374        1
[INPUT] 1    0    [1    /1   ]  1.56620768848        1
[INPUT] 1    0    [1    /1   ]  5.70375562972        1
[INPUT] 1    0    [1    /1   ]  0.370759371864       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.4968643473, 1.0]], [0, [7585.465959193778, 1.0]], [0, [3553.0619695205405, 1.0]], [0, [601.6620195017732, 1.0]], [0, [138.46768427394827, 1.0]], [0, [39.31652134241565, 1.0]], [0, [4.61096488259536, 1.0]], [0, [0.3912328251546605, 1.0]], [1, [1362.7673824651422, 1.0]], [1, [652.6981377445737, 1.0]], [1, [238.76273470853278, 1.0]], [1, [259.5479000156913, 1.0]], [1, [790.2947689296478, 1.0]], [1, [19.918546619171163, 1.0]], [1, [90.50737043744068, 1.0]], [1, [1.5662076884846807, 1.0]], [1, [5.703755629720255, 1.0]], [1, [0.37075937186418306, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.49686435]
bas 1, expnt(s) = [7585.46595919]
bas 2, expnt(s) = [3553.06196952]
bas 3, expnt(s) = [601.6620195]
bas 4, expnt(s) = [138.46768427]
bas 5, expnt(s) = [39.31652134]
bas 6, expnt(s) = [4.61096488]
bas 7, expnt(s) = [0.39123283]
bas 8, expnt(s) = [1362.76738247]
bas 9, expnt(s) = [652.69813774]
bas 10, expnt(s) = [238.76273471]
bas 11, expnt(s) = [259.54790002]
bas 12, expnt(s) = [790.29476893]
bas 13, expnt(s) = [19.91854662]
bas 14, expnt(s) = [90.50737044]
bas 15, expnt(s) = [1.56620769]
bas 16, expnt(s) = [5.70375563]
bas 17, expnt(s) = [0.37075937]
CPU time:       598.23
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61854969e+04 5.20068606e+03 7.58546596e+03 2.05353317e+03
 3.55306197e+03 1.16269850e+03 6.01662020e+02 3.06923027e+02
 1.38467684e+02 1.01982663e+02 3.93165213e+01 3.96685511e+01
 4.61096488e+00 7.94984910e+00 3.91232825e-01 1.24980279e+00
 1.36276738e+03 2.41552510e+04 6.52698138e+02 9.62442648e+03
 2.38762735e+02 2.73805756e+03 2.59547900e+02 3.03917908e+03
 7.90294769e+02 1.22242093e+04 1.99185466e+01 1.22759879e+02
 9.05073704e+01 8.14402928e+02 1.56620769e+00 5.11147313e+00
 5.70375563e+00 2.57149409e+01 3.70759372e-01 8.44013833e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.896925612733725
cond(S) = 132543.09259321567
E1 = -728.1203095257133  E_coul = 202.9800757958502
init E= -525.140233729863
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.54526255035439  LUMO = 2.68695265281848
  mo_energy =
[-1.18263655e+02 -1.21012613e+01 -9.43601144e+00 -9.43601144e+00
 -9.43601144e+00 -1.23943865e+00 -5.45262550e-01 -5.45262550e-01
 -5.45262550e-01  2.68695265e+00  2.68695265e+00  2.68695265e+00
  2.27910543e+01  2.27910543e+01  2.27910543e+01  9.84261461e+01
  1.35541674e+02  1.35541674e+02  1.35541674e+02  4.77993114e+02
  4.77993114e+02  4.77993114e+02  8.52959182e+02  1.16927184e+03
  1.16927184e+03  1.16927184e+03  2.42594187e+03  2.42594187e+03
  2.42594187e+03  4.70207367e+03  4.70207367e+03  4.70207367e+03
  5.26273646e+03  8.87095101e+03  8.87095101e+03  8.87095101e+03
  2.05903809e+04  7.11354751e+04]
E1 = -729.0041072274676  E_coul = 202.92877449339298
cycle= 1 E= -526.075332734075  delta_E= -0.935  |g|= 0.182  |ddm|= 1.95
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.489799
diis-c [-0.23990331  1.        ]
  HOMO = -0.509080107541225  LUMO = 2.72516027087893
  mo_energy =
[-1.18437542e+02 -1.20979886e+01 -9.43690579e+00 -9.43690579e+00
 -9.43690579e+00 -1.19991696e+00 -5.09080108e-01 -5.09080108e-01
 -5.09080108e-01  2.72516027e+00  2.72516027e+00  2.72516027e+00
  2.27815414e+01  2.27815414e+01  2.27815414e+01  9.83489091e+01
  1.35439925e+02  1.35439925e+02  1.35439925e+02  4.77838739e+02
  4.77838739e+02  4.77838739e+02  8.52695564e+02  1.16907126e+03
  1.16907126e+03  1.16907126e+03  2.42568993e+03  2.42568993e+03
  2.42568993e+03  4.70176027e+03  4.70176027e+03  4.70176027e+03
  5.26226366e+03  8.87053002e+03  8.87053002e+03  8.87053002e+03
  2.05897834e+04  7.11347873e+04]
E1 = -729.0613994678992  E_coul = 202.98583051251916
cycle= 2 E= -526.07556895538  delta_E= -0.000236  |g|= 0.0128  |ddm|= 0.0128
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0220108
diis-c [-3.65500646e-04  2.18004895e-02  9.78199511e-01]
  HOMO = -0.509680945158732  LUMO = 2.72479961492097
  mo_energy =
[-1.18420147e+02 -1.20947736e+01 -9.43362183e+00 -9.43362183e+00
 -9.43362183e+00 -1.20066335e+00 -5.09680945e-01 -5.09680945e-01
 -5.09680945e-01  2.72479961e+00  2.72479961e+00  2.72479961e+00
  2.27854267e+01  2.27854267e+01  2.27854267e+01  9.83623632e+01
  1.35452593e+02  1.35452593e+02  1.35452593e+02  4.77855363e+02
  4.77855363e+02  4.77855363e+02  8.52715367e+02  1.16908978e+03
  1.16908978e+03  1.16908978e+03  2.42570970e+03  2.42570970e+03
  2.42570970e+03  4.70178092e+03  4.70178092e+03  4.70178092e+03
  5.26228508e+03  8.87055124e+03  8.87055124e+03  8.87055124e+03
  2.05898050e+04  7.11348089e+04]
E1 = -729.0448583152819  E_coul = 202.96928749799642
cycle= 3 E= -526.075570817285  delta_E= -1.86e-06  |g|= 0.00128  |ddm|= 0.00124
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00259051
diis-c [-1.55385056e-07 -8.23135022e-04  9.56006622e-02  9.05222473e-01]
  HOMO = -0.509837561868533  LUMO = 2.724493866035
  mo_energy =
[-1.18422334e+02 -1.20957361e+01 -9.43462770e+00 -9.43462770e+00
 -9.43462770e+00 -1.20086865e+00 -5.09837562e-01 -5.09837562e-01
 -5.09837562e-01  2.72449387e+00  2.72449387e+00  2.72449387e+00
  2.27844108e+01  2.27844108e+01  2.27844108e+01  9.83605834e+01
  1.35450799e+02  1.35450799e+02  1.35450799e+02  4.77853252e+02
  4.77853252e+02  4.77853252e+02  8.52712946e+02  1.16908750e+03
  1.16908750e+03  1.16908750e+03  2.42570729e+03  2.42570729e+03
  2.42570729e+03  4.70177840e+03  4.70177840e+03  4.70177840e+03
  5.26228238e+03  8.87054859e+03  8.87054859e+03  8.87054859e+03
  2.05898022e+04  7.11348061e+04]
E1 = -729.0472002342672  E_coul = 202.97162938292487
cycle= 4 E= -526.075570851342  delta_E= -3.41e-08  |g|= 3.64e-05  |ddm|= 0.00021
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=4.97489e-05
diis-c [-4.57651045e-10  7.49714437e-07 -7.49483993e-04  1.08240583e-02
  9.89924676e-01]
  HOMO = -0.509825398153234  LUMO = 2.72451521179549
  mo_energy =
[-1.18422261e+02 -1.20956810e+01 -9.43457255e+00 -9.43457255e+00
 -9.43457255e+00 -1.20085245e+00 -5.09825398e-01 -5.09825398e-01
 -5.09825398e-01  2.72451521e+00  2.72451521e+00  2.72451521e+00
  2.27844636e+01  2.27844636e+01  2.27844636e+01  9.83606543e+01
  1.35450868e+02  1.35450868e+02  1.35450868e+02  4.77853324e+02
  4.77853324e+02  4.77853324e+02  8.52713015e+02  1.16908757e+03
  1.16908757e+03  1.16908757e+03  2.42570736e+03  2.42570736e+03
  2.42570736e+03  4.70177847e+03  4.70177847e+03  4.70177847e+03
  5.26228244e+03  8.87054866e+03  8.87054866e+03  8.87054866e+03
  2.05898023e+04  7.11348061e+04]
E1 = -729.047110728301  E_coul = 202.97153987691934
cycle= 5 E= -526.075570851382  delta_E= -3.94e-11  |g|= 3e-06  |ddm|= 9.62e-06
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -729.047110728301  E_coul = 202.97153987691934
  HOMO = -0.509826248991098  LUMO = 2.72451370376381
  mo_energy =
[-1.18422268e+02 -1.20956850e+01 -9.43457668e+00 -9.43457668e+00
 -9.43457668e+00 -1.20085358e+00 -5.09826249e-01 -5.09826249e-01
 -5.09826249e-01  2.72451370e+00  2.72451370e+00  2.72451370e+00
  2.27844596e+01  2.27844596e+01  2.27844596e+01  9.83606484e+01
  1.35450862e+02  1.35450862e+02  1.35450862e+02  4.77853317e+02
  4.77853317e+02  4.77853317e+02  8.52713008e+02  1.16908756e+03
  1.16908756e+03  1.16908756e+03  2.42570735e+03  2.42570735e+03
  2.42570735e+03  4.70177846e+03  4.70177846e+03  4.70177846e+03
  5.26228243e+03  8.87054865e+03  8.87054865e+03  8.87054865e+03
  2.05898023e+04  7.11348061e+04]
E1 = -729.0471183666053  E_coul = 202.97154751522373
Extra cycle  E= -526.075570851382  delta_E= 1.14e-13  |g|= 5.75e-07  |ddm|= 7.6e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.18 sec
exp = [2.61854969e+04 7.58546596e+03 3.55306197e+03 6.01662020e+02
 1.38467684e+02 3.93165213e+01 4.61096488e+00 3.91232825e-01
 1.36276738e+03 6.52698138e+02 2.38762735e+02 2.59547900e+02
 7.90294769e+02 1.99185466e+01 9.05073704e+01 1.56620769e+00
 5.70375563e+00 3.70759372e-01]
E = -526.0755708513816
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.4968643        1
[INPUT] 0    0    [1    /1   ]  7585.46595919        1
[INPUT] 0    0    [1    /1   ]  3553.06196952        1
[INPUT] 0    0    [1    /1   ]  601.662019502        1
[INPUT] 0    0    [1    /1   ]  138.467684274        1
[INPUT] 0    0    [1    /1   ]  39.3165213424        1
[INPUT] 0    0    [1    /1   ]  4.6109648826         1
[INPUT] 0    0    [1    /1   ]  0.391232825155       1
[INPUT] 1    0    [1    /1   ]  1362.76738247        1
[INPUT] 1    0    [1    /1   ]  652.698137745        1
[INPUT] 1    0    [1    /1   ]  238.762734709        1
[INPUT] 1    0    [1    /1   ]  259.547900016        1
[INPUT] 1    0    [1    /1   ]  790.29476893         1
[INPUT] 1    0    [1    /1   ]  19.9185466192        1
[INPUT] 1    0    [1    /1   ]  90.5073704374        1
[INPUT] 1    0    [1    /1   ]  1.56620768848        1
[INPUT] 1    0    [1    /1   ]  5.70375562972        1
[INPUT] 1    0    [1    /1   ]  0.370759371864       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.4968643473, 1.0]], [0, [7585.465959193778, 1.0]], [0, [3553.0619695205405, 1.0]], [0, [601.6620195017732, 1.0]], [0, [138.46768427394827, 1.0]], [0, [39.31652134241565, 1.0]], [0, [4.61096488259536, 1.0]], [0, [0.3912328251546605, 1.0]], [1, [1362.7673824651422, 1.0]], [1, [652.6981377445737, 1.0]], [1, [238.76273470853278, 1.0]], [1, [259.5479000156913, 1.0]], [1, [790.2947689296478, 1.0]], [1, [19.918546619171163, 1.0]], [1, [90.50737043744068, 1.0]], [1, [1.5662076884846807, 1.0]], [1, [5.703755629720255, 1.0]], [1, [0.37075937186418306, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.49686435]
bas 1, expnt(s) = [7585.46595919]
bas 2, expnt(s) = [3553.06196952]
bas 3, expnt(s) = [601.6620195]
bas 4, expnt(s) = [138.46768427]
bas 5, expnt(s) = [39.31652134]
bas 6, expnt(s) = [4.61096488]
bas 7, expnt(s) = [0.39123283]
bas 8, expnt(s) = [1362.76738247]
bas 9, expnt(s) = [652.69813774]
bas 10, expnt(s) = [238.76273471]
bas 11, expnt(s) = [259.54790002]
bas 12, expnt(s) = [790.29476893]
bas 13, expnt(s) = [19.91854662]
bas 14, expnt(s) = [90.50737044]
bas 15, expnt(s) = [1.56620769]
bas 16, expnt(s) = [5.70375563]
bas 17, expnt(s) = [0.37075937]
CPU time:       598.80
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61854969e+04 5.20068606e+03 7.58546596e+03 2.05353317e+03
 3.55306197e+03 1.16269850e+03 6.01662020e+02 3.06923027e+02
 1.38467684e+02 1.01982663e+02 3.93165213e+01 3.96685511e+01
 4.61096488e+00 7.94984910e+00 3.91232825e-01 1.24980279e+00
 1.36276738e+03 2.41552510e+04 6.52698138e+02 9.62442648e+03
 2.38762735e+02 2.73805756e+03 2.59547900e+02 3.03917908e+03
 7.90294769e+02 1.22242093e+04 1.99185466e+01 1.22759879e+02
 9.05073704e+01 8.14402928e+02 1.56620769e+00 5.11147313e+00
 5.70375563e+00 2.57149409e+01 3.70759372e-01 8.44013833e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.896925612733725
cond(S) = 132543.09259321567
E1 = -728.1203095257133  E_coul = 202.9800757958502
init E= -525.140233729863
    CPU time for initialize scf      0.13 sec, wall time      0.04 sec
  HOMO = -0.54526255035439  LUMO = 2.68695265281848
  mo_energy =
[-1.18263655e+02 -1.21012613e+01 -9.43601144e+00 -9.43601144e+00
 -9.43601144e+00 -1.23943865e+00 -5.45262550e-01 -5.45262550e-01
 -5.45262550e-01  2.68695265e+00  2.68695265e+00  2.68695265e+00
  2.27910543e+01  2.27910543e+01  2.27910543e+01  9.84261461e+01
  1.35541674e+02  1.35541674e+02  1.35541674e+02  4.77993114e+02
  4.77993114e+02  4.77993114e+02  8.52959182e+02  1.16927184e+03
  1.16927184e+03  1.16927184e+03  2.42594187e+03  2.42594187e+03
  2.42594187e+03  4.70207367e+03  4.70207367e+03  4.70207367e+03
  5.26273646e+03  8.87095101e+03  8.87095101e+03  8.87095101e+03
  2.05903809e+04  7.11354751e+04]
E1 = -729.0041072274676  E_coul = 202.92877449339298
cycle= 1 E= -526.075332734075  delta_E= -0.935  |g|= 0.182  |ddm|= 1.95
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.489799
diis-c [-0.23990331  1.        ]
  HOMO = -0.509080107541225  LUMO = 2.72516027087893
  mo_energy =
[-1.18437542e+02 -1.20979886e+01 -9.43690579e+00 -9.43690579e+00
 -9.43690579e+00 -1.19991696e+00 -5.09080108e-01 -5.09080108e-01
 -5.09080108e-01  2.72516027e+00  2.72516027e+00  2.72516027e+00
  2.27815414e+01  2.27815414e+01  2.27815414e+01  9.83489091e+01
  1.35439925e+02  1.35439925e+02  1.35439925e+02  4.77838739e+02
  4.77838739e+02  4.77838739e+02  8.52695564e+02  1.16907126e+03
  1.16907126e+03  1.16907126e+03  2.42568993e+03  2.42568993e+03
  2.42568993e+03  4.70176027e+03  4.70176027e+03  4.70176027e+03
  5.26226366e+03  8.87053002e+03  8.87053002e+03  8.87053002e+03
  2.05897834e+04  7.11347873e+04]
E1 = -729.0613994678992  E_coul = 202.98583051251916
cycle= 2 E= -526.07556895538  delta_E= -0.000236  |g|= 0.0128  |ddm|= 0.0128
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0220108
diis-c [-3.65500646e-04  2.18004895e-02  9.78199511e-01]
  HOMO = -0.509680945158732  LUMO = 2.72479961492097
  mo_energy =
[-1.18420147e+02 -1.20947736e+01 -9.43362183e+00 -9.43362183e+00
 -9.43362183e+00 -1.20066335e+00 -5.09680945e-01 -5.09680945e-01
 -5.09680945e-01  2.72479961e+00  2.72479961e+00  2.72479961e+00
  2.27854267e+01  2.27854267e+01  2.27854267e+01  9.83623632e+01
  1.35452593e+02  1.35452593e+02  1.35452593e+02  4.77855363e+02
  4.77855363e+02  4.77855363e+02  8.52715367e+02  1.16908978e+03
  1.16908978e+03  1.16908978e+03  2.42570970e+03  2.42570970e+03
  2.42570970e+03  4.70178092e+03  4.70178092e+03  4.70178092e+03
  5.26228508e+03  8.87055124e+03  8.87055124e+03  8.87055124e+03
  2.05898050e+04  7.11348089e+04]
E1 = -729.0448583152819  E_coul = 202.96928749799642
cycle= 3 E= -526.075570817285  delta_E= -1.86e-06  |g|= 0.00128  |ddm|= 0.00124
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00259051
diis-c [-1.55385056e-07 -8.23135022e-04  9.56006622e-02  9.05222473e-01]
  HOMO = -0.509837561868533  LUMO = 2.724493866035
  mo_energy =
[-1.18422334e+02 -1.20957361e+01 -9.43462770e+00 -9.43462770e+00
 -9.43462770e+00 -1.20086865e+00 -5.09837562e-01 -5.09837562e-01
 -5.09837562e-01  2.72449387e+00  2.72449387e+00  2.72449387e+00
  2.27844108e+01  2.27844108e+01  2.27844108e+01  9.83605834e+01
  1.35450799e+02  1.35450799e+02  1.35450799e+02  4.77853252e+02
  4.77853252e+02  4.77853252e+02  8.52712946e+02  1.16908750e+03
  1.16908750e+03  1.16908750e+03  2.42570729e+03  2.42570729e+03
  2.42570729e+03  4.70177840e+03  4.70177840e+03  4.70177840e+03
  5.26228238e+03  8.87054859e+03  8.87054859e+03  8.87054859e+03
  2.05898022e+04  7.11348061e+04]
E1 = -729.0472002342672  E_coul = 202.97162938292487
cycle= 4 E= -526.075570851342  delta_E= -3.41e-08  |g|= 3.64e-05  |ddm|= 0.00021
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=4.97489e-05
diis-c [-4.57651045e-10  7.49714437e-07 -7.49483993e-04  1.08240583e-02
  9.89924676e-01]
  HOMO = -0.509825398153234  LUMO = 2.72451521179549
  mo_energy =
[-1.18422261e+02 -1.20956810e+01 -9.43457255e+00 -9.43457255e+00
 -9.43457255e+00 -1.20085245e+00 -5.09825398e-01 -5.09825398e-01
 -5.09825398e-01  2.72451521e+00  2.72451521e+00  2.72451521e+00
  2.27844636e+01  2.27844636e+01  2.27844636e+01  9.83606543e+01
  1.35450868e+02  1.35450868e+02  1.35450868e+02  4.77853324e+02
  4.77853324e+02  4.77853324e+02  8.52713015e+02  1.16908757e+03
  1.16908757e+03  1.16908757e+03  2.42570736e+03  2.42570736e+03
  2.42570736e+03  4.70177847e+03  4.70177847e+03  4.70177847e+03
  5.26228244e+03  8.87054866e+03  8.87054866e+03  8.87054866e+03
  2.05898023e+04  7.11348061e+04]
E1 = -729.047110728301  E_coul = 202.97153987691934
cycle= 5 E= -526.075570851382  delta_E= -3.94e-11  |g|= 3e-06  |ddm|= 9.62e-06
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -729.047110728301  E_coul = 202.97153987691934
  HOMO = -0.509826248991098  LUMO = 2.72451370376381
  mo_energy =
[-1.18422268e+02 -1.20956850e+01 -9.43457668e+00 -9.43457668e+00
 -9.43457668e+00 -1.20085358e+00 -5.09826249e-01 -5.09826249e-01
 -5.09826249e-01  2.72451370e+00  2.72451370e+00  2.72451370e+00
  2.27844596e+01  2.27844596e+01  2.27844596e+01  9.83606484e+01
  1.35450862e+02  1.35450862e+02  1.35450862e+02  4.77853317e+02
  4.77853317e+02  4.77853317e+02  8.52713008e+02  1.16908756e+03
  1.16908756e+03  1.16908756e+03  2.42570735e+03  2.42570735e+03
  2.42570735e+03  4.70177846e+03  4.70177846e+03  4.70177846e+03
  5.26228243e+03  8.87054865e+03  8.87054865e+03  8.87054865e+03
  2.05898023e+04  7.11348061e+04]
E1 = -729.0471183666053  E_coul = 202.97154751522373
Extra cycle  E= -526.075570851382  delta_E= 1.14e-13  |g|= 5.75e-07  |ddm|= 7.6e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.18 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 132543.09259321567
E1 = -729.0471183666053  E_coul = 202.97154751522373
init E= -526.075570851382
    CPU time for initialize scf      0.94 sec, wall time      0.18 sec
  HOMO = -0.509826152968644  LUMO = 2.72451388742007
  mo_energy =
[-1.18422267e+02 -1.20956844e+01 -9.43457611e+00 -9.43457611e+00
 -9.43457611e+00 -1.20085345e+00 -5.09826153e-01 -5.09826153e-01
 -5.09826153e-01  2.72451389e+00  2.72451389e+00  2.72451389e+00
  2.27844601e+01  2.27844601e+01  2.27844601e+01  9.83606494e+01
  1.35450863e+02  1.35450863e+02  1.35450863e+02  4.77853319e+02
  4.77853319e+02  4.77853319e+02  8.52713009e+02  1.16908756e+03
  1.16908756e+03  1.16908756e+03  2.42570735e+03  2.42570735e+03
  2.42570735e+03  4.70177846e+03  4.70177846e+03  4.70177846e+03
  5.26228243e+03  8.87054865e+03  8.87054865e+03  8.87054865e+03
  2.05898023e+04  7.11348061e+04]
E1 = -729.0471171265146  E_coul = 202.97154627513257
cycle= 1 E= -526.075570851382  delta_E= -4.55e-13  |g|= 9.74e-08  |ddm|= 1.15e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -729.0471171265146  E_coul = 202.97154627513257
  HOMO = -0.509826167916379  LUMO = 2.7245138585863
  mo_energy =
[-1.18422267e+02 -1.20956845e+01 -9.43457620e+00 -9.43457620e+00
 -9.43457620e+00 -1.20085347e+00 -5.09826168e-01 -5.09826168e-01
 -5.09826168e-01  2.72451386e+00  2.72451386e+00  2.72451386e+00
  2.27844600e+01  2.27844600e+01  2.27844600e+01  9.83606492e+01
  1.35450863e+02  1.35450863e+02  1.35450863e+02  4.77853318e+02
  4.77853318e+02  4.77853318e+02  8.52713009e+02  1.16908756e+03
  1.16908756e+03  1.16908756e+03  2.42570735e+03  2.42570735e+03
  2.42570735e+03  4.70177846e+03  4.70177846e+03  4.70177846e+03
  5.26228243e+03  8.87054865e+03  8.87054865e+03  8.87054865e+03
  2.05898023e+04  7.11348061e+04]
E1 = -729.047117332021  E_coul = 202.97154648063864
Extra cycle  E= -526.075570851382  delta_E= -3.41e-13  |g|= 1.64e-08  |ddm|= 1.88e-08
    CPU time for scf_cycle      1.05 sec, wall time      0.28 sec
exp = [2.61854969e+04 7.58546596e+03 3.55306197e+03 6.01662020e+02
 1.38467684e+02 3.93165213e+01 4.61096488e+00 3.91232825e-01
 1.36276738e+03 6.52698138e+02 2.38762735e+02 2.59547900e+02
 7.90294769e+02 1.99185466e+01 9.05073704e+01 1.56620769e+00
 5.70375563e+00 3.70759372e-01]
grad_E = [ 4.48952008e-07  1.03440860e-06  5.45976017e-05  4.55483257e-04
 -2.95279522e-03  8.49622655e-05  2.37775211e-03  1.21841367e-02
  2.85562803e-06  1.85381996e-05  1.76898318e-04  1.53436037e-04
  1.26264878e-05 -6.61003841e-03  3.28762863e-03  4.86367022e-02
 -1.90344703e-02  2.87789934e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.5007905        1
[INPUT] 0    0    [1    /1   ]  7585.42392316        1
[INPUT] 0    0    [1    /1   ]  3552.98002788        1
[INPUT] 0    0    [1    /1   ]  600.342425797        1
[INPUT] 0    0    [1    /1   ]  137.893384269        1
[INPUT] 0    0    [1    /1   ]  39.2421222366        1
[INPUT] 0    0    [1    /1   ]  4.60587751719        1
[INPUT] 0    0    [1    /1   ]  0.390579079543       1
[INPUT] 1    0    [1    /1   ]  1362.77322619        1
[INPUT] 1    0    [1    /1   ]  652.731570581        1
[INPUT] 1    0    [1    /1   ]  238.959987429        1
[INPUT] 1    0    [1    /1   ]  259.722774255        1
[INPUT] 1    0    [1    /1   ]  785.393150136        1
[INPUT] 1    0    [1    /1   ]  19.48933687          1
[INPUT] 1    0    [1    /1   ]  88.6714132779        1
[INPUT] 1    0    [1    /1   ]  1.51020261102        1
[INPUT] 1    0    [1    /1   ]  5.59647044667        1
[INPUT] 1    0    [1    /1   ]  0.349334384734       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.50079045172, 1.0]], [0, [7585.42392315595, 1.0]], [0, [3552.9800278828366, 1.0]], [0, [600.3424257972376, 1.0]], [0, [137.8933842686103, 1.0]], [0, [39.242122236605006, 1.0]], [0, [4.605877517190658, 1.0]], [0, [0.39057907954349896, 1.0]], [1, [1362.7732261944398, 1.0]], [1, [652.7315705814659, 1.0]], [1, [238.95998742939085, 1.0]], [1, [259.72277425509407, 1.0]], [1, [785.3931501363577, 1.0]], [1, [19.489336870017077, 1.0]], [1, [88.67141327785589, 1.0]], [1, [1.510202611022708, 1.0]], [1, [5.596470446671586, 1.0]], [1, [0.34933438473413275, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.50079045]
bas 1, expnt(s) = [7585.42392316]
bas 2, expnt(s) = [3552.98002788]
bas 3, expnt(s) = [600.3424258]
bas 4, expnt(s) = [137.89338427]
bas 5, expnt(s) = [39.24212224]
bas 6, expnt(s) = [4.60587752]
bas 7, expnt(s) = [0.39057908]
bas 8, expnt(s) = [1362.77322619]
bas 9, expnt(s) = [652.73157058]
bas 10, expnt(s) = [238.95998743]
bas 11, expnt(s) = [259.72277426]
bas 12, expnt(s) = [785.39315014]
bas 13, expnt(s) = [19.48933687]
bas 14, expnt(s) = [88.67141328]
bas 15, expnt(s) = [1.51020261]
bas 16, expnt(s) = [5.59647045]
bas 17, expnt(s) = [0.34933438]
CPU time:       604.72
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61855008e+04 5.20068665e+03 7.58542392e+03 2.05352463e+03
 3.55298003e+03 1.16267839e+03 6.00342426e+02 3.06418019e+02
 1.37893384e+02 1.01665265e+02 3.92421222e+01 3.96122388e+01
 4.60587752e+00 7.94326978e+00 3.90579080e-01 1.24823615e+00
 1.36277323e+03 2.41553805e+04 6.52731571e+02 9.62504272e+03
 2.38959987e+02 2.74088539e+03 2.59722774e+02 3.04173891e+03
 7.85393150e+02 1.21295106e+04 1.94893369e+01 1.19462258e+02
 8.86714133e+01 7.93805184e+02 1.51020261e+00 4.88403102e+00
 5.59647045e+00 2.51117605e+01 3.49334385e-01 7.83494697e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.914774114002277
cond(S) = 131233.46489010708
E1 = -728.0344402872341  E_coul = 202.92970745203448
init E= -525.1047328352
    CPU time for initialize scf      0.13 sec, wall time      0.04 sec
  HOMO = -0.549921415116267  LUMO = 2.49929386083317
  mo_energy =
[-1.18266536e+02 -1.21037311e+01 -9.43769638e+00 -9.43769638e+00
 -9.43769638e+00 -1.24194982e+00 -5.49921415e-01 -5.49921415e-01
 -5.49921415e-01  2.49929386e+00  2.49929386e+00  2.49929386e+00
  2.19869218e+01  2.19869218e+01  2.19869218e+01  9.79656241e+01
  1.32592159e+02  1.32592159e+02  1.32592159e+02  4.72302781e+02
  4.72302781e+02  4.72302781e+02  8.49928357e+02  1.16174019e+03
  1.16174019e+03  1.16174019e+03  2.41656654e+03  2.41656654e+03
  2.41656654e+03  4.68829412e+03  4.68829412e+03  4.68829412e+03
  5.25642687e+03  8.85047550e+03  8.85047550e+03  8.85047550e+03
  2.05832907e+04  7.11284794e+04]
E1 = -728.3736767068049  E_coul = 202.29371810150323
cycle= 1 E= -526.079958605302  delta_E= -0.975  |g|= 0.188  |ddm|= 2.61
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.496057
diis-c [-0.24607224  1.        ]
  HOMO = -0.53118407672631  LUMO = 2.51314384226349
  mo_energy =
[-1.18488957e+02 -1.21429442e+01 -9.48137049e+00 -9.48137049e+00
 -9.48137049e+00 -1.22369552e+00 -5.31184077e-01 -5.31184077e-01
 -5.31184077e-01  2.51314384e+00  2.51314384e+00  2.51314384e+00
  2.19370439e+01  2.19370439e+01  2.19370439e+01  9.78425599e+01
  1.32444813e+02  1.32444813e+02  1.32444813e+02  4.72100647e+02
  4.72100647e+02  4.72100647e+02  8.49615734e+02  1.16149081e+03
  1.16149081e+03  1.16149081e+03  2.41626531e+03  2.41626531e+03
  2.41626531e+03  4.68793101e+03  4.68793101e+03  4.68793101e+03
  5.25590349e+03  8.85000426e+03  8.85000426e+03  8.85000426e+03
  2.05826423e+04  7.11277405e+04]
E1 = -728.4997203175212  E_coul = 202.41950993201198
cycle= 2 E= -526.080210385509  delta_E= -0.000252  |g|= 0.0164  |ddm|= 0.00968
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0285083
diis-c [-5.67761245e-04  3.06204498e-02  9.69379550e-01]
  HOMO = -0.530712068428953  LUMO = 2.51459471807227
  mo_energy =
[-1.18463658e+02 -1.21346889e+01 -9.47292818e+00 -9.47292818e+00
 -9.47292818e+00 -1.22301130e+00 -5.30712068e-01 -5.30712068e-01
 -5.30712068e-01  2.51459472e+00  2.51459472e+00  2.51459472e+00
  2.19457388e+01  2.19457388e+01  2.19457388e+01  9.78631016e+01
  1.32464449e+02  1.32464449e+02  1.32464449e+02  4.72125012e+02
  4.72125012e+02  4.72125012e+02  8.49643747e+02  1.16151737e+03
  1.16151737e+03  1.16151737e+03  2.41629332e+03  2.41629332e+03
  2.41629332e+03  4.68796002e+03  4.68796002e+03  4.68796002e+03
  5.25593342e+03  8.85003394e+03  8.85003394e+03  8.85003394e+03
  2.05826724e+04  7.11277706e+04]
E1 = -728.4733697129375  E_coul = 202.39315549900593
cycle= 3 E= -526.080214213932  delta_E= -3.83e-06  |g|= 0.00176  |ddm|= 0.00215
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00346826
diis-c [-1.69630615e-07 -8.80385722e-04  1.00218676e-01  9.00661710e-01]
  HOMO = -0.530956215326908  LUMO = 2.51414454021449
  mo_energy =
[-1.18466672e+02 -1.21361011e+01 -9.47439644e+00 -9.47439644e+00
 -9.47439644e+00 -1.22333430e+00 -5.30956215e-01 -5.30956215e-01
 -5.30956215e-01  2.51414454e+00  2.51414454e+00  2.51414454e+00
  2.19442810e+01  2.19442810e+01  2.19442810e+01  9.78606107e+01
  1.32461951e+02  1.32461951e+02  1.32461951e+02  4.72122097e+02
  4.72122097e+02  4.72122097e+02  8.49640450e+02  1.16151424e+03
  1.16151424e+03  1.16151424e+03  2.41629003e+03  2.41629003e+03
  2.41629003e+03  4.68795660e+03  4.68795660e+03  4.68795660e+03
  5.25592978e+03  8.85003038e+03  8.85003038e+03  8.85003038e+03
  2.05826687e+04  7.11277669e+04]
E1 = -728.4768167169595  E_coul = 202.39660243333398
cycle= 4 E= -526.080214283626  delta_E= -6.97e-08  |g|= 3.27e-05  |ddm|= 0.000314
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=4.29917e-05
diis-c [-4.48783815e-10  2.37415359e-06 -1.07176187e-03  1.81070634e-03
  9.99258681e-01]
  HOMO = -0.53094334924125  LUMO = 2.51416596491607
  mo_energy =
[-1.18466604e+02 -1.21360461e+01 -9.47434146e+00 -9.47434146e+00
 -9.47434146e+00 -1.22331700e+00 -5.30943349e-01 -5.30943349e-01
 -5.30943349e-01  2.51416596e+00  2.51416596e+00  2.51416596e+00
  2.19443329e+01  2.19443329e+01  2.19443329e+01  9.78606782e+01
  1.32462016e+02  1.32462016e+02  1.32462016e+02  4.72122164e+02
  4.72122164e+02  4.72122164e+02  8.49640514e+02  1.16151431e+03
  1.16151431e+03  1.16151431e+03  2.41629010e+03  2.41629010e+03
  2.41629010e+03  4.68795666e+03  4.68795666e+03  4.68795666e+03
  5.25592984e+03  8.85003044e+03  8.85003044e+03  8.85003044e+03
  2.05826687e+04  7.11277669e+04]
E1 = -728.476723692257  E_coul = 202.39650940859133
cycle= 5 E= -526.080214283666  delta_E= -4.01e-11  |g|= 3.33e-06  |ddm|= 1.03e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -728.476723692257  E_coul = 202.39650940859133
  HOMO = -0.530944366395625  LUMO = 2.51416422639704
  mo_energy =
[-1.18466611e+02 -1.21360508e+01 -9.47434628e+00 -9.47434628e+00
 -9.47434628e+00 -1.22331835e+00 -5.30944366e-01 -5.30944366e-01
 -5.30944366e-01  2.51416423e+00  2.51416423e+00  2.51416423e+00
  2.19443283e+01  2.19443283e+01  2.19443283e+01  9.78606716e+01
  1.32462009e+02  1.32462009e+02  1.32462009e+02  4.72122157e+02
  4.72122157e+02  4.72122157e+02  8.49640506e+02  1.16151430e+03
  1.16151430e+03  1.16151430e+03  2.41629009e+03  2.41629009e+03
  2.41629009e+03  4.68795666e+03  4.68795666e+03  4.68795666e+03
  5.25592983e+03  8.85003043e+03  8.85003043e+03  8.85003043e+03
  2.05826687e+04  7.11277669e+04]
E1 = -728.4767330478962  E_coul = 202.39651876423073
Extra cycle  E= -526.080214283666  delta_E= 1.14e-13  |g|= 6.63e-07  |ddm|= 9.46e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.18 sec
exp = [2.61855008e+04 7.58542392e+03 3.55298003e+03 6.00342426e+02
 1.37893384e+02 3.92421222e+01 4.60587752e+00 3.90579080e-01
 1.36277323e+03 6.52731571e+02 2.38959987e+02 2.59722774e+02
 7.85393150e+02 1.94893369e+01 8.86714133e+01 1.51020261e+00
 5.59647045e+00 3.49334385e-01]
E = -526.0802142836656
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.5007905        1
[INPUT] 0    0    [1    /1   ]  7585.42392316        1
[INPUT] 0    0    [1    /1   ]  3552.98002788        1
[INPUT] 0    0    [1    /1   ]  600.342425797        1
[INPUT] 0    0    [1    /1   ]  137.893384269        1
[INPUT] 0    0    [1    /1   ]  39.2421222366        1
[INPUT] 0    0    [1    /1   ]  4.60587751719        1
[INPUT] 0    0    [1    /1   ]  0.390579079543       1
[INPUT] 1    0    [1    /1   ]  1362.77322619        1
[INPUT] 1    0    [1    /1   ]  652.731570581        1
[INPUT] 1    0    [1    /1   ]  238.959987429        1
[INPUT] 1    0    [1    /1   ]  259.722774255        1
[INPUT] 1    0    [1    /1   ]  785.393150136        1
[INPUT] 1    0    [1    /1   ]  19.48933687          1
[INPUT] 1    0    [1    /1   ]  88.6714132779        1
[INPUT] 1    0    [1    /1   ]  1.51020261102        1
[INPUT] 1    0    [1    /1   ]  5.59647044667        1
[INPUT] 1    0    [1    /1   ]  0.349334384734       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.50079045172, 1.0]], [0, [7585.42392315595, 1.0]], [0, [3552.9800278828366, 1.0]], [0, [600.3424257972376, 1.0]], [0, [137.8933842686103, 1.0]], [0, [39.242122236605006, 1.0]], [0, [4.605877517190658, 1.0]], [0, [0.39057907954349896, 1.0]], [1, [1362.7732261944398, 1.0]], [1, [652.7315705814659, 1.0]], [1, [238.95998742939085, 1.0]], [1, [259.72277425509407, 1.0]], [1, [785.3931501363577, 1.0]], [1, [19.489336870017077, 1.0]], [1, [88.67141327785589, 1.0]], [1, [1.510202611022708, 1.0]], [1, [5.596470446671586, 1.0]], [1, [0.34933438473413275, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.50079045]
bas 1, expnt(s) = [7585.42392316]
bas 2, expnt(s) = [3552.98002788]
bas 3, expnt(s) = [600.3424258]
bas 4, expnt(s) = [137.89338427]
bas 5, expnt(s) = [39.24212224]
bas 6, expnt(s) = [4.60587752]
bas 7, expnt(s) = [0.39057908]
bas 8, expnt(s) = [1362.77322619]
bas 9, expnt(s) = [652.73157058]
bas 10, expnt(s) = [238.95998743]
bas 11, expnt(s) = [259.72277426]
bas 12, expnt(s) = [785.39315014]
bas 13, expnt(s) = [19.48933687]
bas 14, expnt(s) = [88.67141328]
bas 15, expnt(s) = [1.51020261]
bas 16, expnt(s) = [5.59647045]
bas 17, expnt(s) = [0.34933438]
CPU time:       605.30
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61855008e+04 5.20068665e+03 7.58542392e+03 2.05352463e+03
 3.55298003e+03 1.16267839e+03 6.00342426e+02 3.06418019e+02
 1.37893384e+02 1.01665265e+02 3.92421222e+01 3.96122388e+01
 4.60587752e+00 7.94326978e+00 3.90579080e-01 1.24823615e+00
 1.36277323e+03 2.41553805e+04 6.52731571e+02 9.62504272e+03
 2.38959987e+02 2.74088539e+03 2.59722774e+02 3.04173891e+03
 7.85393150e+02 1.21295106e+04 1.94893369e+01 1.19462258e+02
 8.86714133e+01 7.93805184e+02 1.51020261e+00 4.88403102e+00
 5.59647045e+00 2.51117605e+01 3.49334385e-01 7.83494697e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.914774114002277
cond(S) = 131233.46489010708
E1 = -728.0344402872341  E_coul = 202.92970745203448
init E= -525.1047328352
    CPU time for initialize scf      0.15 sec, wall time      0.04 sec
  HOMO = -0.549921415116267  LUMO = 2.49929386083317
  mo_energy =
[-1.18266536e+02 -1.21037311e+01 -9.43769638e+00 -9.43769638e+00
 -9.43769638e+00 -1.24194982e+00 -5.49921415e-01 -5.49921415e-01
 -5.49921415e-01  2.49929386e+00  2.49929386e+00  2.49929386e+00
  2.19869218e+01  2.19869218e+01  2.19869218e+01  9.79656241e+01
  1.32592159e+02  1.32592159e+02  1.32592159e+02  4.72302781e+02
  4.72302781e+02  4.72302781e+02  8.49928357e+02  1.16174019e+03
  1.16174019e+03  1.16174019e+03  2.41656654e+03  2.41656654e+03
  2.41656654e+03  4.68829412e+03  4.68829412e+03  4.68829412e+03
  5.25642687e+03  8.85047550e+03  8.85047550e+03  8.85047550e+03
  2.05832907e+04  7.11284794e+04]
E1 = -728.3736767068049  E_coul = 202.29371810150323
cycle= 1 E= -526.079958605302  delta_E= -0.975  |g|= 0.188  |ddm|= 2.61
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.496057
diis-c [-0.24607224  1.        ]
  HOMO = -0.53118407672631  LUMO = 2.51314384226349
  mo_energy =
[-1.18488957e+02 -1.21429442e+01 -9.48137049e+00 -9.48137049e+00
 -9.48137049e+00 -1.22369552e+00 -5.31184077e-01 -5.31184077e-01
 -5.31184077e-01  2.51314384e+00  2.51314384e+00  2.51314384e+00
  2.19370439e+01  2.19370439e+01  2.19370439e+01  9.78425599e+01
  1.32444813e+02  1.32444813e+02  1.32444813e+02  4.72100647e+02
  4.72100647e+02  4.72100647e+02  8.49615734e+02  1.16149081e+03
  1.16149081e+03  1.16149081e+03  2.41626531e+03  2.41626531e+03
  2.41626531e+03  4.68793101e+03  4.68793101e+03  4.68793101e+03
  5.25590349e+03  8.85000426e+03  8.85000426e+03  8.85000426e+03
  2.05826423e+04  7.11277405e+04]
E1 = -728.4997203175212  E_coul = 202.41950993201198
cycle= 2 E= -526.080210385509  delta_E= -0.000252  |g|= 0.0164  |ddm|= 0.00968
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0285083
diis-c [-5.67761245e-04  3.06204498e-02  9.69379550e-01]
  HOMO = -0.530712068428953  LUMO = 2.51459471807227
  mo_energy =
[-1.18463658e+02 -1.21346889e+01 -9.47292818e+00 -9.47292818e+00
 -9.47292818e+00 -1.22301130e+00 -5.30712068e-01 -5.30712068e-01
 -5.30712068e-01  2.51459472e+00  2.51459472e+00  2.51459472e+00
  2.19457388e+01  2.19457388e+01  2.19457388e+01  9.78631016e+01
  1.32464449e+02  1.32464449e+02  1.32464449e+02  4.72125012e+02
  4.72125012e+02  4.72125012e+02  8.49643747e+02  1.16151737e+03
  1.16151737e+03  1.16151737e+03  2.41629332e+03  2.41629332e+03
  2.41629332e+03  4.68796002e+03  4.68796002e+03  4.68796002e+03
  5.25593342e+03  8.85003394e+03  8.85003394e+03  8.85003394e+03
  2.05826724e+04  7.11277706e+04]
E1 = -728.4733697129375  E_coul = 202.39315549900593
cycle= 3 E= -526.080214213932  delta_E= -3.83e-06  |g|= 0.00176  |ddm|= 0.00215
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00346826
diis-c [-1.69630615e-07 -8.80385722e-04  1.00218676e-01  9.00661710e-01]
  HOMO = -0.530956215326908  LUMO = 2.51414454021449
  mo_energy =
[-1.18466672e+02 -1.21361011e+01 -9.47439644e+00 -9.47439644e+00
 -9.47439644e+00 -1.22333430e+00 -5.30956215e-01 -5.30956215e-01
 -5.30956215e-01  2.51414454e+00  2.51414454e+00  2.51414454e+00
  2.19442810e+01  2.19442810e+01  2.19442810e+01  9.78606107e+01
  1.32461951e+02  1.32461951e+02  1.32461951e+02  4.72122097e+02
  4.72122097e+02  4.72122097e+02  8.49640450e+02  1.16151424e+03
  1.16151424e+03  1.16151424e+03  2.41629003e+03  2.41629003e+03
  2.41629003e+03  4.68795660e+03  4.68795660e+03  4.68795660e+03
  5.25592978e+03  8.85003038e+03  8.85003038e+03  8.85003038e+03
  2.05826687e+04  7.11277669e+04]
E1 = -728.4768167169595  E_coul = 202.39660243333398
cycle= 4 E= -526.080214283626  delta_E= -6.97e-08  |g|= 3.27e-05  |ddm|= 0.000314
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=4.29917e-05
diis-c [-4.48783815e-10  2.37415359e-06 -1.07176187e-03  1.81070634e-03
  9.99258681e-01]
  HOMO = -0.53094334924125  LUMO = 2.51416596491607
  mo_energy =
[-1.18466604e+02 -1.21360461e+01 -9.47434146e+00 -9.47434146e+00
 -9.47434146e+00 -1.22331700e+00 -5.30943349e-01 -5.30943349e-01
 -5.30943349e-01  2.51416596e+00  2.51416596e+00  2.51416596e+00
  2.19443329e+01  2.19443329e+01  2.19443329e+01  9.78606782e+01
  1.32462016e+02  1.32462016e+02  1.32462016e+02  4.72122164e+02
  4.72122164e+02  4.72122164e+02  8.49640514e+02  1.16151431e+03
  1.16151431e+03  1.16151431e+03  2.41629010e+03  2.41629010e+03
  2.41629010e+03  4.68795666e+03  4.68795666e+03  4.68795666e+03
  5.25592984e+03  8.85003044e+03  8.85003044e+03  8.85003044e+03
  2.05826687e+04  7.11277669e+04]
E1 = -728.476723692257  E_coul = 202.39650940859133
cycle= 5 E= -526.080214283666  delta_E= -4.01e-11  |g|= 3.33e-06  |ddm|= 1.03e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -728.476723692257  E_coul = 202.39650940859133
  HOMO = -0.530944366395625  LUMO = 2.51416422639704
  mo_energy =
[-1.18466611e+02 -1.21360508e+01 -9.47434628e+00 -9.47434628e+00
 -9.47434628e+00 -1.22331835e+00 -5.30944366e-01 -5.30944366e-01
 -5.30944366e-01  2.51416423e+00  2.51416423e+00  2.51416423e+00
  2.19443283e+01  2.19443283e+01  2.19443283e+01  9.78606716e+01
  1.32462009e+02  1.32462009e+02  1.32462009e+02  4.72122157e+02
  4.72122157e+02  4.72122157e+02  8.49640506e+02  1.16151430e+03
  1.16151430e+03  1.16151430e+03  2.41629009e+03  2.41629009e+03
  2.41629009e+03  4.68795666e+03  4.68795666e+03  4.68795666e+03
  5.25592983e+03  8.85003043e+03  8.85003043e+03  8.85003043e+03
  2.05826687e+04  7.11277669e+04]
E1 = -728.4767330478962  E_coul = 202.39651876423073
Extra cycle  E= -526.080214283666  delta_E= 1.14e-13  |g|= 6.63e-07  |ddm|= 9.46e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.19 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 131233.46489010708
E1 = -728.4767330478962  E_coul = 202.39651876423073
init E= -526.080214283666
    CPU time for initialize scf      0.95 sec, wall time      0.18 sec
  HOMO = -0.530944240775227  LUMO = 2.51416445305014
  mo_energy =
[-1.18466610e+02 -1.21360501e+01 -9.47434557e+00 -9.47434557e+00
 -9.47434557e+00 -1.22331818e+00 -5.30944241e-01 -5.30944241e-01
 -5.30944241e-01  2.51416445e+00  2.51416445e+00  2.51416445e+00
  2.19443290e+01  2.19443290e+01  2.19443290e+01  9.78606727e+01
  1.32462010e+02  1.32462010e+02  1.32462010e+02  4.72122158e+02
  4.72122158e+02  4.72122158e+02  8.49640508e+02  1.16151431e+03
  1.16151431e+03  1.16151431e+03  2.41629009e+03  2.41629009e+03
  2.41629009e+03  4.68795666e+03  4.68795666e+03  4.68795666e+03
  5.25592984e+03  8.85003043e+03  8.85003043e+03  8.85003043e+03
  2.05826687e+04  7.11277669e+04]
E1 = -728.4767314864783  E_coul = 202.3965172028127
cycle= 1 E= -526.080214283666  delta_E= -1.14e-13  |g|= 1.18e-07  |ddm|= 1.47e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.4767314864783  E_coul = 202.3965172028127
  HOMO = -0.530944260538707  LUMO = 2.51416441681728
  mo_energy =
[-1.18466610e+02 -1.21360502e+01 -9.47434569e+00 -9.47434569e+00
 -9.47434569e+00 -1.22331821e+00 -5.30944261e-01 -5.30944261e-01
 -5.30944261e-01  2.51416442e+00  2.51416442e+00  2.51416442e+00
  2.19443289e+01  2.19443289e+01  2.19443289e+01  9.78606725e+01
  1.32462010e+02  1.32462010e+02  1.32462010e+02  4.72122158e+02
  4.72122158e+02  4.72122158e+02  8.49640507e+02  1.16151431e+03
  1.16151431e+03  1.16151431e+03  2.41629009e+03  2.41629009e+03
  2.41629009e+03  4.68795666e+03  4.68795666e+03  4.68795666e+03
  5.25592983e+03  8.85003043e+03  8.85003043e+03  8.85003043e+03
  2.05826687e+04  7.11277669e+04]
E1 = -728.4767317539007  E_coul = 202.39651747023552
Extra cycle  E= -526.080214283665  delta_E= 4.55e-13  |g|= 2.05e-08  |ddm|= 2.47e-08
    CPU time for scf_cycle      1.06 sec, wall time      0.29 sec
exp = [2.61855008e+04 7.58542392e+03 3.55298003e+03 6.00342426e+02
 1.37893384e+02 3.92421222e+01 4.60587752e+00 3.90579080e-01
 1.36277323e+03 6.52731571e+02 2.38959987e+02 2.59722774e+02
 7.85393150e+02 1.94893369e+01 8.86714133e+01 1.51020261e+00
 5.59647045e+00 3.49334385e-01]
grad_E = [ 4.49903806e-07  1.03874170e-06  5.45506260e-05  5.02213643e-04
 -3.40792740e-03  9.23832084e-04 -3.12859073e-03 -2.99458091e-02
  3.11678769e-06  1.99987396e-05  1.89080567e-04  1.64121193e-04
  1.37857181e-05 -1.26692160e-02  3.79307071e-03  9.43941464e-02
 -3.32520576e-03 -2.29755128e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.4994987        1
[INPUT] 0    0    [1    /1   ]  7585.43758443        1
[INPUT] 0    0    [1    /1   ]  3553.00660838        1
[INPUT] 0    0    [1    /1   ]  600.758941184        1
[INPUT] 0    0    [1    /1   ]  138.343122476        1
[INPUT] 0    0    [1    /1   ]  39.3681371404        1
[INPUT] 0    0    [1    /1   ]  4.60650677184        1
[INPUT] 0    0    [1    /1   ]  0.391770952167       1
[INPUT] 1    0    [1    /1   ]  1362.77177482        1
[INPUT] 1    0    [1    /1   ]  652.724750502        1
[INPUT] 1    0    [1    /1   ]  238.918388981        1
[INPUT] 1    0    [1    /1   ]  259.685819934        1
[INPUT] 1    0    [1    /1   ]  786.640569134        1
[INPUT] 1    0    [1    /1   ]  19.6494898405        1
[INPUT] 1    0    [1    /1   ]  88.604251715         1
[INPUT] 1    0    [1    /1   ]  1.46792066363        1
[INPUT] 1    0    [1    /1   ]  5.623131682          1
[INPUT] 1    0    [1    /1   ]  0.343671992546       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.499498670113, 1.0]], [0, [7585.437584432638, 1.0]], [0, [3553.0066083752868, 1.0]], [0, [600.7589411839466, 1.0]], [0, [138.34312247559967, 1.0]], [0, [39.36813714042963, 1.0]], [0, [4.606506771844707, 1.0]], [0, [0.39177095216720126, 1.0]], [1, [1362.7717748169755, 1.0]], [1, [652.7247505015918, 1.0]], [1, [238.9183889808451, 1.0]], [1, [259.6858199339594, 1.0]], [1, [786.6405691338229, 1.0]], [1, [19.649489840548558, 1.0]], [1, [88.60425171501639, 1.0]], [1, [1.4679206636253552, 1.0]], [1, [5.62313168200058, 1.0]], [1, [0.3436719925458728, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.49949867]
bas 1, expnt(s) = [7585.43758443]
bas 2, expnt(s) = [3553.00660838]
bas 3, expnt(s) = [600.75894118]
bas 4, expnt(s) = [138.34312248]
bas 5, expnt(s) = [39.36813714]
bas 6, expnt(s) = [4.60650677]
bas 7, expnt(s) = [0.39177095]
bas 8, expnt(s) = [1362.77177482]
bas 9, expnt(s) = [652.7247505]
bas 10, expnt(s) = [238.91838898]
bas 11, expnt(s) = [259.68581993]
bas 12, expnt(s) = [786.64056913]
bas 13, expnt(s) = [19.64948984]
bas 14, expnt(s) = [88.60425172]
bas 15, expnt(s) = [1.46792066]
bas 16, expnt(s) = [5.62313168]
bas 17, expnt(s) = [0.34367199]
CPU time:       611.26
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61854995e+04 5.20068645e+03 7.58543758e+03 2.05352741e+03
 3.55300661e+03 1.16268491e+03 6.00758941e+02 3.06577449e+02
 1.38343122e+02 1.01913849e+02 3.93681371e+01 3.97076032e+01
 4.60650677e+00 7.94408367e+00 3.91770952e-01 1.25109186e+00
 1.36277177e+03 2.41553484e+04 6.52724751e+02 9.62491701e+03
 2.38918389e+02 2.74028898e+03 2.59685820e+02 3.04119794e+03
 7.86640569e+02 1.21535966e+04 1.96494898e+01 1.20690613e+02
 8.86042517e+01 7.93053699e+02 1.46792066e+00 4.71370742e+00
 5.62313168e+00 2.52613880e+01 3.43671993e-01 7.67652323e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.918635842623246
cond(S) = 130472.2967640248
E1 = -728.07010537423  E_coul = 202.9559712514468
init E= -525.114134122783
    CPU time for initialize scf      0.71 sec, wall time      0.08 sec
  HOMO = -0.550729489186529  LUMO = 2.41471074646682
  mo_energy =
[-1.18264229e+02 -1.21019290e+01 -9.43486346e+00 -9.43486346e+00
 -9.43486346e+00 -1.24163771e+00 -5.50729489e-01 -5.50729489e-01
 -5.50729489e-01  2.41471075e+00  2.41471075e+00  2.41471075e+00
  2.19783979e+01  2.19783979e+01  2.19783979e+01  9.84684656e+01
  1.32985909e+02  1.32985909e+02  1.32985909e+02  4.72684226e+02
  4.72684226e+02  4.72684226e+02  8.52037097e+02  1.16208548e+03
  1.16208548e+03  1.16208548e+03  2.41717186e+03  2.41717186e+03
  2.41717186e+03  4.68997508e+03  4.68997508e+03  4.68997508e+03
  5.25971273e+03  8.85389993e+03  8.85389993e+03  8.85389993e+03
  2.05867546e+04  7.11318270e+04]
E1 = -728.3563643633781  E_coul = 202.2708963914993
cycle= 1 E= -526.085467971879  delta_E= -0.971  |g|= 0.186  |ddm|= 2.51
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.490266
diis-c [-0.24036086  1.        ]
  HOMO = -0.534555230178627  LUMO = 2.42575361108312
  mo_energy =
[-1.18485650e+02 -1.21448915e+01 -9.48220527e+00 -9.48220527e+00
 -9.48220527e+00 -1.22659602e+00 -5.34555230e-01 -5.34555230e-01
 -5.34555230e-01  2.42575361e+00  2.42575361e+00  2.42575361e+00
  2.19246486e+01  2.19246486e+01  2.19246486e+01  9.83444470e+01
  1.32837969e+02  1.32837969e+02  1.32837969e+02  4.72482878e+02
  4.72482878e+02  4.72482878e+02  8.51726319e+02  1.16183755e+03
  1.16183755e+03  1.16183755e+03  2.41687257e+03  2.41687257e+03
  2.41687257e+03  4.68961433e+03  4.68961433e+03  4.68961433e+03
  5.25919246e+03  8.85343153e+03  8.85343153e+03  8.85343153e+03
  2.05861096e+04  7.11310917e+04]
E1 = -728.4840279077682  E_coul = 202.39832108970663
cycle= 2 E= -526.085706818062  delta_E= -0.000239  |g|= 0.0161  |ddm|= 0.00941
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0278349
diis-c [-5.53834344e-04  2.94597872e-02  9.70540213e-01]
  HOMO = -0.533991766004528  LUMO = 2.42728373246311
  mo_energy =
[-1.18460547e+02 -1.21364689e+01 -9.47359785e+00 -9.47359785e+00
 -9.47359785e+00 -1.22578797e+00 -5.33991766e-01 -5.33991766e-01
 -5.33991766e-01  2.42728373e+00  2.42728373e+00  2.42728373e+00
  2.19335374e+01  2.19335374e+01  2.19335374e+01  9.83649341e+01
  1.32857535e+02  1.32857535e+02  1.32857535e+02  4.72507066e+02
  4.72507066e+02  4.72507066e+02  8.51754062e+02  1.16186389e+03
  1.16186389e+03  1.16186389e+03  2.41690030e+03  2.41690030e+03
  2.41690030e+03  4.68964305e+03  4.68964305e+03  4.68964305e+03
  5.25922202e+03  8.85346087e+03  8.85346087e+03  8.85346087e+03
  2.05861394e+04  7.11311214e+04]
E1 = -728.4575016171577  E_coul = 202.3717910425459
cycle= 3 E= -526.085710574612  delta_E= -3.76e-06  |g|= 0.00177  |ddm|= 0.00218
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00346356
diis-c [-1.70302893e-07 -8.84706118e-04  1.02491955e-01  8.98392751e-01]
  HOMO = -0.53424077463882  LUMO = 2.42683675405368
  mo_energy =
[-1.18463578e+02 -1.21378957e+01 -9.47508038e+00 -9.47508038e+00
 -9.47508038e+00 -1.22611800e+00 -5.34240775e-01 -5.34240775e-01
 -5.34240775e-01  2.42683675e+00  2.42683675e+00  2.42683675e+00
  2.19320583e+01  2.19320583e+01  2.19320583e+01  9.83624219e+01
  1.32855019e+02  1.32855019e+02  1.32855019e+02  4.72504133e+02
  4.72504133e+02  4.72504133e+02  8.51750748e+02  1.16186074e+03
  1.16186074e+03  1.16186074e+03  2.41689700e+03  2.41689700e+03
  2.41689700e+03  4.68963961e+03  4.68963961e+03  4.68963961e+03
  5.25921838e+03  8.85345729e+03  8.85345729e+03  8.85345729e+03
  2.05861356e+04  7.11311176e+04]
E1 = -728.4610435253155  E_coul = 202.37533287886876
cycle= 4 E= -526.085710646447  delta_E= -7.18e-08  |g|= 3.27e-05  |ddm|= 0.000323
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=4.27573e-05
diis-c [-4.59861997e-10  2.07452813e-06 -1.07558077e-03  1.89962825e-03
  9.99173878e-01]
  HOMO = -0.534227376939733  LUMO = 2.42685841524043
  mo_energy =
[-1.18463510e+02 -1.21378397e+01 -9.47502433e+00 -9.47502433e+00
 -9.47502433e+00 -1.22609997e+00 -5.34227377e-01 -5.34227377e-01
 -5.34227377e-01  2.42685842e+00  2.42685842e+00  2.42685842e+00
  2.19321112e+01  2.19321112e+01  2.19321112e+01  9.83624902e+01
  1.32855084e+02  1.32855084e+02  1.32855084e+02  4.72504201e+02
  4.72504201e+02  4.72504201e+02  8.51750813e+02  1.16186081e+03
  1.16186081e+03  1.16186081e+03  2.41689706e+03  2.41689706e+03
  2.41689706e+03  4.68963967e+03  4.68963967e+03  4.68963967e+03
  5.25921844e+03  8.85345735e+03  8.85345735e+03  8.85345735e+03
  2.05861357e+04  7.11311177e+04]
E1 = -728.4609461398187  E_coul = 202.37523549332857
cycle= 5 E= -526.08571064649  delta_E= -4.34e-11  |g|= 3.49e-06  |ddm|= 1.09e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -728.4609461398187  E_coul = 202.37523549332857
  HOMO = -0.534228470109371  LUMO = 2.42685659415604
  mo_energy =
[-1.18463518e+02 -1.21378447e+01 -9.47502943e+00 -9.47502943e+00
 -9.47502943e+00 -1.22610143e+00 -5.34228470e-01 -5.34228470e-01
 -5.34228470e-01  2.42685659e+00  2.42685659e+00  2.42685659e+00
  2.19321063e+01  2.19321063e+01  2.19321063e+01  9.83624832e+01
  1.32855077e+02  1.32855077e+02  1.32855077e+02  4.72504193e+02
  4.72504193e+02  4.72504193e+02  8.51750805e+02  1.16186080e+03
  1.16186080e+03  1.16186080e+03  2.41689705e+03  2.41689705e+03
  2.41689705e+03  4.68963967e+03  4.68963967e+03  4.68963967e+03
  5.25921843e+03  8.85345734e+03  8.85345734e+03  8.85345734e+03
  2.05861357e+04  7.11311177e+04]
E1 = -728.4609562886361  E_coul = 202.37524564214544
Extra cycle  E= -526.085710646491  delta_E= -5.68e-13  |g|= 7.04e-07  |ddm|= 1.03e-06
    CPU time for scf_cycle      0.85 sec, wall time      0.23 sec
exp = [2.61854995e+04 7.58543758e+03 3.55300661e+03 6.00758941e+02
 1.38343122e+02 3.93681371e+01 4.60650677e+00 3.91770952e-01
 1.36277177e+03 6.52724751e+02 2.38918389e+02 2.59685820e+02
 7.86640569e+02 1.96494898e+01 8.86042517e+01 1.46792066e+00
 5.62313168e+00 3.43671993e-01]
E = -526.0857106464907
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.4994987        1
[INPUT] 0    0    [1    /1   ]  7585.43758443        1
[INPUT] 0    0    [1    /1   ]  3553.00660838        1
[INPUT] 0    0    [1    /1   ]  600.758941184        1
[INPUT] 0    0    [1    /1   ]  138.343122476        1
[INPUT] 0    0    [1    /1   ]  39.3681371404        1
[INPUT] 0    0    [1    /1   ]  4.60650677184        1
[INPUT] 0    0    [1    /1   ]  0.391770952167       1
[INPUT] 1    0    [1    /1   ]  1362.77177482        1
[INPUT] 1    0    [1    /1   ]  652.724750502        1
[INPUT] 1    0    [1    /1   ]  238.918388981        1
[INPUT] 1    0    [1    /1   ]  259.685819934        1
[INPUT] 1    0    [1    /1   ]  786.640569134        1
[INPUT] 1    0    [1    /1   ]  19.6494898405        1
[INPUT] 1    0    [1    /1   ]  88.604251715         1
[INPUT] 1    0    [1    /1   ]  1.46792066363        1
[INPUT] 1    0    [1    /1   ]  5.623131682          1
[INPUT] 1    0    [1    /1   ]  0.343671992546       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.499498670113, 1.0]], [0, [7585.437584432638, 1.0]], [0, [3553.0066083752868, 1.0]], [0, [600.7589411839466, 1.0]], [0, [138.34312247559967, 1.0]], [0, [39.36813714042963, 1.0]], [0, [4.606506771844707, 1.0]], [0, [0.39177095216720126, 1.0]], [1, [1362.7717748169755, 1.0]], [1, [652.7247505015918, 1.0]], [1, [238.9183889808451, 1.0]], [1, [259.6858199339594, 1.0]], [1, [786.6405691338229, 1.0]], [1, [19.649489840548558, 1.0]], [1, [88.60425171501639, 1.0]], [1, [1.4679206636253552, 1.0]], [1, [5.62313168200058, 1.0]], [1, [0.3436719925458728, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.49949867]
bas 1, expnt(s) = [7585.43758443]
bas 2, expnt(s) = [3553.00660838]
bas 3, expnt(s) = [600.75894118]
bas 4, expnt(s) = [138.34312248]
bas 5, expnt(s) = [39.36813714]
bas 6, expnt(s) = [4.60650677]
bas 7, expnt(s) = [0.39177095]
bas 8, expnt(s) = [1362.77177482]
bas 9, expnt(s) = [652.7247505]
bas 10, expnt(s) = [238.91838898]
bas 11, expnt(s) = [259.68581993]
bas 12, expnt(s) = [786.64056913]
bas 13, expnt(s) = [19.64948984]
bas 14, expnt(s) = [88.60425172]
bas 15, expnt(s) = [1.46792066]
bas 16, expnt(s) = [5.62313168]
bas 17, expnt(s) = [0.34367199]
CPU time:       612.41
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61854995e+04 5.20068645e+03 7.58543758e+03 2.05352741e+03
 3.55300661e+03 1.16268491e+03 6.00758941e+02 3.06577449e+02
 1.38343122e+02 1.01913849e+02 3.93681371e+01 3.97076032e+01
 4.60650677e+00 7.94408367e+00 3.91770952e-01 1.25109186e+00
 1.36277177e+03 2.41553484e+04 6.52724751e+02 9.62491701e+03
 2.38918389e+02 2.74028898e+03 2.59685820e+02 3.04119794e+03
 7.86640569e+02 1.21535966e+04 1.96494898e+01 1.20690613e+02
 8.86042517e+01 7.93053699e+02 1.46792066e+00 4.71370742e+00
 5.62313168e+00 2.52613880e+01 3.43671993e-01 7.67652323e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.918635842623246
cond(S) = 130472.2967640248
E1 = -728.07010537423  E_coul = 202.9559712514468
init E= -525.114134122783
    CPU time for initialize scf      0.47 sec, wall time      0.06 sec
  HOMO = -0.550729489186529  LUMO = 2.41471074646682
  mo_energy =
[-1.18264229e+02 -1.21019290e+01 -9.43486346e+00 -9.43486346e+00
 -9.43486346e+00 -1.24163771e+00 -5.50729489e-01 -5.50729489e-01
 -5.50729489e-01  2.41471075e+00  2.41471075e+00  2.41471075e+00
  2.19783979e+01  2.19783979e+01  2.19783979e+01  9.84684656e+01
  1.32985909e+02  1.32985909e+02  1.32985909e+02  4.72684226e+02
  4.72684226e+02  4.72684226e+02  8.52037097e+02  1.16208548e+03
  1.16208548e+03  1.16208548e+03  2.41717186e+03  2.41717186e+03
  2.41717186e+03  4.68997508e+03  4.68997508e+03  4.68997508e+03
  5.25971273e+03  8.85389993e+03  8.85389993e+03  8.85389993e+03
  2.05867546e+04  7.11318270e+04]
E1 = -728.3563643633781  E_coul = 202.2708963914993
cycle= 1 E= -526.085467971879  delta_E= -0.971  |g|= 0.186  |ddm|= 2.51
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.490266
diis-c [-0.24036086  1.        ]
  HOMO = -0.534555230178627  LUMO = 2.42575361108312
  mo_energy =
[-1.18485650e+02 -1.21448915e+01 -9.48220527e+00 -9.48220527e+00
 -9.48220527e+00 -1.22659602e+00 -5.34555230e-01 -5.34555230e-01
 -5.34555230e-01  2.42575361e+00  2.42575361e+00  2.42575361e+00
  2.19246486e+01  2.19246486e+01  2.19246486e+01  9.83444470e+01
  1.32837969e+02  1.32837969e+02  1.32837969e+02  4.72482878e+02
  4.72482878e+02  4.72482878e+02  8.51726319e+02  1.16183755e+03
  1.16183755e+03  1.16183755e+03  2.41687257e+03  2.41687257e+03
  2.41687257e+03  4.68961433e+03  4.68961433e+03  4.68961433e+03
  5.25919246e+03  8.85343153e+03  8.85343153e+03  8.85343153e+03
  2.05861096e+04  7.11310917e+04]
E1 = -728.4840279077682  E_coul = 202.39832108970663
cycle= 2 E= -526.085706818062  delta_E= -0.000239  |g|= 0.0161  |ddm|= 0.00941
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0278349
diis-c [-5.53834344e-04  2.94597872e-02  9.70540213e-01]
  HOMO = -0.533991766004528  LUMO = 2.42728373246311
  mo_energy =
[-1.18460547e+02 -1.21364689e+01 -9.47359785e+00 -9.47359785e+00
 -9.47359785e+00 -1.22578797e+00 -5.33991766e-01 -5.33991766e-01
 -5.33991766e-01  2.42728373e+00  2.42728373e+00  2.42728373e+00
  2.19335374e+01  2.19335374e+01  2.19335374e+01  9.83649341e+01
  1.32857535e+02  1.32857535e+02  1.32857535e+02  4.72507066e+02
  4.72507066e+02  4.72507066e+02  8.51754062e+02  1.16186389e+03
  1.16186389e+03  1.16186389e+03  2.41690030e+03  2.41690030e+03
  2.41690030e+03  4.68964305e+03  4.68964305e+03  4.68964305e+03
  5.25922202e+03  8.85346087e+03  8.85346087e+03  8.85346087e+03
  2.05861394e+04  7.11311214e+04]
E1 = -728.4575016171577  E_coul = 202.3717910425459
cycle= 3 E= -526.085710574612  delta_E= -3.76e-06  |g|= 0.00177  |ddm|= 0.00218
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00346356
diis-c [-1.70302893e-07 -8.84706118e-04  1.02491955e-01  8.98392751e-01]
  HOMO = -0.53424077463882  LUMO = 2.42683675405368
  mo_energy =
[-1.18463578e+02 -1.21378957e+01 -9.47508038e+00 -9.47508038e+00
 -9.47508038e+00 -1.22611800e+00 -5.34240775e-01 -5.34240775e-01
 -5.34240775e-01  2.42683675e+00  2.42683675e+00  2.42683675e+00
  2.19320583e+01  2.19320583e+01  2.19320583e+01  9.83624219e+01
  1.32855019e+02  1.32855019e+02  1.32855019e+02  4.72504133e+02
  4.72504133e+02  4.72504133e+02  8.51750748e+02  1.16186074e+03
  1.16186074e+03  1.16186074e+03  2.41689700e+03  2.41689700e+03
  2.41689700e+03  4.68963961e+03  4.68963961e+03  4.68963961e+03
  5.25921838e+03  8.85345729e+03  8.85345729e+03  8.85345729e+03
  2.05861356e+04  7.11311176e+04]
E1 = -728.4610435253155  E_coul = 202.37533287886876
cycle= 4 E= -526.085710646447  delta_E= -7.18e-08  |g|= 3.27e-05  |ddm|= 0.000323
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=4.27573e-05
diis-c [-4.59861997e-10  2.07452813e-06 -1.07558077e-03  1.89962825e-03
  9.99173878e-01]
  HOMO = -0.534227376939733  LUMO = 2.42685841524043
  mo_energy =
[-1.18463510e+02 -1.21378397e+01 -9.47502433e+00 -9.47502433e+00
 -9.47502433e+00 -1.22609997e+00 -5.34227377e-01 -5.34227377e-01
 -5.34227377e-01  2.42685842e+00  2.42685842e+00  2.42685842e+00
  2.19321112e+01  2.19321112e+01  2.19321112e+01  9.83624902e+01
  1.32855084e+02  1.32855084e+02  1.32855084e+02  4.72504201e+02
  4.72504201e+02  4.72504201e+02  8.51750813e+02  1.16186081e+03
  1.16186081e+03  1.16186081e+03  2.41689706e+03  2.41689706e+03
  2.41689706e+03  4.68963967e+03  4.68963967e+03  4.68963967e+03
  5.25921844e+03  8.85345735e+03  8.85345735e+03  8.85345735e+03
  2.05861357e+04  7.11311177e+04]
E1 = -728.4609461398187  E_coul = 202.37523549332857
cycle= 5 E= -526.08571064649  delta_E= -4.34e-11  |g|= 3.49e-06  |ddm|= 1.09e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -728.4609461398187  E_coul = 202.37523549332857
  HOMO = -0.534228470109371  LUMO = 2.42685659415604
  mo_energy =
[-1.18463518e+02 -1.21378447e+01 -9.47502943e+00 -9.47502943e+00
 -9.47502943e+00 -1.22610143e+00 -5.34228470e-01 -5.34228470e-01
 -5.34228470e-01  2.42685659e+00  2.42685659e+00  2.42685659e+00
  2.19321063e+01  2.19321063e+01  2.19321063e+01  9.83624832e+01
  1.32855077e+02  1.32855077e+02  1.32855077e+02  4.72504193e+02
  4.72504193e+02  4.72504193e+02  8.51750805e+02  1.16186080e+03
  1.16186080e+03  1.16186080e+03  2.41689705e+03  2.41689705e+03
  2.41689705e+03  4.68963967e+03  4.68963967e+03  4.68963967e+03
  5.25921843e+03  8.85345734e+03  8.85345734e+03  8.85345734e+03
  2.05861357e+04  7.11311177e+04]
E1 = -728.4609562886361  E_coul = 202.37524564214544
Extra cycle  E= -526.085710646491  delta_E= -5.68e-13  |g|= 7.04e-07  |ddm|= 1.03e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.21 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 130472.2967640248
E1 = -728.4609562886361  E_coul = 202.37524564214544
init E= -526.085710646491
    CPU time for initialize scf      1.09 sec, wall time      0.19 sec
  HOMO = -0.534228330172419  LUMO = 2.42685683859224
  mo_energy =
[-1.18463516e+02 -1.21378439e+01 -9.47502867e+00 -9.47502867e+00
 -9.47502867e+00 -1.22610124e+00 -5.34228330e-01 -5.34228330e-01
 -5.34228330e-01  2.42685684e+00  2.42685684e+00  2.42685684e+00
  2.19321070e+01  2.19321070e+01  2.19321070e+01  9.83624844e+01
  1.32855079e+02  1.32855079e+02  1.32855079e+02  4.72504195e+02
  4.72504195e+02  4.72504195e+02  8.51750806e+02  1.16186080e+03
  1.16186080e+03  1.16186080e+03  2.41689706e+03  2.41689706e+03
  2.41689706e+03  4.68963967e+03  4.68963967e+03  4.68963967e+03
  5.25921843e+03  8.85345734e+03  8.85345734e+03  8.85345734e+03
  2.05861357e+04  7.11311177e+04]
E1 = -728.4609545732138  E_coul = 202.37524392672262
cycle= 1 E= -526.085710646491  delta_E= -4.55e-13  |g|= 1.27e-07  |ddm|= 1.63e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.4609545732138  E_coul = 202.37524392672262
  HOMO = -0.534228352426826  LUMO = 2.42685679906077
  mo_energy =
[-1.18463517e+02 -1.21378441e+01 -9.47502879e+00 -9.47502879e+00
 -9.47502879e+00 -1.22610127e+00 -5.34228352e-01 -5.34228352e-01
 -5.34228352e-01  2.42685680e+00  2.42685680e+00  2.42685680e+00
  2.19321069e+01  2.19321069e+01  2.19321069e+01  9.83624842e+01
  1.32855078e+02  1.32855078e+02  1.32855078e+02  4.72504194e+02
  4.72504194e+02  4.72504194e+02  8.51750806e+02  1.16186080e+03
  1.16186080e+03  1.16186080e+03  2.41689706e+03  2.41689706e+03
  2.41689706e+03  4.68963967e+03  4.68963967e+03  4.68963967e+03
  5.25921843e+03  8.85345734e+03  8.85345734e+03  8.85345734e+03
  2.05861357e+04  7.11311177e+04]
E1 = -728.4609548707837  E_coul = 202.3752442242933
Extra cycle  E= -526.08571064649  delta_E= 7.96e-13  |g|= 2.24e-08  |ddm|= 2.77e-08
    CPU time for scf_cycle      1.21 sec, wall time      0.30 sec
exp = [2.61854995e+04 7.58543758e+03 3.55300661e+03 6.00758941e+02
 1.38343122e+02 3.93681371e+01 4.60650677e+00 3.91770952e-01
 1.36277177e+03 6.52724751e+02 2.38918389e+02 2.59685820e+02
 7.86640569e+02 1.96494898e+01 8.86042517e+01 1.46792066e+00
 5.62313168e+00 3.43671993e-01]
grad_E = [ 4.56984653e-07  1.05704505e-06  5.49897324e-05  4.63612779e-04
 -3.21477246e-03  1.16800574e-03 -2.43682755e-03 -1.59993825e-02
  2.82163346e-06  1.84079201e-05  1.74445592e-04  1.51700835e-04
  1.26632335e-05 -1.00043370e-02  3.55162384e-03  8.26211738e-02
  6.10988574e-03 -2.85129128e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.5050133        1
[INPUT] 0    0    [1    /1   ]  7585.37830592        1
[INPUT] 0    0    [1    /1   ]  3552.891846          1
[INPUT] 0    0    [1    /1   ]  598.819301717        1
[INPUT] 0    0    [1    /1   ]  138.660314511        1
[INPUT] 0    0    [1    /1   ]  39.6976136153        1
[INPUT] 0    0    [1    /1   ]  4.6055272904         1
[INPUT] 0    0    [1    /1   ]  0.39602973732        1
[INPUT] 1    0    [1    /1   ]  1362.78661999        1
[INPUT] 1    0    [1    /1   ]  652.828941999        1
[INPUT] 1    0    [1    /1   ]  239.517465425        1
[INPUT] 1    0    [1    /1   ]  260.215945104        1
[INPUT] 1    0    [1    /1   ]  773.638682409        1
[INPUT] 1    0    [1    /1   ]  18.9917452551        1
[INPUT] 1    0    [1    /1   ]  81.2121346578        1
[INPUT] 1    0    [1    /1   ]  1.09421120152        1
[INPUT] 1    0    [1    /1   ]  5.35595605619        1
[INPUT] 1    0    [1    /1   ]  0.29864351943        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.505013327587, 1.0]], [0, [7585.378305918643, 1.0]], [0, [3552.89184600058, 1.0]], [0, [598.8193017166093, 1.0]], [0, [138.6603145106273, 1.0]], [0, [39.69761361531542, 1.0]], [0, [4.605527290402138, 1.0]], [0, [0.3960297373202377, 1.0]], [1, [1362.786619988249, 1.0]], [1, [652.8289419993055, 1.0]], [1, [239.51746542454282, 1.0]], [1, [260.2159451042299, 1.0]], [1, [773.638682409344, 1.0]], [1, [18.99174525514528, 1.0]], [1, [81.21213465780113, 1.0]], [1, [1.0942112015226164, 1.0]], [1, [5.35595605619436, 1.0]], [1, [0.2986435194297016, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.50501333]
bas 1, expnt(s) = [7585.37830592]
bas 2, expnt(s) = [3552.891846]
bas 3, expnt(s) = [598.81930172]
bas 4, expnt(s) = [138.66031451]
bas 5, expnt(s) = [39.69761362]
bas 6, expnt(s) = [4.60552729]
bas 7, expnt(s) = [0.39602974]
bas 8, expnt(s) = [1362.78661999]
bas 9, expnt(s) = [652.828942]
bas 10, expnt(s) = [239.51746542]
bas 11, expnt(s) = [260.2159451]
bas 12, expnt(s) = [773.63868241]
bas 13, expnt(s) = [18.99174526]
bas 14, expnt(s) = [81.21213466]
bas 15, expnt(s) = [1.0942112]
bas 16, expnt(s) = [5.35595606]
bas 17, expnt(s) = [0.29864352]
CPU time:       618.74
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61855050e+04 5.20068728e+03 7.58537831e+03 2.05351537e+03
 3.55289185e+03 1.16265674e+03 5.98819302e+02 3.05834776e+02
 1.38660315e+02 1.02089049e+02 3.96976136e+01 3.99565815e+01
 4.60552729e+00 7.94281677e+00 3.96029737e-01 1.26127815e+00
 1.36278662e+03 2.41556773e+04 6.52828942e+02 9.62683753e+03
 2.39517465e+02 2.74888060e+03 2.60215945e+02 3.04896033e+03
 7.73638682e+02 1.19030186e+04 1.89917453e+01 1.15661944e+02
 8.12121347e+01 7.11230791e+02 1.09421120e+00 3.26483200e+00
 5.35595606e+00 2.37700803e+01 2.98643519e-01 6.44059160e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.94640305466829
cond(S) = 124525.94618094387
E1 = -728.287167501509  E_coul = 203.09481520999364
init E= -525.192352291515
    CPU time for initialize scf      0.17 sec, wall time      0.04 sec
  HOMO = -0.556321484199401  LUMO = 1.70318509039671
  mo_energy =
[-1.18252565e+02 -1.20959623e+01 -9.41891412e+00 -9.41891412e+00
 -9.41891412e+00 -1.23502974e+00 -5.56321484e-01 -5.56321484e-01
 -5.56321484e-01  1.70318509e+00  1.70318509e+00  1.70318509e+00
  1.94172623e+01  1.94172623e+01  1.94172623e+01  9.93873903e+01
  1.24319354e+02  1.24319354e+02  1.24319354e+02  4.53121385e+02
  4.53121385e+02  4.53121385e+02  8.52594880e+02  1.13544898e+03
  1.13544898e+03  1.13544898e+03  2.38489002e+03  2.38489002e+03
  2.38489002e+03  4.64587614e+03  4.64587614e+03  4.64587614e+03
  5.25606268e+03  8.79234288e+03  8.79234288e+03  8.79234288e+03
  2.05816689e+04  7.11265105e+04]
E1 = -728.5057102689967  E_coul = 202.39140787168756
cycle= 1 E= -526.114302397309  delta_E= -0.922  |g|= 0.176  |ddm|= 1.48
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.465219
diis-c [-0.21642914  1.        ]
  HOMO = -0.548256906471296  LUMO = 1.71035321328147
  mo_energy =
[-1.18452605e+02 -1.21378239e+01 -9.46545366e+00 -9.46545366e+00
 -9.46545366e+00 -1.22998338e+00 -5.48256906e-01 -5.48256906e-01
 -5.48256906e-01  1.71035321e+00  1.71035321e+00  1.71035321e+00
  1.93683628e+01  1.93683628e+01  1.93683628e+01  9.92781621e+01
  1.24189434e+02  1.24189434e+02  1.24189434e+02  4.52941456e+02
  4.52941456e+02  4.52941456e+02  8.52310180e+02  1.13522464e+03
  1.13522464e+03  1.13522464e+03  2.38461643e+03  2.38461643e+03
  2.38461643e+03  4.64554292e+03  4.64554292e+03  4.64554292e+03
  5.25557155e+03  8.79190329e+03  8.79190329e+03  8.79190329e+03
  2.05810538e+04  7.11258053e+04]
E1 = -728.6107236078025  E_coul = 202.49624605732802
cycle= 2 E= -526.114477550474  delta_E= -0.000175  |g|= 0.0134  |ddm|= 0.0078
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0221785
diis-c [-3.97434275e-04  2.04812528e-02  9.79518747e-01]
  HOMO = -0.547792102755915  LUMO = 1.71121004490195
  mo_energy =
[-1.18431543e+02 -1.21308546e+01 -9.45836770e+00 -9.45836770e+00
 -9.45836770e+00 -1.22931375e+00 -5.47792103e-01 -5.47792103e-01
 -5.47792103e-01  1.71121004e+00  1.71121004e+00  1.71121004e+00
  1.93754812e+01  1.93754812e+01  1.93754812e+01  9.92954347e+01
  1.24205524e+02  1.24205524e+02  1.24205524e+02  4.52961684e+02
  4.52961684e+02  4.52961684e+02  8.52333473e+02  1.13524676e+03
  1.13524676e+03  1.13524676e+03  2.38463973e+03  2.38463973e+03
  2.38463973e+03  4.64556701e+03  4.64556701e+03  4.64556701e+03
  5.25559625e+03  8.79192784e+03  8.79192784e+03  8.79192784e+03
  2.05810785e+04  7.11258300e+04]
E1 = -728.5880881575088  E_coul = 202.4736081288321
cycle= 3 E= -526.114480028677  delta_E= -2.48e-06  |g|= 0.00155  |ddm|= 0.00186
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00292252
diis-c [-1.52088669e-07 -8.42346607e-04  1.08379783e-01  8.92462563e-01]
  HOMO = -0.548035689564835  LUMO = 1.71089730751157
  mo_energy =
[-1.18434229e+02 -1.21321287e+01 -9.45969167e+00 -9.45969167e+00
 -9.45969167e+00 -1.22963453e+00 -5.48035690e-01 -5.48035690e-01
 -5.48035690e-01  1.71089731e+00  1.71089731e+00  1.71089731e+00
  1.93741869e+01  1.93741869e+01  1.93741869e+01  9.92932042e+01
  1.24203320e+02  1.24203320e+02  1.24203320e+02  4.52959092e+02
  4.52959092e+02  4.52959092e+02  8.52330534e+02  1.13524397e+03
  1.13524397e+03  1.13524397e+03  2.38463680e+03  2.38463680e+03
  2.38463680e+03  4.64556396e+03  4.64556396e+03  4.64556396e+03
  5.25559301e+03  8.79192467e+03  8.79192467e+03  8.79192467e+03
  2.05810752e+04  7.11258267e+04]
E1 = -728.5915844736402  E_coul = 202.477104385602
cycle= 4 E= -526.114480088038  delta_E= -5.94e-08  |g|= 3.89e-05  |ddm|= 0.000336
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=4.99002e-05
diis-c [-6.72418615e-10 -5.36188477e-06 -1.94010923e-04  1.33662944e-02
  9.86833078e-01]
  HOMO = -0.548015782657025  LUMO = 1.71092078258671
  mo_energy =
[-1.18434142e+02 -1.21320565e+01 -9.45961942e+00 -9.45961942e+00
 -9.45961942e+00 -1.22960836e+00 -5.48015783e-01 -5.48015783e-01
 -5.48015783e-01  1.71092078e+00  1.71092078e+00  1.71092078e+00
  1.93742550e+01  1.93742550e+01  1.93742550e+01  9.92932902e+01
  1.24203403e+02  1.24203403e+02  1.24203403e+02  4.52959179e+02
  4.52959179e+02  4.52959179e+02  8.52330618e+02  1.13524405e+03
  1.13524405e+03  1.13524405e+03  2.38463688e+03  2.38463688e+03
  2.38463688e+03  4.64556404e+03  4.64556404e+03  4.64556404e+03
  5.25559309e+03  8.79192475e+03  8.79192475e+03  8.79192475e+03
  2.05810753e+04  7.11258267e+04]
E1 = -728.5914330641522  E_coul = 202.47695297602414
cycle= 5 E= -526.114480088128  delta_E= -8.99e-11  |g|= 4.72e-06  |ddm|= 1.79e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -728.5914330641522  E_coul = 202.47695297602414
  HOMO = -0.548017733526482  LUMO = 1.71091843993084
  mo_energy =
[-1.18434154e+02 -1.21320642e+01 -9.45962723e+00 -9.45962723e+00
 -9.45962723e+00 -1.22961092e+00 -5.48017734e-01 -5.48017734e-01
 -5.48017734e-01  1.71091844e+00  1.71091844e+00  1.71091844e+00
  1.93742476e+01  1.93742476e+01  1.93742476e+01  9.92932800e+01
  1.24203392e+02  1.24203392e+02  1.24203392e+02  4.52959168e+02
  4.52959168e+02  4.52959168e+02  8.52330607e+02  1.13524404e+03
  1.13524404e+03  1.13524404e+03  2.38463687e+03  2.38463687e+03
  2.38463687e+03  4.64556403e+03  4.64556403e+03  4.64556403e+03
  5.25559308e+03  8.79192474e+03  8.79192474e+03  8.79192474e+03
  2.05810753e+04  7.11258267e+04]
E1 = -728.591450732843  E_coul = 202.47697064471316
Extra cycle  E= -526.11448008813  delta_E= -1.71e-12  |g|= 1.04e-06  |ddm|= 1.95e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.20 sec
exp = [2.61855050e+04 7.58537831e+03 3.55289185e+03 5.98819302e+02
 1.38660315e+02 3.96976136e+01 4.60552729e+00 3.96029737e-01
 1.36278662e+03 6.52828942e+02 2.39517465e+02 2.60215945e+02
 7.73638682e+02 1.89917453e+01 8.12121347e+01 1.09421120e+00
 5.35595606e+00 2.98643519e-01]
E = -526.1144800881298
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:28:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.5050133        1
[INPUT] 0    0    [1    /1   ]  7585.37830592        1
[INPUT] 0    0    [1    /1   ]  3552.891846          1
[INPUT] 0    0    [1    /1   ]  598.819301717        1
[INPUT] 0    0    [1    /1   ]  138.660314511        1
[INPUT] 0    0    [1    /1   ]  39.6976136153        1
[INPUT] 0    0    [1    /1   ]  4.6055272904         1
[INPUT] 0    0    [1    /1   ]  0.39602973732        1
[INPUT] 1    0    [1    /1   ]  1362.78661999        1
[INPUT] 1    0    [1    /1   ]  652.828941999        1
[INPUT] 1    0    [1    /1   ]  239.517465425        1
[INPUT] 1    0    [1    /1   ]  260.215945104        1
[INPUT] 1    0    [1    /1   ]  773.638682409        1
[INPUT] 1    0    [1    /1   ]  18.9917452551        1
[INPUT] 1    0    [1    /1   ]  81.2121346578        1
[INPUT] 1    0    [1    /1   ]  1.09421120152        1
[INPUT] 1    0    [1    /1   ]  5.35595605619        1
[INPUT] 1    0    [1    /1   ]  0.29864351943        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.505013327587, 1.0]], [0, [7585.378305918643, 1.0]], [0, [3552.89184600058, 1.0]], [0, [598.8193017166093, 1.0]], [0, [138.6603145106273, 1.0]], [0, [39.69761361531542, 1.0]], [0, [4.605527290402138, 1.0]], [0, [0.3960297373202377, 1.0]], [1, [1362.786619988249, 1.0]], [1, [652.8289419993055, 1.0]], [1, [239.51746542454282, 1.0]], [1, [260.2159451042299, 1.0]], [1, [773.638682409344, 1.0]], [1, [18.99174525514528, 1.0]], [1, [81.21213465780113, 1.0]], [1, [1.0942112015226164, 1.0]], [1, [5.35595605619436, 1.0]], [1, [0.2986435194297016, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.50501333]
bas 1, expnt(s) = [7585.37830592]
bas 2, expnt(s) = [3552.891846]
bas 3, expnt(s) = [598.81930172]
bas 4, expnt(s) = [138.66031451]
bas 5, expnt(s) = [39.69761362]
bas 6, expnt(s) = [4.60552729]
bas 7, expnt(s) = [0.39602974]
bas 8, expnt(s) = [1362.78661999]
bas 9, expnt(s) = [652.828942]
bas 10, expnt(s) = [239.51746542]
bas 11, expnt(s) = [260.2159451]
bas 12, expnt(s) = [773.63868241]
bas 13, expnt(s) = [18.99174526]
bas 14, expnt(s) = [81.21213466]
bas 15, expnt(s) = [1.0942112]
bas 16, expnt(s) = [5.35595606]
bas 17, expnt(s) = [0.29864352]
CPU time:       619.37
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61855050e+04 5.20068728e+03 7.58537831e+03 2.05351537e+03
 3.55289185e+03 1.16265674e+03 5.98819302e+02 3.05834776e+02
 1.38660315e+02 1.02089049e+02 3.96976136e+01 3.99565815e+01
 4.60552729e+00 7.94281677e+00 3.96029737e-01 1.26127815e+00
 1.36278662e+03 2.41556773e+04 6.52828942e+02 9.62683753e+03
 2.39517465e+02 2.74888060e+03 2.60215945e+02 3.04896033e+03
 7.73638682e+02 1.19030186e+04 1.89917453e+01 1.15661944e+02
 8.12121347e+01 7.11230791e+02 1.09421120e+00 3.26483200e+00
 5.35595606e+00 2.37700803e+01 2.98643519e-01 6.44059160e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.94640305466829
cond(S) = 124525.94618094387
E1 = -728.287167501509  E_coul = 203.09481520999364
init E= -525.192352291515
    CPU time for initialize scf      0.15 sec, wall time      0.04 sec
  HOMO = -0.556321484199401  LUMO = 1.70318509039671
  mo_energy =
[-1.18252565e+02 -1.20959623e+01 -9.41891412e+00 -9.41891412e+00
 -9.41891412e+00 -1.23502974e+00 -5.56321484e-01 -5.56321484e-01
 -5.56321484e-01  1.70318509e+00  1.70318509e+00  1.70318509e+00
  1.94172623e+01  1.94172623e+01  1.94172623e+01  9.93873903e+01
  1.24319354e+02  1.24319354e+02  1.24319354e+02  4.53121385e+02
  4.53121385e+02  4.53121385e+02  8.52594880e+02  1.13544898e+03
  1.13544898e+03  1.13544898e+03  2.38489002e+03  2.38489002e+03
  2.38489002e+03  4.64587614e+03  4.64587614e+03  4.64587614e+03
  5.25606268e+03  8.79234288e+03  8.79234288e+03  8.79234288e+03
  2.05816689e+04  7.11265105e+04]
E1 = -728.5057102689967  E_coul = 202.39140787168756
cycle= 1 E= -526.114302397309  delta_E= -0.922  |g|= 0.176  |ddm|= 1.48
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.465219
diis-c [-0.21642914  1.        ]
  HOMO = -0.548256906471296  LUMO = 1.71035321328147
  mo_energy =
[-1.18452605e+02 -1.21378239e+01 -9.46545366e+00 -9.46545366e+00
 -9.46545366e+00 -1.22998338e+00 -5.48256906e-01 -5.48256906e-01
 -5.48256906e-01  1.71035321e+00  1.71035321e+00  1.71035321e+00
  1.93683628e+01  1.93683628e+01  1.93683628e+01  9.92781621e+01
  1.24189434e+02  1.24189434e+02  1.24189434e+02  4.52941456e+02
  4.52941456e+02  4.52941456e+02  8.52310180e+02  1.13522464e+03
  1.13522464e+03  1.13522464e+03  2.38461643e+03  2.38461643e+03
  2.38461643e+03  4.64554292e+03  4.64554292e+03  4.64554292e+03
  5.25557155e+03  8.79190329e+03  8.79190329e+03  8.79190329e+03
  2.05810538e+04  7.11258053e+04]
E1 = -728.6107236078025  E_coul = 202.49624605732802
cycle= 2 E= -526.114477550474  delta_E= -0.000175  |g|= 0.0134  |ddm|= 0.0078
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0221785
diis-c [-3.97434275e-04  2.04812528e-02  9.79518747e-01]
  HOMO = -0.547792102755915  LUMO = 1.71121004490195
  mo_energy =
[-1.18431543e+02 -1.21308546e+01 -9.45836770e+00 -9.45836770e+00
 -9.45836770e+00 -1.22931375e+00 -5.47792103e-01 -5.47792103e-01
 -5.47792103e-01  1.71121004e+00  1.71121004e+00  1.71121004e+00
  1.93754812e+01  1.93754812e+01  1.93754812e+01  9.92954347e+01
  1.24205524e+02  1.24205524e+02  1.24205524e+02  4.52961684e+02
  4.52961684e+02  4.52961684e+02  8.52333473e+02  1.13524676e+03
  1.13524676e+03  1.13524676e+03  2.38463973e+03  2.38463973e+03
  2.38463973e+03  4.64556701e+03  4.64556701e+03  4.64556701e+03
  5.25559625e+03  8.79192784e+03  8.79192784e+03  8.79192784e+03
  2.05810785e+04  7.11258300e+04]
E1 = -728.5880881575088  E_coul = 202.4736081288321
cycle= 3 E= -526.114480028677  delta_E= -2.48e-06  |g|= 0.00155  |ddm|= 0.00186
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00292252
diis-c [-1.52088669e-07 -8.42346607e-04  1.08379783e-01  8.92462563e-01]
  HOMO = -0.548035689564835  LUMO = 1.71089730751157
  mo_energy =
[-1.18434229e+02 -1.21321287e+01 -9.45969167e+00 -9.45969167e+00
 -9.45969167e+00 -1.22963453e+00 -5.48035690e-01 -5.48035690e-01
 -5.48035690e-01  1.71089731e+00  1.71089731e+00  1.71089731e+00
  1.93741869e+01  1.93741869e+01  1.93741869e+01  9.92932042e+01
  1.24203320e+02  1.24203320e+02  1.24203320e+02  4.52959092e+02
  4.52959092e+02  4.52959092e+02  8.52330534e+02  1.13524397e+03
  1.13524397e+03  1.13524397e+03  2.38463680e+03  2.38463680e+03
  2.38463680e+03  4.64556396e+03  4.64556396e+03  4.64556396e+03
  5.25559301e+03  8.79192467e+03  8.79192467e+03  8.79192467e+03
  2.05810752e+04  7.11258267e+04]
E1 = -728.5915844736402  E_coul = 202.477104385602
cycle= 4 E= -526.114480088038  delta_E= -5.94e-08  |g|= 3.89e-05  |ddm|= 0.000336
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=4.99002e-05
diis-c [-6.72418615e-10 -5.36188477e-06 -1.94010923e-04  1.33662944e-02
  9.86833078e-01]
  HOMO = -0.548015782657025  LUMO = 1.71092078258671
  mo_energy =
[-1.18434142e+02 -1.21320565e+01 -9.45961942e+00 -9.45961942e+00
 -9.45961942e+00 -1.22960836e+00 -5.48015783e-01 -5.48015783e-01
 -5.48015783e-01  1.71092078e+00  1.71092078e+00  1.71092078e+00
  1.93742550e+01  1.93742550e+01  1.93742550e+01  9.92932902e+01
  1.24203403e+02  1.24203403e+02  1.24203403e+02  4.52959179e+02
  4.52959179e+02  4.52959179e+02  8.52330618e+02  1.13524405e+03
  1.13524405e+03  1.13524405e+03  2.38463688e+03  2.38463688e+03
  2.38463688e+03  4.64556404e+03  4.64556404e+03  4.64556404e+03
  5.25559309e+03  8.79192475e+03  8.79192475e+03  8.79192475e+03
  2.05810753e+04  7.11258267e+04]
E1 = -728.5914330641522  E_coul = 202.47695297602414
cycle= 5 E= -526.114480088128  delta_E= -8.99e-11  |g|= 4.72e-06  |ddm|= 1.79e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -728.5914330641522  E_coul = 202.47695297602414
  HOMO = -0.548017733526482  LUMO = 1.71091843993084
  mo_energy =
[-1.18434154e+02 -1.21320642e+01 -9.45962723e+00 -9.45962723e+00
 -9.45962723e+00 -1.22961092e+00 -5.48017734e-01 -5.48017734e-01
 -5.48017734e-01  1.71091844e+00  1.71091844e+00  1.71091844e+00
  1.93742476e+01  1.93742476e+01  1.93742476e+01  9.92932800e+01
  1.24203392e+02  1.24203392e+02  1.24203392e+02  4.52959168e+02
  4.52959168e+02  4.52959168e+02  8.52330607e+02  1.13524404e+03
  1.13524404e+03  1.13524404e+03  2.38463687e+03  2.38463687e+03
  2.38463687e+03  4.64556403e+03  4.64556403e+03  4.64556403e+03
  5.25559308e+03  8.79192474e+03  8.79192474e+03  8.79192474e+03
  2.05810753e+04  7.11258267e+04]
E1 = -728.591450732843  E_coul = 202.47697064471316
Extra cycle  E= -526.11448008813  delta_E= -1.71e-12  |g|= 1.04e-06  |ddm|= 1.95e-06
    CPU time for scf_cycle      0.29 sec, wall time      0.19 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 124525.94618094387
E1 = -728.591450732843  E_coul = 202.47697064471316
init E= -526.11448008813
    CPU time for initialize scf      0.97 sec, wall time      0.18 sec
  HOMO = -0.548017438338805  LUMO = 1.71091880322277
  mo_energy =
[-1.18434151e+02 -1.21320629e+01 -9.45962590e+00 -9.45962590e+00
 -9.45962590e+00 -1.22961053e+00 -5.48017438e-01 -5.48017438e-01
 -5.48017438e-01  1.71091880e+00  1.71091880e+00  1.71091880e+00
  1.93742488e+01  1.93742488e+01  1.93742488e+01  9.92932820e+01
  1.24203394e+02  1.24203394e+02  1.24203394e+02  4.52959170e+02
  4.52959170e+02  4.52959170e+02  8.52330609e+02  1.13524405e+03
  1.13524405e+03  1.13524405e+03  2.38463687e+03  2.38463687e+03
  2.38463687e+03  4.64556404e+03  4.64556404e+03  4.64556404e+03
  5.25559308e+03  8.79192474e+03  8.79192474e+03  8.79192474e+03
  2.05810753e+04  7.11258267e+04]
E1 = -728.591447509884  E_coul = 202.47696742175418
cycle= 1 E= -526.11448008813  delta_E=    0  |g|= 2.05e-07  |ddm|= 3.34e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.591447509884  E_coul = 202.47696742175418
  HOMO = -0.54801748933457  LUMO = 1.71091873981268
  mo_energy =
[-1.18434152e+02 -1.21320631e+01 -9.45962614e+00 -9.45962614e+00
 -9.45962614e+00 -1.22961060e+00 -5.48017489e-01 -5.48017489e-01
 -5.48017489e-01  1.71091874e+00  1.71091874e+00  1.71091874e+00
  1.93742486e+01  1.93742486e+01  1.93742486e+01  9.92932816e+01
  1.24203394e+02  1.24203394e+02  1.24203394e+02  4.52959170e+02
  4.52959170e+02  4.52959170e+02  8.52330609e+02  1.13524405e+03
  1.13524405e+03  1.13524405e+03  2.38463687e+03  2.38463687e+03
  2.38463687e+03  4.64556404e+03  4.64556404e+03  4.64556404e+03
  5.25559308e+03  8.79192474e+03  8.79192474e+03  8.79192474e+03
  2.05810753e+04  7.11258267e+04]
E1 = -728.5914481079553  E_coul = 202.47696801982502
Extra cycle  E= -526.11448008813  delta_E= -5.68e-13  |g|= 3.89e-08  |ddm|= 6.07e-08
    CPU time for scf_cycle      1.07 sec, wall time      0.29 sec
exp = [2.61855050e+04 7.58537831e+03 3.55289185e+03 5.98819302e+02
 1.38660315e+02 3.96976136e+01 4.60552729e+00 3.96029737e-01
 1.36278662e+03 6.52828942e+02 2.39517465e+02 2.60215945e+02
 7.73638682e+02 1.89917453e+01 8.12121347e+01 1.09421120e+00
 5.35595606e+00 2.98643519e-01]
grad_E = [ 4.90513319e-07  1.15017910e-06  5.67737239e-05  4.29387722e-04
 -3.66836061e-03  4.60716568e-03 -6.78428254e-04  4.45838790e-02
  1.67263552e-06  1.23642108e-05  1.13912145e-04  1.01392363e-04
  8.86954709e-06 -1.73402089e-03  3.64874760e-03 -8.13852758e-02
  3.62772531e-02 -1.15649833e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.522913         1
[INPUT] 0    0    [1    /1   ]  7585.18585778        1
[INPUT] 0    0    [1    /1   ]  3552.51600155        1
[INPUT] 0    0    [1    /1   ]  592.747235484        1
[INPUT] 0    0    [1    /1   ]  136.934820677        1
[INPUT] 0    0    [1    /1   ]  39.5003451082        1
[INPUT] 0    0    [1    /1   ]  4.60598425578        1
[INPUT] 0    0    [1    /1   ]  0.397781512721       1
[INPUT] 1    0    [1    /1   ]  1362.81294909        1
[INPUT] 1    0    [1    /1   ]  652.979188156        1
[INPUT] 1    0    [1    /1   ]  240.403480977        1
[INPUT] 1    0    [1    /1   ]  261.001460785        1
[INPUT] 1    0    [1    /1   ]  751.843474959        1
[INPUT] 1    0    [1    /1   ]  17.446596702         1
[INPUT] 1    0    [1    /1   ]  71.6385821637        1
[INPUT] 1    0    [1    /1   ]  0.847145266636       1
[INPUT] 1    0    [1    /1   ]  4.94429094066        1
[INPUT] 1    0    [1    /1   ]  0.262364688589       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.52291296097, 1.0]], [0, [7585.185857781632, 1.0]], [0, [3552.5160015479037, 1.0]], [0, [592.747235484464, 1.0]], [0, [136.9348206767907, 1.0]], [0, [39.500345108234185, 1.0]], [0, [4.605984255781546, 1.0]], [0, [0.39778151272139833, 1.0]], [1, [1362.8129490870883, 1.0]], [1, [652.979188156081, 1.0]], [1, [240.403480976599, 1.0]], [1, [261.0014607853648, 1.0]], [1, [751.8434749589767, 1.0]], [1, [17.446596701993265, 1.0]], [1, [71.63858216366292, 1.0]], [1, [0.8471452666360644, 1.0]], [1, [4.944290940656038, 1.0]], [1, [0.2623646885894696, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.52291296]
bas 1, expnt(s) = [7585.18585778]
bas 2, expnt(s) = [3552.51600155]
bas 3, expnt(s) = [592.74723548]
bas 4, expnt(s) = [136.93482068]
bas 5, expnt(s) = [39.50034511]
bas 6, expnt(s) = [4.60598426]
bas 7, expnt(s) = [0.39778151]
bas 8, expnt(s) = [1362.81294909]
bas 9, expnt(s) = [652.97918816]
bas 10, expnt(s) = [240.40348098]
bas 11, expnt(s) = [261.00146079]
bas 12, expnt(s) = [751.84347496]
bas 13, expnt(s) = [17.4465967]
bas 14, expnt(s) = [71.63858216]
bas 15, expnt(s) = [0.84714527]
bas 16, expnt(s) = [4.94429094]
bas 17, expnt(s) = [0.26236469]
CPU time:       625.48
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61855229e+04 5.20068994e+03 7.58518586e+03 2.05347630e+03
 3.55251600e+03 1.16256450e+03 5.92747235e+02 3.03505927e+02
 1.36934821e+02 1.01134760e+02 3.95003451e+01 3.98075722e+01
 4.60598426e+00 7.94340784e+00 3.97781513e-01 1.26546014e+00
 1.36281295e+03 2.41562606e+04 6.52979188e+02 9.62960708e+03
 2.40403481e+02 2.76159719e+03 2.61001461e+02 3.06046957e+03
 7.51843475e+02 1.14853355e+04 1.74465967e+01 1.04021424e+02
 7.16385822e+01 6.08020357e+02 8.47145267e-01 2.37100109e+00
 4.94429094e+00 2.15087125e+01 2.62364689e-01 5.47792550e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.95923931149686
cond(S) = 126910.37449000694
E1 = -728.1191599954359  E_coul = 202.96578918362383
init E= -525.153370811812
    CPU time for initialize scf      0.71 sec, wall time      0.09 sec
  HOMO = -0.557866113767417  LUMO = 1.26365445614228
  mo_energy =
[-1.18262107e+02 -1.21108493e+01 -9.43138198e+00 -9.43138198e+00
 -9.43138198e+00 -1.23508443e+00 -5.57866114e-01 -5.57866114e-01
 -5.57866114e-01  1.26365446e+00  1.26365446e+00  1.26365446e+00
  1.64940002e+01  1.64940002e+01  1.64940002e+01  9.81503458e+01
  1.10970366e+02  1.10970366e+02  1.10970366e+02  4.24342207e+02
  4.24342207e+02  4.24342207e+02  8.41916451e+02  1.09778237e+03
  1.09778237e+03  1.09778237e+03  2.33905012e+03  2.33905012e+03
  2.33905012e+03  4.58033294e+03  4.58033294e+03  4.58033294e+03
  5.23080213e+03  8.69762106e+03  8.69762106e+03  8.69762106e+03
  2.05526674e+04  7.10977045e+04]
E1 = -728.2531150096453  E_coul = 202.13469372315836
cycle= 1 E= -526.118421286487  delta_E= -0.965  |g|= 0.186  |ddm|= 1.74
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.481358
diis-c [-0.23170577  1.        ]
  HOMO = -0.550421057160404  LUMO = 1.27182414167293
  mo_energy =
[-1.18483420e+02 -1.21615552e+01 -9.48802011e+00 -9.48802011e+00
 -9.48802011e+00 -1.23169739e+00 -5.50421057e-01 -5.50421057e-01
 -5.50421057e-01  1.27182414e+00  1.27182414e+00  1.27182414e+00
  1.64441359e+01  1.64441359e+01  1.64441359e+01  9.80234397e+01
  1.10828302e+02  1.10828302e+02  1.10828302e+02  4.24142800e+02
  4.24142800e+02  4.24142800e+02  8.41611662e+02  1.09753670e+03
  1.09753670e+03  1.09753670e+03  2.33875510e+03  2.33875510e+03
  2.33875510e+03  4.57997834e+03  4.57997834e+03  4.57997834e+03
  5.23028842e+03  8.69715953e+03  8.69715953e+03  8.69715953e+03
  2.05520291e+04  7.10969761e+04]
E1 = -728.3821607178862  E_coul = 202.2634995000352
cycle= 2 E= -526.118661217851  delta_E= -0.00024  |g|= 0.0156  |ddm|= 0.00929
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0258612
diis-c [-5.13415327e-04  2.52698778e-02  9.74730122e-01]
  HOMO = -0.549673323512215  LUMO = 1.27269476146305
  mo_energy =
[-1.18458476e+02 -1.21530165e+01 -9.47934375e+00 -9.47934375e+00
 -9.47934375e+00 -1.23066644e+00 -5.49673324e-01 -5.49673324e-01
 -5.49673324e-01  1.27269476e+00  1.27269476e+00  1.27269476e+00
  1.64523218e+01  1.64523218e+01  1.64523218e+01  9.80438471e+01
  1.10846950e+02  1.10846950e+02  1.10846950e+02  4.24166664e+02
  4.24166664e+02  4.24166664e+02  8.41639155e+02  1.09756287e+03
  1.09756287e+03  1.09756287e+03  2.33878263e+03  2.33878263e+03
  2.33878263e+03  4.58000680e+03  4.58000680e+03  4.58000680e+03
  5.23031767e+03  8.69718858e+03  8.69718858e+03  8.69718858e+03
  2.05520586e+04  7.10970055e+04]
E1 = -728.3560616649829  E_coul = 202.23739707504905
cycle= 3 E= -526.118664589934  delta_E= -3.37e-06  |g|= 0.00165  |ddm|= 0.00217
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00312309
diis-c [-1.77006657e-07 -8.52778134e-04  9.98899557e-02  9.00962822e-01]
  HOMO = -0.549964820827481  LUMO = 1.27242321234591
  mo_energy =
[-1.18461426e+02 -1.21544392e+01 -9.48082523e+00 -9.48082523e+00
 -9.48082523e+00 -1.23105091e+00 -5.49964821e-01 -5.49964821e-01
 -5.49964821e-01  1.27242321e+00  1.27242321e+00  1.27242321e+00
  1.64509505e+01  1.64509505e+01  1.64509505e+01  9.80414046e+01
  1.10844575e+02  1.10844575e+02  1.10844575e+02  4.24163827e+02
  4.24163827e+02  4.24163827e+02  8.41635930e+02  1.09755980e+03
  1.09755980e+03  1.09755980e+03  2.33877941e+03  2.33877941e+03
  2.33877941e+03  4.58000345e+03  4.58000345e+03  4.58000345e+03
  5.23031412e+03  8.69718509e+03  8.69718509e+03  8.69718509e+03
  2.05520549e+04  7.10970018e+04]
E1 = -728.3598283249066  E_coul = 202.24116366752386
cycle= 4 E= -526.118664657383  delta_E= -6.74e-08  |g|= 4.11e-05  |ddm|= 0.000382
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.367e-05
diis-c [-9.17562962e-10  8.86645464e-06 -2.27032321e-03 -5.24555839e-03
  1.00750702e+00]
  HOMO = -0.549940677370491  LUMO = 1.27244451733313
  mo_energy =
[-1.18461329e+02 -1.21543591e+01 -9.48074535e+00 -9.48074535e+00
 -9.48074535e+00 -1.23101976e+00 -5.49940677e-01 -5.49940677e-01
 -5.49940677e-01  1.27244452e+00  1.27244452e+00  1.27244452e+00
  1.64510255e+01  1.64510255e+01  1.64510255e+01  9.80415002e+01
  1.10844667e+02  1.10844667e+02  1.10844667e+02  4.24163923e+02
  4.24163923e+02  4.24163923e+02  8.41636024e+02  1.09755990e+03
  1.09755990e+03  1.09755990e+03  2.33877950e+03  2.33877950e+03
  2.33877950e+03  4.58000354e+03  4.58000354e+03  4.58000354e+03
  5.23031421e+03  8.69718518e+03  8.69718518e+03  8.69718518e+03
  2.05520550e+04  7.10970019e+04]
E1 = -728.3596655588098  E_coul = 202.2410009013286
cycle= 5 E= -526.118664657481  delta_E= -9.85e-11  |g|= 5.29e-06  |ddm|= 2.02e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3596655588098  E_coul = 202.2410009013286
  HOMO = -0.549943474677223  LUMO = 1.27244204309799
  mo_energy =
[-1.18461343e+02 -1.21543689e+01 -9.48075536e+00 -9.48075536e+00
 -9.48075536e+00 -1.23102339e+00 -5.49943475e-01 -5.49943475e-01
 -5.49943475e-01  1.27244204e+00  1.27244204e+00  1.27244204e+00
  1.64510162e+01  1.64510162e+01  1.64510162e+01  9.80414876e+01
  1.10844655e+02  1.10844655e+02  1.10844655e+02  4.24163910e+02
  4.24163910e+02  4.24163910e+02  8.41636010e+02  1.09755989e+03
  1.09755989e+03  1.09755989e+03  2.33877949e+03  2.33877949e+03
  2.33877949e+03  4.58000353e+03  4.58000353e+03  4.58000353e+03
  5.23031419e+03  8.69718516e+03  8.69718516e+03  8.69718516e+03
  2.05520550e+04  7.10970019e+04]
E1 = -728.3596870031844  E_coul = 202.241022345702
Extra cycle  E= -526.118664657482  delta_E= -1.25e-12  |g|= 1.16e-06  |ddm|= 2.57e-06
    CPU time for scf_cycle      0.91 sec, wall time      0.29 sec
exp = [2.61855229e+04 7.58518586e+03 3.55251600e+03 5.92747235e+02
 1.36934821e+02 3.95003451e+01 4.60598426e+00 3.97781513e-01
 1.36281295e+03 6.52979188e+02 2.40403481e+02 2.61001461e+02
 7.51843475e+02 1.74465967e+01 7.16385822e+01 8.47145267e-01
 4.94429094e+00 2.62364689e-01]
E = -526.1186646574824
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.522913         1
[INPUT] 0    0    [1    /1   ]  7585.18585778        1
[INPUT] 0    0    [1    /1   ]  3552.51600155        1
[INPUT] 0    0    [1    /1   ]  592.747235484        1
[INPUT] 0    0    [1    /1   ]  136.934820677        1
[INPUT] 0    0    [1    /1   ]  39.5003451082        1
[INPUT] 0    0    [1    /1   ]  4.60598425578        1
[INPUT] 0    0    [1    /1   ]  0.397781512721       1
[INPUT] 1    0    [1    /1   ]  1362.81294909        1
[INPUT] 1    0    [1    /1   ]  652.979188156        1
[INPUT] 1    0    [1    /1   ]  240.403480977        1
[INPUT] 1    0    [1    /1   ]  261.001460785        1
[INPUT] 1    0    [1    /1   ]  751.843474959        1
[INPUT] 1    0    [1    /1   ]  17.446596702         1
[INPUT] 1    0    [1    /1   ]  71.6385821637        1
[INPUT] 1    0    [1    /1   ]  0.847145266636       1
[INPUT] 1    0    [1    /1   ]  4.94429094066        1
[INPUT] 1    0    [1    /1   ]  0.262364688589       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.52291296097, 1.0]], [0, [7585.185857781632, 1.0]], [0, [3552.5160015479037, 1.0]], [0, [592.747235484464, 1.0]], [0, [136.9348206767907, 1.0]], [0, [39.500345108234185, 1.0]], [0, [4.605984255781546, 1.0]], [0, [0.39778151272139833, 1.0]], [1, [1362.8129490870883, 1.0]], [1, [652.979188156081, 1.0]], [1, [240.403480976599, 1.0]], [1, [261.0014607853648, 1.0]], [1, [751.8434749589767, 1.0]], [1, [17.446596701993265, 1.0]], [1, [71.63858216366292, 1.0]], [1, [0.8471452666360644, 1.0]], [1, [4.944290940656038, 1.0]], [1, [0.2623646885894696, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.52291296]
bas 1, expnt(s) = [7585.18585778]
bas 2, expnt(s) = [3552.51600155]
bas 3, expnt(s) = [592.74723548]
bas 4, expnt(s) = [136.93482068]
bas 5, expnt(s) = [39.50034511]
bas 6, expnt(s) = [4.60598426]
bas 7, expnt(s) = [0.39778151]
bas 8, expnt(s) = [1362.81294909]
bas 9, expnt(s) = [652.97918816]
bas 10, expnt(s) = [240.40348098]
bas 11, expnt(s) = [261.00146079]
bas 12, expnt(s) = [751.84347496]
bas 13, expnt(s) = [17.4465967]
bas 14, expnt(s) = [71.63858216]
bas 15, expnt(s) = [0.84714527]
bas 16, expnt(s) = [4.94429094]
bas 17, expnt(s) = [0.26236469]
CPU time:       626.83
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61855229e+04 5.20068994e+03 7.58518586e+03 2.05347630e+03
 3.55251600e+03 1.16256450e+03 5.92747235e+02 3.03505927e+02
 1.36934821e+02 1.01134760e+02 3.95003451e+01 3.98075722e+01
 4.60598426e+00 7.94340784e+00 3.97781513e-01 1.26546014e+00
 1.36281295e+03 2.41562606e+04 6.52979188e+02 9.62960708e+03
 2.40403481e+02 2.76159719e+03 2.61001461e+02 3.06046957e+03
 7.51843475e+02 1.14853355e+04 1.74465967e+01 1.04021424e+02
 7.16385822e+01 6.08020357e+02 8.47145267e-01 2.37100109e+00
 4.94429094e+00 2.15087125e+01 2.62364689e-01 5.47792550e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.95923931149686
cond(S) = 126910.37449000694
E1 = -728.1191599954359  E_coul = 202.96578918362383
init E= -525.153370811812
    CPU time for initialize scf      0.13 sec, wall time      0.04 sec
  HOMO = -0.557866113767417  LUMO = 1.26365445614228
  mo_energy =
[-1.18262107e+02 -1.21108493e+01 -9.43138198e+00 -9.43138198e+00
 -9.43138198e+00 -1.23508443e+00 -5.57866114e-01 -5.57866114e-01
 -5.57866114e-01  1.26365446e+00  1.26365446e+00  1.26365446e+00
  1.64940002e+01  1.64940002e+01  1.64940002e+01  9.81503458e+01
  1.10970366e+02  1.10970366e+02  1.10970366e+02  4.24342207e+02
  4.24342207e+02  4.24342207e+02  8.41916451e+02  1.09778237e+03
  1.09778237e+03  1.09778237e+03  2.33905012e+03  2.33905012e+03
  2.33905012e+03  4.58033294e+03  4.58033294e+03  4.58033294e+03
  5.23080213e+03  8.69762106e+03  8.69762106e+03  8.69762106e+03
  2.05526674e+04  7.10977045e+04]
E1 = -728.2531150096453  E_coul = 202.13469372315836
cycle= 1 E= -526.118421286487  delta_E= -0.965  |g|= 0.186  |ddm|= 1.74
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.481358
diis-c [-0.23170577  1.        ]
  HOMO = -0.550421057160404  LUMO = 1.27182414167293
  mo_energy =
[-1.18483420e+02 -1.21615552e+01 -9.48802011e+00 -9.48802011e+00
 -9.48802011e+00 -1.23169739e+00 -5.50421057e-01 -5.50421057e-01
 -5.50421057e-01  1.27182414e+00  1.27182414e+00  1.27182414e+00
  1.64441359e+01  1.64441359e+01  1.64441359e+01  9.80234397e+01
  1.10828302e+02  1.10828302e+02  1.10828302e+02  4.24142800e+02
  4.24142800e+02  4.24142800e+02  8.41611662e+02  1.09753670e+03
  1.09753670e+03  1.09753670e+03  2.33875510e+03  2.33875510e+03
  2.33875510e+03  4.57997834e+03  4.57997834e+03  4.57997834e+03
  5.23028842e+03  8.69715953e+03  8.69715953e+03  8.69715953e+03
  2.05520291e+04  7.10969761e+04]
E1 = -728.3821607178862  E_coul = 202.2634995000352
cycle= 2 E= -526.118661217851  delta_E= -0.00024  |g|= 0.0156  |ddm|= 0.00929
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0258612
diis-c [-5.13415327e-04  2.52698778e-02  9.74730122e-01]
  HOMO = -0.549673323512215  LUMO = 1.27269476146305
  mo_energy =
[-1.18458476e+02 -1.21530165e+01 -9.47934375e+00 -9.47934375e+00
 -9.47934375e+00 -1.23066644e+00 -5.49673324e-01 -5.49673324e-01
 -5.49673324e-01  1.27269476e+00  1.27269476e+00  1.27269476e+00
  1.64523218e+01  1.64523218e+01  1.64523218e+01  9.80438471e+01
  1.10846950e+02  1.10846950e+02  1.10846950e+02  4.24166664e+02
  4.24166664e+02  4.24166664e+02  8.41639155e+02  1.09756287e+03
  1.09756287e+03  1.09756287e+03  2.33878263e+03  2.33878263e+03
  2.33878263e+03  4.58000680e+03  4.58000680e+03  4.58000680e+03
  5.23031767e+03  8.69718858e+03  8.69718858e+03  8.69718858e+03
  2.05520586e+04  7.10970055e+04]
E1 = -728.3560616649829  E_coul = 202.23739707504905
cycle= 3 E= -526.118664589934  delta_E= -3.37e-06  |g|= 0.00165  |ddm|= 0.00217
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00312309
diis-c [-1.77006657e-07 -8.52778134e-04  9.98899557e-02  9.00962822e-01]
  HOMO = -0.549964820827481  LUMO = 1.27242321234591
  mo_energy =
[-1.18461426e+02 -1.21544392e+01 -9.48082523e+00 -9.48082523e+00
 -9.48082523e+00 -1.23105091e+00 -5.49964821e-01 -5.49964821e-01
 -5.49964821e-01  1.27242321e+00  1.27242321e+00  1.27242321e+00
  1.64509505e+01  1.64509505e+01  1.64509505e+01  9.80414046e+01
  1.10844575e+02  1.10844575e+02  1.10844575e+02  4.24163827e+02
  4.24163827e+02  4.24163827e+02  8.41635930e+02  1.09755980e+03
  1.09755980e+03  1.09755980e+03  2.33877941e+03  2.33877941e+03
  2.33877941e+03  4.58000345e+03  4.58000345e+03  4.58000345e+03
  5.23031412e+03  8.69718509e+03  8.69718509e+03  8.69718509e+03
  2.05520549e+04  7.10970018e+04]
E1 = -728.3598283249066  E_coul = 202.24116366752386
cycle= 4 E= -526.118664657383  delta_E= -6.74e-08  |g|= 4.11e-05  |ddm|= 0.000382
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=5.367e-05
diis-c [-9.17562962e-10  8.86645464e-06 -2.27032321e-03 -5.24555839e-03
  1.00750702e+00]
  HOMO = -0.549940677370491  LUMO = 1.27244451733313
  mo_energy =
[-1.18461329e+02 -1.21543591e+01 -9.48074535e+00 -9.48074535e+00
 -9.48074535e+00 -1.23101976e+00 -5.49940677e-01 -5.49940677e-01
 -5.49940677e-01  1.27244452e+00  1.27244452e+00  1.27244452e+00
  1.64510255e+01  1.64510255e+01  1.64510255e+01  9.80415002e+01
  1.10844667e+02  1.10844667e+02  1.10844667e+02  4.24163923e+02
  4.24163923e+02  4.24163923e+02  8.41636024e+02  1.09755990e+03
  1.09755990e+03  1.09755990e+03  2.33877950e+03  2.33877950e+03
  2.33877950e+03  4.58000354e+03  4.58000354e+03  4.58000354e+03
  5.23031421e+03  8.69718518e+03  8.69718518e+03  8.69718518e+03
  2.05520550e+04  7.10970019e+04]
E1 = -728.3596655588098  E_coul = 202.2410009013286
cycle= 5 E= -526.118664657481  delta_E= -9.85e-11  |g|= 5.29e-06  |ddm|= 2.02e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -728.3596655588098  E_coul = 202.2410009013286
  HOMO = -0.549943474677223  LUMO = 1.27244204309799
  mo_energy =
[-1.18461343e+02 -1.21543689e+01 -9.48075536e+00 -9.48075536e+00
 -9.48075536e+00 -1.23102339e+00 -5.49943475e-01 -5.49943475e-01
 -5.49943475e-01  1.27244204e+00  1.27244204e+00  1.27244204e+00
  1.64510162e+01  1.64510162e+01  1.64510162e+01  9.80414876e+01
  1.10844655e+02  1.10844655e+02  1.10844655e+02  4.24163910e+02
  4.24163910e+02  4.24163910e+02  8.41636010e+02  1.09755989e+03
  1.09755989e+03  1.09755989e+03  2.33877949e+03  2.33877949e+03
  2.33877949e+03  4.58000353e+03  4.58000353e+03  4.58000353e+03
  5.23031419e+03  8.69718516e+03  8.69718516e+03  8.69718516e+03
  2.05520550e+04  7.10970019e+04]
E1 = -728.3596870031844  E_coul = 202.241022345702
Extra cycle  E= -526.118664657482  delta_E= -1.25e-12  |g|= 1.16e-06  |ddm|= 2.57e-06
    CPU time for scf_cycle      0.28 sec, wall time      0.19 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 126910.37449000694
E1 = -728.3596870031844  E_coul = 202.241022345702
init E= -526.118664657482
    CPU time for initialize scf      1.47 sec, wall time      0.22 sec
  HOMO = -0.549943081076485  LUMO = 1.27244239866615
  mo_energy =
[-1.18461340e+02 -1.21543674e+01 -9.48075375e+00 -9.48075375e+00
 -9.48075375e+00 -1.23102288e+00 -5.49943081e-01 -5.49943081e-01
 -5.49943081e-01  1.27244240e+00  1.27244240e+00  1.27244240e+00
  1.64510177e+01  1.64510177e+01  1.64510177e+01  9.80414900e+01
  1.10844657e+02  1.10844657e+02  1.10844657e+02  4.24163912e+02
  4.24163912e+02  4.24163912e+02  8.41636013e+02  1.09755989e+03
  1.09755989e+03  1.09755989e+03  2.33877949e+03  2.33877949e+03
  2.33877949e+03  4.58000353e+03  4.58000353e+03  4.58000353e+03
  5.23031419e+03  8.69718517e+03  8.69718517e+03  8.69718517e+03
  2.05520550e+04  7.10970019e+04]
E1 = -728.3596832837515  E_coul = 202.24101862627063
cycle= 1 E= -526.118664657481  delta_E= 1.59e-12  |g|= 2.22e-07  |ddm|= 4.1e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3596832837515  E_coul = 202.24101862627063
  HOMO = -0.549943144977117  LUMO = 1.27244234047666
  mo_energy =
[-1.18461341e+02 -1.21543676e+01 -9.48075402e+00 -9.48075402e+00
 -9.48075402e+00 -1.23102296e+00 -5.49943145e-01 -5.49943145e-01
 -5.49943145e-01  1.27244234e+00  1.27244234e+00  1.27244234e+00
  1.64510174e+01  1.64510174e+01  1.64510174e+01  9.80414895e+01
  1.10844657e+02  1.10844657e+02  1.10844657e+02  4.24163912e+02
  4.24163912e+02  4.24163912e+02  8.41636012e+02  1.09755989e+03
  1.09755989e+03  1.09755989e+03  2.33877949e+03  2.33877949e+03
  2.33877949e+03  4.58000353e+03  4.58000353e+03  4.58000353e+03
  5.23031419e+03  8.69718517e+03  8.69718517e+03  8.69718517e+03
  2.05520550e+04  7.10970019e+04]
E1 = -728.3596839421401  E_coul = 202.24101928465726
Extra cycle  E= -526.118664657483  delta_E= -2.05e-12  |g|= 4.07e-08  |ddm|= 7.06e-08
    CPU time for scf_cycle      1.58 sec, wall time      0.33 sec
exp = [2.61855229e+04 7.58518586e+03 3.55251600e+03 5.92747235e+02
 1.36934821e+02 3.95003451e+01 4.60598426e+00 3.97781513e-01
 1.36281295e+03 6.52979188e+02 2.40403481e+02 2.61001461e+02
 7.51843475e+02 1.74465967e+01 7.16385822e+01 8.47145267e-01
 4.94429094e+00 2.62364689e-01]
grad_E = [ 5.37320595e-07  1.28857819e-06  5.90356535e-05  4.96754041e-04
 -4.70509215e-03  6.83694617e-03 -7.14940235e-04  5.87223687e-02
  9.44658008e-07  8.54920034e-06  7.25643296e-05  6.75752465e-05
  6.55498171e-06  2.81217569e-04  4.93042923e-03 -3.95583428e-01
  1.36892101e-02  5.10946670e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.550385         1
[INPUT] 0    0    [1    /1   ]  7584.8884339         1
[INPUT] 0    0    [1    /1   ]  3551.93074295        1
[INPUT] 0    0    [1    /1   ]  583.471875274        1
[INPUT] 0    0    [1    /1   ]  134.23753874         1
[INPUT] 0    0    [1    /1   ]  38.9771168196        1
[INPUT] 0    0    [1    /1   ]  4.61264622866        1
[INPUT] 0    0    [1    /1   ]  0.397446971728       1
[INPUT] 1    0    [1    /1   ]  1362.83426891        1
[INPUT] 1    0    [1    /1   ]  653.047065513        1
[INPUT] 1    0    [1    /1   ]  240.844079722        1
[INPUT] 1    0    [1    /1   ]  261.394849775        1
[INPUT] 1    0    [1    /1   ]  736.999593629        1
[INPUT] 1    0    [1    /1   ]  16.2106522636        1
[INPUT] 1    0    [1    /1   ]  65.5940019298        1
[INPUT] 1    0    [1    /1   ]  0.933995864987       1
[INPUT] 1    0    [1    /1   ]  4.77655588202        1
[INPUT] 1    0    [1    /1   ]  0.268105924787       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.55038499745, 1.0]], [0, [7584.88843389645, 1.0]], [0, [3551.9307429489536, 1.0]], [0, [583.4718752741101, 1.0]], [0, [134.23753874023987, 1.0]], [0, [38.97711681958081, 1.0]], [0, [4.612646228656414, 1.0]], [0, [0.39744697172807025, 1.0]], [1, [1362.8342689090684, 1.0]], [1, [653.0470655128884, 1.0]], [1, [240.84407972188527, 1.0]], [1, [261.39484977527195, 1.0]], [1, [736.9995936286363, 1.0]], [1, [16.210652263581448, 1.0]], [1, [65.59400192978079, 1.0]], [1, [0.93399586498659, 1.0]], [1, [4.776555882024029, 1.0]], [1, [0.2681059247865408, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.550385]
bas 1, expnt(s) = [7584.8884339]
bas 2, expnt(s) = [3551.93074295]
bas 3, expnt(s) = [583.47187527]
bas 4, expnt(s) = [134.23753874]
bas 5, expnt(s) = [38.97711682]
bas 6, expnt(s) = [4.61264623]
bas 7, expnt(s) = [0.39744697]
bas 8, expnt(s) = [1362.83426891]
bas 9, expnt(s) = [653.04706551]
bas 10, expnt(s) = [240.84407972]
bas 11, expnt(s) = [261.39484978]
bas 12, expnt(s) = [736.99959363]
bas 13, expnt(s) = [16.21065226]
bas 14, expnt(s) = [65.59400193]
bas 15, expnt(s) = [0.93399586]
bas 16, expnt(s) = [4.77655588]
bas 17, expnt(s) = [0.26810592]
CPU time:       633.34
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61855504e+04 5.20069403e+03 7.58488843e+03 2.05341591e+03
 3.55193074e+03 1.16242085e+03 5.83471875e+02 2.99936949e+02
 1.34237539e+02 9.96369695e+01 3.89771168e+01 3.94114404e+01
 4.61264623e+00 7.95202313e+00 3.97446972e-01 1.26466185e+00
 1.36283427e+03 2.41567330e+04 6.53047066e+02 9.63085835e+03
 2.40844080e+02 2.76792528e+03 2.61394850e+02 3.06623669e+03
 7.36999594e+02 1.12025903e+04 1.62106523e+01 9.48931809e+01
 6.55940019e+01 5.44583593e+02 9.33995865e-01 2.67864761e+00
 4.77655588e+00 2.06005100e+01 2.68105925e-01 5.62817259e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.961236767238532
cond(S) = 137004.24780338805
E1 = -728.3515965191172  E_coul = 203.10538429719
init E= -525.246212221927
    CPU time for initialize scf      0.15 sec, wall time      0.04 sec
  HOMO = -0.556798745967505  LUMO = 1.38054447056576
  mo_energy =
[-1.18249585e+02 -1.20974294e+01 -9.42577948e+00 -9.42577948e+00
 -9.42577948e+00 -1.23171114e+00 -5.56798746e-01 -5.56798746e-01
 -5.56798746e-01  1.38054447e+00  1.38054447e+00  1.38054447e+00
  1.57724198e+01  1.57724198e+01  1.57724198e+01  9.57971422e+01
  1.02431277e+02  1.02431277e+02  1.02431277e+02  4.05115388e+02
  4.05115388e+02  4.05115388e+02  8.24641250e+02  1.07296538e+03
  1.07296538e+03  1.07296538e+03  2.30866299e+03  2.30866299e+03
  2.30866299e+03  4.53621133e+03  4.53621133e+03  4.53621133e+03
  5.19121300e+03  8.63367040e+03  8.63367040e+03  8.63367040e+03
  2.05075045e+04  7.10529220e+04]
E1 = -728.2431125844072  E_coul = 202.08404364955942
cycle= 1 E= -526.159068934848  delta_E= -0.913  |g|= 0.187  |ddm|= 1.69
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.482469
diis-c [-0.23277609  1.        ]
  HOMO = -0.55691740194285  LUMO = 1.3809735984956
  mo_energy =
[-1.18486443e+02 -1.21610370e+01 -9.49414390e+00 -9.49414390e+00
 -9.49414390e+00 -1.23698629e+00 -5.56917402e-01 -5.56917402e-01
 -5.56917402e-01  1.38097360e+00  1.38097360e+00  1.38097360e+00
  1.57121662e+01  1.57121662e+01  1.57121662e+01  9.56573990e+01
  1.02279976e+02  1.02279976e+02  1.02279976e+02  4.04901479e+02
  4.04901479e+02  4.04901479e+02  8.24321650e+02  1.07270336e+03
  1.07270336e+03  1.07270336e+03  2.30835131e+03  2.30835131e+03
  2.30835131e+03  4.53583968e+03  4.53583968e+03  4.53583968e+03
  5.19068079e+03  8.63319088e+03  8.63319088e+03  8.63319088e+03
  2.05068466e+04  7.10521738e+04]
E1 = -728.4139275703678  E_coul = 202.25461778766552
cycle= 2 E= -526.159309782702  delta_E= -0.000241  |g|= 0.0173  |ddm|= 0.012
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0291728
diis-c [-6.30677166e-04  2.98898519e-02  9.70110148e-01]
  HOMO = -0.555388503087229  LUMO = 1.38271623161827
  mo_energy =
[-1.18457353e+02 -1.21494418e+01 -9.48233910e+00 -9.48233910e+00
 -9.48233910e+00 -1.23492068e+00 -5.55388503e-01 -5.55388503e-01
 -5.55388503e-01  1.38271623e+00  1.38271623e+00  1.38271623e+00
  1.57226117e+01  1.57226117e+01  1.57226117e+01  9.56814945e+01
  1.02301879e+02  1.02301879e+02  1.02301879e+02  4.04929347e+02
  4.04929347e+02  4.04929347e+02  8.24353371e+02  1.07273374e+03
  1.07273374e+03  1.07273374e+03  2.30838313e+03  2.30838313e+03
  2.30838313e+03  4.53587247e+03  4.53587247e+03  4.53587247e+03
  5.19071445e+03  8.63322431e+03  8.63322431e+03  8.63322431e+03
  2.05068805e+04  7.10522076e+04]
E1 = -728.3794949122687  E_coul = 202.22018017247996
cycle= 3 E= -526.159314739789  delta_E= -4.96e-06  |g|= 0.00201  |ddm|= 0.00297
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00377154
diis-c [-1.67135822e-07 -8.66757599e-04  1.07481463e-01  8.93385294e-01]
  HOMO = -0.555776452032877  LUMO = 1.38231860622081
  mo_energy =
[-1.18460946e+02 -1.21512660e+01 -9.48422858e+00 -9.48422858e+00
 -9.48422858e+00 -1.23543098e+00 -5.55776452e-01 -5.55776452e-01
 -5.55776452e-01  1.38231861e+00  1.38231861e+00  1.38231861e+00
  1.57209204e+01  1.57209204e+01  1.57209204e+01  9.56784945e+01
  1.02298999e+02  1.02298999e+02  1.02298999e+02  4.04925891e+02
  4.04925891e+02  4.04925891e+02  8.24349485e+02  1.07273002e+03
  1.07273002e+03  1.07273002e+03  2.30837924e+03  2.30837924e+03
  2.30837924e+03  4.53586845e+03  4.53586845e+03  4.53586845e+03
  5.19071020e+03  8.63322013e+03  8.63322013e+03  8.63322013e+03
  2.05068761e+04  7.10522032e+04]
E1 = -728.3844649278288  E_coul = 202.22515007547221
cycle= 4 E= -526.159314852357  delta_E= -1.13e-07  |g|= 4.41e-05  |ddm|= 0.000491
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.78486e-05
diis-c [-9.49926036e-10 -4.33983159e-06 -4.98311779e-04  9.33389102e-03
  9.91168761e-01]
  HOMO = -0.555751568984724  LUMO = 1.38234281027135
  mo_energy =
[-1.18460845e+02 -1.21511817e+01 -9.48414425e+00 -9.48414425e+00
 -9.48414425e+00 -1.23539860e+00 -5.55751569e-01 -5.55751569e-01
 -5.55751569e-01  1.38234281e+00  1.38234281e+00  1.38234281e+00
  1.57209975e+01  1.57209975e+01  1.57209975e+01  9.56785942e+01
  1.02299094e+02  1.02299094e+02  1.02299094e+02  4.04925991e+02
  4.04925991e+02  4.04925991e+02  8.24349582e+02  1.07273012e+03
  1.07273012e+03  1.07273012e+03  2.30837934e+03  2.30837934e+03
  2.30837934e+03  4.53586854e+03  4.53586854e+03  4.53586854e+03
  5.19071029e+03  8.63322023e+03  8.63322023e+03  8.63322023e+03
  2.05068762e+04  7.10522033e+04]
E1 = -728.3842798786615  E_coul = 202.2249650261781
cycle= 5 E= -526.159314852483  delta_E= -1.27e-10  |g|= 5.3e-06  |ddm|= 2.21e-05
    CPU time for cycle= 5      0.06 sec, wall time      0.06 sec
E1 = -728.3842798786615  E_coul = 202.2249650261781
  HOMO = -0.555754149722121  LUMO = 1.38234028146187
  mo_energy =
[-1.18460858e+02 -1.21511910e+01 -9.48415380e+00 -9.48415380e+00
 -9.48415380e+00 -1.23540197e+00 -5.55754150e-01 -5.55754150e-01
 -5.55754150e-01  1.38234028e+00  1.38234028e+00  1.38234028e+00
  1.57209889e+01  1.57209889e+01  1.57209889e+01  9.56785821e+01
  1.02299082e+02  1.02299082e+02  1.02299082e+02  4.04925979e+02
  4.04925979e+02  4.04925979e+02  8.24349569e+02  1.07273011e+03
  1.07273011e+03  1.07273011e+03  2.30837932e+03  2.30837932e+03
  2.30837932e+03  4.53586853e+03  4.53586853e+03  4.53586853e+03
  5.19071028e+03  8.63322021e+03  8.63322021e+03  8.63322021e+03
  2.05068762e+04  7.10522033e+04]
E1 = -728.3843020359991  E_coul = 202.2249871835124
Extra cycle  E= -526.159314852487  delta_E= -3.3e-12  |g|= 1.22e-06  |ddm|= 2.52e-06
    CPU time for scf_cycle      0.37 sec, wall time      0.26 sec
exp = [2.61855504e+04 7.58488843e+03 3.55193074e+03 5.83471875e+02
 1.34237539e+02 3.89771168e+01 4.61264623e+00 3.97446972e-01
 1.36283427e+03 6.53047066e+02 2.40844080e+02 2.61394850e+02
 7.36999594e+02 1.62106523e+01 6.55940019e+01 9.33995865e-01
 4.77655588e+00 2.68105925e-01]
E = -526.1593148524867
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.550385         1
[INPUT] 0    0    [1    /1   ]  7584.8884339         1
[INPUT] 0    0    [1    /1   ]  3551.93074295        1
[INPUT] 0    0    [1    /1   ]  583.471875274        1
[INPUT] 0    0    [1    /1   ]  134.23753874         1
[INPUT] 0    0    [1    /1   ]  38.9771168196        1
[INPUT] 0    0    [1    /1   ]  4.61264622866        1
[INPUT] 0    0    [1    /1   ]  0.397446971728       1
[INPUT] 1    0    [1    /1   ]  1362.83426891        1
[INPUT] 1    0    [1    /1   ]  653.047065513        1
[INPUT] 1    0    [1    /1   ]  240.844079722        1
[INPUT] 1    0    [1    /1   ]  261.394849775        1
[INPUT] 1    0    [1    /1   ]  736.999593629        1
[INPUT] 1    0    [1    /1   ]  16.2106522636        1
[INPUT] 1    0    [1    /1   ]  65.5940019298        1
[INPUT] 1    0    [1    /1   ]  0.933995864987       1
[INPUT] 1    0    [1    /1   ]  4.77655588202        1
[INPUT] 1    0    [1    /1   ]  0.268105924787       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.55038499745, 1.0]], [0, [7584.88843389645, 1.0]], [0, [3551.9307429489536, 1.0]], [0, [583.4718752741101, 1.0]], [0, [134.23753874023987, 1.0]], [0, [38.97711681958081, 1.0]], [0, [4.612646228656414, 1.0]], [0, [0.39744697172807025, 1.0]], [1, [1362.8342689090684, 1.0]], [1, [653.0470655128884, 1.0]], [1, [240.84407972188527, 1.0]], [1, [261.39484977527195, 1.0]], [1, [736.9995936286363, 1.0]], [1, [16.210652263581448, 1.0]], [1, [65.59400192978079, 1.0]], [1, [0.93399586498659, 1.0]], [1, [4.776555882024029, 1.0]], [1, [0.2681059247865408, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.550385]
bas 1, expnt(s) = [7584.8884339]
bas 2, expnt(s) = [3551.93074295]
bas 3, expnt(s) = [583.47187527]
bas 4, expnt(s) = [134.23753874]
bas 5, expnt(s) = [38.97711682]
bas 6, expnt(s) = [4.61264623]
bas 7, expnt(s) = [0.39744697]
bas 8, expnt(s) = [1362.83426891]
bas 9, expnt(s) = [653.04706551]
bas 10, expnt(s) = [240.84407972]
bas 11, expnt(s) = [261.39484978]
bas 12, expnt(s) = [736.99959363]
bas 13, expnt(s) = [16.21065226]
bas 14, expnt(s) = [65.59400193]
bas 15, expnt(s) = [0.93399586]
bas 16, expnt(s) = [4.77655588]
bas 17, expnt(s) = [0.26810592]
CPU time:       634.09
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61855504e+04 5.20069403e+03 7.58488843e+03 2.05341591e+03
 3.55193074e+03 1.16242085e+03 5.83471875e+02 2.99936949e+02
 1.34237539e+02 9.96369695e+01 3.89771168e+01 3.94114404e+01
 4.61264623e+00 7.95202313e+00 3.97446972e-01 1.26466185e+00
 1.36283427e+03 2.41567330e+04 6.53047066e+02 9.63085835e+03
 2.40844080e+02 2.76792528e+03 2.61394850e+02 3.06623669e+03
 7.36999594e+02 1.12025903e+04 1.62106523e+01 9.48931809e+01
 6.55940019e+01 5.44583593e+02 9.33995865e-01 2.67864761e+00
 4.77655588e+00 2.06005100e+01 2.68105925e-01 5.62817259e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.961236767238532
cond(S) = 137004.24780338805
E1 = -728.3515965191172  E_coul = 203.10538429719
init E= -525.246212221927
    CPU time for initialize scf      0.15 sec, wall time      0.04 sec
  HOMO = -0.556798745967505  LUMO = 1.38054447056576
  mo_energy =
[-1.18249585e+02 -1.20974294e+01 -9.42577948e+00 -9.42577948e+00
 -9.42577948e+00 -1.23171114e+00 -5.56798746e-01 -5.56798746e-01
 -5.56798746e-01  1.38054447e+00  1.38054447e+00  1.38054447e+00
  1.57724198e+01  1.57724198e+01  1.57724198e+01  9.57971422e+01
  1.02431277e+02  1.02431277e+02  1.02431277e+02  4.05115388e+02
  4.05115388e+02  4.05115388e+02  8.24641250e+02  1.07296538e+03
  1.07296538e+03  1.07296538e+03  2.30866299e+03  2.30866299e+03
  2.30866299e+03  4.53621133e+03  4.53621133e+03  4.53621133e+03
  5.19121300e+03  8.63367040e+03  8.63367040e+03  8.63367040e+03
  2.05075045e+04  7.10529220e+04]
E1 = -728.2431125844072  E_coul = 202.08404364955942
cycle= 1 E= -526.159068934848  delta_E= -0.913  |g|= 0.187  |ddm|= 1.69
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.482469
diis-c [-0.23277609  1.        ]
  HOMO = -0.55691740194285  LUMO = 1.3809735984956
  mo_energy =
[-1.18486443e+02 -1.21610370e+01 -9.49414390e+00 -9.49414390e+00
 -9.49414390e+00 -1.23698629e+00 -5.56917402e-01 -5.56917402e-01
 -5.56917402e-01  1.38097360e+00  1.38097360e+00  1.38097360e+00
  1.57121662e+01  1.57121662e+01  1.57121662e+01  9.56573990e+01
  1.02279976e+02  1.02279976e+02  1.02279976e+02  4.04901479e+02
  4.04901479e+02  4.04901479e+02  8.24321650e+02  1.07270336e+03
  1.07270336e+03  1.07270336e+03  2.30835131e+03  2.30835131e+03
  2.30835131e+03  4.53583968e+03  4.53583968e+03  4.53583968e+03
  5.19068079e+03  8.63319088e+03  8.63319088e+03  8.63319088e+03
  2.05068466e+04  7.10521738e+04]
E1 = -728.4139275703678  E_coul = 202.25461778766552
cycle= 2 E= -526.159309782702  delta_E= -0.000241  |g|= 0.0173  |ddm|= 0.012
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0291728
diis-c [-6.30677166e-04  2.98898519e-02  9.70110148e-01]
  HOMO = -0.555388503087229  LUMO = 1.38271623161827
  mo_energy =
[-1.18457353e+02 -1.21494418e+01 -9.48233910e+00 -9.48233910e+00
 -9.48233910e+00 -1.23492068e+00 -5.55388503e-01 -5.55388503e-01
 -5.55388503e-01  1.38271623e+00  1.38271623e+00  1.38271623e+00
  1.57226117e+01  1.57226117e+01  1.57226117e+01  9.56814945e+01
  1.02301879e+02  1.02301879e+02  1.02301879e+02  4.04929347e+02
  4.04929347e+02  4.04929347e+02  8.24353371e+02  1.07273374e+03
  1.07273374e+03  1.07273374e+03  2.30838313e+03  2.30838313e+03
  2.30838313e+03  4.53587247e+03  4.53587247e+03  4.53587247e+03
  5.19071445e+03  8.63322431e+03  8.63322431e+03  8.63322431e+03
  2.05068805e+04  7.10522076e+04]
E1 = -728.3794949122687  E_coul = 202.22018017247996
cycle= 3 E= -526.159314739789  delta_E= -4.96e-06  |g|= 0.00201  |ddm|= 0.00297
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00377154
diis-c [-1.67135822e-07 -8.66757599e-04  1.07481463e-01  8.93385294e-01]
  HOMO = -0.555776452032877  LUMO = 1.38231860622081
  mo_energy =
[-1.18460946e+02 -1.21512660e+01 -9.48422858e+00 -9.48422858e+00
 -9.48422858e+00 -1.23543098e+00 -5.55776452e-01 -5.55776452e-01
 -5.55776452e-01  1.38231861e+00  1.38231861e+00  1.38231861e+00
  1.57209204e+01  1.57209204e+01  1.57209204e+01  9.56784945e+01
  1.02298999e+02  1.02298999e+02  1.02298999e+02  4.04925891e+02
  4.04925891e+02  4.04925891e+02  8.24349485e+02  1.07273002e+03
  1.07273002e+03  1.07273002e+03  2.30837924e+03  2.30837924e+03
  2.30837924e+03  4.53586845e+03  4.53586845e+03  4.53586845e+03
  5.19071020e+03  8.63322013e+03  8.63322013e+03  8.63322013e+03
  2.05068761e+04  7.10522032e+04]
E1 = -728.3844649278288  E_coul = 202.22515007547221
cycle= 4 E= -526.159314852357  delta_E= -1.13e-07  |g|= 4.41e-05  |ddm|= 0.000491
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.78486e-05
diis-c [-9.49926036e-10 -4.33983159e-06 -4.98311779e-04  9.33389102e-03
  9.91168761e-01]
  HOMO = -0.555751568984724  LUMO = 1.38234281027135
  mo_energy =
[-1.18460845e+02 -1.21511817e+01 -9.48414425e+00 -9.48414425e+00
 -9.48414425e+00 -1.23539860e+00 -5.55751569e-01 -5.55751569e-01
 -5.55751569e-01  1.38234281e+00  1.38234281e+00  1.38234281e+00
  1.57209975e+01  1.57209975e+01  1.57209975e+01  9.56785942e+01
  1.02299094e+02  1.02299094e+02  1.02299094e+02  4.04925991e+02
  4.04925991e+02  4.04925991e+02  8.24349582e+02  1.07273012e+03
  1.07273012e+03  1.07273012e+03  2.30837934e+03  2.30837934e+03
  2.30837934e+03  4.53586854e+03  4.53586854e+03  4.53586854e+03
  5.19071029e+03  8.63322023e+03  8.63322023e+03  8.63322023e+03
  2.05068762e+04  7.10522033e+04]
E1 = -728.3842798786615  E_coul = 202.2249650261781
cycle= 5 E= -526.159314852483  delta_E= -1.27e-10  |g|= 5.3e-06  |ddm|= 2.21e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3842798786615  E_coul = 202.2249650261781
  HOMO = -0.555754149722121  LUMO = 1.38234028146187
  mo_energy =
[-1.18460858e+02 -1.21511910e+01 -9.48415380e+00 -9.48415380e+00
 -9.48415380e+00 -1.23540197e+00 -5.55754150e-01 -5.55754150e-01
 -5.55754150e-01  1.38234028e+00  1.38234028e+00  1.38234028e+00
  1.57209889e+01  1.57209889e+01  1.57209889e+01  9.56785821e+01
  1.02299082e+02  1.02299082e+02  1.02299082e+02  4.04925979e+02
  4.04925979e+02  4.04925979e+02  8.24349569e+02  1.07273011e+03
  1.07273011e+03  1.07273011e+03  2.30837932e+03  2.30837932e+03
  2.30837932e+03  4.53586853e+03  4.53586853e+03  4.53586853e+03
  5.19071028e+03  8.63322021e+03  8.63322021e+03  8.63322021e+03
  2.05068762e+04  7.10522033e+04]
E1 = -728.3843020359991  E_coul = 202.2249871835124
Extra cycle  E= -526.159314852487  delta_E= -3.3e-12  |g|= 1.22e-06  |ddm|= 2.52e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 137004.24780338805
E1 = -728.3843020359991  E_coul = 202.2249871835124
init E= -526.159314852487
    CPU time for initialize scf      1.07 sec, wall time      0.20 sec
  HOMO = -0.555753750748617  LUMO = 1.38234068067121
  mo_energy =
[-1.18460855e+02 -1.21511894e+01 -9.48415213e+00 -9.48415213e+00
 -9.48415213e+00 -1.23540145e+00 -5.55753751e-01 -5.55753751e-01
 -5.55753751e-01  1.38234068e+00  1.38234068e+00  1.38234068e+00
  1.57209904e+01  1.57209904e+01  1.57209904e+01  9.56785845e+01
  1.02299084e+02  1.02299084e+02  1.02299084e+02  4.04925981e+02
  4.04925981e+02  4.04925981e+02  8.24349572e+02  1.07273011e+03
  1.07273011e+03  1.07273011e+03  2.30837933e+03  2.30837933e+03
  2.30837933e+03  4.53586853e+03  4.53586853e+03  4.53586853e+03
  5.19071028e+03  8.63322022e+03  8.63322022e+03  8.63322022e+03
  2.05068762e+04  7.10522033e+04]
E1 = -728.384297926625  E_coul = 202.22498307413923
cycle= 1 E= -526.159314852486  delta_E= 9.09e-13  |g|= 2.46e-07  |ddm|= 4.34e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.384297926625  E_coul = 202.22498307413923
  HOMO = -0.555753820587284  LUMO = 1.38234061025009
  mo_energy =
[-1.18460856e+02 -1.21511897e+01 -9.48415244e+00 -9.48415244e+00
 -9.48415244e+00 -1.23540154e+00 -5.55753821e-01 -5.55753821e-01
 -5.55753821e-01  1.38234061e+00  1.38234061e+00  1.38234061e+00
  1.57209901e+01  1.57209901e+01  1.57209901e+01  9.56785840e+01
  1.02299084e+02  1.02299084e+02  1.02299084e+02  4.04925981e+02
  4.04925981e+02  4.04925981e+02  8.24349571e+02  1.07273011e+03
  1.07273011e+03  1.07273011e+03  2.30837933e+03  2.30837933e+03
  2.30837933e+03  4.53586853e+03  4.53586853e+03  4.53586853e+03
  5.19071028e+03  8.63322022e+03  8.63322022e+03  8.63322022e+03
  2.05068762e+04  7.10522033e+04]
E1 = -728.3842987008537  E_coul = 202.22498384836862
Extra cycle  E= -526.159314852485  delta_E= 6.82e-13  |g|= 4.77e-08  |ddm|= 7.98e-08
    CPU time for scf_cycle      1.18 sec, wall time      0.31 sec
exp = [2.61855504e+04 7.58488843e+03 3.55193074e+03 5.83471875e+02
 1.34237539e+02 3.89771168e+01 4.61264623e+00 3.97446972e-01
 1.36283427e+03 6.53047066e+02 2.40844080e+02 2.61394850e+02
 7.36999594e+02 1.62106523e+01 6.55940019e+01 9.33995865e-01
 4.77655588e+00 2.68105925e-01]
grad_E = [ 6.24798103e-07  1.55699893e-06  6.34564732e-05  5.48444120e-04
 -5.55186680e-03  7.18703135e-03  5.53468461e-03  5.27637194e-02
  8.16987257e-07  8.00246701e-06  6.19843643e-05  6.00173145e-05
  6.40264390e-06 -2.83094459e-02  7.63354204e-03 -1.37855199e-01
  4.38043704e-02  1.62313190e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.5929248        1
[INPUT] 0    0    [1    /1   ]  7584.43443706        1
[INPUT] 0    0    [1    /1   ]  3551.04950094        1
[INPUT] 0    0    [1    /1   ]  569.113897486        1
[INPUT] 0    0    [1    /1   ]  128.485590188        1
[INPUT] 0    0    [1    /1   ]  37.8627705576        1
[INPUT] 0    0    [1    /1   ]  4.62650762885        1
[INPUT] 0    0    [1    /1   ]  0.39748662402        1
[INPUT] 1    0    [1    /1   ]  1362.91409954        1
[INPUT] 1    0    [1    /1   ]  653.55011598         1
[INPUT] 1    0    [1    /1   ]  243.777068651        1
[INPUT] 1    0    [1    /1   ]  263.992663436        1
[INPUT] 1    0    [1    /1   ]  667.717889123        1
[INPUT] 1    0    [1    /1   ]  11.8738672461        1
[INPUT] 1    0    [1    /1   ]  37.9267673752        1
[INPUT] 1    0    [1    /1   ]  0.868610025605       1
[INPUT] 1    0    [1    /1   ]  4.02470464153        1
[INPUT] 1    0    [1    /1   ]  0.239464822986       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.59292479186, 1.0]], [0, [7584.434437058727, 1.0]], [0, [3551.049500944515, 1.0]], [0, [569.113897485635, 1.0]], [0, [128.4855901880172, 1.0]], [0, [37.86277055757597, 1.0]], [0, [4.6265076288500095, 1.0]], [0, [0.3974866240197045, 1.0]], [1, [1362.9140995445011, 1.0]], [1, [653.5501159795629, 1.0]], [1, [243.77706865071227, 1.0]], [1, [263.9926634359712, 1.0]], [1, [667.7178891234323, 1.0]], [1, [11.87386724614215, 1.0]], [1, [37.92676737521353, 1.0]], [1, [0.8686100256050582, 1.0]], [1, [4.024704641527147, 1.0]], [1, [0.23946482298583724, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.59292479]
bas 1, expnt(s) = [7584.43443706]
bas 2, expnt(s) = [3551.04950094]
bas 3, expnt(s) = [569.11389749]
bas 4, expnt(s) = [128.48559019]
bas 5, expnt(s) = [37.86277056]
bas 6, expnt(s) = [4.62650763]
bas 7, expnt(s) = [0.39748662]
bas 8, expnt(s) = [1362.91409954]
bas 9, expnt(s) = [653.55011598]
bas 10, expnt(s) = [243.77706865]
bas 11, expnt(s) = [263.99266344]
bas 12, expnt(s) = [667.71788912]
bas 13, expnt(s) = [11.87386725]
bas 14, expnt(s) = [37.92676738]
bas 15, expnt(s) = [0.86861003]
bas 16, expnt(s) = [4.02470464]
bas 17, expnt(s) = [0.23946482]
CPU time:       639.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61855929e+04 5.20070037e+03 7.58443444e+03 2.05332373e+03
 3.55104950e+03 1.16220454e+03 5.69113897e+02 2.94384146e+02
 1.28485590e+02 9.64174946e+01 3.78627706e+01 3.85633111e+01
 4.62650763e+00 7.96993879e+00 3.97486624e-01 1.26475648e+00
 1.36291410e+03 2.41585018e+04 6.53550116e+02 9.64013271e+03
 2.43777069e+02 2.81012382e+03 2.63992663e+02 3.10437527e+03
 6.67717889e+02 9.90206236e+03 1.18738672e+01 6.43020219e+01
 3.79267674e+01 2.74578594e+02 8.68610026e-01 2.44633224e+00
 4.02470464e+00 1.66303700e+01 2.39464823e-01 4.88693485e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.970984401747863
cond(S) = 2111575.4817697047
E1 = -728.6052159882902  E_coul = 203.16333512904833
init E= -525.441880859242
    CPU time for initialize scf      0.66 sec, wall time      0.08 sec
  HOMO = -0.557763048138419  LUMO = 1.18930549426445
  mo_energy =
[-1.18233913e+02 -1.20918543e+01 -9.43585550e+00 -9.43585550e+00
 -9.43585550e+00 -1.23019023e+00 -5.57763048e-01 -5.57763048e-01
 -5.57763048e-01  1.18930549e+00  1.18930549e+00  1.18930549e+00
  1.17902259e+01  1.17902259e+01  1.17902259e+01  6.39331927e+01
  6.39331927e+01  6.39331927e+01  9.08142373e+01  3.12659720e+02
  3.12659720e+02  3.12659720e+02  7.92249832e+02  9.61927199e+02
  9.61927199e+02  9.61927199e+02  2.17535940e+03  2.17535940e+03
  2.17535940e+03  4.33952679e+03  4.33952679e+03  4.33952679e+03
  5.12322904e+03  8.34785742e+03  8.34785742e+03  8.34785742e+03
  2.04315172e+04  7.09780853e+04]
E1 = -727.9156837801514  E_coul = 201.67864397099447
cycle= 1 E= -526.237039809157  delta_E= -0.795  |g|= 0.185  |ddm|= 4.89
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.477514
diis-c [-0.22801992  1.        ]
  HOMO = -0.572202648046082  LUMO = 1.17839831440293
  mo_energy =
[-1.18505903e+02 -1.21904018e+01 -9.53781677e+00 -9.53781677e+00
 -9.53781677e+00 -1.25302065e+00 -5.72202648e-01 -5.72202648e-01
 -5.72202648e-01  1.17839831e+00  1.17839831e+00  1.17839831e+00
  1.17127871e+01  1.17127871e+01  1.17127871e+01  6.37804263e+01
  6.37804263e+01  6.37804263e+01  9.06405936e+01  3.12412223e+02
  3.12412223e+02  3.12412223e+02  7.91896307e+02  9.61628465e+02
  9.61628465e+02  9.61628465e+02  2.17501154e+03  2.17501154e+03
  2.17501154e+03  4.33911853e+03  4.33911853e+03  4.33911853e+03
  5.12265405e+03  8.34733812e+03  8.34733812e+03  8.34733812e+03
  2.04308146e+04  7.09772917e+04]
E1 = -728.1826077238265  E_coul = 201.94525912456206
cycle= 2 E= -526.237348599264  delta_E= -0.000309  |g|= 0.0212  |ddm|= 0.0284
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0365075
diis-c [-9.34348251e-04  4.02039664e-02  9.59796034e-01]
  HOMO = -0.568782529338748  LUMO = 1.18156427303723
  mo_energy =
[-1.18467406e+02 -1.21720024e+01 -9.51906453e+00 -9.51906453e+00
 -9.51906453e+00 -1.24846184e+00 -5.68782529e-01 -5.68782529e-01
 -5.68782529e-01  1.18156427e+00  1.18156427e+00  1.18156427e+00
  1.17268129e+01  1.17268129e+01  1.17268129e+01  6.38064528e+01
  6.38064528e+01  6.38064528e+01  9.06728976e+01  3.12448947e+02
  3.12448947e+02  3.12448947e+02  7.91937603e+02  9.61668508e+02
  9.61668508e+02  9.61668508e+02  2.17505311e+03  2.17505311e+03
  2.17505311e+03  4.33916114e+03  4.33916114e+03  4.33916114e+03
  5.12269765e+03  8.34738147e+03  8.34738147e+03  8.34738147e+03
  2.04308585e+04  7.09773356e+04]
E1 = -728.1285553784401  E_coul = 201.89119657136413
cycle= 3 E= -526.237358807076  delta_E= -1.02e-05  |g|= 0.00273  |ddm|= 0.00567
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00507076
diis-c [-1.71122903e-07 -9.18957576e-04  1.16129477e-01  8.84789481e-01]
  HOMO = -0.569394952424089  LUMO = 1.18101662324569
  mo_energy =
[-1.18472306e+02 -1.21746637e+01 -9.52180811e+00 -9.52180811e+00
 -9.52180811e+00 -1.24926603e+00 -5.69394952e-01 -5.69394952e-01
 -5.69394952e-01  1.18101662e+00  1.18101662e+00  1.18101662e+00
  1.17246738e+01  1.17246738e+01  1.17246738e+01  6.38029207e+01
  6.38029207e+01  6.38029207e+01  9.06687765e+01  3.12444255e+02
  3.12444255e+02  3.12444255e+02  7.91932372e+02  9.61663447e+02
  9.61663447e+02  9.61663447e+02  2.17504785e+03  2.17504785e+03
  2.17504785e+03  4.33915573e+03  4.33915573e+03  4.33915573e+03
  5.12269199e+03  8.34737588e+03  8.34737588e+03  8.34737588e+03
  2.04308527e+04  7.09773298e+04]
E1 = -728.1361315176472  E_coul = 201.89877246543242
cycle= 4 E= -526.237359052215  delta_E= -2.45e-07  |g|= 4.02e-05  |ddm|= 0.000848
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.30603e-05
diis-c [-9.94848136e-10 -6.03606358e-06 -2.28968392e-04  7.01884462e-03
  9.93216160e-01]
  HOMO = -0.569370050617306  LUMO = 1.18103812657559
  mo_energy =
[-1.18472214e+02 -1.21745832e+01 -9.52172776e+00 -9.52172776e+00
 -9.52172776e+00 -1.24923356e+00 -5.69370051e-01 -5.69370051e-01
 -5.69370051e-01  1.18103813e+00  1.18103813e+00  1.18103813e+00
  1.17247420e+01  1.17247420e+01  1.17247420e+01  6.38030055e+01
  6.38030055e+01  6.38030055e+01  9.06688682e+01  3.12444346e+02
  3.12444346e+02  3.12444346e+02  7.91932460e+02  9.61663538e+02
  9.61663538e+02  9.61663538e+02  2.17504794e+03  2.17504794e+03
  2.17504794e+03  4.33915582e+03  4.33915582e+03  4.33915582e+03
  5.12269207e+03  8.34737597e+03  8.34737597e+03  8.34737597e+03
  2.04308528e+04  7.09773299e+04]
E1 = -728.1359395068857  E_coul = 201.89858045454366
cycle= 5 E= -526.237359052342  delta_E= -1.27e-10  |g|= 5.32e-06  |ddm|= 2.43e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.1359395068857  E_coul = 201.89858045454366
  HOMO = -0.56937283333278  LUMO = 1.18103571059579
  mo_energy =
[-1.18472228e+02 -1.21745929e+01 -9.52173766e+00 -9.52173766e+00
 -9.52173766e+00 -1.24923720e+00 -5.69372833e-01 -5.69372833e-01
 -5.69372833e-01  1.18103571e+00  1.18103571e+00  1.18103571e+00
  1.17247339e+01  1.17247339e+01  1.17247339e+01  6.38029943e+01
  6.38029943e+01  6.38029943e+01  9.06688560e+01  3.12444333e+02
  3.12444333e+02  3.12444333e+02  7.91932447e+02  9.61663524e+02
  9.61663524e+02  9.61663524e+02  2.17504793e+03  2.17504793e+03
  2.17504793e+03  4.33915580e+03  4.33915580e+03  4.33915580e+03
  5.12269206e+03  8.34737595e+03  8.34737595e+03  8.34737595e+03
  2.04308528e+04  7.09773298e+04]
E1 = -728.1359645113222  E_coul = 201.89860545897758
Extra cycle  E= -526.237359052345  delta_E= -2.5e-12  |g|= 1.33e-06  |ddm|= 3.07e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.25 sec
exp = [2.61855929e+04 7.58443444e+03 3.55104950e+03 5.69113897e+02
 1.28485590e+02 3.78627706e+01 4.62650763e+00 3.97486624e-01
 1.36291410e+03 6.53550116e+02 2.43777069e+02 2.63992663e+02
 6.67717889e+02 1.18738672e+01 3.79267674e+01 8.68610026e-01
 4.02470464e+00 2.39464823e-01]
E = -526.2373590523446
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.5929248        1
[INPUT] 0    0    [1    /1   ]  7584.43443706        1
[INPUT] 0    0    [1    /1   ]  3551.04950094        1
[INPUT] 0    0    [1    /1   ]  569.113897486        1
[INPUT] 0    0    [1    /1   ]  128.485590188        1
[INPUT] 0    0    [1    /1   ]  37.8627705576        1
[INPUT] 0    0    [1    /1   ]  4.62650762885        1
[INPUT] 0    0    [1    /1   ]  0.39748662402        1
[INPUT] 1    0    [1    /1   ]  1362.91409954        1
[INPUT] 1    0    [1    /1   ]  653.55011598         1
[INPUT] 1    0    [1    /1   ]  243.777068651        1
[INPUT] 1    0    [1    /1   ]  263.992663436        1
[INPUT] 1    0    [1    /1   ]  667.717889123        1
[INPUT] 1    0    [1    /1   ]  11.8738672461        1
[INPUT] 1    0    [1    /1   ]  37.9267673752        1
[INPUT] 1    0    [1    /1   ]  0.868610025605       1
[INPUT] 1    0    [1    /1   ]  4.02470464153        1
[INPUT] 1    0    [1    /1   ]  0.239464822986       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.59292479186, 1.0]], [0, [7584.434437058727, 1.0]], [0, [3551.049500944515, 1.0]], [0, [569.113897485635, 1.0]], [0, [128.4855901880172, 1.0]], [0, [37.86277055757597, 1.0]], [0, [4.6265076288500095, 1.0]], [0, [0.3974866240197045, 1.0]], [1, [1362.9140995445011, 1.0]], [1, [653.5501159795629, 1.0]], [1, [243.77706865071227, 1.0]], [1, [263.9926634359712, 1.0]], [1, [667.7178891234323, 1.0]], [1, [11.87386724614215, 1.0]], [1, [37.92676737521353, 1.0]], [1, [0.8686100256050582, 1.0]], [1, [4.024704641527147, 1.0]], [1, [0.23946482298583724, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.59292479]
bas 1, expnt(s) = [7584.43443706]
bas 2, expnt(s) = [3551.04950094]
bas 3, expnt(s) = [569.11389749]
bas 4, expnt(s) = [128.48559019]
bas 5, expnt(s) = [37.86277056]
bas 6, expnt(s) = [4.62650763]
bas 7, expnt(s) = [0.39748662]
bas 8, expnt(s) = [1362.91409954]
bas 9, expnt(s) = [653.55011598]
bas 10, expnt(s) = [243.77706865]
bas 11, expnt(s) = [263.99266344]
bas 12, expnt(s) = [667.71788912]
bas 13, expnt(s) = [11.87386725]
bas 14, expnt(s) = [37.92676738]
bas 15, expnt(s) = [0.86861003]
bas 16, expnt(s) = [4.02470464]
bas 17, expnt(s) = [0.23946482]
CPU time:       641.20
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61855929e+04 5.20070037e+03 7.58443444e+03 2.05332373e+03
 3.55104950e+03 1.16220454e+03 5.69113897e+02 2.94384146e+02
 1.28485590e+02 9.64174946e+01 3.78627706e+01 3.85633111e+01
 4.62650763e+00 7.96993879e+00 3.97486624e-01 1.26475648e+00
 1.36291410e+03 2.41585018e+04 6.53550116e+02 9.64013271e+03
 2.43777069e+02 2.81012382e+03 2.63992663e+02 3.10437527e+03
 6.67717889e+02 9.90206236e+03 1.18738672e+01 6.43020219e+01
 3.79267674e+01 2.74578594e+02 8.68610026e-01 2.44633224e+00
 4.02470464e+00 1.66303700e+01 2.39464823e-01 4.88693485e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.970984401747863
cond(S) = 2111575.4817697047
E1 = -728.6052159882902  E_coul = 203.16333512904833
init E= -525.441880859242
    CPU time for initialize scf      0.19 sec, wall time      0.05 sec
  HOMO = -0.557763048138419  LUMO = 1.18930549426445
  mo_energy =
[-1.18233913e+02 -1.20918543e+01 -9.43585550e+00 -9.43585550e+00
 -9.43585550e+00 -1.23019023e+00 -5.57763048e-01 -5.57763048e-01
 -5.57763048e-01  1.18930549e+00  1.18930549e+00  1.18930549e+00
  1.17902259e+01  1.17902259e+01  1.17902259e+01  6.39331927e+01
  6.39331927e+01  6.39331927e+01  9.08142373e+01  3.12659720e+02
  3.12659720e+02  3.12659720e+02  7.92249832e+02  9.61927199e+02
  9.61927199e+02  9.61927199e+02  2.17535940e+03  2.17535940e+03
  2.17535940e+03  4.33952679e+03  4.33952679e+03  4.33952679e+03
  5.12322904e+03  8.34785742e+03  8.34785742e+03  8.34785742e+03
  2.04315172e+04  7.09780853e+04]
E1 = -727.9156837801514  E_coul = 201.67864397099447
cycle= 1 E= -526.237039809157  delta_E= -0.795  |g|= 0.185  |ddm|= 4.89
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.477514
diis-c [-0.22801992  1.        ]
  HOMO = -0.572202648046082  LUMO = 1.17839831440293
  mo_energy =
[-1.18505903e+02 -1.21904018e+01 -9.53781677e+00 -9.53781677e+00
 -9.53781677e+00 -1.25302065e+00 -5.72202648e-01 -5.72202648e-01
 -5.72202648e-01  1.17839831e+00  1.17839831e+00  1.17839831e+00
  1.17127871e+01  1.17127871e+01  1.17127871e+01  6.37804263e+01
  6.37804263e+01  6.37804263e+01  9.06405936e+01  3.12412223e+02
  3.12412223e+02  3.12412223e+02  7.91896307e+02  9.61628465e+02
  9.61628465e+02  9.61628465e+02  2.17501154e+03  2.17501154e+03
  2.17501154e+03  4.33911853e+03  4.33911853e+03  4.33911853e+03
  5.12265405e+03  8.34733812e+03  8.34733812e+03  8.34733812e+03
  2.04308146e+04  7.09772917e+04]
E1 = -728.1826077238265  E_coul = 201.94525912456206
cycle= 2 E= -526.237348599264  delta_E= -0.000309  |g|= 0.0212  |ddm|= 0.0284
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0365075
diis-c [-9.34348251e-04  4.02039664e-02  9.59796034e-01]
  HOMO = -0.568782529338748  LUMO = 1.18156427303723
  mo_energy =
[-1.18467406e+02 -1.21720024e+01 -9.51906453e+00 -9.51906453e+00
 -9.51906453e+00 -1.24846184e+00 -5.68782529e-01 -5.68782529e-01
 -5.68782529e-01  1.18156427e+00  1.18156427e+00  1.18156427e+00
  1.17268129e+01  1.17268129e+01  1.17268129e+01  6.38064528e+01
  6.38064528e+01  6.38064528e+01  9.06728976e+01  3.12448947e+02
  3.12448947e+02  3.12448947e+02  7.91937603e+02  9.61668508e+02
  9.61668508e+02  9.61668508e+02  2.17505311e+03  2.17505311e+03
  2.17505311e+03  4.33916114e+03  4.33916114e+03  4.33916114e+03
  5.12269765e+03  8.34738147e+03  8.34738147e+03  8.34738147e+03
  2.04308585e+04  7.09773356e+04]
E1 = -728.1285553784401  E_coul = 201.89119657136413
cycle= 3 E= -526.237358807076  delta_E= -1.02e-05  |g|= 0.00273  |ddm|= 0.00567
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00507076
diis-c [-1.71122903e-07 -9.18957576e-04  1.16129477e-01  8.84789481e-01]
  HOMO = -0.569394952424089  LUMO = 1.18101662324569
  mo_energy =
[-1.18472306e+02 -1.21746637e+01 -9.52180811e+00 -9.52180811e+00
 -9.52180811e+00 -1.24926603e+00 -5.69394952e-01 -5.69394952e-01
 -5.69394952e-01  1.18101662e+00  1.18101662e+00  1.18101662e+00
  1.17246738e+01  1.17246738e+01  1.17246738e+01  6.38029207e+01
  6.38029207e+01  6.38029207e+01  9.06687765e+01  3.12444255e+02
  3.12444255e+02  3.12444255e+02  7.91932372e+02  9.61663447e+02
  9.61663447e+02  9.61663447e+02  2.17504785e+03  2.17504785e+03
  2.17504785e+03  4.33915573e+03  4.33915573e+03  4.33915573e+03
  5.12269199e+03  8.34737588e+03  8.34737588e+03  8.34737588e+03
  2.04308527e+04  7.09773298e+04]
E1 = -728.1361315176472  E_coul = 201.89877246543242
cycle= 4 E= -526.237359052215  delta_E= -2.45e-07  |g|= 4.02e-05  |ddm|= 0.000848
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.30603e-05
diis-c [-9.94848136e-10 -6.03606358e-06 -2.28968392e-04  7.01884462e-03
  9.93216160e-01]
  HOMO = -0.569370050617306  LUMO = 1.18103812657559
  mo_energy =
[-1.18472214e+02 -1.21745832e+01 -9.52172776e+00 -9.52172776e+00
 -9.52172776e+00 -1.24923356e+00 -5.69370051e-01 -5.69370051e-01
 -5.69370051e-01  1.18103813e+00  1.18103813e+00  1.18103813e+00
  1.17247420e+01  1.17247420e+01  1.17247420e+01  6.38030055e+01
  6.38030055e+01  6.38030055e+01  9.06688682e+01  3.12444346e+02
  3.12444346e+02  3.12444346e+02  7.91932460e+02  9.61663538e+02
  9.61663538e+02  9.61663538e+02  2.17504794e+03  2.17504794e+03
  2.17504794e+03  4.33915582e+03  4.33915582e+03  4.33915582e+03
  5.12269207e+03  8.34737597e+03  8.34737597e+03  8.34737597e+03
  2.04308528e+04  7.09773299e+04]
E1 = -728.1359395068857  E_coul = 201.89858045454366
cycle= 5 E= -526.237359052342  delta_E= -1.27e-10  |g|= 5.32e-06  |ddm|= 2.43e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.1359395068857  E_coul = 201.89858045454366
  HOMO = -0.56937283333278  LUMO = 1.18103571059579
  mo_energy =
[-1.18472228e+02 -1.21745929e+01 -9.52173766e+00 -9.52173766e+00
 -9.52173766e+00 -1.24923720e+00 -5.69372833e-01 -5.69372833e-01
 -5.69372833e-01  1.18103571e+00  1.18103571e+00  1.18103571e+00
  1.17247339e+01  1.17247339e+01  1.17247339e+01  6.38029943e+01
  6.38029943e+01  6.38029943e+01  9.06688560e+01  3.12444333e+02
  3.12444333e+02  3.12444333e+02  7.91932447e+02  9.61663524e+02
  9.61663524e+02  9.61663524e+02  2.17504793e+03  2.17504793e+03
  2.17504793e+03  4.33915580e+03  4.33915580e+03  4.33915580e+03
  5.12269206e+03  8.34737595e+03  8.34737595e+03  8.34737595e+03
  2.04308528e+04  7.09773298e+04]
E1 = -728.1359645113222  E_coul = 201.89860545897758
Extra cycle  E= -526.237359052345  delta_E= -2.5e-12  |g|= 1.33e-06  |ddm|= 3.07e-06
    CPU time for scf_cycle      0.37 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2111575.4817697047
E1 = -728.1359645113222  E_coul = 201.89860545897758
init E= -526.237359052345
    CPU time for initialize scf      1.38 sec, wall time      0.25 sec
  HOMO = -0.569372362496262  LUMO = 1.1810361259973
  mo_energy =
[-1.18472225e+02 -1.21745911e+01 -9.52173578e+00 -9.52173578e+00
 -9.52173578e+00 -1.24923658e+00 -5.69372362e-01 -5.69372362e-01
 -5.69372362e-01  1.18103613e+00  1.18103613e+00  1.18103613e+00
  1.17247354e+01  1.17247354e+01  1.17247354e+01  6.38029966e+01
  6.38029966e+01  6.38029966e+01  9.06688586e+01  3.12444336e+02
  3.12444336e+02  3.12444336e+02  7.91932450e+02  9.61663527e+02
  9.61663527e+02  9.61663527e+02  2.17504793e+03  2.17504793e+03
  2.17504793e+03  4.33915581e+03  4.33915581e+03  4.33915581e+03
  5.12269206e+03  8.34737596e+03  8.34737596e+03  8.34737596e+03
  2.04308528e+04  7.09773298e+04]
E1 = -728.1359595315192  E_coul = 201.8986004791752
cycle= 1 E= -526.237359052344  delta_E= 5.68e-13  |g|= 2.87e-07  |ddm|= 5.75e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.1359595315192  E_coul = 201.8986004791752
  HOMO = -0.569372450957498  LUMO = 1.18103604745557
  mo_energy =
[-1.18472225e+02 -1.21745914e+01 -9.52173615e+00 -9.52173615e+00
 -9.52173615e+00 -1.24923670e+00 -5.69372451e-01 -5.69372451e-01
 -5.69372451e-01  1.18103605e+00  1.18103605e+00  1.18103605e+00
  1.17247351e+01  1.17247351e+01  1.17247351e+01  6.38029961e+01
  6.38029961e+01  6.38029961e+01  9.06688581e+01  3.12444335e+02
  3.12444335e+02  3.12444335e+02  7.91932449e+02  9.61663527e+02
  9.61663527e+02  9.61663527e+02  2.17504793e+03  2.17504793e+03
  2.17504793e+03  4.33915581e+03  4.33915581e+03  4.33915581e+03
  5.12269206e+03  8.34737595e+03  8.34737595e+03  8.34737595e+03
  2.04308528e+04  7.09773298e+04]
E1 = -728.1359605367777  E_coul = 201.8986014844339
Extra cycle  E= -526.237359052344  delta_E= 2.27e-13  |g|= 5.98e-08  |ddm|= 1.14e-07
    CPU time for scf_cycle      1.52 sec, wall time      0.38 sec
exp = [2.61855929e+04 7.58443444e+03 3.55104950e+03 5.69113897e+02
 1.28485590e+02 3.78627706e+01 4.62650763e+00 3.97486624e-01
 1.36291410e+03 6.53550116e+02 2.43777069e+02 2.63992663e+02
 6.67717889e+02 1.18738672e+01 3.79267674e+01 8.68610026e-01
 4.02470464e+00 2.39464823e-01]
grad_E = [ 6.97852697e-07  1.80135100e-06  6.66177116e-05  9.40338125e-04
 -9.12288385e-03  1.05103730e-02  1.93467841e-02  3.07676213e-02
  6.70988505e-06  2.83586279e-05  2.74933731e-04  2.18682464e-04
  2.69783439e-05  8.58477062e-03 -6.65385482e-03 -1.07697885e-02
  1.64727959e-02 -1.39625739e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.5471793        1
[INPUT] 0    0    [1    /1   ]  7584.9259044         1
[INPUT] 0    0    [1    /1   ]  3552.01017374        1
[INPUT] 0    0    [1    /1   ]  584.524910703        1
[INPUT] 0    0    [1    /1   ]  134.336236147        1
[INPUT] 0    0    [1    /1   ]  38.6576577366        1
[INPUT] 0    0    [1    /1   ]  4.60912014656        1
[INPUT] 0    0    [1    /1   ]  0.393083384387       1
[INPUT] 1    0    [1    /1   ]  1362.85454676        1
[INPUT] 1    0    [1    /1   ]  653.232996462        1
[INPUT] 1    0    [1    /1   ]  241.888557938        1
[INPUT] 1    0    [1    /1   ]  262.317219446        1
[INPUT] 1    0    [1    /1   ]  716.594820493        1
[INPUT] 1    0    [1    /1   ]  14.8972873085        1
[INPUT] 1    0    [1    /1   ]  55.8907384136        1
[INPUT] 1    0    [1    /1   ]  0.969293745101       1
[INPUT] 1    0    [1    /1   ]  4.53784324902        1
[INPUT] 1    0    [1    /1   ]  0.265332588973       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.54717930291, 1.0]], [0, [7584.925904400293, 1.0]], [0, [3552.0101737350287, 1.0]], [0, [584.5249107034831, 1.0]], [0, [134.33623614659317, 1.0]], [0, [38.65765773655939, 1.0]], [0, [4.60912014656036, 1.0]], [0, [0.3930833843867033, 1.0]], [1, [1362.8545467551648, 1.0]], [1, [653.2329964618358, 1.0]], [1, [241.88855793800974, 1.0]], [1, [262.3172194460381, 1.0]], [1, [716.5948204927658, 1.0]], [1, [14.897287308513146, 1.0]], [1, [55.89073841357418, 1.0]], [1, [0.9692937451005362, 1.0]], [1, [4.537843249016359, 1.0]], [1, [0.2653325889734692, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.5471793]
bas 1, expnt(s) = [7584.9259044]
bas 2, expnt(s) = [3552.01017374]
bas 3, expnt(s) = [584.5249107]
bas 4, expnt(s) = [134.33623615]
bas 5, expnt(s) = [38.65765774]
bas 6, expnt(s) = [4.60912015]
bas 7, expnt(s) = [0.39308338]
bas 8, expnt(s) = [1362.85454676]
bas 9, expnt(s) = [653.23299646]
bas 10, expnt(s) = [241.88855794]
bas 11, expnt(s) = [262.31721945]
bas 12, expnt(s) = [716.59482049]
bas 13, expnt(s) = [14.89728731]
bas 14, expnt(s) = [55.89073841]
bas 15, expnt(s) = [0.96929375]
bas 16, expnt(s) = [4.53784325]
bas 17, expnt(s) = [0.26533259]
CPU time:       647.91
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61855472e+04 5.20069356e+03 7.58492590e+03 2.05342352e+03
 3.55201017e+03 1.16244035e+03 5.84524911e+02 3.00342846e+02
 1.34336236e+02 9.96919076e+01 3.86576577e+01 3.91689272e+01
 4.60912015e+00 7.94746357e+00 3.93083384e-01 1.25423391e+00
 1.36285455e+03 2.41571823e+04 6.53232996e+02 9.63428601e+03
 2.41888558e+02 2.78293812e+03 2.62317219e+02 3.07976722e+03
 7.16594820e+02 1.08162439e+04 1.48972873e+01 8.53824052e+01
 5.58907384e+01 4.45819645e+02 9.69293745e-01 2.80578026e+00
 4.53784325e+00 1.93217409e+01 2.65332589e-01 5.55549340e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.96380611371466
cond(S) = 173875.26615794885
E1 = -728.3945290068224  E_coul = 203.06049214950235
init E= -525.33403685732
    CPU time for initialize scf      0.71 sec, wall time      0.08 sec
  HOMO = -0.558870553661095  LUMO = 1.40264576165674
  mo_energy =
[-1.18256090e+02 -1.20971593e+01 -9.43776388e+00 -9.43776388e+00
 -9.43776388e+00 -1.23290395e+00 -5.58870554e-01 -5.58870554e-01
 -5.58870554e-01  1.40264576e+00  1.40264576e+00  1.40264576e+00
  1.46851127e+01  1.46851127e+01  1.46851127e+01  9.00926385e+01
  9.00926385e+01  9.00926385e+01  9.50957876e+01  3.75256923e+02
  3.75256923e+02  3.75256923e+02  8.24565537e+02  1.03576288e+03
  1.03576288e+03  1.03576288e+03  2.26477523e+03  2.26477523e+03
  2.26477523e+03  4.47416764e+03  4.47416764e+03  4.47416764e+03
  5.19369065e+03  8.54526876e+03  8.54526876e+03  8.54526876e+03
  2.05107756e+04  7.10563107e+04]
E1 = -728.03430588763  E_coul = 201.82126394853339
cycle= 1 E= -526.213041939097  delta_E= -0.879  |g|= 0.188  |ddm|= 1.15
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.496143
diis-c [-0.24615767  1.        ]
  HOMO = -0.565437794392255  LUMO = 1.39642107053564
  mo_energy =
[-1.18512977e+02 -1.21758765e+01 -9.52183934e+00 -9.52183934e+00
 -9.52183934e+00 -1.24537313e+00 -5.65437794e-01 -5.65437794e-01
 -5.65437794e-01  1.39642107e+00  1.39642107e+00  1.39642107e+00
  1.46133128e+01  1.46133128e+01  1.46133128e+01  8.99310417e+01
  8.99310417e+01  8.99310417e+01  9.49380530e+01  3.75024292e+02
  3.75024292e+02  3.75024292e+02  8.24222903e+02  1.03547923e+03
  1.03547923e+03  1.03547923e+03  2.26444120e+03  2.26444120e+03
  2.26444120e+03  4.47377333e+03  4.47377333e+03  4.47377333e+03
  5.19313406e+03  8.54476576e+03  8.54476576e+03  8.54476576e+03
  2.05100926e+04  7.10555370e+04]
E1 = -728.2566535632835  E_coul = 202.04332265450034
cycle= 2 E= -526.213330908783  delta_E= -0.000289  |g|= 0.02  |ddm|= 0.0159
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0339932
diis-c [-8.06068802e-04  3.63680807e-02  9.63631919e-01]
  HOMO = -0.563034926300203  LUMO = 1.39910606477843
  mo_energy =
[-1.18478253e+02 -1.21606208e+01 -9.50630261e+00 -9.50630261e+00
 -9.50630261e+00 -1.24216126e+00 -5.63034926e-01 -5.63034926e-01
 -5.63034926e-01  1.39910606e+00  1.39910606e+00  1.39910606e+00
  1.46263241e+01  1.46263241e+01  1.46263241e+01  8.99567176e+01
  8.99567176e+01  8.99567176e+01  9.49671970e+01  3.75057511e+02
  3.75057511e+02  3.75057511e+02  8.24260397e+02  1.03551534e+03
  1.03551534e+03  1.03551534e+03  2.26447885e+03  2.26447885e+03
  2.26447885e+03  4.47381199e+03  4.47381199e+03  4.47381199e+03
  5.19317359e+03  8.54480507e+03  8.54480507e+03  8.54480507e+03
  2.05101323e+04  7.10555767e+04]
E1 = -728.2120315228362  E_coul = 201.99869294571573
cycle= 3 E= -526.213338577121  delta_E= -7.67e-06  |g|= 0.00241  |ddm|= 0.00392
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00455167
diis-c [-2.15362903e-07 -9.64639273e-04  1.10884908e-01  8.90079731e-01]
  HOMO = -0.563530288721157  LUMO = 1.39858762101562
  mo_energy =
[-1.18482560e+02 -1.21628819e+01 -9.50864058e+00 -9.50864058e+00
 -9.50864058e+00 -1.24280895e+00 -5.63530289e-01 -5.63530289e-01
 -5.63530289e-01  1.39858762e+00  1.39858762e+00  1.39858762e+00
  1.46243122e+01  1.46243122e+01  1.46243122e+01  8.99533397e+01
  8.99533397e+01  8.99533397e+01  9.49635738e+01  3.75053374e+02
  3.75053374e+02  3.75053374e+02  8.24255756e+02  1.03551089e+03
  1.03551089e+03  1.03551089e+03  2.26447420e+03  2.26447420e+03
  2.26447420e+03  4.47380719e+03  4.47380719e+03  4.47380719e+03
  5.19316854e+03  8.54480009e+03  8.54480009e+03  8.54480009e+03
  2.05101272e+04  7.10555715e+04]
E1 = -728.2182973632927  E_coul = 202.00495861030936
cycle= 4 E= -526.213338752983  delta_E= -1.76e-07  |g|= 4.27e-05  |ddm|= 0.000608
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.50271e-05
diis-c [-1.02916824e-09 -5.35617837e-06 -5.94187532e-04  5.67355367e-03
  9.94925990e-01]
  HOMO = -0.563505155559457  LUMO = 1.39861267053042
  mo_energy =
[-1.18482462e+02 -1.21627972e+01 -9.50855594e+00 -9.50855594e+00
 -9.50855594e+00 -1.24277622e+00 -5.63505156e-01 -5.63505156e-01
 -5.63505156e-01  1.39861267e+00  1.39861267e+00  1.39861267e+00
  1.46243876e+01  1.46243876e+01  1.46243876e+01  8.99534322e+01
  8.99534322e+01  8.99534322e+01  9.49636715e+01  3.75053471e+02
  3.75053471e+02  3.75053471e+02  8.24255849e+02  1.03551099e+03
  1.03551099e+03  1.03551099e+03  2.26447430e+03  2.26447430e+03
  2.26447430e+03  4.47380728e+03  4.47380728e+03  4.47380728e+03
  5.19316862e+03  8.54480018e+03  8.54480018e+03  8.54480018e+03
  2.05101272e+04  7.10555716e+04]
E1 = -728.2181054751242  E_coul = 202.0047667220071
cycle= 5 E= -526.213338753117  delta_E= -1.34e-10  |g|= 5.76e-06  |ddm|= 2.28e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2181054751242  E_coul = 202.0047667220071
  HOMO = -0.563507938224334  LUMO = 1.39860986864793
  mo_energy =
[-1.18482476e+02 -1.21628073e+01 -9.50856627e+00 -9.50856627e+00
 -9.50856627e+00 -1.24277984e+00 -5.63507938e-01 -5.63507938e-01
 -5.63507938e-01  1.39860987e+00  1.39860987e+00  1.39860987e+00
  1.46243785e+01  1.46243785e+01  1.46243785e+01  8.99534198e+01
  8.99534198e+01  8.99534198e+01  9.49636585e+01  3.75053457e+02
  3.75053457e+02  3.75053457e+02  8.24255835e+02  1.03551097e+03
  1.03551097e+03  1.03551097e+03  2.26447428e+03  2.26447428e+03
  2.26447428e+03  4.47380726e+03  4.47380726e+03  4.47380726e+03
  5.19316861e+03  8.54480017e+03  8.54480017e+03  8.54480017e+03
  2.05101272e+04  7.10555715e+04]
E1 = -728.2181303601957  E_coul = 202.00479160707783
Extra cycle  E= -526.213338753118  delta_E= -6.82e-13  |g|= 1.37e-06  |ddm|= 2.76e-06
    CPU time for scf_cycle      0.87 sec, wall time      0.24 sec
exp = [2.61855472e+04 7.58492590e+03 3.55201017e+03 5.84524911e+02
 1.34336236e+02 3.86576577e+01 4.60912015e+00 3.93083384e-01
 1.36285455e+03 6.53232996e+02 2.41888558e+02 2.62317219e+02
 7.16594820e+02 1.48972873e+01 5.58907384e+01 9.69293745e-01
 4.53784325e+00 2.65332589e-01]
E = -526.2133387531178
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.5738581        1
[INPUT] 0    0    [1    /1   ]  7584.63927985        1
[INPUT] 0    0    [1    /1   ]  3551.4499078         1
[INPUT] 0    0    [1    /1   ]  575.537182788        1
[INPUT] 0    0    [1    /1   ]  130.92412993         1
[INPUT] 0    0    [1    /1   ]  38.1940782439        1
[INPUT] 0    0    [1    /1   ]  4.61926055445        1
[INPUT] 0    0    [1    /1   ]  0.395651360886       1
[INPUT] 1    0    [1    /1   ]  1362.88927804        1
[INPUT] 1    0    [1    /1   ]  653.417941079        1
[INPUT] 1    0    [1    /1   ]  242.98994045         1
[INPUT] 1    0    [1    /1   ]  263.2943411          1
[INPUT] 1    0    [1    /1   ]  688.089714807        1
[INPUT] 1    0    [1    /1   ]  13.1340238221        1
[INPUT] 1    0    [1    /1   ]  45.4141213544        1
[INPUT] 1    0    [1    /1   ]  0.910574836514       1
[INPUT] 1    0    [1    /1   ]  4.23857998047        1
[INPUT] 1    0    [1    /1   ]  0.250246465875       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.573858146297, 1.0]], [0, [7584.6392798492025, 1.0]], [0, [3551.4499078047465, 1.0]], [0, [575.5371827878523, 1.0]], [0, [130.92412992988667, 1.0]], [0, [38.19407824393705, 1.0]], [0, [4.619260554445821, 1.0]], [0, [0.39565136088567243, 1.0]], [1, [1362.8892780385402, 1.0]], [1, [653.4179410791544, 1.0]], [1, [242.98994045008666, 1.0]], [1, [263.29434109965905, 1.0]], [1, [688.0897148070628, 1.0]], [1, [13.134023822126741, 1.0]], [1, [45.41412135441363, 1.0]], [1, [0.9105748365143687, 1.0]], [1, [4.238579980474262, 1.0]], [1, [0.2502464658746463, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.57385815]
bas 1, expnt(s) = [7584.63927985]
bas 2, expnt(s) = [3551.4499078]
bas 3, expnt(s) = [575.53718279]
bas 4, expnt(s) = [130.92412993]
bas 5, expnt(s) = [38.19407824]
bas 6, expnt(s) = [4.61926055]
bas 7, expnt(s) = [0.39565136]
bas 8, expnt(s) = [1362.88927804]
bas 9, expnt(s) = [653.41794108]
bas 10, expnt(s) = [242.98994045]
bas 11, expnt(s) = [263.2943411]
bas 12, expnt(s) = [688.08971481]
bas 13, expnt(s) = [13.13402382]
bas 14, expnt(s) = [45.41412135]
bas 15, expnt(s) = [0.91057484]
bas 16, expnt(s) = [4.23857998]
bas 17, expnt(s) = [0.25024647]
CPU time:       649.08
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61855739e+04 5.20069753e+03 7.58463928e+03 2.05336532e+03
 3.55144991e+03 1.16230283e+03 5.75537183e+02 2.96872565e+02
 1.30924130e+02 9.77867014e+01 3.81940782e+01 3.88161135e+01
 4.61926055e+00 7.96057373e+00 3.95651361e-01 1.26037425e+00
 1.36288928e+03 2.41579518e+04 6.53417941e+02 9.63769573e+03
 2.42989940e+02 2.79878644e+03 2.63294341e+02 3.09411391e+03
 6.88089715e+02 1.02811270e+04 1.31340238e+01 7.29426676e+01
 4.54141214e+01 3.43932358e+02 9.10574837e-01 2.59494973e+00
 4.23857998e+00 1.77422981e+01 2.50246466e-01 5.16350181e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.968454992596904
cond(S) = 411742.8597728487
E1 = -728.5569707322529  E_coul = 203.12267517437647
init E= -525.434295557876
    CPU time for initialize scf      0.69 sec, wall time      0.08 sec
  HOMO = -0.558535166901188  LUMO = 1.2761093969826
  mo_energy =
[-1.18243494e+02 -1.20939644e+01 -9.43917201e+00 -9.43917201e+00
 -9.43917201e+00 -1.23124676e+00 -5.58535167e-01 -5.58535167e-01
 -5.58535167e-01  1.27610940e+00  1.27610940e+00  1.27610940e+00
  1.29468238e+01  1.29468238e+01  1.29468238e+01  7.48900786e+01
  7.48900786e+01  7.48900786e+01  9.25895221e+01  3.39408474e+02
  3.39408474e+02  3.39408474e+02  8.05720862e+02  9.92718466e+02
  9.92718466e+02  9.92718466e+02  2.21255747e+03  2.21255747e+03
  2.21255747e+03  4.39569678e+03  4.39569678e+03  4.39569678e+03
  5.15262190e+03  8.42991626e+03  8.42991626e+03  8.42991626e+03
  2.04645351e+04  7.10106593e+04]
E1 = -728.016833681344  E_coul = 201.77012330420274
cycle= 1 E= -526.246710377141  delta_E= -0.812  |g|= 0.185  |ddm|= 0.773
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.486697
diis-c [-0.2368744  1.       ]
  HOMO = -0.569774612348103  LUMO = 1.26693299967732
  mo_energy =
[-1.18502892e+02 -1.21819358e+01 -9.53151535e+00 -9.53151535e+00
 -9.53151535e+00 -1.24976892e+00 -5.69774612e-01 -5.69774612e-01
 -5.69774612e-01  1.26693300e+00  1.26693300e+00  1.26693300e+00
  1.28731848e+01  1.28731848e+01  1.28731848e+01  7.47358418e+01
  7.47358418e+01  7.47358419e+01  9.24275928e+01  3.39173329e+02
  3.39173329e+02  3.39173329e+02  8.05379386e+02  9.92432851e+02
  9.92432851e+02  9.92432851e+02  2.21222284e+03  2.21222284e+03
  2.21222284e+03  4.39530226e+03  4.39530226e+03  4.39530226e+03
  5.15206310e+03  8.42941209e+03  8.42941209e+03  8.42941209e+03
  2.04638494e+04  7.10098827e+04]
E1 = -728.2603489451128  E_coul = 202.01334789389142
cycle= 2 E= -526.247001051221  delta_E= -0.000291  |g|= 0.0204  |ddm|= 0.0194
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.034846
diis-c [-8.64723661e-04  3.70569982e-02  9.62943002e-01]
  HOMO = -0.566845550906773  LUMO = 1.26986438712246
  mo_energy =
[-1.18466609e+02 -1.21651294e+01 -9.51440135e+00 -9.51440135e+00
 -9.51440135e+00 -1.24586001e+00 -5.66845551e-01 -5.66845551e-01
 -5.66845551e-01  1.26986439e+00  1.26986439e+00  1.26986439e+00
  1.28865992e+01  1.28865992e+01  1.28865992e+01  7.47615225e+01
  7.47615225e+01  7.47615225e+01  9.24580861e+01  3.39207969e+02
  3.39207969e+02  3.39207969e+02  8.05418365e+02  9.92470566e+02
  9.92470566e+02  9.92470566e+02  2.21226204e+03  2.21226204e+03
  2.21226204e+03  4.39534244e+03  4.39534244e+03  4.39534244e+03
  5.15210414e+03  8.42945291e+03  8.42945291e+03  8.42945291e+03
  2.04638906e+04  7.10099239e+04]
E1 = -728.2111992267041  E_coul = 201.96418945238904
cycle= 3 E= -526.247009774315  delta_E= -8.72e-06  |g|= 0.00258  |ddm|= 0.00442
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00484386
diis-c [-2.02041229e-07 -9.65582177e-04  1.15465215e-01  8.85500367e-01]
  HOMO = -0.567402717691664  LUMO = 1.26933118782247
  mo_energy =
[-1.18471226e+02 -1.21675995e+01 -9.51695136e+00 -9.51695136e+00
 -9.51695136e+00 -1.24659042e+00 -5.67402718e-01 -5.67402718e-01
 -5.67402718e-01  1.26933119e+00  1.26933119e+00  1.26933119e+00
  1.28845244e+01  1.28845244e+01  1.28845244e+01  7.47580525e+01
  7.47580525e+01  7.47580525e+01  9.24542046e+01  3.39203544e+02
  3.39203544e+02  3.39203544e+02  8.05413413e+02  9.92465795e+02
  9.92465795e+02  9.92465795e+02  2.21225707e+03  2.21225707e+03
  2.21225707e+03  4.39533732e+03  4.39533732e+03  4.39533732e+03
  5.15209876e+03  8.42944761e+03  8.42944761e+03  8.42944761e+03
  2.04638851e+04  7.10099184e+04]
E1 = -728.2181698546228  E_coul = 201.9711598688798
cycle= 4 E= -526.247009985743  delta_E= -2.11e-07  |g|= 4.06e-05  |ddm|= 0.000684
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.2737e-05
diis-c [-1.02255027e-09 -3.12093877e-06 -7.60926386e-04  3.34016151e-03
  9.97423886e-01]
  HOMO = -0.567377812255047  LUMO = 1.26935406161092
  mo_energy =
[-1.18471134e+02 -1.21675177e+01 -9.51686983e+00 -9.51686983e+00
 -9.51686983e+00 -1.24655797e+00 -5.67377812e-01 -5.67377812e-01
 -5.67377812e-01  1.26935406e+00  1.26935406e+00  1.26935406e+00
  1.28845952e+01  1.28845952e+01  1.28845952e+01  7.47581398e+01
  7.47581398e+01  7.47581398e+01  9.24542980e+01  3.39203637e+02
  3.39203637e+02  3.39203637e+02  8.05413502e+02  9.92465886e+02
  9.92465886e+02  9.92465886e+02  2.21225716e+03  2.21225716e+03
  2.21225716e+03  4.39533741e+03  4.39533741e+03  4.39533741e+03
  5.15209884e+03  8.42944770e+03  8.42944770e+03  8.42944770e+03
  2.04638852e+04  7.10099184e+04]
E1 = -728.2179789678098  E_coul = 201.97096898193942
cycle= 5 E= -526.24700998587  delta_E= -1.27e-10  |g|= 5.66e-06  |ddm|= 2.27e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2179789678098  E_coul = 201.97096898193942
  HOMO = -0.567380700922951  LUMO = 1.26935138797855
  mo_energy =
[-1.18471148e+02 -1.21675280e+01 -9.51688025e+00 -9.51688025e+00
 -9.51688025e+00 -1.24656174e+00 -5.67380701e-01 -5.67380701e-01
 -5.67380701e-01  1.26935139e+00  1.26935139e+00  1.26935139e+00
  1.28845864e+01  1.28845864e+01  1.28845864e+01  7.47581277e+01
  7.47581277e+01  7.47581277e+01  9.24542850e+01  3.39203623e+02
  3.39203623e+02  3.39203623e+02  8.05413487e+02  9.92465872e+02
  9.92465872e+02  9.92465872e+02  2.21225715e+03  2.21225715e+03
  2.21225715e+03  4.39533739e+03  4.39533739e+03  4.39533739e+03
  5.15209883e+03  8.42944768e+03  8.42944768e+03  8.42944768e+03
  2.04638852e+04  7.10099184e+04]
E1 = -728.218004835114  E_coul = 201.97099484924198
Extra cycle  E= -526.247009985872  delta_E= -1.71e-12  |g|= 1.39e-06  |ddm|= 2.9e-06
    CPU time for scf_cycle      0.87 sec, wall time      0.25 sec
exp = [2.61855739e+04 7.58463928e+03 3.55144991e+03 5.75537183e+02
 1.30924130e+02 3.81940782e+01 4.61926055e+00 3.95651361e-01
 1.36288928e+03 6.53417941e+02 2.42989940e+02 2.63294341e+02
 6.88089715e+02 1.31340238e+01 4.54141214e+01 9.10574837e-01
 4.23857998e+00 2.50246466e-01]
E = -526.2470099858721
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:18 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.5738581        1
[INPUT] 0    0    [1    /1   ]  7584.63927985        1
[INPUT] 0    0    [1    /1   ]  3551.4499078         1
[INPUT] 0    0    [1    /1   ]  575.537182788        1
[INPUT] 0    0    [1    /1   ]  130.92412993         1
[INPUT] 0    0    [1    /1   ]  38.1940782439        1
[INPUT] 0    0    [1    /1   ]  4.61926055445        1
[INPUT] 0    0    [1    /1   ]  0.395651360886       1
[INPUT] 1    0    [1    /1   ]  1362.88927804        1
[INPUT] 1    0    [1    /1   ]  653.417941079        1
[INPUT] 1    0    [1    /1   ]  242.98994045         1
[INPUT] 1    0    [1    /1   ]  263.2943411          1
[INPUT] 1    0    [1    /1   ]  688.089714807        1
[INPUT] 1    0    [1    /1   ]  13.1340238221        1
[INPUT] 1    0    [1    /1   ]  45.4141213544        1
[INPUT] 1    0    [1    /1   ]  0.910574836514       1
[INPUT] 1    0    [1    /1   ]  4.23857998047        1
[INPUT] 1    0    [1    /1   ]  0.250246465875       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.573858146297, 1.0]], [0, [7584.6392798492025, 1.0]], [0, [3551.4499078047465, 1.0]], [0, [575.5371827878523, 1.0]], [0, [130.92412992988667, 1.0]], [0, [38.19407824393705, 1.0]], [0, [4.619260554445821, 1.0]], [0, [0.39565136088567243, 1.0]], [1, [1362.8892780385402, 1.0]], [1, [653.4179410791544, 1.0]], [1, [242.98994045008666, 1.0]], [1, [263.29434109965905, 1.0]], [1, [688.0897148070628, 1.0]], [1, [13.134023822126741, 1.0]], [1, [45.41412135441363, 1.0]], [1, [0.9105748365143687, 1.0]], [1, [4.238579980474262, 1.0]], [1, [0.2502464658746463, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.57385815]
bas 1, expnt(s) = [7584.63927985]
bas 2, expnt(s) = [3551.4499078]
bas 3, expnt(s) = [575.53718279]
bas 4, expnt(s) = [130.92412993]
bas 5, expnt(s) = [38.19407824]
bas 6, expnt(s) = [4.61926055]
bas 7, expnt(s) = [0.39565136]
bas 8, expnt(s) = [1362.88927804]
bas 9, expnt(s) = [653.41794108]
bas 10, expnt(s) = [242.98994045]
bas 11, expnt(s) = [263.2943411]
bas 12, expnt(s) = [688.08971481]
bas 13, expnt(s) = [13.13402382]
bas 14, expnt(s) = [45.41412135]
bas 15, expnt(s) = [0.91057484]
bas 16, expnt(s) = [4.23857998]
bas 17, expnt(s) = [0.25024647]
CPU time:       650.25
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61855739e+04 5.20069753e+03 7.58463928e+03 2.05336532e+03
 3.55144991e+03 1.16230283e+03 5.75537183e+02 2.96872565e+02
 1.30924130e+02 9.77867014e+01 3.81940782e+01 3.88161135e+01
 4.61926055e+00 7.96057373e+00 3.95651361e-01 1.26037425e+00
 1.36288928e+03 2.41579518e+04 6.53417941e+02 9.63769573e+03
 2.42989940e+02 2.79878644e+03 2.63294341e+02 3.09411391e+03
 6.88089715e+02 1.02811270e+04 1.31340238e+01 7.29426676e+01
 4.54141214e+01 3.43932358e+02 9.10574837e-01 2.59494973e+00
 4.23857998e+00 1.77422981e+01 2.50246466e-01 5.16350181e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.968454992596904
cond(S) = 411742.8597728487
E1 = -728.5569707322529  E_coul = 203.12267517437647
init E= -525.434295557876
    CPU time for initialize scf      0.69 sec, wall time      0.08 sec
  HOMO = -0.558535166901188  LUMO = 1.2761093969826
  mo_energy =
[-1.18243494e+02 -1.20939644e+01 -9.43917201e+00 -9.43917201e+00
 -9.43917201e+00 -1.23124676e+00 -5.58535167e-01 -5.58535167e-01
 -5.58535167e-01  1.27610940e+00  1.27610940e+00  1.27610940e+00
  1.29468238e+01  1.29468238e+01  1.29468238e+01  7.48900786e+01
  7.48900786e+01  7.48900786e+01  9.25895221e+01  3.39408474e+02
  3.39408474e+02  3.39408474e+02  8.05720862e+02  9.92718466e+02
  9.92718466e+02  9.92718466e+02  2.21255747e+03  2.21255747e+03
  2.21255747e+03  4.39569678e+03  4.39569678e+03  4.39569678e+03
  5.15262190e+03  8.42991626e+03  8.42991626e+03  8.42991626e+03
  2.04645351e+04  7.10106593e+04]
E1 = -728.016833681344  E_coul = 201.77012330420274
cycle= 1 E= -526.246710377141  delta_E= -0.812  |g|= 0.185  |ddm|= 0.773
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.486697
diis-c [-0.2368744  1.       ]
  HOMO = -0.569774612348103  LUMO = 1.26693299967732
  mo_energy =
[-1.18502892e+02 -1.21819358e+01 -9.53151535e+00 -9.53151535e+00
 -9.53151535e+00 -1.24976892e+00 -5.69774612e-01 -5.69774612e-01
 -5.69774612e-01  1.26693300e+00  1.26693300e+00  1.26693300e+00
  1.28731848e+01  1.28731848e+01  1.28731848e+01  7.47358418e+01
  7.47358418e+01  7.47358419e+01  9.24275928e+01  3.39173329e+02
  3.39173329e+02  3.39173329e+02  8.05379386e+02  9.92432851e+02
  9.92432851e+02  9.92432851e+02  2.21222284e+03  2.21222284e+03
  2.21222284e+03  4.39530226e+03  4.39530226e+03  4.39530226e+03
  5.15206310e+03  8.42941209e+03  8.42941209e+03  8.42941209e+03
  2.04638494e+04  7.10098827e+04]
E1 = -728.2603489451128  E_coul = 202.01334789389142
cycle= 2 E= -526.247001051221  delta_E= -0.000291  |g|= 0.0204  |ddm|= 0.0194
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.034846
diis-c [-8.64723661e-04  3.70569982e-02  9.62943002e-01]
  HOMO = -0.566845550906773  LUMO = 1.26986438712246
  mo_energy =
[-1.18466609e+02 -1.21651294e+01 -9.51440135e+00 -9.51440135e+00
 -9.51440135e+00 -1.24586001e+00 -5.66845551e-01 -5.66845551e-01
 -5.66845551e-01  1.26986439e+00  1.26986439e+00  1.26986439e+00
  1.28865992e+01  1.28865992e+01  1.28865992e+01  7.47615225e+01
  7.47615225e+01  7.47615225e+01  9.24580861e+01  3.39207969e+02
  3.39207969e+02  3.39207969e+02  8.05418365e+02  9.92470566e+02
  9.92470566e+02  9.92470566e+02  2.21226204e+03  2.21226204e+03
  2.21226204e+03  4.39534244e+03  4.39534244e+03  4.39534244e+03
  5.15210414e+03  8.42945291e+03  8.42945291e+03  8.42945291e+03
  2.04638906e+04  7.10099239e+04]
E1 = -728.2111992267041  E_coul = 201.96418945238904
cycle= 3 E= -526.247009774315  delta_E= -8.72e-06  |g|= 0.00258  |ddm|= 0.00442
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00484386
diis-c [-2.02041229e-07 -9.65582177e-04  1.15465215e-01  8.85500367e-01]
  HOMO = -0.567402717691664  LUMO = 1.26933118782247
  mo_energy =
[-1.18471226e+02 -1.21675995e+01 -9.51695136e+00 -9.51695136e+00
 -9.51695136e+00 -1.24659042e+00 -5.67402718e-01 -5.67402718e-01
 -5.67402718e-01  1.26933119e+00  1.26933119e+00  1.26933119e+00
  1.28845244e+01  1.28845244e+01  1.28845244e+01  7.47580525e+01
  7.47580525e+01  7.47580525e+01  9.24542046e+01  3.39203544e+02
  3.39203544e+02  3.39203544e+02  8.05413413e+02  9.92465795e+02
  9.92465795e+02  9.92465795e+02  2.21225707e+03  2.21225707e+03
  2.21225707e+03  4.39533732e+03  4.39533732e+03  4.39533732e+03
  5.15209876e+03  8.42944761e+03  8.42944761e+03  8.42944761e+03
  2.04638851e+04  7.10099184e+04]
E1 = -728.2181698546228  E_coul = 201.9711598688798
cycle= 4 E= -526.247009985743  delta_E= -2.11e-07  |g|= 4.06e-05  |ddm|= 0.000684
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.2737e-05
diis-c [-1.02255027e-09 -3.12093877e-06 -7.60926386e-04  3.34016151e-03
  9.97423886e-01]
  HOMO = -0.567377812255047  LUMO = 1.26935406161092
  mo_energy =
[-1.18471134e+02 -1.21675177e+01 -9.51686983e+00 -9.51686983e+00
 -9.51686983e+00 -1.24655797e+00 -5.67377812e-01 -5.67377812e-01
 -5.67377812e-01  1.26935406e+00  1.26935406e+00  1.26935406e+00
  1.28845952e+01  1.28845952e+01  1.28845952e+01  7.47581398e+01
  7.47581398e+01  7.47581398e+01  9.24542980e+01  3.39203637e+02
  3.39203637e+02  3.39203637e+02  8.05413502e+02  9.92465886e+02
  9.92465886e+02  9.92465886e+02  2.21225716e+03  2.21225716e+03
  2.21225716e+03  4.39533741e+03  4.39533741e+03  4.39533741e+03
  5.15209884e+03  8.42944770e+03  8.42944770e+03  8.42944770e+03
  2.04638852e+04  7.10099184e+04]
E1 = -728.2179789678098  E_coul = 201.97096898193942
cycle= 5 E= -526.24700998587  delta_E= -1.27e-10  |g|= 5.66e-06  |ddm|= 2.27e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2179789678098  E_coul = 201.97096898193942
  HOMO = -0.567380700922951  LUMO = 1.26935138797855
  mo_energy =
[-1.18471148e+02 -1.21675280e+01 -9.51688025e+00 -9.51688025e+00
 -9.51688025e+00 -1.24656174e+00 -5.67380701e-01 -5.67380701e-01
 -5.67380701e-01  1.26935139e+00  1.26935139e+00  1.26935139e+00
  1.28845864e+01  1.28845864e+01  1.28845864e+01  7.47581277e+01
  7.47581277e+01  7.47581277e+01  9.24542850e+01  3.39203623e+02
  3.39203623e+02  3.39203623e+02  8.05413487e+02  9.92465872e+02
  9.92465872e+02  9.92465872e+02  2.21225715e+03  2.21225715e+03
  2.21225715e+03  4.39533739e+03  4.39533739e+03  4.39533739e+03
  5.15209883e+03  8.42944768e+03  8.42944768e+03  8.42944768e+03
  2.04638852e+04  7.10099184e+04]
E1 = -728.218004835114  E_coul = 201.97099484924198
Extra cycle  E= -526.247009985872  delta_E= -1.71e-12  |g|= 1.39e-06  |ddm|= 2.9e-06
    CPU time for scf_cycle      0.85 sec, wall time      0.24 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 411742.8597728487
E1 = -728.218004835114  E_coul = 201.97099484924198
init E= -526.247009985872
    CPU time for initialize scf      1.12 sec, wall time      0.21 sec
  HOMO = -0.567380221271983  LUMO = 1.26935183963718
  mo_energy =
[-1.18471145e+02 -1.21675260e+01 -9.51687830e+00 -9.51687830e+00
 -9.51687830e+00 -1.24656111e+00 -5.67380221e-01 -5.67380221e-01
 -5.67380221e-01  1.26935184e+00  1.26935184e+00  1.26935184e+00
  1.28845880e+01  1.28845880e+01  1.28845880e+01  7.47581302e+01
  7.47581302e+01  7.47581302e+01  9.24542878e+01  3.39203626e+02
  3.39203626e+02  3.39203626e+02  8.05413491e+02  9.92465875e+02
  9.92465875e+02  9.92465875e+02  2.21225715e+03  2.21225715e+03
  2.21225715e+03  4.39533740e+03  4.39533740e+03  4.39533740e+03
  5.15209883e+03  8.42944769e+03  8.42944769e+03  8.42944769e+03
  2.04638852e+04  7.10099184e+04]
E1 = -728.2179997523883  E_coul = 201.970989766515
cycle= 1 E= -526.247009985873  delta_E= -1.25e-12  |g|= 2.96e-07  |ddm|= 5.28e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2179997523883  E_coul = 201.970989766515
  HOMO = -0.567380310178494  LUMO = 1.26935175531949
  mo_energy =
[-1.18471145e+02 -1.21675264e+01 -9.51687868e+00 -9.51687868e+00
 -9.51687868e+00 -1.24656123e+00 -5.67380310e-01 -5.67380310e-01
 -5.67380310e-01  1.26935176e+00  1.26935176e+00  1.26935176e+00
  1.28845877e+01  1.28845877e+01  1.28845877e+01  7.47581297e+01
  7.47581297e+01  7.47581297e+01  9.24542872e+01  3.39203625e+02
  3.39203625e+02  3.39203625e+02  8.05413490e+02  9.92465875e+02
  9.92465875e+02  9.92465875e+02  2.21225715e+03  2.21225715e+03
  2.21225715e+03  4.39533740e+03  4.39533740e+03  4.39533740e+03
  5.15209883e+03  8.42944769e+03  8.42944769e+03  8.42944769e+03
  2.04638852e+04  7.10099184e+04]
E1 = -728.218000764956  E_coul = 201.97099077908354
Extra cycle  E= -526.247009985872  delta_E= 9.09e-13  |g|= 6.09e-08  |ddm|= 1.03e-07
    CPU time for scf_cycle      1.25 sec, wall time      0.34 sec
exp = [2.61855739e+04 7.58463928e+03 3.55144991e+03 5.75537183e+02
 1.30924130e+02 3.81940782e+01 4.61926055e+00 3.95651361e-01
 1.36288928e+03 6.53417941e+02 2.42989940e+02 2.63294341e+02
 6.88089715e+02 1.31340238e+01 4.54141214e+01 9.10574837e-01
 4.23857998e+00 2.50246466e-01]
grad_E = [ 6.68340075e-07  1.70067554e-06  6.54021896e-05  7.30168684e-04
 -6.97561970e-03  6.97026326e-03  1.16196032e-02  1.11358041e-02
  6.84947382e-07  2.86196126e-06  2.11439055e-05  1.72487175e-05
  2.51535788e-06 -2.14276550e-02  6.08064602e-03 -6.63479963e-04
  3.78855603e-02 -1.37038863e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.5625082        1
[INPUT] 0    0    [1    /1   ]  7584.76224173        1
[INPUT] 0    0    [1    /1   ]  3551.69285962        1
[INPUT] 0    0    [1    /1   ]  579.321303953        1
[INPUT] 0    0    [1    /1   ]  132.675495488        1
[INPUT] 0    0    [1    /1   ]  38.2327002936        1
[INPUT] 0    0    [1    /1   ]  4.60798317446        1
[INPUT] 0    0    [1    /1   ]  0.393235783291       1
[INPUT] 1    0    [1    /1   ]  1362.88569025        1
[INPUT] 1    0    [1    /1   ]  653.434793221        1
[INPUT] 1    0    [1    /1   ]  243.060979911        1
[INPUT] 1    0    [1    /1   ]  263.35540421         1
[INPUT] 1    0    [1    /1   ]  689.571653262        1
[INPUT] 1    0    [1    /1   ]  13.0117420564        1
[INPUT] 1    0    [1    /1   ]  43.7922983328        1
[INPUT] 1    0    [1    /1   ]  0.923462719534       1
[INPUT] 1    0    [1    /1   ]  4.18697044606        1
[INPUT] 1    0    [1    /1   ]  0.252498525051       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.562508216557, 1.0]], [0, [7584.762241734262, 1.0]], [0, [3551.6928596235202, 1.0]], [0, [579.3213039527236, 1.0]], [0, [132.67549548817354, 1.0]], [0, [38.23270029356278, 1.0]], [0, [4.6079831744559785, 1.0]], [0, [0.3932357832906712, 1.0]], [1, [1362.8856902514099, 1.0]], [1, [653.4347932210737, 1.0]], [1, [243.06097991054384, 1.0]], [1, [263.3554042101841, 1.0]], [1, [689.5716532623425, 1.0]], [1, [13.01174205639998, 1.0]], [1, [43.79229833275932, 1.0]], [1, [0.9234627195342688, 1.0]], [1, [4.186970446063182, 1.0]], [1, [0.25249852505051606, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.56250822]
bas 1, expnt(s) = [7584.76224173]
bas 2, expnt(s) = [3551.69285962]
bas 3, expnt(s) = [579.32130395]
bas 4, expnt(s) = [132.67549549]
bas 5, expnt(s) = [38.23270029]
bas 6, expnt(s) = [4.60798317]
bas 7, expnt(s) = [0.39323578]
bas 8, expnt(s) = [1362.88569025]
bas 9, expnt(s) = [653.43479322]
bas 10, expnt(s) = [243.06097991]
bas 11, expnt(s) = [263.35540421]
bas 12, expnt(s) = [689.57165326]
bas 13, expnt(s) = [13.01174206]
bas 14, expnt(s) = [43.79229833]
bas 15, expnt(s) = [0.92346272]
bas 16, expnt(s) = [4.18697045]
bas 17, expnt(s) = [0.25249853]
CPU time:       656.92
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61855625e+04 5.20069584e+03 7.58476224e+03 2.05339028e+03
 3.55169286e+03 1.16236246e+03 5.79321304e+02 2.98335304e+02
 1.32675495e+02 9.87661359e+01 3.82327003e+01 3.88455481e+01
 4.60798317e+00 7.94599318e+00 3.93235783e-01 1.25459860e+00
 1.36288569e+03 2.41578723e+04 6.53434793e+02 9.63800643e+03
 2.43060980e+02 2.79980928e+03 2.63355404e+02 3.09501092e+03
 6.89571653e+02 1.03088126e+04 1.30117421e+01 7.20947598e+01
 4.37922983e+01 3.28648433e+02 9.23462720e-01 2.64094041e+00
 4.18697045e+00 1.74726695e+01 2.52498525e-01 5.22165230e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.968444010741337
cond(S) = 379169.59042423364
E1 = -728.4952537011214  E_coul = 203.06766608610104
init E= -525.42758761502
    CPU time for initialize scf      0.69 sec, wall time      0.08 sec
  HOMO = -0.559416410495462  LUMO = 1.29662906815268
  mo_energy =
[-1.18254509e+02 -1.20959839e+01 -9.44526661e+00 -9.44526661e+00
 -9.44526661e+00 -1.23195767e+00 -5.59416410e-01 -5.59416410e-01
 -5.59416410e-01  1.29662907e+00  1.29662907e+00  1.29662907e+00
  1.28426992e+01  1.28426992e+01  1.28426992e+01  7.29872141e+01
  7.29872141e+01  7.29872141e+01  9.34043346e+01  3.34333795e+02
  3.34333795e+02  3.34333795e+02  8.13937841e+02  9.87174911e+02
  9.87174911e+02  9.87174911e+02  2.20772334e+03  2.20772334e+03
  2.20772334e+03  4.39264475e+03  4.39264475e+03  4.39264475e+03
  5.17047967e+03  8.42923343e+03  8.42923343e+03  8.42923343e+03
  2.04845650e+04  7.10304136e+04]
E1 = -727.9361346236725  E_coul = 201.67531160644842
cycle= 1 E= -526.260823017224  delta_E= -0.833  |g|= 0.187  |ddm|= 0.422
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.497201
diis-c [-0.24720854  1.        ]
  HOMO = -0.570569583086789  LUMO = 1.28718377955
  mo_energy =
[-1.18522729e+02 -1.21860482e+01 -9.54082628e+00 -9.54082628e+00
 -9.54082628e+00 -1.24998208e+00 -5.70569583e-01 -5.70569583e-01
 -5.70569583e-01  1.28718378e+00  1.28718378e+00  1.28718378e+00
  1.27671537e+01  1.27671537e+01  1.27671537e+01  7.28287916e+01
  7.28287916e+01  7.28287916e+01  9.32356055e+01  3.34090424e+02
  3.34090424e+02  3.34090424e+02  8.13583389e+02  9.86878819e+02
  9.86878819e+02  9.86878819e+02  2.20737685e+03  2.20737685e+03
  2.20737685e+03  4.39223790e+03  4.39223790e+03  4.39223790e+03
  5.16990838e+03  8.42871680e+03  8.42871680e+03  8.42871680e+03
  2.04838664e+04  7.10296239e+04]
E1 = -728.1922899201635  E_coul = 201.9311462678444
cycle= 2 E= -526.261143652319  delta_E= -0.000321  |g|= 0.0215  |ddm|= 0.0199
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0367032
diis-c [-9.18922626e-04  4.00275695e-02  9.59972430e-01]
  HOMO = -0.567519428998882  LUMO = 1.2902816633223
  mo_energy =
[-1.18484589e+02 -1.21684280e+01 -9.52287591e+00 -9.52287591e+00
 -9.52287591e+00 -1.24592305e+00 -5.67519429e-01 -5.67519429e-01
 -5.67519429e-01  1.29028166e+00  1.29028166e+00  1.29028166e+00
  1.27810889e+01  1.27810889e+01  1.27810889e+01  7.28554566e+01
  7.28554566e+01  7.28554566e+01  9.32677251e+01  3.34126810e+02
  3.34126810e+02  3.34126810e+02  8.13624341e+02  9.86918460e+02
  9.86918460e+02  9.86918460e+02  2.20741803e+03  2.20741803e+03
  2.20741803e+03  4.39228010e+03  4.39228010e+03  4.39228010e+03
  5.16995146e+03  8.42875966e+03  8.42875966e+03  8.42875966e+03
  2.04839097e+04  7.10296672e+04]
E1 = -728.1406389663923  E_coul = 201.8794855760569
cycle= 3 E= -526.261153390335  delta_E= -9.74e-06  |g|= 0.00266  |ddm|= 0.00465
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00502273
diis-c [-2.40665866e-07 -1.00796527e-03  1.13337377e-01  8.87670588e-01]
  HOMO = -0.568093857088084  LUMO = 1.2897246916743
  mo_energy =
[-1.18489348e+02 -1.21709755e+01 -9.52550855e+00 -9.52550855e+00
 -9.52550855e+00 -1.24667291e+00 -5.68093857e-01 -5.68093857e-01
 -5.68093857e-01  1.28972469e+00  1.28972469e+00  1.28972469e+00
  1.27789603e+01  1.27789603e+01  1.27789603e+01  7.28519065e+01
  7.28519065e+01  7.28519065e+01  9.32637156e+01  3.34122250e+02
  3.34122250e+02  3.34122250e+02  8.13619228e+02  9.86913539e+02
  9.86913539e+02  9.86913539e+02  2.20741291e+03  2.20741291e+03
  2.20741291e+03  4.39227481e+03  4.39227481e+03  4.39227481e+03
  5.16994591e+03  8.42875419e+03  8.42875419e+03  8.42875419e+03
  2.04839040e+04  7.10296614e+04]
E1 = -728.1478217970721  E_coul = 201.88666818121902
cycle= 4 E= -526.261153615853  delta_E= -2.26e-07  |g|= 4.06e-05  |ddm|= 0.000706
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.20402e-05
diis-c [-1.12197226e-09 -3.12197059e-06 -9.66411969e-04  1.03399195e-03
  9.99935542e-01]
  HOMO = -0.568068376644698  LUMO = 1.28974837891446
  mo_energy =
[-1.18489255e+02 -1.21708920e+01 -9.52542529e+00 -9.52542529e+00
 -9.52542529e+00 -1.24663976e+00 -5.68068377e-01 -5.68068377e-01
 -5.68068377e-01  1.28974838e+00  1.28974838e+00  1.28974838e+00
  1.27790324e+01  1.27790324e+01  1.27790324e+01  7.28519947e+01
  7.28519947e+01  7.28519947e+01  9.32638100e+01  3.34122343e+02
  3.34122343e+02  3.34122343e+02  8.13619317e+02  9.86913631e+02
  9.86913631e+02  9.86913631e+02  2.20741300e+03  2.20741300e+03
  2.20741300e+03  4.39227490e+03  4.39227490e+03  4.39227490e+03
  5.16994599e+03  8.42875428e+03  8.42875428e+03  8.42875428e+03
  2.04839041e+04  7.10296615e+04]
E1 = -728.1476279874009  E_coul = 201.8864743714169
cycle= 5 E= -526.261153615984  delta_E= -1.31e-10  |g|= 6.02e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.1476279874009  E_coul = 201.8864743714169
  HOMO = -0.568071426528213  LUMO = 1.28974551890017
  mo_energy =
[-1.18489270e+02 -1.21709028e+01 -9.52543633e+00 -9.52543633e+00
 -9.52543633e+00 -1.24664373e+00 -5.68071427e-01 -5.68071427e-01
 -5.68071427e-01  1.28974552e+00  1.28974552e+00  1.28974552e+00
  1.27790231e+01  1.27790231e+01  1.27790231e+01  7.28519819e+01
  7.28519819e+01  7.28519819e+01  9.32637963e+01  3.34122328e+02
  3.34122328e+02  3.34122328e+02  8.13619302e+02  9.86913616e+02
  9.86913616e+02  9.86913616e+02  2.20741298e+03  2.20741298e+03
  2.20741298e+03  4.39227488e+03  4.39227488e+03  4.39227488e+03
  5.16994597e+03  8.42875426e+03  8.42875426e+03  8.42875426e+03
  2.04839041e+04  7.10296615e+04]
E1 = -728.1476552977945  E_coul = 201.8865016818087
Extra cycle  E= -526.261153615986  delta_E= -1.71e-12  |g|= 1.47e-06  |ddm|= 3.06e-06
    CPU time for scf_cycle      0.85 sec, wall time      0.24 sec
exp = [2.61855625e+04 7.58476224e+03 3.55169286e+03 5.79321304e+02
 1.32675495e+02 3.82327003e+01 4.60798317e+00 3.93235783e-01
 1.36288569e+03 6.53434793e+02 2.43060980e+02 2.63355404e+02
 6.89571653e+02 1.30117421e+01 4.37922983e+01 9.23462720e-01
 4.18697045e+00 2.52498525e-01]
E = -526.2611536159858
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.5625082        1
[INPUT] 0    0    [1    /1   ]  7584.76224173        1
[INPUT] 0    0    [1    /1   ]  3551.69285962        1
[INPUT] 0    0    [1    /1   ]  579.321303953        1
[INPUT] 0    0    [1    /1   ]  132.675495488        1
[INPUT] 0    0    [1    /1   ]  38.2327002936        1
[INPUT] 0    0    [1    /1   ]  4.60798317446        1
[INPUT] 0    0    [1    /1   ]  0.393235783291       1
[INPUT] 1    0    [1    /1   ]  1362.88569025        1
[INPUT] 1    0    [1    /1   ]  653.434793221        1
[INPUT] 1    0    [1    /1   ]  243.060979911        1
[INPUT] 1    0    [1    /1   ]  263.35540421         1
[INPUT] 1    0    [1    /1   ]  689.571653262        1
[INPUT] 1    0    [1    /1   ]  13.0117420564        1
[INPUT] 1    0    [1    /1   ]  43.7922983328        1
[INPUT] 1    0    [1    /1   ]  0.923462719534       1
[INPUT] 1    0    [1    /1   ]  4.18697044606        1
[INPUT] 1    0    [1    /1   ]  0.252498525051       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.562508216557, 1.0]], [0, [7584.762241734262, 1.0]], [0, [3551.6928596235202, 1.0]], [0, [579.3213039527236, 1.0]], [0, [132.67549548817354, 1.0]], [0, [38.23270029356278, 1.0]], [0, [4.6079831744559785, 1.0]], [0, [0.3932357832906712, 1.0]], [1, [1362.8856902514099, 1.0]], [1, [653.4347932210737, 1.0]], [1, [243.06097991054384, 1.0]], [1, [263.3554042101841, 1.0]], [1, [689.5716532623425, 1.0]], [1, [13.01174205639998, 1.0]], [1, [43.79229833275932, 1.0]], [1, [0.9234627195342688, 1.0]], [1, [4.186970446063182, 1.0]], [1, [0.25249852505051606, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.56250822]
bas 1, expnt(s) = [7584.76224173]
bas 2, expnt(s) = [3551.69285962]
bas 3, expnt(s) = [579.32130395]
bas 4, expnt(s) = [132.67549549]
bas 5, expnt(s) = [38.23270029]
bas 6, expnt(s) = [4.60798317]
bas 7, expnt(s) = [0.39323578]
bas 8, expnt(s) = [1362.88569025]
bas 9, expnt(s) = [653.43479322]
bas 10, expnt(s) = [243.06097991]
bas 11, expnt(s) = [263.35540421]
bas 12, expnt(s) = [689.57165326]
bas 13, expnt(s) = [13.01174206]
bas 14, expnt(s) = [43.79229833]
bas 15, expnt(s) = [0.92346272]
bas 16, expnt(s) = [4.18697045]
bas 17, expnt(s) = [0.25249853]
CPU time:       658.07
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61855625e+04 5.20069584e+03 7.58476224e+03 2.05339028e+03
 3.55169286e+03 1.16236246e+03 5.79321304e+02 2.98335304e+02
 1.32675495e+02 9.87661359e+01 3.82327003e+01 3.88455481e+01
 4.60798317e+00 7.94599318e+00 3.93235783e-01 1.25459860e+00
 1.36288569e+03 2.41578723e+04 6.53434793e+02 9.63800643e+03
 2.43060980e+02 2.79980928e+03 2.63355404e+02 3.09501092e+03
 6.89571653e+02 1.03088126e+04 1.30117421e+01 7.20947598e+01
 4.37922983e+01 3.28648433e+02 9.23462720e-01 2.64094041e+00
 4.18697045e+00 1.74726695e+01 2.52498525e-01 5.22165230e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.968444010741337
cond(S) = 379169.59042423364
E1 = -728.4952537011214  E_coul = 203.06766608610104
init E= -525.42758761502
    CPU time for initialize scf      0.66 sec, wall time      0.08 sec
  HOMO = -0.559416410495462  LUMO = 1.29662906815268
  mo_energy =
[-1.18254509e+02 -1.20959839e+01 -9.44526661e+00 -9.44526661e+00
 -9.44526661e+00 -1.23195767e+00 -5.59416410e-01 -5.59416410e-01
 -5.59416410e-01  1.29662907e+00  1.29662907e+00  1.29662907e+00
  1.28426992e+01  1.28426992e+01  1.28426992e+01  7.29872141e+01
  7.29872141e+01  7.29872141e+01  9.34043346e+01  3.34333795e+02
  3.34333795e+02  3.34333795e+02  8.13937841e+02  9.87174911e+02
  9.87174911e+02  9.87174911e+02  2.20772334e+03  2.20772334e+03
  2.20772334e+03  4.39264475e+03  4.39264475e+03  4.39264475e+03
  5.17047967e+03  8.42923343e+03  8.42923343e+03  8.42923343e+03
  2.04845650e+04  7.10304136e+04]
E1 = -727.9361346236725  E_coul = 201.67531160644842
cycle= 1 E= -526.260823017224  delta_E= -0.833  |g|= 0.187  |ddm|= 0.422
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.497201
diis-c [-0.24720854  1.        ]
  HOMO = -0.570569583086789  LUMO = 1.28718377955
  mo_energy =
[-1.18522729e+02 -1.21860482e+01 -9.54082628e+00 -9.54082628e+00
 -9.54082628e+00 -1.24998208e+00 -5.70569583e-01 -5.70569583e-01
 -5.70569583e-01  1.28718378e+00  1.28718378e+00  1.28718378e+00
  1.27671537e+01  1.27671537e+01  1.27671537e+01  7.28287916e+01
  7.28287916e+01  7.28287916e+01  9.32356055e+01  3.34090424e+02
  3.34090424e+02  3.34090424e+02  8.13583389e+02  9.86878819e+02
  9.86878819e+02  9.86878819e+02  2.20737685e+03  2.20737685e+03
  2.20737685e+03  4.39223790e+03  4.39223790e+03  4.39223790e+03
  5.16990838e+03  8.42871680e+03  8.42871680e+03  8.42871680e+03
  2.04838664e+04  7.10296239e+04]
E1 = -728.1922899201635  E_coul = 201.9311462678444
cycle= 2 E= -526.261143652319  delta_E= -0.000321  |g|= 0.0215  |ddm|= 0.0199
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0367032
diis-c [-9.18922626e-04  4.00275695e-02  9.59972430e-01]
  HOMO = -0.567519428998882  LUMO = 1.2902816633223
  mo_energy =
[-1.18484589e+02 -1.21684280e+01 -9.52287591e+00 -9.52287591e+00
 -9.52287591e+00 -1.24592305e+00 -5.67519429e-01 -5.67519429e-01
 -5.67519429e-01  1.29028166e+00  1.29028166e+00  1.29028166e+00
  1.27810889e+01  1.27810889e+01  1.27810889e+01  7.28554566e+01
  7.28554566e+01  7.28554566e+01  9.32677251e+01  3.34126810e+02
  3.34126810e+02  3.34126810e+02  8.13624341e+02  9.86918460e+02
  9.86918460e+02  9.86918460e+02  2.20741803e+03  2.20741803e+03
  2.20741803e+03  4.39228010e+03  4.39228010e+03  4.39228010e+03
  5.16995146e+03  8.42875966e+03  8.42875966e+03  8.42875966e+03
  2.04839097e+04  7.10296672e+04]
E1 = -728.1406389663923  E_coul = 201.8794855760569
cycle= 3 E= -526.261153390335  delta_E= -9.74e-06  |g|= 0.00266  |ddm|= 0.00465
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00502273
diis-c [-2.40665866e-07 -1.00796527e-03  1.13337377e-01  8.87670588e-01]
  HOMO = -0.568093857088084  LUMO = 1.2897246916743
  mo_energy =
[-1.18489348e+02 -1.21709755e+01 -9.52550855e+00 -9.52550855e+00
 -9.52550855e+00 -1.24667291e+00 -5.68093857e-01 -5.68093857e-01
 -5.68093857e-01  1.28972469e+00  1.28972469e+00  1.28972469e+00
  1.27789603e+01  1.27789603e+01  1.27789603e+01  7.28519065e+01
  7.28519065e+01  7.28519065e+01  9.32637156e+01  3.34122250e+02
  3.34122250e+02  3.34122250e+02  8.13619228e+02  9.86913539e+02
  9.86913539e+02  9.86913539e+02  2.20741291e+03  2.20741291e+03
  2.20741291e+03  4.39227481e+03  4.39227481e+03  4.39227481e+03
  5.16994591e+03  8.42875419e+03  8.42875419e+03  8.42875419e+03
  2.04839040e+04  7.10296614e+04]
E1 = -728.1478217970721  E_coul = 201.88666818121902
cycle= 4 E= -526.261153615853  delta_E= -2.26e-07  |g|= 4.06e-05  |ddm|= 0.000706
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.20402e-05
diis-c [-1.12197226e-09 -3.12197059e-06 -9.66411969e-04  1.03399195e-03
  9.99935542e-01]
  HOMO = -0.568068376644698  LUMO = 1.28974837891446
  mo_energy =
[-1.18489255e+02 -1.21708920e+01 -9.52542529e+00 -9.52542529e+00
 -9.52542529e+00 -1.24663976e+00 -5.68068377e-01 -5.68068377e-01
 -5.68068377e-01  1.28974838e+00  1.28974838e+00  1.28974838e+00
  1.27790324e+01  1.27790324e+01  1.27790324e+01  7.28519947e+01
  7.28519947e+01  7.28519947e+01  9.32638100e+01  3.34122343e+02
  3.34122343e+02  3.34122343e+02  8.13619317e+02  9.86913631e+02
  9.86913631e+02  9.86913631e+02  2.20741300e+03  2.20741300e+03
  2.20741300e+03  4.39227490e+03  4.39227490e+03  4.39227490e+03
  5.16994599e+03  8.42875428e+03  8.42875428e+03  8.42875428e+03
  2.04839041e+04  7.10296615e+04]
E1 = -728.1476279874009  E_coul = 201.8864743714169
cycle= 5 E= -526.261153615984  delta_E= -1.31e-10  |g|= 6.02e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.1476279874009  E_coul = 201.8864743714169
  HOMO = -0.568071426528213  LUMO = 1.28974551890017
  mo_energy =
[-1.18489270e+02 -1.21709028e+01 -9.52543633e+00 -9.52543633e+00
 -9.52543633e+00 -1.24664373e+00 -5.68071427e-01 -5.68071427e-01
 -5.68071427e-01  1.28974552e+00  1.28974552e+00  1.28974552e+00
  1.27790231e+01  1.27790231e+01  1.27790231e+01  7.28519819e+01
  7.28519819e+01  7.28519819e+01  9.32637963e+01  3.34122328e+02
  3.34122328e+02  3.34122328e+02  8.13619302e+02  9.86913616e+02
  9.86913616e+02  9.86913616e+02  2.20741298e+03  2.20741298e+03
  2.20741298e+03  4.39227488e+03  4.39227488e+03  4.39227488e+03
  5.16994597e+03  8.42875426e+03  8.42875426e+03  8.42875426e+03
  2.04839041e+04  7.10296615e+04]
E1 = -728.1476552977945  E_coul = 201.8865016818087
Extra cycle  E= -526.261153615986  delta_E= -1.71e-12  |g|= 1.47e-06  |ddm|= 3.06e-06
    CPU time for scf_cycle      0.84 sec, wall time      0.26 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 379169.59042423364
E1 = -728.1476552977945  E_coul = 201.8865016818087
init E= -526.261153615986
    CPU time for initialize scf      1.22 sec, wall time      0.21 sec
  HOMO = -0.568070922634329  LUMO = 1.28974599983082
  mo_energy =
[-1.18489266e+02 -1.21709008e+01 -9.52543427e+00 -9.52543427e+00
 -9.52543427e+00 -1.24664307e+00 -5.68070923e-01 -5.68070923e-01
 -5.68070923e-01  1.28974600e+00  1.28974600e+00  1.28974600e+00
  1.27790248e+01  1.27790248e+01  1.27790248e+01  7.28519845e+01
  7.28519845e+01  7.28519845e+01  9.32637992e+01  3.34122331e+02
  3.34122331e+02  3.34122331e+02  8.13619305e+02  9.86913619e+02
  9.86913619e+02  9.86913619e+02  2.20741299e+03  2.20741299e+03
  2.20741299e+03  4.39227489e+03  4.39227489e+03  4.39227489e+03
  5.16994598e+03  8.42875426e+03  8.42875426e+03  8.42875426e+03
  2.04839041e+04  7.10296615e+04]
E1 = -728.1476499326926  E_coul = 201.88649631670643
cycle= 1 E= -526.261153615986  delta_E= -3.41e-13  |g|= 3.15e-07  |ddm|= 5.58e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.1476499326926  E_coul = 201.88649631670643
  HOMO = -0.568071015929798  LUMO = 1.28974591012295
  mo_energy =
[-1.18489267e+02 -1.21709012e+01 -9.52543467e+00 -9.52543467e+00
 -9.52543467e+00 -1.24664319e+00 -5.68071016e-01 -5.68071016e-01
 -5.68071016e-01  1.28974591e+00  1.28974591e+00  1.28974591e+00
  1.27790244e+01  1.27790244e+01  1.27790244e+01  7.28519840e+01
  7.28519840e+01  7.28519840e+01  9.32637986e+01  3.34122331e+02
  3.34122331e+02  3.34122331e+02  8.13619305e+02  9.86913619e+02
  9.86913619e+02  9.86913619e+02  2.20741299e+03  2.20741299e+03
  2.20741299e+03  4.39227488e+03  4.39227488e+03  4.39227488e+03
  5.16994598e+03  8.42875426e+03  8.42875426e+03  8.42875426e+03
  2.04839041e+04  7.10296615e+04]
E1 = -728.1476510016192  E_coul = 201.88649738563373
Extra cycle  E= -526.261153615985  delta_E= 6.82e-13  |g|= 6.47e-08  |ddm|= 1.08e-07
    CPU time for scf_cycle      1.35 sec, wall time      0.34 sec
exp = [2.61855625e+04 7.58476224e+03 3.55169286e+03 5.79321304e+02
 1.32675495e+02 3.82327003e+01 4.60798317e+00 3.93235783e-01
 1.36288569e+03 6.53434793e+02 2.43060980e+02 2.63355404e+02
 6.89571653e+02 1.30117421e+01 4.37922983e+01 9.23462720e-01
 4.18697045e+00 2.52498525e-01]
grad_E = [ 6.80766960e-07  1.73545231e-06  6.64595092e-05  4.88344582e-04
 -4.43516292e-03  1.02388516e-03 -4.52542330e-04 -2.22901081e-02
  1.73124280e-06  7.04807496e-06  6.48944169e-05  5.10369391e-05
  6.18523753e-06 -2.92362774e-04  2.28251132e-03  2.49480352e-02
 -3.09793678e-03 -1.42927680e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:28 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.5469212        1
[INPUT] 0    0    [1    /1   ]  7584.93085788        1
[INPUT] 0    0    [1    /1   ]  3552.0257179         1
[INPUT] 0    0    [1    /1   ]  584.506120111        1
[INPUT] 0    0    [1    /1   ]  135.273014588        1
[INPUT] 0    0    [1    /1   ]  38.4945694607        1
[INPUT] 0    0    [1    /1   ]  4.60419419728        1
[INPUT] 0    0    [1    /1   ]  0.393780448183       1
[INPUT] 1    0    [1    /1   ]  1362.8800871         1
[INPUT] 1    0    [1    /1   ]  653.452350381        1
[INPUT] 1    0    [1    /1   ]  243.126619028        1
[INPUT] 1    0    [1    /1   ]  263.411067943        1
[INPUT] 1    0    [1    /1   ]  692.433887842        1
[INPUT] 1    0    [1    /1   ]  12.687913294         1
[INPUT] 1    0    [1    /1   ]  41.2057872764        1
[INPUT] 1    0    [1    /1   ]  0.925059536679       1
[INPUT] 1    0    [1    /1   ]  4.12689445755        1
[INPUT] 1    0    [1    /1   ]  0.25581000763        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.546921226476, 1.0]], [0, [7584.930857884236, 1.0]], [0, [3552.025717900268, 1.0]], [0, [584.5061201111047, 1.0]], [0, [135.27301458808418, 1.0]], [0, [38.494569460713755, 1.0]], [0, [4.604194197283298, 1.0]], [0, [0.39378044818284647, 1.0]], [1, [1362.8800870985076, 1.0]], [1, [653.4523503808301, 1.0]], [1, [243.12661902821642, 1.0]], [1, [263.4110679426197, 1.0]], [1, [692.4338878420592, 1.0]], [1, [12.687913294008078, 1.0]], [1, [41.2057872764099, 1.0]], [1, [0.9250595366794803, 1.0]], [1, [4.12689445754908, 1.0]], [1, [0.25581000762952694, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.54692123]
bas 1, expnt(s) = [7584.93085788]
bas 2, expnt(s) = [3552.0257179]
bas 3, expnt(s) = [584.50612011]
bas 4, expnt(s) = [135.27301459]
bas 5, expnt(s) = [38.49456946]
bas 6, expnt(s) = [4.6041942]
bas 7, expnt(s) = [0.39378045]
bas 8, expnt(s) = [1362.8800871]
bas 9, expnt(s) = [653.45235038]
bas 10, expnt(s) = [243.12661903]
bas 11, expnt(s) = [263.41106794]
bas 12, expnt(s) = [692.43388784]
bas 13, expnt(s) = [12.68791329]
bas 14, expnt(s) = [41.20578728]
bas 15, expnt(s) = [0.92505954]
bas 16, expnt(s) = [4.12689446]
bas 17, expnt(s) = [0.25581001]
CPU time:       665.14
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61855469e+04 5.20069352e+03 7.58493086e+03 2.05342452e+03
 3.55202572e+03 1.16244416e+03 5.84506120e+02 3.00335605e+02
 1.35273015e+02 1.00212847e+02 3.84945695e+01 3.90449278e+01
 4.60419420e+00 7.94109240e+00 3.93780448e-01 1.25590166e+00
 1.36288009e+03 2.41577482e+04 6.53452350e+02 9.63833014e+03
 2.43126619e+02 2.80075443e+03 2.63411068e+02 3.09582866e+03
 6.92433888e+02 1.03623268e+04 1.26879133e+01 6.98589647e+01
 4.12057873e+01 3.04566521e+02 9.25059537e-01 2.64664991e+00
 4.12689446e+00 1.71598543e+01 2.55810008e-01 5.30739372e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.967938040606946
cond(S) = 326985.51676794246
E1 = -728.4638358925348  E_coul = 203.06585742803958
init E= -525.397978464495
    CPU time for initialize scf      0.15 sec, wall time      0.04 sec
  HOMO = -0.558785620431141  LUMO = 1.31139996251344
  mo_energy =
[-1.18260588e+02 -1.20948428e+01 -9.44617025e+00 -9.44617025e+00
 -9.44617025e+00 -1.23119391e+00 -5.58785620e-01 -5.58785620e-01
 -5.58785620e-01  1.31139996e+00  1.31139996e+00  1.31139996e+00
  1.26062720e+01  1.26062720e+01  1.26062720e+01  6.96134917e+01
  6.96134917e+01  6.96134917e+01  9.51509789e+01  3.25752209e+02
  3.25752209e+02  3.25752209e+02  8.26596359e+02  9.77962334e+02
  9.77962334e+02  9.77962334e+02  2.19980339e+03  2.19980339e+03
  2.19980339e+03  4.38802274e+03  4.38802274e+03  4.38802274e+03
  5.19637805e+03  8.42905675e+03  8.42905675e+03  8.42905675e+03
  2.05133811e+04  7.10587634e+04]
E1 = -727.9796184664758  E_coul = 201.71071130973232
cycle= 1 E= -526.268907156743  delta_E= -0.871  |g|= 0.188  |ddm|= 1.05
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.501151
diis-c [-0.25115208  1.        ]
  HOMO = -0.567819599191792  LUMO = 1.30377407468125
  mo_energy =
[-1.18529921e+02 -1.21818206e+01 -9.53916702e+00 -9.53916702e+00
 -9.53916702e+00 -1.24658947e+00 -5.67819599e-01 -5.67819599e-01
 -5.67819599e-01  1.30377407e+00  1.30377407e+00  1.30377407e+00
  1.25347473e+01  1.25347473e+01  1.25347473e+01  6.94597199e+01
  6.94597199e+01  6.94597199e+01  9.49812447e+01  3.25508146e+02
  3.25508146e+02  3.25508146e+02  8.26236939e+02  9.77663577e+02
  9.77663577e+02  9.77663577e+02  2.19945319e+03  2.19945319e+03
  2.19945319e+03  4.38761219e+03  4.38761219e+03  4.38761219e+03
  5.19580406e+03  8.42853704e+03  8.42853704e+03  8.42853704e+03
  2.05126801e+04  7.10579711e+04]
E1 = -728.2298798633552  E_coul = 201.9606471409876
cycle= 2 E= -526.269232722368  delta_E= -0.000326  |g|= 0.0217  |ddm|= 0.0191
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0368619
diis-c [-9.06927171e-04  4.07616165e-02  9.59238384e-01]
  HOMO = -0.564961876132153  LUMO = 1.30670750583234
  mo_energy =
[-1.18491969e+02 -1.21646768e+01 -9.52169386e+00 -9.52169386e+00
 -9.52169386e+00 -1.24278030e+00 -5.64961876e-01 -5.64961876e-01
 -5.64961876e-01  1.30670751e+00  1.30670751e+00  1.30670751e+00
  1.25480243e+01  1.25480243e+01  1.25480243e+01  6.94855002e+01
  6.94855002e+01  6.94855002e+01  9.50132332e+01  3.25544288e+02
  3.25544288e+02  3.25544288e+02  8.26277768e+02  9.77703071e+02
  9.77703071e+02  9.77703071e+02  2.19949424e+03  2.19949424e+03
  2.19949424e+03  4.38765426e+03  4.38765426e+03  4.38765426e+03
  5.19584703e+03  8.42857979e+03  8.42857979e+03  8.42857979e+03
  2.05127233e+04  7.10580143e+04]
E1 = -728.1795150932653  E_coul = 201.91027286991502
cycle= 3 E= -526.26924222335  delta_E= -9.5e-06  |g|= 0.00261  |ddm|= 0.00453
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00494204
diis-c [-2.54271201e-07 -9.99610293e-04  1.10990339e-01  8.90009271e-01]
  HOMO = -0.565514297456215  LUMO = 1.30616962870436
  mo_energy =
[-1.18496628e+02 -1.21671527e+01 -9.52425498e+00 -9.52425498e+00
 -9.52425498e+00 -1.24350147e+00 -5.65514297e-01 -5.65514297e-01
 -5.65514297e-01  1.30616963e+00  1.30616963e+00  1.30616963e+00
  1.25459833e+01  1.25459833e+01  1.25459833e+01  6.94820876e+01
  6.94820876e+01  6.94820876e+01  9.50092994e+01  3.25539828e+02
  3.25539828e+02  3.25539828e+02  8.26272751e+02  9.77698249e+02
  9.77698249e+02  9.77698249e+02  2.19948922e+03  2.19948922e+03
  2.19948922e+03  4.38764907e+03  4.38764907e+03  4.38764907e+03
  5.19584158e+03  8.42857442e+03  8.42857442e+03  8.42857442e+03
  2.05127177e+04  7.10580086e+04]
E1 = -728.1864434541734  E_coul = 201.91720101915672
cycle= 4 E= -526.269242435017  delta_E= -2.12e-07  |g|= 4.11e-05  |ddm|= 0.000685
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.29234e-05
diis-c [-1.17977319e-09 -3.59399232e-06 -1.02542940e-03  6.97143773e-04
  1.00033188e+00]
  HOMO = -0.565488437271315  LUMO = 1.30619373731191
  mo_energy =
[-1.18496533e+02 -1.21670678e+01 -9.52417037e+00 -9.52417037e+00
 -9.52417037e+00 -1.24346785e+00 -5.65488437e-01 -5.65488437e-01
 -5.65488437e-01  1.30619374e+00  1.30619374e+00  1.30619374e+00
  1.25460560e+01  1.25460560e+01  1.25460560e+01  6.94821769e+01
  6.94821769e+01  6.94821769e+01  9.50093954e+01  3.25539922e+02
  3.25539922e+02  3.25539922e+02  8.26272841e+02  9.77698343e+02
  9.77698343e+02  9.77698343e+02  2.19948931e+03  2.19948931e+03
  2.19948931e+03  4.38764916e+03  4.38764916e+03  4.38764916e+03
  5.19584166e+03  8.42857450e+03  8.42857450e+03  8.42857450e+03
  2.05127178e+04  7.10580087e+04]
E1 = -728.1862497744202  E_coul = 201.9170073392725
cycle= 5 E= -526.269242435148  delta_E= -1.31e-10  |g|= 6.07e-06  |ddm|= 2.34e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.1862497744202  E_coul = 201.9170073392725
  HOMO = -0.565491495325131  LUMO = 1.30619086146154
  mo_energy =
[-1.18496548e+02 -1.21670787e+01 -9.52418149e+00 -9.52418149e+00
 -9.52418149e+00 -1.24347183e+00 -5.65491495e-01 -5.65491495e-01
 -5.65491495e-01  1.30619086e+00  1.30619086e+00  1.30619086e+00
  1.25460467e+01  1.25460467e+01  1.25460467e+01  6.94821641e+01
  6.94821641e+01  6.94821641e+01  9.50093816e+01  3.25539907e+02
  3.25539907e+02  3.25539907e+02  8.26272826e+02  9.77698327e+02
  9.77698327e+02  9.77698327e+02  2.19948929e+03  2.19948929e+03
  2.19948929e+03  4.38764914e+03  4.38764914e+03  4.38764914e+03
  5.19584165e+03  8.42857449e+03  8.42857449e+03  8.42857449e+03
  2.05127177e+04  7.10580087e+04]
E1 = -728.1862768815687  E_coul = 201.9170344464183
Extra cycle  E= -526.26924243515  delta_E= -2.61e-12  |g|= 1.47e-06  |ddm|= 3.06e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.23 sec
exp = [2.61855469e+04 7.58493086e+03 3.55202572e+03 5.84506120e+02
 1.35273015e+02 3.84945695e+01 4.60419420e+00 3.93780448e-01
 1.36288009e+03 6.53452350e+02 2.43126619e+02 2.63411068e+02
 6.92433888e+02 1.26879133e+01 4.12057873e+01 9.25059537e-01
 4.12689446e+00 2.55810008e-01]
E = -526.2692424351503
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.5469212        1
[INPUT] 0    0    [1    /1   ]  7584.93085788        1
[INPUT] 0    0    [1    /1   ]  3552.0257179         1
[INPUT] 0    0    [1    /1   ]  584.506120111        1
[INPUT] 0    0    [1    /1   ]  135.273014588        1
[INPUT] 0    0    [1    /1   ]  38.4945694607        1
[INPUT] 0    0    [1    /1   ]  4.60419419728        1
[INPUT] 0    0    [1    /1   ]  0.393780448183       1
[INPUT] 1    0    [1    /1   ]  1362.8800871         1
[INPUT] 1    0    [1    /1   ]  653.452350381        1
[INPUT] 1    0    [1    /1   ]  243.126619028        1
[INPUT] 1    0    [1    /1   ]  263.411067943        1
[INPUT] 1    0    [1    /1   ]  692.433887842        1
[INPUT] 1    0    [1    /1   ]  12.687913294         1
[INPUT] 1    0    [1    /1   ]  41.2057872764        1
[INPUT] 1    0    [1    /1   ]  0.925059536679       1
[INPUT] 1    0    [1    /1   ]  4.12689445755        1
[INPUT] 1    0    [1    /1   ]  0.25581000763        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.546921226476, 1.0]], [0, [7584.930857884236, 1.0]], [0, [3552.025717900268, 1.0]], [0, [584.5061201111047, 1.0]], [0, [135.27301458808418, 1.0]], [0, [38.494569460713755, 1.0]], [0, [4.604194197283298, 1.0]], [0, [0.39378044818284647, 1.0]], [1, [1362.8800870985076, 1.0]], [1, [653.4523503808301, 1.0]], [1, [243.12661902821642, 1.0]], [1, [263.4110679426197, 1.0]], [1, [692.4338878420592, 1.0]], [1, [12.687913294008078, 1.0]], [1, [41.2057872764099, 1.0]], [1, [0.9250595366794803, 1.0]], [1, [4.12689445754908, 1.0]], [1, [0.25581000762952694, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.54692123]
bas 1, expnt(s) = [7584.93085788]
bas 2, expnt(s) = [3552.0257179]
bas 3, expnt(s) = [584.50612011]
bas 4, expnt(s) = [135.27301459]
bas 5, expnt(s) = [38.49456946]
bas 6, expnt(s) = [4.6041942]
bas 7, expnt(s) = [0.39378045]
bas 8, expnt(s) = [1362.8800871]
bas 9, expnt(s) = [653.45235038]
bas 10, expnt(s) = [243.12661903]
bas 11, expnt(s) = [263.41106794]
bas 12, expnt(s) = [692.43388784]
bas 13, expnt(s) = [12.68791329]
bas 14, expnt(s) = [41.20578728]
bas 15, expnt(s) = [0.92505954]
bas 16, expnt(s) = [4.12689446]
bas 17, expnt(s) = [0.25581001]
CPU time:       665.99
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61855469e+04 5.20069352e+03 7.58493086e+03 2.05342452e+03
 3.55202572e+03 1.16244416e+03 5.84506120e+02 3.00335605e+02
 1.35273015e+02 1.00212847e+02 3.84945695e+01 3.90449278e+01
 4.60419420e+00 7.94109240e+00 3.93780448e-01 1.25590166e+00
 1.36288009e+03 2.41577482e+04 6.53452350e+02 9.63833014e+03
 2.43126619e+02 2.80075443e+03 2.63411068e+02 3.09582866e+03
 6.92433888e+02 1.03623268e+04 1.26879133e+01 6.98589647e+01
 4.12057873e+01 3.04566521e+02 9.25059537e-01 2.64664991e+00
 4.12689446e+00 1.71598543e+01 2.55810008e-01 5.30739372e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.967938040606946
cond(S) = 326985.51676794246
E1 = -728.4638358925348  E_coul = 203.06585742803958
init E= -525.397978464495
    CPU time for initialize scf      0.15 sec, wall time      0.04 sec
  HOMO = -0.558785620431141  LUMO = 1.31139996251344
  mo_energy =
[-1.18260588e+02 -1.20948428e+01 -9.44617025e+00 -9.44617025e+00
 -9.44617025e+00 -1.23119391e+00 -5.58785620e-01 -5.58785620e-01
 -5.58785620e-01  1.31139996e+00  1.31139996e+00  1.31139996e+00
  1.26062720e+01  1.26062720e+01  1.26062720e+01  6.96134917e+01
  6.96134917e+01  6.96134917e+01  9.51509789e+01  3.25752209e+02
  3.25752209e+02  3.25752209e+02  8.26596359e+02  9.77962334e+02
  9.77962334e+02  9.77962334e+02  2.19980339e+03  2.19980339e+03
  2.19980339e+03  4.38802274e+03  4.38802274e+03  4.38802274e+03
  5.19637805e+03  8.42905675e+03  8.42905675e+03  8.42905675e+03
  2.05133811e+04  7.10587634e+04]
E1 = -727.9796184664758  E_coul = 201.71071130973232
cycle= 1 E= -526.268907156743  delta_E= -0.871  |g|= 0.188  |ddm|= 1.05
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.501151
diis-c [-0.25115208  1.        ]
  HOMO = -0.567819599191792  LUMO = 1.30377407468125
  mo_energy =
[-1.18529921e+02 -1.21818206e+01 -9.53916702e+00 -9.53916702e+00
 -9.53916702e+00 -1.24658947e+00 -5.67819599e-01 -5.67819599e-01
 -5.67819599e-01  1.30377407e+00  1.30377407e+00  1.30377407e+00
  1.25347473e+01  1.25347473e+01  1.25347473e+01  6.94597199e+01
  6.94597199e+01  6.94597199e+01  9.49812447e+01  3.25508146e+02
  3.25508146e+02  3.25508146e+02  8.26236939e+02  9.77663577e+02
  9.77663577e+02  9.77663577e+02  2.19945319e+03  2.19945319e+03
  2.19945319e+03  4.38761219e+03  4.38761219e+03  4.38761219e+03
  5.19580406e+03  8.42853704e+03  8.42853704e+03  8.42853704e+03
  2.05126801e+04  7.10579711e+04]
E1 = -728.2298798633552  E_coul = 201.9606471409876
cycle= 2 E= -526.269232722368  delta_E= -0.000326  |g|= 0.0217  |ddm|= 0.0191
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0368619
diis-c [-9.06927171e-04  4.07616165e-02  9.59238384e-01]
  HOMO = -0.564961876132153  LUMO = 1.30670750583234
  mo_energy =
[-1.18491969e+02 -1.21646768e+01 -9.52169386e+00 -9.52169386e+00
 -9.52169386e+00 -1.24278030e+00 -5.64961876e-01 -5.64961876e-01
 -5.64961876e-01  1.30670751e+00  1.30670751e+00  1.30670751e+00
  1.25480243e+01  1.25480243e+01  1.25480243e+01  6.94855002e+01
  6.94855002e+01  6.94855002e+01  9.50132332e+01  3.25544288e+02
  3.25544288e+02  3.25544288e+02  8.26277768e+02  9.77703071e+02
  9.77703071e+02  9.77703071e+02  2.19949424e+03  2.19949424e+03
  2.19949424e+03  4.38765426e+03  4.38765426e+03  4.38765426e+03
  5.19584703e+03  8.42857979e+03  8.42857979e+03  8.42857979e+03
  2.05127233e+04  7.10580143e+04]
E1 = -728.1795150932653  E_coul = 201.91027286991502
cycle= 3 E= -526.26924222335  delta_E= -9.5e-06  |g|= 0.00261  |ddm|= 0.00453
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00494204
diis-c [-2.54271201e-07 -9.99610293e-04  1.10990339e-01  8.90009271e-01]
  HOMO = -0.565514297456215  LUMO = 1.30616962870436
  mo_energy =
[-1.18496628e+02 -1.21671527e+01 -9.52425498e+00 -9.52425498e+00
 -9.52425498e+00 -1.24350147e+00 -5.65514297e-01 -5.65514297e-01
 -5.65514297e-01  1.30616963e+00  1.30616963e+00  1.30616963e+00
  1.25459833e+01  1.25459833e+01  1.25459833e+01  6.94820876e+01
  6.94820876e+01  6.94820876e+01  9.50092994e+01  3.25539828e+02
  3.25539828e+02  3.25539828e+02  8.26272751e+02  9.77698249e+02
  9.77698249e+02  9.77698249e+02  2.19948922e+03  2.19948922e+03
  2.19948922e+03  4.38764907e+03  4.38764907e+03  4.38764907e+03
  5.19584158e+03  8.42857442e+03  8.42857442e+03  8.42857442e+03
  2.05127177e+04  7.10580086e+04]
E1 = -728.1864434541734  E_coul = 201.91720101915672
cycle= 4 E= -526.269242435017  delta_E= -2.12e-07  |g|= 4.11e-05  |ddm|= 0.000685
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.29234e-05
diis-c [-1.17977319e-09 -3.59399232e-06 -1.02542940e-03  6.97143773e-04
  1.00033188e+00]
  HOMO = -0.565488437271315  LUMO = 1.30619373731191
  mo_energy =
[-1.18496533e+02 -1.21670678e+01 -9.52417037e+00 -9.52417037e+00
 -9.52417037e+00 -1.24346785e+00 -5.65488437e-01 -5.65488437e-01
 -5.65488437e-01  1.30619374e+00  1.30619374e+00  1.30619374e+00
  1.25460560e+01  1.25460560e+01  1.25460560e+01  6.94821769e+01
  6.94821769e+01  6.94821769e+01  9.50093954e+01  3.25539922e+02
  3.25539922e+02  3.25539922e+02  8.26272841e+02  9.77698343e+02
  9.77698343e+02  9.77698343e+02  2.19948931e+03  2.19948931e+03
  2.19948931e+03  4.38764916e+03  4.38764916e+03  4.38764916e+03
  5.19584166e+03  8.42857450e+03  8.42857450e+03  8.42857450e+03
  2.05127178e+04  7.10580087e+04]
E1 = -728.1862497744202  E_coul = 201.9170073392725
cycle= 5 E= -526.269242435148  delta_E= -1.31e-10  |g|= 6.07e-06  |ddm|= 2.34e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.1862497744202  E_coul = 201.9170073392725
  HOMO = -0.565491495325131  LUMO = 1.30619086146154
  mo_energy =
[-1.18496548e+02 -1.21670787e+01 -9.52418149e+00 -9.52418149e+00
 -9.52418149e+00 -1.24347183e+00 -5.65491495e-01 -5.65491495e-01
 -5.65491495e-01  1.30619086e+00  1.30619086e+00  1.30619086e+00
  1.25460467e+01  1.25460467e+01  1.25460467e+01  6.94821641e+01
  6.94821641e+01  6.94821641e+01  9.50093816e+01  3.25539907e+02
  3.25539907e+02  3.25539907e+02  8.26272826e+02  9.77698327e+02
  9.77698327e+02  9.77698327e+02  2.19948929e+03  2.19948929e+03
  2.19948929e+03  4.38764914e+03  4.38764914e+03  4.38764914e+03
  5.19584165e+03  8.42857449e+03  8.42857449e+03  8.42857449e+03
  2.05127177e+04  7.10580087e+04]
E1 = -728.1862768815687  E_coul = 201.9170344464183
Extra cycle  E= -526.26924243515  delta_E= -2.61e-12  |g|= 1.47e-06  |ddm|= 3.06e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.24 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 326985.51676794246
E1 = -728.1862768815687  E_coul = 201.9170344464183
init E= -526.26924243515
    CPU time for initialize scf      0.99 sec, wall time      0.21 sec
  HOMO = -0.565490998999962  LUMO = 1.30619133691044
  mo_energy =
[-1.18496545e+02 -1.21670767e+01 -9.52417945e+00 -9.52417945e+00
 -9.52417945e+00 -1.24347118e+00 -5.65490999e-01 -5.65490999e-01
 -5.65490999e-01  1.30619134e+00  1.30619134e+00  1.30619134e+00
  1.25460484e+01  1.25460484e+01  1.25460484e+01  6.94821667e+01
  6.94821667e+01  6.94821667e+01  9.50093845e+01  3.25539911e+02
  3.25539911e+02  3.25539911e+02  8.26272829e+02  9.77698331e+02
  9.77698331e+02  9.77698331e+02  2.19948929e+03  2.19948929e+03
  2.19948929e+03  4.38764915e+03  4.38764915e+03  4.38764915e+03
  5.19584165e+03  8.42857449e+03  8.42857449e+03  8.42857449e+03
  2.05127177e+04  7.10580087e+04]
E1 = -728.1862716130075  E_coul = 201.91702917785733
cycle= 1 E= -526.26924243515  delta_E= 1.14e-13  |g|= 3.12e-07  |ddm|= 5.51e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.1862716130075  E_coul = 201.91702917785733
  HOMO = -0.565491089744768  LUMO = 1.30619124931309
  mo_energy =
[-1.18496545e+02 -1.21670771e+01 -9.52417984e+00 -9.52417984e+00
 -9.52417984e+00 -1.24347130e+00 -5.65491090e-01 -5.65491090e-01
 -5.65491090e-01  1.30619125e+00  1.30619125e+00  1.30619125e+00
  1.25460481e+01  1.25460481e+01  1.25460481e+01  6.94821662e+01
  6.94821662e+01  6.94821662e+01  9.50093839e+01  3.25539910e+02
  3.25539910e+02  3.25539910e+02  8.26272829e+02  9.77698330e+02
  9.77698330e+02  9.77698330e+02  2.19948929e+03  2.19948929e+03
  2.19948929e+03  4.38764915e+03  4.38764915e+03  4.38764915e+03
  5.19584165e+03  8.42857449e+03  8.42857449e+03  8.42857449e+03
  2.05127177e+04  7.10580087e+04]
E1 = -728.186272652697  E_coul = 201.91703021754722
Extra cycle  E= -526.26924243515  delta_E= 4.55e-13  |g|= 6.36e-08  |ddm|= 1.06e-07
    CPU time for scf_cycle      1.13 sec, wall time      0.35 sec
exp = [2.61855469e+04 7.58493086e+03 3.55202572e+03 5.84506120e+02
 1.35273015e+02 3.84945695e+01 4.60419420e+00 3.93780448e-01
 1.36288009e+03 6.53452350e+02 2.43126619e+02 2.63411068e+02
 6.92433888e+02 1.26879133e+01 4.12057873e+01 9.25059537e-01
 4.12689446e+00 2.55810008e-01]
grad_E = [ 6.95123612e-07  1.77474768e-06  6.77258436e-05  2.02280943e-04
 -1.64815319e-03 -4.76293098e-03 -6.17839298e-03 -8.76160178e-03
  3.83895620e-06  1.60133006e-05  1.54807585e-04  1.21976694e-04
  1.39640175e-05  1.76905220e-02 -3.02853007e-03  1.31319384e-02
 -2.68784234e-02 -4.04425288e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.53059          1
[INPUT] 0    0    [1    /1   ]  7585.10789848        1
[INPUT] 0    0    [1    /1   ]  3552.37501292        1
[INPUT] 0    0    [1    /1   ]  589.991162846        1
[INPUT] 0    0    [1    /1   ]  137.199345924        1
[INPUT] 0    0    [1    /1   ]  38.8724333299        1
[INPUT] 0    0    [1    /1   ]  4.60669234482        1
[INPUT] 0    0    [1    /1   ]  0.394142301236       1
[INPUT] 1    0    [1    /1   ]  1362.87183316        1
[INPUT] 1    0    [1    /1   ]  653.449936183        1
[INPUT] 1    0    [1    /1   ]  243.07864005         1
[INPUT] 1    0    [1    /1   ]  263.366248465        1
[INPUT] 1    0    [1    /1   ]  697.297851868        1
[INPUT] 1    0    [1    /1   ]  12.7329230887        1
[INPUT] 1    0    [1    /1   ]  41.4816488428        1
[INPUT] 1    0    [1    /1   ]  0.928788691294       1
[INPUT] 1    0    [1    /1   ]  4.14444667389        1
[INPUT] 1    0    [1    /1   ]  0.258321006902       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.530590025603, 1.0]], [0, [7585.107898482591, 1.0]], [0, [3552.3750129172795, 1.0]], [0, [589.9911628456465, 1.0]], [0, [137.19934592360644, 1.0]], [0, [38.87243332994346, 1.0]], [0, [4.606692344816781, 1.0]], [0, [0.394142301236033, 1.0]], [1, [1362.8718331644884, 1.0]], [1, [653.4499361826962, 1.0]], [1, [243.07864004982835, 1.0]], [1, [263.3662484648668, 1.0]], [1, [697.297851867557, 1.0]], [1, [12.732923088704863, 1.0]], [1, [41.48164884281456, 1.0]], [1, [0.9287886912940622, 1.0]], [1, [4.144446673892506, 1.0]], [1, [0.2583210069018388, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.53059003]
bas 1, expnt(s) = [7585.10789848]
bas 2, expnt(s) = [3552.37501292]
bas 3, expnt(s) = [589.99116285]
bas 4, expnt(s) = [137.19934592]
bas 5, expnt(s) = [38.87243333]
bas 6, expnt(s) = [4.60669234]
bas 7, expnt(s) = [0.3941423]
bas 8, expnt(s) = [1362.87183316]
bas 9, expnt(s) = [653.44993618]
bas 10, expnt(s) = [243.07864005]
bas 11, expnt(s) = [263.36624846]
bas 12, expnt(s) = [697.29785187]
bas 13, expnt(s) = [12.73292309]
bas 14, expnt(s) = [41.48164884]
bas 15, expnt(s) = [0.92878869]
bas 16, expnt(s) = [4.14444667]
bas 17, expnt(s) = [0.25832101]
CPU time:       672.45
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61855306e+04 5.20069109e+03 7.58510790e+03 2.05346047e+03
 3.55237501e+03 1.16252989e+03 5.89991163e+02 3.02446912e+02
 1.37199346e+02 1.01281251e+02 3.88724333e+01 3.93320262e+01
 4.60669234e+00 7.94432369e+00 3.94142301e-01 1.25676712e+00
 1.36287183e+03 2.41575653e+04 6.53449936e+02 9.63828563e+03
 2.43078640e+02 2.80006356e+03 2.63366248e+02 3.09517023e+03
 6.97297852e+02 1.04533936e+04 1.27329231e+01 7.01688788e+01
 4.14816488e+01 3.07117388e+02 9.28788691e-01 2.65999329e+00
 4.14444667e+00 1.72511316e+01 2.58321007e-01 5.37259432e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.96720328776562
cond(S) = 269139.60539547075
E1 = -728.4728876036963  E_coul = 203.07351336409013
init E= -525.399374239606
    CPU time for initialize scf      0.66 sec, wall time      0.08 sec
  HOMO = -0.55847240689719  LUMO = 1.32599839053274
  mo_energy =
[-1.18261309e+02 -1.20947564e+01 -9.44568050e+00 -9.44568050e+00
 -9.44568050e+00 -1.23103181e+00 -5.58472407e-01 -5.58472407e-01
 -5.58472407e-01  1.32599839e+00  1.32599839e+00  1.32599839e+00
  1.26862993e+01  1.26862993e+01  1.26862993e+01  7.00612288e+01
  7.00612288e+01  7.00612288e+01  9.68815432e+01  3.26883669e+02
  3.26883669e+02  3.26883669e+02  8.38041896e+02  9.79683832e+02
  9.79683832e+02  9.79683832e+02  2.20332036e+03  2.20332036e+03
  2.20332036e+03  4.39640922e+03  4.39640922e+03  4.39640922e+03
  5.22121930e+03  8.44408791e+03  8.44408791e+03  8.44408791e+03
  2.05414476e+04  7.10865126e+04]
E1 = -728.049052406129  E_coul = 201.77630511050896
cycle= 1 E= -526.27274729562  delta_E= -0.873  |g|= 0.186  |ddm|= 0.879
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.498657
diis-c [-0.24865928  1.        ]
  HOMO = -0.565999713139339  LUMO = 1.31968252150797
  mo_energy =
[-1.18524885e+02 -1.21776607e+01 -9.53441346e+00 -9.53441346e+00
 -9.53441346e+00 -1.24461882e+00 -5.65999713e-01 -5.65999713e-01
 -5.65999713e-01  1.31968252e+00  1.31968252e+00  1.31968252e+00
  1.26183320e+01  1.26183320e+01  1.26183320e+01  6.99118956e+01
  6.99118956e+01  6.99118956e+01  9.67157266e+01  3.26645248e+02
  3.26645248e+02  3.26645248e+02  8.37687774e+02  9.79391068e+02
  9.79391068e+02  9.79391068e+02  2.20297643e+03  2.20297643e+03
  2.20297643e+03  4.39600545e+03  4.39600545e+03  4.39600545e+03
  5.22065350e+03  8.44357590e+03  8.44357590e+03  8.44357590e+03
  2.05407555e+04  7.10857296e+04]
E1 = -728.2870679762319  E_coul = 202.01401051000224
cycle= 2 E= -526.27305746623  delta_E= -0.00031  |g|= 0.021  |ddm|= 0.0178
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0357871
diis-c [-8.64842770e-04  3.93547472e-02  9.60645253e-01]
  HOMO = -0.563362347910069  LUMO = 1.32242723639397
  mo_energy =
[-1.18488246e+02 -1.21613624e+01 -9.51780474e+00 -9.51780474e+00
 -9.51780474e+00 -1.24109708e+00 -5.63362348e-01 -5.63362348e-01
 -5.63362348e-01  1.32242724e+00  1.32242724e+00  1.32242724e+00
  1.26309358e+01  1.26309358e+01  1.26309358e+01  6.99366860e+01
  6.99366860e+01  6.99366860e+01  9.67466737e+01  3.26680122e+02
  3.26680122e+02  3.26680122e+02  8.37727263e+02  9.79429218e+02
  9.79429218e+02  9.79429218e+02  2.20301610e+03  2.20301610e+03
  2.20301610e+03  4.39604613e+03  4.39604613e+03  4.39604613e+03
  5.22069506e+03  8.44361723e+03  8.44361723e+03  8.44361723e+03
  2.05407973e+04  7.10857714e+04]
E1 = -728.2391688925658  E_coul = 201.96610271600176
cycle= 3 E= -526.273066176564  delta_E= -8.71e-06  |g|= 0.00252  |ddm|= 0.00427
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00478437
diis-c [-2.44056531e-07 -9.79357571e-04  1.10716402e-01  8.90262956e-01]
  HOMO = -0.563888399955296  LUMO = 1.32191064785785
  mo_energy =
[-1.18492749e+02 -1.21637413e+01 -9.52026555e+00 -9.52026555e+00
 -9.52026555e+00 -1.24178445e+00 -5.63888400e-01 -5.63888400e-01
 -5.63888400e-01  1.32191065e+00  1.32191065e+00  1.32191065e+00
  1.26289737e+01  1.26289737e+01  1.26289737e+01  6.99333910e+01
  6.99333910e+01  6.99333910e+01  9.67428624e+01  3.26675811e+02
  3.26675811e+02  3.26675811e+02  8.37722407e+02  9.79424555e+02
  9.79424555e+02  9.79424555e+02  2.20301124e+03  2.20301124e+03
  2.20301124e+03  4.39604111e+03  4.39604111e+03  4.39604111e+03
  5.22068978e+03  8.44361204e+03  8.44361204e+03  8.44361204e+03
  2.05407919e+04  7.10857659e+04]
E1 = -728.2457944597517  E_coul = 201.97272808855362
cycle= 4 E= -526.273066371198  delta_E= -1.95e-07  |g|= 4.12e-05  |ddm|= 0.000653
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.3539e-05
diis-c [-1.14633656e-09 -3.85280400e-06 -9.64619384e-04  1.67171949e-03
  9.99296753e-01]
  HOMO = -0.563862759591736  LUMO = 1.32193472625189
  mo_energy =
[-1.18492654e+02 -1.21636568e+01 -9.52018125e+00 -9.52018125e+00
 -9.52018125e+00 -1.24175113e+00 -5.63862760e-01 -5.63862760e-01
 -5.63862760e-01  1.32193473e+00  1.32193473e+00  1.32193473e+00
  1.26290462e+01  1.26290462e+01  1.26290462e+01  6.99334803e+01
  6.99334803e+01  6.99334803e+01  9.67429585e+01  3.26675906e+02
  3.26675906e+02  3.26675906e+02  8.37722497e+02  9.79424649e+02
  9.79424649e+02  9.79424649e+02  2.20301133e+03  2.20301133e+03
  2.20301133e+03  4.39604120e+03  4.39604120e+03  4.39604120e+03
  5.22068986e+03  8.44361212e+03  8.44361212e+03  8.44361212e+03
  2.05407920e+04  7.10857660e+04]
E1 = -728.2456030601757  E_coul = 201.97253668884852
cycle= 5 E= -526.273066371327  delta_E= -1.29e-10  |g|= 5.92e-06  |ddm|= 2.3e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2456030601757  E_coul = 201.97253668884852
  HOMO = -0.563865726620205  LUMO = 1.32193191589627
  mo_energy =
[-1.18492669e+02 -1.21636674e+01 -9.52019209e+00 -9.52019209e+00
 -9.52019209e+00 -1.24175499e+00 -5.63865727e-01 -5.63865727e-01
 -5.63865727e-01  1.32193192e+00  1.32193192e+00  1.32193192e+00
  1.26290371e+01  1.26290371e+01  1.26290371e+01  6.99334678e+01
  6.99334678e+01  6.99334678e+01  9.67429449e+01  3.26675892e+02
  3.26675892e+02  3.26675892e+02  8.37722482e+02  9.79424634e+02
  9.79424634e+02  9.79424634e+02  2.20301132e+03  2.20301132e+03
  2.20301132e+03  4.39604118e+03  4.39604118e+03  4.39604118e+03
  5.22068985e+03  8.44361211e+03  8.44361211e+03  8.44361211e+03
  2.05407919e+04  7.10857659e+04]
E1 = -728.2456292478475  E_coul = 201.97256287651697
Extra cycle  E= -526.273066371331  delta_E= -3.41e-12  |g|= 1.43e-06  |ddm|= 2.95e-06
    CPU time for scf_cycle      0.84 sec, wall time      0.25 sec
exp = [2.61855306e+04 7.58510790e+03 3.55237501e+03 5.89991163e+02
 1.37199346e+02 3.88724333e+01 4.60669234e+00 3.94142301e-01
 1.36287183e+03 6.53449936e+02 2.43078640e+02 2.63366248e+02
 6.97297852e+02 1.27329231e+01 4.14816488e+01 9.28788691e-01
 4.14444667e+00 2.58321007e-01]
E = -526.2730663713305
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.53059          1
[INPUT] 0    0    [1    /1   ]  7585.10789848        1
[INPUT] 0    0    [1    /1   ]  3552.37501292        1
[INPUT] 0    0    [1    /1   ]  589.991162846        1
[INPUT] 0    0    [1    /1   ]  137.199345924        1
[INPUT] 0    0    [1    /1   ]  38.8724333299        1
[INPUT] 0    0    [1    /1   ]  4.60669234482        1
[INPUT] 0    0    [1    /1   ]  0.394142301236       1
[INPUT] 1    0    [1    /1   ]  1362.87183316        1
[INPUT] 1    0    [1    /1   ]  653.449936183        1
[INPUT] 1    0    [1    /1   ]  243.07864005         1
[INPUT] 1    0    [1    /1   ]  263.366248465        1
[INPUT] 1    0    [1    /1   ]  697.297851868        1
[INPUT] 1    0    [1    /1   ]  12.7329230887        1
[INPUT] 1    0    [1    /1   ]  41.4816488428        1
[INPUT] 1    0    [1    /1   ]  0.928788691294       1
[INPUT] 1    0    [1    /1   ]  4.14444667389        1
[INPUT] 1    0    [1    /1   ]  0.258321006902       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.530590025603, 1.0]], [0, [7585.107898482591, 1.0]], [0, [3552.3750129172795, 1.0]], [0, [589.9911628456465, 1.0]], [0, [137.19934592360644, 1.0]], [0, [38.87243332994346, 1.0]], [0, [4.606692344816781, 1.0]], [0, [0.394142301236033, 1.0]], [1, [1362.8718331644884, 1.0]], [1, [653.4499361826962, 1.0]], [1, [243.07864004982835, 1.0]], [1, [263.3662484648668, 1.0]], [1, [697.297851867557, 1.0]], [1, [12.732923088704863, 1.0]], [1, [41.48164884281456, 1.0]], [1, [0.9287886912940622, 1.0]], [1, [4.144446673892506, 1.0]], [1, [0.2583210069018388, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.53059003]
bas 1, expnt(s) = [7585.10789848]
bas 2, expnt(s) = [3552.37501292]
bas 3, expnt(s) = [589.99116285]
bas 4, expnt(s) = [137.19934592]
bas 5, expnt(s) = [38.87243333]
bas 6, expnt(s) = [4.60669234]
bas 7, expnt(s) = [0.3941423]
bas 8, expnt(s) = [1362.87183316]
bas 9, expnt(s) = [653.44993618]
bas 10, expnt(s) = [243.07864005]
bas 11, expnt(s) = [263.36624846]
bas 12, expnt(s) = [697.29785187]
bas 13, expnt(s) = [12.73292309]
bas 14, expnt(s) = [41.48164884]
bas 15, expnt(s) = [0.92878869]
bas 16, expnt(s) = [4.14444667]
bas 17, expnt(s) = [0.25832101]
CPU time:       673.64
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61855306e+04 5.20069109e+03 7.58510790e+03 2.05346047e+03
 3.55237501e+03 1.16252989e+03 5.89991163e+02 3.02446912e+02
 1.37199346e+02 1.01281251e+02 3.88724333e+01 3.93320262e+01
 4.60669234e+00 7.94432369e+00 3.94142301e-01 1.25676712e+00
 1.36287183e+03 2.41575653e+04 6.53449936e+02 9.63828563e+03
 2.43078640e+02 2.80006356e+03 2.63366248e+02 3.09517023e+03
 6.97297852e+02 1.04533936e+04 1.27329231e+01 7.01688788e+01
 4.14816488e+01 3.07117388e+02 9.28788691e-01 2.65999329e+00
 4.14444667e+00 1.72511316e+01 2.58321007e-01 5.37259432e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.96720328776562
cond(S) = 269139.60539547075
E1 = -728.4728876036963  E_coul = 203.07351336409013
init E= -525.399374239606
    CPU time for initialize scf      0.66 sec, wall time      0.08 sec
  HOMO = -0.55847240689719  LUMO = 1.32599839053274
  mo_energy =
[-1.18261309e+02 -1.20947564e+01 -9.44568050e+00 -9.44568050e+00
 -9.44568050e+00 -1.23103181e+00 -5.58472407e-01 -5.58472407e-01
 -5.58472407e-01  1.32599839e+00  1.32599839e+00  1.32599839e+00
  1.26862993e+01  1.26862993e+01  1.26862993e+01  7.00612288e+01
  7.00612288e+01  7.00612288e+01  9.68815432e+01  3.26883669e+02
  3.26883669e+02  3.26883669e+02  8.38041896e+02  9.79683832e+02
  9.79683832e+02  9.79683832e+02  2.20332036e+03  2.20332036e+03
  2.20332036e+03  4.39640922e+03  4.39640922e+03  4.39640922e+03
  5.22121930e+03  8.44408791e+03  8.44408791e+03  8.44408791e+03
  2.05414476e+04  7.10865126e+04]
E1 = -728.049052406129  E_coul = 201.77630511050896
cycle= 1 E= -526.27274729562  delta_E= -0.873  |g|= 0.186  |ddm|= 0.879
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.498657
diis-c [-0.24865928  1.        ]
  HOMO = -0.565999713139339  LUMO = 1.31968252150797
  mo_energy =
[-1.18524885e+02 -1.21776607e+01 -9.53441346e+00 -9.53441346e+00
 -9.53441346e+00 -1.24461882e+00 -5.65999713e-01 -5.65999713e-01
 -5.65999713e-01  1.31968252e+00  1.31968252e+00  1.31968252e+00
  1.26183320e+01  1.26183320e+01  1.26183320e+01  6.99118956e+01
  6.99118956e+01  6.99118956e+01  9.67157266e+01  3.26645248e+02
  3.26645248e+02  3.26645248e+02  8.37687774e+02  9.79391068e+02
  9.79391068e+02  9.79391068e+02  2.20297643e+03  2.20297643e+03
  2.20297643e+03  4.39600545e+03  4.39600545e+03  4.39600545e+03
  5.22065350e+03  8.44357590e+03  8.44357590e+03  8.44357590e+03
  2.05407555e+04  7.10857296e+04]
E1 = -728.2870679762319  E_coul = 202.01401051000224
cycle= 2 E= -526.27305746623  delta_E= -0.00031  |g|= 0.021  |ddm|= 0.0178
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0357871
diis-c [-8.64842770e-04  3.93547472e-02  9.60645253e-01]
  HOMO = -0.563362347910069  LUMO = 1.32242723639397
  mo_energy =
[-1.18488246e+02 -1.21613624e+01 -9.51780474e+00 -9.51780474e+00
 -9.51780474e+00 -1.24109708e+00 -5.63362348e-01 -5.63362348e-01
 -5.63362348e-01  1.32242724e+00  1.32242724e+00  1.32242724e+00
  1.26309358e+01  1.26309358e+01  1.26309358e+01  6.99366860e+01
  6.99366860e+01  6.99366860e+01  9.67466737e+01  3.26680122e+02
  3.26680122e+02  3.26680122e+02  8.37727263e+02  9.79429218e+02
  9.79429218e+02  9.79429218e+02  2.20301610e+03  2.20301610e+03
  2.20301610e+03  4.39604613e+03  4.39604613e+03  4.39604613e+03
  5.22069506e+03  8.44361723e+03  8.44361723e+03  8.44361723e+03
  2.05407973e+04  7.10857714e+04]
E1 = -728.2391688925658  E_coul = 201.96610271600176
cycle= 3 E= -526.273066176564  delta_E= -8.71e-06  |g|= 0.00252  |ddm|= 0.00427
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00478437
diis-c [-2.44056531e-07 -9.79357571e-04  1.10716402e-01  8.90262956e-01]
  HOMO = -0.563888399955296  LUMO = 1.32191064785785
  mo_energy =
[-1.18492749e+02 -1.21637413e+01 -9.52026555e+00 -9.52026555e+00
 -9.52026555e+00 -1.24178445e+00 -5.63888400e-01 -5.63888400e-01
 -5.63888400e-01  1.32191065e+00  1.32191065e+00  1.32191065e+00
  1.26289737e+01  1.26289737e+01  1.26289737e+01  6.99333910e+01
  6.99333910e+01  6.99333910e+01  9.67428624e+01  3.26675811e+02
  3.26675811e+02  3.26675811e+02  8.37722407e+02  9.79424555e+02
  9.79424555e+02  9.79424555e+02  2.20301124e+03  2.20301124e+03
  2.20301124e+03  4.39604111e+03  4.39604111e+03  4.39604111e+03
  5.22068978e+03  8.44361204e+03  8.44361204e+03  8.44361204e+03
  2.05407919e+04  7.10857659e+04]
E1 = -728.2457944597517  E_coul = 201.97272808855362
cycle= 4 E= -526.273066371198  delta_E= -1.95e-07  |g|= 4.12e-05  |ddm|= 0.000653
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.3539e-05
diis-c [-1.14633656e-09 -3.85280400e-06 -9.64619384e-04  1.67171949e-03
  9.99296753e-01]
  HOMO = -0.563862759591736  LUMO = 1.32193472625189
  mo_energy =
[-1.18492654e+02 -1.21636568e+01 -9.52018125e+00 -9.52018125e+00
 -9.52018125e+00 -1.24175113e+00 -5.63862760e-01 -5.63862760e-01
 -5.63862760e-01  1.32193473e+00  1.32193473e+00  1.32193473e+00
  1.26290462e+01  1.26290462e+01  1.26290462e+01  6.99334803e+01
  6.99334803e+01  6.99334803e+01  9.67429585e+01  3.26675906e+02
  3.26675906e+02  3.26675906e+02  8.37722497e+02  9.79424649e+02
  9.79424649e+02  9.79424649e+02  2.20301133e+03  2.20301133e+03
  2.20301133e+03  4.39604120e+03  4.39604120e+03  4.39604120e+03
  5.22068986e+03  8.44361212e+03  8.44361212e+03  8.44361212e+03
  2.05407920e+04  7.10857660e+04]
E1 = -728.2456030601757  E_coul = 201.97253668884852
cycle= 5 E= -526.273066371327  delta_E= -1.29e-10  |g|= 5.92e-06  |ddm|= 2.3e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2456030601757  E_coul = 201.97253668884852
  HOMO = -0.563865726620205  LUMO = 1.32193191589627
  mo_energy =
[-1.18492669e+02 -1.21636674e+01 -9.52019209e+00 -9.52019209e+00
 -9.52019209e+00 -1.24175499e+00 -5.63865727e-01 -5.63865727e-01
 -5.63865727e-01  1.32193192e+00  1.32193192e+00  1.32193192e+00
  1.26290371e+01  1.26290371e+01  1.26290371e+01  6.99334678e+01
  6.99334678e+01  6.99334678e+01  9.67429449e+01  3.26675892e+02
  3.26675892e+02  3.26675892e+02  8.37722482e+02  9.79424634e+02
  9.79424634e+02  9.79424634e+02  2.20301132e+03  2.20301132e+03
  2.20301132e+03  4.39604118e+03  4.39604118e+03  4.39604118e+03
  5.22068985e+03  8.44361211e+03  8.44361211e+03  8.44361211e+03
  2.05407919e+04  7.10857659e+04]
E1 = -728.2456292478475  E_coul = 201.97256287651697
Extra cycle  E= -526.273066371331  delta_E= -3.41e-12  |g|= 1.43e-06  |ddm|= 2.95e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.24 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 269139.60539547075
E1 = -728.2456292478475  E_coul = 201.97256287651697
init E= -526.273066371331
    CPU time for initialize scf      1.24 sec, wall time      0.22 sec
  HOMO = -0.563865249417453  LUMO = 1.3219323765533
  mo_energy =
[-1.18492666e+02 -1.21636655e+01 -9.52019011e+00 -9.52019011e+00
 -9.52019011e+00 -1.24175437e+00 -5.63865249e-01 -5.63865249e-01
 -5.63865249e-01  1.32193238e+00  1.32193238e+00  1.32193238e+00
  1.26290387e+01  1.26290387e+01  1.26290387e+01  6.99334703e+01
  6.99334703e+01  6.99334703e+01  9.67429477e+01  3.26675895e+02
  3.26675895e+02  3.26675895e+02  8.37722486e+02  9.79424637e+02
  9.79424637e+02  9.79424637e+02  2.20301132e+03  2.20301132e+03
  2.20301132e+03  4.39604118e+03  4.39604118e+03  4.39604118e+03
  5.22068985e+03  8.44361211e+03  8.44361211e+03  8.44361211e+03
  2.05407919e+04  7.10857660e+04]
E1 = -728.2456241928825  E_coul = 201.97255782155187
cycle= 1 E= -526.273066371331  delta_E= -1.14e-13  |g|= 3.01e-07  |ddm|= 5.27e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2456241928825  E_coul = 201.97255782155187
  HOMO = -0.563865336033096  LUMO = 1.32193229228741
  mo_energy =
[-1.18492666e+02 -1.21636658e+01 -9.52019049e+00 -9.52019049e+00
 -9.52019049e+00 -1.24175448e+00 -5.63865336e-01 -5.63865336e-01
 -5.63865336e-01  1.32193229e+00  1.32193229e+00  1.32193229e+00
  1.26290384e+01  1.26290384e+01  1.26290384e+01  6.99334698e+01
  6.99334698e+01  6.99334698e+01  9.67429472e+01  3.26675894e+02
  3.26675894e+02  3.26675894e+02  8.37722485e+02  9.79424637e+02
  9.79424637e+02  9.79424637e+02  2.20301132e+03  2.20301132e+03
  2.20301132e+03  4.39604118e+03  4.39604118e+03  4.39604118e+03
  5.22068985e+03  8.44361211e+03  8.44361211e+03  8.44361211e+03
  2.05407919e+04  7.10857660e+04]
E1 = -728.2456251839691  E_coul = 201.9725588126392
Extra cycle  E= -526.27306637133  delta_E= 7.96e-13  |g|= 6.09e-08  |ddm|= 1.01e-07
    CPU time for scf_cycle      1.38 sec, wall time      0.36 sec
exp = [2.61855306e+04 7.58510790e+03 3.55237501e+03 5.89991163e+02
 1.37199346e+02 3.88724333e+01 4.60669234e+00 3.94142301e-01
 1.36287183e+03 6.53449936e+02 2.43078640e+02 2.63366248e+02
 6.97297852e+02 1.27329231e+01 4.14816488e+01 9.28788691e-01
 4.14444667e+00 2.58321007e-01]
grad_E = [ 6.56455992e-07  1.64666624e-06  6.58498391e-05  1.31965048e-04
 -8.90628158e-04 -5.38877990e-03 -4.37052605e-03 -1.57772790e-03
  3.57570936e-06  1.49094119e-05  1.43641182e-04  1.13085338e-04
  1.27843072e-05  1.46584303e-02 -2.33235511e-03  3.29738701e-03
 -2.08390498e-02  5.91198804e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:39 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.4761341        1
[INPUT] 0    0    [1    /1   ]  7585.6982132         1
[INPUT] 0    0    [1    /1   ]  3553.53973898        1
[INPUT] 0    0    [1    /1   ]  608.272741097        1
[INPUT] 0    0    [1    /1   ]  143.711236565        1
[INPUT] 0    0    [1    /1   ]  40.3509656166        1
[INPUT] 0    0    [1    /1   ]  4.61399951838        1
[INPUT] 0    0    [1    /1   ]  0.39484605249        1
[INPUT] 1    0    [1    /1   ]  1362.84492224        1
[INPUT] 1    0    [1    /1   ]  653.447208488        1
[INPUT] 1    0    [1    /1   ]  242.948510738        1
[INPUT] 1    0    [1    /1   ]  263.243192274        1
[INPUT] 1    0    [1    /1   ]  713.036418698        1
[INPUT] 1    0    [1    /1   ]  12.6587674016        1
[INPUT] 1    0    [1    /1   ]  41.6928272785        1
[INPUT] 1    0    [1    /1   ]  0.93119603554        1
[INPUT] 1    0    [1    /1   ]  4.15401940187        1
[INPUT] 1    0    [1    /1   ]  0.261778151044       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.47613410261, 1.0]], [0, [7585.698213198563, 1.0]], [0, [3553.5397389818922, 1.0]], [0, [608.2727410968805, 1.0]], [0, [143.71123656500288, 1.0]], [0, [40.350965616637566, 1.0]], [0, [4.613999518384094, 1.0]], [0, [0.39484605248993054, 1.0]], [1, [1362.8449222386428, 1.0]], [1, [653.4472084882832, 1.0]], [1, [242.94851073761092, 1.0]], [1, [263.24319227380596, 1.0]], [1, [713.0364186978456, 1.0]], [1, [12.658767401587024, 1.0]], [1, [41.69282727852091, 1.0]], [1, [0.9311960355402419, 1.0]], [1, [4.154019401868799, 1.0]], [1, [0.2617781510435037, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.4761341]
bas 1, expnt(s) = [7585.6982132]
bas 2, expnt(s) = [3553.53973898]
bas 3, expnt(s) = [608.2727411]
bas 4, expnt(s) = [143.71123657]
bas 5, expnt(s) = [40.35096562]
bas 6, expnt(s) = [4.61399952]
bas 7, expnt(s) = [0.39484605]
bas 8, expnt(s) = [1362.84492224]
bas 9, expnt(s) = [653.44720849]
bas 10, expnt(s) = [242.94851074]
bas 11, expnt(s) = [263.24319227]
bas 12, expnt(s) = [713.0364187]
bas 13, expnt(s) = [12.6587674]
bas 14, expnt(s) = [41.69282728]
bas 15, expnt(s) = [0.93119604]
bas 16, expnt(s) = [4.1540194]
bas 17, expnt(s) = [0.26177815]
CPU time:       681.05
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61854761e+04 5.20068297e+03 7.58569821e+03 2.05358033e+03
 3.55353974e+03 1.16281575e+03 6.08272741e+02 3.09448791e+02
 1.43711237e+02 1.04865606e+02 4.03509656e+01 4.04487843e+01
 4.61399952e+00 7.95377283e+00 3.94846052e-01 1.25844974e+00
 1.36284492e+03 2.41569691e+04 6.53447208e+02 9.63823534e+03
 2.42948511e+02 2.79818996e+03 2.63243192e+02 3.09336259e+03
 7.13036419e+02 1.07491478e+04 1.26587674e+01 6.96584277e+01
 4.16928273e+01 3.09073006e+02 9.31196036e-01 2.66861419e+00
 4.15401940e+00 1.73009537e+01 2.61778151e-01 5.46262185e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.96601024388725
cond(S) = 167839.88064512835
E1 = -728.5029806391996  E_coul = 203.09413542339357
init E= -525.408845215806
    CPU time for initialize scf      0.28 sec, wall time      0.06 sec
  HOMO = -0.557961220538075  LUMO = 1.34343571136425
  mo_energy =
[-1.18259531e+02 -1.20965939e+01 -9.44395869e+00 -9.44395869e+00
 -9.44395869e+00 -1.23103959e+00 -5.57961221e-01 -5.57961221e-01
 -5.57961221e-01  1.34343571e+00  1.34343571e+00  1.34343571e+00
  1.26935247e+01  1.26935247e+01  1.26935247e+01  7.00961751e+01
  7.00961751e+01  7.00961751e+01  1.03264907e+02  3.27686684e+02
  3.27686684e+02  3.27686684e+02  8.77255540e+02  9.82169670e+02
  9.82169670e+02  9.82169670e+02  2.21158831e+03  2.21158831e+03
  2.21158831e+03  4.42043683e+03  4.42043683e+03  4.42043683e+03
  5.30489010e+03  8.48989133e+03  8.48989133e+03  8.48989133e+03
  2.06360941e+04  7.11801296e+04]
E1 = -728.1983559912567  E_coul = 201.91809746666934
cycle= 1 E= -526.280258524587  delta_E= -0.871  |g|= 0.181  |ddm|= 0.56
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.486297
diis-c [-0.23648525  1.        ]
  HOMO = -0.562956947617201  LUMO = 1.33949393143539
  mo_energy =
[-1.18508158e+02 -1.21715432e+01 -9.52366435e+00 -9.52366435e+00
 -9.52366435e+00 -1.24167243e+00 -5.62956948e-01 -5.62956948e-01
 -5.62956948e-01  1.33949393e+00  1.33949393e+00  1.33949393e+00
  1.26334453e+01  1.26334453e+01  1.26334453e+01  6.99583637e+01
  6.99583637e+01  6.99583637e+01  1.03107212e+02  3.27462826e+02
  3.27462826e+02  3.27462826e+02  8.76917280e+02  9.81893694e+02
  9.81893694e+02  9.81893694e+02  2.21126293e+03  2.21126293e+03
  2.21126293e+03  4.42005375e+03  4.42005375e+03  4.42005375e+03
  5.30435020e+03  8.48940346e+03  8.48940346e+03  8.48940346e+03
  2.06354311e+04  7.11793768e+04]
E1 = -728.4089010216735  E_coul = 202.12837448838707
cycle= 2 E= -526.280526533286  delta_E= -0.000268  |g|= 0.0192  |ddm|= 0.0153
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0328808
diis-c [-7.62834064e-04  3.54449827e-02  9.64555017e-01]
  HOMO = -0.560755939065116  LUMO = 1.34183121709458
  mo_energy =
[-1.18474804e+02 -1.21571123e+01 -9.50896736e+00 -9.50896736e+00
 -9.50896736e+00 -1.23872167e+00 -5.60755939e-01 -5.60755939e-01
 -5.60755939e-01  1.34183122e+00  1.34183122e+00  1.34183122e+00
  1.26444918e+01  1.26444918e+01  1.26444918e+01  6.99807114e+01
  6.99807114e+01  6.99807114e+01  1.03135703e+02  3.27494550e+02
  3.27494550e+02  3.27494550e+02  8.76953415e+02  9.81928472e+02
  9.81928472e+02  9.81928472e+02  2.21129914e+03  2.21129914e+03
  2.21129914e+03  4.42009091e+03  4.42009091e+03  4.42009091e+03
  5.30438818e+03  8.48944123e+03  8.48944123e+03  8.48944123e+03
  2.06354693e+04  7.11794149e+04]
E1 = -728.3664337665948  E_coul = 202.0859002584491
cycle= 3 E= -526.280533508146  delta_E= -6.97e-06  |g|= 0.00232  |ddm|= 0.00371
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00439165
diis-c [-1.98669367e-07 -8.98180420e-04  1.11110180e-01  8.89788000e-01]
  HOMO = -0.561227197721202  LUMO = 1.34136395445526
  mo_energy =
[-1.18478953e+02 -1.21592820e+01 -9.51120879e+00 -9.51120879e+00
 -9.51120879e+00 -1.23933907e+00 -5.61227198e-01 -5.61227198e-01
 -5.61227198e-01  1.34136395e+00  1.34136395e+00  1.34136395e+00
  1.26427129e+01  1.26427129e+01  1.26427129e+01  6.99776903e+01
  6.99776903e+01  6.99776903e+01  1.03132152e+02  3.27490580e+02
  3.27490580e+02  3.27490580e+02  8.76948928e+02  9.81924175e+02
  9.81924175e+02  9.81924175e+02  2.21129466e+03  2.21129466e+03
  2.21129466e+03  4.42008628e+03  4.42008628e+03  4.42008628e+03
  5.30438333e+03  8.48943645e+03  8.48943645e+03  8.48943645e+03
  2.06354643e+04  7.11794099e+04]
E1 = -728.3724269814902  E_coul = 202.09189331312456
cycle= 4 E= -526.280533668366  delta_E= -1.6e-07  |g|= 4.14e-05  |ddm|= 0.000586
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.57328e-05
diis-c [-1.00433895e-09 -5.64486187e-06 -5.14952001e-04  6.87409359e-03
  9.93646503e-01]
  HOMO = -0.561202391900437  LUMO = 1.34138743754226
  mo_energy =
[-1.18478857e+02 -1.21591995e+01 -9.51112624e+00 -9.51112624e+00
 -9.51112624e+00 -1.23930685e+00 -5.61202392e-01 -5.61202392e-01
 -5.61202392e-01  1.34138744e+00  1.34138744e+00  1.34138744e+00
  1.26427837e+01  1.26427837e+01  1.26427837e+01  6.99777787e+01
  6.99777787e+01  6.99777787e+01  1.03132248e+02  3.27490675e+02
  3.27490675e+02  3.27490675e+02  8.76949020e+02  9.81924269e+02
  9.81924269e+02  9.81924269e+02  2.21129475e+03  2.21129475e+03
  2.21129475e+03  4.42008637e+03  4.42008637e+03  4.42008637e+03
  5.30438341e+03  8.48943653e+03  8.48943653e+03  8.48943653e+03
  2.06354644e+04  7.11794100e+04]
E1 = -728.3722410747905  E_coul = 202.09170740630054
cycle= 5 E= -526.28053366849  delta_E= -1.24e-10  |g|= 5.33e-06  |ddm|= 2.21e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3722410747905  E_coul = 202.09170740630054
  HOMO = -0.5612050392556  LUMO = 1.3413849119285
  mo_energy =
[-1.18478871e+02 -1.21592090e+01 -9.51113597e+00 -9.51113597e+00
 -9.51113597e+00 -1.23931030e+00 -5.61205039e-01 -5.61205039e-01
 -5.61205039e-01  1.34138491e+00  1.34138491e+00  1.34138491e+00
  1.26427756e+01  1.26427756e+01  1.26427756e+01  6.99777675e+01
  6.99777675e+01  6.99777675e+01  1.03132235e+02  3.27490662e+02
  3.27490662e+02  3.27490662e+02  8.76949006e+02  9.81924256e+02
  9.81924256e+02  9.81924256e+02  2.21129474e+03  2.21129474e+03
  2.21129474e+03  4.42008636e+03  4.42008636e+03  4.42008636e+03
  5.30438340e+03  8.48943652e+03  8.48943652e+03  8.48943652e+03
  2.06354644e+04  7.11794100e+04]
E1 = -728.3722643270185  E_coul = 202.09173065852815
Extra cycle  E= -526.28053366849  delta_E= -3.41e-13  |g|= 1.27e-06  |ddm|= 2.62e-06
    CPU time for scf_cycle      0.48 sec, wall time      0.26 sec
exp = [2.61854761e+04 7.58569821e+03 3.55353974e+03 6.08272741e+02
 1.43711237e+02 4.03509656e+01 4.61399952e+00 3.94846052e-01
 1.36284492e+03 6.53447208e+02 2.42948511e+02 2.63243192e+02
 7.13036419e+02 1.26587674e+01 4.16928273e+01 9.31196036e-01
 4.15401940e+00 2.61778151e-01]
E = -526.2805336684903
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.4761341        1
[INPUT] 0    0    [1    /1   ]  7585.6982132         1
[INPUT] 0    0    [1    /1   ]  3553.53973898        1
[INPUT] 0    0    [1    /1   ]  608.272741097        1
[INPUT] 0    0    [1    /1   ]  143.711236565        1
[INPUT] 0    0    [1    /1   ]  40.3509656166        1
[INPUT] 0    0    [1    /1   ]  4.61399951838        1
[INPUT] 0    0    [1    /1   ]  0.39484605249        1
[INPUT] 1    0    [1    /1   ]  1362.84492224        1
[INPUT] 1    0    [1    /1   ]  653.447208488        1
[INPUT] 1    0    [1    /1   ]  242.948510738        1
[INPUT] 1    0    [1    /1   ]  263.243192274        1
[INPUT] 1    0    [1    /1   ]  713.036418698        1
[INPUT] 1    0    [1    /1   ]  12.6587674016        1
[INPUT] 1    0    [1    /1   ]  41.6928272785        1
[INPUT] 1    0    [1    /1   ]  0.93119603554        1
[INPUT] 1    0    [1    /1   ]  4.15401940187        1
[INPUT] 1    0    [1    /1   ]  0.261778151044       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.47613410261, 1.0]], [0, [7585.698213198563, 1.0]], [0, [3553.5397389818922, 1.0]], [0, [608.2727410968805, 1.0]], [0, [143.71123656500288, 1.0]], [0, [40.350965616637566, 1.0]], [0, [4.613999518384094, 1.0]], [0, [0.39484605248993054, 1.0]], [1, [1362.8449222386428, 1.0]], [1, [653.4472084882832, 1.0]], [1, [242.94851073761092, 1.0]], [1, [263.24319227380596, 1.0]], [1, [713.0364186978456, 1.0]], [1, [12.658767401587024, 1.0]], [1, [41.69282727852091, 1.0]], [1, [0.9311960355402419, 1.0]], [1, [4.154019401868799, 1.0]], [1, [0.2617781510435037, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.4761341]
bas 1, expnt(s) = [7585.6982132]
bas 2, expnt(s) = [3553.53973898]
bas 3, expnt(s) = [608.2727411]
bas 4, expnt(s) = [143.71123657]
bas 5, expnt(s) = [40.35096562]
bas 6, expnt(s) = [4.61399952]
bas 7, expnt(s) = [0.39484605]
bas 8, expnt(s) = [1362.84492224]
bas 9, expnt(s) = [653.44720849]
bas 10, expnt(s) = [242.94851074]
bas 11, expnt(s) = [263.24319227]
bas 12, expnt(s) = [713.0364187]
bas 13, expnt(s) = [12.6587674]
bas 14, expnt(s) = [41.69282728]
bas 15, expnt(s) = [0.93119604]
bas 16, expnt(s) = [4.1540194]
bas 17, expnt(s) = [0.26177815]
CPU time:       681.91
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61854761e+04 5.20068297e+03 7.58569821e+03 2.05358033e+03
 3.55353974e+03 1.16281575e+03 6.08272741e+02 3.09448791e+02
 1.43711237e+02 1.04865606e+02 4.03509656e+01 4.04487843e+01
 4.61399952e+00 7.95377283e+00 3.94846052e-01 1.25844974e+00
 1.36284492e+03 2.41569691e+04 6.53447208e+02 9.63823534e+03
 2.42948511e+02 2.79818996e+03 2.63243192e+02 3.09336259e+03
 7.13036419e+02 1.07491478e+04 1.26587674e+01 6.96584277e+01
 4.16928273e+01 3.09073006e+02 9.31196036e-01 2.66861419e+00
 4.15401940e+00 1.73009537e+01 2.61778151e-01 5.46262185e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.96601024388725
cond(S) = 167839.88064512835
E1 = -728.5029806391996  E_coul = 203.09413542339357
init E= -525.408845215806
    CPU time for initialize scf      0.17 sec, wall time      0.05 sec
  HOMO = -0.557961220538075  LUMO = 1.34343571136425
  mo_energy =
[-1.18259531e+02 -1.20965939e+01 -9.44395869e+00 -9.44395869e+00
 -9.44395869e+00 -1.23103959e+00 -5.57961221e-01 -5.57961221e-01
 -5.57961221e-01  1.34343571e+00  1.34343571e+00  1.34343571e+00
  1.26935247e+01  1.26935247e+01  1.26935247e+01  7.00961751e+01
  7.00961751e+01  7.00961751e+01  1.03264907e+02  3.27686684e+02
  3.27686684e+02  3.27686684e+02  8.77255540e+02  9.82169670e+02
  9.82169670e+02  9.82169670e+02  2.21158831e+03  2.21158831e+03
  2.21158831e+03  4.42043683e+03  4.42043683e+03  4.42043683e+03
  5.30489010e+03  8.48989133e+03  8.48989133e+03  8.48989133e+03
  2.06360941e+04  7.11801296e+04]
E1 = -728.1983559912567  E_coul = 201.91809746666934
cycle= 1 E= -526.280258524587  delta_E= -0.871  |g|= 0.181  |ddm|= 0.56
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.486297
diis-c [-0.23648525  1.        ]
  HOMO = -0.562956947617201  LUMO = 1.33949393143539
  mo_energy =
[-1.18508158e+02 -1.21715432e+01 -9.52366435e+00 -9.52366435e+00
 -9.52366435e+00 -1.24167243e+00 -5.62956948e-01 -5.62956948e-01
 -5.62956948e-01  1.33949393e+00  1.33949393e+00  1.33949393e+00
  1.26334453e+01  1.26334453e+01  1.26334453e+01  6.99583637e+01
  6.99583637e+01  6.99583637e+01  1.03107212e+02  3.27462826e+02
  3.27462826e+02  3.27462826e+02  8.76917280e+02  9.81893694e+02
  9.81893694e+02  9.81893694e+02  2.21126293e+03  2.21126293e+03
  2.21126293e+03  4.42005375e+03  4.42005375e+03  4.42005375e+03
  5.30435020e+03  8.48940346e+03  8.48940346e+03  8.48940346e+03
  2.06354311e+04  7.11793768e+04]
E1 = -728.4089010216735  E_coul = 202.12837448838707
cycle= 2 E= -526.280526533286  delta_E= -0.000268  |g|= 0.0192  |ddm|= 0.0153
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0328808
diis-c [-7.62834064e-04  3.54449827e-02  9.64555017e-01]
  HOMO = -0.560755939065116  LUMO = 1.34183121709458
  mo_energy =
[-1.18474804e+02 -1.21571123e+01 -9.50896736e+00 -9.50896736e+00
 -9.50896736e+00 -1.23872167e+00 -5.60755939e-01 -5.60755939e-01
 -5.60755939e-01  1.34183122e+00  1.34183122e+00  1.34183122e+00
  1.26444918e+01  1.26444918e+01  1.26444918e+01  6.99807114e+01
  6.99807114e+01  6.99807114e+01  1.03135703e+02  3.27494550e+02
  3.27494550e+02  3.27494550e+02  8.76953415e+02  9.81928472e+02
  9.81928472e+02  9.81928472e+02  2.21129914e+03  2.21129914e+03
  2.21129914e+03  4.42009091e+03  4.42009091e+03  4.42009091e+03
  5.30438818e+03  8.48944123e+03  8.48944123e+03  8.48944123e+03
  2.06354693e+04  7.11794149e+04]
E1 = -728.3664337665948  E_coul = 202.0859002584491
cycle= 3 E= -526.280533508146  delta_E= -6.97e-06  |g|= 0.00232  |ddm|= 0.00371
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00439165
diis-c [-1.98669367e-07 -8.98180420e-04  1.11110180e-01  8.89788000e-01]
  HOMO = -0.561227197721202  LUMO = 1.34136395445526
  mo_energy =
[-1.18478953e+02 -1.21592820e+01 -9.51120879e+00 -9.51120879e+00
 -9.51120879e+00 -1.23933907e+00 -5.61227198e-01 -5.61227198e-01
 -5.61227198e-01  1.34136395e+00  1.34136395e+00  1.34136395e+00
  1.26427129e+01  1.26427129e+01  1.26427129e+01  6.99776903e+01
  6.99776903e+01  6.99776903e+01  1.03132152e+02  3.27490580e+02
  3.27490580e+02  3.27490580e+02  8.76948928e+02  9.81924175e+02
  9.81924175e+02  9.81924175e+02  2.21129466e+03  2.21129466e+03
  2.21129466e+03  4.42008628e+03  4.42008628e+03  4.42008628e+03
  5.30438333e+03  8.48943645e+03  8.48943645e+03  8.48943645e+03
  2.06354643e+04  7.11794099e+04]
E1 = -728.3724269814902  E_coul = 202.09189331312456
cycle= 4 E= -526.280533668366  delta_E= -1.6e-07  |g|= 4.14e-05  |ddm|= 0.000586
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.57328e-05
diis-c [-1.00433895e-09 -5.64486187e-06 -5.14952001e-04  6.87409359e-03
  9.93646503e-01]
  HOMO = -0.561202391900437  LUMO = 1.34138743754226
  mo_energy =
[-1.18478857e+02 -1.21591995e+01 -9.51112624e+00 -9.51112624e+00
 -9.51112624e+00 -1.23930685e+00 -5.61202392e-01 -5.61202392e-01
 -5.61202392e-01  1.34138744e+00  1.34138744e+00  1.34138744e+00
  1.26427837e+01  1.26427837e+01  1.26427837e+01  6.99777787e+01
  6.99777787e+01  6.99777787e+01  1.03132248e+02  3.27490675e+02
  3.27490675e+02  3.27490675e+02  8.76949020e+02  9.81924269e+02
  9.81924269e+02  9.81924269e+02  2.21129475e+03  2.21129475e+03
  2.21129475e+03  4.42008637e+03  4.42008637e+03  4.42008637e+03
  5.30438341e+03  8.48943653e+03  8.48943653e+03  8.48943653e+03
  2.06354644e+04  7.11794100e+04]
E1 = -728.3722410747905  E_coul = 202.09170740630054
cycle= 5 E= -526.28053366849  delta_E= -1.24e-10  |g|= 5.33e-06  |ddm|= 2.21e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3722410747905  E_coul = 202.09170740630054
  HOMO = -0.5612050392556  LUMO = 1.3413849119285
  mo_energy =
[-1.18478871e+02 -1.21592090e+01 -9.51113597e+00 -9.51113597e+00
 -9.51113597e+00 -1.23931030e+00 -5.61205039e-01 -5.61205039e-01
 -5.61205039e-01  1.34138491e+00  1.34138491e+00  1.34138491e+00
  1.26427756e+01  1.26427756e+01  1.26427756e+01  6.99777675e+01
  6.99777675e+01  6.99777675e+01  1.03132235e+02  3.27490662e+02
  3.27490662e+02  3.27490662e+02  8.76949006e+02  9.81924256e+02
  9.81924256e+02  9.81924256e+02  2.21129474e+03  2.21129474e+03
  2.21129474e+03  4.42008636e+03  4.42008636e+03  4.42008636e+03
  5.30438340e+03  8.48943652e+03  8.48943652e+03  8.48943652e+03
  2.06354644e+04  7.11794100e+04]
E1 = -728.3722643270185  E_coul = 202.09173065852815
Extra cycle  E= -526.28053366849  delta_E= -3.41e-13  |g|= 1.27e-06  |ddm|= 2.62e-06
    CPU time for scf_cycle      0.37 sec, wall time      0.25 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 167839.88064512835
E1 = -728.3722643270185  E_coul = 202.09173065852815
init E= -526.28053366849
    CPU time for initialize scf      1.34 sec, wall time      0.23 sec
  HOMO = -0.561204618428712  LUMO = 1.3413853213871
  mo_energy =
[-1.18478868e+02 -1.21592073e+01 -9.51113422e+00 -9.51113422e+00
 -9.51113422e+00 -1.23930975e+00 -5.61204618e-01 -5.61204618e-01
 -5.61204618e-01  1.34138532e+00  1.34138532e+00  1.34138532e+00
  1.26427770e+01  1.26427770e+01  1.26427770e+01  6.99777697e+01
  6.99777697e+01  6.99777697e+01  1.03132238e+02  3.27490664e+02
  3.27490664e+02  3.27490664e+02  8.76949009e+02  9.81924259e+02
  9.81924259e+02  9.81924259e+02  2.21129474e+03  2.21129474e+03
  2.21129474e+03  4.42008636e+03  4.42008636e+03  4.42008636e+03
  5.30438340e+03  8.48943652e+03  8.48943652e+03  8.48943652e+03
  2.06354644e+04  7.11794100e+04]
E1 = -728.3722598880319  E_coul = 202.09172621954
cycle= 1 E= -526.280533668492  delta_E= -1.59e-12  |g|= 2.64e-07  |ddm|= 4.61e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3722598880319  E_coul = 202.09172621954
  HOMO = -0.561204693985795  LUMO = 1.34138524730307
  mo_energy =
[-1.18478868e+02 -1.21592076e+01 -9.51113455e+00 -9.51113455e+00
 -9.51113455e+00 -1.23930985e+00 -5.61204694e-01 -5.61204694e-01
 -5.61204694e-01  1.34138525e+00  1.34138525e+00  1.34138525e+00
  1.26427767e+01  1.26427767e+01  1.26427767e+01  6.99777693e+01
  6.99777693e+01  6.99777693e+01  1.03132237e+02  3.27490664e+02
  3.27490664e+02  3.27490664e+02  8.76949008e+02  9.81924258e+02
  9.81924258e+02  9.81924258e+02  2.21129474e+03  2.21129474e+03
  2.21129474e+03  4.42008636e+03  4.42008636e+03  4.42008636e+03
  5.30438340e+03  8.48943652e+03  8.48943652e+03  8.48943652e+03
  2.06354644e+04  7.11794100e+04]
E1 = -728.372260748948  E_coul = 202.0917270804561
Extra cycle  E= -526.280533668492  delta_E=    0  |g|= 5.28e-08  |ddm|= 8.72e-08
    CPU time for scf_cycle      1.48 sec, wall time      0.36 sec
exp = [2.61854761e+04 7.58569821e+03 3.55353974e+03 6.08272741e+02
 1.43711237e+02 4.03509656e+01 4.61399952e+00 3.94846052e-01
 1.36284492e+03 6.53447208e+02 2.42948511e+02 2.63243192e+02
 7.13036419e+02 1.26587674e+01 4.16928273e+01 9.31196036e-01
 4.15401940e+00 2.61778151e-01]
grad_E = [ 5.22535948e-07  1.22782591e-06  5.93116727e-05 -8.63150239e-06
  3.88885849e-04 -3.19958785e-03  2.63280215e-03  7.65985179e-03
  3.13842441e-06  1.31234251e-05  1.24736520e-04  9.81282344e-05
  1.06680361e-05  2.67413429e-03 -3.31788286e-04 -1.53717363e-02
  2.79202373e-03  8.14698820e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.467413         1
[INPUT] 0    0    [1    /1   ]  7585.79250745        1
[INPUT] 0    0    [1    /1   ]  3553.72548656        1
[INPUT] 0    0    [1    /1   ]  611.188463869        1
[INPUT] 0    0    [1    /1   ]  144.955081375        1
[INPUT] 0    0    [1    /1   ]  40.7134438547        1
[INPUT] 0    0    [1    /1   ]  4.61236104718        1
[INPUT] 0    0    [1    /1   ]  0.39486444275        1
[INPUT] 1    0    [1    /1   ]  1362.84002309        1
[INPUT] 1    0    [1    /1   ]  653.441916243        1
[INPUT] 1    0    [1    /1   ]  242.89990458         1
[INPUT] 1    0    [1    /1   ]  263.198965111        1
[INPUT] 1    0    [1    /1   ]  716.278849429        1
[INPUT] 1    0    [1    /1   ]  12.516940146         1
[INPUT] 1    0    [1    /1   ]  41.404140789         1
[INPUT] 1    0    [1    /1   ]  0.924943297597       1
[INPUT] 1    0    [1    /1   ]  4.11707626515        1
[INPUT] 1    0    [1    /1   ]  0.259078893858       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.46741300644, 1.0]], [0, [7585.792507450967, 1.0]], [0, [3553.725486557232, 1.0]], [0, [611.1884638692094, 1.0]], [0, [144.95508137479698, 1.0]], [0, [40.7134438546632, 1.0]], [0, [4.612361047184994, 1.0]], [0, [0.39486444274984905, 1.0]], [1, [1362.840023086428, 1.0]], [1, [653.4419162430466, 1.0]], [1, [242.89990458020947, 1.0]], [1, [263.19896511056044, 1.0]], [1, [716.2788494286943, 1.0]], [1, [12.516940146034008, 1.0]], [1, [41.40414078898138, 1.0]], [1, [0.9249432975974352, 1.0]], [1, [4.117076265153741, 1.0]], [1, [0.25907889385831784, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.46741301]
bas 1, expnt(s) = [7585.79250745]
bas 2, expnt(s) = [3553.72548656]
bas 3, expnt(s) = [611.18846387]
bas 4, expnt(s) = [144.95508137]
bas 5, expnt(s) = [40.71344385]
bas 6, expnt(s) = [4.61236105]
bas 7, expnt(s) = [0.39486444]
bas 8, expnt(s) = [1362.84002309]
bas 9, expnt(s) = [653.44191624]
bas 10, expnt(s) = [242.89990458]
bas 11, expnt(s) = [263.19896511]
bas 12, expnt(s) = [716.27884943]
bas 13, expnt(s) = [12.51694015]
bas 14, expnt(s) = [41.40414079]
bas 15, expnt(s) = [0.9249433]
bas 16, expnt(s) = [4.11707627]
bas 17, expnt(s) = [0.25907889]
CPU time:       688.67
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61854674e+04 5.20068167e+03 7.58579251e+03 2.05359947e+03
 3.55372549e+03 1.16286134e+03 6.11188464e+02 3.10560620e+02
 1.44955081e+02 1.05545594e+02 4.07134439e+01 4.07209971e+01
 4.61236105e+00 7.95165440e+00 3.94864443e-01 1.25849370e+00
 1.36284002e+03 2.41568605e+04 6.53441916e+02 9.63813776e+03
 2.42899905e+02 2.79749019e+03 2.63198965e+02 3.09271296e+03
 7.16278849e+02 1.08102827e+04 1.25169401e+01 6.86842423e+01
 4.14041408e+01 3.06400249e+02 9.24943298e-01 2.64623421e+00
 4.11707627e+00 1.71088387e+01 2.59078894e-01 5.39230483e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.966848513216377
cond(S) = 155093.53664122013
E1 = -728.5036960598433  E_coul = 203.09343248983424
init E= -525.410263570009
    CPU time for initialize scf      0.15 sec, wall time      0.04 sec
  HOMO = -0.558137888787999  LUMO = 1.3255063032668
  mo_energy =
[-1.18258544e+02 -1.20978529e+01 -9.44389434e+00 -9.44389434e+00
 -9.44389434e+00 -1.23117839e+00 -5.58137889e-01 -5.58137889e-01
 -5.58137889e-01  1.32550630e+00  1.32550630e+00  1.32550630e+00
  1.25160044e+01  1.25160044e+01  1.25160044e+01  6.92953361e+01
  6.92953361e+01  6.92953361e+01  1.04670494e+02  3.26331135e+02
  3.26331135e+02  3.26331135e+02  8.84553117e+02  9.81018397e+02
  9.81018397e+02  9.81018397e+02  2.21158586e+03  2.21158586e+03
  2.21158586e+03  4.42366452e+03  4.42366452e+03  4.42366452e+03
  5.31935470e+03  8.49767481e+03  8.49767481e+03  8.49767481e+03
  2.06522883e+04  7.11960962e+04]
E1 = -728.1589811384981  E_coul = 201.87793838550337
cycle= 1 E= -526.281042752995  delta_E= -0.871  |g|= 0.182  |ddm|= 0.516
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.484615
diis-c [-0.23485185  1.        ]
  HOMO = -0.564458199870353  LUMO = 1.32046665128557
  mo_energy =
[-1.18509787e+02 -1.21758253e+01 -9.52641871e+00 -9.52641871e+00
 -9.52641871e+00 -1.24346890e+00 -5.64458200e-01 -5.64458200e-01
 -5.64458200e-01  1.32046665e+00  1.32046665e+00  1.32046665e+00
  1.24538823e+01  1.24538823e+01  1.24538823e+01  6.91553945e+01
  6.91553945e+01  6.91553945e+01  1.04509118e+02  3.26104698e+02
  3.26104698e+02  3.26104698e+02  8.84213149e+02  9.80740426e+02
  9.80740426e+02  9.80740426e+02  2.21125900e+03  2.21125900e+03
  2.21125900e+03  4.42328050e+03  4.42328050e+03  4.42328050e+03
  5.31881502e+03  8.49718674e+03  8.49718674e+03  8.49718674e+03
  2.06516261e+04  7.11953445e+04]
E1 = -728.376513345403  E_coul = 202.09519940633712
cycle= 2 E= -526.281313939066  delta_E= -0.000271  |g|= 0.0194  |ddm|= 0.016
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0332536
diis-c [-7.81251364e-04  3.58997191e-02  9.64100281e-01]
  HOMO = -0.562106603536777  LUMO = 1.32291943338641
  mo_energy =
[-1.18475817e+02 -1.21608878e+01 -9.51120574e+00 -9.51120574e+00
 -9.51120574e+00 -1.24032074e+00 -5.62106604e-01 -5.62106604e-01
 -5.62106604e-01  1.32291943e+00  1.32291943e+00  1.32291943e+00
  1.24652763e+01  1.24652763e+01  1.24652763e+01  6.91782347e+01
  6.91782347e+01  6.91782347e+01  1.04538282e+02  3.26137032e+02
  3.26137032e+02  3.26137032e+02  8.84249934e+02  9.80775831e+02
  9.80775831e+02  9.80775831e+02  2.21129584e+03  2.21129584e+03
  2.21129584e+03  4.42331829e+03  4.42331829e+03  4.42331829e+03
  5.31885366e+03  8.49722516e+03  8.49722516e+03  8.49722516e+03
  2.06516650e+04  7.11953833e+04]
E1 = -728.3326857984382  E_coul = 202.05136455474715
cycle= 3 E= -526.281321243691  delta_E= -7.3e-06  |g|= 0.00236  |ddm|= 0.00386
    CPU time for cycle= 3      0.05 sec, wall time      0.05 sec
diis-norm(errvec)=0.00445827
diis-c [-1.91008375e-07 -8.86318474e-04  1.11746951e-01  8.89139368e-01]
  HOMO = -0.562595306594436  LUMO = 1.3224404450432
  mo_energy =
[-1.18480056e+02 -1.21631200e+01 -9.51350973e+00 -9.51350973e+00
 -9.51350973e+00 -1.24096102e+00 -5.62595307e-01 -5.62595307e-01
 -5.62595307e-01  1.32244045e+00  1.32244045e+00  1.32244045e+00
  1.24634561e+01  1.24634561e+01  1.24634561e+01  6.91751468e+01
  6.91751468e+01  6.91751468e+01  1.04534638e+02  3.26132974e+02
  3.26132974e+02  3.26132974e+02  8.84245354e+02  9.80771442e+02
  9.80771442e+02  9.80771442e+02  2.21129127e+03  2.21129127e+03
  2.21129127e+03  4.42331357e+03  4.42331357e+03  4.42331357e+03
  5.31884871e+03  8.49722029e+03  8.49722029e+03  8.49722029e+03
  2.06516599e+04  7.11953782e+04]
E1 = -728.3388660040741  E_coul = 202.05754459122815
cycle= 4 E= -526.281321412846  delta_E= -1.69e-07  |g|= 4.15e-05  |ddm|= 0.000606
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.63061e-05
diis-c [-9.79847701e-10 -6.52505151e-06 -3.30607237e-04  8.34419728e-03
  9.91992935e-01]
  HOMO = -0.562570443570767  LUMO = 1.32246375520862
  mo_energy =
[-1.18479961e+02 -1.21630375e+01 -9.51342714e+00 -9.51342714e+00
 -9.51342714e+00 -1.24092872e+00 -5.62570444e-01 -5.62570444e-01
 -5.62570444e-01  1.32246376e+00  1.32246376e+00  1.32246376e+00
  1.24635267e+01  1.24635267e+01  1.24635267e+01  6.91752352e+01
  6.91752352e+01  6.91752352e+01  1.04534734e+02  3.26133068e+02
  3.26133068e+02  3.26133068e+02  8.84245445e+02  9.80771536e+02
  9.80771536e+02  9.80771536e+02  2.21129137e+03  2.21129137e+03
  2.21129137e+03  4.42331367e+03  4.42331367e+03  4.42331367e+03
  5.31884879e+03  8.49722037e+03  8.49722037e+03  8.49722037e+03
  2.06516600e+04  7.11953783e+04]
E1 = -728.3386781687595  E_coul = 202.0573567557875
cycle= 5 E= -526.281321412972  delta_E= -1.26e-10  |g|= 5.23e-06  |ddm|= 2.23e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3386781687595  E_coul = 202.0573567557875
  HOMO = -0.562573059058843  LUMO = 1.32246128506524
  mo_energy =
[-1.18479974e+02 -1.21630469e+01 -9.51343672e+00 -9.51343672e+00
 -9.51343672e+00 -1.24093213e+00 -5.62573059e-01 -5.62573059e-01
 -5.62573059e-01  1.32246129e+00  1.32246129e+00  1.32246129e+00
  1.24635188e+01  1.24635188e+01  1.24635188e+01  6.91752242e+01
  6.91752242e+01  6.91752242e+01  1.04534722e+02  3.26133056e+02
  3.26133056e+02  3.26133056e+02  8.84245432e+02  9.80771523e+02
  9.80771523e+02  9.80771523e+02  2.21129135e+03  2.21129135e+03
  2.21129135e+03  4.42331365e+03  4.42331365e+03  4.42331365e+03
  5.31884878e+03  8.49722036e+03  8.49722036e+03  8.49722036e+03
  2.06516600e+04  7.11953782e+04]
E1 = -728.3387012399579  E_coul = 202.05737982698287
Extra cycle  E= -526.281321412975  delta_E= -3.07e-12  |g|= 1.25e-06  |ddm|= 2.59e-06
    CPU time for scf_cycle      0.36 sec, wall time      0.25 sec
exp = [2.61854674e+04 7.58579251e+03 3.55372549e+03 6.11188464e+02
 1.44955081e+02 4.07134439e+01 4.61236105e+00 3.94864443e-01
 1.36284002e+03 6.53441916e+02 2.42899905e+02 2.63198965e+02
 7.16278849e+02 1.25169401e+01 4.14041408e+01 9.24943298e-01
 4.11707627e+00 2.59078894e-01]
E = -526.2813214129751
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.467413         1
[INPUT] 0    0    [1    /1   ]  7585.79250745        1
[INPUT] 0    0    [1    /1   ]  3553.72548656        1
[INPUT] 0    0    [1    /1   ]  611.188463869        1
[INPUT] 0    0    [1    /1   ]  144.955081375        1
[INPUT] 0    0    [1    /1   ]  40.7134438547        1
[INPUT] 0    0    [1    /1   ]  4.61236104718        1
[INPUT] 0    0    [1    /1   ]  0.39486444275        1
[INPUT] 1    0    [1    /1   ]  1362.84002309        1
[INPUT] 1    0    [1    /1   ]  653.441916243        1
[INPUT] 1    0    [1    /1   ]  242.89990458         1
[INPUT] 1    0    [1    /1   ]  263.198965111        1
[INPUT] 1    0    [1    /1   ]  716.278849429        1
[INPUT] 1    0    [1    /1   ]  12.516940146         1
[INPUT] 1    0    [1    /1   ]  41.404140789         1
[INPUT] 1    0    [1    /1   ]  0.924943297597       1
[INPUT] 1    0    [1    /1   ]  4.11707626515        1
[INPUT] 1    0    [1    /1   ]  0.259078893858       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.46741300644, 1.0]], [0, [7585.792507450967, 1.0]], [0, [3553.725486557232, 1.0]], [0, [611.1884638692094, 1.0]], [0, [144.95508137479698, 1.0]], [0, [40.7134438546632, 1.0]], [0, [4.612361047184994, 1.0]], [0, [0.39486444274984905, 1.0]], [1, [1362.840023086428, 1.0]], [1, [653.4419162430466, 1.0]], [1, [242.89990458020947, 1.0]], [1, [263.19896511056044, 1.0]], [1, [716.2788494286943, 1.0]], [1, [12.516940146034008, 1.0]], [1, [41.40414078898138, 1.0]], [1, [0.9249432975974352, 1.0]], [1, [4.117076265153741, 1.0]], [1, [0.25907889385831784, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.46741301]
bas 1, expnt(s) = [7585.79250745]
bas 2, expnt(s) = [3553.72548656]
bas 3, expnt(s) = [611.18846387]
bas 4, expnt(s) = [144.95508137]
bas 5, expnt(s) = [40.71344385]
bas 6, expnt(s) = [4.61236105]
bas 7, expnt(s) = [0.39486444]
bas 8, expnt(s) = [1362.84002309]
bas 9, expnt(s) = [653.44191624]
bas 10, expnt(s) = [242.89990458]
bas 11, expnt(s) = [263.19896511]
bas 12, expnt(s) = [716.27884943]
bas 13, expnt(s) = [12.51694015]
bas 14, expnt(s) = [41.40414079]
bas 15, expnt(s) = [0.9249433]
bas 16, expnt(s) = [4.11707627]
bas 17, expnt(s) = [0.25907889]
CPU time:       689.40
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61854674e+04 5.20068167e+03 7.58579251e+03 2.05359947e+03
 3.55372549e+03 1.16286134e+03 6.11188464e+02 3.10560620e+02
 1.44955081e+02 1.05545594e+02 4.07134439e+01 4.07209971e+01
 4.61236105e+00 7.95165440e+00 3.94864443e-01 1.25849370e+00
 1.36284002e+03 2.41568605e+04 6.53441916e+02 9.63813776e+03
 2.42899905e+02 2.79749019e+03 2.63198965e+02 3.09271296e+03
 7.16278849e+02 1.08102827e+04 1.25169401e+01 6.86842423e+01
 4.14041408e+01 3.06400249e+02 9.24943298e-01 2.64623421e+00
 4.11707627e+00 1.71088387e+01 2.59078894e-01 5.39230483e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.966848513216377
cond(S) = 155093.53664122013
E1 = -728.5036960598433  E_coul = 203.09343248983424
init E= -525.410263570009
    CPU time for initialize scf      0.15 sec, wall time      0.05 sec
  HOMO = -0.558137888787999  LUMO = 1.3255063032668
  mo_energy =
[-1.18258544e+02 -1.20978529e+01 -9.44389434e+00 -9.44389434e+00
 -9.44389434e+00 -1.23117839e+00 -5.58137889e-01 -5.58137889e-01
 -5.58137889e-01  1.32550630e+00  1.32550630e+00  1.32550630e+00
  1.25160044e+01  1.25160044e+01  1.25160044e+01  6.92953361e+01
  6.92953361e+01  6.92953361e+01  1.04670494e+02  3.26331135e+02
  3.26331135e+02  3.26331135e+02  8.84553117e+02  9.81018397e+02
  9.81018397e+02  9.81018397e+02  2.21158586e+03  2.21158586e+03
  2.21158586e+03  4.42366452e+03  4.42366452e+03  4.42366452e+03
  5.31935470e+03  8.49767481e+03  8.49767481e+03  8.49767481e+03
  2.06522883e+04  7.11960962e+04]
E1 = -728.1589811384981  E_coul = 201.87793838550337
cycle= 1 E= -526.281042752995  delta_E= -0.871  |g|= 0.182  |ddm|= 0.516
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.484615
diis-c [-0.23485185  1.        ]
  HOMO = -0.564458199870353  LUMO = 1.32046665128557
  mo_energy =
[-1.18509787e+02 -1.21758253e+01 -9.52641871e+00 -9.52641871e+00
 -9.52641871e+00 -1.24346890e+00 -5.64458200e-01 -5.64458200e-01
 -5.64458200e-01  1.32046665e+00  1.32046665e+00  1.32046665e+00
  1.24538823e+01  1.24538823e+01  1.24538823e+01  6.91553945e+01
  6.91553945e+01  6.91553945e+01  1.04509118e+02  3.26104698e+02
  3.26104698e+02  3.26104698e+02  8.84213149e+02  9.80740426e+02
  9.80740426e+02  9.80740426e+02  2.21125900e+03  2.21125900e+03
  2.21125900e+03  4.42328050e+03  4.42328050e+03  4.42328050e+03
  5.31881502e+03  8.49718674e+03  8.49718674e+03  8.49718674e+03
  2.06516261e+04  7.11953445e+04]
E1 = -728.376513345403  E_coul = 202.09519940633712
cycle= 2 E= -526.281313939066  delta_E= -0.000271  |g|= 0.0194  |ddm|= 0.016
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0332536
diis-c [-7.81251364e-04  3.58997191e-02  9.64100281e-01]
  HOMO = -0.562106603536777  LUMO = 1.32291943338641
  mo_energy =
[-1.18475817e+02 -1.21608878e+01 -9.51120574e+00 -9.51120574e+00
 -9.51120574e+00 -1.24032074e+00 -5.62106604e-01 -5.62106604e-01
 -5.62106604e-01  1.32291943e+00  1.32291943e+00  1.32291943e+00
  1.24652763e+01  1.24652763e+01  1.24652763e+01  6.91782347e+01
  6.91782347e+01  6.91782347e+01  1.04538282e+02  3.26137032e+02
  3.26137032e+02  3.26137032e+02  8.84249934e+02  9.80775831e+02
  9.80775831e+02  9.80775831e+02  2.21129584e+03  2.21129584e+03
  2.21129584e+03  4.42331829e+03  4.42331829e+03  4.42331829e+03
  5.31885366e+03  8.49722516e+03  8.49722516e+03  8.49722516e+03
  2.06516650e+04  7.11953833e+04]
E1 = -728.3326857984382  E_coul = 202.05136455474715
cycle= 3 E= -526.281321243691  delta_E= -7.3e-06  |g|= 0.00236  |ddm|= 0.00386
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00445827
diis-c [-1.91008375e-07 -8.86318474e-04  1.11746951e-01  8.89139368e-01]
  HOMO = -0.562595306594436  LUMO = 1.3224404450432
  mo_energy =
[-1.18480056e+02 -1.21631200e+01 -9.51350973e+00 -9.51350973e+00
 -9.51350973e+00 -1.24096102e+00 -5.62595307e-01 -5.62595307e-01
 -5.62595307e-01  1.32244045e+00  1.32244045e+00  1.32244045e+00
  1.24634561e+01  1.24634561e+01  1.24634561e+01  6.91751468e+01
  6.91751468e+01  6.91751468e+01  1.04534638e+02  3.26132974e+02
  3.26132974e+02  3.26132974e+02  8.84245354e+02  9.80771442e+02
  9.80771442e+02  9.80771442e+02  2.21129127e+03  2.21129127e+03
  2.21129127e+03  4.42331357e+03  4.42331357e+03  4.42331357e+03
  5.31884871e+03  8.49722029e+03  8.49722029e+03  8.49722029e+03
  2.06516599e+04  7.11953782e+04]
E1 = -728.3388660040741  E_coul = 202.05754459122815
cycle= 4 E= -526.281321412846  delta_E= -1.69e-07  |g|= 4.15e-05  |ddm|= 0.000606
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.63061e-05
diis-c [-9.79847701e-10 -6.52505151e-06 -3.30607237e-04  8.34419728e-03
  9.91992935e-01]
  HOMO = -0.562570443570767  LUMO = 1.32246375520862
  mo_energy =
[-1.18479961e+02 -1.21630375e+01 -9.51342714e+00 -9.51342714e+00
 -9.51342714e+00 -1.24092872e+00 -5.62570444e-01 -5.62570444e-01
 -5.62570444e-01  1.32246376e+00  1.32246376e+00  1.32246376e+00
  1.24635267e+01  1.24635267e+01  1.24635267e+01  6.91752352e+01
  6.91752352e+01  6.91752352e+01  1.04534734e+02  3.26133068e+02
  3.26133068e+02  3.26133068e+02  8.84245445e+02  9.80771536e+02
  9.80771536e+02  9.80771536e+02  2.21129137e+03  2.21129137e+03
  2.21129137e+03  4.42331367e+03  4.42331367e+03  4.42331367e+03
  5.31884879e+03  8.49722037e+03  8.49722037e+03  8.49722037e+03
  2.06516600e+04  7.11953783e+04]
E1 = -728.3386781687595  E_coul = 202.0573567557875
cycle= 5 E= -526.281321412972  delta_E= -1.26e-10  |g|= 5.23e-06  |ddm|= 2.23e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3386781687595  E_coul = 202.0573567557875
  HOMO = -0.562573059058843  LUMO = 1.32246128506524
  mo_energy =
[-1.18479974e+02 -1.21630469e+01 -9.51343672e+00 -9.51343672e+00
 -9.51343672e+00 -1.24093213e+00 -5.62573059e-01 -5.62573059e-01
 -5.62573059e-01  1.32246129e+00  1.32246129e+00  1.32246129e+00
  1.24635188e+01  1.24635188e+01  1.24635188e+01  6.91752242e+01
  6.91752242e+01  6.91752242e+01  1.04534722e+02  3.26133056e+02
  3.26133056e+02  3.26133056e+02  8.84245432e+02  9.80771523e+02
  9.80771523e+02  9.80771523e+02  2.21129135e+03  2.21129135e+03
  2.21129135e+03  4.42331365e+03  4.42331365e+03  4.42331365e+03
  5.31884878e+03  8.49722036e+03  8.49722036e+03  8.49722036e+03
  2.06516600e+04  7.11953782e+04]
E1 = -728.3387012399579  E_coul = 202.05737982698287
Extra cycle  E= -526.281321412975  delta_E= -3.07e-12  |g|= 1.25e-06  |ddm|= 2.59e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.24 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 155093.53664122013
E1 = -728.3387012399579  E_coul = 202.05737982698287
init E= -526.281321412975
    CPU time for initialize scf      1.19 sec, wall time      0.21 sec
  HOMO = -0.56257263942043  LUMO = 1.32246168905218
  mo_energy =
[-1.18479971e+02 -1.21630452e+01 -9.51343498e+00 -9.51343498e+00
 -9.51343498e+00 -1.24093158e+00 -5.62572639e-01 -5.62572639e-01
 -5.62572639e-01  1.32246169e+00  1.32246169e+00  1.32246169e+00
  1.24635202e+01  1.24635202e+01  1.24635202e+01  6.91752264e+01
  6.91752264e+01  6.91752264e+01  1.04534724e+02  3.26133058e+02
  3.26133058e+02  3.26133058e+02  8.84245435e+02  9.80771526e+02
  9.80771526e+02  9.80771526e+02  2.21129136e+03  2.21129136e+03
  2.21129136e+03  4.42331366e+03  4.42331366e+03  4.42331366e+03
  5.31884878e+03  8.49722036e+03  8.49722036e+03  8.49722036e+03
  2.06516600e+04  7.11953782e+04]
E1 = -728.3386968111627  E_coul = 202.0573753981877
cycle= 1 E= -526.281321412975  delta_E= 1.14e-13  |g|= 2.61e-07  |ddm|= 4.6e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3386968111627  E_coul = 202.0573753981877
  HOMO = -0.562572715240721  LUMO = 1.32246161551484
  mo_energy =
[-1.18479972e+02 -1.21630455e+01 -9.51343531e+00 -9.51343531e+00
 -9.51343531e+00 -1.24093168e+00 -5.62572715e-01 -5.62572715e-01
 -5.62572715e-01  1.32246162e+00  1.32246162e+00  1.32246162e+00
  1.24635199e+01  1.24635199e+01  1.24635199e+01  6.91752260e+01
  6.91752260e+01  6.91752260e+01  1.04534724e+02  3.26133058e+02
  3.26133058e+02  3.26133058e+02  8.84245434e+02  9.80771525e+02
  9.80771525e+02  9.80771525e+02  2.21129136e+03  2.21129136e+03
  2.21129136e+03  4.42331365e+03  4.42331365e+03  4.42331365e+03
  5.31884878e+03  8.49722036e+03  8.49722036e+03  8.49722036e+03
  2.06516600e+04  7.11953782e+04]
E1 = -728.3386976743732  E_coul = 202.0573762613981
Extra cycle  E= -526.281321412975  delta_E= -1.14e-13  |g|= 5.26e-08  |ddm|= 8.75e-08
    CPU time for scf_cycle      1.31 sec, wall time      0.33 sec
exp = [2.61854674e+04 7.58579251e+03 3.55372549e+03 6.11188464e+02
 1.44955081e+02 4.07134439e+01 4.61236105e+00 3.94864443e-01
 1.36284002e+03 6.53441916e+02 2.42899905e+02 2.63198965e+02
 7.16278849e+02 1.25169401e+01 4.14041408e+01 9.24943298e-01
 4.11707627e+00 2.59078894e-01]
grad_E = [ 5.03168531e-07  1.17018752e-06  5.83823991e-05 -2.45528268e-05
  3.34489142e-04 -1.41365608e-03  1.67900278e-03  3.80603757e-03
  3.21842314e-06  1.34880272e-05  1.27920805e-04  1.00686943e-04
  1.08499309e-05 -5.02754689e-05  3.80238357e-05 -8.94258089e-03
  4.92345258e-03  4.67327154e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.4678174        1
[INPUT] 0    0    [1    /1   ]  7585.78790459        1
[INPUT] 0    0    [1    /1   ]  3553.71610093        1
[INPUT] 0    0    [1    /1   ]  611.041811613        1
[INPUT] 0    0    [1    /1   ]  145.085098327        1
[INPUT] 0    0    [1    /1   ]  40.8163967986        1
[INPUT] 0    0    [1    /1   ]  4.61022292276        1
[INPUT] 0    0    [1    /1   ]  0.394880164255       1
[INPUT] 1    0    [1    /1   ]  1362.83972302        1
[INPUT] 1    0    [1    /1   ]  653.437835618        1
[INPUT] 1    0    [1    /1   ]  242.877362196        1
[INPUT] 1    0    [1    /1   ]  263.179129412        1
[INPUT] 1    0    [1    /1   ]  716.780631334        1
[INPUT] 1    0    [1    /1   ]  12.3909391492        1
[INPUT] 1    0    [1    /1   ]  41.0967041315        1
[INPUT] 1    0    [1    /1   ]  0.917737299312       1
[INPUT] 1    0    [1    /1   ]  4.07757525846        1
[INPUT] 1    0    [1    /1   ]  0.255881158499       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.467817370292, 1.0]], [0, [7585.787904592927, 1.0]], [0, [3553.716100925118, 1.0]], [0, [611.041811612818, 1.0]], [0, [145.08509832733512, 1.0]], [0, [40.816396798576655, 1.0]], [0, [4.6102229227553115, 1.0]], [0, [0.3948801642547999, 1.0]], [1, [1362.8397230175929, 1.0]], [1, [653.4378356178203, 1.0]], [1, [242.87736219635502, 1.0]], [1, [263.17912941220453, 1.0]], [1, [716.7806313336285, 1.0]], [1, [12.39093914923867, 1.0]], [1, [41.09670413152142, 1.0]], [1, [0.9177372993119282, 1.0]], [1, [4.077575258461002, 1.0]], [1, [0.25588115849946735, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.46781737]
bas 1, expnt(s) = [7585.78790459]
bas 2, expnt(s) = [3553.71610093]
bas 3, expnt(s) = [611.04181161]
bas 4, expnt(s) = [145.08509833]
bas 5, expnt(s) = [40.8163968]
bas 6, expnt(s) = [4.61022292]
bas 7, expnt(s) = [0.39488016]
bas 8, expnt(s) = [1362.83972302]
bas 9, expnt(s) = [653.43783562]
bas 10, expnt(s) = [242.8773622]
bas 11, expnt(s) = [263.17912941]
bas 12, expnt(s) = [716.78063133]
bas 13, expnt(s) = [12.39093915]
bas 14, expnt(s) = [41.09670413]
bas 15, expnt(s) = [0.9177373]
bas 16, expnt(s) = [4.07757526]
bas 17, expnt(s) = [0.25588116]
CPU time:       695.86
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61854678e+04 5.20068173e+03 7.58578790e+03 2.05359854e+03
 3.55371610e+03 1.16285904e+03 6.11041812e+02 3.10504730e+02
 1.45085098e+02 1.05616587e+02 4.08163968e+01 4.07982018e+01
 4.61022292e+00 7.94888966e+00 3.94880164e-01 1.25853128e+00
 1.36283972e+03 2.41568539e+04 6.53437836e+02 9.63806253e+03
 2.42877362e+02 2.79716567e+03 2.63179129e+02 3.09242161e+03
 7.16780631e+02 1.08197498e+04 1.23909391e+01 6.78210755e+01
 4.10967041e+01 3.03559015e+02 9.17737299e-01 2.62048918e+00
 4.07757526e+00 1.69038984e+01 2.55881158e-01 5.30923902e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.96778710862337
cond(S) = 152774.33802621593
E1 = -728.5025029853332  E_coul = 203.09136989797258
init E= -525.411133087361
    CPU time for initialize scf      0.14 sec, wall time      0.04 sec
  HOMO = -0.558321042566707  LUMO = 1.30452245892882
  mo_energy =
[-1.18258172e+02 -1.20985494e+01 -9.44396432e+00 -9.44396432e+00
 -9.44396432e+00 -1.23125526e+00 -5.58321043e-01 -5.58321043e-01
 -5.58321043e-01  1.30452246e+00  1.30452246e+00  1.30452246e+00
  1.23355476e+01  1.23355476e+01  1.23355476e+01  6.85083556e+01
  6.85083556e+01  6.85083556e+01  1.04959224e+02  3.24898021e+02
  3.24898021e+02  3.24898021e+02  8.85177486e+02  9.79520647e+02
  9.79520647e+02  9.79520647e+02  2.21025729e+03  2.21025729e+03
  2.21025729e+03  4.42284688e+03  4.42284688e+03  4.42284688e+03
  5.31971250e+03  8.49760446e+03  8.49760446e+03  8.49760446e+03
  2.06524987e+04  7.11962443e+04]
E1 = -728.1008150293122  E_coul = 201.8195573834967
cycle= 1 E= -526.281257645816  delta_E= -0.87  |g|= 0.182  |ddm|= 0.514
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.485118
diis-c [-0.23533902  1.        ]
  HOMO = -0.566243749189633  LUMO = 1.29815909509645
  mo_energy =
[-1.18514382e+02 -1.21806370e+01 -9.53057749e+00 -9.53057749e+00
 -9.53057749e+00 -1.24553309e+00 -5.66243749e-01 -5.66243749e-01
 -5.66243749e-01  1.29815910e+00  1.29815910e+00  1.29815910e+00
  1.22703333e+01  1.22703333e+01  1.22703333e+01  6.83645216e+01
  6.83645216e+01  6.83645216e+01  1.04792924e+02  3.24666699e+02
  3.24666699e+02  3.24666699e+02  8.84833121e+02  9.79237945e+02
  9.79237945e+02  9.79237945e+02  2.20992587e+03  2.20992587e+03
  2.20992587e+03  4.42245845e+03  4.42245845e+03  4.42245845e+03
  5.31916868e+03  8.49711214e+03  8.49711214e+03  8.49711214e+03
  2.06518326e+04  7.11954885e+04]
E1 = -728.3293925231466  E_coul = 202.0478533641199
cycle= 2 E= -526.281539159027  delta_E= -0.000282  |g|= 0.0199  |ddm|= 0.0171
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0340831
diis-c [-8.15490963e-04  3.69978855e-02  9.63002115e-01]
  HOMO = -0.563679898834329  LUMO = 1.30077954435698
  mo_energy =
[-1.18479292e+02 -1.21649213e+01 -9.51457083e+00 -9.51457083e+00
 -9.51457083e+00 -1.24210628e+00 -5.63679899e-01 -5.63679899e-01
 -5.63679899e-01  1.30077954e+00  1.30077954e+00  1.30077954e+00
  1.22822941e+01  1.22822941e+01  1.22822941e+01  6.83882201e+01
  6.83882201e+01  6.83882201e+01  1.04823135e+02  3.24700127e+02
  3.24700127e+02  3.24700127e+02  8.84871074e+02  9.79274496e+02
  9.79274496e+02  9.79274496e+02  2.20996389e+03  2.20996389e+03
  2.20996389e+03  4.42249743e+03  4.42249743e+03  4.42249743e+03
  5.31920853e+03  8.49715176e+03  8.49715176e+03  8.49715176e+03
  2.06518726e+04  7.11955286e+04]
E1 = -728.2833805804266  E_coul = 202.00183351073596
cycle= 3 E= -526.281547069691  delta_E= -7.91e-06  |g|= 0.00244  |ddm|= 0.00409
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00458328
diis-c [-1.90448439e-07 -8.87532198e-04  1.12202459e-01  8.88685073e-01]
  HOMO = -0.564194297878247  LUMO = 1.30028222491009
  mo_energy =
[-1.18483675e+02 -1.21672470e+01 -9.51696989e+00 -9.51696989e+00
 -9.51696989e+00 -1.24278006e+00 -5.64194298e-01 -5.64194298e-01
 -5.64194298e-01  1.30028222e+00  1.30028222e+00  1.30028222e+00
  1.22804062e+01  1.22804062e+01  1.22804062e+01  6.83850247e+01
  6.83850247e+01  6.83850247e+01  1.04819359e+02  3.24695929e+02
  3.24695929e+02  3.24695929e+02  8.84866345e+02  9.79269961e+02
  9.79269961e+02  9.79269961e+02  2.20995917e+03  2.20995917e+03
  2.20995917e+03  4.42249256e+03  4.42249256e+03  4.42249256e+03
  5.31920343e+03  8.49714674e+03  8.49714674e+03  8.49714674e+03
  2.06518674e+04  7.11955233e+04]
E1 = -728.2898423878919  E_coul = 202.0082951346931
cycle= 4 E= -526.281547253199  delta_E= -1.84e-07  |g|= 4.16e-05  |ddm|= 0.000635
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.65763e-05
diis-c [-9.80420004e-10 -7.11911515e-06 -2.29838988e-04  8.90023398e-03
  9.91336724e-01]
  HOMO = -0.564169207462054  LUMO = 1.30030547558622
  mo_energy =
[-1.18483579e+02 -1.21671641e+01 -9.51688687e+00 -9.51688687e+00
 -9.51688687e+00 -1.24274746e+00 -5.64169207e-01 -5.64169207e-01
 -5.64169207e-01  1.30030548e+00  1.30030548e+00  1.30030548e+00
  1.22804770e+01  1.22804770e+01  1.22804770e+01  6.83851135e+01
  6.83851135e+01  6.83851135e+01  1.04819455e+02  3.24696025e+02
  3.24696025e+02  3.24696025e+02  8.84866437e+02  9.79270056e+02
  9.79270056e+02  9.79270056e+02  2.20995926e+03  2.20995926e+03
  2.20995926e+03  4.42249265e+03  4.42249265e+03  4.42249265e+03
  5.31920351e+03  8.49714682e+03  8.49714682e+03  8.49714682e+03
  2.06518675e+04  7.11955234e+04]
E1 = -728.2896516003071  E_coul = 202.00810434697718
cycle= 5 E= -526.28154725333  delta_E= -1.31e-10  |g|= 5.23e-06  |ddm|= 2.26e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2896516003071  E_coul = 202.00810434697718
  HOMO = -0.564171845127665  LUMO = 1.30030301409389
  mo_energy =
[-1.18483592e+02 -1.21671735e+01 -9.51689649e+00 -9.51689649e+00
 -9.51689649e+00 -1.24275090e+00 -5.64171845e-01 -5.64171845e-01
 -5.64171845e-01  1.30030301e+00  1.30030301e+00  1.30030301e+00
  1.22804690e+01  1.22804690e+01  1.22804690e+01  6.83851025e+01
  6.83851025e+01  6.83851025e+01  1.04819443e+02  3.24696012e+02
  3.24696012e+02  3.24696012e+02  8.84866424e+02  9.79270043e+02
  9.79270043e+02  9.79270043e+02  2.20995925e+03  2.20995925e+03
  2.20995925e+03  4.42249264e+03  4.42249264e+03  4.42249264e+03
  5.31920350e+03  8.49714681e+03  8.49714681e+03  8.49714681e+03
  2.06518675e+04  7.11955234e+04]
E1 = -728.2896749688609  E_coul = 202.0081277155289
Extra cycle  E= -526.281547253332  delta_E= -2.05e-12  |g|= 1.26e-06  |ddm|= 2.63e-06
    CPU time for scf_cycle      0.29 sec, wall time      0.20 sec
exp = [2.61854678e+04 7.58578790e+03 3.55371610e+03 6.11041812e+02
 1.45085098e+02 4.08163968e+01 4.61022292e+00 3.94880164e-01
 1.36283972e+03 6.53437836e+02 2.42877362e+02 2.63179129e+02
 7.16780631e+02 1.23909391e+01 4.10967041e+01 9.17737299e-01
 4.07757526e+00 2.55881158e-01]
E = -526.2815472533321
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.4678174        1
[INPUT] 0    0    [1    /1   ]  7585.78790459        1
[INPUT] 0    0    [1    /1   ]  3553.71610093        1
[INPUT] 0    0    [1    /1   ]  611.041811613        1
[INPUT] 0    0    [1    /1   ]  145.085098327        1
[INPUT] 0    0    [1    /1   ]  40.8163967986        1
[INPUT] 0    0    [1    /1   ]  4.61022292276        1
[INPUT] 0    0    [1    /1   ]  0.394880164255       1
[INPUT] 1    0    [1    /1   ]  1362.83972302        1
[INPUT] 1    0    [1    /1   ]  653.437835618        1
[INPUT] 1    0    [1    /1   ]  242.877362196        1
[INPUT] 1    0    [1    /1   ]  263.179129412        1
[INPUT] 1    0    [1    /1   ]  716.780631334        1
[INPUT] 1    0    [1    /1   ]  12.3909391492        1
[INPUT] 1    0    [1    /1   ]  41.0967041315        1
[INPUT] 1    0    [1    /1   ]  0.917737299312       1
[INPUT] 1    0    [1    /1   ]  4.07757525846        1
[INPUT] 1    0    [1    /1   ]  0.255881158499       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.467817370292, 1.0]], [0, [7585.787904592927, 1.0]], [0, [3553.716100925118, 1.0]], [0, [611.041811612818, 1.0]], [0, [145.08509832733512, 1.0]], [0, [40.816396798576655, 1.0]], [0, [4.6102229227553115, 1.0]], [0, [0.3948801642547999, 1.0]], [1, [1362.8397230175929, 1.0]], [1, [653.4378356178203, 1.0]], [1, [242.87736219635502, 1.0]], [1, [263.17912941220453, 1.0]], [1, [716.7806313336285, 1.0]], [1, [12.39093914923867, 1.0]], [1, [41.09670413152142, 1.0]], [1, [0.9177372993119282, 1.0]], [1, [4.077575258461002, 1.0]], [1, [0.25588115849946735, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.46781737]
bas 1, expnt(s) = [7585.78790459]
bas 2, expnt(s) = [3553.71610093]
bas 3, expnt(s) = [611.04181161]
bas 4, expnt(s) = [145.08509833]
bas 5, expnt(s) = [40.8163968]
bas 6, expnt(s) = [4.61022292]
bas 7, expnt(s) = [0.39488016]
bas 8, expnt(s) = [1362.83972302]
bas 9, expnt(s) = [653.43783562]
bas 10, expnt(s) = [242.8773622]
bas 11, expnt(s) = [263.17912941]
bas 12, expnt(s) = [716.78063133]
bas 13, expnt(s) = [12.39093915]
bas 14, expnt(s) = [41.09670413]
bas 15, expnt(s) = [0.9177373]
bas 16, expnt(s) = [4.07757526]
bas 17, expnt(s) = [0.25588116]
CPU time:       696.59
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61854678e+04 5.20068173e+03 7.58578790e+03 2.05359854e+03
 3.55371610e+03 1.16285904e+03 6.11041812e+02 3.10504730e+02
 1.45085098e+02 1.05616587e+02 4.08163968e+01 4.07982018e+01
 4.61022292e+00 7.94888966e+00 3.94880164e-01 1.25853128e+00
 1.36283972e+03 2.41568539e+04 6.53437836e+02 9.63806253e+03
 2.42877362e+02 2.79716567e+03 2.63179129e+02 3.09242161e+03
 7.16780631e+02 1.08197498e+04 1.23909391e+01 6.78210755e+01
 4.10967041e+01 3.03559015e+02 9.17737299e-01 2.62048918e+00
 4.07757526e+00 1.69038984e+01 2.55881158e-01 5.30923902e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.96778710862337
cond(S) = 152774.33802621593
E1 = -728.5025029853332  E_coul = 203.09136989797258
init E= -525.411133087361
    CPU time for initialize scf      0.13 sec, wall time      0.04 sec
  HOMO = -0.558321042566707  LUMO = 1.30452245892882
  mo_energy =
[-1.18258172e+02 -1.20985494e+01 -9.44396432e+00 -9.44396432e+00
 -9.44396432e+00 -1.23125526e+00 -5.58321043e-01 -5.58321043e-01
 -5.58321043e-01  1.30452246e+00  1.30452246e+00  1.30452246e+00
  1.23355476e+01  1.23355476e+01  1.23355476e+01  6.85083556e+01
  6.85083556e+01  6.85083556e+01  1.04959224e+02  3.24898021e+02
  3.24898021e+02  3.24898021e+02  8.85177486e+02  9.79520647e+02
  9.79520647e+02  9.79520647e+02  2.21025729e+03  2.21025729e+03
  2.21025729e+03  4.42284688e+03  4.42284688e+03  4.42284688e+03
  5.31971250e+03  8.49760446e+03  8.49760446e+03  8.49760446e+03
  2.06524987e+04  7.11962443e+04]
E1 = -728.1008150293122  E_coul = 201.8195573834967
cycle= 1 E= -526.281257645816  delta_E= -0.87  |g|= 0.182  |ddm|= 0.514
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.485118
diis-c [-0.23533902  1.        ]
  HOMO = -0.566243749189633  LUMO = 1.29815909509645
  mo_energy =
[-1.18514382e+02 -1.21806370e+01 -9.53057749e+00 -9.53057749e+00
 -9.53057749e+00 -1.24553309e+00 -5.66243749e-01 -5.66243749e-01
 -5.66243749e-01  1.29815910e+00  1.29815910e+00  1.29815910e+00
  1.22703333e+01  1.22703333e+01  1.22703333e+01  6.83645216e+01
  6.83645216e+01  6.83645216e+01  1.04792924e+02  3.24666699e+02
  3.24666699e+02  3.24666699e+02  8.84833121e+02  9.79237945e+02
  9.79237945e+02  9.79237945e+02  2.20992587e+03  2.20992587e+03
  2.20992587e+03  4.42245845e+03  4.42245845e+03  4.42245845e+03
  5.31916868e+03  8.49711214e+03  8.49711214e+03  8.49711214e+03
  2.06518326e+04  7.11954885e+04]
E1 = -728.3293925231466  E_coul = 202.0478533641199
cycle= 2 E= -526.281539159027  delta_E= -0.000282  |g|= 0.0199  |ddm|= 0.0171
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0340831
diis-c [-8.15490963e-04  3.69978855e-02  9.63002115e-01]
  HOMO = -0.563679898834329  LUMO = 1.30077954435698
  mo_energy =
[-1.18479292e+02 -1.21649213e+01 -9.51457083e+00 -9.51457083e+00
 -9.51457083e+00 -1.24210628e+00 -5.63679899e-01 -5.63679899e-01
 -5.63679899e-01  1.30077954e+00  1.30077954e+00  1.30077954e+00
  1.22822941e+01  1.22822941e+01  1.22822941e+01  6.83882201e+01
  6.83882201e+01  6.83882201e+01  1.04823135e+02  3.24700127e+02
  3.24700127e+02  3.24700127e+02  8.84871074e+02  9.79274496e+02
  9.79274496e+02  9.79274496e+02  2.20996389e+03  2.20996389e+03
  2.20996389e+03  4.42249743e+03  4.42249743e+03  4.42249743e+03
  5.31920853e+03  8.49715176e+03  8.49715176e+03  8.49715176e+03
  2.06518726e+04  7.11955286e+04]
E1 = -728.2833805804266  E_coul = 202.00183351073596
cycle= 3 E= -526.281547069691  delta_E= -7.91e-06  |g|= 0.00244  |ddm|= 0.00409
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00458328
diis-c [-1.90448439e-07 -8.87532198e-04  1.12202459e-01  8.88685073e-01]
  HOMO = -0.564194297878247  LUMO = 1.30028222491009
  mo_energy =
[-1.18483675e+02 -1.21672470e+01 -9.51696989e+00 -9.51696989e+00
 -9.51696989e+00 -1.24278006e+00 -5.64194298e-01 -5.64194298e-01
 -5.64194298e-01  1.30028222e+00  1.30028222e+00  1.30028222e+00
  1.22804062e+01  1.22804062e+01  1.22804062e+01  6.83850247e+01
  6.83850247e+01  6.83850247e+01  1.04819359e+02  3.24695929e+02
  3.24695929e+02  3.24695929e+02  8.84866345e+02  9.79269961e+02
  9.79269961e+02  9.79269961e+02  2.20995917e+03  2.20995917e+03
  2.20995917e+03  4.42249256e+03  4.42249256e+03  4.42249256e+03
  5.31920343e+03  8.49714674e+03  8.49714674e+03  8.49714674e+03
  2.06518674e+04  7.11955233e+04]
E1 = -728.2898423878919  E_coul = 202.0082951346931
cycle= 4 E= -526.281547253199  delta_E= -1.84e-07  |g|= 4.16e-05  |ddm|= 0.000635
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.65763e-05
diis-c [-9.80420004e-10 -7.11911515e-06 -2.29838988e-04  8.90023398e-03
  9.91336724e-01]
  HOMO = -0.564169207462054  LUMO = 1.30030547558622
  mo_energy =
[-1.18483579e+02 -1.21671641e+01 -9.51688687e+00 -9.51688687e+00
 -9.51688687e+00 -1.24274746e+00 -5.64169207e-01 -5.64169207e-01
 -5.64169207e-01  1.30030548e+00  1.30030548e+00  1.30030548e+00
  1.22804770e+01  1.22804770e+01  1.22804770e+01  6.83851135e+01
  6.83851135e+01  6.83851135e+01  1.04819455e+02  3.24696025e+02
  3.24696025e+02  3.24696025e+02  8.84866437e+02  9.79270056e+02
  9.79270056e+02  9.79270056e+02  2.20995926e+03  2.20995926e+03
  2.20995926e+03  4.42249265e+03  4.42249265e+03  4.42249265e+03
  5.31920351e+03  8.49714682e+03  8.49714682e+03  8.49714682e+03
  2.06518675e+04  7.11955234e+04]
E1 = -728.2896516003071  E_coul = 202.00810434697718
cycle= 5 E= -526.28154725333  delta_E= -1.31e-10  |g|= 5.23e-06  |ddm|= 2.26e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2896516003071  E_coul = 202.00810434697718
  HOMO = -0.564171845127665  LUMO = 1.30030301409389
  mo_energy =
[-1.18483592e+02 -1.21671735e+01 -9.51689649e+00 -9.51689649e+00
 -9.51689649e+00 -1.24275090e+00 -5.64171845e-01 -5.64171845e-01
 -5.64171845e-01  1.30030301e+00  1.30030301e+00  1.30030301e+00
  1.22804690e+01  1.22804690e+01  1.22804690e+01  6.83851025e+01
  6.83851025e+01  6.83851025e+01  1.04819443e+02  3.24696012e+02
  3.24696012e+02  3.24696012e+02  8.84866424e+02  9.79270043e+02
  9.79270043e+02  9.79270043e+02  2.20995925e+03  2.20995925e+03
  2.20995925e+03  4.42249264e+03  4.42249264e+03  4.42249264e+03
  5.31920350e+03  8.49714681e+03  8.49714681e+03  8.49714681e+03
  2.06518675e+04  7.11955234e+04]
E1 = -728.2896749688609  E_coul = 202.0081277155289
Extra cycle  E= -526.281547253332  delta_E= -2.05e-12  |g|= 1.26e-06  |ddm|= 2.63e-06
    CPU time for scf_cycle      0.30 sec, wall time      0.20 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 152774.33802621593
E1 = -728.2896749688609  E_coul = 202.0081277155289
init E= -526.281547253332
    CPU time for initialize scf      0.98 sec, wall time      0.19 sec
  HOMO = -0.564171417588441  LUMO = 1.30030342055268
  mo_energy =
[-1.18483589e+02 -1.21671718e+01 -9.51689473e+00 -9.51689473e+00
 -9.51689473e+00 -1.24275034e+00 -5.64171418e-01 -5.64171418e-01
 -5.64171418e-01  1.30030342e+00  1.30030342e+00  1.30030342e+00
  1.22804704e+01  1.22804704e+01  1.22804704e+01  6.83851047e+01
  6.83851047e+01  6.83851047e+01  1.04819446e+02  3.24696014e+02
  3.24696014e+02  3.24696014e+02  8.84866427e+02  9.79270045e+02
  9.79270045e+02  9.79270045e+02  2.20995925e+03  2.20995925e+03
  2.20995925e+03  4.42249264e+03  4.42249264e+03  4.42249264e+03
  5.31920350e+03  8.49714681e+03  8.49714681e+03  8.49714681e+03
  2.06518675e+04  7.11955234e+04]
E1 = -728.2896704524845  E_coul = 202.00812319915238
cycle= 1 E= -526.281547253332  delta_E= -1.14e-13  |g|= 2.65e-07  |ddm|= 4.69e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.2896704524845  E_coul = 202.00812319915238
  HOMO = -0.564171495414346  LUMO = 1.30030334602835
  mo_energy =
[-1.18483590e+02 -1.21671721e+01 -9.51689507e+00 -9.51689507e+00
 -9.51689507e+00 -1.24275044e+00 -5.64171495e-01 -5.64171495e-01
 -5.64171495e-01  1.30030335e+00  1.30030335e+00  1.30030335e+00
  1.22804702e+01  1.22804702e+01  1.22804702e+01  6.83851042e+01
  6.83851042e+01  6.83851042e+01  1.04819445e+02  3.24696014e+02
  3.24696014e+02  3.24696014e+02  8.84866426e+02  9.79270045e+02
  9.79270045e+02  9.79270045e+02  2.20995925e+03  2.20995925e+03
  2.20995925e+03  4.42249264e+03  4.42249264e+03  4.42249264e+03
  5.31920350e+03  8.49714681e+03  8.49714681e+03  8.49714681e+03
  2.06518675e+04  7.11955234e+04]
E1 = -728.289671338268  E_coul = 202.0081240849372
Extra cycle  E= -526.281547253331  delta_E= 1.36e-12  |g|= 5.36e-08  |ddm|= 8.98e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.30 sec
exp = [2.61854678e+04 7.58578790e+03 3.55371610e+03 6.11041812e+02
 1.45085098e+02 4.08163968e+01 4.61022292e+00 3.94880164e-01
 1.36283972e+03 6.53437836e+02 2.42877362e+02 2.63179129e+02
 7.16780631e+02 1.23909391e+01 4.10967041e+01 9.17737299e-01
 4.07757526e+00 2.55881158e-01]
grad_E = [ 5.05093264e-07  1.17577795e-06  5.84785509e-05 -2.18186746e-05
  1.36737686e-04 -2.58906736e-04  2.96902806e-05  4.52796034e-04
  3.36751954e-06  1.41361303e-05  1.34128149e-04  1.05633589e-04
  1.13563224e-05 -5.45194341e-04  6.55529653e-05 -1.10112370e-03
  2.44416022e-03  5.80546963e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:55 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.4697045        1
[INPUT] 0    0    [1    /1   ]  7585.76742991        1
[INPUT] 0    0    [1    /1   ]  3553.67562625        1
[INPUT] 0    0    [1    /1   ]  610.407188234        1
[INPUT] 0    0    [1    /1   ]  144.87063473         1
[INPUT] 0    0    [1    /1   ]  40.7877707417        1
[INPUT] 0    0    [1    /1   ]  4.60995515367        1
[INPUT] 0    0    [1    /1   ]  0.394893516226       1
[INPUT] 1    0    [1    /1   ]  1362.84066973        1
[INPUT] 1    0    [1    /1   ]  653.438079652        1
[INPUT] 1    0    [1    /1   ]  242.88262267         1
[INPUT] 1    0    [1    /1   ]  263.184075307        1
[INPUT] 1    0    [1    /1   ]  716.232478945        1
[INPUT] 1    0    [1    /1   ]  12.3638221359        1
[INPUT] 1    0    [1    /1   ]  41.0278447334        1
[INPUT] 1    0    [1    /1   ]  0.915465488855       1
[INPUT] 1    0    [1    /1   ]  4.06665435983        1
[INPUT] 1    0    [1    /1   ]  0.255005881883       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.469704517476, 1.0]], [0, [7585.767429907582, 1.0]], [0, [3553.6756262544595, 1.0]], [0, [610.4071882340629, 1.0]], [0, [144.87063473013336, 1.0]], [0, [40.787770741729894, 1.0]], [0, [4.609955153668897, 1.0]], [0, [0.39489351622641217, 1.0]], [1, [1362.8406697288365, 1.0]], [1, [653.4380796517746, 1.0]], [1, [242.88262267001093, 1.0]], [1, [263.18407530704474, 1.0]], [1, [716.2324789448, 1.0]], [1, [12.363822135905789, 1.0]], [1, [41.027844733444795, 1.0]], [1, [0.9154654888550559, 1.0]], [1, [4.066654359832581, 1.0]], [1, [0.25500588188272716, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.46970452]
bas 1, expnt(s) = [7585.76742991]
bas 2, expnt(s) = [3553.67562625]
bas 3, expnt(s) = [610.40718823]
bas 4, expnt(s) = [144.87063473]
bas 5, expnt(s) = [40.78777074]
bas 6, expnt(s) = [4.60995515]
bas 7, expnt(s) = [0.39489352]
bas 8, expnt(s) = [1362.84066973]
bas 9, expnt(s) = [653.43807965]
bas 10, expnt(s) = [242.88262267]
bas 11, expnt(s) = [263.18407531]
bas 12, expnt(s) = [716.23247894]
bas 13, expnt(s) = [12.36382214]
bas 14, expnt(s) = [41.02784473]
bas 15, expnt(s) = [0.91546549]
bas 16, expnt(s) = [4.06665436]
bas 17, expnt(s) = [0.25500588]
CPU time:       702.55
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61854697e+04 5.20068202e+03 7.58576743e+03 2.05359438e+03
 3.55367563e+03 1.16284910e+03 6.10407188e+02 3.10262833e+02
 1.44870635e+02 1.05499475e+02 4.07877707e+01 4.07767399e+01
 4.60995515e+00 7.94854340e+00 3.94893516e-01 1.25856319e+00
 1.36284067e+03 2.41568748e+04 6.53438080e+02 9.63806703e+03
 2.42882623e+02 2.79724140e+03 2.63184075e+02 3.09249426e+03
 7.16232479e+02 1.08094079e+04 1.23638221e+01 6.76355971e+01
 4.10278447e+01 3.02923364e+02 9.15465489e-01 2.61238309e+00
 4.06665436e+00 1.68473256e+01 2.55005882e-01 5.28654751e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.968034676000514
cond(S) = 154517.66284668812
E1 = -728.5033176590368  E_coul = 203.09120940136603
init E= -525.412108257671
    CPU time for initialize scf      0.15 sec, wall time      0.04 sec
  HOMO = -0.558352587287526  LUMO = 1.29848091596749
  mo_energy =
[-1.18258148e+02 -1.20985873e+01 -9.44396015e+00 -9.44396015e+00
 -9.44396015e+00 -1.23125663e+00 -5.58352587e-01 -5.58352587e-01
 -5.58352587e-01  1.29848092e+00  1.29848092e+00  1.29848092e+00
  1.22880465e+01  1.22880465e+01  1.22880465e+01  6.83255151e+01
  6.83255151e+01  6.83255151e+01  1.04791727e+02  3.24560405e+02
  3.24560405e+02  3.24560405e+02  8.83934869e+02  9.79114419e+02
  9.79114419e+02  9.79114419e+02  2.20966343e+03  2.20966343e+03
  2.20966343e+03  4.42172076e+03  4.42172076e+03  4.42172076e+03
  5.31693220e+03  8.49573088e+03  8.49573088e+03  8.49573088e+03
  2.06493193e+04  7.11930888e+04]
E1 = -728.0845622890581  E_coul = 201.8032884942448
cycle= 1 E= -526.281273794813  delta_E= -0.869  |g|= 0.183  |ddm|= 0.524
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.485564
diis-c [-0.23577266  1.        ]
  HOMO = -0.566681259068222  LUMO = 1.29179234941143
  mo_energy =
[-1.18515937e+02 -1.21818529e+01 -9.53176227e+00 -9.53176227e+00
 -9.53176227e+00 -1.24604027e+00 -5.66681259e-01 -5.66681259e-01
 -5.66681259e-01  1.29179235e+00  1.29179235e+00  1.29179235e+00
  1.22219475e+01  1.22219475e+01  1.22219475e+01  6.81804398e+01
  6.81804398e+01  6.81804398e+01  1.04624042e+02  3.24327522e+02
  3.24327522e+02  3.24327522e+02  8.83589037e+02  9.78830139e+02
  9.78830139e+02  9.78830139e+02  2.20933044e+03  2.20933044e+03
  2.20933044e+03  4.42133071e+03  4.42133071e+03  4.42133071e+03
  5.31638665e+03  8.49523686e+03  8.49523686e+03  8.49523686e+03
  2.06486513e+04  7.11923313e+04]
E1 = -728.3163832114591  E_coul = 202.03482426316407
cycle= 2 E= -526.281558948295  delta_E= -0.000285  |g|= 0.02  |ddm|= 0.0174
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0343549
diis-c [-8.26275509e-04  3.73654911e-02  9.62634509e-01]
  HOMO = -0.56405770302926  LUMO = 1.29445873026697
  mo_energy =
[-1.18480501e+02 -1.21659120e+01 -9.51552584e+00 -9.51552584e+00
 -9.51552584e+00 -1.24253505e+00 -5.64057703e-01 -5.64057703e-01
 -5.64057703e-01  1.29445873e+00  1.29445873e+00  1.29445873e+00
  1.22340743e+01  1.22340743e+01  1.22340743e+01  6.82043995e+01
  6.82043995e+01  6.82043995e+01  1.04654555e+02  3.24361285e+02
  3.24361285e+02  3.24361285e+02  8.83627349e+02  9.78867045e+02
  9.78867045e+02  9.78867045e+02  2.20936882e+03  2.20936882e+03
  2.20936882e+03  4.42137007e+03  4.42137007e+03  4.42137007e+03
  5.31642687e+03  8.49527686e+03  8.49527686e+03  8.49527686e+03
  2.06486918e+04  7.11923718e+04]
E1 = -728.2697268639191  E_coul = 201.98815981450744
cycle= 3 E= -526.281567049412  delta_E= -8.1e-06  |g|= 0.00246  |ddm|= 0.00415
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00462158
diis-c [-1.91214745e-07 -8.89885175e-04  1.12260121e-01  8.88629764e-01]
  HOMO = -0.564579375474952  LUMO = 1.29395644290929
  mo_energy =
[-1.18484925e+02 -1.21682642e+01 -9.51795207e+00 -9.51795207e+00
 -9.51795207e+00 -1.24321830e+00 -5.64579375e-01 -5.64579375e-01
 -5.64579375e-01  1.29395644e+00  1.29395644e+00  1.29395644e+00
  1.22321668e+01  1.22321668e+01  1.22321668e+01  6.82011728e+01
  6.82011728e+01  6.82011728e+01  1.04650743e+02  3.24357048e+02
  3.24357048e+02  3.24357048e+02  8.83622577e+02  9.78862468e+02
  9.78862468e+02  9.78862468e+02  2.20936405e+03  2.20936405e+03
  2.20936405e+03  4.42136515e+03  4.42136515e+03  4.42136515e+03
  5.31642173e+03  8.49527179e+03  8.49527179e+03  8.49527179e+03
  2.06486865e+04  7.11923664e+04]
E1 = -728.276268703046  E_coul = 201.99470146589763
cycle= 4 E= -526.281567237148  delta_E= -1.88e-07  |g|= 4.16e-05  |ddm|= 0.000643
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.65743e-05
diis-c [-9.85064997e-10 -7.19056281e-06 -2.21672281e-04  8.86762545e-03
  9.91361237e-01]
  HOMO = -0.564554205472966  LUMO = 1.2939796841136
  mo_energy =
[-1.18484830e+02 -1.21681811e+01 -9.51786889e+00 -9.51786889e+00
 -9.51786889e+00 -1.24318560e+00 -5.64554205e-01 -5.64554205e-01
 -5.64554205e-01  1.29397968e+00  1.29397968e+00  1.29397968e+00
  1.22322377e+01  1.22322377e+01  1.22322377e+01  6.82012617e+01
  6.82012617e+01  6.82012617e+01  1.04650839e+02  3.24357143e+02
  3.24357143e+02  3.24357143e+02  8.83622670e+02  9.78862563e+02
  9.78862563e+02  9.78862563e+02  2.20936415e+03  2.20936415e+03
  2.20936415e+03  4.42136524e+03  4.42136524e+03  4.42136524e+03
  5.31642181e+03  8.49527188e+03  8.49527188e+03  8.49527188e+03
  2.06486866e+04  7.11923665e+04]
E1 = -728.2760771272358  E_coul = 201.99450988995636
cycle= 5 E= -526.281567237279  delta_E= -1.31e-10  |g|= 5.25e-06  |ddm|= 2.27e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2760771272358  E_coul = 201.99450988995636
  HOMO = -0.564556857256509  LUMO = 1.29397721847979
  mo_energy =
[-1.18484843e+02 -1.21681906e+01 -9.51787856e+00 -9.51787856e+00
 -9.51787856e+00 -1.24318905e+00 -5.64556857e-01 -5.64556857e-01
 -5.64556857e-01  1.29397722e+00  1.29397722e+00  1.29397722e+00
  1.22322297e+01  1.22322297e+01  1.22322297e+01  6.82012506e+01
  6.82012506e+01  6.82012506e+01  1.04650827e+02  3.24357130e+02
  3.24357130e+02  3.24357130e+02  8.83622656e+02  9.78862549e+02
  9.78862549e+02  9.78862549e+02  2.20936413e+03  2.20936413e+03
  2.20936413e+03  4.42136523e+03  4.42136523e+03  4.42136523e+03
  5.31642180e+03  8.49527186e+03  8.49527186e+03  8.49527186e+03
  2.06486866e+04  7.11923665e+04]
E1 = -728.2761006397059  E_coul = 201.99453340242317
Extra cycle  E= -526.281567237283  delta_E= -3.3e-12  |g|= 1.27e-06  |ddm|= 2.64e-06
    CPU time for scf_cycle      0.30 sec, wall time      0.20 sec
exp = [2.61854697e+04 7.58576743e+03 3.55367563e+03 6.10407188e+02
 1.44870635e+02 4.07877707e+01 4.60995515e+00 3.94893516e-01
 1.36284067e+03 6.53438080e+02 2.42882623e+02 2.63184075e+02
 7.16232479e+02 1.23638221e+01 4.10278447e+01 9.15465489e-01
 4.06665436e+00 2.55005882e-01]
E = -526.2815672372827
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:29:55 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.4697045        1
[INPUT] 0    0    [1    /1   ]  7585.76742991        1
[INPUT] 0    0    [1    /1   ]  3553.67562625        1
[INPUT] 0    0    [1    /1   ]  610.407188234        1
[INPUT] 0    0    [1    /1   ]  144.87063473         1
[INPUT] 0    0    [1    /1   ]  40.7877707417        1
[INPUT] 0    0    [1    /1   ]  4.60995515367        1
[INPUT] 0    0    [1    /1   ]  0.394893516226       1
[INPUT] 1    0    [1    /1   ]  1362.84066973        1
[INPUT] 1    0    [1    /1   ]  653.438079652        1
[INPUT] 1    0    [1    /1   ]  242.88262267         1
[INPUT] 1    0    [1    /1   ]  263.184075307        1
[INPUT] 1    0    [1    /1   ]  716.232478945        1
[INPUT] 1    0    [1    /1   ]  12.3638221359        1
[INPUT] 1    0    [1    /1   ]  41.0278447334        1
[INPUT] 1    0    [1    /1   ]  0.915465488855       1
[INPUT] 1    0    [1    /1   ]  4.06665435983        1
[INPUT] 1    0    [1    /1   ]  0.255005881883       1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.469704517476, 1.0]], [0, [7585.767429907582, 1.0]], [0, [3553.6756262544595, 1.0]], [0, [610.4071882340629, 1.0]], [0, [144.87063473013336, 1.0]], [0, [40.787770741729894, 1.0]], [0, [4.609955153668897, 1.0]], [0, [0.39489351622641217, 1.0]], [1, [1362.8406697288365, 1.0]], [1, [653.4380796517746, 1.0]], [1, [242.88262267001093, 1.0]], [1, [263.18407530704474, 1.0]], [1, [716.2324789448, 1.0]], [1, [12.363822135905789, 1.0]], [1, [41.027844733444795, 1.0]], [1, [0.9154654888550559, 1.0]], [1, [4.066654359832581, 1.0]], [1, [0.25500588188272716, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.46970452]
bas 1, expnt(s) = [7585.76742991]
bas 2, expnt(s) = [3553.67562625]
bas 3, expnt(s) = [610.40718823]
bas 4, expnt(s) = [144.87063473]
bas 5, expnt(s) = [40.78777074]
bas 6, expnt(s) = [4.60995515]
bas 7, expnt(s) = [0.39489352]
bas 8, expnt(s) = [1362.84066973]
bas 9, expnt(s) = [653.43807965]
bas 10, expnt(s) = [242.88262267]
bas 11, expnt(s) = [263.18407531]
bas 12, expnt(s) = [716.23247894]
bas 13, expnt(s) = [12.36382214]
bas 14, expnt(s) = [41.02784473]
bas 15, expnt(s) = [0.91546549]
bas 16, expnt(s) = [4.06665436]
bas 17, expnt(s) = [0.25500588]
CPU time:       703.19
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61854697e+04 5.20068202e+03 7.58576743e+03 2.05359438e+03
 3.55367563e+03 1.16284910e+03 6.10407188e+02 3.10262833e+02
 1.44870635e+02 1.05499475e+02 4.07877707e+01 4.07767399e+01
 4.60995515e+00 7.94854340e+00 3.94893516e-01 1.25856319e+00
 1.36284067e+03 2.41568748e+04 6.53438080e+02 9.63806703e+03
 2.42882623e+02 2.79724140e+03 2.63184075e+02 3.09249426e+03
 7.16232479e+02 1.08094079e+04 1.23638221e+01 6.76355971e+01
 4.10278447e+01 3.02923364e+02 9.15465489e-01 2.61238309e+00
 4.06665436e+00 1.68473256e+01 2.55005882e-01 5.28654751e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.968034676000514
cond(S) = 154517.66284668812
E1 = -728.5033176590368  E_coul = 203.09120940136603
init E= -525.412108257671
    CPU time for initialize scf      0.13 sec, wall time      0.04 sec
  HOMO = -0.558352587287526  LUMO = 1.29848091596749
  mo_energy =
[-1.18258148e+02 -1.20985873e+01 -9.44396015e+00 -9.44396015e+00
 -9.44396015e+00 -1.23125663e+00 -5.58352587e-01 -5.58352587e-01
 -5.58352587e-01  1.29848092e+00  1.29848092e+00  1.29848092e+00
  1.22880465e+01  1.22880465e+01  1.22880465e+01  6.83255151e+01
  6.83255151e+01  6.83255151e+01  1.04791727e+02  3.24560405e+02
  3.24560405e+02  3.24560405e+02  8.83934869e+02  9.79114419e+02
  9.79114419e+02  9.79114419e+02  2.20966343e+03  2.20966343e+03
  2.20966343e+03  4.42172076e+03  4.42172076e+03  4.42172076e+03
  5.31693220e+03  8.49573088e+03  8.49573088e+03  8.49573088e+03
  2.06493193e+04  7.11930888e+04]
E1 = -728.0845622890581  E_coul = 201.8032884942448
cycle= 1 E= -526.281273794813  delta_E= -0.869  |g|= 0.183  |ddm|= 0.524
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.485564
diis-c [-0.23577266  1.        ]
  HOMO = -0.566681259068222  LUMO = 1.29179234941143
  mo_energy =
[-1.18515937e+02 -1.21818529e+01 -9.53176227e+00 -9.53176227e+00
 -9.53176227e+00 -1.24604027e+00 -5.66681259e-01 -5.66681259e-01
 -5.66681259e-01  1.29179235e+00  1.29179235e+00  1.29179235e+00
  1.22219475e+01  1.22219475e+01  1.22219475e+01  6.81804398e+01
  6.81804398e+01  6.81804398e+01  1.04624042e+02  3.24327522e+02
  3.24327522e+02  3.24327522e+02  8.83589037e+02  9.78830139e+02
  9.78830139e+02  9.78830139e+02  2.20933044e+03  2.20933044e+03
  2.20933044e+03  4.42133071e+03  4.42133071e+03  4.42133071e+03
  5.31638665e+03  8.49523686e+03  8.49523686e+03  8.49523686e+03
  2.06486513e+04  7.11923313e+04]
E1 = -728.3163832114591  E_coul = 202.03482426316407
cycle= 2 E= -526.281558948295  delta_E= -0.000285  |g|= 0.02  |ddm|= 0.0174
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0343549
diis-c [-8.26275509e-04  3.73654911e-02  9.62634509e-01]
  HOMO = -0.56405770302926  LUMO = 1.29445873026697
  mo_energy =
[-1.18480501e+02 -1.21659120e+01 -9.51552584e+00 -9.51552584e+00
 -9.51552584e+00 -1.24253505e+00 -5.64057703e-01 -5.64057703e-01
 -5.64057703e-01  1.29445873e+00  1.29445873e+00  1.29445873e+00
  1.22340743e+01  1.22340743e+01  1.22340743e+01  6.82043995e+01
  6.82043995e+01  6.82043995e+01  1.04654555e+02  3.24361285e+02
  3.24361285e+02  3.24361285e+02  8.83627349e+02  9.78867045e+02
  9.78867045e+02  9.78867045e+02  2.20936882e+03  2.20936882e+03
  2.20936882e+03  4.42137007e+03  4.42137007e+03  4.42137007e+03
  5.31642687e+03  8.49527686e+03  8.49527686e+03  8.49527686e+03
  2.06486918e+04  7.11923718e+04]
E1 = -728.2697268639191  E_coul = 201.98815981450744
cycle= 3 E= -526.281567049412  delta_E= -8.1e-06  |g|= 0.00246  |ddm|= 0.00415
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00462158
diis-c [-1.91214745e-07 -8.89885175e-04  1.12260121e-01  8.88629764e-01]
  HOMO = -0.564579375474952  LUMO = 1.29395644290929
  mo_energy =
[-1.18484925e+02 -1.21682642e+01 -9.51795207e+00 -9.51795207e+00
 -9.51795207e+00 -1.24321830e+00 -5.64579375e-01 -5.64579375e-01
 -5.64579375e-01  1.29395644e+00  1.29395644e+00  1.29395644e+00
  1.22321668e+01  1.22321668e+01  1.22321668e+01  6.82011728e+01
  6.82011728e+01  6.82011728e+01  1.04650743e+02  3.24357048e+02
  3.24357048e+02  3.24357048e+02  8.83622577e+02  9.78862468e+02
  9.78862468e+02  9.78862468e+02  2.20936405e+03  2.20936405e+03
  2.20936405e+03  4.42136515e+03  4.42136515e+03  4.42136515e+03
  5.31642173e+03  8.49527179e+03  8.49527179e+03  8.49527179e+03
  2.06486865e+04  7.11923664e+04]
E1 = -728.276268703046  E_coul = 201.99470146589763
cycle= 4 E= -526.281567237148  delta_E= -1.88e-07  |g|= 4.16e-05  |ddm|= 0.000643
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.65743e-05
diis-c [-9.85064997e-10 -7.19056281e-06 -2.21672281e-04  8.86762545e-03
  9.91361237e-01]
  HOMO = -0.564554205472966  LUMO = 1.2939796841136
  mo_energy =
[-1.18484830e+02 -1.21681811e+01 -9.51786889e+00 -9.51786889e+00
 -9.51786889e+00 -1.24318560e+00 -5.64554205e-01 -5.64554205e-01
 -5.64554205e-01  1.29397968e+00  1.29397968e+00  1.29397968e+00
  1.22322377e+01  1.22322377e+01  1.22322377e+01  6.82012617e+01
  6.82012617e+01  6.82012617e+01  1.04650839e+02  3.24357143e+02
  3.24357143e+02  3.24357143e+02  8.83622670e+02  9.78862563e+02
  9.78862563e+02  9.78862563e+02  2.20936415e+03  2.20936415e+03
  2.20936415e+03  4.42136524e+03  4.42136524e+03  4.42136524e+03
  5.31642181e+03  8.49527188e+03  8.49527188e+03  8.49527188e+03
  2.06486866e+04  7.11923665e+04]
E1 = -728.2760771272358  E_coul = 201.99450988995636
cycle= 5 E= -526.281567237279  delta_E= -1.31e-10  |g|= 5.25e-06  |ddm|= 2.27e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2760771272358  E_coul = 201.99450988995636
  HOMO = -0.564556857256509  LUMO = 1.29397721847979
  mo_energy =
[-1.18484843e+02 -1.21681906e+01 -9.51787856e+00 -9.51787856e+00
 -9.51787856e+00 -1.24318905e+00 -5.64556857e-01 -5.64556857e-01
 -5.64556857e-01  1.29397722e+00  1.29397722e+00  1.29397722e+00
  1.22322297e+01  1.22322297e+01  1.22322297e+01  6.82012506e+01
  6.82012506e+01  6.82012506e+01  1.04650827e+02  3.24357130e+02
  3.24357130e+02  3.24357130e+02  8.83622656e+02  9.78862549e+02
  9.78862549e+02  9.78862549e+02  2.20936413e+03  2.20936413e+03
  2.20936413e+03  4.42136523e+03  4.42136523e+03  4.42136523e+03
  5.31642180e+03  8.49527186e+03  8.49527186e+03  8.49527186e+03
  2.06486866e+04  7.11923665e+04]
E1 = -728.2761006397059  E_coul = 201.99453340242317
Extra cycle  E= -526.281567237283  delta_E= -3.3e-12  |g|= 1.27e-06  |ddm|= 2.64e-06
    CPU time for scf_cycle      0.29 sec, wall time      0.20 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 154517.66284668812
E1 = -728.2761006397059  E_coul = 201.99453340242317
init E= -526.281567237283
    CPU time for initialize scf      0.95 sec, wall time      0.18 sec
  HOMO = -0.564556426417266  LUMO = 1.29397762652223
  mo_energy =
[-1.18484840e+02 -1.21681889e+01 -9.51787678e+00 -9.51787678e+00
 -9.51787678e+00 -1.24318849e+00 -5.64556426e-01 -5.64556426e-01
 -5.64556426e-01  1.29397763e+00  1.29397763e+00  1.29397763e+00
  1.22322311e+01  1.22322311e+01  1.22322311e+01  6.82012528e+01
  6.82012528e+01  6.82012528e+01  1.04650830e+02  3.24357133e+02
  3.24357133e+02  3.24357133e+02  8.83622659e+02  9.78862552e+02
  9.78862552e+02  9.78862552e+02  2.20936413e+03  2.20936413e+03
  2.20936413e+03  4.42136523e+03  4.42136523e+03  4.42136523e+03
  5.31642180e+03  8.49527187e+03  8.49527187e+03  8.49527187e+03
  2.06486866e+04  7.11923665e+04]
E1 = -728.2760960879293  E_coul = 201.9945288506473
cycle= 1 E= -526.281567237282  delta_E= 6.82e-13  |g|= 2.66e-07  |ddm|= 4.73e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.2760960879293  E_coul = 201.9945288506473
  HOMO = -0.564556504983269  LUMO = 1.29397755157857
  mo_energy =
[-1.18484840e+02 -1.21681892e+01 -9.51787713e+00 -9.51787713e+00
 -9.51787713e+00 -1.24318859e+00 -5.64556505e-01 -5.64556505e-01
 -5.64556505e-01  1.29397755e+00  1.29397755e+00  1.29397755e+00
  1.22322308e+01  1.22322308e+01  1.22322308e+01  6.82012523e+01
  6.82012523e+01  6.82012523e+01  1.04650829e+02  3.24357132e+02
  3.24357132e+02  3.24357132e+02  8.83622658e+02  9.78862552e+02
  9.78862552e+02  9.78862552e+02  2.20936413e+03  2.20936413e+03
  2.20936413e+03  4.42136523e+03  4.42136523e+03  4.42136523e+03
  5.31642180e+03  8.49527186e+03  8.49527186e+03  8.49527186e+03
  2.06486866e+04  7.11923665e+04]
E1 = -728.2760969820397  E_coul = 201.99452974475707
Extra cycle  E= -526.281567237283  delta_E= -5.68e-13  |g|= 5.4e-08  |ddm|= 9.07e-08
    CPU time for scf_cycle      1.08 sec, wall time      0.32 sec
exp = [2.61854697e+04 7.58576743e+03 3.55367563e+03 6.10407188e+02
 1.44870635e+02 4.07877707e+01 4.60995515e+00 3.94893516e-01
 1.36284067e+03 6.53438080e+02 2.42882623e+02 2.63184075e+02
 7.16232479e+02 1.23638221e+01 4.10278447e+01 9.15465489e-01
 4.06665436e+00 2.55005882e-01]
grad_E = [ 5.08505020e-07  1.18604623e-06  5.86322049e-05 -1.36464162e-05
  2.92976653e-05 -3.94203768e-05 -1.85831001e-04 -1.15658468e-04
  3.40940548e-06  1.43139476e-05  1.35880536e-04  1.07030104e-04
  1.15209577e-05 -1.42362346e-04  1.39472185e-05  3.26939395e-04
  5.69949696e-04 -2.82252816e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:30:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.4701645        1
[INPUT] 0    0    [1    /1   ]  7585.76245864        1
[INPUT] 0    0    [1    /1   ]  3553.66577731        1
[INPUT] 0    0    [1    /1   ]  610.253402411        1
[INPUT] 0    0    [1    /1   ]  144.799371577        1
[INPUT] 0    0    [1    /1   ]  40.7745191654        1
[INPUT] 0    0    [1    /1   ]  4.61010157106        1
[INPUT] 0    0    [1    /1   ]  0.394896045333       1
[INPUT] 1    0    [1    /1   ]  1362.84097931        1
[INPUT] 1    0    [1    /1   ]  653.438809143        1
[INPUT] 1    0    [1    /1   ]  242.887665862        1
[INPUT] 1    0    [1    /1   ]  263.188615915        1
[INPUT] 1    0    [1    /1   ]  716.007275598        1
[INPUT] 1    0    [1    /1   ]  12.3616432252        1
[INPUT] 1    0    [1    /1   ]  41.0222634453        1
[INPUT] 1    0    [1    /1   ]  0.915219270642       1
[INPUT] 1    0    [1    /1   ]  4.06519899173        1
[INPUT] 1    0    [1    /1   ]  0.25497314756        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.470164464572, 1.0]], [0, [7585.7624586435795, 1.0]], [0, [3553.665777306161, 1.0]], [0, [610.2534024114365, 1.0]], [0, [144.7993715765959, 1.0]], [0, [40.77451916535257, 1.0]], [0, [4.610101571060688, 1.0]], [0, [0.3948960453326544, 1.0]], [1, [1362.8409793087599, 1.0]], [1, [653.4388091434131, 1.0]], [1, [242.8876658616037, 1.0]], [1, [263.1886159150954, 1.0]], [1, [716.0072755978615, 1.0]], [1, [12.361643225220638, 1.0]], [1, [41.02226344533153, 1.0]], [1, [0.9152192706424384, 1.0]], [1, [4.06519899173028, 1.0]], [1, [0.25497314755963113, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.47016446]
bas 1, expnt(s) = [7585.76245864]
bas 2, expnt(s) = [3553.66577731]
bas 3, expnt(s) = [610.25340241]
bas 4, expnt(s) = [144.79937158]
bas 5, expnt(s) = [40.77451917]
bas 6, expnt(s) = [4.61010157]
bas 7, expnt(s) = [0.39489605]
bas 8, expnt(s) = [1362.84097931]
bas 9, expnt(s) = [653.43880914]
bas 10, expnt(s) = [242.88766586]
bas 11, expnt(s) = [263.18861592]
bas 12, expnt(s) = [716.0072756]
bas 13, expnt(s) = [12.36164323]
bas 14, expnt(s) = [41.02226345]
bas 15, expnt(s) = [0.91521927]
bas 16, expnt(s) = [4.06519899]
bas 17, expnt(s) = [0.25497315]
CPU time:       709.37
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61854702e+04 5.20068208e+03 7.58576246e+03 2.05359337e+03
 3.55366578e+03 1.16284669e+03 6.10253402e+02 3.10204206e+02
 1.44799372e+02 1.05460550e+02 4.07745192e+01 4.07668035e+01
 4.61010157e+00 7.94873274e+00 3.94896045e-01 1.25856924e+00
 1.36284098e+03 2.41568817e+04 6.53438809e+02 9.63808048e+03
 2.42887666e+02 2.79731400e+03 2.63188616e+02 3.09256095e+03
 7.16007276e+02 1.08051596e+04 1.23616432e+01 6.76206979e+01
 4.10222634e+01 3.02871854e+02 9.15219271e-01 2.61150485e+00
 4.06519899e+00 1.68397893e+01 2.54973148e-01 5.28569925e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.96804729338897
cond(S) = 155298.36312310834
E1 = -728.5040285905385  E_coul = 203.09142375484788
init E= -525.412604835691
    CPU time for initialize scf      0.24 sec, wall time      0.05 sec
  HOMO = -0.558346007559318  LUMO = 1.29807969844091
  mo_energy =
[-1.18258135e+02 -1.20985629e+01 -9.44394580e+00 -9.44394580e+00
 -9.44394580e+00 -1.23125136e+00 -5.58346008e-01 -5.58346008e-01
 -5.58346008e-01  1.29807970e+00  1.29807970e+00  1.29807970e+00
  1.22828368e+01  1.22828368e+01  1.22828368e+01  6.83086469e+01
  6.83086469e+01  6.83086469e+01  1.04728403e+02  3.24529009e+02
  3.24529009e+02  3.24529009e+02  8.83556211e+02  9.79065730e+02
  9.79065730e+02  9.79065730e+02  2.20954169e+03  2.20954169e+03
  2.20954169e+03  4.42138215e+03  4.42138215e+03  4.42138215e+03
  5.31616944e+03  8.49508321e+03  8.49508321e+03  8.49508321e+03
  2.06484642e+04  7.11922456e+04]
E1 = -728.084134078232  E_coul = 201.80285934533464
cycle= 1 E= -526.281274732897  delta_E= -0.869  |g|= 0.183  |ddm|= 0.528
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.485612
diis-c [-0.23581883  1.        ]
  HOMO = -0.566673673859525  LUMO = 1.29139573576009
  mo_energy =
[-1.18516027e+02 -1.21818856e+01 -9.53180228e+00 -9.53180228e+00
 -9.53180228e+00 -1.24603546e+00 -5.66673674e-01 -5.66673674e-01
 -5.66673674e-01  1.29139574e+00  1.29139574e+00  1.29139574e+00
  1.22167207e+01  1.22167207e+01  1.22167207e+01  6.81635015e+01
  6.81635015e+01  6.81635015e+01  1.04560652e+02  3.24296020e+02
  3.24296020e+02  3.24296020e+02  8.83210293e+02  9.78781344e+02
  9.78781344e+02  9.78781344e+02  2.20920859e+03  2.20920859e+03
  2.20920859e+03  4.42099198e+03  4.42099198e+03  4.42099198e+03
  5.31562371e+03  8.49458905e+03  8.49458905e+03  8.49458905e+03
  2.06477961e+04  7.11914878e+04]
E1 = -728.316080537049  E_coul = 202.0345204196625
cycle= 2 E= -526.281560117386  delta_E= -0.000285  |g|= 0.02  |ddm|= 0.0174
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0343732
diis-c [-8.26937679e-04  3.73919357e-02  9.62608064e-01]
  HOMO = -0.564048441500007  LUMO = 1.29406280110796
  mo_energy =
[-1.18480573e+02 -1.21659367e+01 -9.51555771e+00 -9.51555771e+00
 -9.51555771e+00 -1.24252804e+00 -5.64048442e-01 -5.64048442e-01
 -5.64048442e-01  1.29406280e+00  1.29406280e+00  1.29406280e+00
  1.22288516e+01  1.22288516e+01  1.22288516e+01  6.81874720e+01
  6.81874720e+01  6.81874720e+01  1.04591175e+02  3.24329801e+02
  3.24329801e+02  3.24329801e+02  8.83248623e+02  9.78818268e+02
  9.78818268e+02  9.78818268e+02  2.20924698e+03  2.20924698e+03
  2.20924698e+03  4.42103135e+03  4.42103135e+03  4.42103135e+03
  5.31566396e+03  8.49462907e+03  8.49462907e+03  8.49462907e+03
  2.06478365e+04  7.11915283e+04]
E1 = -728.2693998863473  E_coul = 201.9878316589131
cycle= 3 E= -526.281568227434  delta_E= -8.11e-06  |g|= 0.00246  |ddm|= 0.00416
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00462331
diis-c [-1.91245627e-07 -8.90190107e-04  1.12242958e-01  8.88647232e-01]
  HOMO = -0.564570306668344  LUMO = 1.29356050835727
  mo_energy =
[-1.18484999e+02 -1.21682898e+01 -9.51798479e+00 -9.51798479e+00
 -9.51798479e+00 -1.24321155e+00 -5.64570307e-01 -5.64570307e-01
 -5.64570307e-01  1.29356051e+00  1.29356051e+00  1.29356051e+00
  1.22269437e+01  1.22269437e+01  1.22269437e+01  6.81842443e+01
  6.81842443e+01  6.81842443e+01  1.04587362e+02  3.24325561e+02
  3.24325561e+02  3.24325561e+02  8.83243850e+02  9.78813689e+02
  9.78813689e+02  9.78813689e+02  2.20924222e+03  2.20924222e+03
  2.20924222e+03  4.42102644e+03  4.42102644e+03  4.42102644e+03
  5.31565881e+03  8.49462399e+03  8.49462399e+03  8.49462399e+03
  2.06478313e+04  7.11915230e+04]
E1 = -728.2759438406372  E_coul = 201.99437542534224
cycle= 4 E= -526.281568415295  delta_E= -1.88e-07  |g|= 4.16e-05  |ddm|= 0.000643
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.65663e-05
diis-c [-9.85954919e-10 -7.18004337e-06 -2.23174361e-04  8.84798549e-03
  9.91382369e-01]
  HOMO = -0.564545132137602  LUMO = 1.293583746035
  mo_energy =
[-1.18484903e+02 -1.21682067e+01 -9.51790161e+00 -9.51790161e+00
 -9.51790161e+00 -1.24317884e+00 -5.64545132e-01 -5.64545132e-01
 -5.64545132e-01  1.29358375e+00  1.29358375e+00  1.29358375e+00
  1.22270146e+01  1.22270146e+01  1.22270146e+01  6.81843332e+01
  6.81843332e+01  6.81843332e+01  1.04587458e+02  3.24325657e+02
  3.24325657e+02  3.24325657e+02  8.83243942e+02  9.78813784e+02
  9.78813784e+02  9.78813784e+02  2.20924231e+03  2.20924231e+03
  2.20924231e+03  4.42102653e+03  4.42102653e+03  4.42102653e+03
  5.31565890e+03  8.49462408e+03  8.49462408e+03  8.49462408e+03
  2.06478314e+04  7.11915231e+04]
E1 = -728.2757522683519  E_coul = 201.9941838529256
cycle= 5 E= -526.281568415426  delta_E= -1.31e-10  |g|= 5.25e-06  |ddm|= 2.27e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2757522683519  E_coul = 201.9941838529256
  HOMO = -0.564547784868503  LUMO = 1.29358128038313
  mo_energy =
[-1.18484917e+02 -1.21682162e+01 -9.51791128e+00 -9.51791128e+00
 -9.51791128e+00 -1.24318230e+00 -5.64547785e-01 -5.64547785e-01
 -5.64547785e-01  1.29358128e+00  1.29358128e+00  1.29358128e+00
  1.22270066e+01  1.22270066e+01  1.22270066e+01  6.81843221e+01
  6.81843221e+01  6.81843221e+01  1.04587446e+02  3.24325644e+02
  3.24325644e+02  3.24325644e+02  8.83243929e+02  9.78813770e+02
  9.78813770e+02  9.78813770e+02  2.20924230e+03  2.20924230e+03
  2.20924230e+03  4.42102652e+03  4.42102652e+03  4.42102652e+03
  5.31565888e+03  8.49462407e+03  8.49462407e+03  8.49462407e+03
  2.06478313e+04  7.11915231e+04]
E1 = -728.2757757866142  E_coul = 201.9942073711858
Extra cycle  E= -526.281568415428  delta_E= -2.16e-12  |g|= 1.27e-06  |ddm|= 2.64e-06
    CPU time for scf_cycle      0.40 sec, wall time      0.21 sec
exp = [2.61854702e+04 7.58576246e+03 3.55366578e+03 6.10253402e+02
 1.44799372e+02 4.07745192e+01 4.61010157e+00 3.94896045e-01
 1.36284098e+03 6.53438809e+02 2.42887666e+02 2.63188616e+02
 7.16007276e+02 1.23616432e+01 4.10222634e+01 9.15219271e-01
 4.06519899e+00 2.54973148e-01]
E = -526.2815684154284
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:30:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.4701645        1
[INPUT] 0    0    [1    /1   ]  7585.76245864        1
[INPUT] 0    0    [1    /1   ]  3553.66577731        1
[INPUT] 0    0    [1    /1   ]  610.253402411        1
[INPUT] 0    0    [1    /1   ]  144.799371577        1
[INPUT] 0    0    [1    /1   ]  40.7745191654        1
[INPUT] 0    0    [1    /1   ]  4.61010157106        1
[INPUT] 0    0    [1    /1   ]  0.394896045333       1
[INPUT] 1    0    [1    /1   ]  1362.84097931        1
[INPUT] 1    0    [1    /1   ]  653.438809143        1
[INPUT] 1    0    [1    /1   ]  242.887665862        1
[INPUT] 1    0    [1    /1   ]  263.188615915        1
[INPUT] 1    0    [1    /1   ]  716.007275598        1
[INPUT] 1    0    [1    /1   ]  12.3616432252        1
[INPUT] 1    0    [1    /1   ]  41.0222634453        1
[INPUT] 1    0    [1    /1   ]  0.915219270642       1
[INPUT] 1    0    [1    /1   ]  4.06519899173        1
[INPUT] 1    0    [1    /1   ]  0.25497314756        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.470164464572, 1.0]], [0, [7585.7624586435795, 1.0]], [0, [3553.665777306161, 1.0]], [0, [610.2534024114365, 1.0]], [0, [144.7993715765959, 1.0]], [0, [40.77451916535257, 1.0]], [0, [4.610101571060688, 1.0]], [0, [0.3948960453326544, 1.0]], [1, [1362.8409793087599, 1.0]], [1, [653.4388091434131, 1.0]], [1, [242.8876658616037, 1.0]], [1, [263.1886159150954, 1.0]], [1, [716.0072755978615, 1.0]], [1, [12.361643225220638, 1.0]], [1, [41.02226344533153, 1.0]], [1, [0.9152192706424384, 1.0]], [1, [4.06519899173028, 1.0]], [1, [0.25497314755963113, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.47016446]
bas 1, expnt(s) = [7585.76245864]
bas 2, expnt(s) = [3553.66577731]
bas 3, expnt(s) = [610.25340241]
bas 4, expnt(s) = [144.79937158]
bas 5, expnt(s) = [40.77451917]
bas 6, expnt(s) = [4.61010157]
bas 7, expnt(s) = [0.39489605]
bas 8, expnt(s) = [1362.84097931]
bas 9, expnt(s) = [653.43880914]
bas 10, expnt(s) = [242.88766586]
bas 11, expnt(s) = [263.18861592]
bas 12, expnt(s) = [716.0072756]
bas 13, expnt(s) = [12.36164323]
bas 14, expnt(s) = [41.02226345]
bas 15, expnt(s) = [0.91521927]
bas 16, expnt(s) = [4.06519899]
bas 17, expnt(s) = [0.25497315]
CPU time:       710.13
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61854702e+04 5.20068208e+03 7.58576246e+03 2.05359337e+03
 3.55366578e+03 1.16284669e+03 6.10253402e+02 3.10204206e+02
 1.44799372e+02 1.05460550e+02 4.07745192e+01 4.07668035e+01
 4.61010157e+00 7.94873274e+00 3.94896045e-01 1.25856924e+00
 1.36284098e+03 2.41568817e+04 6.53438809e+02 9.63808048e+03
 2.42887666e+02 2.79731400e+03 2.63188616e+02 3.09256095e+03
 7.16007276e+02 1.08051596e+04 1.23616432e+01 6.76206979e+01
 4.10222634e+01 3.02871854e+02 9.15219271e-01 2.61150485e+00
 4.06519899e+00 1.68397893e+01 2.54973148e-01 5.28569925e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.96804729338897
cond(S) = 155298.36312310834
E1 = -728.5040285905385  E_coul = 203.09142375484788
init E= -525.412604835691
    CPU time for initialize scf      0.13 sec, wall time      0.04 sec
  HOMO = -0.558346007559318  LUMO = 1.29807969844091
  mo_energy =
[-1.18258135e+02 -1.20985629e+01 -9.44394580e+00 -9.44394580e+00
 -9.44394580e+00 -1.23125136e+00 -5.58346008e-01 -5.58346008e-01
 -5.58346008e-01  1.29807970e+00  1.29807970e+00  1.29807970e+00
  1.22828368e+01  1.22828368e+01  1.22828368e+01  6.83086469e+01
  6.83086469e+01  6.83086469e+01  1.04728403e+02  3.24529009e+02
  3.24529009e+02  3.24529009e+02  8.83556211e+02  9.79065730e+02
  9.79065730e+02  9.79065730e+02  2.20954169e+03  2.20954169e+03
  2.20954169e+03  4.42138215e+03  4.42138215e+03  4.42138215e+03
  5.31616944e+03  8.49508321e+03  8.49508321e+03  8.49508321e+03
  2.06484642e+04  7.11922456e+04]
E1 = -728.084134078232  E_coul = 201.80285934533464
cycle= 1 E= -526.281274732897  delta_E= -0.869  |g|= 0.183  |ddm|= 0.528
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.485612
diis-c [-0.23581883  1.        ]
  HOMO = -0.566673673859525  LUMO = 1.29139573576009
  mo_energy =
[-1.18516027e+02 -1.21818856e+01 -9.53180228e+00 -9.53180228e+00
 -9.53180228e+00 -1.24603546e+00 -5.66673674e-01 -5.66673674e-01
 -5.66673674e-01  1.29139574e+00  1.29139574e+00  1.29139574e+00
  1.22167207e+01  1.22167207e+01  1.22167207e+01  6.81635015e+01
  6.81635015e+01  6.81635015e+01  1.04560652e+02  3.24296020e+02
  3.24296020e+02  3.24296020e+02  8.83210293e+02  9.78781344e+02
  9.78781344e+02  9.78781344e+02  2.20920859e+03  2.20920859e+03
  2.20920859e+03  4.42099198e+03  4.42099198e+03  4.42099198e+03
  5.31562371e+03  8.49458905e+03  8.49458905e+03  8.49458905e+03
  2.06477961e+04  7.11914878e+04]
E1 = -728.316080537049  E_coul = 202.0345204196625
cycle= 2 E= -526.281560117386  delta_E= -0.000285  |g|= 0.02  |ddm|= 0.0174
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0343732
diis-c [-8.26937679e-04  3.73919357e-02  9.62608064e-01]
  HOMO = -0.564048441500007  LUMO = 1.29406280110796
  mo_energy =
[-1.18480573e+02 -1.21659367e+01 -9.51555771e+00 -9.51555771e+00
 -9.51555771e+00 -1.24252804e+00 -5.64048442e-01 -5.64048442e-01
 -5.64048442e-01  1.29406280e+00  1.29406280e+00  1.29406280e+00
  1.22288516e+01  1.22288516e+01  1.22288516e+01  6.81874720e+01
  6.81874720e+01  6.81874720e+01  1.04591175e+02  3.24329801e+02
  3.24329801e+02  3.24329801e+02  8.83248623e+02  9.78818268e+02
  9.78818268e+02  9.78818268e+02  2.20924698e+03  2.20924698e+03
  2.20924698e+03  4.42103135e+03  4.42103135e+03  4.42103135e+03
  5.31566396e+03  8.49462907e+03  8.49462907e+03  8.49462907e+03
  2.06478365e+04  7.11915283e+04]
E1 = -728.2693998863473  E_coul = 201.9878316589131
cycle= 3 E= -526.281568227434  delta_E= -8.11e-06  |g|= 0.00246  |ddm|= 0.00416
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00462331
diis-c [-1.91245627e-07 -8.90190107e-04  1.12242958e-01  8.88647232e-01]
  HOMO = -0.564570306668344  LUMO = 1.29356050835727
  mo_energy =
[-1.18484999e+02 -1.21682898e+01 -9.51798479e+00 -9.51798479e+00
 -9.51798479e+00 -1.24321155e+00 -5.64570307e-01 -5.64570307e-01
 -5.64570307e-01  1.29356051e+00  1.29356051e+00  1.29356051e+00
  1.22269437e+01  1.22269437e+01  1.22269437e+01  6.81842443e+01
  6.81842443e+01  6.81842443e+01  1.04587362e+02  3.24325561e+02
  3.24325561e+02  3.24325561e+02  8.83243850e+02  9.78813689e+02
  9.78813689e+02  9.78813689e+02  2.20924222e+03  2.20924222e+03
  2.20924222e+03  4.42102644e+03  4.42102644e+03  4.42102644e+03
  5.31565881e+03  8.49462399e+03  8.49462399e+03  8.49462399e+03
  2.06478313e+04  7.11915230e+04]
E1 = -728.2759438406372  E_coul = 201.99437542534224
cycle= 4 E= -526.281568415295  delta_E= -1.88e-07  |g|= 4.16e-05  |ddm|= 0.000643
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.65663e-05
diis-c [-9.85954919e-10 -7.18004337e-06 -2.23174361e-04  8.84798549e-03
  9.91382369e-01]
  HOMO = -0.564545132137602  LUMO = 1.293583746035
  mo_energy =
[-1.18484903e+02 -1.21682067e+01 -9.51790161e+00 -9.51790161e+00
 -9.51790161e+00 -1.24317884e+00 -5.64545132e-01 -5.64545132e-01
 -5.64545132e-01  1.29358375e+00  1.29358375e+00  1.29358375e+00
  1.22270146e+01  1.22270146e+01  1.22270146e+01  6.81843332e+01
  6.81843332e+01  6.81843332e+01  1.04587458e+02  3.24325657e+02
  3.24325657e+02  3.24325657e+02  8.83243942e+02  9.78813784e+02
  9.78813784e+02  9.78813784e+02  2.20924231e+03  2.20924231e+03
  2.20924231e+03  4.42102653e+03  4.42102653e+03  4.42102653e+03
  5.31565890e+03  8.49462408e+03  8.49462408e+03  8.49462408e+03
  2.06478314e+04  7.11915231e+04]
E1 = -728.2757522683519  E_coul = 201.9941838529256
cycle= 5 E= -526.281568415426  delta_E= -1.31e-10  |g|= 5.25e-06  |ddm|= 2.27e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2757522683519  E_coul = 201.9941838529256
  HOMO = -0.564547784868503  LUMO = 1.29358128038313
  mo_energy =
[-1.18484917e+02 -1.21682162e+01 -9.51791128e+00 -9.51791128e+00
 -9.51791128e+00 -1.24318230e+00 -5.64547785e-01 -5.64547785e-01
 -5.64547785e-01  1.29358128e+00  1.29358128e+00  1.29358128e+00
  1.22270066e+01  1.22270066e+01  1.22270066e+01  6.81843221e+01
  6.81843221e+01  6.81843221e+01  1.04587446e+02  3.24325644e+02
  3.24325644e+02  3.24325644e+02  8.83243929e+02  9.78813770e+02
  9.78813770e+02  9.78813770e+02  2.20924230e+03  2.20924230e+03
  2.20924230e+03  4.42102652e+03  4.42102652e+03  4.42102652e+03
  5.31565888e+03  8.49462407e+03  8.49462407e+03  8.49462407e+03
  2.06478313e+04  7.11915231e+04]
E1 = -728.2757757866142  E_coul = 201.9942073711858
Extra cycle  E= -526.281568415428  delta_E= -2.16e-12  |g|= 1.27e-06  |ddm|= 2.64e-06
    CPU time for scf_cycle      0.29 sec, wall time      0.20 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 155298.36312310834
E1 = -728.2757757866142  E_coul = 201.9942073711858
init E= -526.281568415428
    CPU time for initialize scf      0.96 sec, wall time      0.19 sec
  HOMO = -0.564547353913191  LUMO = 1.29358168839515
  mo_energy =
[-1.18484914e+02 -1.21682144e+01 -9.51790950e+00 -9.51790950e+00
 -9.51790950e+00 -1.24318173e+00 -5.64547354e-01 -5.64547354e-01
 -5.64547354e-01  1.29358169e+00  1.29358169e+00  1.29358169e+00
  1.22270080e+01  1.22270080e+01  1.22270080e+01  6.81843243e+01
  6.81843243e+01  6.81843243e+01  1.04587449e+02  3.24325646e+02
  3.24325646e+02  3.24325646e+02  8.83243932e+02  9.78813773e+02
  9.78813773e+02  9.78813773e+02  2.20924230e+03  2.20924230e+03
  2.20924230e+03  4.42102652e+03  4.42102652e+03  4.42102652e+03
  5.31565889e+03  8.49462407e+03  8.49462407e+03  8.49462407e+03
  2.06478313e+04  7.11915231e+04]
E1 = -728.2757712339145  E_coul = 201.9942028184861
cycle= 1 E= -526.281568415428  delta_E=    0  |g|= 2.67e-07  |ddm|= 4.73e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.2757712339145  E_coul = 201.9942028184861
  HOMO = -0.564547432496566  LUMO = 1.29358161346123
  mo_energy =
[-1.18484914e+02 -1.21682148e+01 -9.51790984e+00 -9.51790984e+00
 -9.51790984e+00 -1.24318184e+00 -5.64547432e-01 -5.64547432e-01
 -5.64547432e-01  1.29358161e+00  1.29358161e+00  1.29358161e+00
  1.22270077e+01  1.22270077e+01  1.22270077e+01  6.81843239e+01
  6.81843239e+01  6.81843239e+01  1.04587448e+02  3.24325646e+02
  3.24325646e+02  3.24325646e+02  8.83243931e+02  9.78813773e+02
  9.78813773e+02  9.78813773e+02  2.20924230e+03  2.20924230e+03
  2.20924230e+03  4.42102652e+03  4.42102652e+03  4.42102652e+03
  5.31565889e+03  8.49462407e+03  8.49462407e+03  8.49462407e+03
  2.06478313e+04  7.11915231e+04]
E1 = -728.275772128175  E_coul = 201.99420371274732
Extra cycle  E= -526.281568415428  delta_E= 6.82e-13  |g|= 5.4e-08  |ddm|= 9.07e-08
    CPU time for scf_cycle      1.06 sec, wall time      0.29 sec
exp = [2.61854702e+04 7.58576246e+03 3.55366578e+03 6.10253402e+02
 1.44799372e+02 4.07745192e+01 4.61010157e+00 3.94896045e-01
 1.36284098e+03 6.53438809e+02 2.42887666e+02 2.63188616e+02
 7.16007276e+02 1.23616432e+01 4.10222634e+01 9.15219271e-01
 4.06519899e+00 2.54973148e-01]
grad_E = [ 5.08796344e-07  1.18703766e-06  5.86388144e-05 -1.01111518e-05
 -1.29280492e-06 -1.14522135e-05 -5.77323316e-05 -7.54568528e-05
  3.41436198e-06  1.43338769e-05  1.36084422e-04  1.07193477e-04
  1.15456945e-05  1.25878189e-05 -2.49362356e-06  9.07524077e-05
  6.47956681e-05 -1.75696840e-03]
 message: Iteration limit reached
 success: False
  status: 9
     fun: -526.2815684154284
       x: [ 2.619e+04  7.586e+03 ...  4.065e+00  2.550e-01]
     nit: 100
     jac: [ 5.088e-07  1.187e-06 ...  6.480e-05 -1.757e-03]
    nfev: 116
    njev: 100
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 8
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:30:05 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62935863.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26185.4701645        1
[INPUT] 0    0    [1    /1   ]  7585.76245864        1
[INPUT] 0    0    [1    /1   ]  3553.66577731        1
[INPUT] 0    0    [1    /1   ]  610.253402411        1
[INPUT] 0    0    [1    /1   ]  144.799371577        1
[INPUT] 0    0    [1    /1   ]  40.7745191654        1
[INPUT] 0    0    [1    /1   ]  4.61010157106        1
[INPUT] 0    0    [1    /1   ]  0.394896045333       1
[INPUT] 1    0    [1    /1   ]  1362.84097931        1
[INPUT] 1    0    [1    /1   ]  653.438809143        1
[INPUT] 1    0    [1    /1   ]  242.887665862        1
[INPUT] 1    0    [1    /1   ]  263.188615915        1
[INPUT] 1    0    [1    /1   ]  716.007275598        1
[INPUT] 1    0    [1    /1   ]  12.3616432252        1
[INPUT] 1    0    [1    /1   ]  41.0222634453        1
[INPUT] 1    0    [1    /1   ]  0.915219270642       1
[INPUT] 1    0    [1    /1   ]  4.06519899173        1
[INPUT] 1    0    [1    /1   ]  0.25497314756        1

nuclear repulsion = 0
number of shells = 18
number of NR pGTOs = 38
number of NR cGTOs = 38
basis = {'Ar': [[0, [26185.470164464572, 1.0]], [0, [7585.7624586435795, 1.0]], [0, [3553.665777306161, 1.0]], [0, [610.2534024114365, 1.0]], [0, [144.7993715765959, 1.0]], [0, [40.77451916535257, 1.0]], [0, [4.610101571060688, 1.0]], [0, [0.3948960453326544, 1.0]], [1, [1362.8409793087599, 1.0]], [1, [653.4388091434131, 1.0]], [1, [242.8876658616037, 1.0]], [1, [263.1886159150954, 1.0]], [1, [716.0072755978615, 1.0]], [1, [12.361643225220638, 1.0]], [1, [41.02226344533153, 1.0]], [1, [0.9152192706424384, 1.0]], [1, [4.06519899173028, 1.0]], [1, [0.25497314755963113, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26185.47016446]
bas 1, expnt(s) = [7585.76245864]
bas 2, expnt(s) = [3553.66577731]
bas 3, expnt(s) = [610.25340241]
bas 4, expnt(s) = [144.79937158]
bas 5, expnt(s) = [40.77451917]
bas 6, expnt(s) = [4.61010157]
bas 7, expnt(s) = [0.39489605]
bas 8, expnt(s) = [1362.84097931]
bas 9, expnt(s) = [653.43880914]
bas 10, expnt(s) = [242.88766586]
bas 11, expnt(s) = [263.18861592]
bas 12, expnt(s) = [716.0072756]
bas 13, expnt(s) = [12.36164323]
bas 14, expnt(s) = [41.02226345]
bas 15, expnt(s) = [0.91521927]
bas 16, expnt(s) = [4.06519899]
bas 17, expnt(s) = [0.25497315]
CPU time:       715.76
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61854702e+04 5.20068208e+03 7.58576246e+03 2.05359337e+03
 3.55366578e+03 1.16284669e+03 6.10253402e+02 3.10204206e+02
 1.44799372e+02 1.05460550e+02 4.07745192e+01 4.07668035e+01
 4.61010157e+00 7.94873274e+00 3.94896045e-01 1.25856924e+00
 1.36284098e+03 2.41568817e+04 6.53438809e+02 9.63808048e+03
 2.42887666e+02 2.79731400e+03 2.63188616e+02 3.09256095e+03
 7.16007276e+02 1.08051596e+04 1.23616432e+01 6.76206979e+01
 4.10222634e+01 3.02871854e+02 9.15219271e-01 2.61150485e+00
 4.06519899e+00 1.68397893e+01 2.54973148e-01 5.28569925e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.96804729338897
cond(S) = 155298.36312310834
E1 = -728.5040285905385  E_coul = 203.09142375484788
init E= -525.412604835691
    CPU time for initialize scf      0.13 sec, wall time      0.04 sec
  HOMO = -0.558346007559318  LUMO = 1.29807969844091
  mo_energy =
[-1.18258135e+02 -1.20985629e+01 -9.44394580e+00 -9.44394580e+00
 -9.44394580e+00 -1.23125136e+00 -5.58346008e-01 -5.58346008e-01
 -5.58346008e-01  1.29807970e+00  1.29807970e+00  1.29807970e+00
  1.22828368e+01  1.22828368e+01  1.22828368e+01  6.83086469e+01
  6.83086469e+01  6.83086469e+01  1.04728403e+02  3.24529009e+02
  3.24529009e+02  3.24529009e+02  8.83556211e+02  9.79065730e+02
  9.79065730e+02  9.79065730e+02  2.20954169e+03  2.20954169e+03
  2.20954169e+03  4.42138215e+03  4.42138215e+03  4.42138215e+03
  5.31616944e+03  8.49508321e+03  8.49508321e+03  8.49508321e+03
  2.06484642e+04  7.11922456e+04]
E1 = -728.084134078232  E_coul = 201.80285934533464
cycle= 1 E= -526.281274732897  delta_E= -0.869  |g|= 0.183  |ddm|= 0.528
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.485612
diis-c [-0.23581883  1.        ]
  HOMO = -0.566673673859525  LUMO = 1.29139573576009
  mo_energy =
[-1.18516027e+02 -1.21818856e+01 -9.53180228e+00 -9.53180228e+00
 -9.53180228e+00 -1.24603546e+00 -5.66673674e-01 -5.66673674e-01
 -5.66673674e-01  1.29139574e+00  1.29139574e+00  1.29139574e+00
  1.22167207e+01  1.22167207e+01  1.22167207e+01  6.81635015e+01
  6.81635015e+01  6.81635015e+01  1.04560652e+02  3.24296020e+02
  3.24296020e+02  3.24296020e+02  8.83210293e+02  9.78781344e+02
  9.78781344e+02  9.78781344e+02  2.20920859e+03  2.20920859e+03
  2.20920859e+03  4.42099198e+03  4.42099198e+03  4.42099198e+03
  5.31562371e+03  8.49458905e+03  8.49458905e+03  8.49458905e+03
  2.06477961e+04  7.11914878e+04]
E1 = -728.316080537049  E_coul = 202.0345204196625
cycle= 2 E= -526.281560117386  delta_E= -0.000285  |g|= 0.02  |ddm|= 0.0174
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0343732
diis-c [-8.26937679e-04  3.73919357e-02  9.62608064e-01]
  HOMO = -0.564048441500007  LUMO = 1.29406280110796
  mo_energy =
[-1.18480573e+02 -1.21659367e+01 -9.51555771e+00 -9.51555771e+00
 -9.51555771e+00 -1.24252804e+00 -5.64048442e-01 -5.64048442e-01
 -5.64048442e-01  1.29406280e+00  1.29406280e+00  1.29406280e+00
  1.22288516e+01  1.22288516e+01  1.22288516e+01  6.81874720e+01
  6.81874720e+01  6.81874720e+01  1.04591175e+02  3.24329801e+02
  3.24329801e+02  3.24329801e+02  8.83248623e+02  9.78818268e+02
  9.78818268e+02  9.78818268e+02  2.20924698e+03  2.20924698e+03
  2.20924698e+03  4.42103135e+03  4.42103135e+03  4.42103135e+03
  5.31566396e+03  8.49462907e+03  8.49462907e+03  8.49462907e+03
  2.06478365e+04  7.11915283e+04]
E1 = -728.2693998863473  E_coul = 201.9878316589131
cycle= 3 E= -526.281568227434  delta_E= -8.11e-06  |g|= 0.00246  |ddm|= 0.00416
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00462331
diis-c [-1.91245627e-07 -8.90190107e-04  1.12242958e-01  8.88647232e-01]
  HOMO = -0.564570306668344  LUMO = 1.29356050835727
  mo_energy =
[-1.18484999e+02 -1.21682898e+01 -9.51798479e+00 -9.51798479e+00
 -9.51798479e+00 -1.24321155e+00 -5.64570307e-01 -5.64570307e-01
 -5.64570307e-01  1.29356051e+00  1.29356051e+00  1.29356051e+00
  1.22269437e+01  1.22269437e+01  1.22269437e+01  6.81842443e+01
  6.81842443e+01  6.81842443e+01  1.04587362e+02  3.24325561e+02
  3.24325561e+02  3.24325561e+02  8.83243850e+02  9.78813689e+02
  9.78813689e+02  9.78813689e+02  2.20924222e+03  2.20924222e+03
  2.20924222e+03  4.42102644e+03  4.42102644e+03  4.42102644e+03
  5.31565881e+03  8.49462399e+03  8.49462399e+03  8.49462399e+03
  2.06478313e+04  7.11915230e+04]
E1 = -728.2759438406372  E_coul = 201.99437542534224
cycle= 4 E= -526.281568415295  delta_E= -1.88e-07  |g|= 4.16e-05  |ddm|= 0.000643
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=5.65663e-05
diis-c [-9.85954919e-10 -7.18004337e-06 -2.23174361e-04  8.84798549e-03
  9.91382369e-01]
  HOMO = -0.564545132137602  LUMO = 1.293583746035
  mo_energy =
[-1.18484903e+02 -1.21682067e+01 -9.51790161e+00 -9.51790161e+00
 -9.51790161e+00 -1.24317884e+00 -5.64545132e-01 -5.64545132e-01
 -5.64545132e-01  1.29358375e+00  1.29358375e+00  1.29358375e+00
  1.22270146e+01  1.22270146e+01  1.22270146e+01  6.81843332e+01
  6.81843332e+01  6.81843332e+01  1.04587458e+02  3.24325657e+02
  3.24325657e+02  3.24325657e+02  8.83243942e+02  9.78813784e+02
  9.78813784e+02  9.78813784e+02  2.20924231e+03  2.20924231e+03
  2.20924231e+03  4.42102653e+03  4.42102653e+03  4.42102653e+03
  5.31565890e+03  8.49462408e+03  8.49462408e+03  8.49462408e+03
  2.06478314e+04  7.11915231e+04]
E1 = -728.2757522683519  E_coul = 201.9941838529256
cycle= 5 E= -526.281568415426  delta_E= -1.31e-10  |g|= 5.25e-06  |ddm|= 2.27e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -728.2757522683519  E_coul = 201.9941838529256
  HOMO = -0.564547784868503  LUMO = 1.29358128038313
  mo_energy =
[-1.18484917e+02 -1.21682162e+01 -9.51791128e+00 -9.51791128e+00
 -9.51791128e+00 -1.24318230e+00 -5.64547785e-01 -5.64547785e-01
 -5.64547785e-01  1.29358128e+00  1.29358128e+00  1.29358128e+00
  1.22270066e+01  1.22270066e+01  1.22270066e+01  6.81843221e+01
  6.81843221e+01  6.81843221e+01  1.04587446e+02  3.24325644e+02
  3.24325644e+02  3.24325644e+02  8.83243929e+02  9.78813770e+02
  9.78813770e+02  9.78813770e+02  2.20924230e+03  2.20924230e+03
  2.20924230e+03  4.42102652e+03  4.42102652e+03  4.42102652e+03
  5.31565888e+03  8.49462407e+03  8.49462407e+03  8.49462407e+03
  2.06478313e+04  7.11915231e+04]
E1 = -728.2757757866142  E_coul = 201.9942073711858
Extra cycle  E= -526.281568415428  delta_E= -2.16e-12  |g|= 1.27e-06  |ddm|= 2.64e-06
    CPU time for scf_cycle      0.28 sec, wall time      0.19 sec
exp = [2.61854702e+04 7.58576246e+03 3.55366578e+03 6.10253402e+02
 1.44799372e+02 4.07745192e+01 4.61010157e+00 3.94896045e-01
 1.36284098e+03 6.53438809e+02 2.42887666e+02 2.63188616e+02
 7.16007276e+02 1.23616432e+01 4.10222634e+01 9.15219271e-01
 4.06519899e+00 2.54973148e-01]
E = -526.2815684154284
E = -526.2815684154284
exp = [2.6185470164464572e+04,7.5857624586435795e+03,3.5536657773061611e+03,6.1025340241143647e+02,1.4479937157659589e+02,4.0774519165352572e+01,4.6101015710606879e+00,3.9489604533265438e-01,1.3628409793087599e+03,6.5343880914341310e+02,2.4288766586160369e+02,2.6318861591509540e+02,7.1600727559786151e+02,1.2361643225220638e+01,4.1022263445331532e+01,9.1521927064243835e-01,4.0651989917302798e+00,2.5497314755963113e-01]

real	8m7.814s
user	10m36.776s
sys	1m21.634s
