created virtual environment CPython3.10.2.final.0-64 in 1240ms
  creator CPython3Posix(dest=/localscratch/nike.35634263.0/ENV, clear=True, no_vcs_ignore=False, global=False)
  seeder FromAppData(download=False, pip=bundle, setuptools=bundle, wheel=bundle, via=copy, app_data_dir=/home/nike/.local/share/virtualenv)
    added seed packages: pip==22.3.1, setuptools==67.3.3, wheel==0.38.4+computecanada
  activators BashActivator,CShellActivator,FishActivator,NushellActivator,PowerShellActivator,PythonActivator
Looking in links: /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx512, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic
Requirement already satisfied: pip in /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages (22.3.1)
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pip-23.0+computecanada-py3-none-any.whl
Installing collected packages: pip
  Attempting uninstall: pip
    Found existing installation: pip 22.3.1
    Uninstalling pip-22.3.1:
      Successfully uninstalled pip-22.3.1
Successfully installed pip-23.0+computecanada
Looking in links: /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx512, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic
Processing /home/nike/pyscf_ad/dist/pyscf-2.1.1+ad-cp310-cp310-linux_x86_64.whl
Processing /home/nike/properties_ad/dist/pyscf_properties-0.1.0+ad-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/absl_py-1.4.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/contourpy-1.0.7+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/cycler-0.11.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/fonttools-4.39.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/h5py-3.8.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/jax-0.4.2+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/jaxlib-0.4.2+cuda11.cudnn82.computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/jaxopt-0.6+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/kiwisolver-1.4.4+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/matplotlib-3.7.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/numpy-1.24.2+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/opt_einsum-3.3.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/packaging-23.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/Pillow-9.4.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pyparsing-3.0.9+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pyscfad-0.1.2+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/python_dateutil-2.8.2+computecanada-py2.py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/scipy-1.10.1+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/six-1.16.0+computecanada-py2.py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/typing_extensions-4.5.0+computecanada-py3-none-any.whl
Installing collected packages: typing_extensions, six, pyparsing, Pillow, packaging, numpy, kiwisolver, fonttools, cycler, absl_py, scipy, python-dateutil, opt-einsum, h5py, contourpy, pyscf, matplotlib, jaxlib, pyscf-properties, jax, jaxopt, pyscfad
Successfully installed Pillow-9.4.0+computecanada absl_py-1.4.0+computecanada contourpy-1.0.7+computecanada cycler-0.11.0+computecanada fonttools-4.39.0+computecanada h5py-3.8.0+computecanada jax-0.4.2+computecanada jaxlib-0.4.2+cuda11.cudnn82.computecanada jaxopt-0.6+computecanada kiwisolver-1.4.4+computecanada matplotlib-3.7.0+computecanada numpy-1.24.2+computecanada opt-einsum-3.3.0+computecanada packaging-23.0+computecanada pyparsing-3.0.9+computecanada pyscf-2.1.1+ad pyscf-properties-0.1.0+ad pyscfad-0.1.2+computecanada python-dateutil-2.8.2+computecanada scipy-1.10.1+computecanada six-1.16.0+computecanada typing_extensions-4.5.0+computecanada
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:06:04 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.0264535373938      1
[INPUT] 0    0    [1    /1   ]  0.264535373938       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.672136183893       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200236        1
[INPUT] 0    0    [1    /1   ]  36754.7149415        1
[INPUT] 0    0    [1    /1   ]  7303.15506922        1
[INPUT] 0    0    [1    /1   ]  18375.7992872        1
[INPUT] 0    0    [1    /1   ]  1449.0839289         1
[INPUT] 0    0    [1    /1   ]  376.379721694        1
[INPUT] 0    0    [1    /1   ]  114.557167338        1
[INPUT] 0    0    [1    /1   ]  38.2887338495        1
[INPUT] 0    0    [1    /1   ]  8.42599766215        1
[INPUT] 0    0    [1    /1   ]  3.38239117922        1
[INPUT] 1    0    [1    /1   ]  8.60353103241        1
[INPUT] 1    0    [1    /1   ]  0.49256484046        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.026453537393791568, 1.0]], [0, [0.26453537393791565, 1.0]], [0, [117616.81386811525, 1.0]], [0, [0.6721361838929967, 1.0]], [0, [1176168.142617244, 1.0]], [0, [588084.069982512, 1.0]], [0, [294042.0310737377, 1.0]], [0, [147020.99191980762, 1.0]], [0, [73510.42002361391, 1.0]], [0, [36754.71494148734, 1.0]], [0, [7303.155069221313, 1.0]], [0, [18375.79928724561, 1.0]], [0, [1449.083928904265, 1.0]], [0, [376.3797216937185, 1.0]], [0, [114.5571673377634, 1.0]], [0, [38.288733849518216, 1.0]], [0, [8.425997662149568, 1.0]], [0, [3.3823911792214205, 1.0]], [1, [8.603531032405357, 1.0]], [1, [0.4925648404604559, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.02645354]
bas 1, expnt(s) = [0.26453537]
bas 2, expnt(s) = [117616.81386812]
bas 3, expnt(s) = [0.67213618]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998251]
bas 6, expnt(s) = [294042.03107374]
bas 7, expnt(s) = [147020.99191981]
bas 8, expnt(s) = [73510.42002361]
bas 9, expnt(s) = [36754.71494149]
bas 10, expnt(s) = [7303.15506922]
bas 11, expnt(s) = [18375.79928725]
bas 12, expnt(s) = [1449.0839289]
bas 13, expnt(s) = [376.37972169]
bas 14, expnt(s) = [114.55716734]
bas 15, expnt(s) = [38.28873385]
bas 16, expnt(s) = [8.42599766]
bas 17, expnt(s) = [3.38239118]
bas 18, expnt(s) = [8.60353103]
bas 19, expnt(s) = [0.49256484]
CPU time:         3.05
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.64535374e-02 1.65721113e-01 2.64535374e-01 9.31918300e-01
 1.17616814e+05 1.60460109e+04 6.72136184e-01 1.87546076e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315507e+03 1.99594199e+03 1.83757993e+04 3.98749088e+03
 1.44908393e+03 5.93383108e+02 3.76379722e+02 2.15891074e+02
 1.14557167e+02 8.84670863e+01 3.82887338e+01 3.88882391e+01
 8.42599766e+00 1.24948494e+01 3.38239118e+00 6.30133979e+00
 8.60353103e+00 4.29863237e+01 4.92564840e-01 1.20382582e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.3360406649007
cond(S) = 907857.9324002027
E1 = -689.5652359685085  E_coul = 184.96305958973312
init E= -504.602176378775
    CPU time for initialize scf      1.87 sec, wall time      0.42 sec
  HOMO = -0.672398234624071  LUMO = -0.0682460903365949
  mo_energy =
[-1.21704755e+02 -1.33849599e+01 -7.62404512e+00 -7.62404512e+00
 -7.62404512e+00 -1.65761629e+00 -6.72398235e-01 -6.72398235e-01
 -6.72398235e-01 -6.82460903e-02  8.93050866e-01  1.27472877e+01
  1.14420319e+02  6.13677875e+02  2.75853518e+03  1.22372786e+04
  4.08572716e+04  1.04899995e+05  2.30082908e+05  4.55897523e+05
  8.44849565e+05  1.52802664e+06  2.85029381e+06  5.80818082e+06]
E1 = -707.7272718168746  E_coul = 199.77168592699803
cycle= 1 E= -507.955585889877  delta_E= -3.35  |g|= 0.449  |ddm|= 0.484
    CPU time for cycle= 1      0.65 sec, wall time      0.65 sec
diis-norm(errvec)=0.641018
diis-c [-0.41090447  1.        ]
  HOMO = -0.218026856122524  LUMO = 0.072146201393776
  mo_energy =
[-1.20194476e+02 -1.23037548e+01 -6.59472361e+00 -6.59472361e+00
 -6.59472361e+00 -1.16337203e+00 -2.18026856e-01 -2.18026856e-01
 -2.18026856e-01  7.21462014e-02  1.29412589e+00  1.36932493e+01
  1.15822366e+02  6.15174138e+02  2.75997071e+03  1.22386054e+04
  4.08585320e+04  1.04901219e+05  2.30084107e+05  4.55898705e+05
  8.44850734e+05  1.52802780e+06  2.85029496e+06  5.80818196e+06]
E1 = -706.7825867620932  E_coul = 198.80940083843092
cycle= 2 E= -507.973185923662  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.437
    CPU time for cycle= 2      0.22 sec, wall time      0.22 sec
diis-norm(errvec)=0.032886
diis-c [-0.00107961 -0.00214962  1.00214962]
  HOMO = -0.240204824251387  LUMO = 0.0721565055786173
  mo_energy =
[-1.20307950e+02 -1.23706289e+01 -6.66872238e+00 -6.66872238e+00
 -6.66872238e+00 -1.17768335e+00 -2.40204824e-01 -2.40204824e-01
 -2.40204824e-01  7.21565056e-02  1.28665822e+00  1.36411602e+01
  1.15727273e+02  6.15056581e+02  2.75983721e+03  1.22384617e+04
  4.08583846e+04  1.04901070e+05  2.30083958e+05  4.55898555e+05
  8.44850583e+05  1.52802765e+06  2.85029481e+06  5.80818181e+06]
E1 = -706.6744569529526  E_coul = 198.70100966315
cycle= 3 E= -507.973447289803  delta_E= -0.000261  |g|= 0.00433  |ddm|= 0.0571
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00437808
diis-c [-3.07706421e-06 -3.95690987e-04 -1.38141807e-01  1.13853750e+00]
  HOMO = -0.243461160223434  LUMO = 0.0721411766829932
  mo_energy =
[-1.20320128e+02 -1.23794950e+01 -6.67808614e+00 -6.67808614e+00
 -6.67808614e+00 -1.17965736e+00 -2.43461160e-01 -2.43461160e-01
 -2.43461160e-01  7.21411767e-02  1.28528647e+00  1.36339522e+01
  1.15716364e+02  6.15044236e+02  2.75982403e+03  1.22384481e+04
  4.08583707e+04  1.04901056e+05  2.30083944e+05  4.55898541e+05
  8.44850569e+05  1.52802763e+06  2.85029480e+06  5.80818179e+06]
E1 = -706.6586598469459  E_coul = 198.68520761757216
cycle= 4 E= -507.973452229374  delta_E= -4.94e-06  |g|= 0.000115  |ddm|= 0.00849
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00016236
diis-c [-2.41239288e-09 -9.73496373e-06  9.35071574e-03 -9.44823809e-02
  1.08514140e+00]
  HOMO = -0.243507438186167  LUMO = 0.0721398777449907
  mo_energy =
[-1.20320101e+02 -1.23795680e+01 -6.67813949e+00 -6.67813949e+00
 -6.67813949e+00 -1.17968375e+00 -2.43507438e-01 -2.43507438e-01
 -2.43507438e-01  7.21398777e-02  1.28525420e+00  1.36338783e+01
  1.15716355e+02  6.15044270e+02  2.75982409e+03  1.22384481e+04
  4.08583708e+04  1.04901056e+05  2.30083944e+05  4.55898541e+05
  8.44850569e+05  1.52802763e+06  2.85029480e+06  5.80818179e+06]
E1 = -706.6584335844174  E_coul = 198.68498135118276
cycle= 5 E= -507.973452233235  delta_E= -3.86e-09  |g|= 7.94e-06  |ddm|= 0.000143
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.18265e-06
diis-c [-1.75324901e-12  1.03204482e-06 -1.17751403e-03  1.20408713e-02
 -1.47926955e-01  1.13706257e+00]
  HOMO = -0.243503939460374  LUMO = 0.072139892843509
  mo_energy =
[-1.20320089e+02 -1.23795580e+01 -6.67812923e+00 -6.67812923e+00
 -6.67812923e+00 -1.17968190e+00 -2.43503939e-01 -2.43503939e-01
 -2.43503939e-01  7.21398928e-02  1.28525544e+00  1.36338865e+01
  1.15716367e+02  6.15044281e+02  2.75982410e+03  1.22384481e+04
  4.08583708e+04  1.04901056e+05  2.30083944e+05  4.55898541e+05
  8.44850569e+05  1.52802763e+06  2.85029480e+06  5.80818179e+06]
E1 = -706.658448848709  E_coul = 198.68499661545653
cycle= 6 E= -507.973452233252  delta_E= -1.78e-11  |g|= 6.52e-08  |ddm|= 1.8e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.658448848709  E_coul = 198.68499661545653
  HOMO = -0.243503920233778  LUMO = 0.0721398886735019
  mo_energy =
[-1.20320089e+02 -1.23795579e+01 -6.67812915e+00 -6.67812915e+00
 -6.67812915e+00 -1.17968187e+00 -2.43503920e-01 -2.43503920e-01
 -2.43503920e-01  7.21398887e-02  1.28525541e+00  1.36338865e+01
  1.15716367e+02  6.15044281e+02  2.75982410e+03  1.22384481e+04
  4.08583708e+04  1.04901056e+05  2.30083944e+05  4.55898541e+05
  8.44850569e+05  1.52802763e+06  2.85029480e+06  5.80818179e+06]
E1 = -706.6584489951687  E_coul = 198.68499676191652
Extra cycle  E= -507.973452233252  delta_E= 3.41e-13  |g|= 7.02e-09  |ddm|= 1.07e-07
    CPU time for scf_cycle      2.90 sec, wall time      1.45 sec
exp = [2.64535374e-02 2.64535374e-01 1.17616814e+05 6.72136184e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315507e+03 1.83757993e+04
 1.44908393e+03 3.76379722e+02 1.14557167e+02 3.82887338e+01
 8.42599766e+00 3.38239118e+00 8.60353103e+00 4.92564840e-01]
E = -507.97345223325215
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:06:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.0264535373938      1
[INPUT] 0    0    [1    /1   ]  0.264535373938       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.672136183893       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200236        1
[INPUT] 0    0    [1    /1   ]  36754.7149415        1
[INPUT] 0    0    [1    /1   ]  7303.15506922        1
[INPUT] 0    0    [1    /1   ]  18375.7992872        1
[INPUT] 0    0    [1    /1   ]  1449.0839289         1
[INPUT] 0    0    [1    /1   ]  376.379721694        1
[INPUT] 0    0    [1    /1   ]  114.557167338        1
[INPUT] 0    0    [1    /1   ]  38.2887338495        1
[INPUT] 0    0    [1    /1   ]  8.42599766215        1
[INPUT] 0    0    [1    /1   ]  3.38239117922        1
[INPUT] 1    0    [1    /1   ]  8.60353103241        1
[INPUT] 1    0    [1    /1   ]  0.49256484046        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.026453537393791568, 1.0]], [0, [0.26453537393791565, 1.0]], [0, [117616.81386811525, 1.0]], [0, [0.6721361838929967, 1.0]], [0, [1176168.142617244, 1.0]], [0, [588084.069982512, 1.0]], [0, [294042.0310737377, 1.0]], [0, [147020.99191980762, 1.0]], [0, [73510.42002361391, 1.0]], [0, [36754.71494148734, 1.0]], [0, [7303.155069221313, 1.0]], [0, [18375.79928724561, 1.0]], [0, [1449.083928904265, 1.0]], [0, [376.3797216937185, 1.0]], [0, [114.5571673377634, 1.0]], [0, [38.288733849518216, 1.0]], [0, [8.425997662149568, 1.0]], [0, [3.3823911792214205, 1.0]], [1, [8.603531032405357, 1.0]], [1, [0.4925648404604559, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.02645354]
bas 1, expnt(s) = [0.26453537]
bas 2, expnt(s) = [117616.81386812]
bas 3, expnt(s) = [0.67213618]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998251]
bas 6, expnt(s) = [294042.03107374]
bas 7, expnt(s) = [147020.99191981]
bas 8, expnt(s) = [73510.42002361]
bas 9, expnt(s) = [36754.71494149]
bas 10, expnt(s) = [7303.15506922]
bas 11, expnt(s) = [18375.79928725]
bas 12, expnt(s) = [1449.0839289]
bas 13, expnt(s) = [376.37972169]
bas 14, expnt(s) = [114.55716734]
bas 15, expnt(s) = [38.28873385]
bas 16, expnt(s) = [8.42599766]
bas 17, expnt(s) = [3.38239118]
bas 18, expnt(s) = [8.60353103]
bas 19, expnt(s) = [0.49256484]
CPU time:         6.81
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.64535374e-02 1.65721113e-01 2.64535374e-01 9.31918300e-01
 1.17616814e+05 1.60460109e+04 6.72136184e-01 1.87546076e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315507e+03 1.99594199e+03 1.83757993e+04 3.98749088e+03
 1.44908393e+03 5.93383108e+02 3.76379722e+02 2.15891074e+02
 1.14557167e+02 8.84670863e+01 3.82887338e+01 3.88882391e+01
 8.42599766e+00 1.24948494e+01 3.38239118e+00 6.30133979e+00
 8.60353103e+00 4.29863237e+01 4.92564840e-01 1.20382582e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.3360406649007
cond(S) = 907857.9324002027
E1 = -689.5652359685085  E_coul = 184.96305958973312
init E= -504.602176378775
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672398234624071  LUMO = -0.0682460903365949
  mo_energy =
[-1.21704755e+02 -1.33849599e+01 -7.62404512e+00 -7.62404512e+00
 -7.62404512e+00 -1.65761629e+00 -6.72398235e-01 -6.72398235e-01
 -6.72398235e-01 -6.82460903e-02  8.93050866e-01  1.27472877e+01
  1.14420319e+02  6.13677875e+02  2.75853518e+03  1.22372786e+04
  4.08572716e+04  1.04899995e+05  2.30082908e+05  4.55897523e+05
  8.44849565e+05  1.52802664e+06  2.85029381e+06  5.80818082e+06]
E1 = -707.7272718168746  E_coul = 199.77168592699803
cycle= 1 E= -507.955585889877  delta_E= -3.35  |g|= 0.449  |ddm|= 0.484
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.641018
diis-c [-0.41090447  1.        ]
  HOMO = -0.218026856122524  LUMO = 0.072146201393776
  mo_energy =
[-1.20194476e+02 -1.23037548e+01 -6.59472361e+00 -6.59472361e+00
 -6.59472361e+00 -1.16337203e+00 -2.18026856e-01 -2.18026856e-01
 -2.18026856e-01  7.21462014e-02  1.29412589e+00  1.36932493e+01
  1.15822366e+02  6.15174138e+02  2.75997071e+03  1.22386054e+04
  4.08585320e+04  1.04901219e+05  2.30084107e+05  4.55898705e+05
  8.44850734e+05  1.52802780e+06  2.85029496e+06  5.80818196e+06]
E1 = -706.7825867620932  E_coul = 198.80940083843092
cycle= 2 E= -507.973185923662  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.437
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.032886
diis-c [-0.00107961 -0.00214962  1.00214962]
  HOMO = -0.240204824251387  LUMO = 0.0721565055786173
  mo_energy =
[-1.20307950e+02 -1.23706289e+01 -6.66872238e+00 -6.66872238e+00
 -6.66872238e+00 -1.17768335e+00 -2.40204824e-01 -2.40204824e-01
 -2.40204824e-01  7.21565056e-02  1.28665822e+00  1.36411602e+01
  1.15727273e+02  6.15056581e+02  2.75983721e+03  1.22384617e+04
  4.08583846e+04  1.04901070e+05  2.30083958e+05  4.55898555e+05
  8.44850583e+05  1.52802765e+06  2.85029481e+06  5.80818181e+06]
E1 = -706.6744569529526  E_coul = 198.70100966315
cycle= 3 E= -507.973447289803  delta_E= -0.000261  |g|= 0.00433  |ddm|= 0.0571
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00437808
diis-c [-3.07706421e-06 -3.95690987e-04 -1.38141807e-01  1.13853750e+00]
  HOMO = -0.243461160223434  LUMO = 0.0721411766829932
  mo_energy =
[-1.20320128e+02 -1.23794950e+01 -6.67808614e+00 -6.67808614e+00
 -6.67808614e+00 -1.17965736e+00 -2.43461160e-01 -2.43461160e-01
 -2.43461160e-01  7.21411767e-02  1.28528647e+00  1.36339522e+01
  1.15716364e+02  6.15044236e+02  2.75982403e+03  1.22384481e+04
  4.08583707e+04  1.04901056e+05  2.30083944e+05  4.55898541e+05
  8.44850569e+05  1.52802763e+06  2.85029480e+06  5.80818179e+06]
E1 = -706.6586598469459  E_coul = 198.68520761757216
cycle= 4 E= -507.973452229374  delta_E= -4.94e-06  |g|= 0.000115  |ddm|= 0.00849
    CPU time for cycle= 4      0.05 sec, wall time      0.05 sec
diis-norm(errvec)=0.00016236
diis-c [-2.41239288e-09 -9.73496373e-06  9.35071574e-03 -9.44823809e-02
  1.08514140e+00]
  HOMO = -0.243507438186167  LUMO = 0.0721398777449907
  mo_energy =
[-1.20320101e+02 -1.23795680e+01 -6.67813949e+00 -6.67813949e+00
 -6.67813949e+00 -1.17968375e+00 -2.43507438e-01 -2.43507438e-01
 -2.43507438e-01  7.21398777e-02  1.28525420e+00  1.36338783e+01
  1.15716355e+02  6.15044270e+02  2.75982409e+03  1.22384481e+04
  4.08583708e+04  1.04901056e+05  2.30083944e+05  4.55898541e+05
  8.44850569e+05  1.52802763e+06  2.85029480e+06  5.80818179e+06]
E1 = -706.6584335844174  E_coul = 198.68498135118276
cycle= 5 E= -507.973452233235  delta_E= -3.86e-09  |g|= 7.94e-06  |ddm|= 0.000143
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.18265e-06
diis-c [-1.75324901e-12  1.03204482e-06 -1.17751403e-03  1.20408713e-02
 -1.47926955e-01  1.13706257e+00]
  HOMO = -0.243503939460374  LUMO = 0.072139892843509
  mo_energy =
[-1.20320089e+02 -1.23795580e+01 -6.67812923e+00 -6.67812923e+00
 -6.67812923e+00 -1.17968190e+00 -2.43503939e-01 -2.43503939e-01
 -2.43503939e-01  7.21398928e-02  1.28525544e+00  1.36338865e+01
  1.15716367e+02  6.15044281e+02  2.75982410e+03  1.22384481e+04
  4.08583708e+04  1.04901056e+05  2.30083944e+05  4.55898541e+05
  8.44850569e+05  1.52802763e+06  2.85029480e+06  5.80818179e+06]
E1 = -706.658448848709  E_coul = 198.68499661545653
cycle= 6 E= -507.973452233252  delta_E= -1.78e-11  |g|= 6.52e-08  |ddm|= 1.8e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.658448848709  E_coul = 198.68499661545653
  HOMO = -0.243503920233778  LUMO = 0.0721398886735019
  mo_energy =
[-1.20320089e+02 -1.23795579e+01 -6.67812915e+00 -6.67812915e+00
 -6.67812915e+00 -1.17968187e+00 -2.43503920e-01 -2.43503920e-01
 -2.43503920e-01  7.21398887e-02  1.28525541e+00  1.36338865e+01
  1.15716367e+02  6.15044281e+02  2.75982410e+03  1.22384481e+04
  4.08583708e+04  1.04901056e+05  2.30083944e+05  4.55898541e+05
  8.44850569e+05  1.52802763e+06  2.85029480e+06  5.80818179e+06]
E1 = -706.6584489951687  E_coul = 198.68499676191652
Extra cycle  E= -507.973452233252  delta_E= 3.41e-13  |g|= 7.02e-09  |ddm|= 1.07e-07
    CPU time for scf_cycle      1.12 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907857.9324002027
E1 = -706.6584489951687  E_coul = 198.68499676191652
init E= -507.973452233252
    CPU time for initialize scf      8.73 sec, wall time      0.83 sec
  HOMO = -0.243503916641029  LUMO = 0.0721398886976108
  mo_energy =
[-1.20320089e+02 -1.23795579e+01 -6.67812914e+00 -6.67812914e+00
 -6.67812914e+00 -1.17968186e+00 -2.43503917e-01 -2.43503917e-01
 -2.43503917e-01  7.21398887e-02  1.28525542e+00  1.36338865e+01
  1.15716367e+02  6.15044281e+02  2.75982410e+03  1.22384481e+04
  4.08583708e+04  1.04901056e+05  2.30083944e+05  4.55898541e+05
  8.44850569e+05  1.52802763e+06  2.85029480e+06  5.80818179e+06]
E1 = -706.6584490099362  E_coul = 198.68499677668416
cycle= 1 E= -507.973452233252  delta_E= 5.68e-14  |g|= 1.43e-09  |ddm|= 1.25e-08
    CPU time for cycle= 1      0.29 sec, wall time      0.03 sec
E1 = -706.6584490099362  E_coul = 198.68499677668416
  HOMO = -0.243503916257094  LUMO = 0.0721398886146052
  mo_energy =
[-1.20320089e+02 -1.23795579e+01 -6.67812914e+00 -6.67812914e+00
 -6.67812914e+00 -1.17968186e+00 -2.43503916e-01 -2.43503916e-01
 -2.43503916e-01  7.21398886e-02  1.28525542e+00  1.36338865e+01
  1.15716367e+02  6.15044281e+02  2.75982410e+03  1.22384481e+04
  4.08583708e+04  1.04901056e+05  2.30083944e+05  4.55898541e+05
  8.44850569e+05  1.52802763e+06  2.85029480e+06  5.80818179e+06]
E1 = -706.6584490116564  E_coul = 198.6849967784041
Extra cycle  E= -507.973452233252  delta_E= -2.84e-13  |g|= 1.37e-09  |ddm|= 9.46e-10
    CPU time for scf_cycle     11.24 sec, wall time      3.08 sec
exp = [2.64535374e-02 2.64535374e-01 1.17616814e+05 6.72136184e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315507e+03 1.83757993e+04
 1.44908393e+03 3.76379722e+02 1.14557167e+02 3.82887338e+01
 8.42599766e+00 3.38239118e+00 8.60353103e+00 4.92564840e-01]
grad_E = [-9.53353256e-03 -1.77142564e-02  4.33539525e-09  3.68285735e-03
  2.05730219e-11  1.17742824e-10  6.74395753e-10  2.64646161e-09
  1.10003774e-08  5.89924657e-08  3.71911169e-06  1.28611284e-07
  4.48947811e-07  3.20622788e-07  2.45929752e-06 -8.22169225e-06
  5.53219362e-05 -1.39111862e-04 -4.77634657e-05 -2.09124002e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:06:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.0359870699519      1
[INPUT] 0    0    [1    /1   ]  0.282249630289       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.668453326545       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200236        1
[INPUT] 0    0    [1    /1   ]  36754.7149414        1
[INPUT] 0    0    [1    /1   ]  7303.1550655         1
[INPUT] 0    0    [1    /1   ]  18375.7992871        1
[INPUT] 0    0    [1    /1   ]  1449.08392846        1
[INPUT] 0    0    [1    /1   ]  376.379721373        1
[INPUT] 0    0    [1    /1   ]  114.557164878        1
[INPUT] 0    0    [1    /1   ]  38.2887420712        1
[INPUT] 0    0    [1    /1   ]  8.42594234021        1
[INPUT] 0    0    [1    /1   ]  3.38253029108        1
[INPUT] 1    0    [1    /1   ]  8.60357879587        1
[INPUT] 1    0    [1    /1   ]  0.494656080484       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.03598706995189864, 1.0]], [0, [0.2822496302894119, 1.0]], [0, [117616.81386811091, 1.0]], [0, [0.668453326545057, 1.0]], [0, [1176168.142617244, 1.0]], [0, [588084.0699825119, 1.0]], [0, [294042.031073737, 1.0]], [0, [147020.99191980498, 1.0]], [0, [73510.42002360291, 1.0]], [0, [36754.71494142835, 1.0]], [0, [7303.155065502201, 1.0]], [0, [18375.799287117, 1.0]], [0, [1449.0839284553172, 1.0]], [0, [376.3797213730957, 1.0]], [0, [114.55716487846588, 1.0]], [0, [38.288742071210464, 1.0]], [0, [8.425942340213343, 1.0]], [0, [3.3825302910839032, 1.0]], [1, [8.603578795871094, 1.0]], [1, [0.49465608048407295, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.03598707]
bas 1, expnt(s) = [0.28224963]
bas 2, expnt(s) = [117616.81386811]
bas 3, expnt(s) = [0.66845333]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998251]
bas 6, expnt(s) = [294042.03107374]
bas 7, expnt(s) = [147020.9919198]
bas 8, expnt(s) = [73510.4200236]
bas 9, expnt(s) = [36754.71494143]
bas 10, expnt(s) = [7303.1550655]
bas 11, expnt(s) = [18375.79928712]
bas 12, expnt(s) = [1449.08392846]
bas 13, expnt(s) = [376.37972137]
bas 14, expnt(s) = [114.55716488]
bas 15, expnt(s) = [38.28874207]
bas 16, expnt(s) = [8.42594234]
bas 17, expnt(s) = [3.38253029]
bas 18, expnt(s) = [8.6035788]
bas 19, expnt(s) = [0.49465608]
CPU time:        31.35
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.59870700e-02 2.08749234e-01 2.82249630e-01 9.78340564e-01
 1.17616814e+05 1.60460109e+04 6.68453327e-01 1.86774826e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315507e+03 1.99594199e+03 1.83757993e+04 3.98749088e+03
 1.44908393e+03 5.93383108e+02 3.76379721e+02 2.15891074e+02
 1.14557165e+02 8.84670849e+01 3.82887421e+01 3.88882453e+01
 8.42594234e+00 1.24947878e+01 3.38253029e+00 6.30153416e+00
 8.60357880e+00 4.29866220e+01 4.94656080e-01 1.21021793e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33308632202452
cond(S) = 907859.4174457322
E1 = -689.6307879173437  E_coul = 185.02270793686642
init E= -504.608079980477
    CPU time for initialize scf      0.42 sec, wall time      0.07 sec
  HOMO = -0.670122341209001  LUMO = -0.0557991999338299
  mo_energy =
[-1.21699422e+02 -1.33800480e+01 -7.62066390e+00 -7.62066390e+00
 -7.62066390e+00 -1.65579891e+00 -6.70122341e-01 -6.70122341e-01
 -6.70122341e-01 -5.57991999e-02  9.92290606e-01  1.28646699e+01
  1.14513210e+02  6.13753524e+02  2.75860016e+03  1.22373355e+04
  4.08573246e+04  1.04900046e+05  2.30082958e+05  4.55897572e+05
  8.44849613e+05  1.52802669e+06  2.85029386e+06  5.80818086e+06]
E1 = -707.8280471320852  E_coul = 199.87229110643392
cycle= 1 E= -507.955756025651  delta_E= -3.35  |g|= 0.45  |ddm|= 0.503
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.644419
diis-c [-0.41527601  1.        ]
  HOMO = -0.213038753687391  LUMO = 0.10203602360855
  mo_energy =
[-1.20187084e+02 -1.22962799e+01 -6.58912663e+00 -6.58912663e+00
 -6.58912663e+00 -1.15970972e+00 -2.13038754e-01 -2.13038754e-01
 -2.13038754e-01  1.02036024e-01  1.40042045e+00  1.38126390e+01
  1.15917226e+02  6.15251800e+02  2.76003754e+03  1.22386641e+04
  4.08585867e+04  1.04901271e+05  2.30084159e+05  4.55898756e+05
  8.44850784e+05  1.52802785e+06  2.85029501e+06  5.80818201e+06]
E1 = -706.8903430671412  E_coul = 198.91713472743925
cycle= 2 E= -507.973208339702  delta_E= -0.0175  |g|= 0.0347  |ddm|= 0.443
    CPU time for cycle= 2      0.09 sec, wall time      0.03 sec
diis-norm(errvec)=0.0347103
diis-c [-0.00119986 -0.0034694   1.0034694 ]
  HOMO = -0.235051682880538  LUMO = 0.102050798391859
  mo_energy =
[-1.20300129e+02 -1.23626935e+01 -6.66266013e+00 -6.66266013e+00
 -6.66266013e+00 -1.17385480e+00 -2.35051683e-01 -2.35051683e-01
 -2.35051683e-01  1.02050798e-01  1.39244722e+00  1.37609189e+01
  1.15822574e+02  6.15134670e+02  2.75990445e+03  1.22385209e+04
  4.08584397e+04  1.04901123e+05  2.30084010e+05  4.55898606e+05
  8.44850633e+05  1.52802770e+06  2.85029486e+06  5.80818186e+06]
E1 = -706.7823069371524  E_coul = 198.8088360827191
cycle= 3 E= -507.973470854433  delta_E= -0.000263  |g|= 0.00433  |ddm|= 0.057
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00476933
diis-c [-3.50925718e-06 -4.48393694e-04 -1.43549901e-01  1.14399829e+00]
  HOMO = -0.238307260621543  LUMO = 0.102025494613348
  mo_energy =
[-1.20312208e+02 -1.23715037e+01 -6.67195969e+00 -6.67195969e+00
 -6.67195969e+00 -1.17582228e+00 -2.38307261e-01 -2.38307261e-01
 -2.38307261e-01  1.02025495e-01  1.39097494e+00  1.37537495e+01
  1.15811747e+02  6.15122429e+02  2.75989140e+03  1.22385073e+04
  4.08584260e+04  1.04901109e+05  2.30083996e+05  4.55898592e+05
  8.44850620e+05  1.52802768e+06  2.85029484e+06  5.80818184e+06]
E1 = -706.7663601374256  E_coul = 198.79288416913738
cycle= 4 E= -507.973475968288  delta_E= -5.11e-06  |g|= 0.000129  |ddm|= 0.00829
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000179002
diis-c [-3.22956660e-09 -1.10214339e-05  9.88566795e-03 -9.66664775e-02
  1.08679183e+00]
  HOMO = -0.238343958967376  LUMO = 0.102023194998605
  mo_energy =
[-1.20312123e+02 -1.23715403e+01 -6.67197339e+00 -6.67197339e+00
 -6.67197339e+00 -1.17584313e+00 -2.38343959e-01 -2.38343959e-01
 -2.38343959e-01  1.02023195e-01  1.39094216e+00  1.37537032e+01
  1.15811788e+02  6.15122521e+02  2.75989152e+03  1.22385075e+04
  4.08584262e+04  1.04901109e+05  2.30083996e+05  4.55898592e+05
  8.44850620e+05  1.52802768e+06  2.85029484e+06  5.80818184e+06]
E1 = -706.7661729703161  E_coul = 198.79269699671957
cycle= 5 E= -507.973475973597  delta_E= -5.31e-09  |g|= 1.04e-05  |ddm|= 0.000177
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.45835e-06
diis-c [-2.05087066e-12  1.10760327e-06 -1.25857621e-03  1.23930847e-02
 -1.52928009e-01  1.14179239e+00]
  HOMO = -0.23833998752821  LUMO = 0.10202319501042
  mo_energy =
[-1.20312109e+02 -1.23715283e+01 -6.67196112e+00 -6.67196112e+00
 -6.67196112e+00 -1.17584106e+00 -2.38339988e-01 -2.38339988e-01
 -2.38339988e-01  1.02023195e-01  1.39094341e+00  1.37537129e+01
  1.15811801e+02  6.15122535e+02  2.75989153e+03  1.22385075e+04
  4.08584262e+04  1.04901109e+05  2.30083996e+05  4.55898592e+05
  8.44850620e+05  1.52802768e+06  2.85029484e+06  5.80818184e+06]
E1 = -706.7661898711453  E_coul = 198.7927138975194
cycle= 6 E= -507.973475973626  delta_E= -2.93e-11  |g|= 6.41e-08  |ddm|= 2.58e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7661898711453  E_coul = 198.7927138975194
  HOMO = -0.238339975186863  LUMO = 0.102023188714909
  mo_energy =
[-1.20312109e+02 -1.23715283e+01 -6.67196105e+00 -6.67196105e+00
 -6.67196105e+00 -1.17584103e+00 -2.38339975e-01 -2.38339975e-01
 -2.38339975e-01  1.02023189e-01  1.39094339e+00  1.37537129e+01
  1.15811801e+02  6.15122535e+02  2.75989153e+03  1.22385075e+04
  4.08584262e+04  1.04901109e+05  2.30083996e+05  4.55898592e+05
  8.44850620e+05  1.52802768e+06  2.85029484e+06  5.80818184e+06]
E1 = -706.7661899932124  E_coul = 198.79271401958673
Extra cycle  E= -507.973475973626  delta_E= 2.27e-13  |g|= 6.77e-09  |ddm|= 1.04e-07
    CPU time for scf_cycle      1.10 sec, wall time      0.28 sec
exp = [3.59870700e-02 2.82249630e-01 1.17616814e+05 6.68453327e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315507e+03 1.83757993e+04
 1.44908393e+03 3.76379721e+02 1.14557165e+02 3.82887421e+01
 8.42594234e+00 3.38253029e+00 8.60357880e+00 4.94656080e-01]
E = -507.9734759736257
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:06:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.0315039928322      1
[INPUT] 0    0    [1    /1   ]  0.273919624926       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.670185164498       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200236        1
[INPUT] 0    0    [1    /1   ]  36754.7149415        1
[INPUT] 0    0    [1    /1   ]  7303.15506725        1
[INPUT] 0    0    [1    /1   ]  18375.7992872        1
[INPUT] 0    0    [1    /1   ]  1449.08392867        1
[INPUT] 0    0    [1    /1   ]  376.379721524        1
[INPUT] 0    0    [1    /1   ]  114.557166035        1
[INPUT] 0    0    [1    /1   ]  38.288738205         1
[INPUT] 0    0    [1    /1   ]  8.42596835497        1
[INPUT] 0    0    [1    /1   ]  3.3824648747         1
[INPUT] 1    0    [1    /1   ]  8.60355633543        1
[INPUT] 1    0    [1    /1   ]  0.493672689465       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.03150399283215411, 1.0]], [0, [0.2739196249258544, 1.0]], [0, [117616.81386811295, 1.0]], [0, [0.6701851644982185, 1.0]], [0, [1176168.142617244, 1.0]], [0, [588084.0699825119, 1.0]], [0, [294042.03107373737, 1.0]], [0, [147020.99191980623, 1.0]], [0, [73510.4200236081, 1.0]], [0, [36754.71494145609, 1.0]], [0, [7303.1550672510875, 1.0]], [0, [18375.799287177477, 1.0]], [0, [1449.0839286664316, 1.0]], [0, [376.37972152386635, 1.0]], [0, [114.55716603493337, 1.0]], [0, [38.28873820501709, 1.0]], [0, [8.42596835496758, 1.0]], [0, [3.3824648747018875, 1.0]], [1, [8.60355633543483, 1.0]], [1, [0.49367268946457105, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.03150399]
bas 1, expnt(s) = [0.27391962]
bas 2, expnt(s) = [117616.81386811]
bas 3, expnt(s) = [0.67018516]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998251]
bas 6, expnt(s) = [294042.03107374]
bas 7, expnt(s) = [147020.99191981]
bas 8, expnt(s) = [73510.42002361]
bas 9, expnt(s) = [36754.71494146]
bas 10, expnt(s) = [7303.15506725]
bas 11, expnt(s) = [18375.79928718]
bas 12, expnt(s) = [1449.08392867]
bas 13, expnt(s) = [376.37972152]
bas 14, expnt(s) = [114.55716603]
bas 15, expnt(s) = [38.28873821]
bas 16, expnt(s) = [8.42596835]
bas 17, expnt(s) = [3.38246487]
bas 18, expnt(s) = [8.60355634]
bas 19, expnt(s) = [0.49367269]
CPU time:        32.54
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.15039928e-02 1.88924910e-01 2.73919625e-01 9.56604425e-01
 1.17616814e+05 1.60460109e+04 6.70185164e-01 1.87137633e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315507e+03 1.99594199e+03 1.83757993e+04 3.98749088e+03
 1.44908393e+03 5.93383108e+02 3.76379722e+02 2.15891074e+02
 1.14557166e+02 8.84670856e+01 3.82887382e+01 3.88882424e+01
 8.42596835e+00 1.24948168e+01 3.38246487e+00 6.30144276e+00
 8.60355634e+00 4.29864817e+01 4.93672689e-01 1.20721124e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33449646167697
cond(S) = 907858.7102077217
E1 = -689.600230362213  E_coul = 184.99461596525904
init E= -504.605614396954
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.671193247817521  LUMO = -0.06221646163756
  mo_energy =
[-1.21701935e+02 -1.33823677e+01 -7.62226136e+00 -7.62226136e+00
 -7.62226136e+00 -1.65668498e+00 -6.71193248e-01 -6.71193248e-01
 -6.71193248e-01 -6.22164616e-02  9.45811893e-01  1.28092481e+01
  1.14469279e+02  6.13717741e+02  2.75856942e+03  1.22373086e+04
  4.08572995e+04  1.04900022e+05  2.30082934e+05  4.55897548e+05
  8.44849590e+05  1.52802666e+06  2.85029384e+06  5.80818084e+06]
E1 = -707.780574104867  E_coul = 199.82479125783615
cycle= 1 E= -507.955782847031  delta_E= -3.35  |g|= 0.449  |ddm|= 0.493
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.642832
diis-c [-0.41323286  1.        ]
  HOMO = -0.215381218806534  LUMO = 0.0878543174541275
  mo_energy =
[-1.20190598e+02 -1.22998145e+01 -6.59178047e+00 -6.59178047e+00
 -6.59178047e+00 -1.16146072e+00 -2.15381219e-01 -2.15381219e-01
 -2.15381219e-01  8.78543175e-02  1.35062273e+00  1.37562724e+01
  1.15872343e+02  6.15215037e+02  2.76000590e+03  1.22386363e+04
  4.08585608e+04  1.04901246e+05  2.30084134e+05  4.55898732e+05
  8.44850760e+05  1.52802782e+06  2.85029499e+06  5.80818198e+06]
E1 = -706.8402713558103  E_coul = 198.86698233239343
cycle= 2 E= -507.973289023417  delta_E= -0.0175  |g|= 0.0347  |ddm|= 0.44
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0338734
diis-c [-0.00114406 -0.00285896  1.00285896]
  HOMO = -0.237447410619421  LUMO = 0.0878682724483826
  mo_energy =
[-1.20303788e+02 -1.23663954e+01 -6.66548280e+00 -6.66548280e+00
 -6.66548280e+00 -1.17566671e+00 -2.37447411e-01 -2.37447411e-01
 -2.37447411e-01  8.78682724e-02  1.34289819e+00  1.37044226e+01
  1.15777537e+02  6.15097764e+02  2.75987267e+03  1.22384929e+04
  4.08584137e+04  1.04901098e+05  2.30083985e+05  4.55898582e+05
  8.44850610e+05  1.52802767e+06  2.85029484e+06  5.80818183e+06]
E1 = -706.7323019202662  E_coul = 198.75875130703773
cycle= 3 E= -507.973550613228  delta_E= -0.000262  |g|= 0.00433  |ddm|= 0.057
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00459291
diis-c [-3.31921457e-06 -4.25630563e-04 -1.41212811e-01  1.14163844e+00]
  HOMO = -0.240699285145456  LUMO = 0.0878481311587797
  mo_energy =
[-1.20315904e+02 -1.23752239e+01 -6.67480442e+00 -6.67480442e+00
 -6.67480442e+00 -1.17763462e+00 -2.40699285e-01 -2.40699285e-01
 -2.40699285e-01  8.78481312e-02  1.34147540e+00  1.36972423e+01
  1.15766680e+02  6.15085483e+02  2.75985957e+03  1.22384793e+04
  4.08583999e+04  1.04901084e+05  2.30083971e+05  4.55898568e+05
  8.44850596e+05  1.52802766e+06  2.85029482e+06  5.80818182e+06]
E1 = -706.716443048031  E_coul = 198.74288741364222
cycle= 4 E= -507.973555634389  delta_E= -5.02e-06  |g|= 0.000121  |ddm|= 0.00839
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000171982
diis-c [-2.89482437e-09 -1.04629876e-05  9.66957339e-03 -9.58716291e-02
  1.08621252e+00]
  HOMO = -0.240739744274005  LUMO = 0.087846338105899
  mo_energy =
[-1.20315844e+02 -1.23752757e+01 -6.67483467e+00 -6.67483467e+00
 -6.67483467e+00 -1.17765763e+00 -2.40739744e-01 -2.40739744e-01
 -2.40739744e-01  8.78463381e-02  1.34144311e+00  1.36971846e+01
  1.15766700e+02  6.15085550e+02  2.75985966e+03  1.22384794e+04
  4.08584000e+04  1.04901084e+05  2.30083971e+05  4.55898568e+05
  8.44850596e+05  1.52802766e+06  2.85029482e+06  5.80818182e+06]
E1 = -706.7162409756749  E_coul = 198.74268533671037
cycle= 5 E= -507.973555638965  delta_E= -4.58e-09  |g|= 9.34e-06  |ddm|= 0.000154
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.94186e-06
diis-c [-1.92700443e-12  1.08171455e-06 -1.22769295e-03  1.22906614e-02
 -1.51169638e-01  1.14010559e+00]
  HOMO = -0.240735916899893  LUMO = 0.0878463469577542
  mo_energy =
[-1.20315830e+02 -1.23752643e+01 -6.67482314e+00 -6.67482314e+00
 -6.67482314e+00 -1.17765561e+00 -2.40735917e-01 -2.40735917e-01
 -2.40735917e-01  8.78463470e-02  1.34144439e+00  1.36971937e+01
  1.15766712e+02  6.15085563e+02  2.75985968e+03  1.22384795e+04
  4.08584001e+04  1.04901084e+05  2.30083971e+05  4.55898568e+05
  8.44850596e+05  1.52802766e+06  2.85029482e+06  5.80818182e+06]
E1 = -706.7162574854583  E_coul = 198.7427018464705
cycle= 6 E= -507.973555638988  delta_E= -2.33e-11  |g|= 6.47e-08  |ddm|= 2.22e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7162574854583  E_coul = 198.7427018464705
  HOMO = -0.240735901334512  LUMO = 0.0878463414996747
  mo_energy =
[-1.20315830e+02 -1.23752643e+01 -6.67482306e+00 -6.67482306e+00
 -6.67482306e+00 -1.17765558e+00 -2.40735901e-01 -2.40735901e-01
 -2.40735901e-01  8.78463415e-02  1.34144437e+00  1.36971938e+01
  1.15766713e+02  6.15085564e+02  2.75985968e+03  1.22384795e+04
  4.08584001e+04  1.04901084e+05  2.30083971e+05  4.55898568e+05
  8.44850596e+05  1.52802766e+06  2.85029482e+06  5.80818182e+06]
E1 = -706.7162576201213  E_coul = 198.7427019811341
Extra cycle  E= -507.973555638987  delta_E= 6.82e-13  |g|= 7.1e-09  |ddm|= 1.05e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [3.15039928e-02 2.73919625e-01 1.17616814e+05 6.70185164e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315507e+03 1.83757993e+04
 1.44908393e+03 3.76379722e+02 1.14557166e+02 3.82887382e+01
 8.42596835e+00 3.38246487e+00 8.60355634e+00 4.93672689e-01]
E = -507.97355563898714
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:06:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.0315039928322      1
[INPUT] 0    0    [1    /1   ]  0.273919624926       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.670185164498       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200236        1
[INPUT] 0    0    [1    /1   ]  36754.7149415        1
[INPUT] 0    0    [1    /1   ]  7303.15506725        1
[INPUT] 0    0    [1    /1   ]  18375.7992872        1
[INPUT] 0    0    [1    /1   ]  1449.08392867        1
[INPUT] 0    0    [1    /1   ]  376.379721524        1
[INPUT] 0    0    [1    /1   ]  114.557166035        1
[INPUT] 0    0    [1    /1   ]  38.288738205         1
[INPUT] 0    0    [1    /1   ]  8.42596835497        1
[INPUT] 0    0    [1    /1   ]  3.3824648747         1
[INPUT] 1    0    [1    /1   ]  8.60355633543        1
[INPUT] 1    0    [1    /1   ]  0.493672689465       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.03150399283215411, 1.0]], [0, [0.2739196249258544, 1.0]], [0, [117616.81386811295, 1.0]], [0, [0.6701851644982185, 1.0]], [0, [1176168.142617244, 1.0]], [0, [588084.0699825119, 1.0]], [0, [294042.03107373737, 1.0]], [0, [147020.99191980623, 1.0]], [0, [73510.4200236081, 1.0]], [0, [36754.71494145609, 1.0]], [0, [7303.1550672510875, 1.0]], [0, [18375.799287177477, 1.0]], [0, [1449.0839286664316, 1.0]], [0, [376.37972152386635, 1.0]], [0, [114.55716603493337, 1.0]], [0, [38.28873820501709, 1.0]], [0, [8.42596835496758, 1.0]], [0, [3.3824648747018875, 1.0]], [1, [8.60355633543483, 1.0]], [1, [0.49367268946457105, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.03150399]
bas 1, expnt(s) = [0.27391962]
bas 2, expnt(s) = [117616.81386811]
bas 3, expnt(s) = [0.67018516]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998251]
bas 6, expnt(s) = [294042.03107374]
bas 7, expnt(s) = [147020.99191981]
bas 8, expnt(s) = [73510.42002361]
bas 9, expnt(s) = [36754.71494146]
bas 10, expnt(s) = [7303.15506725]
bas 11, expnt(s) = [18375.79928718]
bas 12, expnt(s) = [1449.08392867]
bas 13, expnt(s) = [376.37972152]
bas 14, expnt(s) = [114.55716603]
bas 15, expnt(s) = [38.28873821]
bas 16, expnt(s) = [8.42596835]
bas 17, expnt(s) = [3.38246487]
bas 18, expnt(s) = [8.60355634]
bas 19, expnt(s) = [0.49367269]
CPU time:        33.72
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.15039928e-02 1.88924910e-01 2.73919625e-01 9.56604425e-01
 1.17616814e+05 1.60460109e+04 6.70185164e-01 1.87137633e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315507e+03 1.99594199e+03 1.83757993e+04 3.98749088e+03
 1.44908393e+03 5.93383108e+02 3.76379722e+02 2.15891074e+02
 1.14557166e+02 8.84670856e+01 3.82887382e+01 3.88882424e+01
 8.42596835e+00 1.24948168e+01 3.38246487e+00 6.30144276e+00
 8.60355634e+00 4.29864817e+01 4.93672689e-01 1.20721124e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33449646167697
cond(S) = 907858.7102077217
E1 = -689.600230362213  E_coul = 184.99461596525904
init E= -504.605614396954
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.671193247817521  LUMO = -0.06221646163756
  mo_energy =
[-1.21701935e+02 -1.33823677e+01 -7.62226136e+00 -7.62226136e+00
 -7.62226136e+00 -1.65668498e+00 -6.71193248e-01 -6.71193248e-01
 -6.71193248e-01 -6.22164616e-02  9.45811893e-01  1.28092481e+01
  1.14469279e+02  6.13717741e+02  2.75856942e+03  1.22373086e+04
  4.08572995e+04  1.04900022e+05  2.30082934e+05  4.55897548e+05
  8.44849590e+05  1.52802666e+06  2.85029384e+06  5.80818084e+06]
E1 = -707.780574104867  E_coul = 199.82479125783615
cycle= 1 E= -507.955782847031  delta_E= -3.35  |g|= 0.449  |ddm|= 0.493
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.642832
diis-c [-0.41323286  1.        ]
  HOMO = -0.215381218806534  LUMO = 0.0878543174541275
  mo_energy =
[-1.20190598e+02 -1.22998145e+01 -6.59178047e+00 -6.59178047e+00
 -6.59178047e+00 -1.16146072e+00 -2.15381219e-01 -2.15381219e-01
 -2.15381219e-01  8.78543175e-02  1.35062273e+00  1.37562724e+01
  1.15872343e+02  6.15215037e+02  2.76000590e+03  1.22386363e+04
  4.08585608e+04  1.04901246e+05  2.30084134e+05  4.55898732e+05
  8.44850760e+05  1.52802782e+06  2.85029499e+06  5.80818198e+06]
E1 = -706.8402713558103  E_coul = 198.86698233239343
cycle= 2 E= -507.973289023417  delta_E= -0.0175  |g|= 0.0347  |ddm|= 0.44
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0338734
diis-c [-0.00114406 -0.00285896  1.00285896]
  HOMO = -0.237447410619421  LUMO = 0.0878682724483826
  mo_energy =
[-1.20303788e+02 -1.23663954e+01 -6.66548280e+00 -6.66548280e+00
 -6.66548280e+00 -1.17566671e+00 -2.37447411e-01 -2.37447411e-01
 -2.37447411e-01  8.78682724e-02  1.34289819e+00  1.37044226e+01
  1.15777537e+02  6.15097764e+02  2.75987267e+03  1.22384929e+04
  4.08584137e+04  1.04901098e+05  2.30083985e+05  4.55898582e+05
  8.44850610e+05  1.52802767e+06  2.85029484e+06  5.80818183e+06]
E1 = -706.7323019202662  E_coul = 198.75875130703773
cycle= 3 E= -507.973550613228  delta_E= -0.000262  |g|= 0.00433  |ddm|= 0.057
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00459291
diis-c [-3.31921457e-06 -4.25630563e-04 -1.41212811e-01  1.14163844e+00]
  HOMO = -0.240699285145456  LUMO = 0.0878481311587797
  mo_energy =
[-1.20315904e+02 -1.23752239e+01 -6.67480442e+00 -6.67480442e+00
 -6.67480442e+00 -1.17763462e+00 -2.40699285e-01 -2.40699285e-01
 -2.40699285e-01  8.78481312e-02  1.34147540e+00  1.36972423e+01
  1.15766680e+02  6.15085483e+02  2.75985957e+03  1.22384793e+04
  4.08583999e+04  1.04901084e+05  2.30083971e+05  4.55898568e+05
  8.44850596e+05  1.52802766e+06  2.85029482e+06  5.80818182e+06]
E1 = -706.716443048031  E_coul = 198.74288741364222
cycle= 4 E= -507.973555634389  delta_E= -5.02e-06  |g|= 0.000121  |ddm|= 0.00839
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000171982
diis-c [-2.89482437e-09 -1.04629876e-05  9.66957339e-03 -9.58716291e-02
  1.08621252e+00]
  HOMO = -0.240739744274005  LUMO = 0.087846338105899
  mo_energy =
[-1.20315844e+02 -1.23752757e+01 -6.67483467e+00 -6.67483467e+00
 -6.67483467e+00 -1.17765763e+00 -2.40739744e-01 -2.40739744e-01
 -2.40739744e-01  8.78463381e-02  1.34144311e+00  1.36971846e+01
  1.15766700e+02  6.15085550e+02  2.75985966e+03  1.22384794e+04
  4.08584000e+04  1.04901084e+05  2.30083971e+05  4.55898568e+05
  8.44850596e+05  1.52802766e+06  2.85029482e+06  5.80818182e+06]
E1 = -706.7162409756749  E_coul = 198.74268533671037
cycle= 5 E= -507.973555638965  delta_E= -4.58e-09  |g|= 9.34e-06  |ddm|= 0.000154
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.94186e-06
diis-c [-1.92700443e-12  1.08171455e-06 -1.22769295e-03  1.22906614e-02
 -1.51169638e-01  1.14010559e+00]
  HOMO = -0.240735916899893  LUMO = 0.0878463469577542
  mo_energy =
[-1.20315830e+02 -1.23752643e+01 -6.67482314e+00 -6.67482314e+00
 -6.67482314e+00 -1.17765561e+00 -2.40735917e-01 -2.40735917e-01
 -2.40735917e-01  8.78463470e-02  1.34144439e+00  1.36971937e+01
  1.15766712e+02  6.15085563e+02  2.75985968e+03  1.22384795e+04
  4.08584001e+04  1.04901084e+05  2.30083971e+05  4.55898568e+05
  8.44850596e+05  1.52802766e+06  2.85029482e+06  5.80818182e+06]
E1 = -706.7162574854583  E_coul = 198.7427018464705
cycle= 6 E= -507.973555638988  delta_E= -2.33e-11  |g|= 6.47e-08  |ddm|= 2.22e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7162574854583  E_coul = 198.7427018464705
  HOMO = -0.240735901334512  LUMO = 0.0878463414996747
  mo_energy =
[-1.20315830e+02 -1.23752643e+01 -6.67482306e+00 -6.67482306e+00
 -6.67482306e+00 -1.17765558e+00 -2.40735901e-01 -2.40735901e-01
 -2.40735901e-01  8.78463415e-02  1.34144437e+00  1.36971938e+01
  1.15766713e+02  6.15085564e+02  2.75985968e+03  1.22384795e+04
  4.08584001e+04  1.04901084e+05  2.30083971e+05  4.55898568e+05
  8.44850596e+05  1.52802766e+06  2.85029482e+06  5.80818182e+06]
E1 = -706.7162576201213  E_coul = 198.7427019811341
Extra cycle  E= -507.973555638987  delta_E= 6.82e-13  |g|= 7.1e-09  |ddm|= 1.05e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907858.7102077217
E1 = -706.7162576201213  E_coul = 198.7427019811341
init E= -507.973555638987
    CPU time for initialize scf      3.41 sec, wall time      0.22 sec
  HOMO = -0.240735898114063  LUMO = 0.0878463413932739
  mo_energy =
[-1.20315830e+02 -1.23752643e+01 -6.67482305e+00 -6.67482305e+00
 -6.67482305e+00 -1.17765558e+00 -2.40735898e-01 -2.40735898e-01
 -2.40735898e-01  8.78463414e-02  1.34144437e+00  1.36971938e+01
  1.15766713e+02  6.15085564e+02  2.75985968e+03  1.22384795e+04
  4.08584001e+04  1.04901084e+05  2.30083971e+05  4.55898568e+05
  8.44850596e+05  1.52802766e+06  2.85029482e+06  5.80818182e+06]
E1 = -706.7162576359917  E_coul = 198.7427019970039
cycle= 1 E= -507.973555638988  delta_E= -6.82e-13  |g|= 1.67e-09  |ddm|= 1.32e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.7162576359917  E_coul = 198.7427019970039
  HOMO = -0.24073589770981  LUMO = 0.0878463413452445
  mo_energy =
[-1.20315830e+02 -1.23752643e+01 -6.67482305e+00 -6.67482305e+00
 -6.67482305e+00 -1.17765558e+00 -2.40735898e-01 -2.40735898e-01
 -2.40735898e-01  8.78463413e-02  1.34144437e+00  1.36971938e+01
  1.15766713e+02  6.15085564e+02  2.75985968e+03  1.22384795e+04
  4.08584001e+04  1.04901084e+05  2.30083971e+05  4.55898568e+05
  8.44850596e+05  1.52802766e+06  2.85029482e+06  5.80818182e+06]
E1 = -706.7162576378405  E_coul = 198.74270199885274
Extra cycle  E= -507.973555638988  delta_E= 5.68e-14  |g|= 1.16e-09  |ddm|= 1.43e-09
    CPU time for scf_cycle      3.86 sec, wall time      0.39 sec
exp = [3.15039928e-02 2.73919625e-01 1.17616814e+05 6.70185164e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315507e+03 1.83757993e+04
 1.44908393e+03 3.76379722e+02 1.14557166e+02 3.82887382e+01
 8.42596835e+00 3.38246487e+00 8.60355634e+00 4.93672689e-01]
grad_E = [-1.50703297e-02  3.66740886e-03  4.33537481e-09 -3.64692100e-03
  2.05732601e-11  1.17742403e-10  6.74392751e-10  2.64644920e-09
  1.10003256e-08  5.89921883e-08  3.71910943e-06  1.28610671e-07
  4.45208106e-07  3.76431210e-07  1.41581474e-06 -8.81573080e-08
  2.47619650e-04 -1.47294675e-03 -1.18015974e-03  3.77138894e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:06:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.0818541046466      1
[INPUT] 0    0    [1    /1   ]  0.33677295359        1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.659914077649       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200236        1
[INPUT] 0    0    [1    /1   ]  36754.7149412        1
[INPUT] 0    0    [1    /1   ]  7303.1550497         1
[INPUT] 0    0    [1    /1   ]  18375.7992866        1
[INPUT] 0    0    [1    /1   ]  1449.08392655        1
[INPUT] 0    0    [1    /1   ]  376.379719957        1
[INPUT] 0    0    [1    /1   ]  114.557155443        1
[INPUT] 0    0    [1    /1   ]  38.2887691127        1
[INPUT] 0    0    [1    /1   ]  8.4255209035         1
[INPUT] 0    0    [1    /1   ]  3.38441434336        1
[INPUT] 1    0    [1    /1   ]  8.60487950587        1
[INPUT] 1    0    [1    /1   ]  0.464950623603       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.08185410464664963, 1.0]], [0, [0.33677295359033677, 1.0]], [0, [117616.81386809249, 1.0]], [0, [0.6599140776487047, 1.0]], [0, [1176168.142617244, 1.0]], [0, [588084.0699825113, 1.0]], [0, [294042.03107373416, 1.0]], [0, [147020.99191979374, 1.0]], [0, [73510.42002355619, 1.0]], [0, [36754.71494117774, 1.0]], [0, [7303.155049703059, 1.0]], [0, [18375.799286570647, 1.0]], [0, [1449.0839265517689, 1.0]], [0, [376.37971995695557, 1.0]], [0, [114.55715544274194, 1.0]], [0, [38.288769112661825, 1.0]], [0, [8.425520903496377, 1.0]], [0, [3.3844143433640506, 1.0]], [1, [8.604879505874896, 1.0]], [1, [0.46495062360289063, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.0818541]
bas 1, expnt(s) = [0.33677295]
bas 2, expnt(s) = [117616.81386809]
bas 3, expnt(s) = [0.65991408]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998251]
bas 6, expnt(s) = [294042.03107373]
bas 7, expnt(s) = [147020.99191979]
bas 8, expnt(s) = [73510.42002356]
bas 9, expnt(s) = [36754.71494118]
bas 10, expnt(s) = [7303.1550497]
bas 11, expnt(s) = [18375.79928657]
bas 12, expnt(s) = [1449.08392655]
bas 13, expnt(s) = [376.37971996]
bas 14, expnt(s) = [114.55715544]
bas 15, expnt(s) = [38.28876911]
bas 16, expnt(s) = [8.4255209]
bas 17, expnt(s) = [3.38441434]
bas 18, expnt(s) = [8.60487951]
bas 19, expnt(s) = [0.46495062]
CPU time:        45.45
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.18541046e-02 3.86629841e-01 3.36772954e-01 1.11690936e+00
 1.17616814e+05 1.60460109e+04 6.59914078e-01 1.84982468e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315505e+03 1.99594199e+03 1.83757993e+04 3.98749088e+03
 1.44908393e+03 5.93383108e+02 3.76379720e+02 2.15891073e+02
 1.14557155e+02 8.84670794e+01 3.82887691e+01 3.88882659e+01
 8.42552090e+00 1.24943191e+01 3.38441434e+00 6.30416642e+00
 8.60487951e+00 4.29947457e+01 4.64950624e-01 1.12006425e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.365237654118317
cond(S) = 907865.8989757795
E1 = -688.4306911545056  E_coul = 183.93757028544258
init E= -504.493120869063
    CPU time for initialize scf      0.42 sec, wall time      0.06 sec
  HOMO = -0.707870009748524  LUMO = 0.0401068632853086
  mo_energy =
[-1.21790634e+02 -1.34697875e+01 -7.68766233e+00 -7.68766233e+00
 -7.68766233e+00 -1.68912968e+00 -7.07870010e-01 -7.07870010e-01
 -7.07870010e-01  4.01068633e-02  1.34477180e+00  1.32395360e+01
  1.14780777e+02  6.13950269e+02  2.75875309e+03  1.22374557e+04
  4.08574286e+04  1.04900142e+05  2.30083048e+05  4.55897658e+05
  8.44849697e+05  1.52802677e+06  2.85029394e+06  5.80818094e+06]
E1 = -706.29855158486  E_coul = 198.35610596766145
cycle= 1 E= -507.942445617199  delta_E= -3.45  |g|= 0.441  |ddm|= 0.572
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.650955
diis-c [-0.42374277  1.        ]
  HOMO = -0.277820646855115  LUMO = 0.239945556325714
  mo_energy =
[-1.20306771e+02 -1.24119098e+01 -6.67942746e+00 -6.67942746e+00
 -6.67942746e+00 -1.20992514e+00 -2.77820647e-01 -2.77820647e-01
 -2.77820647e-01  2.39945556e-01  1.75073616e+00  1.41604799e+01
  1.16156450e+02  6.15420176e+02  2.76016241e+03  1.22387565e+04
  4.08586631e+04  1.04901340e+05  2.30084222e+05  4.55898815e+05
  8.44850840e+05  1.52802790e+06  2.85029506e+06  5.80818205e+06]
E1 = -705.4058050699476  E_coul = 197.44738111984813
cycle= 2 E= -507.958423950099  delta_E= -0.016  |g|= 0.0333  |ddm|= 0.439
    CPU time for cycle= 2      0.10 sec, wall time      0.03 sec
diis-norm(errvec)=0.037106
diis-c [-0.0013617  -0.00602673  1.00602673]
  HOMO = -0.297871732903955  LUMO = 0.23977531774968
  mo_energy =
[-1.20415842e+02 -1.24753294e+01 -6.75007888e+00 -6.75007888e+00
 -6.75007888e+00 -1.22334874e+00 -2.97871733e-01 -2.97871733e-01
 -2.97871733e-01  2.39775318e-01  1.74124382e+00  1.41111476e+01
  1.16065418e+02  6.15307099e+02  2.76003366e+03  1.22386178e+04
  4.08585207e+04  1.04901196e+05  2.30084077e+05  4.55898670e+05
  8.44850694e+05  1.52802775e+06  2.85029491e+06  5.80818191e+06]
E1 = -705.3022916936334  E_coul = 197.34362371790147
cycle= 3 E= -507.958667975732  delta_E= -0.000244  |g|= 0.00415  |ddm|= 0.0512
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00514853
diis-c [-3.66582775e-06 -4.73786333e-04 -1.46337351e-01  1.14681114e+00]
  HOMO = -0.300875515618358  LUMO = 0.239678698081643
  mo_energy =
[-1.20427208e+02 -1.24836472e+01 -6.75887844e+00 -6.75887844e+00
 -6.75887844e+00 -1.22524246e+00 -3.00875516e-01 -3.00875516e-01
 -3.00875516e-01  2.39678698e-01  1.73953092e+00  1.41043687e+01
  1.16055222e+02  6.15295587e+02  2.76002140e+03  1.22386051e+04
  4.08585079e+04  1.04901183e+05  2.30084064e+05  4.55898657e+05
  8.44850681e+05  1.52802774e+06  2.85029490e+06  5.80818189e+06]
E1 = -705.2868355852789  E_coul = 197.32816254636558
cycle= 4 E= -507.958673038913  delta_E= -5.06e-06  |g|= 0.000165  |ddm|= 0.00677
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000179067
diis-c [-2.58365111e-09 -1.21512229e-05  9.66461216e-03 -9.33854992e-02
  1.08373304e+00]
  HOMO = -0.300914619896322  LUMO = 0.239671895120157
  mo_energy =
[-1.20427096e+02 -1.24836711e+01 -6.75887664e+00 -6.75887664e+00
 -6.75887664e+00 -1.22526619e+00 -3.00914620e-01 -3.00914620e-01
 -3.00914620e-01  2.39671895e-01  1.73948865e+00  1.41043296e+01
  1.16055284e+02  6.15295707e+02  2.76002155e+03  1.22386053e+04
  4.08585081e+04  1.04901183e+05  2.30084064e+05  4.55898657e+05
  8.44850682e+05  1.52802774e+06  2.85029490e+06  5.80818189e+06]
E1 = -705.2866253984413  E_coul = 197.32795235132667
cycle= 5 E= -507.958673047115  delta_E= -8.2e-09  |g|= 1.24e-05  |ddm|= 0.000411
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.11158e-06
diis-c [-2.05185529e-12  1.14278796e-06 -1.23252058e-03  1.17053563e-02
 -1.52271292e-01  1.14179731e+00]
  HOMO = -0.300912878360569  LUMO = 0.239671753518525
  mo_energy =
[-1.20427086e+02 -1.24836629e+01 -6.75886821e+00 -6.75886821e+00
 -6.75886821e+00 -1.22526546e+00 -3.00912878e-01 -3.00912878e-01
 -3.00912878e-01  2.39671754e-01  1.73948854e+00  1.41043356e+01
  1.16055293e+02  6.15295717e+02  2.76002156e+03  1.22386053e+04
  4.08585081e+04  1.04901183e+05  2.30084065e+05  4.55898657e+05
  8.44850682e+05  1.52802774e+06  2.85029490e+06  5.80818189e+06]
E1 = -705.2866311465082  E_coul = 197.32795809935493
cycle= 6 E= -507.958673047153  delta_E= -3.86e-11  |g|= 5.27e-08  |ddm|= 4.25e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -705.2866311465082  E_coul = 197.32795809935493
  HOMO = -0.300912882519014  LUMO = 0.239671739641826
  mo_energy =
[-1.20427086e+02 -1.24836629e+01 -6.75886819e+00 -6.75886819e+00
 -6.75886819e+00 -1.22526544e+00 -3.00912883e-01 -3.00912883e-01
 -3.00912883e-01  2.39671740e-01  1.73948851e+00  1.41043356e+01
  1.16055293e+02  6.15295717e+02  2.76002156e+03  1.22386053e+04
  4.08585081e+04  1.04901183e+05  2.30084065e+05  4.55898657e+05
  8.44850682e+05  1.52802774e+06  2.85029490e+06  5.80818189e+06]
E1 = -705.2866312031066  E_coul = 197.3279581559538
Extra cycle  E= -507.958673047153  delta_E= 4.55e-13  |g|= 5.59e-09  |ddm|= 7.76e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [8.18541046e-02 3.36772954e-01 1.17616814e+05 6.59914078e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315505e+03 1.83757993e+04
 1.44908393e+03 3.76379720e+02 1.14557155e+02 3.82887691e+01
 8.42552090e+00 3.38441434e+00 8.60487951e+00 4.64950624e-01]
E = -507.9586730471528
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:06:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.0365390040136      1
[INPUT] 0    0    [1    /1   ]  0.280204957792       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.669158055813       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200236        1
[INPUT] 0    0    [1    /1   ]  36754.7149414        1
[INPUT] 0    0    [1    /1   ]  7303.1550655         1
[INPUT] 0    0    [1    /1   ]  18375.7992871        1
[INPUT] 0    0    [1    /1   ]  1449.08392845        1
[INPUT] 0    0    [1    /1   ]  376.379721367        1
[INPUT] 0    0    [1    /1   ]  114.557164976        1
[INPUT] 0    0    [1    /1   ]  38.2887412958        1
[INPUT] 0    0    [1    /1   ]  8.42592360982        1
[INPUT] 0    0    [1    /1   ]  3.38265982157        1
[INPUT] 1    0    [1    /1   ]  8.60368865248        1
[INPUT] 1    0    [1    /1   ]  0.490800482878       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.03653900401360366, 1.0]], [0, [0.28020495779230264, 1.0]], [0, [117616.8138681109, 1.0]], [0, [0.6691580558132671, 1.0]], [0, [1176168.142617244, 1.0]], [0, [588084.0699825119, 1.0]], [0, [294042.0310737371, 1.0]], [0, [147020.99191980498, 1.0]], [0, [73510.4200236029, 1.0]], [0, [36754.714941428254, 1.0]], [0, [7303.155065496285, 1.0]], [0, [18375.799287116795, 1.0]], [0, [1449.0839284549654, 1.0]], [0, [376.37972136717525, 1.0]], [0, [114.55716497571423, 1.0]], [0, [38.28874129578156, 1.0]], [0, [8.42592360982046, 1.0]], [0, [3.3826598215681036, 1.0]], [1, [8.603688652478835, 1.0]], [1, [0.490800482878403, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.036539]
bas 1, expnt(s) = [0.28020496]
bas 2, expnt(s) = [117616.81386811]
bas 3, expnt(s) = [0.66915806]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998251]
bas 6, expnt(s) = [294042.03107374]
bas 7, expnt(s) = [147020.9919198]
bas 8, expnt(s) = [73510.4200236]
bas 9, expnt(s) = [36754.71494143]
bas 10, expnt(s) = [7303.1550655]
bas 11, expnt(s) = [18375.79928712]
bas 12, expnt(s) = [1449.08392845]
bas 13, expnt(s) = [376.37972137]
bas 14, expnt(s) = [114.55716498]
bas 15, expnt(s) = [38.2887413]
bas 16, expnt(s) = [8.42592361]
bas 17, expnt(s) = [3.38265982]
bas 18, expnt(s) = [8.60368865]
bas 19, expnt(s) = [0.49080048]
CPU time:        46.64
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.65390040e-02 2.11145852e-01 2.80204958e-01 9.73020266e-01
 1.17616814e+05 1.60460109e+04 6.69158056e-01 1.86922490e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315507e+03 1.99594199e+03 1.83757993e+04 3.98749088e+03
 1.44908393e+03 5.93383108e+02 3.76379721e+02 2.15891074e+02
 1.14557165e+02 8.84670850e+01 3.82887413e+01 3.88882448e+01
 8.42592361e+00 1.24947670e+01 3.38265982e+00 6.30171515e+00
 8.60368865e+00 4.29873081e+01 4.90800483e-01 1.19843813e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.338214038445592
cond(S) = 907859.3726140591
E1 = -689.4944654979332  E_coul = 184.8982994895089
init E= -504.596166008424
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.674786255660503  LUMO = -0.0541421797407877
  mo_energy =
[-1.21710129e+02 -1.33904662e+01 -7.62810666e+00 -7.62810666e+00
 -7.62810666e+00 -1.65947946e+00 -6.74786256e-01 -6.74786256e-01
 -6.74786256e-01 -5.41421797e-02  9.87703293e-01  1.28517444e+01
  1.14499768e+02  6.13740553e+02  2.75858752e+03  1.22373231e+04
  4.08573124e+04  1.04900034e+05  2.30082945e+05  4.55897559e+05
  8.44849601e+05  1.52802667e+06  2.85029385e+06  5.80818085e+06]
E1 = -707.6360078334536  E_coul = 199.68002067350363
cycle= 1 E= -507.95598715995  delta_E= -3.36  |g|= 0.448  |ddm|=  0.5
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.644401
diis-c [-0.41525221  1.        ]
  HOMO = -0.221803747808539  LUMO = 0.103213722861642
  mo_energy =
[-1.20202163e+02 -1.23108845e+01 -6.60037180e+00 -6.60037180e+00
 -6.60037180e+00 -1.16617215e+00 -2.21803748e-01 -2.21803748e-01
 -2.21803748e-01  1.03213723e-01  1.39235917e+00  1.37957066e+01
  1.15899499e+02  6.15234484e+02  2.76002063e+03  1.22386475e+04
  4.08585703e+04  1.04901255e+05  2.30084143e+05  4.55898739e+05
  8.44850767e+05  1.52802783e+06  2.85029499e+06  5.80818199e+06]
E1 = -706.7029188703896  E_coul = 198.7296468777757
cycle= 2 E= -507.973271992614  delta_E= -0.0173  |g|= 0.0345  |ddm|= 0.439
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0346219
diis-c [-0.00119372 -0.00347316  1.00347316]
  HOMO = -0.243593612699881  LUMO = 0.103223539681792
  mo_energy =
[-1.20314753e+02 -1.23769858e+01 -6.67360396e+00 -6.67360396e+00
 -6.67360396e+00 -1.18024930e+00 -2.43593613e-01 -2.43593613e-01
 -2.43593613e-01  1.03223540e-01  1.38445966e+00  1.37442510e+01
  1.15805250e+02  6.15117821e+02  2.75988805e+03  1.22385048e+04
  4.08584238e+04  1.04901107e+05  2.30083994e+05  4.55898590e+05
  8.44850618e+05  1.52802768e+06  2.85029484e+06  5.80818184e+06]
E1 = -706.5955691240474  E_coul = 198.62203783154345
cycle= 3 E= -507.973531292504  delta_E= -0.000259  |g|= 0.0043  |ddm|= 0.0564
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0047491
diis-c [-3.48098668e-06 -4.43720080e-04 -1.43272648e-01  1.14371637e+00]
  HOMO = -0.24681335851566  LUMO = 0.103197831721092
  mo_energy =
[-1.20326760e+02 -1.23857411e+01 -6.68284969e+00 -6.68284969e+00
 -6.68284969e+00 -1.18220548e+00 -2.46813359e-01 -2.46813359e-01
 -2.46813359e-01  1.03197832e-01  1.38300416e+00  1.37371284e+01
  1.15794488e+02  6.15105652e+02  2.75987506e+03  1.22384913e+04
  4.08584102e+04  1.04901093e+05  2.30083980e+05  4.55898576e+05
  8.44850604e+05  1.52802767e+06  2.85029483e+06  5.80818183e+06]
E1 = -706.5797452311803  E_coul = 198.6062088975209
cycle= 4 E= -507.973536333659  delta_E= -5.04e-06  |g|= 0.000128  |ddm|= 0.0082
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000177827
diis-c [-3.16462508e-09 -1.09955876e-05  9.84145945e-03 -9.64212531e-02
  1.08659079e+00]
  HOMO = -0.246850048672917  LUMO = 0.103195567525386
  mo_energy =
[-1.20326677e+02 -1.23857786e+01 -6.68286433e+00 -6.68286433e+00
 -6.68286433e+00 -1.18222642e+00 -2.46850049e-01 -2.46850049e-01
 -2.46850049e-01  1.03195568e-01  1.38297173e+00  1.37370816e+01
  1.15794527e+02  6.15105742e+02  2.75987518e+03  1.22384915e+04
  4.08584104e+04  1.04901094e+05  2.30083980e+05  4.55898577e+05
  8.44850604e+05  1.52802767e+06  2.85029483e+06  5.80818183e+06]
E1 = -706.5795578006207  E_coul = 198.6060214617446
cycle= 5 E= -507.973536338876  delta_E= -5.22e-09  |g|= 1.03e-05  |ddm|= 0.000175
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.37282e-06
diis-c [-2.02750916e-12  1.10582811e-06 -1.25223245e-03  1.23516535e-02
 -1.52661710e-01  1.14156118e+00]
  HOMO = -0.246846170186241  LUMO = 0.103195569284097
  mo_energy =
[-1.20326663e+02 -1.23857668e+01 -6.68285229e+00 -6.68285229e+00
 -6.68285229e+00 -1.18222438e+00 -2.46846170e-01 -2.46846170e-01
 -2.46846170e-01  1.03195569e-01  1.38297295e+00  1.37370911e+01
  1.15794540e+02  6.15105756e+02  2.75987520e+03  1.22384915e+04
  4.08584104e+04  1.04901094e+05  2.30083980e+05  4.55898577e+05
  8.44850604e+05  1.52802767e+06  2.85029483e+06  5.80818183e+06]
E1 = -706.5795743363414  E_coul = 198.60603799743686
cycle= 6 E= -507.973536338905  delta_E= -2.84e-11  |g|= 6.38e-08  |ddm|= 2.53e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.5795743363414  E_coul = 198.60603799743686
  HOMO = -0.246846157491683  LUMO = 0.103195562609805
  mo_energy =
[-1.20326663e+02 -1.23857667e+01 -6.68285222e+00 -6.68285222e+00
 -6.68285222e+00 -1.18222435e+00 -2.46846157e-01 -2.46846157e-01
 -2.46846157e-01  1.03195563e-01  1.38297293e+00  1.37370911e+01
  1.15794540e+02  6.15105756e+02  2.75987520e+03  1.22384915e+04
  4.08584104e+04  1.04901094e+05  2.30083980e+05  4.55898577e+05
  8.44850604e+05  1.52802767e+06  2.85029483e+06  5.80818183e+06]
E1 = -706.5795744614842  E_coul = 198.60603812257952
Extra cycle  E= -507.973536338905  delta_E= -1.14e-13  |g|= 6.57e-09  |ddm|= 1.03e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [3.65390040e-02 2.80204958e-01 1.17616814e+05 6.69158056e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315507e+03 1.83757993e+04
 1.44908393e+03 3.76379721e+02 1.14557165e+02 3.82887413e+01
 8.42592361e+00 3.38265982e+00 8.60368865e+00 4.90800483e-01]
E = -507.97353633890464
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:06:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.033747236201       1
[INPUT] 0    0    [1    /1   ]  0.276719922833       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.669727557819       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200236        1
[INPUT] 0    0    [1    /1   ]  36754.7149414        1
[INPUT] 0    0    [1    /1   ]  7303.15506647        1
[INPUT] 0    0    [1    /1   ]  18375.7992872        1
[INPUT] 0    0    [1    /1   ]  1449.08392857        1
[INPUT] 0    0    [1    /1   ]  376.379721454        1
[INPUT] 0    0    [1    /1   ]  114.557165563        1
[INPUT] 0    0    [1    /1   ]  38.288739582         1
[INPUT] 0    0    [1    /1   ]  8.42594841971        1
[INPUT] 0    0    [1    /1   ]  3.38255172918        1
[INPUT] 1    0    [1    /1   ]  8.60361528651        1
[INPUT] 1    0    [1    /1   ]  0.492393038209       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.033747236201026265, 1.0]], [0, [0.27671992283298935, 1.0]], [0, [117616.81386811203, 1.0]], [0, [0.6697275578189887, 1.0]], [0, [1176168.142617244, 1.0]], [0, [588084.0699825119, 1.0]], [0, [294042.03107373725, 1.0]], [0, [147020.99191980567, 1.0]], [0, [73510.42002360578, 1.0]], [0, [36754.71494144369, 1.0]], [0, [7303.155066469272, 1.0]], [0, [18375.79928715044, 1.0]], [0, [1449.0839285722172, 1.0]], [0, [376.3797214540559, 1.0]], [0, [114.55716556302056, 1.0]], [0, [38.28873958204222, 1.0]], [0, [8.425948419708064, 1.0]], [0, [3.382551729179298, 1.0]], [1, [8.60361528651177, 1.0]], [1, [0.4923930382093384, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.03374724]
bas 1, expnt(s) = [0.27671992]
bas 2, expnt(s) = [117616.81386811]
bas 3, expnt(s) = [0.66972756]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998251]
bas 6, expnt(s) = [294042.03107374]
bas 7, expnt(s) = [147020.99191981]
bas 8, expnt(s) = [73510.42002361]
bas 9, expnt(s) = [36754.71494144]
bas 10, expnt(s) = [7303.15506647]
bas 11, expnt(s) = [18375.79928715]
bas 12, expnt(s) = [1449.08392857]
bas 13, expnt(s) = [376.37972145]
bas 14, expnt(s) = [114.55716556]
bas 15, expnt(s) = [38.28873958]
bas 16, expnt(s) = [8.42594842]
bas 17, expnt(s) = [3.38255173]
bas 18, expnt(s) = [8.60361529]
bas 19, expnt(s) = [0.49239304]
CPU time:        47.83
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.37472362e-02 1.98926977e-01 2.76719923e-01 9.63929663e-01
 1.17616814e+05 1.60460109e+04 6.69727558e-01 1.87041791e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315507e+03 1.99594199e+03 1.83757993e+04 3.98749088e+03
 1.44908393e+03 5.93383108e+02 3.76379721e+02 2.15891074e+02
 1.14557166e+02 8.84670853e+01 3.82887396e+01 3.88882434e+01
 8.42594842e+00 1.24947946e+01 3.38255173e+00 6.30156412e+00
 8.60361529e+00 4.29868499e+01 4.92393038e-01 1.20330099e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336169993049147
cond(S) = 907859.0032944054
E1 = -689.5534173719908  E_coul = 184.95194742898747
init E= -504.601469943003
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672792114789581  LUMO = -0.0587445388047091
  mo_energy =
[-1.21705568e+02 -1.33859594e+01 -7.62484777e+00 -7.62484777e+00
 -7.62484777e+00 -1.65792065e+00 -6.72792115e-01 -6.72792115e-01
 -6.72792115e-01 -5.87445388e-02  9.64521361e-01  1.28281408e+01
  1.14482825e+02  6.13727876e+02  2.75857746e+03  1.22373150e+04
  4.08573052e+04  1.04900027e+05  2.30082939e+05  4.55897553e+05
  8.44849595e+05  1.52802667e+06  2.85029384e+06  5.80818085e+06]
E1 = -707.7162643608299  E_coul = 199.76034415159577
cycle= 1 E= -507.955920209234  delta_E= -3.35  |g|= 0.449  |ddm|= 0.496
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.64355
diis-c [-0.4141561  1.       ]
  HOMO = -0.218247108494767  LUMO = 0.0946904876343567
  mo_energy =
[-1.20195750e+02 -1.23047432e+01 -6.59560408e+00 -6.59560408e+00
 -6.59560408e+00 -1.16355801e+00 -2.18247108e-01 -2.18247108e-01
 -2.18247108e-01  9.46904876e-02  1.36925078e+00  1.37737894e+01
  1.15884387e+02  6.15223656e+02  2.76001242e+03  1.22386412e+04
  4.08585650e+04  1.04901250e+05  2.30084138e+05  4.55898735e+05
  8.44850763e+05  1.52802783e+06  2.85029499e+06  5.80818199e+06]
E1 = -706.7792796184045  E_coul = 198.80595462412163
cycle= 2 E= -507.973324994283  delta_E= -0.0174  |g|= 0.0346  |ddm|= 0.44
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0342209
diis-c [-0.00116702 -0.00314115  1.00314115]
  HOMO = -0.240186785722131  LUMO = 0.0947029937746938
  mo_energy =
[-1.20308665e+02 -1.23711034e+01 -6.66908980e+00 -6.66908980e+00
 -6.66908980e+00 -1.17770431e+00 -2.40186786e-01 -2.40186786e-01
 -2.40186786e-01  9.47029938e-02  1.36144903e+00  1.37221214e+01
  1.15789837e+02  6.15106662e+02  2.75987949e+03  1.22384982e+04
  4.08584182e+04  1.04901102e+05  2.30083989e+05  4.55898585e+05
  8.44850613e+05  1.52802768e+06  2.85029484e+06  5.80818184e+06]
E1 = -706.671597081966  E_coul = 198.69801155469568
cycle= 3 E= -507.97358552727  delta_E= -0.000261  |g|= 0.00431  |ddm|= 0.0568
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00466622
diis-c [-3.39663012e-06 -4.34349986e-04 -1.42201234e-01  1.14263558e+00]
  HOMO = -0.243423957267039  LUMO = 0.0946804523580129
  mo_energy =
[-1.20320731e+02 -1.23798983e+01 -6.67837667e+00 -6.67837667e+00
 -6.67837667e+00 -1.17966676e+00 -2.43423957e-01 -2.43423957e-01
 -2.43423957e-01  9.46804524e-02  1.36001169e+00  1.37149675e+01
  1.15779024e+02  6.15094433e+02  2.75986644e+03  1.22384847e+04
  4.08584045e+04  1.04901088e+05  2.30083975e+05  4.55898572e+05
  8.44850599e+05  1.52802766e+06  2.85029483e+06  5.80818182e+06]
E1 = -706.6557544572754  E_coul = 198.68216390025327
cycle= 4 E= -507.973590557022  delta_E= -5.03e-06  |g|= 0.000124  |ddm|= 0.0083
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000174838
diis-c [-3.03103465e-09 -1.07176262e-05  9.75604057e-03 -9.61704414e-02
  1.08642512e+00]
  HOMO = -0.243462532804197  LUMO = 0.0946784531730045
  mo_energy =
[-1.20320660e+02 -1.23799432e+01 -6.67839934e+00 -6.67839934e+00
 -6.67839934e+00 -1.17968872e+00 -2.43462533e-01 -2.43462533e-01
 -2.43462533e-01  9.46784532e-02  1.35997940e+00  1.37149152e+01
  1.15779053e+02  6.15094511e+02  2.75986655e+03  1.22384848e+04
  4.08584046e+04  1.04901088e+05  2.30083975e+05  4.55898572e+05
  8.44850600e+05  1.52802766e+06  2.85029483e+06  5.80818182e+06]
E1 = -706.6555598109694  E_coul = 198.68196924908563
cycle= 5 E= -507.973590561884  delta_E= -4.86e-09  |g|= 9.78e-06  |ddm|= 0.000162
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.15625e-06
diis-c [-1.97566256e-12  1.09430404e-06 -1.24017671e-03  1.23285121e-02
 -1.51934409e-01  1.14084498e+00]
  HOMO = -0.243458663977219  LUMO = 0.0946784589671004
  mo_energy =
[-1.20320646e+02 -1.23799316e+01 -6.67838753e+00 -6.67838753e+00
 -6.67838753e+00 -1.17968669e+00 -2.43458664e-01 -2.43458664e-01
 -2.43458664e-01  9.46784590e-02  1.35998066e+00  1.37149245e+01
  1.15779066e+02  6.15094524e+02  2.75986656e+03  1.22384848e+04
  4.08584046e+04  1.04901088e+05  2.30083975e+05  4.55898572e+05
  8.44850600e+05  1.52802766e+06  2.85029483e+06  5.80818182e+06]
E1 = -706.6555764180264  E_coul = 198.68198585611677
cycle= 6 E= -507.97359056191  delta_E= -2.59e-11  |g|= 6.43e-08  |ddm|= 2.36e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6555764180264  E_coul = 198.68198585611677
  HOMO = -0.243458649711725  LUMO = 0.0946784532949426
  mo_energy =
[-1.20320646e+02 -1.23799315e+01 -6.67838745e+00 -6.67838745e+00
 -6.67838745e+00 -1.17968666e+00 -2.43458650e-01 -2.43458650e-01
 -2.43458650e-01  9.46784533e-02  1.35998063e+00  1.37149245e+01
  1.15779066e+02  6.15094525e+02  2.75986656e+03  1.22384848e+04
  4.08584046e+04  1.04901088e+05  2.30083975e+05  4.55898572e+05
  8.44850600e+05  1.52802766e+06  2.85029483e+06  5.80818182e+06]
E1 = -706.6555765483886  E_coul = 198.68198598647896
Extra cycle  E= -507.97359056191  delta_E=    0  |g|= 6.16e-09  |ddm|= 1.07e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [3.37472362e-02 2.76719923e-01 1.17616814e+05 6.69727558e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315507e+03 1.83757993e+04
 1.44908393e+03 3.76379721e+02 1.14557166e+02 3.82887396e+01
 8.42594842e+00 3.38255173e+00 8.60361529e+00 4.92393038e-01]
E = -507.97359056190965
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:06:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.033747236201       1
[INPUT] 0    0    [1    /1   ]  0.276719922833       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.669727557819       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200236        1
[INPUT] 0    0    [1    /1   ]  36754.7149414        1
[INPUT] 0    0    [1    /1   ]  7303.15506647        1
[INPUT] 0    0    [1    /1   ]  18375.7992872        1
[INPUT] 0    0    [1    /1   ]  1449.08392857        1
[INPUT] 0    0    [1    /1   ]  376.379721454        1
[INPUT] 0    0    [1    /1   ]  114.557165563        1
[INPUT] 0    0    [1    /1   ]  38.288739582         1
[INPUT] 0    0    [1    /1   ]  8.42594841971        1
[INPUT] 0    0    [1    /1   ]  3.38255172918        1
[INPUT] 1    0    [1    /1   ]  8.60361528651        1
[INPUT] 1    0    [1    /1   ]  0.492393038209       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.033747236201026265, 1.0]], [0, [0.27671992283298935, 1.0]], [0, [117616.81386811203, 1.0]], [0, [0.6697275578189887, 1.0]], [0, [1176168.142617244, 1.0]], [0, [588084.0699825119, 1.0]], [0, [294042.03107373725, 1.0]], [0, [147020.99191980567, 1.0]], [0, [73510.42002360578, 1.0]], [0, [36754.71494144369, 1.0]], [0, [7303.155066469272, 1.0]], [0, [18375.79928715044, 1.0]], [0, [1449.0839285722172, 1.0]], [0, [376.3797214540559, 1.0]], [0, [114.55716556302056, 1.0]], [0, [38.28873958204222, 1.0]], [0, [8.425948419708064, 1.0]], [0, [3.382551729179298, 1.0]], [1, [8.60361528651177, 1.0]], [1, [0.4923930382093384, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.03374724]
bas 1, expnt(s) = [0.27671992]
bas 2, expnt(s) = [117616.81386811]
bas 3, expnt(s) = [0.66972756]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998251]
bas 6, expnt(s) = [294042.03107374]
bas 7, expnt(s) = [147020.99191981]
bas 8, expnt(s) = [73510.42002361]
bas 9, expnt(s) = [36754.71494144]
bas 10, expnt(s) = [7303.15506647]
bas 11, expnt(s) = [18375.79928715]
bas 12, expnt(s) = [1449.08392857]
bas 13, expnt(s) = [376.37972145]
bas 14, expnt(s) = [114.55716556]
bas 15, expnt(s) = [38.28873958]
bas 16, expnt(s) = [8.42594842]
bas 17, expnt(s) = [3.38255173]
bas 18, expnt(s) = [8.60361529]
bas 19, expnt(s) = [0.49239304]
CPU time:        49.03
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.37472362e-02 1.98926977e-01 2.76719923e-01 9.63929663e-01
 1.17616814e+05 1.60460109e+04 6.69727558e-01 1.87041791e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315507e+03 1.99594199e+03 1.83757993e+04 3.98749088e+03
 1.44908393e+03 5.93383108e+02 3.76379721e+02 2.15891074e+02
 1.14557166e+02 8.84670853e+01 3.82887396e+01 3.88882434e+01
 8.42594842e+00 1.24947946e+01 3.38255173e+00 6.30156412e+00
 8.60361529e+00 4.29868499e+01 4.92393038e-01 1.20330099e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336169993049147
cond(S) = 907859.0032944054
E1 = -689.5534173719908  E_coul = 184.95194742898747
init E= -504.601469943003
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672792114789581  LUMO = -0.0587445388047091
  mo_energy =
[-1.21705568e+02 -1.33859594e+01 -7.62484777e+00 -7.62484777e+00
 -7.62484777e+00 -1.65792065e+00 -6.72792115e-01 -6.72792115e-01
 -6.72792115e-01 -5.87445388e-02  9.64521361e-01  1.28281408e+01
  1.14482825e+02  6.13727876e+02  2.75857746e+03  1.22373150e+04
  4.08573052e+04  1.04900027e+05  2.30082939e+05  4.55897553e+05
  8.44849595e+05  1.52802667e+06  2.85029384e+06  5.80818085e+06]
E1 = -707.7162643608299  E_coul = 199.76034415159577
cycle= 1 E= -507.955920209234  delta_E= -3.35  |g|= 0.449  |ddm|= 0.496
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.64355
diis-c [-0.4141561  1.       ]
  HOMO = -0.218247108494767  LUMO = 0.0946904876343567
  mo_energy =
[-1.20195750e+02 -1.23047432e+01 -6.59560408e+00 -6.59560408e+00
 -6.59560408e+00 -1.16355801e+00 -2.18247108e-01 -2.18247108e-01
 -2.18247108e-01  9.46904876e-02  1.36925078e+00  1.37737894e+01
  1.15884387e+02  6.15223656e+02  2.76001242e+03  1.22386412e+04
  4.08585650e+04  1.04901250e+05  2.30084138e+05  4.55898735e+05
  8.44850763e+05  1.52802783e+06  2.85029499e+06  5.80818199e+06]
E1 = -706.7792796184045  E_coul = 198.80595462412163
cycle= 2 E= -507.973324994283  delta_E= -0.0174  |g|= 0.0346  |ddm|= 0.44
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0342209
diis-c [-0.00116702 -0.00314115  1.00314115]
  HOMO = -0.240186785722131  LUMO = 0.0947029937746938
  mo_energy =
[-1.20308665e+02 -1.23711034e+01 -6.66908980e+00 -6.66908980e+00
 -6.66908980e+00 -1.17770431e+00 -2.40186786e-01 -2.40186786e-01
 -2.40186786e-01  9.47029938e-02  1.36144903e+00  1.37221214e+01
  1.15789837e+02  6.15106662e+02  2.75987949e+03  1.22384982e+04
  4.08584182e+04  1.04901102e+05  2.30083989e+05  4.55898585e+05
  8.44850613e+05  1.52802768e+06  2.85029484e+06  5.80818184e+06]
E1 = -706.671597081966  E_coul = 198.69801155469568
cycle= 3 E= -507.97358552727  delta_E= -0.000261  |g|= 0.00431  |ddm|= 0.0568
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00466622
diis-c [-3.39663012e-06 -4.34349986e-04 -1.42201234e-01  1.14263558e+00]
  HOMO = -0.243423957267039  LUMO = 0.0946804523580129
  mo_energy =
[-1.20320731e+02 -1.23798983e+01 -6.67837667e+00 -6.67837667e+00
 -6.67837667e+00 -1.17966676e+00 -2.43423957e-01 -2.43423957e-01
 -2.43423957e-01  9.46804524e-02  1.36001169e+00  1.37149675e+01
  1.15779024e+02  6.15094433e+02  2.75986644e+03  1.22384847e+04
  4.08584045e+04  1.04901088e+05  2.30083975e+05  4.55898572e+05
  8.44850599e+05  1.52802766e+06  2.85029483e+06  5.80818182e+06]
E1 = -706.6557544572754  E_coul = 198.68216390025327
cycle= 4 E= -507.973590557022  delta_E= -5.03e-06  |g|= 0.000124  |ddm|= 0.0083
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000174838
diis-c [-3.03103465e-09 -1.07176262e-05  9.75604057e-03 -9.61704414e-02
  1.08642512e+00]
  HOMO = -0.243462532804197  LUMO = 0.0946784531730045
  mo_energy =
[-1.20320660e+02 -1.23799432e+01 -6.67839934e+00 -6.67839934e+00
 -6.67839934e+00 -1.17968872e+00 -2.43462533e-01 -2.43462533e-01
 -2.43462533e-01  9.46784532e-02  1.35997940e+00  1.37149152e+01
  1.15779053e+02  6.15094511e+02  2.75986655e+03  1.22384848e+04
  4.08584046e+04  1.04901088e+05  2.30083975e+05  4.55898572e+05
  8.44850600e+05  1.52802766e+06  2.85029483e+06  5.80818182e+06]
E1 = -706.6555598109694  E_coul = 198.68196924908563
cycle= 5 E= -507.973590561884  delta_E= -4.86e-09  |g|= 9.78e-06  |ddm|= 0.000162
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.15625e-06
diis-c [-1.97566256e-12  1.09430404e-06 -1.24017671e-03  1.23285121e-02
 -1.51934409e-01  1.14084498e+00]
  HOMO = -0.243458663977219  LUMO = 0.0946784589671004
  mo_energy =
[-1.20320646e+02 -1.23799316e+01 -6.67838753e+00 -6.67838753e+00
 -6.67838753e+00 -1.17968669e+00 -2.43458664e-01 -2.43458664e-01
 -2.43458664e-01  9.46784590e-02  1.35998066e+00  1.37149245e+01
  1.15779066e+02  6.15094524e+02  2.75986656e+03  1.22384848e+04
  4.08584046e+04  1.04901088e+05  2.30083975e+05  4.55898572e+05
  8.44850600e+05  1.52802766e+06  2.85029483e+06  5.80818182e+06]
E1 = -706.6555764180264  E_coul = 198.68198585611677
cycle= 6 E= -507.97359056191  delta_E= -2.59e-11  |g|= 6.43e-08  |ddm|= 2.36e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6555764180264  E_coul = 198.68198585611677
  HOMO = -0.243458649711725  LUMO = 0.0946784532949426
  mo_energy =
[-1.20320646e+02 -1.23799315e+01 -6.67838745e+00 -6.67838745e+00
 -6.67838745e+00 -1.17968666e+00 -2.43458650e-01 -2.43458650e-01
 -2.43458650e-01  9.46784533e-02  1.35998063e+00  1.37149245e+01
  1.15779066e+02  6.15094525e+02  2.75986656e+03  1.22384848e+04
  4.08584046e+04  1.04901088e+05  2.30083975e+05  4.55898572e+05
  8.44850600e+05  1.52802766e+06  2.85029483e+06  5.80818182e+06]
E1 = -706.6555765483886  E_coul = 198.68198598647896
Extra cycle  E= -507.97359056191  delta_E=    0  |g|= 6.16e-09  |ddm|= 1.07e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907859.0032944054
E1 = -706.6555765483886  E_coul = 198.68198598647896
init E= -507.97359056191
    CPU time for initialize scf      3.38 sec, wall time      0.21 sec
  HOMO = -0.24345864663402  LUMO = 0.0946784528658286
  mo_energy =
[-1.20320646e+02 -1.23799315e+01 -6.67838744e+00 -6.67838744e+00
 -6.67838744e+00 -1.17968666e+00 -2.43458647e-01 -2.43458647e-01
 -2.43458647e-01  9.46784529e-02  1.35998063e+00  1.37149245e+01
  1.15779066e+02  6.15094525e+02  2.75986656e+03  1.22384848e+04
  4.08584046e+04  1.04901088e+05  2.30083975e+05  4.55898572e+05
  8.44850600e+05  1.52802766e+06  2.85029483e+06  5.80818182e+06]
E1 = -706.6555765624764  E_coul = 198.68198600056687
cycle= 1 E= -507.97359056191  delta_E= 1.14e-13  |g|= 1.92e-09  |ddm|= 1.02e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6555765624764  E_coul = 198.68198600056687
  HOMO = -0.243458646262578  LUMO = 0.0946784532875017
  mo_energy =
[-1.20320646e+02 -1.23799315e+01 -6.67838744e+00 -6.67838744e+00
 -6.67838744e+00 -1.17968666e+00 -2.43458646e-01 -2.43458646e-01
 -2.43458646e-01  9.46784533e-02  1.35998063e+00  1.37149245e+01
  1.15779066e+02  6.15094525e+02  2.75986656e+03  1.22384848e+04
  4.08584046e+04  1.04901088e+05  2.30083975e+05  4.55898572e+05
  8.44850600e+05  1.52802766e+06  2.85029483e+06  5.80818182e+06]
E1 = -706.6555765629987  E_coul = 198.68198600108892
Extra cycle  E= -507.97359056191  delta_E= -2.27e-13  |g|= 1.32e-09  |ddm|= 4.24e-09
    CPU time for scf_cycle      3.84 sec, wall time      0.38 sec
exp = [3.37472362e-02 2.76719923e-01 1.17616814e+05 6.69727558e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315507e+03 1.83757993e+04
 1.44908393e+03 3.76379721e+02 1.14557166e+02 3.82887396e+01
 8.42594842e+00 3.38255173e+00 8.60361529e+00 4.92393038e-01]
grad_E = [-1.64619711e-02  8.34190665e-03  4.33538134e-09 -5.36059910e-03
  2.05732070e-11  1.17742482e-10  6.74393842e-10  2.64645301e-09
  1.10003405e-08  5.89922974e-08  3.71911811e-06  1.28610615e-07
  4.45484558e-07  3.71402219e-07  1.28215941e-06  1.72283917e-06
  3.08034129e-04 -1.87252569e-03  1.42085761e-04 -9.03428499e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:06:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.064753607872       1
[INPUT] 0    0    [1    /1   ]  0.286070166031       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.67225959819        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200236        1
[INPUT] 0    0    [1    /1   ]  36754.7149413        1
[INPUT] 0    0    [1    /1   ]  7303.15505771        1
[INPUT] 0    0    [1    /1   ]  18375.7992868        1
[INPUT] 0    0    [1    /1   ]  1449.08392752        1
[INPUT] 0    0    [1    /1   ]  376.379720632        1
[INPUT] 0    0    [1    /1   ]  114.557161258        1
[INPUT] 0    0    [1    /1   ]  38.2887465984        1
[INPUT] 0    0    [1    /1   ]  8.42550884876        1
[INPUT] 0    0    [1    /1   ]  3.38500537594        1
[INPUT] 1    0    [1    /1   ]  8.60387798984        1
[INPUT] 1    0    [1    /1   ]  0.49230414108        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.06475360787198631, 1.0]], [0, [0.28607016603113217, 1.0]], [0, [117616.81386810183, 1.0]], [0, [0.672259598189521, 1.0]], [0, [1176168.142617244, 1.0]], [0, [588084.0699825117, 1.0]], [0, [294042.0310737357, 1.0]], [0, [147020.99191979945, 1.0]], [0, [73510.42002357988, 1.0]], [0, [36754.714941304796, 1.0]], [0, [7303.155057712591, 1.0]], [0, [18375.799286847625, 1.0]], [0, [1449.083927519736, 1.0]], [0, [376.3797206318495, 1.0]], [0, [114.55716125765753, 1.0]], [0, [38.288746598434805, 1.0]], [0, [8.42550884875878, 1.0]], [0, [3.385005375937274, 1.0]], [1, [8.603877989841802, 1.0]], [1, [0.492304141079999, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.06475361]
bas 1, expnt(s) = [0.28607017]
bas 2, expnt(s) = [117616.8138681]
bas 3, expnt(s) = [0.6722596]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998251]
bas 6, expnt(s) = [294042.03107374]
bas 7, expnt(s) = [147020.9919198]
bas 8, expnt(s) = [73510.42002358]
bas 9, expnt(s) = [36754.7149413]
bas 10, expnt(s) = [7303.15505771]
bas 11, expnt(s) = [18375.79928685]
bas 12, expnt(s) = [1449.08392752]
bas 13, expnt(s) = [376.37972063]
bas 14, expnt(s) = [114.55716126]
bas 15, expnt(s) = [38.2887466]
bas 16, expnt(s) = [8.42550885]
bas 17, expnt(s) = [3.38500538]
bas 18, expnt(s) = [8.60387799]
bas 19, expnt(s) = [0.49230414]
CPU time:        60.63
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 6.47536079e-02 3.24311988e-01 2.86070166e-01 9.88255978e-01
 1.17616814e+05 1.60460109e+04 6.72259598e-01 1.87571902e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315506e+03 1.99594199e+03 1.83757993e+04 3.98749088e+03
 1.44908393e+03 5.93383108e+02 3.76379721e+02 2.15891074e+02
 1.14557161e+02 8.84670828e+01 3.82887466e+01 3.88882488e+01
 8.42550885e+00 1.24943057e+01 3.38500538e+00 6.30499209e+00
 8.60387799e+00 4.29884906e+01 4.92304141e-01 1.20302944e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33648971122546
cond(S) = 907862.0347541019
E1 = -689.5552830586121  E_coul = 184.95276340079423
init E= -504.602519657818
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672818773005435  LUMO = -0.00484412890306523
  mo_energy =
[-1.21705377e+02 -1.33859579e+01 -7.62473519e+00 -7.62473519e+00
 -7.62473519e+00 -1.65797298e+00 -6.72818773e-01 -6.72818773e-01
 -6.72818773e-01 -4.84412890e-03  1.15468913e+00  1.30369877e+01
  1.14650172e+02  6.13862846e+02  2.75869198e+03  1.22374142e+04
  4.08573969e+04  1.04900115e+05  2.30083025e+05  4.55897637e+05
  8.44849677e+05  1.52802675e+06  2.85029392e+06  5.80818092e+06]
E1 = -707.7103148915403  E_coul = 199.75410428149692
cycle= 1 E= -507.956210610043  delta_E= -3.35  |g|= 0.449  |ddm|= 0.471
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.656433
diis-c [-0.43090423  1.        ]
  HOMO = -0.218499011752121  LUMO = 0.184332787276992
  mo_energy =
[-1.20196236e+02 -1.23052700e+01 -6.59602697e+00 -6.59602697e+00
 -6.59602697e+00 -1.16381835e+00 -2.18499012e-01 -2.18499012e-01
 -2.18499012e-01  1.84332787e-01  1.56362055e+00  1.39807283e+01
  1.16050839e+02  6.15357891e+02  2.76012620e+03  1.22387397e+04
  4.08586558e+04  1.04901337e+05  2.30084223e+05  4.55898818e+05
  8.44850845e+05  1.52802791e+06  2.85029507e+06  5.80818206e+06]
E1 = -706.7687885089002  E_coul = 198.79508457599525
cycle= 2 E= -507.973703932905  delta_E= -0.0175  |g|= 0.0348  |ddm|= 0.429
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0383798
diis-c [-0.00145331 -0.00681986  1.00681986]
  HOMO = -0.240688644868392  LUMO = 0.184263889625253
  mo_energy =
[-1.20309951e+02 -1.23721947e+01 -6.67011672e+00 -6.67011672e+00
 -6.67011672e+00 -1.17814385e+00 -2.40688645e-01 -2.40688645e-01
 -2.40688645e-01  1.84263890e-01  1.55469934e+00  1.39284865e+01
  1.15955586e+02  6.15240081e+02  2.75999238e+03  1.22385957e+04
  4.08585081e+04  1.04901188e+05  2.30084073e+05  4.55898667e+05
  8.44850694e+05  1.52802775e+06  2.85029492e+06  5.80818191e+06]
E1 = -706.6585382604775  E_coul = 198.68456309816992
cycle= 3 E= -507.973975162308  delta_E= -0.000271  |g|= 0.00433  |ddm|= 0.0523
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00534524
diis-c [-3.99295848e-06 -4.63495757e-04 -1.46819483e-01  1.14728298e+00]
  HOMO = -0.243972492914514  LUMO = 0.18419935376563
  mo_energy =
[-1.20321888e+02 -1.23809878e+01 -6.67938071e+00 -6.67938071e+00
 -6.67938071e+00 -1.18013809e+00 -2.43972493e-01 -2.43972493e-01
 -2.43972493e-01  1.84199354e-01  1.55306113e+00  1.39213015e+01
  1.15944854e+02  6.15227994e+02  2.75997952e+03  1.22385824e+04
  4.08584946e+04  1.04901175e+05  2.30084059e+05  4.55898654e+05
  8.44850680e+05  1.52802774e+06  2.85029490e+06  5.80818190e+06]
E1 = -706.6421547443248  E_coul = 198.6681740462918
cycle= 4 E= -507.973980698033  delta_E= -5.54e-06  |g|= 0.000168  |ddm|= 0.00726
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000194287
diis-c [-3.92737019e-09 -1.18719198e-05  1.00323315e-02 -9.65395672e-02
  1.08651911e+00]
  HOMO = -0.244007668746795  LUMO = 0.184194445040873
  mo_energy =
[-1.20321765e+02 -1.23810041e+01 -6.67937107e+00 -6.67937107e+00
 -6.67937107e+00 -1.18015873e+00 -2.44007669e-01 -2.44007669e-01
 -2.44007669e-01  1.84194445e-01  1.55302272e+00  1.39212686e+01
  1.15944925e+02  6.15228125e+02  2.75997969e+03  1.22385825e+04
  4.08584948e+04  1.04901175e+05  2.30084059e+05  4.55898654e+05
  8.44850680e+05  1.52802774e+06  2.85029490e+06  5.80818190e+06]
E1 = -706.6419547324944  E_coul = 198.66797402520623
cycle= 5 E= -507.973980707288  delta_E= -9.26e-09  |g|= 1.35e-05  |ddm|= 0.000359
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.83732e-06
diis-c [-2.33761468e-12  1.19856070e-06 -1.28483072e-03  1.22162742e-02
 -1.56968751e-01  1.14603611e+00]
  HOMO = -0.244004783372885  LUMO = 0.184194385704087
  mo_energy =
[-1.20321752e+02 -1.23809936e+01 -6.67936032e+00 -6.67936032e+00
 -6.67936032e+00 -1.18015741e+00 -2.44004783e-01 -2.44004783e-01
 -2.44004783e-01  1.84194386e-01  1.55302309e+00  1.39212767e+01
  1.15944937e+02  6.15228138e+02  2.75997970e+03  1.22385826e+04
  4.08584948e+04  1.04901175e+05  2.30084059e+05  4.55898654e+05
  8.44850680e+05  1.52802774e+06  2.85029490e+06  5.80818190e+06]
E1 = -706.6419644234147  E_coul = 198.66798371607638
cycle= 6 E= -507.973980707338  delta_E= -5.02e-11  |g|= 5.62e-08  |ddm|= 3.94e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6419644234147  E_coul = 198.66798371607638
  HOMO = -0.244004785030071  LUMO = 0.184194372598841
  mo_energy =
[-1.20321752e+02 -1.23809936e+01 -6.67936029e+00 -6.67936029e+00
 -6.67936029e+00 -1.18015739e+00 -2.44004785e-01 -2.44004785e-01
 -2.44004785e-01  1.84194373e-01  1.55302305e+00  1.39212767e+01
  1.15944937e+02  6.15228138e+02  2.75997970e+03  1.22385826e+04
  4.08584948e+04  1.04901175e+05  2.30084059e+05  4.55898654e+05
  8.44850680e+05  1.52802774e+06  2.85029490e+06  5.80818190e+06]
E1 = -706.6419645021357  E_coul = 198.66798379479724
Extra cycle  E= -507.973980707338  delta_E= -1.14e-13  |g|= 5.34e-09  |ddm|= 7.82e-08
    CPU time for scf_cycle      1.08 sec, wall time      0.28 sec
exp = [6.47536079e-02 2.86070166e-01 1.17616814e+05 6.72259598e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315506e+03 1.83757993e+04
 1.44908393e+03 3.76379721e+02 1.14557161e+02 3.82887466e+01
 8.42550885e+00 3.38500538e+00 8.60387799e+00 4.92304141e-01]
E = -507.97398070733846
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:06:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.064753607872       1
[INPUT] 0    0    [1    /1   ]  0.286070166031       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.67225959819        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200236        1
[INPUT] 0    0    [1    /1   ]  36754.7149413        1
[INPUT] 0    0    [1    /1   ]  7303.15505771        1
[INPUT] 0    0    [1    /1   ]  18375.7992868        1
[INPUT] 0    0    [1    /1   ]  1449.08392752        1
[INPUT] 0    0    [1    /1   ]  376.379720632        1
[INPUT] 0    0    [1    /1   ]  114.557161258        1
[INPUT] 0    0    [1    /1   ]  38.2887465984        1
[INPUT] 0    0    [1    /1   ]  8.42550884876        1
[INPUT] 0    0    [1    /1   ]  3.38500537594        1
[INPUT] 1    0    [1    /1   ]  8.60387798984        1
[INPUT] 1    0    [1    /1   ]  0.49230414108        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.06475360787198631, 1.0]], [0, [0.28607016603113217, 1.0]], [0, [117616.81386810183, 1.0]], [0, [0.672259598189521, 1.0]], [0, [1176168.142617244, 1.0]], [0, [588084.0699825117, 1.0]], [0, [294042.0310737357, 1.0]], [0, [147020.99191979945, 1.0]], [0, [73510.42002357988, 1.0]], [0, [36754.714941304796, 1.0]], [0, [7303.155057712591, 1.0]], [0, [18375.799286847625, 1.0]], [0, [1449.083927519736, 1.0]], [0, [376.3797206318495, 1.0]], [0, [114.55716125765753, 1.0]], [0, [38.288746598434805, 1.0]], [0, [8.42550884875878, 1.0]], [0, [3.385005375937274, 1.0]], [1, [8.603877989841802, 1.0]], [1, [0.492304141079999, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.06475361]
bas 1, expnt(s) = [0.28607017]
bas 2, expnt(s) = [117616.8138681]
bas 3, expnt(s) = [0.6722596]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998251]
bas 6, expnt(s) = [294042.03107374]
bas 7, expnt(s) = [147020.9919198]
bas 8, expnt(s) = [73510.42002358]
bas 9, expnt(s) = [36754.7149413]
bas 10, expnt(s) = [7303.15505771]
bas 11, expnt(s) = [18375.79928685]
bas 12, expnt(s) = [1449.08392752]
bas 13, expnt(s) = [376.37972063]
bas 14, expnt(s) = [114.55716126]
bas 15, expnt(s) = [38.2887466]
bas 16, expnt(s) = [8.42550885]
bas 17, expnt(s) = [3.38500538]
bas 18, expnt(s) = [8.60387799]
bas 19, expnt(s) = [0.49230414]
CPU time:        61.82
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 6.47536079e-02 3.24311988e-01 2.86070166e-01 9.88255978e-01
 1.17616814e+05 1.60460109e+04 6.72259598e-01 1.87571902e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315506e+03 1.99594199e+03 1.83757993e+04 3.98749088e+03
 1.44908393e+03 5.93383108e+02 3.76379721e+02 2.15891074e+02
 1.14557161e+02 8.84670828e+01 3.82887466e+01 3.88882488e+01
 8.42550885e+00 1.24943057e+01 3.38500538e+00 6.30499209e+00
 8.60387799e+00 4.29884906e+01 4.92304141e-01 1.20302944e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33648971122546
cond(S) = 907862.0347541019
E1 = -689.5552830586121  E_coul = 184.95276340079423
init E= -504.602519657818
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672818773005435  LUMO = -0.00484412890306523
  mo_energy =
[-1.21705377e+02 -1.33859579e+01 -7.62473519e+00 -7.62473519e+00
 -7.62473519e+00 -1.65797298e+00 -6.72818773e-01 -6.72818773e-01
 -6.72818773e-01 -4.84412890e-03  1.15468913e+00  1.30369877e+01
  1.14650172e+02  6.13862846e+02  2.75869198e+03  1.22374142e+04
  4.08573969e+04  1.04900115e+05  2.30083025e+05  4.55897637e+05
  8.44849677e+05  1.52802675e+06  2.85029392e+06  5.80818092e+06]
E1 = -707.7103148915403  E_coul = 199.75410428149692
cycle= 1 E= -507.956210610043  delta_E= -3.35  |g|= 0.449  |ddm|= 0.471
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.656433
diis-c [-0.43090423  1.        ]
  HOMO = -0.218499011752121  LUMO = 0.184332787276992
  mo_energy =
[-1.20196236e+02 -1.23052700e+01 -6.59602697e+00 -6.59602697e+00
 -6.59602697e+00 -1.16381835e+00 -2.18499012e-01 -2.18499012e-01
 -2.18499012e-01  1.84332787e-01  1.56362055e+00  1.39807283e+01
  1.16050839e+02  6.15357891e+02  2.76012620e+03  1.22387397e+04
  4.08586558e+04  1.04901337e+05  2.30084223e+05  4.55898818e+05
  8.44850845e+05  1.52802791e+06  2.85029507e+06  5.80818206e+06]
E1 = -706.7687885089002  E_coul = 198.79508457599525
cycle= 2 E= -507.973703932905  delta_E= -0.0175  |g|= 0.0348  |ddm|= 0.429
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0383798
diis-c [-0.00145331 -0.00681986  1.00681986]
  HOMO = -0.240688644868392  LUMO = 0.184263889625253
  mo_energy =
[-1.20309951e+02 -1.23721947e+01 -6.67011672e+00 -6.67011672e+00
 -6.67011672e+00 -1.17814385e+00 -2.40688645e-01 -2.40688645e-01
 -2.40688645e-01  1.84263890e-01  1.55469934e+00  1.39284865e+01
  1.15955586e+02  6.15240081e+02  2.75999238e+03  1.22385957e+04
  4.08585081e+04  1.04901188e+05  2.30084073e+05  4.55898667e+05
  8.44850694e+05  1.52802775e+06  2.85029492e+06  5.80818191e+06]
E1 = -706.6585382604775  E_coul = 198.68456309816992
cycle= 3 E= -507.973975162308  delta_E= -0.000271  |g|= 0.00433  |ddm|= 0.0523
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00534524
diis-c [-3.99295848e-06 -4.63495757e-04 -1.46819483e-01  1.14728298e+00]
  HOMO = -0.243972492914514  LUMO = 0.18419935376563
  mo_energy =
[-1.20321888e+02 -1.23809878e+01 -6.67938071e+00 -6.67938071e+00
 -6.67938071e+00 -1.18013809e+00 -2.43972493e-01 -2.43972493e-01
 -2.43972493e-01  1.84199354e-01  1.55306113e+00  1.39213015e+01
  1.15944854e+02  6.15227994e+02  2.75997952e+03  1.22385824e+04
  4.08584946e+04  1.04901175e+05  2.30084059e+05  4.55898654e+05
  8.44850680e+05  1.52802774e+06  2.85029490e+06  5.80818190e+06]
E1 = -706.6421547443248  E_coul = 198.6681740462918
cycle= 4 E= -507.973980698033  delta_E= -5.54e-06  |g|= 0.000168  |ddm|= 0.00726
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000194287
diis-c [-3.92737019e-09 -1.18719198e-05  1.00323315e-02 -9.65395672e-02
  1.08651911e+00]
  HOMO = -0.244007668746795  LUMO = 0.184194445040873
  mo_energy =
[-1.20321765e+02 -1.23810041e+01 -6.67937107e+00 -6.67937107e+00
 -6.67937107e+00 -1.18015873e+00 -2.44007669e-01 -2.44007669e-01
 -2.44007669e-01  1.84194445e-01  1.55302272e+00  1.39212686e+01
  1.15944925e+02  6.15228125e+02  2.75997969e+03  1.22385825e+04
  4.08584948e+04  1.04901175e+05  2.30084059e+05  4.55898654e+05
  8.44850680e+05  1.52802774e+06  2.85029490e+06  5.80818190e+06]
E1 = -706.6419547324944  E_coul = 198.66797402520623
cycle= 5 E= -507.973980707288  delta_E= -9.26e-09  |g|= 1.35e-05  |ddm|= 0.000359
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.83732e-06
diis-c [-2.33761468e-12  1.19856070e-06 -1.28483072e-03  1.22162742e-02
 -1.56968751e-01  1.14603611e+00]
  HOMO = -0.244004783372885  LUMO = 0.184194385704087
  mo_energy =
[-1.20321752e+02 -1.23809936e+01 -6.67936032e+00 -6.67936032e+00
 -6.67936032e+00 -1.18015741e+00 -2.44004783e-01 -2.44004783e-01
 -2.44004783e-01  1.84194386e-01  1.55302309e+00  1.39212767e+01
  1.15944937e+02  6.15228138e+02  2.75997970e+03  1.22385826e+04
  4.08584948e+04  1.04901175e+05  2.30084059e+05  4.55898654e+05
  8.44850680e+05  1.52802774e+06  2.85029490e+06  5.80818190e+06]
E1 = -706.6419644234147  E_coul = 198.66798371607638
cycle= 6 E= -507.973980707338  delta_E= -5.02e-11  |g|= 5.62e-08  |ddm|= 3.94e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6419644234147  E_coul = 198.66798371607638
  HOMO = -0.244004785030071  LUMO = 0.184194372598841
  mo_energy =
[-1.20321752e+02 -1.23809936e+01 -6.67936029e+00 -6.67936029e+00
 -6.67936029e+00 -1.18015739e+00 -2.44004785e-01 -2.44004785e-01
 -2.44004785e-01  1.84194373e-01  1.55302305e+00  1.39212767e+01
  1.15944937e+02  6.15228138e+02  2.75997970e+03  1.22385826e+04
  4.08584948e+04  1.04901175e+05  2.30084059e+05  4.55898654e+05
  8.44850680e+05  1.52802774e+06  2.85029490e+06  5.80818190e+06]
E1 = -706.6419645021357  E_coul = 198.66798379479724
Extra cycle  E= -507.973980707338  delta_E= -1.14e-13  |g|= 5.34e-09  |ddm|= 7.82e-08
    CPU time for scf_cycle      1.08 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907862.0347541019
E1 = -706.6419645021357  E_coul = 198.66798379479724
init E= -507.973980707338
    CPU time for initialize scf      3.30 sec, wall time      0.21 sec
  HOMO = -0.244004783378834  LUMO = 0.184194373555346
  mo_energy =
[-1.20321752e+02 -1.23809936e+01 -6.67936028e+00 -6.67936028e+00
 -6.67936028e+00 -1.18015738e+00 -2.44004783e-01 -2.44004783e-01
 -2.44004783e-01  1.84194374e-01  1.55302305e+00  1.39212767e+01
  1.15944937e+02  6.15228138e+02  2.75997970e+03  1.22385826e+04
  4.08584948e+04  1.04901175e+05  2.30084059e+05  4.55898654e+05
  8.44850680e+05  1.52802774e+06  2.85029490e+06  5.80818190e+06]
E1 = -706.6419645043625  E_coul = 198.66798379702414
cycle= 1 E= -507.973980707338  delta_E= 1.14e-13  |g|= 2.4e-09  |ddm|= 1.54e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6419645043625  E_coul = 198.66798379702414
  HOMO = -0.244004783404803  LUMO = 0.184194373856303
  mo_energy =
[-1.20321752e+02 -1.23809936e+01 -6.67936028e+00 -6.67936028e+00
 -6.67936028e+00 -1.18015738e+00 -2.44004783e-01 -2.44004783e-01
 -2.44004783e-01  1.84194374e-01  1.55302305e+00  1.39212767e+01
  1.15944937e+02  6.15228138e+02  2.75997970e+03  1.22385826e+04
  4.08584948e+04  1.04901175e+05  2.30084059e+05  4.55898654e+05
  8.44850680e+05  1.52802774e+06  2.85029490e+06  5.80818190e+06]
E1 = -706.6419645018063  E_coul = 198.66798379446783
Extra cycle  E= -507.973980707339  delta_E= -1.71e-13  |g|= 2.16e-09  |ddm|= 2.83e-09
    CPU time for scf_cycle      3.75 sec, wall time      0.38 sec
exp = [6.47536079e-02 2.86070166e-01 1.17616814e+05 6.72259598e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315506e+03 1.83757993e+04
 1.44908393e+03 3.76379721e+02 1.14557161e+02 3.82887466e+01
 8.42550885e+00 3.38500538e+00 8.60387799e+00 4.92304141e-01]
grad_E = [-1.03700747e-02  7.74894115e-04  4.33445398e-09 -4.56308369e-03
  2.05625904e-11  1.17712518e-10  6.74250537e-10  2.64587994e-09
  1.09979243e-08  5.89803886e-08  3.71828320e-06  1.28574332e-07
  4.91492039e-07 -3.65145905e-07  7.32120985e-06 -2.21379444e-05
  4.53010646e-04 -2.72713145e-03  3.80812536e-04 -1.43607299e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:06:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.172468347897       1
[INPUT] 0    0    [1    /1   ]  0.328705340874       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.687572967962       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200235        1
[INPUT] 0    0    [1    /1   ]  36754.7149407        1
[INPUT] 0    0    [1    /1   ]  7303.15502252        1
[INPUT] 0    0    [1    /1   ]  18375.7992856        1
[INPUT] 0    0    [1    /1   ]  1449.08392312        1
[INPUT] 0    0    [1    /1   ]  376.379720069        1
[INPUT] 0    0    [1    /1   ]  114.557122144        1
[INPUT] 0    0    [1    /1   ]  38.2888563485        1
[INPUT] 0    0    [1    /1   ]  8.42297075357        1
[INPUT] 0    0    [1    /1   ]  3.39963566919        1
[INPUT] 1    0    [1    /1   ]  8.60458701783        1
[INPUT] 1    0    [1    /1   ]  0.492625769457       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.1724683478974819, 1.0]], [0, [0.32870534087370346, 1.0]], [0, [117616.81386806081, 1.0]], [0, [0.6875729679623444, 1.0]], [0, [1176168.1426172438, 1.0]], [0, [588084.0699825105, 1.0]], [0, [294042.0310737293, 1.0]], [0, [147020.99191977442, 1.0]], [0, [73510.42002347579, 1.0]], [0, [36754.71494074655, 1.0]], [0, [7303.155022518874, 1.0]], [0, [18375.79928563062, 1.0]], [0, [1449.0839231183897, 1.0]], [0, [376.37972006854017, 1.0]], [0, [114.55712214397357, 1.0]], [0, [38.28885634850375, 1.0]], [0, [8.422970753571613, 1.0]], [0, [3.3996356691859067, 1.0]], [1, [8.60458701782613, 1.0]], [1, [0.492625769456546, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.17246835]
bas 1, expnt(s) = [0.32870534]
bas 2, expnt(s) = [117616.81386806]
bas 3, expnt(s) = [0.68757297]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998251]
bas 6, expnt(s) = [294042.03107373]
bas 7, expnt(s) = [147020.99191977]
bas 8, expnt(s) = [73510.42002348]
bas 9, expnt(s) = [36754.71494075]
bas 10, expnt(s) = [7303.15502252]
bas 11, expnt(s) = [18375.79928563]
bas 12, expnt(s) = [1449.08392312]
bas 13, expnt(s) = [376.37972007]
bas 14, expnt(s) = [114.55712214]
bas 15, expnt(s) = [38.28885635]
bas 16, expnt(s) = [8.42297075]
bas 17, expnt(s) = [3.39963567]
bas 18, expnt(s) = [8.60458702]
bas 19, expnt(s) = [0.49262577]
CPU time:        73.27
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.72468348e-01 6.76156265e-01 3.28705341e-01 1.09678145e+00
 1.17616814e+05 1.60460109e+04 6.87572968e-01 1.90767382e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315502e+03 1.99594199e+03 1.83757993e+04 3.98749088e+03
 1.44908392e+03 5.93383107e+02 3.76379720e+02 2.15891073e+02
 1.14557122e+02 8.84670601e+01 3.82888563e+01 3.88883324e+01
 8.42297075e+00 1.24914828e+01 3.39963567e+00 6.32541912e+00
 8.60458702e+00 4.29929189e+01 4.92625769e-01 1.20401196e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33621449103716
cond(S) = 907875.3937520396
E1 = -689.5801675318221  E_coul = 184.9741118020967
init E= -504.606055729725
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672193125359038  LUMO = 0.201703032463206
  mo_energy =
[-1.21703259e+02 -1.33843684e+01 -7.62325754e+00 -7.62325754e+00
 -7.62325754e+00 -1.65756293e+00 -6.72193125e-01 -6.72193125e-01
 -6.72193125e-01  2.01703032e-01  1.79967160e+00  1.38887702e+01
  1.15360235e+02  6.14438234e+02  2.75918075e+03  1.22378378e+04
  4.08577883e+04  1.04900490e+05  2.30083389e+05  4.55897994e+05
  8.44850028e+05  1.52802710e+06  2.85029426e+06  5.80818125e+06]
E1 = -707.7292317259602  E_coul = 199.77240140361303
cycle= 1 E= -507.956830322347  delta_E= -3.35  |g|= 0.45  |ddm|= 0.434
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.656899
diis-c [-0.43151651  1.        ]
  HOMO = -0.217825635581087  LUMO = 0.454705096095867
  mo_energy =
[-1.20194590e+02 -1.23040053e+01 -6.59489387e+00 -6.59489387e+00
 -6.59489387e+00 -1.16335905e+00 -2.17825636e-01 -2.17825636e-01
 -2.17825636e-01  4.54705096e-01  2.23611760e+00  1.48285658e+01
  1.16759506e+02  6.15932589e+02  2.76061432e+03  1.22391626e+04
  4.08590466e+04  1.04901712e+05  2.30084587e+05  4.55899174e+05
  8.44851195e+05  1.52802825e+06  2.85029541e+06  5.80818239e+06]
E1 = -706.7848223580125  E_coul = 198.81039815003948
cycle= 2 E= -507.974424207973  delta_E= -0.0176  |g|= 0.0349  |ddm|= 0.383
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0360096
diis-c [-0.00128051 -0.00616966  1.00616966]
  HOMO = -0.240036432614886  LUMO = 0.454014946844198
  mo_energy =
[-1.20308611e+02 -1.23711109e+01 -6.66919602e+00 -6.66919602e+00
 -6.66919602e+00 -1.17768746e+00 -2.40036433e-01 -2.40036433e-01
 -2.40036433e-01  4.54014947e-01  2.22405150e+00  1.47757819e+01
  1.16664021e+02  6.15814480e+02  2.76048017e+03  1.22390182e+04
  4.08588985e+04  1.04901562e+05  2.30084436e+05  4.55899023e+05
  8.44851044e+05  1.52802810e+06  2.85029525e+06  5.80818224e+06]
E1 = -706.6746970557066  E_coul = 198.7000005298611
cycle= 3 E= -507.974696525846  delta_E= -0.000272  |g|= 0.00439  |ddm|= 0.0462
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00459091
diis-c [-2.91715099e-06 -3.82103271e-04 -1.32935051e-01  1.13331715e+00]
  HOMO = -0.243302295142486  LUMO = 0.453786108056636
  mo_energy =
[-1.20320422e+02 -1.23798098e+01 -6.67836096e+00 -6.67836096e+00
 -6.67836096e+00 -1.17967505e+00 -2.43302295e-01 -2.43302295e-01
 -2.43302295e-01  4.53786108e-01  2.22196670e+00  1.47686445e+01
  1.16653406e+02  6.15802521e+02  2.76046744e+03  1.22390050e+04
  4.08588852e+04  1.04901549e+05  2.30084423e+05  4.55899010e+05
  8.44851030e+05  1.52802809e+06  2.85029524e+06  5.80818223e+06]
E1 = -706.6583948098113  E_coul = 198.68369252100717
cycle= 4 E= -507.974702288804  delta_E= -5.76e-06  |g|= 0.000214  |ddm|= 0.00971
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000159093
diis-c [-1.53723061e-09 -8.45798767e-06  8.66558624e-03 -9.24142670e-02
  1.08375714e+00]
  HOMO = -0.243385741674869  LUMO = 0.453771268546549
  mo_energy =
[-1.20320459e+02 -1.23799445e+01 -6.67847566e+00 -6.67847566e+00
 -6.67847566e+00 -1.17972610e+00 -2.43385742e-01 -2.43385742e-01
 -2.43385742e-01  4.53771269e-01  2.22189218e+00  1.47685141e+01
  1.16653333e+02  6.15802489e+02  2.76046744e+03  1.22390050e+04
  4.08588852e+04  1.04901549e+05  2.30084423e+05  4.55899010e+05
  8.44851030e+05  1.52802809e+06  2.85029524e+06  5.80818223e+06]
E1 = -706.6579544465594  E_coul = 198.68325214362906
cycle= 5 E= -507.97470230293  delta_E= -1.41e-08  |g|= 1.44e-05  |ddm|= 0.00101
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.13747e-06
diis-c [-1.87993519e-12  1.08535220e-06 -1.14454623e-03  1.17427162e-02
 -1.55590692e-01  1.14499144e+00]
  HOMO = -0.243388208073676  LUMO = 0.453770714666568
  mo_energy =
[-1.20320461e+02 -1.23799466e+01 -6.67847765e+00 -6.67847765e+00
 -6.67847765e+00 -1.17972808e+00 -2.43388208e-01 -2.43388208e-01
 -2.43388208e-01  4.53770715e-01  2.22188926e+00  1.47685115e+01
  1.16653332e+02  6.15802487e+02  2.76046743e+03  1.22390050e+04
  4.08588852e+04  1.04901549e+05  2.30084423e+05  4.55899010e+05
  8.44851030e+05  1.52802809e+06  2.85029524e+06  5.80818223e+06]
E1 = -706.6579379129897  E_coul = 198.6832356100017
cycle= 6 E= -507.974702302988  delta_E= -5.76e-11  |g|= 4.53e-08  |ddm|= 8.13e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6579379129897  E_coul = 198.6832356100017
  HOMO = -0.243388227474367  LUMO = 0.453770692935393
  mo_energy =
[-1.20320461e+02 -1.23799466e+01 -6.67847768e+00 -6.67847768e+00
 -6.67847768e+00 -1.17972806e+00 -2.43388227e-01 -2.43388227e-01
 -2.43388227e-01  4.53770693e-01  2.22188923e+00  1.47685115e+01
  1.16653332e+02  6.15802487e+02  2.76046743e+03  1.22390050e+04
  4.08588852e+04  1.04901549e+05  2.30084423e+05  4.55899010e+05
  8.44851030e+05  1.52802809e+06  2.85029524e+06  5.80818223e+06]
E1 = -706.6579378994792  E_coul = 198.6832355964915
Extra cycle  E= -507.974702302988  delta_E= 3.41e-13  |g|= 2.96e-09  |ddm|= 3.36e-08
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
exp = [1.72468348e-01 3.28705341e-01 1.17616814e+05 6.87572968e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315502e+03 1.83757993e+04
 1.44908392e+03 3.76379720e+02 1.14557122e+02 3.82888563e+01
 8.42297075e+00 3.39963567e+00 8.60458702e+00 4.92625769e-01]
E = -507.9747023029877
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:06:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.172468347897       1
[INPUT] 0    0    [1    /1   ]  0.328705340874       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.687572967962       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200235        1
[INPUT] 0    0    [1    /1   ]  36754.7149407        1
[INPUT] 0    0    [1    /1   ]  7303.15502252        1
[INPUT] 0    0    [1    /1   ]  18375.7992856        1
[INPUT] 0    0    [1    /1   ]  1449.08392312        1
[INPUT] 0    0    [1    /1   ]  376.379720069        1
[INPUT] 0    0    [1    /1   ]  114.557122144        1
[INPUT] 0    0    [1    /1   ]  38.2888563485        1
[INPUT] 0    0    [1    /1   ]  8.42297075357        1
[INPUT] 0    0    [1    /1   ]  3.39963566919        1
[INPUT] 1    0    [1    /1   ]  8.60458701783        1
[INPUT] 1    0    [1    /1   ]  0.492625769457       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.1724683478974819, 1.0]], [0, [0.32870534087370346, 1.0]], [0, [117616.81386806081, 1.0]], [0, [0.6875729679623444, 1.0]], [0, [1176168.1426172438, 1.0]], [0, [588084.0699825105, 1.0]], [0, [294042.0310737293, 1.0]], [0, [147020.99191977442, 1.0]], [0, [73510.42002347579, 1.0]], [0, [36754.71494074655, 1.0]], [0, [7303.155022518874, 1.0]], [0, [18375.79928563062, 1.0]], [0, [1449.0839231183897, 1.0]], [0, [376.37972006854017, 1.0]], [0, [114.55712214397357, 1.0]], [0, [38.28885634850375, 1.0]], [0, [8.422970753571613, 1.0]], [0, [3.3996356691859067, 1.0]], [1, [8.60458701782613, 1.0]], [1, [0.492625769456546, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.17246835]
bas 1, expnt(s) = [0.32870534]
bas 2, expnt(s) = [117616.81386806]
bas 3, expnt(s) = [0.68757297]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998251]
bas 6, expnt(s) = [294042.03107373]
bas 7, expnt(s) = [147020.99191977]
bas 8, expnt(s) = [73510.42002348]
bas 9, expnt(s) = [36754.71494075]
bas 10, expnt(s) = [7303.15502252]
bas 11, expnt(s) = [18375.79928563]
bas 12, expnt(s) = [1449.08392312]
bas 13, expnt(s) = [376.37972007]
bas 14, expnt(s) = [114.55712214]
bas 15, expnt(s) = [38.28885635]
bas 16, expnt(s) = [8.42297075]
bas 17, expnt(s) = [3.39963567]
bas 18, expnt(s) = [8.60458702]
bas 19, expnt(s) = [0.49262577]
CPU time:        74.45
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.72468348e-01 6.76156265e-01 3.28705341e-01 1.09678145e+00
 1.17616814e+05 1.60460109e+04 6.87572968e-01 1.90767382e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315502e+03 1.99594199e+03 1.83757993e+04 3.98749088e+03
 1.44908392e+03 5.93383107e+02 3.76379720e+02 2.15891073e+02
 1.14557122e+02 8.84670601e+01 3.82888563e+01 3.88883324e+01
 8.42297075e+00 1.24914828e+01 3.39963567e+00 6.32541912e+00
 8.60458702e+00 4.29929189e+01 4.92625769e-01 1.20401196e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33621449103716
cond(S) = 907875.3937520396
E1 = -689.5801675318221  E_coul = 184.9741118020967
init E= -504.606055729725
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672193125359038  LUMO = 0.201703032463206
  mo_energy =
[-1.21703259e+02 -1.33843684e+01 -7.62325754e+00 -7.62325754e+00
 -7.62325754e+00 -1.65756293e+00 -6.72193125e-01 -6.72193125e-01
 -6.72193125e-01  2.01703032e-01  1.79967160e+00  1.38887702e+01
  1.15360235e+02  6.14438234e+02  2.75918075e+03  1.22378378e+04
  4.08577883e+04  1.04900490e+05  2.30083389e+05  4.55897994e+05
  8.44850028e+05  1.52802710e+06  2.85029426e+06  5.80818125e+06]
E1 = -707.7292317259602  E_coul = 199.77240140361303
cycle= 1 E= -507.956830322347  delta_E= -3.35  |g|= 0.45  |ddm|= 0.434
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.656899
diis-c [-0.43151651  1.        ]
  HOMO = -0.217825635581087  LUMO = 0.454705096095867
  mo_energy =
[-1.20194590e+02 -1.23040053e+01 -6.59489387e+00 -6.59489387e+00
 -6.59489387e+00 -1.16335905e+00 -2.17825636e-01 -2.17825636e-01
 -2.17825636e-01  4.54705096e-01  2.23611760e+00  1.48285658e+01
  1.16759506e+02  6.15932589e+02  2.76061432e+03  1.22391626e+04
  4.08590466e+04  1.04901712e+05  2.30084587e+05  4.55899174e+05
  8.44851195e+05  1.52802825e+06  2.85029541e+06  5.80818239e+06]
E1 = -706.7848223580125  E_coul = 198.81039815003948
cycle= 2 E= -507.974424207973  delta_E= -0.0176  |g|= 0.0349  |ddm|= 0.383
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0360096
diis-c [-0.00128051 -0.00616966  1.00616966]
  HOMO = -0.240036432614886  LUMO = 0.454014946844198
  mo_energy =
[-1.20308611e+02 -1.23711109e+01 -6.66919602e+00 -6.66919602e+00
 -6.66919602e+00 -1.17768746e+00 -2.40036433e-01 -2.40036433e-01
 -2.40036433e-01  4.54014947e-01  2.22405150e+00  1.47757819e+01
  1.16664021e+02  6.15814480e+02  2.76048017e+03  1.22390182e+04
  4.08588985e+04  1.04901562e+05  2.30084436e+05  4.55899023e+05
  8.44851044e+05  1.52802810e+06  2.85029525e+06  5.80818224e+06]
E1 = -706.6746970557066  E_coul = 198.7000005298611
cycle= 3 E= -507.974696525846  delta_E= -0.000272  |g|= 0.00439  |ddm|= 0.0462
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00459091
diis-c [-2.91715099e-06 -3.82103271e-04 -1.32935051e-01  1.13331715e+00]
  HOMO = -0.243302295142486  LUMO = 0.453786108056636
  mo_energy =
[-1.20320422e+02 -1.23798098e+01 -6.67836096e+00 -6.67836096e+00
 -6.67836096e+00 -1.17967505e+00 -2.43302295e-01 -2.43302295e-01
 -2.43302295e-01  4.53786108e-01  2.22196670e+00  1.47686445e+01
  1.16653406e+02  6.15802521e+02  2.76046744e+03  1.22390050e+04
  4.08588852e+04  1.04901549e+05  2.30084423e+05  4.55899010e+05
  8.44851030e+05  1.52802809e+06  2.85029524e+06  5.80818223e+06]
E1 = -706.6583948098113  E_coul = 198.68369252100717
cycle= 4 E= -507.974702288804  delta_E= -5.76e-06  |g|= 0.000214  |ddm|= 0.00971
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000159093
diis-c [-1.53723061e-09 -8.45798767e-06  8.66558624e-03 -9.24142670e-02
  1.08375714e+00]
  HOMO = -0.243385741674869  LUMO = 0.453771268546549
  mo_energy =
[-1.20320459e+02 -1.23799445e+01 -6.67847566e+00 -6.67847566e+00
 -6.67847566e+00 -1.17972610e+00 -2.43385742e-01 -2.43385742e-01
 -2.43385742e-01  4.53771269e-01  2.22189218e+00  1.47685141e+01
  1.16653333e+02  6.15802489e+02  2.76046744e+03  1.22390050e+04
  4.08588852e+04  1.04901549e+05  2.30084423e+05  4.55899010e+05
  8.44851030e+05  1.52802809e+06  2.85029524e+06  5.80818223e+06]
E1 = -706.6579544465594  E_coul = 198.68325214362906
cycle= 5 E= -507.97470230293  delta_E= -1.41e-08  |g|= 1.44e-05  |ddm|= 0.00101
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.13747e-06
diis-c [-1.87993519e-12  1.08535220e-06 -1.14454623e-03  1.17427162e-02
 -1.55590692e-01  1.14499144e+00]
  HOMO = -0.243388208073676  LUMO = 0.453770714666568
  mo_energy =
[-1.20320461e+02 -1.23799466e+01 -6.67847765e+00 -6.67847765e+00
 -6.67847765e+00 -1.17972808e+00 -2.43388208e-01 -2.43388208e-01
 -2.43388208e-01  4.53770715e-01  2.22188926e+00  1.47685115e+01
  1.16653332e+02  6.15802487e+02  2.76046743e+03  1.22390050e+04
  4.08588852e+04  1.04901549e+05  2.30084423e+05  4.55899010e+05
  8.44851030e+05  1.52802809e+06  2.85029524e+06  5.80818223e+06]
E1 = -706.6579379129897  E_coul = 198.6832356100017
cycle= 6 E= -507.974702302988  delta_E= -5.76e-11  |g|= 4.53e-08  |ddm|= 8.13e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6579379129897  E_coul = 198.6832356100017
  HOMO = -0.243388227474367  LUMO = 0.453770692935393
  mo_energy =
[-1.20320461e+02 -1.23799466e+01 -6.67847768e+00 -6.67847768e+00
 -6.67847768e+00 -1.17972806e+00 -2.43388227e-01 -2.43388227e-01
 -2.43388227e-01  4.53770693e-01  2.22188923e+00  1.47685115e+01
  1.16653332e+02  6.15802487e+02  2.76046743e+03  1.22390050e+04
  4.08588852e+04  1.04901549e+05  2.30084423e+05  4.55899010e+05
  8.44851030e+05  1.52802809e+06  2.85029524e+06  5.80818223e+06]
E1 = -706.6579378994792  E_coul = 198.6832355964915
Extra cycle  E= -507.974702302988  delta_E= 3.41e-13  |g|= 2.96e-09  |ddm|= 3.36e-08
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907875.3937520396
E1 = -706.6579378994792  E_coul = 198.6832355964915
init E= -507.974702302988
    CPU time for initialize scf      3.27 sec, wall time      0.21 sec
  HOMO = -0.243388228087551  LUMO = 0.453770693622358
  mo_energy =
[-1.20320461e+02 -1.23799466e+01 -6.67847768e+00 -6.67847768e+00
 -6.67847768e+00 -1.17972807e+00 -2.43388228e-01 -2.43388228e-01
 -2.43388228e-01  4.53770694e-01  2.22188923e+00  1.47685115e+01
  1.16653332e+02  6.15802487e+02  2.76046743e+03  1.22390050e+04
  4.08588852e+04  1.04901549e+05  2.30084423e+05  4.55899010e+05
  8.44851030e+05  1.52802809e+06  2.85029524e+06  5.80818223e+06]
E1 = -706.6579378987327  E_coul = 198.68323559574472
cycle= 1 E= -507.974702302988  delta_E= -3.41e-13  |g|= 2.23e-09  |ddm|= 1.38e-09
    CPU time for cycle= 1      0.34 sec, wall time      0.04 sec
E1 = -706.6579378987327  E_coul = 198.68323559574472
  HOMO = -0.243388228133271  LUMO = 0.453770693587027
  mo_energy =
[-1.20320461e+02 -1.23799466e+01 -6.67847768e+00 -6.67847768e+00
 -6.67847768e+00 -1.17972806e+00 -2.43388228e-01 -2.43388228e-01
 -2.43388228e-01  4.53770694e-01  2.22188923e+00  1.47685115e+01
  1.16653332e+02  6.15802487e+02  2.76046743e+03  1.22390050e+04
  4.08588852e+04  1.04901549e+05  2.30084423e+05  4.55899010e+05
  8.44851030e+05  1.52802809e+06  2.85029524e+06  5.80818223e+06]
E1 = -706.6579378944165  E_coul = 198.68323559142877
Extra cycle  E= -507.974702302988  delta_E= 3.41e-13  |g|= 1.64e-09  |ddm|= 2.75e-09
    CPU time for scf_cycle      3.77 sec, wall time      0.41 sec
exp = [1.72468348e-01 3.28705341e-01 1.17616814e+05 6.87572968e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315502e+03 1.83757993e+04
 1.44908392e+03 3.76379720e+02 1.14557122e+02 3.82888563e+01
 8.42297075e+00 3.39963567e+00 8.60458702e+00 4.92625769e-01]
grad_E = [ 2.10573906e-03 -8.09923633e-03  4.32988944e-09 -5.87992154e-04
  2.05092841e-11  1.17564555e-10  6.73544731e-10  2.64305890e-09
  1.09860300e-08  5.89217878e-08  3.71413182e-06  1.28395541e-07
  7.29117599e-07 -4.16043161e-06  4.00254393e-05 -1.61617117e-04
  6.91395613e-04 -4.29414613e-03  5.46291126e-04 -3.25191614e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:06:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.196983216503       1
[INPUT] 0    0    [1    /1   ]  0.342300398544       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.692790840183       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200234        1
[INPUT] 0    0    [1    /1   ]  36754.7149406        1
[INPUT] 0    0    [1    /1   ]  7303.1550103         1
[INPUT] 0    0    [1    /1   ]  18375.7992852        1
[INPUT] 0    0    [1    /1   ]  1449.0839213         1
[INPUT] 0    0    [1    /1   ]  376.379724584        1
[INPUT] 0    0    [1    /1   ]  114.557068459        1
[INPUT] 0    0    [1    /1   ]  38.2890622365        1
[INPUT] 0    0    [1    /1   ]  8.42162506319        1
[INPUT] 0    0    [1    /1   ]  3.40777669653        1
[INPUT] 1    0    [1    /1   ]  8.60424263387        1
[INPUT] 1    0    [1    /1   ]  0.49262397409        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.19698321650282619, 1.0]], [0, [0.34230039854400945, 1.0]], [0, [117616.81386804656, 1.0]], [0, [0.6927908401831191, 1.0]], [0, [1176168.1426172438, 1.0]], [0, [588084.0699825102, 1.0]], [0, [294042.03107372706, 1.0]], [0, [147020.99191976571, 1.0]], [0, [73510.42002343966, 1.0]], [0, [36754.71494055277, 1.0]], [0, [7303.155010302689, 1.0]], [0, [18375.799285208224, 1.0]], [0, [1449.0839212951944, 1.0]], [0, [376.3797245840275, 1.0]], [0, [114.55706845928528, 1.0]], [0, [38.289062236515115, 1.0]], [0, [8.421625063186871, 1.0]], [0, [3.4077766965307834, 1.0]], [1, [8.60424263387347, 1.0]], [1, [0.4926239740903181, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.19698322]
bas 1, expnt(s) = [0.3423004]
bas 2, expnt(s) = [117616.81386805]
bas 3, expnt(s) = [0.69279084]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998251]
bas 6, expnt(s) = [294042.03107373]
bas 7, expnt(s) = [147020.99191977]
bas 8, expnt(s) = [73510.42002344]
bas 9, expnt(s) = [36754.71494055]
bas 10, expnt(s) = [7303.1550103]
bas 11, expnt(s) = [18375.79928521]
bas 12, expnt(s) = [1449.0839213]
bas 13, expnt(s) = [376.37972458]
bas 14, expnt(s) = [114.55706846]
bas 15, expnt(s) = [38.28906224]
bas 16, expnt(s) = [8.42162506]
bas 17, expnt(s) = [3.4077767]
bas 18, expnt(s) = [8.60424263]
bas 19, expnt(s) = [0.49262397]
CPU time:        86.08
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.96983217e-01 7.47028107e-01 3.42300399e-01 1.13063019e+00
 1.17616814e+05 1.60460109e+04 6.92790840e-01 1.91852131e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315501e+03 1.99594198e+03 1.83757993e+04 3.98749088e+03
 1.44908392e+03 5.93383106e+02 3.76379725e+02 2.15891075e+02
 1.14557068e+02 8.84670291e+01 3.82890622e+01 3.88884892e+01
 8.42162506e+00 1.24899860e+01 3.40777670e+00 6.33677622e+00
 8.60424263e+00 4.29907680e+01 4.92623974e-01 1.20400647e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336164341100325
cond(S) = 907879.1823661006
E1 = -689.579945983077  E_coul = 184.97395951349046
init E= -504.605986469587
    CPU time for initialize scf      0.43 sec, wall time      0.06 sec
  HOMO = -0.672153148706315  LUMO = 0.248372247530603
  mo_energy =
[-1.21703512e+02 -1.33844028e+01 -7.62324627e+00 -7.62324627e+00
 -7.62324627e+00 -1.65756312e+00 -6.72153149e-01 -6.72153149e-01
 -6.72153149e-01  2.48372248e-01  1.95138754e+00  1.41223693e+01
  1.15566516e+02  6.14606436e+02  2.75932365e+03  1.22379616e+04
  4.08579027e+04  1.04900600e+05  2.30083496e+05  4.55898098e+05
  8.44850131e+05  1.52802720e+06  2.85029436e+06  5.80818135e+06]
E1 = -707.7300056870445  E_coul = 199.77309184843
cycle= 1 E= -507.956913838614  delta_E= -3.35  |g|= 0.45  |ddm|= 0.463
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.652473
diis-c [-0.42572099  1.        ]
  HOMO = -0.217789060052366  LUMO = 0.512109070069092
  mo_energy =
[-1.20194752e+02 -1.23039771e+01 -6.59480071e+00 -6.59480071e+00
 -6.59480071e+00 -1.16330682e+00 -2.17789060e-01 -2.17789060e-01
 -2.17789060e-01  5.12109070e-01  2.39523797e+00  1.50617625e+01
  1.16965645e+02  6.16100821e+02  2.76075729e+03  1.22392864e+04
  4.08591610e+04  1.04901821e+05  2.30084693e+05  4.55899279e+05
  8.44851298e+05  1.52802835e+06  2.85029550e+06  5.80818249e+06]
E1 = -706.7869043154694  E_coul = 198.81241495551146
cycle= 2 E= -507.974489359958  delta_E= -0.0176  |g|= 0.0349  |ddm|= 0.372
    CPU time for cycle= 2      0.10 sec, wall time      0.03 sec
diis-norm(errvec)=0.0344453
diis-c [-0.00117624 -0.00493593  1.00493593]
  HOMO = -0.239899961696507  LUMO = 0.511235916825383
  mo_energy =
[-1.20308555e+02 -1.23709165e+01 -6.66893187e+00 -6.66893187e+00
 -6.66893187e+00 -1.17756425e+00 -2.39899962e-01 -2.39899962e-01
 -2.39899962e-01  5.11235917e-01  2.38253302e+00  1.50090037e+01
  1.16870365e+02  6.15982938e+02  2.76062338e+03  1.22391423e+04
  4.08590131e+04  1.04901672e+05  2.30084543e+05  4.55899128e+05
  8.44851147e+05  1.52802820e+06  2.85029535e+06  5.80818234e+06]
E1 = -706.677705543314  E_coul = 198.70294733890444
cycle= 3 E= -507.97475820441  delta_E= -0.000269  |g|= 0.00439  |ddm|= 0.0493
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00430182
diis-c [-2.62597668e-06 -3.65331766e-04 -1.29694911e-01  1.13006024e+00]
  HOMO = -0.243147435018673  LUMO = 0.510970051888561
  mo_energy =
[-1.20320379e+02 -1.23795954e+01 -6.67808240e+00 -6.67808240e+00
 -6.67808240e+00 -1.17954103e+00 -2.43147435e-01 -2.43147435e-01
 -2.43147435e-01  5.10970052e-01  2.38036635e+00  1.50018807e+01
  1.16859750e+02  6.15970962e+02  2.76061062e+03  1.22391291e+04
  4.08589998e+04  1.04901659e+05  2.30084529e+05  4.55899114e+05
  8.44851133e+05  1.52802819e+06  2.85029534e+06  5.80818232e+06]
E1 = -706.6615717791861  E_coul = 198.6868079019616
cycle= 4 E= -507.974763877225  delta_E= -5.67e-06  |g|= 0.000216  |ddm|= 0.0113
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000149581
diis-c [-1.20284884e-09 -7.71029459e-06  8.44389196e-03 -9.21197276e-02
  1.08368355e+00]
  HOMO = -0.24323940248584  LUMO = 0.510953082690155
  mo_energy =
[-1.20320453e+02 -1.23797551e+01 -6.67822382e+00 -6.67822382e+00
 -6.67822382e+00 -1.17959730e+00 -2.43239402e-01 -2.43239402e-01
 -2.43239402e-01  5.10953083e-01  2.38028479e+00  1.50017307e+01
  1.16859646e+02  6.15970893e+02  2.76061057e+03  1.22391290e+04
  4.08589997e+04  1.04901659e+05  2.30084529e+05  4.55899114e+05
  8.44851133e+05  1.52802819e+06  2.85029534e+06  5.80818232e+06]
E1 = -706.6610949741969  E_coul = 198.68633108276032
cycle= 5 E= -507.974763891437  delta_E= -1.42e-08  |g|= 1.39e-05  |ddm|= 0.00116
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.43404e-06
diis-c [-1.72986863e-12  1.03142954e-06 -1.11449024e-03  1.16878046e-02
 -1.53955842e-01  1.14338150e+00]
  HOMO = -0.243242493139089  LUMO = 0.510952426728322
  mo_energy =
[-1.20320457e+02 -1.23797588e+01 -6.67822758e+00 -6.67822758e+00
 -6.67822758e+00 -1.17959964e+00 -2.43242493e-01 -2.43242493e-01
 -2.43242493e-01  5.10952427e-01  2.38028146e+00  1.50017267e+01
  1.16859642e+02  6.15970889e+02  2.76061057e+03  1.22391290e+04
  4.08589997e+04  1.04901659e+05  2.30084529e+05  4.55899114e+05
  8.44851133e+05  1.52802819e+06  2.85029534e+06  5.80818232e+06]
E1 = -706.6610759771369  E_coul = 198.68631208564727
cycle= 6 E= -507.97476389149  delta_E= -5.3e-11  |g|= 4.59e-08  |ddm|= 8.9e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6610759771369  E_coul = 198.68631208564727
  HOMO = -0.243242513210937  LUMO = 0.510952406343201
  mo_energy =
[-1.20320457e+02 -1.23797588e+01 -6.67822761e+00 -6.67822761e+00
 -6.67822761e+00 -1.17959963e+00 -2.43242513e-01 -2.43242513e-01
 -2.43242513e-01  5.10952406e-01  2.38028143e+00  1.50017266e+01
  1.16859642e+02  6.15970889e+02  2.76061057e+03  1.22391290e+04
  4.08589997e+04  1.04901659e+05  2.30084529e+05  4.55899114e+05
  8.44851133e+05  1.52802819e+06  2.85029534e+06  5.80818232e+06]
E1 = -706.6610759507864  E_coul = 198.68631205929591
Extra cycle  E= -507.974763891491  delta_E= -9.09e-13  |g|= 2.32e-09  |ddm|= 4.36e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [1.96983217e-01 3.42300399e-01 1.17616814e+05 6.92790840e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315501e+03 1.83757993e+04
 1.44908392e+03 3.76379725e+02 1.14557068e+02 3.82890622e+01
 8.42162506e+00 3.40777670e+00 8.60424263e+00 4.92623974e-01]
E = -507.9747638914905
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:06:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.196983216503       1
[INPUT] 0    0    [1    /1   ]  0.342300398544       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.692790840183       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200234        1
[INPUT] 0    0    [1    /1   ]  36754.7149406        1
[INPUT] 0    0    [1    /1   ]  7303.1550103         1
[INPUT] 0    0    [1    /1   ]  18375.7992852        1
[INPUT] 0    0    [1    /1   ]  1449.0839213         1
[INPUT] 0    0    [1    /1   ]  376.379724584        1
[INPUT] 0    0    [1    /1   ]  114.557068459        1
[INPUT] 0    0    [1    /1   ]  38.2890622365        1
[INPUT] 0    0    [1    /1   ]  8.42162506319        1
[INPUT] 0    0    [1    /1   ]  3.40777669653        1
[INPUT] 1    0    [1    /1   ]  8.60424263387        1
[INPUT] 1    0    [1    /1   ]  0.49262397409        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.19698321650282619, 1.0]], [0, [0.34230039854400945, 1.0]], [0, [117616.81386804656, 1.0]], [0, [0.6927908401831191, 1.0]], [0, [1176168.1426172438, 1.0]], [0, [588084.0699825102, 1.0]], [0, [294042.03107372706, 1.0]], [0, [147020.99191976571, 1.0]], [0, [73510.42002343966, 1.0]], [0, [36754.71494055277, 1.0]], [0, [7303.155010302689, 1.0]], [0, [18375.799285208224, 1.0]], [0, [1449.0839212951944, 1.0]], [0, [376.3797245840275, 1.0]], [0, [114.55706845928528, 1.0]], [0, [38.289062236515115, 1.0]], [0, [8.421625063186871, 1.0]], [0, [3.4077766965307834, 1.0]], [1, [8.60424263387347, 1.0]], [1, [0.4926239740903181, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.19698322]
bas 1, expnt(s) = [0.3423004]
bas 2, expnt(s) = [117616.81386805]
bas 3, expnt(s) = [0.69279084]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998251]
bas 6, expnt(s) = [294042.03107373]
bas 7, expnt(s) = [147020.99191977]
bas 8, expnt(s) = [73510.42002344]
bas 9, expnt(s) = [36754.71494055]
bas 10, expnt(s) = [7303.1550103]
bas 11, expnt(s) = [18375.79928521]
bas 12, expnt(s) = [1449.0839213]
bas 13, expnt(s) = [376.37972458]
bas 14, expnt(s) = [114.55706846]
bas 15, expnt(s) = [38.28906224]
bas 16, expnt(s) = [8.42162506]
bas 17, expnt(s) = [3.4077767]
bas 18, expnt(s) = [8.60424263]
bas 19, expnt(s) = [0.49262397]
CPU time:        87.30
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.96983217e-01 7.47028107e-01 3.42300399e-01 1.13063019e+00
 1.17616814e+05 1.60460109e+04 6.92790840e-01 1.91852131e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315501e+03 1.99594198e+03 1.83757993e+04 3.98749088e+03
 1.44908392e+03 5.93383106e+02 3.76379725e+02 2.15891075e+02
 1.14557068e+02 8.84670291e+01 3.82890622e+01 3.88884892e+01
 8.42162506e+00 1.24899860e+01 3.40777670e+00 6.33677622e+00
 8.60424263e+00 4.29907680e+01 4.92623974e-01 1.20400647e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336164341100325
cond(S) = 907879.1823661006
E1 = -689.579945983077  E_coul = 184.97395951349046
init E= -504.605986469587
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672153148706315  LUMO = 0.248372247530603
  mo_energy =
[-1.21703512e+02 -1.33844028e+01 -7.62324627e+00 -7.62324627e+00
 -7.62324627e+00 -1.65756312e+00 -6.72153149e-01 -6.72153149e-01
 -6.72153149e-01  2.48372248e-01  1.95138754e+00  1.41223693e+01
  1.15566516e+02  6.14606436e+02  2.75932365e+03  1.22379616e+04
  4.08579027e+04  1.04900600e+05  2.30083496e+05  4.55898098e+05
  8.44850131e+05  1.52802720e+06  2.85029436e+06  5.80818135e+06]
E1 = -707.7300056870445  E_coul = 199.77309184843
cycle= 1 E= -507.956913838614  delta_E= -3.35  |g|= 0.45  |ddm|= 0.463
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.652473
diis-c [-0.42572099  1.        ]
  HOMO = -0.217789060052366  LUMO = 0.512109070069092
  mo_energy =
[-1.20194752e+02 -1.23039771e+01 -6.59480071e+00 -6.59480071e+00
 -6.59480071e+00 -1.16330682e+00 -2.17789060e-01 -2.17789060e-01
 -2.17789060e-01  5.12109070e-01  2.39523797e+00  1.50617625e+01
  1.16965645e+02  6.16100821e+02  2.76075729e+03  1.22392864e+04
  4.08591610e+04  1.04901821e+05  2.30084693e+05  4.55899279e+05
  8.44851298e+05  1.52802835e+06  2.85029550e+06  5.80818249e+06]
E1 = -706.7869043154694  E_coul = 198.81241495551146
cycle= 2 E= -507.974489359958  delta_E= -0.0176  |g|= 0.0349  |ddm|= 0.372
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0344453
diis-c [-0.00117624 -0.00493593  1.00493593]
  HOMO = -0.239899961696507  LUMO = 0.511235916825383
  mo_energy =
[-1.20308555e+02 -1.23709165e+01 -6.66893187e+00 -6.66893187e+00
 -6.66893187e+00 -1.17756425e+00 -2.39899962e-01 -2.39899962e-01
 -2.39899962e-01  5.11235917e-01  2.38253302e+00  1.50090037e+01
  1.16870365e+02  6.15982938e+02  2.76062338e+03  1.22391423e+04
  4.08590131e+04  1.04901672e+05  2.30084543e+05  4.55899128e+05
  8.44851147e+05  1.52802820e+06  2.85029535e+06  5.80818234e+06]
E1 = -706.677705543314  E_coul = 198.70294733890444
cycle= 3 E= -507.97475820441  delta_E= -0.000269  |g|= 0.00439  |ddm|= 0.0493
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00430182
diis-c [-2.62597668e-06 -3.65331766e-04 -1.29694911e-01  1.13006024e+00]
  HOMO = -0.243147435018673  LUMO = 0.510970051888561
  mo_energy =
[-1.20320379e+02 -1.23795954e+01 -6.67808240e+00 -6.67808240e+00
 -6.67808240e+00 -1.17954103e+00 -2.43147435e-01 -2.43147435e-01
 -2.43147435e-01  5.10970052e-01  2.38036635e+00  1.50018807e+01
  1.16859750e+02  6.15970962e+02  2.76061062e+03  1.22391291e+04
  4.08589998e+04  1.04901659e+05  2.30084529e+05  4.55899114e+05
  8.44851133e+05  1.52802819e+06  2.85029534e+06  5.80818232e+06]
E1 = -706.6615717791861  E_coul = 198.6868079019616
cycle= 4 E= -507.974763877225  delta_E= -5.67e-06  |g|= 0.000216  |ddm|= 0.0113
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000149581
diis-c [-1.20284884e-09 -7.71029459e-06  8.44389196e-03 -9.21197276e-02
  1.08368355e+00]
  HOMO = -0.24323940248584  LUMO = 0.510953082690155
  mo_energy =
[-1.20320453e+02 -1.23797551e+01 -6.67822382e+00 -6.67822382e+00
 -6.67822382e+00 -1.17959730e+00 -2.43239402e-01 -2.43239402e-01
 -2.43239402e-01  5.10953083e-01  2.38028479e+00  1.50017307e+01
  1.16859646e+02  6.15970893e+02  2.76061057e+03  1.22391290e+04
  4.08589997e+04  1.04901659e+05  2.30084529e+05  4.55899114e+05
  8.44851133e+05  1.52802819e+06  2.85029534e+06  5.80818232e+06]
E1 = -706.6610949741969  E_coul = 198.68633108276032
cycle= 5 E= -507.974763891437  delta_E= -1.42e-08  |g|= 1.39e-05  |ddm|= 0.00116
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.43404e-06
diis-c [-1.72986863e-12  1.03142954e-06 -1.11449024e-03  1.16878046e-02
 -1.53955842e-01  1.14338150e+00]
  HOMO = -0.243242493139089  LUMO = 0.510952426728322
  mo_energy =
[-1.20320457e+02 -1.23797588e+01 -6.67822758e+00 -6.67822758e+00
 -6.67822758e+00 -1.17959964e+00 -2.43242493e-01 -2.43242493e-01
 -2.43242493e-01  5.10952427e-01  2.38028146e+00  1.50017267e+01
  1.16859642e+02  6.15970889e+02  2.76061057e+03  1.22391290e+04
  4.08589997e+04  1.04901659e+05  2.30084529e+05  4.55899114e+05
  8.44851133e+05  1.52802819e+06  2.85029534e+06  5.80818232e+06]
E1 = -706.6610759771369  E_coul = 198.68631208564727
cycle= 6 E= -507.97476389149  delta_E= -5.3e-11  |g|= 4.59e-08  |ddm|= 8.9e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6610759771369  E_coul = 198.68631208564727
  HOMO = -0.243242513210937  LUMO = 0.510952406343201
  mo_energy =
[-1.20320457e+02 -1.23797588e+01 -6.67822761e+00 -6.67822761e+00
 -6.67822761e+00 -1.17959963e+00 -2.43242513e-01 -2.43242513e-01
 -2.43242513e-01  5.10952406e-01  2.38028143e+00  1.50017266e+01
  1.16859642e+02  6.15970889e+02  2.76061057e+03  1.22391290e+04
  4.08589997e+04  1.04901659e+05  2.30084529e+05  4.55899114e+05
  8.44851133e+05  1.52802819e+06  2.85029534e+06  5.80818232e+06]
E1 = -706.6610759507864  E_coul = 198.68631205929591
Extra cycle  E= -507.974763891491  delta_E= -9.09e-13  |g|= 2.32e-09  |ddm|= 4.36e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907879.1823661006
E1 = -706.6610759507864  E_coul = 198.68631205929591
init E= -507.974763891491
    CPU time for initialize scf      3.38 sec, wall time      0.21 sec
  HOMO = -0.243242514149805  LUMO = 0.510952406419
  mo_energy =
[-1.20320457e+02 -1.23797588e+01 -6.67822761e+00 -6.67822761e+00
 -6.67822761e+00 -1.17959963e+00 -2.43242514e-01 -2.43242514e-01
 -2.43242514e-01  5.10952406e-01  2.38028143e+00  1.50017266e+01
  1.16859642e+02  6.15970889e+02  2.76061057e+03  1.22391290e+04
  4.08589997e+04  1.04901659e+05  2.30084529e+05  4.55899114e+05
  8.44851133e+05  1.52802819e+06  2.85029534e+06  5.80818232e+06]
E1 = -706.6610759480989  E_coul = 198.6863120566092
cycle= 1 E= -507.97476389149  delta_E= 8.53e-13  |g|= 8.77e-10  |ddm|= 2.5e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6610759480989  E_coul = 198.6863120566092
  HOMO = -0.243242514229809  LUMO = 0.510952406309161
  mo_energy =
[-1.20320457e+02 -1.23797588e+01 -6.67822761e+00 -6.67822761e+00
 -6.67822761e+00 -1.17959963e+00 -2.43242514e-01 -2.43242514e-01
 -2.43242514e-01  5.10952406e-01  2.38028143e+00  1.50017266e+01
  1.16859642e+02  6.15970889e+02  2.76061057e+03  1.22391290e+04
  4.08589997e+04  1.04901659e+05  2.30084529e+05  4.55899114e+05
  8.44851133e+05  1.52802819e+06  2.85029534e+06  5.80818232e+06]
E1 = -706.6610759443131  E_coul = 198.6863120528232
Extra cycle  E= -507.97476389149  delta_E= -2.27e-13  |g|= 7.88e-10  |ddm|= 3.71e-09
    CPU time for scf_cycle      3.83 sec, wall time      0.38 sec
exp = [1.96983217e-01 3.42300399e-01 1.17616814e+05 6.92790840e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315501e+03 1.83757993e+04
 1.44908392e+03 3.76379725e+02 1.14557068e+02 3.82890622e+01
 8.42162506e+00 3.40777670e+00 8.60424263e+00 4.92623974e-01]
grad_E = [ 4.77105568e-03 -7.95198151e-03  4.32818473e-09  3.39113301e-04
  2.04890822e-11  1.17509232e-10  6.73280880e-10  2.64200541e-09
  1.09815892e-08  5.88998844e-08  3.71256203e-06  1.28328986e-07
  8.21778866e-07 -5.63958796e-06  5.35951119e-05 -2.24309251e-04
  5.72025431e-04 -3.96961030e-03  2.64386611e-04 -1.95900663e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:06:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.202338447798       1
[INPUT] 0    0    [1    /1   ]  0.3509886385         1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.696777749556       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200234        1
[INPUT] 0    0    [1    /1   ]  36754.7149404        1
[INPUT] 0    0    [1    /1   ]  7303.15500004        1
[INPUT] 0    0    [1    /1   ]  18375.7992849        1
[INPUT] 0    0    [1    /1   ]  1449.08391937        1
[INPUT] 0    0    [1    /1   ]  376.379734595        1
[INPUT] 0    0    [1    /1   ]  114.556969281        1
[INPUT] 0    0    [1    /1   ]  38.2894682628        1
[INPUT] 0    0    [1    /1   ]  8.42018097277        1
[INPUT] 0    0    [1    /1   ]  3.41727095187        1
[INPUT] 1    0    [1    /1   ]  8.6037328879         1
[INPUT] 1    0    [1    /1   ]  0.492608493955       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2023384477984491, 1.0]], [0, [0.3509886385001836, 1.0]], [0, [117616.8138680346, 1.0]], [0, [0.6967777495557874, 1.0]], [0, [1176168.1426172438, 1.0]], [0, [588084.0699825098, 1.0]], [0, [294042.0310737252, 1.0]], [0, [147020.9919197584, 1.0]], [0, [73510.4200234093, 1.0]], [0, [36754.71494038994, 1.0]], [0, [7303.155000038445, 1.0]], [0, [18375.79928485338, 1.0]], [0, [1449.083919373331, 1.0]], [0, [376.37973459548124, 1.0]], [0, [114.55696928089866, 1.0]], [0, [38.28946826275393, 1.0]], [0, [8.42018097276985, 1.0]], [0, [3.4172709518660875, 1.0]], [1, [8.60373288790422, 1.0]], [1, [0.49260849395489154, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.20233845]
bas 1, expnt(s) = [0.35098864]
bas 2, expnt(s) = [117616.81386803]
bas 3, expnt(s) = [0.69677775]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998251]
bas 6, expnt(s) = [294042.03107373]
bas 7, expnt(s) = [147020.99191976]
bas 8, expnt(s) = [73510.42002341]
bas 9, expnt(s) = [36754.71494039]
bas 10, expnt(s) = [7303.15500004]
bas 11, expnt(s) = [18375.79928485]
bas 12, expnt(s) = [1449.08391937]
bas 13, expnt(s) = [376.3797346]
bas 14, expnt(s) = [114.55696928]
bas 15, expnt(s) = [38.28946826]
bas 16, expnt(s) = [8.42018097]
bas 17, expnt(s) = [3.41727095]
bas 18, expnt(s) = [8.60373289]
bas 19, expnt(s) = [0.49260849]
CPU time:        98.91
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.02338448e-01 7.62208583e-01 3.50988639e-01 1.15208579e+00
 1.17616814e+05 1.60460109e+04 6.96777750e-01 1.92679597e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315500e+03 1.99594198e+03 1.83757993e+04 3.98749088e+03
 1.44908392e+03 5.93383105e+02 3.76379735e+02 2.15891080e+02
 1.14556969e+02 8.84669716e+01 3.82894683e+01 3.88887985e+01
 8.42018097e+00 1.24883797e+01 3.41727095e+00 6.35001258e+00
 8.60373289e+00 4.29875844e+01 4.92608494e-01 1.20395918e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33617211851771
cond(S) = 907880.9116525522
E1 = -689.5770002367933  E_coul = 184.97120955431024
init E= -504.605790682483
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672164902699758  LUMO = 0.262106652335474
  mo_energy =
[-1.21704072e+02 -1.33846369e+01 -7.62343330e+00 -7.62343330e+00
 -7.62343330e+00 -1.65760194e+00 -6.72164903e-01 -6.72164903e-01
 -6.72164903e-01  2.62106652e-01  2.00679040e+00  1.42336384e+01
  1.15676482e+02  6.14697414e+02  2.75940107e+03  1.22380286e+04
  4.08579645e+04  1.04900659e+05  2.30083553e+05  4.55898155e+05
  8.44850186e+05  1.52802725e+06  2.85029441e+06  5.80818140e+06]
E1 = -707.7281132951312  E_coul = 199.77112233061703
cycle= 1 E= -507.956990964514  delta_E= -3.35  |g|= 0.45  |ddm|= 0.47
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.651034
diis-c [-0.42384555  1.        ]
  HOMO = -0.217807467521422  LUMO = 0.529121093828794
  mo_energy =
[-1.20195238e+02 -1.23041381e+01 -6.59489987e+00 -6.59489987e+00
 -6.59489987e+00 -1.16333103e+00 -2.17807468e-01 -2.17807468e-01
 -2.17807468e-01  5.29121094e-01  2.45402433e+00  1.51732974e+01
  1.17075616e+02  6.16191836e+02  2.76083475e+03  1.22393534e+04
  4.08592229e+04  1.04901881e+05  2.30084751e+05  4.55899335e+05
  8.44851353e+05  1.52802841e+06  2.85029556e+06  5.80818254e+06]
E1 = -706.7851253674958  E_coul = 198.81056037884682
cycle= 2 E= -507.974564988649  delta_E= -0.0176  |g|= 0.0349  |ddm|= 0.368
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0340839
diis-c [-0.00115285 -0.00459924  1.00459924]
  HOMO = -0.239894676169675  LUMO = 0.528184410278357
  mo_energy =
[-1.20309002e+02 -1.23710556e+01 -6.66900686e+00 -6.66900686e+00
 -6.66900686e+00 -1.17757160e+00 -2.39894676e-01 -2.39894676e-01
 -2.39894676e-01  5.28184410e-01  2.44104509e+00  1.51204793e+01
  1.16980371e+02  6.16073996e+02  2.76070089e+03  1.22392094e+04
  4.08590751e+04  1.04901731e+05  2.30084601e+05  4.55899184e+05
  8.44851202e+05  1.52802826e+06  2.85029541e+06  5.80818239e+06]
E1 = -706.6761594870081  E_coul = 198.70132661227848
cycle= 3 E= -507.97483287473  delta_E= -0.000268  |g|= 0.00439  |ddm|= 0.0497
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00424224
diis-c [-2.56807046e-06 -3.63054048e-04 -1.29166259e-01  1.12952931e+00]
  HOMO = -0.24313819379727  LUMO = 0.527905790758479
  mo_energy =
[-1.20320837e+02 -1.23797340e+01 -6.67815874e+00 -6.67815874e+00
 -6.67815874e+00 -1.17954600e+00 -2.43138194e-01 -2.43138194e-01
 -2.43138194e-01  5.27905791e-01  2.43884081e+00  1.51133519e+01
  1.16969750e+02  6.16062008e+02  2.76068812e+03  1.22391961e+04
  4.08590617e+04  1.04901718e+05  2.30084587e+05  4.55899171e+05
  8.44851189e+05  1.52802824e+06  2.85029539e+06  5.80818237e+06]
E1 = -706.6600669678788  E_coul = 198.68522844783604
cycle= 4 E= -507.974838520043  delta_E= -5.65e-06  |g|= 0.000216  |ddm|= 0.0115
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000147423
diis-c [-1.15115639e-09 -7.64106943e-06  8.40533148e-03 -9.19672928e-02
  1.08356960e+00]
  HOMO = -0.243231301566628  LUMO = 0.527888199994989
  mo_energy =
[-1.20320916e+02 -1.23798972e+01 -6.67830409e+00 -6.67830409e+00
 -6.67830409e+00 -1.17960296e+00 -2.43231302e-01 -2.43231302e-01
 -2.43231302e-01  5.27888200e-01  2.43875761e+00  1.51131991e+01
  1.16969641e+02  6.16061934e+02  2.76068806e+03  1.22391961e+04
  4.08590617e+04  1.04901718e+05  2.30084587e+05  4.55899171e+05
  8.44851189e+05  1.52802824e+06  2.85029539e+06  5.80818237e+06]
E1 = -706.6595863546686  E_coul = 198.68474782057967
cycle= 5 E= -507.974838534089  delta_E= -1.4e-08  |g|= 1.37e-05  |ddm|= 0.00117
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.28467e-06
diis-c [-1.68295350e-12  1.01780659e-06 -1.10546860e-03  1.16248799e-02
 -1.52993394e-01  1.14247297e+00]
  HOMO = -0.243234470114304  LUMO = 0.527887522117645
  mo_energy =
[-1.20320920e+02 -1.23799012e+01 -6.67830810e+00 -6.67830810e+00
 -6.67830810e+00 -1.17960534e+00 -2.43234470e-01 -2.43234470e-01
 -2.43234470e-01  5.27887522e-01  2.43875422e+00  1.51131949e+01
  1.16969637e+02  6.16061929e+02  2.76068806e+03  1.22391961e+04
  4.08590617e+04  1.04901718e+05  2.30084587e+05  4.55899171e+05
  8.44851189e+05  1.52802824e+06  2.85029539e+06  5.80818237e+06]
E1 = -706.6595671675328  E_coul = 198.6847286333928
cycle= 6 E= -507.97483853414  delta_E= -5.11e-11  |g|= 4.64e-08  |ddm|= 8.82e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6595671675328  E_coul = 198.6847286333928
  HOMO = -0.243234489999185  LUMO = 0.527887501735076
  mo_energy =
[-1.20320920e+02 -1.23799013e+01 -6.67830813e+00 -6.67830813e+00
 -6.67830813e+00 -1.17960533e+00 -2.43234490e-01 -2.43234490e-01
 -2.43234490e-01  5.27887502e-01  2.43875419e+00  1.51131948e+01
  1.16969637e+02  6.16061929e+02  2.76068806e+03  1.22391961e+04
  4.08590617e+04  1.04901718e+05  2.30084587e+05  4.55899171e+05
  8.44851189e+05  1.52802824e+06  2.85029539e+06  5.80818237e+06]
E1 = -706.6595671368789  E_coul = 198.68472860273943
Extra cycle  E= -507.974838534139  delta_E= 5.68e-13  |g|= 2.32e-09  |ddm|= 5.07e-08
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
exp = [2.02338448e-01 3.50988639e-01 1.17616814e+05 6.96777750e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315500e+03 1.83757993e+04
 1.44908392e+03 3.76379735e+02 1.14556969e+02 3.82894683e+01
 8.42018097e+00 3.41727095e+00 8.60373289e+00 4.92608494e-01]
E = -507.97483853413945
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:07:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.202338447798       1
[INPUT] 0    0    [1    /1   ]  0.3509886385         1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.696777749556       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200234        1
[INPUT] 0    0    [1    /1   ]  36754.7149404        1
[INPUT] 0    0    [1    /1   ]  7303.15500004        1
[INPUT] 0    0    [1    /1   ]  18375.7992849        1
[INPUT] 0    0    [1    /1   ]  1449.08391937        1
[INPUT] 0    0    [1    /1   ]  376.379734595        1
[INPUT] 0    0    [1    /1   ]  114.556969281        1
[INPUT] 0    0    [1    /1   ]  38.2894682628        1
[INPUT] 0    0    [1    /1   ]  8.42018097277        1
[INPUT] 0    0    [1    /1   ]  3.41727095187        1
[INPUT] 1    0    [1    /1   ]  8.6037328879         1
[INPUT] 1    0    [1    /1   ]  0.492608493955       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2023384477984491, 1.0]], [0, [0.3509886385001836, 1.0]], [0, [117616.8138680346, 1.0]], [0, [0.6967777495557874, 1.0]], [0, [1176168.1426172438, 1.0]], [0, [588084.0699825098, 1.0]], [0, [294042.0310737252, 1.0]], [0, [147020.9919197584, 1.0]], [0, [73510.4200234093, 1.0]], [0, [36754.71494038994, 1.0]], [0, [7303.155000038445, 1.0]], [0, [18375.79928485338, 1.0]], [0, [1449.083919373331, 1.0]], [0, [376.37973459548124, 1.0]], [0, [114.55696928089866, 1.0]], [0, [38.28946826275393, 1.0]], [0, [8.42018097276985, 1.0]], [0, [3.4172709518660875, 1.0]], [1, [8.60373288790422, 1.0]], [1, [0.49260849395489154, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.20233845]
bas 1, expnt(s) = [0.35098864]
bas 2, expnt(s) = [117616.81386803]
bas 3, expnt(s) = [0.69677775]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998251]
bas 6, expnt(s) = [294042.03107373]
bas 7, expnt(s) = [147020.99191976]
bas 8, expnt(s) = [73510.42002341]
bas 9, expnt(s) = [36754.71494039]
bas 10, expnt(s) = [7303.15500004]
bas 11, expnt(s) = [18375.79928485]
bas 12, expnt(s) = [1449.08391937]
bas 13, expnt(s) = [376.3797346]
bas 14, expnt(s) = [114.55696928]
bas 15, expnt(s) = [38.28946826]
bas 16, expnt(s) = [8.42018097]
bas 17, expnt(s) = [3.41727095]
bas 18, expnt(s) = [8.60373289]
bas 19, expnt(s) = [0.49260849]
CPU time:       100.11
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.02338448e-01 7.62208583e-01 3.50988639e-01 1.15208579e+00
 1.17616814e+05 1.60460109e+04 6.96777750e-01 1.92679597e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315500e+03 1.99594198e+03 1.83757993e+04 3.98749088e+03
 1.44908392e+03 5.93383105e+02 3.76379735e+02 2.15891080e+02
 1.14556969e+02 8.84669716e+01 3.82894683e+01 3.88887985e+01
 8.42018097e+00 1.24883797e+01 3.41727095e+00 6.35001258e+00
 8.60373289e+00 4.29875844e+01 4.92608494e-01 1.20395918e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33617211851771
cond(S) = 907880.9116525522
E1 = -689.5770002367933  E_coul = 184.97120955431024
init E= -504.605790682483
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672164902699758  LUMO = 0.262106652335474
  mo_energy =
[-1.21704072e+02 -1.33846369e+01 -7.62343330e+00 -7.62343330e+00
 -7.62343330e+00 -1.65760194e+00 -6.72164903e-01 -6.72164903e-01
 -6.72164903e-01  2.62106652e-01  2.00679040e+00  1.42336384e+01
  1.15676482e+02  6.14697414e+02  2.75940107e+03  1.22380286e+04
  4.08579645e+04  1.04900659e+05  2.30083553e+05  4.55898155e+05
  8.44850186e+05  1.52802725e+06  2.85029441e+06  5.80818140e+06]
E1 = -707.7281132951312  E_coul = 199.77112233061703
cycle= 1 E= -507.956990964514  delta_E= -3.35  |g|= 0.45  |ddm|= 0.47
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.651034
diis-c [-0.42384555  1.        ]
  HOMO = -0.217807467521422  LUMO = 0.529121093828794
  mo_energy =
[-1.20195238e+02 -1.23041381e+01 -6.59489987e+00 -6.59489987e+00
 -6.59489987e+00 -1.16333103e+00 -2.17807468e-01 -2.17807468e-01
 -2.17807468e-01  5.29121094e-01  2.45402433e+00  1.51732974e+01
  1.17075616e+02  6.16191836e+02  2.76083475e+03  1.22393534e+04
  4.08592229e+04  1.04901881e+05  2.30084751e+05  4.55899335e+05
  8.44851353e+05  1.52802841e+06  2.85029556e+06  5.80818254e+06]
E1 = -706.7851253674958  E_coul = 198.81056037884682
cycle= 2 E= -507.974564988649  delta_E= -0.0176  |g|= 0.0349  |ddm|= 0.368
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0340839
diis-c [-0.00115285 -0.00459924  1.00459924]
  HOMO = -0.239894676169675  LUMO = 0.528184410278357
  mo_energy =
[-1.20309002e+02 -1.23710556e+01 -6.66900686e+00 -6.66900686e+00
 -6.66900686e+00 -1.17757160e+00 -2.39894676e-01 -2.39894676e-01
 -2.39894676e-01  5.28184410e-01  2.44104509e+00  1.51204793e+01
  1.16980371e+02  6.16073996e+02  2.76070089e+03  1.22392094e+04
  4.08590751e+04  1.04901731e+05  2.30084601e+05  4.55899184e+05
  8.44851202e+05  1.52802826e+06  2.85029541e+06  5.80818239e+06]
E1 = -706.6761594870081  E_coul = 198.70132661227848
cycle= 3 E= -507.97483287473  delta_E= -0.000268  |g|= 0.00439  |ddm|= 0.0497
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00424224
diis-c [-2.56807046e-06 -3.63054048e-04 -1.29166259e-01  1.12952931e+00]
  HOMO = -0.24313819379727  LUMO = 0.527905790758479
  mo_energy =
[-1.20320837e+02 -1.23797340e+01 -6.67815874e+00 -6.67815874e+00
 -6.67815874e+00 -1.17954600e+00 -2.43138194e-01 -2.43138194e-01
 -2.43138194e-01  5.27905791e-01  2.43884081e+00  1.51133519e+01
  1.16969750e+02  6.16062008e+02  2.76068812e+03  1.22391961e+04
  4.08590617e+04  1.04901718e+05  2.30084587e+05  4.55899171e+05
  8.44851189e+05  1.52802824e+06  2.85029539e+06  5.80818237e+06]
E1 = -706.6600669678788  E_coul = 198.68522844783604
cycle= 4 E= -507.974838520043  delta_E= -5.65e-06  |g|= 0.000216  |ddm|= 0.0115
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000147423
diis-c [-1.15115639e-09 -7.64106943e-06  8.40533148e-03 -9.19672928e-02
  1.08356960e+00]
  HOMO = -0.243231301566628  LUMO = 0.527888199994989
  mo_energy =
[-1.20320916e+02 -1.23798972e+01 -6.67830409e+00 -6.67830409e+00
 -6.67830409e+00 -1.17960296e+00 -2.43231302e-01 -2.43231302e-01
 -2.43231302e-01  5.27888200e-01  2.43875761e+00  1.51131991e+01
  1.16969641e+02  6.16061934e+02  2.76068806e+03  1.22391961e+04
  4.08590617e+04  1.04901718e+05  2.30084587e+05  4.55899171e+05
  8.44851189e+05  1.52802824e+06  2.85029539e+06  5.80818237e+06]
E1 = -706.6595863546686  E_coul = 198.68474782057967
cycle= 5 E= -507.974838534089  delta_E= -1.4e-08  |g|= 1.37e-05  |ddm|= 0.00117
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.28467e-06
diis-c [-1.68295350e-12  1.01780659e-06 -1.10546860e-03  1.16248799e-02
 -1.52993394e-01  1.14247297e+00]
  HOMO = -0.243234470114304  LUMO = 0.527887522117645
  mo_energy =
[-1.20320920e+02 -1.23799012e+01 -6.67830810e+00 -6.67830810e+00
 -6.67830810e+00 -1.17960534e+00 -2.43234470e-01 -2.43234470e-01
 -2.43234470e-01  5.27887522e-01  2.43875422e+00  1.51131949e+01
  1.16969637e+02  6.16061929e+02  2.76068806e+03  1.22391961e+04
  4.08590617e+04  1.04901718e+05  2.30084587e+05  4.55899171e+05
  8.44851189e+05  1.52802824e+06  2.85029539e+06  5.80818237e+06]
E1 = -706.6595671675328  E_coul = 198.6847286333928
cycle= 6 E= -507.97483853414  delta_E= -5.11e-11  |g|= 4.64e-08  |ddm|= 8.82e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6595671675328  E_coul = 198.6847286333928
  HOMO = -0.243234489999185  LUMO = 0.527887501735076
  mo_energy =
[-1.20320920e+02 -1.23799013e+01 -6.67830813e+00 -6.67830813e+00
 -6.67830813e+00 -1.17960533e+00 -2.43234490e-01 -2.43234490e-01
 -2.43234490e-01  5.27887502e-01  2.43875419e+00  1.51131948e+01
  1.16969637e+02  6.16061929e+02  2.76068806e+03  1.22391961e+04
  4.08590617e+04  1.04901718e+05  2.30084587e+05  4.55899171e+05
  8.44851189e+05  1.52802824e+06  2.85029539e+06  5.80818237e+06]
E1 = -706.6595671368789  E_coul = 198.68472860273943
Extra cycle  E= -507.974838534139  delta_E= 5.68e-13  |g|= 2.32e-09  |ddm|= 5.07e-08
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907880.9116525522
E1 = -706.6595671368789  E_coul = 198.68472860273943
init E= -507.974838534139
    CPU time for initialize scf      3.26 sec, wall time      0.21 sec
  HOMO = -0.243234491033126  LUMO = 0.527887501664724
  mo_energy =
[-1.20320920e+02 -1.23799013e+01 -6.67830813e+00 -6.67830813e+00
 -6.67830813e+00 -1.17960533e+00 -2.43234491e-01 -2.43234491e-01
 -2.43234491e-01  5.27887502e-01  2.43875419e+00  1.51131948e+01
  1.16969637e+02  6.16061929e+02  2.76068806e+03  1.22391961e+04
  4.08590617e+04  1.04901718e+05  2.30084587e+05  4.55899171e+05
  8.44851189e+05  1.52802824e+06  2.85029539e+06  5.80818237e+06]
E1 = -706.6595671333896  E_coul = 198.68472859925015
cycle= 1 E= -507.974838534139  delta_E=    0  |g|= 1.08e-09  |ddm|= 3.29e-09
    CPU time for cycle= 1      0.32 sec, wall time      0.03 sec
E1 = -706.6595671333896  E_coul = 198.68472859925015
  HOMO = -0.243234491133256  LUMO = 0.527887501775495
  mo_energy =
[-1.20320920e+02 -1.23799013e+01 -6.67830813e+00 -6.67830813e+00
 -6.67830813e+00 -1.17960533e+00 -2.43234491e-01 -2.43234491e-01
 -2.43234491e-01  5.27887502e-01  2.43875419e+00  1.51131948e+01
  1.16969637e+02  6.16061929e+02  2.76068806e+03  1.22391961e+04
  4.08590617e+04  1.04901718e+05  2.30084587e+05  4.55899171e+05
  8.44851189e+05  1.52802824e+06  2.85029539e+06  5.80818237e+06]
E1 = -706.6595671329536  E_coul = 198.68472859881382
Extra cycle  E= -507.97483853414  delta_E= -3.41e-13  |g|= 5.4e-10  |ddm|= 5.04e-10
    CPU time for scf_cycle      3.72 sec, wall time      0.37 sec
exp = [2.02338448e-01 3.50988639e-01 1.17616814e+05 6.96777750e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315500e+03 1.83757993e+04
 1.44908392e+03 3.76379735e+02 1.14556969e+02 3.82894683e+01
 8.42018097e+00 3.41727095e+00 8.60373289e+00 4.92608494e-01]
grad_E = [ 5.58040329e-03 -7.81185251e-03  4.32689228e-09  2.73877027e-04
  2.04737135e-11  1.17467377e-10  6.73080606e-10  2.64120694e-09
  1.09782252e-08  5.88832429e-08  3.71135752e-06  1.28278953e-07
  8.93860579e-07 -6.79314961e-06  6.48926579e-05 -2.80343635e-04
  3.33297282e-04 -3.26120325e-03 -1.42183390e-04 -1.75674306e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:07:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.198228463285       1
[INPUT] 0    0    [1    /1   ]  0.391724332347       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.718945358758       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200232        1
[INPUT] 0    0    [1    /1   ]  36754.7149395        1
[INPUT] 0    0    [1    /1   ]  7303.15494516        1
[INPUT] 0    0    [1    /1   ]  18375.799283         1
[INPUT] 0    0    [1    /1   ]  1449.08390805        1
[INPUT] 0    0    [1    /1   ]  376.37980484         1
[INPUT] 0    0    [1    /1   ]  114.556288493        1
[INPUT] 0    0    [1    /1   ]  38.2923174669        1
[INPUT] 0    0    [1    /1   ]  8.41277549908        1
[INPUT] 0    0    [1    /1   ]  3.47076316556        1
[INPUT] 1    0    [1    /1   ]  8.60211455591        1
[INPUT] 1    0    [1    /1   ]  0.492576368578       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.19822846328529115, 1.0]], [0, [0.39172433234680054, 1.0]], [0, [117616.81386797063, 1.0]], [0, [0.7189453587583459, 1.0]], [0, [1176168.1426172436, 1.0]], [0, [588084.0699825081, 1.0]], [0, [294042.03107371525, 1.0]], [0, [147020.99191971935, 1.0]], [0, [73510.42002324699, 1.0]], [0, [36754.71493951937, 1.0]], [0, [7303.154945163236, 1.0]], [0, [18375.799282956432, 1.0]], [0, [1449.0839080505234, 1.0]], [0, [376.37980483996097, 1.0]], [0, [114.5562884926074, 1.0]], [0, [38.29231746686619, 1.0]], [0, [8.412775499081063, 1.0]], [0, [3.470763165561785, 1.0]], [1, [8.602114555907797, 1.0]], [1, [0.4925763685776894, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.19822846]
bas 1, expnt(s) = [0.39172433]
bas 2, expnt(s) = [117616.81386797]
bas 3, expnt(s) = [0.71894536]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998251]
bas 6, expnt(s) = [294042.03107372]
bas 7, expnt(s) = [147020.99191972]
bas 8, expnt(s) = [73510.42002325]
bas 9, expnt(s) = [36754.71493952]
bas 10, expnt(s) = [7303.15494516]
bas 11, expnt(s) = [18375.79928296]
bas 12, expnt(s) = [1449.08390805]
bas 13, expnt(s) = [376.37980484]
bas 14, expnt(s) = [114.55628849]
bas 15, expnt(s) = [38.29231747]
bas 16, expnt(s) = [8.4127755]
bas 17, expnt(s) = [3.47076317]
bas 18, expnt(s) = [8.60211456]
bas 19, expnt(s) = [0.49257637]
CPU time:       111.56
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.98228463e-01 7.50567119e-01 3.91724332e-01 1.25098020e+00
 1.17616814e+05 1.60460109e+04 7.18945359e-01 1.97259050e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315495e+03 1.99594197e+03 1.83757993e+04 3.98749088e+03
 1.44908391e+03 5.93383102e+02 3.76379805e+02 2.15891110e+02
 1.14556288e+02 8.84665773e+01 3.82923175e+01 3.88909688e+01
 8.41277550e+00 1.24801412e+01 3.47076317e+00 6.42441754e+00
 8.60211456e+00 4.29774773e+01 4.92576369e-01 1.20386104e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336256698364664
cond(S) = 907886.9922022994
E1 = -689.5654014331698  E_coul = 184.96038308926225
init E= -504.605018343908
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672243370644979  LUMO = 0.279928897583261
  mo_energy =
[-1.21706089e+02 -1.33855444e+01 -7.62421963e+00 -7.62421963e+00
 -7.62421963e+00 -1.65776025e+00 -6.72243371e-01 -6.72243371e-01
 -6.72243371e-01  2.79928898e-01  2.15299043e+00  1.46474043e+01
  1.16128365e+02  6.15076816e+02  2.75972480e+03  1.22383090e+04
  4.08582235e+04  1.04900907e+05  2.30083794e+05  4.55898390e+05
  8.44850418e+05  1.52802748e+06  2.85029464e+06  5.80818162e+06]
E1 = -707.7212905420371  E_coul = 199.76393474188367
cycle= 1 E= -507.957355800153  delta_E= -3.35  |g|= 0.45  |ddm|= 0.447
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.649462
diis-c [-0.42180055  1.        ]
  HOMO = -0.217884208723207  LUMO = 0.552809013675288
  mo_energy =
[-1.20196988e+02 -1.23046882e+01 -6.59526841e+00 -6.59526841e+00
 -6.59526841e+00 -1.16349488e+00 -2.17884209e-01 -2.17884209e-01
 -2.17884209e-01  5.52809014e-01  2.61261410e+00  1.55895954e+01
  1.17527639e+02  6.16571338e+02  2.76115853e+03  1.22396338e+04
  4.08594817e+04  1.04902129e+05  2.30084992e+05  4.55899571e+05
  8.44851585e+05  1.52802863e+06  2.85029578e+06  5.80818276e+06]
E1 = -706.775541425164  E_coul = 198.80056052927864
cycle= 2 E= -507.974980895885  delta_E= -0.0176  |g|= 0.0349  |ddm|= 0.359
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0344216
diis-c [-0.0011762  -0.00455663  1.00455663]
  HOMO = -0.240027435977476  LUMO = 0.551728024578183
  mo_energy =
[-1.20310998e+02 -1.23718405e+01 -6.66961186e+00 -6.66961186e+00
 -6.66961186e+00 -1.17777075e+00 -2.40027436e-01 -2.40027436e-01
 -2.40027436e-01  5.51728025e-01  2.59862930e+00  1.55362062e+01
  1.17432160e+02  6.16453257e+02  2.76102442e+03  1.22394895e+04
  4.08593337e+04  1.04901979e+05  2.30084841e+05  4.55899420e+05
  8.44851434e+05  1.52802848e+06  2.85029563e+06  5.80818261e+06]
E1 = -706.6663007813075  E_coul = 198.69105150628064
cycle= 3 E= -507.975249275027  delta_E= -0.000268  |g|= 0.0044  |ddm|= 0.046
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00433296
diis-c [-2.64465874e-06 -3.77841264e-04 -1.30976181e-01  1.13135402e+00]
  HOMO = -0.243283452578377  LUMO = 0.551417870508682
  mo_energy =
[-1.20322892e+02 -1.23805607e+01 -6.67880802e+00 -6.67880802e+00
 -6.67880802e+00 -1.17975217e+00 -2.43283453e-01 -2.43283453e-01
 -2.43283453e-01  5.51417871e-01  2.59627321e+00  1.55290097e+01
  1.17421489e+02  6.16441211e+02  2.76101159e+03  1.22394762e+04
  4.08593202e+04  1.04901966e+05  2.30084828e+05  4.55899406e+05
  8.44851420e+05  1.52802847e+06  2.85029562e+06  5.80818259e+06]
E1 = -706.6501590396275  E_coul = 198.67490412459046
cycle= 4 E= -507.975254915037  delta_E= -5.64e-06  |g|= 0.000211  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000147259
diis-c [-1.22828390e-09 -8.52245932e-06  8.43714214e-03 -9.06078229e-02
  1.08217920e+00]
  HOMO = -0.243370740089042  LUMO = 0.551399438118536
  mo_energy =
[-1.20322948e+02 -1.23807075e+01 -6.67893596e+00 -6.67893596e+00
 -6.67893596e+00 -1.17980555e+00 -2.43370740e-01 -2.43370740e-01
 -2.43370740e-01  5.51399438e-01  2.59619026e+00  1.55288705e+01
  1.17421400e+02  6.16441159e+02  2.76101156e+03  1.22394762e+04
  4.08593202e+04  1.04901966e+05  2.30084828e+05  4.55899406e+05
  8.44851420e+05  1.52802847e+06  2.85029562e+06  5.80818259e+06]
E1 = -706.6497100240708  E_coul = 198.67445509625028
cycle= 5 E= -507.975254927821  delta_E= -1.28e-08  |g|= 1.29e-05  |ddm|= 0.00102
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.27723e-06
diis-c [-1.59522709e-12  9.77663695e-07 -1.08596289e-03  1.11981207e-02
 -1.48980154e-01  1.13886702e+00]
  HOMO = -0.243373596974609  LUMO = 0.55139876895561
  mo_energy =
[-1.20322951e+02 -1.23807108e+01 -6.67893920e+00 -6.67893920e+00
 -6.67893920e+00 -1.17980773e+00 -2.43373597e-01 -2.43373597e-01
 -2.43373597e-01  5.51398769e-01  2.59618703e+00  1.55288669e+01
  1.17421397e+02  6.16441156e+02  2.76101156e+03  1.22394762e+04
  4.08593202e+04  1.04901966e+05  2.30084828e+05  4.55899406e+05
  8.44851420e+05  1.52802847e+06  2.85029562e+06  5.80818259e+06]
E1 = -706.6496926966292  E_coul = 198.67443776876593
cycle= 6 E= -507.975254927863  delta_E= -4.28e-11  |g|= 4.89e-08  |ddm|= 7.43e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6496926966292  E_coul = 198.67443776876593
  HOMO = -0.24337361522853  LUMO = 0.551398747669811
  mo_energy =
[-1.20322951e+02 -1.23807108e+01 -6.67893924e+00 -6.67893924e+00
 -6.67893924e+00 -1.17980772e+00 -2.43373615e-01 -2.43373615e-01
 -2.43373615e-01  5.51398748e-01  2.59618701e+00  1.55288669e+01
  1.17421397e+02  6.16441156e+02  2.76101156e+03  1.22394762e+04
  4.08593202e+04  1.04901966e+05  2.30084828e+05  4.55899406e+05
  8.44851420e+05  1.52802847e+06  2.85029562e+06  5.80818259e+06]
E1 = -706.6496926797894  E_coul = 198.67443775192575
Extra cycle  E= -507.975254927864  delta_E= -2.84e-13  |g|= 2.8e-09  |ddm|= 1.04e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [1.98228463e-01 3.91724332e-01 1.17616814e+05 7.18945359e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315495e+03 1.83757993e+04
 1.44908391e+03 3.76379805e+02 1.14556288e+02 3.82923175e+01
 8.41277550e+00 3.47076317e+00 8.60211456e+00 4.92576369e-01]
E = -507.9752549278636
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:07:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.198228463285       1
[INPUT] 0    0    [1    /1   ]  0.391724332347       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.718945358758       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200232        1
[INPUT] 0    0    [1    /1   ]  36754.7149395        1
[INPUT] 0    0    [1    /1   ]  7303.15494516        1
[INPUT] 0    0    [1    /1   ]  18375.799283         1
[INPUT] 0    0    [1    /1   ]  1449.08390805        1
[INPUT] 0    0    [1    /1   ]  376.37980484         1
[INPUT] 0    0    [1    /1   ]  114.556288493        1
[INPUT] 0    0    [1    /1   ]  38.2923174669        1
[INPUT] 0    0    [1    /1   ]  8.41277549908        1
[INPUT] 0    0    [1    /1   ]  3.47076316556        1
[INPUT] 1    0    [1    /1   ]  8.60211455591        1
[INPUT] 1    0    [1    /1   ]  0.492576368578       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.19822846328529115, 1.0]], [0, [0.39172433234680054, 1.0]], [0, [117616.81386797063, 1.0]], [0, [0.7189453587583459, 1.0]], [0, [1176168.1426172436, 1.0]], [0, [588084.0699825081, 1.0]], [0, [294042.03107371525, 1.0]], [0, [147020.99191971935, 1.0]], [0, [73510.42002324699, 1.0]], [0, [36754.71493951937, 1.0]], [0, [7303.154945163236, 1.0]], [0, [18375.799282956432, 1.0]], [0, [1449.0839080505234, 1.0]], [0, [376.37980483996097, 1.0]], [0, [114.5562884926074, 1.0]], [0, [38.29231746686619, 1.0]], [0, [8.412775499081063, 1.0]], [0, [3.470763165561785, 1.0]], [1, [8.602114555907797, 1.0]], [1, [0.4925763685776894, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.19822846]
bas 1, expnt(s) = [0.39172433]
bas 2, expnt(s) = [117616.81386797]
bas 3, expnt(s) = [0.71894536]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998251]
bas 6, expnt(s) = [294042.03107372]
bas 7, expnt(s) = [147020.99191972]
bas 8, expnt(s) = [73510.42002325]
bas 9, expnt(s) = [36754.71493952]
bas 10, expnt(s) = [7303.15494516]
bas 11, expnt(s) = [18375.79928296]
bas 12, expnt(s) = [1449.08390805]
bas 13, expnt(s) = [376.37980484]
bas 14, expnt(s) = [114.55628849]
bas 15, expnt(s) = [38.29231747]
bas 16, expnt(s) = [8.4127755]
bas 17, expnt(s) = [3.47076317]
bas 18, expnt(s) = [8.60211456]
bas 19, expnt(s) = [0.49257637]
CPU time:       112.77
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.98228463e-01 7.50567119e-01 3.91724332e-01 1.25098020e+00
 1.17616814e+05 1.60460109e+04 7.18945359e-01 1.97259050e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315495e+03 1.99594197e+03 1.83757993e+04 3.98749088e+03
 1.44908391e+03 5.93383102e+02 3.76379805e+02 2.15891110e+02
 1.14556288e+02 8.84665773e+01 3.82923175e+01 3.88909688e+01
 8.41277550e+00 1.24801412e+01 3.47076317e+00 6.42441754e+00
 8.60211456e+00 4.29774773e+01 4.92576369e-01 1.20386104e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336256698364664
cond(S) = 907886.9922022994
E1 = -689.5654014331698  E_coul = 184.96038308926225
init E= -504.605018343908
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672243370644979  LUMO = 0.279928897583261
  mo_energy =
[-1.21706089e+02 -1.33855444e+01 -7.62421963e+00 -7.62421963e+00
 -7.62421963e+00 -1.65776025e+00 -6.72243371e-01 -6.72243371e-01
 -6.72243371e-01  2.79928898e-01  2.15299043e+00  1.46474043e+01
  1.16128365e+02  6.15076816e+02  2.75972480e+03  1.22383090e+04
  4.08582235e+04  1.04900907e+05  2.30083794e+05  4.55898390e+05
  8.44850418e+05  1.52802748e+06  2.85029464e+06  5.80818162e+06]
E1 = -707.7212905420371  E_coul = 199.76393474188367
cycle= 1 E= -507.957355800153  delta_E= -3.35  |g|= 0.45  |ddm|= 0.447
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.649462
diis-c [-0.42180055  1.        ]
  HOMO = -0.217884208723207  LUMO = 0.552809013675288
  mo_energy =
[-1.20196988e+02 -1.23046882e+01 -6.59526841e+00 -6.59526841e+00
 -6.59526841e+00 -1.16349488e+00 -2.17884209e-01 -2.17884209e-01
 -2.17884209e-01  5.52809014e-01  2.61261410e+00  1.55895954e+01
  1.17527639e+02  6.16571338e+02  2.76115853e+03  1.22396338e+04
  4.08594817e+04  1.04902129e+05  2.30084992e+05  4.55899571e+05
  8.44851585e+05  1.52802863e+06  2.85029578e+06  5.80818276e+06]
E1 = -706.775541425164  E_coul = 198.80056052927864
cycle= 2 E= -507.974980895885  delta_E= -0.0176  |g|= 0.0349  |ddm|= 0.359
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0344216
diis-c [-0.0011762  -0.00455663  1.00455663]
  HOMO = -0.240027435977476  LUMO = 0.551728024578183
  mo_energy =
[-1.20310998e+02 -1.23718405e+01 -6.66961186e+00 -6.66961186e+00
 -6.66961186e+00 -1.17777075e+00 -2.40027436e-01 -2.40027436e-01
 -2.40027436e-01  5.51728025e-01  2.59862930e+00  1.55362062e+01
  1.17432160e+02  6.16453257e+02  2.76102442e+03  1.22394895e+04
  4.08593337e+04  1.04901979e+05  2.30084841e+05  4.55899420e+05
  8.44851434e+05  1.52802848e+06  2.85029563e+06  5.80818261e+06]
E1 = -706.6663007813075  E_coul = 198.69105150628064
cycle= 3 E= -507.975249275027  delta_E= -0.000268  |g|= 0.0044  |ddm|= 0.046
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00433296
diis-c [-2.64465874e-06 -3.77841264e-04 -1.30976181e-01  1.13135402e+00]
  HOMO = -0.243283452578377  LUMO = 0.551417870508682
  mo_energy =
[-1.20322892e+02 -1.23805607e+01 -6.67880802e+00 -6.67880802e+00
 -6.67880802e+00 -1.17975217e+00 -2.43283453e-01 -2.43283453e-01
 -2.43283453e-01  5.51417871e-01  2.59627321e+00  1.55290097e+01
  1.17421489e+02  6.16441211e+02  2.76101159e+03  1.22394762e+04
  4.08593202e+04  1.04901966e+05  2.30084828e+05  4.55899406e+05
  8.44851420e+05  1.52802847e+06  2.85029562e+06  5.80818259e+06]
E1 = -706.6501590396275  E_coul = 198.67490412459046
cycle= 4 E= -507.975254915037  delta_E= -5.64e-06  |g|= 0.000211  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000147259
diis-c [-1.22828390e-09 -8.52245932e-06  8.43714214e-03 -9.06078229e-02
  1.08217920e+00]
  HOMO = -0.243370740089042  LUMO = 0.551399438118536
  mo_energy =
[-1.20322948e+02 -1.23807075e+01 -6.67893596e+00 -6.67893596e+00
 -6.67893596e+00 -1.17980555e+00 -2.43370740e-01 -2.43370740e-01
 -2.43370740e-01  5.51399438e-01  2.59619026e+00  1.55288705e+01
  1.17421400e+02  6.16441159e+02  2.76101156e+03  1.22394762e+04
  4.08593202e+04  1.04901966e+05  2.30084828e+05  4.55899406e+05
  8.44851420e+05  1.52802847e+06  2.85029562e+06  5.80818259e+06]
E1 = -706.6497100240708  E_coul = 198.67445509625028
cycle= 5 E= -507.975254927821  delta_E= -1.28e-08  |g|= 1.29e-05  |ddm|= 0.00102
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.27723e-06
diis-c [-1.59522709e-12  9.77663695e-07 -1.08596289e-03  1.11981207e-02
 -1.48980154e-01  1.13886702e+00]
  HOMO = -0.243373596974609  LUMO = 0.55139876895561
  mo_energy =
[-1.20322951e+02 -1.23807108e+01 -6.67893920e+00 -6.67893920e+00
 -6.67893920e+00 -1.17980773e+00 -2.43373597e-01 -2.43373597e-01
 -2.43373597e-01  5.51398769e-01  2.59618703e+00  1.55288669e+01
  1.17421397e+02  6.16441156e+02  2.76101156e+03  1.22394762e+04
  4.08593202e+04  1.04901966e+05  2.30084828e+05  4.55899406e+05
  8.44851420e+05  1.52802847e+06  2.85029562e+06  5.80818259e+06]
E1 = -706.6496926966292  E_coul = 198.67443776876593
cycle= 6 E= -507.975254927863  delta_E= -4.28e-11  |g|= 4.89e-08  |ddm|= 7.43e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6496926966292  E_coul = 198.67443776876593
  HOMO = -0.24337361522853  LUMO = 0.551398747669811
  mo_energy =
[-1.20322951e+02 -1.23807108e+01 -6.67893924e+00 -6.67893924e+00
 -6.67893924e+00 -1.17980772e+00 -2.43373615e-01 -2.43373615e-01
 -2.43373615e-01  5.51398748e-01  2.59618701e+00  1.55288669e+01
  1.17421397e+02  6.16441156e+02  2.76101156e+03  1.22394762e+04
  4.08593202e+04  1.04901966e+05  2.30084828e+05  4.55899406e+05
  8.44851420e+05  1.52802847e+06  2.85029562e+06  5.80818259e+06]
E1 = -706.6496926797894  E_coul = 198.67443775192575
Extra cycle  E= -507.975254927864  delta_E= -2.84e-13  |g|= 2.8e-09  |ddm|= 1.04e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907886.9922022994
E1 = -706.6496926797894  E_coul = 198.67443775192575
init E= -507.975254927864
    CPU time for initialize scf      3.80 sec, wall time      0.25 sec
  HOMO = -0.243373615689881  LUMO = 0.55139874887395
  mo_energy =
[-1.20322951e+02 -1.23807108e+01 -6.67893924e+00 -6.67893924e+00
 -6.67893924e+00 -1.17980772e+00 -2.43373616e-01 -2.43373616e-01
 -2.43373616e-01  5.51398749e-01  2.59618701e+00  1.55288669e+01
  1.17421397e+02  6.16441156e+02  2.76101156e+03  1.22394762e+04
  4.08593202e+04  1.04901966e+05  2.30084828e+05  4.55899406e+05
  8.44851420e+05  1.52802847e+06  2.85029562e+06  5.80818259e+06]
E1 = -706.649692678801  E_coul = 198.67443775093744
cycle= 1 E= -507.975254927864  delta_E= 5.68e-14  |g|= 1.99e-09  |ddm|= 8.67e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.649692678801  E_coul = 198.67443775093744
  HOMO = -0.243373615716499  LUMO = 0.551398747206976
  mo_energy =
[-1.20322951e+02 -1.23807108e+01 -6.67893924e+00 -6.67893924e+00
 -6.67893924e+00 -1.17980772e+00 -2.43373616e-01 -2.43373616e-01
 -2.43373616e-01  5.51398747e-01  2.59618701e+00  1.55288669e+01
  1.17421397e+02  6.16441156e+02  2.76101156e+03  1.22394762e+04
  4.08593202e+04  1.04901966e+05  2.30084828e+05  4.55899406e+05
  8.44851420e+05  1.52802847e+06  2.85029562e+06  5.80818259e+06]
E1 = -706.6496926797158  E_coul = 198.67443775185265
Extra cycle  E= -507.975254927863  delta_E= 3.98e-13  |g|= 1.44e-09  |ddm|= 1.89e-09
    CPU time for scf_cycle      4.25 sec, wall time      0.41 sec
exp = [1.98228463e-01 3.91724332e-01 1.17616814e+05 7.18945359e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315495e+03 1.83757993e+04
 1.44908391e+03 3.76379805e+02 1.14556288e+02 3.82923175e+01
 8.41277550e+00 3.47076317e+00 8.60211456e+00 4.92576369e-01]
grad_E = [ 4.85287583e-03 -7.13192339e-03  4.32092155e-09 -1.92893283e-03
  2.04027732e-11  1.17274374e-10  6.72154827e-10  2.63751915e-09
  1.09626935e-08  5.88062599e-08  3.70575968e-06  1.28049102e-07
  1.22997401e-06 -1.21822813e-05  1.19348672e-04 -5.56696786e-04
 -9.75379847e-04  4.81984258e-04 -1.47022498e-03 -2.00325878e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:07:14 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.183575428881       1
[INPUT] 0    0    [1    /1   ]  0.468521275686       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.766211434743       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200229        1
[INPUT] 0    0    [1    /1   ]  36754.7149379        1
[INPUT] 0    0    [1    /1   ]  7303.15484056        1
[INPUT] 0    0    [1    /1   ]  18375.7992793        1
[INPUT] 0    0    [1    /1   ]  1449.08388536        1
[INPUT] 0    0    [1    /1   ]  376.379956443        1
[INPUT] 0    0    [1    /1   ]  114.554816431        1
[INPUT] 0    0    [1    /1   ]  38.2986118603        1
[INPUT] 0    0    [1    /1   ]  8.4020151896         1
[INPUT] 0    0    [1    /1   ]  3.56399266087        1
[INPUT] 1    0    [1    /1   ]  8.60251385471        1
[INPUT] 1    0    [1    /1   ]  0.492645833391       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.1835754288807396, 1.0]], [0, [0.4685212756864211, 1.0]], [0, [117616.81386784867, 1.0]], [0, [0.7662114347434519, 1.0]], [0, [1176168.142617243, 1.0]], [0, [588084.0699825048, 1.0]], [0, [294042.0310736963, 1.0]], [0, [147020.9919196449, 1.0]], [0, [73510.42002293756, 1.0]], [0, [36754.71493785977, 1.0]], [0, [7303.154840555042, 1.0]], [0, [18375.79927934042, 1.0]], [0, [1449.0838853591758, 1.0]], [0, [376.37995644278925, 1.0]], [0, [114.55481643055965, 1.0]], [0, [38.29861186032289, 1.0]], [0, [8.402015189595922, 1.0]], [0, [3.563992660865954, 1.0]], [1, [8.602513854714896, 1.0]], [1, [0.4926458333913916, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.18357543]
bas 1, expnt(s) = [0.46852128]
bas 2, expnt(s) = [117616.81386785]
bas 3, expnt(s) = [0.76621143]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.0699825]
bas 6, expnt(s) = [294042.0310737]
bas 7, expnt(s) = [147020.99191964]
bas 8, expnt(s) = [73510.42002294]
bas 9, expnt(s) = [36754.71493786]
bas 10, expnt(s) = [7303.15484056]
bas 11, expnt(s) = [18375.79927934]
bas 12, expnt(s) = [1449.08388536]
bas 13, expnt(s) = [376.37995644]
bas 14, expnt(s) = [114.55481643]
bas 15, expnt(s) = [38.29861186]
bas 16, expnt(s) = [8.40201519]
bas 17, expnt(s) = [3.56399266]
bas 18, expnt(s) = [8.60251385]
bas 19, expnt(s) = [0.49264583]
CPU time:       124.83
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.83575429e-01 7.08558868e-01 4.68521276e-01 1.43074426e+00
 1.17616814e+05 1.60460109e+04 7.66211435e-01 2.06907625e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315484e+03 1.99594195e+03 1.83757993e+04 3.98749088e+03
 1.44908389e+03 5.93383095e+02 3.76379956e+02 2.15891175e+02
 1.14554816e+02 8.84657247e+01 3.82986119e+01 3.88957633e+01
 8.40201519e+00 1.24681673e+01 3.56399266e+00 6.55341431e+00
 8.60251385e+00 4.29799710e+01 4.92645833e-01 1.20407326e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336209779768364
cond(S) = 907897.9442261838
E1 = -689.5620319853745  E_coul = 184.95784713547008
init E= -504.604184849904
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672314668290266  LUMO = 0.292738840481493
  mo_energy =
[-1.21706304e+02 -1.33857541e+01 -7.62452289e+00 -7.62452289e+00
 -7.62452289e+00 -1.65765930e+00 -6.72314668e-01 -6.72314668e-01
 -6.72314668e-01  2.92738840e-01  2.40339052e+00  1.53965200e+01
  1.16962602e+02  6.15782859e+02  2.76032866e+03  1.22388328e+04
  4.08587074e+04  1.04901371e+05  2.30084245e+05  4.55898832e+05
  8.44850852e+05  1.52802791e+06  2.85029505e+06  5.80818203e+06]
E1 = -707.7248556521848  E_coul = 199.76741614727038
cycle= 1 E= -507.957439504914  delta_E= -3.35  |g|= 0.45  |ddm|= 0.429
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.650487
diis-c [-0.42313278  1.        ]
  HOMO = -0.217800556653618  LUMO = 0.572812626754701
  mo_energy =
[-1.20196997e+02 -1.23043259e+01 -6.59495160e+00 -6.59495160e+00
 -6.59495160e+00 -1.16341263e+00 -2.17800557e-01 -2.17800557e-01
 -2.17800557e-01  5.72812627e-01  2.88562893e+00  1.63436009e+01
  1.18361826e+02  6.17277301e+02  2.76176218e+03  1.22401571e+04
  4.08599652e+04  1.04902592e+05  2.30085442e+05  4.55900011e+05
  8.44852018e+05  1.52802906e+06  2.85029620e+06  5.80818316e+06]
E1 = -706.7713896784403  E_coul = 198.79617650055076
cycle= 2 E= -507.97521317789  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.374
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0360824
diis-c [-0.00128982 -0.00538875  1.00538875]
  HOMO = -0.240193653074618  LUMO = 0.571493114567771
  mo_energy =
[-1.20311785e+02 -1.23721308e+01 -6.66997073e+00 -6.66997073e+00
 -6.66997073e+00 -1.17785127e+00 -2.40193653e-01 -2.40193653e-01
 -2.40193653e-01  5.71493115e-01  2.86965342e+00  1.62889789e+01
  1.18265629e+02  6.17158446e+02  2.76162726e+03  1.22400120e+04
  4.08598163e+04  1.04902441e+05  2.30085290e+05  4.55899860e+05
  8.44851866e+05  1.52802891e+06  2.85029605e+06  5.80818301e+06]
E1 = -706.6606325777183  E_coul = 198.68514614854664
cycle= 3 E= -507.975486429172  delta_E= -0.000273  |g|= 0.00441  |ddm|= 0.0444
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00464932
diis-c [-2.89966479e-06 -4.01732474e-04 -1.34999828e-01  1.13540156e+00]
  HOMO = -0.243498153199465  LUMO = 0.57112782229278
  mo_energy =
[-1.20323781e+02 -1.23809510e+01 -6.67926700e+00 -6.67926700e+00
 -6.67926700e+00 -1.17986090e+00 -2.43498153e-01 -2.43498153e-01
 -2.43498153e-01  5.71127822e-01  2.86699003e+00  1.62816289e+01
  1.18254857e+02  6.17146300e+02  2.76161432e+03  1.22399986e+04
  4.08598027e+04  1.04902428e+05  2.30085277e+05  4.55899846e+05
  8.44851853e+05  1.52802889e+06  2.85029603e+06  5.80818300e+06]
E1 = -706.6442503648127  E_coul = 198.6687582218203
cycle= 4 E= -507.975492142992  delta_E= -5.71e-06  |g|= 0.000201  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000147255
diis-c [-1.27994834e-09 -1.10401193e-05  8.35330396e-03 -8.63687009e-02
  1.07802644e+00]
  HOMO = -0.243573478476355  LUMO = 0.571108479879998
  mo_energy =
[-1.20323787e+02 -1.23810625e+01 -6.67935723e+00 -6.67935723e+00
 -6.67935723e+00 -1.17990691e+00 -2.43573478e-01 -2.43573478e-01
 -2.43573478e-01  5.71108480e-01  2.86690972e+00  1.62815190e+01
  1.18254813e+02  6.17146300e+02  2.76161435e+03  1.22399987e+04
  4.08598028e+04  1.04902428e+05  2.30085277e+05  4.55899846e+05
  8.44851853e+05  1.52802889e+06  2.85029603e+06  5.80818300e+06]
E1 = -706.6438652952077  E_coul = 198.66837314157826
cycle= 5 E= -507.975492153629  delta_E= -1.06e-08  |g|= 1.19e-05  |ddm|= 0.00102
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.19363e-06
diis-c [-1.47627322e-12  9.12892097e-07 -1.04432079e-03  1.03259892e-02
 -1.42325334e-01  1.13304275e+00]
  HOMO = -0.243575839435207  LUMO = 0.571107837669874
  mo_energy =
[-1.20323788e+02 -1.23810645e+01 -6.67935911e+00 -6.67935911e+00
 -6.67935911e+00 -1.17990878e+00 -2.43575839e-01 -2.43575839e-01
 -2.43575839e-01  5.71107838e-01  2.86690675e+00  1.62815165e+01
  1.18254811e+02  6.17146298e+02  2.76161435e+03  1.22399987e+04
  4.08598028e+04  1.04902428e+05  2.30085277e+05  4.55899846e+05
  8.44851853e+05  1.52802889e+06  2.85029603e+06  5.80818300e+06]
E1 = -706.6438508360322  E_coul = 198.66835868237033
cycle= 6 E= -507.975492153662  delta_E= -3.25e-11  |g|= 5.23e-08  |ddm|= 7.01e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6438508360322  E_coul = 198.66835868237033
  HOMO = -0.243575856031712  LUMO = 0.57110781673842
  mo_energy =
[-1.20323788e+02 -1.23810645e+01 -6.67935915e+00 -6.67935915e+00
 -6.67935915e+00 -1.17990877e+00 -2.43575856e-01 -2.43575856e-01
 -2.43575856e-01  5.71107817e-01  2.86690673e+00  1.62815165e+01
  1.18254811e+02  6.17146298e+02  2.76161435e+03  1.22399987e+04
  4.08598028e+04  1.04902428e+05  2.30085277e+05  4.55899846e+05
  8.44851853e+05  1.52802889e+06  2.85029603e+06  5.80818300e+06]
E1 = -706.6438508266003  E_coul = 198.66835867293867
Extra cycle  E= -507.975492153662  delta_E= 2.27e-13  |g|= 3.31e-09  |ddm|= 1.5e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [1.83575429e-01 4.68521276e-01 1.17616814e+05 7.66211435e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315484e+03 1.83757993e+04
 1.44908389e+03 3.76379956e+02 1.14554816e+02 3.82986119e+01
 8.40201519e+00 3.56399266e+00 8.60251385e+00 4.92645833e-01]
E = -507.97549215366166
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:07:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.183575428881       1
[INPUT] 0    0    [1    /1   ]  0.468521275686       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.766211434743       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200229        1
[INPUT] 0    0    [1    /1   ]  36754.7149379        1
[INPUT] 0    0    [1    /1   ]  7303.15484056        1
[INPUT] 0    0    [1    /1   ]  18375.7992793        1
[INPUT] 0    0    [1    /1   ]  1449.08388536        1
[INPUT] 0    0    [1    /1   ]  376.379956443        1
[INPUT] 0    0    [1    /1   ]  114.554816431        1
[INPUT] 0    0    [1    /1   ]  38.2986118603        1
[INPUT] 0    0    [1    /1   ]  8.4020151896         1
[INPUT] 0    0    [1    /1   ]  3.56399266087        1
[INPUT] 1    0    [1    /1   ]  8.60251385471        1
[INPUT] 1    0    [1    /1   ]  0.492645833391       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.1835754288807396, 1.0]], [0, [0.4685212756864211, 1.0]], [0, [117616.81386784867, 1.0]], [0, [0.7662114347434519, 1.0]], [0, [1176168.142617243, 1.0]], [0, [588084.0699825048, 1.0]], [0, [294042.0310736963, 1.0]], [0, [147020.9919196449, 1.0]], [0, [73510.42002293756, 1.0]], [0, [36754.71493785977, 1.0]], [0, [7303.154840555042, 1.0]], [0, [18375.79927934042, 1.0]], [0, [1449.0838853591758, 1.0]], [0, [376.37995644278925, 1.0]], [0, [114.55481643055965, 1.0]], [0, [38.29861186032289, 1.0]], [0, [8.402015189595922, 1.0]], [0, [3.563992660865954, 1.0]], [1, [8.602513854714896, 1.0]], [1, [0.4926458333913916, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.18357543]
bas 1, expnt(s) = [0.46852128]
bas 2, expnt(s) = [117616.81386785]
bas 3, expnt(s) = [0.76621143]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.0699825]
bas 6, expnt(s) = [294042.0310737]
bas 7, expnt(s) = [147020.99191964]
bas 8, expnt(s) = [73510.42002294]
bas 9, expnt(s) = [36754.71493786]
bas 10, expnt(s) = [7303.15484056]
bas 11, expnt(s) = [18375.79927934]
bas 12, expnt(s) = [1449.08388536]
bas 13, expnt(s) = [376.37995644]
bas 14, expnt(s) = [114.55481643]
bas 15, expnt(s) = [38.29861186]
bas 16, expnt(s) = [8.40201519]
bas 17, expnt(s) = [3.56399266]
bas 18, expnt(s) = [8.60251385]
bas 19, expnt(s) = [0.49264583]
CPU time:       126.06
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.83575429e-01 7.08558868e-01 4.68521276e-01 1.43074426e+00
 1.17616814e+05 1.60460109e+04 7.66211435e-01 2.06907625e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315484e+03 1.99594195e+03 1.83757993e+04 3.98749088e+03
 1.44908389e+03 5.93383095e+02 3.76379956e+02 2.15891175e+02
 1.14554816e+02 8.84657247e+01 3.82986119e+01 3.88957633e+01
 8.40201519e+00 1.24681673e+01 3.56399266e+00 6.55341431e+00
 8.60251385e+00 4.29799710e+01 4.92645833e-01 1.20407326e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336209779768364
cond(S) = 907897.9442261838
E1 = -689.5620319853745  E_coul = 184.95784713547008
init E= -504.604184849904
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672314668290266  LUMO = 0.292738840481493
  mo_energy =
[-1.21706304e+02 -1.33857541e+01 -7.62452289e+00 -7.62452289e+00
 -7.62452289e+00 -1.65765930e+00 -6.72314668e-01 -6.72314668e-01
 -6.72314668e-01  2.92738840e-01  2.40339052e+00  1.53965200e+01
  1.16962602e+02  6.15782859e+02  2.76032866e+03  1.22388328e+04
  4.08587074e+04  1.04901371e+05  2.30084245e+05  4.55898832e+05
  8.44850852e+05  1.52802791e+06  2.85029505e+06  5.80818203e+06]
E1 = -707.7248556521848  E_coul = 199.76741614727038
cycle= 1 E= -507.957439504914  delta_E= -3.35  |g|= 0.45  |ddm|= 0.429
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.650487
diis-c [-0.42313278  1.        ]
  HOMO = -0.217800556653618  LUMO = 0.572812626754701
  mo_energy =
[-1.20196997e+02 -1.23043259e+01 -6.59495160e+00 -6.59495160e+00
 -6.59495160e+00 -1.16341263e+00 -2.17800557e-01 -2.17800557e-01
 -2.17800557e-01  5.72812627e-01  2.88562893e+00  1.63436009e+01
  1.18361826e+02  6.17277301e+02  2.76176218e+03  1.22401571e+04
  4.08599652e+04  1.04902592e+05  2.30085442e+05  4.55900011e+05
  8.44852018e+05  1.52802906e+06  2.85029620e+06  5.80818316e+06]
E1 = -706.7713896784403  E_coul = 198.79617650055076
cycle= 2 E= -507.97521317789  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.374
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0360824
diis-c [-0.00128982 -0.00538875  1.00538875]
  HOMO = -0.240193653074618  LUMO = 0.571493114567771
  mo_energy =
[-1.20311785e+02 -1.23721308e+01 -6.66997073e+00 -6.66997073e+00
 -6.66997073e+00 -1.17785127e+00 -2.40193653e-01 -2.40193653e-01
 -2.40193653e-01  5.71493115e-01  2.86965342e+00  1.62889789e+01
  1.18265629e+02  6.17158446e+02  2.76162726e+03  1.22400120e+04
  4.08598163e+04  1.04902441e+05  2.30085290e+05  4.55899860e+05
  8.44851866e+05  1.52802891e+06  2.85029605e+06  5.80818301e+06]
E1 = -706.6606325777183  E_coul = 198.68514614854664
cycle= 3 E= -507.975486429172  delta_E= -0.000273  |g|= 0.00441  |ddm|= 0.0444
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00464932
diis-c [-2.89966479e-06 -4.01732474e-04 -1.34999828e-01  1.13540156e+00]
  HOMO = -0.243498153199465  LUMO = 0.57112782229278
  mo_energy =
[-1.20323781e+02 -1.23809510e+01 -6.67926700e+00 -6.67926700e+00
 -6.67926700e+00 -1.17986090e+00 -2.43498153e-01 -2.43498153e-01
 -2.43498153e-01  5.71127822e-01  2.86699003e+00  1.62816289e+01
  1.18254857e+02  6.17146300e+02  2.76161432e+03  1.22399986e+04
  4.08598027e+04  1.04902428e+05  2.30085277e+05  4.55899846e+05
  8.44851853e+05  1.52802889e+06  2.85029603e+06  5.80818300e+06]
E1 = -706.6442503648127  E_coul = 198.6687582218203
cycle= 4 E= -507.975492142992  delta_E= -5.71e-06  |g|= 0.000201  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000147255
diis-c [-1.27994834e-09 -1.10401193e-05  8.35330396e-03 -8.63687009e-02
  1.07802644e+00]
  HOMO = -0.243573478476355  LUMO = 0.571108479879998
  mo_energy =
[-1.20323787e+02 -1.23810625e+01 -6.67935723e+00 -6.67935723e+00
 -6.67935723e+00 -1.17990691e+00 -2.43573478e-01 -2.43573478e-01
 -2.43573478e-01  5.71108480e-01  2.86690972e+00  1.62815190e+01
  1.18254813e+02  6.17146300e+02  2.76161435e+03  1.22399987e+04
  4.08598028e+04  1.04902428e+05  2.30085277e+05  4.55899846e+05
  8.44851853e+05  1.52802889e+06  2.85029603e+06  5.80818300e+06]
E1 = -706.6438652952077  E_coul = 198.66837314157826
cycle= 5 E= -507.975492153629  delta_E= -1.06e-08  |g|= 1.19e-05  |ddm|= 0.00102
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.19363e-06
diis-c [-1.47627322e-12  9.12892097e-07 -1.04432079e-03  1.03259892e-02
 -1.42325334e-01  1.13304275e+00]
  HOMO = -0.243575839435207  LUMO = 0.571107837669874
  mo_energy =
[-1.20323788e+02 -1.23810645e+01 -6.67935911e+00 -6.67935911e+00
 -6.67935911e+00 -1.17990878e+00 -2.43575839e-01 -2.43575839e-01
 -2.43575839e-01  5.71107838e-01  2.86690675e+00  1.62815165e+01
  1.18254811e+02  6.17146298e+02  2.76161435e+03  1.22399987e+04
  4.08598028e+04  1.04902428e+05  2.30085277e+05  4.55899846e+05
  8.44851853e+05  1.52802889e+06  2.85029603e+06  5.80818300e+06]
E1 = -706.6438508360322  E_coul = 198.66835868237033
cycle= 6 E= -507.975492153662  delta_E= -3.25e-11  |g|= 5.23e-08  |ddm|= 7.01e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6438508360322  E_coul = 198.66835868237033
  HOMO = -0.243575856031712  LUMO = 0.57110781673842
  mo_energy =
[-1.20323788e+02 -1.23810645e+01 -6.67935915e+00 -6.67935915e+00
 -6.67935915e+00 -1.17990877e+00 -2.43575856e-01 -2.43575856e-01
 -2.43575856e-01  5.71107817e-01  2.86690673e+00  1.62815165e+01
  1.18254811e+02  6.17146298e+02  2.76161435e+03  1.22399987e+04
  4.08598028e+04  1.04902428e+05  2.30085277e+05  4.55899846e+05
  8.44851853e+05  1.52802889e+06  2.85029603e+06  5.80818300e+06]
E1 = -706.6438508266003  E_coul = 198.66835867293867
Extra cycle  E= -507.975492153662  delta_E= 2.27e-13  |g|= 3.31e-09  |ddm|= 1.5e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907897.9442261838
E1 = -706.6438508266003  E_coul = 198.66835867293867
init E= -507.975492153662
    CPU time for initialize scf      3.35 sec, wall time      0.21 sec
  HOMO = -0.243575856141727  LUMO = 0.571107816682431
  mo_energy =
[-1.20323788e+02 -1.23810645e+01 -6.67935915e+00 -6.67935915e+00
 -6.67935915e+00 -1.17990877e+00 -2.43575856e-01 -2.43575856e-01
 -2.43575856e-01  5.71107817e-01  2.86690673e+00  1.62815165e+01
  1.18254811e+02  6.17146298e+02  2.76161435e+03  1.22399987e+04
  4.08598028e+04  1.04902428e+05  2.30085277e+05  4.55899846e+05
  8.44851853e+05  1.52802889e+06  2.85029603e+06  5.80818300e+06]
E1 = -706.643850825982  E_coul = 198.66835867231975
cycle= 1 E= -507.975492153662  delta_E= -5.68e-13  |g|= 1.73e-09  |ddm|= 1.28e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.643850825982  E_coul = 198.66835867231975
  HOMO = -0.243575856123734  LUMO = 0.571107815610408
  mo_energy =
[-1.20323788e+02 -1.23810645e+01 -6.67935915e+00 -6.67935915e+00
 -6.67935915e+00 -1.17990877e+00 -2.43575856e-01 -2.43575856e-01
 -2.43575856e-01  5.71107816e-01  2.86690673e+00  1.62815165e+01
  1.18254811e+02  6.17146298e+02  2.76161435e+03  1.22399987e+04
  4.08598028e+04  1.04902428e+05  2.30085277e+05  4.55899846e+05
  8.44851853e+05  1.52802889e+06  2.85029603e+06  5.80818300e+06]
E1 = -706.6438508321546  E_coul = 198.6683586784929
Extra cycle  E= -507.975492153662  delta_E= 5.12e-13  |g|= 1.99e-09  |ddm|= 6.25e-09
    CPU time for scf_cycle      3.80 sec, wall time      0.38 sec
exp = [1.83575429e-01 4.68521276e-01 1.17616814e+05 7.66211435e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315484e+03 1.83757993e+04
 1.44908389e+03 3.76379956e+02 1.14554816e+02 3.82986119e+01
 8.40201519e+00 3.56399266e+00 8.60251385e+00 4.92645833e-01]
grad_E = [-1.33169154e-02 -9.30534454e-04  4.31198639e-09 -5.15293889e-03
  2.02969783e-11  1.16985981e-10  6.70769062e-10  2.63200117e-09
  1.09394581e-08  5.86909642e-08  3.69736717e-06  1.27706241e-07
  1.73248243e-06 -2.02660961e-05  2.02068155e-04 -9.74054496e-04
 -2.60483289e-03  4.48037240e-03 -1.28828996e-03 -3.30084075e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:07:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.225293699135       1
[INPUT] 0    0    [1    /1   ]  0.525072345122       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.796734167101       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200227        1
[INPUT] 0    0    [1    /1   ]  36754.7149368        1
[INPUT] 0    0    [1    /1   ]  7303.15477366        1
[INPUT] 0    0    [1    /1   ]  18375.799277         1
[INPUT] 0    0    [1    /1   ]  1449.08387131        1
[INPUT] 0    0    [1    /1   ]  376.380046057        1
[INPUT] 0    0    [1    /1   ]  114.553924929        1
[INPUT] 0    0    [1    /1   ]  38.3024949892        1
[INPUT] 0    0    [1    /1   ]  8.39821306874        1
[INPUT] 0    0    [1    /1   ]  3.60956650761        1
[INPUT] 1    0    [1    /1   ]  8.6049251156         1
[INPUT] 1    0    [1    /1   ]  0.492727562886       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.22529369913509562, 1.0]], [0, [0.5250723451223405, 1.0]], [0, [117616.81386777067, 1.0]], [0, [0.7967341671012098, 1.0]], [0, [1176168.1426172426, 1.0]], [0, [588084.0699825027, 1.0]], [0, [294042.03107368416, 1.0]], [0, [147020.9919195973, 1.0]], [0, [73510.42002273967, 1.0]], [0, [36754.714936798424, 1.0]], [0, [7303.154773655749, 1.0]], [0, [18375.799277027807, 1.0]], [0, [1449.0838713103885, 1.0]], [0, [376.3800460574703, 1.0]], [0, [114.55392492928003, 1.0]], [0, [38.302494989240515, 1.0]], [0, [8.398213068744871, 1.0]], [0, [3.6095665076061447, 1.0]], [1, [8.604925115595568, 1.0]], [1, [0.49272756288581304, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2252937]
bas 1, expnt(s) = [0.52507235]
bas 2, expnt(s) = [117616.81386777]
bas 3, expnt(s) = [0.79673417]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.0699825]
bas 6, expnt(s) = [294042.03107368]
bas 7, expnt(s) = [147020.9919196]
bas 8, expnt(s) = [73510.42002274]
bas 9, expnt(s) = [36754.7149368]
bas 10, expnt(s) = [7303.15477366]
bas 11, expnt(s) = [18375.79927703]
bas 12, expnt(s) = [1449.08387131]
bas 13, expnt(s) = [376.38004606]
bas 14, expnt(s) = [114.55392493]
bas 15, expnt(s) = [38.30249499]
bas 16, expnt(s) = [8.39821307]
bas 17, expnt(s) = [3.60956651]
bas 18, expnt(s) = [8.60492512]
bas 19, expnt(s) = [0.49272756]
CPU time:       137.82
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.25293699e-01 8.26184054e-01 5.25072345e-01 1.55840159e+00
 1.17616814e+05 1.60460109e+04 7.96734167e-01 2.13059109e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315477e+03 1.99594193e+03 1.83757993e+04 3.98749088e+03
 1.44908387e+03 5.93383091e+02 3.76380046e+02 2.15891214e+02
 1.14553925e+02 8.84652083e+01 3.83024950e+01 3.88987211e+01
 8.39821307e+00 1.24639354e+01 3.60956651e+00 6.61616474e+00
 8.60492512e+00 4.29950305e+01 4.92727563e-01 1.20432295e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335973202894024
cond(S) = 907910.4314761921
E1 = -689.5773124955944  E_coul = 184.97485305071754
init E= -504.602459444877
    CPU time for initialize scf      0.43 sec, wall time      0.07 sec
  HOMO = -0.672156115022738  LUMO = 0.406291260025029
  mo_energy =
[-1.21703673e+02 -1.33843694e+01 -7.62327872e+00 -7.62327872e+00
 -7.62327872e+00 -1.65761283e+00 -6.72156115e-01 -6.72156115e-01
 -6.72156115e-01  4.06291260e-01  2.81039413e+00  1.61281660e+01
  1.17691501e+02  6.16393294e+02  2.76085029e+03  1.22392854e+04
  4.08591258e+04  1.04901772e+05  2.30084635e+05  4.55899213e+05
  8.44851227e+05  1.52802828e+06  2.85029542e+06  5.80818238e+06]
E1 = -707.7462543642414  E_coul = 199.78847107544195
cycle= 1 E= -507.957783288799  delta_E= -3.36  |g|= 0.45  |ddm|= 0.499
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.643728
diis-c [-0.41438627  1.        ]
  HOMO = -0.217548151804628  LUMO = 0.709594059805942
  mo_energy =
[-1.20193989e+02 -1.23027039e+01 -6.59336657e+00 -6.59336657e+00
 -6.59336657e+00 -1.16315899e+00 -2.17548152e-01 -2.17548152e-01
 -2.17548152e-01  7.09594060e-01  3.31065830e+00  1.70763114e+01
  1.19090530e+02  6.17887897e+02  2.76228400e+03  1.22406099e+04
  4.08603837e+04  1.04902993e+05  2.30085832e+05  4.55900393e+05
  8.44852394e+05  1.52802943e+06  2.85029656e+06  5.80818352e+06]
E1 = -706.7998068653175  E_coul = 198.82436729030096
cycle= 2 E= -507.975439575016  delta_E= -0.0177  |g|= 0.035  |ddm|= 0.349
    CPU time for cycle= 2      0.09 sec, wall time      0.03 sec
diis-norm(errvec)=0.0334599
diis-c [-0.00111525 -0.00324085  1.00324085]
  HOMO = -0.239579054645034  LUMO = 0.707723940370364
  mo_energy =
[-1.20308015e+02 -1.23698808e+01 -6.66774855e+00 -6.66774855e+00
 -6.66774855e+00 -1.17733749e+00 -2.39579055e-01 -2.39579055e-01
 -2.39579055e-01  7.07723940e-01  3.29325496e+00  1.70218418e+01
  1.18995057e+02  6.17769825e+02  2.76214990e+03  1.22404656e+04
  4.08602357e+04  1.04902843e+05  2.30085681e+05  4.55900242e+05
  8.44852243e+05  1.52802928e+06  2.85029641e+06  5.80818336e+06]
E1 = -706.6921111693339  E_coul = 198.716410263411
cycle= 3 E= -507.975700905923  delta_E= -0.000261  |g|= 0.00436  |ddm|= 0.0532
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00416624
diis-c [-2.48533605e-06 -3.49279710e-04 -1.29420519e-01  1.12976980e+00]
  HOMO = -0.242789352960676  LUMO = 0.707268898446988
  mo_energy =
[-1.20319905e+02 -1.23785515e+01 -6.67690411e+00 -6.67690411e+00
 -6.67690411e+00 -1.17928734e+00 -2.42789353e-01 -2.42789353e-01
 -2.42789353e-01  7.07268898e-01  3.29044790e+00  1.70145996e+01
  1.18984411e+02  6.17757780e+02  2.76213705e+03  1.22404523e+04
  4.08602222e+04  1.04902830e+05  2.30085668e+05  4.55900229e+05
  8.44852229e+05  1.52802927e+06  2.85029640e+06  5.80818335e+06]
E1 = -706.6764048925062  E_coul = 198.7006986975838
cycle= 4 E= -507.975706194922  delta_E= -5.29e-06  |g|= 0.000192  |ddm|= 0.0132
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00013202
diis-c [-7.92367170e-10 -1.03258618e-05  7.86783162e-03 -8.46758913e-02
  1.07681839e+00]
  HOMO = -0.242871948794546  LUMO = 0.707246345287599
  mo_energy =
[-1.20319960e+02 -1.23786927e+01 -6.67702717e+00 -6.67702717e+00
 -6.67702717e+00 -1.17933762e+00 -2.42871949e-01 -2.42871949e-01
 -2.42871949e-01  7.07246345e-01  3.29035969e+00  1.70144674e+01
  1.18984325e+02  6.17757730e+02  2.76213702e+03  1.22404523e+04
  4.08602222e+04  1.04902830e+05  2.30085668e+05  4.55900229e+05
  8.44852229e+05  1.52802927e+06  2.85029640e+06  5.80818335e+06]
E1 = -706.6759965045591  E_coul = 198.70029030035596
cycle= 5 E= -507.975706204203  delta_E= -9.28e-09  |g|= 1.01e-05  |ddm|= 0.00115
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.96134e-06
diis-c [-1.18879394e-12  7.91602405e-07 -9.52450632e-04  9.79630486e-03
 -1.34709103e-01  1.12586446e+00]
  HOMO = -0.242874625083551  LUMO = 0.707245615664992
  mo_energy =
[-1.20319964e+02 -1.23786962e+01 -6.67703060e+00 -6.67703060e+00
 -6.67703060e+00 -1.17933961e+00 -2.42874625e-01 -2.42874625e-01
 -2.42874625e-01  7.07245616e-01  3.29035657e+00  1.70144638e+01
  1.18984321e+02  6.17757726e+02  2.76213702e+03  1.22404523e+04
  4.08602222e+04  1.04902830e+05  2.30085668e+05  4.55900229e+05
  8.44852229e+05  1.52802927e+06  2.85029640e+06  5.80818335e+06]
E1 = -706.6759817339968  E_coul = 198.70027552977112
cycle= 6 E= -507.975706204226  delta_E= -2.25e-11  |g|= 4.47e-08  |ddm|= 7.03e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6759817339968  E_coul = 198.70027552977112
  HOMO = -0.242874641490426  LUMO = 0.707245595456036
  mo_energy =
[-1.20319964e+02 -1.23786962e+01 -6.67703063e+00 -6.67703063e+00
 -6.67703063e+00 -1.17933960e+00 -2.42874641e-01 -2.42874641e-01
 -2.42874641e-01  7.07245595e-01  3.29035654e+00  1.70144637e+01
  1.18984321e+02  6.17757726e+02  2.76213702e+03  1.22404523e+04
  4.08602222e+04  1.04902830e+05  2.30085668e+05  4.55900229e+05
  8.44852229e+05  1.52802927e+06  2.85029640e+06  5.80818335e+06]
E1 = -706.6759817042299  E_coul = 198.70027550000398
Extra cycle  E= -507.975706204226  delta_E= -3.41e-13  |g|= 2.99e-09  |ddm|= 5.45e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.28 sec
exp = [2.25293699e-01 5.25072345e-01 1.17616814e+05 7.96734167e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315477e+03 1.83757993e+04
 1.44908387e+03 3.76380046e+02 1.14553925e+02 3.83024950e+01
 8.39821307e+00 3.60956651e+00 8.60492512e+00 4.92727563e-01]
E = -507.97570620422596
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:07:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.225293699135       1
[INPUT] 0    0    [1    /1   ]  0.525072345122       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.796734167101       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200227        1
[INPUT] 0    0    [1    /1   ]  36754.7149368        1
[INPUT] 0    0    [1    /1   ]  7303.15477366        1
[INPUT] 0    0    [1    /1   ]  18375.799277         1
[INPUT] 0    0    [1    /1   ]  1449.08387131        1
[INPUT] 0    0    [1    /1   ]  376.380046057        1
[INPUT] 0    0    [1    /1   ]  114.553924929        1
[INPUT] 0    0    [1    /1   ]  38.3024949892        1
[INPUT] 0    0    [1    /1   ]  8.39821306874        1
[INPUT] 0    0    [1    /1   ]  3.60956650761        1
[INPUT] 1    0    [1    /1   ]  8.6049251156         1
[INPUT] 1    0    [1    /1   ]  0.492727562886       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.22529369913509562, 1.0]], [0, [0.5250723451223405, 1.0]], [0, [117616.81386777067, 1.0]], [0, [0.7967341671012098, 1.0]], [0, [1176168.1426172426, 1.0]], [0, [588084.0699825027, 1.0]], [0, [294042.03107368416, 1.0]], [0, [147020.9919195973, 1.0]], [0, [73510.42002273967, 1.0]], [0, [36754.714936798424, 1.0]], [0, [7303.154773655749, 1.0]], [0, [18375.799277027807, 1.0]], [0, [1449.0838713103885, 1.0]], [0, [376.3800460574703, 1.0]], [0, [114.55392492928003, 1.0]], [0, [38.302494989240515, 1.0]], [0, [8.398213068744871, 1.0]], [0, [3.6095665076061447, 1.0]], [1, [8.604925115595568, 1.0]], [1, [0.49272756288581304, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2252937]
bas 1, expnt(s) = [0.52507235]
bas 2, expnt(s) = [117616.81386777]
bas 3, expnt(s) = [0.79673417]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.0699825]
bas 6, expnt(s) = [294042.03107368]
bas 7, expnt(s) = [147020.9919196]
bas 8, expnt(s) = [73510.42002274]
bas 9, expnt(s) = [36754.7149368]
bas 10, expnt(s) = [7303.15477366]
bas 11, expnt(s) = [18375.79927703]
bas 12, expnt(s) = [1449.08387131]
bas 13, expnt(s) = [376.38004606]
bas 14, expnt(s) = [114.55392493]
bas 15, expnt(s) = [38.30249499]
bas 16, expnt(s) = [8.39821307]
bas 17, expnt(s) = [3.60956651]
bas 18, expnt(s) = [8.60492512]
bas 19, expnt(s) = [0.49272756]
CPU time:       139.05
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.25293699e-01 8.26184054e-01 5.25072345e-01 1.55840159e+00
 1.17616814e+05 1.60460109e+04 7.96734167e-01 2.13059109e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315477e+03 1.99594193e+03 1.83757993e+04 3.98749088e+03
 1.44908387e+03 5.93383091e+02 3.76380046e+02 2.15891214e+02
 1.14553925e+02 8.84652083e+01 3.83024950e+01 3.88987211e+01
 8.39821307e+00 1.24639354e+01 3.60956651e+00 6.61616474e+00
 8.60492512e+00 4.29950305e+01 4.92727563e-01 1.20432295e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335973202894024
cond(S) = 907910.4314761921
E1 = -689.5773124955944  E_coul = 184.97485305071754
init E= -504.602459444877
    CPU time for initialize scf      0.43 sec, wall time      0.06 sec
  HOMO = -0.672156115022738  LUMO = 0.406291260025029
  mo_energy =
[-1.21703673e+02 -1.33843694e+01 -7.62327872e+00 -7.62327872e+00
 -7.62327872e+00 -1.65761283e+00 -6.72156115e-01 -6.72156115e-01
 -6.72156115e-01  4.06291260e-01  2.81039413e+00  1.61281660e+01
  1.17691501e+02  6.16393294e+02  2.76085029e+03  1.22392854e+04
  4.08591258e+04  1.04901772e+05  2.30084635e+05  4.55899213e+05
  8.44851227e+05  1.52802828e+06  2.85029542e+06  5.80818238e+06]
E1 = -707.7462543642414  E_coul = 199.78847107544195
cycle= 1 E= -507.957783288799  delta_E= -3.36  |g|= 0.45  |ddm|= 0.499
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.643728
diis-c [-0.41438627  1.        ]
  HOMO = -0.217548151804628  LUMO = 0.709594059805942
  mo_energy =
[-1.20193989e+02 -1.23027039e+01 -6.59336657e+00 -6.59336657e+00
 -6.59336657e+00 -1.16315899e+00 -2.17548152e-01 -2.17548152e-01
 -2.17548152e-01  7.09594060e-01  3.31065830e+00  1.70763114e+01
  1.19090530e+02  6.17887897e+02  2.76228400e+03  1.22406099e+04
  4.08603837e+04  1.04902993e+05  2.30085832e+05  4.55900393e+05
  8.44852394e+05  1.52802943e+06  2.85029656e+06  5.80818352e+06]
E1 = -706.7998068653175  E_coul = 198.82436729030096
cycle= 2 E= -507.975439575016  delta_E= -0.0177  |g|= 0.035  |ddm|= 0.349
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0334599
diis-c [-0.00111525 -0.00324085  1.00324085]
  HOMO = -0.239579054645034  LUMO = 0.707723940370364
  mo_energy =
[-1.20308015e+02 -1.23698808e+01 -6.66774855e+00 -6.66774855e+00
 -6.66774855e+00 -1.17733749e+00 -2.39579055e-01 -2.39579055e-01
 -2.39579055e-01  7.07723940e-01  3.29325496e+00  1.70218418e+01
  1.18995057e+02  6.17769825e+02  2.76214990e+03  1.22404656e+04
  4.08602357e+04  1.04902843e+05  2.30085681e+05  4.55900242e+05
  8.44852243e+05  1.52802928e+06  2.85029641e+06  5.80818336e+06]
E1 = -706.6921111693339  E_coul = 198.716410263411
cycle= 3 E= -507.975700905923  delta_E= -0.000261  |g|= 0.00436  |ddm|= 0.0532
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00416624
diis-c [-2.48533605e-06 -3.49279710e-04 -1.29420519e-01  1.12976980e+00]
  HOMO = -0.242789352960676  LUMO = 0.707268898446988
  mo_energy =
[-1.20319905e+02 -1.23785515e+01 -6.67690411e+00 -6.67690411e+00
 -6.67690411e+00 -1.17928734e+00 -2.42789353e-01 -2.42789353e-01
 -2.42789353e-01  7.07268898e-01  3.29044790e+00  1.70145996e+01
  1.18984411e+02  6.17757780e+02  2.76213705e+03  1.22404523e+04
  4.08602222e+04  1.04902830e+05  2.30085668e+05  4.55900229e+05
  8.44852229e+05  1.52802927e+06  2.85029640e+06  5.80818335e+06]
E1 = -706.6764048925062  E_coul = 198.7006986975838
cycle= 4 E= -507.975706194922  delta_E= -5.29e-06  |g|= 0.000192  |ddm|= 0.0132
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00013202
diis-c [-7.92367170e-10 -1.03258618e-05  7.86783162e-03 -8.46758913e-02
  1.07681839e+00]
  HOMO = -0.242871948794546  LUMO = 0.707246345287599
  mo_energy =
[-1.20319960e+02 -1.23786927e+01 -6.67702717e+00 -6.67702717e+00
 -6.67702717e+00 -1.17933762e+00 -2.42871949e-01 -2.42871949e-01
 -2.42871949e-01  7.07246345e-01  3.29035969e+00  1.70144674e+01
  1.18984325e+02  6.17757730e+02  2.76213702e+03  1.22404523e+04
  4.08602222e+04  1.04902830e+05  2.30085668e+05  4.55900229e+05
  8.44852229e+05  1.52802927e+06  2.85029640e+06  5.80818335e+06]
E1 = -706.6759965045591  E_coul = 198.70029030035596
cycle= 5 E= -507.975706204203  delta_E= -9.28e-09  |g|= 1.01e-05  |ddm|= 0.00115
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.96134e-06
diis-c [-1.18879394e-12  7.91602405e-07 -9.52450632e-04  9.79630486e-03
 -1.34709103e-01  1.12586446e+00]
  HOMO = -0.242874625083551  LUMO = 0.707245615664992
  mo_energy =
[-1.20319964e+02 -1.23786962e+01 -6.67703060e+00 -6.67703060e+00
 -6.67703060e+00 -1.17933961e+00 -2.42874625e-01 -2.42874625e-01
 -2.42874625e-01  7.07245616e-01  3.29035657e+00  1.70144638e+01
  1.18984321e+02  6.17757726e+02  2.76213702e+03  1.22404523e+04
  4.08602222e+04  1.04902830e+05  2.30085668e+05  4.55900229e+05
  8.44852229e+05  1.52802927e+06  2.85029640e+06  5.80818335e+06]
E1 = -706.6759817339968  E_coul = 198.70027552977112
cycle= 6 E= -507.975706204226  delta_E= -2.25e-11  |g|= 4.47e-08  |ddm|= 7.03e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6759817339968  E_coul = 198.70027552977112
  HOMO = -0.242874641490426  LUMO = 0.707245595456036
  mo_energy =
[-1.20319964e+02 -1.23786962e+01 -6.67703063e+00 -6.67703063e+00
 -6.67703063e+00 -1.17933960e+00 -2.42874641e-01 -2.42874641e-01
 -2.42874641e-01  7.07245595e-01  3.29035654e+00  1.70144637e+01
  1.18984321e+02  6.17757726e+02  2.76213702e+03  1.22404523e+04
  4.08602222e+04  1.04902830e+05  2.30085668e+05  4.55900229e+05
  8.44852229e+05  1.52802927e+06  2.85029640e+06  5.80818335e+06]
E1 = -706.6759817042299  E_coul = 198.70027550000398
Extra cycle  E= -507.975706204226  delta_E= -3.41e-13  |g|= 2.99e-09  |ddm|= 5.45e-08
    CPU time for scf_cycle      1.12 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907910.4314761921
E1 = -706.6759817042299  E_coul = 198.70027550000398
init E= -507.975706204226
    CPU time for initialize scf      3.77 sec, wall time      0.24 sec
  HOMO = -0.242874642424621  LUMO = 0.707245597616482
  mo_energy =
[-1.20319964e+02 -1.23786962e+01 -6.67703063e+00 -6.67703063e+00
 -6.67703063e+00 -1.17933960e+00 -2.42874642e-01 -2.42874642e-01
 -2.42874642e-01  7.07245598e-01  3.29035654e+00  1.70144637e+01
  1.18984321e+02  6.17757726e+02  2.76213702e+03  1.22404523e+04
  4.08602222e+04  1.04902830e+05  2.30085668e+05  4.55900229e+05
  8.44852229e+05  1.52802927e+06  2.85029640e+06  5.80818335e+06]
E1 = -706.6759816951763  E_coul = 198.70027549095036
cycle= 1 E= -507.975706204226  delta_E=    0  |g|= 1.47e-09  |ddm|= 6.33e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6759816951763  E_coul = 198.70027549095036
  HOMO = -0.242874642688452  LUMO = 0.707245596614043
  mo_energy =
[-1.20319964e+02 -1.23786962e+01 -6.67703063e+00 -6.67703063e+00
 -6.67703063e+00 -1.17933960e+00 -2.42874643e-01 -2.42874643e-01
 -2.42874643e-01  7.07245597e-01  3.29035654e+00  1.70144637e+01
  1.18984321e+02  6.17757726e+02  2.76213702e+03  1.22404523e+04
  4.08602222e+04  1.04902830e+05  2.30085668e+05  4.55900229e+05
  8.44852229e+05  1.52802927e+06  2.85029640e+06  5.80818335e+06]
E1 = -706.6759816988551  E_coul = 198.7002754946292
Extra cycle  E= -507.975706204226  delta_E=    0  |g|= 1.97e-09  |ddm|= 3.4e-09
    CPU time for scf_cycle      4.22 sec, wall time      0.41 sec
exp = [2.25293699e-01 5.25072345e-01 1.17616814e+05 7.96734167e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315477e+03 1.83757993e+04
 1.44908387e+03 3.76380046e+02 1.14553925e+02 3.83024950e+01
 8.39821307e+00 3.60956651e+00 8.60492512e+00 4.92727563e-01]
grad_E = [ 1.06072243e-02 -6.81976904e-03  4.30687376e-09 -4.14854408e-03
  2.02363265e-11  1.16820499e-10  6.69976853e-10  2.62884276e-09
  1.09261518e-08  5.86251251e-08  3.69260430e-06  1.27508432e-07
  2.01711091e-06 -2.48583819e-05  2.47355112e-04 -1.19303483e-03
 -3.06674580e-03  5.92964987e-03  6.60511293e-04  8.89844947e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:07:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.217914051546       1
[INPUT] 0    0    [1    /1   ]  0.532460283743       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.80552071326        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200227        1
[INPUT] 0    0    [1    /1   ]  36754.7149366        1
[INPUT] 0    0    [1    /1   ]  7303.15476185        1
[INPUT] 0    0    [1    /1   ]  18375.7992766        1
[INPUT] 0    0    [1    /1   ]  1449.08386754        1
[INPUT] 0    0    [1    /1   ]  376.38008251         1
[INPUT] 0    0    [1    /1   ]  114.553567178        1
[INPUT] 0    0    [1    /1   ]  38.3041477995        1
[INPUT] 0    0    [1    /1   ]  8.40001388189        1
[INPUT] 0    0    [1    /1   ]  3.6128300719         1
[INPUT] 1    0    [1    /1   ]  8.60435619883        1
[INPUT] 1    0    [1    /1   ]  0.492702079667       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2179140515460217, 1.0]], [0, [0.5324602837427368, 1.0]], [0, [117616.81386775691, 1.0]], [0, [0.8055207132600599, 1.0]], [0, [1176168.1426172426, 1.0]], [0, [588084.0699825024, 1.0]], [0, [294042.031073682, 1.0]], [0, [147020.99191958888, 1.0]], [0, [73510.42002270474, 1.0]], [0, [36754.714936611046, 1.0]], [0, [7303.1547618475315, 1.0]], [0, [18375.799276619768, 1.0]], [0, [1449.0838675426342, 1.0]], [0, [376.38008251010615, 1.0]], [0, [114.55356717771123, 1.0]], [0, [38.304147799525076, 1.0]], [0, [8.400013881893896, 1.0]], [0, [3.6128300718975312, 1.0]], [1, [8.604356198828302, 1.0]], [1, [0.4927020796669797, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.21791405]
bas 1, expnt(s) = [0.53246028]
bas 2, expnt(s) = [117616.81386776]
bas 3, expnt(s) = [0.80552071]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.0699825]
bas 6, expnt(s) = [294042.03107368]
bas 7, expnt(s) = [147020.99191959]
bas 8, expnt(s) = [73510.4200227]
bas 9, expnt(s) = [36754.71493661]
bas 10, expnt(s) = [7303.15476185]
bas 11, expnt(s) = [18375.79927662]
bas 12, expnt(s) = [1449.08386754]
bas 13, expnt(s) = [376.38008251]
bas 14, expnt(s) = [114.55356718]
bas 15, expnt(s) = [38.3041478]
bas 16, expnt(s) = [8.40001388]
bas 17, expnt(s) = [3.61283007]
bas 18, expnt(s) = [8.6043562]
bas 19, expnt(s) = [0.49270208]
CPU time:       151.14
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.17914052e-01 8.05803131e-01 5.32460284e-01 1.57481825e+00
 1.17616814e+05 1.60460109e+04 8.05520713e-01 2.14818935e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315476e+03 1.99594193e+03 1.83757993e+04 3.98749088e+03
 1.44908387e+03 5.93383089e+02 3.76380083e+02 2.15891229e+02
 1.14553567e+02 8.84650011e+01 3.83041478e+01 3.88999800e+01
 8.40001388e+00 1.24659399e+01 3.61283007e+00 6.62065070e+00
 8.60435620e+00 4.29914773e+01 4.92702080e-01 1.20424510e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336073375434644
cond(S) = 907911.0350756927
E1 = -689.5740324234414  E_coul = 184.97046300160747
init E= -504.603569421834
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672196841464775  LUMO = 0.396107225073052
  mo_energy =
[-1.21704351e+02 -1.33847608e+01 -7.62360733e+00 -7.62360733e+00
 -7.62360733e+00 -1.65762849e+00 -6.72196841e-01 -6.72196841e-01
 -6.72196841e-01  3.96107225e-01  2.81610003e+00  1.61774082e+01
  1.17753748e+02  6.16448939e+02  2.76089829e+03  1.22393270e+04
  4.08591643e+04  1.04901809e+05  2.30084670e+05  4.55899248e+05
  8.44851262e+05  1.52802831e+06  2.85029545e+06  5.80818241e+06]
E1 = -707.7393234913503  E_coul = 199.78146910553738
cycle= 1 E= -507.957854385813  delta_E= -3.35  |g|= 0.45  |ddm|= 0.473
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.645548
diis-c [-0.41673215  1.        ]
  HOMO = -0.21767068902105  LUMO = 0.698252995066754
  mo_energy =
[-1.20194960e+02 -1.23032461e+01 -6.59387991e+00 -6.59387991e+00
 -6.59387991e+00 -1.16329595e+00 -2.17670689e-01 -2.17670689e-01
 -2.17670689e-01  6.98252995e-01  3.31825993e+00  1.71258860e+01
  1.19152469e+02  6.17943243e+02  2.76233169e+03  1.22406512e+04
  4.08604218e+04  1.04903029e+05  2.30085867e+05  4.55900428e+05
  8.44852428e+05  1.52802946e+06  2.85029659e+06  5.80818355e+06]
E1 = -706.7902084825959  E_coul = 198.81464580146704
cycle= 2 E= -507.975562681129  delta_E= -0.0177  |g|= 0.035  |ddm|= 0.355
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0341195
diis-c [-0.00115834 -0.0037496   1.0037496 ]
  HOMO = -0.239809377316009  LUMO = 0.696385511829193
  mo_energy =
[-1.20309272e+02 -1.23706502e+01 -6.66849738e+00 -6.66849738e+00
 -6.66849738e+00 -1.17754846e+00 -2.39809377e-01 -2.39809377e-01
 -2.39809377e-01  6.96385512e-01  3.30061369e+00  1.70711642e+01
  1.19056732e+02  6.17824882e+02  2.76219728e+03  1.22405066e+04
  4.08602735e+04  1.04902880e+05  2.30085716e+05  4.55900277e+05
  8.44852277e+05  1.52802931e+06  2.85029644e+06  5.80818340e+06]
E1 = -706.6818026010556  E_coul = 198.70597607010967
cycle= 3 E= -507.975826530946  delta_E= -0.000264  |g|= 0.00437  |ddm|= 0.0533
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00427358
diis-c [-2.57448221e-06 -3.53218771e-04 -1.30426444e-01  1.13077966e+00]
  HOMO = -0.243038874103546  LUMO = 0.695928073021003
  mo_energy =
[-1.20321182e+02 -1.23793519e+01 -6.67768217e+00 -6.67768217e+00
 -6.67768217e+00 -1.17951001e+00 -2.43038874e-01 -2.43038874e-01
 -2.43038874e-01  6.95928073e-01  3.29776485e+00  1.70638868e+01
  1.19046060e+02  6.17812817e+02  2.76218441e+03  1.22404933e+04
  4.08602600e+04  1.04902866e+05  2.30085703e+05  4.55900263e+05
  8.44852263e+05  1.52802930e+06  2.85029643e+06  5.80818338e+06]
E1 = -706.6659833851596  E_coul = 198.69015151114382
cycle= 4 E= -507.975831874016  delta_E= -5.34e-06  |g|= 0.000191  |ddm|= 0.0134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00013345
diis-c [-8.23857792e-10 -1.07614180e-05  7.86746133e-03 -8.39545102e-02
  1.07609781e+00]
  HOMO = -0.243119241006501  LUMO = 0.695905722357928
  mo_energy =
[-1.20321227e+02 -1.23794857e+01 -6.67779718e+00 -6.67779718e+00
 -6.67779718e+00 -1.17955893e+00 -2.43119241e-01 -2.43119241e-01
 -2.43119241e-01  6.95905722e-01  3.29767778e+00  1.70637606e+01
  1.19045984e+02  6.17812778e+02  2.76218440e+03  1.22404933e+04
  4.08602600e+04  1.04902866e+05  2.30085703e+05  4.55900263e+05
  8.44852263e+05  1.52802930e+06  2.85029643e+06  5.80818338e+06]
E1 = -706.6655856166503  E_coul = 198.68975373353751
cycle= 5 E= -507.975831883113  delta_E= -9.1e-09  |g|= 1.01e-05  |ddm|= 0.00117
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.03923e-06
diis-c [-1.19928050e-12  7.86461356e-07 -9.51009328e-04  9.69203938e-03
 -1.34351733e-01  1.12560992e+00]
  HOMO = -0.243121846842201  LUMO = 0.695905004666824
  mo_energy =
[-1.20321230e+02 -1.23794890e+01 -6.67780036e+00 -6.67780036e+00
 -6.67780036e+00 -1.17956089e+00 -2.43121847e-01 -2.43121847e-01
 -2.43121847e-01  6.95905005e-01  3.29767468e+00  1.70637572e+01
  1.19045981e+02  6.17812775e+02  2.76218439e+03  1.22404933e+04
  4.08602600e+04  1.04902866e+05  2.30085703e+05  4.55900263e+05
  8.44852263e+05  1.52802930e+06  2.85029643e+06  5.80818338e+06]
E1 = -706.6655711391571  E_coul = 198.68973925602154
cycle= 6 E= -507.975831883136  delta_E= -2.27e-11  |g|= 4.47e-08  |ddm|= 7.14e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6655711391571  E_coul = 198.68973925602154
  HOMO = -0.243121862997544  LUMO = 0.695904983651668
  mo_energy =
[-1.20321230e+02 -1.23794890e+01 -6.67780039e+00 -6.67780039e+00
 -6.67780039e+00 -1.17956088e+00 -2.43121863e-01 -2.43121863e-01
 -2.43121863e-01  6.95904984e-01  3.29767466e+00  1.70637571e+01
  1.19045981e+02  6.17812775e+02  2.76218439e+03  1.22404933e+04
  4.08602600e+04  1.04902866e+05  2.30085703e+05  4.55900263e+05
  8.44852263e+05  1.52802930e+06  2.85029643e+06  5.80818338e+06]
E1 = -706.6655711118764  E_coul = 198.68973922874065
Extra cycle  E= -507.975831883136  delta_E= -1.14e-13  |g|= 2.45e-09  |ddm|= 6.29e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.17914052e-01 5.32460284e-01 1.17616814e+05 8.05520713e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315476e+03 1.83757993e+04
 1.44908387e+03 3.76380083e+02 1.14553567e+02 3.83041478e+01
 8.40001388e+00 3.61283007e+00 8.60435620e+00 4.92702080e-01]
E = -507.9758318831357
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:07:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.217914051546       1
[INPUT] 0    0    [1    /1   ]  0.532460283743       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.80552071326        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200227        1
[INPUT] 0    0    [1    /1   ]  36754.7149366        1
[INPUT] 0    0    [1    /1   ]  7303.15476185        1
[INPUT] 0    0    [1    /1   ]  18375.7992766        1
[INPUT] 0    0    [1    /1   ]  1449.08386754        1
[INPUT] 0    0    [1    /1   ]  376.38008251         1
[INPUT] 0    0    [1    /1   ]  114.553567178        1
[INPUT] 0    0    [1    /1   ]  38.3041477995        1
[INPUT] 0    0    [1    /1   ]  8.40001388189        1
[INPUT] 0    0    [1    /1   ]  3.6128300719         1
[INPUT] 1    0    [1    /1   ]  8.60435619883        1
[INPUT] 1    0    [1    /1   ]  0.492702079667       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2179140515460217, 1.0]], [0, [0.5324602837427368, 1.0]], [0, [117616.81386775691, 1.0]], [0, [0.8055207132600599, 1.0]], [0, [1176168.1426172426, 1.0]], [0, [588084.0699825024, 1.0]], [0, [294042.031073682, 1.0]], [0, [147020.99191958888, 1.0]], [0, [73510.42002270474, 1.0]], [0, [36754.714936611046, 1.0]], [0, [7303.1547618475315, 1.0]], [0, [18375.799276619768, 1.0]], [0, [1449.0838675426342, 1.0]], [0, [376.38008251010615, 1.0]], [0, [114.55356717771123, 1.0]], [0, [38.304147799525076, 1.0]], [0, [8.400013881893896, 1.0]], [0, [3.6128300718975312, 1.0]], [1, [8.604356198828302, 1.0]], [1, [0.4927020796669797, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.21791405]
bas 1, expnt(s) = [0.53246028]
bas 2, expnt(s) = [117616.81386776]
bas 3, expnt(s) = [0.80552071]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.0699825]
bas 6, expnt(s) = [294042.03107368]
bas 7, expnt(s) = [147020.99191959]
bas 8, expnt(s) = [73510.4200227]
bas 9, expnt(s) = [36754.71493661]
bas 10, expnt(s) = [7303.15476185]
bas 11, expnt(s) = [18375.79927662]
bas 12, expnt(s) = [1449.08386754]
bas 13, expnt(s) = [376.38008251]
bas 14, expnt(s) = [114.55356718]
bas 15, expnt(s) = [38.3041478]
bas 16, expnt(s) = [8.40001388]
bas 17, expnt(s) = [3.61283007]
bas 18, expnt(s) = [8.6043562]
bas 19, expnt(s) = [0.49270208]
CPU time:       152.37
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.17914052e-01 8.05803131e-01 5.32460284e-01 1.57481825e+00
 1.17616814e+05 1.60460109e+04 8.05520713e-01 2.14818935e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315476e+03 1.99594193e+03 1.83757993e+04 3.98749088e+03
 1.44908387e+03 5.93383089e+02 3.76380083e+02 2.15891229e+02
 1.14553567e+02 8.84650011e+01 3.83041478e+01 3.88999800e+01
 8.40001388e+00 1.24659399e+01 3.61283007e+00 6.62065070e+00
 8.60435620e+00 4.29914773e+01 4.92702080e-01 1.20424510e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336073375434644
cond(S) = 907911.0350756927
E1 = -689.5740324234414  E_coul = 184.97046300160747
init E= -504.603569421834
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672196841464775  LUMO = 0.396107225073052
  mo_energy =
[-1.21704351e+02 -1.33847608e+01 -7.62360733e+00 -7.62360733e+00
 -7.62360733e+00 -1.65762849e+00 -6.72196841e-01 -6.72196841e-01
 -6.72196841e-01  3.96107225e-01  2.81610003e+00  1.61774082e+01
  1.17753748e+02  6.16448939e+02  2.76089829e+03  1.22393270e+04
  4.08591643e+04  1.04901809e+05  2.30084670e+05  4.55899248e+05
  8.44851262e+05  1.52802831e+06  2.85029545e+06  5.80818241e+06]
E1 = -707.7393234913503  E_coul = 199.78146910553738
cycle= 1 E= -507.957854385813  delta_E= -3.35  |g|= 0.45  |ddm|= 0.473
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.645548
diis-c [-0.41673215  1.        ]
  HOMO = -0.21767068902105  LUMO = 0.698252995066754
  mo_energy =
[-1.20194960e+02 -1.23032461e+01 -6.59387991e+00 -6.59387991e+00
 -6.59387991e+00 -1.16329595e+00 -2.17670689e-01 -2.17670689e-01
 -2.17670689e-01  6.98252995e-01  3.31825993e+00  1.71258860e+01
  1.19152469e+02  6.17943243e+02  2.76233169e+03  1.22406512e+04
  4.08604218e+04  1.04903029e+05  2.30085867e+05  4.55900428e+05
  8.44852428e+05  1.52802946e+06  2.85029659e+06  5.80818355e+06]
E1 = -706.7902084825959  E_coul = 198.81464580146704
cycle= 2 E= -507.975562681129  delta_E= -0.0177  |g|= 0.035  |ddm|= 0.355
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0341195
diis-c [-0.00115834 -0.0037496   1.0037496 ]
  HOMO = -0.239809377316009  LUMO = 0.696385511829193
  mo_energy =
[-1.20309272e+02 -1.23706502e+01 -6.66849738e+00 -6.66849738e+00
 -6.66849738e+00 -1.17754846e+00 -2.39809377e-01 -2.39809377e-01
 -2.39809377e-01  6.96385512e-01  3.30061369e+00  1.70711642e+01
  1.19056732e+02  6.17824882e+02  2.76219728e+03  1.22405066e+04
  4.08602735e+04  1.04902880e+05  2.30085716e+05  4.55900277e+05
  8.44852277e+05  1.52802931e+06  2.85029644e+06  5.80818340e+06]
E1 = -706.6818026010556  E_coul = 198.70597607010967
cycle= 3 E= -507.975826530946  delta_E= -0.000264  |g|= 0.00437  |ddm|= 0.0533
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00427358
diis-c [-2.57448221e-06 -3.53218771e-04 -1.30426444e-01  1.13077966e+00]
  HOMO = -0.243038874103546  LUMO = 0.695928073021003
  mo_energy =
[-1.20321182e+02 -1.23793519e+01 -6.67768217e+00 -6.67768217e+00
 -6.67768217e+00 -1.17951001e+00 -2.43038874e-01 -2.43038874e-01
 -2.43038874e-01  6.95928073e-01  3.29776485e+00  1.70638868e+01
  1.19046060e+02  6.17812817e+02  2.76218441e+03  1.22404933e+04
  4.08602600e+04  1.04902866e+05  2.30085703e+05  4.55900263e+05
  8.44852263e+05  1.52802930e+06  2.85029643e+06  5.80818338e+06]
E1 = -706.6659833851596  E_coul = 198.69015151114382
cycle= 4 E= -507.975831874016  delta_E= -5.34e-06  |g|= 0.000191  |ddm|= 0.0134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00013345
diis-c [-8.23857792e-10 -1.07614180e-05  7.86746133e-03 -8.39545102e-02
  1.07609781e+00]
  HOMO = -0.243119241006501  LUMO = 0.695905722357928
  mo_energy =
[-1.20321227e+02 -1.23794857e+01 -6.67779718e+00 -6.67779718e+00
 -6.67779718e+00 -1.17955893e+00 -2.43119241e-01 -2.43119241e-01
 -2.43119241e-01  6.95905722e-01  3.29767778e+00  1.70637606e+01
  1.19045984e+02  6.17812778e+02  2.76218440e+03  1.22404933e+04
  4.08602600e+04  1.04902866e+05  2.30085703e+05  4.55900263e+05
  8.44852263e+05  1.52802930e+06  2.85029643e+06  5.80818338e+06]
E1 = -706.6655856166503  E_coul = 198.68975373353751
cycle= 5 E= -507.975831883113  delta_E= -9.1e-09  |g|= 1.01e-05  |ddm|= 0.00117
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.03923e-06
diis-c [-1.19928050e-12  7.86461356e-07 -9.51009328e-04  9.69203938e-03
 -1.34351733e-01  1.12560992e+00]
  HOMO = -0.243121846842201  LUMO = 0.695905004666824
  mo_energy =
[-1.20321230e+02 -1.23794890e+01 -6.67780036e+00 -6.67780036e+00
 -6.67780036e+00 -1.17956089e+00 -2.43121847e-01 -2.43121847e-01
 -2.43121847e-01  6.95905005e-01  3.29767468e+00  1.70637572e+01
  1.19045981e+02  6.17812775e+02  2.76218439e+03  1.22404933e+04
  4.08602600e+04  1.04902866e+05  2.30085703e+05  4.55900263e+05
  8.44852263e+05  1.52802930e+06  2.85029643e+06  5.80818338e+06]
E1 = -706.6655711391571  E_coul = 198.68973925602154
cycle= 6 E= -507.975831883136  delta_E= -2.27e-11  |g|= 4.47e-08  |ddm|= 7.14e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6655711391571  E_coul = 198.68973925602154
  HOMO = -0.243121862997544  LUMO = 0.695904983651668
  mo_energy =
[-1.20321230e+02 -1.23794890e+01 -6.67780039e+00 -6.67780039e+00
 -6.67780039e+00 -1.17956088e+00 -2.43121863e-01 -2.43121863e-01
 -2.43121863e-01  6.95904984e-01  3.29767466e+00  1.70637571e+01
  1.19045981e+02  6.17812775e+02  2.76218439e+03  1.22404933e+04
  4.08602600e+04  1.04902866e+05  2.30085703e+05  4.55900263e+05
  8.44852263e+05  1.52802930e+06  2.85029643e+06  5.80818338e+06]
E1 = -706.6655711118764  E_coul = 198.68973922874065
Extra cycle  E= -507.975831883136  delta_E= -1.14e-13  |g|= 2.45e-09  |ddm|= 6.29e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907911.0350756927
E1 = -706.6655711118764  E_coul = 198.68973922874065
init E= -507.975831883136
    CPU time for initialize scf      3.37 sec, wall time      0.21 sec
  HOMO = -0.243121863835737  LUMO = 0.695904984527157
  mo_energy =
[-1.20321230e+02 -1.23794890e+01 -6.67780039e+00 -6.67780039e+00
 -6.67780039e+00 -1.17956088e+00 -2.43121864e-01 -2.43121864e-01
 -2.43121864e-01  6.95904985e-01  3.29767466e+00  1.70637571e+01
  1.19045981e+02  6.17812775e+02  2.76218439e+03  1.22404933e+04
  4.08602600e+04  1.04902866e+05  2.30085703e+05  4.55900263e+05
  8.44852263e+05  1.52802930e+06  2.85029643e+06  5.80818338e+06]
E1 = -706.6655711063399  E_coul = 198.68973922320464
cycle= 1 E= -507.975831883135  delta_E= 3.98e-13  |g|= 1.15e-09  |ddm|= 2.96e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6655711063399  E_coul = 198.68973922320464
  HOMO = -0.2431218639973  LUMO = 0.695904982955489
  mo_energy =
[-1.20321230e+02 -1.23794890e+01 -6.67780040e+00 -6.67780040e+00
 -6.67780040e+00 -1.17956088e+00 -2.43121864e-01 -2.43121864e-01
 -2.43121864e-01  6.95904983e-01  3.29767466e+00  1.70637571e+01
  1.19045981e+02  6.17812775e+02  2.76218439e+03  1.22404933e+04
  4.08602600e+04  1.04902866e+05  2.30085703e+05  4.55900263e+05
  8.44852263e+05  1.52802930e+06  2.85029643e+06  5.80818338e+06]
E1 = -706.6655711082465  E_coul = 198.6897392251106
Extra cycle  E= -507.975831883136  delta_E= -5.68e-13  |g|= 1.45e-09  |ddm|= 2.66e-09
    CPU time for scf_cycle      3.82 sec, wall time      0.38 sec
exp = [2.17914052e-01 5.32460284e-01 1.17616814e+05 8.05520713e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315476e+03 1.83757993e+04
 1.44908387e+03 3.76380083e+02 1.14553567e+02 3.83041478e+01
 8.40001388e+00 3.61283007e+00 8.60435620e+00 4.92702080e-01]
grad_E = [ 3.78682714e-03 -5.31937937e-03  4.30721184e-09 -4.32063817e-03
  2.02404920e-11  1.16831537e-10  6.70029259e-10  2.62905173e-09
  1.09270326e-08  5.86294675e-08  3.69292069e-06  1.27521638e-07
  1.99791106e-06 -2.46013765e-05  2.45755977e-04 -1.19080233e-03
 -2.99796787e-03  5.46080688e-03  1.77070797e-04 -7.54070302e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:07:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.21732208408        1
[INPUT] 0    0    [1    /1   ]  0.61894270655        1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.87461795491        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200224        1
[INPUT] 0    0    [1    /1   ]  36754.7149347        1
[INPUT] 0    0    [1    /1   ]  7303.15464452        1
[INPUT] 0    0    [1    /1   ]  18375.7992726        1
[INPUT] 0    0    [1    /1   ]  1449.08383671        1
[INPUT] 0    0    [1    /1   ]  376.380339127        1
[INPUT] 0    0    [1    /1   ]  114.5510371          1
[INPUT] 0    0    [1    /1   ]  38.3156287199        1
[INPUT] 0    0    [1    /1   ]  8.40468100413        1
[INPUT] 0    0    [1    /1   ]  3.67214139956        1
[INPUT] 1    0    [1    /1   ]  8.60346494992        1
[INPUT] 1    0    [1    /1   ]  0.492673875167       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2173220840797151, 1.0]], [0, [0.61894270655015, 1.0]], [0, [117616.81386762012, 1.0]], [0, [0.8746179549101701, 1.0]], [0, [1176168.142617242, 1.0]], [0, [588084.0699824987, 1.0]], [0, [294042.0310736607, 1.0]], [0, [147020.99191950538, 1.0]], [0, [73510.42002235769, 1.0]], [0, [36754.714934749536, 1.0]], [0, [7303.154644524444, 1.0]], [0, [18375.79927256482, 1.0]], [0, [1449.08383670577, 1.0]], [0, [376.3803391273668, 1.0]], [0, [114.55103710007262, 1.0]], [0, [38.31562871993299, 1.0]], [0, [8.404681004134614, 1.0]], [0, [3.672141399560692, 1.0]], [1, [8.603464949917413, 1.0]], [1, [0.492673875167111, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.21732208]
bas 1, expnt(s) = [0.61894271]
bas 2, expnt(s) = [117616.81386762]
bas 3, expnt(s) = [0.87461795]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.0699825]
bas 6, expnt(s) = [294042.03107366]
bas 7, expnt(s) = [147020.99191951]
bas 8, expnt(s) = [73510.42002236]
bas 9, expnt(s) = [36754.71493475]
bas 10, expnt(s) = [7303.15464452]
bas 11, expnt(s) = [18375.79927256]
bas 12, expnt(s) = [1449.08383671]
bas 13, expnt(s) = [376.38033913]
bas 14, expnt(s) = [114.5510371]
bas 15, expnt(s) = [38.31562872]
bas 16, expnt(s) = [8.404681]
bas 17, expnt(s) = [3.6721414]
bas 18, expnt(s) = [8.60346495]
bas 19, expnt(s) = [0.49267388]
CPU time:       164.03
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.17322084e-01 8.04160839e-01 6.18942707e-01 1.76300223e+00
 1.17616814e+05 1.60460109e+04 8.74617955e-01 2.28496113e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315464e+03 1.99594191e+03 1.83757993e+04 3.98749088e+03
 1.44908384e+03 5.93383080e+02 3.76380339e+02 2.15891340e+02
 1.14551037e+02 8.84635357e+01 3.83156287e+01 3.89087243e+01
 8.40468100e+00 1.24711341e+01 3.67214140e+00 6.70200228e+00
 8.60346495e+00 4.29859110e+01 4.92673875e-01 1.20415893e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33616583448859
cond(S) = 907925.3001473614
E1 = -689.5689080927154  E_coul = 184.9630857202095
init E= -504.605822372506
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672256575151586  LUMO = 0.44320731884176
  mo_energy =
[-1.21705529e+02 -1.33854882e+01 -7.62418964e+00 -7.62418964e+00
 -7.62418964e+00 -1.65746290e+00 -6.72256575e-01 -6.72256575e-01
 -6.72256575e-01  4.43207319e-01  3.19787487e+00  1.70547224e+01
  1.18708731e+02  6.17267971e+02  2.76160066e+03  1.22399364e+04
  4.08597272e+04  1.04902348e+05  2.30085195e+05  4.55899761e+05
  8.44851767e+05  1.52802881e+06  2.85029594e+06  5.80818288e+06]
E1 = -707.7251215045985  E_coul = 199.7671313403744
cycle= 1 E= -507.957990164224  delta_E= -3.35  |g|= 0.45  |ddm|= 0.474
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.649976
diis-c [-0.42246832  1.        ]
  HOMO = -0.217943580441402  LUMO = 0.75827588418862
  mo_energy =
[-1.20197061e+02 -1.23043461e+01 -6.59491886e+00 -6.59491886e+00
 -6.59491886e+00 -1.16345258e+00 -2.17943580e-01 -2.17943580e-01
 -2.17943580e-01  7.58275884e-01  3.72310421e+00  1.80062614e+01
  1.20105967e+02  6.18761142e+02  2.76303288e+03  1.22412593e+04
  4.08609835e+04  1.04903568e+05  2.30086390e+05  4.55900940e+05
  8.44852931e+05  1.52802996e+06  2.85029708e+06  5.80818402e+06]
E1 = -706.7703731408862  E_coul = 198.79454750109483
cycle= 2 E= -507.975825639791  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.378
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0350426
diis-c [-0.00121958 -0.00448704  1.00448704]
  HOMO = -0.240276834279389  LUMO = 0.75592646940248
  mo_energy =
[-1.20311976e+02 -1.23722185e+01 -6.67002905e+00 -6.67002905e+00
 -6.67002905e+00 -1.17783008e+00 -2.40276834e-01 -2.40276834e-01
 -2.40276834e-01  7.55926469e-01  3.70316777e+00  1.79505373e+01
  1.20009687e+02  6.18642182e+02  2.76289783e+03  1.22411141e+04
  4.08608345e+04  1.04903417e+05  2.30086238e+05  4.55900788e+05
  8.44852779e+05  1.52802981e+06  2.85029693e+06  5.80818387e+06]
E1 = -706.6613664734103  E_coul = 198.68527581891624
cycle= 3 E= -507.976090654494  delta_E= -0.000265  |g|= 0.00434  |ddm|= 0.0739
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00436713
diis-c [-2.68392972e-06 -3.07196861e-04 -1.29795920e-01  1.13010312e+00]
  HOMO = -0.243506564108288  LUMO = 0.755384431959319
  mo_energy =
[-1.20323852e+02 -1.23809098e+01 -6.67919988e+00 -6.67919988e+00
 -6.67919988e+00 -1.17978945e+00 -2.43506564e-01 -2.43506564e-01
 -2.43506564e-01  7.55384432e-01  3.70002579e+00  1.79432102e+01
  1.19999042e+02  6.18630156e+02  2.76288501e+03  1.22411008e+04
  4.08608211e+04  1.04903404e+05  2.30086225e+05  4.55900774e+05
  8.44852766e+05  1.52802979e+06  2.85029691e+06  5.80818385e+06]
E1 = -706.6456574364447  E_coul = 198.66956158066412
cycle= 4 E= -507.976095855781  delta_E= -5.2e-06  |g|= 0.000179  |ddm|= 0.0189
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000129286
diis-c [-6.21742511e-10 -1.17384539e-05  7.48003050e-03 -7.99910944e-02
  1.07252280e+00]
  HOMO = -0.243583077983636  LUMO = 0.755360591388443
  mo_energy =
[-1.20323889e+02 -1.23810365e+01 -6.67930785e+00 -6.67930785e+00
 -6.67930785e+00 -1.17983587e+00 -2.43583078e-01 -2.43583078e-01
 -2.43583078e-01  7.55360591e-01  3.69993743e+00  1.79430909e+01
  1.19998973e+02  6.18630123e+02  2.76288500e+03  1.22411008e+04
  4.08608211e+04  1.04903404e+05  2.30086225e+05  4.55900774e+05
  8.44852766e+05  1.52802979e+06  2.85029691e+06  5.80818385e+06]
E1 = -706.6452874551431  E_coul = 198.66919159196138
cycle= 5 E= -507.976095863182  delta_E= -7.4e-09  |g|= 8.62e-06  |ddm|= 0.00149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.41734e-06
diis-c [-1.02463835e-12  6.88358977e-07 -8.56370682e-04  8.72227266e-03
 -1.24590169e-01  1.11672358e+00]
  HOMO = -0.243585465492198  LUMO = 0.755359889198272
  mo_energy =
[-1.20323892e+02 -1.23810396e+01 -6.67931084e+00 -6.67931084e+00
 -6.67931084e+00 -1.17983765e+00 -2.43585465e-01 -2.43585465e-01
 -2.43585465e-01  7.55359889e-01  3.69993451e+00  1.79430877e+01
  1.19998970e+02  6.18630120e+02  2.76288500e+03  1.22411008e+04
  4.08608211e+04  1.04903404e+05  2.30086225e+05  4.55900774e+05
  8.44852766e+05  1.52802979e+06  2.85029691e+06  5.80818385e+06]
E1 = -706.6452747180047  E_coul = 198.6691788548082
cycle= 6 E= -507.976095863196  delta_E= -1.47e-11  |g|= 4.63e-08  |ddm|= 8.25e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6452747180047  E_coul = 198.6691788548082
  HOMO = -0.2435854831139  LUMO = 0.755359866591644
  mo_energy =
[-1.20323892e+02 -1.23810396e+01 -6.67931087e+00 -6.67931087e+00
 -6.67931087e+00 -1.17983765e+00 -2.43585483e-01 -2.43585483e-01
 -2.43585483e-01  7.55359867e-01  3.69993448e+00  1.79430876e+01
  1.19998970e+02  6.18630120e+02  2.76288500e+03  1.22411008e+04
  4.08608211e+04  1.04903404e+05  2.30086225e+05  4.55900774e+05
  8.44852766e+05  1.52802979e+06  2.85029691e+06  5.80818385e+06]
E1 = -706.6452746746544  E_coul = 198.6691788114573
Extra cycle  E= -507.976095863197  delta_E= -6.25e-13  |g|= 4.08e-09  |ddm|= 1.12e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.17322084e-01 6.18942707e-01 1.17616814e+05 8.74617955e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315464e+03 1.83757993e+04
 1.44908384e+03 3.76380339e+02 1.14551037e+02 3.83156287e+01
 8.40468100e+00 3.67214140e+00 8.60346495e+00 4.92673875e-01]
E = -507.9760958631971
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:07:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.21732208408        1
[INPUT] 0    0    [1    /1   ]  0.61894270655        1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.87461795491        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.99192         1
[INPUT] 0    0    [1    /1   ]  73510.4200224        1
[INPUT] 0    0    [1    /1   ]  36754.7149347        1
[INPUT] 0    0    [1    /1   ]  7303.15464452        1
[INPUT] 0    0    [1    /1   ]  18375.7992726        1
[INPUT] 0    0    [1    /1   ]  1449.08383671        1
[INPUT] 0    0    [1    /1   ]  376.380339127        1
[INPUT] 0    0    [1    /1   ]  114.5510371          1
[INPUT] 0    0    [1    /1   ]  38.3156287199        1
[INPUT] 0    0    [1    /1   ]  8.40468100413        1
[INPUT] 0    0    [1    /1   ]  3.67214139956        1
[INPUT] 1    0    [1    /1   ]  8.60346494992        1
[INPUT] 1    0    [1    /1   ]  0.492673875167       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2173220840797151, 1.0]], [0, [0.61894270655015, 1.0]], [0, [117616.81386762012, 1.0]], [0, [0.8746179549101701, 1.0]], [0, [1176168.142617242, 1.0]], [0, [588084.0699824987, 1.0]], [0, [294042.0310736607, 1.0]], [0, [147020.99191950538, 1.0]], [0, [73510.42002235769, 1.0]], [0, [36754.714934749536, 1.0]], [0, [7303.154644524444, 1.0]], [0, [18375.79927256482, 1.0]], [0, [1449.08383670577, 1.0]], [0, [376.3803391273668, 1.0]], [0, [114.55103710007262, 1.0]], [0, [38.31562871993299, 1.0]], [0, [8.404681004134614, 1.0]], [0, [3.672141399560692, 1.0]], [1, [8.603464949917413, 1.0]], [1, [0.492673875167111, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.21732208]
bas 1, expnt(s) = [0.61894271]
bas 2, expnt(s) = [117616.81386762]
bas 3, expnt(s) = [0.87461795]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.0699825]
bas 6, expnt(s) = [294042.03107366]
bas 7, expnt(s) = [147020.99191951]
bas 8, expnt(s) = [73510.42002236]
bas 9, expnt(s) = [36754.71493475]
bas 10, expnt(s) = [7303.15464452]
bas 11, expnt(s) = [18375.79927256]
bas 12, expnt(s) = [1449.08383671]
bas 13, expnt(s) = [376.38033913]
bas 14, expnt(s) = [114.5510371]
bas 15, expnt(s) = [38.31562872]
bas 16, expnt(s) = [8.404681]
bas 17, expnt(s) = [3.6721414]
bas 18, expnt(s) = [8.60346495]
bas 19, expnt(s) = [0.49267388]
CPU time:       165.26
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.17322084e-01 8.04160839e-01 6.18942707e-01 1.76300223e+00
 1.17616814e+05 1.60460109e+04 8.74617955e-01 2.28496113e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315464e+03 1.99594191e+03 1.83757993e+04 3.98749088e+03
 1.44908384e+03 5.93383080e+02 3.76380339e+02 2.15891340e+02
 1.14551037e+02 8.84635357e+01 3.83156287e+01 3.89087243e+01
 8.40468100e+00 1.24711341e+01 3.67214140e+00 6.70200228e+00
 8.60346495e+00 4.29859110e+01 4.92673875e-01 1.20415893e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33616583448859
cond(S) = 907925.3001473614
E1 = -689.5689080927154  E_coul = 184.9630857202095
init E= -504.605822372506
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672256575151586  LUMO = 0.44320731884176
  mo_energy =
[-1.21705529e+02 -1.33854882e+01 -7.62418964e+00 -7.62418964e+00
 -7.62418964e+00 -1.65746290e+00 -6.72256575e-01 -6.72256575e-01
 -6.72256575e-01  4.43207319e-01  3.19787487e+00  1.70547224e+01
  1.18708731e+02  6.17267971e+02  2.76160066e+03  1.22399364e+04
  4.08597272e+04  1.04902348e+05  2.30085195e+05  4.55899761e+05
  8.44851767e+05  1.52802881e+06  2.85029594e+06  5.80818288e+06]
E1 = -707.7251215045985  E_coul = 199.7671313403744
cycle= 1 E= -507.957990164224  delta_E= -3.35  |g|= 0.45  |ddm|= 0.474
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.649976
diis-c [-0.42246832  1.        ]
  HOMO = -0.217943580441402  LUMO = 0.75827588418862
  mo_energy =
[-1.20197061e+02 -1.23043461e+01 -6.59491886e+00 -6.59491886e+00
 -6.59491886e+00 -1.16345258e+00 -2.17943580e-01 -2.17943580e-01
 -2.17943580e-01  7.58275884e-01  3.72310421e+00  1.80062614e+01
  1.20105967e+02  6.18761142e+02  2.76303288e+03  1.22412593e+04
  4.08609835e+04  1.04903568e+05  2.30086390e+05  4.55900940e+05
  8.44852931e+05  1.52802996e+06  2.85029708e+06  5.80818402e+06]
E1 = -706.7703731408862  E_coul = 198.79454750109483
cycle= 2 E= -507.975825639791  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.378
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0350426
diis-c [-0.00121958 -0.00448704  1.00448704]
  HOMO = -0.240276834279389  LUMO = 0.75592646940248
  mo_energy =
[-1.20311976e+02 -1.23722185e+01 -6.67002905e+00 -6.67002905e+00
 -6.67002905e+00 -1.17783008e+00 -2.40276834e-01 -2.40276834e-01
 -2.40276834e-01  7.55926469e-01  3.70316777e+00  1.79505373e+01
  1.20009687e+02  6.18642182e+02  2.76289783e+03  1.22411141e+04
  4.08608345e+04  1.04903417e+05  2.30086238e+05  4.55900788e+05
  8.44852779e+05  1.52802981e+06  2.85029693e+06  5.80818387e+06]
E1 = -706.6613664734103  E_coul = 198.68527581891624
cycle= 3 E= -507.976090654494  delta_E= -0.000265  |g|= 0.00434  |ddm|= 0.0739
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00436713
diis-c [-2.68392972e-06 -3.07196861e-04 -1.29795920e-01  1.13010312e+00]
  HOMO = -0.243506564108288  LUMO = 0.755384431959319
  mo_energy =
[-1.20323852e+02 -1.23809098e+01 -6.67919988e+00 -6.67919988e+00
 -6.67919988e+00 -1.17978945e+00 -2.43506564e-01 -2.43506564e-01
 -2.43506564e-01  7.55384432e-01  3.70002579e+00  1.79432102e+01
  1.19999042e+02  6.18630156e+02  2.76288501e+03  1.22411008e+04
  4.08608211e+04  1.04903404e+05  2.30086225e+05  4.55900774e+05
  8.44852766e+05  1.52802979e+06  2.85029691e+06  5.80818385e+06]
E1 = -706.6456574364447  E_coul = 198.66956158066412
cycle= 4 E= -507.976095855781  delta_E= -5.2e-06  |g|= 0.000179  |ddm|= 0.0189
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000129286
diis-c [-6.21742511e-10 -1.17384539e-05  7.48003050e-03 -7.99910944e-02
  1.07252280e+00]
  HOMO = -0.243583077983636  LUMO = 0.755360591388443
  mo_energy =
[-1.20323889e+02 -1.23810365e+01 -6.67930785e+00 -6.67930785e+00
 -6.67930785e+00 -1.17983587e+00 -2.43583078e-01 -2.43583078e-01
 -2.43583078e-01  7.55360591e-01  3.69993743e+00  1.79430909e+01
  1.19998973e+02  6.18630123e+02  2.76288500e+03  1.22411008e+04
  4.08608211e+04  1.04903404e+05  2.30086225e+05  4.55900774e+05
  8.44852766e+05  1.52802979e+06  2.85029691e+06  5.80818385e+06]
E1 = -706.6452874551431  E_coul = 198.66919159196138
cycle= 5 E= -507.976095863182  delta_E= -7.4e-09  |g|= 8.62e-06  |ddm|= 0.00149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.41734e-06
diis-c [-1.02463835e-12  6.88358977e-07 -8.56370682e-04  8.72227266e-03
 -1.24590169e-01  1.11672358e+00]
  HOMO = -0.243585465492198  LUMO = 0.755359889198272
  mo_energy =
[-1.20323892e+02 -1.23810396e+01 -6.67931084e+00 -6.67931084e+00
 -6.67931084e+00 -1.17983765e+00 -2.43585465e-01 -2.43585465e-01
 -2.43585465e-01  7.55359889e-01  3.69993451e+00  1.79430877e+01
  1.19998970e+02  6.18630120e+02  2.76288500e+03  1.22411008e+04
  4.08608211e+04  1.04903404e+05  2.30086225e+05  4.55900774e+05
  8.44852766e+05  1.52802979e+06  2.85029691e+06  5.80818385e+06]
E1 = -706.6452747180047  E_coul = 198.6691788548082
cycle= 6 E= -507.976095863196  delta_E= -1.47e-11  |g|= 4.63e-08  |ddm|= 8.25e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6452747180047  E_coul = 198.6691788548082
  HOMO = -0.2435854831139  LUMO = 0.755359866591644
  mo_energy =
[-1.20323892e+02 -1.23810396e+01 -6.67931087e+00 -6.67931087e+00
 -6.67931087e+00 -1.17983765e+00 -2.43585483e-01 -2.43585483e-01
 -2.43585483e-01  7.55359867e-01  3.69993448e+00  1.79430876e+01
  1.19998970e+02  6.18630120e+02  2.76288500e+03  1.22411008e+04
  4.08608211e+04  1.04903404e+05  2.30086225e+05  4.55900774e+05
  8.44852766e+05  1.52802979e+06  2.85029691e+06  5.80818385e+06]
E1 = -706.6452746746544  E_coul = 198.6691788114573
Extra cycle  E= -507.976095863197  delta_E= -6.25e-13  |g|= 4.08e-09  |ddm|= 1.12e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907925.3001473614
E1 = -706.6452746746544  E_coul = 198.6691788114573
init E= -507.976095863197
    CPU time for initialize scf      3.39 sec, wall time      0.21 sec
  HOMO = -0.243585484647163  LUMO = 0.755359867706094
  mo_energy =
[-1.20323892e+02 -1.23810396e+01 -6.67931087e+00 -6.67931087e+00
 -6.67931087e+00 -1.17983765e+00 -2.43585485e-01 -2.43585485e-01
 -2.43585485e-01  7.55359868e-01  3.69993448e+00  1.79430876e+01
  1.19998970e+02  6.18630120e+02  2.76288500e+03  1.22411008e+04
  4.08608211e+04  1.04903404e+05  2.30086225e+05  4.55900774e+05
  8.44852766e+05  1.52802979e+06  2.85029691e+06  5.80818385e+06]
E1 = -706.6452746674977  E_coul = 198.66917880430069
cycle= 1 E= -507.976095863197  delta_E= 1.14e-13  |g|= 1.39e-09  |ddm|= 2.18e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6452746674977  E_coul = 198.66917880430069
  HOMO = -0.243585484897341  LUMO = 0.755359867521411
  mo_energy =
[-1.20323892e+02 -1.23810396e+01 -6.67931087e+00 -6.67931087e+00
 -6.67931087e+00 -1.17983765e+00 -2.43585485e-01 -2.43585485e-01
 -2.43585485e-01  7.55359868e-01  3.69993447e+00  1.79430876e+01
  1.19998970e+02  6.18630120e+02  2.76288500e+03  1.22411008e+04
  4.08608211e+04  1.04903404e+05  2.30086225e+05  4.55900774e+05
  8.44852766e+05  1.52802979e+06  2.85029691e+06  5.80818385e+06]
E1 = -706.6452746643866  E_coul = 198.66917880118916
Extra cycle  E= -507.976095863197  delta_E= -5.12e-13  |g|= 1.22e-09  |ddm|= 5.55e-09
    CPU time for scf_cycle      3.84 sec, wall time      0.38 sec
exp = [2.17322084e-01 6.18942707e-01 1.17616814e+05 8.74617955e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315464e+03 1.83757993e+04
 1.44908384e+03 3.76380339e+02 1.14551037e+02 3.83156287e+01
 8.40468100e+00 3.67214140e+00 8.60346495e+00 4.92673875e-01]
grad_E = [-1.68645918e-02 -2.66938303e-04  4.30447490e-09 -3.40533660e-03
  2.02086466e-11  1.16743337e-10  6.69605246e-10  2.62736142e-09
  1.09199132e-08  5.85941747e-08  3.69037485e-06  1.27416263e-07
  2.14960301e-06 -2.73020557e-05  2.76887954e-04 -1.36591700e-03
 -3.02172845e-03  4.41112363e-03 -6.65157357e-04 -3.63617835e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:07:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.234196264188       1
[INPUT] 0    0    [1    /1   ]  0.690491727863       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.928596261883       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.4200221        1
[INPUT] 0    0    [1    /1   ]  36754.7149333        1
[INPUT] 0    0    [1    /1   ]  7303.15455043        1
[INPUT] 0    0    [1    /1   ]  18375.7992693        1
[INPUT] 0    0    [1    /1   ]  1449.08381176        1
[INPUT] 0    0    [1    /1   ]  376.380548571        1
[INPUT] 0    0    [1    /1   ]  114.548960987        1
[INPUT] 0    0    [1    /1   ]  38.3251173298        1
[INPUT] 0    0    [1    /1   ]  8.40990824678        1
[INPUT] 0    0    [1    /1   ]  3.71452573499        1
[INPUT] 1    0    [1    /1   ]  8.60305128368        1
[INPUT] 1    0    [1    /1   ]  0.492627301184       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.23419626418835499, 1.0]], [0, [0.6904917278630908, 1.0]], [0, [117616.81386751041, 1.0]], [0, [0.9285962618827317, 1.0]], [0, [1176168.1426172415, 1.0]], [0, [588084.0699824956, 1.0]], [0, [294042.03107364365, 1.0]], [0, [147020.9919194384, 1.0]], [0, [73510.42002207934, 1.0]], [0, [36754.71493325652, 1.0]], [0, [7303.154550426556, 1.0]], [0, [18375.799269312596, 1.0]], [0, [1449.0838117632575, 1.0]], [0, [376.38054857089986, 1.0]], [0, [114.54896098700398, 1.0]], [0, [38.32511732982291, 1.0]], [0, [8.409908246782816, 1.0]], [0, [3.714525734988711, 1.0]], [1, [8.603051283679335, 1.0]], [1, [0.49262730118397174, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23419626]
bas 1, expnt(s) = [0.69049173]
bas 2, expnt(s) = [117616.81386751]
bas 3, expnt(s) = [0.92859626]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.0699825]
bas 6, expnt(s) = [294042.03107364]
bas 7, expnt(s) = [147020.99191944]
bas 8, expnt(s) = [73510.42002208]
bas 9, expnt(s) = [36754.71493326]
bas 10, expnt(s) = [7303.15455043]
bas 11, expnt(s) = [18375.79926931]
bas 12, expnt(s) = [1449.08381176]
bas 13, expnt(s) = [376.38054857]
bas 14, expnt(s) = [114.54896099]
bas 15, expnt(s) = [38.32511733]
bas 16, expnt(s) = [8.40990825]
bas 17, expnt(s) = [3.71452573]
bas 18, expnt(s) = [8.60305128]
bas 19, expnt(s) = [0.4926273]
CPU time:       176.93
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.34196264e-01 8.50550289e-01 6.90491728e-01 1.91374419e+00
 1.17616814e+05 1.60460109e+04 9.28596262e-01 2.38993023e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315455e+03 1.99594189e+03 1.83757993e+04 3.98749088e+03
 1.44908381e+03 5.93383072e+02 3.76380549e+02 2.15891430e+02
 1.14548961e+02 8.84623332e+01 3.83251173e+01 3.89159507e+01
 8.40990825e+00 1.24769509e+01 3.71452573e+00 6.75993551e+00
 8.60305128e+00 4.29833274e+01 4.92627301e-01 1.20401664e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336179913825017
cond(S) = 907938.9292154284
E1 = -689.5674462232716  E_coul = 184.96073647030153
init E= -504.60670975297
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672272622871855  LUMO = 0.522588827393065
  mo_energy =
[-1.21706032e+02 -1.33857528e+01 -7.62433737e+00 -7.62433737e+00
 -7.62433737e+00 -1.65748921e+00 -6.72272623e-01 -6.72272623e-01
 -6.72272623e-01  5.22588827e-01  3.58722306e+00  1.78280346e+01
  1.19536080e+02  6.17976970e+02  2.76220868e+03  1.22404640e+04
  4.08602147e+04  1.04902815e+05  2.30085649e+05  4.55900206e+05
  8.44852204e+05  1.52802924e+06  2.85029636e+06  5.80818329e+06]
E1 = -707.7184744914301  E_coul = 199.76011841623992
cycle= 1 E= -507.95835607519  delta_E= -3.35  |g|= 0.451  |ddm|= 0.592
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.651306
diis-c [-0.42419904  1.        ]
  HOMO = -0.218127919332751  LUMO = 0.853673342298757
  mo_energy =
[-1.20198079e+02 -1.23049056e+01 -6.59538275e+00 -6.59538275e+00
 -6.59538275e+00 -1.16359897e+00 -2.18127919e-01 -2.18127919e-01
 -2.18127919e-01  8.53673342e-01  4.12982705e+00  1.87814753e+01
  1.20932245e+02  6.19469451e+02  2.76364024e+03  1.22417862e+04
  4.08614703e+04  1.04904034e+05  2.30086843e+05  4.55901383e+05
  8.44853368e+05  1.52803039e+06  2.85029750e+06  5.80818443e+06]
E1 = -706.767637823026  E_coul = 198.79150878337578
cycle= 2 E= -507.97612903965  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.41
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0343168
diis-c [-0.00117065 -0.00408265  1.00408265]
  HOMO = -0.240281036317809  LUMO = 0.850802942940175
  mo_energy =
[-1.20312661e+02 -1.23724785e+01 -6.67019330e+00 -6.67019330e+00
 -6.67019330e+00 -1.17784295e+00 -2.40281036e-01 -2.40281036e-01
 -2.40281036e-01  8.50802943e-01  4.10837331e+00  1.87255879e+01
  1.20836295e+02  6.19350839e+02  2.76350554e+03  1.22416413e+04
  4.08613216e+04  1.04903884e+05  2.30086692e+05  4.55901232e+05
  8.44853216e+05  1.52803024e+06  2.85029735e+06  5.80818428e+06]
E1 = -706.6604565915394  E_coul = 198.68407013503955
cycle= 3 E= -507.9763864565  delta_E= -0.000257  |g|= 0.00428  |ddm|= 0.107
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00418505
diis-c [-2.59620696e-06 -2.39792206e-04 -1.26260750e-01  1.12650054e+00]
  HOMO = -0.24343239955522  LUMO = 0.850186569236451
  mo_energy =
[-1.20324371e+02 -1.23810187e+01 -6.67921210e+00 -6.67921210e+00
 -6.67921210e+00 -1.17975144e+00 -2.43432400e-01 -2.43432400e-01
 -2.43432400e-01  8.50186569e-01  4.10509020e+00  1.87183576e+01
  1.20825811e+02  6.19338979e+02  2.76349289e+03  1.22416282e+04
  4.08613084e+04  1.04903870e+05  2.30086679e+05  4.55901218e+05
  8.44853203e+05  1.52803022e+06  2.85029733e+06  5.80818426e+06]
E1 = -706.64529219628  E_coul = 198.66890088775307
cycle= 4 E= -507.976391308527  delta_E= -4.85e-06  |g|= 0.000168  |ddm|= 0.0256
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000123871
diis-c [-4.14929699e-10 -1.11147562e-05  7.14004190e-03 -7.86083116e-02
  1.07147938e+00]
  HOMO = -0.243509738077742  LUMO = 0.850161048401287
  mo_energy =
[-1.20324430e+02 -1.23811557e+01 -6.67933221e+00 -6.67933221e+00
 -6.67933221e+00 -1.17979820e+00 -2.43509738e-01 -2.43509738e-01
 -2.43509738e-01  8.50161048e-01  4.10499840e+00  1.87182312e+01
  1.20825725e+02  6.19338925e+02  2.76349286e+03  1.22416282e+04
  4.08613083e+04  1.04903870e+05  2.30086679e+05  4.55901218e+05
  8.44853203e+05  1.52803022e+06  2.85029733e+06  5.80818426e+06]
E1 = -706.644926621492  E_coul = 198.66853530667296
cycle= 5 E= -507.976391314819  delta_E= -6.29e-09  |g|= 7.17e-06  |ddm|= 0.00179
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.69398e-06
diis-c [-8.39807501e-13  5.65772264e-07 -7.51130051e-04  7.87238326e-03
 -1.12990078e-01  1.10586826e+00]
  HOMO = -0.243511937528423  LUMO = 0.850160374386924
  mo_energy =
[-1.20324433e+02 -1.23811589e+01 -6.67933530e+00 -6.67933530e+00
 -6.67933530e+00 -1.17979982e+00 -2.43511938e-01 -2.43511938e-01
 -2.43511938e-01  8.50160374e-01  4.10499569e+00  1.87182280e+01
  1.20825722e+02  6.19338921e+02  2.76349285e+03  1.22416282e+04
  4.08613083e+04  1.04903870e+05  2.30086679e+05  4.55901218e+05
  8.44853203e+05  1.52803022e+06  2.85029733e+06  5.80818426e+06]
E1 = -706.6449154325895  E_coul = 198.6685241177605
cycle= 6 E= -507.976391314829  delta_E= -1e-11  |g|= 6.41e-08  |ddm|= 8.73e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6449154325895  E_coul = 198.6685241177605
  HOMO = -0.243511960529672  LUMO = 0.850160350261885
  mo_energy =
[-1.20324433e+02 -1.23811589e+01 -6.67933533e+00 -6.67933533e+00
 -6.67933533e+00 -1.17979982e+00 -2.43511961e-01 -2.43511961e-01
 -2.43511961e-01  8.50160350e-01  4.10499565e+00  1.87182280e+01
  1.20825722e+02  6.19338921e+02  2.76349285e+03  1.22416282e+04
  4.08613083e+04  1.04903870e+05  2.30086679e+05  4.55901218e+05
  8.44853203e+05  1.52803022e+06  2.85029733e+06  5.80818426e+06]
E1 = -706.644915352499  E_coul = 198.66852403767
Extra cycle  E= -507.976391314829  delta_E= 5.68e-14  |g|= 7.4e-09  |ddm|= 4.88e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.34196264e-01 6.90491728e-01 1.17616814e+05 9.28596262e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315455e+03 1.83757993e+04
 1.44908381e+03 3.76380549e+02 1.14548961e+02 3.83251173e+01
 8.40990825e+00 3.71452573e+00 8.60305128e+00 4.92627301e-01]
E = -507.97639131482896
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:07:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.234196264188       1
[INPUT] 0    0    [1    /1   ]  0.690491727863       1
[INPUT] 0    0    [1    /1   ]  117616.813868        1
[INPUT] 0    0    [1    /1   ]  0.928596261883       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.4200221        1
[INPUT] 0    0    [1    /1   ]  36754.7149333        1
[INPUT] 0    0    [1    /1   ]  7303.15455043        1
[INPUT] 0    0    [1    /1   ]  18375.7992693        1
[INPUT] 0    0    [1    /1   ]  1449.08381176        1
[INPUT] 0    0    [1    /1   ]  376.380548571        1
[INPUT] 0    0    [1    /1   ]  114.548960987        1
[INPUT] 0    0    [1    /1   ]  38.3251173298        1
[INPUT] 0    0    [1    /1   ]  8.40990824678        1
[INPUT] 0    0    [1    /1   ]  3.71452573499        1
[INPUT] 1    0    [1    /1   ]  8.60305128368        1
[INPUT] 1    0    [1    /1   ]  0.492627301184       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.23419626418835499, 1.0]], [0, [0.6904917278630908, 1.0]], [0, [117616.81386751041, 1.0]], [0, [0.9285962618827317, 1.0]], [0, [1176168.1426172415, 1.0]], [0, [588084.0699824956, 1.0]], [0, [294042.03107364365, 1.0]], [0, [147020.9919194384, 1.0]], [0, [73510.42002207934, 1.0]], [0, [36754.71493325652, 1.0]], [0, [7303.154550426556, 1.0]], [0, [18375.799269312596, 1.0]], [0, [1449.0838117632575, 1.0]], [0, [376.38054857089986, 1.0]], [0, [114.54896098700398, 1.0]], [0, [38.32511732982291, 1.0]], [0, [8.409908246782816, 1.0]], [0, [3.714525734988711, 1.0]], [1, [8.603051283679335, 1.0]], [1, [0.49262730118397174, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23419626]
bas 1, expnt(s) = [0.69049173]
bas 2, expnt(s) = [117616.81386751]
bas 3, expnt(s) = [0.92859626]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.0699825]
bas 6, expnt(s) = [294042.03107364]
bas 7, expnt(s) = [147020.99191944]
bas 8, expnt(s) = [73510.42002208]
bas 9, expnt(s) = [36754.71493326]
bas 10, expnt(s) = [7303.15455043]
bas 11, expnt(s) = [18375.79926931]
bas 12, expnt(s) = [1449.08381176]
bas 13, expnt(s) = [376.38054857]
bas 14, expnt(s) = [114.54896099]
bas 15, expnt(s) = [38.32511733]
bas 16, expnt(s) = [8.40990825]
bas 17, expnt(s) = [3.71452573]
bas 18, expnt(s) = [8.60305128]
bas 19, expnt(s) = [0.4926273]
CPU time:       178.16
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.34196264e-01 8.50550289e-01 6.90491728e-01 1.91374419e+00
 1.17616814e+05 1.60460109e+04 9.28596262e-01 2.38993023e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315455e+03 1.99594189e+03 1.83757993e+04 3.98749088e+03
 1.44908381e+03 5.93383072e+02 3.76380549e+02 2.15891430e+02
 1.14548961e+02 8.84623332e+01 3.83251173e+01 3.89159507e+01
 8.40990825e+00 1.24769509e+01 3.71452573e+00 6.75993551e+00
 8.60305128e+00 4.29833274e+01 4.92627301e-01 1.20401664e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336179913825017
cond(S) = 907938.9292154284
E1 = -689.5674462232716  E_coul = 184.96073647030153
init E= -504.60670975297
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672272622871855  LUMO = 0.522588827393065
  mo_energy =
[-1.21706032e+02 -1.33857528e+01 -7.62433737e+00 -7.62433737e+00
 -7.62433737e+00 -1.65748921e+00 -6.72272623e-01 -6.72272623e-01
 -6.72272623e-01  5.22588827e-01  3.58722306e+00  1.78280346e+01
  1.19536080e+02  6.17976970e+02  2.76220868e+03  1.22404640e+04
  4.08602147e+04  1.04902815e+05  2.30085649e+05  4.55900206e+05
  8.44852204e+05  1.52802924e+06  2.85029636e+06  5.80818329e+06]
E1 = -707.7184744914301  E_coul = 199.76011841623992
cycle= 1 E= -507.95835607519  delta_E= -3.35  |g|= 0.451  |ddm|= 0.592
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.651306
diis-c [-0.42419904  1.        ]
  HOMO = -0.218127919332751  LUMO = 0.853673342298757
  mo_energy =
[-1.20198079e+02 -1.23049056e+01 -6.59538275e+00 -6.59538275e+00
 -6.59538275e+00 -1.16359897e+00 -2.18127919e-01 -2.18127919e-01
 -2.18127919e-01  8.53673342e-01  4.12982705e+00  1.87814753e+01
  1.20932245e+02  6.19469451e+02  2.76364024e+03  1.22417862e+04
  4.08614703e+04  1.04904034e+05  2.30086843e+05  4.55901383e+05
  8.44853368e+05  1.52803039e+06  2.85029750e+06  5.80818443e+06]
E1 = -706.767637823026  E_coul = 198.79150878337578
cycle= 2 E= -507.97612903965  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.41
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0343168
diis-c [-0.00117065 -0.00408265  1.00408265]
  HOMO = -0.240281036317809  LUMO = 0.850802942940175
  mo_energy =
[-1.20312661e+02 -1.23724785e+01 -6.67019330e+00 -6.67019330e+00
 -6.67019330e+00 -1.17784295e+00 -2.40281036e-01 -2.40281036e-01
 -2.40281036e-01  8.50802943e-01  4.10837331e+00  1.87255879e+01
  1.20836295e+02  6.19350839e+02  2.76350554e+03  1.22416413e+04
  4.08613216e+04  1.04903884e+05  2.30086692e+05  4.55901232e+05
  8.44853216e+05  1.52803024e+06  2.85029735e+06  5.80818428e+06]
E1 = -706.6604565915394  E_coul = 198.68407013503955
cycle= 3 E= -507.9763864565  delta_E= -0.000257  |g|= 0.00428  |ddm|= 0.107
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00418505
diis-c [-2.59620696e-06 -2.39792206e-04 -1.26260750e-01  1.12650054e+00]
  HOMO = -0.24343239955522  LUMO = 0.850186569236451
  mo_energy =
[-1.20324371e+02 -1.23810187e+01 -6.67921210e+00 -6.67921210e+00
 -6.67921210e+00 -1.17975144e+00 -2.43432400e-01 -2.43432400e-01
 -2.43432400e-01  8.50186569e-01  4.10509020e+00  1.87183576e+01
  1.20825811e+02  6.19338979e+02  2.76349289e+03  1.22416282e+04
  4.08613084e+04  1.04903870e+05  2.30086679e+05  4.55901218e+05
  8.44853203e+05  1.52803022e+06  2.85029733e+06  5.80818426e+06]
E1 = -706.64529219628  E_coul = 198.66890088775307
cycle= 4 E= -507.976391308527  delta_E= -4.85e-06  |g|= 0.000168  |ddm|= 0.0256
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000123871
diis-c [-4.14929699e-10 -1.11147562e-05  7.14004190e-03 -7.86083116e-02
  1.07147938e+00]
  HOMO = -0.243509738077742  LUMO = 0.850161048401287
  mo_energy =
[-1.20324430e+02 -1.23811557e+01 -6.67933221e+00 -6.67933221e+00
 -6.67933221e+00 -1.17979820e+00 -2.43509738e-01 -2.43509738e-01
 -2.43509738e-01  8.50161048e-01  4.10499840e+00  1.87182312e+01
  1.20825725e+02  6.19338925e+02  2.76349286e+03  1.22416282e+04
  4.08613083e+04  1.04903870e+05  2.30086679e+05  4.55901218e+05
  8.44853203e+05  1.52803022e+06  2.85029733e+06  5.80818426e+06]
E1 = -706.644926621492  E_coul = 198.66853530667296
cycle= 5 E= -507.976391314819  delta_E= -6.29e-09  |g|= 7.17e-06  |ddm|= 0.00179
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.69398e-06
diis-c [-8.39807501e-13  5.65772264e-07 -7.51130051e-04  7.87238326e-03
 -1.12990078e-01  1.10586826e+00]
  HOMO = -0.243511937528423  LUMO = 0.850160374386924
  mo_energy =
[-1.20324433e+02 -1.23811589e+01 -6.67933530e+00 -6.67933530e+00
 -6.67933530e+00 -1.17979982e+00 -2.43511938e-01 -2.43511938e-01
 -2.43511938e-01  8.50160374e-01  4.10499569e+00  1.87182280e+01
  1.20825722e+02  6.19338921e+02  2.76349285e+03  1.22416282e+04
  4.08613083e+04  1.04903870e+05  2.30086679e+05  4.55901218e+05
  8.44853203e+05  1.52803022e+06  2.85029733e+06  5.80818426e+06]
E1 = -706.6449154325895  E_coul = 198.6685241177605
cycle= 6 E= -507.976391314829  delta_E= -1e-11  |g|= 6.41e-08  |ddm|= 8.73e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6449154325895  E_coul = 198.6685241177605
  HOMO = -0.243511960529672  LUMO = 0.850160350261885
  mo_energy =
[-1.20324433e+02 -1.23811589e+01 -6.67933533e+00 -6.67933533e+00
 -6.67933533e+00 -1.17979982e+00 -2.43511961e-01 -2.43511961e-01
 -2.43511961e-01  8.50160350e-01  4.10499565e+00  1.87182280e+01
  1.20825722e+02  6.19338921e+02  2.76349285e+03  1.22416282e+04
  4.08613083e+04  1.04903870e+05  2.30086679e+05  4.55901218e+05
  8.44853203e+05  1.52803022e+06  2.85029733e+06  5.80818426e+06]
E1 = -706.644915352499  E_coul = 198.66852403767
Extra cycle  E= -507.976391314829  delta_E= 5.68e-14  |g|= 7.4e-09  |ddm|= 4.88e-07
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907938.9292154284
E1 = -706.644915352499  E_coul = 198.66852403767
init E= -507.976391314829
    CPU time for initialize scf      3.29 sec, wall time      0.21 sec
  HOMO = -0.243511963448973  LUMO = 0.850160349022167
  mo_energy =
[-1.20324433e+02 -1.23811589e+01 -6.67933533e+00 -6.67933533e+00
 -6.67933533e+00 -1.17979982e+00 -2.43511963e-01 -2.43511963e-01
 -2.43511963e-01  8.50160349e-01  4.10499565e+00  1.87182279e+01
  1.20825722e+02  6.19338921e+02  2.76349285e+03  1.22416282e+04
  4.08613083e+04  1.04903870e+05  2.30086679e+05  4.55901218e+05
  8.44853203e+05  1.52803022e+06  2.85029733e+06  5.80818426e+06]
E1 = -706.6449153364241  E_coul = 198.66852402159532
cycle= 1 E= -507.976391314829  delta_E= 1.71e-13  |g|= 2.75e-09  |ddm|= 6.82e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6449153364241  E_coul = 198.66852402159532
  HOMO = -0.243511963958243  LUMO = 0.850160350297615
  mo_energy =
[-1.20324433e+02 -1.23811589e+01 -6.67933533e+00 -6.67933533e+00
 -6.67933533e+00 -1.17979982e+00 -2.43511964e-01 -2.43511964e-01
 -2.43511964e-01  8.50160350e-01  4.10499565e+00  1.87182279e+01
  1.20825722e+02  6.19338921e+02  2.76349285e+03  1.22416282e+04
  4.08613083e+04  1.04903870e+05  2.30086679e+05  4.55901218e+05
  8.44853203e+05  1.52803022e+06  2.85029733e+06  5.80818426e+06]
E1 = -706.6449153320604  E_coul = 198.66852401723088
Extra cycle  E= -507.976391314829  delta_E= -6.82e-13  |g|= 2.22e-09  |ddm|= 1.62e-08
    CPU time for scf_cycle      3.74 sec, wall time      0.37 sec
exp = [2.34196264e-01 6.90491728e-01 1.17616814e+05 9.28596262e-01
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315455e+03 1.83757993e+04
 1.44908381e+03 3.76380549e+02 1.14548961e+02 3.83251173e+01
 8.40990825e+00 3.71452573e+00 8.60305128e+00 4.92627301e-01]
grad_E = [-1.04369834e-02 -8.39313038e-04  4.30262520e-09 -2.79274084e-03
  2.01869641e-11  1.16683486e-10  6.69318930e-10  2.62621858e-09
  1.09150968e-08  5.85703777e-08  3.68866419e-06  1.27344356e-07
  2.25297689e-06 -2.91895504e-05  2.98851400e-04 -1.49097989e-03
 -2.95746525e-03  3.86234310e-03 -1.00097694e-03 -3.83062884e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:07:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.291796008544       1
[INPUT] 0    0    [1    /1   ]  0.973934180627       1
[INPUT] 0    0    [1    /1   ]  117616.813867        1
[INPUT] 0    0    [1    /1   ]  1.14933823553        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.420021         1
[INPUT] 0    0    [1    /1   ]  36754.7149272        1
[INPUT] 0    0    [1    /1   ]  7303.15417151        1
[INPUT] 0    0    [1    /1   ]  18375.7992562        1
[INPUT] 0    0    [1    /1   ]  1449.08370796        1
[INPUT] 0    0    [1    /1   ]  376.381447358        1
[INPUT] 0    0    [1    /1   ]  114.540030299        1
[INPUT] 0    0    [1    /1   ]  38.3662465225        1
[INPUT] 0    0    [1    /1   ]  8.43760054483        1
[INPUT] 0    0    [1    /1   ]  3.87242612708        1
[INPUT] 1    0    [1    /1   ]  8.60348416925        1
[INPUT] 1    0    [1    /1   ]  0.49265572653        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2917960085442915, 1.0]], [0, [0.9739341806268282, 1.0]], [0, [117616.81386706863, 1.0]], [0, [1.149338235528829, 1.0]], [0, [1176168.1426172394, 1.0]], [0, [588084.0699824836, 1.0]], [0, [294042.0310735749, 1.0]], [0, [147020.99191916874, 1.0]], [0, [73510.42002095847, 1.0]], [0, [36754.71492724432, 1.0]], [0, [7303.154171513158, 1.0]], [0, [18375.799256216927, 1.0]], [0, [1449.0837079569671, 1.0]], [0, [376.38144735843787, 1.0]], [0, [114.54003029894197, 1.0]], [0, [38.36624652250858, 1.0]], [0, [8.437600544831183, 1.0]], [0, [3.872426127079642, 1.0]], [1, [8.603484169245633, 1.0]], [1, [0.49265572653029216, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.29179601]
bas 1, expnt(s) = [0.97393418]
bas 2, expnt(s) = [117616.81386707]
bas 3, expnt(s) = [1.14933824]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998248]
bas 6, expnt(s) = [294042.03107357]
bas 7, expnt(s) = [147020.99191917]
bas 8, expnt(s) = [73510.42002096]
bas 9, expnt(s) = [36754.71492724]
bas 10, expnt(s) = [7303.15417151]
bas 11, expnt(s) = [18375.79925622]
bas 12, expnt(s) = [1449.08370796]
bas 13, expnt(s) = [376.38144736]
bas 14, expnt(s) = [114.5400303]
bas 15, expnt(s) = [38.36624652]
bas 16, expnt(s) = [8.43760054]
bas 17, expnt(s) = [3.87242613]
bas 18, expnt(s) = [8.60348417]
bas 19, expnt(s) = [0.49265573]
CPU time:       189.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.91796009e-01 1.00305451e+00 9.73934181e-01 2.47692143e+00
 1.17616814e+05 1.60460109e+04 1.14933824e+00 2.80447075e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315417e+03 1.99594181e+03 1.83757993e+04 3.98749088e+03
 1.44908371e+03 5.93383040e+02 3.76381447e+02 2.15891816e+02
 1.14540030e+02 8.84571605e+01 3.83662465e+01 3.89472689e+01
 8.43760054e+00 1.25077515e+01 3.87242613e+00 6.97432820e+00
 8.60348417e+00 4.29860310e+01 4.92655727e-01 1.20410348e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335271516274126
cond(S) = 907995.6265601636
E1 = -689.5751328973254  E_coul = 184.96774567841572
init E= -504.60738721891
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672137422072897  LUMO = 0.847104237550521
  mo_energy =
[-1.21705445e+02 -1.33853573e+01 -7.62381205e+00 -7.62381205e+00
 -7.62381205e+00 -1.65736272e+00 -6.72137422e-01 -6.72137422e-01
 -6.72137422e-01  8.47104238e-01  5.10941496e+00  2.07959111e+01
  1.22817859e+02  6.20815268e+02  2.76464713e+03  1.22425809e+04
  4.08621711e+04  1.04904690e+05  2.30087470e+05  4.55901990e+05
  8.44853958e+05  1.52803096e+06  2.85029805e+06  5.80818494e+06]
E1 = -707.7296722477561  E_coul = 199.77065552656558
cycle= 1 E= -507.95901672119  delta_E= -3.35  |g|= 0.451  |ddm|= 3.47
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.662363
diis-c [-0.43872455  1.        ]
  HOMO = -0.217763649171119  LUMO = 1.23384869779345
  mo_energy =
[-1.20197554e+02 -1.23042532e+01 -6.59462943e+00 -6.59462943e+00
 -6.59462943e+00 -1.16292597e+00 -2.17763649e-01 -2.17763649e-01
 -2.17763649e-01  1.23384870e+00  5.70850623e+00  2.17590060e+01
  1.24211872e+02  6.22307066e+02  2.76607823e+03  1.22439026e+04
  4.08634261e+04  1.04905908e+05  2.30088664e+05  4.55903166e+05
  8.44855122e+05  1.52803211e+06  2.85029919e+06  5.80818608e+06]
E1 = -706.8139931616225  E_coul = 198.83788079626498
cycle= 2 E= -507.976112365358  delta_E= -0.0171  |g|= 0.0343  |ddm|= 2.11
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0313744
diis-c [-9.80110485e-04 -3.12173530e-03  1.00312174e+00]
  HOMO = -0.238570116669348  LUMO = 1.2291469436266
  mo_energy =
[-1.20309142e+02 -1.23692218e+01 -6.66679590e+00 -6.66679590e+00
 -6.66679590e+00 -1.17621052e+00 -2.38570117e-01 -2.38570117e-01
 -2.38570117e-01  1.22914694e+00  5.68312698e+00  2.17039579e+01
  1.24118790e+02  6.22191513e+02  2.76594668e+03  1.22437609e+04
  4.08632807e+04  1.04905761e+05  2.30088517e+05  4.55903018e+05
  8.44854973e+05  1.52803196e+06  2.85029904e+06  5.80818593e+06]
E1 = -706.7169799525908  E_coul = 198.74064883480148
cycle= 3 E= -507.976331117789  delta_E= -0.000219  |g|= 0.00394  |ddm|= 0.406
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00347887
diis-c [-2.32379448e-06  3.50612284e-05 -1.10936121e-01  1.11090106e+00]
  HOMO = -0.241295656382902  LUMO = 1.2283342688455
  mo_energy =
[-1.20319839e+02 -1.23768830e+01 -6.67492098e+00 -6.67492098e+00
 -6.67492098e+00 -1.17784744e+00 -2.41295656e-01 -2.41295656e-01
 -2.41295656e-01  1.22833427e+00  5.67966465e+00  2.16973799e+01
  1.24109270e+02  6.22180675e+02  2.76593509e+03  1.22437489e+04
  4.08632685e+04  1.04905749e+05  2.30088504e+05  4.55903006e+05
  8.44854961e+05  1.52803195e+06  2.85029903e+06  5.80818591e+06]
E1 = -706.7043744776288  E_coul = 198.72803987790485
cycle= 4 E= -507.976334599724  delta_E= -3.48e-06  |g|= 0.000142  |ddm|= 0.0728
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000116849
diis-c [-1.06960668e-10 -7.31797333e-06  6.27327230e-03 -8.00702512e-02
  1.07380430e+00]
  HOMO = -0.241375124477384  LUMO = 1.22830337309363
  mo_energy =
[-1.20319978e+02 -1.23770569e+01 -6.67508524e+00 -6.67508524e+00
 -6.67508524e+00 -1.17789513e+00 -2.41375124e-01 -2.41375124e-01
 -2.41375124e-01  1.22830337e+00  5.67955979e+00  2.16972266e+01
  1.24109120e+02  6.22180538e+02  2.76593496e+03  1.22437488e+04
  4.08632684e+04  1.04905749e+05  2.30088504e+05  4.55903006e+05
  8.44854961e+05  1.52803195e+06  2.85029903e+06  5.80818591e+06]
E1 = -706.7040199233577  E_coul = 198.72768531954753
cycle= 5 E= -507.97633460381  delta_E= -4.09e-09  |g|= 3.17e-06  |ddm|= 0.0038
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.96424e-07
diis-c [-2.46282256e-13  1.82096212e-07 -3.02803806e-04  3.62262023e-03
 -5.06773752e-02  1.04735738e+00]
  HOMO = -0.241376302412777  LUMO = 1.22830295256355
  mo_energy =
[-1.20319981e+02 -1.23770590e+01 -6.67508738e+00 -6.67508738e+00
 -6.67508738e+00 -1.17789599e+00 -2.41376302e-01 -2.41376302e-01
 -2.41376302e-01  1.22830295e+00  5.67955824e+00  2.16972246e+01
  1.24109118e+02  6.22180536e+02  2.76593495e+03  1.22437488e+04
  4.08632684e+04  1.04905749e+05  2.30088504e+05  4.55903006e+05
  8.44854961e+05  1.52803195e+06  2.85029903e+06  5.80818591e+06]
E1 = -706.7040146580616  E_coul = 198.7276800542493
cycle= 6 E= -507.976334603812  delta_E= -2.16e-12  |g|= 1.38e-07  |ddm|= 9.5e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7040146580616  E_coul = 198.7276800542493
  HOMO = -0.241376349377996  LUMO = 1.22830292688126
  mo_energy =
[-1.20319981e+02 -1.23770591e+01 -6.67508746e+00 -6.67508746e+00
 -6.67508746e+00 -1.17789602e+00 -2.41376349e-01 -2.41376349e-01
 -2.41376349e-01  1.22830293e+00  5.67955818e+00  2.16972245e+01
  1.24109118e+02  6.22180536e+02  2.76593495e+03  1.22437488e+04
  4.08632684e+04  1.04905749e+05  2.30088504e+05  4.55903006e+05
  8.44854961e+05  1.52803195e+06  2.85029903e+06  5.80818591e+06]
E1 = -706.7040144544221  E_coul = 198.7276798506094
Extra cycle  E= -507.976334603813  delta_E= -3.41e-13  |g|= 1.49e-08  |ddm|= 3.71e-06
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
exp = [2.91796009e-01 9.73934181e-01 1.17616814e+05 1.14933824e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315417e+03 1.83757993e+04
 1.44908371e+03 3.76381447e+02 1.14540030e+02 3.83662465e+01
 8.43760054e+00 3.87242613e+00 8.60348417e+00 4.92655727e-01]
E = -507.9763346038127
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:07:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.261438929656       1
[INPUT] 0    0    [1    /1   ]  0.824550099239       1
[INPUT] 0    0    [1    /1   ]  117616.813867        1
[INPUT] 0    0    [1    /1   ]  1.03299949856        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.4200215        1
[INPUT] 0    0    [1    /1   ]  36754.7149304        1
[INPUT] 0    0    [1    /1   ]  7303.15437121        1
[INPUT] 0    0    [1    /1   ]  18375.7992631        1
[INPUT] 0    0    [1    /1   ]  1449.08376267        1
[INPUT] 0    0    [1    /1   ]  376.380973666        1
[INPUT] 0    0    [1    /1   ]  114.544737084        1
[INPUT] 0    0    [1    /1   ]  38.3445700001        1
[INPUT] 0    0    [1    /1   ]  8.42300573567        1
[INPUT] 0    0    [1    /1   ]  3.78920710045        1
[INPUT] 1    0    [1    /1   ]  8.60325602342        1
[INPUT] 1    0    [1    /1   ]  0.492640745379       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.26143892965619253, 1.0]], [0, [0.8245500992390047, 1.0]], [0, [117616.81386730146, 1.0]], [0, [1.0329994985636084, 1.0]], [0, [1176168.1426172405, 1.0]], [0, [588084.0699824899, 1.0]], [0, [294042.0310736112, 1.0]], [0, [147020.99191931088, 1.0]], [0, [73510.4200215492, 1.0]], [0, [36754.714930412956, 1.0]], [0, [7303.154371213765, 1.0]], [0, [18375.799263118803, 1.0]], [0, [1449.0837626665111, 1.0]], [0, [376.38097366598487, 1.0]], [0, [114.54473708375595, 1.0]], [0, [38.34457000013988, 1.0]], [0, [8.423005735672792, 1.0]], [0, [3.7892071004543593, 1.0]], [1, [8.603256023419075, 1.0]], [1, [0.492640745379068, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26143893]
bas 1, expnt(s) = [0.8245501]
bas 2, expnt(s) = [117616.8138673]
bas 3, expnt(s) = [1.0329995]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998249]
bas 6, expnt(s) = [294042.03107361]
bas 7, expnt(s) = [147020.99191931]
bas 8, expnt(s) = [73510.42002155]
bas 9, expnt(s) = [36754.71493041]
bas 10, expnt(s) = [7303.15437121]
bas 11, expnt(s) = [18375.79926312]
bas 12, expnt(s) = [1449.08376267]
bas 13, expnt(s) = [376.38097367]
bas 14, expnt(s) = [114.54473708]
bas 15, expnt(s) = [38.34457]
bas 16, expnt(s) = [8.42300574]
bas 17, expnt(s) = [3.7892071]
bas 18, expnt(s) = [8.60325602]
bas 19, expnt(s) = [0.49264075]
CPU time:       190.92
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61438930e-01 9.23725041e-01 8.24550099e-01 2.18613919e+00
 1.17616814e+05 1.60460109e+04 1.03299950e+00 2.58874997e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315437e+03 1.99594185e+03 1.83757993e+04 3.98749088e+03
 1.44908376e+03 5.93383057e+02 3.76380974e+02 2.15891613e+02
 1.14544737e+02 8.84598867e+01 3.83445700e+01 3.89307641e+01
 8.42300574e+00 1.24915217e+01 3.78920710e+00 6.86161397e+00
 8.60325602e+00 4.29846061e+01 4.92640745e-01 1.20405771e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335932929847537
cond(S) = 907965.0773340833
E1 = -689.5721477718502  E_coul = 184.96391760121398
init E= -504.608230170636
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672202402464283  LUMO = 0.670317001662304
  mo_energy =
[-1.21705756e+02 -1.33856132e+01 -7.62410775e+00 -7.62410775e+00
 -7.62410775e+00 -1.65741909e+00 -6.72202402e-01 -6.72202402e-01
 -6.72202402e-01  6.70317002e-01  4.30638033e+00  1.92440391e+01
  1.21085033e+02  6.19313416e+02  2.76335638e+03  1.22414603e+04
  4.08611354e+04  1.04903697e+05  2.30086506e+05  4.55901045e+05
  8.44853029e+05  1.52803005e+06  2.85029715e+06  5.80818407e+06]
E1 = -707.7181786748222  E_coul = 199.7592985465105
cycle= 1 E= -507.958880128312  delta_E= -3.35  |g|= 0.451  |ddm|= 1.27
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.656225
diis-c [-0.43063139  1.        ]
  HOMO = -0.218155013518298  LUMO = 1.02865028273259
  mo_energy =
[-1.20198340e+02 -1.23050251e+01 -6.59544655e+00 -6.59544655e+00
 -6.59544655e+00 -1.16354028e+00 -2.18155014e-01 -2.18155014e-01
 -2.18155014e-01  1.02865028e+00  4.87774464e+00  2.02015967e+01
  1.22479654e+02  6.20805058e+02  2.76478718e+03  1.22427817e+04
  4.08623902e+04  1.04904915e+05  2.30087700e+05  4.55902222e+05
  8.44854193e+05  1.52803120e+06  2.85029829e+06  5.80818520e+06]
E1 = -706.7791274831799  E_coul = 198.80268542281317
cycle= 2 E= -507.976442060367  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.825
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0330447
diis-c [-0.00108636 -0.00362184  1.00362184]
  HOMO = -0.239833903108242  LUMO = 1.02485361274267
  mo_energy =
[-1.20311935e+02 -1.23717236e+01 -6.66937433e+00 -6.66937433e+00
 -6.66937433e+00 -1.17743806e+00 -2.39833903e-01 -2.39833903e-01
 -2.39833903e-01  1.02485361e+00  4.85399112e+00  2.01457484e+01
  1.22384660e+02  6.20687460e+02  2.76465352e+03  1.22426378e+04
  4.08622426e+04  1.04904766e+05  2.30087550e+05  4.55902071e+05
  8.44854042e+05  1.52803105e+06  2.85029814e+06  5.80818505e+06]
E1 = -706.6760580172518  E_coul = 198.69937487371686
cycle= 3 E= -507.976683143535  delta_E= -0.000241  |g|= 0.00414  |ddm|= 0.211
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00386152
diis-c [-2.48125533e-06 -1.05491876e-04 -1.19295110e-01  1.11940060e+00]
  HOMO = -0.242807448766332  LUMO = 1.02412436638968
  mo_energy =
[-1.20323234e+02 -1.23799041e+01 -6.67802802e+00 -6.67802802e+00
 -6.67802802e+00 -1.17923184e+00 -2.42807449e-01 -2.42807449e-01
 -2.42807449e-01  1.02412437e+00  4.85054943e+00  2.01387725e+01
  1.22374569e+02  6.20676015e+02  2.76464130e+03  1.22426252e+04
  4.08622297e+04  1.04904753e+05  2.30087537e+05  4.55902059e+05
  8.44854029e+05  1.52803104e+06  2.85029813e+06  5.80818504e+06]
E1 = -706.6620279977776  E_coul = 198.68534065830988
cycle= 4 E= -507.976687339468  delta_E= -4.2e-06  |g|= 0.000153  |ddm|= 0.0434
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00011889
diis-c [-2.01503045e-10 -9.34571165e-06  6.66007760e-03 -7.81690909e-02
  1.07151836e+00]
  HOMO = -0.242885905269187  LUMO = 1.02409618804805
  mo_energy =
[-1.20323331e+02 -1.23800591e+01 -6.67816958e+00 -6.67816958e+00
 -6.67816958e+00 -1.17927906e+00 -2.42885905e-01 -2.42885905e-01
 -2.42885905e-01  1.02409619e+00  4.85045148e+00  2.01386333e+01
  1.22374452e+02  6.20675921e+02  2.76464122e+03  1.22426251e+04
  4.08622297e+04  1.04904753e+05  2.30087537e+05  4.55902058e+05
  8.44854029e+05  1.52803104e+06  2.85029813e+06  5.80818504e+06]
E1 = -706.6616690916017  E_coul = 198.68498174722023
cycle= 5 E= -507.976687344381  delta_E= -4.91e-09  |g|= 4.95e-06  |ddm|= 0.00255
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.69655e-06
diis-c [-5.29147236e-13  3.57035775e-07 -5.36492264e-04  5.97726697e-03
 -8.53370615e-02  1.07989593e+00]
  HOMO = -0.242887617793173  LUMO = 1.02409561965031
  mo_energy =
[-1.20323334e+02 -1.23800619e+01 -6.67817235e+00 -6.67817235e+00
 -6.67817235e+00 -1.17928031e+00 -2.42887618e-01 -2.42887618e-01
 -2.42887618e-01  1.02409562e+00  4.85044931e+00  2.01386306e+01
  1.22374449e+02  6.20675918e+02  2.76464121e+03  1.22426251e+04
  4.08622297e+04  1.04904753e+05  2.30087537e+05  4.55902058e+05
  8.44854029e+05  1.52803104e+06  2.85029813e+06  5.80818504e+06]
E1 = -706.6616609585642  E_coul = 198.68497361417866
cycle= 6 E= -507.976687344386  delta_E= -4.15e-12  |g|= 1.13e-07  |ddm|= 9.34e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6616609585642  E_coul = 198.68497361417866
  HOMO = -0.242887655412936  LUMO = 1.02409559375447
  mo_energy =
[-1.20323334e+02 -1.23800620e+01 -6.67817241e+00 -6.67817241e+00
 -6.67817241e+00 -1.17928032e+00 -2.42887655e-01 -2.42887655e-01
 -2.42887655e-01  1.02409559e+00  4.85044926e+00  2.01386305e+01
  1.22374449e+02  6.20675917e+02  2.76464121e+03  1.22426251e+04
  4.08622297e+04  1.04904753e+05  2.30087537e+05  4.55902058e+05
  8.44854029e+05  1.52803104e+06  2.85029813e+06  5.80818504e+06]
E1 = -706.6616607977272  E_coul = 198.68497345334183
Extra cycle  E= -507.976687344385  delta_E= 1.71e-13  |g|= 1.29e-08  |ddm|= 1.79e-06
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
exp = [2.61438930e-01 8.24550099e-01 1.17616814e+05 1.03299950e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315437e+03 1.83757993e+04
 1.44908376e+03 3.76380974e+02 1.14544737e+02 3.83445700e+01
 8.42300574e+00 3.78920710e+00 8.60325602e+00 4.92640745e-01]
E = -507.97668734438537
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:07:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.261438929656       1
[INPUT] 0    0    [1    /1   ]  0.824550099239       1
[INPUT] 0    0    [1    /1   ]  117616.813867        1
[INPUT] 0    0    [1    /1   ]  1.03299949856        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.4200215        1
[INPUT] 0    0    [1    /1   ]  36754.7149304        1
[INPUT] 0    0    [1    /1   ]  7303.15437121        1
[INPUT] 0    0    [1    /1   ]  18375.7992631        1
[INPUT] 0    0    [1    /1   ]  1449.08376267        1
[INPUT] 0    0    [1    /1   ]  376.380973666        1
[INPUT] 0    0    [1    /1   ]  114.544737084        1
[INPUT] 0    0    [1    /1   ]  38.3445700001        1
[INPUT] 0    0    [1    /1   ]  8.42300573567        1
[INPUT] 0    0    [1    /1   ]  3.78920710045        1
[INPUT] 1    0    [1    /1   ]  8.60325602342        1
[INPUT] 1    0    [1    /1   ]  0.492640745379       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.26143892965619253, 1.0]], [0, [0.8245500992390047, 1.0]], [0, [117616.81386730146, 1.0]], [0, [1.0329994985636084, 1.0]], [0, [1176168.1426172405, 1.0]], [0, [588084.0699824899, 1.0]], [0, [294042.0310736112, 1.0]], [0, [147020.99191931088, 1.0]], [0, [73510.4200215492, 1.0]], [0, [36754.714930412956, 1.0]], [0, [7303.154371213765, 1.0]], [0, [18375.799263118803, 1.0]], [0, [1449.0837626665111, 1.0]], [0, [376.38097366598487, 1.0]], [0, [114.54473708375595, 1.0]], [0, [38.34457000013988, 1.0]], [0, [8.423005735672792, 1.0]], [0, [3.7892071004543593, 1.0]], [1, [8.603256023419075, 1.0]], [1, [0.492640745379068, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26143893]
bas 1, expnt(s) = [0.8245501]
bas 2, expnt(s) = [117616.8138673]
bas 3, expnt(s) = [1.0329995]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998249]
bas 6, expnt(s) = [294042.03107361]
bas 7, expnt(s) = [147020.99191931]
bas 8, expnt(s) = [73510.42002155]
bas 9, expnt(s) = [36754.71493041]
bas 10, expnt(s) = [7303.15437121]
bas 11, expnt(s) = [18375.79926312]
bas 12, expnt(s) = [1449.08376267]
bas 13, expnt(s) = [376.38097367]
bas 14, expnt(s) = [114.54473708]
bas 15, expnt(s) = [38.34457]
bas 16, expnt(s) = [8.42300574]
bas 17, expnt(s) = [3.7892071]
bas 18, expnt(s) = [8.60325602]
bas 19, expnt(s) = [0.49264075]
CPU time:       192.15
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61438930e-01 9.23725041e-01 8.24550099e-01 2.18613919e+00
 1.17616814e+05 1.60460109e+04 1.03299950e+00 2.58874997e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315437e+03 1.99594185e+03 1.83757993e+04 3.98749088e+03
 1.44908376e+03 5.93383057e+02 3.76380974e+02 2.15891613e+02
 1.14544737e+02 8.84598867e+01 3.83445700e+01 3.89307641e+01
 8.42300574e+00 1.24915217e+01 3.78920710e+00 6.86161397e+00
 8.60325602e+00 4.29846061e+01 4.92640745e-01 1.20405771e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335932929847537
cond(S) = 907965.0773340833
E1 = -689.5721477718502  E_coul = 184.96391760121398
init E= -504.608230170636
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672202402464283  LUMO = 0.670317001662304
  mo_energy =
[-1.21705756e+02 -1.33856132e+01 -7.62410775e+00 -7.62410775e+00
 -7.62410775e+00 -1.65741909e+00 -6.72202402e-01 -6.72202402e-01
 -6.72202402e-01  6.70317002e-01  4.30638033e+00  1.92440391e+01
  1.21085033e+02  6.19313416e+02  2.76335638e+03  1.22414603e+04
  4.08611354e+04  1.04903697e+05  2.30086506e+05  4.55901045e+05
  8.44853029e+05  1.52803005e+06  2.85029715e+06  5.80818407e+06]
E1 = -707.7181786748222  E_coul = 199.7592985465105
cycle= 1 E= -507.958880128312  delta_E= -3.35  |g|= 0.451  |ddm|= 1.27
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.656225
diis-c [-0.43063139  1.        ]
  HOMO = -0.218155013518298  LUMO = 1.02865028273259
  mo_energy =
[-1.20198340e+02 -1.23050251e+01 -6.59544655e+00 -6.59544655e+00
 -6.59544655e+00 -1.16354028e+00 -2.18155014e-01 -2.18155014e-01
 -2.18155014e-01  1.02865028e+00  4.87774464e+00  2.02015967e+01
  1.22479654e+02  6.20805058e+02  2.76478718e+03  1.22427817e+04
  4.08623902e+04  1.04904915e+05  2.30087700e+05  4.55902222e+05
  8.44854193e+05  1.52803120e+06  2.85029829e+06  5.80818520e+06]
E1 = -706.7791274831799  E_coul = 198.80268542281317
cycle= 2 E= -507.976442060367  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.825
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0330447
diis-c [-0.00108636 -0.00362184  1.00362184]
  HOMO = -0.239833903108242  LUMO = 1.02485361274267
  mo_energy =
[-1.20311935e+02 -1.23717236e+01 -6.66937433e+00 -6.66937433e+00
 -6.66937433e+00 -1.17743806e+00 -2.39833903e-01 -2.39833903e-01
 -2.39833903e-01  1.02485361e+00  4.85399112e+00  2.01457484e+01
  1.22384660e+02  6.20687460e+02  2.76465352e+03  1.22426378e+04
  4.08622426e+04  1.04904766e+05  2.30087550e+05  4.55902071e+05
  8.44854042e+05  1.52803105e+06  2.85029814e+06  5.80818505e+06]
E1 = -706.6760580172518  E_coul = 198.69937487371686
cycle= 3 E= -507.976683143535  delta_E= -0.000241  |g|= 0.00414  |ddm|= 0.211
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00386152
diis-c [-2.48125533e-06 -1.05491876e-04 -1.19295110e-01  1.11940060e+00]
  HOMO = -0.242807448766332  LUMO = 1.02412436638968
  mo_energy =
[-1.20323234e+02 -1.23799041e+01 -6.67802802e+00 -6.67802802e+00
 -6.67802802e+00 -1.17923184e+00 -2.42807449e-01 -2.42807449e-01
 -2.42807449e-01  1.02412437e+00  4.85054943e+00  2.01387725e+01
  1.22374569e+02  6.20676015e+02  2.76464130e+03  1.22426252e+04
  4.08622297e+04  1.04904753e+05  2.30087537e+05  4.55902059e+05
  8.44854029e+05  1.52803104e+06  2.85029813e+06  5.80818504e+06]
E1 = -706.6620279977776  E_coul = 198.68534065830988
cycle= 4 E= -507.976687339468  delta_E= -4.2e-06  |g|= 0.000153  |ddm|= 0.0434
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00011889
diis-c [-2.01503045e-10 -9.34571165e-06  6.66007760e-03 -7.81690909e-02
  1.07151836e+00]
  HOMO = -0.242885905269187  LUMO = 1.02409618804805
  mo_energy =
[-1.20323331e+02 -1.23800591e+01 -6.67816958e+00 -6.67816958e+00
 -6.67816958e+00 -1.17927906e+00 -2.42885905e-01 -2.42885905e-01
 -2.42885905e-01  1.02409619e+00  4.85045148e+00  2.01386333e+01
  1.22374452e+02  6.20675921e+02  2.76464122e+03  1.22426251e+04
  4.08622297e+04  1.04904753e+05  2.30087537e+05  4.55902058e+05
  8.44854029e+05  1.52803104e+06  2.85029813e+06  5.80818504e+06]
E1 = -706.6616690916017  E_coul = 198.68498174722023
cycle= 5 E= -507.976687344381  delta_E= -4.91e-09  |g|= 4.95e-06  |ddm|= 0.00255
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.69655e-06
diis-c [-5.29147236e-13  3.57035775e-07 -5.36492264e-04  5.97726697e-03
 -8.53370615e-02  1.07989593e+00]
  HOMO = -0.242887617793173  LUMO = 1.02409561965031
  mo_energy =
[-1.20323334e+02 -1.23800619e+01 -6.67817235e+00 -6.67817235e+00
 -6.67817235e+00 -1.17928031e+00 -2.42887618e-01 -2.42887618e-01
 -2.42887618e-01  1.02409562e+00  4.85044931e+00  2.01386306e+01
  1.22374449e+02  6.20675918e+02  2.76464121e+03  1.22426251e+04
  4.08622297e+04  1.04904753e+05  2.30087537e+05  4.55902058e+05
  8.44854029e+05  1.52803104e+06  2.85029813e+06  5.80818504e+06]
E1 = -706.6616609585642  E_coul = 198.68497361417866
cycle= 6 E= -507.976687344386  delta_E= -4.15e-12  |g|= 1.13e-07  |ddm|= 9.34e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6616609585642  E_coul = 198.68497361417866
  HOMO = -0.242887655412936  LUMO = 1.02409559375447
  mo_energy =
[-1.20323334e+02 -1.23800620e+01 -6.67817241e+00 -6.67817241e+00
 -6.67817241e+00 -1.17928032e+00 -2.42887655e-01 -2.42887655e-01
 -2.42887655e-01  1.02409559e+00  4.85044926e+00  2.01386305e+01
  1.22374449e+02  6.20675917e+02  2.76464121e+03  1.22426251e+04
  4.08622297e+04  1.04904753e+05  2.30087537e+05  4.55902058e+05
  8.44854029e+05  1.52803104e+06  2.85029813e+06  5.80818504e+06]
E1 = -706.6616607977272  E_coul = 198.68497345334183
Extra cycle  E= -507.976687344385  delta_E= 1.71e-13  |g|= 1.29e-08  |ddm|= 1.79e-06
    CPU time for scf_cycle      1.10 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907965.0773340833
E1 = -706.6616607977272  E_coul = 198.68497345334183
init E= -507.976687344385
    CPU time for initialize scf      3.33 sec, wall time      0.21 sec
  HOMO = -0.242887661110406  LUMO = 1.02409559314757
  mo_energy =
[-1.20323334e+02 -1.23800620e+01 -6.67817242e+00 -6.67817242e+00
 -6.67817242e+00 -1.17928033e+00 -2.42887661e-01 -2.42887661e-01
 -2.42887661e-01  1.02409559e+00  4.85044925e+00  2.01386305e+01
  1.22374449e+02  6.20675917e+02  2.76464121e+03  1.22426251e+04
  4.08622297e+04  1.04904753e+05  2.30087537e+05  4.55902058e+05
  8.44854029e+05  1.52803104e+06  2.85029813e+06  5.80818504e+06]
E1 = -706.6616607720505  E_coul = 198.68497342766486
cycle= 1 E= -507.976687344386  delta_E= -2.27e-13  |g|= 3.29e-09  |ddm|= 2.11e-07
    CPU time for cycle= 1      0.32 sec, wall time      0.03 sec
E1 = -706.6616607720505  E_coul = 198.68497342766486
  HOMO = -0.242887661958594  LUMO = 1.02409558996596
  mo_energy =
[-1.20323334e+02 -1.23800620e+01 -6.67817242e+00 -6.67817242e+00
 -6.67817242e+00 -1.17928033e+00 -2.42887662e-01 -2.42887662e-01
 -2.42887662e-01  1.02409559e+00  4.85044925e+00  2.01386305e+01
  1.22374449e+02  6.20675917e+02  2.76464121e+03  1.22426251e+04
  4.08622297e+04  1.04904753e+05  2.30087537e+05  4.55902058e+05
  8.44854029e+05  1.52803104e+06  2.85029813e+06  5.80818504e+06]
E1 = -706.6616607691991  E_coul = 198.6849734248133
Extra cycle  E= -507.976687344386  delta_E= -2.27e-13  |g|= 1.16e-09  |ddm|= 1.77e-08
    CPU time for scf_cycle      3.79 sec, wall time      0.38 sec
exp = [2.61438930e-01 8.24550099e-01 1.17616814e+05 1.03299950e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315437e+03 1.83757993e+04
 1.44908376e+03 3.76380974e+02 1.14544737e+02 3.83445700e+01
 8.42300574e+00 3.78920710e+00 8.60325602e+00 4.92640745e-01]
grad_E = [ 6.88577369e-03 -1.39017451e-03  4.30067466e-09 -2.11198236e-03
  2.01642539e-11  1.16620328e-10  6.69017291e-10  2.62501321e-09
  1.09100151e-08  5.85453126e-08  3.68686893e-06  1.27268105e-07
  2.36401101e-06 -3.14651053e-05  3.28868934e-04 -1.67853123e-03
 -2.73556823e-03  2.86245791e-03 -8.60858905e-04 -5.15729342e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:08:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.265746334069       1
[INPUT] 0    0    [1    /1   ]  0.873171835479       1
[INPUT] 0    0    [1    /1   ]  117616.813867        1
[INPUT] 0    0    [1    /1   ]  1.08163644148        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.4200213        1
[INPUT] 0    0    [1    /1   ]  36754.7149293        1
[INPUT] 0    0    [1    /1   ]  7303.15429992        1
[INPUT] 0    0    [1    /1   ]  18375.7992607        1
[INPUT] 0    0    [1    /1   ]  1449.0837388         1
[INPUT] 0    0    [1    /1   ]  376.38121359         1
[INPUT] 0    0    [1    /1   ]  114.542330606        1
[INPUT] 0    0    [1    /1   ]  38.3560071415        1
[INPUT] 0    0    [1    /1   ]  8.43836887968        1
[INPUT] 0    0    [1    /1   ]  3.7959423477         1
[INPUT] 1    0    [1    /1   ]  8.60371196793        1
[INPUT] 1    0    [1    /1   ]  0.492673254919       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.26574633406942866, 1.0]], [0, [0.8731718354787661, 1.0]], [0, [117616.81386721833, 1.0]], [0, [1.0816364414763844, 1.0]], [0, [1176168.14261724, 1.0]], [0, [588084.0699824877, 1.0]], [0, [294042.03107359825, 1.0]], [0, [147020.99191926015, 1.0]], [0, [73510.4200213383, 1.0]], [0, [36754.7149292816, 1.0]], [0, [7303.154299920421, 1.0]], [0, [18375.799260655313, 1.0]], [0, [1449.083738800082, 1.0]], [0, [376.38121358968414, 1.0]], [0, [114.5423306058712, 1.0]], [0, [38.35600714148694, 1.0]], [0, [8.438368879675611, 1.0]], [0, [3.795942347701235, 1.0]], [1, [8.603711967925138, 1.0]], [1, [0.49267325491857633, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26574633]
bas 1, expnt(s) = [0.87317184]
bas 2, expnt(s) = [117616.81386722]
bas 3, expnt(s) = [1.08163644]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998249]
bas 6, expnt(s) = [294042.0310736]
bas 7, expnt(s) = [147020.99191926]
bas 8, expnt(s) = [73510.42002134]
bas 9, expnt(s) = [36754.71492928]
bas 10, expnt(s) = [7303.15429992]
bas 11, expnt(s) = [18375.79926066]
bas 12, expnt(s) = [1449.0837388]
bas 13, expnt(s) = [376.38121359]
bas 14, expnt(s) = [114.54233061]
bas 15, expnt(s) = [38.35600714]
bas 16, expnt(s) = [8.43836888]
bas 17, expnt(s) = [3.79594235]
bas 18, expnt(s) = [8.60371197]
bas 19, expnt(s) = [0.49267325]
CPU time:       203.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.65746334e-01 9.35115996e-01 8.73171835e-01 2.28212702e+00
 1.17616814e+05 1.60460109e+04 1.08163644e+00 2.67963726e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315430e+03 1.99594184e+03 1.83757993e+04 3.98749088e+03
 1.44908374e+03 5.93383050e+02 3.76381214e+02 2.15891716e+02
 1.14542331e+02 8.84584929e+01 3.83560071e+01 3.89394728e+01
 8.43836888e+00 1.25086057e+01 3.79594235e+00 6.87075923e+00
 8.60371197e+00 4.29874537e+01 4.92673255e-01 1.20415703e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335855136610103
cond(S) = 907974.4962073477
E1 = -689.5777388853022  E_coul = 184.96757794120788
init E= -504.610160944094
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672148617016216  LUMO = 0.714481211965191
  mo_energy =
[-1.21705156e+02 -1.33854418e+01 -7.62386557e+00 -7.62386557e+00
 -7.62386557e+00 -1.65723572e+00 -6.72148617e-01 -6.72148617e-01
 -6.72148617e-01  7.14481212e-01  4.55965134e+00  1.97325229e+01
  1.21634452e+02  6.19799029e+02  2.76377547e+03  1.22418244e+04
  4.08614721e+04  1.04904020e+05  2.30086819e+05  4.55901352e+05
  8.44853331e+05  1.52803034e+06  2.85029744e+06  5.80818435e+06]
E1 = -707.716790787226  E_coul = 199.7577670732246
cycle= 1 E= -507.959023714001  delta_E= -3.35  |g|= 0.451  |ddm|= 1.39
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.659993
diis-c [-0.43559043  1.        ]
  HOMO = -0.218253873181528  LUMO = 1.08106278484219
  mo_energy =
[-1.20198209e+02 -1.23052081e+01 -6.59560862e+00 -6.59560862e+00
 -6.59560862e+00 -1.16354554e+00 -2.18253873e-01 -2.18253873e-01
 -2.18253873e-01  1.08106278e+00  5.14066392e+00  2.06911780e+01
  1.23028202e+02  6.21290134e+02  2.76520577e+03  1.22431454e+04
  4.08627263e+04  1.04905238e+05  2.30088013e+05  4.55902528e+05
  8.44854494e+05  1.52803150e+06  2.85029858e+06  5.80818549e+06]
E1 = -706.778899184507  E_coul = 198.8023178173083
cycle= 2 E= -507.976581367199  delta_E= -0.0176  |g|= 0.0347  |ddm|= 1.11
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0329283
diis-c [-0.00107807 -0.00379389  1.00379389]
  HOMO = -0.239883539905515  LUMO = 1.07693001251858
  mo_energy =
[-1.20311760e+02 -1.23718340e+01 -6.66946957e+00 -6.66946957e+00
 -6.66946957e+00 -1.17739944e+00 -2.39883540e-01 -2.39883540e-01
 -2.39883540e-01  1.07693001e+00  5.11600108e+00  2.06351618e+01
  1.22933265e+02  6.21172583e+02  2.76507215e+03  1.22430016e+04
  4.08625788e+04  1.04905088e+05  2.30087863e+05  4.55902378e+05
  8.44854343e+05  1.52803135e+06  2.85029843e+06  5.80818534e+06]
E1 = -706.6767138136045  E_coul = 198.6998951351124
cycle= 3 E= -507.976818678492  delta_E= -0.000237  |g|= 0.00409  |ddm|= 0.254
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00379161
diis-c [-2.48163151e-06 -5.57325766e-05 -1.16986358e-01  1.11704209e+00]
  HOMO = -0.242809755201618  LUMO = 1.0761621166653
  mo_energy =
[-1.20322932e+02 -1.23799118e+01 -6.67801717e+00 -6.67801717e+00
 -6.67801717e+00 -1.17916194e+00 -2.42809755e-01 -2.42809755e-01
 -2.42809755e-01  1.07616212e+00  5.11249491e+00  2.06282555e+01
  1.22923293e+02  6.21161268e+02  2.76506006e+03  1.22429890e+04
  4.08625661e+04  1.04905076e+05  2.30087850e+05  4.55902365e+05
  8.44854331e+05  1.52803133e+06  2.85029842e+06  5.80818532e+06]
E1 = -706.6630059905206  E_coul = 198.6861833020278
cycle= 4 E= -507.976822688493  delta_E= -4.01e-06  |g|= 0.000148  |ddm|= 0.0496
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000118622
diis-c [-1.61496399e-10 -8.67909926e-06  6.51156985e-03 -7.81852843e-02
  1.07168239e+00]
  HOMO = -0.242888484363774  LUMO = 1.0761330249178
  mo_energy =
[-1.20323040e+02 -1.23800721e+01 -6.67816500e+00 -6.67816500e+00
 -6.67816500e+00 -1.17920924e+00 -2.42888484e-01 -2.42888484e-01
 -2.42888484e-01  1.07613302e+00  5.11239457e+00  2.06281124e+01
  1.22923167e+02  6.21161162e+02  2.76505997e+03  1.22429890e+04
  4.08625660e+04  1.04905076e+05  2.30087850e+05  4.55902365e+05
  8.44854331e+05  1.52803133e+06  2.85029842e+06  5.80818532e+06]
E1 = -706.6626495213465  E_coul = 198.68582682829776
cycle= 5 E= -507.976822693049  delta_E= -4.56e-09  |g|= 4.3e-06  |ddm|= 0.00275
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.4416e-06
diis-c [-4.32556758e-13  2.94544585e-07 -4.56051707e-04  5.18379139e-03
 -7.39395440e-02  1.06921151e+00]
  HOMO = -0.242890020234348  LUMO = 1.07613250375887
  mo_energy =
[-1.20323043e+02 -1.23800747e+01 -6.67816758e+00 -6.67816758e+00
 -6.67816758e+00 -1.17921036e+00 -2.42890020e-01 -2.42890020e-01
 -2.42890020e-01  1.07613250e+00  5.11239260e+00  2.06281099e+01
  1.22923164e+02  6.21161159e+02  2.76505996e+03  1.22429889e+04
  4.08625660e+04  1.04905076e+05  2.30087850e+05  4.55902365e+05
  8.44854331e+05  1.52803133e+06  2.85029842e+06  5.80818532e+06]
E1 = -706.6626423752626  E_coul = 198.68581968221056
cycle= 6 E= -507.976822693052  delta_E= -3.41e-12  |g|= 1.26e-07  |ddm|= 8.99e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6626423752626  E_coul = 198.68581968221056
  HOMO = -0.242890062628772  LUMO = 1.0761324759084
  mo_energy =
[-1.20323043e+02 -1.23800747e+01 -6.67816765e+00 -6.67816765e+00
 -6.67816765e+00 -1.17921038e+00 -2.42890063e-01 -2.42890063e-01
 -2.42890063e-01  1.07613248e+00  5.11239254e+00  2.06281098e+01
  1.22923164e+02  6.21161159e+02  2.76505996e+03  1.22429889e+04
  4.08625660e+04  1.04905076e+05  2.30087850e+05  4.55902365e+05
  8.44854331e+05  1.52803133e+06  2.85029842e+06  5.80818532e+06]
E1 = -706.6626421926268  E_coul = 198.68581949957502
Extra cycle  E= -507.976822693052  delta_E= 3.41e-13  |g|= 1.46e-08  |ddm|= 2.28e-06
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
exp = [2.65746334e-01 8.73171835e-01 1.17616814e+05 1.08163644e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315430e+03 1.83757993e+04
 1.44908374e+03 3.76381214e+02 1.14542331e+02 3.83560071e+01
 8.43836888e+00 3.79594235e+00 8.60371197e+00 4.92673255e-01]
E = -507.97682269305176
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:08:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.265746334069       1
[INPUT] 0    0    [1    /1   ]  0.873171835479       1
[INPUT] 0    0    [1    /1   ]  117616.813867        1
[INPUT] 0    0    [1    /1   ]  1.08163644148        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.4200213        1
[INPUT] 0    0    [1    /1   ]  36754.7149293        1
[INPUT] 0    0    [1    /1   ]  7303.15429992        1
[INPUT] 0    0    [1    /1   ]  18375.7992607        1
[INPUT] 0    0    [1    /1   ]  1449.0837388         1
[INPUT] 0    0    [1    /1   ]  376.38121359         1
[INPUT] 0    0    [1    /1   ]  114.542330606        1
[INPUT] 0    0    [1    /1   ]  38.3560071415        1
[INPUT] 0    0    [1    /1   ]  8.43836887968        1
[INPUT] 0    0    [1    /1   ]  3.7959423477         1
[INPUT] 1    0    [1    /1   ]  8.60371196793        1
[INPUT] 1    0    [1    /1   ]  0.492673254919       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.26574633406942866, 1.0]], [0, [0.8731718354787661, 1.0]], [0, [117616.81386721833, 1.0]], [0, [1.0816364414763844, 1.0]], [0, [1176168.14261724, 1.0]], [0, [588084.0699824877, 1.0]], [0, [294042.03107359825, 1.0]], [0, [147020.99191926015, 1.0]], [0, [73510.4200213383, 1.0]], [0, [36754.7149292816, 1.0]], [0, [7303.154299920421, 1.0]], [0, [18375.799260655313, 1.0]], [0, [1449.083738800082, 1.0]], [0, [376.38121358968414, 1.0]], [0, [114.5423306058712, 1.0]], [0, [38.35600714148694, 1.0]], [0, [8.438368879675611, 1.0]], [0, [3.795942347701235, 1.0]], [1, [8.603711967925138, 1.0]], [1, [0.49267325491857633, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26574633]
bas 1, expnt(s) = [0.87317184]
bas 2, expnt(s) = [117616.81386722]
bas 3, expnt(s) = [1.08163644]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998249]
bas 6, expnt(s) = [294042.0310736]
bas 7, expnt(s) = [147020.99191926]
bas 8, expnt(s) = [73510.42002134]
bas 9, expnt(s) = [36754.71492928]
bas 10, expnt(s) = [7303.15429992]
bas 11, expnt(s) = [18375.79926066]
bas 12, expnt(s) = [1449.0837388]
bas 13, expnt(s) = [376.38121359]
bas 14, expnt(s) = [114.54233061]
bas 15, expnt(s) = [38.35600714]
bas 16, expnt(s) = [8.43836888]
bas 17, expnt(s) = [3.79594235]
bas 18, expnt(s) = [8.60371197]
bas 19, expnt(s) = [0.49267325]
CPU time:       204.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.65746334e-01 9.35115996e-01 8.73171835e-01 2.28212702e+00
 1.17616814e+05 1.60460109e+04 1.08163644e+00 2.67963726e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315430e+03 1.99594184e+03 1.83757993e+04 3.98749088e+03
 1.44908374e+03 5.93383050e+02 3.76381214e+02 2.15891716e+02
 1.14542331e+02 8.84584929e+01 3.83560071e+01 3.89394728e+01
 8.43836888e+00 1.25086057e+01 3.79594235e+00 6.87075923e+00
 8.60371197e+00 4.29874537e+01 4.92673255e-01 1.20415703e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335855136610103
cond(S) = 907974.4962073477
E1 = -689.5777388853022  E_coul = 184.96757794120788
init E= -504.610160944094
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672148617016216  LUMO = 0.714481211965191
  mo_energy =
[-1.21705156e+02 -1.33854418e+01 -7.62386557e+00 -7.62386557e+00
 -7.62386557e+00 -1.65723572e+00 -6.72148617e-01 -6.72148617e-01
 -6.72148617e-01  7.14481212e-01  4.55965134e+00  1.97325229e+01
  1.21634452e+02  6.19799029e+02  2.76377547e+03  1.22418244e+04
  4.08614721e+04  1.04904020e+05  2.30086819e+05  4.55901352e+05
  8.44853331e+05  1.52803034e+06  2.85029744e+06  5.80818435e+06]
E1 = -707.716790787226  E_coul = 199.7577670732246
cycle= 1 E= -507.959023714001  delta_E= -3.35  |g|= 0.451  |ddm|= 1.39
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.659993
diis-c [-0.43559043  1.        ]
  HOMO = -0.218253873181528  LUMO = 1.08106278484219
  mo_energy =
[-1.20198209e+02 -1.23052081e+01 -6.59560862e+00 -6.59560862e+00
 -6.59560862e+00 -1.16354554e+00 -2.18253873e-01 -2.18253873e-01
 -2.18253873e-01  1.08106278e+00  5.14066392e+00  2.06911780e+01
  1.23028202e+02  6.21290134e+02  2.76520577e+03  1.22431454e+04
  4.08627263e+04  1.04905238e+05  2.30088013e+05  4.55902528e+05
  8.44854494e+05  1.52803150e+06  2.85029858e+06  5.80818549e+06]
E1 = -706.778899184507  E_coul = 198.8023178173083
cycle= 2 E= -507.976581367199  delta_E= -0.0176  |g|= 0.0347  |ddm|= 1.11
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0329283
diis-c [-0.00107807 -0.00379389  1.00379389]
  HOMO = -0.239883539905515  LUMO = 1.07693001251858
  mo_energy =
[-1.20311760e+02 -1.23718340e+01 -6.66946957e+00 -6.66946957e+00
 -6.66946957e+00 -1.17739944e+00 -2.39883540e-01 -2.39883540e-01
 -2.39883540e-01  1.07693001e+00  5.11600108e+00  2.06351618e+01
  1.22933265e+02  6.21172583e+02  2.76507215e+03  1.22430016e+04
  4.08625788e+04  1.04905088e+05  2.30087863e+05  4.55902378e+05
  8.44854343e+05  1.52803135e+06  2.85029843e+06  5.80818534e+06]
E1 = -706.6767138136045  E_coul = 198.6998951351124
cycle= 3 E= -507.976818678492  delta_E= -0.000237  |g|= 0.00409  |ddm|= 0.254
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00379161
diis-c [-2.48163151e-06 -5.57325766e-05 -1.16986358e-01  1.11704209e+00]
  HOMO = -0.242809755201618  LUMO = 1.0761621166653
  mo_energy =
[-1.20322932e+02 -1.23799118e+01 -6.67801717e+00 -6.67801717e+00
 -6.67801717e+00 -1.17916194e+00 -2.42809755e-01 -2.42809755e-01
 -2.42809755e-01  1.07616212e+00  5.11249491e+00  2.06282555e+01
  1.22923293e+02  6.21161268e+02  2.76506006e+03  1.22429890e+04
  4.08625661e+04  1.04905076e+05  2.30087850e+05  4.55902365e+05
  8.44854331e+05  1.52803133e+06  2.85029842e+06  5.80818532e+06]
E1 = -706.6630059905206  E_coul = 198.6861833020278
cycle= 4 E= -507.976822688493  delta_E= -4.01e-06  |g|= 0.000148  |ddm|= 0.0496
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000118622
diis-c [-1.61496399e-10 -8.67909926e-06  6.51156985e-03 -7.81852843e-02
  1.07168239e+00]
  HOMO = -0.242888484363774  LUMO = 1.0761330249178
  mo_energy =
[-1.20323040e+02 -1.23800721e+01 -6.67816500e+00 -6.67816500e+00
 -6.67816500e+00 -1.17920924e+00 -2.42888484e-01 -2.42888484e-01
 -2.42888484e-01  1.07613302e+00  5.11239457e+00  2.06281124e+01
  1.22923167e+02  6.21161162e+02  2.76505997e+03  1.22429890e+04
  4.08625660e+04  1.04905076e+05  2.30087850e+05  4.55902365e+05
  8.44854331e+05  1.52803133e+06  2.85029842e+06  5.80818532e+06]
E1 = -706.6626495213465  E_coul = 198.68582682829776
cycle= 5 E= -507.976822693049  delta_E= -4.56e-09  |g|= 4.3e-06  |ddm|= 0.00275
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.4416e-06
diis-c [-4.32556758e-13  2.94544585e-07 -4.56051707e-04  5.18379139e-03
 -7.39395440e-02  1.06921151e+00]
  HOMO = -0.242890020234348  LUMO = 1.07613250375887
  mo_energy =
[-1.20323043e+02 -1.23800747e+01 -6.67816758e+00 -6.67816758e+00
 -6.67816758e+00 -1.17921036e+00 -2.42890020e-01 -2.42890020e-01
 -2.42890020e-01  1.07613250e+00  5.11239260e+00  2.06281099e+01
  1.22923164e+02  6.21161159e+02  2.76505996e+03  1.22429889e+04
  4.08625660e+04  1.04905076e+05  2.30087850e+05  4.55902365e+05
  8.44854331e+05  1.52803133e+06  2.85029842e+06  5.80818532e+06]
E1 = -706.6626423752626  E_coul = 198.68581968221056
cycle= 6 E= -507.976822693052  delta_E= -3.41e-12  |g|= 1.26e-07  |ddm|= 8.99e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6626423752626  E_coul = 198.68581968221056
  HOMO = -0.242890062628772  LUMO = 1.0761324759084
  mo_energy =
[-1.20323043e+02 -1.23800747e+01 -6.67816765e+00 -6.67816765e+00
 -6.67816765e+00 -1.17921038e+00 -2.42890063e-01 -2.42890063e-01
 -2.42890063e-01  1.07613248e+00  5.11239254e+00  2.06281098e+01
  1.22923164e+02  6.21161159e+02  2.76505996e+03  1.22429889e+04
  4.08625660e+04  1.04905076e+05  2.30087850e+05  4.55902365e+05
  8.44854331e+05  1.52803133e+06  2.85029842e+06  5.80818532e+06]
E1 = -706.6626421926268  E_coul = 198.68581949957502
Extra cycle  E= -507.976822693052  delta_E= 3.41e-13  |g|= 1.46e-08  |ddm|= 2.28e-06
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907974.4962073477
E1 = -706.6626421926268  E_coul = 198.68581949957502
init E= -507.976822693052
    CPU time for initialize scf      3.33 sec, wall time      0.21 sec
  HOMO = -0.24289006901945  LUMO = 1.07613247616207
  mo_energy =
[-1.20323043e+02 -1.23800747e+01 -6.67816766e+00 -6.67816766e+00
 -6.67816766e+00 -1.17921038e+00 -2.42890069e-01 -2.42890069e-01
 -2.42890069e-01  1.07613248e+00  5.11239253e+00  2.06281098e+01
  1.22923164e+02  6.21161159e+02  2.76505996e+03  1.22429889e+04
  4.08625660e+04  1.04905076e+05  2.30087850e+05  4.55902365e+05
  8.44854331e+05  1.52803133e+06  2.85029842e+06  5.80818532e+06]
E1 = -706.6626421613631  E_coul = 198.68581946831142
cycle= 1 E= -507.976822693052  delta_E= 5.68e-14  |g|= 1.81e-09  |ddm|= 2.7e-07
    CPU time for cycle= 1      0.32 sec, wall time      0.03 sec
E1 = -706.6626421613631  E_coul = 198.68581946831142
  HOMO = -0.242890070021567  LUMO = 1.0761324768186
  mo_energy =
[-1.20323043e+02 -1.23800747e+01 -6.67816766e+00 -6.67816766e+00
 -6.67816766e+00 -1.17921038e+00 -2.42890070e-01 -2.42890070e-01
 -2.42890070e-01  1.07613248e+00  5.11239253e+00  2.06281098e+01
  1.22923164e+02  6.21161159e+02  2.76505996e+03  1.22429889e+04
  4.08625660e+04  1.04905076e+05  2.30087850e+05  4.55902365e+05
  8.44854331e+05  1.52803133e+06  2.85029842e+06  5.80818532e+06]
E1 = -706.6626421561642  E_coul = 198.68581946311255
Extra cycle  E= -507.976822693052  delta_E= 5.68e-14  |g|= 1.35e-09  |ddm|= 3.82e-08
    CPU time for scf_cycle      3.79 sec, wall time      0.38 sec
exp = [2.65746334e-01 8.73171835e-01 1.17616814e+05 1.08163644e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315430e+03 1.83757993e+04
 1.44908374e+03 3.76381214e+02 1.14542331e+02 3.83560071e+01
 8.43836888e+00 3.79594235e+00 8.60371197e+00 4.92673255e-01]
grad_E = [ 1.47284053e-03  6.17999565e-06  4.30335068e-09 -1.05572016e-03
  2.01964670e-11  1.16706997e-10  6.69432446e-10  2.62666614e-09
  1.09169763e-08  5.85798097e-08  3.68938324e-06  1.27371101e-07
  2.21550039e-06 -2.94420797e-05  3.14777928e-04 -1.64735587e-03
 -2.30701440e-03  1.52495297e-03 -5.26606632e-04  1.93631408e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:08:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.266830533212       1
[INPUT] 0    0    [1    /1   ]  0.890597347564       1
[INPUT] 0    0    [1    /1   ]  117616.813867        1
[INPUT] 0    0    [1    /1   ]  1.11039730989        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.4200212        1
[INPUT] 0    0    [1    /1   ]  36754.7149287        1
[INPUT] 0    0    [1    /1   ]  7303.1542652         1
[INPUT] 0    0    [1    /1   ]  18375.7992595        1
[INPUT] 0    0    [1    /1   ]  1449.08372183        1
[INPUT] 0    0    [1    /1   ]  376.381418964        1
[INPUT] 0    0    [1    /1   ]  114.540229122        1
[INPUT] 0    0    [1    /1   ]  38.3664325366        1
[INPUT] 0    0    [1    /1   ]  8.45811664099        1
[INPUT] 0    0    [1    /1   ]  3.7721345426         1
[INPUT] 1    0    [1    /1   ]  8.60432911161        1
[INPUT] 1    0    [1    /1   ]  0.492679344018       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2668305332118459, 1.0]], [0, [0.8905973475637448, 1.0]], [0, [117616.81386717783, 1.0]], [0, [1.1103973098869089, 1.0]], [0, [1176168.1426172398, 1.0]], [0, [588084.0699824867, 1.0]], [0, [294042.03107359196, 1.0]], [0, [147020.99191923544, 1.0]], [0, [73510.42002123556, 1.0]], [0, [36754.714928730406, 1.0]], [0, [7303.154265197563, 1.0]], [0, [18375.79925945609, 1.0]], [0, [1449.0837218323654, 1.0]], [0, [376.3814189636499, 1.0]], [0, [114.5402291216337, 1.0]], [0, [38.366432536553795, 1.0]], [0, [8.458116640986571, 1.0]], [0, [3.772134542598701, 1.0]], [1, [8.604329111611504, 1.0]], [1, [0.4926793440176705, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26683053]
bas 1, expnt(s) = [0.89059735]
bas 2, expnt(s) = [117616.81386718]
bas 3, expnt(s) = [1.11039731]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998249]
bas 6, expnt(s) = [294042.03107359]
bas 7, expnt(s) = [147020.99191924]
bas 8, expnt(s) = [73510.42002124]
bas 9, expnt(s) = [36754.71492873]
bas 10, expnt(s) = [7303.1542652]
bas 11, expnt(s) = [18375.79925946]
bas 12, expnt(s) = [1449.08372183]
bas 13, expnt(s) = [376.38141896]
bas 14, expnt(s) = [114.54022912]
bas 15, expnt(s) = [38.36643254]
bas 16, expnt(s) = [8.45811664]
bas 17, expnt(s) = [3.77213454]
bas 18, expnt(s) = [8.60432911]
bas 19, expnt(s) = [0.49267934]
CPU time:       216.57
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.66830533e-01 9.37975873e-01 8.90597348e-01 2.31620008e+00
 1.17616814e+05 1.60460109e+04 1.11039731e+00 2.73290053e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315427e+03 1.99594183e+03 1.83757993e+04 3.98749088e+03
 1.44908372e+03 5.93383045e+02 3.76381419e+02 2.15891804e+02
 1.14540229e+02 8.84572757e+01 3.83664325e+01 3.89474105e+01
 8.45811664e+00 1.25305541e+01 3.77213454e+00 6.83841424e+00
 8.60432911e+00 4.29913081e+01 4.92679344e-01 1.20417564e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335843347907755
cond(S) = 907978.2022236185
E1 = -689.5827200640604  E_coul = 184.9711315281303
init E= -504.61158853593
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672137602603089  LUMO = 0.732149459668307
  mo_energy =
[-1.21704430e+02 -1.33852734e+01 -7.62361349e+00 -7.62361349e+00
 -7.62361349e+00 -1.65710140e+00 -6.72137603e-01 -6.72137603e-01
 -6.72137603e-01  7.32149460e-01  4.66476475e+00  1.99031446e+01
  1.21833904e+02  6.19989154e+02  2.76394200e+03  1.22419696e+04
  4.08616064e+04  1.04904149e+05  2.30086945e+05  4.55901475e+05
  8.44853452e+05  1.52803046e+06  2.85029756e+06  5.80818447e+06]
E1 = -707.7162943916879  E_coul = 199.7572073036888
cycle= 1 E= -507.959087087999  delta_E= -3.35  |g|= 0.451  |ddm|= 1.25
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.662188
diis-c [-0.43849263  1.        ]
  HOMO = -0.218370497598275  LUMO = 1.1020572032369
  mo_energy =
[-1.20197773e+02 -1.23053352e+01 -6.59569358e+00 -6.59569358e+00
 -6.59569358e+00 -1.16357242e+00 -2.18370498e-01 -2.18370498e-01
 -2.18370498e-01  1.10205720e+00  5.24940980e+00  2.08616156e+01
  1.23227140e+02  6.21479984e+02  2.76537208e+03  1.22432904e+04
  4.08628605e+04  1.04905366e+05  2.30088138e+05  4.55902651e+05
  8.44854615e+05  1.52803161e+06  2.85029870e+06  5.80818560e+06]
E1 = -706.7779463243836  E_coul = 198.8012800068157
cycle= 2 E= -507.976666317568  delta_E= -0.0176  |g|= 0.0347  |ddm|= 1.15
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0329238
diis-c [-0.00107732 -0.00391513  1.00391513]
  HOMO = -0.240012298726611  LUMO = 1.09777363393285
  mo_energy =
[-1.20311408e+02 -1.23719992e+01 -6.66959992e+00 -6.66959992e+00
 -6.66959992e+00 -1.17742924e+00 -2.40012299e-01 -2.40012299e-01
 -2.40012299e-01  1.09777363e+00  5.22434591e+00  2.08055153e+01
  1.23132134e+02  6.21362349e+02  2.76523835e+03  1.22431464e+04
  4.08627128e+04  1.04905217e+05  2.30087988e+05  4.55902500e+05
  8.44854464e+05  1.52803146e+06  2.85029855e+06  5.80818545e+06]
E1 = -706.676012720621  E_coul = 198.6991102984255
cycle= 3 E= -507.976902422196  delta_E= -0.000236  |g|= 0.00407  |ddm|= 0.25
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00376478
diis-c [-2.48658582e-06 -3.25421346e-05 -1.15922169e-01  1.11595471e+00]
  HOMO = -0.242921767221211  LUMO = 1.09698871622139
  mo_energy =
[-1.20322530e+02 -1.23800390e+01 -6.67810804e+00 -6.67810804e+00
 -6.67810804e+00 -1.17918040e+00 -2.42921767e-01 -2.42921767e-01
 -2.42921767e-01  1.09698872e+00  5.22081220e+00  2.07986379e+01
  1.23122206e+02  6.21351085e+02  2.76522632e+03  1.22431340e+04
  4.08627001e+04  1.04905204e+05  2.30087975e+05  4.55902487e+05
  8.44854451e+05  1.52803145e+06  2.85029854e+06  5.80818544e+06]
E1 = -706.6624298409087  E_coul = 198.68552348221283
cycle= 4 E= -507.976906358696  delta_E= -3.94e-06  |g|= 0.000146  |ddm|= 0.0477
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00011875
diis-c [-1.48368525e-10 -8.35383882e-06  6.44697395e-03 -7.82506031e-02
  1.07181198e+00]
  HOMO = -0.243000835833859  LUMO = 1.0969591719047
  mo_energy =
[-1.20322644e+02 -1.23802021e+01 -6.67825911e+00 -6.67825911e+00
 -6.67825911e+00 -1.17922788e+00 -2.43000836e-01 -2.43000836e-01
 -2.43000836e-01  1.09695917e+00  5.22071060e+00  2.07984927e+01
  1.23122076e+02  6.21350973e+02  2.76522622e+03  1.22431339e+04
  4.08627000e+04  1.04905204e+05  2.30087975e+05  4.55902487e+05
  8.44854451e+05  1.52803145e+06  2.85029854e+06  5.80818544e+06]
E1 = -706.6620734433624  E_coul = 198.6851670802367
cycle= 5 E= -507.976906363126  delta_E= -4.43e-09  |g|= 4.04e-06  |ddm|= 0.00258
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.34511e-06
diis-c [-3.94511813e-13  2.68262726e-07 -4.21827807e-04  4.83992887e-03
 -6.89997067e-02  1.06458134e+00]
  HOMO = -0.243002301393051  LUMO = 1.09695867225451
  mo_energy =
[-1.20322647e+02 -1.23802046e+01 -6.67826162e+00 -6.67826162e+00
 -6.67826162e+00 -1.17922894e+00 -2.43002301e-01 -2.43002301e-01
 -2.43002301e-01  1.09695867e+00  5.22070871e+00  2.07984903e+01
  1.23122073e+02  6.21350970e+02  2.76522622e+03  1.22431339e+04
  4.08627000e+04  1.04905204e+05  2.30087975e+05  4.55902487e+05
  8.44854451e+05  1.52803145e+06  2.85029854e+06  5.80818544e+06]
E1 = -706.662066685555  E_coul = 198.68516032242675
cycle= 6 E= -507.976906363128  delta_E= -2.61e-12  |g|= 1.3e-07  |ddm|= 8.02e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.662066685555  E_coul = 198.68516032242675
  HOMO = -0.243002345516479  LUMO = 1.09695864434027
  mo_energy =
[-1.20322647e+02 -1.23802047e+01 -6.67826169e+00 -6.67826169e+00
 -6.67826169e+00 -1.17922896e+00 -2.43002346e-01 -2.43002346e-01
 -2.43002346e-01  1.09695864e+00  5.22070865e+00  2.07984902e+01
  1.23122073e+02  6.21350970e+02  2.76522622e+03  1.22431339e+04
  4.08627000e+04  1.04905204e+05  2.30087975e+05  4.55902487e+05
  8.44854451e+05  1.52803145e+06  2.85029854e+06  5.80818544e+06]
E1 = -706.6620664947625  E_coul = 198.6851601316345
Extra cycle  E= -507.976906363128  delta_E= 2.27e-13  |g|= 1.47e-08  |ddm|= 2.26e-06
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
exp = [2.66830533e-01 8.90597348e-01 1.17616814e+05 1.11039731e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315427e+03 1.83757993e+04
 1.44908372e+03 3.76381419e+02 1.14540229e+02 3.83664325e+01
 8.45811664e+00 3.77213454e+00 8.60432911e+00 4.92679344e-01]
E = -507.976906363128
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:08:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.266830533212       1
[INPUT] 0    0    [1    /1   ]  0.890597347564       1
[INPUT] 0    0    [1    /1   ]  117616.813867        1
[INPUT] 0    0    [1    /1   ]  1.11039730989        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.4200212        1
[INPUT] 0    0    [1    /1   ]  36754.7149287        1
[INPUT] 0    0    [1    /1   ]  7303.1542652         1
[INPUT] 0    0    [1    /1   ]  18375.7992595        1
[INPUT] 0    0    [1    /1   ]  1449.08372183        1
[INPUT] 0    0    [1    /1   ]  376.381418964        1
[INPUT] 0    0    [1    /1   ]  114.540229122        1
[INPUT] 0    0    [1    /1   ]  38.3664325366        1
[INPUT] 0    0    [1    /1   ]  8.45811664099        1
[INPUT] 0    0    [1    /1   ]  3.7721345426         1
[INPUT] 1    0    [1    /1   ]  8.60432911161        1
[INPUT] 1    0    [1    /1   ]  0.492679344018       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2668305332118459, 1.0]], [0, [0.8905973475637448, 1.0]], [0, [117616.81386717783, 1.0]], [0, [1.1103973098869089, 1.0]], [0, [1176168.1426172398, 1.0]], [0, [588084.0699824867, 1.0]], [0, [294042.03107359196, 1.0]], [0, [147020.99191923544, 1.0]], [0, [73510.42002123556, 1.0]], [0, [36754.714928730406, 1.0]], [0, [7303.154265197563, 1.0]], [0, [18375.79925945609, 1.0]], [0, [1449.0837218323654, 1.0]], [0, [376.3814189636499, 1.0]], [0, [114.5402291216337, 1.0]], [0, [38.366432536553795, 1.0]], [0, [8.458116640986571, 1.0]], [0, [3.772134542598701, 1.0]], [1, [8.604329111611504, 1.0]], [1, [0.4926793440176705, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26683053]
bas 1, expnt(s) = [0.89059735]
bas 2, expnt(s) = [117616.81386718]
bas 3, expnt(s) = [1.11039731]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998249]
bas 6, expnt(s) = [294042.03107359]
bas 7, expnt(s) = [147020.99191924]
bas 8, expnt(s) = [73510.42002124]
bas 9, expnt(s) = [36754.71492873]
bas 10, expnt(s) = [7303.1542652]
bas 11, expnt(s) = [18375.79925946]
bas 12, expnt(s) = [1449.08372183]
bas 13, expnt(s) = [376.38141896]
bas 14, expnt(s) = [114.54022912]
bas 15, expnt(s) = [38.36643254]
bas 16, expnt(s) = [8.45811664]
bas 17, expnt(s) = [3.77213454]
bas 18, expnt(s) = [8.60432911]
bas 19, expnt(s) = [0.49267934]
CPU time:       217.81
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.66830533e-01 9.37975873e-01 8.90597348e-01 2.31620008e+00
 1.17616814e+05 1.60460109e+04 1.11039731e+00 2.73290053e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315427e+03 1.99594183e+03 1.83757993e+04 3.98749088e+03
 1.44908372e+03 5.93383045e+02 3.76381419e+02 2.15891804e+02
 1.14540229e+02 8.84572757e+01 3.83664325e+01 3.89474105e+01
 8.45811664e+00 1.25305541e+01 3.77213454e+00 6.83841424e+00
 8.60432911e+00 4.29913081e+01 4.92679344e-01 1.20417564e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335843347907755
cond(S) = 907978.2022236185
E1 = -689.5827200640604  E_coul = 184.9711315281303
init E= -504.61158853593
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672137602603089  LUMO = 0.732149459668307
  mo_energy =
[-1.21704430e+02 -1.33852734e+01 -7.62361349e+00 -7.62361349e+00
 -7.62361349e+00 -1.65710140e+00 -6.72137603e-01 -6.72137603e-01
 -6.72137603e-01  7.32149460e-01  4.66476475e+00  1.99031446e+01
  1.21833904e+02  6.19989154e+02  2.76394200e+03  1.22419696e+04
  4.08616064e+04  1.04904149e+05  2.30086945e+05  4.55901475e+05
  8.44853452e+05  1.52803046e+06  2.85029756e+06  5.80818447e+06]
E1 = -707.7162943916879  E_coul = 199.7572073036888
cycle= 1 E= -507.959087087999  delta_E= -3.35  |g|= 0.451  |ddm|= 1.25
    CPU time for cycle= 1      0.53 sec, wall time      0.04 sec
diis-norm(errvec)=0.662188
diis-c [-0.43849263  1.        ]
  HOMO = -0.218370497598275  LUMO = 1.1020572032369
  mo_energy =
[-1.20197773e+02 -1.23053352e+01 -6.59569358e+00 -6.59569358e+00
 -6.59569358e+00 -1.16357242e+00 -2.18370498e-01 -2.18370498e-01
 -2.18370498e-01  1.10205720e+00  5.24940980e+00  2.08616156e+01
  1.23227140e+02  6.21479984e+02  2.76537208e+03  1.22432904e+04
  4.08628605e+04  1.04905366e+05  2.30088138e+05  4.55902651e+05
  8.44854615e+05  1.52803161e+06  2.85029870e+06  5.80818560e+06]
E1 = -706.7779463243836  E_coul = 198.8012800068157
cycle= 2 E= -507.976666317568  delta_E= -0.0176  |g|= 0.0347  |ddm|= 1.15
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0329238
diis-c [-0.00107732 -0.00391513  1.00391513]
  HOMO = -0.240012298726611  LUMO = 1.09777363393285
  mo_energy =
[-1.20311408e+02 -1.23719992e+01 -6.66959992e+00 -6.66959992e+00
 -6.66959992e+00 -1.17742924e+00 -2.40012299e-01 -2.40012299e-01
 -2.40012299e-01  1.09777363e+00  5.22434591e+00  2.08055153e+01
  1.23132134e+02  6.21362349e+02  2.76523835e+03  1.22431464e+04
  4.08627128e+04  1.04905217e+05  2.30087988e+05  4.55902500e+05
  8.44854464e+05  1.52803146e+06  2.85029855e+06  5.80818545e+06]
E1 = -706.676012720621  E_coul = 198.6991102984255
cycle= 3 E= -507.976902422196  delta_E= -0.000236  |g|= 0.00407  |ddm|= 0.25
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00376478
diis-c [-2.48658582e-06 -3.25421346e-05 -1.15922169e-01  1.11595471e+00]
  HOMO = -0.242921767221211  LUMO = 1.09698871622139
  mo_energy =
[-1.20322530e+02 -1.23800390e+01 -6.67810804e+00 -6.67810804e+00
 -6.67810804e+00 -1.17918040e+00 -2.42921767e-01 -2.42921767e-01
 -2.42921767e-01  1.09698872e+00  5.22081220e+00  2.07986379e+01
  1.23122206e+02  6.21351085e+02  2.76522632e+03  1.22431340e+04
  4.08627001e+04  1.04905204e+05  2.30087975e+05  4.55902487e+05
  8.44854451e+05  1.52803145e+06  2.85029854e+06  5.80818544e+06]
E1 = -706.6624298409087  E_coul = 198.68552348221283
cycle= 4 E= -507.976906358696  delta_E= -3.94e-06  |g|= 0.000146  |ddm|= 0.0477
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00011875
diis-c [-1.48368525e-10 -8.35383882e-06  6.44697395e-03 -7.82506031e-02
  1.07181198e+00]
  HOMO = -0.243000835833859  LUMO = 1.0969591719047
  mo_energy =
[-1.20322644e+02 -1.23802021e+01 -6.67825911e+00 -6.67825911e+00
 -6.67825911e+00 -1.17922788e+00 -2.43000836e-01 -2.43000836e-01
 -2.43000836e-01  1.09695917e+00  5.22071060e+00  2.07984927e+01
  1.23122076e+02  6.21350973e+02  2.76522622e+03  1.22431339e+04
  4.08627000e+04  1.04905204e+05  2.30087975e+05  4.55902487e+05
  8.44854451e+05  1.52803145e+06  2.85029854e+06  5.80818544e+06]
E1 = -706.6620734433624  E_coul = 198.6851670802367
cycle= 5 E= -507.976906363126  delta_E= -4.43e-09  |g|= 4.04e-06  |ddm|= 0.00258
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.34511e-06
diis-c [-3.94511813e-13  2.68262726e-07 -4.21827807e-04  4.83992887e-03
 -6.89997067e-02  1.06458134e+00]
  HOMO = -0.243002301393051  LUMO = 1.09695867225451
  mo_energy =
[-1.20322647e+02 -1.23802046e+01 -6.67826162e+00 -6.67826162e+00
 -6.67826162e+00 -1.17922894e+00 -2.43002301e-01 -2.43002301e-01
 -2.43002301e-01  1.09695867e+00  5.22070871e+00  2.07984903e+01
  1.23122073e+02  6.21350970e+02  2.76522622e+03  1.22431339e+04
  4.08627000e+04  1.04905204e+05  2.30087975e+05  4.55902487e+05
  8.44854451e+05  1.52803145e+06  2.85029854e+06  5.80818544e+06]
E1 = -706.662066685555  E_coul = 198.68516032242675
cycle= 6 E= -507.976906363128  delta_E= -2.61e-12  |g|= 1.3e-07  |ddm|= 8.02e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.662066685555  E_coul = 198.68516032242675
  HOMO = -0.243002345516479  LUMO = 1.09695864434027
  mo_energy =
[-1.20322647e+02 -1.23802047e+01 -6.67826169e+00 -6.67826169e+00
 -6.67826169e+00 -1.17922896e+00 -2.43002346e-01 -2.43002346e-01
 -2.43002346e-01  1.09695864e+00  5.22070865e+00  2.07984902e+01
  1.23122073e+02  6.21350970e+02  2.76522622e+03  1.22431339e+04
  4.08627000e+04  1.04905204e+05  2.30087975e+05  4.55902487e+05
  8.44854451e+05  1.52803145e+06  2.85029854e+06  5.80818544e+06]
E1 = -706.6620664947625  E_coul = 198.6851601316345
Extra cycle  E= -507.976906363128  delta_E= 2.27e-13  |g|= 1.47e-08  |ddm|= 2.26e-06
    CPU time for scf_cycle      1.12 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907978.2022236185
E1 = -706.6620664947625  E_coul = 198.6851601316345
init E= -507.976906363128
    CPU time for initialize scf      3.55 sec, wall time      0.23 sec
  HOMO = -0.243002352152272  LUMO = 1.09695864316043
  mo_energy =
[-1.20322647e+02 -1.23802047e+01 -6.67826170e+00 -6.67826170e+00
 -6.67826170e+00 -1.17922897e+00 -2.43002352e-01 -2.43002352e-01
 -2.43002352e-01  1.09695864e+00  5.22070864e+00  2.07984902e+01
  1.23122073e+02  6.21350970e+02  2.76522622e+03  1.22431339e+04
  4.08627000e+04  1.04905204e+05  2.30087975e+05  4.55902487e+05
  8.44854451e+05  1.52803145e+06  2.85029854e+06  5.80818544e+06]
E1 = -706.6620664633399  E_coul = 198.68516010021114
cycle= 1 E= -507.976906363129  delta_E= -7.39e-13  |g|= 2.09e-09  |ddm|= 2.62e-07
    CPU time for cycle= 1      0.29 sec, wall time      0.03 sec
E1 = -706.6620664633399  E_coul = 198.68516010021114
  HOMO = -0.243002353155178  LUMO = 1.096958643124
  mo_energy =
[-1.20322647e+02 -1.23802047e+01 -6.67826170e+00 -6.67826170e+00
 -6.67826170e+00 -1.17922897e+00 -2.43002353e-01 -2.43002353e-01
 -2.43002353e-01  1.09695864e+00  5.22070864e+00  2.07984902e+01
  1.23122073e+02  6.21350970e+02  2.76522622e+03  1.22431339e+04
  4.08627000e+04  1.04905204e+05  2.30087975e+05  4.55902487e+05
  8.44854451e+05  1.52803145e+06  2.85029854e+06  5.80818544e+06]
E1 = -706.6620664607195  E_coul = 198.68516009759122
Extra cycle  E= -507.976906363128  delta_E= 4.55e-13  |g|= 2.89e-09  |ddm|= 2.22e-08
    CPU time for scf_cycle      3.99 sec, wall time      0.40 sec
exp = [2.66830533e-01 8.90597348e-01 1.17616814e+05 1.11039731e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315427e+03 1.83757993e+04
 1.44908372e+03 3.76381419e+02 1.14540229e+02 3.83664325e+01
 8.45811664e+00 3.77213454e+00 8.60432911e+00 4.92679344e-01]
grad_E = [-4.46656536e-03  1.20973462e-03  4.30852851e-09 -1.64810088e-04
  2.02582712e-11  1.16874671e-10  6.70235094e-10  2.62986474e-09
  1.09304505e-08  5.86465033e-08  3.69421642e-06  1.27571145e-07
  1.92977133e-06 -2.52245987e-05  2.79963415e-04 -1.52277581e-03
 -1.75477397e-03  1.76953043e-05 -1.36644245e-05 -4.78208076e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:08:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.269471647104       1
[INPUT] 0    0    [1    /1   ]  0.89470169716        1
[INPUT] 0    0    [1    /1   ]  117616.813867        1
[INPUT] 0    0    [1    /1   ]  1.12290501273        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.4200212        1
[INPUT] 0    0    [1    /1   ]  36754.7149285        1
[INPUT] 0    0    [1    /1   ]  7303.154249          1
[INPUT] 0    0    [1    /1   ]  18375.7992589        1
[INPUT] 0    0    [1    /1   ]  1449.08371168        1
[INPUT] 0    0    [1    /1   ]  376.381553239        1
[INPUT] 0    0    [1    /1   ]  114.53882185         1
[INPUT] 0    0    [1    /1   ]  38.3736561596        1
[INPUT] 0    0    [1    /1   ]  8.47212246723        1
[INPUT] 0    0    [1    /1   ]  3.75165387855        1
[INPUT] 1    0    [1    /1   ]  8.60454207033        1
[INPUT] 1    0    [1    /1   ]  0.492682541587       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.26947164710437355, 1.0]], [0, [0.8947016971602388, 1.0]], [0, [117616.81386715894, 1.0]], [0, [1.1229050127319427, 1.0]], [0, [1176168.1426172398, 1.0]], [0, [588084.0699824862, 1.0]], [0, [294042.03107358905, 1.0]], [0, [147020.99191922392, 1.0]], [0, [73510.42002118765, 1.0]], [0, [36754.71492847327, 1.0]], [0, [7303.154249004398, 1.0]], [0, [18375.799258897077, 1.0]], [0, [1449.08371167701, 1.0]], [0, [376.3815532388532, 1.0]], [0, [114.53882184968305, 1.0]], [0, [38.37365615963636, 1.0]], [0, [8.472122467228129, 1.0]], [0, [3.751653878547999, 1.0]], [1, [8.604542070332675, 1.0]], [1, [0.492682541587167, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26947165]
bas 1, expnt(s) = [0.8947017]
bas 2, expnt(s) = [117616.81386716]
bas 3, expnt(s) = [1.12290501]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998249]
bas 6, expnt(s) = [294042.03107359]
bas 7, expnt(s) = [147020.99191922]
bas 8, expnt(s) = [73510.42002119]
bas 9, expnt(s) = [36754.71492847]
bas 10, expnt(s) = [7303.154249]
bas 11, expnt(s) = [18375.7992589]
bas 12, expnt(s) = [1449.08371168]
bas 13, expnt(s) = [376.38155324]
bas 14, expnt(s) = [114.53882185]
bas 15, expnt(s) = [38.37365616]
bas 16, expnt(s) = [8.47212247]
bas 17, expnt(s) = [3.75165388]
bas 18, expnt(s) = [8.60454207]
bas 19, expnt(s) = [0.49268254]
CPU time:       229.71
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.69471647e-01 9.44930423e-01 8.94701697e-01 2.32420119e+00
 1.17616814e+05 1.60460109e+04 1.12290501e+00 2.75595606e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315425e+03 1.99594183e+03 1.83757993e+04 3.98749088e+03
 1.44908371e+03 5.93383042e+02 3.76381553e+02 2.15891862e+02
 1.14538822e+02 8.84564606e+01 3.83736562e+01 3.89529101e+01
 8.47212247e+00 1.25461129e+01 3.75165388e+00 6.81054862e+00
 8.60454207e+00 4.29926381e+01 4.92682542e-01 1.20418540e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335796038476772
cond(S) = 907979.6468807008
E1 = -689.584995018842  E_coul = 184.97288295824606
init E= -504.612112060596
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672125425001665  LUMO = 0.744305842113227
  mo_energy =
[-1.21704121e+02 -1.33851786e+01 -7.62348037e+00 -7.62348037e+00
 -7.62348037e+00 -1.65709977e+00 -6.72125425e-01 -6.72125425e-01
 -6.72125425e-01  7.44305842e-01  4.70823687e+00  1.99521838e+01
  1.21897303e+02  6.20058116e+02  2.76400378e+03  1.22420237e+04
  4.08616564e+04  1.04904197e+05  2.30086991e+05  4.55901520e+05
  8.44853497e+05  1.52803051e+06  2.85029760e+06  5.80818451e+06]
E1 = -707.7183587382284  E_coul = 199.75920554201315
cycle= 1 E= -507.959153196215  delta_E= -3.35  |g|= 0.451  |ddm|= 1.24
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.662647
diis-c [-0.43910128  1.        ]
  HOMO = -0.218333876941635  LUMO = 1.11604112485019
  mo_energy =
[-1.20197390e+02 -1.23052420e+01 -6.59557700e+00 -6.59557700e+00
 -6.59557700e+00 -1.16352772e+00 -2.18333877e-01 -2.18333877e-01
 -2.18333877e-01  1.11604112e+00  5.29396373e+00  2.09103958e+01
  1.23290504e+02  6.21549044e+02  2.76543400e+03  1.22433446e+04
  4.08629107e+04  1.04905414e+05  2.30088185e+05  4.55902697e+05
  8.44854660e+05  1.52803166e+06  2.85029874e+06  5.80818564e+06]
E1 = -706.7818313133365  E_coul = 198.80513526243277
cycle= 2 E= -507.976696050904  delta_E= -0.0175  |g|= 0.0347  |ddm|= 1.12
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0327677
diis-c [-0.0010673  -0.00384304  1.00384304]
  HOMO = -0.239905502891642  LUMO = 1.11170497263627
  mo_energy =
[-1.20310876e+02 -1.23717655e+01 -6.66934259e+00 -6.66934259e+00
 -6.66934259e+00 -1.17733519e+00 -2.39905503e-01 -2.39905503e-01
 -2.39905503e-01  1.11170497e+00  5.26886517e+00  2.08544283e+01
  1.23195641e+02  6.21431558e+02  2.76530042e+03  1.22432008e+04
  4.08627632e+04  1.04905265e+05  2.30088035e+05  4.55902546e+05
  8.44854509e+05  1.52803151e+06  2.85029859e+06  5.80818549e+06]
E1 = -706.6803723643436  E_coul = 198.70344193744094
cycle= 3 E= -507.976930426903  delta_E= -0.000234  |g|= 0.00405  |ddm|= 0.235
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00373156
diis-c [-2.47076609e-06 -2.25585462e-05 -1.15264145e-01  1.11528670e+00]
  HOMO = -0.242796392004392  LUMO = 1.11091597995284
  mo_energy =
[-1.20321955e+02 -1.23797667e+01 -6.67781158e+00 -6.67781158e+00
 -6.67781158e+00 -1.17907466e+00 -2.42796392e-01 -2.42796392e-01
 -2.42796392e-01  1.11091598e+00  5.26534021e+00  2.08475865e+01
  1.23185754e+02  6.21420337e+02  2.76528843e+03  1.22431884e+04
  4.08627506e+04  1.04905253e+05  2.30088022e+05  4.55902534e+05
  8.44854496e+05  1.52803150e+06  2.85029858e+06  5.80818548e+06]
E1 = -706.6668948258589  E_coul = 198.6899605137891
cycle= 4 E= -507.97693431207  delta_E= -3.89e-06  |g|= 0.000146  |ddm|= 0.0445
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000118661
diis-c [-1.43235034e-10 -8.18541894e-06  6.42307120e-03 -7.84847953e-02
  1.07206991e+00]
  HOMO = -0.242875798384345  LUMO = 1.11088621554849
  mo_energy =
[-1.20322074e+02 -1.23799318e+01 -6.67796503e+00 -6.67796503e+00
 -6.67796503e+00 -1.17912234e+00 -2.42875798e-01 -2.42875798e-01
 -2.42875798e-01  1.11088622e+00  5.26523801e+00  2.08474397e+01
  1.23185621e+02  6.21420221e+02  2.76528833e+03  1.22431883e+04
  4.08627505e+04  1.04905253e+05  2.30088022e+05  4.55902533e+05
  8.44854496e+05  1.52803150e+06  2.85029858e+06  5.80818548e+06]
E1 = -706.666537439706  E_coul = 198.68960312323549
cycle= 5 E= -507.97693431647  delta_E= -4.4e-09  |g|= 3.93e-06  |ddm|= 0.0024
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.30419e-06
diis-c [-3.78660741e-13  2.63931552e-07 -4.08997273e-04  4.72135354e-03
 -6.71213428e-02  1.06280872e+00]
  HOMO = -0.242877235812397  LUMO = 1.11088572204785
  mo_energy =
[-1.20322076e+02 -1.23799343e+01 -6.67796752e+00 -6.67796752e+00
 -6.67796752e+00 -1.17912338e+00 -2.42877236e-01 -2.42877236e-01
 -2.42877236e-01  1.11088572e+00  5.26523615e+00  2.08474374e+01
  1.23185618e+02  6.21420218e+02  2.76528833e+03  1.22431883e+04
  4.08627505e+04  1.04905253e+05  2.30088022e+05  4.55902533e+05
  8.44854496e+05  1.52803150e+06  2.85029858e+06  5.80818548e+06]
E1 = -706.66653083877  E_coul = 198.68959652229645
cycle= 6 E= -507.976934316473  delta_E= -3.01e-12  |g|= 1.32e-07  |ddm|= 7.28e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.66653083877  E_coul = 198.68959652229645
  HOMO = -0.242877280498688  LUMO = 1.11088569556341
  mo_energy =
[-1.20322077e+02 -1.23799344e+01 -6.67796759e+00 -6.67796759e+00
 -6.67796759e+00 -1.17912341e+00 -2.42877280e-01 -2.42877280e-01
 -2.42877280e-01  1.11088570e+00  5.26523609e+00  2.08474373e+01
  1.23185618e+02  6.21420218e+02  2.76528833e+03  1.22431883e+04
  4.08627505e+04  1.04905253e+05  2.30088022e+05  4.55902533e+05
  8.44854496e+05  1.52803150e+06  2.85029858e+06  5.80818548e+06]
E1 = -706.6665306458063  E_coul = 198.68959632933309
Extra cycle  E= -507.976934316473  delta_E= 2.27e-13  |g|= 1.48e-08  |ddm|= 2.13e-06
    CPU time for scf_cycle      1.10 sec, wall time      0.27 sec
exp = [2.69471647e-01 8.94701697e-01 1.17616814e+05 1.12290501e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315425e+03 1.83757993e+04
 1.44908371e+03 3.76381553e+02 1.14538822e+02 3.83736562e+01
 8.47212247e+00 3.75165388e+00 8.60454207e+00 4.92682542e-01]
E = -507.97693431647326
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:08:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.269471647104       1
[INPUT] 0    0    [1    /1   ]  0.89470169716        1
[INPUT] 0    0    [1    /1   ]  117616.813867        1
[INPUT] 0    0    [1    /1   ]  1.12290501273        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.4200212        1
[INPUT] 0    0    [1    /1   ]  36754.7149285        1
[INPUT] 0    0    [1    /1   ]  7303.154249          1
[INPUT] 0    0    [1    /1   ]  18375.7992589        1
[INPUT] 0    0    [1    /1   ]  1449.08371168        1
[INPUT] 0    0    [1    /1   ]  376.381553239        1
[INPUT] 0    0    [1    /1   ]  114.53882185         1
[INPUT] 0    0    [1    /1   ]  38.3736561596        1
[INPUT] 0    0    [1    /1   ]  8.47212246723        1
[INPUT] 0    0    [1    /1   ]  3.75165387855        1
[INPUT] 1    0    [1    /1   ]  8.60454207033        1
[INPUT] 1    0    [1    /1   ]  0.492682541587       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.26947164710437355, 1.0]], [0, [0.8947016971602388, 1.0]], [0, [117616.81386715894, 1.0]], [0, [1.1229050127319427, 1.0]], [0, [1176168.1426172398, 1.0]], [0, [588084.0699824862, 1.0]], [0, [294042.03107358905, 1.0]], [0, [147020.99191922392, 1.0]], [0, [73510.42002118765, 1.0]], [0, [36754.71492847327, 1.0]], [0, [7303.154249004398, 1.0]], [0, [18375.799258897077, 1.0]], [0, [1449.08371167701, 1.0]], [0, [376.3815532388532, 1.0]], [0, [114.53882184968305, 1.0]], [0, [38.37365615963636, 1.0]], [0, [8.472122467228129, 1.0]], [0, [3.751653878547999, 1.0]], [1, [8.604542070332675, 1.0]], [1, [0.492682541587167, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26947165]
bas 1, expnt(s) = [0.8947017]
bas 2, expnt(s) = [117616.81386716]
bas 3, expnt(s) = [1.12290501]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998249]
bas 6, expnt(s) = [294042.03107359]
bas 7, expnt(s) = [147020.99191922]
bas 8, expnt(s) = [73510.42002119]
bas 9, expnt(s) = [36754.71492847]
bas 10, expnt(s) = [7303.154249]
bas 11, expnt(s) = [18375.7992589]
bas 12, expnt(s) = [1449.08371168]
bas 13, expnt(s) = [376.38155324]
bas 14, expnt(s) = [114.53882185]
bas 15, expnt(s) = [38.37365616]
bas 16, expnt(s) = [8.47212247]
bas 17, expnt(s) = [3.75165388]
bas 18, expnt(s) = [8.60454207]
bas 19, expnt(s) = [0.49268254]
CPU time:       230.96
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.69471647e-01 9.44930423e-01 8.94701697e-01 2.32420119e+00
 1.17616814e+05 1.60460109e+04 1.12290501e+00 2.75595606e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315425e+03 1.99594183e+03 1.83757993e+04 3.98749088e+03
 1.44908371e+03 5.93383042e+02 3.76381553e+02 2.15891862e+02
 1.14538822e+02 8.84564606e+01 3.83736562e+01 3.89529101e+01
 8.47212247e+00 1.25461129e+01 3.75165388e+00 6.81054862e+00
 8.60454207e+00 4.29926381e+01 4.92682542e-01 1.20418540e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335796038476772
cond(S) = 907979.6468807008
E1 = -689.584995018842  E_coul = 184.97288295824606
init E= -504.612112060596
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672125425001665  LUMO = 0.744305842113227
  mo_energy =
[-1.21704121e+02 -1.33851786e+01 -7.62348037e+00 -7.62348037e+00
 -7.62348037e+00 -1.65709977e+00 -6.72125425e-01 -6.72125425e-01
 -6.72125425e-01  7.44305842e-01  4.70823687e+00  1.99521838e+01
  1.21897303e+02  6.20058116e+02  2.76400378e+03  1.22420237e+04
  4.08616564e+04  1.04904197e+05  2.30086991e+05  4.55901520e+05
  8.44853497e+05  1.52803051e+06  2.85029760e+06  5.80818451e+06]
E1 = -707.7183587382284  E_coul = 199.75920554201315
cycle= 1 E= -507.959153196215  delta_E= -3.35  |g|= 0.451  |ddm|= 1.24
    CPU time for cycle= 1      0.55 sec, wall time      0.04 sec
diis-norm(errvec)=0.662647
diis-c [-0.43910128  1.        ]
  HOMO = -0.218333876941635  LUMO = 1.11604112485019
  mo_energy =
[-1.20197390e+02 -1.23052420e+01 -6.59557700e+00 -6.59557700e+00
 -6.59557700e+00 -1.16352772e+00 -2.18333877e-01 -2.18333877e-01
 -2.18333877e-01  1.11604112e+00  5.29396373e+00  2.09103958e+01
  1.23290504e+02  6.21549044e+02  2.76543400e+03  1.22433446e+04
  4.08629107e+04  1.04905414e+05  2.30088185e+05  4.55902697e+05
  8.44854660e+05  1.52803166e+06  2.85029874e+06  5.80818564e+06]
E1 = -706.7818313133365  E_coul = 198.80513526243277
cycle= 2 E= -507.976696050904  delta_E= -0.0175  |g|= 0.0347  |ddm|= 1.12
    CPU time for cycle= 2      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.0327677
diis-c [-0.0010673  -0.00384304  1.00384304]
  HOMO = -0.239905502891642  LUMO = 1.11170497263627
  mo_energy =
[-1.20310876e+02 -1.23717655e+01 -6.66934259e+00 -6.66934259e+00
 -6.66934259e+00 -1.17733519e+00 -2.39905503e-01 -2.39905503e-01
 -2.39905503e-01  1.11170497e+00  5.26886517e+00  2.08544283e+01
  1.23195641e+02  6.21431558e+02  2.76530042e+03  1.22432008e+04
  4.08627632e+04  1.04905265e+05  2.30088035e+05  4.55902546e+05
  8.44854509e+05  1.52803151e+06  2.85029859e+06  5.80818549e+06]
E1 = -706.6803723643436  E_coul = 198.70344193744094
cycle= 3 E= -507.976930426903  delta_E= -0.000234  |g|= 0.00405  |ddm|= 0.235
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00373156
diis-c [-2.47076609e-06 -2.25585462e-05 -1.15264145e-01  1.11528670e+00]
  HOMO = -0.242796392004392  LUMO = 1.11091597995284
  mo_energy =
[-1.20321955e+02 -1.23797667e+01 -6.67781158e+00 -6.67781158e+00
 -6.67781158e+00 -1.17907466e+00 -2.42796392e-01 -2.42796392e-01
 -2.42796392e-01  1.11091598e+00  5.26534021e+00  2.08475865e+01
  1.23185754e+02  6.21420337e+02  2.76528843e+03  1.22431884e+04
  4.08627506e+04  1.04905253e+05  2.30088022e+05  4.55902534e+05
  8.44854496e+05  1.52803150e+06  2.85029858e+06  5.80818548e+06]
E1 = -706.6668948258589  E_coul = 198.6899605137891
cycle= 4 E= -507.97693431207  delta_E= -3.89e-06  |g|= 0.000146  |ddm|= 0.0445
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000118661
diis-c [-1.43235034e-10 -8.18541894e-06  6.42307120e-03 -7.84847953e-02
  1.07206991e+00]
  HOMO = -0.242875798384345  LUMO = 1.11088621554849
  mo_energy =
[-1.20322074e+02 -1.23799318e+01 -6.67796503e+00 -6.67796503e+00
 -6.67796503e+00 -1.17912234e+00 -2.42875798e-01 -2.42875798e-01
 -2.42875798e-01  1.11088622e+00  5.26523801e+00  2.08474397e+01
  1.23185621e+02  6.21420221e+02  2.76528833e+03  1.22431883e+04
  4.08627505e+04  1.04905253e+05  2.30088022e+05  4.55902533e+05
  8.44854496e+05  1.52803150e+06  2.85029858e+06  5.80818548e+06]
E1 = -706.666537439706  E_coul = 198.68960312323549
cycle= 5 E= -507.97693431647  delta_E= -4.4e-09  |g|= 3.93e-06  |ddm|= 0.0024
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.30419e-06
diis-c [-3.78660741e-13  2.63931552e-07 -4.08997273e-04  4.72135354e-03
 -6.71213428e-02  1.06280872e+00]
  HOMO = -0.242877235812397  LUMO = 1.11088572204785
  mo_energy =
[-1.20322076e+02 -1.23799343e+01 -6.67796752e+00 -6.67796752e+00
 -6.67796752e+00 -1.17912338e+00 -2.42877236e-01 -2.42877236e-01
 -2.42877236e-01  1.11088572e+00  5.26523615e+00  2.08474374e+01
  1.23185618e+02  6.21420218e+02  2.76528833e+03  1.22431883e+04
  4.08627505e+04  1.04905253e+05  2.30088022e+05  4.55902533e+05
  8.44854496e+05  1.52803150e+06  2.85029858e+06  5.80818548e+06]
E1 = -706.66653083877  E_coul = 198.68959652229645
cycle= 6 E= -507.976934316473  delta_E= -3.01e-12  |g|= 1.32e-07  |ddm|= 7.28e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.66653083877  E_coul = 198.68959652229645
  HOMO = -0.242877280498688  LUMO = 1.11088569556341
  mo_energy =
[-1.20322077e+02 -1.23799344e+01 -6.67796759e+00 -6.67796759e+00
 -6.67796759e+00 -1.17912341e+00 -2.42877280e-01 -2.42877280e-01
 -2.42877280e-01  1.11088570e+00  5.26523609e+00  2.08474373e+01
  1.23185618e+02  6.21420218e+02  2.76528833e+03  1.22431883e+04
  4.08627505e+04  1.04905253e+05  2.30088022e+05  4.55902533e+05
  8.44854496e+05  1.52803150e+06  2.85029858e+06  5.80818548e+06]
E1 = -706.6665306458063  E_coul = 198.68959632933309
Extra cycle  E= -507.976934316473  delta_E= 2.27e-13  |g|= 1.48e-08  |ddm|= 2.13e-06
    CPU time for scf_cycle      1.14 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907979.6468807008
E1 = -706.6665306458063  E_coul = 198.68959632933309
init E= -507.976934316473
    CPU time for initialize scf      3.33 sec, wall time      0.21 sec
  HOMO = -0.242877287198064  LUMO = 1.11088569340079
  mo_energy =
[-1.20322077e+02 -1.23799344e+01 -6.67796760e+00 -6.67796760e+00
 -6.67796760e+00 -1.17912341e+00 -2.42877287e-01 -2.42877287e-01
 -2.42877287e-01  1.11088569e+00  5.26523608e+00  2.08474373e+01
  1.23185618e+02  6.21420218e+02  2.76528833e+03  1.22431883e+04
  4.08627505e+04  1.04905253e+05  2.30088022e+05  4.55902533e+05
  8.44854496e+05  1.52803150e+06  2.85029858e+06  5.80818548e+06]
E1 = -706.6665306152897  E_coul = 198.68959629881653
cycle= 1 E= -507.976934316473  delta_E= 5.68e-14  |g|= 2.24e-09  |ddm|= 2.4e-07
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6665306152897  E_coul = 198.68959629881653
  HOMO = -0.242877288171633  LUMO = 1.11088569271511
  mo_energy =
[-1.20322077e+02 -1.23799344e+01 -6.67796760e+00 -6.67796760e+00
 -6.67796760e+00 -1.17912341e+00 -2.42877288e-01 -2.42877288e-01
 -2.42877288e-01  1.11088569e+00  5.26523608e+00  2.08474373e+01
  1.23185618e+02  6.21420218e+02  2.76528833e+03  1.22431883e+04
  4.08627505e+04  1.04905253e+05  2.30088022e+05  4.55902533e+05
  8.44854496e+05  1.52803150e+06  2.85029858e+06  5.80818548e+06]
E1 = -706.666530610748  E_coul = 198.68959629427465
Extra cycle  E= -507.976934316473  delta_E= -1.71e-13  |g|= 1.1e-09  |ddm|= 3.12e-08
    CPU time for scf_cycle      3.78 sec, wall time      0.38 sec
exp = [2.69471647e-01 8.94701697e-01 1.17616814e+05 1.12290501e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315425e+03 1.83757993e+04
 1.44908371e+03 3.76381553e+02 1.14538822e+02 3.83736562e+01
 8.47212247e+00 3.75165388e+00 8.60454207e+00 4.92682542e-01]
grad_E = [-8.08850345e-04  1.22956602e-03  4.31248036e-09 -1.48562113e-05
  2.03052259e-11  1.17002626e-10  6.70847458e-10  2.63230613e-09
  1.09407360e-08  5.86973844e-08  3.69788924e-06  1.27724091e-07
  1.71428778e-06 -2.20166811e-05  2.53568811e-04 -1.42763652e-03
 -1.40880024e-03 -8.22682285e-04  1.84106353e-04 -2.20794263e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:08:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.267426434919       1
[INPUT] 0    0    [1    /1   ]  0.875675896138       1
[INPUT] 0    0    [1    /1   ]  117616.813867        1
[INPUT] 0    0    [1    /1   ]  1.11273473598        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.4200212        1
[INPUT] 0    0    [1    /1   ]  36754.7149287        1
[INPUT] 0    0    [1    /1   ]  7303.15426499        1
[INPUT] 0    0    [1    /1   ]  18375.7992594        1
[INPUT] 0    0    [1    /1   ]  1449.08371254        1
[INPUT] 0    0    [1    /1   ]  376.381575772        1
[INPUT] 0    0    [1    /1   ]  114.538524853        1
[INPUT] 0    0    [1    /1   ]  38.3756642369        1
[INPUT] 0    0    [1    /1   ]  8.47852193915        1
[INPUT] 0    0    [1    /1   ]  3.73049510059        1
[INPUT] 1    0    [1    /1   ]  8.60442507695        1
[INPUT] 1    0    [1    /1   ]  0.492689652084       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.26742643491934776, 1.0]], [0, [0.8756758961380645, 1.0]], [0, [117616.81386717757, 1.0]], [0, [1.1127347359835245, 1.0]], [0, [1176168.1426172398, 1.0]], [0, [588084.0699824867, 1.0]], [0, [294042.03107359196, 1.0]], [0, [147020.9919192353, 1.0]], [0, [73510.42002123491, 1.0]], [0, [36754.714928726724, 1.0]], [0, [7303.154264985261, 1.0]], [0, [18375.79925944979, 1.0]], [0, [1449.0837125440573, 1.0]], [0, [376.3815757724483, 1.0]], [0, [114.53852485291065, 1.0]], [0, [38.375664236936316, 1.0]], [0, [8.478521939153891, 1.0]], [0, [3.730495100587327, 1.0]], [1, [8.604425076951422, 1.0]], [1, [0.4926896520839539, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26742643]
bas 1, expnt(s) = [0.8756759]
bas 2, expnt(s) = [117616.81386718]
bas 3, expnt(s) = [1.11273474]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998249]
bas 6, expnt(s) = [294042.03107359]
bas 7, expnt(s) = [147020.99191924]
bas 8, expnt(s) = [73510.42002123]
bas 9, expnt(s) = [36754.71492873]
bas 10, expnt(s) = [7303.15426499]
bas 11, expnt(s) = [18375.79925945]
bas 12, expnt(s) = [1449.08371254]
bas 13, expnt(s) = [376.38157577]
bas 14, expnt(s) = [114.53852485]
bas 15, expnt(s) = [38.37566424]
bas 16, expnt(s) = [8.47852194]
bas 17, expnt(s) = [3.7304951]
bas 18, expnt(s) = [8.60442508]
bas 19, expnt(s) = [0.49268965]
CPU time:       242.78
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.67426435e-01 9.39546492e-01 8.75675896e-01 2.28703374e+00
 1.17616814e+05 1.60460109e+04 1.11273474e+00 2.73721404e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315426e+03 1.99594183e+03 1.83757993e+04 3.98749088e+03
 1.44908371e+03 5.93383042e+02 3.76381576e+02 2.15891872e+02
 1.14538525e+02 8.84562886e+01 3.83756642e+01 3.89544389e+01
 8.47852194e+00 1.25532199e+01 3.73049510e+00 6.78172039e+00
 8.60442508e+00 4.29919075e+01 4.92689652e-01 1.20420713e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335816671793822
cond(S) = 907976.3458478915
E1 = -689.5849876022952  E_coul = 184.97271971515374
init E= -504.612267887141
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672117244355531  LUMO = 0.727958353225495
  mo_energy =
[-1.21704159e+02 -1.33852004e+01 -7.62349071e+00 -7.62349071e+00
 -7.62349071e+00 -1.65711587e+00 -6.72117244e-01 -6.72117244e-01
 -6.72117244e-01  7.27958353e-01  4.62142624e+00  1.97658309e+01
  1.21700055e+02  6.19897249e+02  2.76386729e+03  1.22419054e+04
  4.08615472e+04  1.04904092e+05  2.30086890e+05  4.55901421e+05
  8.44853399e+05  1.52803041e+06  2.85029751e+06  5.80818442e+06]
E1 = -707.7188821373045  E_coul = 199.75974398992508
cycle= 1 E= -507.959138147379  delta_E= -3.35  |g|= 0.451  |ddm|= 1.09
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.661881
diis-c [-0.43808685  1.        ]
  HOMO = -0.218290407184677  LUMO = 1.09687077374567
  mo_energy =
[-1.20197328e+02 -1.23052273e+01 -6.59556053e+00 -6.59556053e+00
 -6.59556053e+00 -1.16351653e+00 -2.18290407e-01 -2.18290407e-01
 -2.18290407e-01  1.09687077e+00  5.20392437e+00  2.07232617e+01
  1.23093447e+02  6.21388337e+02  2.76529768e+03  1.22432266e+04
  4.08628017e+04  1.04905310e+05  2.30088083e+05  4.55902597e+05
  8.44854562e+05  1.52803156e+06  2.85029865e+06  5.80818555e+06]
E1 = -706.7809718046865  E_coul = 198.80426668258443
cycle= 2 E= -507.976705122102  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.972
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0328759
diis-c [-0.00107442 -0.00384429  1.00384429]
  HOMO = -0.239914896193234  LUMO = 1.09264044187801
  mo_energy =
[-1.20310932e+02 -1.23718481e+01 -6.66942559e+00 -6.66942559e+00
 -6.66942559e+00 -1.17736276e+00 -2.39914896e-01 -2.39914896e-01
 -2.39914896e-01  1.09264044e+00  5.17907935e+00  2.06673140e+01
  1.22998469e+02  6.21270730e+02  2.76516398e+03  1.22430827e+04
  4.08626541e+04  1.04905161e+05  2.30087933e+05  4.55902447e+05
  8.44854411e+05  1.52803141e+06  2.85029850e+06  5.80818540e+06]
E1 = -706.67905051026  E_coul = 198.70210921395426
cycle= 3 E= -507.976941296306  delta_E= -0.000236  |g|= 0.00407  |ddm|= 0.209
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00376166
diis-c [-2.48002482e-06 -3.65905937e-05 -1.16005920e-01  1.11604251e+00]
  HOMO = -0.242826396281184  LUMO = 1.09186235337764
  mo_energy =
[-1.20322062e+02 -1.23798922e+01 -6.67793849e+00 -6.67793849e+00
 -6.67793849e+00 -1.17911551e+00 -2.42826396e-01 -2.42826396e-01
 -2.42826396e-01  1.09186235e+00  5.17556806e+00  2.06604438e+01
  1.22988534e+02  6.21259457e+02  2.76515194e+03  1.22430702e+04
  4.08626414e+04  1.04905148e+05  2.30087920e+05  4.55902434e+05
  8.44854398e+05  1.52803140e+06  2.85029849e+06  5.80818539e+06]
E1 = -706.6654468133802  E_coul = 198.68850156475995
cycle= 4 E= -507.97694524862  delta_E= -3.95e-06  |g|= 0.000147  |ddm|= 0.0401
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000118887
diis-c [-1.54046611e-10 -8.37830015e-06  6.46528395e-03 -7.84238980e-02
  1.07196699e+00]
  HOMO = -0.24290591707803  LUMO = 1.09183283540299
  mo_energy =
[-1.20322177e+02 -1.23800561e+01 -6.67809037e+00 -6.67809037e+00
 -6.67809037e+00 -1.17916328e+00 -2.42905917e-01 -2.42905917e-01
 -2.42905917e-01  1.09183284e+00  5.17546643e+00  2.06602979e+01
  1.22988403e+02  6.21259344e+02  2.76515184e+03  1.22430701e+04
  4.08626413e+04  1.04905148e+05  2.30087920e+05  4.55902434e+05
  8.44854398e+05  1.52803140e+06  2.85029849e+06  5.80818539e+06]
E1 = -706.6650878753571  E_coul = 198.68814262222645
cycle= 5 E= -507.976945253131  delta_E= -4.51e-09  |g|= 4.13e-06  |ddm|= 0.00219
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.38161e-06
diis-c [-4.11446152e-13  2.80720883e-07 -4.35181557e-04  4.99440777e-03
 -7.10606553e-02  1.06650115e+00]
  HOMO = -0.242907416801686  LUMO = 1.09183232493715
  mo_energy =
[-1.20322180e+02 -1.23800587e+01 -6.67809294e+00 -6.67809294e+00
 -6.67809294e+00 -1.17916437e+00 -2.42907417e-01 -2.42907417e-01
 -2.42907417e-01  1.09183232e+00  5.17546450e+00  2.06602955e+01
  1.22988400e+02  6.21259341e+02  2.76515184e+03  1.22430701e+04
  4.08626413e+04  1.04905148e+05  2.30087920e+05  4.55902434e+05
  8.44854398e+05  1.52803140e+06  2.85029849e+06  5.80818539e+06]
E1 = -706.6650809452344  E_coul = 198.6881356920999
cycle= 6 E= -507.976945253135  delta_E= -3.87e-12  |g|= 1.28e-07  |ddm|= 6.94e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6650809452344  E_coul = 198.6881356920999
  HOMO = -0.242907460316513  LUMO = 1.0918322966419
  mo_energy =
[-1.20322180e+02 -1.23800587e+01 -6.67809301e+00 -6.67809301e+00
 -6.67809301e+00 -1.17916439e+00 -2.42907460e-01 -2.42907460e-01
 -2.42907460e-01  1.09183230e+00  5.17546444e+00  2.06602954e+01
  1.22988400e+02  6.21259341e+02  2.76515183e+03  1.22430701e+04
  4.08626413e+04  1.04905148e+05  2.30087920e+05  4.55902434e+05
  8.44854398e+05  1.52803140e+06  2.85029849e+06  5.80818539e+06]
E1 = -706.6650807584863  E_coul = 198.68813550535185
Extra cycle  E= -507.976945253134  delta_E= 1.14e-13  |g|= 1.47e-08  |ddm|= 1.87e-06
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
exp = [2.67426435e-01 8.75675896e-01 1.17616814e+05 1.11273474e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315426e+03 1.83757993e+04
 1.44908371e+03 3.76381576e+02 1.14538525e+02 3.83756642e+01
 8.47852194e+00 3.73049510e+00 8.60442508e+00 4.92689652e-01]
E = -507.97694525313443
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:08:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.267426434919       1
[INPUT] 0    0    [1    /1   ]  0.875675896138       1
[INPUT] 0    0    [1    /1   ]  117616.813867        1
[INPUT] 0    0    [1    /1   ]  1.11273473598        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.4200212        1
[INPUT] 0    0    [1    /1   ]  36754.7149287        1
[INPUT] 0    0    [1    /1   ]  7303.15426499        1
[INPUT] 0    0    [1    /1   ]  18375.7992594        1
[INPUT] 0    0    [1    /1   ]  1449.08371254        1
[INPUT] 0    0    [1    /1   ]  376.381575772        1
[INPUT] 0    0    [1    /1   ]  114.538524853        1
[INPUT] 0    0    [1    /1   ]  38.3756642369        1
[INPUT] 0    0    [1    /1   ]  8.47852193915        1
[INPUT] 0    0    [1    /1   ]  3.73049510059        1
[INPUT] 1    0    [1    /1   ]  8.60442507695        1
[INPUT] 1    0    [1    /1   ]  0.492689652084       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.26742643491934776, 1.0]], [0, [0.8756758961380645, 1.0]], [0, [117616.81386717757, 1.0]], [0, [1.1127347359835245, 1.0]], [0, [1176168.1426172398, 1.0]], [0, [588084.0699824867, 1.0]], [0, [294042.03107359196, 1.0]], [0, [147020.9919192353, 1.0]], [0, [73510.42002123491, 1.0]], [0, [36754.714928726724, 1.0]], [0, [7303.154264985261, 1.0]], [0, [18375.79925944979, 1.0]], [0, [1449.0837125440573, 1.0]], [0, [376.3815757724483, 1.0]], [0, [114.53852485291065, 1.0]], [0, [38.375664236936316, 1.0]], [0, [8.478521939153891, 1.0]], [0, [3.730495100587327, 1.0]], [1, [8.604425076951422, 1.0]], [1, [0.4926896520839539, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26742643]
bas 1, expnt(s) = [0.8756759]
bas 2, expnt(s) = [117616.81386718]
bas 3, expnt(s) = [1.11273474]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998249]
bas 6, expnt(s) = [294042.03107359]
bas 7, expnt(s) = [147020.99191924]
bas 8, expnt(s) = [73510.42002123]
bas 9, expnt(s) = [36754.71492873]
bas 10, expnt(s) = [7303.15426499]
bas 11, expnt(s) = [18375.79925945]
bas 12, expnt(s) = [1449.08371254]
bas 13, expnt(s) = [376.38157577]
bas 14, expnt(s) = [114.53852485]
bas 15, expnt(s) = [38.37566424]
bas 16, expnt(s) = [8.47852194]
bas 17, expnt(s) = [3.7304951]
bas 18, expnt(s) = [8.60442508]
bas 19, expnt(s) = [0.49268965]
CPU time:       244.03
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.67426435e-01 9.39546492e-01 8.75675896e-01 2.28703374e+00
 1.17616814e+05 1.60460109e+04 1.11273474e+00 2.73721404e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315426e+03 1.99594183e+03 1.83757993e+04 3.98749088e+03
 1.44908371e+03 5.93383042e+02 3.76381576e+02 2.15891872e+02
 1.14538525e+02 8.84562886e+01 3.83756642e+01 3.89544389e+01
 8.47852194e+00 1.25532199e+01 3.73049510e+00 6.78172039e+00
 8.60442508e+00 4.29919075e+01 4.92689652e-01 1.20420713e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335816671793822
cond(S) = 907976.3458478915
E1 = -689.5849876022952  E_coul = 184.97271971515374
init E= -504.612267887141
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672117244355531  LUMO = 0.727958353225495
  mo_energy =
[-1.21704159e+02 -1.33852004e+01 -7.62349071e+00 -7.62349071e+00
 -7.62349071e+00 -1.65711587e+00 -6.72117244e-01 -6.72117244e-01
 -6.72117244e-01  7.27958353e-01  4.62142624e+00  1.97658309e+01
  1.21700055e+02  6.19897249e+02  2.76386729e+03  1.22419054e+04
  4.08615472e+04  1.04904092e+05  2.30086890e+05  4.55901421e+05
  8.44853399e+05  1.52803041e+06  2.85029751e+06  5.80818442e+06]
E1 = -707.7188821373045  E_coul = 199.75974398992508
cycle= 1 E= -507.959138147379  delta_E= -3.35  |g|= 0.451  |ddm|= 1.09
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.661881
diis-c [-0.43808685  1.        ]
  HOMO = -0.218290407184677  LUMO = 1.09687077374567
  mo_energy =
[-1.20197328e+02 -1.23052273e+01 -6.59556053e+00 -6.59556053e+00
 -6.59556053e+00 -1.16351653e+00 -2.18290407e-01 -2.18290407e-01
 -2.18290407e-01  1.09687077e+00  5.20392437e+00  2.07232617e+01
  1.23093447e+02  6.21388337e+02  2.76529768e+03  1.22432266e+04
  4.08628017e+04  1.04905310e+05  2.30088083e+05  4.55902597e+05
  8.44854562e+05  1.52803156e+06  2.85029865e+06  5.80818555e+06]
E1 = -706.7809718046865  E_coul = 198.80426668258443
cycle= 2 E= -507.976705122102  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.972
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0328759
diis-c [-0.00107442 -0.00384429  1.00384429]
  HOMO = -0.239914896193234  LUMO = 1.09264044187801
  mo_energy =
[-1.20310932e+02 -1.23718481e+01 -6.66942559e+00 -6.66942559e+00
 -6.66942559e+00 -1.17736276e+00 -2.39914896e-01 -2.39914896e-01
 -2.39914896e-01  1.09264044e+00  5.17907935e+00  2.06673140e+01
  1.22998469e+02  6.21270730e+02  2.76516398e+03  1.22430827e+04
  4.08626541e+04  1.04905161e+05  2.30087933e+05  4.55902447e+05
  8.44854411e+05  1.52803141e+06  2.85029850e+06  5.80818540e+06]
E1 = -706.67905051026  E_coul = 198.70210921395426
cycle= 3 E= -507.976941296306  delta_E= -0.000236  |g|= 0.00407  |ddm|= 0.209
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00376166
diis-c [-2.48002482e-06 -3.65905937e-05 -1.16005920e-01  1.11604251e+00]
  HOMO = -0.242826396281184  LUMO = 1.09186235337764
  mo_energy =
[-1.20322062e+02 -1.23798922e+01 -6.67793849e+00 -6.67793849e+00
 -6.67793849e+00 -1.17911551e+00 -2.42826396e-01 -2.42826396e-01
 -2.42826396e-01  1.09186235e+00  5.17556806e+00  2.06604438e+01
  1.22988534e+02  6.21259457e+02  2.76515194e+03  1.22430702e+04
  4.08626414e+04  1.04905148e+05  2.30087920e+05  4.55902434e+05
  8.44854398e+05  1.52803140e+06  2.85029849e+06  5.80818539e+06]
E1 = -706.6654468133802  E_coul = 198.68850156475995
cycle= 4 E= -507.97694524862  delta_E= -3.95e-06  |g|= 0.000147  |ddm|= 0.0401
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000118887
diis-c [-1.54046611e-10 -8.37830015e-06  6.46528395e-03 -7.84238980e-02
  1.07196699e+00]
  HOMO = -0.24290591707803  LUMO = 1.09183283540299
  mo_energy =
[-1.20322177e+02 -1.23800561e+01 -6.67809037e+00 -6.67809037e+00
 -6.67809037e+00 -1.17916328e+00 -2.42905917e-01 -2.42905917e-01
 -2.42905917e-01  1.09183284e+00  5.17546643e+00  2.06602979e+01
  1.22988403e+02  6.21259344e+02  2.76515184e+03  1.22430701e+04
  4.08626413e+04  1.04905148e+05  2.30087920e+05  4.55902434e+05
  8.44854398e+05  1.52803140e+06  2.85029849e+06  5.80818539e+06]
E1 = -706.6650878753571  E_coul = 198.68814262222645
cycle= 5 E= -507.976945253131  delta_E= -4.51e-09  |g|= 4.13e-06  |ddm|= 0.00219
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.38161e-06
diis-c [-4.11446152e-13  2.80720883e-07 -4.35181557e-04  4.99440777e-03
 -7.10606553e-02  1.06650115e+00]
  HOMO = -0.242907416801686  LUMO = 1.09183232493715
  mo_energy =
[-1.20322180e+02 -1.23800587e+01 -6.67809294e+00 -6.67809294e+00
 -6.67809294e+00 -1.17916437e+00 -2.42907417e-01 -2.42907417e-01
 -2.42907417e-01  1.09183232e+00  5.17546450e+00  2.06602955e+01
  1.22988400e+02  6.21259341e+02  2.76515184e+03  1.22430701e+04
  4.08626413e+04  1.04905148e+05  2.30087920e+05  4.55902434e+05
  8.44854398e+05  1.52803140e+06  2.85029849e+06  5.80818539e+06]
E1 = -706.6650809452344  E_coul = 198.6881356920999
cycle= 6 E= -507.976945253135  delta_E= -3.87e-12  |g|= 1.28e-07  |ddm|= 6.94e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6650809452344  E_coul = 198.6881356920999
  HOMO = -0.242907460316513  LUMO = 1.0918322966419
  mo_energy =
[-1.20322180e+02 -1.23800587e+01 -6.67809301e+00 -6.67809301e+00
 -6.67809301e+00 -1.17916439e+00 -2.42907460e-01 -2.42907460e-01
 -2.42907460e-01  1.09183230e+00  5.17546444e+00  2.06602954e+01
  1.22988400e+02  6.21259341e+02  2.76515183e+03  1.22430701e+04
  4.08626413e+04  1.04905148e+05  2.30087920e+05  4.55902434e+05
  8.44854398e+05  1.52803140e+06  2.85029849e+06  5.80818539e+06]
E1 = -706.6650807584863  E_coul = 198.68813550535185
Extra cycle  E= -507.976945253134  delta_E= 1.14e-13  |g|= 1.47e-08  |ddm|= 1.87e-06
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907976.3458478915
E1 = -706.6650807584863  E_coul = 198.68813550535185
init E= -507.976945253134
    CPU time for initialize scf      3.28 sec, wall time      0.21 sec
  HOMO = -0.242907466824226  LUMO = 1.09183229679599
  mo_energy =
[-1.20322180e+02 -1.23800587e+01 -6.67809302e+00 -6.67809302e+00
 -6.67809302e+00 -1.17916440e+00 -2.42907467e-01 -2.42907467e-01
 -2.42907467e-01  1.09183230e+00  5.17546443e+00  2.06602954e+01
  1.22988400e+02  6.21259341e+02  2.76515183e+03  1.22430701e+04
  4.08626413e+04  1.04905148e+05  2.30087920e+05  4.55902434e+05
  8.44854398e+05  1.52803140e+06  2.85029849e+06  5.80818539e+06]
E1 = -706.6650807277832  E_coul = 198.68813547464916
cycle= 1 E= -507.976945253134  delta_E= 3.41e-13  |g|= 2.37e-09  |ddm|= 2.17e-07
    CPU time for cycle= 1      0.32 sec, wall time      0.03 sec
E1 = -706.6650807277832  E_coul = 198.68813547464916
  HOMO = -0.242907467814124  LUMO = 1.09183229508275
  mo_energy =
[-1.20322180e+02 -1.23800587e+01 -6.67809303e+00 -6.67809303e+00
 -6.67809303e+00 -1.17916440e+00 -2.42907468e-01 -2.42907468e-01
 -2.42907468e-01  1.09183230e+00  5.17546443e+00  2.06602954e+01
  1.22988400e+02  6.21259341e+02  2.76515183e+03  1.22430701e+04
  4.08626413e+04  1.04905148e+05  2.30087920e+05  4.55902434e+05
  8.44854398e+05  1.52803140e+06  2.85029849e+06  5.80818539e+06]
E1 = -706.6650807236654  E_coul = 198.68813547053122
Extra cycle  E= -507.976945253134  delta_E= -5.68e-14  |g|= 1.3e-09  |ddm|= 2.54e-08
    CPU time for scf_cycle      3.73 sec, wall time      0.37 sec
exp = [2.67426435e-01 8.75675896e-01 1.17616814e+05 1.11273474e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315426e+03 1.83757993e+04
 1.44908371e+03 3.76381576e+02 1.14538525e+02 3.83756642e+01
 8.47852194e+00 3.73049510e+00 8.60442508e+00 4.92689652e-01]
grad_E = [-1.67968173e-03  1.34563173e-03  4.31529025e-09  2.74405688e-05
  2.03385271e-11  1.17093650e-10  6.71282674e-10  2.63404220e-09
  1.09480514e-08  5.87335389e-08  3.70049179e-06  1.27833151e-07
  1.56115121e-06 -1.96476838e-05  2.32736150e-04 -1.34237118e-03
 -1.21835135e-03 -1.29656649e-03  8.66884464e-05  1.16010254e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:08:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.266548020157       1
[INPUT] 0    0    [1    /1   ]  0.859320028589       1
[INPUT] 0    0    [1    /1   ]  117616.813867        1
[INPUT] 0    0    [1    /1   ]  1.10229301632        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.4200213        1
[INPUT] 0    0    [1    /1   ]  36754.7149289        1
[INPUT] 0    0    [1    /1   ]  7303.15427325        1
[INPUT] 0    0    [1    /1   ]  18375.7992597        1
[INPUT] 0    0    [1    /1   ]  1449.08371165        1
[INPUT] 0    0    [1    /1   ]  376.381613322        1
[INPUT] 0    0    [1    /1   ]  114.538036741        1
[INPUT] 0    0    [1    /1   ]  38.3788082404        1
[INPUT] 0    0    [1    /1   ]  8.48411779801        1
[INPUT] 0    0    [1    /1   ]  3.71825910135        1
[INPUT] 1    0    [1    /1   ]  8.60427741687        1
[INPUT] 1    0    [1    /1   ]  0.492697687554       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2665480201572421, 1.0]], [0, [0.8593200285886725, 1.0]], [0, [117616.8138671872, 1.0]], [0, [1.1022930163158453, 1.0]], [0, [1176168.1426172398, 1.0]], [0, [588084.0699824869, 1.0]], [0, [294042.0310735935, 1.0]], [0, [147020.99191924118, 1.0]], [0, [73510.42002125934, 1.0]], [0, [36754.714928857684, 1.0]], [0, [7303.154273245783, 1.0]], [0, [18375.79925973563, 1.0]], [0, [1449.083711648006, 1.0]], [0, [376.3816133215482, 1.0]], [0, [114.53803674069047, 1.0]], [0, [38.3788082403743, 1.0]], [0, [8.484117798009995, 1.0]], [0, [3.718259101349212, 1.0]], [1, [8.60427741686613, 1.0]], [1, [0.4926976875539107, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26654802]
bas 1, expnt(s) = [0.85932003]
bas 2, expnt(s) = [117616.81386719]
bas 3, expnt(s) = [1.10229302]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998249]
bas 6, expnt(s) = [294042.03107359]
bas 7, expnt(s) = [147020.99191924]
bas 8, expnt(s) = [73510.42002126]
bas 9, expnt(s) = [36754.71492886]
bas 10, expnt(s) = [7303.15427325]
bas 11, expnt(s) = [18375.79925974]
bas 12, expnt(s) = [1449.08371165]
bas 13, expnt(s) = [376.38161332]
bas 14, expnt(s) = [114.53803674]
bas 15, expnt(s) = [38.37880824]
bas 16, expnt(s) = [8.4841178]
bas 17, expnt(s) = [3.7182591]
bas 18, expnt(s) = [8.60427742]
bas 19, expnt(s) = [0.49269769]
CPU time:       255.56
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.66548020e-01 9.37230946e-01 8.59320029e-01 2.25492045e+00
 1.17616814e+05 1.60460109e+04 1.10229302e+00 2.71792718e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315427e+03 1.99594183e+03 1.83757993e+04 3.98749088e+03
 1.44908371e+03 5.93383042e+02 3.76381613e+02 2.15891888e+02
 1.14538037e+02 8.84560058e+01 3.83788082e+01 3.89568325e+01
 8.48411780e+00 1.25594332e+01 3.71825910e+00 6.76503054e+00
 8.60427742e+00 4.29909852e+01 4.92697688e-01 1.20423168e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335814027535157
cond(S) = 907973.8429065134
E1 = -689.5847048385386  E_coul = 184.97246667512798
init E= -504.612238163411
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672106480123825  LUMO = 0.715911833244727
  mo_energy =
[-1.21704246e+02 -1.33852156e+01 -7.62350631e+00 -7.62350631e+00
 -7.62350631e+00 -1.65715910e+00 -6.72106480e-01 -6.72106480e-01
 -6.72106480e-01  7.15911833e-01  4.54905610e+00  1.96178430e+01
  1.21555410e+02  6.19783538e+02  2.76377159e+03  1.22418227e+04
  4.08614707e+04  1.04904019e+05  2.30086818e+05  4.55901351e+05
  8.44853330e+05  1.52803034e+06  2.85029744e+06  5.80818435e+06]
E1 = -707.7203618302042  E_coul = 199.76121120146107
cycle= 1 E= -507.959150628743  delta_E= -3.35  |g|= 0.451  |ddm|= 1.03
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.66094
diis-c [-0.43684219  1.        ]
  HOMO = -0.218210011457074  LUMO = 1.0825860785568
  mo_energy =
[-1.20197239e+02 -1.23051355e+01 -6.59546961e+00 -6.59546961e+00
 -6.59546961e+00 -1.16348238e+00 -2.18210011e-01 -2.18210011e-01
 -2.18210011e-01  1.08258608e+00  5.12879354e+00  2.05748534e+01
  1.22949073e+02  6.21274846e+02  2.76520221e+03  1.22431441e+04
  4.08627255e+04  1.04905237e+05  2.30088012e+05  4.55902528e+05
  8.44854494e+05  1.52803150e+06  2.85029858e+06  5.80818549e+06]
E1 = -706.782199369901  E_coul = 198.80548233369544
cycle= 2 E= -507.976717036206  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.868
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.032901
diis-c [-0.00107626 -0.00379096  1.00379096]
  HOMO = -0.239845370221587  LUMO = 1.07845102744391
  mo_energy =
[-1.20310855e+02 -1.23717686e+01 -6.66934643e+00 -6.66934643e+00
 -6.66934643e+00 -1.17733871e+00 -2.39845370e-01 -2.39845370e-01
 -2.39845370e-01  1.07845103e+00  5.10421247e+00  2.05189727e+01
  1.22854078e+02  6.21157224e+02  2.76506849e+03  1.22430002e+04
  4.08625778e+04  1.04905088e+05  2.30087862e+05  4.55902377e+05
  8.44854343e+05  1.52803134e+06  2.85029843e+06  5.80818533e+06]
E1 = -706.6800444215265  E_coul = 198.70309020277563
cycle= 3 E= -507.976954218751  delta_E= -0.000237  |g|= 0.00409  |ddm|= 0.191
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00377858
diis-c [-2.48008681e-06 -4.91543550e-05 -1.16578413e-01  1.11662757e+00]
  HOMO = -0.242769534257137  LUMO = 1.07768364739461
  mo_energy =
[-1.20322020e+02 -1.23798398e+01 -6.67788742e+00 -6.67788742e+00
 -6.67788742e+00 -1.17909985e+00 -2.42769534e-01 -2.42769534e-01
 -2.42769534e-01  1.07768365e+00  5.10072019e+00  2.05120856e+01
  1.22844112e+02  6.21145916e+02  2.76505642e+03  1.22429877e+04
  4.08625652e+04  1.04905075e+05  2.30087849e+05  4.55902365e+05
  8.44854330e+05  1.52803133e+06  2.85029842e+06  5.80818532e+06]
E1 = -706.6663543390489  E_coul = 198.68939611830157
cycle= 4 E= -507.976958220747  delta_E= -4e-06  |g|= 0.000149  |ddm|= 0.037
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000119011
diis-c [-1.64020137e-10 -8.53062594e-06  6.50443956e-03 -7.84566809e-02
  1.07196077e+00]
  HOMO = -0.242849181333945  LUMO = 1.07765434083467
  mo_energy =
[-1.20322132e+02 -1.23800029e+01 -6.67803819e+00 -6.67803819e+00
 -6.67803819e+00 -1.17914772e+00 -2.42849181e-01 -2.42849181e-01
 -2.42849181e-01  1.07765434e+00  5.10061903e+00  2.05119403e+01
  1.22843982e+02  6.21145806e+02  2.76505632e+03  1.22429876e+04
  4.08625651e+04  1.04905075e+05  2.30087849e+05  4.55902364e+05
  8.44854330e+05  1.52803133e+06  2.85029842e+06  5.80818532e+06]
E1 = -706.6659938397923  E_coul = 198.68903561442954
cycle= 5 E= -507.976958225363  delta_E= -4.62e-09  |g|= 4.3e-06  |ddm|= 0.00205
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.44987e-06
diis-c [-4.39056037e-13  3.01655000e-07 -4.58159029e-04  5.23354025e-03
 -7.44373764e-02  1.06966169e+00]
  HOMO = -0.24285073450531  LUMO = 1.07765381539953
  mo_energy =
[-1.20322135e+02 -1.23800055e+01 -6.67804083e+00 -6.67804083e+00
 -6.67804083e+00 -1.17914885e+00 -2.42850735e-01 -2.42850735e-01
 -2.42850735e-01  1.07765382e+00  5.10061704e+00  2.05119378e+01
  1.22843979e+02  6.21145803e+02  2.76505631e+03  1.22429876e+04
  4.08625651e+04  1.04905075e+05  2.30087849e+05  4.55902364e+05
  8.44854330e+05  1.52803133e+06  2.85029842e+06  5.80818532e+06]
E1 = -706.6659866255569  E_coul = 198.68902840019035
cycle= 6 E= -507.976958225367  delta_E= -3.75e-12  |g|= 1.25e-07  |ddm|= 6.71e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6659866255569  E_coul = 198.68902840019035
  HOMO = -0.242850776755572  LUMO = 1.07765379039222
  mo_energy =
[-1.20322135e+02 -1.23800056e+01 -6.67804090e+00 -6.67804090e+00
 -6.67804090e+00 -1.17914887e+00 -2.42850777e-01 -2.42850777e-01
 -2.42850777e-01  1.07765379e+00  5.10061699e+00  2.05119377e+01
  1.22843979e+02  6.21145803e+02  2.76505631e+03  1.22429876e+04
  4.08625651e+04  1.04905075e+05  2.30087849e+05  4.55902364e+05
  8.44854330e+05  1.52803133e+06  2.85029842e+06  5.80818532e+06]
E1 = -706.6659864430172  E_coul = 198.68902821765084
Extra cycle  E= -507.976958225366  delta_E= 1.71e-13  |g|= 1.45e-08  |ddm|= 1.68e-06
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
exp = [2.66548020e-01 8.59320029e-01 1.17616814e+05 1.10229302e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315427e+03 1.83757993e+04
 1.44908371e+03 3.76381613e+02 1.14538037e+02 3.83788082e+01
 8.48411780e+00 3.71825910e+00 8.60427742e+00 4.92697688e-01]
E = -507.9769582253664
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:08:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.266548020157       1
[INPUT] 0    0    [1    /1   ]  0.859320028589       1
[INPUT] 0    0    [1    /1   ]  117616.813867        1
[INPUT] 0    0    [1    /1   ]  1.10229301632        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.4200213        1
[INPUT] 0    0    [1    /1   ]  36754.7149289        1
[INPUT] 0    0    [1    /1   ]  7303.15427325        1
[INPUT] 0    0    [1    /1   ]  18375.7992597        1
[INPUT] 0    0    [1    /1   ]  1449.08371165        1
[INPUT] 0    0    [1    /1   ]  376.381613322        1
[INPUT] 0    0    [1    /1   ]  114.538036741        1
[INPUT] 0    0    [1    /1   ]  38.3788082404        1
[INPUT] 0    0    [1    /1   ]  8.48411779801        1
[INPUT] 0    0    [1    /1   ]  3.71825910135        1
[INPUT] 1    0    [1    /1   ]  8.60427741687        1
[INPUT] 1    0    [1    /1   ]  0.492697687554       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2665480201572421, 1.0]], [0, [0.8593200285886725, 1.0]], [0, [117616.8138671872, 1.0]], [0, [1.1022930163158453, 1.0]], [0, [1176168.1426172398, 1.0]], [0, [588084.0699824869, 1.0]], [0, [294042.0310735935, 1.0]], [0, [147020.99191924118, 1.0]], [0, [73510.42002125934, 1.0]], [0, [36754.714928857684, 1.0]], [0, [7303.154273245783, 1.0]], [0, [18375.79925973563, 1.0]], [0, [1449.083711648006, 1.0]], [0, [376.3816133215482, 1.0]], [0, [114.53803674069047, 1.0]], [0, [38.3788082403743, 1.0]], [0, [8.484117798009995, 1.0]], [0, [3.718259101349212, 1.0]], [1, [8.60427741686613, 1.0]], [1, [0.4926976875539107, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26654802]
bas 1, expnt(s) = [0.85932003]
bas 2, expnt(s) = [117616.81386719]
bas 3, expnt(s) = [1.10229302]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998249]
bas 6, expnt(s) = [294042.03107359]
bas 7, expnt(s) = [147020.99191924]
bas 8, expnt(s) = [73510.42002126]
bas 9, expnt(s) = [36754.71492886]
bas 10, expnt(s) = [7303.15427325]
bas 11, expnt(s) = [18375.79925974]
bas 12, expnt(s) = [1449.08371165]
bas 13, expnt(s) = [376.38161332]
bas 14, expnt(s) = [114.53803674]
bas 15, expnt(s) = [38.37880824]
bas 16, expnt(s) = [8.4841178]
bas 17, expnt(s) = [3.7182591]
bas 18, expnt(s) = [8.60427742]
bas 19, expnt(s) = [0.49269769]
CPU time:       256.80
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.66548020e-01 9.37230946e-01 8.59320029e-01 2.25492045e+00
 1.17616814e+05 1.60460109e+04 1.10229302e+00 2.71792718e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315427e+03 1.99594183e+03 1.83757993e+04 3.98749088e+03
 1.44908371e+03 5.93383042e+02 3.76381613e+02 2.15891888e+02
 1.14538037e+02 8.84560058e+01 3.83788082e+01 3.89568325e+01
 8.48411780e+00 1.25594332e+01 3.71825910e+00 6.76503054e+00
 8.60427742e+00 4.29909852e+01 4.92697688e-01 1.20423168e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335814027535157
cond(S) = 907973.8429065134
E1 = -689.5847048385386  E_coul = 184.97246667512798
init E= -504.612238163411
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672106480123825  LUMO = 0.715911833244727
  mo_energy =
[-1.21704246e+02 -1.33852156e+01 -7.62350631e+00 -7.62350631e+00
 -7.62350631e+00 -1.65715910e+00 -6.72106480e-01 -6.72106480e-01
 -6.72106480e-01  7.15911833e-01  4.54905610e+00  1.96178430e+01
  1.21555410e+02  6.19783538e+02  2.76377159e+03  1.22418227e+04
  4.08614707e+04  1.04904019e+05  2.30086818e+05  4.55901351e+05
  8.44853330e+05  1.52803034e+06  2.85029744e+06  5.80818435e+06]
E1 = -707.7203618302042  E_coul = 199.76121120146107
cycle= 1 E= -507.959150628743  delta_E= -3.35  |g|= 0.451  |ddm|= 1.03
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.66094
diis-c [-0.43684219  1.        ]
  HOMO = -0.218210011457074  LUMO = 1.0825860785568
  mo_energy =
[-1.20197239e+02 -1.23051355e+01 -6.59546961e+00 -6.59546961e+00
 -6.59546961e+00 -1.16348238e+00 -2.18210011e-01 -2.18210011e-01
 -2.18210011e-01  1.08258608e+00  5.12879354e+00  2.05748534e+01
  1.22949073e+02  6.21274846e+02  2.76520221e+03  1.22431441e+04
  4.08627255e+04  1.04905237e+05  2.30088012e+05  4.55902528e+05
  8.44854494e+05  1.52803150e+06  2.85029858e+06  5.80818549e+06]
E1 = -706.782199369901  E_coul = 198.80548233369544
cycle= 2 E= -507.976717036206  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.868
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.032901
diis-c [-0.00107626 -0.00379096  1.00379096]
  HOMO = -0.239845370221587  LUMO = 1.07845102744391
  mo_energy =
[-1.20310855e+02 -1.23717686e+01 -6.66934643e+00 -6.66934643e+00
 -6.66934643e+00 -1.17733871e+00 -2.39845370e-01 -2.39845370e-01
 -2.39845370e-01  1.07845103e+00  5.10421247e+00  2.05189727e+01
  1.22854078e+02  6.21157224e+02  2.76506849e+03  1.22430002e+04
  4.08625778e+04  1.04905088e+05  2.30087862e+05  4.55902377e+05
  8.44854343e+05  1.52803134e+06  2.85029843e+06  5.80818533e+06]
E1 = -706.6800444215265  E_coul = 198.70309020277563
cycle= 3 E= -507.976954218751  delta_E= -0.000237  |g|= 0.00409  |ddm|= 0.191
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00377858
diis-c [-2.48008681e-06 -4.91543550e-05 -1.16578413e-01  1.11662757e+00]
  HOMO = -0.242769534257137  LUMO = 1.07768364739461
  mo_energy =
[-1.20322020e+02 -1.23798398e+01 -6.67788742e+00 -6.67788742e+00
 -6.67788742e+00 -1.17909985e+00 -2.42769534e-01 -2.42769534e-01
 -2.42769534e-01  1.07768365e+00  5.10072019e+00  2.05120856e+01
  1.22844112e+02  6.21145916e+02  2.76505642e+03  1.22429877e+04
  4.08625652e+04  1.04905075e+05  2.30087849e+05  4.55902365e+05
  8.44854330e+05  1.52803133e+06  2.85029842e+06  5.80818532e+06]
E1 = -706.6663543390489  E_coul = 198.68939611830157
cycle= 4 E= -507.976958220747  delta_E= -4e-06  |g|= 0.000149  |ddm|= 0.037
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000119011
diis-c [-1.64020137e-10 -8.53062594e-06  6.50443956e-03 -7.84566809e-02
  1.07196077e+00]
  HOMO = -0.242849181333945  LUMO = 1.07765434083467
  mo_energy =
[-1.20322132e+02 -1.23800029e+01 -6.67803819e+00 -6.67803819e+00
 -6.67803819e+00 -1.17914772e+00 -2.42849181e-01 -2.42849181e-01
 -2.42849181e-01  1.07765434e+00  5.10061903e+00  2.05119403e+01
  1.22843982e+02  6.21145806e+02  2.76505632e+03  1.22429876e+04
  4.08625651e+04  1.04905075e+05  2.30087849e+05  4.55902364e+05
  8.44854330e+05  1.52803133e+06  2.85029842e+06  5.80818532e+06]
E1 = -706.6659938397923  E_coul = 198.68903561442954
cycle= 5 E= -507.976958225363  delta_E= -4.62e-09  |g|= 4.3e-06  |ddm|= 0.00205
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.44987e-06
diis-c [-4.39056037e-13  3.01655000e-07 -4.58159029e-04  5.23354025e-03
 -7.44373764e-02  1.06966169e+00]
  HOMO = -0.24285073450531  LUMO = 1.07765381539953
  mo_energy =
[-1.20322135e+02 -1.23800055e+01 -6.67804083e+00 -6.67804083e+00
 -6.67804083e+00 -1.17914885e+00 -2.42850735e-01 -2.42850735e-01
 -2.42850735e-01  1.07765382e+00  5.10061704e+00  2.05119378e+01
  1.22843979e+02  6.21145803e+02  2.76505631e+03  1.22429876e+04
  4.08625651e+04  1.04905075e+05  2.30087849e+05  4.55902364e+05
  8.44854330e+05  1.52803133e+06  2.85029842e+06  5.80818532e+06]
E1 = -706.6659866255569  E_coul = 198.68902840019035
cycle= 6 E= -507.976958225367  delta_E= -3.75e-12  |g|= 1.25e-07  |ddm|= 6.71e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6659866255569  E_coul = 198.68902840019035
  HOMO = -0.242850776755572  LUMO = 1.07765379039222
  mo_energy =
[-1.20322135e+02 -1.23800056e+01 -6.67804090e+00 -6.67804090e+00
 -6.67804090e+00 -1.17914887e+00 -2.42850777e-01 -2.42850777e-01
 -2.42850777e-01  1.07765379e+00  5.10061699e+00  2.05119377e+01
  1.22843979e+02  6.21145803e+02  2.76505631e+03  1.22429876e+04
  4.08625651e+04  1.04905075e+05  2.30087849e+05  4.55902364e+05
  8.44854330e+05  1.52803133e+06  2.85029842e+06  5.80818532e+06]
E1 = -706.6659864430172  E_coul = 198.68902821765084
Extra cycle  E= -507.976958225366  delta_E= 1.71e-13  |g|= 1.45e-08  |ddm|= 1.68e-06
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907973.8429065134
E1 = -706.6659864430172  E_coul = 198.68902821765084
init E= -507.976958225366
    CPU time for initialize scf      3.34 sec, wall time      0.21 sec
  HOMO = -0.242850783143229  LUMO = 1.07765378750022
  mo_energy =
[-1.20322135e+02 -1.23800056e+01 -6.67804091e+00 -6.67804091e+00
 -6.67804091e+00 -1.17914887e+00 -2.42850783e-01 -2.42850783e-01
 -2.42850783e-01  1.07765379e+00  5.10061698e+00  2.05119377e+01
  1.22843979e+02  6.21145803e+02  2.76505631e+03  1.22429876e+04
  4.08625651e+04  1.04905075e+05  2.30087849e+05  4.55902364e+05
  8.44854330e+05  1.52803133e+06  2.85029842e+06  5.80818532e+06]
E1 = -706.6659864134587  E_coul = 198.68902818809218
cycle= 1 E= -507.976958225367  delta_E= -1.14e-13  |g|= 2.38e-09  |ddm|= 1.93e-07
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6659864134587  E_coul = 198.68902818809218
  HOMO = -0.242850784084485  LUMO = 1.07765378599519
  mo_energy =
[-1.20322135e+02 -1.23800056e+01 -6.67804091e+00 -6.67804091e+00
 -6.67804091e+00 -1.17914887e+00 -2.42850784e-01 -2.42850784e-01
 -2.42850784e-01  1.07765379e+00  5.10061698e+00  2.05119377e+01
  1.22843979e+02  6.21145803e+02  2.76505631e+03  1.22429876e+04
  4.08625651e+04  1.04905075e+05  2.30087849e+05  4.55902364e+05
  8.44854330e+05  1.52803133e+06  2.85029842e+06  5.80818532e+06]
E1 = -706.6659864090664  E_coul = 198.6890281836999
Extra cycle  E= -507.976958225367  delta_E=    0  |g|= 1.35e-09  |ddm|= 2.34e-08
    CPU time for scf_cycle      3.80 sec, wall time      0.38 sec
exp = [2.66548020e-01 8.59320029e-01 1.17616814e+05 1.10229302e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315427e+03 1.83757993e+04
 1.44908371e+03 3.76381613e+02 1.14538037e+02 3.83788082e+01
 8.48411780e+00 3.71825910e+00 8.60427742e+00 4.92697688e-01]
grad_E = [ 4.36149332e-04  1.12037963e-03  4.31779827e-09 -1.11128619e-04
  2.03681671e-11  1.17174957e-10  6.71670917e-10  2.63559199e-09
  1.09545834e-08  5.87657787e-08  3.70279969e-06  1.27930864e-07
  1.42693708e-06 -1.75987593e-05  2.15893023e-04 -1.28001702e-03
 -1.12775242e-03 -1.48799379e-03 -3.31814335e-05  6.42633041e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:08:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.264238387473       1
[INPUT] 0    0    [1    /1   ]  0.827518088716       1
[INPUT] 0    0    [1    /1   ]  117616.813867        1
[INPUT] 0    0    [1    /1   ]  1.080650171          1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.4200213        1
[INPUT] 0    0    [1    /1   ]  36754.7149289        1
[INPUT] 0    0    [1    /1   ]  7303.1542766         1
[INPUT] 0    0    [1    /1   ]  18375.7992599        1
[INPUT] 0    0    [1    /1   ]  1449.08370564        1
[INPUT] 0    0    [1    /1   ]  376.381735486        1
[INPUT] 0    0    [1    /1   ]  114.536482576        1
[INPUT] 0    0    [1    /1   ]  38.3885024606        1
[INPUT] 0    0    [1    /1   ]  8.49674172363        1
[INPUT] 0    0    [1    /1   ]  3.7042471322         1
[INPUT] 1    0    [1    /1   ]  8.60401495474        1
[INPUT] 1    0    [1    /1   ]  0.49271185443        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2642383874728805, 1.0]], [0, [0.8275180887160433, 1.0]], [0, [117616.8138671911, 1.0]], [0, [1.0806501709956677, 1.0]], [0, [1176168.1426172398, 1.0]], [0, [588084.069982487, 1.0]], [0, [294042.03107359406, 1.0]], [0, [147020.99191924356, 1.0]], [0, [73510.42002126924, 1.0]], [0, [36754.71492891065, 1.0]], [0, [7303.154276598923, 1.0]], [0, [18375.799259852287, 1.0]], [0, [1449.0837056399607, 1.0]], [0, [376.38173548576003, 1.0]], [0, [114.53648257571611, 1.0]], [0, [38.38850246062937, 1.0]], [0, [8.496741723633502, 1.0]], [0, [3.7042471321997685, 1.0]], [1, [8.604014954744224, 1.0]], [1, [0.49271185443036064, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26423839]
bas 1, expnt(s) = [0.82751809]
bas 2, expnt(s) = [117616.81386719]
bas 3, expnt(s) = [1.08065017]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998249]
bas 6, expnt(s) = [294042.03107359]
bas 7, expnt(s) = [147020.99191924]
bas 8, expnt(s) = [73510.42002127]
bas 9, expnt(s) = [36754.71492891]
bas 10, expnt(s) = [7303.1542766]
bas 11, expnt(s) = [18375.79925985]
bas 12, expnt(s) = [1449.08370564]
bas 13, expnt(s) = [376.38173549]
bas 14, expnt(s) = [114.53648258]
bas 15, expnt(s) = [38.38850246]
bas 16, expnt(s) = [8.49674172]
bas 17, expnt(s) = [3.70424713]
bas 18, expnt(s) = [8.60401495]
bas 19, expnt(s) = [0.49271185]
CPU time:       268.44
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.64238387e-01 9.31133511e-01 8.27518089e-01 2.19203834e+00
 1.17616814e+05 1.60460109e+04 1.08065017e+00 2.67780451e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315428e+03 1.99594183e+03 1.83757993e+04 3.98749088e+03
 1.44908371e+03 5.93383040e+02 3.76381735e+02 2.15891940e+02
 1.14536483e+02 8.84551057e+01 3.83885025e+01 3.89642124e+01
 8.49674172e+00 1.25734465e+01 3.70424713e+00 6.74590140e+00
 8.60401495e+00 4.29893460e+01 4.92711854e-01 1.20427496e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33581799394472
cond(S) = 907969.4650825739
E1 = -689.5838522289338  E_coul = 184.9718589262957
init E= -504.611993302638
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672090890764141  LUMO = 0.690640838934837
  mo_energy =
[-1.21704428e+02 -1.33852475e+01 -7.62354612e+00 -7.62354612e+00
 -7.62354612e+00 -1.65723729e+00 -6.72090891e-01 -6.72090891e-01
 -6.72090891e-01  6.90640839e-01  4.40542625e+00  1.93480777e+01
  1.21321591e+02  6.19611498e+02  2.76362904e+03  1.22416998e+04
  4.08613573e+04  1.04903910e+05  2.30086713e+05  4.55901248e+05
  8.44853228e+05  1.52803024e+06  2.85029734e+06  5.80818426e+06]
E1 = -707.722947748933  E_coul = 199.76377401597327
cycle= 1 E= -507.95917373296  delta_E= -3.35  |g|= 0.451  |ddm|= 0.922
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.65911
diis-c [-0.43442641  1.        ]
  HOMO = -0.218072059916276  LUMO = 1.05266364255519
  mo_energy =
[-1.20197097e+02 -1.23049686e+01 -6.59530540e+00 -6.59530540e+00
 -6.59530540e+00 -1.16342813e+00 -2.18072060e-01 -2.18072060e-01
 -2.18072060e-01  1.05266364e+00  4.97978713e+00  2.03046852e+01
  1.22715803e+02  6.21103205e+02  2.76506007e+03  1.22430216e+04
  4.08626125e+04  1.04905129e+05  2.30087907e+05  4.55902425e+05
  8.44854392e+05  1.52803140e+06  2.85029849e+06  5.80818539e+06]
E1 = -706.783976878138  E_coul = 198.80723086303078
cycle= 2 E= -507.976746015107  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.711
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0329727
diis-c [-0.0010813  -0.00370288  1.00370288]
  HOMO = -0.239740450933605  LUMO = 1.04871898412503
  mo_energy =
[-1.20310763e+02 -1.23716508e+01 -6.66923039e+00 -6.66923039e+00
 -6.66923039e+00 -1.17731223e+00 -2.39740451e-01 -2.39740451e-01
 -2.39740451e-01  1.04871898e+00  4.95571061e+00  2.02488814e+01
  1.22620746e+02  6.20985530e+02  2.76492630e+03  1.22428776e+04
  4.08624648e+04  1.04904979e+05  2.30087757e+05  4.55902274e+05
  8.44854241e+05  1.52803125e+06  2.85029834e+06  5.80818524e+06]
E1 = -706.681294596093  E_coul = 198.70430916863972
cycle= 3 E= -507.976985427453  delta_E= -0.000239  |g|= 0.00411  |ddm|= 0.162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00381621
diis-c [-2.48243998e-06 -7.53041913e-05 -1.17776110e-01  1.11785141e+00]
  HOMO = -0.242691964971899  LUMO = 1.04797317553971
  mo_energy =
[-1.20322000e+02 -1.23797806e+01 -6.67783167e+00 -6.67783167e+00
 -6.67783167e+00 -1.17909138e+00 -2.42691965e-01 -2.42691965e-01
 -2.42691965e-01  1.04797318e+00  4.95225325e+00  2.02419536e+01
  1.22610711e+02  6.20974148e+02  2.76491415e+03  1.22428650e+04
  4.08624520e+04  1.04904967e+05  2.30087744e+05  4.55902261e+05
  8.44854229e+05  1.52803123e+06  2.85029832e+06  5.80818523e+06]
E1 = -706.667420266956  E_coul = 198.6904307315782
cycle= 4 E= -507.976989535378  delta_E= -4.11e-06  |g|= 0.000152  |ddm|= 0.0322
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000119346
diis-c [-1.87011657e-10 -8.86360923e-06  6.58678224e-03 -7.85284709e-02
  1.07195055e+00]
  HOMO = -0.242771832281281  LUMO = 1.04794430522167
  mo_energy =
[-1.20322108e+02 -1.23799417e+01 -6.67797999e+00 -6.67797999e+00
 -6.67797999e+00 -1.17913943e+00 -2.42771832e-01 -2.42771832e-01
 -2.42771832e-01  1.04794431e+00  4.95215303e+00  2.02418096e+01
  1.22610586e+02  6.20974043e+02  2.76491405e+03  1.22428650e+04
  4.08624519e+04  1.04904966e+05  2.30087744e+05  4.55902261e+05
  8.44854229e+05  1.52803123e+06  2.85029832e+06  5.80818523e+06]
E1 = -706.6670566713185  E_coul = 198.69006713109783
cycle= 5 E= -507.976989540221  delta_E= -4.84e-09  |g|= 4.67e-06  |ddm|= 0.00184
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.59644e-06
diis-c [-4.94481257e-13  3.44806682e-07 -5.05980170e-04  5.72278845e-03
 -8.13344078e-02  1.07611725e+00]
  HOMO = -0.242773495246377  LUMO = 1.04794375077897
  mo_energy =
[-1.20322111e+02 -1.23799445e+01 -6.67798277e+00 -6.67798277e+00
 -6.67798277e+00 -1.17914063e+00 -2.42773495e-01 -2.42773495e-01
 -2.42773495e-01  1.04794375e+00  4.95215092e+00  2.02418069e+01
  1.22610583e+02  6.20974040e+02  2.76491405e+03  1.22428650e+04
  4.08624519e+04  1.04904966e+05  2.30087744e+05  4.55902261e+05
  8.44854229e+05  1.52803123e+06  2.85029832e+06  5.80818523e+06]
E1 = -706.6670488573986  E_coul = 198.6900593171749
cycle= 6 E= -507.976989540224  delta_E= -3.07e-12  |g|= 1.17e-07  |ddm|= 6.41e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6670488573986  E_coul = 198.6900593171749
  HOMO = -0.242773534763277  LUMO = 1.04794372307129
  mo_energy =
[-1.20322111e+02 -1.23799445e+01 -6.67798283e+00 -6.67798283e+00
 -6.67798283e+00 -1.17914065e+00 -2.42773535e-01 -2.42773535e-01
 -2.42773535e-01  1.04794372e+00  4.95215087e+00  2.02418068e+01
  1.22610583e+02  6.20974040e+02  2.76491405e+03  1.22428650e+04
  4.08624519e+04  1.04904966e+05  2.30087744e+05  4.55902261e+05
  8.44854229e+05  1.52803123e+06  2.85029832e+06  5.80818523e+06]
E1 = -706.6670486882043  E_coul = 198.69005914798103
Extra cycle  E= -507.976989540223  delta_E= 4.55e-13  |g|= 1.35e-08  |ddm|= 1.36e-06
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
exp = [2.64238387e-01 8.27518089e-01 1.17616814e+05 1.08065017e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315428e+03 1.83757993e+04
 1.44908371e+03 3.76381735e+02 1.14536483e+02 3.83885025e+01
 8.49674172e+00 3.70424713e+00 8.60401495e+00 4.92711854e-01]
E = -507.97698954022326
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:08:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.264238387473       1
[INPUT] 0    0    [1    /1   ]  0.827518088716       1
[INPUT] 0    0    [1    /1   ]  117616.813867        1
[INPUT] 0    0    [1    /1   ]  1.080650171          1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.4200213        1
[INPUT] 0    0    [1    /1   ]  36754.7149289        1
[INPUT] 0    0    [1    /1   ]  7303.1542766         1
[INPUT] 0    0    [1    /1   ]  18375.7992599        1
[INPUT] 0    0    [1    /1   ]  1449.08370564        1
[INPUT] 0    0    [1    /1   ]  376.381735486        1
[INPUT] 0    0    [1    /1   ]  114.536482576        1
[INPUT] 0    0    [1    /1   ]  38.3885024606        1
[INPUT] 0    0    [1    /1   ]  8.49674172363        1
[INPUT] 0    0    [1    /1   ]  3.7042471322         1
[INPUT] 1    0    [1    /1   ]  8.60401495474        1
[INPUT] 1    0    [1    /1   ]  0.49271185443        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2642383874728805, 1.0]], [0, [0.8275180887160433, 1.0]], [0, [117616.8138671911, 1.0]], [0, [1.0806501709956677, 1.0]], [0, [1176168.1426172398, 1.0]], [0, [588084.069982487, 1.0]], [0, [294042.03107359406, 1.0]], [0, [147020.99191924356, 1.0]], [0, [73510.42002126924, 1.0]], [0, [36754.71492891065, 1.0]], [0, [7303.154276598923, 1.0]], [0, [18375.799259852287, 1.0]], [0, [1449.0837056399607, 1.0]], [0, [376.38173548576003, 1.0]], [0, [114.53648257571611, 1.0]], [0, [38.38850246062937, 1.0]], [0, [8.496741723633502, 1.0]], [0, [3.7042471321997685, 1.0]], [1, [8.604014954744224, 1.0]], [1, [0.49271185443036064, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26423839]
bas 1, expnt(s) = [0.82751809]
bas 2, expnt(s) = [117616.81386719]
bas 3, expnt(s) = [1.08065017]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998249]
bas 6, expnt(s) = [294042.03107359]
bas 7, expnt(s) = [147020.99191924]
bas 8, expnt(s) = [73510.42002127]
bas 9, expnt(s) = [36754.71492891]
bas 10, expnt(s) = [7303.1542766]
bas 11, expnt(s) = [18375.79925985]
bas 12, expnt(s) = [1449.08370564]
bas 13, expnt(s) = [376.38173549]
bas 14, expnt(s) = [114.53648258]
bas 15, expnt(s) = [38.38850246]
bas 16, expnt(s) = [8.49674172]
bas 17, expnt(s) = [3.70424713]
bas 18, expnt(s) = [8.60401495]
bas 19, expnt(s) = [0.49271185]
CPU time:       269.71
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.64238387e-01 9.31133511e-01 8.27518089e-01 2.19203834e+00
 1.17616814e+05 1.60460109e+04 1.08065017e+00 2.67780451e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315428e+03 1.99594183e+03 1.83757993e+04 3.98749088e+03
 1.44908371e+03 5.93383040e+02 3.76381735e+02 2.15891940e+02
 1.14536483e+02 8.84551057e+01 3.83885025e+01 3.89642124e+01
 8.49674172e+00 1.25734465e+01 3.70424713e+00 6.74590140e+00
 8.60401495e+00 4.29893460e+01 4.92711854e-01 1.20427496e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33581799394472
cond(S) = 907969.4650825739
E1 = -689.5838522289338  E_coul = 184.9718589262957
init E= -504.611993302638
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672090890764141  LUMO = 0.690640838934837
  mo_energy =
[-1.21704428e+02 -1.33852475e+01 -7.62354612e+00 -7.62354612e+00
 -7.62354612e+00 -1.65723729e+00 -6.72090891e-01 -6.72090891e-01
 -6.72090891e-01  6.90640839e-01  4.40542625e+00  1.93480777e+01
  1.21321591e+02  6.19611498e+02  2.76362904e+03  1.22416998e+04
  4.08613573e+04  1.04903910e+05  2.30086713e+05  4.55901248e+05
  8.44853228e+05  1.52803024e+06  2.85029734e+06  5.80818426e+06]
E1 = -707.722947748933  E_coul = 199.76377401597327
cycle= 1 E= -507.95917373296  delta_E= -3.35  |g|= 0.451  |ddm|= 0.922
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.65911
diis-c [-0.43442641  1.        ]
  HOMO = -0.218072059916276  LUMO = 1.05266364255519
  mo_energy =
[-1.20197097e+02 -1.23049686e+01 -6.59530540e+00 -6.59530540e+00
 -6.59530540e+00 -1.16342813e+00 -2.18072060e-01 -2.18072060e-01
 -2.18072060e-01  1.05266364e+00  4.97978713e+00  2.03046852e+01
  1.22715803e+02  6.21103205e+02  2.76506007e+03  1.22430216e+04
  4.08626125e+04  1.04905129e+05  2.30087907e+05  4.55902425e+05
  8.44854392e+05  1.52803140e+06  2.85029849e+06  5.80818539e+06]
E1 = -706.783976878138  E_coul = 198.80723086303078
cycle= 2 E= -507.976746015107  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.711
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0329727
diis-c [-0.0010813  -0.00370288  1.00370288]
  HOMO = -0.239740450933605  LUMO = 1.04871898412503
  mo_energy =
[-1.20310763e+02 -1.23716508e+01 -6.66923039e+00 -6.66923039e+00
 -6.66923039e+00 -1.17731223e+00 -2.39740451e-01 -2.39740451e-01
 -2.39740451e-01  1.04871898e+00  4.95571061e+00  2.02488814e+01
  1.22620746e+02  6.20985530e+02  2.76492630e+03  1.22428776e+04
  4.08624648e+04  1.04904979e+05  2.30087757e+05  4.55902274e+05
  8.44854241e+05  1.52803125e+06  2.85029834e+06  5.80818524e+06]
E1 = -706.681294596093  E_coul = 198.70430916863972
cycle= 3 E= -507.976985427453  delta_E= -0.000239  |g|= 0.00411  |ddm|= 0.162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00381621
diis-c [-2.48243998e-06 -7.53041913e-05 -1.17776110e-01  1.11785141e+00]
  HOMO = -0.242691964971899  LUMO = 1.04797317553971
  mo_energy =
[-1.20322000e+02 -1.23797806e+01 -6.67783167e+00 -6.67783167e+00
 -6.67783167e+00 -1.17909138e+00 -2.42691965e-01 -2.42691965e-01
 -2.42691965e-01  1.04797318e+00  4.95225325e+00  2.02419536e+01
  1.22610711e+02  6.20974148e+02  2.76491415e+03  1.22428650e+04
  4.08624520e+04  1.04904967e+05  2.30087744e+05  4.55902261e+05
  8.44854229e+05  1.52803123e+06  2.85029832e+06  5.80818523e+06]
E1 = -706.667420266956  E_coul = 198.6904307315782
cycle= 4 E= -507.976989535378  delta_E= -4.11e-06  |g|= 0.000152  |ddm|= 0.0322
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000119346
diis-c [-1.87011657e-10 -8.86360923e-06  6.58678224e-03 -7.85284709e-02
  1.07195055e+00]
  HOMO = -0.242771832281281  LUMO = 1.04794430522167
  mo_energy =
[-1.20322108e+02 -1.23799417e+01 -6.67797999e+00 -6.67797999e+00
 -6.67797999e+00 -1.17913943e+00 -2.42771832e-01 -2.42771832e-01
 -2.42771832e-01  1.04794431e+00  4.95215303e+00  2.02418096e+01
  1.22610586e+02  6.20974043e+02  2.76491405e+03  1.22428650e+04
  4.08624519e+04  1.04904966e+05  2.30087744e+05  4.55902261e+05
  8.44854229e+05  1.52803123e+06  2.85029832e+06  5.80818523e+06]
E1 = -706.6670566713185  E_coul = 198.69006713109783
cycle= 5 E= -507.976989540221  delta_E= -4.84e-09  |g|= 4.67e-06  |ddm|= 0.00184
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.59644e-06
diis-c [-4.94481257e-13  3.44806682e-07 -5.05980170e-04  5.72278845e-03
 -8.13344078e-02  1.07611725e+00]
  HOMO = -0.242773495246377  LUMO = 1.04794375077897
  mo_energy =
[-1.20322111e+02 -1.23799445e+01 -6.67798277e+00 -6.67798277e+00
 -6.67798277e+00 -1.17914063e+00 -2.42773495e-01 -2.42773495e-01
 -2.42773495e-01  1.04794375e+00  4.95215092e+00  2.02418069e+01
  1.22610583e+02  6.20974040e+02  2.76491405e+03  1.22428650e+04
  4.08624519e+04  1.04904966e+05  2.30087744e+05  4.55902261e+05
  8.44854229e+05  1.52803123e+06  2.85029832e+06  5.80818523e+06]
E1 = -706.6670488573986  E_coul = 198.6900593171749
cycle= 6 E= -507.976989540224  delta_E= -3.07e-12  |g|= 1.17e-07  |ddm|= 6.41e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6670488573986  E_coul = 198.6900593171749
  HOMO = -0.242773534763277  LUMO = 1.04794372307129
  mo_energy =
[-1.20322111e+02 -1.23799445e+01 -6.67798283e+00 -6.67798283e+00
 -6.67798283e+00 -1.17914065e+00 -2.42773535e-01 -2.42773535e-01
 -2.42773535e-01  1.04794372e+00  4.95215087e+00  2.02418068e+01
  1.22610583e+02  6.20974040e+02  2.76491405e+03  1.22428650e+04
  4.08624519e+04  1.04904966e+05  2.30087744e+05  4.55902261e+05
  8.44854229e+05  1.52803123e+06  2.85029832e+06  5.80818523e+06]
E1 = -706.6670486882043  E_coul = 198.69005914798103
Extra cycle  E= -507.976989540223  delta_E= 4.55e-13  |g|= 1.35e-08  |ddm|= 1.36e-06
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907969.4650825739
E1 = -706.6670486882043  E_coul = 198.69005914798103
init E= -507.976989540223
    CPU time for initialize scf      3.28 sec, wall time      0.21 sec
  HOMO = -0.24277354070499  LUMO = 1.04794372218669
  mo_energy =
[-1.20322111e+02 -1.23799446e+01 -6.67798284e+00 -6.67798284e+00
 -6.67798284e+00 -1.17914065e+00 -2.42773541e-01 -2.42773541e-01
 -2.42773541e-01  1.04794372e+00  4.95215086e+00  2.02418068e+01
  1.22610583e+02  6.20974040e+02  2.76491405e+03  1.22428650e+04
  4.08624519e+04  1.04904966e+05  2.30087744e+05  4.55902261e+05
  8.44854229e+05  1.52803123e+06  2.85029832e+06  5.80818523e+06]
E1 = -706.6670486591145  E_coul = 198.69005911889087
cycle= 1 E= -507.976989540224  delta_E= -3.41e-13  |g|= 1.91e-09  |ddm|= 1.61e-07
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6670486591145  E_coul = 198.69005911889087
  HOMO = -0.24277354163448  LUMO = 1.04794372037066
  mo_energy =
[-1.20322111e+02 -1.23799446e+01 -6.67798285e+00 -6.67798285e+00
 -6.67798285e+00 -1.17914065e+00 -2.42773542e-01 -2.42773542e-01
 -2.42773542e-01  1.04794372e+00  4.95215086e+00  2.02418068e+01
  1.22610583e+02  6.20974040e+02  2.76491405e+03  1.22428650e+04
  4.08624519e+04  1.04904966e+05  2.30087744e+05  4.55902261e+05
  8.44854229e+05  1.52803123e+06  2.85029832e+06  5.80818523e+06]
E1 = -706.6670486575166  E_coul = 198.69005911729272
Extra cycle  E= -507.976989540224  delta_E= -2.84e-13  |g|= 1.19e-09  |ddm|= 1.27e-08
    CPU time for scf_cycle      3.74 sec, wall time      0.37 sec
exp = [2.64238387e-01 8.27518089e-01 1.17616814e+05 1.08065017e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315428e+03 1.83757993e+04
 1.44908371e+03 3.76381735e+02 1.14536483e+02 3.83885025e+01
 8.49674172e+00 3.70424713e+00 8.60401495e+00 4.92711854e-01]
grad_E = [ 3.58683788e-03  6.45308387e-04  4.32335040e-09 -4.18932242e-04
  2.04337367e-11  1.17355110e-10  6.72530037e-10  2.63902327e-09
  1.09690483e-08  5.88370917e-08  3.70788531e-06  1.28147867e-07
  1.13334541e-06 -1.31758814e-05  1.81759031e-04 -1.16718890e-03
 -1.04686159e-03 -1.60528692e-03 -2.47793756e-04  1.46890345e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:08:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.261884079816       1
[INPUT] 0    0    [1    /1   ]  0.792051689105       1
[INPUT] 0    0    [1    /1   ]  117616.813867        1
[INPUT] 0    0    [1    /1   ]  1.05873368167        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.4200211        1
[INPUT] 0    0    [1    /1   ]  36754.7149283        1
[INPUT] 0    0    [1    /1   ]  7303.15423597        1
[INPUT] 0    0    [1    /1   ]  18375.7992584        1
[INPUT] 0    0    [1    /1   ]  1449.08368071        1
[INPUT] 0    0    [1    /1   ]  376.382096434        1
[INPUT] 0    0    [1    /1   ]  114.532116388        1
[INPUT] 0    0    [1    /1   ]  38.4143173741        1
[INPUT] 0    0    [1    /1   ]  8.52530347037        1
[INPUT] 0    0    [1    /1   ]  3.70128994025        1
[INPUT] 1    0    [1    /1   ]  8.60371698846        1
[INPUT] 1    0    [1    /1   ]  0.492727737036       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2618840798160474, 1.0]], [0, [0.7920516891048991, 1.0]], [0, [117616.8138671437, 1.0]], [0, [1.0587336816727162, 1.0]], [0, [1176168.1426172396, 1.0]], [0, [588084.0699824857, 1.0]], [0, [294042.03107358667, 1.0]], [0, [147020.99191921463, 1.0]], [0, [73510.420021149, 1.0]], [0, [36754.71492826547, 1.0]], [0, [7303.154235966065, 1.0]], [0, [18375.79925844948, 1.0]], [0, [1449.083680705449, 1.0]], [0, [376.3820964341419, 1.0]], [0, [114.53211638755411, 1.0]], [0, [38.414317374092654, 1.0]], [0, [8.525303470369677, 1.0]], [0, [3.701289940253981, 1.0]], [1, [8.603716988459743, 1.0]], [1, [0.49272773703562855, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26188408]
bas 1, expnt(s) = [0.79205169]
bas 2, expnt(s) = [117616.81386714]
bas 3, expnt(s) = [1.05873368]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998249]
bas 6, expnt(s) = [294042.03107359]
bas 7, expnt(s) = [147020.99191921]
bas 8, expnt(s) = [73510.42002115]
bas 9, expnt(s) = [36754.71492827]
bas 10, expnt(s) = [7303.15423597]
bas 11, expnt(s) = [18375.79925845]
bas 12, expnt(s) = [1449.08368071]
bas 13, expnt(s) = [376.38209643]
bas 14, expnt(s) = [114.53211639]
bas 15, expnt(s) = [38.41431737]
bas 16, expnt(s) = [8.52530347]
bas 17, expnt(s) = [3.70128994]
bas 18, expnt(s) = [8.60371699]
bas 19, expnt(s) = [0.49272774]
CPU time:       281.30
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61884080e-01 9.24904405e-01 7.92051689e-01 2.12119291e+00
 1.17616814e+05 1.60460109e+04 1.05873368e+00 2.63696929e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315424e+03 1.99594182e+03 1.83757993e+04 3.98749088e+03
 1.44908368e+03 5.93383032e+02 3.76382096e+02 2.15892096e+02
 1.14532116e+02 8.84525767e+01 3.84143174e+01 3.89838623e+01
 8.52530347e+00 1.26051323e+01 3.70128994e+00 6.74186193e+00
 8.60371699e+00 4.29874851e+01 4.92727737e-01 1.20432349e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33581288269011
cond(S) = 907966.4461796914
E1 = -689.5825692911393  E_coul = 184.97113237379276
init E= -504.611436917347
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672075641562264  LUMO = 0.663693626077253
  mo_energy =
[-1.21704663e+02 -1.33852850e+01 -7.62359169e+00 -7.62359169e+00
 -7.62359169e+00 -1.65732801e+00 -6.72075642e-01 -6.72075642e-01
 -6.72075642e-01  6.63693626e-01  4.25391204e+00  1.91069455e+01
  1.21210761e+02  6.19581998e+02  2.76361524e+03  1.22416896e+04
  4.08613482e+04  1.04903901e+05  2.30086704e+05  4.55901239e+05
  8.44853220e+05  1.52803024e+06  2.85029734e+06  5.80818425e+06]
E1 = -707.7261866539545  E_coul = 199.76695140658745
cycle= 1 E= -507.959235247367  delta_E= -3.35  |g|= 0.451  |ddm|= 0.827
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.657129
diis-c [-0.43181865  1.        ]
  HOMO = -0.217914775924148  LUMO = 1.0206592851818
  mo_energy =
[-1.20196912e+02 -1.23047639e+01 -6.59509449e+00 -6.59509449e+00
 -6.59509449e+00 -1.16336116e+00 -2.17914776e-01 -2.17914776e-01
 -2.17914776e-01  1.02065929e+00  4.82267514e+00  2.00640567e+01
  1.22605698e+02  6.21074203e+02  2.76504680e+03  1.22430121e+04
  4.08626040e+04  1.04905121e+05  2.30087899e+05  4.55902417e+05
  8.44854385e+05  1.52803139e+06  2.85029848e+06  5.80818538e+06]
E1 = -706.7866901122296  E_coul = 198.80988372763073
cycle= 2 E= -507.976806384599  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.577
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.033014
diis-c [-0.00108443 -0.0035836   1.0035836 ]
  HOMO = -0.239605097784116  LUMO = 1.01692165192633
  mo_energy =
[-1.20310599e+02 -1.23714733e+01 -6.66904441e+00 -6.66904441e+00
 -6.66904441e+00 -1.17726589e+00 -2.39605098e-01 -2.39605098e-01
 -2.39605098e-01  1.01692165e+00  4.79914847e+00  2.00082922e+01
  1.22510594e+02  6.20956504e+02  2.76491301e+03  1.22428681e+04
  4.08624562e+04  1.04904971e+05  2.30087749e+05  4.55902267e+05
  8.44854234e+05  1.52803124e+06  2.85029833e+06  5.80818523e+06]
E1 = -706.6835046440431  E_coul = 198.70645664777405
cycle= 3 E= -507.977047996269  delta_E= -0.000242  |g|= 0.00414  |ddm|= 0.135
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00385156
diis-c [-2.48098764e-06 -1.04216837e-04 -1.19011119e-01  1.11911534e+00]
  HOMO = -0.242584058614948  LUMO = 1.0162002854725
  mo_energy =
[-1.20321911e+02 -1.23796623e+01 -6.67770697e+00 -6.67770697e+00
 -6.67770697e+00 -1.17906323e+00 -2.42584059e-01 -2.42584059e-01
 -2.42584059e-01  1.01620029e+00  4.79573105e+00  2.00013173e+01
  1.22500489e+02  6.20945046e+02  2.76490077e+03  1.22428554e+04
  4.08624434e+04  1.04904958e+05  2.30087736e+05  4.55902254e+05
  8.44854221e+05  1.52803122e+06  2.85029832e+06  5.80818522e+06]
E1 = -706.6694382895948  E_coul = 198.69238607080223
cycle= 4 E= -507.977052218793  delta_E= -4.22e-06  |g|= 0.000155  |ddm|= 0.0275
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000119846
diis-c [-2.17343284e-10 -9.20471589e-06  6.68237134e-03 -7.87388298e-02
  1.07206566e+00]
  HOMO = -0.242664317663654  LUMO = 1.01617185869664
  mo_energy =
[-1.20322014e+02 -1.23798218e+01 -6.67785309e+00 -6.67785309e+00
 -6.67785309e+00 -1.17911156e+00 -2.42664318e-01 -2.42664318e-01
 -2.42664318e-01  1.01617186e+00  4.79563161e+00  2.00011743e+01
  1.22500367e+02  6.20944947e+02  2.76490069e+03  1.22428553e+04
  4.08624433e+04  1.04904958e+05  2.30087736e+05  4.55902254e+05
  8.44854221e+05  1.52803122e+06  2.85029832e+06  5.80818522e+06]
E1 = -706.669070386633  E_coul = 198.69201816271215
cycle= 5 E= -507.977052223921  delta_E= -5.13e-09  |g|= 5.09e-06  |ddm|= 0.00162
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.7712e-06
diis-c [-5.58931884e-13  3.83183490e-07 -5.56790131e-04  6.23326487e-03
 -8.84612151e-02  1.08278436e+00]
  HOMO = -0.242666105413854  LUMO = 1.01617127018068
  mo_energy =
[-1.20322017e+02 -1.23798247e+01 -6.67785603e+00 -6.67785603e+00
 -6.67785603e+00 -1.17911286e+00 -2.42666105e-01 -2.42666105e-01
 -2.42666105e-01  1.01617127e+00  4.79562936e+00  2.00011715e+01
  1.22500364e+02  6.20944943e+02  2.76490068e+03  1.22428553e+04
  4.08624433e+04  1.04904958e+05  2.30087736e+05  4.55902254e+05
  8.44854221e+05  1.52803122e+06  2.85029832e+06  5.80818522e+06]
E1 = -706.669061877014  E_coul = 198.69200965308804
cycle= 6 E= -507.977052223926  delta_E= -5.06e-12  |g|= 1.07e-07  |ddm|= 6.04e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.669061877014  E_coul = 198.69200965308804
  HOMO = -0.242666141697982  LUMO = 1.01617124572753
  mo_energy =
[-1.20322017e+02 -1.23798248e+01 -6.67785608e+00 -6.67785608e+00
 -6.67785608e+00 -1.17911287e+00 -2.42666142e-01 -2.42666142e-01
 -2.42666142e-01  1.01617125e+00  4.79562930e+00  2.00011714e+01
  1.22500364e+02  6.20944943e+02  2.76490068e+03  1.22428553e+04
  4.08624433e+04  1.04904958e+05  2.30087736e+05  4.55902254e+05
  8.44854221e+05  1.52803122e+06  2.85029832e+06  5.80818522e+06]
E1 = -706.6690617226891  E_coul = 198.69200949876316
Extra cycle  E= -507.977052223926  delta_E=    0  |g|= 1.25e-08  |ddm|= 1.05e-06
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.61884080e-01 7.92051689e-01 1.17616814e+05 1.05873368e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315424e+03 1.83757993e+04
 1.44908368e+03 3.76382096e+02 1.14532116e+02 3.84143174e+01
 8.52530347e+00 3.70128994e+00 8.60371699e+00 4.92727737e-01]
E = -507.97705222392597
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:08:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.261884079816       1
[INPUT] 0    0    [1    /1   ]  0.792051689105       1
[INPUT] 0    0    [1    /1   ]  117616.813867        1
[INPUT] 0    0    [1    /1   ]  1.05873368167        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.4200211        1
[INPUT] 0    0    [1    /1   ]  36754.7149283        1
[INPUT] 0    0    [1    /1   ]  7303.15423597        1
[INPUT] 0    0    [1    /1   ]  18375.7992584        1
[INPUT] 0    0    [1    /1   ]  1449.08368071        1
[INPUT] 0    0    [1    /1   ]  376.382096434        1
[INPUT] 0    0    [1    /1   ]  114.532116388        1
[INPUT] 0    0    [1    /1   ]  38.4143173741        1
[INPUT] 0    0    [1    /1   ]  8.52530347037        1
[INPUT] 0    0    [1    /1   ]  3.70128994025        1
[INPUT] 1    0    [1    /1   ]  8.60371698846        1
[INPUT] 1    0    [1    /1   ]  0.492727737036       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2618840798160474, 1.0]], [0, [0.7920516891048991, 1.0]], [0, [117616.8138671437, 1.0]], [0, [1.0587336816727162, 1.0]], [0, [1176168.1426172396, 1.0]], [0, [588084.0699824857, 1.0]], [0, [294042.03107358667, 1.0]], [0, [147020.99191921463, 1.0]], [0, [73510.420021149, 1.0]], [0, [36754.71492826547, 1.0]], [0, [7303.154235966065, 1.0]], [0, [18375.79925844948, 1.0]], [0, [1449.083680705449, 1.0]], [0, [376.3820964341419, 1.0]], [0, [114.53211638755411, 1.0]], [0, [38.414317374092654, 1.0]], [0, [8.525303470369677, 1.0]], [0, [3.701289940253981, 1.0]], [1, [8.603716988459743, 1.0]], [1, [0.49272773703562855, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26188408]
bas 1, expnt(s) = [0.79205169]
bas 2, expnt(s) = [117616.81386714]
bas 3, expnt(s) = [1.05873368]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998249]
bas 6, expnt(s) = [294042.03107359]
bas 7, expnt(s) = [147020.99191921]
bas 8, expnt(s) = [73510.42002115]
bas 9, expnt(s) = [36754.71492827]
bas 10, expnt(s) = [7303.15423597]
bas 11, expnt(s) = [18375.79925845]
bas 12, expnt(s) = [1449.08368071]
bas 13, expnt(s) = [376.38209643]
bas 14, expnt(s) = [114.53211639]
bas 15, expnt(s) = [38.41431737]
bas 16, expnt(s) = [8.52530347]
bas 17, expnt(s) = [3.70128994]
bas 18, expnt(s) = [8.60371699]
bas 19, expnt(s) = [0.49272774]
CPU time:       282.57
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61884080e-01 9.24904405e-01 7.92051689e-01 2.12119291e+00
 1.17616814e+05 1.60460109e+04 1.05873368e+00 2.63696929e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315424e+03 1.99594182e+03 1.83757993e+04 3.98749088e+03
 1.44908368e+03 5.93383032e+02 3.76382096e+02 2.15892096e+02
 1.14532116e+02 8.84525767e+01 3.84143174e+01 3.89838623e+01
 8.52530347e+00 1.26051323e+01 3.70128994e+00 6.74186193e+00
 8.60371699e+00 4.29874851e+01 4.92727737e-01 1.20432349e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33581288269011
cond(S) = 907966.4461796914
E1 = -689.5825692911393  E_coul = 184.97113237379276
init E= -504.611436917347
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672075641562264  LUMO = 0.663693626077253
  mo_energy =
[-1.21704663e+02 -1.33852850e+01 -7.62359169e+00 -7.62359169e+00
 -7.62359169e+00 -1.65732801e+00 -6.72075642e-01 -6.72075642e-01
 -6.72075642e-01  6.63693626e-01  4.25391204e+00  1.91069455e+01
  1.21210761e+02  6.19581998e+02  2.76361524e+03  1.22416896e+04
  4.08613482e+04  1.04903901e+05  2.30086704e+05  4.55901239e+05
  8.44853220e+05  1.52803024e+06  2.85029734e+06  5.80818425e+06]
E1 = -707.7261866539545  E_coul = 199.76695140658745
cycle= 1 E= -507.959235247367  delta_E= -3.35  |g|= 0.451  |ddm|= 0.827
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.657129
diis-c [-0.43181865  1.        ]
  HOMO = -0.217914775924148  LUMO = 1.0206592851818
  mo_energy =
[-1.20196912e+02 -1.23047639e+01 -6.59509449e+00 -6.59509449e+00
 -6.59509449e+00 -1.16336116e+00 -2.17914776e-01 -2.17914776e-01
 -2.17914776e-01  1.02065929e+00  4.82267514e+00  2.00640567e+01
  1.22605698e+02  6.21074203e+02  2.76504680e+03  1.22430121e+04
  4.08626040e+04  1.04905121e+05  2.30087899e+05  4.55902417e+05
  8.44854385e+05  1.52803139e+06  2.85029848e+06  5.80818538e+06]
E1 = -706.7866901122296  E_coul = 198.80988372763073
cycle= 2 E= -507.976806384599  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.577
    CPU time for cycle= 2      0.10 sec, wall time      0.03 sec
diis-norm(errvec)=0.033014
diis-c [-0.00108443 -0.0035836   1.0035836 ]
  HOMO = -0.239605097784116  LUMO = 1.01692165192633
  mo_energy =
[-1.20310599e+02 -1.23714733e+01 -6.66904441e+00 -6.66904441e+00
 -6.66904441e+00 -1.17726589e+00 -2.39605098e-01 -2.39605098e-01
 -2.39605098e-01  1.01692165e+00  4.79914847e+00  2.00082922e+01
  1.22510594e+02  6.20956504e+02  2.76491301e+03  1.22428681e+04
  4.08624562e+04  1.04904971e+05  2.30087749e+05  4.55902267e+05
  8.44854234e+05  1.52803124e+06  2.85029833e+06  5.80818523e+06]
E1 = -706.6835046440431  E_coul = 198.70645664777405
cycle= 3 E= -507.977047996269  delta_E= -0.000242  |g|= 0.00414  |ddm|= 0.135
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00385156
diis-c [-2.48098764e-06 -1.04216837e-04 -1.19011119e-01  1.11911534e+00]
  HOMO = -0.242584058614948  LUMO = 1.0162002854725
  mo_energy =
[-1.20321911e+02 -1.23796623e+01 -6.67770697e+00 -6.67770697e+00
 -6.67770697e+00 -1.17906323e+00 -2.42584059e-01 -2.42584059e-01
 -2.42584059e-01  1.01620029e+00  4.79573105e+00  2.00013173e+01
  1.22500489e+02  6.20945046e+02  2.76490077e+03  1.22428554e+04
  4.08624434e+04  1.04904958e+05  2.30087736e+05  4.55902254e+05
  8.44854221e+05  1.52803122e+06  2.85029832e+06  5.80818522e+06]
E1 = -706.6694382895948  E_coul = 198.69238607080223
cycle= 4 E= -507.977052218793  delta_E= -4.22e-06  |g|= 0.000155  |ddm|= 0.0275
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000119846
diis-c [-2.17343284e-10 -9.20471589e-06  6.68237134e-03 -7.87388298e-02
  1.07206566e+00]
  HOMO = -0.242664317663654  LUMO = 1.01617185869664
  mo_energy =
[-1.20322014e+02 -1.23798218e+01 -6.67785309e+00 -6.67785309e+00
 -6.67785309e+00 -1.17911156e+00 -2.42664318e-01 -2.42664318e-01
 -2.42664318e-01  1.01617186e+00  4.79563161e+00  2.00011743e+01
  1.22500367e+02  6.20944947e+02  2.76490069e+03  1.22428553e+04
  4.08624433e+04  1.04904958e+05  2.30087736e+05  4.55902254e+05
  8.44854221e+05  1.52803122e+06  2.85029832e+06  5.80818522e+06]
E1 = -706.669070386633  E_coul = 198.69201816271215
cycle= 5 E= -507.977052223921  delta_E= -5.13e-09  |g|= 5.09e-06  |ddm|= 0.00162
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.7712e-06
diis-c [-5.58931884e-13  3.83183490e-07 -5.56790131e-04  6.23326487e-03
 -8.84612151e-02  1.08278436e+00]
  HOMO = -0.242666105413854  LUMO = 1.01617127018068
  mo_energy =
[-1.20322017e+02 -1.23798247e+01 -6.67785603e+00 -6.67785603e+00
 -6.67785603e+00 -1.17911286e+00 -2.42666105e-01 -2.42666105e-01
 -2.42666105e-01  1.01617127e+00  4.79562936e+00  2.00011715e+01
  1.22500364e+02  6.20944943e+02  2.76490068e+03  1.22428553e+04
  4.08624433e+04  1.04904958e+05  2.30087736e+05  4.55902254e+05
  8.44854221e+05  1.52803122e+06  2.85029832e+06  5.80818522e+06]
E1 = -706.669061877014  E_coul = 198.69200965308804
cycle= 6 E= -507.977052223926  delta_E= -5.06e-12  |g|= 1.07e-07  |ddm|= 6.04e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.669061877014  E_coul = 198.69200965308804
  HOMO = -0.242666141697982  LUMO = 1.01617124572753
  mo_energy =
[-1.20322017e+02 -1.23798248e+01 -6.67785608e+00 -6.67785608e+00
 -6.67785608e+00 -1.17911287e+00 -2.42666142e-01 -2.42666142e-01
 -2.42666142e-01  1.01617125e+00  4.79562930e+00  2.00011714e+01
  1.22500364e+02  6.20944943e+02  2.76490068e+03  1.22428553e+04
  4.08624433e+04  1.04904958e+05  2.30087736e+05  4.55902254e+05
  8.44854221e+05  1.52803122e+06  2.85029832e+06  5.80818522e+06]
E1 = -706.6690617226891  E_coul = 198.69200949876316
Extra cycle  E= -507.977052223926  delta_E=    0  |g|= 1.25e-08  |ddm|= 1.05e-06
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907966.4461796914
E1 = -706.6690617226891  E_coul = 198.69200949876316
init E= -507.977052223926
    CPU time for initialize scf      3.37 sec, wall time      0.21 sec
  HOMO = -0.242666147155235  LUMO = 1.01617124548681
  mo_energy =
[-1.20322017e+02 -1.23798248e+01 -6.67785609e+00 -6.67785609e+00
 -6.67785609e+00 -1.17911287e+00 -2.42666147e-01 -2.42666147e-01
 -2.42666147e-01  1.01617125e+00  4.79562930e+00  2.00011714e+01
  1.22500364e+02  6.20944943e+02  2.76490068e+03  1.22428553e+04
  4.08624433e+04  1.04904958e+05  2.30087736e+05  4.55902254e+05
  8.44854221e+05  1.52803122e+06  2.85029832e+06  5.80818522e+06]
E1 = -706.6690616944417  E_coul = 198.6920094705159
cycle= 1 E= -507.977052223926  delta_E= 2.27e-13  |g|= 1.53e-09  |ddm|= 1.35e-07
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6690616944417  E_coul = 198.6920094705159
  HOMO = -0.242666148059914  LUMO = 1.01617124190722
  mo_energy =
[-1.20322017e+02 -1.23798248e+01 -6.67785610e+00 -6.67785610e+00
 -6.67785610e+00 -1.17911288e+00 -2.42666148e-01 -2.42666148e-01
 -2.42666148e-01  1.01617124e+00  4.79562930e+00  2.00011714e+01
  1.22500364e+02  6.20944943e+02  2.76490068e+03  1.22428553e+04
  4.08624433e+04  1.04904958e+05  2.30087736e+05  4.55902254e+05
  8.44854221e+05  1.52803122e+06  2.85029832e+06  5.80818522e+06]
E1 = -706.6690616943055  E_coul = 198.69200947038
Extra cycle  E= -507.977052223926  delta_E= 2.27e-13  |g|= 1.7e-09  |ddm|= 4.88e-09
    CPU time for scf_cycle      3.82 sec, wall time      0.38 sec
exp = [2.61884080e-01 7.92051689e-01 1.17616814e+05 1.05873368e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315424e+03 1.83757993e+04
 1.44908368e+03 3.76382096e+02 1.14532116e+02 3.84143174e+01
 8.52530347e+00 3.70128994e+00 8.60371699e+00 4.92727737e-01]
grad_E = [ 7.86399205e-03 -1.03779122e-04  4.33418648e-09 -8.53722179e-04
  2.05617091e-11  1.17706938e-10  6.74206369e-10  2.64572065e-09
  1.09972853e-08  5.89761990e-08  3.71778045e-06  1.28572258e-07
  5.65861789e-07 -4.79239745e-06  1.21751469e-04 -1.00043568e-03
 -1.00958304e-03 -1.52200608e-03 -4.83806790e-04  2.50272269e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:08:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.260048494736       1
[INPUT] 0    0    [1    /1   ]  0.7525501488         1
[INPUT] 0    0    [1    /1   ]  117616.813867        1
[INPUT] 0    0    [1    /1   ]  1.04477643276        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.4200206        1
[INPUT] 0    0    [1    /1   ]  36754.7149254        1
[INPUT] 0    0    [1    /1   ]  7303.15405293        1
[INPUT] 0    0    [1    /1   ]  18375.7992521        1
[INPUT] 0    0    [1    /1   ]  1449.08359528        1
[INPUT] 0    0    [1    /1   ]  376.383213219        1
[INPUT] 0    0    [1    /1   ]  114.518889952        1
[INPUT] 0    0    [1    /1   ]  38.4906754384        1
[INPUT] 0    0    [1    /1   ]  8.60593471373        1
[INPUT] 0    0    [1    /1   ]  3.72732371184        1
[INPUT] 1    0    [1    /1   ]  8.60329587575        1
[INPUT] 1    0    [1    /1   ]  0.492743650916       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.26004849473560154, 1.0]], [0, [0.7525501488003351, 1.0]], [0, [117616.81386693026, 1.0]], [0, [1.0447764327645102, 1.0]], [0, [1176168.1426172387, 1.0]], [0, [588084.0699824799, 1.0]], [0, [294042.0310735535, 1.0]], [0, [147020.99191908434, 1.0]], [0, [73510.42002060746, 1.0]], [0, [36754.71492536014, 1.0]], [0, [7303.154052934058, 1.0]], [0, [18375.799252127505, 1.0]], [0, [1449.0835952842842, 1.0]], [0, [376.38321321905397, 1.0]], [0, [114.51888995239192, 1.0]], [0, [38.49067543843243, 1.0]], [0, [8.605934713726358, 1.0]], [0, [3.7273237118392557, 1.0]], [1, [8.603295875753071, 1.0]], [1, [0.49274365091588, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26004849]
bas 1, expnt(s) = [0.75255015]
bas 2, expnt(s) = [117616.81386693]
bas 3, expnt(s) = [1.04477643]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998248]
bas 6, expnt(s) = [294042.03107355]
bas 7, expnt(s) = [147020.99191908]
bas 8, expnt(s) = [73510.42002061]
bas 9, expnt(s) = [36754.71492536]
bas 10, expnt(s) = [7303.15405293]
bas 11, expnt(s) = [18375.79925213]
bas 12, expnt(s) = [1449.08359528]
bas 13, expnt(s) = [376.38321322]
bas 14, expnt(s) = [114.51888995]
bas 15, expnt(s) = [38.49067544]
bas 16, expnt(s) = [8.60593471]
bas 17, expnt(s) = [3.72732371]
bas 18, expnt(s) = [8.60329588]
bas 19, expnt(s) = [0.49274365]
CPU time:       294.33
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.60048495e-01 9.20038036e-01 7.52550149e-01 2.04134594e+00
 1.17616814e+05 1.60460109e+04 1.04477643e+00 2.61085378e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315405e+03 1.99594179e+03 1.83757993e+04 3.98749088e+03
 1.44908360e+03 5.93383006e+02 3.76383213e+02 2.15892576e+02
 1.14518890e+02 8.84449155e+01 3.84906754e+01 3.90419655e+01
 8.60593471e+00 1.26944404e+01 3.72732371e+00 6.77739594e+00
 8.60329588e+00 4.29848550e+01 4.92743651e-01 1.20437211e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335787062404613
cond(S) = 907968.7521270337
E1 = -689.5800393999863  E_coul = 184.96989921251634
init E= -504.61014018747
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672065211318785  LUMO = 0.637988813964323
  mo_energy =
[-1.21705064e+02 -1.33853665e+01 -7.62366445e+00 -7.62366445e+00
 -7.62366445e+00 -1.65743955e+00 -6.72065211e-01 -6.72065211e-01
 -6.72065211e-01  6.37988814e-01  4.11663785e+00  1.90212959e+01
  1.21541628e+02  6.20045488e+02  2.76404447e+03  1.22420673e+04
  4.08616979e+04  1.04904237e+05  2.30087030e+05  4.55901558e+05
  8.44853534e+05  1.52803054e+06  2.85029764e+06  5.80818454e+06]
E1 = -707.7303945174176  E_coul = 199.77099041229786
cycle= 1 E= -507.95940410512  delta_E= -3.35  |g|= 0.451  |ddm|= 0.741
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.655341
diis-c [-0.42947173  1.        ]
  HOMO = -0.217730825333367  LUMO = 0.990073753034234
  mo_energy =
[-1.20196677e+02 -1.23045272e+01 -6.59481762e+00 -6.59481762e+00
 -6.59481762e+00 -1.16327066e+00 -2.17730825e-01 -2.17730825e-01
 -2.17730825e-01  9.90073753e-01  4.68092876e+00  1.99816601e+01
  1.22937673e+02  6.21538409e+02  2.76547680e+03  1.22433905e+04
  4.08629546e+04  1.04905457e+05  2.30088226e+05  4.55902737e+05
  8.44854699e+05  1.52803170e+06  2.85029878e+06  5.80818568e+06]
E1 = -706.7910304041566  E_coul = 198.8140711589845
cycle= 2 E= -507.976959245172  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.472
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0329867
diis-c [-0.00108314 -0.00342016  1.00342016]
  HOMO = -0.239415735348096  LUMO = 0.986538393865268
  mo_energy =
[-1.20310327e+02 -1.23712145e+01 -6.66874168e+00 -6.66874168e+00
 -6.66874168e+00 -1.17717764e+00 -2.39415735e-01 -2.39415735e-01
 -2.39415735e-01  9.86538394e-01  4.65790412e+00  1.99257751e+01
  1.22842542e+02  6.21420748e+02  2.76534306e+03  1.22432466e+04
  4.08628069e+04  1.04905307e+05  2.30088076e+05  4.55902586e+05
  8.44854549e+05  1.52803155e+06  2.85029863e+06  5.80818553e+06]
E1 = -706.6874730244058  E_coul = 198.71027041116528
cycle= 3 E= -507.97720261324  delta_E= -0.000243  |g|= 0.00417  |ddm|= 0.109
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00387454
diis-c [-2.47373857e-06 -1.32525366e-04 -1.20043477e-01  1.12017600e+00]
  HOMO = -0.242417360438166  LUMO = 0.985842011739589
  mo_energy =
[-1.20321704e+02 -1.23794542e+01 -6.67745675e+00 -6.67745675e+00
 -6.67745675e+00 -1.17899027e+00 -2.42417360e-01 -2.42417360e-01
 -2.42417360e-01  9.85842012e-01  4.65452307e+00  1.99187412e+01
  1.22832373e+02  6.21409224e+02  2.76533075e+03  1.22432338e+04
  4.08627940e+04  1.04905294e+05  2.30088063e+05  4.55902573e+05
  8.44854535e+05  1.52803153e+06  2.85029862e+06  5.80818551e+06]
E1 = -706.6732329039459  E_coul = 198.6960259574867
cycle= 4 E= -507.977206946459  delta_E= -4.33e-06  |g|= 0.000159  |ddm|= 0.0225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000120656
diis-c [-2.55239912e-10 -9.48878228e-06  6.78501404e-03 -7.92172775e-02
  1.07244175e+00]
  HOMO = -0.242498520265968  LUMO = 0.985813902884522
  mo_energy =
[-1.20321804e+02 -1.23796135e+01 -6.67760225e+00 -6.67760225e+00
 -6.67760225e+00 -1.17903921e+00 -2.42498520e-01 -2.42498520e-01
 -2.42498520e-01  9.85813903e-01  4.65442360e+00  1.99185979e+01
  1.22832253e+02  6.21409127e+02  2.76533067e+03  1.22432338e+04
  4.08627939e+04  1.04905294e+05  2.30088063e+05  4.55902573e+05
  8.44854535e+05  1.52803153e+06  2.85029862e+06  5.80818551e+06]
E1 = -706.672857912378  E_coul = 198.6956509604228
cycle= 5 E= -507.977206951955  delta_E= -5.5e-09  |g|= 5.54e-06  |ddm|= 0.00137
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.96745e-06
diis-c [-6.26121438e-13  4.29949610e-07 -6.08141566e-04  6.75193997e-03
 -9.54320970e-02  1.08928787e+00]
  HOMO = -0.242500446695564  LUMO = 0.985813282218885
  mo_energy =
[-1.20321808e+02 -1.23796166e+01 -6.67760539e+00 -6.67760539e+00
 -6.67760539e+00 -1.17904060e+00 -2.42500447e-01 -2.42500447e-01
 -2.42500447e-01  9.85813282e-01  4.65442119e+00  1.99185948e+01
  1.22832250e+02  6.21409124e+02  2.76533066e+03  1.22432338e+04
  4.08627939e+04  1.04905294e+05  2.30088063e+05  4.55902573e+05
  8.44854535e+05  1.52803153e+06  2.85029862e+06  5.80818551e+06]
E1 = -706.6728486144116  E_coul = 198.69564166245016
cycle= 6 E= -507.977206951961  delta_E= -6.14e-12  |g|= 9.52e-08  |ddm|= 5.4e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6728486144116  E_coul = 198.69564166245016
  HOMO = -0.242500479535175  LUMO = 0.98581325616052
  mo_energy =
[-1.20321808e+02 -1.23796167e+01 -6.67760543e+00 -6.67760543e+00
 -6.67760543e+00 -1.17904061e+00 -2.42500480e-01 -2.42500480e-01
 -2.42500480e-01  9.85813256e-01  4.65442115e+00  1.99185948e+01
  1.22832250e+02  6.21409124e+02  2.76533066e+03  1.22432338e+04
  4.08627939e+04  1.04905294e+05  2.30088063e+05  4.55902573e+05
  8.44854535e+05  1.52803153e+06  2.85029862e+06  5.80818551e+06]
E1 = -706.6728484789844  E_coul = 198.6956415270236
Extra cycle  E= -507.977206951961  delta_E= 6.25e-13  |g|= 1.15e-08  |ddm|= 7.37e-07
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
exp = [2.60048495e-01 7.52550149e-01 1.17616814e+05 1.04477643e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315405e+03 1.83757993e+04
 1.44908360e+03 3.76383213e+02 1.14518890e+02 3.84906754e+01
 8.60593471e+00 3.72732371e+00 8.60329588e+00 4.92743651e-01]
E = -507.9772069519608
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:08:54 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.260048494736       1
[INPUT] 0    0    [1    /1   ]  0.7525501488         1
[INPUT] 0    0    [1    /1   ]  117616.813867        1
[INPUT] 0    0    [1    /1   ]  1.04477643276        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031074        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.4200206        1
[INPUT] 0    0    [1    /1   ]  36754.7149254        1
[INPUT] 0    0    [1    /1   ]  7303.15405293        1
[INPUT] 0    0    [1    /1   ]  18375.7992521        1
[INPUT] 0    0    [1    /1   ]  1449.08359528        1
[INPUT] 0    0    [1    /1   ]  376.383213219        1
[INPUT] 0    0    [1    /1   ]  114.518889952        1
[INPUT] 0    0    [1    /1   ]  38.4906754384        1
[INPUT] 0    0    [1    /1   ]  8.60593471373        1
[INPUT] 0    0    [1    /1   ]  3.72732371184        1
[INPUT] 1    0    [1    /1   ]  8.60329587575        1
[INPUT] 1    0    [1    /1   ]  0.492743650916       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.26004849473560154, 1.0]], [0, [0.7525501488003351, 1.0]], [0, [117616.81386693026, 1.0]], [0, [1.0447764327645102, 1.0]], [0, [1176168.1426172387, 1.0]], [0, [588084.0699824799, 1.0]], [0, [294042.0310735535, 1.0]], [0, [147020.99191908434, 1.0]], [0, [73510.42002060746, 1.0]], [0, [36754.71492536014, 1.0]], [0, [7303.154052934058, 1.0]], [0, [18375.799252127505, 1.0]], [0, [1449.0835952842842, 1.0]], [0, [376.38321321905397, 1.0]], [0, [114.51888995239192, 1.0]], [0, [38.49067543843243, 1.0]], [0, [8.605934713726358, 1.0]], [0, [3.7273237118392557, 1.0]], [1, [8.603295875753071, 1.0]], [1, [0.49274365091588, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26004849]
bas 1, expnt(s) = [0.75255015]
bas 2, expnt(s) = [117616.81386693]
bas 3, expnt(s) = [1.04477643]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998248]
bas 6, expnt(s) = [294042.03107355]
bas 7, expnt(s) = [147020.99191908]
bas 8, expnt(s) = [73510.42002061]
bas 9, expnt(s) = [36754.71492536]
bas 10, expnt(s) = [7303.15405293]
bas 11, expnt(s) = [18375.79925213]
bas 12, expnt(s) = [1449.08359528]
bas 13, expnt(s) = [376.38321322]
bas 14, expnt(s) = [114.51888995]
bas 15, expnt(s) = [38.49067544]
bas 16, expnt(s) = [8.60593471]
bas 17, expnt(s) = [3.72732371]
bas 18, expnt(s) = [8.60329588]
bas 19, expnt(s) = [0.49274365]
CPU time:       295.58
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.60048495e-01 9.20038036e-01 7.52550149e-01 2.04134594e+00
 1.17616814e+05 1.60460109e+04 1.04477643e+00 2.61085378e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315405e+03 1.99594179e+03 1.83757993e+04 3.98749088e+03
 1.44908360e+03 5.93383006e+02 3.76383213e+02 2.15892576e+02
 1.14518890e+02 8.84449155e+01 3.84906754e+01 3.90419655e+01
 8.60593471e+00 1.26944404e+01 3.72732371e+00 6.77739594e+00
 8.60329588e+00 4.29848550e+01 4.92743651e-01 1.20437211e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335787062404613
cond(S) = 907968.7521270337
E1 = -689.5800393999863  E_coul = 184.96989921251634
init E= -504.61014018747
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672065211318785  LUMO = 0.637988813964323
  mo_energy =
[-1.21705064e+02 -1.33853665e+01 -7.62366445e+00 -7.62366445e+00
 -7.62366445e+00 -1.65743955e+00 -6.72065211e-01 -6.72065211e-01
 -6.72065211e-01  6.37988814e-01  4.11663785e+00  1.90212959e+01
  1.21541628e+02  6.20045488e+02  2.76404447e+03  1.22420673e+04
  4.08616979e+04  1.04904237e+05  2.30087030e+05  4.55901558e+05
  8.44853534e+05  1.52803054e+06  2.85029764e+06  5.80818454e+06]
E1 = -707.7303945174176  E_coul = 199.77099041229786
cycle= 1 E= -507.95940410512  delta_E= -3.35  |g|= 0.451  |ddm|= 0.741
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.655341
diis-c [-0.42947173  1.        ]
  HOMO = -0.217730825333367  LUMO = 0.990073753034234
  mo_energy =
[-1.20196677e+02 -1.23045272e+01 -6.59481762e+00 -6.59481762e+00
 -6.59481762e+00 -1.16327066e+00 -2.17730825e-01 -2.17730825e-01
 -2.17730825e-01  9.90073753e-01  4.68092876e+00  1.99816601e+01
  1.22937673e+02  6.21538409e+02  2.76547680e+03  1.22433905e+04
  4.08629546e+04  1.04905457e+05  2.30088226e+05  4.55902737e+05
  8.44854699e+05  1.52803170e+06  2.85029878e+06  5.80818568e+06]
E1 = -706.7910304041566  E_coul = 198.8140711589845
cycle= 2 E= -507.976959245172  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.472
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0329867
diis-c [-0.00108314 -0.00342016  1.00342016]
  HOMO = -0.239415735348096  LUMO = 0.986538393865268
  mo_energy =
[-1.20310327e+02 -1.23712145e+01 -6.66874168e+00 -6.66874168e+00
 -6.66874168e+00 -1.17717764e+00 -2.39415735e-01 -2.39415735e-01
 -2.39415735e-01  9.86538394e-01  4.65790412e+00  1.99257751e+01
  1.22842542e+02  6.21420748e+02  2.76534306e+03  1.22432466e+04
  4.08628069e+04  1.04905307e+05  2.30088076e+05  4.55902586e+05
  8.44854549e+05  1.52803155e+06  2.85029863e+06  5.80818553e+06]
E1 = -706.6874730244058  E_coul = 198.71027041116528
cycle= 3 E= -507.97720261324  delta_E= -0.000243  |g|= 0.00417  |ddm|= 0.109
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00387454
diis-c [-2.47373857e-06 -1.32525366e-04 -1.20043477e-01  1.12017600e+00]
  HOMO = -0.242417360438166  LUMO = 0.985842011739589
  mo_energy =
[-1.20321704e+02 -1.23794542e+01 -6.67745675e+00 -6.67745675e+00
 -6.67745675e+00 -1.17899027e+00 -2.42417360e-01 -2.42417360e-01
 -2.42417360e-01  9.85842012e-01  4.65452307e+00  1.99187412e+01
  1.22832373e+02  6.21409224e+02  2.76533075e+03  1.22432338e+04
  4.08627940e+04  1.04905294e+05  2.30088063e+05  4.55902573e+05
  8.44854535e+05  1.52803153e+06  2.85029862e+06  5.80818551e+06]
E1 = -706.6732329039459  E_coul = 198.6960259574867
cycle= 4 E= -507.977206946459  delta_E= -4.33e-06  |g|= 0.000159  |ddm|= 0.0225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000120656
diis-c [-2.55239912e-10 -9.48878228e-06  6.78501404e-03 -7.92172775e-02
  1.07244175e+00]
  HOMO = -0.242498520265968  LUMO = 0.985813902884522
  mo_energy =
[-1.20321804e+02 -1.23796135e+01 -6.67760225e+00 -6.67760225e+00
 -6.67760225e+00 -1.17903921e+00 -2.42498520e-01 -2.42498520e-01
 -2.42498520e-01  9.85813903e-01  4.65442360e+00  1.99185979e+01
  1.22832253e+02  6.21409127e+02  2.76533067e+03  1.22432338e+04
  4.08627939e+04  1.04905294e+05  2.30088063e+05  4.55902573e+05
  8.44854535e+05  1.52803153e+06  2.85029862e+06  5.80818551e+06]
E1 = -706.672857912378  E_coul = 198.6956509604228
cycle= 5 E= -507.977206951955  delta_E= -5.5e-09  |g|= 5.54e-06  |ddm|= 0.00137
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.96745e-06
diis-c [-6.26121438e-13  4.29949610e-07 -6.08141566e-04  6.75193997e-03
 -9.54320970e-02  1.08928787e+00]
  HOMO = -0.242500446695564  LUMO = 0.985813282218885
  mo_energy =
[-1.20321808e+02 -1.23796166e+01 -6.67760539e+00 -6.67760539e+00
 -6.67760539e+00 -1.17904060e+00 -2.42500447e-01 -2.42500447e-01
 -2.42500447e-01  9.85813282e-01  4.65442119e+00  1.99185948e+01
  1.22832250e+02  6.21409124e+02  2.76533066e+03  1.22432338e+04
  4.08627939e+04  1.04905294e+05  2.30088063e+05  4.55902573e+05
  8.44854535e+05  1.52803153e+06  2.85029862e+06  5.80818551e+06]
E1 = -706.6728486144116  E_coul = 198.69564166245016
cycle= 6 E= -507.977206951961  delta_E= -6.14e-12  |g|= 9.52e-08  |ddm|= 5.4e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6728486144116  E_coul = 198.69564166245016
  HOMO = -0.242500479535175  LUMO = 0.98581325616052
  mo_energy =
[-1.20321808e+02 -1.23796167e+01 -6.67760543e+00 -6.67760543e+00
 -6.67760543e+00 -1.17904061e+00 -2.42500480e-01 -2.42500480e-01
 -2.42500480e-01  9.85813256e-01  4.65442115e+00  1.99185948e+01
  1.22832250e+02  6.21409124e+02  2.76533066e+03  1.22432338e+04
  4.08627939e+04  1.04905294e+05  2.30088063e+05  4.55902573e+05
  8.44854535e+05  1.52803153e+06  2.85029862e+06  5.80818551e+06]
E1 = -706.6728484789844  E_coul = 198.6956415270236
Extra cycle  E= -507.977206951961  delta_E= 6.25e-13  |g|= 1.15e-08  |ddm|= 7.37e-07
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907968.7521270337
E1 = -706.6728484789844  E_coul = 198.6956415270236
init E= -507.977206951961
    CPU time for initialize scf      3.42 sec, wall time      0.22 sec
  HOMO = -0.242500484343802  LUMO = 0.985813256703293
  mo_energy =
[-1.20321808e+02 -1.23796167e+01 -6.67760544e+00 -6.67760544e+00
 -6.67760544e+00 -1.17904061e+00 -2.42500484e-01 -2.42500484e-01
 -2.42500484e-01  9.85813257e-01  4.65442114e+00  1.99185948e+01
  1.22832250e+02  6.21409124e+02  2.76533066e+03  1.22432338e+04
  4.08627939e+04  1.04905294e+05  2.30088063e+05  4.55902573e+05
  8.44854535e+05  1.52803153e+06  2.85029862e+06  5.80818551e+06]
E1 = -706.6728484560061  E_coul = 198.69564150404474
cycle= 1 E= -507.977206951961  delta_E= -6.25e-13  |g|= 2.26e-09  |ddm|= 9.33e-08
    CPU time for cycle= 1      0.32 sec, wall time      0.03 sec
E1 = -706.6728484560061  E_coul = 198.69564150404474
  HOMO = -0.242500485102861  LUMO = 0.985813255927408
  mo_energy =
[-1.20321808e+02 -1.23796167e+01 -6.67760545e+00 -6.67760545e+00
 -6.67760545e+00 -1.17904061e+00 -2.42500485e-01 -2.42500485e-01
 -2.42500485e-01  9.85813256e-01  4.65442114e+00  1.99185948e+01
  1.22832250e+02  6.21409124e+02  2.76533066e+03  1.22432338e+04
  4.08627939e+04  1.04905294e+05  2.30088063e+05  4.55902573e+05
  8.44854535e+05  1.52803153e+06  2.85029862e+06  5.80818551e+06]
E1 = -706.6728484522719  E_coul = 198.69564150031087
Extra cycle  E= -507.977206951961  delta_E= 4.55e-13  |g|= 1.08e-09  |ddm|= 1.09e-08
    CPU time for scf_cycle      3.87 sec, wall time      0.38 sec
exp = [2.60048495e-01 7.52550149e-01 1.17616814e+05 1.04477643e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315405e+03 1.83757993e+04
 1.44908360e+03 3.76383213e+02 1.14518890e+02 3.84906754e+01
 8.60593471e+00 3.72732371e+00 8.60329588e+00 4.92743651e-01]
grad_E = [ 1.43229812e-02 -1.39685724e-03  4.36151297e-09 -1.49862397e-03
  2.08843549e-11  1.18594553e-10  6.78432972e-10  2.66261114e-09
  1.10685041e-08  5.93268674e-08  3.74267734e-06  1.29644051e-07
 -8.55200439e-07  1.59426227e-05 -1.90014939e-05 -6.62445524e-04
 -1.00504080e-03 -1.12120633e-03 -7.94449451e-04  3.91757061e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:09:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.262201134067       1
[INPUT] 0    0    [1    /1   ]  0.741615097591       1
[INPUT] 0    0    [1    /1   ]  117616.813866        1
[INPUT] 0    0    [1    /1   ]  1.07772403714        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031073        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.4200191        1
[INPUT] 0    0    [1    /1   ]  36754.7149174        1
[INPUT] 0    0    [1    /1   ]  7303.15355197        1
[INPUT] 0    0    [1    /1   ]  18375.7992348        1
[INPUT] 0    0    [1    /1   ]  1449.08338337        1
[INPUT] 0    0    [1    /1   ]  376.385857982        1
[INPUT] 0    0    [1    /1   ]  114.487836075        1
[INPUT] 0    0    [1    /1   ]  38.6680195082        1
[INPUT] 0    0    [1    /1   ]  8.79071919034        1
[INPUT] 0    0    [1    /1   ]  3.82262933536        1
[INPUT] 1    0    [1    /1   ]  8.60284222486        1
[INPUT] 1    0    [1    /1   ]  0.492743527824       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2622011340673126, 1.0]], [0, [0.7416150975909546, 1.0]], [0, [117616.81386634606, 1.0]], [0, [1.0777240371421377, 1.0]], [0, [1176168.142617236, 1.0]], [0, [588084.0699824641, 1.0]], [0, [294042.0310734626, 1.0]], [0, [147020.99191872776, 1.0]], [0, [73510.42001912533, 1.0]], [0, [36754.71491740887, 1.0]], [0, [7303.153551969907, 1.0]], [0, [18375.79923482159, 1.0]], [0, [1449.0833833728734, 1.0]], [0, [376.38585798189405, 1.0]], [0, [114.48783607473966, 1.0]], [0, [38.66801950822398, 1.0]], [0, [8.790719190339983, 1.0]], [0, [3.822629335363222, 1.0]], [1, [8.602842224856063, 1.0]], [1, [0.4927435278237075, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26220113]
bas 1, expnt(s) = [0.7416151]
bas 2, expnt(s) = [117616.81386635]
bas 3, expnt(s) = [1.07772404]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998246]
bas 6, expnt(s) = [294042.03107346]
bas 7, expnt(s) = [147020.99191873]
bas 8, expnt(s) = [73510.42001913]
bas 9, expnt(s) = [36754.71491741]
bas 10, expnt(s) = [7303.15355197]
bas 11, expnt(s) = [18375.79923482]
bas 12, expnt(s) = [1449.08338337]
bas 13, expnt(s) = [376.38585798]
bas 14, expnt(s) = [114.48783607]
bas 15, expnt(s) = [38.66801951]
bas 16, expnt(s) = [8.79071919]
bas 17, expnt(s) = [3.82262934]
bas 18, expnt(s) = [8.60284222]
bas 19, expnt(s) = [0.49274353]
CPU time:       307.11
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.62201134e-01 9.25744091e-01 7.41615098e-01 2.01905870e+00
 1.17616814e+05 1.60460109e+04 1.07772404e+00 2.67236455e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315355e+03 1.99594168e+03 1.83757992e+04 3.98749088e+03
 1.44908338e+03 5.93382941e+02 3.76385858e+02 2.15893714e+02
 1.14487836e+02 8.84269273e+01 3.86680195e+01 3.91768010e+01
 8.79071919e+00 1.28983254e+01 3.82262934e+00 6.90695562e+00
 8.60284222e+00 4.29820218e+01 4.92743528e-01 1.20437173e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335727199994118
cond(S) = 907987.7941862306
E1 = -689.5759140535466  E_coul = 184.96801719688875
init E= -504.607896856658
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672078029321893  LUMO = 0.645226741534588
  mo_energy =
[-1.21705632e+02 -1.33855403e+01 -7.62377343e+00 -7.62377343e+00
 -7.62377343e+00 -1.65752657e+00 -6.72078029e-01 -6.72078029e-01
 -6.72078029e-01  6.45226742e-01  4.18784599e+00  1.95993771e+01
  1.23105125e+02  6.21788408e+02  2.76561106e+03  1.22434385e+04
  4.08629667e+04  1.04905453e+05  2.30088212e+05  4.55902715e+05
  8.44854672e+05  1.52803166e+06  2.85029874e+06  5.80818561e+06]
E1 = -707.733559258087  E_coul = 199.77378825174503
cycle= 1 E= -507.959771006342  delta_E= -3.35  |g|= 0.451  |ddm|= 0.713
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.656221
diis-c [-0.4306259  1.       ]
  HOMO = -0.217619217956743  LUMO = 0.998911141089351
  mo_energy =
[-1.20196550e+02 -1.23044346e+01 -6.59461702e+00 -6.59461702e+00
 -6.59461702e+00 -1.16319256e+00 -2.17619218e-01 -2.17619218e-01
 -2.17619218e-01  9.98911141e-01  4.75761658e+00  2.05689723e+01
  1.24502415e+02  6.23282028e+02  2.76704420e+03  1.22447627e+04
  4.08642244e+04  1.04906674e+05  2.30089409e+05  4.55903895e+05
  8.44855838e+05  1.52803282e+06  2.85029988e+06  5.80818675e+06]
E1 = -706.7961142199493  E_coul = 198.81883346441202
cycle= 2 E= -507.977280755537  delta_E= -0.0175  |g|= 0.0348  |ddm|= 0.444
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0328247
diis-c [-0.00107278 -0.00331259  1.00331259]
  HOMO = -0.239223957785997  LUMO = 0.995330089353177
  mo_energy =
[-1.20310035e+02 -1.23709792e+01 -6.66839455e+00 -6.66839455e+00
 -6.66839455e+00 -1.17704600e+00 -2.39223958e-01 -2.39223958e-01
 -2.39223958e-01  9.95330089e-01  4.73426723e+00  2.05125109e+01
  1.24407322e+02  6.23164542e+02  2.76691064e+03  1.22446189e+04
  4.08640769e+04  1.04906525e+05  2.30089259e+05  4.55903745e+05
  8.44855688e+05  1.52803267e+06  2.85029973e+06  5.80818660e+06]
E1 = -706.6929378714767  E_coul = 198.7154151001749
cycle= 3 E= -507.977522771302  delta_E= -0.000242  |g|= 0.00416  |ddm|= 0.096
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00384005
diis-c [-2.46502189e-06 -1.26041603e-04 -1.19334407e-01  1.11946045e+00]
  HOMO = -0.242210376248804  LUMO = 0.99462827391737
  mo_energy =
[-1.20321381e+02 -1.23791908e+01 -6.67708119e+00 -6.67708119e+00
 -6.67708119e+00 -1.17884932e+00 -2.42210376e-01 -2.42210376e-01
 -2.42210376e-01  9.94628274e-01  4.73085008e+00  2.05054341e+01
  1.24397175e+02  6.23153050e+02  2.76689837e+03  1.22446062e+04
  4.08640640e+04  1.04906512e+05  2.30089246e+05  4.55903732e+05
  8.44855675e+05  1.52803265e+06  2.85029972e+06  5.80818658e+06]
E1 = -706.6787650279329  E_coul = 198.70123795125426
cycle= 4 E= -507.977527076679  delta_E= -4.31e-06  |g|= 0.000161  |ddm|= 0.0194
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000121296
diis-c [-2.56183656e-10 -9.35421379e-06  6.77625558e-03 -7.97687784e-02
  1.07300188e+00]
  HOMO = -0.242293025314489  LUMO = 0.99459963337378
  mo_energy =
[-1.20321488e+02 -1.23793549e+01 -6.67723184e+00 -6.67723184e+00
 -6.67723184e+00 -1.17889916e+00 -2.42293025e-01 -2.42293025e-01
 -2.42293025e-01  9.94599633e-01  4.73074782e+00  2.05052865e+01
  1.24397049e+02  6.23152946e+02  2.76689828e+03  1.22446061e+04
  4.08640639e+04  1.04906512e+05  2.30089246e+05  4.55903732e+05
  8.44855675e+05  1.52803265e+06  2.85029972e+06  5.80818658e+06]
E1 = -706.6783826923786  E_coul = 198.70085561009154
cycle= 5 E= -507.977527082287  delta_E= -5.61e-09  |g|= 5.48e-06  |ddm|= 0.00116
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.9617e-06
diis-c [-6.23296027e-13  4.31677936e-07 -6.06137880e-04  6.78263550e-03
 -9.51982850e-02  1.08902136e+00]
  HOMO = -0.242294967910266  LUMO = 0.994599006524195
  mo_energy =
[-1.20321491e+02 -1.23793581e+01 -6.67723506e+00 -6.67723506e+00
 -6.67723506e+00 -1.17890055e+00 -2.42294968e-01 -2.42294968e-01
 -2.42294968e-01  9.94599007e-01  4.73074537e+00  2.05052834e+01
  1.24397046e+02  6.23152942e+02  2.76689827e+03  1.22446061e+04
  4.08640639e+04  1.04906512e+05  2.30089246e+05  4.55903732e+05
  8.44855675e+05  1.52803265e+06  2.85029972e+06  5.80818658e+06]
E1 = -706.6783733220597  E_coul = 198.70084623976712
cycle= 6 E= -507.977527082293  delta_E= -5.51e-12  |g|= 9.37e-08  |ddm|= 4.44e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6783733220597  E_coul = 198.70084623976712
  HOMO = -0.242295000681835  LUMO = 0.994598982439436
  mo_energy =
[-1.20321491e+02 -1.23793582e+01 -6.67723511e+00 -6.67723511e+00
 -6.67723511e+00 -1.17890056e+00 -2.42295001e-01 -2.42295001e-01
 -2.42295001e-01  9.94598982e-01  4.73074533e+00  2.05052833e+01
  1.24397046e+02  6.23152942e+02  2.76689827e+03  1.22446061e+04
  4.08640639e+04  1.04906512e+05  2.30089246e+05  4.55903732e+05
  8.44855675e+05  1.52803265e+06  2.85029972e+06  5.80818658e+06]
E1 = -706.6783731867703  E_coul = 198.70084610447796
Extra cycle  E= -507.977527082292  delta_E= 2.27e-13  |g|= 1.18e-08  |ddm|= 5.99e-07
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
exp = [2.62201134e-01 7.41615098e-01 1.17616814e+05 1.07772404e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315355e+03 1.83757992e+04
 1.44908338e+03 3.76385858e+02 1.14487836e+02 3.86680195e+01
 8.79071919e+00 3.82262934e+00 8.60284222e+00 4.92743528e-01]
E = -507.97752708229234
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:09:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.262201134067       1
[INPUT] 0    0    [1    /1   ]  0.741615097591       1
[INPUT] 0    0    [1    /1   ]  117616.813866        1
[INPUT] 0    0    [1    /1   ]  1.07772403714        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031073        1
[INPUT] 0    0    [1    /1   ]  147020.991919        1
[INPUT] 0    0    [1    /1   ]  73510.4200191        1
[INPUT] 0    0    [1    /1   ]  36754.7149174        1
[INPUT] 0    0    [1    /1   ]  7303.15355197        1
[INPUT] 0    0    [1    /1   ]  18375.7992348        1
[INPUT] 0    0    [1    /1   ]  1449.08338337        1
[INPUT] 0    0    [1    /1   ]  376.385857982        1
[INPUT] 0    0    [1    /1   ]  114.487836075        1
[INPUT] 0    0    [1    /1   ]  38.6680195082        1
[INPUT] 0    0    [1    /1   ]  8.79071919034        1
[INPUT] 0    0    [1    /1   ]  3.82262933536        1
[INPUT] 1    0    [1    /1   ]  8.60284222486        1
[INPUT] 1    0    [1    /1   ]  0.492743527824       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2622011340673126, 1.0]], [0, [0.7416150975909546, 1.0]], [0, [117616.81386634606, 1.0]], [0, [1.0777240371421377, 1.0]], [0, [1176168.142617236, 1.0]], [0, [588084.0699824641, 1.0]], [0, [294042.0310734626, 1.0]], [0, [147020.99191872776, 1.0]], [0, [73510.42001912533, 1.0]], [0, [36754.71491740887, 1.0]], [0, [7303.153551969907, 1.0]], [0, [18375.79923482159, 1.0]], [0, [1449.0833833728734, 1.0]], [0, [376.38585798189405, 1.0]], [0, [114.48783607473966, 1.0]], [0, [38.66801950822398, 1.0]], [0, [8.790719190339983, 1.0]], [0, [3.822629335363222, 1.0]], [1, [8.602842224856063, 1.0]], [1, [0.4927435278237075, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26220113]
bas 1, expnt(s) = [0.7416151]
bas 2, expnt(s) = [117616.81386635]
bas 3, expnt(s) = [1.07772404]
bas 4, expnt(s) = [1176168.14261724]
bas 5, expnt(s) = [588084.06998246]
bas 6, expnt(s) = [294042.03107346]
bas 7, expnt(s) = [147020.99191873]
bas 8, expnt(s) = [73510.42001913]
bas 9, expnt(s) = [36754.71491741]
bas 10, expnt(s) = [7303.15355197]
bas 11, expnt(s) = [18375.79923482]
bas 12, expnt(s) = [1449.08338337]
bas 13, expnt(s) = [376.38585798]
bas 14, expnt(s) = [114.48783607]
bas 15, expnt(s) = [38.66801951]
bas 16, expnt(s) = [8.79071919]
bas 17, expnt(s) = [3.82262934]
bas 18, expnt(s) = [8.60284222]
bas 19, expnt(s) = [0.49274353]
CPU time:       308.36
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.62201134e-01 9.25744091e-01 7.41615098e-01 2.01905870e+00
 1.17616814e+05 1.60460109e+04 1.07772404e+00 2.67236455e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315355e+03 1.99594168e+03 1.83757992e+04 3.98749088e+03
 1.44908338e+03 5.93382941e+02 3.76385858e+02 2.15893714e+02
 1.14487836e+02 8.84269273e+01 3.86680195e+01 3.91768010e+01
 8.79071919e+00 1.28983254e+01 3.82262934e+00 6.90695562e+00
 8.60284222e+00 4.29820218e+01 4.92743528e-01 1.20437173e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335727199994118
cond(S) = 907987.7941862306
E1 = -689.5759140535466  E_coul = 184.96801719688875
init E= -504.607896856658
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672078029321893  LUMO = 0.645226741534588
  mo_energy =
[-1.21705632e+02 -1.33855403e+01 -7.62377343e+00 -7.62377343e+00
 -7.62377343e+00 -1.65752657e+00 -6.72078029e-01 -6.72078029e-01
 -6.72078029e-01  6.45226742e-01  4.18784599e+00  1.95993771e+01
  1.23105125e+02  6.21788408e+02  2.76561106e+03  1.22434385e+04
  4.08629667e+04  1.04905453e+05  2.30088212e+05  4.55902715e+05
  8.44854672e+05  1.52803166e+06  2.85029874e+06  5.80818561e+06]
E1 = -707.733559258087  E_coul = 199.77378825174503
cycle= 1 E= -507.959771006342  delta_E= -3.35  |g|= 0.451  |ddm|= 0.713
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.656221
diis-c [-0.4306259  1.       ]
  HOMO = -0.217619217956743  LUMO = 0.998911141089351
  mo_energy =
[-1.20196550e+02 -1.23044346e+01 -6.59461702e+00 -6.59461702e+00
 -6.59461702e+00 -1.16319256e+00 -2.17619218e-01 -2.17619218e-01
 -2.17619218e-01  9.98911141e-01  4.75761658e+00  2.05689723e+01
  1.24502415e+02  6.23282028e+02  2.76704420e+03  1.22447627e+04
  4.08642244e+04  1.04906674e+05  2.30089409e+05  4.55903895e+05
  8.44855838e+05  1.52803282e+06  2.85029988e+06  5.80818675e+06]
E1 = -706.7961142199493  E_coul = 198.81883346441202
cycle= 2 E= -507.977280755537  delta_E= -0.0175  |g|= 0.0348  |ddm|= 0.444
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0328247
diis-c [-0.00107278 -0.00331259  1.00331259]
  HOMO = -0.239223957785997  LUMO = 0.995330089353177
  mo_energy =
[-1.20310035e+02 -1.23709792e+01 -6.66839455e+00 -6.66839455e+00
 -6.66839455e+00 -1.17704600e+00 -2.39223958e-01 -2.39223958e-01
 -2.39223958e-01  9.95330089e-01  4.73426723e+00  2.05125109e+01
  1.24407322e+02  6.23164542e+02  2.76691064e+03  1.22446189e+04
  4.08640769e+04  1.04906525e+05  2.30089259e+05  4.55903745e+05
  8.44855688e+05  1.52803267e+06  2.85029973e+06  5.80818660e+06]
E1 = -706.6929378714767  E_coul = 198.7154151001749
cycle= 3 E= -507.977522771302  delta_E= -0.000242  |g|= 0.00416  |ddm|= 0.096
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00384005
diis-c [-2.46502189e-06 -1.26041603e-04 -1.19334407e-01  1.11946045e+00]
  HOMO = -0.242210376248804  LUMO = 0.99462827391737
  mo_energy =
[-1.20321381e+02 -1.23791908e+01 -6.67708119e+00 -6.67708119e+00
 -6.67708119e+00 -1.17884932e+00 -2.42210376e-01 -2.42210376e-01
 -2.42210376e-01  9.94628274e-01  4.73085008e+00  2.05054341e+01
  1.24397175e+02  6.23153050e+02  2.76689837e+03  1.22446062e+04
  4.08640640e+04  1.04906512e+05  2.30089246e+05  4.55903732e+05
  8.44855675e+05  1.52803265e+06  2.85029972e+06  5.80818658e+06]
E1 = -706.6787650279329  E_coul = 198.70123795125426
cycle= 4 E= -507.977527076679  delta_E= -4.31e-06  |g|= 0.000161  |ddm|= 0.0194
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000121296
diis-c [-2.56183656e-10 -9.35421379e-06  6.77625558e-03 -7.97687784e-02
  1.07300188e+00]
  HOMO = -0.242293025314489  LUMO = 0.99459963337378
  mo_energy =
[-1.20321488e+02 -1.23793549e+01 -6.67723184e+00 -6.67723184e+00
 -6.67723184e+00 -1.17889916e+00 -2.42293025e-01 -2.42293025e-01
 -2.42293025e-01  9.94599633e-01  4.73074782e+00  2.05052865e+01
  1.24397049e+02  6.23152946e+02  2.76689828e+03  1.22446061e+04
  4.08640639e+04  1.04906512e+05  2.30089246e+05  4.55903732e+05
  8.44855675e+05  1.52803265e+06  2.85029972e+06  5.80818658e+06]
E1 = -706.6783826923786  E_coul = 198.70085561009154
cycle= 5 E= -507.977527082287  delta_E= -5.61e-09  |g|= 5.48e-06  |ddm|= 0.00116
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.9617e-06
diis-c [-6.23296027e-13  4.31677936e-07 -6.06137880e-04  6.78263550e-03
 -9.51982850e-02  1.08902136e+00]
  HOMO = -0.242294967910266  LUMO = 0.994599006524195
  mo_energy =
[-1.20321491e+02 -1.23793581e+01 -6.67723506e+00 -6.67723506e+00
 -6.67723506e+00 -1.17890055e+00 -2.42294968e-01 -2.42294968e-01
 -2.42294968e-01  9.94599007e-01  4.73074537e+00  2.05052834e+01
  1.24397046e+02  6.23152942e+02  2.76689827e+03  1.22446061e+04
  4.08640639e+04  1.04906512e+05  2.30089246e+05  4.55903732e+05
  8.44855675e+05  1.52803265e+06  2.85029972e+06  5.80818658e+06]
E1 = -706.6783733220597  E_coul = 198.70084623976712
cycle= 6 E= -507.977527082293  delta_E= -5.51e-12  |g|= 9.37e-08  |ddm|= 4.44e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6783733220597  E_coul = 198.70084623976712
  HOMO = -0.242295000681835  LUMO = 0.994598982439436
  mo_energy =
[-1.20321491e+02 -1.23793582e+01 -6.67723511e+00 -6.67723511e+00
 -6.67723511e+00 -1.17890056e+00 -2.42295001e-01 -2.42295001e-01
 -2.42295001e-01  9.94598982e-01  4.73074533e+00  2.05052833e+01
  1.24397046e+02  6.23152942e+02  2.76689827e+03  1.22446061e+04
  4.08640639e+04  1.04906512e+05  2.30089246e+05  4.55903732e+05
  8.44855675e+05  1.52803265e+06  2.85029972e+06  5.80818658e+06]
E1 = -706.6783731867703  E_coul = 198.70084610447796
Extra cycle  E= -507.977527082292  delta_E= 2.27e-13  |g|= 1.18e-08  |ddm|= 5.99e-07
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 907987.7941862306
E1 = -706.6783731867703  E_coul = 198.70084610447796
init E= -507.977527082292
    CPU time for initialize scf      3.40 sec, wall time      0.22 sec
  HOMO = -0.242295005463772  LUMO = 0.994598983157472
  mo_energy =
[-1.20321491e+02 -1.23793582e+01 -6.67723512e+00 -6.67723512e+00
 -6.67723512e+00 -1.17890057e+00 -2.42295005e-01 -2.42295005e-01
 -2.42295005e-01  9.94598983e-01  4.73074532e+00  2.05052833e+01
  1.24397046e+02  6.23152942e+02  2.76689827e+03  1.22446061e+04
  4.08640639e+04  1.04906512e+05  2.30089246e+05  4.55903732e+05
  8.44855675e+05  1.52803265e+06  2.85029972e+06  5.80818658e+06]
E1 = -706.6783731615478  E_coul = 198.70084607925517
cycle= 1 E= -507.977527082293  delta_E= -3.41e-13  |g|= 2.61e-09  |ddm|= 7.79e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6783731615478  E_coul = 198.70084607925517
  HOMO = -0.242295006270726  LUMO = 0.994598982741468
  mo_energy =
[-1.20321491e+02 -1.23793582e+01 -6.67723512e+00 -6.67723512e+00
 -6.67723512e+00 -1.17890057e+00 -2.42295006e-01 -2.42295006e-01
 -2.42295006e-01  9.94598983e-01  4.73074532e+00  2.05052833e+01
  1.24397046e+02  6.23152942e+02  2.76689827e+03  1.22446061e+04
  4.08640639e+04  1.04906512e+05  2.30089246e+05  4.55903732e+05
  8.44855675e+05  1.52803265e+06  2.85029972e+06  5.80818658e+06]
E1 = -706.6783731569241  E_coul = 198.70084607463187
Extra cycle  E= -507.977527082292  delta_E= 4.55e-13  |g|= 1.39e-09  |ddm|= 1.03e-08
    CPU time for scf_cycle      3.85 sec, wall time      0.38 sec
exp = [2.62201134e-01 7.41615098e-01 1.17616814e+05 1.07772404e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315355e+03 1.83757992e+04
 1.44908338e+03 3.76385858e+02 1.14487836e+02 3.86680195e+01
 8.79071919e+00 3.82262934e+00 8.60284222e+00 4.92743528e-01]
grad_E = [ 2.18933768e-02 -2.85792969e-03  4.41879704e-09 -2.16814459e-03
  2.15599196e-11  1.20456123e-10  6.87290510e-10  2.69802124e-09
  1.12178301e-08  6.00615807e-08  3.79469158e-06  1.31895488e-07
 -3.80678649e-06  5.87027976e-05 -2.96258847e-04 -7.58336519e-05
 -1.01975322e-03 -4.61884437e-04 -1.08555740e-03  5.11540051e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:09:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.270651789172       1
[INPUT] 0    0    [1    /1   ]  0.801834147831       1
[INPUT] 0    0    [1    /1   ]  117616.813865        1
[INPUT] 0    0    [1    /1   ]  1.2053268432         1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031073        1
[INPUT] 0    0    [1    /1   ]  147020.991918        1
[INPUT] 0    0    [1    /1   ]  73510.4200162        1
[INPUT] 0    0    [1    /1   ]  36754.7149016        1
[INPUT] 0    0    [1    /1   ]  7303.15255435        1
[INPUT] 0    0    [1    /1   ]  18375.7992004        1
[INPUT] 0    0    [1    /1   ]  1449.0829834         1
[INPUT] 0    0    [1    /1   ]  376.390726289        1
[INPUT] 0    0    [1    /1   ]  114.430642961        1
[INPUT] 0    0    [1    /1   ]  38.9940185131        1
[INPUT] 0    0    [1    /1   ]  9.12950351064        1
[INPUT] 0    0    [1    /1   ]  4.02923141353        1
[INPUT] 1    0    [1    /1   ]  8.60265949666        1
[INPUT] 1    0    [1    /1   ]  0.49271615721        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.27065178917164356, 1.0]], [0, [0.8018341478305182, 1.0]], [0, [117616.81386518272, 1.0]], [0, [1.205326843204717, 1.0]], [0, [1176168.1426172303, 1.0]], [0, [588084.0699824325, 1.0]], [0, [294042.03107328166, 1.0]], [0, [147020.99191801765, 1.0]], [0, [73510.42001617386, 1.0]], [0, [36754.714901575404, 1.0]], [0, [7303.1525543485095, 1.0]], [0, [18375.799200355872, 1.0]], [0, [1449.0829834019548, 1.0]], [0, [376.39072628915005, 1.0]], [0, [114.43064296078963, 1.0]], [0, [38.994018513116565, 1.0]], [0, [9.129503510640104, 1.0]], [0, [4.029231413533569, 1.0]], [1, [8.602659496659271, 1.0]], [1, [0.49271615720991574, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.27065179]
bas 1, expnt(s) = [0.80183415]
bas 2, expnt(s) = [117616.81386518]
bas 3, expnt(s) = [1.20532684]
bas 4, expnt(s) = [1176168.14261723]
bas 5, expnt(s) = [588084.06998243]
bas 6, expnt(s) = [294042.03107328]
bas 7, expnt(s) = [147020.99191802]
bas 8, expnt(s) = [73510.42001617]
bas 9, expnt(s) = [36754.71490158]
bas 10, expnt(s) = [7303.15255435]
bas 11, expnt(s) = [18375.79920036]
bas 12, expnt(s) = [1449.0829834]
bas 13, expnt(s) = [376.39072629]
bas 14, expnt(s) = [114.43064296]
bas 15, expnt(s) = [38.99401851]
bas 16, expnt(s) = [9.12950351]
bas 17, expnt(s) = [4.02923141]
bas 18, expnt(s) = [8.6026595]
bas 19, expnt(s) = [0.49271616]
CPU time:       319.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.70651789e-01 9.48032446e-01 8.01834148e-01 2.14081153e+00
 1.17616814e+05 1.60460109e+04 1.20532684e+00 2.90632144e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315255e+03 1.99594148e+03 1.83757992e+04 3.98749087e+03
 1.44908298e+03 5.93382818e+02 3.76390726e+02 2.15895808e+02
 1.14430643e+02 8.83937946e+01 3.89940185e+01 3.94242572e+01
 9.12950351e+00 1.32693728e+01 4.02923141e+00 7.18508124e+00
 8.60265950e+00 4.29808806e+01 4.92716157e-01 1.20428811e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335652851352087
cond(S) = 908036.7898988059
E1 = -689.5718616537612  E_coul = 184.96650381102418
init E= -504.605357842737
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672099465596974  LUMO = 0.724023002117795
  mo_energy =
[-1.21706084e+02 -1.33857914e+01 -7.62387176e+00 -7.62387176e+00
 -7.62387176e+00 -1.65749600e+00 -6.72099466e-01 -6.72099466e-01
 -6.72099466e-01  7.24023002e-01  4.71733768e+00  2.14387821e+01
  1.26753639e+02  6.25655421e+02  2.76906223e+03  1.22464556e+04
  4.08657581e+04  1.04908128e+05  2.30090812e+05  4.55905261e+05
  8.44857176e+05  1.52803413e+06  2.85030115e+06  5.80818796e+06]
E1 = -707.7310294307241  E_coul = 199.77065027804744
cycle= 1 E= -507.960379152677  delta_E= -3.36  |g|= 0.451  |ddm|= 0.727
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.66301
diis-c [-0.43958285  1.        ]
  HOMO = -0.217758052171541  LUMO = 1.09305899936707
  mo_energy =
[-1.20196840e+02 -1.23048313e+01 -6.59484576e+00 -6.59484576e+00
 -6.59484576e+00 -1.16324960e+00 -2.17758052e-01 -2.17758052e-01
 -2.17758052e-01  1.09305900e+00  5.31222080e+00  2.24257763e+01
  1.28151624e+02  6.27149028e+02  2.77049553e+03  1.22477801e+04
  4.08670161e+04  1.04909349e+05  2.30092009e+05  4.55906441e+05
  8.44858342e+05  1.52803528e+06  2.85030229e+06  5.80818910e+06]
E1 = -706.7980574499582  E_coul = 198.8202440457987
cycle= 2 E= -507.977813404159  delta_E= -0.0174  |g|= 0.0346  |ddm|= 0.512
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0324841
diis-c [-0.0010501  -0.00342594  1.00342594]
  HOMO = -0.239181441677553  LUMO = 1.08887447286103
  mo_energy =
[-1.20309998e+02 -1.23710675e+01 -6.66831416e+00 -6.66831416e+00
 -6.66831416e+00 -1.17696812e+00 -2.39181442e-01 -2.39181442e-01
 -2.39181442e-01  1.08887447e+00  5.28680530e+00  2.23680239e+01
  1.28056657e+02  6.27031898e+02  2.77036232e+03  1.22476366e+04
  4.08668689e+04  1.04909201e+05  2.30091859e+05  4.55906291e+05
  8.44858192e+05  1.52803513e+06  2.85030214e+06  5.80818895e+06]
E1 = -706.6966755167684  E_coul = 198.71862740242995
cycle= 3 E= -507.978048114338  delta_E= -0.000235  |g|= 0.00408  |ddm|=  0.1
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00370222
diis-c [-2.46167551e-06 -4.63853512e-05 -1.15138688e-01  1.11518507e+00]
  HOMO = -0.242078988551943  LUMO = 1.08810055189946
  mo_energy =
[-1.20321115e+02 -1.23790934e+01 -6.67680969e+00 -6.67680969e+00
 -6.67680969e+00 -1.17871377e+00 -2.42078989e-01 -2.42078989e-01
 -2.42078989e-01  1.08810055e+00  5.28320866e+00  2.23609667e+01
  1.28046708e+02  6.27020638e+02  2.77035029e+03  1.22476242e+04
  4.08668563e+04  1.04909188e+05  2.30091847e+05  4.55906278e+05
  8.44858179e+05  1.52803512e+06  2.85030213e+06  5.80818893e+06]
E1 = -706.6830666233096  E_coul = 198.70501452215916
cycle= 4 E= -507.97805210115  delta_E= -3.99e-06  |g|= 0.000154  |ddm|= 0.0186
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000121518
diis-c [-1.79599180e-10 -8.36740937e-06  6.53650423e-03 -8.03251452e-02
  1.07379701e+00]
  HOMO = -0.242163149570409  LUMO = 1.08806970058665
  mo_energy =
[-1.20321247e+02 -1.23792696e+01 -6.67697443e+00 -6.67697443e+00
 -6.67697443e+00 -1.17876438e+00 -2.42163150e-01 -2.42163150e-01
 -2.42163150e-01  1.08806970e+00  5.28309892e+00  2.23608088e+01
  1.28046563e+02  6.27020509e+02  2.77035017e+03  1.22476240e+04
  4.08668562e+04  1.04909188e+05  2.30091846e+05  4.55906278e+05
  8.44858179e+05  1.52803512e+06  2.85030213e+06  5.80818893e+06]
E1 = -706.6826831465967  E_coul = 198.70463104039987
cycle= 5 E= -507.978052106197  delta_E= -5.05e-09  |g|= 4.28e-06  |ddm|= 0.00101
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.50941e-06
diis-c [-4.64291018e-13  3.27703599e-07 -4.79628592e-04  5.58568918e-03
 -7.75955946e-02  1.07248921e+00]
  HOMO = -0.242164765181652  LUMO = 1.08806915816727
  mo_energy =
[-1.20321250e+02 -1.23792725e+01 -6.67697728e+00 -6.67697728e+00
 -6.67697728e+00 -1.17876554e+00 -2.42164765e-01 -2.42164765e-01
 -2.42164765e-01  1.08806916e+00  5.28309681e+00  2.23608061e+01
  1.28046560e+02  6.27020505e+02  2.77035016e+03  1.22476240e+04
  4.08668562e+04  1.04909188e+05  2.30091846e+05  4.55906278e+05
  8.44858179e+05  1.52803512e+06  2.85030213e+06  5.80818893e+06]
E1 = -706.682675590525  E_coul = 198.70462348432497
cycle= 6 E= -507.9780521062  delta_E= -3.24e-12  |g|= 1.11e-07  |ddm|= 3.08e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.682675590525  E_coul = 198.70462348432497
  HOMO = -0.242164804837941  LUMO = 1.08806913388703
  mo_energy =
[-1.20321250e+02 -1.23792725e+01 -6.67697735e+00 -6.67697735e+00
 -6.67697735e+00 -1.17876556e+00 -2.42164805e-01 -2.42164805e-01
 -2.42164805e-01  1.08806913e+00  5.28309675e+00  2.23608060e+01
  1.28046560e+02  6.27020505e+02  2.77035016e+03  1.22476240e+04
  4.08668562e+04  1.04909188e+05  2.30091846e+05  4.55906278e+05
  8.44858179e+05  1.52803512e+06  2.85030213e+06  5.80818893e+06]
E1 = -706.6826754203872  E_coul = 198.7046233141871
Extra cycle  E= -507.9780521062  delta_E= -1.14e-13  |g|= 1.3e-08  |ddm|= 6.81e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.70651789e-01 8.01834148e-01 1.17616814e+05 1.20532684e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315255e+03 1.83757992e+04
 1.44908298e+03 3.76390726e+02 1.14430643e+02 3.89940185e+01
 9.12950351e+00 4.02923141e+00 8.60265950e+00 4.92716157e-01]
E = -507.97805210620015
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:09:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.270651789172       1
[INPUT] 0    0    [1    /1   ]  0.801834147831       1
[INPUT] 0    0    [1    /1   ]  117616.813865        1
[INPUT] 0    0    [1    /1   ]  1.2053268432         1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031073        1
[INPUT] 0    0    [1    /1   ]  147020.991918        1
[INPUT] 0    0    [1    /1   ]  73510.4200162        1
[INPUT] 0    0    [1    /1   ]  36754.7149016        1
[INPUT] 0    0    [1    /1   ]  7303.15255435        1
[INPUT] 0    0    [1    /1   ]  18375.7992004        1
[INPUT] 0    0    [1    /1   ]  1449.0829834         1
[INPUT] 0    0    [1    /1   ]  376.390726289        1
[INPUT] 0    0    [1    /1   ]  114.430642961        1
[INPUT] 0    0    [1    /1   ]  38.9940185131        1
[INPUT] 0    0    [1    /1   ]  9.12950351064        1
[INPUT] 0    0    [1    /1   ]  4.02923141353        1
[INPUT] 1    0    [1    /1   ]  8.60265949666        1
[INPUT] 1    0    [1    /1   ]  0.49271615721        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.27065178917164356, 1.0]], [0, [0.8018341478305182, 1.0]], [0, [117616.81386518272, 1.0]], [0, [1.205326843204717, 1.0]], [0, [1176168.1426172303, 1.0]], [0, [588084.0699824325, 1.0]], [0, [294042.03107328166, 1.0]], [0, [147020.99191801765, 1.0]], [0, [73510.42001617386, 1.0]], [0, [36754.714901575404, 1.0]], [0, [7303.1525543485095, 1.0]], [0, [18375.799200355872, 1.0]], [0, [1449.0829834019548, 1.0]], [0, [376.39072628915005, 1.0]], [0, [114.43064296078963, 1.0]], [0, [38.994018513116565, 1.0]], [0, [9.129503510640104, 1.0]], [0, [4.029231413533569, 1.0]], [1, [8.602659496659271, 1.0]], [1, [0.49271615720991574, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.27065179]
bas 1, expnt(s) = [0.80183415]
bas 2, expnt(s) = [117616.81386518]
bas 3, expnt(s) = [1.20532684]
bas 4, expnt(s) = [1176168.14261723]
bas 5, expnt(s) = [588084.06998243]
bas 6, expnt(s) = [294042.03107328]
bas 7, expnt(s) = [147020.99191802]
bas 8, expnt(s) = [73510.42001617]
bas 9, expnt(s) = [36754.71490158]
bas 10, expnt(s) = [7303.15255435]
bas 11, expnt(s) = [18375.79920036]
bas 12, expnt(s) = [1449.0829834]
bas 13, expnt(s) = [376.39072629]
bas 14, expnt(s) = [114.43064296]
bas 15, expnt(s) = [38.99401851]
bas 16, expnt(s) = [9.12950351]
bas 17, expnt(s) = [4.02923141]
bas 18, expnt(s) = [8.6026595]
bas 19, expnt(s) = [0.49271616]
CPU time:       321.16
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.70651789e-01 9.48032446e-01 8.01834148e-01 2.14081153e+00
 1.17616814e+05 1.60460109e+04 1.20532684e+00 2.90632144e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656006e+03
 7.30315255e+03 1.99594148e+03 1.83757992e+04 3.98749087e+03
 1.44908298e+03 5.93382818e+02 3.76390726e+02 2.15895808e+02
 1.14430643e+02 8.83937946e+01 3.89940185e+01 3.94242572e+01
 9.12950351e+00 1.32693728e+01 4.02923141e+00 7.18508124e+00
 8.60265950e+00 4.29808806e+01 4.92716157e-01 1.20428811e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335652851352087
cond(S) = 908036.7898988059
E1 = -689.5718616537612  E_coul = 184.96650381102418
init E= -504.605357842737
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672099465596974  LUMO = 0.724023002117795
  mo_energy =
[-1.21706084e+02 -1.33857914e+01 -7.62387176e+00 -7.62387176e+00
 -7.62387176e+00 -1.65749600e+00 -6.72099466e-01 -6.72099466e-01
 -6.72099466e-01  7.24023002e-01  4.71733768e+00  2.14387821e+01
  1.26753639e+02  6.25655421e+02  2.76906223e+03  1.22464556e+04
  4.08657581e+04  1.04908128e+05  2.30090812e+05  4.55905261e+05
  8.44857176e+05  1.52803413e+06  2.85030115e+06  5.80818796e+06]
E1 = -707.7310294307241  E_coul = 199.77065027804744
cycle= 1 E= -507.960379152677  delta_E= -3.36  |g|= 0.451  |ddm|= 0.727
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.66301
diis-c [-0.43958285  1.        ]
  HOMO = -0.217758052171541  LUMO = 1.09305899936707
  mo_energy =
[-1.20196840e+02 -1.23048313e+01 -6.59484576e+00 -6.59484576e+00
 -6.59484576e+00 -1.16324960e+00 -2.17758052e-01 -2.17758052e-01
 -2.17758052e-01  1.09305900e+00  5.31222080e+00  2.24257763e+01
  1.28151624e+02  6.27149028e+02  2.77049553e+03  1.22477801e+04
  4.08670161e+04  1.04909349e+05  2.30092009e+05  4.55906441e+05
  8.44858342e+05  1.52803528e+06  2.85030229e+06  5.80818910e+06]
E1 = -706.7980574499582  E_coul = 198.8202440457987
cycle= 2 E= -507.977813404159  delta_E= -0.0174  |g|= 0.0346  |ddm|= 0.512
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0324841
diis-c [-0.0010501  -0.00342594  1.00342594]
  HOMO = -0.239181441677553  LUMO = 1.08887447286103
  mo_energy =
[-1.20309998e+02 -1.23710675e+01 -6.66831416e+00 -6.66831416e+00
 -6.66831416e+00 -1.17696812e+00 -2.39181442e-01 -2.39181442e-01
 -2.39181442e-01  1.08887447e+00  5.28680530e+00  2.23680239e+01
  1.28056657e+02  6.27031898e+02  2.77036232e+03  1.22476366e+04
  4.08668689e+04  1.04909201e+05  2.30091859e+05  4.55906291e+05
  8.44858192e+05  1.52803513e+06  2.85030214e+06  5.80818895e+06]
E1 = -706.6966755167684  E_coul = 198.71862740242995
cycle= 3 E= -507.978048114338  delta_E= -0.000235  |g|= 0.00408  |ddm|=  0.1
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00370222
diis-c [-2.46167551e-06 -4.63853512e-05 -1.15138688e-01  1.11518507e+00]
  HOMO = -0.242078988551943  LUMO = 1.08810055189946
  mo_energy =
[-1.20321115e+02 -1.23790934e+01 -6.67680969e+00 -6.67680969e+00
 -6.67680969e+00 -1.17871377e+00 -2.42078989e-01 -2.42078989e-01
 -2.42078989e-01  1.08810055e+00  5.28320866e+00  2.23609667e+01
  1.28046708e+02  6.27020638e+02  2.77035029e+03  1.22476242e+04
  4.08668563e+04  1.04909188e+05  2.30091847e+05  4.55906278e+05
  8.44858179e+05  1.52803512e+06  2.85030213e+06  5.80818893e+06]
E1 = -706.6830666233096  E_coul = 198.70501452215916
cycle= 4 E= -507.97805210115  delta_E= -3.99e-06  |g|= 0.000154  |ddm|= 0.0186
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000121518
diis-c [-1.79599180e-10 -8.36740937e-06  6.53650423e-03 -8.03251452e-02
  1.07379701e+00]
  HOMO = -0.242163149570409  LUMO = 1.08806970058665
  mo_energy =
[-1.20321247e+02 -1.23792696e+01 -6.67697443e+00 -6.67697443e+00
 -6.67697443e+00 -1.17876438e+00 -2.42163150e-01 -2.42163150e-01
 -2.42163150e-01  1.08806970e+00  5.28309892e+00  2.23608088e+01
  1.28046563e+02  6.27020509e+02  2.77035017e+03  1.22476240e+04
  4.08668562e+04  1.04909188e+05  2.30091846e+05  4.55906278e+05
  8.44858179e+05  1.52803512e+06  2.85030213e+06  5.80818893e+06]
E1 = -706.6826831465967  E_coul = 198.70463104039987
cycle= 5 E= -507.978052106197  delta_E= -5.05e-09  |g|= 4.28e-06  |ddm|= 0.00101
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.50941e-06
diis-c [-4.64291018e-13  3.27703599e-07 -4.79628592e-04  5.58568918e-03
 -7.75955946e-02  1.07248921e+00]
  HOMO = -0.242164765181652  LUMO = 1.08806915816727
  mo_energy =
[-1.20321250e+02 -1.23792725e+01 -6.67697728e+00 -6.67697728e+00
 -6.67697728e+00 -1.17876554e+00 -2.42164765e-01 -2.42164765e-01
 -2.42164765e-01  1.08806916e+00  5.28309681e+00  2.23608061e+01
  1.28046560e+02  6.27020505e+02  2.77035016e+03  1.22476240e+04
  4.08668562e+04  1.04909188e+05  2.30091846e+05  4.55906278e+05
  8.44858179e+05  1.52803512e+06  2.85030213e+06  5.80818893e+06]
E1 = -706.682675590525  E_coul = 198.70462348432497
cycle= 6 E= -507.9780521062  delta_E= -3.24e-12  |g|= 1.11e-07  |ddm|= 3.08e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.682675590525  E_coul = 198.70462348432497
  HOMO = -0.242164804837941  LUMO = 1.08806913388703
  mo_energy =
[-1.20321250e+02 -1.23792725e+01 -6.67697735e+00 -6.67697735e+00
 -6.67697735e+00 -1.17876556e+00 -2.42164805e-01 -2.42164805e-01
 -2.42164805e-01  1.08806913e+00  5.28309675e+00  2.23608060e+01
  1.28046560e+02  6.27020505e+02  2.77035016e+03  1.22476240e+04
  4.08668562e+04  1.04909188e+05  2.30091846e+05  4.55906278e+05
  8.44858179e+05  1.52803512e+06  2.85030213e+06  5.80818893e+06]
E1 = -706.6826754203872  E_coul = 198.7046233141871
Extra cycle  E= -507.9780521062  delta_E= -1.14e-13  |g|= 1.3e-08  |ddm|= 6.81e-07
    CPU time for scf_cycle      1.08 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908036.7898988059
E1 = -706.6826754203872  E_coul = 198.7046233141871
init E= -507.9780521062
    CPU time for initialize scf      3.36 sec, wall time      0.21 sec
  HOMO = -0.242164810703921  LUMO = 1.08806913072368
  mo_energy =
[-1.20321250e+02 -1.23792726e+01 -6.67697736e+00 -6.67697736e+00
 -6.67697736e+00 -1.17876557e+00 -2.42164811e-01 -2.42164811e-01
 -2.42164811e-01  1.08806913e+00  5.28309674e+00  2.23608060e+01
  1.28046560e+02  6.27020505e+02  2.77035016e+03  1.22476240e+04
  4.08668562e+04  1.04909188e+05  2.30091846e+05  4.55906278e+05
  8.44858179e+05  1.52803512e+06  2.85030213e+06  5.80818893e+06]
E1 = -706.6826753922479  E_coul = 198.70462328604765
cycle= 1 E= -507.9780521062  delta_E= -1.14e-13  |g|= 2.38e-09  |ddm|= 7.99e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6826753922479  E_coul = 198.70462328604765
  HOMO = -0.242164811579269  LUMO = 1.08806913161528
  mo_energy =
[-1.20321250e+02 -1.23792726e+01 -6.67697736e+00 -6.67697736e+00
 -6.67697736e+00 -1.17876557e+00 -2.42164812e-01 -2.42164812e-01
 -2.42164812e-01  1.08806913e+00  5.28309674e+00  2.23608060e+01
  1.28046560e+02  6.27020505e+02  2.77035016e+03  1.22476240e+04
  4.08668562e+04  1.04909188e+05  2.30091846e+05  4.55906278e+05
  8.44858179e+05  1.52803512e+06  2.85030213e+06  5.80818893e+06]
E1 = -706.6826753884117  E_coul = 198.70462328221163
Extra cycle  E= -507.9780521062  delta_E= 2.27e-13  |g|= 1.44e-09  |ddm|= 1.09e-08
    CPU time for scf_cycle      3.81 sec, wall time      0.38 sec
exp = [2.70651789e-01 8.01834148e-01 1.17616814e+05 1.20532684e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315255e+03 1.83757992e+04
 1.44908298e+03 3.76390726e+02 1.14430643e+02 3.89940185e+01
 9.12950351e+00 4.02923141e+00 8.60265950e+00 4.92716157e-01]
grad_E = [ 2.47158432e-02 -2.61948899e-03  4.51571398e-09 -2.31754747e-03
  2.27000258e-11  1.23607755e-10  7.02268767e-10  2.75793789e-09
  1.14705547e-08  6.13035759e-08  3.88220377e-06  1.35717283e-07
 -8.72981818e-06  1.29798638e-04 -7.35131911e-04  7.52847100e-04
 -9.67815077e-04 -3.13389239e-04 -1.12837174e-03  5.05672991e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:09:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.272270746333       1
[INPUT] 0    0    [1    /1   ]  0.871014227121       1
[INPUT] 0    0    [1    /1   ]  117616.813864        1
[INPUT] 0    0    [1    /1   ]  1.34374831918        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031073        1
[INPUT] 0    0    [1    /1   ]  147020.991917        1
[INPUT] 0    0    [1    /1   ]  73510.4200131        1
[INPUT] 0    0    [1    /1   ]  36754.7148853        1
[INPUT] 0    0    [1    /1   ]  7303.15152805        1
[INPUT] 0    0    [1    /1   ]  18375.7991649        1
[INPUT] 0    0    [1    /1   ]  1449.0825885         1
[INPUT] 0    0    [1    /1   ]  376.395485856        1
[INPUT] 0    0    [1    /1   ]  114.37364248         1
[INPUT] 0    0    [1    /1   ]  39.3235004816        1
[INPUT] 0    0    [1    /1   ]  9.47295591087        1
[INPUT] 0    0    [1    /1   ]  4.24788267284        1
[INPUT] 1    0    [1    /1   ]  8.60323699459        1
[INPUT] 1    0    [1    /1   ]  0.492684357763       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2722707463334644, 1.0]], [0, [0.8710142271205125, 1.0]], [0, [117616.81386398595, 1.0]], [0, [1.3437483191797435, 1.0]], [0, [1176168.1426172247, 1.0]], [0, [588084.0699824, 1.0]], [0, [294042.0310730955, 1.0]], [0, [147020.99191728715, 1.0]], [0, [73510.42001313755, 1.0]], [0, [36754.714885287234, 1.0]], [0, [7303.151528045569, 1.0]], [0, [18375.799164896776, 1.0]], [0, [1449.0825884955739, 1.0]], [0, [376.39548585565444, 1.0]], [0, [114.37364248007343, 1.0]], [0, [39.32350048164214, 1.0]], [0, [9.47295591087395, 1.0]], [0, [4.247882672837224, 1.0]], [1, [8.603236994594612, 1.0]], [1, [0.4926843577626657, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.27227075]
bas 1, expnt(s) = [0.87101423]
bas 2, expnt(s) = [117616.81386399]
bas 3, expnt(s) = [1.34374832]
bas 4, expnt(s) = [1176168.14261722]
bas 5, expnt(s) = [588084.0699824]
bas 6, expnt(s) = [294042.0310731]
bas 7, expnt(s) = [147020.99191729]
bas 8, expnt(s) = [73510.42001314]
bas 9, expnt(s) = [36754.71488529]
bas 10, expnt(s) = [7303.15152805]
bas 11, expnt(s) = [18375.7991649]
bas 12, expnt(s) = [1449.0825885]
bas 13, expnt(s) = [376.39548586]
bas 14, expnt(s) = [114.37364248]
bas 15, expnt(s) = [39.32350048]
bas 16, expnt(s) = [9.47295591]
bas 17, expnt(s) = [4.24788267]
bas 18, expnt(s) = [8.60323699]
bas 19, expnt(s) = [0.49268436]
CPU time:       332.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.72270746e-01 9.52282406e-01 8.71014227e-01 2.27789636e+00
 1.17616814e+05 1.60460109e+04 1.34374832e+00 3.15321421e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656005e+03
 7.30315153e+03 1.99594127e+03 1.83757992e+04 3.98749086e+03
 1.44908259e+03 5.93382697e+02 3.76395486e+02 2.15897856e+02
 1.14373642e+02 8.83607693e+01 3.93235005e+01 3.96738322e+01
 9.47295591e+00 1.36420351e+01 4.24788267e+00 7.47557166e+00
 8.60323699e+00 4.29844873e+01 4.92684358e-01 1.20419095e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33573899428064
cond(S) = 908088.2446528191
E1 = -689.5705144013833  E_coul = 184.96751797715825
init E= -504.602996424225
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672118156389781  LUMO = 0.793870472099319
  mo_energy =
[-1.21705786e+02 -1.33858558e+01 -7.62382865e+00 -7.62382865e+00
 -7.62382865e+00 -1.65722071e+00 -6.72118156e-01 -6.72118156e-01
 -6.72118156e-01  7.93870472e-01  5.28280734e+00  2.33819419e+01
  1.30522052e+02  6.29657430e+02  2.77263894e+03  1.22495834e+04
  4.08686522e+04  1.04910902e+05  2.30093507e+05  4.55907900e+05
  8.44859772e+05  1.52803668e+06  2.85030365e+06  5.80819039e+06]
E1 = -707.7198727622126  E_coul = 199.75922939175464
cycle= 1 E= -507.960643370458  delta_E= -3.36  |g|= 0.452  |ddm|= 0.641
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.67157
diis-c [-0.45100639  1.        ]
  HOMO = -0.218309139987847  LUMO = 1.17696192013339
  mo_energy =
[-1.20197376e+02 -1.23057368e+01 -6.59566179e+00 -6.59566179e+00
 -6.59566179e+00 -1.16358787e+00 -2.18309140e-01 -2.18309140e-01
 -2.18309140e-01  1.17696192e+00  5.90263039e+00  2.43851081e+01
  1.31919848e+02  6.31149998e+02  2.77407129e+03  1.22509070e+04
  4.08699093e+04  1.04912122e+05  2.30094704e+05  4.55909079e+05
  8.44860937e+05  1.52803784e+06  2.85030480e+06  5.80819153e+06]
E1 = -706.7853198660952  E_coul = 198.80716998452885
cycle= 2 E= -507.978149881566  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.594
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0324494
diis-c [-0.00104643 -0.00382422  1.00382422]
  HOMO = -0.239774378716667  LUMO = 1.17210413380794
  mo_energy =
[-1.20310760e+02 -1.23721272e+01 -6.66929604e+00 -6.66929604e+00
 -6.66929604e+00 -1.17731790e+00 -2.39774379e-01 -2.39774379e-01
 -2.39774379e-01  1.17210413e+00  5.87482825e+00  2.43256979e+01
  1.31824492e+02  6.31032663e+02  2.77393783e+03  1.22507634e+04
  4.08697619e+04  1.04911973e+05  2.30094554e+05  4.55908929e+05
  8.44860787e+05  1.52803768e+06  2.85030464e+06  5.80819138e+06]
E1 = -706.6848416753003  E_coul = 198.70646148440096
cycle= 3 E= -507.978380190899  delta_E= -0.00023  |g|= 0.00401  |ddm|= 0.106
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00360438
diis-c [-2.48370041e-06  3.03581625e-05 -1.11212198e-01  1.11118184e+00]
  HOMO = -0.242611123706605  LUMO = 1.17125234331702
  mo_energy =
[-1.20321704e+02 -1.23800221e+01 -6.67765484e+00 -6.67765484e+00
 -6.67765484e+00 -1.17902241e+00 -2.42611124e-01 -2.42611124e-01
 -2.42611124e-01  1.17125234e+00  5.87102413e+00  2.43186202e+01
  1.31814688e+02  6.31021581e+02  2.77392599e+03  1.22507511e+04
  4.08697494e+04  1.04911961e+05  2.30094541e+05  4.55908916e+05
  8.44860774e+05  1.52803767e+06  2.85030463e+06  5.80819137e+06]
E1 = -706.6716818526149  E_coul = 198.69329794056523
cycle= 4 E= -507.97838391205  delta_E= -3.72e-06  |g|= 0.000148  |ddm|= 0.0182
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122489
diis-c [-1.29204829e-10 -7.39180105e-06  6.31500535e-03 -8.08431443e-02
  1.07453553e+00]
  HOMO = -0.242696208252018  LUMO = 1.17121927779088
  mo_energy =
[-1.20321856e+02 -1.23802082e+01 -6.67783114e+00 -6.67783114e+00
 -6.67783114e+00 -1.17907339e+00 -2.42696208e-01 -2.42696208e-01
 -2.42696208e-01  1.17121928e+00  5.87090689e+00  2.43184533e+01
  1.31814527e+02  6.31021431e+02  2.77392585e+03  1.22507509e+04
  4.08697493e+04  1.04911961e+05  2.30094541e+05  4.55908916e+05
  8.44860774e+05  1.52803767e+06  2.85030463e+06  5.80819137e+06]
E1 = -706.6713001966474  E_coul = 198.69291628006158
cycle= 5 E= -507.978383916586  delta_E= -4.54e-09  |g|= 3.2e-06  |ddm|= 0.000906
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.12577e-06
diis-c [-3.12650393e-13  2.37757548e-07 -3.46875244e-04  4.18134158e-03
 -5.76500301e-02  1.05381533e+00]
  HOMO = -0.242697475132113  LUMO = 1.17121884188999
  mo_energy =
[-1.20321858e+02 -1.23802105e+01 -6.67783349e+00 -6.67783349e+00
 -6.67783349e+00 -1.17907431e+00 -2.42697475e-01 -2.42697475e-01
 -2.42697475e-01  1.17121884e+00  5.87090516e+00  2.43184511e+01
  1.31814524e+02  6.31021428e+02  2.77392584e+03  1.22507509e+04
  4.08697493e+04  1.04911961e+05  2.30094541e+05  4.55908916e+05
  8.44860774e+05  1.52803767e+06  2.85030463e+06  5.80819137e+06]
E1 = -706.6712944449108  E_coul = 198.69291052832384
cycle= 6 E= -507.978383916587  delta_E= -1.14e-12  |g|= 1.18e-07  |ddm|= 2.12e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6712944449108  E_coul = 198.69291052832384
  HOMO = -0.242697518380501  LUMO = 1.17121881724014
  mo_energy =
[-1.20321859e+02 -1.23802106e+01 -6.67783356e+00 -6.67783356e+00
 -6.67783356e+00 -1.17907434e+00 -2.42697518e-01 -2.42697518e-01
 -2.42697518e-01  1.17121882e+00  5.87090510e+00  2.43184511e+01
  1.31814524e+02  6.31021428e+02  2.77392584e+03  1.22507509e+04
  4.08697493e+04  1.04911961e+05  2.30094541e+05  4.55908916e+05
  8.44860774e+05  1.52803767e+06  2.85030463e+06  5.80819137e+06]
E1 = -706.671294256922  E_coul = 198.69291034033517
Extra cycle  E= -507.978383916587  delta_E= 1.14e-13  |g|= 1.28e-08  |ddm|= 6.96e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.72270746e-01 8.71014227e-01 1.17616814e+05 1.34374832e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315153e+03 1.83757992e+04
 1.44908259e+03 3.76395486e+02 1.14373642e+02 3.93235005e+01
 9.47295591e+00 4.24788267e+00 8.60323699e+00 4.92684358e-01]
E = -507.97838391658684
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:09:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.272270746333       1
[INPUT] 0    0    [1    /1   ]  0.871014227121       1
[INPUT] 0    0    [1    /1   ]  117616.813864        1
[INPUT] 0    0    [1    /1   ]  1.34374831918        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031073        1
[INPUT] 0    0    [1    /1   ]  147020.991917        1
[INPUT] 0    0    [1    /1   ]  73510.4200131        1
[INPUT] 0    0    [1    /1   ]  36754.7148853        1
[INPUT] 0    0    [1    /1   ]  7303.15152805        1
[INPUT] 0    0    [1    /1   ]  18375.7991649        1
[INPUT] 0    0    [1    /1   ]  1449.0825885         1
[INPUT] 0    0    [1    /1   ]  376.395485856        1
[INPUT] 0    0    [1    /1   ]  114.37364248         1
[INPUT] 0    0    [1    /1   ]  39.3235004816        1
[INPUT] 0    0    [1    /1   ]  9.47295591087        1
[INPUT] 0    0    [1    /1   ]  4.24788267284        1
[INPUT] 1    0    [1    /1   ]  8.60323699459        1
[INPUT] 1    0    [1    /1   ]  0.492684357763       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2722707463334644, 1.0]], [0, [0.8710142271205125, 1.0]], [0, [117616.81386398595, 1.0]], [0, [1.3437483191797435, 1.0]], [0, [1176168.1426172247, 1.0]], [0, [588084.0699824, 1.0]], [0, [294042.0310730955, 1.0]], [0, [147020.99191728715, 1.0]], [0, [73510.42001313755, 1.0]], [0, [36754.714885287234, 1.0]], [0, [7303.151528045569, 1.0]], [0, [18375.799164896776, 1.0]], [0, [1449.0825884955739, 1.0]], [0, [376.39548585565444, 1.0]], [0, [114.37364248007343, 1.0]], [0, [39.32350048164214, 1.0]], [0, [9.47295591087395, 1.0]], [0, [4.247882672837224, 1.0]], [1, [8.603236994594612, 1.0]], [1, [0.4926843577626657, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.27227075]
bas 1, expnt(s) = [0.87101423]
bas 2, expnt(s) = [117616.81386399]
bas 3, expnt(s) = [1.34374832]
bas 4, expnt(s) = [1176168.14261722]
bas 5, expnt(s) = [588084.0699824]
bas 6, expnt(s) = [294042.0310731]
bas 7, expnt(s) = [147020.99191729]
bas 8, expnt(s) = [73510.42001314]
bas 9, expnt(s) = [36754.71488529]
bas 10, expnt(s) = [7303.15152805]
bas 11, expnt(s) = [18375.7991649]
bas 12, expnt(s) = [1449.0825885]
bas 13, expnt(s) = [376.39548586]
bas 14, expnt(s) = [114.37364248]
bas 15, expnt(s) = [39.32350048]
bas 16, expnt(s) = [9.47295591]
bas 17, expnt(s) = [4.24788267]
bas 18, expnt(s) = [8.60323699]
bas 19, expnt(s) = [0.49268436]
CPU time:       333.99
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.72270746e-01 9.52282406e-01 8.71014227e-01 2.27789636e+00
 1.17616814e+05 1.60460109e+04 1.34374832e+00 3.15321421e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656005e+03
 7.30315153e+03 1.99594127e+03 1.83757992e+04 3.98749086e+03
 1.44908259e+03 5.93382697e+02 3.76395486e+02 2.15897856e+02
 1.14373642e+02 8.83607693e+01 3.93235005e+01 3.96738322e+01
 9.47295591e+00 1.36420351e+01 4.24788267e+00 7.47557166e+00
 8.60323699e+00 4.29844873e+01 4.92684358e-01 1.20419095e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33573899428064
cond(S) = 908088.2446528191
E1 = -689.5705144013833  E_coul = 184.96751797715825
init E= -504.602996424225
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672118156389781  LUMO = 0.793870472099319
  mo_energy =
[-1.21705786e+02 -1.33858558e+01 -7.62382865e+00 -7.62382865e+00
 -7.62382865e+00 -1.65722071e+00 -6.72118156e-01 -6.72118156e-01
 -6.72118156e-01  7.93870472e-01  5.28280734e+00  2.33819419e+01
  1.30522052e+02  6.29657430e+02  2.77263894e+03  1.22495834e+04
  4.08686522e+04  1.04910902e+05  2.30093507e+05  4.55907900e+05
  8.44859772e+05  1.52803668e+06  2.85030365e+06  5.80819039e+06]
E1 = -707.7198727622126  E_coul = 199.75922939175464
cycle= 1 E= -507.960643370458  delta_E= -3.36  |g|= 0.452  |ddm|= 0.641
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.67157
diis-c [-0.45100639  1.        ]
  HOMO = -0.218309139987847  LUMO = 1.17696192013339
  mo_energy =
[-1.20197376e+02 -1.23057368e+01 -6.59566179e+00 -6.59566179e+00
 -6.59566179e+00 -1.16358787e+00 -2.18309140e-01 -2.18309140e-01
 -2.18309140e-01  1.17696192e+00  5.90263039e+00  2.43851081e+01
  1.31919848e+02  6.31149998e+02  2.77407129e+03  1.22509070e+04
  4.08699093e+04  1.04912122e+05  2.30094704e+05  4.55909079e+05
  8.44860937e+05  1.52803784e+06  2.85030480e+06  5.80819153e+06]
E1 = -706.7853198660952  E_coul = 198.80716998452885
cycle= 2 E= -507.978149881566  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.594
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0324494
diis-c [-0.00104643 -0.00382422  1.00382422]
  HOMO = -0.239774378716667  LUMO = 1.17210413380794
  mo_energy =
[-1.20310760e+02 -1.23721272e+01 -6.66929604e+00 -6.66929604e+00
 -6.66929604e+00 -1.17731790e+00 -2.39774379e-01 -2.39774379e-01
 -2.39774379e-01  1.17210413e+00  5.87482825e+00  2.43256979e+01
  1.31824492e+02  6.31032663e+02  2.77393783e+03  1.22507634e+04
  4.08697619e+04  1.04911973e+05  2.30094554e+05  4.55908929e+05
  8.44860787e+05  1.52803768e+06  2.85030464e+06  5.80819138e+06]
E1 = -706.6848416753003  E_coul = 198.70646148440096
cycle= 3 E= -507.978380190899  delta_E= -0.00023  |g|= 0.00401  |ddm|= 0.106
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00360438
diis-c [-2.48370041e-06  3.03581625e-05 -1.11212198e-01  1.11118184e+00]
  HOMO = -0.242611123706605  LUMO = 1.17125234331702
  mo_energy =
[-1.20321704e+02 -1.23800221e+01 -6.67765484e+00 -6.67765484e+00
 -6.67765484e+00 -1.17902241e+00 -2.42611124e-01 -2.42611124e-01
 -2.42611124e-01  1.17125234e+00  5.87102413e+00  2.43186202e+01
  1.31814688e+02  6.31021581e+02  2.77392599e+03  1.22507511e+04
  4.08697494e+04  1.04911961e+05  2.30094541e+05  4.55908916e+05
  8.44860774e+05  1.52803767e+06  2.85030463e+06  5.80819137e+06]
E1 = -706.6716818526149  E_coul = 198.69329794056523
cycle= 4 E= -507.97838391205  delta_E= -3.72e-06  |g|= 0.000148  |ddm|= 0.0182
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122489
diis-c [-1.29204829e-10 -7.39180105e-06  6.31500535e-03 -8.08431443e-02
  1.07453553e+00]
  HOMO = -0.242696208252018  LUMO = 1.17121927779088
  mo_energy =
[-1.20321856e+02 -1.23802082e+01 -6.67783114e+00 -6.67783114e+00
 -6.67783114e+00 -1.17907339e+00 -2.42696208e-01 -2.42696208e-01
 -2.42696208e-01  1.17121928e+00  5.87090689e+00  2.43184533e+01
  1.31814527e+02  6.31021431e+02  2.77392585e+03  1.22507509e+04
  4.08697493e+04  1.04911961e+05  2.30094541e+05  4.55908916e+05
  8.44860774e+05  1.52803767e+06  2.85030463e+06  5.80819137e+06]
E1 = -706.6713001966474  E_coul = 198.69291628006158
cycle= 5 E= -507.978383916586  delta_E= -4.54e-09  |g|= 3.2e-06  |ddm|= 0.000906
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.12577e-06
diis-c [-3.12650393e-13  2.37757548e-07 -3.46875244e-04  4.18134158e-03
 -5.76500301e-02  1.05381533e+00]
  HOMO = -0.242697475132113  LUMO = 1.17121884188999
  mo_energy =
[-1.20321858e+02 -1.23802105e+01 -6.67783349e+00 -6.67783349e+00
 -6.67783349e+00 -1.17907431e+00 -2.42697475e-01 -2.42697475e-01
 -2.42697475e-01  1.17121884e+00  5.87090516e+00  2.43184511e+01
  1.31814524e+02  6.31021428e+02  2.77392584e+03  1.22507509e+04
  4.08697493e+04  1.04911961e+05  2.30094541e+05  4.55908916e+05
  8.44860774e+05  1.52803767e+06  2.85030463e+06  5.80819137e+06]
E1 = -706.6712944449108  E_coul = 198.69291052832384
cycle= 6 E= -507.978383916587  delta_E= -1.14e-12  |g|= 1.18e-07  |ddm|= 2.12e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6712944449108  E_coul = 198.69291052832384
  HOMO = -0.242697518380501  LUMO = 1.17121881724014
  mo_energy =
[-1.20321859e+02 -1.23802106e+01 -6.67783356e+00 -6.67783356e+00
 -6.67783356e+00 -1.17907434e+00 -2.42697518e-01 -2.42697518e-01
 -2.42697518e-01  1.17121882e+00  5.87090510e+00  2.43184511e+01
  1.31814524e+02  6.31021428e+02  2.77392584e+03  1.22507509e+04
  4.08697493e+04  1.04911961e+05  2.30094541e+05  4.55908916e+05
  8.44860774e+05  1.52803767e+06  2.85030463e+06  5.80819137e+06]
E1 = -706.671294256922  E_coul = 198.69291034033517
Extra cycle  E= -507.978383916587  delta_E= 1.14e-13  |g|= 1.28e-08  |ddm|= 6.96e-07
    CPU time for scf_cycle      1.08 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908088.2446528191
E1 = -706.671294256922  E_coul = 198.69291034033517
init E= -507.978383916587
    CPU time for initialize scf      3.30 sec, wall time      0.21 sec
  HOMO = -0.242697524703238  LUMO = 1.17121881287306
  mo_energy =
[-1.20321859e+02 -1.23802106e+01 -6.67783358e+00 -6.67783358e+00
 -6.67783358e+00 -1.17907434e+00 -2.42697525e-01 -2.42697525e-01
 -2.42697525e-01  1.17121881e+00  5.87090509e+00  2.43184511e+01
  1.31814524e+02  6.31021428e+02  2.77392584e+03  1.22507509e+04
  4.08697493e+04  1.04911961e+05  2.30094541e+05  4.55908916e+05
  8.44860774e+05  1.52803767e+06  2.85030463e+06  5.80819137e+06]
E1 = -706.6712942294417  E_coul = 198.6929103128548
cycle= 1 E= -507.978383916587  delta_E= -1.14e-13  |g|= 2.17e-09  |ddm|= 7.53e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6712942294417  E_coul = 198.6929103128548
  HOMO = -0.242697525554346  LUMO = 1.17121881384298
  mo_energy =
[-1.20321859e+02 -1.23802106e+01 -6.67783358e+00 -6.67783358e+00
 -6.67783358e+00 -1.17907434e+00 -2.42697526e-01 -2.42697526e-01
 -2.42697526e-01  1.17121881e+00  5.87090509e+00  2.43184510e+01
  1.31814524e+02  6.31021428e+02  2.77392584e+03  1.22507509e+04
  4.08697493e+04  1.04911961e+05  2.30094541e+05  4.55908916e+05
  8.44860774e+05  1.52803767e+06  2.85030463e+06  5.80819137e+06]
E1 = -706.6712942257467  E_coul = 198.6929103091593
Extra cycle  E= -507.978383916587  delta_E= -4.55e-13  |g|= 1.39e-09  |ddm|= 9.46e-09
    CPU time for scf_cycle      3.75 sec, wall time      0.38 sec
exp = [2.72270746e-01 8.71014227e-01 1.17616814e+05 1.34374832e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315153e+03 1.83757992e+04
 1.44908259e+03 3.76395486e+02 1.14373642e+02 3.93235005e+01
 9.47295591e+00 4.24788267e+00 8.60323699e+00 4.92684358e-01]
grad_E = [ 3.48447667e-03  5.26492283e-04  4.60819149e-09 -1.48996553e-03
  2.37844879e-11  1.26617329e-10  7.16552325e-10  2.81511846e-09
  1.17117991e-08  6.24875081e-08  3.96515873e-06  1.39378362e-07
 -1.33517956e-05  1.96627322e-04 -1.12989468e-03  1.44686606e-03
 -9.39347451e-04 -6.18127809e-04 -6.15822304e-04  2.02634442e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:09:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.27385201792        1
[INPUT] 0    0    [1    /1   ]  0.892809708474       1
[INPUT] 0    0    [1    /1   ]  117616.813864        1
[INPUT] 0    0    [1    /1   ]  1.37238060311        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031073        1
[INPUT] 0    0    [1    /1   ]  147020.991917        1
[INPUT] 0    0    [1    /1   ]  73510.4200127        1
[INPUT] 0    0    [1    /1   ]  36754.7148829        1
[INPUT] 0    0    [1    /1   ]  7303.15137756        1
[INPUT] 0    0    [1    /1   ]  18375.7991597        1
[INPUT] 0    0    [1    /1   ]  1449.08254899        1
[INPUT] 0    0    [1    /1   ]  376.395905629        1
[INPUT] 0    0    [1    /1   ]  114.367357929        1
[INPUT] 0    0    [1    /1   ]  39.3648980416        1
[INPUT] 0    0    [1    /1   ]  9.51768574103        1
[INPUT] 0    0    [1    /1   ]  4.28477671826        1
[INPUT] 1    0    [1    /1   ]  8.60378825286        1
[INPUT] 1    0    [1    /1   ]  0.492660226279       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.27385201791979247, 1.0]], [0, [0.8928097084739895, 1.0]], [0, [117616.8138638105, 1.0]], [0, [1.3723806031103456, 1.0]], [0, [1176168.1426172238, 1.0]], [0, [588084.0699823953, 1.0]], [0, [294042.0310730682, 1.0]], [0, [147020.99191718004, 1.0]], [0, [73510.42001269238, 1.0]], [0, [36754.71488289951, 1.0]], [0, [7303.151377562462, 1.0]], [0, [18375.79915969472, 1.0]], [0, [1449.0825489896436, 1.0]], [0, [376.3959056293841, 1.0]], [0, [114.36735792892739, 1.0]], [0, [39.36489804157055, 1.0]], [0, [9.517685741033704, 1.0]], [0, [4.284776718261486, 1.0]], [1, [8.60378825286363, 1.0]], [1, [0.49266022627874173, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.27385202]
bas 1, expnt(s) = [0.89280971]
bas 2, expnt(s) = [117616.81386381]
bas 3, expnt(s) = [1.3723806]
bas 4, expnt(s) = [1176168.14261722]
bas 5, expnt(s) = [588084.0699824]
bas 6, expnt(s) = [294042.03107307]
bas 7, expnt(s) = [147020.99191718]
bas 8, expnt(s) = [73510.42001269]
bas 9, expnt(s) = [36754.7148829]
bas 10, expnt(s) = [7303.15137756]
bas 11, expnt(s) = [18375.79915969]
bas 12, expnt(s) = [1449.08254899]
bas 13, expnt(s) = [376.39590563]
bas 14, expnt(s) = [114.36735793]
bas 15, expnt(s) = [39.36489804]
bas 16, expnt(s) = [9.51768574]
bas 17, expnt(s) = [4.28477672]
bas 18, expnt(s) = [8.60378825]
bas 19, expnt(s) = [0.49266023]
CPU time:       345.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.73852018e-01 9.56427343e-01 8.92809708e-01 2.32051405e+00
 1.17616814e+05 1.60460109e+04 1.37238060e+00 3.20347215e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656005e+03
 7.30315138e+03 1.99594124e+03 1.83757992e+04 3.98749086e+03
 1.44908255e+03 5.93382684e+02 3.76395906e+02 2.15898036e+02
 1.14367358e+02 8.83571279e+01 3.93648980e+01 3.97051529e+01
 9.51768574e+00 1.36903183e+01 4.28477672e+00 7.52421455e+00
 8.60378825e+00 4.29879301e+01 4.92660226e-01 1.20411723e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335752692076582
cond(S) = 908097.5606833624
E1 = -689.5717723516364  E_coul = 184.96911744289847
init E= -504.602654908738
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672148137623248  LUMO = 0.816190148644224
  mo_energy =
[-1.21705358e+02 -1.33857668e+01 -7.62371462e+00 -7.62371462e+00
 -7.62371462e+00 -1.65713778e+00 -6.72148138e-01 -6.72148138e-01
 -6.72148138e-01  8.16190149e-01  5.42662289e+00  2.37681066e+01
  1.31152225e+02  6.30298819e+02  2.77320887e+03  1.22500814e+04
  4.08691129e+04  1.04911343e+05  2.30093937e+05  4.55908320e+05
  8.44860185e+05  1.52803709e+06  2.85030405e+06  5.80819078e+06]
E1 = -707.7178383622651  E_coul = 199.75717619790817
cycle= 1 E= -507.960662164357  delta_E= -3.36  |g|= 0.452  |ddm|= 0.635
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.673327
diis-c [-0.45336982  1.        ]
  HOMO = -0.21849201286774  LUMO = 1.2032048877819
  mo_energy =
[-1.20197237e+02 -1.23058911e+01 -6.59579237e+00 -6.59579237e+00
 -6.59579237e+00 -1.16367055e+00 -2.18492013e-01 -2.18492013e-01
 -2.18492013e-01  1.20320489e+00  6.05164205e+00  2.47734841e+01
  1.32549741e+02  6.31791041e+02  2.77464088e+03  1.22514046e+04
  4.08703696e+04  1.04912563e+05  2.30095132e+05  4.55909499e+05
  8.44861350e+05  1.52803824e+06  2.85030519e+06  5.80819192e+06]
E1 = -706.783920309823  E_coul = 198.80575309682897
cycle= 2 E= -507.978167212994  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.626
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0323542
diis-c [-0.00104008 -0.0038688   1.0038688 ]
  HOMO = -0.239928881725271  LUMO = 1.19817170424022
  mo_energy =
[-1.20310584e+02 -1.23722412e+01 -6.66938815e+00 -6.66938815e+00
 -6.66938815e+00 -1.17737613e+00 -2.39928882e-01 -2.39928882e-01
 -2.39928882e-01  1.19817170e+00  6.02335980e+00  2.47138706e+01
  1.32454401e+02  6.31673747e+02  2.77450746e+03  1.22512610e+04
  4.08702222e+04  1.04912414e+05  2.30094983e+05  4.55909349e+05
  8.44861200e+05  1.52803809e+06  2.85030504e+06  5.80819177e+06]
E1 = -706.6839253844527  E_coul = 198.7055298570385
cycle= 3 E= -507.978395527414  delta_E= -0.000228  |g|= 0.00399  |ddm|= 0.109
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00356699
diis-c [-2.47433284e-06  4.97280917e-05 -1.10095630e-01  1.11004590e+00]
  HOMO = -0.24274173879025  LUMO = 1.19730220286592
  mo_energy =
[-1.20321466e+02 -1.23800856e+01 -6.67769498e+00 -6.67769498e+00
 -6.67769498e+00 -1.17906493e+00 -2.42741739e-01 -2.42741739e-01
 -2.42741739e-01  1.19730220e+00  6.01952592e+00  2.47068178e+01
  1.32444654e+02  6.31662728e+02  2.77449568e+03  1.22512488e+04
  4.08702098e+04  1.04912402e+05  2.30094970e+05  4.55909336e+05
  8.44861187e+05  1.52803808e+06  2.85030503e+06  5.80819176e+06]
E1 = -706.6709245883131  E_coul = 198.69252542570757
cycle= 4 E= -507.978399162606  delta_E= -3.64e-06  |g|= 0.000146  |ddm|= 0.0185
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122397
diis-c [-1.18167137e-10 -7.12676905e-06  6.25781375e-03 -8.10137542e-02
  1.07476307e+00]
  HOMO = -0.242826732354619  LUMO = 1.19726866464705
  mo_energy =
[-1.20321622e+02 -1.23802736e+01 -6.67787368e+00 -6.67787368e+00
 -6.67787368e+00 -1.17911582e+00 -2.42826732e-01 -2.42826732e-01
 -2.42826732e-01  1.19726866e+00  6.01940739e+00  2.47066492e+01
  1.32444489e+02  6.31662574e+02  2.77449553e+03  1.22512486e+04
  4.08702097e+04  1.04912402e+05  2.30094970e+05  4.55909336e+05
  8.44861187e+05  1.52803808e+06  2.85030503e+06  5.80819176e+06]
E1 = -706.6705449868183  E_coul = 198.69214581981927
cycle= 5 E= -507.978399166999  delta_E= -4.39e-09  |g|= 2.94e-06  |ddm|= 0.000905
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.02933e-06
diis-c [-2.71709115e-13  2.19395354e-07 -3.12107714e-04  3.79451354e-03
 -5.22104745e-02  1.04872785e+00]
  HOMO = -0.242827906107871  LUMO = 1.19726825603071
  mo_energy =
[-1.20321625e+02 -1.23802758e+01 -6.67787588e+00 -6.67787588e+00
 -6.67787588e+00 -1.17911668e+00 -2.42827906e-01 -2.42827906e-01
 -2.42827906e-01  1.19726826e+00  6.01940578e+00  2.47066471e+01
  1.32444486e+02  6.31662571e+02  2.77449553e+03  1.22512486e+04
  4.08702097e+04  1.04912402e+05  2.30094970e+05  4.55909336e+05
  8.44861187e+05  1.52803808e+06  2.85030503e+06  5.80819176e+06]
E1 = -706.670539707681  E_coul = 198.69214054068036
cycle= 6 E= -507.978399167001  delta_E= -1.59e-12  |g|= 1.18e-07  |ddm|= 1.97e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.670539707681  E_coul = 198.69214054068036
  HOMO = -0.242827949433331  LUMO = 1.19726823164781
  mo_energy =
[-1.20321625e+02 -1.23802759e+01 -6.67787595e+00 -6.67787595e+00
 -6.67787595e+00 -1.17911670e+00 -2.42827949e-01 -2.42827949e-01
 -2.42827949e-01  1.19726823e+00  6.01940572e+00  2.47066470e+01
  1.32444486e+02  6.31662571e+02  2.77449553e+03  1.22512486e+04
  4.08702097e+04  1.04912402e+05  2.30094970e+05  4.55909336e+05
  8.44861187e+05  1.52803808e+06  2.85030503e+06  5.80819176e+06]
E1 = -706.6705395204234  E_coul = 198.69214035342293
Extra cycle  E= -507.978399167  delta_E= 1.14e-13  |g|= 1.31e-08  |ddm|= 7.05e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.73852018e-01 8.92809708e-01 1.17616814e+05 1.37238060e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315138e+03 1.83757992e+04
 1.44908255e+03 3.76395906e+02 1.14367358e+02 3.93648980e+01
 9.51768574e+00 4.28477672e+00 8.60378825e+00 4.92660226e-01]
E = -507.9783991670005
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:09:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.27385201792        1
[INPUT] 0    0    [1    /1   ]  0.892809708474       1
[INPUT] 0    0    [1    /1   ]  117616.813864        1
[INPUT] 0    0    [1    /1   ]  1.37238060311        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031073        1
[INPUT] 0    0    [1    /1   ]  147020.991917        1
[INPUT] 0    0    [1    /1   ]  73510.4200127        1
[INPUT] 0    0    [1    /1   ]  36754.7148829        1
[INPUT] 0    0    [1    /1   ]  7303.15137756        1
[INPUT] 0    0    [1    /1   ]  18375.7991597        1
[INPUT] 0    0    [1    /1   ]  1449.08254899        1
[INPUT] 0    0    [1    /1   ]  376.395905629        1
[INPUT] 0    0    [1    /1   ]  114.367357929        1
[INPUT] 0    0    [1    /1   ]  39.3648980416        1
[INPUT] 0    0    [1    /1   ]  9.51768574103        1
[INPUT] 0    0    [1    /1   ]  4.28477671826        1
[INPUT] 1    0    [1    /1   ]  8.60378825286        1
[INPUT] 1    0    [1    /1   ]  0.492660226279       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.27385201791979247, 1.0]], [0, [0.8928097084739895, 1.0]], [0, [117616.8138638105, 1.0]], [0, [1.3723806031103456, 1.0]], [0, [1176168.1426172238, 1.0]], [0, [588084.0699823953, 1.0]], [0, [294042.0310730682, 1.0]], [0, [147020.99191718004, 1.0]], [0, [73510.42001269238, 1.0]], [0, [36754.71488289951, 1.0]], [0, [7303.151377562462, 1.0]], [0, [18375.79915969472, 1.0]], [0, [1449.0825489896436, 1.0]], [0, [376.3959056293841, 1.0]], [0, [114.36735792892739, 1.0]], [0, [39.36489804157055, 1.0]], [0, [9.517685741033704, 1.0]], [0, [4.284776718261486, 1.0]], [1, [8.60378825286363, 1.0]], [1, [0.49266022627874173, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.27385202]
bas 1, expnt(s) = [0.89280971]
bas 2, expnt(s) = [117616.81386381]
bas 3, expnt(s) = [1.3723806]
bas 4, expnt(s) = [1176168.14261722]
bas 5, expnt(s) = [588084.0699824]
bas 6, expnt(s) = [294042.03107307]
bas 7, expnt(s) = [147020.99191718]
bas 8, expnt(s) = [73510.42001269]
bas 9, expnt(s) = [36754.7148829]
bas 10, expnt(s) = [7303.15137756]
bas 11, expnt(s) = [18375.79915969]
bas 12, expnt(s) = [1449.08254899]
bas 13, expnt(s) = [376.39590563]
bas 14, expnt(s) = [114.36735793]
bas 15, expnt(s) = [39.36489804]
bas 16, expnt(s) = [9.51768574]
bas 17, expnt(s) = [4.28477672]
bas 18, expnt(s) = [8.60378825]
bas 19, expnt(s) = [0.49266023]
CPU time:       346.81
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.73852018e-01 9.56427343e-01 8.92809708e-01 2.32051405e+00
 1.17616814e+05 1.60460109e+04 1.37238060e+00 3.20347215e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656005e+03
 7.30315138e+03 1.99594124e+03 1.83757992e+04 3.98749086e+03
 1.44908255e+03 5.93382684e+02 3.76395906e+02 2.15898036e+02
 1.14367358e+02 8.83571279e+01 3.93648980e+01 3.97051529e+01
 9.51768574e+00 1.36903183e+01 4.28477672e+00 7.52421455e+00
 8.60378825e+00 4.29879301e+01 4.92660226e-01 1.20411723e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335752692076582
cond(S) = 908097.5606833624
E1 = -689.5717723516364  E_coul = 184.96911744289847
init E= -504.602654908738
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672148137623248  LUMO = 0.816190148644224
  mo_energy =
[-1.21705358e+02 -1.33857668e+01 -7.62371462e+00 -7.62371462e+00
 -7.62371462e+00 -1.65713778e+00 -6.72148138e-01 -6.72148138e-01
 -6.72148138e-01  8.16190149e-01  5.42662289e+00  2.37681066e+01
  1.31152225e+02  6.30298819e+02  2.77320887e+03  1.22500814e+04
  4.08691129e+04  1.04911343e+05  2.30093937e+05  4.55908320e+05
  8.44860185e+05  1.52803709e+06  2.85030405e+06  5.80819078e+06]
E1 = -707.7178383622651  E_coul = 199.75717619790817
cycle= 1 E= -507.960662164357  delta_E= -3.36  |g|= 0.452  |ddm|= 0.635
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.673327
diis-c [-0.45336982  1.        ]
  HOMO = -0.21849201286774  LUMO = 1.2032048877819
  mo_energy =
[-1.20197237e+02 -1.23058911e+01 -6.59579237e+00 -6.59579237e+00
 -6.59579237e+00 -1.16367055e+00 -2.18492013e-01 -2.18492013e-01
 -2.18492013e-01  1.20320489e+00  6.05164205e+00  2.47734841e+01
  1.32549741e+02  6.31791041e+02  2.77464088e+03  1.22514046e+04
  4.08703696e+04  1.04912563e+05  2.30095132e+05  4.55909499e+05
  8.44861350e+05  1.52803824e+06  2.85030519e+06  5.80819192e+06]
E1 = -706.783920309823  E_coul = 198.80575309682897
cycle= 2 E= -507.978167212994  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.626
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0323542
diis-c [-0.00104008 -0.0038688   1.0038688 ]
  HOMO = -0.239928881725271  LUMO = 1.19817170424022
  mo_energy =
[-1.20310584e+02 -1.23722412e+01 -6.66938815e+00 -6.66938815e+00
 -6.66938815e+00 -1.17737613e+00 -2.39928882e-01 -2.39928882e-01
 -2.39928882e-01  1.19817170e+00  6.02335980e+00  2.47138706e+01
  1.32454401e+02  6.31673747e+02  2.77450746e+03  1.22512610e+04
  4.08702222e+04  1.04912414e+05  2.30094983e+05  4.55909349e+05
  8.44861200e+05  1.52803809e+06  2.85030504e+06  5.80819177e+06]
E1 = -706.6839253844527  E_coul = 198.7055298570385
cycle= 3 E= -507.978395527414  delta_E= -0.000228  |g|= 0.00399  |ddm|= 0.109
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00356699
diis-c [-2.47433284e-06  4.97280917e-05 -1.10095630e-01  1.11004590e+00]
  HOMO = -0.24274173879025  LUMO = 1.19730220286592
  mo_energy =
[-1.20321466e+02 -1.23800856e+01 -6.67769498e+00 -6.67769498e+00
 -6.67769498e+00 -1.17906493e+00 -2.42741739e-01 -2.42741739e-01
 -2.42741739e-01  1.19730220e+00  6.01952592e+00  2.47068178e+01
  1.32444654e+02  6.31662728e+02  2.77449568e+03  1.22512488e+04
  4.08702098e+04  1.04912402e+05  2.30094970e+05  4.55909336e+05
  8.44861187e+05  1.52803808e+06  2.85030503e+06  5.80819176e+06]
E1 = -706.6709245883131  E_coul = 198.69252542570757
cycle= 4 E= -507.978399162606  delta_E= -3.64e-06  |g|= 0.000146  |ddm|= 0.0185
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122397
diis-c [-1.18167137e-10 -7.12676905e-06  6.25781375e-03 -8.10137542e-02
  1.07476307e+00]
  HOMO = -0.242826732354619  LUMO = 1.19726866464705
  mo_energy =
[-1.20321622e+02 -1.23802736e+01 -6.67787368e+00 -6.67787368e+00
 -6.67787368e+00 -1.17911582e+00 -2.42826732e-01 -2.42826732e-01
 -2.42826732e-01  1.19726866e+00  6.01940739e+00  2.47066492e+01
  1.32444489e+02  6.31662574e+02  2.77449553e+03  1.22512486e+04
  4.08702097e+04  1.04912402e+05  2.30094970e+05  4.55909336e+05
  8.44861187e+05  1.52803808e+06  2.85030503e+06  5.80819176e+06]
E1 = -706.6705449868183  E_coul = 198.69214581981927
cycle= 5 E= -507.978399166999  delta_E= -4.39e-09  |g|= 2.94e-06  |ddm|= 0.000905
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.02933e-06
diis-c [-2.71709115e-13  2.19395354e-07 -3.12107714e-04  3.79451354e-03
 -5.22104745e-02  1.04872785e+00]
  HOMO = -0.242827906107871  LUMO = 1.19726825603071
  mo_energy =
[-1.20321625e+02 -1.23802758e+01 -6.67787588e+00 -6.67787588e+00
 -6.67787588e+00 -1.17911668e+00 -2.42827906e-01 -2.42827906e-01
 -2.42827906e-01  1.19726826e+00  6.01940578e+00  2.47066471e+01
  1.32444486e+02  6.31662571e+02  2.77449553e+03  1.22512486e+04
  4.08702097e+04  1.04912402e+05  2.30094970e+05  4.55909336e+05
  8.44861187e+05  1.52803808e+06  2.85030503e+06  5.80819176e+06]
E1 = -706.670539707681  E_coul = 198.69214054068036
cycle= 6 E= -507.978399167001  delta_E= -1.59e-12  |g|= 1.18e-07  |ddm|= 1.97e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.670539707681  E_coul = 198.69214054068036
  HOMO = -0.242827949433331  LUMO = 1.19726823164781
  mo_energy =
[-1.20321625e+02 -1.23802759e+01 -6.67787595e+00 -6.67787595e+00
 -6.67787595e+00 -1.17911670e+00 -2.42827949e-01 -2.42827949e-01
 -2.42827949e-01  1.19726823e+00  6.01940572e+00  2.47066470e+01
  1.32444486e+02  6.31662571e+02  2.77449553e+03  1.22512486e+04
  4.08702097e+04  1.04912402e+05  2.30094970e+05  4.55909336e+05
  8.44861187e+05  1.52803808e+06  2.85030503e+06  5.80819176e+06]
E1 = -706.6705395204234  E_coul = 198.69214035342293
Extra cycle  E= -507.978399167  delta_E= 1.14e-13  |g|= 1.31e-08  |ddm|= 7.05e-07
    CPU time for scf_cycle      1.08 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908097.5606833624
E1 = -706.6705395204234  E_coul = 198.69214035342293
init E= -507.978399167
    CPU time for initialize scf      3.33 sec, wall time      0.21 sec
  HOMO = -0.242827955704543  LUMO = 1.19726822800798
  mo_energy =
[-1.20321625e+02 -1.23802759e+01 -6.67787596e+00 -6.67787596e+00
 -6.67787596e+00 -1.17911671e+00 -2.42827956e-01 -2.42827956e-01
 -2.42827956e-01  1.19726823e+00  6.01940571e+00  2.47066470e+01
  1.32444486e+02  6.31662571e+02  2.77449553e+03  1.22512486e+04
  4.08702097e+04  1.04912402e+05  2.30094970e+05  4.55909336e+05
  8.44861187e+05  1.52803808e+06  2.85030503e+06  5.80819176e+06]
E1 = -706.6705394930677  E_coul = 198.6921403260667
cycle= 1 E= -507.978399167001  delta_E= -5.68e-13  |g|= 2.64e-09  |ddm|= 7.71e-08
    CPU time for cycle= 1      0.29 sec, wall time      0.03 sec
E1 = -706.6705394930677  E_coul = 198.6921403260667
  HOMO = -0.242827956553191  LUMO = 1.19726822924448
  mo_energy =
[-1.20321625e+02 -1.23802759e+01 -6.67787596e+00 -6.67787596e+00
 -6.67787596e+00 -1.17911671e+00 -2.42827957e-01 -2.42827957e-01
 -2.42827957e-01  1.19726823e+00  6.01940571e+00  2.47066470e+01
  1.32444486e+02  6.31662571e+02  2.77449553e+03  1.22512486e+04
  4.08702097e+04  1.04912402e+05  2.30094970e+05  4.55909336e+05
  8.44861187e+05  1.52803808e+06  2.85030503e+06  5.80819176e+06]
E1 = -706.670539487251  E_coul = 198.69214032024988
Extra cycle  E= -507.978399167001  delta_E=    0  |g|= 1.15e-09  |ddm|= 1.18e-08
    CPU time for scf_cycle      3.76 sec, wall time      0.38 sec
exp = [2.73852018e-01 8.92809708e-01 1.17616814e+05 1.37238060e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315138e+03 1.83757992e+04
 1.44908255e+03 3.76395906e+02 1.14367358e+02 3.93648980e+01
 9.51768574e+00 4.28477672e+00 8.60378825e+00 4.92660226e-01]
grad_E = [-8.49852875e-04  1.25010906e-03  4.61808974e-09 -1.17352838e-03
  2.39004471e-11  1.26939636e-10  7.18080676e-10  2.82123927e-09
  1.17376264e-08  6.26141564e-08  3.97400618e-06  1.39771098e-07
 -1.38417442e-05  2.03643884e-04 -1.16847132e-03  1.49679492e-03
 -9.27030163e-04 -7.29420879e-04 -1.37745332e-04  5.07383616e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:09:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.275032857256       1
[INPUT] 0    0    [1    /1   ]  0.905158094639       1
[INPUT] 0    0    [1    /1   ]  117616.813864        1
[INPUT] 0    0    [1    /1   ]  1.3853361699         1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031073        1
[INPUT] 0    0    [1    /1   ]  147020.991917        1
[INPUT] 0    0    [1    /1   ]  73510.4200125        1
[INPUT] 0    0    [1    /1   ]  36754.7148821        1
[INPUT] 0    0    [1    /1   ]  7303.15132815        1
[INPUT] 0    0    [1    /1   ]  18375.799158         1
[INPUT] 0    0    [1    /1   ]  1449.08256036        1
[INPUT] 0    0    [1    /1   ]  376.395685314        1
[INPUT] 0    0    [1    /1   ]  114.367714892        1
[INPUT] 0    0    [1    /1   ]  39.3721740245        1
[INPUT] 0    0    [1    /1   ]  9.52840925663        1
[INPUT] 0    0    [1    /1   ]  4.30121052011        1
[INPUT] 1    0    [1    /1   ]  8.60416402921        1
[INPUT] 1    0    [1    /1   ]  0.492644969242       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2750328572564804, 1.0]], [0, [0.905158094638918, 1.0]], [0, [117616.81386375292, 1.0]], [0, [1.385336169895917, 1.0]], [0, [1176168.1426172236, 1.0]], [0, [588084.0699823938, 1.0]], [0, [294042.03107305925, 1.0]], [0, [147020.9919171449, 1.0]], [0, [73510.42001254624, 1.0]], [0, [36754.714882116234, 1.0]], [0, [7303.1513281513035, 1.0]], [0, [18375.7991579828, 1.0]], [0, [1449.0825603638102, 1.0]], [0, [376.3956853137275, 1.0]], [0, [114.36771489244157, 1.0]], [0, [39.37217402452883, 1.0]], [0, [9.528409256631994, 1.0]], [0, [4.301210520108082, 1.0]], [1, [8.604164029211926, 1.0]], [1, [0.49264496924207496, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.27503286]
bas 1, expnt(s) = [0.90515809]
bas 2, expnt(s) = [117616.81386375]
bas 3, expnt(s) = [1.38533617]
bas 4, expnt(s) = [1176168.14261722]
bas 5, expnt(s) = [588084.06998239]
bas 6, expnt(s) = [294042.03107306]
bas 7, expnt(s) = [147020.99191714]
bas 8, expnt(s) = [73510.42001255]
bas 9, expnt(s) = [36754.71488212]
bas 10, expnt(s) = [7303.15132815]
bas 11, expnt(s) = [18375.79915798]
bas 12, expnt(s) = [1449.08256036]
bas 13, expnt(s) = [376.39568531]
bas 14, expnt(s) = [114.36771489]
bas 15, expnt(s) = [39.37217402]
bas 16, expnt(s) = [9.52840926]
bas 17, expnt(s) = [4.30121052]
bas 18, expnt(s) = [8.60416403]
bas 19, expnt(s) = [0.49264497]
CPU time:       358.34
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.75032857e-01 9.59518737e-01 9.05158095e-01 2.34454382e+00
 1.17616814e+05 1.60460109e+04 1.38533617e+00 3.22612659e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656005e+03
 7.30315133e+03 1.99594123e+03 1.83757992e+04 3.98749086e+03
 1.44908256e+03 5.93382688e+02 3.76395685e+02 2.15897942e+02
 1.14367715e+02 8.83573347e+01 3.93721740e+01 3.97106569e+01
 9.52840926e+00 1.37018852e+01 4.30121052e+00 7.54584793e+00
 8.60416403e+00 4.29902771e+01 4.92644969e-01 1.20407062e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335754526336544
cond(S) = 908101.3578669891
E1 = -689.572980602669  E_coul = 184.97027951912767
init E= -504.602701083541
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672168061017303  LUMO = 0.829061102984891
  mo_energy =
[-1.21705065e+02 -1.33856924e+01 -7.62363000e+00 -7.62363000e+00
 -7.62363000e+00 -1.65710095e+00 -6.72168061e-01 -6.72168061e-01
 -6.72168061e-01  8.29061103e-01  5.50117436e+00  2.39428227e+01
  1.31391963e+02  6.30527580e+02  2.77341056e+03  1.22502573e+04
  4.08692756e+04  1.04911499e+05  2.30094088e+05  4.55908468e+05
  8.44860331e+05  1.52803723e+06  2.85030419e+06  5.80819092e+06]
E1 = -707.7173339463174  E_coul = 199.75664979757266
cycle= 1 E= -507.960684148745  delta_E= -3.36  |g|= 0.452  |ddm|= 0.639
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.674105
diis-c [-0.45441795  1.        ]
  HOMO = -0.21858336685048  LUMO = 1.21821660919199
  mo_energy =
[-1.20197089e+02 -1.23059278e+01 -6.59581649e+00 -6.59581649e+00
 -6.59581649e+00 -1.16370679e+00 -2.18583367e-01 -2.18583367e-01
 -2.18583367e-01  1.21821661e+00  6.12866600e+00  2.49489432e+01
  1.32789293e+02  6.32019621e+02  2.77484239e+03  1.22515804e+04
  4.08705321e+04  1.04912719e+05  2.30095284e+05  4.55909647e+05
  8.44861496e+05  1.52803838e+06  2.85030533e+06  5.80819206e+06]
E1 = -706.7841737493983  E_coul = 198.8059945369284
cycle= 2 E= -507.97817921247  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.647
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0322821
diis-c [-0.00103537 -0.00387841  1.00387841]
  HOMO = -0.239989879871254  LUMO = 1.21309366126416
  mo_energy =
[-1.20310379e+02 -1.23722248e+01 -6.66935951e+00 -6.66935951e+00
 -6.66935951e+00 -1.17738899e+00 -2.39989880e-01 -2.39989880e-01
 -2.39989880e-01  1.21309366e+00  6.10017215e+00  2.48892853e+01
  1.32694006e+02  6.31902386e+02  2.77470903e+03  1.22514368e+04
  4.08703848e+04  1.04912570e+05  2.30095134e+05  4.55909497e+05
  8.44861346e+05  1.52803823e+06  2.85030518e+06  5.80819190e+06]
E1 = -706.6845107412761  E_coul = 198.70610451711588
cycle= 3 E= -507.97840622416  delta_E= -0.000227  |g|= 0.00397  |ddm|= 0.111
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0035445
diis-c [-2.46598380e-06  5.97698749e-05 -1.09487812e-01  1.10942804e+00]
  HOMO = -0.242787607164516  LUMO = 1.21221574919815
  mo_energy =
[-1.20321222e+02 -1.23800373e+01 -6.67763363e+00 -6.67763363e+00
 -6.67763363e+00 -1.17906798e+00 -2.42787607e-01 -2.42787607e-01
 -2.42787607e-01  1.21221575e+00  6.09632897e+00  2.48822537e+01
  1.32684294e+02  6.31891407e+02  2.77469729e+03  1.22514246e+04
  4.08703725e+04  1.04912558e+05  2.30095122e+05  4.55909484e+05
  8.44861333e+05  1.52803822e+06  2.85030517e+06  5.80819189e+06]
E1 = -706.67160530075  E_coul = 198.69319549085077
cycle= 4 E= -507.978409809899  delta_E= -3.59e-06  |g|= 0.000145  |ddm|= 0.0188
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122275
diis-c [-1.12747896e-10 -6.99260032e-06  6.22807187e-03 -8.11158222e-02
  1.07489474e+00]
  HOMO = -0.242872474608226  LUMO = 1.21218198664325
  mo_energy =
[-1.20321380e+02 -1.23802261e+01 -6.67781343e+00 -6.67781343e+00
 -6.67781343e+00 -1.17911878e+00 -2.42872475e-01 -2.42872475e-01
 -2.42872475e-01  1.21218199e+00  6.09620993e+00  2.48820844e+01
  1.32684127e+02  6.31891250e+02  2.77469714e+03  1.22514245e+04
  4.08703723e+04  1.04912558e+05  2.30095121e+05  4.55909484e+05
  8.44861333e+05  1.52803822e+06  2.85030517e+06  5.80819189e+06]
E1 = -706.6712271218436  E_coul = 198.69281730762538
cycle= 5 E= -507.978409814218  delta_E= -4.32e-09  |g|= 2.81e-06  |ddm|= 0.000911
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.80061e-07
diis-c [-2.51382300e-13  2.05258405e-07 -2.93494395e-04  3.58380735e-03
 -4.92655724e-02  1.04597505e+00]
  HOMO = -0.242873599681976  LUMO = 1.21218159545686
  mo_energy =
[-1.20321383e+02 -1.23802282e+01 -6.67781555e+00 -6.67781555e+00
 -6.67781555e+00 -1.17911960e+00 -2.42873600e-01 -2.42873600e-01
 -2.42873600e-01  1.21218160e+00  6.09620838e+00  2.48820824e+01
  1.32684125e+02  6.31891247e+02  2.77469714e+03  1.22514245e+04
  4.08703723e+04  1.04912558e+05  2.30095121e+05  4.55909484e+05
  8.44861333e+05  1.52803822e+06  2.85030517e+06  5.80819189e+06]
E1 = -706.6712220821007  E_coul = 198.6928122678814
cycle= 6 E= -507.978409814219  delta_E= -1.08e-12  |g|= 1.17e-07  |ddm|= 1.91e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6712220821007  E_coul = 198.6928122678814
  HOMO = -0.242873643021356  LUMO = 1.2121815698229
  mo_energy =
[-1.20321383e+02 -1.23802283e+01 -6.67781562e+00 -6.67781562e+00
 -6.67781562e+00 -1.17911962e+00 -2.42873643e-01 -2.42873643e-01
 -2.42873643e-01  1.21218157e+00  6.09620832e+00  2.48820823e+01
  1.32684125e+02  6.31891247e+02  2.77469714e+03  1.22514245e+04
  4.08703723e+04  1.04912558e+05  2.30095121e+05  4.55909484e+05
  8.44861333e+05  1.52803822e+06  2.85030517e+06  5.80819189e+06]
E1 = -706.6712218973857  E_coul = 198.6928120831664
Extra cycle  E= -507.978409814219  delta_E= -1.14e-13  |g|= 1.32e-08  |ddm|= 7.1e-07
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
exp = [2.75032857e-01 9.05158095e-01 1.17616814e+05 1.38533617e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315133e+03 1.83757992e+04
 1.44908256e+03 3.76395685e+02 1.14367715e+02 3.93721740e+01
 9.52840926e+00 4.30121052e+00 8.60416403e+00 4.92644969e-01]
E = -507.9784098142194
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:09:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.275032857256       1
[INPUT] 0    0    [1    /1   ]  0.905158094639       1
[INPUT] 0    0    [1    /1   ]  117616.813864        1
[INPUT] 0    0    [1    /1   ]  1.3853361699         1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031073        1
[INPUT] 0    0    [1    /1   ]  147020.991917        1
[INPUT] 0    0    [1    /1   ]  73510.4200125        1
[INPUT] 0    0    [1    /1   ]  36754.7148821        1
[INPUT] 0    0    [1    /1   ]  7303.15132815        1
[INPUT] 0    0    [1    /1   ]  18375.799158         1
[INPUT] 0    0    [1    /1   ]  1449.08256036        1
[INPUT] 0    0    [1    /1   ]  376.395685314        1
[INPUT] 0    0    [1    /1   ]  114.367714892        1
[INPUT] 0    0    [1    /1   ]  39.3721740245        1
[INPUT] 0    0    [1    /1   ]  9.52840925663        1
[INPUT] 0    0    [1    /1   ]  4.30121052011        1
[INPUT] 1    0    [1    /1   ]  8.60416402921        1
[INPUT] 1    0    [1    /1   ]  0.492644969242       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2750328572564804, 1.0]], [0, [0.905158094638918, 1.0]], [0, [117616.81386375292, 1.0]], [0, [1.385336169895917, 1.0]], [0, [1176168.1426172236, 1.0]], [0, [588084.0699823938, 1.0]], [0, [294042.03107305925, 1.0]], [0, [147020.9919171449, 1.0]], [0, [73510.42001254624, 1.0]], [0, [36754.714882116234, 1.0]], [0, [7303.1513281513035, 1.0]], [0, [18375.7991579828, 1.0]], [0, [1449.0825603638102, 1.0]], [0, [376.3956853137275, 1.0]], [0, [114.36771489244157, 1.0]], [0, [39.37217402452883, 1.0]], [0, [9.528409256631994, 1.0]], [0, [4.301210520108082, 1.0]], [1, [8.604164029211926, 1.0]], [1, [0.49264496924207496, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.27503286]
bas 1, expnt(s) = [0.90515809]
bas 2, expnt(s) = [117616.81386375]
bas 3, expnt(s) = [1.38533617]
bas 4, expnt(s) = [1176168.14261722]
bas 5, expnt(s) = [588084.06998239]
bas 6, expnt(s) = [294042.03107306]
bas 7, expnt(s) = [147020.99191714]
bas 8, expnt(s) = [73510.42001255]
bas 9, expnt(s) = [36754.71488212]
bas 10, expnt(s) = [7303.15132815]
bas 11, expnt(s) = [18375.79915798]
bas 12, expnt(s) = [1449.08256036]
bas 13, expnt(s) = [376.39568531]
bas 14, expnt(s) = [114.36771489]
bas 15, expnt(s) = [39.37217402]
bas 16, expnt(s) = [9.52840926]
bas 17, expnt(s) = [4.30121052]
bas 18, expnt(s) = [8.60416403]
bas 19, expnt(s) = [0.49264497]
CPU time:       359.63
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.75032857e-01 9.59518737e-01 9.05158095e-01 2.34454382e+00
 1.17616814e+05 1.60460109e+04 1.38533617e+00 3.22612659e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656005e+03
 7.30315133e+03 1.99594123e+03 1.83757992e+04 3.98749086e+03
 1.44908256e+03 5.93382688e+02 3.76395685e+02 2.15897942e+02
 1.14367715e+02 8.83573347e+01 3.93721740e+01 3.97106569e+01
 9.52840926e+00 1.37018852e+01 4.30121052e+00 7.54584793e+00
 8.60416403e+00 4.29902771e+01 4.92644969e-01 1.20407062e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335754526336544
cond(S) = 908101.3578669891
E1 = -689.572980602669  E_coul = 184.97027951912767
init E= -504.602701083541
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672168061017303  LUMO = 0.829061102984891
  mo_energy =
[-1.21705065e+02 -1.33856924e+01 -7.62363000e+00 -7.62363000e+00
 -7.62363000e+00 -1.65710095e+00 -6.72168061e-01 -6.72168061e-01
 -6.72168061e-01  8.29061103e-01  5.50117436e+00  2.39428227e+01
  1.31391963e+02  6.30527580e+02  2.77341056e+03  1.22502573e+04
  4.08692756e+04  1.04911499e+05  2.30094088e+05  4.55908468e+05
  8.44860331e+05  1.52803723e+06  2.85030419e+06  5.80819092e+06]
E1 = -707.7173339463174  E_coul = 199.75664979757266
cycle= 1 E= -507.960684148745  delta_E= -3.36  |g|= 0.452  |ddm|= 0.639
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.674105
diis-c [-0.45441795  1.        ]
  HOMO = -0.21858336685048  LUMO = 1.21821660919199
  mo_energy =
[-1.20197089e+02 -1.23059278e+01 -6.59581649e+00 -6.59581649e+00
 -6.59581649e+00 -1.16370679e+00 -2.18583367e-01 -2.18583367e-01
 -2.18583367e-01  1.21821661e+00  6.12866600e+00  2.49489432e+01
  1.32789293e+02  6.32019621e+02  2.77484239e+03  1.22515804e+04
  4.08705321e+04  1.04912719e+05  2.30095284e+05  4.55909647e+05
  8.44861496e+05  1.52803838e+06  2.85030533e+06  5.80819206e+06]
E1 = -706.7841737493983  E_coul = 198.8059945369284
cycle= 2 E= -507.97817921247  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.647
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0322821
diis-c [-0.00103537 -0.00387841  1.00387841]
  HOMO = -0.239989879871254  LUMO = 1.21309366126416
  mo_energy =
[-1.20310379e+02 -1.23722248e+01 -6.66935951e+00 -6.66935951e+00
 -6.66935951e+00 -1.17738899e+00 -2.39989880e-01 -2.39989880e-01
 -2.39989880e-01  1.21309366e+00  6.10017215e+00  2.48892853e+01
  1.32694006e+02  6.31902386e+02  2.77470903e+03  1.22514368e+04
  4.08703848e+04  1.04912570e+05  2.30095134e+05  4.55909497e+05
  8.44861346e+05  1.52803823e+06  2.85030518e+06  5.80819190e+06]
E1 = -706.6845107412761  E_coul = 198.70610451711588
cycle= 3 E= -507.97840622416  delta_E= -0.000227  |g|= 0.00397  |ddm|= 0.111
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0035445
diis-c [-2.46598380e-06  5.97698749e-05 -1.09487812e-01  1.10942804e+00]
  HOMO = -0.242787607164516  LUMO = 1.21221574919815
  mo_energy =
[-1.20321222e+02 -1.23800373e+01 -6.67763363e+00 -6.67763363e+00
 -6.67763363e+00 -1.17906798e+00 -2.42787607e-01 -2.42787607e-01
 -2.42787607e-01  1.21221575e+00  6.09632897e+00  2.48822537e+01
  1.32684294e+02  6.31891407e+02  2.77469729e+03  1.22514246e+04
  4.08703725e+04  1.04912558e+05  2.30095122e+05  4.55909484e+05
  8.44861333e+05  1.52803822e+06  2.85030517e+06  5.80819189e+06]
E1 = -706.67160530075  E_coul = 198.69319549085077
cycle= 4 E= -507.978409809899  delta_E= -3.59e-06  |g|= 0.000145  |ddm|= 0.0188
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122275
diis-c [-1.12747896e-10 -6.99260032e-06  6.22807187e-03 -8.11158222e-02
  1.07489474e+00]
  HOMO = -0.242872474608226  LUMO = 1.21218198664325
  mo_energy =
[-1.20321380e+02 -1.23802261e+01 -6.67781343e+00 -6.67781343e+00
 -6.67781343e+00 -1.17911878e+00 -2.42872475e-01 -2.42872475e-01
 -2.42872475e-01  1.21218199e+00  6.09620993e+00  2.48820844e+01
  1.32684127e+02  6.31891250e+02  2.77469714e+03  1.22514245e+04
  4.08703723e+04  1.04912558e+05  2.30095121e+05  4.55909484e+05
  8.44861333e+05  1.52803822e+06  2.85030517e+06  5.80819189e+06]
E1 = -706.6712271218436  E_coul = 198.69281730762538
cycle= 5 E= -507.978409814218  delta_E= -4.32e-09  |g|= 2.81e-06  |ddm|= 0.000911
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.80061e-07
diis-c [-2.51382300e-13  2.05258405e-07 -2.93494395e-04  3.58380735e-03
 -4.92655724e-02  1.04597505e+00]
  HOMO = -0.242873599681976  LUMO = 1.21218159545686
  mo_energy =
[-1.20321383e+02 -1.23802282e+01 -6.67781555e+00 -6.67781555e+00
 -6.67781555e+00 -1.17911960e+00 -2.42873600e-01 -2.42873600e-01
 -2.42873600e-01  1.21218160e+00  6.09620838e+00  2.48820824e+01
  1.32684125e+02  6.31891247e+02  2.77469714e+03  1.22514245e+04
  4.08703723e+04  1.04912558e+05  2.30095121e+05  4.55909484e+05
  8.44861333e+05  1.52803822e+06  2.85030517e+06  5.80819189e+06]
E1 = -706.6712220821007  E_coul = 198.6928122678814
cycle= 6 E= -507.978409814219  delta_E= -1.08e-12  |g|= 1.17e-07  |ddm|= 1.91e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6712220821007  E_coul = 198.6928122678814
  HOMO = -0.242873643021356  LUMO = 1.2121815698229
  mo_energy =
[-1.20321383e+02 -1.23802283e+01 -6.67781562e+00 -6.67781562e+00
 -6.67781562e+00 -1.17911962e+00 -2.42873643e-01 -2.42873643e-01
 -2.42873643e-01  1.21218157e+00  6.09620832e+00  2.48820823e+01
  1.32684125e+02  6.31891247e+02  2.77469714e+03  1.22514245e+04
  4.08703723e+04  1.04912558e+05  2.30095121e+05  4.55909484e+05
  8.44861333e+05  1.52803822e+06  2.85030517e+06  5.80819189e+06]
E1 = -706.6712218973857  E_coul = 198.6928120831664
Extra cycle  E= -507.978409814219  delta_E= -1.14e-13  |g|= 1.32e-08  |ddm|= 7.1e-07
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908101.3578669891
E1 = -706.6712218973857  E_coul = 198.6928120831664
init E= -507.978409814219
    CPU time for initialize scf      3.32 sec, wall time      0.21 sec
  HOMO = -0.242873649200513  LUMO = 1.21218156894962
  mo_energy =
[-1.20321383e+02 -1.23802283e+01 -6.67781564e+00 -6.67781564e+00
 -6.67781564e+00 -1.17911963e+00 -2.42873649e-01 -2.42873649e-01
 -2.42873649e-01  1.21218157e+00  6.09620831e+00  2.48820823e+01
  1.32684125e+02  6.31891247e+02  2.77469714e+03  1.22514245e+04
  4.08703723e+04  1.04912558e+05  2.30095121e+05  4.55909484e+05
  8.44861333e+05  1.52803822e+06  2.85030517e+06  5.80819189e+06]
E1 = -706.6712218665533  E_coul = 198.6928120523342
cycle= 1 E= -507.978409814219  delta_E= 2.84e-13  |g|= 1.86e-09  |ddm|= 8.39e-08
    CPU time for cycle= 1      0.32 sec, wall time      0.03 sec
E1 = -706.6712218665533  E_coul = 198.6928120523342
  HOMO = -0.24287365014178  LUMO = 1.21218156708492
  mo_energy =
[-1.20321383e+02 -1.23802283e+01 -6.67781564e+00 -6.67781564e+00
 -6.67781564e+00 -1.17911963e+00 -2.42873650e-01 -2.42873650e-01
 -2.42873650e-01  1.21218157e+00  6.09620831e+00  2.48820823e+01
  1.32684125e+02  6.31891247e+02  2.77469714e+03  1.22514245e+04
  4.08703723e+04  1.04912558e+05  2.30095121e+05  4.55909484e+05
  8.44861333e+05  1.52803822e+06  2.85030517e+06  5.80819189e+06]
E1 = -706.6712218655153  E_coul = 198.6928120512963
Extra cycle  E= -507.978409814219  delta_E= 5.68e-14  |g|= 1.39e-09  |ddm|= 4.43e-09
    CPU time for scf_cycle      3.78 sec, wall time      0.38 sec
exp = [2.75032857e-01 9.05158095e-01 1.17616814e+05 1.38533617e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315133e+03 1.83757992e+04
 1.44908256e+03 3.76395685e+02 1.14367715e+02 3.93721740e+01
 9.52840926e+00 4.30121052e+00 8.60416403e+00 4.92644969e-01]
grad_E = [-2.08787588e-03  1.49060088e-03  4.61823620e-09 -1.04928527e-03
  2.39022420e-11  1.26944477e-10  7.18103257e-10  2.82132995e-09
  1.17380096e-08  6.26160167e-08  3.97413468e-06  1.39777063e-07
 -1.38484795e-05  2.03669383e-04 -1.16635927e-03  1.47373959e-03
 -9.35544726e-04 -7.08292118e-04  1.87077333e-04 -3.70055441e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:09:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.277956600191       1
[INPUT] 0    0    [1    /1   ]  0.936104642223       1
[INPUT] 0    0    [1    /1   ]  117616.813864        1
[INPUT] 0    0    [1    /1   ]  1.41822945982        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031073        1
[INPUT] 0    0    [1    /1   ]  147020.991917        1
[INPUT] 0    0    [1    /1   ]  73510.4200122        1
[INPUT] 0    0    [1    /1   ]  36754.7148803        1
[INPUT] 0    0    [1    /1   ]  7303.15121451        1
[INPUT] 0    0    [1    /1   ]  18375.799154         1
[INPUT] 0    0    [1    /1   ]  1449.08266298        1
[INPUT] 0    0    [1    /1   ]  376.394068136        1
[INPUT] 0    0    [1    /1   ]  114.375660212        1
[INPUT] 0    0    [1    /1   ]  39.3732634668        1
[INPUT] 0    0    [1    /1   ]  9.54710986391        1
[INPUT] 0    0    [1    /1   ]  4.34495017202        1
[INPUT] 1    0    [1    /1   ]  8.60506573174        1
[INPUT] 1    0    [1    /1   ]  0.492611857548       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.27795660019078905, 1.0]], [0, [0.9361046422231623, 1.0]], [0, [117616.81386362055, 1.0]], [0, [1.4182294598168173, 1.0]], [0, [1176168.1426172229, 1.0]], [0, [588084.0699823902, 1.0]], [0, [294042.03107303864, 1.0]], [0, [147020.99191706406, 1.0]], [0, [73510.42001221023, 1.0]], [0, [36754.71488031703, 1.0]], [0, [7303.151214509359, 1.0]], [0, [18375.799154033342, 1.0]], [0, [1449.0826629768817, 1.0]], [0, [376.394068135759, 1.0]], [0, [114.37566021243173, 1.0]], [0, [39.3732634667606, 1.0]], [0, [9.547109863912263, 1.0]], [0, [4.344950172016891, 1.0]], [1, [8.605065731736516, 1.0]], [1, [0.49261185754795545, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2779566]
bas 1, expnt(s) = [0.93610464]
bas 2, expnt(s) = [117616.81386362]
bas 3, expnt(s) = [1.41822946]
bas 4, expnt(s) = [1176168.14261722]
bas 5, expnt(s) = [588084.06998239]
bas 6, expnt(s) = [294042.03107304]
bas 7, expnt(s) = [147020.99191706]
bas 8, expnt(s) = [73510.42001221]
bas 9, expnt(s) = [36754.71488032]
bas 10, expnt(s) = [7303.15121451]
bas 11, expnt(s) = [18375.79915403]
bas 12, expnt(s) = [1449.08266298]
bas 13, expnt(s) = [376.39406814]
bas 14, expnt(s) = [114.37566021]
bas 15, expnt(s) = [39.37326347]
bas 16, expnt(s) = [9.54710986]
bas 17, expnt(s) = [4.34495017]
bas 18, expnt(s) = [8.60506573]
bas 19, expnt(s) = [0.49261186]
CPU time:       371.14
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.77956600e-01 9.67158755e-01 9.36104642e-01 2.40440888e+00
 1.17616814e+05 1.60460109e+04 1.41822946e+00 3.28340837e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656005e+03
 7.30315121e+03 1.99594120e+03 1.83757992e+04 3.98749086e+03
 1.44908266e+03 5.93382719e+02 3.76394068e+02 2.15897246e+02
 1.14375660e+02 8.83619385e+01 3.93732635e+01 3.97114810e+01
 9.54710986e+00 1.37220490e+01 4.34495017e+00 7.60332622e+00
 8.60506573e+00 4.29959088e+01 4.92611858e-01 1.20396946e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33574914404584
cond(S) = 908110.3197738422
E1 = -689.5763549125335  E_coul = 184.97313534000946
init E= -504.603219572524
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672213100573117  LUMO = 0.861551276938202
  mo_energy =
[-1.21704377e+02 -1.33855021e+01 -7.62342360e+00 -7.62342360e+00
 -7.62342360e+00 -1.65700231e+00 -6.72213101e-01 -6.72213101e-01
 -6.72213101e-01  8.61551277e-01  5.68982806e+00  2.43768376e+01
  1.31944542e+02  6.31035020e+02  2.77385738e+03  1.22506469e+04
  4.08696359e+04  1.04911845e+05  2.30094424e+05  4.55908797e+05
  8.44860654e+05  1.52803755e+06  2.85030450e+06  5.80819122e+06]
E1 = -707.7160713154913  E_coul = 199.75531716222946
cycle= 1 E= -507.960754153262  delta_E= -3.36  |g|= 0.452  |ddm|= 0.65
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.676003
diis-c [-0.45698021  1.        ]
  HOMO = -0.218803454186495  LUMO = 1.25603630595789
  mo_energy =
[-1.20196781e+02 -1.23060103e+01 -6.59587538e+00 -6.59587538e+00
 -6.59587538e+00 -1.16378809e+00 -2.18803454e-01 -2.18803454e-01
 -2.18803454e-01  1.25603631e+00  6.32345980e+00  2.53846774e+01
  1.33341349e+02  6.32526572e+02  2.77528871e+03  1.22519694e+04
  4.08708919e+04  1.04913064e+05  2.30095619e+05  4.55909975e+05
  8.44861819e+05  1.52803870e+06  2.85030564e+06  5.80819236e+06]
E1 = -706.7849698486257  E_coul = 198.80674885758577
cycle= 2 E= -507.97822099104  delta_E= -0.0175  |g|= 0.0345  |ddm|= 0.702
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0320938
diis-c [-0.00102312 -0.00390392  1.00390392]
  HOMO = -0.240127868950089  LUMO = 1.25069036056943
  mo_energy =
[-1.20309912e+02 -1.23721636e+01 -6.66927485e+00 -6.66927485e+00
 -6.66927485e+00 -1.17740741e+00 -2.40127869e-01 -2.40127869e-01
 -2.40127869e-01  1.25069036e+00  6.29445126e+00  2.53249295e+01
  1.33246212e+02  6.32409503e+02  2.77515551e+03  1.22518260e+04
  4.08707447e+04  1.04912915e+05  2.30095469e+05  4.55909825e+05
  8.44861668e+05  1.52803855e+06  2.85030549e+06  5.80819221e+06]
E1 = -706.6861625714663  E_coul = 198.707717891571
cycle= 3 E= -507.978444679895  delta_E= -0.000224  |g|= 0.00394  |ddm|= 0.118
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00348732
diis-c [-2.44320879e-06  8.44640201e-05 -1.07954998e-01  1.10787053e+00]
  HOMO = -0.242886866968593  LUMO = 1.24979228872524
  mo_energy =
[-1.20320656e+02 -1.23798942e+01 -6.67746507e+00 -6.67746507e+00
 -6.67746507e+00 -1.17906130e+00 -2.42886867e-01 -2.42886867e-01
 -2.42886867e-01  1.24979229e+00  6.29058769e+00  2.53179537e+01
  1.33236593e+02  6.32398623e+02  2.77514388e+03  1.22518139e+04
  4.08707325e+04  1.04912903e+05  2.30095457e+05  4.55909813e+05
  8.44861656e+05  1.52803854e+06  2.85030548e+06  5.80819220e+06]
E1 = -706.6734976028856  E_coul = 198.69504945952121
cycle= 4 E= -507.978448143364  delta_E= -3.46e-06  |g|= 0.000143  |ddm|= 0.0194
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000121987
diis-c [-1.01305803e-10 -6.65068049e-06  6.15479672e-03 -8.14041363e-02
  1.07525599e+00]
  HOMO = -0.242971425917434  LUMO = 1.24975797471254
  mo_energy =
[-1.20320821e+02 -1.23800851e+01 -6.67764761e+00 -6.67764761e+00
 -6.67764761e+00 -1.17911186e+00 -2.42971426e-01 -2.42971426e-01
 -2.42971426e-01  1.24975797e+00  6.29046736e+00  2.53177825e+01
  1.33236421e+02  6.32398460e+02  2.77514372e+03  1.22518138e+04
  4.08707323e+04  1.04912903e+05  2.30095457e+05  4.55909813e+05
  8.44861656e+05  1.52803854e+06  2.85030548e+06  5.80819219e+06]
E1 = -706.673122829496  E_coul = 198.6946746819876
cycle= 5 E= -507.978448147508  delta_E= -4.14e-09  |g|= 2.5e-06  |ddm|= 0.000925
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.6457e-07
diis-c [-2.02923666e-13  1.76699766e-07 -2.49448156e-04  3.07826251e-03
 -4.22179262e-02  1.03938894e+00]
  HOMO = -0.242972434894031  LUMO = 1.24975762075326
  mo_energy =
[-1.20320823e+02 -1.23800870e+01 -6.67764954e+00 -6.67764954e+00
 -6.67764954e+00 -1.17911260e+00 -2.42972435e-01 -2.42972435e-01
 -2.42972435e-01  1.24975762e+00  6.29046595e+00  2.53177807e+01
  1.33236419e+02  6.32398458e+02  2.77514372e+03  1.22518138e+04
  4.08707323e+04  1.04912903e+05  2.30095457e+05  4.55909812e+05
  8.44861656e+05  1.52803854e+06  2.85030548e+06  5.80819219e+06]
E1 = -706.673118365686  E_coul = 198.6946702181769
cycle= 6 E= -507.978448147509  delta_E= -7.39e-13  |g|= 1.14e-07  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.673118365686  E_coul = 198.6946702181769
  HOMO = -0.242972477422478  LUMO = 1.24975759736985
  mo_energy =
[-1.20320823e+02 -1.23800871e+01 -6.67764961e+00 -6.67764961e+00
 -6.67764961e+00 -1.17911262e+00 -2.42972477e-01 -2.42972477e-01
 -2.42972477e-01  1.24975760e+00  6.29046589e+00  2.53177806e+01
  1.33236419e+02  6.32398458e+02  2.77514372e+03  1.22518138e+04
  4.08707323e+04  1.04912903e+05  2.30095457e+05  4.55909812e+05
  8.44861656e+05  1.52803854e+06  2.85030548e+06  5.80819219e+06]
E1 = -706.6731181836806  E_coul = 198.69467003617086
Extra cycle  E= -507.97844814751  delta_E= -5.68e-13  |g|= 1.22e-08  |ddm|= 7.26e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.77956600e-01 9.36104642e-01 1.17616814e+05 1.41822946e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315121e+03 1.83757992e+04
 1.44908266e+03 3.76394068e+02 1.14375660e+02 3.93732635e+01
 9.54710986e+00 4.34495017e+00 8.60506573e+00 4.92611858e-01]
E = -507.9784481475097
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:09:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.277956600191       1
[INPUT] 0    0    [1    /1   ]  0.936104642223       1
[INPUT] 0    0    [1    /1   ]  117616.813864        1
[INPUT] 0    0    [1    /1   ]  1.41822945982        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031073        1
[INPUT] 0    0    [1    /1   ]  147020.991917        1
[INPUT] 0    0    [1    /1   ]  73510.4200122        1
[INPUT] 0    0    [1    /1   ]  36754.7148803        1
[INPUT] 0    0    [1    /1   ]  7303.15121451        1
[INPUT] 0    0    [1    /1   ]  18375.799154         1
[INPUT] 0    0    [1    /1   ]  1449.08266298        1
[INPUT] 0    0    [1    /1   ]  376.394068136        1
[INPUT] 0    0    [1    /1   ]  114.375660212        1
[INPUT] 0    0    [1    /1   ]  39.3732634668        1
[INPUT] 0    0    [1    /1   ]  9.54710986391        1
[INPUT] 0    0    [1    /1   ]  4.34495017202        1
[INPUT] 1    0    [1    /1   ]  8.60506573174        1
[INPUT] 1    0    [1    /1   ]  0.492611857548       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.27795660019078905, 1.0]], [0, [0.9361046422231623, 1.0]], [0, [117616.81386362055, 1.0]], [0, [1.4182294598168173, 1.0]], [0, [1176168.1426172229, 1.0]], [0, [588084.0699823902, 1.0]], [0, [294042.03107303864, 1.0]], [0, [147020.99191706406, 1.0]], [0, [73510.42001221023, 1.0]], [0, [36754.71488031703, 1.0]], [0, [7303.151214509359, 1.0]], [0, [18375.799154033342, 1.0]], [0, [1449.0826629768817, 1.0]], [0, [376.394068135759, 1.0]], [0, [114.37566021243173, 1.0]], [0, [39.3732634667606, 1.0]], [0, [9.547109863912263, 1.0]], [0, [4.344950172016891, 1.0]], [1, [8.605065731736516, 1.0]], [1, [0.49261185754795545, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2779566]
bas 1, expnt(s) = [0.93610464]
bas 2, expnt(s) = [117616.81386362]
bas 3, expnt(s) = [1.41822946]
bas 4, expnt(s) = [1176168.14261722]
bas 5, expnt(s) = [588084.06998239]
bas 6, expnt(s) = [294042.03107304]
bas 7, expnt(s) = [147020.99191706]
bas 8, expnt(s) = [73510.42001221]
bas 9, expnt(s) = [36754.71488032]
bas 10, expnt(s) = [7303.15121451]
bas 11, expnt(s) = [18375.79915403]
bas 12, expnt(s) = [1449.08266298]
bas 13, expnt(s) = [376.39406814]
bas 14, expnt(s) = [114.37566021]
bas 15, expnt(s) = [39.37326347]
bas 16, expnt(s) = [9.54710986]
bas 17, expnt(s) = [4.34495017]
bas 18, expnt(s) = [8.60506573]
bas 19, expnt(s) = [0.49261186]
CPU time:       372.44
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.77956600e-01 9.67158755e-01 9.36104642e-01 2.40440888e+00
 1.17616814e+05 1.60460109e+04 1.41822946e+00 3.28340837e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656005e+03
 7.30315121e+03 1.99594120e+03 1.83757992e+04 3.98749086e+03
 1.44908266e+03 5.93382719e+02 3.76394068e+02 2.15897246e+02
 1.14375660e+02 8.83619385e+01 3.93732635e+01 3.97114810e+01
 9.54710986e+00 1.37220490e+01 4.34495017e+00 7.60332622e+00
 8.60506573e+00 4.29959088e+01 4.92611858e-01 1.20396946e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33574914404584
cond(S) = 908110.3197738422
E1 = -689.5763549125335  E_coul = 184.97313534000946
init E= -504.603219572524
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672213100573117  LUMO = 0.861551276938202
  mo_energy =
[-1.21704377e+02 -1.33855021e+01 -7.62342360e+00 -7.62342360e+00
 -7.62342360e+00 -1.65700231e+00 -6.72213101e-01 -6.72213101e-01
 -6.72213101e-01  8.61551277e-01  5.68982806e+00  2.43768376e+01
  1.31944542e+02  6.31035020e+02  2.77385738e+03  1.22506469e+04
  4.08696359e+04  1.04911845e+05  2.30094424e+05  4.55908797e+05
  8.44860654e+05  1.52803755e+06  2.85030450e+06  5.80819122e+06]
E1 = -707.7160713154913  E_coul = 199.75531716222946
cycle= 1 E= -507.960754153262  delta_E= -3.36  |g|= 0.452  |ddm|= 0.65
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.676003
diis-c [-0.45698021  1.        ]
  HOMO = -0.218803454186495  LUMO = 1.25603630595789
  mo_energy =
[-1.20196781e+02 -1.23060103e+01 -6.59587538e+00 -6.59587538e+00
 -6.59587538e+00 -1.16378809e+00 -2.18803454e-01 -2.18803454e-01
 -2.18803454e-01  1.25603631e+00  6.32345980e+00  2.53846774e+01
  1.33341349e+02  6.32526572e+02  2.77528871e+03  1.22519694e+04
  4.08708919e+04  1.04913064e+05  2.30095619e+05  4.55909975e+05
  8.44861819e+05  1.52803870e+06  2.85030564e+06  5.80819236e+06]
E1 = -706.7849698486257  E_coul = 198.80674885758577
cycle= 2 E= -507.97822099104  delta_E= -0.0175  |g|= 0.0345  |ddm|= 0.702
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0320938
diis-c [-0.00102312 -0.00390392  1.00390392]
  HOMO = -0.240127868950089  LUMO = 1.25069036056943
  mo_energy =
[-1.20309912e+02 -1.23721636e+01 -6.66927485e+00 -6.66927485e+00
 -6.66927485e+00 -1.17740741e+00 -2.40127869e-01 -2.40127869e-01
 -2.40127869e-01  1.25069036e+00  6.29445126e+00  2.53249295e+01
  1.33246212e+02  6.32409503e+02  2.77515551e+03  1.22518260e+04
  4.08707447e+04  1.04912915e+05  2.30095469e+05  4.55909825e+05
  8.44861668e+05  1.52803855e+06  2.85030549e+06  5.80819221e+06]
E1 = -706.6861625714663  E_coul = 198.707717891571
cycle= 3 E= -507.978444679895  delta_E= -0.000224  |g|= 0.00394  |ddm|= 0.118
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00348732
diis-c [-2.44320879e-06  8.44640201e-05 -1.07954998e-01  1.10787053e+00]
  HOMO = -0.242886866968593  LUMO = 1.24979228872524
  mo_energy =
[-1.20320656e+02 -1.23798942e+01 -6.67746507e+00 -6.67746507e+00
 -6.67746507e+00 -1.17906130e+00 -2.42886867e-01 -2.42886867e-01
 -2.42886867e-01  1.24979229e+00  6.29058769e+00  2.53179537e+01
  1.33236593e+02  6.32398623e+02  2.77514388e+03  1.22518139e+04
  4.08707325e+04  1.04912903e+05  2.30095457e+05  4.55909813e+05
  8.44861656e+05  1.52803854e+06  2.85030548e+06  5.80819220e+06]
E1 = -706.6734976028856  E_coul = 198.69504945952121
cycle= 4 E= -507.978448143364  delta_E= -3.46e-06  |g|= 0.000143  |ddm|= 0.0194
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000121987
diis-c [-1.01305803e-10 -6.65068049e-06  6.15479672e-03 -8.14041363e-02
  1.07525599e+00]
  HOMO = -0.242971425917434  LUMO = 1.24975797471254
  mo_energy =
[-1.20320821e+02 -1.23800851e+01 -6.67764761e+00 -6.67764761e+00
 -6.67764761e+00 -1.17911186e+00 -2.42971426e-01 -2.42971426e-01
 -2.42971426e-01  1.24975797e+00  6.29046736e+00  2.53177825e+01
  1.33236421e+02  6.32398460e+02  2.77514372e+03  1.22518138e+04
  4.08707323e+04  1.04912903e+05  2.30095457e+05  4.55909813e+05
  8.44861656e+05  1.52803854e+06  2.85030548e+06  5.80819219e+06]
E1 = -706.673122829496  E_coul = 198.6946746819876
cycle= 5 E= -507.978448147508  delta_E= -4.14e-09  |g|= 2.5e-06  |ddm|= 0.000925
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.6457e-07
diis-c [-2.02923666e-13  1.76699766e-07 -2.49448156e-04  3.07826251e-03
 -4.22179262e-02  1.03938894e+00]
  HOMO = -0.242972434894031  LUMO = 1.24975762075326
  mo_energy =
[-1.20320823e+02 -1.23800870e+01 -6.67764954e+00 -6.67764954e+00
 -6.67764954e+00 -1.17911260e+00 -2.42972435e-01 -2.42972435e-01
 -2.42972435e-01  1.24975762e+00  6.29046595e+00  2.53177807e+01
  1.33236419e+02  6.32398458e+02  2.77514372e+03  1.22518138e+04
  4.08707323e+04  1.04912903e+05  2.30095457e+05  4.55909812e+05
  8.44861656e+05  1.52803854e+06  2.85030548e+06  5.80819219e+06]
E1 = -706.673118365686  E_coul = 198.6946702181769
cycle= 6 E= -507.978448147509  delta_E= -7.39e-13  |g|= 1.14e-07  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.673118365686  E_coul = 198.6946702181769
  HOMO = -0.242972477422478  LUMO = 1.24975759736985
  mo_energy =
[-1.20320823e+02 -1.23800871e+01 -6.67764961e+00 -6.67764961e+00
 -6.67764961e+00 -1.17911262e+00 -2.42972477e-01 -2.42972477e-01
 -2.42972477e-01  1.24975760e+00  6.29046589e+00  2.53177806e+01
  1.33236419e+02  6.32398458e+02  2.77514372e+03  1.22518138e+04
  4.08707323e+04  1.04912903e+05  2.30095457e+05  4.55909812e+05
  8.44861656e+05  1.52803854e+06  2.85030548e+06  5.80819219e+06]
E1 = -706.6731181836806  E_coul = 198.69467003617086
Extra cycle  E= -507.97844814751  delta_E= -5.68e-13  |g|= 1.22e-08  |ddm|= 7.26e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908110.3197738422
E1 = -706.6731181836806  E_coul = 198.69467003617086
init E= -507.97844814751
    CPU time for initialize scf      3.36 sec, wall time      0.21 sec
  HOMO = -0.242972483466926  LUMO = 1.24975759605887
  mo_energy =
[-1.20320823e+02 -1.23800871e+01 -6.67764963e+00 -6.67764963e+00
 -6.67764963e+00 -1.17911263e+00 -2.42972483e-01 -2.42972483e-01
 -2.42972483e-01  1.24975760e+00  6.29046588e+00  2.53177806e+01
  1.33236419e+02  6.32398458e+02  2.77514372e+03  1.22518138e+04
  4.08707323e+04  1.04912903e+05  2.30095457e+05  4.55909812e+05
  8.44861656e+05  1.52803854e+06  2.85030548e+06  5.80819219e+06]
E1 = -706.673118155472  E_coul = 198.6946700079626
cycle= 1 E= -507.978448147509  delta_E= 2.84e-13  |g|= 1.75e-09  |ddm|= 8.12e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.673118155472  E_coul = 198.6946700079626
  HOMO = -0.242972484331791  LUMO = 1.24975759348729
  mo_energy =
[-1.20320823e+02 -1.23800871e+01 -6.67764963e+00 -6.67764963e+00
 -6.67764963e+00 -1.17911263e+00 -2.42972484e-01 -2.42972484e-01
 -2.42972484e-01  1.24975759e+00  6.29046588e+00  2.53177806e+01
  1.33236419e+02  6.32398458e+02  2.77514372e+03  1.22518138e+04
  4.08707323e+04  1.04912903e+05  2.30095457e+05  4.55909812e+05
  8.44861656e+05  1.52803854e+06  2.85030548e+06  5.80819219e+06]
E1 = -706.6731181535316  E_coul = 198.6946700060221
Extra cycle  E= -507.97844814751  delta_E= -1.14e-13  |g|= 1.24e-09  |ddm|= 5.55e-09
    CPU time for scf_cycle      3.82 sec, wall time      0.38 sec
exp = [2.77956600e-01 9.36104642e-01 1.17616814e+05 1.41822946e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315121e+03 1.83757992e+04
 1.44908266e+03 3.76394068e+02 1.14375660e+02 3.93732635e+01
 9.54710986e+00 4.34495017e+00 8.60506573e+00 4.92611858e-01]
grad_E = [-4.97404494e-03  2.00043179e-03  4.61114893e-09 -7.96308176e-04
  2.38195628e-11  1.26713994e-10  7.17008842e-10  2.81694783e-09
  1.17195211e-08  6.25252853e-08  3.96779532e-06  1.39496434e-07
 -1.34971124e-05  1.98380018e-04 -1.12821746e-03  1.33885553e-03
 -9.78441387e-04 -5.10422696e-04  9.57388865e-04 -2.33604145e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:09:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.28072976061        1
[INPUT] 0    0    [1    /1   ]  0.96315918594        1
[INPUT] 0    0    [1    /1   ]  117616.813863        1
[INPUT] 0    0    [1    /1   ]  1.45510902714        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031073        1
[INPUT] 0    0    [1    /1   ]  147020.991917        1
[INPUT] 0    0    [1    /1   ]  73510.4200118        1
[INPUT] 0    0    [1    /1   ]  36754.7148781        1
[INPUT] 0    0    [1    /1   ]  7303.15107417        1
[INPUT] 0    0    [1    /1   ]  18375.7991491        1
[INPUT] 0    0    [1    /1   ]  1449.08287008        1
[INPUT] 0    0    [1    /1   ]  376.390918719        1
[INPUT] 0    0    [1    /1   ]  114.392444407        1
[INPUT] 0    0    [1    /1   ]  39.3627281491        1
[INPUT] 0    0    [1    /1   ]  9.57184969348        1
[INPUT] 0    0    [1    /1   ]  4.39379358181        1
[INPUT] 1    0    [1    /1   ]  8.60570495273        1
[INPUT] 1    0    [1    /1   ]  0.49258777111        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.28072976061037375, 1.0]], [0, [0.9631591859399953, 1.0]], [0, [117616.81386345718, 1.0]], [0, [1.4551090271443992, 1.0]], [0, [1176168.1426172222, 1.0]], [0, [588084.0699823857, 1.0]], [0, [294042.0310730132, 1.0]], [0, [147020.9919169643, 1.0]], [0, [73510.4200117954, 1.0]], [0, [36754.7148780976, 1.0]], [0, [7303.151074174487, 1.0]], [0, [18375.799149143233, 1.0]], [0, [1449.0828700754425, 1.0]], [0, [376.3909187187569, 1.0]], [0, [114.39244440743663, 1.0]], [0, [39.36272814907146, 1.0]], [0, [9.571849693483058, 1.0]], [0, [4.393793581806148, 1.0]], [1, [8.605704952727224, 1.0]], [1, [0.4925877711100636, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.28072976]
bas 1, expnt(s) = [0.96315919]
bas 2, expnt(s) = [117616.81386346]
bas 3, expnt(s) = [1.45510903]
bas 4, expnt(s) = [1176168.14261722]
bas 5, expnt(s) = [588084.06998239]
bas 6, expnt(s) = [294042.03107301]
bas 7, expnt(s) = [147020.99191696]
bas 8, expnt(s) = [73510.4200118]
bas 9, expnt(s) = [36754.7148781]
bas 10, expnt(s) = [7303.15107417]
bas 11, expnt(s) = [18375.79914914]
bas 12, expnt(s) = [1449.08287008]
bas 13, expnt(s) = [376.39091872]
bas 14, expnt(s) = [114.39244441]
bas 15, expnt(s) = [39.36272815]
bas 16, expnt(s) = [9.57184969]
bas 17, expnt(s) = [4.39379358]
bas 18, expnt(s) = [8.60570495]
bas 19, expnt(s) = [0.49258777]
CPU time:       384.02
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.80729761e-01 9.74386741e-01 9.63159186e-01 2.45634055e+00
 1.17616814e+05 1.60460109e+04 1.45510903e+00 3.34723863e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656005e+03
 7.30315107e+03 1.99594118e+03 1.83757991e+04 3.98749086e+03
 1.44908287e+03 5.93382783e+02 3.76390919e+02 2.15895891e+02
 1.14392444e+02 8.83716634e+01 3.93627281e+01 3.97035114e+01
 9.57184969e+00 1.37487092e+01 4.39379358e+00 7.66734070e+00
 8.60570495e+00 4.29999012e+01 4.92587771e-01 1.20389587e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33572963002059
cond(S) = 908119.6073586708
E1 = -689.5792663754271  E_coul = 184.9751247020733
init E= -504.604141673354
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672245626348464  LUMO = 0.892712908633549
  mo_energy =
[-1.21703928e+02 -1.33853672e+01 -7.62328053e+00 -7.62328053e+00
 -7.62328053e+00 -1.65690921e+00 -6.72245626e-01 -6.72245626e-01
 -6.72245626e-01  8.92712909e-01  5.87715489e+00  2.48285846e+01
  1.32523736e+02  6.31564976e+02  2.77432756e+03  1.22510572e+04
  4.08700154e+04  1.04912208e+05  2.30094777e+05  4.55909143e+05
  8.44860995e+05  1.52803788e+06  2.85030483e+06  5.80819154e+06]
E1 = -707.7143848289862  E_coul = 199.75353761763685
cycle= 1 E= -507.960847211349  delta_E= -3.36  |g|= 0.452  |ddm|= 0.655
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.677823
diis-c [-0.45944428  1.        ]
  HOMO = -0.218989914324798  LUMO = 1.29225921110088
  mo_energy =
[-1.20196696e+02 -1.23061178e+01 -6.59596875e+00 -6.59596875e+00
 -6.59596875e+00 -1.16385100e+00 -2.18989914e-01 -2.18989914e-01
 -2.18989914e-01  1.29225921e+00  6.51694014e+00  2.58384391e+01
  1.33920039e+02  6.33056041e+02  2.77575840e+03  1.22523792e+04
  4.08712708e+04  1.04913427e+05  2.30095972e+05  4.55910320e+05
  8.44862159e+05  1.52803904e+06  2.85030597e+06  5.80819268e+06]
E1 = -706.7854813896922  E_coul = 198.80719973363614
cycle= 2 E= -507.978281656056  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.743
    CPU time for cycle= 2      0.14 sec, wall time      0.04 sec
diis-norm(errvec)=0.0318939
diis-c [-0.00101022 -0.00392128  1.00392128]
  HOMO = -0.240226793938522  LUMO = 1.28670216406458
  mo_energy =
[-1.20309656e+02 -1.23721171e+01 -6.66921374e+00 -6.66921374e+00
 -6.66921374e+00 -1.17740412e+00 -2.40226794e-01 -2.40226794e-01
 -2.40226794e-01  1.28670216e+00  6.48743619e+00  2.57785929e+01
  1.33825065e+02  6.32939149e+02  2.77562538e+03  1.22522359e+04
  4.08711238e+04  1.04913279e+05  2.30095822e+05  4.55910171e+05
  8.44862008e+05  1.52803889e+06  2.85030582e+06  5.80819253e+06]
E1 = -706.6875169455908  E_coul = 198.7090148239834
cycle= 3 E= -507.978502121607  delta_E= -0.00022  |g|= 0.0039  |ddm|= 0.121
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00342991
diis-c [-2.41836035e-06  1.07575922e-04 -1.06443705e-01  1.10633613e+00]
  HOMO = -0.242948027172944  LUMO = 1.28578579333635
  mo_energy =
[-1.20320304e+02 -1.23797678e+01 -6.67732217e+00 -6.67732217e+00
 -6.67732217e+00 -1.17903361e+00 -2.42948027e-01 -2.42948027e-01
 -2.42948027e-01  1.28578579e+00  6.48355356e+00  2.57716696e+01
  1.33815535e+02  6.32928368e+02  2.77561386e+03  1.22522240e+04
  4.08711117e+04  1.04913266e+05  2.30095810e+05  4.55910158e+05
  8.44861996e+05  1.52803887e+06  2.85030581e+06  5.80819251e+06]
E1 = -706.6750808650216  E_coul = 198.69657539294164
cycle= 4 E= -507.97850547208  delta_E= -3.35e-06  |g|= 0.000141  |ddm|= 0.0196
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000121805
diis-c [-9.30868839e-11 -6.33396720e-06  6.08786960e-03 -8.17812728e-02
  1.07569974e+00]
  HOMO = -0.243032465422314  LUMO = 1.28575088767037
  mo_energy =
[-1.20320474e+02 -1.23799611e+01 -6.67750778e+00 -6.67750778e+00
 -6.67750778e+00 -1.17908405e+00 -2.43032465e-01 -2.43032465e-01
 -2.43032465e-01  1.28575089e+00  6.48343164e+00  2.57714962e+01
  1.33815359e+02  6.32928198e+02  2.77561369e+03  1.22522238e+04
  4.08711116e+04  1.04913266e+05  2.30095810e+05  4.55910158e+05
  8.44861996e+05  1.52803887e+06  2.85030581e+06  5.80819251e+06]
E1 = -706.6747083646612  E_coul = 198.69620288857
cycle= 5 E= -507.978505476091  delta_E= -4.01e-09  |g|= 2.23e-06  |ddm|= 0.00092
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.69111e-07
diis-c [-1.62961608e-13  1.65259398e-07 -2.13633109e-04  2.66259899e-03
 -3.63781143e-02  1.03392898e+00]
  HOMO = -0.243033372254574  LUMO = 1.2857505708508
  mo_energy =
[-1.20320476e+02 -1.23799629e+01 -6.67750954e+00 -6.67750954e+00
 -6.67750954e+00 -1.17908473e+00 -2.43033372e-01 -2.43033372e-01
 -2.43033372e-01  1.28575057e+00  6.48343037e+00  2.57714946e+01
  1.33815357e+02  6.32928196e+02  2.77561369e+03  1.22522238e+04
  4.08711116e+04  1.04913266e+05  2.30095810e+05  4.55910158e+05
  8.44861996e+05  1.52803887e+06  2.85030581e+06  5.80819251e+06]
E1 = -706.6747043965472  E_coul = 198.6961989204552
cycle= 6 E= -507.978505476092  delta_E= -7.96e-13  |g|= 1.09e-07  |ddm|= 1.57e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6747043965472  E_coul = 198.6961989204552
  HOMO = -0.243033413043472  LUMO = 1.28575054610339
  mo_energy =
[-1.20320476e+02 -1.23799630e+01 -6.67750961e+00 -6.67750961e+00
 -6.67750961e+00 -1.17908475e+00 -2.43033413e-01 -2.43033413e-01
 -2.43033413e-01  1.28575055e+00  6.48343031e+00  2.57714945e+01
  1.33815357e+02  6.32928196e+02  2.77561369e+03  1.22522238e+04
  4.08711116e+04  1.04913266e+05  2.30095810e+05  4.55910158e+05
  8.44861996e+05  1.52803887e+06  2.85030581e+06  5.80819251e+06]
E1 = -706.6747042245869  E_coul = 198.69619874849496
Extra cycle  E= -507.978505476092  delta_E= 5.68e-14  |g|= 1.19e-08  |ddm|= 6.98e-07
    CPU time for scf_cycle      1.10 sec, wall time      0.29 sec
exp = [2.80729761e-01 9.63159186e-01 1.17616814e+05 1.45510903e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315107e+03 1.83757991e+04
 1.44908287e+03 3.76390919e+02 1.14392444e+02 3.93627281e+01
 9.57184969e+00 4.39379358e+00 8.60570495e+00 4.92587771e-01]
E = -507.9785054760919
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:09:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.28072976061        1
[INPUT] 0    0    [1    /1   ]  0.96315918594        1
[INPUT] 0    0    [1    /1   ]  117616.813863        1
[INPUT] 0    0    [1    /1   ]  1.45510902714        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031073        1
[INPUT] 0    0    [1    /1   ]  147020.991917        1
[INPUT] 0    0    [1    /1   ]  73510.4200118        1
[INPUT] 0    0    [1    /1   ]  36754.7148781        1
[INPUT] 0    0    [1    /1   ]  7303.15107417        1
[INPUT] 0    0    [1    /1   ]  18375.7991491        1
[INPUT] 0    0    [1    /1   ]  1449.08287008        1
[INPUT] 0    0    [1    /1   ]  376.390918719        1
[INPUT] 0    0    [1    /1   ]  114.392444407        1
[INPUT] 0    0    [1    /1   ]  39.3627281491        1
[INPUT] 0    0    [1    /1   ]  9.57184969348        1
[INPUT] 0    0    [1    /1   ]  4.39379358181        1
[INPUT] 1    0    [1    /1   ]  8.60570495273        1
[INPUT] 1    0    [1    /1   ]  0.49258777111        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.28072976061037375, 1.0]], [0, [0.9631591859399953, 1.0]], [0, [117616.81386345718, 1.0]], [0, [1.4551090271443992, 1.0]], [0, [1176168.1426172222, 1.0]], [0, [588084.0699823857, 1.0]], [0, [294042.0310730132, 1.0]], [0, [147020.9919169643, 1.0]], [0, [73510.4200117954, 1.0]], [0, [36754.7148780976, 1.0]], [0, [7303.151074174487, 1.0]], [0, [18375.799149143233, 1.0]], [0, [1449.0828700754425, 1.0]], [0, [376.3909187187569, 1.0]], [0, [114.39244440743663, 1.0]], [0, [39.36272814907146, 1.0]], [0, [9.571849693483058, 1.0]], [0, [4.393793581806148, 1.0]], [1, [8.605704952727224, 1.0]], [1, [0.4925877711100636, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.28072976]
bas 1, expnt(s) = [0.96315919]
bas 2, expnt(s) = [117616.81386346]
bas 3, expnt(s) = [1.45510903]
bas 4, expnt(s) = [1176168.14261722]
bas 5, expnt(s) = [588084.06998239]
bas 6, expnt(s) = [294042.03107301]
bas 7, expnt(s) = [147020.99191696]
bas 8, expnt(s) = [73510.4200118]
bas 9, expnt(s) = [36754.7148781]
bas 10, expnt(s) = [7303.15107417]
bas 11, expnt(s) = [18375.79914914]
bas 12, expnt(s) = [1449.08287008]
bas 13, expnt(s) = [376.39091872]
bas 14, expnt(s) = [114.39244441]
bas 15, expnt(s) = [39.36272815]
bas 16, expnt(s) = [9.57184969]
bas 17, expnt(s) = [4.39379358]
bas 18, expnt(s) = [8.60570495]
bas 19, expnt(s) = [0.49258777]
CPU time:       385.36
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.80729761e-01 9.74386741e-01 9.63159186e-01 2.45634055e+00
 1.17616814e+05 1.60460109e+04 1.45510903e+00 3.34723863e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656005e+03
 7.30315107e+03 1.99594118e+03 1.83757991e+04 3.98749086e+03
 1.44908287e+03 5.93382783e+02 3.76390919e+02 2.15895891e+02
 1.14392444e+02 8.83716634e+01 3.93627281e+01 3.97035114e+01
 9.57184969e+00 1.37487092e+01 4.39379358e+00 7.66734070e+00
 8.60570495e+00 4.29999012e+01 4.92587771e-01 1.20389587e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33572963002059
cond(S) = 908119.6073586708
E1 = -689.5792663754271  E_coul = 184.9751247020733
init E= -504.604141673354
    CPU time for initialize scf      0.40 sec, wall time      0.07 sec
  HOMO = -0.672245626348464  LUMO = 0.892712908633549
  mo_energy =
[-1.21703928e+02 -1.33853672e+01 -7.62328053e+00 -7.62328053e+00
 -7.62328053e+00 -1.65690921e+00 -6.72245626e-01 -6.72245626e-01
 -6.72245626e-01  8.92712909e-01  5.87715489e+00  2.48285846e+01
  1.32523736e+02  6.31564976e+02  2.77432756e+03  1.22510572e+04
  4.08700154e+04  1.04912208e+05  2.30094777e+05  4.55909143e+05
  8.44860995e+05  1.52803788e+06  2.85030483e+06  5.80819154e+06]
E1 = -707.7143848289862  E_coul = 199.75353761763685
cycle= 1 E= -507.960847211349  delta_E= -3.36  |g|= 0.452  |ddm|= 0.655
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.677823
diis-c [-0.45944428  1.        ]
  HOMO = -0.218989914324798  LUMO = 1.29225921110088
  mo_energy =
[-1.20196696e+02 -1.23061178e+01 -6.59596875e+00 -6.59596875e+00
 -6.59596875e+00 -1.16385100e+00 -2.18989914e-01 -2.18989914e-01
 -2.18989914e-01  1.29225921e+00  6.51694014e+00  2.58384391e+01
  1.33920039e+02  6.33056041e+02  2.77575840e+03  1.22523792e+04
  4.08712708e+04  1.04913427e+05  2.30095972e+05  4.55910320e+05
  8.44862159e+05  1.52803904e+06  2.85030597e+06  5.80819268e+06]
E1 = -706.7854813896922  E_coul = 198.80719973363614
cycle= 2 E= -507.978281656056  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.743
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0318939
diis-c [-0.00101022 -0.00392128  1.00392128]
  HOMO = -0.240226793938522  LUMO = 1.28670216406458
  mo_energy =
[-1.20309656e+02 -1.23721171e+01 -6.66921374e+00 -6.66921374e+00
 -6.66921374e+00 -1.17740412e+00 -2.40226794e-01 -2.40226794e-01
 -2.40226794e-01  1.28670216e+00  6.48743619e+00  2.57785929e+01
  1.33825065e+02  6.32939149e+02  2.77562538e+03  1.22522359e+04
  4.08711238e+04  1.04913279e+05  2.30095822e+05  4.55910171e+05
  8.44862008e+05  1.52803889e+06  2.85030582e+06  5.80819253e+06]
E1 = -706.6875169455908  E_coul = 198.7090148239834
cycle= 3 E= -507.978502121607  delta_E= -0.00022  |g|= 0.0039  |ddm|= 0.121
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00342991
diis-c [-2.41836035e-06  1.07575922e-04 -1.06443705e-01  1.10633613e+00]
  HOMO = -0.242948027172944  LUMO = 1.28578579333635
  mo_energy =
[-1.20320304e+02 -1.23797678e+01 -6.67732217e+00 -6.67732217e+00
 -6.67732217e+00 -1.17903361e+00 -2.42948027e-01 -2.42948027e-01
 -2.42948027e-01  1.28578579e+00  6.48355356e+00  2.57716696e+01
  1.33815535e+02  6.32928368e+02  2.77561386e+03  1.22522240e+04
  4.08711117e+04  1.04913266e+05  2.30095810e+05  4.55910158e+05
  8.44861996e+05  1.52803887e+06  2.85030581e+06  5.80819251e+06]
E1 = -706.6750808650216  E_coul = 198.69657539294164
cycle= 4 E= -507.97850547208  delta_E= -3.35e-06  |g|= 0.000141  |ddm|= 0.0196
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000121805
diis-c [-9.30868839e-11 -6.33396720e-06  6.08786960e-03 -8.17812728e-02
  1.07569974e+00]
  HOMO = -0.243032465422314  LUMO = 1.28575088767037
  mo_energy =
[-1.20320474e+02 -1.23799611e+01 -6.67750778e+00 -6.67750778e+00
 -6.67750778e+00 -1.17908405e+00 -2.43032465e-01 -2.43032465e-01
 -2.43032465e-01  1.28575089e+00  6.48343164e+00  2.57714962e+01
  1.33815359e+02  6.32928198e+02  2.77561369e+03  1.22522238e+04
  4.08711116e+04  1.04913266e+05  2.30095810e+05  4.55910158e+05
  8.44861996e+05  1.52803887e+06  2.85030581e+06  5.80819251e+06]
E1 = -706.6747083646612  E_coul = 198.69620288857
cycle= 5 E= -507.978505476091  delta_E= -4.01e-09  |g|= 2.23e-06  |ddm|= 0.00092
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.69111e-07
diis-c [-1.62961608e-13  1.65259398e-07 -2.13633109e-04  2.66259899e-03
 -3.63781143e-02  1.03392898e+00]
  HOMO = -0.243033372254574  LUMO = 1.2857505708508
  mo_energy =
[-1.20320476e+02 -1.23799629e+01 -6.67750954e+00 -6.67750954e+00
 -6.67750954e+00 -1.17908473e+00 -2.43033372e-01 -2.43033372e-01
 -2.43033372e-01  1.28575057e+00  6.48343037e+00  2.57714946e+01
  1.33815357e+02  6.32928196e+02  2.77561369e+03  1.22522238e+04
  4.08711116e+04  1.04913266e+05  2.30095810e+05  4.55910158e+05
  8.44861996e+05  1.52803887e+06  2.85030581e+06  5.80819251e+06]
E1 = -706.6747043965472  E_coul = 198.6961989204552
cycle= 6 E= -507.978505476092  delta_E= -7.96e-13  |g|= 1.09e-07  |ddm|= 1.57e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6747043965472  E_coul = 198.6961989204552
  HOMO = -0.243033413043472  LUMO = 1.28575054610339
  mo_energy =
[-1.20320476e+02 -1.23799630e+01 -6.67750961e+00 -6.67750961e+00
 -6.67750961e+00 -1.17908475e+00 -2.43033413e-01 -2.43033413e-01
 -2.43033413e-01  1.28575055e+00  6.48343031e+00  2.57714945e+01
  1.33815357e+02  6.32928196e+02  2.77561369e+03  1.22522238e+04
  4.08711116e+04  1.04913266e+05  2.30095810e+05  4.55910158e+05
  8.44861996e+05  1.52803887e+06  2.85030581e+06  5.80819251e+06]
E1 = -706.6747042245869  E_coul = 198.69619874849496
Extra cycle  E= -507.978505476092  delta_E= 5.68e-14  |g|= 1.19e-08  |ddm|= 6.98e-07
    CPU time for scf_cycle      1.10 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908119.6073586708
E1 = -706.6747042245869  E_coul = 198.69619874849496
init E= -507.978505476092
    CPU time for initialize scf      3.36 sec, wall time      0.21 sec
  HOMO = -0.243033418721791  LUMO = 1.28575054459804
  mo_energy =
[-1.20320477e+02 -1.23799630e+01 -6.67750962e+00 -6.67750962e+00
 -6.67750962e+00 -1.17908475e+00 -2.43033419e-01 -2.43033419e-01
 -2.43033419e-01  1.28575054e+00  6.48343030e+00  2.57714945e+01
  1.33815357e+02  6.32928196e+02  2.77561369e+03  1.22522238e+04
  4.08711116e+04  1.04913266e+05  2.30095810e+05  4.55910158e+05
  8.44861996e+05  1.52803887e+06  2.85030581e+06  5.80819251e+06]
E1 = -706.6747041987187  E_coul = 198.6961987226271
cycle= 1 E= -507.978505476092  delta_E= 2.84e-13  |g|= 2.08e-09  |ddm|= 7.49e-08
    CPU time for cycle= 1      0.32 sec, wall time      0.03 sec
E1 = -706.6747041987187  E_coul = 198.6961987226271
  HOMO = -0.243033419509266  LUMO = 1.285750544548
  mo_energy =
[-1.20320477e+02 -1.23799630e+01 -6.67750963e+00 -6.67750963e+00
 -6.67750963e+00 -1.17908475e+00 -2.43033420e-01 -2.43033420e-01
 -2.43033420e-01  1.28575054e+00  6.48343030e+00  2.57714945e+01
  1.33815357e+02  6.32928196e+02  2.77561369e+03  1.22522238e+04
  4.08711116e+04  1.04913266e+05  2.30095810e+05  4.55910158e+05
  8.44861996e+05  1.52803887e+06  2.85030581e+06  5.80819251e+06]
E1 = -706.6747041949749  E_coul = 198.6961987188828
Extra cycle  E= -507.978505476092  delta_E= -4.55e-13  |g|= 1.05e-09  |ddm|= 9.82e-09
    CPU time for scf_cycle      3.82 sec, wall time      0.38 sec
exp = [2.80729761e-01 9.63159186e-01 1.17616814e+05 1.45510903e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315107e+03 1.83757991e+04
 1.44908287e+03 3.76390919e+02 1.14392444e+02 3.93627281e+01
 9.57184969e+00 4.39379358e+00 8.60570495e+00 4.92587771e-01]
grad_E = [-7.04517846e-03  2.38893247e-03  4.59728095e-09 -6.26838886e-04
  2.36575387e-11  1.26262800e-10  7.14867406e-10  2.80837283e-09
  1.16833411e-08  6.23477830e-08  3.95539949e-06  1.38946935e-07
 -1.28124290e-05  1.88322466e-04 -1.06157600e-03  1.13820226e-03
 -1.01554601e-03 -2.33108828e-04  1.49653410e-03 -3.67036717e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:09:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.283928706534       1
[INPUT] 0    0    [1    /1   ]  0.990473030279       1
[INPUT] 0    0    [1    /1   ]  117616.813863        1
[INPUT] 0    0    [1    /1   ]  1.52479635237        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031073        1
[INPUT] 0    0    [1    /1   ]  147020.991917        1
[INPUT] 0    0    [1    /1   ]  73510.4200108        1
[INPUT] 0    0    [1    /1   ]  36754.7148726        1
[INPUT] 0    0    [1    /1   ]  7303.15072803        1
[INPUT] 0    0    [1    /1   ]  18375.7991371        1
[INPUT] 0    0    [1    /1   ]  1449.08337829        1
[INPUT] 0    0    [1    /1   ]  376.383230332        1
[INPUT] 0    0    [1    /1   ]  114.432172061        1
[INPUT] 0    0    [1    /1   ]  39.3498941762        1
[INPUT] 0    0    [1    /1   ]  9.65397849116        1
[INPUT] 0    0    [1    /1   ]  4.48578047261        1
[INPUT] 1    0    [1    /1   ]  8.60626302636        1
[INPUT] 1    0    [1    /1   ]  0.492561493182       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.28392870653449204, 1.0]], [0, [0.9904730302794479, 1.0]], [0, [117616.81386305422, 1.0]], [0, [1.524796352370572, 1.0]], [0, [1176168.14261722, 1.0]], [0, [588084.0699823747, 1.0]], [0, [294042.0310729505, 1.0]], [0, [147020.99191671822, 1.0]], [0, [73510.42001077217, 1.0]], [0, [36754.71487262314, 1.0]], [0, [7303.150728030794, 1.0]], [0, [18375.799137081434, 1.0]], [0, [1449.0833782908403, 1.0]], [0, [376.38323033248776, 1.0]], [0, [114.43217206119088, 1.0]], [0, [39.34989417621343, 1.0]], [0, [9.653978491158718, 1.0]], [0, [4.485780472611963, 1.0]], [1, [8.606263026358828, 1.0]], [1, [0.49256149318223436, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.28392871]
bas 1, expnt(s) = [0.99047303]
bas 2, expnt(s) = [117616.81386305]
bas 3, expnt(s) = [1.52479635]
bas 4, expnt(s) = [1176168.14261722]
bas 5, expnt(s) = [588084.06998237]
bas 6, expnt(s) = [294042.03107295]
bas 7, expnt(s) = [147020.99191672]
bas 8, expnt(s) = [73510.42001077]
bas 9, expnt(s) = [36754.71487262]
bas 10, expnt(s) = [7303.15072803]
bas 11, expnt(s) = [18375.79913708]
bas 12, expnt(s) = [1449.08337829]
bas 13, expnt(s) = [376.38323033]
bas 14, expnt(s) = [114.43217206]
bas 15, expnt(s) = [39.34989418]
bas 16, expnt(s) = [9.65397849]
bas 17, expnt(s) = [4.48578047]
bas 18, expnt(s) = [8.60626303]
bas 19, expnt(s) = [0.49256149]
CPU time:       397.06
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.83928707e-01 9.82702367e-01 9.90473030e-01 2.50840129e+00
 1.17616814e+05 1.60460109e+04 1.52479635e+00 3.46676104e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656005e+03
 7.30315073e+03 1.99594111e+03 1.83757991e+04 3.98749086e+03
 1.44908338e+03 5.93382939e+02 3.76383230e+02 2.15892583e+02
 1.14432172e+02 8.83946805e+01 3.93498942e+01 3.96938022e+01
 9.65397849e+00 1.38370901e+01 4.48578047e+00 7.78741889e+00
 8.60626303e+00 4.30033869e+01 4.92561493e-01 1.20381559e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.3357003625972
cond(S) = 908136.7109435337
E1 = -689.5825392946991  E_coul = 184.97660652324805
init E= -504.605932771451
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672281741198712  LUMO = 0.933038272648417
  mo_energy =
[-1.21703632e+02 -1.33852647e+01 -7.62317472e+00 -7.62317472e+00
 -7.62317472e+00 -1.65678306e+00 -6.72281741e-01 -6.72281741e-01
 -6.72281741e-01  9.33038273e-01  6.15390470e+00  2.56078875e+01
  1.33657749e+02  6.32656069e+02  2.77530901e+03  1.22519156e+04
  4.08708095e+04  1.04912969e+05  2.30095517e+05  4.55909867e+05
  8.44861707e+05  1.52803858e+06  2.85030552e+06  5.80819221e+06]
E1 = -707.7110369406322  E_coul = 199.75001808071212
cycle= 1 E= -507.96101885992  delta_E= -3.36  |g|= 0.452  |ddm|= 0.629
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.680505
diis-c [-0.46308682  1.        ]
  HOMO = -0.219229981260458  LUMO = 1.33928536333422
  mo_energy =
[-1.20196900e+02 -1.23063320e+01 -6.59617355e+00 -6.59617355e+00
 -6.59617355e+00 -1.16393265e+00 -2.19229981e-01 -2.19229981e-01
 -2.19229981e-01  1.33928536e+00  6.80341530e+00  2.66223587e+01
  1.35053461e+02  6.34146425e+02  2.77673916e+03  1.22532368e+04
  4.08720642e+04  1.04914187e+05  2.30096710e+05  4.55911044e+05
  8.44862870e+05  1.52803974e+06  2.85030666e+06  5.80819334e+06]
E1 = -706.7847583422176  E_coul = 198.80634241669182
cycle= 2 E= -507.978415925526  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.749
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0316061
diis-c [-9.91842307e-04 -3.93666714e-03  1.00393667e+00]
  HOMO = -0.240358123709739  LUMO = 1.33343840765463
  mo_energy =
[-1.20309658e+02 -1.23721495e+01 -6.66923645e+00 -6.66923645e+00
 -6.66923645e+00 -1.17740320e+00 -2.40358124e-01 -2.40358124e-01
 -2.40358124e-01  1.33343841e+00  6.77313061e+00  2.65622089e+01
  1.34958659e+02  6.34029744e+02  2.77660635e+03  1.22530938e+04
  4.08719174e+04  1.04914039e+05  2.30096561e+05  4.55910894e+05
  8.44862720e+05  1.52803959e+06  2.85030651e+06  5.80819319e+06]
E1 = -706.6878429184987  E_coul = 198.70921053887446
cycle= 3 E= -507.978632379624  delta_E= -0.000216  |g|= 0.00386  |ddm|= 0.118
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00334961
diis-c [-2.38256492e-06  1.37785025e-04 -1.04325738e-01  1.10418795e+00]
  HOMO = -0.243031582416769  LUMO = 1.33249693825738
  mo_energy =
[-1.20320186e+02 -1.23796999e+01 -6.67724219e+00 -6.67724219e+00
 -6.67724219e+00 -1.17900181e+00 -2.43031582e-01 -2.43031582e-01
 -2.43031582e-01  1.33249694e+00  6.76920815e+00  2.65553370e+01
  1.34949241e+02  6.34019085e+02  2.77659496e+03  1.22530820e+04
  4.08719054e+04  1.04914027e+05  2.30096549e+05  4.55910882e+05
  8.44862708e+05  1.52803957e+06  2.85030650e+06  5.80819318e+06]
E1 = -706.6756928501239  E_coul = 198.69705725813935
cycle= 4 E= -507.978635591985  delta_E= -3.21e-06  |g|= 0.00014  |ddm|= 0.0185
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000121853
diis-c [-8.55808939e-11 -5.95724215e-06  6.00442767e-03 -8.25073326e-02
  1.07650886e+00]
  HOMO = -0.243116407523972  LUMO = 1.33246100756184
  mo_energy =
[-1.20320366e+02 -1.23798980e+01 -6.67743335e+00 -6.67743335e+00
 -6.67743335e+00 -1.17905242e+00 -2.43116408e-01 -2.43116408e-01
 -2.43116408e-01  1.33246101e+00  6.76908290e+00  2.65551592e+01
  1.34949056e+02  6.34018906e+02  2.77659478e+03  1.22530818e+04
  4.08719052e+04  1.04914027e+05  2.30096549e+05  4.55910882e+05
  8.44862708e+05  1.52803957e+06  2.85030650e+06  5.80819318e+06]
E1 = -706.675320601607  E_coul = 198.69668500572743
cycle= 5 E= -507.97863559588  delta_E= -3.9e-09  |g|= 1.9e-06  |ddm|= 0.00085
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.59273e-07
diis-c [-1.20560418e-13  1.55239193e-07 -1.75398813e-04  2.22107102e-03
 -3.01055251e-02  1.02805970e+00]
  HOMO = -0.243117188877795  LUMO = 1.33246073575184
  mo_energy =
[-1.20320368e+02 -1.23798995e+01 -6.67743490e+00 -6.67743490e+00
 -6.67743490e+00 -1.17905301e+00 -2.43117189e-01 -2.43117189e-01
 -2.43117189e-01  1.33246074e+00  6.76908179e+00  2.65551578e+01
  1.34949055e+02  6.34018904e+02  2.77659478e+03  1.22530818e+04
  4.08719052e+04  1.04914027e+05  2.30096549e+05  4.55910882e+05
  8.44862708e+05  1.52803957e+06  2.85030650e+06  5.80819318e+06]
E1 = -706.6753172293492  E_coul = 198.69668163346842
cycle= 6 E= -507.978635595881  delta_E= -1.14e-12  |g|= 9.77e-08  |ddm|= 1.24e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6753172293492  E_coul = 198.69668163346842
  HOMO = -0.243117225946969  LUMO = 1.3324607126731
  mo_energy =
[-1.20320368e+02 -1.23798996e+01 -6.67743496e+00 -6.67743496e+00
 -6.67743496e+00 -1.17905303e+00 -2.43117226e-01 -2.43117226e-01
 -2.43117226e-01  1.33246071e+00  6.76908173e+00  2.65551577e+01
  1.34949055e+02  6.34018904e+02  2.77659478e+03  1.22530818e+04
  4.08719052e+04  1.04914027e+05  2.30096549e+05  4.55910882e+05
  8.44862708e+05  1.52803957e+06  2.85030650e+06  5.80819318e+06]
E1 = -706.6753170727499  E_coul = 198.69668147686897
Extra cycle  E= -507.978635595881  delta_E= -1.14e-13  |g|= 1.04e-08  |ddm|= 5.9e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.83928707e-01 9.90473030e-01 1.17616814e+05 1.52479635e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315073e+03 1.83757991e+04
 1.44908338e+03 3.76383230e+02 1.14432172e+02 3.93498942e+01
 9.65397849e+00 4.48578047e+00 8.60626303e+00 4.92561493e-01]
E = -507.97863559588086
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:09:54 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.283928706534       1
[INPUT] 0    0    [1    /1   ]  0.990473030279       1
[INPUT] 0    0    [1    /1   ]  117616.813863        1
[INPUT] 0    0    [1    /1   ]  1.52479635237        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031073        1
[INPUT] 0    0    [1    /1   ]  147020.991917        1
[INPUT] 0    0    [1    /1   ]  73510.4200108        1
[INPUT] 0    0    [1    /1   ]  36754.7148726        1
[INPUT] 0    0    [1    /1   ]  7303.15072803        1
[INPUT] 0    0    [1    /1   ]  18375.7991371        1
[INPUT] 0    0    [1    /1   ]  1449.08337829        1
[INPUT] 0    0    [1    /1   ]  376.383230332        1
[INPUT] 0    0    [1    /1   ]  114.432172061        1
[INPUT] 0    0    [1    /1   ]  39.3498941762        1
[INPUT] 0    0    [1    /1   ]  9.65397849116        1
[INPUT] 0    0    [1    /1   ]  4.48578047261        1
[INPUT] 1    0    [1    /1   ]  8.60626302636        1
[INPUT] 1    0    [1    /1   ]  0.492561493182       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.28392870653449204, 1.0]], [0, [0.9904730302794479, 1.0]], [0, [117616.81386305422, 1.0]], [0, [1.524796352370572, 1.0]], [0, [1176168.14261722, 1.0]], [0, [588084.0699823747, 1.0]], [0, [294042.0310729505, 1.0]], [0, [147020.99191671822, 1.0]], [0, [73510.42001077217, 1.0]], [0, [36754.71487262314, 1.0]], [0, [7303.150728030794, 1.0]], [0, [18375.799137081434, 1.0]], [0, [1449.0833782908403, 1.0]], [0, [376.38323033248776, 1.0]], [0, [114.43217206119088, 1.0]], [0, [39.34989417621343, 1.0]], [0, [9.653978491158718, 1.0]], [0, [4.485780472611963, 1.0]], [1, [8.606263026358828, 1.0]], [1, [0.49256149318223436, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.28392871]
bas 1, expnt(s) = [0.99047303]
bas 2, expnt(s) = [117616.81386305]
bas 3, expnt(s) = [1.52479635]
bas 4, expnt(s) = [1176168.14261722]
bas 5, expnt(s) = [588084.06998237]
bas 6, expnt(s) = [294042.03107295]
bas 7, expnt(s) = [147020.99191672]
bas 8, expnt(s) = [73510.42001077]
bas 9, expnt(s) = [36754.71487262]
bas 10, expnt(s) = [7303.15072803]
bas 11, expnt(s) = [18375.79913708]
bas 12, expnt(s) = [1449.08337829]
bas 13, expnt(s) = [376.38323033]
bas 14, expnt(s) = [114.43217206]
bas 15, expnt(s) = [39.34989418]
bas 16, expnt(s) = [9.65397849]
bas 17, expnt(s) = [4.48578047]
bas 18, expnt(s) = [8.60626303]
bas 19, expnt(s) = [0.49256149]
CPU time:       398.36
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.83928707e-01 9.82702367e-01 9.90473030e-01 2.50840129e+00
 1.17616814e+05 1.60460109e+04 1.52479635e+00 3.46676104e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656005e+03
 7.30315073e+03 1.99594111e+03 1.83757991e+04 3.98749086e+03
 1.44908338e+03 5.93382939e+02 3.76383230e+02 2.15892583e+02
 1.14432172e+02 8.83946805e+01 3.93498942e+01 3.96938022e+01
 9.65397849e+00 1.38370901e+01 4.48578047e+00 7.78741889e+00
 8.60626303e+00 4.30033869e+01 4.92561493e-01 1.20381559e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.3357003625972
cond(S) = 908136.7109435337
E1 = -689.5825392946991  E_coul = 184.97660652324805
init E= -504.605932771451
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672281741198712  LUMO = 0.933038272648417
  mo_energy =
[-1.21703632e+02 -1.33852647e+01 -7.62317472e+00 -7.62317472e+00
 -7.62317472e+00 -1.65678306e+00 -6.72281741e-01 -6.72281741e-01
 -6.72281741e-01  9.33038273e-01  6.15390470e+00  2.56078875e+01
  1.33657749e+02  6.32656069e+02  2.77530901e+03  1.22519156e+04
  4.08708095e+04  1.04912969e+05  2.30095517e+05  4.55909867e+05
  8.44861707e+05  1.52803858e+06  2.85030552e+06  5.80819221e+06]
E1 = -707.7110369406322  E_coul = 199.75001808071212
cycle= 1 E= -507.96101885992  delta_E= -3.36  |g|= 0.452  |ddm|= 0.629
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.680505
diis-c [-0.46308682  1.        ]
  HOMO = -0.219229981260458  LUMO = 1.33928536333422
  mo_energy =
[-1.20196900e+02 -1.23063320e+01 -6.59617355e+00 -6.59617355e+00
 -6.59617355e+00 -1.16393265e+00 -2.19229981e-01 -2.19229981e-01
 -2.19229981e-01  1.33928536e+00  6.80341530e+00  2.66223587e+01
  1.35053461e+02  6.34146425e+02  2.77673916e+03  1.22532368e+04
  4.08720642e+04  1.04914187e+05  2.30096710e+05  4.55911044e+05
  8.44862870e+05  1.52803974e+06  2.85030666e+06  5.80819334e+06]
E1 = -706.7847583422176  E_coul = 198.80634241669182
cycle= 2 E= -507.978415925526  delta_E= -0.0174  |g|= 0.0344  |ddm|= 0.749
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0316061
diis-c [-9.91842307e-04 -3.93666714e-03  1.00393667e+00]
  HOMO = -0.240358123709739  LUMO = 1.33343840765463
  mo_energy =
[-1.20309658e+02 -1.23721495e+01 -6.66923645e+00 -6.66923645e+00
 -6.66923645e+00 -1.17740320e+00 -2.40358124e-01 -2.40358124e-01
 -2.40358124e-01  1.33343841e+00  6.77313061e+00  2.65622089e+01
  1.34958659e+02  6.34029744e+02  2.77660635e+03  1.22530938e+04
  4.08719174e+04  1.04914039e+05  2.30096561e+05  4.55910894e+05
  8.44862720e+05  1.52803959e+06  2.85030651e+06  5.80819319e+06]
E1 = -706.6878429184987  E_coul = 198.70921053887446
cycle= 3 E= -507.978632379624  delta_E= -0.000216  |g|= 0.00386  |ddm|= 0.118
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00334961
diis-c [-2.38256492e-06  1.37785025e-04 -1.04325738e-01  1.10418795e+00]
  HOMO = -0.243031582416769  LUMO = 1.33249693825738
  mo_energy =
[-1.20320186e+02 -1.23796999e+01 -6.67724219e+00 -6.67724219e+00
 -6.67724219e+00 -1.17900181e+00 -2.43031582e-01 -2.43031582e-01
 -2.43031582e-01  1.33249694e+00  6.76920815e+00  2.65553370e+01
  1.34949241e+02  6.34019085e+02  2.77659496e+03  1.22530820e+04
  4.08719054e+04  1.04914027e+05  2.30096549e+05  4.55910882e+05
  8.44862708e+05  1.52803957e+06  2.85030650e+06  5.80819318e+06]
E1 = -706.6756928501239  E_coul = 198.69705725813935
cycle= 4 E= -507.978635591985  delta_E= -3.21e-06  |g|= 0.00014  |ddm|= 0.0185
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000121853
diis-c [-8.55808939e-11 -5.95724215e-06  6.00442767e-03 -8.25073326e-02
  1.07650886e+00]
  HOMO = -0.243116407523972  LUMO = 1.33246100756184
  mo_energy =
[-1.20320366e+02 -1.23798980e+01 -6.67743335e+00 -6.67743335e+00
 -6.67743335e+00 -1.17905242e+00 -2.43116408e-01 -2.43116408e-01
 -2.43116408e-01  1.33246101e+00  6.76908290e+00  2.65551592e+01
  1.34949056e+02  6.34018906e+02  2.77659478e+03  1.22530818e+04
  4.08719052e+04  1.04914027e+05  2.30096549e+05  4.55910882e+05
  8.44862708e+05  1.52803957e+06  2.85030650e+06  5.80819318e+06]
E1 = -706.675320601607  E_coul = 198.69668500572743
cycle= 5 E= -507.97863559588  delta_E= -3.9e-09  |g|= 1.9e-06  |ddm|= 0.00085
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.59273e-07
diis-c [-1.20560418e-13  1.55239193e-07 -1.75398813e-04  2.22107102e-03
 -3.01055251e-02  1.02805970e+00]
  HOMO = -0.243117188877795  LUMO = 1.33246073575184
  mo_energy =
[-1.20320368e+02 -1.23798995e+01 -6.67743490e+00 -6.67743490e+00
 -6.67743490e+00 -1.17905301e+00 -2.43117189e-01 -2.43117189e-01
 -2.43117189e-01  1.33246074e+00  6.76908179e+00  2.65551578e+01
  1.34949055e+02  6.34018904e+02  2.77659478e+03  1.22530818e+04
  4.08719052e+04  1.04914027e+05  2.30096549e+05  4.55910882e+05
  8.44862708e+05  1.52803957e+06  2.85030650e+06  5.80819318e+06]
E1 = -706.6753172293492  E_coul = 198.69668163346842
cycle= 6 E= -507.978635595881  delta_E= -1.14e-12  |g|= 9.77e-08  |ddm|= 1.24e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6753172293492  E_coul = 198.69668163346842
  HOMO = -0.243117225946969  LUMO = 1.3324607126731
  mo_energy =
[-1.20320368e+02 -1.23798996e+01 -6.67743496e+00 -6.67743496e+00
 -6.67743496e+00 -1.17905303e+00 -2.43117226e-01 -2.43117226e-01
 -2.43117226e-01  1.33246071e+00  6.76908173e+00  2.65551577e+01
  1.34949055e+02  6.34018904e+02  2.77659478e+03  1.22530818e+04
  4.08719052e+04  1.04914027e+05  2.30096549e+05  4.55910882e+05
  8.44862708e+05  1.52803957e+06  2.85030650e+06  5.80819318e+06]
E1 = -706.6753170727499  E_coul = 198.69668147686897
Extra cycle  E= -507.978635595881  delta_E= -1.14e-13  |g|= 1.04e-08  |ddm|= 5.9e-07
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908136.7109435337
E1 = -706.6753170727499  E_coul = 198.69668147686897
init E= -507.978635595881
    CPU time for initialize scf      3.29 sec, wall time      0.21 sec
  HOMO = -0.243117231052343  LUMO = 1.33246071181033
  mo_energy =
[-1.20320368e+02 -1.23798996e+01 -6.67743498e+00 -6.67743498e+00
 -6.67743498e+00 -1.17905303e+00 -2.43117231e-01 -2.43117231e-01
 -2.43117231e-01  1.33246071e+00  6.76908173e+00  2.65551577e+01
  1.34949055e+02  6.34018904e+02  2.77659478e+03  1.22530818e+04
  4.08719052e+04  1.04914027e+05  2.30096549e+05  4.55910882e+05
  8.44862708e+05  1.52803957e+06  2.85030650e+06  5.80819318e+06]
E1 = -706.6753170497879  E_coul = 198.6966814539071
cycle= 1 E= -507.978635595881  delta_E= 1.14e-13  |g|= 1.27e-09  |ddm|= 6.34e-08
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.6753170497879  E_coul = 198.6966814539071
  HOMO = -0.243117231751803  LUMO = 1.33246071177326
  mo_energy =
[-1.20320368e+02 -1.23798996e+01 -6.67743498e+00 -6.67743498e+00
 -6.67743498e+00 -1.17905303e+00 -2.43117232e-01 -2.43117232e-01
 -2.43117232e-01  1.33246071e+00  6.76908172e+00  2.65551577e+01
  1.34949055e+02  6.34018904e+02  2.77659478e+03  1.22530818e+04
  4.08719052e+04  1.04914027e+05  2.30096549e+05  4.55910882e+05
  8.44862708e+05  1.52803957e+06  2.85030650e+06  5.80819318e+06]
E1 = -706.6753170459012  E_coul = 198.69668145002046
Extra cycle  E= -507.978635595881  delta_E=    0  |g|= 1.27e-09  |ddm|= 8.11e-09
    CPU time for scf_cycle      3.73 sec, wall time      0.38 sec
exp = [2.83928707e-01 9.90473030e-01 1.17616814e+05 1.52479635e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30315073e+03 1.83757991e+04
 1.44908338e+03 3.76383230e+02 1.14432172e+02 3.93498942e+01
 9.65397849e+00 4.48578047e+00 8.60626303e+00 4.92561493e-01]
grad_E = [-1.02182684e-02  2.99011998e-03  4.57061607e-09 -4.98939886e-04
  2.33457920e-11  1.25395206e-10  7.10749745e-10  2.79188512e-09
  1.16137762e-08  6.20064862e-08  3.93156959e-06  1.37890508e-07
 -1.15010367e-05  1.69369121e-04 -9.39872789e-04  7.84168528e-04
 -1.02617263e-03  2.08030260e-04  1.95719873e-03 -5.00639589e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:10:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.287096539481       1
[INPUT] 0    0    [1    /1   ]  1.00107900612        1
[INPUT] 0    0    [1    /1   ]  117616.813862        1
[INPUT] 0    0    [1    /1   ]  1.66555316896        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031073        1
[INPUT] 0    0    [1    /1   ]  147020.991916        1
[INPUT] 0    0    [1    /1   ]  73510.4200082        1
[INPUT] 0    0    [1    /1   ]  36754.7148588        1
[INPUT] 0    0    [1    /1   ]  7303.1498569         1
[INPUT] 0    0    [1    /1   ]  18375.7991067        1
[INPUT] 0    0    [1    /1   ]  1449.08451707        1
[INPUT] 0    0    [1    /1   ]  376.365974394        1
[INPUT] 0    0    [1    /1   ]  114.517154408        1
[INPUT] 0    0    [1    /1   ]  39.3634282763        1
[INPUT] 0    0    [1    /1   ]  9.89971328202        1
[INPUT] 0    0    [1    /1   ]  4.66845128968        1
[INPUT] 1    0    [1    /1   ]  8.60669536124        1
[INPUT] 1    0    [1    /1   ]  0.492532439276       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2870965394805202, 1.0]], [0, [1.0010790061152268, 1.0]], [0, [117616.81386203994, 1.0]], [0, [1.6655531689625764, 1.0]], [0, [1176168.1426172152, 1.0]], [0, [588084.069982347, 1.0]], [0, [294042.0310727928, 1.0]], [0, [147020.99191609886, 1.0]], [0, [73510.42000819682, 1.0]], [0, [36754.714858841406, 1.0]], [0, [7303.149856895479, 1.0]], [0, [18375.799106747334, 1.0]], [0, [1449.0845170748678, 1.0]], [0, [376.3659743939924, 1.0]], [0, [114.51715440771193, 1.0]], [0, [39.36342827630676, 1.0]], [0, [9.899713282020025, 1.0]], [0, [4.668451289684445, 1.0]], [1, [8.606695361241565, 1.0]], [1, [0.492532439275775, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.28709654]
bas 1, expnt(s) = [1.00107901]
bas 2, expnt(s) = [117616.81386204]
bas 3, expnt(s) = [1.66555317]
bas 4, expnt(s) = [1176168.14261722]
bas 5, expnt(s) = [588084.06998235]
bas 6, expnt(s) = [294042.03107279]
bas 7, expnt(s) = [147020.9919161]
bas 8, expnt(s) = [73510.4200082]
bas 9, expnt(s) = [36754.71485884]
bas 10, expnt(s) = [7303.1498569]
bas 11, expnt(s) = [18375.79910675]
bas 12, expnt(s) = [1449.08451707]
bas 13, expnt(s) = [376.36597439]
bas 14, expnt(s) = [114.51715441]
bas 15, expnt(s) = [39.36342828]
bas 16, expnt(s) = [9.89971328]
bas 17, expnt(s) = [4.66845129]
bas 18, expnt(s) = [8.60669536]
bas 19, expnt(s) = [0.49253244]
CPU time:       409.86
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.87096539e-01 9.90914064e-01 1.00107901e+00 2.52851940e+00
 1.17616814e+05 1.60460109e+04 1.66555317e+00 3.70411021e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656005e+03
 7.30314986e+03 1.99594093e+03 1.83757991e+04 3.98749085e+03
 1.44908452e+03 5.93383289e+02 3.76365974e+02 2.15885160e+02
 1.14517154e+02 8.84439102e+01 3.93634283e+01 3.97040410e+01
 9.89971328e+00 1.41004180e+01 4.66845129e+00 8.02406888e+00
 8.60669536e+00 4.30060872e+01 4.92532439e-01 1.20372683e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33566811794268
cond(S) = 908171.5724181457
E1 = -689.5864064094692  E_coul = 184.97743202739176
init E= -504.608974382077
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.67232222209483  LUMO = 0.978952227935908
  mo_energy =
[-1.21703553e+02 -1.33852089e+01 -7.62311472e+00 -7.62311472e+00
 -7.62311472e+00 -1.65665027e+00 -6.72322222e-01 -6.72322222e-01
 -6.72322222e-01  9.78952228e-01  6.56880141e+00  2.70612264e+01
  1.36107038e+02  6.35145855e+02  2.77757228e+03  1.22538987e+04
  4.08726448e+04  1.04914728e+05  2.30097226e+05  4.55911541e+05
  8.44863353e+05  1.52804020e+06  2.85030710e+06  5.80819375e+06]
E1 = -707.7070898857603  E_coul = 199.74574281558054
cycle= 1 E= -507.96134707018  delta_E= -3.35  |g|= 0.452  |ddm|= 0.554
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.684202
diis-c [-0.46813295  1.        ]
  HOMO = -0.219491258788029  LUMO = 1.39340117449563
  mo_energy =
[-1.20197344e+02 -1.23065855e+01 -6.59641491e+00 -6.59641491e+00
 -6.59641491e+00 -1.16401984e+00 -2.19491259e-01 -2.19491259e-01
 -2.19491259e-01  1.39340117e+00  7.23454621e+00  2.80865645e+01
  1.37502423e+02  6.36635343e+02  2.77900164e+03  1.22552191e+04
  4.08738985e+04  1.04915945e+05  2.30098419e+05  4.55912716e+05
  8.44864515e+05  1.52804135e+06  2.85030824e+06  5.80819489e+06]
E1 = -706.7832071628239  E_coul = 198.8044949027114
cycle= 2 E= -507.978712260113  delta_E= -0.0174  |g|= 0.0343  |ddm|= 0.659
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0311757
diis-c [-9.64931631e-04 -3.88466319e-03  1.00388466e+00]
  HOMO = -0.240506439090656  LUMO = 1.38717602198052
  mo_energy =
[-1.20309929e+02 -1.23722383e+01 -6.66931480e+00 -6.66931480e+00
 -6.66931480e+00 -1.17740442e+00 -2.40506439e-01 -2.40506439e-01
 -2.40506439e-01  1.38717602e+00  7.20296452e+00  2.80255850e+01
  1.37407708e+02  6.36518851e+02  2.77886901e+03  1.22550762e+04
  4.08737519e+04  1.04915797e+05  2.30098270e+05  4.55912567e+05
  8.44864365e+05  1.52804120e+06  2.85030809e+06  5.80819474e+06]
E1 = -706.6873818488964  E_coul = 198.70845734890892
cycle= 3 E= -507.978924499987  delta_E= -0.000212  |g|= 0.00381  |ddm|= 0.0981
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324006
diis-c [-2.32925943e-06  1.72496730e-04 -1.01511799e-01  1.10133930e+00]
  HOMO = -0.243128862406904  LUMO = 1.38620036553649
  mo_energy =
[-1.20320334e+02 -1.23796853e+01 -6.67721513e+00 -6.67721513e+00
 -6.67721513e+00 -1.17897004e+00 -2.43128862e-01 -2.43128862e-01
 -2.43128862e-01  1.38620037e+00  7.19895011e+00  2.80187239e+01
  1.37398400e+02  6.36508317e+02  2.77885774e+03  1.22550645e+04
  4.08737400e+04  1.04915785e+05  2.30098258e+05  4.55912555e+05
  8.44864353e+05  1.52804119e+06  2.85030808e+06  5.80819473e+06]
E1 = -706.675531906572  E_coul = 198.6966043357095
cycle= 4 E= -507.978927570863  delta_E= -3.07e-06  |g|= 0.00014  |ddm|= 0.0148
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122467
diis-c [-8.07449312e-11 -5.56766007e-06  5.91831162e-03 -8.39377147e-02
  1.07802497e+00]
  HOMO = -0.243215519951884  LUMO = 1.38616254580316
  mo_energy =
[-1.20320531e+02 -1.23798927e+01 -6.67741690e+00 -6.67741690e+00
 -6.67741690e+00 -1.17902167e+00 -2.43215520e-01 -2.43215520e-01
 -2.43215520e-01  1.38616255e+00  7.19881756e+00  2.80185366e+01
  1.37398201e+02  6.36508120e+02  2.77885754e+03  1.22550643e+04
  4.08737398e+04  1.04915785e+05  2.30098258e+05  4.55912555e+05
  8.44864353e+05  1.52804119e+06  2.85030808e+06  5.80819473e+06]
E1 = -706.6751532412567  E_coul = 198.69622566650852
cycle= 5 E= -507.978927574748  delta_E= -3.89e-09  |g|= 1.53e-06  |ddm|= 0.000671
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.49718e-07
diis-c [-8.47995798e-14  1.59307348e-07 -1.42354653e-04  1.84919787e-03
 -2.46094207e-02  1.02290242e+00]
  HOMO = -0.243216158903347  LUMO = 1.38616232715685
  mo_energy =
[-1.20320533e+02 -1.23798940e+01 -6.67741820e+00 -6.67741820e+00
 -6.67741820e+00 -1.17902216e+00 -2.43216159e-01 -2.43216159e-01
 -2.43216159e-01  1.38616233e+00  7.19881663e+00  2.80185354e+01
  1.37398200e+02  6.36508118e+02  2.77885754e+03  1.22550643e+04
  4.08737398e+04  1.04915785e+05  2.30098258e+05  4.55912555e+05
  8.44864353e+05  1.52804119e+06  2.85030808e+06  5.80819473e+06]
E1 = -706.6751505213944  E_coul = 198.69622294664563
cycle= 6 E= -507.978927574749  delta_E= -5.68e-13  |g|= 8e-08  |ddm|= 7.76e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6751505213944  E_coul = 198.69622294664563
  HOMO = -0.243216189756695  LUMO = 1.38616230866144
  mo_energy =
[-1.20320533e+02 -1.23798941e+01 -6.67741826e+00 -6.67741826e+00
 -6.67741826e+00 -1.17902218e+00 -2.43216190e-01 -2.43216190e-01
 -2.43216190e-01  1.38616231e+00  7.19881658e+00  2.80185353e+01
  1.37398200e+02  6.36508118e+02  2.77885754e+03  1.22550643e+04
  4.08737398e+04  1.04915785e+05  2.30098258e+05  4.55912555e+05
  8.44864353e+05  1.52804119e+06  2.85030808e+06  5.80819473e+06]
E1 = -706.6751503912907  E_coul = 198.6962228165422
Extra cycle  E= -507.978927574748  delta_E= 2.27e-13  |g|= 8.24e-09  |ddm|= 3.8e-07
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
exp = [2.87096539e-01 1.00107901e+00 1.17616814e+05 1.66555317e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30314986e+03 1.83757991e+04
 1.44908452e+03 3.76365974e+02 1.14517154e+02 3.93634283e+01
 9.89971328e+00 4.66845129e+00 8.60669536e+00 4.92532439e-01]
E = -507.97892757474847
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:10:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.287096539481       1
[INPUT] 0    0    [1    /1   ]  1.00107900612        1
[INPUT] 0    0    [1    /1   ]  117616.813862        1
[INPUT] 0    0    [1    /1   ]  1.66555316896        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031073        1
[INPUT] 0    0    [1    /1   ]  147020.991916        1
[INPUT] 0    0    [1    /1   ]  73510.4200082        1
[INPUT] 0    0    [1    /1   ]  36754.7148588        1
[INPUT] 0    0    [1    /1   ]  7303.1498569         1
[INPUT] 0    0    [1    /1   ]  18375.7991067        1
[INPUT] 0    0    [1    /1   ]  1449.08451707        1
[INPUT] 0    0    [1    /1   ]  376.365974394        1
[INPUT] 0    0    [1    /1   ]  114.517154408        1
[INPUT] 0    0    [1    /1   ]  39.3634282763        1
[INPUT] 0    0    [1    /1   ]  9.89971328202        1
[INPUT] 0    0    [1    /1   ]  4.66845128968        1
[INPUT] 1    0    [1    /1   ]  8.60669536124        1
[INPUT] 1    0    [1    /1   ]  0.492532439276       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2870965394805202, 1.0]], [0, [1.0010790061152268, 1.0]], [0, [117616.81386203994, 1.0]], [0, [1.6655531689625764, 1.0]], [0, [1176168.1426172152, 1.0]], [0, [588084.069982347, 1.0]], [0, [294042.0310727928, 1.0]], [0, [147020.99191609886, 1.0]], [0, [73510.42000819682, 1.0]], [0, [36754.714858841406, 1.0]], [0, [7303.149856895479, 1.0]], [0, [18375.799106747334, 1.0]], [0, [1449.0845170748678, 1.0]], [0, [376.3659743939924, 1.0]], [0, [114.51715440771193, 1.0]], [0, [39.36342827630676, 1.0]], [0, [9.899713282020025, 1.0]], [0, [4.668451289684445, 1.0]], [1, [8.606695361241565, 1.0]], [1, [0.492532439275775, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.28709654]
bas 1, expnt(s) = [1.00107901]
bas 2, expnt(s) = [117616.81386204]
bas 3, expnt(s) = [1.66555317]
bas 4, expnt(s) = [1176168.14261722]
bas 5, expnt(s) = [588084.06998235]
bas 6, expnt(s) = [294042.03107279]
bas 7, expnt(s) = [147020.9919161]
bas 8, expnt(s) = [73510.4200082]
bas 9, expnt(s) = [36754.71485884]
bas 10, expnt(s) = [7303.1498569]
bas 11, expnt(s) = [18375.79910675]
bas 12, expnt(s) = [1449.08451707]
bas 13, expnt(s) = [376.36597439]
bas 14, expnt(s) = [114.51715441]
bas 15, expnt(s) = [39.36342828]
bas 16, expnt(s) = [9.89971328]
bas 17, expnt(s) = [4.66845129]
bas 18, expnt(s) = [8.60669536]
bas 19, expnt(s) = [0.49253244]
CPU time:       411.16
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.87096539e-01 9.90914064e-01 1.00107901e+00 2.52851940e+00
 1.17616814e+05 1.60460109e+04 1.66555317e+00 3.70411021e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547149e+04 6.70656005e+03
 7.30314986e+03 1.99594093e+03 1.83757991e+04 3.98749085e+03
 1.44908452e+03 5.93383289e+02 3.76365974e+02 2.15885160e+02
 1.14517154e+02 8.84439102e+01 3.93634283e+01 3.97040410e+01
 9.89971328e+00 1.41004180e+01 4.66845129e+00 8.02406888e+00
 8.60669536e+00 4.30060872e+01 4.92532439e-01 1.20372683e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33566811794268
cond(S) = 908171.5724181457
E1 = -689.5864064094692  E_coul = 184.97743202739176
init E= -504.608974382077
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.67232222209483  LUMO = 0.978952227935908
  mo_energy =
[-1.21703553e+02 -1.33852089e+01 -7.62311472e+00 -7.62311472e+00
 -7.62311472e+00 -1.65665027e+00 -6.72322222e-01 -6.72322222e-01
 -6.72322222e-01  9.78952228e-01  6.56880141e+00  2.70612264e+01
  1.36107038e+02  6.35145855e+02  2.77757228e+03  1.22538987e+04
  4.08726448e+04  1.04914728e+05  2.30097226e+05  4.55911541e+05
  8.44863353e+05  1.52804020e+06  2.85030710e+06  5.80819375e+06]
E1 = -707.7070898857603  E_coul = 199.74574281558054
cycle= 1 E= -507.96134707018  delta_E= -3.35  |g|= 0.452  |ddm|= 0.554
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.684202
diis-c [-0.46813295  1.        ]
  HOMO = -0.219491258788029  LUMO = 1.39340117449563
  mo_energy =
[-1.20197344e+02 -1.23065855e+01 -6.59641491e+00 -6.59641491e+00
 -6.59641491e+00 -1.16401984e+00 -2.19491259e-01 -2.19491259e-01
 -2.19491259e-01  1.39340117e+00  7.23454621e+00  2.80865645e+01
  1.37502423e+02  6.36635343e+02  2.77900164e+03  1.22552191e+04
  4.08738985e+04  1.04915945e+05  2.30098419e+05  4.55912716e+05
  8.44864515e+05  1.52804135e+06  2.85030824e+06  5.80819489e+06]
E1 = -706.7832071628239  E_coul = 198.8044949027114
cycle= 2 E= -507.978712260113  delta_E= -0.0174  |g|= 0.0343  |ddm|= 0.659
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0311757
diis-c [-9.64931631e-04 -3.88466319e-03  1.00388466e+00]
  HOMO = -0.240506439090656  LUMO = 1.38717602198052
  mo_energy =
[-1.20309929e+02 -1.23722383e+01 -6.66931480e+00 -6.66931480e+00
 -6.66931480e+00 -1.17740442e+00 -2.40506439e-01 -2.40506439e-01
 -2.40506439e-01  1.38717602e+00  7.20296452e+00  2.80255850e+01
  1.37407708e+02  6.36518851e+02  2.77886901e+03  1.22550762e+04
  4.08737519e+04  1.04915797e+05  2.30098270e+05  4.55912567e+05
  8.44864365e+05  1.52804120e+06  2.85030809e+06  5.80819474e+06]
E1 = -706.6873818488964  E_coul = 198.70845734890892
cycle= 3 E= -507.978924499987  delta_E= -0.000212  |g|= 0.00381  |ddm|= 0.0981
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324006
diis-c [-2.32925943e-06  1.72496730e-04 -1.01511799e-01  1.10133930e+00]
  HOMO = -0.243128862406904  LUMO = 1.38620036553649
  mo_energy =
[-1.20320334e+02 -1.23796853e+01 -6.67721513e+00 -6.67721513e+00
 -6.67721513e+00 -1.17897004e+00 -2.43128862e-01 -2.43128862e-01
 -2.43128862e-01  1.38620037e+00  7.19895011e+00  2.80187239e+01
  1.37398400e+02  6.36508317e+02  2.77885774e+03  1.22550645e+04
  4.08737400e+04  1.04915785e+05  2.30098258e+05  4.55912555e+05
  8.44864353e+05  1.52804119e+06  2.85030808e+06  5.80819473e+06]
E1 = -706.675531906572  E_coul = 198.6966043357095
cycle= 4 E= -507.978927570863  delta_E= -3.07e-06  |g|= 0.00014  |ddm|= 0.0148
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122467
diis-c [-8.07449312e-11 -5.56766007e-06  5.91831162e-03 -8.39377147e-02
  1.07802497e+00]
  HOMO = -0.243215519951884  LUMO = 1.38616254580316
  mo_energy =
[-1.20320531e+02 -1.23798927e+01 -6.67741690e+00 -6.67741690e+00
 -6.67741690e+00 -1.17902167e+00 -2.43215520e-01 -2.43215520e-01
 -2.43215520e-01  1.38616255e+00  7.19881756e+00  2.80185366e+01
  1.37398201e+02  6.36508120e+02  2.77885754e+03  1.22550643e+04
  4.08737398e+04  1.04915785e+05  2.30098258e+05  4.55912555e+05
  8.44864353e+05  1.52804119e+06  2.85030808e+06  5.80819473e+06]
E1 = -706.6751532412567  E_coul = 198.69622566650852
cycle= 5 E= -507.978927574748  delta_E= -3.89e-09  |g|= 1.53e-06  |ddm|= 0.000671
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.49718e-07
diis-c [-8.47995798e-14  1.59307348e-07 -1.42354653e-04  1.84919787e-03
 -2.46094207e-02  1.02290242e+00]
  HOMO = -0.243216158903347  LUMO = 1.38616232715685
  mo_energy =
[-1.20320533e+02 -1.23798940e+01 -6.67741820e+00 -6.67741820e+00
 -6.67741820e+00 -1.17902216e+00 -2.43216159e-01 -2.43216159e-01
 -2.43216159e-01  1.38616233e+00  7.19881663e+00  2.80185354e+01
  1.37398200e+02  6.36508118e+02  2.77885754e+03  1.22550643e+04
  4.08737398e+04  1.04915785e+05  2.30098258e+05  4.55912555e+05
  8.44864353e+05  1.52804119e+06  2.85030808e+06  5.80819473e+06]
E1 = -706.6751505213944  E_coul = 198.69622294664563
cycle= 6 E= -507.978927574749  delta_E= -5.68e-13  |g|= 8e-08  |ddm|= 7.76e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6751505213944  E_coul = 198.69622294664563
  HOMO = -0.243216189756695  LUMO = 1.38616230866144
  mo_energy =
[-1.20320533e+02 -1.23798941e+01 -6.67741826e+00 -6.67741826e+00
 -6.67741826e+00 -1.17902218e+00 -2.43216190e-01 -2.43216190e-01
 -2.43216190e-01  1.38616231e+00  7.19881658e+00  2.80185353e+01
  1.37398200e+02  6.36508118e+02  2.77885754e+03  1.22550643e+04
  4.08737398e+04  1.04915785e+05  2.30098258e+05  4.55912555e+05
  8.44864353e+05  1.52804119e+06  2.85030808e+06  5.80819473e+06]
E1 = -706.6751503912907  E_coul = 198.6962228165422
Extra cycle  E= -507.978927574748  delta_E= 2.27e-13  |g|= 8.24e-09  |ddm|= 3.8e-07
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908171.5724181457
E1 = -706.6751503912907  E_coul = 198.6962228165422
init E= -507.978927574748
    CPU time for initialize scf      3.28 sec, wall time      0.21 sec
  HOMO = -0.243216193942886  LUMO = 1.38616230892701
  mo_energy =
[-1.20320533e+02 -1.23798941e+01 -6.67741827e+00 -6.67741827e+00
 -6.67741827e+00 -1.17902218e+00 -2.43216194e-01 -2.43216194e-01
 -2.43216194e-01  1.38616231e+00  7.19881658e+00  2.80185353e+01
  1.37398200e+02  6.36508118e+02  2.77885754e+03  1.22550643e+04
  4.08737398e+04  1.04915785e+05  2.30098258e+05  4.55912555e+05
  8.44864353e+05  1.52804119e+06  2.85030808e+06  5.80819473e+06]
E1 = -706.6751503740445  E_coul = 198.6962227992958
cycle= 1 E= -507.978927574749  delta_E= -2.27e-13  |g|= 2.03e-09  |ddm|= 3.86e-08
    CPU time for cycle= 1      0.32 sec, wall time      0.03 sec
E1 = -706.6751503740445  E_coul = 198.6962227992958
  HOMO = -0.24321619447717  LUMO = 1.38616230688358
  mo_energy =
[-1.20320533e+02 -1.23798941e+01 -6.67741827e+00 -6.67741827e+00
 -6.67741827e+00 -1.17902218e+00 -2.43216194e-01 -2.43216194e-01
 -2.43216194e-01  1.38616231e+00  7.19881657e+00  2.80185353e+01
  1.37398200e+02  6.36508118e+02  2.77885754e+03  1.22550643e+04
  4.08737398e+04  1.04915785e+05  2.30098258e+05  4.55912555e+05
  8.44864353e+05  1.52804119e+06  2.85030808e+06  5.80819473e+06]
E1 = -706.6751503726136  E_coul = 198.69622279786535
Extra cycle  E= -507.978927574748  delta_E= 3.98e-13  |g|= 1.42e-09  |ddm|= 2.87e-09
    CPU time for scf_cycle      3.74 sec, wall time      0.37 sec
exp = [2.87096539e-01 1.00107901e+00 1.17616814e+05 1.66555317e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547149e+04 7.30314986e+03 1.83757991e+04
 1.44908452e+03 3.76365974e+02 1.14517154e+02 3.93634283e+01
 9.89971328e+00 4.66845129e+00 8.60669536e+00 4.92532439e-01]
grad_E = [-1.38921199e-02  3.99982212e-03  4.52750419e-09 -5.56315839e-04
  2.28413061e-11  1.23992531e-10  7.04091600e-10  2.76522820e-09
  1.15013100e-08  6.14546234e-08  3.89303883e-06  1.36183399e-07
 -9.39212550e-06  1.39578821e-04 -7.54684545e-04  2.47590498e-04
 -9.23192904e-04  7.47050286e-04  2.30393136e-03 -6.28661892e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:10:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.287486453358       1
[INPUT] 0    0    [1    /1   ]  0.938141900802       1
[INPUT] 0    0    [1    /1   ]  117616.813859        1
[INPUT] 0    0    [1    /1   ]  2.03391397304        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031072        1
[INPUT] 0    0    [1    /1   ]  147020.991914        1
[INPUT] 0    0    [1    /1   ]  73510.4200004        1
[INPUT] 0    0    [1    /1   ]  36754.7148169        1
[INPUT] 0    0    [1    /1   ]  7303.14720566        1
[INPUT] 0    0    [1    /1   ]  18375.7990145        1
[INPUT] 0    0    [1    /1   ]  1449.0876918         1
[INPUT] 0    0    [1    /1   ]  376.317771588        1
[INPUT] 0    0    [1    /1   ]  114.745686206        1
[INPUT] 0    0    [1    /1   ]  39.4908275949        1
[INPUT] 0    0    [1    /1   ]  10.7119444601        1
[INPUT] 0    0    [1    /1   ]  5.14916981858        1
[INPUT] 1    0    [1    /1   ]  8.60730776076        1
[INPUT] 1    0    [1    /1   ]  0.492490628107       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.28748645335797796, 1.0]], [0, [0.9381419008018442, 1.0]], [0, [117616.81385895271, 1.0]], [0, [2.0339139730421554, 1.0]], [0, [1176168.1426172, 1.0]], [0, [588084.0699822628, 1.0]], [0, [294042.0310723126, 1.0]], [0, [147020.99191421378, 1.0]], [0, [73510.42000035848, 1.0]], [0, [36754.71481688893, 1.0]], [0, [7303.147205657794, 1.0]], [0, [18375.79901447303, 1.0]], [0, [1449.0876917974522, 1.0]], [0, [376.3177715880471, 1.0]], [0, [114.74568620639052, 1.0]], [0, [39.49082759487882, 1.0]], [0, [10.711944460059986, 1.0]], [0, [5.149169818583547, 1.0]], [1, [8.60730776075521, 1.0]], [1, [0.49249062810690436, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.28748645]
bas 1, expnt(s) = [0.9381419]
bas 2, expnt(s) = [117616.81385895]
bas 3, expnt(s) = [2.03391397]
bas 4, expnt(s) = [1176168.1426172]
bas 5, expnt(s) = [588084.06998226]
bas 6, expnt(s) = [294042.03107231]
bas 7, expnt(s) = [147020.99191421]
bas 8, expnt(s) = [73510.42000036]
bas 9, expnt(s) = [36754.71481689]
bas 10, expnt(s) = [7303.14720566]
bas 11, expnt(s) = [18375.79901447]
bas 12, expnt(s) = [1449.0876918]
bas 13, expnt(s) = [376.31777159]
bas 14, expnt(s) = [114.74568621]
bas 15, expnt(s) = [39.49082759]
bas 16, expnt(s) = [10.71194446]
bas 17, expnt(s) = [5.14916982]
bas 18, expnt(s) = [8.60730776]
bas 19, expnt(s) = [0.49249063]
CPU time:       422.63
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.87486453e-01 9.91923234e-01 9.38141901e-01 2.40833238e+00
 1.17616814e+05 1.60460109e+04 2.03391397e+00 4.30293177e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547148e+04 6.70656005e+03
 7.30314721e+03 1.99594038e+03 1.83757990e+04 3.98749084e+03
 1.44908769e+03 5.93384264e+02 3.76317772e+02 2.15864423e+02
 1.14745686e+02 8.85762520e+01 3.94908276e+01 3.98003784e+01
 1.07119445e+01 1.49594718e+01 5.14916982e+00 8.63610543e+00
 8.60730776e+00 4.30099123e+01 4.92490628e-01 1.20359910e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33570645678156
cond(S) = 908264.2921309721
E1 = -689.5942848565724  E_coul = 184.97897585158935
init E= -504.615309004983
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672375452307999  LUMO = 0.999066083110194
  mo_energy =
[-1.21703468e+02 -1.33851601e+01 -7.62299487e+00 -7.62299487e+00
 -7.62299487e+00 -1.65668738e+00 -6.72375452e-01 -6.72375452e-01
 -6.72375452e-01  9.99066083e-01  7.32884975e+00  3.06576117e+01
  1.42882506e+02  6.42349195e+02  2.78417364e+03  1.22596918e+04
  4.08780071e+04  1.04919868e+05  2.30102221e+05  4.55916431e+05
  8.44868163e+05  1.52804494e+06  2.85031174e+06  5.80819827e+06]
E1 = -707.712034392507  E_coul = 199.74985376381116
cycle= 1 E= -507.962180628696  delta_E= -3.35  |g|= 0.452  |ddm|= 0.47
    CPU time for cycle= 1      0.43 sec, wall time      0.03 sec
diis-norm(errvec)=0.688312
diis-c [-0.47377371  1.        ]
  HOMO = -0.219543281005733  LUMO = 1.42102312628182
  mo_energy =
[-1.20197142e+02 -1.23062661e+01 -6.59599986e+00 -6.59599986e+00
 -6.59599986e+00 -1.16401807e+00 -2.19543281e-01 -2.19543281e-01
 -2.19543281e-01  1.42102313e+00  8.03082292e+00  3.17133307e+01
  1.44279393e+02  6.43838131e+02  2.78560275e+03  1.22610118e+04
  4.08792604e+04  1.04921085e+05  2.30103413e+05  4.55917606e+05
  8.44869324e+05  1.52804609e+06  2.85031288e+06  5.80819940e+06]
E1 = -706.7852404833302  E_coul = 198.80563734207814
cycle= 2 E= -507.979603141252  delta_E= -0.0174  |g|= 0.0343  |ddm|= 0.481
    CPU time for cycle= 2      0.10 sec, wall time      0.03 sec
diis-norm(errvec)=0.030391
diis-c [-9.18189443e-04 -3.39733407e-03  1.00339733e+00]
  HOMO = -0.24059760421725  LUMO = 1.41434119403848
  mo_energy =
[-1.20309997e+02 -1.23721197e+01 -6.66911523e+00 -6.66911523e+00
 -6.66911523e+00 -1.17742996e+00 -2.40597604e-01 -2.40597604e-01
 -2.40597604e-01  1.41434119e+00  7.99629242e+00  3.16496371e+01
  1.44184140e+02  6.43721400e+02  2.78546984e+03  1.22608686e+04
  4.08791135e+04  1.04920936e+05  2.30103264e+05  4.55917456e+05
  8.44869174e+05  1.52804594e+06  2.85031273e+06  5.80819925e+06]
E1 = -706.6892634358171  E_coul = 198.7094480625074
cycle= 3 E= -507.97981537331  delta_E= -0.000212  |g|= 0.00382  |ddm|= 0.0673
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00309263
diis-c [-2.24161804e-06  1.96771607e-04 -9.83359605e-02  1.09813919e+00]
  HOMO = -0.243218220906982  LUMO = 1.41330945775511
  mo_energy =
[-1.20320447e+02 -1.23795897e+01 -6.67704267e+00 -6.67704267e+00
 -6.67704267e+00 -1.17899403e+00 -2.43218221e-01 -2.43218221e-01
 -2.43218221e-01  1.41330946e+00  7.99195349e+00  3.16425374e+01
  1.44174775e+02  6.43710821e+02  2.78545852e+03  1.22608569e+04
  4.08791016e+04  1.04920924e+05  2.30103252e+05  4.55917444e+05
  8.44869162e+05  1.52804592e+06  2.85031272e+06  5.80819924e+06]
E1 = -706.6774218140771  E_coul = 198.69760337910716
cycle= 4 E= -507.97981843497  delta_E= -3.06e-06  |g|= 0.000148  |ddm|= 0.00975
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000125034
diis-c [-8.21361574e-11 -5.46837601e-06  5.91822057e-03 -8.73978805e-02
  1.08148513e+00]
  HOMO = -0.243312705246936  LUMO = 1.41326705787639
  mo_energy =
[-1.20320682e+02 -1.23798226e+01 -6.67727187e+00 -6.67727187e+00
 -6.67727187e+00 -1.17905024e+00 -2.43312705e-01 -2.43312705e-01
 -2.43312705e-01  1.41326706e+00  7.99179878e+00  3.16423231e+01
  1.44174543e+02  6.43710586e+02  2.78545828e+03  1.22608566e+04
  4.08791013e+04  1.04920924e+05  2.30103252e+05  4.55917444e+05
  8.44869162e+05  1.52804592e+06  2.85031272e+06  5.80819924e+06]
E1 = -706.6770069517315  E_coul = 198.69718851236453
cycle= 5 E= -507.979818439367  delta_E= -4.4e-09  |g|= 1.13e-06  |ddm|= 0.000439
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.62696e-07
diis-c [-6.32025032e-14  1.77966094e-07 -1.23025192e-04  1.66501615e-03
 -2.12274435e-02  1.01968527e+00]
  HOMO = -0.243313200022384  LUMO = 1.41326690574635
  mo_energy =
[-1.20320683e+02 -1.23798236e+01 -6.67727292e+00 -6.67727292e+00
 -6.67727292e+00 -1.17905064e+00 -2.43313200e-01 -2.43313200e-01
 -2.43313200e-01  1.41326691e+00  7.99179803e+00  3.16423221e+01
  1.44174542e+02  6.43710585e+02  2.78545828e+03  1.22608566e+04
  4.08791013e+04  1.04920924e+05  2.30103252e+05  4.55917444e+05
  8.44869162e+05  1.52804592e+06  2.85031272e+06  5.80819924e+06]
E1 = -706.6770048327463  E_coul = 198.69718639337864
cycle= 6 E= -507.979818439368  delta_E= -6.82e-13  |g|= 5.55e-08  |ddm|= 3.39e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6770048327463  E_coul = 198.69718639337864
  HOMO = -0.243313222321103  LUMO = 1.41326689294406
  mo_energy =
[-1.20320683e+02 -1.23798237e+01 -6.67727297e+00 -6.67727297e+00
 -6.67727297e+00 -1.17905065e+00 -2.43313222e-01 -2.43313222e-01
 -2.43313222e-01  1.41326689e+00  7.99179799e+00  3.16423221e+01
  1.44174542e+02  6.43710585e+02  2.78545828e+03  1.22608566e+04
  4.08791013e+04  1.04920924e+05  2.30103252e+05  4.55917444e+05
  8.44869162e+05  1.52804592e+06  2.85031272e+06  5.80819924e+06]
E1 = -706.6770047381164  E_coul = 198.69718629874936
Extra cycle  E= -507.979818439367  delta_E= 6.82e-13  |g|= 5.39e-09  |ddm|= 1.57e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.87486453e-01 9.38141901e-01 1.17616814e+05 2.03391397e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547148e+04 7.30314721e+03 1.83757990e+04
 1.44908769e+03 3.76317772e+02 1.14745686e+02 3.94908276e+01
 1.07119445e+01 5.14916982e+00 8.60730776e+00 4.92490628e-01]
E = -507.979818439367
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:10:09 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.287486453358       1
[INPUT] 0    0    [1    /1   ]  0.938141900802       1
[INPUT] 0    0    [1    /1   ]  117616.813859        1
[INPUT] 0    0    [1    /1   ]  2.03391397304        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031072        1
[INPUT] 0    0    [1    /1   ]  147020.991914        1
[INPUT] 0    0    [1    /1   ]  73510.4200004        1
[INPUT] 0    0    [1    /1   ]  36754.7148169        1
[INPUT] 0    0    [1    /1   ]  7303.14720566        1
[INPUT] 0    0    [1    /1   ]  18375.7990145        1
[INPUT] 0    0    [1    /1   ]  1449.0876918         1
[INPUT] 0    0    [1    /1   ]  376.317771588        1
[INPUT] 0    0    [1    /1   ]  114.745686206        1
[INPUT] 0    0    [1    /1   ]  39.4908275949        1
[INPUT] 0    0    [1    /1   ]  10.7119444601        1
[INPUT] 0    0    [1    /1   ]  5.14916981858        1
[INPUT] 1    0    [1    /1   ]  8.60730776076        1
[INPUT] 1    0    [1    /1   ]  0.492490628107       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.28748645335797796, 1.0]], [0, [0.9381419008018442, 1.0]], [0, [117616.81385895271, 1.0]], [0, [2.0339139730421554, 1.0]], [0, [1176168.1426172, 1.0]], [0, [588084.0699822628, 1.0]], [0, [294042.0310723126, 1.0]], [0, [147020.99191421378, 1.0]], [0, [73510.42000035848, 1.0]], [0, [36754.71481688893, 1.0]], [0, [7303.147205657794, 1.0]], [0, [18375.79901447303, 1.0]], [0, [1449.0876917974522, 1.0]], [0, [376.3177715880471, 1.0]], [0, [114.74568620639052, 1.0]], [0, [39.49082759487882, 1.0]], [0, [10.711944460059986, 1.0]], [0, [5.149169818583547, 1.0]], [1, [8.60730776075521, 1.0]], [1, [0.49249062810690436, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.28748645]
bas 1, expnt(s) = [0.9381419]
bas 2, expnt(s) = [117616.81385895]
bas 3, expnt(s) = [2.03391397]
bas 4, expnt(s) = [1176168.1426172]
bas 5, expnt(s) = [588084.06998226]
bas 6, expnt(s) = [294042.03107231]
bas 7, expnt(s) = [147020.99191421]
bas 8, expnt(s) = [73510.42000036]
bas 9, expnt(s) = [36754.71481689]
bas 10, expnt(s) = [7303.14720566]
bas 11, expnt(s) = [18375.79901447]
bas 12, expnt(s) = [1449.0876918]
bas 13, expnt(s) = [376.31777159]
bas 14, expnt(s) = [114.74568621]
bas 15, expnt(s) = [39.49082759]
bas 16, expnt(s) = [10.71194446]
bas 17, expnt(s) = [5.14916982]
bas 18, expnt(s) = [8.60730776]
bas 19, expnt(s) = [0.49249063]
CPU time:       423.95
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.87486453e-01 9.91923234e-01 9.38141901e-01 2.40833238e+00
 1.17616814e+05 1.60460109e+04 2.03391397e+00 4.30293177e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547148e+04 6.70656005e+03
 7.30314721e+03 1.99594038e+03 1.83757990e+04 3.98749084e+03
 1.44908769e+03 5.93384264e+02 3.76317772e+02 2.15864423e+02
 1.14745686e+02 8.85762520e+01 3.94908276e+01 3.98003784e+01
 1.07119445e+01 1.49594718e+01 5.14916982e+00 8.63610543e+00
 8.60730776e+00 4.30099123e+01 4.92490628e-01 1.20359910e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33570645678156
cond(S) = 908264.2921309721
E1 = -689.5942848565724  E_coul = 184.97897585158935
init E= -504.615309004983
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672375452307999  LUMO = 0.999066083110194
  mo_energy =
[-1.21703468e+02 -1.33851601e+01 -7.62299487e+00 -7.62299487e+00
 -7.62299487e+00 -1.65668738e+00 -6.72375452e-01 -6.72375452e-01
 -6.72375452e-01  9.99066083e-01  7.32884975e+00  3.06576117e+01
  1.42882506e+02  6.42349195e+02  2.78417364e+03  1.22596918e+04
  4.08780071e+04  1.04919868e+05  2.30102221e+05  4.55916431e+05
  8.44868163e+05  1.52804494e+06  2.85031174e+06  5.80819827e+06]
E1 = -707.712034392507  E_coul = 199.74985376381116
cycle= 1 E= -507.962180628696  delta_E= -3.35  |g|= 0.452  |ddm|= 0.47
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.688312
diis-c [-0.47377371  1.        ]
  HOMO = -0.219543281005733  LUMO = 1.42102312628182
  mo_energy =
[-1.20197142e+02 -1.23062661e+01 -6.59599986e+00 -6.59599986e+00
 -6.59599986e+00 -1.16401807e+00 -2.19543281e-01 -2.19543281e-01
 -2.19543281e-01  1.42102313e+00  8.03082292e+00  3.17133307e+01
  1.44279393e+02  6.43838131e+02  2.78560275e+03  1.22610118e+04
  4.08792604e+04  1.04921085e+05  2.30103413e+05  4.55917606e+05
  8.44869324e+05  1.52804609e+06  2.85031288e+06  5.80819940e+06]
E1 = -706.7852404833302  E_coul = 198.80563734207814
cycle= 2 E= -507.979603141252  delta_E= -0.0174  |g|= 0.0343  |ddm|= 0.481
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.030391
diis-c [-9.18189443e-04 -3.39733407e-03  1.00339733e+00]
  HOMO = -0.24059760421725  LUMO = 1.41434119403848
  mo_energy =
[-1.20309997e+02 -1.23721197e+01 -6.66911523e+00 -6.66911523e+00
 -6.66911523e+00 -1.17742996e+00 -2.40597604e-01 -2.40597604e-01
 -2.40597604e-01  1.41434119e+00  7.99629242e+00  3.16496371e+01
  1.44184140e+02  6.43721400e+02  2.78546984e+03  1.22608686e+04
  4.08791135e+04  1.04920936e+05  2.30103264e+05  4.55917456e+05
  8.44869174e+05  1.52804594e+06  2.85031273e+06  5.80819925e+06]
E1 = -706.6892634358171  E_coul = 198.7094480625074
cycle= 3 E= -507.97981537331  delta_E= -0.000212  |g|= 0.00382  |ddm|= 0.0673
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00309263
diis-c [-2.24161804e-06  1.96771607e-04 -9.83359605e-02  1.09813919e+00]
  HOMO = -0.243218220906982  LUMO = 1.41330945775511
  mo_energy =
[-1.20320447e+02 -1.23795897e+01 -6.67704267e+00 -6.67704267e+00
 -6.67704267e+00 -1.17899403e+00 -2.43218221e-01 -2.43218221e-01
 -2.43218221e-01  1.41330946e+00  7.99195349e+00  3.16425374e+01
  1.44174775e+02  6.43710821e+02  2.78545852e+03  1.22608569e+04
  4.08791016e+04  1.04920924e+05  2.30103252e+05  4.55917444e+05
  8.44869162e+05  1.52804592e+06  2.85031272e+06  5.80819924e+06]
E1 = -706.6774218140771  E_coul = 198.69760337910716
cycle= 4 E= -507.97981843497  delta_E= -3.06e-06  |g|= 0.000148  |ddm|= 0.00975
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000125034
diis-c [-8.21361574e-11 -5.46837601e-06  5.91822057e-03 -8.73978805e-02
  1.08148513e+00]
  HOMO = -0.243312705246936  LUMO = 1.41326705787639
  mo_energy =
[-1.20320682e+02 -1.23798226e+01 -6.67727187e+00 -6.67727187e+00
 -6.67727187e+00 -1.17905024e+00 -2.43312705e-01 -2.43312705e-01
 -2.43312705e-01  1.41326706e+00  7.99179878e+00  3.16423231e+01
  1.44174543e+02  6.43710586e+02  2.78545828e+03  1.22608566e+04
  4.08791013e+04  1.04920924e+05  2.30103252e+05  4.55917444e+05
  8.44869162e+05  1.52804592e+06  2.85031272e+06  5.80819924e+06]
E1 = -706.6770069517315  E_coul = 198.69718851236453
cycle= 5 E= -507.979818439367  delta_E= -4.4e-09  |g|= 1.13e-06  |ddm|= 0.000439
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.62696e-07
diis-c [-6.32025032e-14  1.77966094e-07 -1.23025192e-04  1.66501615e-03
 -2.12274435e-02  1.01968527e+00]
  HOMO = -0.243313200022384  LUMO = 1.41326690574635
  mo_energy =
[-1.20320683e+02 -1.23798236e+01 -6.67727292e+00 -6.67727292e+00
 -6.67727292e+00 -1.17905064e+00 -2.43313200e-01 -2.43313200e-01
 -2.43313200e-01  1.41326691e+00  7.99179803e+00  3.16423221e+01
  1.44174542e+02  6.43710585e+02  2.78545828e+03  1.22608566e+04
  4.08791013e+04  1.04920924e+05  2.30103252e+05  4.55917444e+05
  8.44869162e+05  1.52804592e+06  2.85031272e+06  5.80819924e+06]
E1 = -706.6770048327463  E_coul = 198.69718639337864
cycle= 6 E= -507.979818439368  delta_E= -6.82e-13  |g|= 5.55e-08  |ddm|= 3.39e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6770048327463  E_coul = 198.69718639337864
  HOMO = -0.243313222321103  LUMO = 1.41326689294406
  mo_energy =
[-1.20320683e+02 -1.23798237e+01 -6.67727297e+00 -6.67727297e+00
 -6.67727297e+00 -1.17905065e+00 -2.43313222e-01 -2.43313222e-01
 -2.43313222e-01  1.41326689e+00  7.99179799e+00  3.16423221e+01
  1.44174542e+02  6.43710585e+02  2.78545828e+03  1.22608566e+04
  4.08791013e+04  1.04920924e+05  2.30103252e+05  4.55917444e+05
  8.44869162e+05  1.52804592e+06  2.85031272e+06  5.80819924e+06]
E1 = -706.6770047381164  E_coul = 198.69718629874936
Extra cycle  E= -507.979818439367  delta_E= 6.82e-13  |g|= 5.39e-09  |ddm|= 1.57e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908264.2921309721
E1 = -706.6770047381164  E_coul = 198.69718629874936
init E= -507.979818439367
    CPU time for initialize scf      3.32 sec, wall time      0.21 sec
  HOMO = -0.243313225311942  LUMO = 1.41326689100711
  mo_energy =
[-1.20320683e+02 -1.23798237e+01 -6.67727297e+00 -6.67727297e+00
 -6.67727297e+00 -1.17905066e+00 -2.43313225e-01 -2.43313225e-01
 -2.43313225e-01  1.41326689e+00  7.99179799e+00  3.16423221e+01
  1.44174542e+02  6.43710585e+02  2.78545828e+03  1.22608566e+04
  4.08791013e+04  1.04920924e+05  2.30103252e+05  4.55917444e+05
  8.44869162e+05  1.52804592e+06  2.85031272e+06  5.80819924e+06]
E1 = -706.6770047257443  E_coul = 198.697186286377
cycle= 1 E= -507.979818439367  delta_E= -2.27e-13  |g|= 8.51e-10  |ddm|= 1.57e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6770047257443  E_coul = 198.697186286377
  HOMO = -0.243313225678248  LUMO = 1.41326689028165
  mo_energy =
[-1.20320683e+02 -1.23798237e+01 -6.67727297e+00 -6.67727297e+00
 -6.67727297e+00 -1.17905066e+00 -2.43313226e-01 -2.43313226e-01
 -2.43313226e-01  1.41326689e+00  7.99179798e+00  3.16423221e+01
  1.44174542e+02  6.43710585e+02  2.78545828e+03  1.22608566e+04
  4.08791013e+04  1.04920924e+05  2.30103252e+05  4.55917444e+05
  8.44869162e+05  1.52804592e+06  2.85031272e+06  5.80819924e+06]
E1 = -706.6770047241511  E_coul = 198.6971862847835
Extra cycle  E= -507.979818439368  delta_E= -3.41e-13  |g|= 7.5e-10  |ddm|= 1.8e-09
    CPU time for scf_cycle      3.77 sec, wall time      0.38 sec
exp = [2.87486453e-01 9.38141901e-01 1.17616814e+05 2.03391397e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547148e+04 7.30314721e+03 1.83757990e+04
 1.44908769e+03 3.76317772e+02 1.14745686e+02 3.94908276e+01
 1.07119445e+01 5.14916982e+00 8.60730776e+00 4.92490628e-01]
grad_E = [-1.48090006e-02  6.17012941e-03  4.44384920e-09 -1.12991724e-03
  2.18603610e-11  1.21271320e-10  6.91168345e-10  2.71350560e-09
  1.12831153e-08  6.03834127e-08  3.81817265e-06  1.32876280e-07
 -5.32415001e-06  8.44369481e-05 -4.33812390e-04 -6.49823343e-04
 -5.26080868e-04  1.25269921e-03  2.79441721e-03 -8.05907852e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:10:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.242635701004       1
[INPUT] 0    0    [1    /1   ]  0.114119394849       1
[INPUT] 0    0    [1    /1   ]  117616.813834        1
[INPUT] 0    0    [1    /1   ]  4.74717501847        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031068        1
[INPUT] 0    0    [1    /1   ]  147020.991899        1
[INPUT] 0    0    [1    /1   ]  73510.4199378        1
[INPUT] 0    0    [1    /1   ]  36754.7144822        1
[INPUT] 0    0    [1    /1   ]  7303.12605327        1
[INPUT] 0    0    [1    /1   ]  18375.7982784        1
[INPUT] 0    0    [1    /1   ]  1449.1121012         1
[INPUT] 0    0    [1    /1   ]  375.946815272        1
[INPUT] 0    0    [1    /1   ]  116.474177065        1
[INPUT] 0    0    [1    /1   ]  40.7776339087        1
[INPUT] 0    0    [1    /1   ]  17.3736050248        1
[INPUT] 0    0    [1    /1   ]  8.81966755562        1
[INPUT] 1    0    [1    /1   ]  8.61221236284        1
[INPUT] 1    0    [1    /1   ]  0.492304803669       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24263570100441018, 1.0]], [0, [0.11411939484869871, 1.0]], [0, [117616.81383432083, 1.0]], [0, [4.747175018473793, 1.0]], [0, [1176168.1426170794, 1.0]], [0, [588084.069981591, 1.0]], [0, [294042.03106848156, 1.0]], [0, [147020.99189917344, 1.0]], [0, [73510.41993782062, 1.0]], [0, [36754.7144821517, 1.0]], [0, [7303.126053273455, 1.0]], [0, [18375.798278423947, 1.0]], [0, [1449.1121012038159, 1.0]], [0, [375.9468152720486, 1.0]], [0, [116.47417706542954, 1.0]], [0, [40.77763390871963, 1.0]], [0, [17.373605024797182, 1.0]], [0, [8.819667555618802, 1.0]], [1, [8.612212362837681, 1.0]], [1, [0.4923048036690593, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2426357]
bas 1, expnt(s) = [0.11411939]
bas 2, expnt(s) = [117616.81383432]
bas 3, expnt(s) = [4.74717502]
bas 4, expnt(s) = [1176168.14261708]
bas 5, expnt(s) = [588084.06998159]
bas 6, expnt(s) = [294042.03106848]
bas 7, expnt(s) = [147020.99189917]
bas 8, expnt(s) = [73510.41993782]
bas 9, expnt(s) = [36754.71448215]
bas 10, expnt(s) = [7303.12605327]
bas 11, expnt(s) = [18375.79827842]
bas 12, expnt(s) = [1449.1121012]
bas 13, expnt(s) = [375.94681527]
bas 14, expnt(s) = [116.47417707]
bas 15, expnt(s) = [40.77763391]
bas 16, expnt(s) = [17.37360502]
bas 17, expnt(s) = [8.81966756]
bas 18, expnt(s) = [8.61221236]
bas 19, expnt(s) = [0.4923048]
CPU time:       435.51
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.42635701e-01 8.73435926e-01 1.14119395e-01 4.96060469e-01
 1.17616814e+05 1.60460109e+04 4.74717502e+00 8.12533839e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104199e+04 1.12791586e+04 3.67547145e+04 6.70656000e+03
 7.30312605e+03 1.99593605e+03 1.83757983e+04 3.98749072e+03
 1.44911210e+03 5.93391760e+02 3.75946815e+02 2.15704811e+02
 1.16474177e+02 8.95750919e+01 4.07776339e+01 4.07691391e+01
 1.73736050e+01 2.14997041e+01 8.81966756e+00 1.29301685e+01
 8.61221236e+00 4.30405493e+01 4.92304804e-01 1.20303146e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.276178513083767
cond(S) = 909004.9101114684
E1 = -686.2649618510837  E_coul = 183.29490221813253
init E= -502.970059632951
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.745749309122588  LUMO = 0.0462126480839908
  mo_energy =
[-1.21823979e+02 -1.34459460e+01 -7.74556744e+00 -7.74556744e+00
 -7.74556744e+00 -1.59558021e+00 -7.45749309e-01 -7.45749309e-01
 -7.45749309e-01  4.62126481e-02  1.11089321e+01  5.66116680e+01
  1.92703171e+02  6.99095109e+02  2.83708328e+03  1.23062740e+04
  4.09211442e+04  1.04961215e+05  2.30142402e+05  4.55955768e+05
  8.44906854e+05  1.52808300e+06  2.85034903e+06  5.80823456e+06]
E1 = -705.4274859330444  E_coul = 197.71644287048693
cycle= 1 E= -507.711043062557  delta_E= -4.74  |g|= 0.455  |ddm|=  5.9
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.696299
diis-c [-0.48483215  1.        ]
  HOMO = -0.284093787460491  LUMO = 0.283540119678117
  mo_energy =
[-1.20358032e+02 -1.23989257e+01 -6.75076244e+00 -6.75076244e+00
 -6.75076244e+00 -1.13959984e+00 -2.84093787e-01 -2.84093787e-01
 -2.84093787e-01  2.83540120e-01  1.20534475e+01  5.77913732e+01
  1.94080372e+02  7.00541990e+02  2.83846721e+03  1.23075468e+04
  4.09223494e+04  1.04962383e+05  2.30143546e+05  4.55956894e+05
  8.44907967e+05  1.52808410e+06  2.85035012e+06  5.80823564e+06]
E1 = -704.9968539796789  E_coul = 197.27751539130963
cycle= 2 E= -507.719338588369  delta_E= -0.0083  |g|= 0.0226  |ddm|= 0.611
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0224313
diis-c [-4.98743762e-04 -3.03009540e-03  1.00303010e+00]
  HOMO = -0.291981708031292  LUMO = 0.283496530347987
  mo_energy =
[-1.20419332e+02 -1.24282946e+01 -6.78475746e+00 -6.78475746e+00
 -6.78475746e+00 -1.14377899e+00 -2.91981708e-01 -2.91981708e-01
 -2.91981708e-01  2.83496530e-01  1.20354841e+01  5.77554595e+01
  1.94030026e+02  7.00477858e+02  2.83839105e+03  1.23074628e+04
  4.09222626e+04  1.04962295e+05  2.30143457e+05  4.55956805e+05
  8.44907877e+05  1.52808401e+06  2.85035003e+06  5.80823555e+06]
E1 = -704.954757336138  E_coul = 197.23531119891655
cycle= 3 E= -507.719446137221  delta_E= -0.000108  |g|= 0.00297  |ddm|= 0.0896
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00210182
diis-c [-1.48880123e-06 -8.35985458e-05 -8.23383852e-02  1.08242198e+00]
  HOMO = -0.293102173043438  LUMO = 0.283451775316664
  mo_energy =
[-1.20424081e+02 -1.24314920e+01 -6.78818741e+00 -6.78818741e+00
 -6.78818741e+00 -1.14438608e+00 -2.93102173e-01 -2.93102173e-01
 -2.93102173e-01  2.83451775e-01  1.20330694e+01  5.77519366e+01
  1.94025776e+02  7.00473050e+02  2.83838585e+03  1.23074574e+04
  4.09222571e+04  1.04962290e+05  2.30143452e+05  4.55956799e+05
  8.44907872e+05  1.52808401e+06  2.85035002e+06  5.80823555e+06]
E1 = -704.9478008563607  E_coul = 197.228351094866
cycle= 4 E= -507.719449761495  delta_E= -3.62e-06  |g|= 0.000362  |ddm|= 0.0185
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000217078
diis-c [-2.86395048e-10 -1.12078879e-05  9.89684259e-03 -1.97037921e-01
  1.18715229e+00]
  HOMO = -0.293238521141039  LUMO = 0.28344380308285
  mo_energy =
[-1.20424442e+02 -1.24318200e+01 -6.78851819e+00 -6.78851819e+00
 -6.78851819e+00 -1.14446196e+00 -2.93238521e-01 -2.93238521e-01
 -2.93238521e-01  2.83443803e-01  1.20327851e+01  5.77516040e+01
  1.94025425e+02  7.00472687e+02  2.83838548e+03  1.23074570e+04
  4.09222567e+04  1.04962289e+05  2.30143451e+05  4.55956799e+05
  8.44907871e+05  1.52808400e+06  2.85035002e+06  5.80823555e+06]
E1 = -704.9468998590211  E_coul = 197.2274500415607
cycle= 5 E= -507.71944981746  delta_E= -5.6e-08  |g|= 9.49e-07  |ddm|= 0.00263
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.07942e-07
diis-c [-6.05518019e-14  3.60221371e-07 -1.67459482e-04  2.92189066e-03
 -1.87281567e-02  1.01597337e+00]
  HOMO = -0.293238811260648  LUMO = 0.283443834898023
  mo_energy =
[-1.20424444e+02 -1.24318209e+01 -6.78851915e+00 -6.78851915e+00
 -6.78851915e+00 -1.14446216e+00 -2.93238811e-01 -2.93238811e-01
 -2.93238811e-01  2.83443835e-01  1.20327844e+01  5.77516030e+01
  1.94025424e+02  7.00472685e+02  2.83838548e+03  1.23074570e+04
  4.09222567e+04  1.04962289e+05  2.30143451e+05  4.55956799e+05
  8.44907871e+05  1.52808400e+06  2.85035002e+06  5.80823555e+06]
E1 = -704.9468975906398  E_coul = 197.22744777317882
cycle= 6 E= -507.719449817461  delta_E= -5.68e-13  |g|= 2.38e-08  |ddm|= 6.23e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -704.9468975906398  E_coul = 197.22744777317882
  HOMO = -0.293238817307017  LUMO = 0.28344383459987
  mo_energy =
[-1.20424444e+02 -1.24318209e+01 -6.78851916e+00 -6.78851916e+00
 -6.78851916e+00 -1.14446216e+00 -2.93238817e-01 -2.93238817e-01
 -2.93238817e-01  2.83443835e-01  1.20327844e+01  5.77516030e+01
  1.94025424e+02  7.00472685e+02  2.83838548e+03  1.23074570e+04
  4.09222567e+04  1.04962289e+05  2.30143451e+05  4.55956799e+05
  8.44907871e+05  1.52808400e+06  2.85035002e+06  5.80823555e+06]
E1 = -704.946897552082  E_coul = 197.22744773462125
Extra cycle  E= -507.719449817461  delta_E= 2.27e-13  |g|= 4.32e-09  |ddm|= 1.27e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.42635701e-01 1.14119395e-01 1.17616814e+05 4.74717502e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104199e+04 3.67547145e+04 7.30312605e+03 1.83757983e+04
 1.44911210e+03 3.75946815e+02 1.16474177e+02 4.07776339e+01
 1.73736050e+01 8.81966756e+00 8.61221236e+00 4.92304804e-01]
E = -507.7194498174607
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:10:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.283001378123       1
[INPUT] 0    0    [1    /1   ]  0.855739650207       1
[INPUT] 0    0    [1    /1   ]  117616.813856        1
[INPUT] 0    0    [1    /1   ]  2.30524007759        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031072        1
[INPUT] 0    0    [1    /1   ]  147020.991913        1
[INPUT] 0    0    [1    /1   ]  73510.4199941        1
[INPUT] 0    0    [1    /1   ]  36754.7147834        1
[INPUT] 0    0    [1    /1   ]  7303.14509042        1
[INPUT] 0    0    [1    /1   ]  18375.7989409        1
[INPUT] 0    0    [1    /1   ]  1449.09013274        1
[INPUT] 0    0    [1    /1   ]  376.280675956        1
[INPUT] 0    0    [1    /1   ]  114.918535292        1
[INPUT] 0    0    [1    /1   ]  39.6195082263        1
[INPUT] 0    0    [1    /1   ]  11.3781105165        1
[INPUT] 0    0    [1    /1   ]  5.51621959229        1
[INPUT] 1    0    [1    /1   ]  8.60779822096        1
[INPUT] 1    0    [1    /1   ]  0.492472045663       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.28300137812262116, 1.0]], [0, [0.8557396502065296, 1.0]], [0, [117616.81385648952, 1.0]], [0, [2.305240077585319, 1.0]], [0, [1176168.142617188, 1.0]], [0, [588084.0699821956, 1.0]], [0, [294042.0310719295, 1.0]], [0, [147020.99191270975, 1.0]], [0, [73510.4199941047, 1.0]], [0, [36754.714783415206, 1.0]], [0, [7303.14509041936, 1.0]], [0, [18375.79894086812, 1.0]], [0, [1449.0901327380886, 1.0]], [0, [376.2806759564472, 1.0]], [0, [114.91853529229442, 1.0]], [0, [39.6195082262629, 1.0]], [0, [11.378110516533706, 1.0]], [0, [5.516219592287073, 1.0]], [1, [8.607798220963458, 1.0]], [1, [0.49247204566311986, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.28300138]
bas 1, expnt(s) = [0.85573965]
bas 2, expnt(s) = [117616.81385649]
bas 3, expnt(s) = [2.30524008]
bas 4, expnt(s) = [1176168.14261719]
bas 5, expnt(s) = [588084.0699822]
bas 6, expnt(s) = [294042.03107193]
bas 7, expnt(s) = [147020.99191271]
bas 8, expnt(s) = [73510.4199941]
bas 9, expnt(s) = [36754.71478342]
bas 10, expnt(s) = [7303.14509042]
bas 11, expnt(s) = [18375.79894087]
bas 12, expnt(s) = [1449.09013274]
bas 13, expnt(s) = [376.28067596]
bas 14, expnt(s) = [114.91853529]
bas 15, expnt(s) = [39.61950823]
bas 16, expnt(s) = [11.37811052]
bas 17, expnt(s) = [5.51621959]
bas 18, expnt(s) = [8.60779822]
bas 19, expnt(s) = [0.49247205]
CPU time:       436.84
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.83001378e-01 9.80294209e-01 8.55739650e-01 2.24787039e+00
 1.17616814e+05 1.60460109e+04 2.30524008e+00 4.72663586e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547148e+04 6.70656004e+03
 7.30314509e+03 1.99593995e+03 1.83757989e+04 3.98749083e+03
 1.44909013e+03 5.93385014e+02 3.76280676e+02 2.15848463e+02
 1.14918535e+02 8.86763044e+01 3.96195082e+01 3.98976058e+01
 1.13781105e+01 1.56519206e+01 5.51621959e+00 9.09381645e+00
 8.60779822e+00 4.30129758e+01 4.92472046e-01 1.20354234e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33581900316387
cond(S) = 908333.6059461979
E1 = -689.6002345417334  E_coul = 184.98085956581684
init E= -504.619374975917
    CPU time for initialize scf      0.42 sec, wall time      0.06 sec
  HOMO = -0.672398297687805  LUMO = 0.948543462820597
  mo_energy =
[-1.21703189e+02 -1.33851346e+01 -7.62285002e+00 -7.62285002e+00
 -7.62285002e+00 -1.65698599e+00 -6.72398298e-01 -6.72398298e-01
 -6.72398298e-01  9.48543463e-01  7.72665526e+00  3.32548325e+01
  1.48030885e+02  6.47980511e+02  2.78936368e+03  1.22642513e+04
  4.08822285e+04  1.04923914e+05  2.30106153e+05  4.55920280e+05
  8.44871949e+05  1.52804866e+06  2.85031539e+06  5.80820182e+06]
E1 = -707.7271631951361  E_coul = 199.76427644424413
cycle= 1 E= -507.962886750892  delta_E= -3.34  |g|= 0.452  |ddm|= 0.463
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.687916
diis-c [-0.4732289  1.       ]
  HOMO = -0.219151768056334  LUMO = 1.36706106168828
  mo_energy =
[-1.20195871e+02 -1.23053149e+01 -6.59491385e+00 -6.59491385e+00
 -6.59491385e+00 -1.16385214e+00 -2.19151768e-01 -2.19151768e-01
 -2.19151768e-01  1.36706106e+00  8.45381359e+00  3.43329206e+01
  1.49430163e+02  6.49470078e+02  2.79079368e+03  1.22655722e+04
  4.08834826e+04  1.04925132e+05  2.30107346e+05  4.55921456e+05
  8.44873112e+05  1.52804981e+06  2.85031653e+06  5.80820295e+06]
E1 = -706.7934623689115  E_coul = 198.81304926422737
cycle= 2 E= -507.980413104684  delta_E= -0.0175  |g|= 0.0345  |ddm|= 0.431
    CPU time for cycle= 2      0.10 sec, wall time      0.03 sec
diis-norm(errvec)=0.0299558
diis-c [-8.93688473e-04 -2.79301953e-03  1.00279302e+00]
  HOMO = -0.240429864482558  LUMO = 1.36039839576624
  mo_energy =
[-1.20309257e+02 -1.23716289e+01 -6.66850025e+00 -6.66850025e+00
 -6.66850025e+00 -1.17743493e+00 -2.40429864e-01 -2.40429864e-01
 -2.40429864e-01  1.36039840e+00  8.41723930e+00  3.42670172e+01
  1.49334164e+02  6.49352836e+02  2.79066023e+03  1.22654285e+04
  4.08833351e+04  1.04924983e+05  2.30107196e+05  4.55921306e+05
  8.44872961e+05  1.52804966e+06  2.85031638e+06  5.80820280e+06]
E1 = -706.6954477002399  E_coul = 198.71481511219866
cycle= 3 E= -507.980632588041  delta_E= -0.000219  |g|= 0.00391  |ddm|= 0.0594
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00306073
diis-c [-2.21160791e-06  1.79173004e-04 -9.85670385e-02  1.09838787e+00]
  HOMO = -0.243134731630069  LUMO = 1.35934471833262
  mo_energy =
[-1.20319974e+02 -1.23793034e+01 -6.67664128e+00 -6.67664128e+00
 -6.67664128e+00 -1.17905321e+00 -2.43134732e-01 -2.43134732e-01
 -2.43134732e-01  1.35934472e+00  8.41257061e+00  3.42595691e+01
  1.49324538e+02  6.49341987e+02  2.79064862e+03  1.22654164e+04
  4.08833229e+04  1.04924970e+05  2.30107184e+05  4.55921294e+05
  8.44872949e+05  1.52804965e+06  2.85031637e+06  5.80820279e+06]
E1 = -706.6830989940239  E_coul = 198.70246310988927
cycle= 4 E= -507.980635884135  delta_E= -3.3e-06  |g|= 0.00016  |ddm|= 0.00861
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000128086
diis-c [-8.89960010e-11 -5.82386367e-06  6.06668335e-03 -9.00234790e-02
  1.08396262e+00]
  HOMO = -0.243238236096339  LUMO = 1.35929898061274
  mo_energy =
[-1.20320238e+02 -1.23795595e+01 -6.67689443e+00 -6.67689443e+00
 -6.67689443e+00 -1.17911481e+00 -2.43238236e-01 -2.43238236e-01
 -2.43238236e-01  1.35929898e+00  8.41239474e+00  3.42593301e+01
  1.49324279e+02  6.49341723e+02  2.79064835e+03  1.22654162e+04
  4.08833226e+04  1.04924970e+05  2.30107184e+05  4.55921294e+05
  8.44872949e+05  1.52804965e+06  2.85031637e+06  5.80820279e+06]
E1 = -706.6826378919026  E_coul = 198.70200200251355
cycle= 5 E= -507.980635889389  delta_E= -5.25e-09  |g|= 1.1e-06  |ddm|= 0.000395
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.82812e-07
diis-c [-6.85237703e-14  1.84604568e-07 -1.29176504e-04  1.76189748e-03
 -2.19663064e-02  1.02033340e+00]
  HOMO = -0.243238744235221  LUMO = 1.35929884021004
  mo_energy =
[-1.20320239e+02 -1.23795606e+01 -6.67689554e+00 -6.67689554e+00
 -6.67689554e+00 -1.17911522e+00 -2.43238744e-01 -2.43238744e-01
 -2.43238744e-01  1.35929884e+00  8.41239393e+00  3.42593291e+01
  1.49324278e+02  6.49341722e+02  2.79064835e+03  1.22654162e+04
  4.08833226e+04  1.04924970e+05  2.30107184e+05  4.55921293e+05
  8.44872949e+05  1.52804965e+06  2.85031637e+06  5.80820279e+06]
E1 = -706.6826356348049  E_coul = 198.70199974541617
cycle= 6 E= -507.980635889389  delta_E= 2.84e-13  |g|= 5e-08  |ddm|= 2.68e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6826356348049  E_coul = 198.70199974541617
  HOMO = -0.243238765464256  LUMO = 1.35929882573511
  mo_energy =
[-1.20320239e+02 -1.23795606e+01 -6.67689558e+00 -6.67689558e+00
 -6.67689558e+00 -1.17911523e+00 -2.43238765e-01 -2.43238765e-01
 -2.43238765e-01  1.35929883e+00  8.41239389e+00  3.42593291e+01
  1.49324278e+02  6.49341722e+02  2.79064835e+03  1.22654162e+04
  4.08833226e+04  1.04924970e+05  2.30107184e+05  4.55921293e+05
  8.44872949e+05  1.52804965e+06  2.85031637e+06  5.80820279e+06]
E1 = -706.6826355448875  E_coul = 198.70199965549827
Extra cycle  E= -507.980635889389  delta_E= -4.55e-13  |g|= 5.3e-09  |ddm|= 1.13e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.83001378e-01 8.55739650e-01 1.17616814e+05 2.30524008e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547148e+04 7.30314509e+03 1.83757989e+04
 1.44909013e+03 3.76280676e+02 1.14918535e+02 3.96195082e+01
 1.13781105e+01 5.51621959e+00 8.60779822e+00 4.92472046e-01]
E = -507.9806358893892
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:10:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.283001378123       1
[INPUT] 0    0    [1    /1   ]  0.855739650207       1
[INPUT] 0    0    [1    /1   ]  117616.813856        1
[INPUT] 0    0    [1    /1   ]  2.30524007759        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031072        1
[INPUT] 0    0    [1    /1   ]  147020.991913        1
[INPUT] 0    0    [1    /1   ]  73510.4199941        1
[INPUT] 0    0    [1    /1   ]  36754.7147834        1
[INPUT] 0    0    [1    /1   ]  7303.14509042        1
[INPUT] 0    0    [1    /1   ]  18375.7989409        1
[INPUT] 0    0    [1    /1   ]  1449.09013274        1
[INPUT] 0    0    [1    /1   ]  376.280675956        1
[INPUT] 0    0    [1    /1   ]  114.918535292        1
[INPUT] 0    0    [1    /1   ]  39.6195082263        1
[INPUT] 0    0    [1    /1   ]  11.3781105165        1
[INPUT] 0    0    [1    /1   ]  5.51621959229        1
[INPUT] 1    0    [1    /1   ]  8.60779822096        1
[INPUT] 1    0    [1    /1   ]  0.492472045663       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.28300137812262116, 1.0]], [0, [0.8557396502065296, 1.0]], [0, [117616.81385648952, 1.0]], [0, [2.305240077585319, 1.0]], [0, [1176168.142617188, 1.0]], [0, [588084.0699821956, 1.0]], [0, [294042.0310719295, 1.0]], [0, [147020.99191270975, 1.0]], [0, [73510.4199941047, 1.0]], [0, [36754.714783415206, 1.0]], [0, [7303.14509041936, 1.0]], [0, [18375.79894086812, 1.0]], [0, [1449.0901327380886, 1.0]], [0, [376.2806759564472, 1.0]], [0, [114.91853529229442, 1.0]], [0, [39.6195082262629, 1.0]], [0, [11.378110516533706, 1.0]], [0, [5.516219592287073, 1.0]], [1, [8.607798220963458, 1.0]], [1, [0.49247204566311986, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.28300138]
bas 1, expnt(s) = [0.85573965]
bas 2, expnt(s) = [117616.81385649]
bas 3, expnt(s) = [2.30524008]
bas 4, expnt(s) = [1176168.14261719]
bas 5, expnt(s) = [588084.0699822]
bas 6, expnt(s) = [294042.03107193]
bas 7, expnt(s) = [147020.99191271]
bas 8, expnt(s) = [73510.4199941]
bas 9, expnt(s) = [36754.71478342]
bas 10, expnt(s) = [7303.14509042]
bas 11, expnt(s) = [18375.79894087]
bas 12, expnt(s) = [1449.09013274]
bas 13, expnt(s) = [376.28067596]
bas 14, expnt(s) = [114.91853529]
bas 15, expnt(s) = [39.61950823]
bas 16, expnt(s) = [11.37811052]
bas 17, expnt(s) = [5.51621959]
bas 18, expnt(s) = [8.60779822]
bas 19, expnt(s) = [0.49247205]
CPU time:       438.17
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.83001378e-01 9.80294209e-01 8.55739650e-01 2.24787039e+00
 1.17616814e+05 1.60460109e+04 2.30524008e+00 4.72663586e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547148e+04 6.70656004e+03
 7.30314509e+03 1.99593995e+03 1.83757989e+04 3.98749083e+03
 1.44909013e+03 5.93385014e+02 3.76280676e+02 2.15848463e+02
 1.14918535e+02 8.86763044e+01 3.96195082e+01 3.98976058e+01
 1.13781105e+01 1.56519206e+01 5.51621959e+00 9.09381645e+00
 8.60779822e+00 4.30129758e+01 4.92472046e-01 1.20354234e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33581900316387
cond(S) = 908333.6059461979
E1 = -689.6002345417334  E_coul = 184.98085956581684
init E= -504.619374975917
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672398297687805  LUMO = 0.948543462820597
  mo_energy =
[-1.21703189e+02 -1.33851346e+01 -7.62285002e+00 -7.62285002e+00
 -7.62285002e+00 -1.65698599e+00 -6.72398298e-01 -6.72398298e-01
 -6.72398298e-01  9.48543463e-01  7.72665526e+00  3.32548325e+01
  1.48030885e+02  6.47980511e+02  2.78936368e+03  1.22642513e+04
  4.08822285e+04  1.04923914e+05  2.30106153e+05  4.55920280e+05
  8.44871949e+05  1.52804866e+06  2.85031539e+06  5.80820182e+06]
E1 = -707.7271631951361  E_coul = 199.76427644424413
cycle= 1 E= -507.962886750892  delta_E= -3.34  |g|= 0.452  |ddm|= 0.463
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.687916
diis-c [-0.4732289  1.       ]
  HOMO = -0.219151768056334  LUMO = 1.36706106168828
  mo_energy =
[-1.20195871e+02 -1.23053149e+01 -6.59491385e+00 -6.59491385e+00
 -6.59491385e+00 -1.16385214e+00 -2.19151768e-01 -2.19151768e-01
 -2.19151768e-01  1.36706106e+00  8.45381359e+00  3.43329206e+01
  1.49430163e+02  6.49470078e+02  2.79079368e+03  1.22655722e+04
  4.08834826e+04  1.04925132e+05  2.30107346e+05  4.55921456e+05
  8.44873112e+05  1.52804981e+06  2.85031653e+06  5.80820295e+06]
E1 = -706.7934623689115  E_coul = 198.81304926422737
cycle= 2 E= -507.980413104684  delta_E= -0.0175  |g|= 0.0345  |ddm|= 0.431
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0299558
diis-c [-8.93688473e-04 -2.79301953e-03  1.00279302e+00]
  HOMO = -0.240429864482558  LUMO = 1.36039839576624
  mo_energy =
[-1.20309257e+02 -1.23716289e+01 -6.66850025e+00 -6.66850025e+00
 -6.66850025e+00 -1.17743493e+00 -2.40429864e-01 -2.40429864e-01
 -2.40429864e-01  1.36039840e+00  8.41723930e+00  3.42670172e+01
  1.49334164e+02  6.49352836e+02  2.79066023e+03  1.22654285e+04
  4.08833351e+04  1.04924983e+05  2.30107196e+05  4.55921306e+05
  8.44872961e+05  1.52804966e+06  2.85031638e+06  5.80820280e+06]
E1 = -706.6954477002399  E_coul = 198.71481511219866
cycle= 3 E= -507.980632588041  delta_E= -0.000219  |g|= 0.00391  |ddm|= 0.0594
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00306073
diis-c [-2.21160791e-06  1.79173004e-04 -9.85670385e-02  1.09838787e+00]
  HOMO = -0.243134731630069  LUMO = 1.35934471833262
  mo_energy =
[-1.20319974e+02 -1.23793034e+01 -6.67664128e+00 -6.67664128e+00
 -6.67664128e+00 -1.17905321e+00 -2.43134732e-01 -2.43134732e-01
 -2.43134732e-01  1.35934472e+00  8.41257061e+00  3.42595691e+01
  1.49324538e+02  6.49341987e+02  2.79064862e+03  1.22654164e+04
  4.08833229e+04  1.04924970e+05  2.30107184e+05  4.55921294e+05
  8.44872949e+05  1.52804965e+06  2.85031637e+06  5.80820279e+06]
E1 = -706.6830989940239  E_coul = 198.70246310988927
cycle= 4 E= -507.980635884135  delta_E= -3.3e-06  |g|= 0.00016  |ddm|= 0.00861
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000128086
diis-c [-8.89960010e-11 -5.82386367e-06  6.06668335e-03 -9.00234790e-02
  1.08396262e+00]
  HOMO = -0.243238236096339  LUMO = 1.35929898061274
  mo_energy =
[-1.20320238e+02 -1.23795595e+01 -6.67689443e+00 -6.67689443e+00
 -6.67689443e+00 -1.17911481e+00 -2.43238236e-01 -2.43238236e-01
 -2.43238236e-01  1.35929898e+00  8.41239474e+00  3.42593301e+01
  1.49324279e+02  6.49341723e+02  2.79064835e+03  1.22654162e+04
  4.08833226e+04  1.04924970e+05  2.30107184e+05  4.55921294e+05
  8.44872949e+05  1.52804965e+06  2.85031637e+06  5.80820279e+06]
E1 = -706.6826378919026  E_coul = 198.70200200251355
cycle= 5 E= -507.980635889389  delta_E= -5.25e-09  |g|= 1.1e-06  |ddm|= 0.000395
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.82812e-07
diis-c [-6.85237703e-14  1.84604568e-07 -1.29176504e-04  1.76189748e-03
 -2.19663064e-02  1.02033340e+00]
  HOMO = -0.243238744235221  LUMO = 1.35929884021004
  mo_energy =
[-1.20320239e+02 -1.23795606e+01 -6.67689554e+00 -6.67689554e+00
 -6.67689554e+00 -1.17911522e+00 -2.43238744e-01 -2.43238744e-01
 -2.43238744e-01  1.35929884e+00  8.41239393e+00  3.42593291e+01
  1.49324278e+02  6.49341722e+02  2.79064835e+03  1.22654162e+04
  4.08833226e+04  1.04924970e+05  2.30107184e+05  4.55921293e+05
  8.44872949e+05  1.52804965e+06  2.85031637e+06  5.80820279e+06]
E1 = -706.6826356348049  E_coul = 198.70199974541617
cycle= 6 E= -507.980635889389  delta_E= 2.84e-13  |g|= 5e-08  |ddm|= 2.68e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6826356348049  E_coul = 198.70199974541617
  HOMO = -0.243238765464256  LUMO = 1.35929882573511
  mo_energy =
[-1.20320239e+02 -1.23795606e+01 -6.67689558e+00 -6.67689558e+00
 -6.67689558e+00 -1.17911523e+00 -2.43238765e-01 -2.43238765e-01
 -2.43238765e-01  1.35929883e+00  8.41239389e+00  3.42593291e+01
  1.49324278e+02  6.49341722e+02  2.79064835e+03  1.22654162e+04
  4.08833226e+04  1.04924970e+05  2.30107184e+05  4.55921293e+05
  8.44872949e+05  1.52804965e+06  2.85031637e+06  5.80820279e+06]
E1 = -706.6826355448875  E_coul = 198.70199965549827
Extra cycle  E= -507.980635889389  delta_E= -4.55e-13  |g|= 5.3e-09  |ddm|= 1.13e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908333.6059461979
E1 = -706.6826355448875  E_coul = 198.70199965549827
init E= -507.980635889389
    CPU time for initialize scf      3.32 sec, wall time      0.21 sec
  HOMO = -0.243238768277033  LUMO = 1.35929882283995
  mo_energy =
[-1.20320239e+02 -1.23795606e+01 -6.67689558e+00 -6.67689558e+00
 -6.67689558e+00 -1.17911523e+00 -2.43238768e-01 -2.43238768e-01
 -2.43238768e-01  1.35929882e+00  8.41239389e+00  3.42593290e+01
  1.49324278e+02  6.49341722e+02  2.79064835e+03  1.22654162e+04
  4.08833226e+04  1.04924970e+05  2.30107184e+05  4.55921293e+05
  8.44872949e+05  1.52804965e+06  2.85031637e+06  5.80820279e+06]
E1 = -706.6826355341169  E_coul = 198.70199964472803
cycle= 1 E= -507.980635889389  delta_E= 3.41e-13  |g|= 1.7e-09  |ddm|= 1.08e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6826355341169  E_coul = 198.70199964472803
  HOMO = -0.243238768594447  LUMO = 1.35929882482545
  mo_energy =
[-1.20320239e+02 -1.23795606e+01 -6.67689558e+00 -6.67689558e+00
 -6.67689558e+00 -1.17911523e+00 -2.43238769e-01 -2.43238769e-01
 -2.43238769e-01  1.35929882e+00  8.41239389e+00  3.42593290e+01
  1.49324278e+02  6.49341722e+02  2.79064835e+03  1.22654162e+04
  4.08833226e+04  1.04924970e+05  2.30107184e+05  4.55921293e+05
  8.44872949e+05  1.52804965e+06  2.85031637e+06  5.80820279e+06]
E1 = -706.6826355304173  E_coul = 198.7019996410279
Extra cycle  E= -507.980635889389  delta_E= -5.68e-13  |g|= 1.33e-09  |ddm|= 3.02e-09
    CPU time for scf_cycle      3.77 sec, wall time      0.38 sec
exp = [2.83001378e-01 8.55739650e-01 1.17616814e+05 2.30524008e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547148e+04 7.30314509e+03 1.83757989e+04
 1.44909013e+03 3.76280676e+02 1.14918535e+02 3.96195082e+01
 1.13781105e+01 5.51621959e+00 8.60779822e+00 4.92472046e-01]
grad_E = [-7.33165398e-03  6.61630215e-03  4.39465412e-09 -1.23566015e-03
  2.12820082e-11  1.19671480e-10  6.83565836e-10  2.68309121e-09
  1.11548285e-08  5.97531843e-08  3.77405817e-06  1.30935460e-07
 -2.94435409e-06  5.37522114e-05 -2.72830854e-04 -1.05124824e-03
 -2.56546729e-04  1.06265884e-03  3.21112121e-03 -8.93088160e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:10:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.233021974314       1
[INPUT] 0    0    [1    /1   ]  1e-09                1
[INPUT] 0    0    [1    /1   ]  117616.813828        1
[INPUT] 0    0    [1    /1   ]  5.40891570438        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031068        1
[INPUT] 0    0    [1    /1   ]  147020.991895        1
[INPUT] 0    0    [1    /1   ]  73510.4199219        1
[INPUT] 0    0    [1    /1   ]  36754.7143966        1
[INPUT] 0    0    [1    /1   ]  7303.12065265        1
[INPUT] 0    0    [1    /1   ]  18375.7980908        1
[INPUT] 0    0    [1    /1   ]  1449.11618348        1
[INPUT] 0    0    [1    /1   ]  375.883115904        1
[INPUT] 0    0    [1    /1   ]  116.722323234        1
[INPUT] 0    0    [1    /1   ]  41.4844519349        1
[INPUT] 0    0    [1    /1   ]  19.1170639992        1
[INPUT] 0    0    [1    /1   ]  9.80433933822        1
[INPUT] 1    0    [1    /1   ]  8.60831689143        1
[INPUT] 1    0    [1    /1   ]  0.492527851196       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2330219743143344, 1.0]], [0, [1e-09, 1.0]], [0, [117616.81382802958, 1.0]], [0, [5.408915704383779, 1.0]], [0, [1176168.1426170487, 1.0]], [0, [588084.0699814196, 1.0]], [0, [294042.03106750303, 1.0]], [0, [147020.99189533232, 1.0]], [0, [73510.41992185076, 1.0]], [0, [36754.71439662281, 1.0]], [0, [7303.120652652382, 1.0]], [0, [18375.79809084104, 1.0]], [0, [1449.1161834844788, 1.0]], [0, [375.88311590439196, 1.0]], [0, [116.72232323440532, 1.0]], [0, [41.484451934922994, 1.0]], [0, [19.117063999211087, 1.0]], [0, [9.80433933821648, 1.0]], [1, [8.608316891426663, 1.0]], [1, [0.49252785119631964, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23302197]
bas 1, expnt(s) = [1.e-09]
bas 2, expnt(s) = [117616.81382803]
bas 3, expnt(s) = [5.4089157]
bas 4, expnt(s) = [1176168.14261705]
bas 5, expnt(s) = [588084.06998142]
bas 6, expnt(s) = [294042.0310675]
bas 7, expnt(s) = [147020.99189533]
bas 8, expnt(s) = [73510.41992185]
bas 9, expnt(s) = [36754.71439662]
bas 10, expnt(s) = [7303.12065265]
bas 11, expnt(s) = [18375.79809084]
bas 12, expnt(s) = [1449.11618348]
bas 13, expnt(s) = [375.8831159]
bas 14, expnt(s) = [116.72232323]
bas 15, expnt(s) = [41.48445193]
bas 16, expnt(s) = [19.117064]
bas 17, expnt(s) = [9.80433934]
bas 18, expnt(s) = [8.60831689]
bas 19, expnt(s) = [0.49252785]
CPU time:       449.77
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.33021974e-01 8.47349705e-01 1.00000000e-09 4.49277867e-07
 1.17616814e+05 1.60460109e+04 5.40891570e+00 8.96081857e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104199e+04 1.12791586e+04 3.67547144e+04 6.70655999e+03
 7.30312065e+03 1.99593494e+03 1.83757981e+04 3.98749069e+03
 1.44911618e+03 5.93393014e+02 3.75883116e+02 2.15677399e+02
 1.16722323e+02 8.97181824e+01 4.14844519e+01 4.12980021e+01
 1.91170640e+01 2.30983480e+01 9.80433934e+00 1.39984121e+01
 8.60831689e+00 4.30162156e+01 4.92527851e-01 1.20371282e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.205843570105124
cond(S) = 909241.4718672181
E1 = -682.7861900968626  E_coul = 181.610815830233
init E= -501.17537426663
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.819323021995629  LUMO = -4.00738475355378e-05
  mo_energy =
[-1.21948921e+02 -1.34943835e+01 -7.86789759e+00 -7.86789759e+00
 -7.86789759e+00 -1.55588137e+00 -8.19323022e-01 -8.19323022e-01
 -8.19323022e-01 -4.00738475e-05  1.28134692e+01  6.38126481e+01
  2.06156774e+02  7.15147987e+02  2.85217704e+03  1.23195841e+04
  4.09334692e+04  1.04973027e+05  2.30153879e+05  4.55967002e+05
  8.44917902e+05  1.52809387e+06  2.85035967e+06  5.80824492e+06]
E1 = -703.6859048282131  E_coul = 196.22084246958872
cycle= 1 E= -507.465062358624  delta_E= -6.29  |g|= 0.453  |ddm|= 11.1
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.660807
diis-c [-0.43666541  1.        ]
  HOMO = -0.337632214321214  LUMO = 1.46484387323141e-09
  mo_energy =
[-1.20465263e+02 -1.24393965e+01 -6.86173447e+00 -6.86173447e+00
 -6.86173447e+00 -1.12175635e+00 -3.37632214e-01 -3.37632214e-01
 -3.37632214e-01  1.46484387e-09  1.38327236e+01  6.50311937e+01
  2.07555148e+02  7.16613486e+02  2.85358067e+03  1.23208777e+04
  4.09346956e+04  1.04974216e+05  2.30155044e+05  4.55968150e+05
  8.44919037e+05  1.52809499e+06  2.85036078e+06  5.80824602e+06]
E1 = -703.4514492859113  E_coul = 195.9814095863089
cycle= 2 E= -507.470039699602  delta_E= -0.00498  |g|= 0.015  |ddm|= 0.377
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0151178
diis-c [-2.27067070e-04  1.83854556e-03  9.98161454e-01]
  HOMO = -0.34060867649586  LUMO = 1.52641282678823e-09
  mo_energy =
[-1.20505035e+02 -1.24543199e+01 -6.88002740e+00 -6.88002740e+00
 -6.88002740e+00 -1.12283455e+00 -3.40608676e-01 -3.40608676e-01
 -3.40608676e-01  1.52641283e-09  1.38251606e+01  6.50105605e+01
  2.07523923e+02  7.16571327e+02  2.85352848e+03  1.23208189e+04
  4.09346344e+04  1.04974154e+05  2.30154981e+05  4.55968087e+05
  8.44918973e+05  1.52809493e+06  2.85036072e+06  5.80824596e+06]
E1 = -703.4433181471171  E_coul = 195.97327231019415
cycle= 3 E= -507.470045836923  delta_E= -6.14e-06  |g|= 0.000574  |ddm|= 0.0139
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000646263
diis-c [-4.41247907e-09  4.78752987e-05 -4.42312708e-02  1.04418340e+00]
  HOMO = -0.340719903131072  LUMO = 1.18438789365123e-09
  mo_energy =
[-1.20506472e+02 -1.24548834e+01 -6.88072459e+00 -6.88072459e+00
 -6.88072459e+00 -1.12287151e+00 -3.40719903e-01 -3.40719903e-01
 -3.40719903e-01  1.18438789e-09  1.38248704e+01  6.50097774e+01
  2.07522769e+02  7.16569855e+02  2.85352678e+03  1.23208171e+04
  4.09346325e+04  1.04974152e+05  2.30154980e+05  4.55968085e+05
  8.44918972e+05  1.52809492e+06  2.85036072e+06  5.80824596e+06]
E1 = -703.4429964661658  E_coul = 195.97295062046913
cycle= 4 E= -507.470045845697  delta_E= -8.77e-09  |g|= 2.29e-06  |ddm|= 0.000567
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.90386e-06
diis-c [-4.10702137e-13 -1.05548852e-06  6.45562652e-04 -1.27758109e-02
  1.01213130e+00]
  HOMO = -0.340719498621644  LUMO = 1.56769936384044e-09
  mo_energy =
[-1.20506468e+02 -1.24548816e+01 -6.88072254e+00 -6.88072254e+00
 -6.88072254e+00 -1.12287135e+00 -3.40719499e-01 -3.40719499e-01
 -3.40719499e-01  1.56769936e-09  1.38248713e+01  6.50097797e+01
  2.07522772e+02  7.16569860e+02  2.85352678e+03  1.23208171e+04
  4.09346325e+04  1.04974152e+05  2.30154980e+05  4.55968085e+05
  8.44918972e+05  1.52809492e+06  2.85036072e+06  5.80824596e+06]
E1 = -703.4429973123687  E_coul = 195.97295146667213
cycle= 5 E= -507.470045845697  delta_E= 1.71e-13  |g|= 4.01e-08  |ddm|= 1.65e-06
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -703.4429973123687  E_coul = 195.97295146667213
  HOMO = -0.34071949903074  LUMO = 1.54462288329854e-09
  mo_energy =
[-1.20506468e+02 -1.24548816e+01 -6.88072256e+00 -6.88072256e+00
 -6.88072256e+00 -1.12287135e+00 -3.40719499e-01 -3.40719499e-01
 -3.40719499e-01  1.54462288e-09  1.38248713e+01  6.50097796e+01
  2.07522772e+02  7.16569860e+02  2.85352678e+03  1.23208171e+04
  4.09346325e+04  1.04974152e+05  2.30154980e+05  4.55968085e+05
  8.44918972e+05  1.52809492e+06  2.85036072e+06  5.80824596e+06]
E1 = -703.442997301716  E_coul = 195.97295145601927
Extra cycle  E= -507.470045845697  delta_E= -2.27e-13  |g|= 1.96e-09  |ddm|= 3.75e-08
    CPU time for scf_cycle      1.05 sec, wall time      0.24 sec
exp = [2.33021974e-01 1.00000000e-09 1.17616814e+05 5.40891570e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104199e+04 3.67547144e+04 7.30312065e+03 1.83757981e+04
 1.44911618e+03 3.75883116e+02 1.16722323e+02 4.14844519e+01
 1.91170640e+01 9.80433934e+00 8.60831689e+00 4.92527851e-01]
E = -507.47004584569675
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:10:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.278003437742       1
[INPUT] 0    0    [1    /1   ]  0.770165685286       1
[INPUT] 0    0    [1    /1   ]  117616.813854        1
[INPUT] 0    0    [1    /1   ]  2.61560764027        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991911        1
[INPUT] 0    0    [1    /1   ]  73510.4199869        1
[INPUT] 0    0    [1    /1   ]  36754.7147447        1
[INPUT] 0    0    [1    /1   ]  7303.14264664        1
[INPUT] 0    0    [1    /1   ]  18375.7988559        1
[INPUT] 0    0    [1    /1   ]  1449.09273781        1
[INPUT] 0    0    [1    /1   ]  376.240919951        1
[INPUT] 0    0    [1    /1   ]  115.098914087        1
[INPUT] 0    0    [1    /1   ]  39.8060025971        1
[INPUT] 0    0    [1    /1   ]  12.1520058648        1
[INPUT] 0    0    [1    /1   ]  5.94503156688        1
[INPUT] 1    0    [1    /1   ]  8.60785008801        1
[INPUT] 1    0    [1    /1   ]  0.492477626216       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2780034377417925, 1.0]], [0, [0.7701656852858767, 1.0]], [0, [117616.81385364353, 1.0]], [0, [2.615607640265165, 1.0]], [0, [1176168.142617174, 1.0]], [0, [588084.069982118, 1.0]], [0, [294042.0310714868, 1.0]], [0, [147020.99191097202, 1.0]], [0, [73510.41998687931, 1.0]], [0, [36754.71474473597, 1.0]], [0, [7303.142646642662, 1.0]], [0, [18375.798855865414, 1.0]], [0, [1449.0927378127276, 1.0]], [0, [376.2409199512417, 1.0]], [0, [115.09891408650552, 1.0]], [0, [39.80600259712891, 1.0]], [0, [12.152005864801444, 1.0]], [0, [5.945031566880014, 1.0]], [1, [8.607850088009778, 1.0]], [1, [0.49247762621643987, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.27800344]
bas 1, expnt(s) = [0.77016569]
bas 2, expnt(s) = [117616.81385364]
bas 3, expnt(s) = [2.61560764]
bas 4, expnt(s) = [1176168.14261717]
bas 5, expnt(s) = [588084.06998212]
bas 6, expnt(s) = [294042.03107149]
bas 7, expnt(s) = [147020.99191097]
bas 8, expnt(s) = [73510.41998688]
bas 9, expnt(s) = [36754.71474474]
bas 10, expnt(s) = [7303.14264664]
bas 11, expnt(s) = [18375.79885587]
bas 12, expnt(s) = [1449.09273781]
bas 13, expnt(s) = [376.24091995]
bas 14, expnt(s) = [115.09891409]
bas 15, expnt(s) = [39.8060026]
bas 16, expnt(s) = [12.15200586]
bas 17, expnt(s) = [5.94503157]
bas 18, expnt(s) = [8.60785009]
bas 19, expnt(s) = [0.49247763]
CPU time:       451.06
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.78003438e-01 9.67280982e-01 7.70165685e-01 2.07707964e+00
 1.17616814e+05 1.60460109e+04 2.61560764e+00 5.19630306e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656004e+03
 7.30314265e+03 1.99593945e+03 1.83757989e+04 3.98749081e+03
 1.44909274e+03 5.93385814e+02 3.76240920e+02 2.15831359e+02
 1.15098914e+02 8.87806753e+01 3.98060026e+01 4.00383756e+01
 1.21520059e+01 1.64437552e+01 5.94503157e+00 9.61901602e+00
 8.60785009e+00 4.30132998e+01 4.92477626e-01 1.20355938e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335859933926507
cond(S) = 908416.698345053
E1 = -689.6022697619292  E_coul = 184.98038155229415
init E= -504.621888209635
    CPU time for initialize scf      0.63 sec, wall time      0.08 sec
  HOMO = -0.67243931762143  LUMO = 0.87808158042915
  mo_energy =
[-1.21703286e+02 -1.33853082e+01 -7.62288011e+00 -7.62288011e+00
 -7.62288011e+00 -1.65739899e+00 -6.72439318e-01 -6.72439318e-01
 -6.72439318e-01  8.78081580e-01  8.20015246e+00  3.63174647e+01
  1.54055690e+02  6.54654163e+02  2.79552282e+03  1.22696644e+04
  4.08872405e+04  1.04928718e+05  2.30110822e+05  4.55924851e+05
  8.44876445e+05  1.52805308e+06  2.85031972e+06  5.80820604e+06]
E1 = -707.7447750359662  E_coul = 199.78114654703765
cycle= 1 E= -507.963628488929  delta_E= -3.34  |g|= 0.452  |ddm|= 0.479
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.686024
diis-c [-0.47062916  1.        ]
  HOMO = -0.218523354198928  LUMO = 1.28996024523881
  mo_energy =
[-1.20194606e+02 -1.23042574e+01 -6.59372394e+00 -6.59372394e+00
 -6.59372394e+00 -1.16355763e+00 -2.18523354e-01 -2.18523354e-01
 -2.18523354e-01  1.28996025e+00  8.95682370e+00  3.74193272e+01
  1.55458032e+02  6.56144778e+02  2.79695417e+03  1.22709867e+04
  4.08884960e+04  1.04929937e+05  2.30112017e+05  4.55926029e+05
  8.44877610e+05  1.52805424e+06  2.85032086e+06  5.80820717e+06]
E1 = -706.8074845519241  E_coul = 198.82631719847018
cycle= 2 E= -507.981167353454  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.418
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.029383
diis-c [-8.61560561e-04 -1.96243146e-03  1.00196243e+00]
  HOMO = -0.23996035871981  LUMO = 1.28348946860069
  mo_energy =
[-1.20308115e+02 -1.23707555e+01 -6.66747903e+00 -6.66747903e+00
 -6.66747903e+00 -1.17727674e+00 -2.39960359e-01 -2.39960359e-01
 -2.39960359e-01  1.28348947e+00  8.91816096e+00  3.73513867e+01
  1.55361615e+02  6.56027444e+02  2.79682064e+03  1.22708429e+04
  4.08883485e+04  1.04929788e+05  2.30111867e+05  4.55925878e+05
  8.44877459e+05  1.52805409e+06  2.85032071e+06  5.80820702e+06]
E1 = -706.707168003499  E_coul = 198.72577202391125
cycle= 3 E= -507.981395979588  delta_E= -0.000229  |g|= 0.00403  |ddm|= 0.0572
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00303031
diis-c [-2.16165408e-06  1.45732331e-04 -9.95070905e-02  1.09936136e+00]
  HOMO = -0.242771543951163  LUMO = 1.28242689794006
  mo_energy =
[-1.20319154e+02 -1.23786765e+01 -6.67587689e+00 -6.67587689e+00
 -6.67587689e+00 -1.17896448e+00 -2.42771544e-01 -2.42771544e-01
 -2.42771544e-01  1.28242690e+00  8.91310048e+00  3.73435364e+01
  1.55351674e+02  6.56016269e+02  2.79680868e+03  1.22708305e+04
  4.08883359e+04  1.04929775e+05  2.30111854e+05  4.55925866e+05
  8.44877446e+05  1.52805407e+06  2.85032070e+06  5.80820701e+06]
E1 = -706.6941300439785  E_coul = 198.71273042086244
cycle= 4 E= -507.981399623116  delta_E= -3.64e-06  |g|= 0.000175  |ddm|= 0.0084
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000131601
diis-c [-9.79724369e-11 -6.26172578e-06  6.29953214e-03 -9.33739227e-02
  1.08708065e+00]
  HOMO = -0.242886829857597  LUMO = 1.28237755064942
  mo_energy =
[-1.20319453e+02 -1.23789618e+01 -6.67616009e+00 -6.67616009e+00
 -6.67616009e+00 -1.17903316e+00 -2.42886830e-01 -2.42886830e-01
 -2.42886830e-01  1.28237755e+00  8.91289706e+00  3.73432661e+01
  1.55351382e+02  6.56015970e+02  2.79680837e+03  1.22708302e+04
  4.08883356e+04  1.04929775e+05  2.30111854e+05  4.55925865e+05
  8.44877446e+05  1.52805407e+06  2.85032070e+06  5.80820701e+06]
E1 = -706.6936057335203  E_coul = 198.71220610382332
cycle= 5 E= -507.981399629697  delta_E= -6.58e-09  |g|= 1.11e-06  |ddm|= 0.0004
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.22979e-07
diis-c [-7.22662808e-14  2.09001351e-07 -1.37896295e-04  1.87631862e-03
 -2.28017561e-02  1.02106312e+00]
  HOMO = -0.242887383381489  LUMO = 1.28237741534596
  mo_energy =
[-1.20319455e+02 -1.23789630e+01 -6.67616136e+00 -6.67616136e+00
 -6.67616136e+00 -1.17903360e+00 -2.42887383e-01 -2.42887383e-01
 -2.42887383e-01  1.28237742e+00  8.91289614e+00  3.73432649e+01
  1.55351380e+02  6.56015968e+02  2.79680837e+03  1.22708302e+04
  4.08883356e+04  1.04929775e+05  2.30111854e+05  4.55925865e+05
  8.44877446e+05  1.52805407e+06  2.85032070e+06  5.80820701e+06]
E1 = -706.693603158523  E_coul = 198.71220352882597
cycle= 6 E= -507.981399629697  delta_E= -1.14e-13  |g|= 4.64e-08  |ddm|= 2.46e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.693603158523  E_coul = 198.71220352882597
  HOMO = -0.242887404184696  LUMO = 1.28237740423612
  mo_energy =
[-1.20319455e+02 -1.23789631e+01 -6.67616140e+00 -6.67616140e+00
 -6.67616140e+00 -1.17903361e+00 -2.42887404e-01 -2.42887404e-01
 -2.42887404e-01  1.28237740e+00  8.91289610e+00  3.73432649e+01
  1.55351380e+02  6.56015968e+02  2.79680837e+03  1.22708302e+04
  4.08883356e+04  1.04929775e+05  2.30111854e+05  4.55925865e+05
  8.44877446e+05  1.52805407e+06  2.85032070e+06  5.80820701e+06]
E1 = -706.6936030660198  E_coul = 198.71220343632268
Extra cycle  E= -507.981399629697  delta_E= -5.68e-14  |g|= 4.8e-09  |ddm|= 9.47e-08
    CPU time for scf_cycle      1.32 sec, wall time      0.29 sec
exp = [2.78003438e-01 7.70165685e-01 1.17616814e+05 2.61560764e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314265e+03 1.83757989e+04
 1.44909274e+03 3.76240920e+02 1.15098914e+02 3.98060026e+01
 1.21520059e+01 5.94503157e+00 8.60785009e+00 4.92477626e-01]
E = -507.98139962969714
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:10:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.278003437742       1
[INPUT] 0    0    [1    /1   ]  0.770165685286       1
[INPUT] 0    0    [1    /1   ]  117616.813854        1
[INPUT] 0    0    [1    /1   ]  2.61560764027        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991911        1
[INPUT] 0    0    [1    /1   ]  73510.4199869        1
[INPUT] 0    0    [1    /1   ]  36754.7147447        1
[INPUT] 0    0    [1    /1   ]  7303.14264664        1
[INPUT] 0    0    [1    /1   ]  18375.7988559        1
[INPUT] 0    0    [1    /1   ]  1449.09273781        1
[INPUT] 0    0    [1    /1   ]  376.240919951        1
[INPUT] 0    0    [1    /1   ]  115.098914087        1
[INPUT] 0    0    [1    /1   ]  39.8060025971        1
[INPUT] 0    0    [1    /1   ]  12.1520058648        1
[INPUT] 0    0    [1    /1   ]  5.94503156688        1
[INPUT] 1    0    [1    /1   ]  8.60785008801        1
[INPUT] 1    0    [1    /1   ]  0.492477626216       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2780034377417925, 1.0]], [0, [0.7701656852858767, 1.0]], [0, [117616.81385364353, 1.0]], [0, [2.615607640265165, 1.0]], [0, [1176168.142617174, 1.0]], [0, [588084.069982118, 1.0]], [0, [294042.0310714868, 1.0]], [0, [147020.99191097202, 1.0]], [0, [73510.41998687931, 1.0]], [0, [36754.71474473597, 1.0]], [0, [7303.142646642662, 1.0]], [0, [18375.798855865414, 1.0]], [0, [1449.0927378127276, 1.0]], [0, [376.2409199512417, 1.0]], [0, [115.09891408650552, 1.0]], [0, [39.80600259712891, 1.0]], [0, [12.152005864801444, 1.0]], [0, [5.945031566880014, 1.0]], [1, [8.607850088009778, 1.0]], [1, [0.49247762621643987, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.27800344]
bas 1, expnt(s) = [0.77016569]
bas 2, expnt(s) = [117616.81385364]
bas 3, expnt(s) = [2.61560764]
bas 4, expnt(s) = [1176168.14261717]
bas 5, expnt(s) = [588084.06998212]
bas 6, expnt(s) = [294042.03107149]
bas 7, expnt(s) = [147020.99191097]
bas 8, expnt(s) = [73510.41998688]
bas 9, expnt(s) = [36754.71474474]
bas 10, expnt(s) = [7303.14264664]
bas 11, expnt(s) = [18375.79885587]
bas 12, expnt(s) = [1449.09273781]
bas 13, expnt(s) = [376.24091995]
bas 14, expnt(s) = [115.09891409]
bas 15, expnt(s) = [39.8060026]
bas 16, expnt(s) = [12.15200586]
bas 17, expnt(s) = [5.94503157]
bas 18, expnt(s) = [8.60785009]
bas 19, expnt(s) = [0.49247763]
CPU time:       452.63
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.78003438e-01 9.67280982e-01 7.70165685e-01 2.07707964e+00
 1.17616814e+05 1.60460109e+04 2.61560764e+00 5.19630306e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656004e+03
 7.30314265e+03 1.99593945e+03 1.83757989e+04 3.98749081e+03
 1.44909274e+03 5.93385814e+02 3.76240920e+02 2.15831359e+02
 1.15098914e+02 8.87806753e+01 3.98060026e+01 4.00383756e+01
 1.21520059e+01 1.64437552e+01 5.94503157e+00 9.61901602e+00
 8.60785009e+00 4.30132998e+01 4.92477626e-01 1.20355938e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335859933926507
cond(S) = 908416.698345053
E1 = -689.6022697619292  E_coul = 184.98038155229415
init E= -504.621888209635
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.67243931762143  LUMO = 0.87808158042915
  mo_energy =
[-1.21703286e+02 -1.33853082e+01 -7.62288011e+00 -7.62288011e+00
 -7.62288011e+00 -1.65739899e+00 -6.72439318e-01 -6.72439318e-01
 -6.72439318e-01  8.78081580e-01  8.20015246e+00  3.63174647e+01
  1.54055690e+02  6.54654163e+02  2.79552282e+03  1.22696644e+04
  4.08872405e+04  1.04928718e+05  2.30110822e+05  4.55924851e+05
  8.44876445e+05  1.52805308e+06  2.85031972e+06  5.80820604e+06]
E1 = -707.7447750359662  E_coul = 199.78114654703765
cycle= 1 E= -507.963628488929  delta_E= -3.34  |g|= 0.452  |ddm|= 0.479
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.686024
diis-c [-0.47062916  1.        ]
  HOMO = -0.218523354198928  LUMO = 1.28996024523881
  mo_energy =
[-1.20194606e+02 -1.23042574e+01 -6.59372394e+00 -6.59372394e+00
 -6.59372394e+00 -1.16355763e+00 -2.18523354e-01 -2.18523354e-01
 -2.18523354e-01  1.28996025e+00  8.95682370e+00  3.74193272e+01
  1.55458032e+02  6.56144778e+02  2.79695417e+03  1.22709867e+04
  4.08884960e+04  1.04929937e+05  2.30112017e+05  4.55926029e+05
  8.44877610e+05  1.52805424e+06  2.85032086e+06  5.80820717e+06]
E1 = -706.8074845519241  E_coul = 198.82631719847018
cycle= 2 E= -507.981167353454  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.418
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.029383
diis-c [-8.61560561e-04 -1.96243146e-03  1.00196243e+00]
  HOMO = -0.23996035871981  LUMO = 1.28348946860069
  mo_energy =
[-1.20308115e+02 -1.23707555e+01 -6.66747903e+00 -6.66747903e+00
 -6.66747903e+00 -1.17727674e+00 -2.39960359e-01 -2.39960359e-01
 -2.39960359e-01  1.28348947e+00  8.91816096e+00  3.73513867e+01
  1.55361615e+02  6.56027444e+02  2.79682064e+03  1.22708429e+04
  4.08883485e+04  1.04929788e+05  2.30111867e+05  4.55925878e+05
  8.44877459e+05  1.52805409e+06  2.85032071e+06  5.80820702e+06]
E1 = -706.707168003499  E_coul = 198.72577202391125
cycle= 3 E= -507.981395979588  delta_E= -0.000229  |g|= 0.00403  |ddm|= 0.0572
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00303031
diis-c [-2.16165408e-06  1.45732331e-04 -9.95070905e-02  1.09936136e+00]
  HOMO = -0.242771543951163  LUMO = 1.28242689794006
  mo_energy =
[-1.20319154e+02 -1.23786765e+01 -6.67587689e+00 -6.67587689e+00
 -6.67587689e+00 -1.17896448e+00 -2.42771544e-01 -2.42771544e-01
 -2.42771544e-01  1.28242690e+00  8.91310048e+00  3.73435364e+01
  1.55351674e+02  6.56016269e+02  2.79680868e+03  1.22708305e+04
  4.08883359e+04  1.04929775e+05  2.30111854e+05  4.55925866e+05
  8.44877446e+05  1.52805407e+06  2.85032070e+06  5.80820701e+06]
E1 = -706.6941300439785  E_coul = 198.71273042086244
cycle= 4 E= -507.981399623116  delta_E= -3.64e-06  |g|= 0.000175  |ddm|= 0.0084
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000131601
diis-c [-9.79724369e-11 -6.26172578e-06  6.29953214e-03 -9.33739227e-02
  1.08708065e+00]
  HOMO = -0.242886829857597  LUMO = 1.28237755064942
  mo_energy =
[-1.20319453e+02 -1.23789618e+01 -6.67616009e+00 -6.67616009e+00
 -6.67616009e+00 -1.17903316e+00 -2.42886830e-01 -2.42886830e-01
 -2.42886830e-01  1.28237755e+00  8.91289706e+00  3.73432661e+01
  1.55351382e+02  6.56015970e+02  2.79680837e+03  1.22708302e+04
  4.08883356e+04  1.04929775e+05  2.30111854e+05  4.55925865e+05
  8.44877446e+05  1.52805407e+06  2.85032070e+06  5.80820701e+06]
E1 = -706.6936057335203  E_coul = 198.71220610382332
cycle= 5 E= -507.981399629697  delta_E= -6.58e-09  |g|= 1.11e-06  |ddm|= 0.0004
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.22979e-07
diis-c [-7.22662808e-14  2.09001351e-07 -1.37896295e-04  1.87631862e-03
 -2.28017561e-02  1.02106312e+00]
  HOMO = -0.242887383381489  LUMO = 1.28237741534596
  mo_energy =
[-1.20319455e+02 -1.23789630e+01 -6.67616136e+00 -6.67616136e+00
 -6.67616136e+00 -1.17903360e+00 -2.42887383e-01 -2.42887383e-01
 -2.42887383e-01  1.28237742e+00  8.91289614e+00  3.73432649e+01
  1.55351380e+02  6.56015968e+02  2.79680837e+03  1.22708302e+04
  4.08883356e+04  1.04929775e+05  2.30111854e+05  4.55925865e+05
  8.44877446e+05  1.52805407e+06  2.85032070e+06  5.80820701e+06]
E1 = -706.693603158523  E_coul = 198.71220352882597
cycle= 6 E= -507.981399629697  delta_E= -1.14e-13  |g|= 4.64e-08  |ddm|= 2.46e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.693603158523  E_coul = 198.71220352882597
  HOMO = -0.242887404184696  LUMO = 1.28237740423612
  mo_energy =
[-1.20319455e+02 -1.23789631e+01 -6.67616140e+00 -6.67616140e+00
 -6.67616140e+00 -1.17903361e+00 -2.42887404e-01 -2.42887404e-01
 -2.42887404e-01  1.28237740e+00  8.91289610e+00  3.73432649e+01
  1.55351380e+02  6.56015968e+02  2.79680837e+03  1.22708302e+04
  4.08883356e+04  1.04929775e+05  2.30111854e+05  4.55925865e+05
  8.44877446e+05  1.52805407e+06  2.85032070e+06  5.80820701e+06]
E1 = -706.6936030660198  E_coul = 198.71220343632268
Extra cycle  E= -507.981399629697  delta_E= -5.68e-14  |g|= 4.8e-09  |ddm|= 9.47e-08
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908416.698345053
E1 = -706.6936030660198  E_coul = 198.71220343632268
init E= -507.981399629697
    CPU time for initialize scf      3.33 sec, wall time      0.21 sec
  HOMO = -0.242887407036331  LUMO = 1.2823774007399
  mo_energy =
[-1.20319455e+02 -1.23789631e+01 -6.67616140e+00 -6.67616140e+00
 -6.67616140e+00 -1.17903361e+00 -2.42887407e-01 -2.42887407e-01
 -2.42887407e-01  1.28237740e+00  8.91289610e+00  3.73432649e+01
  1.55351380e+02  6.56015968e+02  2.79680837e+03  1.22708302e+04
  4.08883356e+04  1.04929775e+05  2.30111854e+05  4.55925865e+05
  8.44877446e+05  1.52805407e+06  2.85032070e+06  5.80820701e+06]
E1 = -706.6936030542223  E_coul = 198.7122034245252
cycle= 1 E= -507.981399629697  delta_E= 5.68e-14  |g|= 1.27e-09  |ddm|= 9.69e-09
    CPU time for cycle= 1      0.32 sec, wall time      0.03 sec
E1 = -706.6936030542223  E_coul = 198.7122034245252
  HOMO = -0.242887407373682  LUMO = 1.28237740206335
  mo_energy =
[-1.20319455e+02 -1.23789631e+01 -6.67616140e+00 -6.67616140e+00
 -6.67616140e+00 -1.17903361e+00 -2.42887407e-01 -2.42887407e-01
 -2.42887407e-01  1.28237740e+00  8.91289610e+00  3.73432649e+01
  1.55351380e+02  6.56015968e+02  2.79680837e+03  1.22708302e+04
  4.08883356e+04  1.04929775e+05  2.30111854e+05  4.55925865e+05
  8.44877446e+05  1.52805407e+06  2.85032070e+06  5.80820701e+06]
E1 = -706.6936030521714  E_coul = 198.71220342247435
Extra cycle  E= -507.981399629697  delta_E=    0  |g|= 1.07e-09  |ddm|= 1.7e-09
    CPU time for scf_cycle      3.79 sec, wall time      0.38 sec
exp = [2.78003438e-01 7.70165685e-01 1.17616814e+05 2.61560764e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314265e+03 1.83757989e+04
 1.44909274e+03 3.76240920e+02 1.15098914e+02 3.98060026e+01
 1.21520059e+01 5.94503157e+00 8.60785009e+00 4.92477626e-01]
grad_E = [ 9.80022152e-03  3.96560355e-03  4.35908845e-09  2.84571318e-04
  2.08632092e-11  1.18514813e-10  6.78068781e-10  2.66110337e-09
  1.10620895e-08  5.92975510e-08  3.74222742e-06  1.29533176e-07
 -1.26427470e-06  3.39821613e-05 -1.91295751e-04 -1.21352281e-03
 -2.96743839e-06  1.64639067e-04  3.31428537e-03 -7.97174641e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:10:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249817954124       1
[INPUT] 0    0    [1    /1   ]  0.515785655541       1
[INPUT] 0    0    [1    /1   ]  117616.81385         1
[INPUT] 0    0    [1    /1   ]  2.94582851286        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991909        1
[INPUT] 0    0    [1    /1   ]  73510.4199777        1
[INPUT] 0    0    [1    /1   ]  36754.7146958        1
[INPUT] 0    0    [1    /1   ]  7303.13955141        1
[INPUT] 0    0    [1    /1   ]  18375.798748         1
[INPUT] 0    0    [1    /1   ]  1449.09707084        1
[INPUT] 0    0    [1    /1   ]  376.175739704        1
[INPUT] 0    0    [1    /1   ]  115.417423669        1
[INPUT] 0    0    [1    /1   ]  39.8863490195        1
[INPUT] 0    0    [1    /1   ]  13.1386214229        1
[INPUT] 0    0    [1    /1   ]  6.46184854943        1
[INPUT] 1    0    [1    /1   ]  8.60849318295        1
[INPUT] 1    0    [1    /1   ]  0.492448218999       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24981795412378793, 1.0]], [0, [0.5157856555414002, 1.0]], [0, [117616.81385003992, 1.0]], [0, [2.945828512860039, 1.0]], [0, [1176168.1426171563, 1.0]], [0, [588084.0699820196, 1.0]], [0, [294042.03107092634, 1.0]], [0, [147020.99190877154, 1.0]], [0, [73510.41997772906, 1.0]], [0, [36754.714695776325, 1.0]], [0, [7303.139551407301, 1.0]], [0, [18375.798748036304, 1.0]], [0, [1449.0970708350744, 1.0]], [0, [376.17573970438895, 1.0]], [0, [115.41742366850909, 1.0]], [0, [39.8863490195277, 1.0]], [0, [13.138621422888784, 1.0]], [0, [6.4618485494290105, 1.0]], [1, [8.608493182949468, 1.0]], [1, [0.49244821899880614, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24981795]
bas 1, expnt(s) = [0.51578566]
bas 2, expnt(s) = [117616.81385004]
bas 3, expnt(s) = [2.94582851]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998202]
bas 6, expnt(s) = [294042.03107093]
bas 7, expnt(s) = [147020.99190877]
bas 8, expnt(s) = [73510.41997773]
bas 9, expnt(s) = [36754.71469578]
bas 10, expnt(s) = [7303.13955141]
bas 11, expnt(s) = [18375.79874804]
bas 12, expnt(s) = [1449.09707084]
bas 13, expnt(s) = [376.1757397]
bas 14, expnt(s) = [115.41742367]
bas 15, expnt(s) = [39.88634902]
bas 16, expnt(s) = [13.13862142]
bas 17, expnt(s) = [6.46184855]
bas 18, expnt(s) = [8.60849318]
bas 19, expnt(s) = [0.49244822]
CPU time:       464.18
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49817954e-01 8.92755963e-01 5.15785656e-01 1.53768355e+00
 1.17616814e+05 1.60460109e+04 2.94582851e+00 5.68094547e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30313955e+03 1.99593881e+03 1.83757987e+04 3.98749080e+03
 1.44909707e+03 5.93387144e+02 3.76175740e+02 2.15803315e+02
 1.15417424e+02 8.89648716e+01 3.98863490e+01 4.00989719e+01
 1.31386214e+01 1.74352177e+01 6.46184855e+00 1.02395909e+01
 8.60849318e+00 4.30173168e+01 4.92448219e-01 1.20346955e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33475924020424
cond(S) = 908494.0620109146
E1 = -689.504451561119  E_coul = 184.92326147542713
init E= -504.581190085692
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.674976146668866  LUMO = 0.550976219505427
  mo_energy =
[-1.21707165e+02 -1.33890809e+01 -7.62702837e+00 -7.62702837e+00
 -7.62702837e+00 -1.65615878e+00 -6.74976147e-01 -6.74976147e-01
 -6.74976147e-01  5.50976220e-01  7.88202444e+00  3.90974210e+01
  1.60304598e+02  6.61863319e+02  2.80229191e+03  1.22756294e+04
  4.08927654e+04  1.04934014e+05  2.30115969e+05  4.55929890e+05
  8.44881402e+05  1.52805796e+06  2.85032450e+06  5.80821069e+06]
E1 = -707.668002489338  E_coul = 199.70749478391537
cycle= 1 E= -507.960507705423  delta_E= -3.38  |g|= 0.451  |ddm|= 0.746
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.683227
diis-c [-0.4667988  1.       ]
  HOMO = -0.219479697942458  LUMO = 0.908917971688099
  mo_energy =
[-1.20202660e+02 -1.23098772e+01 -6.60013884e+00 -6.60013884e+00
 -6.60013884e+00 -1.16246017e+00 -2.19479698e-01 -2.19479698e-01
 -2.19479698e-01  9.08917972e-01  8.66883880e+00  4.02240319e+01
  1.61706491e+02  6.63349377e+02  2.80371825e+03  1.22769462e+04
  4.08940153e+04  1.04935227e+05  2.30117158e+05  4.55931062e+05
  8.44882560e+05  1.52805911e+06  2.85032564e+06  5.80821182e+06]
E1 = -706.779648764728  E_coul = 198.80279039505675
cycle= 2 E= -507.976858369671  delta_E= -0.0164  |g|= 0.034  |ddm|= 0.502
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0279363
diis-c [-7.79496518e-04 -1.42226242e-03  1.00142226e+00]
  HOMO = -0.23971425506085  LUMO = 0.90497178685673
  mo_energy =
[-1.20311025e+02 -1.23725775e+01 -6.66988605e+00 -6.66988605e+00
 -6.66988605e+00 -1.17538524e+00 -2.39714255e-01 -2.39714255e-01
 -2.39714255e-01  9.04971787e-01  8.63212717e+00  4.01578712e+01
  1.61614419e+02  6.63237281e+02  2.80359034e+03  1.22768082e+04
  4.08938736e+04  1.04935084e+05  2.30117014e+05  4.55930917e+05
  8.44882415e+05  1.52805896e+06  2.85032549e+06  5.80821167e+06]
E1 = -706.6769228514061  E_coul = 198.69981238099473
cycle= 3 E= -507.977110470411  delta_E= -0.000252  |g|= 0.00441  |ddm|= 0.073
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00292528
diis-c [-2.06625398e-06  6.70017308e-05 -1.00611436e-01  1.10054443e+00]
  HOMO = -0.24269997129143  LUMO = 0.904172194040005
  mo_energy =
[-1.20322284e+02 -1.23807198e+01 -6.67850181e+00 -6.67850181e+00
 -6.67850181e+00 -1.17719057e+00 -2.42699971e-01 -2.42699971e-01
 -2.42699971e-01  9.04172194e-01  8.62674623e+00  4.01496222e+01
  1.61604234e+02  6.63225885e+02  2.80357815e+03  1.22767956e+04
  4.08938608e+04  1.04935071e+05  2.30117001e+05  4.55930904e+05
  8.44882402e+05  1.52805895e+06  2.85032548e+06  5.80821166e+06]
E1 = -706.6617972889673  E_coul = 198.68468151878957
cycle= 4 E= -507.977115770178  delta_E= -5.3e-06  |g|= 0.000277  |ddm|= 0.0121
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000158783
diis-c [-2.60670679e-10 -7.07468133e-06  7.35074530e-03 -1.13650131e-01
  1.10630646e+00]
  HOMO = -0.242879801720275  LUMO = 0.904116250915619
  mo_energy =
[-1.20322755e+02 -1.23811507e+01 -6.67893404e+00 -6.67893404e+00
 -6.67893404e+00 -1.17729870e+00 -2.42879802e-01 -2.42879802e-01
 -2.42879802e-01  9.04116251e-01  8.62642756e+00  4.01492037e+01
  1.61603778e+02  6.63225412e+02  2.80357767e+03  1.22767951e+04
  4.08938603e+04  1.04935071e+05  2.30117000e+05  4.55930904e+05
  8.44882402e+05  1.52805895e+06  2.85032548e+06  5.80821166e+06]
E1 = -706.6608873333912  E_coul = 198.68377154272537
cycle= 5 E= -507.977115790666  delta_E= -2.05e-08  |g|= 3.31e-06  |ddm|= 0.000825
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.46332e-06
diis-c [-2.80557010e-13  4.58045886e-07 -3.56289204e-04  5.15660365e-03
 -5.47515296e-02  1.04995076e+00]
  HOMO = -0.242881681262328  LUMO = 0.904115814278464
  mo_energy =
[-1.20322761e+02 -1.23811550e+01 -6.67893853e+00 -6.67893853e+00
 -6.67893853e+00 -1.17729999e+00 -2.42881681e-01 -2.42881681e-01
 -2.42881681e-01  9.04115814e-01  8.62642425e+00  4.01491994e+01
  1.61603773e+02  6.63225406e+02  2.80357766e+03  1.22767951e+04
  4.08938603e+04  1.04935071e+05  2.30117000e+05  4.55930904e+05
  8.44882402e+05  1.52805895e+06  2.85032548e+06  5.80821166e+06]
E1 = -706.6608772617445  E_coul = 198.68376147107548
cycle= 6 E= -507.977115790669  delta_E= -3.18e-12  |g|= 6.86e-08  |ddm|= 9.7e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6608772617445  E_coul = 198.68376147107548
  HOMO = -0.242881716496901  LUMO = 0.904115795656114
  mo_energy =
[-1.20322761e+02 -1.23811551e+01 -6.67893860e+00 -6.67893860e+00
 -6.67893860e+00 -1.17730001e+00 -2.42881716e-01 -2.42881716e-01
 -2.42881716e-01  9.04115796e-01  8.62642419e+00  4.01491993e+01
  1.61603773e+02  6.63225406e+02  2.80357766e+03  1.22767951e+04
  4.08938603e+04  1.04935071e+05  2.30117000e+05  4.55930904e+05
  8.44882402e+05  1.52805895e+06  2.85032548e+06  5.80821166e+06]
E1 = -706.6608770947635  E_coul = 198.68376130409433
Extra cycle  E= -507.977115790669  delta_E= -1.14e-13  |g|= 9.46e-09  |ddm|= 1.69e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.27 sec
exp = [2.49817954e-01 5.15785656e-01 1.17616814e+05 2.94582851e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30313955e+03 1.83757987e+04
 1.44909707e+03 3.76175740e+02 1.15417424e+02 3.98863490e+01
 1.31386214e+01 6.46184855e+00 8.60849318e+00 4.92448219e-01]
E = -507.97711579066913
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:10:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.274786401934       1
[INPUT] 0    0    [1    /1   ]  0.741131247719       1
[INPUT] 0    0    [1    /1   ]  117616.813853        1
[INPUT] 0    0    [1    /1   ]  2.65329840285        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991911        1
[INPUT] 0    0    [1    /1   ]  73510.4199858        1
[INPUT] 0    0    [1    /1   ]  36754.7147391        1
[INPUT] 0    0    [1    /1   ]  7303.14229336        1
[INPUT] 0    0    [1    /1   ]  18375.7988436        1
[INPUT] 0    0    [1    /1   ]  1449.09323238        1
[INPUT] 0    0    [1    /1   ]  376.233480406        1
[INPUT] 0    0    [1    /1   ]  115.135268145        1
[INPUT] 0    0    [1    /1   ]  39.8151731802        1
[INPUT] 0    0    [1    /1   ]  12.2646162291        1
[INPUT] 0    0    [1    /1   ]  6.00402004341        1
[INPUT] 1    0    [1    /1   ]  8.6079234896         1
[INPUT] 1    0    [1    /1   ]  0.492474269734       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2747864019343509, 1.0]], [0, [0.7411312477194661, 1.0]], [0, [117616.81385323222, 1.0]], [0, [2.6532984028541637, 1.0]], [0, [1176168.1426171719, 1.0]], [0, [588084.0699821068, 1.0]], [0, [294042.03107142285, 1.0]], [0, [147020.99191072086, 1.0]], [0, [73510.41998583492, 1.0]], [0, [36754.71473914781, 1.0]], [0, [7303.14229335857, 1.0]], [0, [18375.798843558012, 1.0]], [0, [1449.093232375398, 1.0]], [0, [376.23348040573296, 1.0]], [0, [115.13526814536098, 1.0]], [0, [39.815173180162354, 1.0]], [0, [12.264616229113889, 1.0]], [0, [6.004020043405284, 1.0]], [1, [8.607923489604607, 1.0]], [1, [0.4924742697343086, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2747864]
bas 1, expnt(s) = [0.74113125]
bas 2, expnt(s) = [117616.81385323]
bas 3, expnt(s) = [2.6532984]
bas 4, expnt(s) = [1176168.14261717]
bas 5, expnt(s) = [588084.06998211]
bas 6, expnt(s) = [294042.03107142]
bas 7, expnt(s) = [147020.99191072]
bas 8, expnt(s) = [73510.41998583]
bas 9, expnt(s) = [36754.71473915]
bas 10, expnt(s) = [7303.14229336]
bas 11, expnt(s) = [18375.79884356]
bas 12, expnt(s) = [1449.09323238]
bas 13, expnt(s) = [376.23348041]
bas 14, expnt(s) = [115.13526815]
bas 15, expnt(s) = [39.81517318]
bas 16, expnt(s) = [12.26461623]
bas 17, expnt(s) = [6.00402004]
bas 18, expnt(s) = [8.60792349]
bas 19, expnt(s) = [0.49247427]
CPU time:       465.51
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.74786402e-01 9.58873800e-01 7.41131248e-01 2.01807066e+00
 1.17616814e+05 1.60460109e+04 2.65329840e+00 5.25236134e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314229e+03 1.99593938e+03 1.83757988e+04 3.98749081e+03
 1.44909323e+03 5.93385966e+02 3.76233480e+02 2.15828158e+02
 1.15135268e+02 8.88017055e+01 3.98151732e+01 4.00452935e+01
 1.22646162e+01 1.65579092e+01 6.00402004e+00 9.69050978e+00
 8.60792349e+00 4.30137583e+01 4.92474270e-01 1.20354913e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33589716101166
cond(S) = 908425.4155511187
E1 = -689.6013994392317  E_coul = 184.97937175907487
init E= -504.622027680157
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672493039566199  LUMO = 0.841659656930563
  mo_energy =
[-1.21703329e+02 -1.33853850e+01 -7.62295367e+00 -7.62295367e+00
 -7.62295367e+00 -1.65754201e+00 -6.72493040e-01 -6.72493040e-01
 -6.72493040e-01  8.41659657e-01  8.17136046e+00  3.66344793e+01
  1.54771869e+02  6.55475199e+02  2.79629251e+03  1.22703425e+04
  4.08878685e+04  1.04929320e+05  2.30111407e+05  4.55925424e+05
  8.44877009e+05  1.52805364e+06  2.85032026e+06  5.80820657e+06]
E1 = -707.7485489932969  E_coul = 199.78478525530437
cycle= 1 E= -507.963763737993  delta_E= -3.34  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.685282
diis-c [-0.4696115  1.       ]
  HOMO = -0.218342078521828  LUMO = 1.24849930071266
  mo_energy =
[-1.20194364e+02 -1.23040273e+01 -6.59349870e+00 -6.59349870e+00
 -6.59349870e+00 -1.16348398e+00 -2.18342079e-01 -2.18342079e-01
 -2.18342079e-01  1.24849930e+00  8.93140137e+00  3.77397881e+01
  1.56174818e+02  6.56966064e+02  2.79772413e+03  1.22716650e+04
  4.08891243e+04  1.04930539e+05  2.30112602e+05  4.55926602e+05
  8.44878173e+05  1.52805479e+06  2.85032141e+06  5.80820770e+06]
E1 = -706.8109093771086  E_coul = 198.8296243316849
cycle= 2 E= -507.981285045424  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.418
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0293269
diis-c [-8.58466746e-04 -1.84959946e-03  1.00184960e+00]
  HOMO = -0.239822884707705  LUMO = 1.24223715788918
  mo_energy =
[-1.20307833e+02 -1.23705281e+01 -6.66724858e+00 -6.66724858e+00
 -6.66724858e+00 -1.17724339e+00 -2.39822885e-01 -2.39822885e-01
 -2.39822885e-01  1.24223716e+00  8.89261743e+00  3.76716028e+01
  1.56078387e+02  6.56848775e+02  2.79759065e+03  1.22715213e+04
  4.08889768e+04  1.04930390e+05  2.30112452e+05  4.55926452e+05
  8.44878023e+05  1.52805464e+06  2.85032126e+06  5.80820755e+06]
E1 = -706.7096346621526  E_coul = 198.72811687799944
cycle= 3 E= -507.981517784153  delta_E= -0.000233  |g|= 0.00408  |ddm|= 0.0575
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00304407
diis-c [-2.17070748e-06  1.33283830e-04 -1.00271428e-01  1.10013814e+00]
  HOMO = -0.242677375997608  LUMO = 1.24118798663776
  mo_energy =
[-1.20318980e+02 -1.23785380e+01 -6.67573767e+00 -6.67573767e+00
 -6.67573767e+00 -1.17895954e+00 -2.42677376e-01 -2.42677376e-01
 -2.42677376e-01  1.24118799e+00  8.88747591e+00  3.76636434e+01
  1.56068343e+02  6.56837491e+02  2.79757857e+03  1.22715088e+04
  4.08889641e+04  1.04930378e+05  2.30112439e+05  4.55926439e+05
  8.44878010e+05  1.52805463e+06  2.85032124e+06  5.80820754e+06]
E1 = -706.6962976191359  E_coul = 198.71477602676583
cycle= 4 E= -507.98152159237  delta_E= -3.81e-06  |g|= 0.000181  |ddm|= 0.00855
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000133636
diis-c [-1.04986242e-10 -6.44639565e-06  6.39124990e-03 -9.44394364e-02
  1.08805463e+00]
  HOMO = -0.242797320445928  LUMO = 1.24113788526526
  mo_energy =
[-1.20319290e+02 -1.23788334e+01 -6.67603103e+00 -6.67603103e+00
 -6.67603103e+00 -1.17903107e+00 -2.42797320e-01 -2.42797320e-01
 -2.42797320e-01  1.24113789e+00  8.88726414e+00  3.76633629e+01
  1.56068040e+02  6.56837181e+02  2.79757826e+03  1.22715084e+04
  4.08889638e+04  1.04930377e+05  2.30112439e+05  4.55926438e+05
  8.44878009e+05  1.52805463e+06  2.85032124e+06  5.80820754e+06]
E1 = -706.6957472857691  E_coul = 198.71422568617066
cycle= 5 E= -507.981521599598  delta_E= -7.23e-09  |g|= 1.24e-06  |ddm|= 0.000416
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.81156e-07
diis-c [-8.73479365e-14  2.16688032e-07 -1.53938818e-04  2.09628186e-03
 -2.53429741e-02  1.02340041e+00]
  HOMO = -0.242797952423253  LUMO = 1.24113772648773
  mo_energy =
[-1.20319291e+02 -1.23788349e+01 -6.67603248e+00 -6.67603248e+00
 -6.67603248e+00 -1.17903156e+00 -2.42797952e-01 -2.42797952e-01
 -2.42797952e-01  1.24113773e+00  8.88726307e+00  3.76633615e+01
  1.56068038e+02  6.56837179e+02  2.79757826e+03  1.22715084e+04
  4.08889638e+04  1.04930377e+05  2.30112439e+05  4.55926438e+05
  8.44878009e+05  1.52805463e+06  2.85032124e+06  5.80820754e+06]
E1 = -706.6957442972825  E_coul = 198.7142226976839
cycle= 6 E= -507.981521599599  delta_E= -1.71e-13  |g|= 5.04e-08  |ddm|= 2.75e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6957442972825  E_coul = 198.7142226976839
  HOMO = -0.242797975382685  LUMO = 1.24113771490282
  mo_energy =
[-1.20319291e+02 -1.23788349e+01 -6.67603252e+00 -6.67603252e+00
 -6.67603252e+00 -1.17903158e+00 -2.42797975e-01 -2.42797975e-01
 -2.42797975e-01  1.24113771e+00  8.88726303e+00  3.76633615e+01
  1.56068038e+02  6.56837179e+02  2.79757826e+03  1.22715084e+04
  4.08889638e+04  1.04930377e+05  2.30112439e+05  4.55926438e+05
  8.44878009e+05  1.52805463e+06  2.85032124e+06  5.80820754e+06]
E1 = -706.6957441939628  E_coul = 198.7142225943639
Extra cycle  E= -507.981521599599  delta_E= -2.84e-13  |g|= 5.79e-09  |ddm|= 1.02e-07
    CPU time for scf_cycle      1.10 sec, wall time      0.27 sec
exp = [2.74786402e-01 7.41131248e-01 1.17616814e+05 2.65329840e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314229e+03 1.83757988e+04
 1.44909323e+03 3.76233480e+02 1.15135268e+02 3.98151732e+01
 1.22646162e+01 6.00402004e+00 8.60792349e+00 4.92474270e-01]
E = -507.9815215995989
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:10:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.274786401934       1
[INPUT] 0    0    [1    /1   ]  0.741131247719       1
[INPUT] 0    0    [1    /1   ]  117616.813853        1
[INPUT] 0    0    [1    /1   ]  2.65329840285        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991911        1
[INPUT] 0    0    [1    /1   ]  73510.4199858        1
[INPUT] 0    0    [1    /1   ]  36754.7147391        1
[INPUT] 0    0    [1    /1   ]  7303.14229336        1
[INPUT] 0    0    [1    /1   ]  18375.7988436        1
[INPUT] 0    0    [1    /1   ]  1449.09323238        1
[INPUT] 0    0    [1    /1   ]  376.233480406        1
[INPUT] 0    0    [1    /1   ]  115.135268145        1
[INPUT] 0    0    [1    /1   ]  39.8151731802        1
[INPUT] 0    0    [1    /1   ]  12.2646162291        1
[INPUT] 0    0    [1    /1   ]  6.00402004341        1
[INPUT] 1    0    [1    /1   ]  8.6079234896         1
[INPUT] 1    0    [1    /1   ]  0.492474269734       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2747864019343509, 1.0]], [0, [0.7411312477194661, 1.0]], [0, [117616.81385323222, 1.0]], [0, [2.6532984028541637, 1.0]], [0, [1176168.1426171719, 1.0]], [0, [588084.0699821068, 1.0]], [0, [294042.03107142285, 1.0]], [0, [147020.99191072086, 1.0]], [0, [73510.41998583492, 1.0]], [0, [36754.71473914781, 1.0]], [0, [7303.14229335857, 1.0]], [0, [18375.798843558012, 1.0]], [0, [1449.093232375398, 1.0]], [0, [376.23348040573296, 1.0]], [0, [115.13526814536098, 1.0]], [0, [39.815173180162354, 1.0]], [0, [12.264616229113889, 1.0]], [0, [6.004020043405284, 1.0]], [1, [8.607923489604607, 1.0]], [1, [0.4924742697343086, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2747864]
bas 1, expnt(s) = [0.74113125]
bas 2, expnt(s) = [117616.81385323]
bas 3, expnt(s) = [2.6532984]
bas 4, expnt(s) = [1176168.14261717]
bas 5, expnt(s) = [588084.06998211]
bas 6, expnt(s) = [294042.03107142]
bas 7, expnt(s) = [147020.99191072]
bas 8, expnt(s) = [73510.41998583]
bas 9, expnt(s) = [36754.71473915]
bas 10, expnt(s) = [7303.14229336]
bas 11, expnt(s) = [18375.79884356]
bas 12, expnt(s) = [1449.09323238]
bas 13, expnt(s) = [376.23348041]
bas 14, expnt(s) = [115.13526815]
bas 15, expnt(s) = [39.81517318]
bas 16, expnt(s) = [12.26461623]
bas 17, expnt(s) = [6.00402004]
bas 18, expnt(s) = [8.60792349]
bas 19, expnt(s) = [0.49247427]
CPU time:       466.86
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.74786402e-01 9.58873800e-01 7.41131248e-01 2.01807066e+00
 1.17616814e+05 1.60460109e+04 2.65329840e+00 5.25236134e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314229e+03 1.99593938e+03 1.83757988e+04 3.98749081e+03
 1.44909323e+03 5.93385966e+02 3.76233480e+02 2.15828158e+02
 1.15135268e+02 8.88017055e+01 3.98151732e+01 4.00452935e+01
 1.22646162e+01 1.65579092e+01 6.00402004e+00 9.69050978e+00
 8.60792349e+00 4.30137583e+01 4.92474270e-01 1.20354913e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33589716101166
cond(S) = 908425.4155511187
E1 = -689.6013994392317  E_coul = 184.97937175907487
init E= -504.622027680157
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672493039566199  LUMO = 0.841659656930563
  mo_energy =
[-1.21703329e+02 -1.33853850e+01 -7.62295367e+00 -7.62295367e+00
 -7.62295367e+00 -1.65754201e+00 -6.72493040e-01 -6.72493040e-01
 -6.72493040e-01  8.41659657e-01  8.17136046e+00  3.66344793e+01
  1.54771869e+02  6.55475199e+02  2.79629251e+03  1.22703425e+04
  4.08878685e+04  1.04929320e+05  2.30111407e+05  4.55925424e+05
  8.44877009e+05  1.52805364e+06  2.85032026e+06  5.80820657e+06]
E1 = -707.7485489932969  E_coul = 199.78478525530437
cycle= 1 E= -507.963763737993  delta_E= -3.34  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.685282
diis-c [-0.4696115  1.       ]
  HOMO = -0.218342078521828  LUMO = 1.24849930071266
  mo_energy =
[-1.20194364e+02 -1.23040273e+01 -6.59349870e+00 -6.59349870e+00
 -6.59349870e+00 -1.16348398e+00 -2.18342079e-01 -2.18342079e-01
 -2.18342079e-01  1.24849930e+00  8.93140137e+00  3.77397881e+01
  1.56174818e+02  6.56966064e+02  2.79772413e+03  1.22716650e+04
  4.08891243e+04  1.04930539e+05  2.30112602e+05  4.55926602e+05
  8.44878173e+05  1.52805479e+06  2.85032141e+06  5.80820770e+06]
E1 = -706.8109093771086  E_coul = 198.8296243316849
cycle= 2 E= -507.981285045424  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.418
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0293269
diis-c [-8.58466746e-04 -1.84959946e-03  1.00184960e+00]
  HOMO = -0.239822884707705  LUMO = 1.24223715788918
  mo_energy =
[-1.20307833e+02 -1.23705281e+01 -6.66724858e+00 -6.66724858e+00
 -6.66724858e+00 -1.17724339e+00 -2.39822885e-01 -2.39822885e-01
 -2.39822885e-01  1.24223716e+00  8.89261743e+00  3.76716028e+01
  1.56078387e+02  6.56848775e+02  2.79759065e+03  1.22715213e+04
  4.08889768e+04  1.04930390e+05  2.30112452e+05  4.55926452e+05
  8.44878023e+05  1.52805464e+06  2.85032126e+06  5.80820755e+06]
E1 = -706.7096346621526  E_coul = 198.72811687799944
cycle= 3 E= -507.981517784153  delta_E= -0.000233  |g|= 0.00408  |ddm|= 0.0575
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00304407
diis-c [-2.17070748e-06  1.33283830e-04 -1.00271428e-01  1.10013814e+00]
  HOMO = -0.242677375997608  LUMO = 1.24118798663776
  mo_energy =
[-1.20318980e+02 -1.23785380e+01 -6.67573767e+00 -6.67573767e+00
 -6.67573767e+00 -1.17895954e+00 -2.42677376e-01 -2.42677376e-01
 -2.42677376e-01  1.24118799e+00  8.88747591e+00  3.76636434e+01
  1.56068343e+02  6.56837491e+02  2.79757857e+03  1.22715088e+04
  4.08889641e+04  1.04930378e+05  2.30112439e+05  4.55926439e+05
  8.44878010e+05  1.52805463e+06  2.85032124e+06  5.80820754e+06]
E1 = -706.6962976191359  E_coul = 198.71477602676583
cycle= 4 E= -507.98152159237  delta_E= -3.81e-06  |g|= 0.000181  |ddm|= 0.00855
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000133636
diis-c [-1.04986242e-10 -6.44639565e-06  6.39124990e-03 -9.44394364e-02
  1.08805463e+00]
  HOMO = -0.242797320445928  LUMO = 1.24113788526526
  mo_energy =
[-1.20319290e+02 -1.23788334e+01 -6.67603103e+00 -6.67603103e+00
 -6.67603103e+00 -1.17903107e+00 -2.42797320e-01 -2.42797320e-01
 -2.42797320e-01  1.24113789e+00  8.88726414e+00  3.76633629e+01
  1.56068040e+02  6.56837181e+02  2.79757826e+03  1.22715084e+04
  4.08889638e+04  1.04930377e+05  2.30112439e+05  4.55926438e+05
  8.44878009e+05  1.52805463e+06  2.85032124e+06  5.80820754e+06]
E1 = -706.6957472857691  E_coul = 198.71422568617066
cycle= 5 E= -507.981521599598  delta_E= -7.23e-09  |g|= 1.24e-06  |ddm|= 0.000416
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.81156e-07
diis-c [-8.73479365e-14  2.16688032e-07 -1.53938818e-04  2.09628186e-03
 -2.53429741e-02  1.02340041e+00]
  HOMO = -0.242797952423253  LUMO = 1.24113772648773
  mo_energy =
[-1.20319291e+02 -1.23788349e+01 -6.67603248e+00 -6.67603248e+00
 -6.67603248e+00 -1.17903156e+00 -2.42797952e-01 -2.42797952e-01
 -2.42797952e-01  1.24113773e+00  8.88726307e+00  3.76633615e+01
  1.56068038e+02  6.56837179e+02  2.79757826e+03  1.22715084e+04
  4.08889638e+04  1.04930377e+05  2.30112439e+05  4.55926438e+05
  8.44878009e+05  1.52805463e+06  2.85032124e+06  5.80820754e+06]
E1 = -706.6957442972825  E_coul = 198.7142226976839
cycle= 6 E= -507.981521599599  delta_E= -1.71e-13  |g|= 5.04e-08  |ddm|= 2.75e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6957442972825  E_coul = 198.7142226976839
  HOMO = -0.242797975382685  LUMO = 1.24113771490282
  mo_energy =
[-1.20319291e+02 -1.23788349e+01 -6.67603252e+00 -6.67603252e+00
 -6.67603252e+00 -1.17903158e+00 -2.42797975e-01 -2.42797975e-01
 -2.42797975e-01  1.24113771e+00  8.88726303e+00  3.76633615e+01
  1.56068038e+02  6.56837179e+02  2.79757826e+03  1.22715084e+04
  4.08889638e+04  1.04930377e+05  2.30112439e+05  4.55926438e+05
  8.44878009e+05  1.52805463e+06  2.85032124e+06  5.80820754e+06]
E1 = -706.6957441939628  E_coul = 198.7142225943639
Extra cycle  E= -507.981521599599  delta_E= -2.84e-13  |g|= 5.79e-09  |ddm|= 1.02e-07
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908425.4155511187
E1 = -706.6957441939628  E_coul = 198.7142225943639
init E= -507.981521599599
    CPU time for initialize scf      3.33 sec, wall time      0.21 sec
  HOMO = -0.242797978559279  LUMO = 1.24113771261077
  mo_energy =
[-1.20319291e+02 -1.23788349e+01 -6.67603253e+00 -6.67603253e+00
 -6.67603253e+00 -1.17903158e+00 -2.42797979e-01 -2.42797979e-01
 -2.42797979e-01  1.24113771e+00  8.88726302e+00  3.76633615e+01
  1.56068038e+02  6.56837179e+02  2.79757826e+03  1.22715084e+04
  4.08889638e+04  1.04930377e+05  2.30112439e+05  4.55926438e+05
  8.44878009e+05  1.52805463e+06  2.85032124e+06  5.80820754e+06]
E1 = -706.6957441782336  E_coul = 198.7142225786348
cycle= 1 E= -507.981521599599  delta_E= 1.71e-13  |g|= 1.21e-09  |ddm|= 1.25e-08
    CPU time for cycle= 1      0.32 sec, wall time      0.03 sec
E1 = -706.6957441782336  E_coul = 198.7142225786348
  HOMO = -0.242797979006202  LUMO = 1.24113771274844
  mo_energy =
[-1.20319291e+02 -1.23788349e+01 -6.67603253e+00 -6.67603253e+00
 -6.67603253e+00 -1.17903158e+00 -2.42797979e-01 -2.42797979e-01
 -2.42797979e-01  1.24113771e+00  8.88726302e+00  3.76633615e+01
  1.56068038e+02  6.56837179e+02  2.79757826e+03  1.22715084e+04
  4.08889638e+04  1.04930377e+05  2.30112439e+05  4.55926438e+05
  8.44878009e+05  1.52805463e+06  2.85032124e+06  5.80820754e+06]
E1 = -706.6957441763049  E_coul = 198.7142225767066
Extra cycle  E= -507.981521599598  delta_E= 4.55e-13  |g|= 1.15e-09  |ddm|= 1.4e-09
    CPU time for scf_cycle      3.79 sec, wall time      0.38 sec
exp = [2.74786402e-01 7.41131248e-01 1.17616814e+05 2.65329840e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314229e+03 1.83757988e+04
 1.44909323e+03 3.76233480e+02 1.15135268e+02 3.98151732e+01
 1.22646162e+01 6.00402004e+00 8.60792349e+00 4.92474270e-01]
grad_E = [ 1.68377598e-02  1.65588353e-03  4.34719563e-09  3.75861520e-04
  2.07229435e-11  1.18128217e-10  6.76230022e-10  2.65375151e-09
  1.10310853e-08  5.91450830e-08  3.73150188e-06  1.29065328e-07
 -6.79467043e-07  2.64872684e-05 -1.54188243e-04 -1.28028660e-03
  2.75616949e-05  1.07818430e-04  3.38565913e-03 -8.37160283e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:10:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.265391568972       1
[INPUT] 0    0    [1    /1   ]  0.67321618382        1
[INPUT] 0    0    [1    /1   ]  117616.81385         1
[INPUT] 0    0    [1    /1   ]  2.97360469881        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991909        1
[INPUT] 0    0    [1    /1   ]  73510.4199777        1
[INPUT] 0    0    [1    /1   ]  36754.7146953        1
[INPUT] 0    0    [1    /1   ]  7303.13952659        1
[INPUT] 0    0    [1    /1   ]  18375.7987475        1
[INPUT] 0    0    [1    /1   ]  1449.09513291        1
[INPUT] 0    0    [1    /1   ]  376.203613937        1
[INPUT] 0    0    [1    /1   ]  115.244718886        1
[INPUT] 0    0    [1    /1   ]  40.2162399538        1
[INPUT] 0    0    [1    /1   ]  13.1669514457        1
[INPUT] 0    0    [1    /1   ]  6.50943950817        1
[INPUT] 1    0    [1    /1   ]  8.60313664725        1
[INPUT] 1    0    [1    /1   ]  0.492731681961       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2653915689722056, 1.0]], [0, [0.6732161838203431, 1.0]], [0, [117616.81385000897, 1.0]], [0, [2.9736046988071183, 1.0]], [0, [1176168.1426171563, 1.0]], [0, [588084.069982019, 1.0]], [0, [294042.0310709215, 1.0]], [0, [147020.99190875294, 1.0]], [0, [73510.41997765322, 1.0]], [0, [36754.71469532518, 1.0]], [0, [7303.139526587974, 1.0]], [0, [18375.798747488745, 1.0]], [0, [1449.0951329109296, 1.0]], [0, [376.20361393732344, 1.0]], [0, [115.2447188861165, 1.0]], [0, [40.2162399537636, 1.0]], [0, [13.166951445706841, 1.0]], [0, [6.509439508171821, 1.0]], [1, [8.603136647246966, 1.0]], [1, [0.4927316819608084, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26539157]
bas 1, expnt(s) = [0.67321618]
bas 2, expnt(s) = [117616.81385001]
bas 3, expnt(s) = [2.9736047]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998202]
bas 6, expnt(s) = [294042.03107092]
bas 7, expnt(s) = [147020.99190875]
bas 8, expnt(s) = [73510.41997765]
bas 9, expnt(s) = [36754.71469533]
bas 10, expnt(s) = [7303.13952659]
bas 11, expnt(s) = [18375.79874749]
bas 12, expnt(s) = [1449.09513291]
bas 13, expnt(s) = [376.20361394]
bas 14, expnt(s) = [115.24471889]
bas 15, expnt(s) = [40.21623995]
bas 16, expnt(s) = [13.16695145]
bas 17, expnt(s) = [6.50943951]
bas 18, expnt(s) = [8.60313665]
bas 19, expnt(s) = [0.49273168]
CPU time:       478.42
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.65391569e-01 9.34179571e-01 6.73216184e-01 1.87772045e+00
 1.17616814e+05 1.60460109e+04 2.97360470e+00 5.72107248e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30313953e+03 1.99593881e+03 1.83757987e+04 3.98749080e+03
 1.44909513e+03 5.93386549e+02 3.76203614e+02 2.15815308e+02
 1.15244719e+02 8.88650110e+01 4.02162400e+01 4.03474528e+01
 1.31669514e+01 1.74634060e+01 6.50943951e+00 1.02960993e+01
 8.60313665e+00 4.29838606e+01 4.92731682e-01 1.20433554e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335613394189263
cond(S) = 908528.3070052542
E1 = -689.5810173925303  E_coul = 184.9627176242486
init E= -504.618299768282
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672291004733563  LUMO = 0.759297437289609
  mo_energy =
[-1.21707490e+02 -1.33864374e+01 -7.62422380e+00 -7.62422380e+00
 -7.62422380e+00 -1.65766620e+00 -6.72291005e-01 -6.72291005e-01
 -6.72291005e-01  7.59297437e-01  8.76108005e+00  4.02263690e+01
  1.61990147e+02  6.63664802e+02  2.80384394e+03  1.22769805e+04
  4.08940149e+04  1.04935212e+05  2.30117133e+05  4.55931030e+05
  8.44882523e+05  1.52805906e+06  2.85032558e+06  5.80821174e+06]
E1 = -707.7457218835041  E_coul = 199.78195495553888
cycle= 1 E= -507.963766927965  delta_E= -3.35  |g|= 0.451  |ddm|= 0.516
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.684457
diis-c [-0.4684811  1.       ]
  HOMO = -0.217485562390151  LUMO = 1.15660259746072
  mo_energy =
[-1.20197312e+02 -1.23041532e+01 -6.59392171e+00 -6.59392171e+00
 -6.59392171e+00 -1.16308676e+00 -2.17485562e-01 -2.17485562e-01
 -2.17485562e-01  1.15660260e+00  9.55393986e+00  4.13557267e+01
  1.63396599e+02  6.65156705e+02  2.80527689e+03  1.22783045e+04
  4.08952723e+04  1.04936433e+05  2.30118329e+05  4.55932209e+05
  8.44883689e+05  1.52806022e+06  2.85032672e+06  5.80821288e+06]
E1 = -706.8080261978964  E_coul = 198.82678949102038
cycle= 2 E= -507.981236706876  delta_E= -0.0175  |g|= 0.0347  |ddm|= 0.427
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0289495
diis-c [-8.37433804e-04 -1.16997696e-03  1.00116998e+00]
  HOMO = -0.239116808163172  LUMO = 1.15064453245584
  mo_energy =
[-1.20310410e+02 -1.23705805e+01 -6.66752430e+00 -6.66752430e+00
 -6.66752430e+00 -1.17697739e+00 -2.39116808e-01 -2.39116808e-01
 -2.39116808e-01  1.15064453e+00  9.51300482e+00  4.12857546e+01
  1.63300107e+02  6.65039834e+02  2.80514390e+03  1.22781613e+04
  4.08951253e+04  1.04936284e+05  2.30118180e+05  4.55932059e+05
  8.44883539e+05  1.52806007e+06  2.85032657e+06  5.80821273e+06]
E1 = -706.7042420344605  E_coul = 198.72276138583194
cycle= 3 E= -507.981480648629  delta_E= -0.000244  |g|= 0.00422  |ddm|= 0.0587
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00304538
diis-c [-2.12867938e-06  8.69402492e-05 -1.02001098e-01  1.10191416e+00]
  HOMO = -0.242095190350977  LUMO = 1.14959957749333
  mo_energy =
[-1.20321876e+02 -1.23788498e+01 -6.67627889e+00 -6.67627889e+00
 -6.67627889e+00 -1.17877428e+00 -2.42095190e-01 -2.42095190e-01
 -2.42095190e-01  1.14959958e+00  9.50741979e+00  4.12773730e+01
  1.63289740e+02  6.65028228e+02  2.80513148e+03  1.22781484e+04
  4.08951122e+04  1.04936271e+05  2.30118167e+05  4.55932046e+05
  8.44883525e+05  1.52806005e+06  2.85032656e+06  5.80821271e+06]
E1 = -706.6900811141359  E_coul = 198.70859620311575
cycle= 4 E= -507.98148491102  delta_E= -4.26e-06  |g|= 0.000198  |ddm|= 0.00892
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000137645
diis-c [-1.14222736e-10 -6.81716638e-06  6.67365077e-03 -9.78214055e-02
  1.09115457e+00]
  HOMO = -0.242228087907256  LUMO = 1.14954654491326
  mo_energy =
[-1.20322222e+02 -1.23791759e+01 -6.67660354e+00 -6.67660354e+00
 -6.67660354e+00 -1.17885357e+00 -2.42228088e-01 -2.42228088e-01
 -2.42228088e-01  1.14954654e+00  9.50717650e+00  4.12770591e+01
  1.63289403e+02  6.65027882e+02  2.80513113e+03  1.22781480e+04
  4.08951119e+04  1.04936271e+05  2.30118166e+05  4.55932046e+05
  8.44883525e+05  1.52806005e+06  2.85032656e+06  5.80821271e+06]
E1 = -706.6894578243646  E_coul = 198.70797290434868
cycle= 5 E= -507.981484920016  delta_E= -9e-09  |g|= 1.22e-06  |ddm|= 0.00045
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.08777e-07
diis-c [-8.02581879e-14  2.31010456e-07 -1.53303977e-04  2.05609588e-03
 -2.42801120e-02  1.02237709e+00]
  HOMO = -0.242228756508099  LUMO = 1.14954640476794
  mo_energy =
[-1.20322224e+02 -1.23791774e+01 -6.67660514e+00 -6.67660514e+00
 -6.67660514e+00 -1.17885410e+00 -2.42228757e-01 -2.42228757e-01
 -2.42228757e-01  1.14954640e+00  9.50717532e+00  4.12770576e+01
  1.63289401e+02  6.65027879e+02  2.80513113e+03  1.22781480e+04
  4.08951119e+04  1.04936271e+05  2.30118166e+05  4.55932046e+05
  8.44883525e+05  1.52806005e+06  2.85032656e+06  5.80821271e+06]
E1 = -706.6894545108485  E_coul = 198.70796959083214
cycle= 6 E= -507.981484920016  delta_E= -4.55e-13  |g|= 4.49e-08  |ddm|= 2.69e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6894545108485  E_coul = 198.70796959083214
  HOMO = -0.242228778463117  LUMO = 1.14954639256384
  mo_energy =
[-1.20322224e+02 -1.23791775e+01 -6.67660519e+00 -6.67660519e+00
 -6.67660519e+00 -1.17885411e+00 -2.42228778e-01 -2.42228778e-01
 -2.42228778e-01  1.14954639e+00  9.50717528e+00  4.12770575e+01
  1.63289401e+02  6.65027879e+02  2.80513113e+03  1.22781480e+04
  4.08951119e+04  1.04936271e+05  2.30118166e+05  4.55932046e+05
  8.44883525e+05  1.52806005e+06  2.85032656e+06  5.80821271e+06]
E1 = -706.6894544113616  E_coul = 198.70796949134512
Extra cycle  E= -507.981484920016  delta_E= -1.14e-13  |g|= 5.44e-09  |ddm|= 8.79e-08
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
exp = [2.65391569e-01 6.73216184e-01 1.17616814e+05 2.97360470e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30313953e+03 1.83757987e+04
 1.44909513e+03 3.76203614e+02 1.15244719e+02 4.02162400e+01
 1.31669514e+01 6.50943951e+00 8.60313665e+00 4.92731682e-01]
E = -507.98148492001644
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:10:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.27035119972        1
[INPUT] 0    0    [1    /1   ]  0.709069257582       1
[INPUT] 0    0    [1    /1   ]  117616.813852        1
[INPUT] 0    0    [1    /1   ]  2.8045116494         1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.99191         1
[INPUT] 0    0    [1    /1   ]  73510.419982         1
[INPUT] 0    0    [1    /1   ]  36754.7147185        1
[INPUT] 0    0    [1    /1   ]  7303.1409872         1
[INPUT] 0    0    [1    /1   ]  18375.7987982        1
[INPUT] 0    0    [1    /1   ]  1449.0941296         1
[INPUT] 0    0    [1    /1   ]  376.219380759        1
[INPUT] 0    0    [1    /1   ]  115.186938693        1
[INPUT] 0    0    [1    /1   ]  40.0045126021        1
[INPUT] 0    0    [1    /1   ]  12.6905992313        1
[INPUT] 0    0    [1    /1   ]  6.24262327756        1
[INPUT] 1    0    [1    /1   ]  8.60566367148        1
[INPUT] 1    0    [1    /1   ]  0.49259579135        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.27035119972032284, 1.0]], [0, [0.7090692575824468, 1.0]], [0, [117616.81385171055, 1.0]], [0, [2.8045116494016864, 1.0]], [0, [1176168.1426171644, 1.0]], [0, [588084.0699820654, 1.0]], [0, [294042.0310711862, 1.0]], [0, [147020.99190979183, 1.0]], [0, [73510.41998197242, 1.0]], [0, [36754.7147184596, 1.0]], [0, [7303.140987195158, 1.0]], [0, [18375.798798204716, 1.0]], [0, [1449.094129598311, 1.0]], [0, [376.2193807589006, 1.0]], [0, [115.18693869338263, 1.0]], [0, [40.004512602099574, 1.0]], [0, [12.690599231318824, 1.0]], [0, [6.242623277563642, 1.0]], [1, [8.605663671478158, 1.0]], [1, [0.4925957913495933, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2703512]
bas 1, expnt(s) = [0.70906926]
bas 2, expnt(s) = [117616.81385171]
bas 3, expnt(s) = [2.80451165]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998207]
bas 6, expnt(s) = [294042.03107119]
bas 7, expnt(s) = [147020.99190979]
bas 8, expnt(s) = [73510.41998197]
bas 9, expnt(s) = [36754.71471846]
bas 10, expnt(s) = [7303.1409872]
bas 11, expnt(s) = [18375.7987982]
bas 12, expnt(s) = [1449.0941296]
bas 13, expnt(s) = [376.21938076]
bas 14, expnt(s) = [115.18693869]
bas 15, expnt(s) = [40.0045126]
bas 16, expnt(s) = [12.69059923]
bas 17, expnt(s) = [6.24262328]
bas 18, expnt(s) = [8.60566367]
bas 19, expnt(s) = [0.49259579]
CPU time:       479.76
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.70351200e-01 9.47242663e-01 7.09069258e-01 1.95223240e+00
 1.17616814e+05 1.60460109e+04 2.80451165e+00 5.47530051e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314099e+03 1.99593911e+03 1.83757988e+04 3.98749080e+03
 1.44909413e+03 5.93386241e+02 3.76219381e+02 2.15822092e+02
 1.15186939e+02 8.88315932e+01 4.00045126e+01 4.01880341e+01
 1.26905992e+01 1.69873886e+01 6.24262328e+00 9.97792809e+00
 8.60566367e+00 4.29996434e+01 4.92595791e-01 1.20392037e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33578464145148
cond(S) = 908473.7283339171
E1 = -689.5933180609135  E_coul = 184.9720966313526
init E= -504.621221429561
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672372919774392  LUMO = 0.803920408669216
  mo_energy =
[-1.21705256e+02 -1.33859121e+01 -7.62351150e+00 -7.62351150e+00
 -7.62351150e+00 -1.65758864e+00 -6.72372920e-01 -6.72372920e-01
 -6.72372920e-01  8.03920409e-01  8.44761860e+00  3.83282308e+01
  1.58188118e+02  6.59339624e+02  2.79985230e+03  1.22734710e+04
  4.08907653e+04  1.04932097e+05  2.30114106e+05  4.55928066e+05
  8.44879608e+05  1.52805620e+06  2.85032277e+06  5.80820900e+06]
E1 = -707.7474334744769  E_coul = 199.78350720763044
cycle= 1 E= -507.963926266846  delta_E= -3.34  |g|= 0.451  |ddm|= 0.497
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.684952
diis-c [-0.4691598  1.       ]
  HOMO = -0.217937230898719  LUMO = 1.20666609746482
  mo_energy =
[-1.20195784e+02 -1.23041453e+01 -6.59369031e+00 -6.59369031e+00
 -6.59369031e+00 -1.16329960e+00 -2.17937231e-01 -2.17937231e-01
 -2.17937231e-01  1.20666610e+00  9.22321600e+00  3.94452010e+01
  1.59592666e+02  6.60830903e+02  2.80128447e+03  1.22747942e+04
  4.08920217e+04  1.04933317e+05  2.30115301e+05  4.55929244e+05
  8.44880773e+05  1.52805735e+06  2.85032391e+06  5.80821014e+06]
E1 = -706.8084803628752  E_coul = 198.82702843097098
cycle= 2 E= -507.981451931904  delta_E= -0.0175  |g|= 0.0347  |ddm|= 0.421
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0291598
diis-c [-8.49208215e-04 -1.52490775e-03  1.00152491e+00]
  HOMO = -0.239520049582868  LUMO = 1.20051820659854
  mo_energy =
[-1.20309217e+02 -1.23707071e+01 -6.66747432e+00 -6.66747432e+00
 -6.66747432e+00 -1.17714107e+00 -2.39520050e-01 -2.39520050e-01
 -2.39520050e-01  1.20051821e+00  9.18333194e+00  3.93760426e+01
  1.59496079e+02  6.60713671e+02  2.80115107e+03  1.22746506e+04
  4.08918743e+04  1.04933168e+05  2.30115151e+05  4.55929094e+05
  8.44880622e+05  1.52805720e+06  2.85032376e+06  5.80820999e+06]
E1 = -706.7059435931129  E_coul = 198.72425358607677
cycle= 3 E= -507.981690007036  delta_E= -0.000238  |g|= 0.00415  |ddm|= 0.0578
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00304519
diis-c [-2.15327087e-06  1.12484805e-04 -1.01042801e-01  1.10093032e+00]
  HOMO = -0.242434413042557  LUMO = 1.19946716563868
  mo_energy =
[-1.20320523e+02 -1.23788457e+01 -6.67609542e+00 -6.67609542e+00
 -6.67609542e+00 -1.17889600e+00 -2.42434413e-01 -2.42434413e-01
 -2.42434413e-01  1.19946717e+00  9.17797644e+00  3.93678757e+01
  1.59485875e+02  6.60702227e+02  2.80113882e+03  1.22746378e+04
  4.08918614e+04  1.04933155e+05  2.30115138e+05  4.55929081e+05
  8.44880609e+05  1.52805719e+06  2.85032375e+06  5.80820998e+06]
E1 = -706.6922229759181  E_coul = 198.71052895692463
cycle= 4 E= -507.981694018993  delta_E= -4.01e-06  |g|= 0.000189  |ddm|= 0.00867
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135436
diis-c [-1.09123574e-10 -6.62589788e-06  6.51704791e-03 -9.59367635e-02
  1.08942634e+00]
  HOMO = -0.242560192641911  LUMO = 1.1994156147195
  mo_energy =
[-1.20320849e+02 -1.23791550e+01 -6.67640297e+00 -6.67640297e+00
 -6.67640297e+00 -1.17897102e+00 -2.42560193e-01 -2.42560193e-01
 -2.42560193e-01  1.19941561e+00  9.17775034e+00  3.93675800e+01
  1.59485556e+02  6.60701900e+02  2.80113849e+03  1.22746375e+04
  4.08918611e+04  1.04933154e+05  2.30115138e+05  4.55929081e+05
  8.44880609e+05  1.52805718e+06  2.85032375e+06  5.80820998e+06]
E1 = -706.6916402273014  E_coul = 198.7099462003273
cycle= 5 E= -507.981694026974  delta_E= -7.98e-09  |g|= 1.22e-06  |ddm|= 0.000428
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.92915e-07
diis-c [-8.38629369e-14  2.28461120e-07 -1.54018477e-04  2.08283842e-03
 -2.48997578e-02  1.02297071e+00]
  HOMO = -0.242560838376858  LUMO = 1.19941546711322
  mo_energy =
[-1.20320851e+02 -1.23791565e+01 -6.67640447e+00 -6.67640447e+00
 -6.67640447e+00 -1.17897153e+00 -2.42560838e-01 -2.42560838e-01
 -2.42560838e-01  1.19941547e+00  9.17774923e+00  3.93675786e+01
  1.59485555e+02  6.60701898e+02  2.80113849e+03  1.22746375e+04
  4.08918611e+04  1.04933154e+05  2.30115138e+05  4.55929081e+05
  8.44880609e+05  1.52805718e+06  2.85032375e+06  5.80820998e+06]
E1 = -706.6916371055319  E_coul = 198.709943078558
cycle= 6 E= -507.981694026974  delta_E= 2.27e-13  |g|= 4.71e-08  |ddm|= 2.68e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6916371055319  E_coul = 198.709943078558
  HOMO = -0.242560860823001  LUMO = 1.19941545111816
  mo_energy =
[-1.20320851e+02 -1.23791565e+01 -6.67640452e+00 -6.67640452e+00
 -6.67640452e+00 -1.17897154e+00 -2.42560861e-01 -2.42560861e-01
 -2.42560861e-01  1.19941545e+00  9.17774919e+00  3.93675785e+01
  1.59485555e+02  6.60701897e+02  2.80113849e+03  1.22746375e+04
  4.08918611e+04  1.04933154e+05  2.30115138e+05  4.55929081e+05
  8.44880609e+05  1.52805718e+06  2.85032375e+06  5.80820998e+06]
E1 = -706.6916370074151  E_coul = 198.7099429804411
Extra cycle  E= -507.981694026974  delta_E= -1.71e-13  |g|= 5.96e-09  |ddm|= 9.17e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.27 sec
exp = [2.70351200e-01 7.09069258e-01 1.17616814e+05 2.80451165e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314099e+03 1.83757988e+04
 1.44909413e+03 3.76219381e+02 1.15186939e+02 4.00045126e+01
 1.26905992e+01 6.24262328e+00 8.60566367e+00 4.92595791e-01]
E = -507.981694026974
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:10:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.27035119972        1
[INPUT] 0    0    [1    /1   ]  0.709069257582       1
[INPUT] 0    0    [1    /1   ]  117616.813852        1
[INPUT] 0    0    [1    /1   ]  2.8045116494         1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.99191         1
[INPUT] 0    0    [1    /1   ]  73510.419982         1
[INPUT] 0    0    [1    /1   ]  36754.7147185        1
[INPUT] 0    0    [1    /1   ]  7303.1409872         1
[INPUT] 0    0    [1    /1   ]  18375.7987982        1
[INPUT] 0    0    [1    /1   ]  1449.0941296         1
[INPUT] 0    0    [1    /1   ]  376.219380759        1
[INPUT] 0    0    [1    /1   ]  115.186938693        1
[INPUT] 0    0    [1    /1   ]  40.0045126021        1
[INPUT] 0    0    [1    /1   ]  12.6905992313        1
[INPUT] 0    0    [1    /1   ]  6.24262327756        1
[INPUT] 1    0    [1    /1   ]  8.60566367148        1
[INPUT] 1    0    [1    /1   ]  0.49259579135        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.27035119972032284, 1.0]], [0, [0.7090692575824468, 1.0]], [0, [117616.81385171055, 1.0]], [0, [2.8045116494016864, 1.0]], [0, [1176168.1426171644, 1.0]], [0, [588084.0699820654, 1.0]], [0, [294042.0310711862, 1.0]], [0, [147020.99190979183, 1.0]], [0, [73510.41998197242, 1.0]], [0, [36754.7147184596, 1.0]], [0, [7303.140987195158, 1.0]], [0, [18375.798798204716, 1.0]], [0, [1449.094129598311, 1.0]], [0, [376.2193807589006, 1.0]], [0, [115.18693869338263, 1.0]], [0, [40.004512602099574, 1.0]], [0, [12.690599231318824, 1.0]], [0, [6.242623277563642, 1.0]], [1, [8.605663671478158, 1.0]], [1, [0.4925957913495933, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2703512]
bas 1, expnt(s) = [0.70906926]
bas 2, expnt(s) = [117616.81385171]
bas 3, expnt(s) = [2.80451165]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998207]
bas 6, expnt(s) = [294042.03107119]
bas 7, expnt(s) = [147020.99190979]
bas 8, expnt(s) = [73510.41998197]
bas 9, expnt(s) = [36754.71471846]
bas 10, expnt(s) = [7303.1409872]
bas 11, expnt(s) = [18375.7987982]
bas 12, expnt(s) = [1449.0941296]
bas 13, expnt(s) = [376.21938076]
bas 14, expnt(s) = [115.18693869]
bas 15, expnt(s) = [40.0045126]
bas 16, expnt(s) = [12.69059923]
bas 17, expnt(s) = [6.24262328]
bas 18, expnt(s) = [8.60566367]
bas 19, expnt(s) = [0.49259579]
CPU time:       481.11
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.70351200e-01 9.47242663e-01 7.09069258e-01 1.95223240e+00
 1.17616814e+05 1.60460109e+04 2.80451165e+00 5.47530051e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314099e+03 1.99593911e+03 1.83757988e+04 3.98749080e+03
 1.44909413e+03 5.93386241e+02 3.76219381e+02 2.15822092e+02
 1.15186939e+02 8.88315932e+01 4.00045126e+01 4.01880341e+01
 1.26905992e+01 1.69873886e+01 6.24262328e+00 9.97792809e+00
 8.60566367e+00 4.29996434e+01 4.92595791e-01 1.20392037e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33578464145148
cond(S) = 908473.7283339171
E1 = -689.5933180609135  E_coul = 184.9720966313526
init E= -504.621221429561
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672372919774392  LUMO = 0.803920408669216
  mo_energy =
[-1.21705256e+02 -1.33859121e+01 -7.62351150e+00 -7.62351150e+00
 -7.62351150e+00 -1.65758864e+00 -6.72372920e-01 -6.72372920e-01
 -6.72372920e-01  8.03920409e-01  8.44761860e+00  3.83282308e+01
  1.58188118e+02  6.59339624e+02  2.79985230e+03  1.22734710e+04
  4.08907653e+04  1.04932097e+05  2.30114106e+05  4.55928066e+05
  8.44879608e+05  1.52805620e+06  2.85032277e+06  5.80820900e+06]
E1 = -707.7474334744769  E_coul = 199.78350720763044
cycle= 1 E= -507.963926266846  delta_E= -3.34  |g|= 0.451  |ddm|= 0.497
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.684952
diis-c [-0.4691598  1.       ]
  HOMO = -0.217937230898719  LUMO = 1.20666609746482
  mo_energy =
[-1.20195784e+02 -1.23041453e+01 -6.59369031e+00 -6.59369031e+00
 -6.59369031e+00 -1.16329960e+00 -2.17937231e-01 -2.17937231e-01
 -2.17937231e-01  1.20666610e+00  9.22321600e+00  3.94452010e+01
  1.59592666e+02  6.60830903e+02  2.80128447e+03  1.22747942e+04
  4.08920217e+04  1.04933317e+05  2.30115301e+05  4.55929244e+05
  8.44880773e+05  1.52805735e+06  2.85032391e+06  5.80821014e+06]
E1 = -706.8084803628752  E_coul = 198.82702843097098
cycle= 2 E= -507.981451931904  delta_E= -0.0175  |g|= 0.0347  |ddm|= 0.421
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0291598
diis-c [-8.49208215e-04 -1.52490775e-03  1.00152491e+00]
  HOMO = -0.239520049582868  LUMO = 1.20051820659854
  mo_energy =
[-1.20309217e+02 -1.23707071e+01 -6.66747432e+00 -6.66747432e+00
 -6.66747432e+00 -1.17714107e+00 -2.39520050e-01 -2.39520050e-01
 -2.39520050e-01  1.20051821e+00  9.18333194e+00  3.93760426e+01
  1.59496079e+02  6.60713671e+02  2.80115107e+03  1.22746506e+04
  4.08918743e+04  1.04933168e+05  2.30115151e+05  4.55929094e+05
  8.44880622e+05  1.52805720e+06  2.85032376e+06  5.80820999e+06]
E1 = -706.7059435931129  E_coul = 198.72425358607677
cycle= 3 E= -507.981690007036  delta_E= -0.000238  |g|= 0.00415  |ddm|= 0.0578
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00304519
diis-c [-2.15327087e-06  1.12484805e-04 -1.01042801e-01  1.10093032e+00]
  HOMO = -0.242434413042557  LUMO = 1.19946716563868
  mo_energy =
[-1.20320523e+02 -1.23788457e+01 -6.67609542e+00 -6.67609542e+00
 -6.67609542e+00 -1.17889600e+00 -2.42434413e-01 -2.42434413e-01
 -2.42434413e-01  1.19946717e+00  9.17797644e+00  3.93678757e+01
  1.59485875e+02  6.60702227e+02  2.80113882e+03  1.22746378e+04
  4.08918614e+04  1.04933155e+05  2.30115138e+05  4.55929081e+05
  8.44880609e+05  1.52805719e+06  2.85032375e+06  5.80820998e+06]
E1 = -706.6922229759181  E_coul = 198.71052895692463
cycle= 4 E= -507.981694018993  delta_E= -4.01e-06  |g|= 0.000189  |ddm|= 0.00867
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135436
diis-c [-1.09123574e-10 -6.62589788e-06  6.51704791e-03 -9.59367635e-02
  1.08942634e+00]
  HOMO = -0.242560192641911  LUMO = 1.1994156147195
  mo_energy =
[-1.20320849e+02 -1.23791550e+01 -6.67640297e+00 -6.67640297e+00
 -6.67640297e+00 -1.17897102e+00 -2.42560193e-01 -2.42560193e-01
 -2.42560193e-01  1.19941561e+00  9.17775034e+00  3.93675800e+01
  1.59485556e+02  6.60701900e+02  2.80113849e+03  1.22746375e+04
  4.08918611e+04  1.04933154e+05  2.30115138e+05  4.55929081e+05
  8.44880609e+05  1.52805718e+06  2.85032375e+06  5.80820998e+06]
E1 = -706.6916402273014  E_coul = 198.7099462003273
cycle= 5 E= -507.981694026974  delta_E= -7.98e-09  |g|= 1.22e-06  |ddm|= 0.000428
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.92915e-07
diis-c [-8.38629369e-14  2.28461120e-07 -1.54018477e-04  2.08283842e-03
 -2.48997578e-02  1.02297071e+00]
  HOMO = -0.242560838376858  LUMO = 1.19941546711322
  mo_energy =
[-1.20320851e+02 -1.23791565e+01 -6.67640447e+00 -6.67640447e+00
 -6.67640447e+00 -1.17897153e+00 -2.42560838e-01 -2.42560838e-01
 -2.42560838e-01  1.19941547e+00  9.17774923e+00  3.93675786e+01
  1.59485555e+02  6.60701898e+02  2.80113849e+03  1.22746375e+04
  4.08918611e+04  1.04933154e+05  2.30115138e+05  4.55929081e+05
  8.44880609e+05  1.52805718e+06  2.85032375e+06  5.80820998e+06]
E1 = -706.6916371055319  E_coul = 198.709943078558
cycle= 6 E= -507.981694026974  delta_E= 2.27e-13  |g|= 4.71e-08  |ddm|= 2.68e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6916371055319  E_coul = 198.709943078558
  HOMO = -0.242560860823001  LUMO = 1.19941545111816
  mo_energy =
[-1.20320851e+02 -1.23791565e+01 -6.67640452e+00 -6.67640452e+00
 -6.67640452e+00 -1.17897154e+00 -2.42560861e-01 -2.42560861e-01
 -2.42560861e-01  1.19941545e+00  9.17774919e+00  3.93675785e+01
  1.59485555e+02  6.60701897e+02  2.80113849e+03  1.22746375e+04
  4.08918611e+04  1.04933154e+05  2.30115138e+05  4.55929081e+05
  8.44880609e+05  1.52805718e+06  2.85032375e+06  5.80820998e+06]
E1 = -706.6916370074151  E_coul = 198.7099429804411
Extra cycle  E= -507.981694026974  delta_E= -1.71e-13  |g|= 5.96e-09  |ddm|= 9.17e-08
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908473.7283339171
E1 = -706.6916370074151  E_coul = 198.7099429804411
init E= -507.981694026974
    CPU time for initialize scf      3.55 sec, wall time      0.22 sec
  HOMO = -0.242560863824961  LUMO = 1.19941545122227
  mo_energy =
[-1.20320851e+02 -1.23791565e+01 -6.67640453e+00 -6.67640453e+00
 -6.67640453e+00 -1.17897154e+00 -2.42560864e-01 -2.42560864e-01
 -2.42560864e-01  1.19941545e+00  9.17774919e+00  3.93675785e+01
  1.59485555e+02  6.60701897e+02  2.80113849e+03  1.22746375e+04
  4.08918611e+04  1.04933154e+05  2.30115138e+05  4.55929081e+05
  8.44880609e+05  1.52805718e+06  2.85032375e+06  5.80820998e+06]
E1 = -706.6916369919433  E_coul = 198.70994296496937
cycle= 1 E= -507.981694026974  delta_E= 1.71e-13  |g|= 1.45e-09  |ddm|= 1.19e-08
    CPU time for cycle= 1      0.24 sec, wall time      0.03 sec
E1 = -706.6916369919433  E_coul = 198.70994296496937
  HOMO = -0.24256086427485  LUMO = 1.19941545068228
  mo_energy =
[-1.20320851e+02 -1.23791565e+01 -6.67640453e+00 -6.67640453e+00
 -6.67640453e+00 -1.17897154e+00 -2.42560864e-01 -2.42560864e-01
 -2.42560864e-01  1.19941545e+00  9.17774919e+00  3.93675785e+01
  1.59485555e+02  6.60701897e+02  2.80113849e+03  1.22746375e+04
  4.08918611e+04  1.04933154e+05  2.30115138e+05  4.55929081e+05
  8.44880609e+05  1.52805718e+06  2.85032375e+06  5.80820998e+06]
E1 = -706.6916369893437  E_coul = 198.70994296236972
Extra cycle  E= -507.981694026974  delta_E= -1.14e-13  |g|= 1.06e-09  |ddm|= 1.77e-09
    CPU time for scf_cycle      3.94 sec, wall time      0.40 sec
exp = [2.70351200e-01 7.09069258e-01 1.17616814e+05 2.80451165e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314099e+03 1.83757988e+04
 1.44909413e+03 3.76219381e+02 1.15186939e+02 4.00045126e+01
 1.26905992e+01 6.24262328e+00 8.60566367e+00 4.92595791e-01]
grad_E = [ 1.70569183e-02  1.84765945e-04  4.36343667e-09  2.38290590e-03
  2.09145269e-11  1.18655696e-10  6.78741870e-10  2.66379001e-09
  1.10734139e-08  5.93535476e-08  3.74639327e-06  1.29702359e-07
 -1.56487116e-06  4.07078345e-05 -2.54296907e-04 -1.06837497e-03
  9.83487721e-05 -5.53479792e-04  1.45446417e-03 -1.75620978e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:10:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.254782873415       1
[INPUT] 0    0    [1    /1   ]  0.62543035807        1
[INPUT] 0    0    [1    /1   ]  117616.813852        1
[INPUT] 0    0    [1    /1   ]  2.75050977669        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.99191         1
[INPUT] 0    0    [1    /1   ]  73510.4199817        1
[INPUT] 0    0    [1    /1   ]  36754.714717         1
[INPUT] 0    0    [1    /1   ]  7303.14089624        1
[INPUT] 0    0    [1    /1   ]  18375.7987951        1
[INPUT] 0    0    [1    /1   ]  1449.09412655        1
[INPUT] 0    0    [1    /1   ]  376.219413998        1
[INPUT] 0    0    [1    /1   ]  115.182146187        1
[INPUT] 0    0    [1    /1   ]  40.0530152626        1
[INPUT] 0    0    [1    /1   ]  12.7491279778        1
[INPUT] 0    0    [1    /1   ]  6.24301004267        1
[INPUT] 1    0    [1    /1   ]  8.60336984428        1
[INPUT] 1    0    [1    /1   ]  0.49268626391        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.25478287341478817, 1.0]], [0, [0.6254303580697552, 1.0]], [0, [117616.81385160451, 1.0]], [0, [2.7505097766926108, 1.0]], [0, [1176168.142617164, 1.0]], [0, [588084.0699820624, 1.0]], [0, [294042.0310711697, 1.0]], [0, [147020.9919097271, 1.0]], [0, [73510.41998170334, 1.0]], [0, [36754.71471701694, 1.0]], [0, [7303.140896236619, 1.0]], [0, [18375.798795056373, 1.0]], [0, [1449.0941265463723, 1.0]], [0, [376.2194139979165, 1.0]], [0, [115.1821461871302, 1.0]], [0, [40.05301526262997, 1.0]], [0, [12.749127977844527, 1.0]], [0, [6.24301004266789, 1.0]], [1, [8.603369844284302, 1.0]], [1, [0.4926862639098591, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25478287]
bas 1, expnt(s) = [0.62543036]
bas 2, expnt(s) = [117616.8138516]
bas 3, expnt(s) = [2.75050978]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998206]
bas 6, expnt(s) = [294042.03107117]
bas 7, expnt(s) = [147020.99190973]
bas 8, expnt(s) = [73510.4199817]
bas 9, expnt(s) = [36754.71471702]
bas 10, expnt(s) = [7303.14089624]
bas 11, expnt(s) = [18375.79879506]
bas 12, expnt(s) = [1449.09412655]
bas 13, expnt(s) = [376.219414]
bas 14, expnt(s) = [115.18214619]
bas 15, expnt(s) = [40.05301526]
bas 16, expnt(s) = [12.74912798]
bas 17, expnt(s) = [6.24301004]
bas 18, expnt(s) = [8.60336984]
bas 19, expnt(s) = [0.49268626]
CPU time:       492.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.54782873e-01 9.06030250e-01 6.25430358e-01 1.77684376e+00
 1.17616814e+05 1.60460109e+04 2.75050978e+00 5.39603700e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314090e+03 1.99593909e+03 1.83757988e+04 3.98749080e+03
 1.44909413e+03 5.93386240e+02 3.76219414e+02 2.15822106e+02
 1.15182146e+02 8.88288212e+01 4.00530153e+01 4.02245724e+01
 1.27491280e+01 1.70461138e+01 6.24301004e+00 9.97839173e+00
 8.60336984e+00 4.29853170e+01 4.92686264e-01 1.20419678e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335732511689223
cond(S) = 908461.7390604309
E1 = -689.571686938623  E_coul = 184.9552000772489
init E= -504.616486861374
    CPU time for initialize scf      0.42 sec, wall time      0.06 sec
  HOMO = -0.672625753237809  LUMO = 0.671276339479518
  mo_energy =
[-1.21707949e+02 -1.33871781e+01 -7.62476823e+00 -7.62476823e+00
 -7.62476823e+00 -1.65757184e+00 -6.72625753e-01 -6.72625753e-01
 -6.72625753e-01  6.71276339e-01  7.91010774e+00  3.77494737e+01
  1.57846611e+02  6.59174097e+02  2.79973797e+03  1.22733761e+04
  4.08906780e+04  1.04932013e+05  2.30114024e+05  4.55927986e+05
  8.44879529e+05  1.52805612e+06  2.85032269e+06  5.80820893e+06]
E1 = -707.7280248323631  E_coul = 199.7638652235599
cycle= 1 E= -507.964159608803  delta_E= -3.35  |g|= 0.451  |ddm|= 0.54
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.68492
diis-c [-0.46911565  1.        ]
  HOMO = -0.217674803354014  LUMO = 1.05176752702203
  mo_energy =
[-1.20199570e+02 -1.23058084e+01 -6.59548112e+00 -6.59548112e+00
 -6.59548112e+00 -1.16308356e+00 -2.17674803e-01 -2.17674803e-01
 -2.17674803e-01  1.05176753e+00  8.68106826e+00  3.88677150e+01
  1.59251064e+02  6.60664324e+02  2.80116884e+03  1.22746978e+04
  4.08919330e+04  1.04933232e+05  2.30115218e+05  4.55929163e+05
  8.44880692e+05  1.52805727e+06  2.85032384e+06  5.80821006e+06]
E1 = -706.7967051520849  E_coul = 198.8152451095118
cycle= 2 E= -507.981460042573  delta_E= -0.0173  |g|= 0.0346  |ddm|= 0.432
    CPU time for cycle= 2      0.10 sec, wall time      0.03 sec
diis-norm(errvec)=0.0293153
diis-c [-8.57883710e-04 -1.79650692e-03  1.00179651e+00]
  HOMO = -0.239143266041566  LUMO = 1.04662386573299
  mo_energy =
[-1.20312151e+02 -1.23717626e+01 -6.66862082e+00 -6.66862082e+00
 -6.66862082e+00 -1.17686627e+00 -2.39143266e-01 -2.39143266e-01
 -2.39143266e-01  1.04662387e+00  8.64250025e+00  3.87991132e+01
  1.59155196e+02  6.60547951e+02  2.80103639e+03  1.22745551e+04
  4.08917865e+04  1.04933084e+05  2.30115069e+05  4.55929014e+05
  8.44880543e+05  1.52805712e+06  2.85032369e+06  5.80820991e+06]
E1 = -706.6917992335962  E_coul = 198.71008836778586
cycle= 3 E= -507.98171086581  delta_E= -0.000251  |g|= 0.0043  |ddm|= 0.0612
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00312439
diis-c [-2.25513973e-06  8.32935920e-05 -1.03398667e-01  1.10331537e+00]
  HOMO = -0.242169505046696  LUMO = 1.04567124900303
  mo_energy =
[-1.20323648e+02 -1.23800836e+01 -6.67742414e+00 -6.67742414e+00
 -6.67742414e+00 -1.17869520e+00 -2.42169505e-01 -2.42169505e-01
 -2.42169505e-01  1.04567125e+00  8.63708356e+00  3.87907611e+01
  1.59144800e+02  6.60536314e+02  2.80102394e+03  1.22745422e+04
  4.08917735e+04  1.04933070e+05  2.30115056e+05  4.55929001e+05
  8.44880530e+05  1.52805711e+06  2.85032367e+06  5.80820990e+06]
E1 = -706.6771339726811  E_coul = 198.69541845780395
cycle= 4 E= -507.981715514877  delta_E= -4.65e-06  |g|= 0.000218  |ddm|= 0.00964
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000146574
diis-c [-1.67512154e-10 -7.18709455e-06  6.84411232e-03 -1.00547030e-01
  1.09371010e+00]
  HOMO = -0.242314206521315  LUMO = 1.04561851562781
  mo_energy =
[-1.20324015e+02 -1.23804311e+01 -6.67776986e+00 -6.67776986e+00
 -6.67776986e+00 -1.17878192e+00 -2.42314207e-01 -2.42314207e-01
 -2.42314207e-01  1.04561852e+00  8.63682928e+00  3.87904280e+01
  1.59144442e+02  6.60535947e+02  2.80102357e+03  1.22745418e+04
  4.08917731e+04  1.04933070e+05  2.30115056e+05  4.55929000e+05
  8.44880529e+05  1.52805711e+06  2.85032367e+06  5.80820990e+06]
E1 = -706.6764402869228  E_coul = 198.69472476052903
cycle= 5 E= -507.981715526394  delta_E= -1.15e-08  |g|= 2.1e-06  |ddm|= 0.00053
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.91239e-07
diis-c [-1.93666113e-13  3.38120166e-07 -2.67359871e-04  3.67419116e-03
 -4.25651695e-02  1.03915800e+00]
  HOMO = -0.24231535218093  LUMO = 1.04561823058955
  mo_energy =
[-1.20324018e+02 -1.23804336e+01 -6.67777251e+00 -6.67777251e+00
 -6.67777251e+00 -1.17878276e+00 -2.42315352e-01 -2.42315352e-01
 -2.42315352e-01  1.04561823e+00  8.63682732e+00  3.87904254e+01
  1.59144439e+02  6.60535943e+02  2.80102357e+03  1.22745418e+04
  4.08917731e+04  1.04933070e+05  2.30115056e+05  4.55929000e+05
  8.44880529e+05  1.52805711e+06  2.85032367e+06  5.80820990e+06]
E1 = -706.6764344837144  E_coul = 198.69471895731945
cycle= 6 E= -507.981715526395  delta_E= -1.19e-12  |g|= 6.17e-08  |ddm|= 4.97e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6764344837144  E_coul = 198.69471895731945
  HOMO = -0.242315382742604  LUMO = 1.04561821295241
  mo_energy =
[-1.20324018e+02 -1.23804337e+01 -6.67777258e+00 -6.67777258e+00
 -6.67777258e+00 -1.17878277e+00 -2.42315383e-01 -2.42315383e-01
 -2.42315383e-01  1.04561821e+00  8.63682726e+00  3.87904254e+01
  1.59144439e+02  6.60535943e+02  2.80102357e+03  1.22745418e+04
  4.08917731e+04  1.04933070e+05  2.30115056e+05  4.55929000e+05
  8.44880529e+05  1.52805711e+06  2.85032367e+06  5.80820990e+06]
E1 = -706.6764343423512  E_coul = 198.6947188159565
Extra cycle  E= -507.981715526395  delta_E= 2.84e-13  |g|= 7.49e-09  |ddm|= 1.28e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.54782873e-01 6.25430358e-01 1.17616814e+05 2.75050978e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314090e+03 1.83757988e+04
 1.44909413e+03 3.76219414e+02 1.15182146e+02 4.00530153e+01
 1.27491280e+01 6.24301004e+00 8.60336984e+00 4.92686264e-01]
E = -507.9817155263947
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:10:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.262183841302       1
[INPUT] 0    0    [1    /1   ]  0.665191138855       1
[INPUT] 0    0    [1    /1   ]  117616.813852        1
[INPUT] 0    0    [1    /1   ]  2.77618152316        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.99191         1
[INPUT] 0    0    [1    /1   ]  73510.4199818        1
[INPUT] 0    0    [1    /1   ]  36754.7147177        1
[INPUT] 0    0    [1    /1   ]  7303.14093948        1
[INPUT] 0    0    [1    /1   ]  18375.7987966        1
[INPUT] 0    0    [1    /1   ]  1449.094128          1
[INPUT] 0    0    [1    /1   ]  376.219398197        1
[INPUT] 0    0    [1    /1   ]  115.184424479        1
[INPUT] 0    0    [1    /1   ]  40.0299577659        1
[INPUT] 0    0    [1    /1   ]  12.7213042179        1
[INPUT] 0    0    [1    /1   ]  6.24282617986        1
[INPUT] 1    0    [1    /1   ]  8.60446029814        1
[INPUT] 1    0    [1    /1   ]  0.492643254501       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.26218384130206596, 1.0]], [0, [0.6651911388545608, 1.0]], [0, [117616.81385165492, 1.0]], [0, [2.7761815231558544, 1.0]], [0, [1176168.1426171642, 1.0]], [0, [588084.0699820638, 1.0]], [0, [294042.0310711775, 1.0]], [0, [147020.99190975787, 1.0]], [0, [73510.41998183126, 1.0]], [0, [36754.714717702765, 1.0]], [0, [7303.140939477055, 1.0]], [0, [18375.798796553052, 1.0]], [0, [1449.094127997222, 1.0]], [0, [376.2193981965462, 1.0]], [0, [115.18442447859054, 1.0]], [0, [40.02995776589024, 1.0]], [0, [12.72130421792209, 1.0]], [0, [6.24282617986464, 1.0]], [1, [8.604460298137049, 1.0]], [1, [0.4926432545008792, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26218384]
bas 1, expnt(s) = [0.66519114]
bas 2, expnt(s) = [117616.81385165]
bas 3, expnt(s) = [2.77618152]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998206]
bas 6, expnt(s) = [294042.03107118]
bas 7, expnt(s) = [147020.99190976]
bas 8, expnt(s) = [73510.41998183]
bas 9, expnt(s) = [36754.7147177]
bas 10, expnt(s) = [7303.14093948]
bas 11, expnt(s) = [18375.79879655]
bas 12, expnt(s) = [1449.094128]
bas 13, expnt(s) = [376.2193982]
bas 14, expnt(s) = [115.18442448]
bas 15, expnt(s) = [40.02995777]
bas 16, expnt(s) = [12.72130422]
bas 17, expnt(s) = [6.24282618]
bas 18, expnt(s) = [8.6044603]
bas 19, expnt(s) = [0.49264325]
CPU time:       494.24
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.62183841e-01 9.25698299e-01 6.65191139e-01 1.86090784e+00
 1.17616814e+05 1.60460109e+04 2.77618152e+00 5.43376584e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314094e+03 1.99593910e+03 1.83757988e+04 3.98749080e+03
 1.44909413e+03 5.93386241e+02 3.76219398e+02 2.15822099e+02
 1.15184424e+02 8.88301390e+01 4.00299578e+01 4.02072040e+01
 1.27213042e+01 1.70182051e+01 6.24282618e+00 9.97817132e+00
 8.60446030e+00 4.29921274e+01 4.92643255e-01 1.20406538e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33579522448821
cond(S) = 908467.3838199909
E1 = -689.5842916836812  E_coul = 184.96440769615168
init E= -504.619883987529
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672452348361464  LUMO = 0.733521888893842
  mo_energy =
[-1.21706582e+02 -1.33864934e+01 -7.62408762e+00 -7.62408762e+00
 -7.62408762e+00 -1.65765989e+00 -6.72452348e-01 -6.72452348e-01
 -6.72452348e-01  7.33521889e-01  8.16723215e+00  3.80249435e+01
  1.58008669e+02  6.59252423e+02  2.79979200e+03  1.22734209e+04
  4.08907192e+04  1.04932053e+05  2.30114063e+05  4.55928024e+05
  8.44879566e+05  1.52805615e+06  2.85032273e+06  5.80820896e+06]
E1 = -707.7406695890804  E_coul = 199.77652652994115
cycle= 1 E= -507.964143059139  delta_E= -3.34  |g|= 0.451  |ddm|= 0.514
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.68479
diis-c [-0.4689371  1.       ]
  HOMO = -0.217719876363724  LUMO = 1.12480798118539
  mo_energy =
[-1.20197441e+02 -1.23047644e+01 -6.59436591e+00 -6.59436591e+00
 -6.59436591e+00 -1.16319994e+00 -2.17719876e-01 -2.17719876e-01
 -2.17719876e-01  1.12480798e+00  8.94047682e+00  3.91427325e+01
  1.59413377e+02  6.60743399e+02  2.80122375e+03  1.22747436e+04
  4.08919752e+04  1.04933272e+05  2.30115258e+05  4.55929202e+05
  8.44880731e+05  1.52805731e+06  2.85032387e+06  5.80821010e+06]
E1 = -706.8039407593722  E_coul = 198.8223550178036
cycle= 2 E= -507.981585741569  delta_E= -0.0174  |g|= 0.0347  |ddm|= 0.425
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0292666
diis-c [-8.55260114e-04 -1.65233399e-03  1.00165233e+00]
  HOMO = -0.239303235793328  LUMO = 1.11916795738236
  mo_energy =
[-1.20310579e+02 -1.23711377e+01 -6.66794426e+00 -6.66794426e+00
 -6.66794426e+00 -1.17705449e+00 -2.39303236e-01 -2.39303236e-01
 -2.39303236e-01  1.11916796e+00  8.90117162e+00  3.90737389e+01
  1.59317023e+02  6.60626464e+02  2.80109069e+03  1.22746003e+04
  4.08918281e+04  1.04933123e+05  2.30115108e+05  4.55929052e+05
  8.44880580e+05  1.52805716e+06  2.85032372e+06  5.80820995e+06]
E1 = -706.6999138820188  E_coul = 198.71808278338244
cycle= 3 E= -507.981831098636  delta_E= -0.000245  |g|= 0.00423  |ddm|= 0.0594
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00309267
diis-c [-2.20841985e-06  9.60325299e-05 -1.02448510e-01  1.10235248e+00]
  HOMO = -0.242285043105565  LUMO = 1.11816339705886
  mo_energy =
[-1.20322013e+02 -1.23793942e+01 -6.67668389e+00 -6.67668389e+00
 -6.67668389e+00 -1.17885382e+00 -2.42285043e-01 -2.42285043e-01
 -2.42285043e-01  1.11816340e+00  8.89576672e+00  3.90654530e+01
  1.59306692e+02  6.60614891e+02  2.80107831e+03  1.22745875e+04
  4.08918151e+04  1.04933110e+05  2.30115095e+05  4.55929039e+05
  8.44880567e+05  1.52805714e+06  2.85032371e+06  5.80820994e+06]
E1 = -706.6856710502047  E_coul = 198.70383561013725
cycle= 4 E= -507.981835440067  delta_E= -4.34e-06  |g|= 0.000202  |ddm|= 0.00912
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000140809
diis-c [-1.33015863e-10 -6.93563894e-06  6.67981804e-03 -9.80164392e-02
  1.09134356e+00]
  HOMO = -0.242420121293576  LUMO = 1.11811117398516
  mo_energy =
[-1.20322359e+02 -1.23797221e+01 -6.67701000e+00 -6.67701000e+00
 -6.67701000e+00 -1.17893459e+00 -2.42420121e-01 -2.42420121e-01
 -2.42420121e-01  1.11811117e+00  8.89552678e+00  3.90651391e+01
  1.59306355e+02  6.60614544e+02  2.80107796e+03  1.22745871e+04
  4.08918148e+04  1.04933110e+05  2.30115095e+05  4.55929039e+05
  8.44880567e+05  1.52805714e+06  2.85032371e+06  5.80820994e+06]
E1 = -706.6850345602687  E_coul = 198.70319911061685
cycle= 5 E= -507.981835449652  delta_E= -9.58e-09  |g|= 1.63e-06  |ddm|= 0.000475
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.76882e-07
diis-c [-1.34535158e-13  2.78344098e-07 -2.07579046e-04  2.82873413e-03
 -3.33842952e-02  1.03076286e+00]
  HOMO = -0.242421000651764  LUMO = 1.11811095791287
  mo_energy =
[-1.20322361e+02 -1.23797241e+01 -6.67701204e+00 -6.67701204e+00
 -6.67701204e+00 -1.17893525e+00 -2.42421001e-01 -2.42421001e-01
 -2.42421001e-01  1.11811096e+00  8.89552527e+00  3.90651371e+01
  1.59306352e+02  6.60614541e+02  2.80107795e+03  1.22745871e+04
  4.08918148e+04  1.04933110e+05  2.30115095e+05  4.55929039e+05
  8.44880567e+05  1.52805714e+06  2.85032371e+06  5.80820994e+06]
E1 = -706.6850302054422  E_coul = 198.7031947557897
cycle= 6 E= -507.981835449653  delta_E= -6.82e-13  |g|= 5.67e-08  |ddm|= 3.71e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6850302054422  E_coul = 198.7031947557897
  HOMO = -0.242421028080036  LUMO = 1.11811094210201
  mo_energy =
[-1.20322362e+02 -1.23797242e+01 -6.67701210e+00 -6.67701210e+00
 -6.67701210e+00 -1.17893527e+00 -2.42421028e-01 -2.42421028e-01
 -2.42421028e-01  1.11811094e+00  8.89552522e+00  3.90651371e+01
  1.59306352e+02  6.60614541e+02  2.80107795e+03  1.22745871e+04
  4.08918148e+04  1.04933110e+05  2.30115095e+05  4.55929039e+05
  8.44880567e+05  1.52805714e+06  2.85032371e+06  5.80820994e+06]
E1 = -706.6850300804384  E_coul = 198.70319463078621
Extra cycle  E= -507.981835449652  delta_E= 3.41e-13  |g|= 7.1e-09  |ddm|= 1.13e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.62183841e-01 6.65191139e-01 1.17616814e+05 2.77618152e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314094e+03 1.83757988e+04
 1.44909413e+03 3.76219398e+02 1.15184424e+02 4.00299578e+01
 1.27213042e+01 6.24282618e+00 8.60446030e+00 4.92643255e-01]
E = -507.9818354496522
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:10:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.262183841302       1
[INPUT] 0    0    [1    /1   ]  0.665191138855       1
[INPUT] 0    0    [1    /1   ]  117616.813852        1
[INPUT] 0    0    [1    /1   ]  2.77618152316        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.99191         1
[INPUT] 0    0    [1    /1   ]  73510.4199818        1
[INPUT] 0    0    [1    /1   ]  36754.7147177        1
[INPUT] 0    0    [1    /1   ]  7303.14093948        1
[INPUT] 0    0    [1    /1   ]  18375.7987966        1
[INPUT] 0    0    [1    /1   ]  1449.094128          1
[INPUT] 0    0    [1    /1   ]  376.219398197        1
[INPUT] 0    0    [1    /1   ]  115.184424479        1
[INPUT] 0    0    [1    /1   ]  40.0299577659        1
[INPUT] 0    0    [1    /1   ]  12.7213042179        1
[INPUT] 0    0    [1    /1   ]  6.24282617986        1
[INPUT] 1    0    [1    /1   ]  8.60446029814        1
[INPUT] 1    0    [1    /1   ]  0.492643254501       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.26218384130206596, 1.0]], [0, [0.6651911388545608, 1.0]], [0, [117616.81385165492, 1.0]], [0, [2.7761815231558544, 1.0]], [0, [1176168.1426171642, 1.0]], [0, [588084.0699820638, 1.0]], [0, [294042.0310711775, 1.0]], [0, [147020.99190975787, 1.0]], [0, [73510.41998183126, 1.0]], [0, [36754.714717702765, 1.0]], [0, [7303.140939477055, 1.0]], [0, [18375.798796553052, 1.0]], [0, [1449.094127997222, 1.0]], [0, [376.2193981965462, 1.0]], [0, [115.18442447859054, 1.0]], [0, [40.02995776589024, 1.0]], [0, [12.72130421792209, 1.0]], [0, [6.24282617986464, 1.0]], [1, [8.604460298137049, 1.0]], [1, [0.4926432545008792, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26218384]
bas 1, expnt(s) = [0.66519114]
bas 2, expnt(s) = [117616.81385165]
bas 3, expnt(s) = [2.77618152]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998206]
bas 6, expnt(s) = [294042.03107118]
bas 7, expnt(s) = [147020.99190976]
bas 8, expnt(s) = [73510.41998183]
bas 9, expnt(s) = [36754.7147177]
bas 10, expnt(s) = [7303.14093948]
bas 11, expnt(s) = [18375.79879655]
bas 12, expnt(s) = [1449.094128]
bas 13, expnt(s) = [376.2193982]
bas 14, expnt(s) = [115.18442448]
bas 15, expnt(s) = [40.02995777]
bas 16, expnt(s) = [12.72130422]
bas 17, expnt(s) = [6.24282618]
bas 18, expnt(s) = [8.6044603]
bas 19, expnt(s) = [0.49264325]
CPU time:       495.60
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.62183841e-01 9.25698299e-01 6.65191139e-01 1.86090784e+00
 1.17616814e+05 1.60460109e+04 2.77618152e+00 5.43376584e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314094e+03 1.99593910e+03 1.83757988e+04 3.98749080e+03
 1.44909413e+03 5.93386241e+02 3.76219398e+02 2.15822099e+02
 1.15184424e+02 8.88301390e+01 4.00299578e+01 4.02072040e+01
 1.27213042e+01 1.70182051e+01 6.24282618e+00 9.97817132e+00
 8.60446030e+00 4.29921274e+01 4.92643255e-01 1.20406538e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33579522448821
cond(S) = 908467.3838199909
E1 = -689.5842916836812  E_coul = 184.96440769615168
init E= -504.619883987529
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672452348361464  LUMO = 0.733521888893842
  mo_energy =
[-1.21706582e+02 -1.33864934e+01 -7.62408762e+00 -7.62408762e+00
 -7.62408762e+00 -1.65765989e+00 -6.72452348e-01 -6.72452348e-01
 -6.72452348e-01  7.33521889e-01  8.16723215e+00  3.80249435e+01
  1.58008669e+02  6.59252423e+02  2.79979200e+03  1.22734209e+04
  4.08907192e+04  1.04932053e+05  2.30114063e+05  4.55928024e+05
  8.44879566e+05  1.52805615e+06  2.85032273e+06  5.80820896e+06]
E1 = -707.7406695890804  E_coul = 199.77652652994115
cycle= 1 E= -507.964143059139  delta_E= -3.34  |g|= 0.451  |ddm|= 0.514
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.68479
diis-c [-0.4689371  1.       ]
  HOMO = -0.217719876363724  LUMO = 1.12480798118539
  mo_energy =
[-1.20197441e+02 -1.23047644e+01 -6.59436591e+00 -6.59436591e+00
 -6.59436591e+00 -1.16319994e+00 -2.17719876e-01 -2.17719876e-01
 -2.17719876e-01  1.12480798e+00  8.94047682e+00  3.91427325e+01
  1.59413377e+02  6.60743399e+02  2.80122375e+03  1.22747436e+04
  4.08919752e+04  1.04933272e+05  2.30115258e+05  4.55929202e+05
  8.44880731e+05  1.52805731e+06  2.85032387e+06  5.80821010e+06]
E1 = -706.8039407593722  E_coul = 198.8223550178036
cycle= 2 E= -507.981585741569  delta_E= -0.0174  |g|= 0.0347  |ddm|= 0.425
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0292666
diis-c [-8.55260114e-04 -1.65233399e-03  1.00165233e+00]
  HOMO = -0.239303235793328  LUMO = 1.11916795738236
  mo_energy =
[-1.20310579e+02 -1.23711377e+01 -6.66794426e+00 -6.66794426e+00
 -6.66794426e+00 -1.17705449e+00 -2.39303236e-01 -2.39303236e-01
 -2.39303236e-01  1.11916796e+00  8.90117162e+00  3.90737389e+01
  1.59317023e+02  6.60626464e+02  2.80109069e+03  1.22746003e+04
  4.08918281e+04  1.04933123e+05  2.30115108e+05  4.55929052e+05
  8.44880580e+05  1.52805716e+06  2.85032372e+06  5.80820995e+06]
E1 = -706.6999138820188  E_coul = 198.71808278338244
cycle= 3 E= -507.981831098636  delta_E= -0.000245  |g|= 0.00423  |ddm|= 0.0594
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00309267
diis-c [-2.20841985e-06  9.60325299e-05 -1.02448510e-01  1.10235248e+00]
  HOMO = -0.242285043105565  LUMO = 1.11816339705886
  mo_energy =
[-1.20322013e+02 -1.23793942e+01 -6.67668389e+00 -6.67668389e+00
 -6.67668389e+00 -1.17885382e+00 -2.42285043e-01 -2.42285043e-01
 -2.42285043e-01  1.11816340e+00  8.89576672e+00  3.90654530e+01
  1.59306692e+02  6.60614891e+02  2.80107831e+03  1.22745875e+04
  4.08918151e+04  1.04933110e+05  2.30115095e+05  4.55929039e+05
  8.44880567e+05  1.52805714e+06  2.85032371e+06  5.80820994e+06]
E1 = -706.6856710502047  E_coul = 198.70383561013725
cycle= 4 E= -507.981835440067  delta_E= -4.34e-06  |g|= 0.000202  |ddm|= 0.00912
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000140809
diis-c [-1.33015863e-10 -6.93563894e-06  6.67981804e-03 -9.80164392e-02
  1.09134356e+00]
  HOMO = -0.242420121293576  LUMO = 1.11811117398516
  mo_energy =
[-1.20322359e+02 -1.23797221e+01 -6.67701000e+00 -6.67701000e+00
 -6.67701000e+00 -1.17893459e+00 -2.42420121e-01 -2.42420121e-01
 -2.42420121e-01  1.11811117e+00  8.89552678e+00  3.90651391e+01
  1.59306355e+02  6.60614544e+02  2.80107796e+03  1.22745871e+04
  4.08918148e+04  1.04933110e+05  2.30115095e+05  4.55929039e+05
  8.44880567e+05  1.52805714e+06  2.85032371e+06  5.80820994e+06]
E1 = -706.6850345602687  E_coul = 198.70319911061685
cycle= 5 E= -507.981835449652  delta_E= -9.58e-09  |g|= 1.63e-06  |ddm|= 0.000475
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.76882e-07
diis-c [-1.34535158e-13  2.78344098e-07 -2.07579046e-04  2.82873413e-03
 -3.33842952e-02  1.03076286e+00]
  HOMO = -0.242421000651764  LUMO = 1.11811095791287
  mo_energy =
[-1.20322361e+02 -1.23797241e+01 -6.67701204e+00 -6.67701204e+00
 -6.67701204e+00 -1.17893525e+00 -2.42421001e-01 -2.42421001e-01
 -2.42421001e-01  1.11811096e+00  8.89552527e+00  3.90651371e+01
  1.59306352e+02  6.60614541e+02  2.80107795e+03  1.22745871e+04
  4.08918148e+04  1.04933110e+05  2.30115095e+05  4.55929039e+05
  8.44880567e+05  1.52805714e+06  2.85032371e+06  5.80820994e+06]
E1 = -706.6850302054422  E_coul = 198.7031947557897
cycle= 6 E= -507.981835449653  delta_E= -6.82e-13  |g|= 5.67e-08  |ddm|= 3.71e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6850302054422  E_coul = 198.7031947557897
  HOMO = -0.242421028080036  LUMO = 1.11811094210201
  mo_energy =
[-1.20322362e+02 -1.23797242e+01 -6.67701210e+00 -6.67701210e+00
 -6.67701210e+00 -1.17893527e+00 -2.42421028e-01 -2.42421028e-01
 -2.42421028e-01  1.11811094e+00  8.89552522e+00  3.90651371e+01
  1.59306352e+02  6.60614541e+02  2.80107795e+03  1.22745871e+04
  4.08918148e+04  1.04933110e+05  2.30115095e+05  4.55929039e+05
  8.44880567e+05  1.52805714e+06  2.85032371e+06  5.80820994e+06]
E1 = -706.6850300804384  E_coul = 198.70319463078621
Extra cycle  E= -507.981835449652  delta_E= 3.41e-13  |g|= 7.1e-09  |ddm|= 1.13e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908467.3838199909
E1 = -706.6850300804384  E_coul = 198.70319463078621
init E= -507.981835449652
    CPU time for initialize scf      3.32 sec, wall time      0.21 sec
  HOMO = -0.242421031904101  LUMO = 1.11811094110293
  mo_energy =
[-1.20322362e+02 -1.23797242e+01 -6.67701211e+00 -6.67701211e+00
 -6.67701211e+00 -1.17893527e+00 -2.42421032e-01 -2.42421032e-01
 -2.42421032e-01  1.11811094e+00  8.89552521e+00  3.90651371e+01
  1.59306352e+02  6.60614541e+02  2.80107795e+03  1.22745871e+04
  4.08918148e+04  1.04933110e+05  2.30115095e+05  4.55929039e+05
  8.44880567e+05  1.52805714e+06  2.85032371e+06  5.80820994e+06]
E1 = -706.6850300619531  E_coul = 198.7031946123007
cycle= 1 E= -507.981835449652  delta_E= -1.71e-13  |g|= 1.95e-09  |ddm|= 1.42e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6850300619531  E_coul = 198.7031946123007
  HOMO = -0.242421032446535  LUMO = 1.11811094028895
  mo_energy =
[-1.20322362e+02 -1.23797242e+01 -6.67701211e+00 -6.67701211e+00
 -6.67701211e+00 -1.17893527e+00 -2.42421032e-01 -2.42421032e-01
 -2.42421032e-01  1.11811094e+00  8.89552521e+00  3.90651371e+01
  1.59306352e+02  6.60614541e+02  2.80107795e+03  1.22745871e+04
  4.08918148e+04  1.04933110e+05  2.30115095e+05  4.55929039e+05
  8.44880567e+05  1.52805714e+06  2.85032371e+06  5.80820994e+06]
E1 = -706.6850300595268  E_coul = 198.7031946098744
Extra cycle  E= -507.981835449652  delta_E=    0  |g|= 1.47e-09  |ddm|= 1.73e-09
    CPU time for scf_cycle      3.78 sec, wall time      0.38 sec
exp = [2.62183841e-01 6.65191139e-01 1.17616814e+05 2.77618152e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314094e+03 1.83757988e+04
 1.44909413e+03 3.76219398e+02 1.15184424e+02 4.00299578e+01
 1.27213042e+01 6.24282618e+00 8.60446030e+00 4.92643255e-01]
grad_E = [ 2.83201278e-02 -6.15769967e-03  4.36806256e-09  1.27793410e-03
  2.09691511e-11  1.18806301e-10  6.79456726e-10  2.66665014e-09
  1.10854791e-08  5.94127972e-08  3.75056543e-06  1.29885135e-07
 -1.79898994e-06  4.39576126e-05 -2.70665183e-04 -1.05451076e-03
  7.51357038e-05 -2.05101195e-04  3.45835385e-04 -4.50379985e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:10:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.255507704439       1
[INPUT] 0    0    [1    /1   ]  0.658206526626       1
[INPUT] 0    0    [1    /1   ]  117616.813851        1
[INPUT] 0    0    [1    /1   ]  2.74350795197        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.99191         1
[INPUT] 0    0    [1    /1   ]  73510.4199814        1
[INPUT] 0    0    [1    /1   ]  36754.7147154        1
[INPUT] 0    0    [1    /1   ]  7303.14079354        1
[INPUT] 0    0    [1    /1   ]  18375.7987916        1
[INPUT] 0    0    [1    /1   ]  1449.0932617         1
[INPUT] 0    0    [1    /1   ]  376.231801053        1
[INPUT] 0    0    [1    /1   ]  115.101928701        1
[INPUT] 0    0    [1    /1   ]  40.2357233704        1
[INPUT] 0    0    [1    /1   ]  12.8053811584        1
[INPUT] 0    0    [1    /1   ]  6.27311825534        1
[INPUT] 1    0    [1    /1   ]  8.6013638725         1
[INPUT] 1    0    [1    /1   ]  0.492760794458       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2555077044386036, 1.0]], [0, [0.6582065266263598, 1.0]], [0, [117616.8138514839, 1.0]], [0, [2.7435079519690375, 1.0]], [0, [1176168.1426171635, 1.0]], [0, [588084.0699820593, 1.0]], [0, [294042.0310711509, 1.0]], [0, [147020.9919096536, 1.0]], [0, [73510.41998139847, 1.0]], [0, [36754.71471536251, 1.0]], [0, [7303.140793536838, 1.0]], [0, [18375.798791640536, 1.0]], [0, [1449.0932616963776, 1.0]], [0, [376.23180105290595, 1.0]], [0, [115.10192870137288, 1.0]], [0, [40.23572337043199, 1.0]], [0, [12.80538115837153, 1.0]], [0, [6.273118255343412, 1.0]], [1, [8.60136387250437, 1.0]], [1, [0.49276079445849885, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2555077]
bas 1, expnt(s) = [0.65820653]
bas 2, expnt(s) = [117616.81385148]
bas 3, expnt(s) = [2.74350795]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998206]
bas 6, expnt(s) = [294042.03107115]
bas 7, expnt(s) = [147020.99190965]
bas 8, expnt(s) = [73510.4199814]
bas 9, expnt(s) = [36754.71471536]
bas 10, expnt(s) = [7303.14079354]
bas 11, expnt(s) = [18375.79879164]
bas 12, expnt(s) = [1449.0932617]
bas 13, expnt(s) = [376.23180105]
bas 14, expnt(s) = [115.1019287]
bas 15, expnt(s) = [40.23572337]
bas 16, expnt(s) = [12.80538116]
bas 17, expnt(s) = [6.27311826]
bas 18, expnt(s) = [8.60136387]
bas 19, expnt(s) = [0.49276079]
CPU time:       507.21
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.55507704e-01 9.07962735e-01 6.58206527e-01 1.84623365e+00
 1.17616814e+05 1.60460109e+04 2.74350795e+00 5.38573142e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314079e+03 1.99593907e+03 1.83757988e+04 3.98749080e+03
 1.44909326e+03 5.93385975e+02 3.76231801e+02 2.15827436e+02
 1.15101929e+02 8.87824192e+01 4.02357234e+01 4.03621121e+01
 1.28053812e+01 1.71024924e+01 6.27311826e+00 1.00144622e+01
 8.60136387e+00 4.29727892e+01 4.92760794e-01 1.20442449e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335794761249087
cond(S) = 908473.7903105381
E1 = -689.574648329694  E_coul = 184.95561501179657
init E= -504.619033317897
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672222315660481  LUMO = 0.705670262906103
  mo_energy =
[-1.21709133e+02 -1.33872005e+01 -7.62474884e+00 -7.62474884e+00
 -7.62474884e+00 -1.65753596e+00 -6.72222316e-01 -6.72222316e-01
 -6.72222316e-01  7.05670263e-01  8.06594991e+00  3.80656100e+01
  1.58596194e+02  6.60076185e+02  2.80053722e+03  1.22740752e+04
  4.08913250e+04  1.04932633e+05  2.30114627e+05  4.55928577e+05
  8.44880109e+05  1.52805669e+06  2.85032325e+06  5.80820947e+06]
E1 = -707.7281092168255  E_coul = 199.76377687221128
cycle= 1 E= -507.964332344614  delta_E= -3.35  |g|= 0.451  |ddm|= 0.506
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.686297
diis-c [-0.47100425  1.        ]
  HOMO = -0.21757164340016  LUMO = 1.09263939144064
  mo_energy =
[-1.20200355e+02 -1.23057720e+01 -6.59537663e+00 -6.59537663e+00
 -6.59537663e+00 -1.16319488e+00 -2.17571643e-01 -2.17571643e-01
 -2.17571643e-01  1.09263939e+00  8.83822975e+00  3.91850260e+01
  1.60001251e+02  6.61566872e+02  2.80196861e+03  1.22753976e+04
  4.08925806e+04  1.04933852e+05  2.30115822e+05  4.55929754e+05
  8.44881274e+05  1.52805784e+06  2.85032440e+06  5.80821061e+06]
E1 = -706.7873190943742  E_coul = 198.8054570519703
cycle= 2 E= -507.981862042404  delta_E= -0.0175  |g|= 0.0348  |ddm|= 0.425
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0296285
diis-c [-8.76188757e-04 -1.88196088e-03  1.00188196e+00]
  HOMO = -0.239324384930378  LUMO = 1.08712070907944
  mo_energy =
[-1.20313841e+02 -1.23724504e+01 -6.66926135e+00 -6.66926135e+00
 -6.66926135e+00 -1.17716821e+00 -2.39324385e-01 -2.39324385e-01
 -2.39324385e-01  1.08712071e+00  8.79883062e+00  3.91156041e+01
  1.59904496e+02  6.61449589e+02  2.80183519e+03  1.22752539e+04
  4.08924332e+04  1.04933703e+05  2.30115672e+05  4.55929604e+05
  8.44881123e+05  1.52805769e+06  2.85032424e+06  5.80821046e+06]
E1 = -706.682161661715  E_coul = 198.70004991124034
cycle= 3 E= -507.982111750475  delta_E= -0.00025  |g|= 0.00426  |ddm|= 0.0596
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0031553
diis-c [-2.27447622e-06  8.79155652e-05 -1.03507598e-01  1.10341968e+00]
  HOMO = -0.242349912314612  LUMO = 1.08612422184952
  mo_energy =
[-1.20325361e+02 -1.23807889e+01 -6.67808271e+00 -6.67808271e+00
 -6.67808271e+00 -1.17899522e+00 -2.42349912e-01 -2.42349912e-01
 -2.42349912e-01  1.08612422e+00  8.79337431e+00  3.91072271e+01
  1.59894076e+02  6.61437929e+02  2.80182273e+03  1.22752410e+04
  4.08924201e+04  1.04933690e+05  2.30115659e+05  4.55929591e+05
  8.44881110e+05  1.52805768e+06  2.85032423e+06  5.80821045e+06]
E1 = -706.6676720035485  E_coul = 198.68555578026476
cycle= 4 E= -507.982116223284  delta_E= -4.47e-06  |g|= 0.000204  |ddm|= 0.00922
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000143047
diis-c [-1.43460499e-10 -7.09064481e-06  6.72211318e-03 -9.78790380e-02
  1.09116402e+00]
  HOMO = -0.24248662913075  LUMO = 1.08607228214877
  mo_energy =
[-1.20325706e+02 -1.23811182e+01 -6.67840980e+00 -6.67840980e+00
 -6.67840980e+00 -1.17907700e+00 -2.42486629e-01 -2.42486629e-01
 -2.42486629e-01  1.08607228e+00  8.79313262e+00  3.91069119e+01
  1.59893738e+02  6.61437584e+02  2.80182238e+03  1.22752406e+04
  4.08924197e+04  1.04933690e+05  2.30115658e+05  4.55929590e+05
  8.44881110e+05  1.52805768e+06  2.85032423e+06  5.80821045e+06]
E1 = -706.6670258483142  E_coul = 198.68490961514843
cycle= 5 E= -507.982116233166  delta_E= -9.88e-09  |g|= 1.74e-06  |ddm|= 0.00048
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.40418e-07
diis-c [-1.54092048e-13  2.90858425e-07 -2.26140883e-04  3.06794820e-03
 -3.62567570e-02  1.03341466e+00]
  HOMO = -0.242487574389916  LUMO = 1.08607205115084
  mo_energy =
[-1.20325709e+02 -1.23811203e+01 -6.67841198e+00 -6.67841198e+00
 -6.67841198e+00 -1.17907771e+00 -2.42487574e-01 -2.42487574e-01
 -2.42487574e-01  1.08607205e+00  8.79313100e+00  3.91069098e+01
  1.59893735e+02  6.61437581e+02  2.80182237e+03  1.22752406e+04
  4.08924197e+04  1.04933690e+05  2.30115658e+05  4.55929590e+05
  8.44881110e+05  1.52805768e+06  2.85032423e+06  5.80821045e+06]
E1 = -706.6670211324888  E_coul = 198.6849048993227
cycle= 6 E= -507.982116233166  delta_E= -2.84e-13  |g|= 5.78e-08  |ddm|= 3.98e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6670211324888  E_coul = 198.6849048993227
  HOMO = -0.242487602610766  LUMO = 1.08607203635018
  mo_energy =
[-1.20325709e+02 -1.23811203e+01 -6.67841204e+00 -6.67841204e+00
 -6.67841204e+00 -1.17907772e+00 -2.42487603e-01 -2.42487603e-01
 -2.42487603e-01  1.08607204e+00  8.79313094e+00  3.91069097e+01
  1.59893735e+02  6.61437581e+02  2.80182237e+03  1.22752406e+04
  4.08924197e+04  1.04933690e+05  2.30115658e+05  4.55929590e+05
  8.44881110e+05  1.52805768e+06  2.85032423e+06  5.80821045e+06]
E1 = -706.6670210037553  E_coul = 198.6849047705889
Extra cycle  E= -507.982116233166  delta_E= -2.84e-13  |g|= 6.97e-09  |ddm|= 1.16e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.55507704e-01 6.58206527e-01 1.17616814e+05 2.74350795e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314079e+03 1.83757988e+04
 1.44909326e+03 3.76231801e+02 1.15101929e+02 4.02357234e+01
 1.28053812e+01 6.27311826e+00 8.60136387e+00 4.92760794e-01]
E = -507.9821162331664
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:10:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.255507704439       1
[INPUT] 0    0    [1    /1   ]  0.658206526626       1
[INPUT] 0    0    [1    /1   ]  117616.813851        1
[INPUT] 0    0    [1    /1   ]  2.74350795197        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.99191         1
[INPUT] 0    0    [1    /1   ]  73510.4199814        1
[INPUT] 0    0    [1    /1   ]  36754.7147154        1
[INPUT] 0    0    [1    /1   ]  7303.14079354        1
[INPUT] 0    0    [1    /1   ]  18375.7987916        1
[INPUT] 0    0    [1    /1   ]  1449.0932617         1
[INPUT] 0    0    [1    /1   ]  376.231801053        1
[INPUT] 0    0    [1    /1   ]  115.101928701        1
[INPUT] 0    0    [1    /1   ]  40.2357233704        1
[INPUT] 0    0    [1    /1   ]  12.8053811584        1
[INPUT] 0    0    [1    /1   ]  6.27311825534        1
[INPUT] 1    0    [1    /1   ]  8.6013638725         1
[INPUT] 1    0    [1    /1   ]  0.492760794458       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2555077044386036, 1.0]], [0, [0.6582065266263598, 1.0]], [0, [117616.8138514839, 1.0]], [0, [2.7435079519690375, 1.0]], [0, [1176168.1426171635, 1.0]], [0, [588084.0699820593, 1.0]], [0, [294042.0310711509, 1.0]], [0, [147020.9919096536, 1.0]], [0, [73510.41998139847, 1.0]], [0, [36754.71471536251, 1.0]], [0, [7303.140793536838, 1.0]], [0, [18375.798791640536, 1.0]], [0, [1449.0932616963776, 1.0]], [0, [376.23180105290595, 1.0]], [0, [115.10192870137288, 1.0]], [0, [40.23572337043199, 1.0]], [0, [12.80538115837153, 1.0]], [0, [6.273118255343412, 1.0]], [1, [8.60136387250437, 1.0]], [1, [0.49276079445849885, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2555077]
bas 1, expnt(s) = [0.65820653]
bas 2, expnt(s) = [117616.81385148]
bas 3, expnt(s) = [2.74350795]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998206]
bas 6, expnt(s) = [294042.03107115]
bas 7, expnt(s) = [147020.99190965]
bas 8, expnt(s) = [73510.4199814]
bas 9, expnt(s) = [36754.71471536]
bas 10, expnt(s) = [7303.14079354]
bas 11, expnt(s) = [18375.79879164]
bas 12, expnt(s) = [1449.0932617]
bas 13, expnt(s) = [376.23180105]
bas 14, expnt(s) = [115.1019287]
bas 15, expnt(s) = [40.23572337]
bas 16, expnt(s) = [12.80538116]
bas 17, expnt(s) = [6.27311826]
bas 18, expnt(s) = [8.60136387]
bas 19, expnt(s) = [0.49276079]
CPU time:       508.57
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.55507704e-01 9.07962735e-01 6.58206527e-01 1.84623365e+00
 1.17616814e+05 1.60460109e+04 2.74350795e+00 5.38573142e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314079e+03 1.99593907e+03 1.83757988e+04 3.98749080e+03
 1.44909326e+03 5.93385975e+02 3.76231801e+02 2.15827436e+02
 1.15101929e+02 8.87824192e+01 4.02357234e+01 4.03621121e+01
 1.28053812e+01 1.71024924e+01 6.27311826e+00 1.00144622e+01
 8.60136387e+00 4.29727892e+01 4.92760794e-01 1.20442449e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335794761249087
cond(S) = 908473.7903105381
E1 = -689.574648329694  E_coul = 184.95561501179657
init E= -504.619033317897
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672222315660481  LUMO = 0.705670262906103
  mo_energy =
[-1.21709133e+02 -1.33872005e+01 -7.62474884e+00 -7.62474884e+00
 -7.62474884e+00 -1.65753596e+00 -6.72222316e-01 -6.72222316e-01
 -6.72222316e-01  7.05670263e-01  8.06594991e+00  3.80656100e+01
  1.58596194e+02  6.60076185e+02  2.80053722e+03  1.22740752e+04
  4.08913250e+04  1.04932633e+05  2.30114627e+05  4.55928577e+05
  8.44880109e+05  1.52805669e+06  2.85032325e+06  5.80820947e+06]
E1 = -707.7281092168255  E_coul = 199.76377687221128
cycle= 1 E= -507.964332344614  delta_E= -3.35  |g|= 0.451  |ddm|= 0.506
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.686297
diis-c [-0.47100425  1.        ]
  HOMO = -0.21757164340016  LUMO = 1.09263939144064
  mo_energy =
[-1.20200355e+02 -1.23057720e+01 -6.59537663e+00 -6.59537663e+00
 -6.59537663e+00 -1.16319488e+00 -2.17571643e-01 -2.17571643e-01
 -2.17571643e-01  1.09263939e+00  8.83822975e+00  3.91850260e+01
  1.60001251e+02  6.61566872e+02  2.80196861e+03  1.22753976e+04
  4.08925806e+04  1.04933852e+05  2.30115822e+05  4.55929754e+05
  8.44881274e+05  1.52805784e+06  2.85032440e+06  5.80821061e+06]
E1 = -706.7873190943742  E_coul = 198.8054570519703
cycle= 2 E= -507.981862042404  delta_E= -0.0175  |g|= 0.0348  |ddm|= 0.425
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0296285
diis-c [-8.76188757e-04 -1.88196088e-03  1.00188196e+00]
  HOMO = -0.239324384930378  LUMO = 1.08712070907944
  mo_energy =
[-1.20313841e+02 -1.23724504e+01 -6.66926135e+00 -6.66926135e+00
 -6.66926135e+00 -1.17716821e+00 -2.39324385e-01 -2.39324385e-01
 -2.39324385e-01  1.08712071e+00  8.79883062e+00  3.91156041e+01
  1.59904496e+02  6.61449589e+02  2.80183519e+03  1.22752539e+04
  4.08924332e+04  1.04933703e+05  2.30115672e+05  4.55929604e+05
  8.44881123e+05  1.52805769e+06  2.85032424e+06  5.80821046e+06]
E1 = -706.682161661715  E_coul = 198.70004991124034
cycle= 3 E= -507.982111750475  delta_E= -0.00025  |g|= 0.00426  |ddm|= 0.0596
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0031553
diis-c [-2.27447622e-06  8.79155652e-05 -1.03507598e-01  1.10341968e+00]
  HOMO = -0.242349912314612  LUMO = 1.08612422184952
  mo_energy =
[-1.20325361e+02 -1.23807889e+01 -6.67808271e+00 -6.67808271e+00
 -6.67808271e+00 -1.17899522e+00 -2.42349912e-01 -2.42349912e-01
 -2.42349912e-01  1.08612422e+00  8.79337431e+00  3.91072271e+01
  1.59894076e+02  6.61437929e+02  2.80182273e+03  1.22752410e+04
  4.08924201e+04  1.04933690e+05  2.30115659e+05  4.55929591e+05
  8.44881110e+05  1.52805768e+06  2.85032423e+06  5.80821045e+06]
E1 = -706.6676720035485  E_coul = 198.68555578026476
cycle= 4 E= -507.982116223284  delta_E= -4.47e-06  |g|= 0.000204  |ddm|= 0.00922
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000143047
diis-c [-1.43460499e-10 -7.09064481e-06  6.72211318e-03 -9.78790380e-02
  1.09116402e+00]
  HOMO = -0.24248662913075  LUMO = 1.08607228214877
  mo_energy =
[-1.20325706e+02 -1.23811182e+01 -6.67840980e+00 -6.67840980e+00
 -6.67840980e+00 -1.17907700e+00 -2.42486629e-01 -2.42486629e-01
 -2.42486629e-01  1.08607228e+00  8.79313262e+00  3.91069119e+01
  1.59893738e+02  6.61437584e+02  2.80182238e+03  1.22752406e+04
  4.08924197e+04  1.04933690e+05  2.30115658e+05  4.55929590e+05
  8.44881110e+05  1.52805768e+06  2.85032423e+06  5.80821045e+06]
E1 = -706.6670258483142  E_coul = 198.68490961514843
cycle= 5 E= -507.982116233166  delta_E= -9.88e-09  |g|= 1.74e-06  |ddm|= 0.00048
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.40418e-07
diis-c [-1.54092048e-13  2.90858425e-07 -2.26140883e-04  3.06794820e-03
 -3.62567570e-02  1.03341466e+00]
  HOMO = -0.242487574389916  LUMO = 1.08607205115084
  mo_energy =
[-1.20325709e+02 -1.23811203e+01 -6.67841198e+00 -6.67841198e+00
 -6.67841198e+00 -1.17907771e+00 -2.42487574e-01 -2.42487574e-01
 -2.42487574e-01  1.08607205e+00  8.79313100e+00  3.91069098e+01
  1.59893735e+02  6.61437581e+02  2.80182237e+03  1.22752406e+04
  4.08924197e+04  1.04933690e+05  2.30115658e+05  4.55929590e+05
  8.44881110e+05  1.52805768e+06  2.85032423e+06  5.80821045e+06]
E1 = -706.6670211324888  E_coul = 198.6849048993227
cycle= 6 E= -507.982116233166  delta_E= -2.84e-13  |g|= 5.78e-08  |ddm|= 3.98e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6670211324888  E_coul = 198.6849048993227
  HOMO = -0.242487602610766  LUMO = 1.08607203635018
  mo_energy =
[-1.20325709e+02 -1.23811203e+01 -6.67841204e+00 -6.67841204e+00
 -6.67841204e+00 -1.17907772e+00 -2.42487603e-01 -2.42487603e-01
 -2.42487603e-01  1.08607204e+00  8.79313094e+00  3.91069097e+01
  1.59893735e+02  6.61437581e+02  2.80182237e+03  1.22752406e+04
  4.08924197e+04  1.04933690e+05  2.30115658e+05  4.55929590e+05
  8.44881110e+05  1.52805768e+06  2.85032423e+06  5.80821045e+06]
E1 = -706.6670210037553  E_coul = 198.6849047705889
Extra cycle  E= -507.982116233166  delta_E= -2.84e-13  |g|= 6.97e-09  |ddm|= 1.16e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908473.7903105381
E1 = -706.6670210037553  E_coul = 198.6849047705889
init E= -507.982116233166
    CPU time for initialize scf      3.31 sec, wall time      0.21 sec
  HOMO = -0.24248760657406  LUMO = 1.08607203283207
  mo_energy =
[-1.20325709e+02 -1.23811204e+01 -6.67841205e+00 -6.67841205e+00
 -6.67841205e+00 -1.17907772e+00 -2.42487607e-01 -2.42487607e-01
 -2.42487607e-01  1.08607203e+00  8.79313094e+00  3.91069097e+01
  1.59893735e+02  6.61437581e+02  2.80182237e+03  1.22752406e+04
  4.08924197e+04  1.04933690e+05  2.30115658e+05  4.55929590e+05
  8.44881110e+05  1.52805768e+06  2.85032423e+06  5.80821045e+06]
E1 = -706.6670209848627  E_coul = 198.6849047516966
cycle= 1 E= -507.982116233166  delta_E= 2.84e-13  |g|= 2e-09  |ddm|= 1.43e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6670209848627  E_coul = 198.6849047516966
  HOMO = -0.242487607114885  LUMO = 1.08607203326407
  mo_energy =
[-1.20325709e+02 -1.23811204e+01 -6.67841205e+00 -6.67841205e+00
 -6.67841205e+00 -1.17907773e+00 -2.42487607e-01 -2.42487607e-01
 -2.42487607e-01  1.08607203e+00  8.79313094e+00  3.91069097e+01
  1.59893735e+02  6.61437581e+02  2.80182237e+03  1.22752406e+04
  4.08924197e+04  1.04933690e+05  2.30115658e+05  4.55929590e+05
  8.44881110e+05  1.52805768e+06  2.85032423e+06  5.80821045e+06]
E1 = -706.6670209819199  E_coul = 198.6849047487533
Extra cycle  E= -507.982116233167  delta_E= -5.12e-13  |g|= 1.54e-09  |ddm|= 2.13e-09
    CPU time for scf_cycle      3.76 sec, wall time      0.38 sec
exp = [2.55507704e-01 6.58206527e-01 1.17616814e+05 2.74350795e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314079e+03 1.83757988e+04
 1.44909326e+03 3.76231801e+02 1.15101929e+02 4.02357234e+01
 1.28053812e+01 6.27311826e+00 8.60136387e+00 4.92760794e-01]
grad_E = [ 1.73742063e-02 -3.88596786e-03  4.43359110e-09  4.23419421e-04
  2.17408963e-11  1.20936997e-10  6.89585571e-10  2.70716048e-09
  1.12563383e-08  6.02526725e-08  3.80972138e-06  1.32466916e-07
 -5.09100149e-06  8.93191006e-05 -5.17795983e-04 -6.29648141e-04
 -1.11184173e-05  8.68081325e-05 -2.40144042e-03  5.64479407e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:11:04 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247746452132       1
[INPUT] 0    0    [1    /1   ]  0.647972160337       1
[INPUT] 0    0    [1    /1   ]  117616.813851        1
[INPUT] 0    0    [1    /1   ]  2.75780207682        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991909        1
[INPUT] 0    0    [1    /1   ]  73510.4199799        1
[INPUT] 0    0    [1    /1   ]  36754.7147073        1
[INPUT] 0    0    [1    /1   ]  7303.14028773        1
[INPUT] 0    0    [1    /1   ]  18375.7987742        1
[INPUT] 0    0    [1    /1   ]  1449.09269368        1
[INPUT] 0    0    [1    /1   ]  376.239565089        1
[INPUT] 0    0    [1    /1   ]  115.038595186        1
[INPUT] 0    0    [1    /1   ]  40.4831417856        1
[INPUT] 0    0    [1    /1   ]  13.0019106486        1
[INPUT] 0    0    [1    /1   ]  6.36989440381        1
[INPUT] 1    0    [1    /1   ]  8.60246384794        1
[INPUT] 1    0    [1    /1   ]  0.492716921296       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24774645213210184, 1.0]], [0, [0.6479721603371, 1.0]], [0, [117616.81385089368, 1.0]], [0, [2.757802076824426, 1.0]], [0, [1176168.1426171607, 1.0]], [0, [588084.0699820434, 1.0]], [0, [294042.0310710591, 1.0]], [0, [147020.99190929337, 1.0]], [0, [73510.41997990158, 1.0]], [0, [36754.71470732386, 1.0]], [0, [7303.140287727296, 1.0]], [0, [18375.798774224528, 1.0]], [0, [1449.0926936750282, 1.0]], [0, [376.23956508852416, 1.0]], [0, [115.03859518649992, 1.0]], [0, [40.483141785646936, 1.0]], [0, [13.001910648555159, 1.0]], [0, [6.369894403813668, 1.0]], [1, [8.602463847938902, 1.0]], [1, [0.49271692129572364, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24774645]
bas 1, expnt(s) = [0.64797216]
bas 2, expnt(s) = [117616.81385089]
bas 3, expnt(s) = [2.75780208]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998204]
bas 6, expnt(s) = [294042.03107106]
bas 7, expnt(s) = [147020.99190929]
bas 8, expnt(s) = [73510.4199799]
bas 9, expnt(s) = [36754.71470732]
bas 10, expnt(s) = [7303.14028773]
bas 11, expnt(s) = [18375.79877422]
bas 12, expnt(s) = [1449.09269368]
bas 13, expnt(s) = [376.23956509]
bas 14, expnt(s) = [115.03859519]
bas 15, expnt(s) = [40.48314179]
bas 16, expnt(s) = [13.00191065]
bas 17, expnt(s) = [6.3698944]
bas 18, expnt(s) = [8.60246385]
bas 19, expnt(s) = [0.49271692]
CPU time:       520.32
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47746452e-01 8.87198108e-01 6.47972160e-01 1.82466140e+00
 1.17616814e+05 1.60460109e+04 2.75780208e+00 5.40676315e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314029e+03 1.99593897e+03 1.83757988e+04 3.98749080e+03
 1.44909269e+03 5.93385800e+02 3.76239565e+02 2.15830776e+02
 1.15038595e+02 8.87457781e+01 4.04831418e+01 4.05481161e+01
 1.30019106e+01 1.72989764e+01 6.36989440e+00 1.01301109e+01
 8.60246385e+00 4.29796587e+01 4.92716921e-01 1.20429044e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335974580210404
cond(S) = 908494.2821432593
E1 = -689.5772121571051  E_coul = 184.96018371107235
init E= -504.617028446033
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672240295230584  LUMO = 0.673330891173067
  mo_energy =
[-1.21708155e+02 -1.33868678e+01 -7.62440322e+00 -7.62440322e+00
 -7.62440322e+00 -1.65747871e+00 -6.72240295e-01 -6.72240295e-01
 -6.72240295e-01  6.73330891e-01  8.07430270e+00  3.86177616e+01
  1.60137272e+02  6.61966399e+02  2.80226740e+03  1.22755959e+04
  4.08927334e+04  1.04933984e+05  2.30115939e+05  4.55929861e+05
  8.44881373e+05  1.52805793e+06  2.85032447e+06  5.80821066e+06]
E1 = -707.7285028128415  E_coul = 199.76414736911326
cycle= 1 E= -507.964355443728  delta_E= -3.35  |g|= 0.451  |ddm|=  0.5
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.688002
diis-c [-0.47334676  1.        ]
  HOMO = -0.217779215675904  LUMO = 1.05550211099555
  mo_energy =
[-1.20199624e+02 -1.23057516e+01 -6.59532479e+00 -6.59532479e+00
 -6.59532479e+00 -1.16333844e+00 -2.17779216e-01 -2.17779216e-01
 -2.17779216e-01  1.05550211e+00  8.85027080e+00  3.97416618e+01
  1.61542995e+02  6.63456862e+02  2.80369851e+03  1.22769181e+04
  4.08939888e+04  1.04935202e+05  2.30117134e+05  4.55931039e+05
  8.44882537e+05  1.52805909e+06  2.85032561e+06  5.80821180e+06]
E1 = -706.7836256121076  E_coul = 198.80165585401195
cycle= 2 E= -507.981969758096  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.425
    CPU time for cycle= 2      0.10 sec, wall time      0.03 sec
diis-norm(errvec)=0.0299583
diis-c [-8.95529114e-04 -2.04584616e-03  1.00204585e+00]
  HOMO = -0.239717376200425  LUMO = 1.05010220463186
  mo_energy =
[-1.20313420e+02 -1.23727236e+01 -6.66950444e+00 -6.66950444e+00
 -6.66950444e+00 -1.17744717e+00 -2.39717376e-01 -2.39717376e-01
 -2.39717376e-01  1.05010220e+00  8.81042783e+00  3.96715816e+01
  1.61445829e+02  6.63339271e+02  2.80356478e+03  1.22767741e+04
  4.08938411e+04  1.04935053e+05  2.30116984e+05  4.55930888e+05
  8.44882386e+05  1.52805893e+06  2.85032546e+06  5.80821164e+06]
E1 = -706.6771357485089  E_coul = 198.69491100325388
cycle= 3 E= -507.982224745255  delta_E= -0.000255  |g|= 0.0043  |ddm|= 0.0598
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00321715
diis-c [-2.33806426e-06  7.64010196e-05 -1.04642565e-01  1.10456616e+00]
  HOMO = -0.242796965478173  LUMO = 1.04911116011235
  mo_energy =
[-1.20325052e+02 -1.23811648e+01 -6.67842933e+00 -6.67842933e+00
 -6.67842933e+00 -1.17930899e+00 -2.42796965e-01 -2.42796965e-01
 -2.42796965e-01  1.04911116e+00  8.80486314e+00  3.96630715e+01
  1.61435293e+02  6.63327500e+02  2.80355220e+03  1.22767610e+04
  4.08938279e+04  1.04935040e+05  2.30116970e+05  4.55930875e+05
  8.44882373e+05  1.52805892e+06  2.85032545e+06  5.80821163e+06]
E1 = -706.6623338033639  E_coul = 198.6801044168469
cycle= 4 E= -507.982229386517  delta_E= -4.64e-06  |g|= 0.000207  |ddm|= 0.00933
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000145687
diis-c [-1.53499131e-10 -7.25727089e-06  6.78607298e-03 -9.80567077e-02
  1.09127789e+00]
  HOMO = -0.242936368630087  LUMO = 1.04905919811383
  mo_energy =
[-1.20325399e+02 -1.23814982e+01 -6.67876020e+00 -6.67876020e+00
 -6.67876020e+00 -1.17939243e+00 -2.42936369e-01 -2.42936369e-01
 -2.42936369e-01  1.04905920e+00  8.80461634e+00  3.96627518e+01
  1.61434952e+02  6.63327152e+02  2.80355184e+03  1.22767607e+04
  4.08938275e+04  1.04935040e+05  2.30116970e+05  4.55930874e+05
  8.44882373e+05  1.52805892e+06  2.85032545e+06  5.80821163e+06]
E1 = -706.6616721198887  E_coul = 198.67944272305846
cycle= 5 E= -507.98222939683  delta_E= -1.03e-08  |g|= 1.81e-06  |ddm|= 0.000486
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.89693e-07
diis-c [-1.65669601e-13  3.12208580e-07 -2.38917515e-04  3.21927726e-03
 -3.79726677e-02  1.03499200e+00]
  HOMO = -0.242937354922592  LUMO = 1.04905896615983
  mo_energy =
[-1.20325402e+02 -1.23815004e+01 -6.67876247e+00 -6.67876247e+00
 -6.67876247e+00 -1.17939317e+00 -2.42937355e-01 -2.42937355e-01
 -2.42937355e-01  1.04905897e+00  8.80461464e+00  3.96627496e+01
  1.61434949e+02  6.63327149e+02  2.80355184e+03  1.22767607e+04
  4.08938275e+04  1.04935040e+05  2.30116970e+05  4.55930874e+05
  8.44882373e+05  1.52805892e+06  2.85032545e+06  5.80821163e+06]
E1 = -706.6616671457597  E_coul = 198.67943774892908
cycle= 6 E= -507.982229396831  delta_E= -2.84e-13  |g|= 5.68e-08  |ddm|= 4.12e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6616671457597  E_coul = 198.67943774892908
  HOMO = -0.242937383036932  LUMO = 1.04905894994971
  mo_energy =
[-1.20325402e+02 -1.23815005e+01 -6.67876253e+00 -6.67876253e+00
 -6.67876253e+00 -1.17939318e+00 -2.42937383e-01 -2.42937383e-01
 -2.42937383e-01  1.04905895e+00  8.80461459e+00  3.96627496e+01
  1.61434949e+02  6.63327149e+02  2.80355184e+03  1.22767607e+04
  4.08938275e+04  1.04935040e+05  2.30116970e+05  4.55930874e+05
  8.44882373e+05  1.52805892e+06  2.85032545e+06  5.80821163e+06]
E1 = -706.6616670172068  E_coul = 198.67943762037598
Extra cycle  E= -507.982229396831  delta_E= -2.27e-13  |g|= 6.7e-09  |ddm|= 1.13e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.47746452e-01 6.47972160e-01 1.17616814e+05 2.75780208e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314029e+03 1.83757988e+04
 1.44909269e+03 3.76239565e+02 1.15038595e+02 4.04831418e+01
 1.30019106e+01 6.36989440e+00 8.60246385e+00 4.92716921e-01]
E = -507.9822293968308
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:11:05 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247746452132       1
[INPUT] 0    0    [1    /1   ]  0.647972160337       1
[INPUT] 0    0    [1    /1   ]  117616.813851        1
[INPUT] 0    0    [1    /1   ]  2.75780207682        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991909        1
[INPUT] 0    0    [1    /1   ]  73510.4199799        1
[INPUT] 0    0    [1    /1   ]  36754.7147073        1
[INPUT] 0    0    [1    /1   ]  7303.14028773        1
[INPUT] 0    0    [1    /1   ]  18375.7987742        1
[INPUT] 0    0    [1    /1   ]  1449.09269368        1
[INPUT] 0    0    [1    /1   ]  376.239565089        1
[INPUT] 0    0    [1    /1   ]  115.038595186        1
[INPUT] 0    0    [1    /1   ]  40.4831417856        1
[INPUT] 0    0    [1    /1   ]  13.0019106486        1
[INPUT] 0    0    [1    /1   ]  6.36989440381        1
[INPUT] 1    0    [1    /1   ]  8.60246384794        1
[INPUT] 1    0    [1    /1   ]  0.492716921296       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24774645213210184, 1.0]], [0, [0.6479721603371, 1.0]], [0, [117616.81385089368, 1.0]], [0, [2.757802076824426, 1.0]], [0, [1176168.1426171607, 1.0]], [0, [588084.0699820434, 1.0]], [0, [294042.0310710591, 1.0]], [0, [147020.99190929337, 1.0]], [0, [73510.41997990158, 1.0]], [0, [36754.71470732386, 1.0]], [0, [7303.140287727296, 1.0]], [0, [18375.798774224528, 1.0]], [0, [1449.0926936750282, 1.0]], [0, [376.23956508852416, 1.0]], [0, [115.03859518649992, 1.0]], [0, [40.483141785646936, 1.0]], [0, [13.001910648555159, 1.0]], [0, [6.369894403813668, 1.0]], [1, [8.602463847938902, 1.0]], [1, [0.49271692129572364, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24774645]
bas 1, expnt(s) = [0.64797216]
bas 2, expnt(s) = [117616.81385089]
bas 3, expnt(s) = [2.75780208]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998204]
bas 6, expnt(s) = [294042.03107106]
bas 7, expnt(s) = [147020.99190929]
bas 8, expnt(s) = [73510.4199799]
bas 9, expnt(s) = [36754.71470732]
bas 10, expnt(s) = [7303.14028773]
bas 11, expnt(s) = [18375.79877422]
bas 12, expnt(s) = [1449.09269368]
bas 13, expnt(s) = [376.23956509]
bas 14, expnt(s) = [115.03859519]
bas 15, expnt(s) = [40.48314179]
bas 16, expnt(s) = [13.00191065]
bas 17, expnt(s) = [6.3698944]
bas 18, expnt(s) = [8.60246385]
bas 19, expnt(s) = [0.49271692]
CPU time:       521.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47746452e-01 8.87198108e-01 6.47972160e-01 1.82466140e+00
 1.17616814e+05 1.60460109e+04 2.75780208e+00 5.40676315e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314029e+03 1.99593897e+03 1.83757988e+04 3.98749080e+03
 1.44909269e+03 5.93385800e+02 3.76239565e+02 2.15830776e+02
 1.15038595e+02 8.87457781e+01 4.04831418e+01 4.05481161e+01
 1.30019106e+01 1.72989764e+01 6.36989440e+00 1.01301109e+01
 8.60246385e+00 4.29796587e+01 4.92716921e-01 1.20429044e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335974580210404
cond(S) = 908494.2821432593
E1 = -689.5772121571051  E_coul = 184.96018371107235
init E= -504.617028446033
    CPU time for initialize scf      0.42 sec, wall time      0.06 sec
  HOMO = -0.672240295230584  LUMO = 0.673330891173067
  mo_energy =
[-1.21708155e+02 -1.33868678e+01 -7.62440322e+00 -7.62440322e+00
 -7.62440322e+00 -1.65747871e+00 -6.72240295e-01 -6.72240295e-01
 -6.72240295e-01  6.73330891e-01  8.07430270e+00  3.86177616e+01
  1.60137272e+02  6.61966399e+02  2.80226740e+03  1.22755959e+04
  4.08927334e+04  1.04933984e+05  2.30115939e+05  4.55929861e+05
  8.44881373e+05  1.52805793e+06  2.85032447e+06  5.80821066e+06]
E1 = -707.7285028128415  E_coul = 199.76414736911326
cycle= 1 E= -507.964355443728  delta_E= -3.35  |g|= 0.451  |ddm|=  0.5
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.688002
diis-c [-0.47334676  1.        ]
  HOMO = -0.217779215675904  LUMO = 1.05550211099555
  mo_energy =
[-1.20199624e+02 -1.23057516e+01 -6.59532479e+00 -6.59532479e+00
 -6.59532479e+00 -1.16333844e+00 -2.17779216e-01 -2.17779216e-01
 -2.17779216e-01  1.05550211e+00  8.85027080e+00  3.97416618e+01
  1.61542995e+02  6.63456862e+02  2.80369851e+03  1.22769181e+04
  4.08939888e+04  1.04935202e+05  2.30117134e+05  4.55931039e+05
  8.44882537e+05  1.52805909e+06  2.85032561e+06  5.80821180e+06]
E1 = -706.7836256121076  E_coul = 198.80165585401195
cycle= 2 E= -507.981969758096  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.425
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0299583
diis-c [-8.95529114e-04 -2.04584616e-03  1.00204585e+00]
  HOMO = -0.239717376200425  LUMO = 1.05010220463186
  mo_energy =
[-1.20313420e+02 -1.23727236e+01 -6.66950444e+00 -6.66950444e+00
 -6.66950444e+00 -1.17744717e+00 -2.39717376e-01 -2.39717376e-01
 -2.39717376e-01  1.05010220e+00  8.81042783e+00  3.96715816e+01
  1.61445829e+02  6.63339271e+02  2.80356478e+03  1.22767741e+04
  4.08938411e+04  1.04935053e+05  2.30116984e+05  4.55930888e+05
  8.44882386e+05  1.52805893e+06  2.85032546e+06  5.80821164e+06]
E1 = -706.6771357485089  E_coul = 198.69491100325388
cycle= 3 E= -507.982224745255  delta_E= -0.000255  |g|= 0.0043  |ddm|= 0.0598
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00321715
diis-c [-2.33806426e-06  7.64010196e-05 -1.04642565e-01  1.10456616e+00]
  HOMO = -0.242796965478173  LUMO = 1.04911116011235
  mo_energy =
[-1.20325052e+02 -1.23811648e+01 -6.67842933e+00 -6.67842933e+00
 -6.67842933e+00 -1.17930899e+00 -2.42796965e-01 -2.42796965e-01
 -2.42796965e-01  1.04911116e+00  8.80486314e+00  3.96630715e+01
  1.61435293e+02  6.63327500e+02  2.80355220e+03  1.22767610e+04
  4.08938279e+04  1.04935040e+05  2.30116970e+05  4.55930875e+05
  8.44882373e+05  1.52805892e+06  2.85032545e+06  5.80821163e+06]
E1 = -706.6623338033639  E_coul = 198.6801044168469
cycle= 4 E= -507.982229386517  delta_E= -4.64e-06  |g|= 0.000207  |ddm|= 0.00933
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000145687
diis-c [-1.53499131e-10 -7.25727089e-06  6.78607298e-03 -9.80567077e-02
  1.09127789e+00]
  HOMO = -0.242936368630087  LUMO = 1.04905919811383
  mo_energy =
[-1.20325399e+02 -1.23814982e+01 -6.67876020e+00 -6.67876020e+00
 -6.67876020e+00 -1.17939243e+00 -2.42936369e-01 -2.42936369e-01
 -2.42936369e-01  1.04905920e+00  8.80461634e+00  3.96627518e+01
  1.61434952e+02  6.63327152e+02  2.80355184e+03  1.22767607e+04
  4.08938275e+04  1.04935040e+05  2.30116970e+05  4.55930874e+05
  8.44882373e+05  1.52805892e+06  2.85032545e+06  5.80821163e+06]
E1 = -706.6616721198887  E_coul = 198.67944272305846
cycle= 5 E= -507.98222939683  delta_E= -1.03e-08  |g|= 1.81e-06  |ddm|= 0.000486
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.89693e-07
diis-c [-1.65669601e-13  3.12208580e-07 -2.38917515e-04  3.21927726e-03
 -3.79726677e-02  1.03499200e+00]
  HOMO = -0.242937354922592  LUMO = 1.04905896615983
  mo_energy =
[-1.20325402e+02 -1.23815004e+01 -6.67876247e+00 -6.67876247e+00
 -6.67876247e+00 -1.17939317e+00 -2.42937355e-01 -2.42937355e-01
 -2.42937355e-01  1.04905897e+00  8.80461464e+00  3.96627496e+01
  1.61434949e+02  6.63327149e+02  2.80355184e+03  1.22767607e+04
  4.08938275e+04  1.04935040e+05  2.30116970e+05  4.55930874e+05
  8.44882373e+05  1.52805892e+06  2.85032545e+06  5.80821163e+06]
E1 = -706.6616671457597  E_coul = 198.67943774892908
cycle= 6 E= -507.982229396831  delta_E= -2.84e-13  |g|= 5.68e-08  |ddm|= 4.12e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6616671457597  E_coul = 198.67943774892908
  HOMO = -0.242937383036932  LUMO = 1.04905894994971
  mo_energy =
[-1.20325402e+02 -1.23815005e+01 -6.67876253e+00 -6.67876253e+00
 -6.67876253e+00 -1.17939318e+00 -2.42937383e-01 -2.42937383e-01
 -2.42937383e-01  1.04905895e+00  8.80461459e+00  3.96627496e+01
  1.61434949e+02  6.63327149e+02  2.80355184e+03  1.22767607e+04
  4.08938275e+04  1.04935040e+05  2.30116970e+05  4.55930874e+05
  8.44882373e+05  1.52805892e+06  2.85032545e+06  5.80821163e+06]
E1 = -706.6616670172068  E_coul = 198.67943762037598
Extra cycle  E= -507.982229396831  delta_E= -2.27e-13  |g|= 6.7e-09  |ddm|= 1.13e-07
    CPU time for scf_cycle      1.11 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908494.2821432593
E1 = -706.6616670172068  E_coul = 198.67943762037598
init E= -507.982229396831
    CPU time for initialize scf      3.40 sec, wall time      0.22 sec
  HOMO = -0.242937386993203  LUMO = 1.04905894667336
  mo_energy =
[-1.20325402e+02 -1.23815005e+01 -6.67876254e+00 -6.67876254e+00
 -6.67876254e+00 -1.17939318e+00 -2.42937387e-01 -2.42937387e-01
 -2.42937387e-01  1.04905895e+00  8.80461458e+00  3.96627496e+01
  1.61434949e+02  6.63327149e+02  2.80355184e+03  1.22767607e+04
  4.08938275e+04  1.04935040e+05  2.30116970e+05  4.55930874e+05
  8.44882373e+05  1.52805892e+06  2.85032545e+06  5.80821163e+06]
E1 = -706.6616670009231  E_coul = 198.67943760409204
cycle= 1 E= -507.982229396831  delta_E= -2.27e-13  |g|= 1.89e-09  |ddm|= 1.26e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6616670009231  E_coul = 198.67943760409204
  HOMO = -0.242937387476123  LUMO = 1.04905894873672
  mo_energy =
[-1.20325402e+02 -1.23815005e+01 -6.67876254e+00 -6.67876254e+00
 -6.67876254e+00 -1.17939318e+00 -2.42937387e-01 -2.42937387e-01
 -2.42937387e-01  1.04905895e+00  8.80461458e+00  3.96627495e+01
  1.61434949e+02  6.63327149e+02  2.80355184e+03  1.22767607e+04
  4.08938275e+04  1.04935040e+05  2.30116970e+05  4.55930874e+05
  8.44882373e+05  1.52805892e+06  2.85032545e+06  5.80821163e+06]
E1 = -706.6616669958627  E_coul = 198.67943759903167
Extra cycle  E= -507.982229396831  delta_E=    0  |g|= 1.33e-09  |ddm|= 3.43e-09
    CPU time for scf_cycle      3.85 sec, wall time      0.39 sec
exp = [2.47746452e-01 6.47972160e-01 1.17616814e+05 2.75780208e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314029e+03 1.83757988e+04
 1.44909269e+03 3.76239565e+02 1.15038595e+02 4.04831418e+01
 1.30019106e+01 6.36989440e+00 8.60246385e+00 4.92716921e-01]
grad_E = [ 3.64573922e-03 -7.51173467e-04  4.49850814e-09  4.25321688e-04
  2.25039357e-11  1.23048746e-10  6.99616239e-10  2.74729628e-09
  1.14256436e-08  6.10842404e-08  3.86813212e-06  1.35030605e-07
 -8.33706053e-06  1.34691781e-04 -7.65230924e-04 -2.01659462e-04
 -7.61399159e-05  1.10498761e-04 -1.44285903e-03  1.82400143e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:11:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.245385048783       1
[INPUT] 0    0    [1    /1   ]  0.641380262916       1
[INPUT] 0    0    [1    /1   ]  117616.813851        1
[INPUT] 0    0    [1    /1   ]  2.76191365361        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991909        1
[INPUT] 0    0    [1    /1   ]  73510.4199796        1
[INPUT] 0    0    [1    /1   ]  36754.7147058        1
[INPUT] 0    0    [1    /1   ]  7303.14019427        1
[INPUT] 0    0    [1    /1   ]  18375.798771         1
[INPUT] 0    0    [1    /1   ]  1449.09272231        1
[INPUT] 0    0    [1    /1   ]  376.239060764        1
[INPUT] 0    0    [1    /1   ]  115.039039973        1
[INPUT] 0    0    [1    /1   ]  40.5055273302        1
[INPUT] 0    0    [1    /1   ]  13.0335492177        1
[INPUT] 0    0    [1    /1   ]  6.38626332215        1
[INPUT] 1    0    [1    /1   ]  8.60383563366        1
[INPUT] 1    0    [1    /1   ]  0.492719277651       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24538504878295336, 1.0]], [0, [0.6413802629162362, 1.0]], [0, [117616.81385078476, 1.0]], [0, [2.7619136536137976, 1.0]], [0, [1176168.1426171602, 1.0]], [0, [588084.0699820404, 1.0]], [0, [294042.0310710422, 1.0]], [0, [147020.99190922687, 1.0]], [0, [73510.41997962516, 1.0]], [0, [36754.71470584252, 1.0]], [0, [7303.140194267337, 1.0]], [0, [18375.798770985282, 1.0]], [0, [1449.092722312551, 1.0]], [0, [376.239060764294, 1.0]], [0, [115.03903997279984, 1.0]], [0, [40.50552733024521, 1.0]], [0, [13.03354921768968, 1.0]], [0, [6.386263322154235, 1.0]], [1, [8.603835633662714, 1.0]], [1, [0.4927192776510792, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24538505]
bas 1, expnt(s) = [0.64138026]
bas 2, expnt(s) = [117616.81385078]
bas 3, expnt(s) = [2.76191365]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998204]
bas 6, expnt(s) = [294042.03107104]
bas 7, expnt(s) = [147020.99190923]
bas 8, expnt(s) = [73510.41997963]
bas 9, expnt(s) = [36754.71470584]
bas 10, expnt(s) = [7303.14019427]
bas 11, expnt(s) = [18375.79877099]
bas 12, expnt(s) = [1449.09272231]
bas 13, expnt(s) = [376.23906076]
bas 14, expnt(s) = [115.03903997]
bas 15, expnt(s) = [40.50552733]
bas 16, expnt(s) = [13.03354922]
bas 17, expnt(s) = [6.38626332]
bas 18, expnt(s) = [8.60383563]
bas 19, expnt(s) = [0.49271928]
CPU time:       533.46
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.45385049e-01 8.80848254e-01 6.41380263e-01 1.81072175e+00
 1.17616814e+05 1.60460109e+04 2.76191365e+00 5.41280768e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314019e+03 1.99593895e+03 1.83757988e+04 3.98749080e+03
 1.44909272e+03 5.93385809e+02 3.76239061e+02 2.15830559e+02
 1.15039040e+02 8.87460354e+01 4.05055273e+01 4.05649310e+01
 1.30335492e+01 1.73305381e+01 6.38626332e+00 1.01496284e+01
 8.60383563e+00 4.29882261e+01 4.92719278e-01 1.20429764e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33598794200846
cond(S) = 908496.7038084649
E1 = -689.5827223452818  E_coul = 184.9659947766813
init E= -504.6167275686
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.67226746346213  LUMO = 0.660164312393321
  mo_energy =
[-1.21706890e+02 -1.33864094e+01 -7.62399240e+00 -7.62399240e+00
 -7.62399240e+00 -1.65743890e+00 -6.72267463e-01 -6.72267463e-01
 -6.72267463e-01  6.60164312e-01  8.05201956e+00  3.86859183e+01
  1.60343550e+02  6.62222537e+02  2.80250683e+03  1.22758071e+04
  4.08929292e+04  1.04934171e+05  2.30116122e+05  4.55930040e+05
  8.44881549e+05  1.52805811e+06  2.85032464e+06  5.80821083e+06]
E1 = -707.7339565438198  E_coul = 199.76959315082243
cycle= 1 E= -507.964363392997  delta_E= -3.35  |g|= 0.451  |ddm|= 0.501
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.688297
diis-c [-0.47375233  1.        ]
  HOMO = -0.21779152889248  LUMO = 1.04017366919903
  mo_energy =
[-1.20198415e+02 -1.23053417e+01 -6.59495270e+00 -6.59495270e+00
 -6.59495270e+00 -1.16331354e+00 -2.17791529e-01 -2.17791529e-01
 -2.17791529e-01  1.04017367e+00  8.82860959e+00  3.98106014e+01
  1.61749363e+02  6.63712936e+02  2.80393785e+03  1.22771292e+04
  4.08941845e+04  1.04935390e+05  2.30117316e+05  4.55931217e+05
  8.44882713e+05  1.52805926e+06  2.85032578e+06  5.80821196e+06]
E1 = -706.7890905418046  E_coul = 198.80711631264484
cycle= 2 E= -507.98197422916  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.426
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0300198
diis-c [-8.99121243e-04 -2.09434952e-03  1.00209435e+00]
  HOMO = -0.239747961940153  LUMO = 1.03485525000561
  mo_energy =
[-1.20312191e+02 -1.23723067e+01 -6.66912459e+00 -6.66912459e+00
 -6.66912459e+00 -1.17743705e+00 -2.39747962e-01 -2.39747962e-01
 -2.39747962e-01  1.03485525e+00  8.78876444e+00  3.97404665e+01
  1.61652198e+02  6.63595367e+02  2.80380415e+03  1.22769852e+04
  4.08940368e+04  1.04935241e+05  2.30117166e+05  4.55931067e+05
  8.44882562e+05  1.52805911e+06  2.85032563e+06  5.80821181e+06]
E1 = -706.6822538201174  E_coul = 198.7000229485994
cycle= 3 E= -507.982230871518  delta_E= -0.000257  |g|= 0.00431  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00323216
diis-c [-2.35663343e-06  7.30239394e-05 -1.04964087e-01  1.10489106e+00]
  HOMO = -0.24284293941644  LUMO = 1.03387153038332
  mo_energy =
[-1.20323851e+02 -1.23807741e+01 -6.67807569e+00 -6.67807569e+00
 -6.67807569e+00 -1.17930892e+00 -2.42842939e-01 -2.42842939e-01
 -2.42842939e-01  1.03387153e+00  8.78317660e+00  3.97319251e+01
  1.61641633e+02  6.63583568e+02  2.80379154e+03  1.22769721e+04
  4.08940235e+04  1.04935227e+05  2.30117153e+05  4.55931053e+05
  8.44882549e+05  1.52805909e+06  2.85032562e+06  5.80821180e+06]
E1 = -706.6673422237815  E_coul = 198.68510664083038
cycle= 4 E= -507.982235582951  delta_E= -4.71e-06  |g|= 0.000209  |ddm|= 0.00941
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00014695
diis-c [-1.59701972e-10 -7.31418033e-06  6.81768093e-03 -9.84128254e-02
  1.09160246e+00]
  HOMO = -0.242984051592707  LUMO = 1.03381948851077
  mo_energy =
[-1.20324201e+02 -1.23811107e+01 -6.67840976e+00 -6.67840976e+00
 -6.67840976e+00 -1.17939341e+00 -2.42984052e-01 -2.42984052e-01
 -2.42984052e-01  1.03381949e+00  8.78292695e+00  3.97316022e+01
  1.61641289e+02  6.63583217e+02  2.80379118e+03  1.22769718e+04
  4.08940232e+04  1.04935227e+05  2.30117152e+05  4.55931053e+05
  8.44882548e+05  1.52805909e+06  2.85032562e+06  5.80821180e+06]
E1 = -706.6666705053061  E_coul = 198.68443491172354
cycle= 5 E= -507.982235593583  delta_E= -1.06e-08  |g|= 1.87e-06  |ddm|= 0.000494
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.21518e-07
diis-c [-1.74726641e-13  3.15805713e-07 -2.47152845e-04  3.33104742e-03
 -3.92009173e-02  1.03611671e+00]
  HOMO = -0.24298507297966  LUMO = 1.03381924808327
  mo_energy =
[-1.20324204e+02 -1.23811130e+01 -6.67841211e+00 -6.67841211e+00
 -6.67841211e+00 -1.17939417e+00 -2.42985073e-01 -2.42985073e-01
 -2.42985073e-01  1.03381925e+00  8.78292519e+00  3.97315999e+01
  1.61641286e+02  6.63583214e+02  2.80379118e+03  1.22769718e+04
  4.08940232e+04  1.04935227e+05  2.30117152e+05  4.55931053e+05
  8.44882548e+05  1.52805909e+06  2.85032562e+06  5.80821180e+06]
E1 = -706.6666653308023  E_coul = 198.6844297372187
cycle= 6 E= -507.982235593584  delta_E= -1.02e-12  |g|= 5.79e-08  |ddm|= 4.27e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6666653308023  E_coul = 198.6844297372187
  HOMO = -0.242985101262295  LUMO = 1.03381923201154
  mo_energy =
[-1.20324204e+02 -1.23811131e+01 -6.67841217e+00 -6.67841217e+00
 -6.67841217e+00 -1.17939419e+00 -2.42985101e-01 -2.42985101e-01
 -2.42985101e-01  1.03381923e+00  8.78292514e+00  3.97315998e+01
  1.61641286e+02  6.63583214e+02  2.80379118e+03  1.22769718e+04
  4.08940232e+04  1.04935227e+05  2.30117152e+05  4.55931053e+05
  8.44882548e+05  1.52805909e+06  2.85032562e+06  5.80821180e+06]
E1 = -706.6666652015847  E_coul = 198.68442960800124
Extra cycle  E= -507.982235593583  delta_E= 1.14e-13  |g|= 7.77e-09  |ddm|= 1.14e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.45385049e-01 6.41380263e-01 1.17616814e+05 2.76191365e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314019e+03 1.83757988e+04
 1.44909272e+03 3.76239061e+02 1.15039040e+02 4.05055273e+01
 1.30335492e+01 6.38626332e+00 8.60383563e+00 4.92719278e-01]
E = -507.9822355935835
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:11:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.245385048783       1
[INPUT] 0    0    [1    /1   ]  0.641380262916       1
[INPUT] 0    0    [1    /1   ]  117616.813851        1
[INPUT] 0    0    [1    /1   ]  2.76191365361        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991909        1
[INPUT] 0    0    [1    /1   ]  73510.4199796        1
[INPUT] 0    0    [1    /1   ]  36754.7147058        1
[INPUT] 0    0    [1    /1   ]  7303.14019427        1
[INPUT] 0    0    [1    /1   ]  18375.798771         1
[INPUT] 0    0    [1    /1   ]  1449.09272231        1
[INPUT] 0    0    [1    /1   ]  376.239060764        1
[INPUT] 0    0    [1    /1   ]  115.039039973        1
[INPUT] 0    0    [1    /1   ]  40.5055273302        1
[INPUT] 0    0    [1    /1   ]  13.0335492177        1
[INPUT] 0    0    [1    /1   ]  6.38626332215        1
[INPUT] 1    0    [1    /1   ]  8.60383563366        1
[INPUT] 1    0    [1    /1   ]  0.492719277651       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24538504878295336, 1.0]], [0, [0.6413802629162362, 1.0]], [0, [117616.81385078476, 1.0]], [0, [2.7619136536137976, 1.0]], [0, [1176168.1426171602, 1.0]], [0, [588084.0699820404, 1.0]], [0, [294042.0310710422, 1.0]], [0, [147020.99190922687, 1.0]], [0, [73510.41997962516, 1.0]], [0, [36754.71470584252, 1.0]], [0, [7303.140194267337, 1.0]], [0, [18375.798770985282, 1.0]], [0, [1449.092722312551, 1.0]], [0, [376.239060764294, 1.0]], [0, [115.03903997279984, 1.0]], [0, [40.50552733024521, 1.0]], [0, [13.03354921768968, 1.0]], [0, [6.386263322154235, 1.0]], [1, [8.603835633662714, 1.0]], [1, [0.4927192776510792, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24538505]
bas 1, expnt(s) = [0.64138026]
bas 2, expnt(s) = [117616.81385078]
bas 3, expnt(s) = [2.76191365]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998204]
bas 6, expnt(s) = [294042.03107104]
bas 7, expnt(s) = [147020.99190923]
bas 8, expnt(s) = [73510.41997963]
bas 9, expnt(s) = [36754.71470584]
bas 10, expnt(s) = [7303.14019427]
bas 11, expnt(s) = [18375.79877099]
bas 12, expnt(s) = [1449.09272231]
bas 13, expnt(s) = [376.23906076]
bas 14, expnt(s) = [115.03903997]
bas 15, expnt(s) = [40.50552733]
bas 16, expnt(s) = [13.03354922]
bas 17, expnt(s) = [6.38626332]
bas 18, expnt(s) = [8.60383563]
bas 19, expnt(s) = [0.49271928]
CPU time:       534.83
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.45385049e-01 8.80848254e-01 6.41380263e-01 1.81072175e+00
 1.17616814e+05 1.60460109e+04 2.76191365e+00 5.41280768e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314019e+03 1.99593895e+03 1.83757988e+04 3.98749080e+03
 1.44909272e+03 5.93385809e+02 3.76239061e+02 2.15830559e+02
 1.15039040e+02 8.87460354e+01 4.05055273e+01 4.05649310e+01
 1.30335492e+01 1.73305381e+01 6.38626332e+00 1.01496284e+01
 8.60383563e+00 4.29882261e+01 4.92719278e-01 1.20429764e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33598794200846
cond(S) = 908496.7038084649
E1 = -689.5827223452818  E_coul = 184.9659947766813
init E= -504.6167275686
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.67226746346213  LUMO = 0.660164312393321
  mo_energy =
[-1.21706890e+02 -1.33864094e+01 -7.62399240e+00 -7.62399240e+00
 -7.62399240e+00 -1.65743890e+00 -6.72267463e-01 -6.72267463e-01
 -6.72267463e-01  6.60164312e-01  8.05201956e+00  3.86859183e+01
  1.60343550e+02  6.62222537e+02  2.80250683e+03  1.22758071e+04
  4.08929292e+04  1.04934171e+05  2.30116122e+05  4.55930040e+05
  8.44881549e+05  1.52805811e+06  2.85032464e+06  5.80821083e+06]
E1 = -707.7339565438198  E_coul = 199.76959315082243
cycle= 1 E= -507.964363392997  delta_E= -3.35  |g|= 0.451  |ddm|= 0.501
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.688297
diis-c [-0.47375233  1.        ]
  HOMO = -0.21779152889248  LUMO = 1.04017366919903
  mo_energy =
[-1.20198415e+02 -1.23053417e+01 -6.59495270e+00 -6.59495270e+00
 -6.59495270e+00 -1.16331354e+00 -2.17791529e-01 -2.17791529e-01
 -2.17791529e-01  1.04017367e+00  8.82860959e+00  3.98106014e+01
  1.61749363e+02  6.63712936e+02  2.80393785e+03  1.22771292e+04
  4.08941845e+04  1.04935390e+05  2.30117316e+05  4.55931217e+05
  8.44882713e+05  1.52805926e+06  2.85032578e+06  5.80821196e+06]
E1 = -706.7890905418046  E_coul = 198.80711631264484
cycle= 2 E= -507.98197422916  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.426
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0300198
diis-c [-8.99121243e-04 -2.09434952e-03  1.00209435e+00]
  HOMO = -0.239747961940153  LUMO = 1.03485525000561
  mo_energy =
[-1.20312191e+02 -1.23723067e+01 -6.66912459e+00 -6.66912459e+00
 -6.66912459e+00 -1.17743705e+00 -2.39747962e-01 -2.39747962e-01
 -2.39747962e-01  1.03485525e+00  8.78876444e+00  3.97404665e+01
  1.61652198e+02  6.63595367e+02  2.80380415e+03  1.22769852e+04
  4.08940368e+04  1.04935241e+05  2.30117166e+05  4.55931067e+05
  8.44882562e+05  1.52805911e+06  2.85032563e+06  5.80821181e+06]
E1 = -706.6822538201174  E_coul = 198.7000229485994
cycle= 3 E= -507.982230871518  delta_E= -0.000257  |g|= 0.00431  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00323216
diis-c [-2.35663343e-06  7.30239394e-05 -1.04964087e-01  1.10489106e+00]
  HOMO = -0.24284293941644  LUMO = 1.03387153038332
  mo_energy =
[-1.20323851e+02 -1.23807741e+01 -6.67807569e+00 -6.67807569e+00
 -6.67807569e+00 -1.17930892e+00 -2.42842939e-01 -2.42842939e-01
 -2.42842939e-01  1.03387153e+00  8.78317660e+00  3.97319251e+01
  1.61641633e+02  6.63583568e+02  2.80379154e+03  1.22769721e+04
  4.08940235e+04  1.04935227e+05  2.30117153e+05  4.55931053e+05
  8.44882549e+05  1.52805909e+06  2.85032562e+06  5.80821180e+06]
E1 = -706.6673422237815  E_coul = 198.68510664083038
cycle= 4 E= -507.982235582951  delta_E= -4.71e-06  |g|= 0.000209  |ddm|= 0.00941
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00014695
diis-c [-1.59701972e-10 -7.31418033e-06  6.81768093e-03 -9.84128254e-02
  1.09160246e+00]
  HOMO = -0.242984051592707  LUMO = 1.03381948851077
  mo_energy =
[-1.20324201e+02 -1.23811107e+01 -6.67840976e+00 -6.67840976e+00
 -6.67840976e+00 -1.17939341e+00 -2.42984052e-01 -2.42984052e-01
 -2.42984052e-01  1.03381949e+00  8.78292695e+00  3.97316022e+01
  1.61641289e+02  6.63583217e+02  2.80379118e+03  1.22769718e+04
  4.08940232e+04  1.04935227e+05  2.30117152e+05  4.55931053e+05
  8.44882548e+05  1.52805909e+06  2.85032562e+06  5.80821180e+06]
E1 = -706.6666705053061  E_coul = 198.68443491172354
cycle= 5 E= -507.982235593583  delta_E= -1.06e-08  |g|= 1.87e-06  |ddm|= 0.000494
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.21518e-07
diis-c [-1.74726641e-13  3.15805713e-07 -2.47152845e-04  3.33104742e-03
 -3.92009173e-02  1.03611671e+00]
  HOMO = -0.24298507297966  LUMO = 1.03381924808327
  mo_energy =
[-1.20324204e+02 -1.23811130e+01 -6.67841211e+00 -6.67841211e+00
 -6.67841211e+00 -1.17939417e+00 -2.42985073e-01 -2.42985073e-01
 -2.42985073e-01  1.03381925e+00  8.78292519e+00  3.97315999e+01
  1.61641286e+02  6.63583214e+02  2.80379118e+03  1.22769718e+04
  4.08940232e+04  1.04935227e+05  2.30117152e+05  4.55931053e+05
  8.44882548e+05  1.52805909e+06  2.85032562e+06  5.80821180e+06]
E1 = -706.6666653308023  E_coul = 198.6844297372187
cycle= 6 E= -507.982235593584  delta_E= -1.02e-12  |g|= 5.79e-08  |ddm|= 4.27e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6666653308023  E_coul = 198.6844297372187
  HOMO = -0.242985101262295  LUMO = 1.03381923201154
  mo_energy =
[-1.20324204e+02 -1.23811131e+01 -6.67841217e+00 -6.67841217e+00
 -6.67841217e+00 -1.17939419e+00 -2.42985101e-01 -2.42985101e-01
 -2.42985101e-01  1.03381923e+00  8.78292514e+00  3.97315998e+01
  1.61641286e+02  6.63583214e+02  2.80379118e+03  1.22769718e+04
  4.08940232e+04  1.04935227e+05  2.30117152e+05  4.55931053e+05
  8.44882548e+05  1.52805909e+06  2.85032562e+06  5.80821180e+06]
E1 = -706.6666652015847  E_coul = 198.68442960800124
Extra cycle  E= -507.982235593583  delta_E= 1.14e-13  |g|= 7.77e-09  |ddm|= 1.14e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908496.7038084649
E1 = -706.6666652015847  E_coul = 198.68442960800124
init E= -507.982235593583
    CPU time for initialize scf      3.39 sec, wall time      0.22 sec
  HOMO = -0.242985105248581  LUMO = 1.03381923308348
  mo_energy =
[-1.20324204e+02 -1.23811131e+01 -6.67841218e+00 -6.67841218e+00
 -6.67841218e+00 -1.17939419e+00 -2.42985105e-01 -2.42985105e-01
 -2.42985105e-01  1.03381923e+00  8.78292513e+00  3.97315998e+01
  1.61641286e+02  6.63583214e+02  2.80379118e+03  1.22769718e+04
  4.08940232e+04  1.04935227e+05  2.30117152e+05  4.55931053e+05
  8.44882548e+05  1.52805909e+06  2.85032562e+06  5.80821180e+06]
E1 = -706.6666651797417  E_coul = 198.6844295861581
cycle= 1 E= -507.982235593584  delta_E= -1.14e-13  |g|= 1.5e-09  |ddm|= 1.63e-08
    CPU time for cycle= 1      0.29 sec, wall time      0.03 sec
E1 = -706.6666651797417  E_coul = 198.6844295861581
  HOMO = -0.242985105897942  LUMO = 1.0338192341262
  mo_energy =
[-1.20324204e+02 -1.23811131e+01 -6.67841218e+00 -6.67841218e+00
 -6.67841218e+00 -1.17939419e+00 -2.42985106e-01 -2.42985106e-01
 -2.42985106e-01  1.03381923e+00  8.78292513e+00  3.97315998e+01
  1.61641286e+02  6.63583214e+02  2.80379118e+03  1.22769718e+04
  4.08940232e+04  1.04935227e+05  2.30117152e+05  4.55931053e+05
  8.44882548e+05  1.52805909e+06  2.85032562e+06  5.80821180e+06]
E1 = -706.6666651761155  E_coul = 198.68442958253232
Extra cycle  E= -507.982235593583  delta_E= 3.41e-13  |g|= 2.4e-09  |ddm|= 2.57e-09
    CPU time for scf_cycle      3.83 sec, wall time      0.38 sec
exp = [2.45385049e-01 6.41380263e-01 1.17616814e+05 2.76191365e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314019e+03 1.83757988e+04
 1.44909272e+03 3.76239061e+02 1.15039040e+02 4.05055273e+01
 1.30335492e+01 6.38626332e+00 8.60383563e+00 4.92719278e-01]
grad_E = [ 2.85769905e-03 -1.11712003e-03  4.50196255e-09  4.00924398e-04
  2.25446048e-11  1.23161238e-10  7.00149854e-10  2.74943226e-09
  1.14346554e-08  6.11284640e-08  3.87123980e-06  1.35167392e-07
 -8.51232474e-06  1.37231140e-04 -7.79371398e-04 -1.78664285e-04
 -7.83317508e-05  1.27373232e-04 -3.02735702e-04  1.66031478e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:11:19 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.243865533061       1
[INPUT] 0    0    [1    /1   ]  0.639479386896       1
[INPUT] 0    0    [1    /1   ]  117616.813851        1
[INPUT] 0    0    [1    /1   ]  2.76376839394        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991909        1
[INPUT] 0    0    [1    /1   ]  73510.4199795        1
[INPUT] 0    0    [1    /1   ]  36754.7147054        1
[INPUT] 0    0    [1    /1   ]  7303.14016495        1
[INPUT] 0    0    [1    /1   ]  18375.79877          1
[INPUT] 0    0    [1    /1   ]  1449.09279092        1
[INPUT] 0    0    [1    /1   ]  376.238021095        1
[INPUT] 0    0    [1    /1   ]  115.04479512         1
[INPUT] 0    0    [1    /1   ]  40.5024339411        1
[INPUT] 0    0    [1    /1   ]  13.0390874694        1
[INPUT] 0    0    [1    /1   ]  6.39097136311        1
[INPUT] 1    0    [1    /1   ]  8.60490348763        1
[INPUT] 1    0    [1    /1   ]  0.492729784558       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24386553306067058, 1.0]], [0, [0.6394793868959732, 1.0]], [0, [117616.81385075065, 1.0]], [0, [2.7637683939433635, 1.0]], [0, [1176168.14261716, 1.0]], [0, [588084.0699820395, 1.0]], [0, [294042.0310710369, 1.0]], [0, [147020.99190920603, 1.0]], [0, [73510.41997953854, 1.0]], [0, [36754.71470537959, 1.0]], [0, [7303.140164947145, 1.0]], [0, [18375.798769959863, 1.0]], [0, [1449.0927909232512, 1.0]], [0, [376.2380210946752, 1.0]], [0, [115.04479512033437, 1.0]], [0, [40.50243394107415, 1.0]], [0, [13.039087469420128, 1.0]], [0, [6.390971363106731, 1.0]], [1, [8.604903487634456, 1.0]], [1, [0.4927297845581249, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24386553]
bas 1, expnt(s) = [0.63947939]
bas 2, expnt(s) = [117616.81385075]
bas 3, expnt(s) = [2.76376839]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998204]
bas 6, expnt(s) = [294042.03107104]
bas 7, expnt(s) = [147020.99190921]
bas 8, expnt(s) = [73510.41997954]
bas 9, expnt(s) = [36754.71470538]
bas 10, expnt(s) = [7303.14016495]
bas 11, expnt(s) = [18375.79876996]
bas 12, expnt(s) = [1449.09279092]
bas 13, expnt(s) = [376.23802109]
bas 14, expnt(s) = [115.04479512]
bas 15, expnt(s) = [40.50243394]
bas 16, expnt(s) = [13.03908747]
bas 17, expnt(s) = [6.39097136]
bas 18, expnt(s) = [8.60490349]
bas 19, expnt(s) = [0.49272978]
CPU time:       546.54
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43865533e-01 8.76754173e-01 6.39479387e-01 1.80669539e+00
 1.17616814e+05 1.60460109e+04 2.76376839e+00 5.41553365e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314016e+03 1.99593894e+03 1.83757988e+04 3.98749080e+03
 1.44909279e+03 5.93385830e+02 3.76238021e+02 2.15830112e+02
 1.15044795e+02 8.87493652e+01 4.05024339e+01 4.05626076e+01
 1.30390875e+01 1.73360609e+01 6.39097136e+00 1.01552397e+01
 8.60490349e+00 4.29948954e+01 4.92729785e-01 1.20432974e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33598996242261
cond(S) = 908496.982165903
E1 = -689.5882885671341  E_coul = 184.9713349080566
init E= -504.616953659077
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672256999019654  LUMO = 0.653934972298781
  mo_energy =
[-1.21705839e+02 -1.33859889e+01 -7.62361588e+00 -7.62361588e+00
 -7.62361588e+00 -1.65739176e+00 -6.72256999e-01 -6.72256999e-01
 -6.72256999e-01  6.53934972e-01  8.04239736e+00  3.86981145e+01
  1.60374493e+02  6.62261455e+02  2.80254625e+03  1.22758424e+04
  4.08929619e+04  1.04934203e+05  2.30116152e+05  4.55930070e+05
  8.44881579e+05  1.52805813e+06  2.85032467e+06  5.80821085e+06]
E1 = -707.7392728834839  E_coul = 199.7749253652045
cycle= 1 E= -507.964347518279  delta_E= -3.35  |g|= 0.451  |ddm|=  0.5
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.688535
diis-c [-0.47408083  1.        ]
  HOMO = -0.217785887170428  LUMO = 1.03297659687612
  mo_energy =
[-1.20197350e+02 -1.23049292e+01 -6.59457197e+00 -6.59457197e+00
 -6.59457197e+00 -1.16328385e+00 -2.17785887e-01 -2.17785887e-01
 -2.17785887e-01  1.03297660e+00  8.81918544e+00  3.98229874e+01
  1.61780331e+02  6.63751863e+02  2.80397727e+03  1.22771644e+04
  4.08942172e+04  1.04935421e+05  2.30117347e+05  4.55931247e+05
  8.44882743e+05  1.52805929e+06  2.85032581e+06  5.80821199e+06]
E1 = -706.7935586683554  E_coul = 198.81158178655602
cycle= 2 E= -507.981976881799  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.426
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0300833
diis-c [-9.02841924e-04 -2.14214050e-03  1.00214214e+00]
  HOMO = -0.239780191730826  LUMO = 1.02768419018441
  mo_energy =
[-1.20311195e+02 -1.23719553e+01 -6.66880683e+00 -6.66880683e+00
 -6.66880683e+00 -1.17743424e+00 -2.39780192e-01 -2.39780192e-01
 -2.39780192e-01  1.02768419e+00  8.77929071e+00  3.97527769e+01
  1.61683098e+02  6.63634224e+02  2.80384349e+03  1.22770204e+04
  4.08940694e+04  1.04935272e+05  2.30117197e+05  4.55931097e+05
  8.44882592e+05  1.52805914e+06  2.85032566e+06  5.80821184e+06]
E1 = -706.6864590808046  E_coul = 198.70422451087705
cycle= 3 E= -507.982234569928  delta_E= -0.000258  |g|= 0.00432  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324408
diis-c [-2.37050707e-06  7.17008242e-05 -1.05170400e-01  1.10509870e+00]
  HOMO = -0.242885515216059  LUMO = 1.02670212967433
  mo_energy =
[-1.20322874e+02 -1.23804416e+01 -6.67777694e+00 -6.67777694e+00
 -6.67777694e+00 -1.17931271e+00 -2.42885515e-01 -2.42885515e-01
 -2.42885515e-01  1.02670213e+00  8.77368680e+00  3.97442156e+01
  1.61672514e+02  6.63622405e+02  2.80383086e+03  1.22770073e+04
  4.08940562e+04  1.04935259e+05  2.30117183e+05  4.55931083e+05
  8.44882578e+05  1.52805912e+06  2.85032565e+06  5.80821182e+06]
E1 = -706.6714880802773  E_coul = 198.68924876599394
cycle= 4 E= -507.982239314283  delta_E= -4.74e-06  |g|= 0.00021  |ddm|= 0.00943
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00014751
diis-c [-1.62175415e-10 -7.34979637e-06  6.82762107e-03 -9.84425963e-02
  1.09162232e+00]
  HOMO = -0.243027178615806  LUMO = 1.02665009713361
  mo_energy =
[-1.20323225e+02 -1.23807790e+01 -6.67811176e+00 -6.67811176e+00
 -6.67811176e+00 -1.17939754e+00 -2.43027179e-01 -2.43027179e-01
 -2.43027179e-01  1.02665010e+00  8.77343628e+00  3.97438918e+01
  1.61672169e+02  6.63622053e+02  2.80383051e+03  1.22770069e+04
  4.08940558e+04  1.04935258e+05  2.30117183e+05  4.55931083e+05
  8.44882578e+05  1.52805912e+06  2.85032565e+06  5.80821182e+06]
E1 = -706.6708132234957  E_coul = 198.68857389848725
cycle= 5 E= -507.982239325008  delta_E= -1.07e-08  |g|= 1.88e-06  |ddm|= 0.000495
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.35056e-07
diis-c [-1.78064141e-13  3.27320180e-07 -2.50720144e-04  3.37490768e-03
 -3.96897372e-02  1.03656522e+00]
  HOMO = -0.243028210185731  LUMO = 1.02664985768368
  mo_energy =
[-1.20323228e+02 -1.23807813e+01 -6.67811413e+00 -6.67811413e+00
 -6.67811413e+00 -1.17939831e+00 -2.43028210e-01 -2.43028210e-01
 -2.43028210e-01  1.02664986e+00  8.77343450e+00  3.97438895e+01
  1.61672166e+02  6.63622050e+02  2.80383050e+03  1.22770069e+04
  4.08940558e+04  1.04935258e+05  2.30117183e+05  4.55931083e+05
  8.44882578e+05  1.52805912e+06  2.85032565e+06  5.80821182e+06]
E1 = -706.6708079836654  E_coul = 198.68856865865595
cycle= 6 E= -507.982239325009  delta_E= -1.02e-12  |g|= 5.71e-08  |ddm|= 4.31e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6708079836654  E_coul = 198.68856865865595
  HOMO = -0.243028238512671  LUMO = 1.02664984065076
  mo_energy =
[-1.20323228e+02 -1.23807814e+01 -6.67811419e+00 -6.67811419e+00
 -6.67811419e+00 -1.17939832e+00 -2.43028239e-01 -2.43028239e-01
 -2.43028239e-01  1.02664984e+00  8.77343445e+00  3.97438895e+01
  1.61672166e+02  6.63622050e+02  2.80383050e+03  1.22770069e+04
  4.08940558e+04  1.04935258e+05  2.30117183e+05  4.55931083e+05
  8.44882578e+05  1.52805912e+06  2.85032565e+06  5.80821182e+06]
E1 = -706.6708078573871  E_coul = 198.68856853237807
Extra cycle  E= -507.982239325009  delta_E= 4.55e-13  |g|= 7.67e-09  |ddm|= 1.12e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.43865533e-01 6.39479387e-01 1.17616814e+05 2.76376839e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314016e+03 1.83757988e+04
 1.44909279e+03 3.76238021e+02 1.15044795e+02 4.05024339e+01
 1.30390875e+01 6.39097136e+00 8.60490349e+00 4.92729785e-01]
E = -507.982239325009
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:11:20 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.243865533061       1
[INPUT] 0    0    [1    /1   ]  0.639479386896       1
[INPUT] 0    0    [1    /1   ]  117616.813851        1
[INPUT] 0    0    [1    /1   ]  2.76376839394        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991909        1
[INPUT] 0    0    [1    /1   ]  73510.4199795        1
[INPUT] 0    0    [1    /1   ]  36754.7147054        1
[INPUT] 0    0    [1    /1   ]  7303.14016495        1
[INPUT] 0    0    [1    /1   ]  18375.79877          1
[INPUT] 0    0    [1    /1   ]  1449.09279092        1
[INPUT] 0    0    [1    /1   ]  376.238021095        1
[INPUT] 0    0    [1    /1   ]  115.04479512         1
[INPUT] 0    0    [1    /1   ]  40.5024339411        1
[INPUT] 0    0    [1    /1   ]  13.0390874694        1
[INPUT] 0    0    [1    /1   ]  6.39097136311        1
[INPUT] 1    0    [1    /1   ]  8.60490348763        1
[INPUT] 1    0    [1    /1   ]  0.492729784558       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24386553306067058, 1.0]], [0, [0.6394793868959732, 1.0]], [0, [117616.81385075065, 1.0]], [0, [2.7637683939433635, 1.0]], [0, [1176168.14261716, 1.0]], [0, [588084.0699820395, 1.0]], [0, [294042.0310710369, 1.0]], [0, [147020.99190920603, 1.0]], [0, [73510.41997953854, 1.0]], [0, [36754.71470537959, 1.0]], [0, [7303.140164947145, 1.0]], [0, [18375.798769959863, 1.0]], [0, [1449.0927909232512, 1.0]], [0, [376.2380210946752, 1.0]], [0, [115.04479512033437, 1.0]], [0, [40.50243394107415, 1.0]], [0, [13.039087469420128, 1.0]], [0, [6.390971363106731, 1.0]], [1, [8.604903487634456, 1.0]], [1, [0.4927297845581249, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24386553]
bas 1, expnt(s) = [0.63947939]
bas 2, expnt(s) = [117616.81385075]
bas 3, expnt(s) = [2.76376839]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998204]
bas 6, expnt(s) = [294042.03107104]
bas 7, expnt(s) = [147020.99190921]
bas 8, expnt(s) = [73510.41997954]
bas 9, expnt(s) = [36754.71470538]
bas 10, expnt(s) = [7303.14016495]
bas 11, expnt(s) = [18375.79876996]
bas 12, expnt(s) = [1449.09279092]
bas 13, expnt(s) = [376.23802109]
bas 14, expnt(s) = [115.04479512]
bas 15, expnt(s) = [40.50243394]
bas 16, expnt(s) = [13.03908747]
bas 17, expnt(s) = [6.39097136]
bas 18, expnt(s) = [8.60490349]
bas 19, expnt(s) = [0.49272978]
CPU time:       547.91
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43865533e-01 8.76754173e-01 6.39479387e-01 1.80669539e+00
 1.17616814e+05 1.60460109e+04 2.76376839e+00 5.41553365e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314016e+03 1.99593894e+03 1.83757988e+04 3.98749080e+03
 1.44909279e+03 5.93385830e+02 3.76238021e+02 2.15830112e+02
 1.15044795e+02 8.87493652e+01 4.05024339e+01 4.05626076e+01
 1.30390875e+01 1.73360609e+01 6.39097136e+00 1.01552397e+01
 8.60490349e+00 4.29948954e+01 4.92729785e-01 1.20432974e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33598996242261
cond(S) = 908496.982165903
E1 = -689.5882885671341  E_coul = 184.9713349080566
init E= -504.616953659077
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672256999019654  LUMO = 0.653934972298781
  mo_energy =
[-1.21705839e+02 -1.33859889e+01 -7.62361588e+00 -7.62361588e+00
 -7.62361588e+00 -1.65739176e+00 -6.72256999e-01 -6.72256999e-01
 -6.72256999e-01  6.53934972e-01  8.04239736e+00  3.86981145e+01
  1.60374493e+02  6.62261455e+02  2.80254625e+03  1.22758424e+04
  4.08929619e+04  1.04934203e+05  2.30116152e+05  4.55930070e+05
  8.44881579e+05  1.52805813e+06  2.85032467e+06  5.80821085e+06]
E1 = -707.7392728834839  E_coul = 199.7749253652045
cycle= 1 E= -507.964347518279  delta_E= -3.35  |g|= 0.451  |ddm|=  0.5
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.688535
diis-c [-0.47408083  1.        ]
  HOMO = -0.217785887170428  LUMO = 1.03297659687612
  mo_energy =
[-1.20197350e+02 -1.23049292e+01 -6.59457197e+00 -6.59457197e+00
 -6.59457197e+00 -1.16328385e+00 -2.17785887e-01 -2.17785887e-01
 -2.17785887e-01  1.03297660e+00  8.81918544e+00  3.98229874e+01
  1.61780331e+02  6.63751863e+02  2.80397727e+03  1.22771644e+04
  4.08942172e+04  1.04935421e+05  2.30117347e+05  4.55931247e+05
  8.44882743e+05  1.52805929e+06  2.85032581e+06  5.80821199e+06]
E1 = -706.7935586683554  E_coul = 198.81158178655602
cycle= 2 E= -507.981976881799  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.426
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0300833
diis-c [-9.02841924e-04 -2.14214050e-03  1.00214214e+00]
  HOMO = -0.239780191730826  LUMO = 1.02768419018441
  mo_energy =
[-1.20311195e+02 -1.23719553e+01 -6.66880683e+00 -6.66880683e+00
 -6.66880683e+00 -1.17743424e+00 -2.39780192e-01 -2.39780192e-01
 -2.39780192e-01  1.02768419e+00  8.77929071e+00  3.97527769e+01
  1.61683098e+02  6.63634224e+02  2.80384349e+03  1.22770204e+04
  4.08940694e+04  1.04935272e+05  2.30117197e+05  4.55931097e+05
  8.44882592e+05  1.52805914e+06  2.85032566e+06  5.80821184e+06]
E1 = -706.6864590808046  E_coul = 198.70422451087705
cycle= 3 E= -507.982234569928  delta_E= -0.000258  |g|= 0.00432  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324408
diis-c [-2.37050707e-06  7.17008242e-05 -1.05170400e-01  1.10509870e+00]
  HOMO = -0.242885515216059  LUMO = 1.02670212967433
  mo_energy =
[-1.20322874e+02 -1.23804416e+01 -6.67777694e+00 -6.67777694e+00
 -6.67777694e+00 -1.17931271e+00 -2.42885515e-01 -2.42885515e-01
 -2.42885515e-01  1.02670213e+00  8.77368680e+00  3.97442156e+01
  1.61672514e+02  6.63622405e+02  2.80383086e+03  1.22770073e+04
  4.08940562e+04  1.04935259e+05  2.30117183e+05  4.55931083e+05
  8.44882578e+05  1.52805912e+06  2.85032565e+06  5.80821182e+06]
E1 = -706.6714880802773  E_coul = 198.68924876599394
cycle= 4 E= -507.982239314283  delta_E= -4.74e-06  |g|= 0.00021  |ddm|= 0.00943
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00014751
diis-c [-1.62175415e-10 -7.34979637e-06  6.82762107e-03 -9.84425963e-02
  1.09162232e+00]
  HOMO = -0.243027178615806  LUMO = 1.02665009713361
  mo_energy =
[-1.20323225e+02 -1.23807790e+01 -6.67811176e+00 -6.67811176e+00
 -6.67811176e+00 -1.17939754e+00 -2.43027179e-01 -2.43027179e-01
 -2.43027179e-01  1.02665010e+00  8.77343628e+00  3.97438918e+01
  1.61672169e+02  6.63622053e+02  2.80383051e+03  1.22770069e+04
  4.08940558e+04  1.04935258e+05  2.30117183e+05  4.55931083e+05
  8.44882578e+05  1.52805912e+06  2.85032565e+06  5.80821182e+06]
E1 = -706.6708132234957  E_coul = 198.68857389848725
cycle= 5 E= -507.982239325008  delta_E= -1.07e-08  |g|= 1.88e-06  |ddm|= 0.000495
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.35056e-07
diis-c [-1.78064141e-13  3.27320180e-07 -2.50720144e-04  3.37490768e-03
 -3.96897372e-02  1.03656522e+00]
  HOMO = -0.243028210185731  LUMO = 1.02664985768368
  mo_energy =
[-1.20323228e+02 -1.23807813e+01 -6.67811413e+00 -6.67811413e+00
 -6.67811413e+00 -1.17939831e+00 -2.43028210e-01 -2.43028210e-01
 -2.43028210e-01  1.02664986e+00  8.77343450e+00  3.97438895e+01
  1.61672166e+02  6.63622050e+02  2.80383050e+03  1.22770069e+04
  4.08940558e+04  1.04935258e+05  2.30117183e+05  4.55931083e+05
  8.44882578e+05  1.52805912e+06  2.85032565e+06  5.80821182e+06]
E1 = -706.6708079836654  E_coul = 198.68856865865595
cycle= 6 E= -507.982239325009  delta_E= -1.02e-12  |g|= 5.71e-08  |ddm|= 4.31e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6708079836654  E_coul = 198.68856865865595
  HOMO = -0.243028238512671  LUMO = 1.02664984065076
  mo_energy =
[-1.20323228e+02 -1.23807814e+01 -6.67811419e+00 -6.67811419e+00
 -6.67811419e+00 -1.17939832e+00 -2.43028239e-01 -2.43028239e-01
 -2.43028239e-01  1.02664984e+00  8.77343445e+00  3.97438895e+01
  1.61672166e+02  6.63622050e+02  2.80383050e+03  1.22770069e+04
  4.08940558e+04  1.04935258e+05  2.30117183e+05  4.55931083e+05
  8.44882578e+05  1.52805912e+06  2.85032565e+06  5.80821182e+06]
E1 = -706.6708078573871  E_coul = 198.68856853237807
Extra cycle  E= -507.982239325009  delta_E= 4.55e-13  |g|= 7.67e-09  |ddm|= 1.12e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908496.982165903
E1 = -706.6708078573871  E_coul = 198.68856853237807
init E= -507.982239325009
    CPU time for initialize scf      3.31 sec, wall time      0.21 sec
  HOMO = -0.243028242425453  LUMO = 1.02664984141301
  mo_energy =
[-1.20323228e+02 -1.23807814e+01 -6.67811420e+00 -6.67811420e+00
 -6.67811420e+00 -1.17939833e+00 -2.43028242e-01 -2.43028242e-01
 -2.43028242e-01  1.02664984e+00  8.77343444e+00  3.97438895e+01
  1.61672166e+02  6.63622050e+02  2.80383050e+03  1.22770069e+04
  4.08940558e+04  1.04935258e+05  2.30117183e+05  4.55931083e+05
  8.44882578e+05  1.52805912e+06  2.85032565e+06  5.80821182e+06]
E1 = -706.670807836312  E_coul = 198.68856851130235
cycle= 1 E= -507.98223932501  delta_E= -5.68e-13  |g|= 1.82e-09  |ddm|= 1.57e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.670807836312  E_coul = 198.68856851130235
  HOMO = -0.243028243053447  LUMO = 1.02664984149137
  mo_energy =
[-1.20323228e+02 -1.23807814e+01 -6.67811420e+00 -6.67811420e+00
 -6.67811420e+00 -1.17939833e+00 -2.43028243e-01 -2.43028243e-01
 -2.43028243e-01  1.02664984e+00  8.77343444e+00  3.97438895e+01
  1.61672166e+02  6.63622050e+02  2.80383050e+03  1.22770069e+04
  4.08940558e+04  1.04935258e+05  2.30117183e+05  4.55931083e+05
  8.44882578e+05  1.52805912e+06  2.85032565e+06  5.80821182e+06]
E1 = -706.6708078316977  E_coul = 198.68856850668843
Extra cycle  E= -507.982239325009  delta_E= 2.27e-13  |g|= 1.69e-09  |ddm|= 3.03e-09
    CPU time for scf_cycle      3.77 sec, wall time      0.38 sec
exp = [2.43865533e-01 6.39479387e-01 1.17616814e+05 2.76376839e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314016e+03 1.83757988e+04
 1.44909279e+03 3.76238021e+02 1.15044795e+02 4.05024339e+01
 1.30390875e+01 6.39097136e+00 8.60490349e+00 4.92729785e-01]
grad_E = [ 9.22602857e-05 -3.81020874e-04  4.49939464e-09  4.70852701e-04
  2.25145428e-11  1.23077749e-10  6.99753142e-10  2.74784463e-09
  1.14279582e-08  6.10955743e-08  3.86894073e-06  1.35065963e-07
 -8.38763051e-06  1.35563674e-04 -7.70946246e-04 -1.93254858e-04
 -7.51041348e-05  1.20149429e-04  5.78859558e-04 -7.03637328e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:11:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.242583000445       1
[INPUT] 0    0    [1    /1   ]  0.636452600877       1
[INPUT] 0    0    [1    /1   ]  117616.813851        1
[INPUT] 0    0    [1    /1   ]  2.76388813507        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991909        1
[INPUT] 0    0    [1    /1   ]  73510.4199795        1
[INPUT] 0    0    [1    /1   ]  36754.7147053        1
[INPUT] 0    0    [1    /1   ]  7303.14015894        1
[INPUT] 0    0    [1    /1   ]  18375.7987697        1
[INPUT] 0    0    [1    /1   ]  1449.09290733        1
[INPUT] 0    0    [1    /1   ]  376.236303906        1
[INPUT] 0    0    [1    /1   ]  115.055468604        1
[INPUT] 0    0    [1    /1   ]  40.4848413456        1
[INPUT] 0    0    [1    /1   ]  13.0345570222        1
[INPUT] 0    0    [1    /1   ]  6.39020618745        1
[INPUT] 1    0    [1    /1   ]  8.60501938041        1
[INPUT] 1    0    [1    /1   ]  0.492737627776       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24258300044494832, 1.0]], [0, [0.6364526008766634, 1.0]], [0, [117616.81385074377, 1.0]], [0, [2.7638881350669897, 1.0]], [0, [1176168.14261716, 1.0]], [0, [588084.0699820393, 1.0]], [0, [294042.03107103583, 1.0]], [0, [147020.9919092018, 1.0]], [0, [73510.41997952093, 1.0]], [0, [36754.7147052878, 1.0]], [0, [7303.140158938482, 1.0]], [0, [18375.798769733778, 1.0]], [0, [1449.0929073270665, 1.0]], [0, [376.2363039057658, 1.0]], [0, [115.05546860390005, 1.0]], [0, [40.48484134555746, 1.0]], [0, [13.034557022167105, 1.0]], [0, [6.3902061874467275, 1.0]], [1, [8.605019380410093, 1.0]], [1, [0.49273762777617014, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.242583]
bas 1, expnt(s) = [0.6364526]
bas 2, expnt(s) = [117616.81385074]
bas 3, expnt(s) = [2.76388814]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998204]
bas 6, expnt(s) = [294042.03107104]
bas 7, expnt(s) = [147020.9919092]
bas 8, expnt(s) = [73510.41997952]
bas 9, expnt(s) = [36754.71470529]
bas 10, expnt(s) = [7303.14015894]
bas 11, expnt(s) = [18375.79876973]
bas 12, expnt(s) = [1449.09290733]
bas 13, expnt(s) = [376.23630391]
bas 14, expnt(s) = [115.0554686]
bas 15, expnt(s) = [40.48484135]
bas 16, expnt(s) = [13.03455702]
bas 17, expnt(s) = [6.39020619]
bas 18, expnt(s) = [8.60501938]
bas 19, expnt(s) = [0.49273763]
CPU time:       559.59
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.42583000e-01 8.73293639e-01 6.36452601e-01 1.80027800e+00
 1.17616814e+05 1.60460109e+04 2.76388814e+00 5.41570962e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314016e+03 1.99593894e+03 1.83757988e+04 3.98749080e+03
 1.44909291e+03 5.93385866e+02 3.76236304e+02 2.15829373e+02
 1.15055469e+02 8.87555406e+01 4.04848413e+01 4.05493928e+01
 1.30345570e+01 1.73315431e+01 6.39020619e+00 1.01543278e+01
 8.60501938e+00 4.29956193e+01 4.92737628e-01 1.20435370e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335990815080766
cond(S) = 908495.8668981576
E1 = -689.589232234217  E_coul = 184.9720311558172
init E= -504.6172010784
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672251899845705  LUMO = 0.647265584683832
  mo_energy =
[-1.21705717e+02 -1.33859300e+01 -7.62356937e+00 -7.62356937e+00
 -7.62356937e+00 -1.65737315e+00 -6.72251900e-01 -6.72251900e-01
 -6.72251900e-01  6.47265585e-01  8.02196149e+00  3.86675930e+01
  1.60309257e+02  6.62187752e+02  2.80248397e+03  1.22757883e+04
  4.08929120e+04  1.04934155e+05  2.30116106e+05  4.55930025e+05
  8.44881534e+05  1.52805809e+06  2.85032463e+06  5.80821081e+06]
E1 = -707.7396091535369  E_coul = 199.77526030018635
cycle= 1 E= -507.964348853351  delta_E= -3.35  |g|= 0.451  |ddm|=  0.5
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.688639
diis-c [-0.47422325  1.        ]
  HOMO = -0.217778213133791  LUMO = 1.02518269943481
  mo_energy =
[-1.20197281e+02 -1.23049019e+01 -6.59455933e+00 -6.59455933e+00
 -6.59455933e+00 -1.16327339e+00 -2.17778213e-01 -2.17778213e-01
 -2.17778213e-01  1.02518270e+00  8.79863591e+00  3.97923892e+01
  1.61715025e+02  6.63678103e+02  2.80391492e+03  1.22771102e+04
  4.08941672e+04  1.04935373e+05  2.30117300e+05  4.55931202e+05
  8.44882698e+05  1.52805924e+06  2.85032577e+06  5.80821195e+06]
E1 = -706.7938051292394  E_coul = 198.8118264929189
cycle= 2 E= -507.981978636321  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.426
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0301209
diis-c [-9.05023168e-04 -2.18190057e-03  1.00218190e+00]
  HOMO = -0.239785074578739  LUMO = 1.01993206921098
  mo_energy =
[-1.20311125e+02 -1.23719336e+01 -6.66879863e+00 -6.66879863e+00
 -6.66879863e+00 -1.17743363e+00 -2.39785075e-01 -2.39785075e-01
 -2.39785075e-01  1.01993207e+00  8.75876340e+00  3.97221790e+01
  1.61617793e+02  6.63560464e+02  2.80378115e+03  1.22769662e+04
  4.08940194e+04  1.04935224e+05  2.30117150e+05  4.55931051e+05
  8.44882547e+05  1.52805909e+06  2.85032562e+06  5.80821179e+06]
E1 = -706.6865222462794  E_coul = 198.70428507312096
cycle= 3 E= -507.982237173158  delta_E= -0.000259  |g|= 0.00433  |ddm|= 0.0602
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00325268
diis-c [-2.38161457e-06  7.04883218e-05 -1.05342849e-01  1.10527236e+00]
  HOMO = -0.242898171762748  LUMO = 1.01895395121931
  mo_energy =
[-1.20322818e+02 -1.23804327e+01 -6.67778152e+00 -6.67778152e+00
 -6.67778152e+00 -1.17931718e+00 -2.42898172e-01 -2.42898172e-01
 -2.42898172e-01  1.01895395e+00  8.75315130e+00  3.97136054e+01
  1.61607196e+02  6.63548632e+02  2.80376851e+03  1.22769531e+04
  4.08940061e+04  1.04935211e+05  2.30117137e+05  4.55931038e+05
  8.44882533e+05  1.52805908e+06  2.85032560e+06  5.80821178e+06]
E1 = -706.6714970182085  E_coul = 198.68925506599845
cycle= 4 E= -507.98224195221  delta_E= -4.78e-06  |g|= 0.000211  |ddm|= 0.00946
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000148158
diis-c [-1.65678847e-10 -7.39303261e-06  6.84171994e-03 -9.85884168e-02
  1.09175409e+00]
  HOMO = -0.243040627206837  LUMO = 1.0189019172133
  mo_energy =
[-1.20323170e+02 -1.23807715e+01 -6.67811770e+00 -6.67811770e+00
 -6.67811770e+00 -1.17940251e+00 -2.43040627e-01 -2.43040627e-01
 -2.43040627e-01  1.01890192e+00  8.75289961e+00  3.97132803e+01
  1.61606850e+02  6.63548279e+02  2.80376815e+03  1.22769527e+04
  4.08940057e+04  1.04935210e+05  2.30117136e+05  4.55931037e+05
  8.44882533e+05  1.52805908e+06  2.85032560e+06  5.80821178e+06]
E1 = -706.670817481285  E_coul = 198.68857551819633
cycle= 5 E= -507.982241963089  delta_E= -1.09e-08  |g|= 1.92e-06  |ddm|= 0.000499
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.51001e-07
diis-c [-1.83380950e-13  3.21171246e-07 -2.54883827e-04  3.43368056e-03
 -4.03702167e-02  1.03719110e+00]
  HOMO = -0.243041677984788  LUMO = 1.01890167386472
  mo_energy =
[-1.20323173e+02 -1.23807739e+01 -6.67812011e+00 -6.67812011e+00
 -6.67812011e+00 -1.17940329e+00 -2.43041678e-01 -2.43041678e-01
 -2.43041678e-01  1.01890167e+00  8.75289779e+00  3.97132779e+01
  1.61606847e+02  6.63548276e+02  2.80376815e+03  1.22769527e+04
  4.08940057e+04  1.04935210e+05  2.30117136e+05  4.55931037e+05
  8.44882533e+05  1.52805908e+06  2.85032560e+06  5.80821178e+06]
E1 = -706.6708121342056  E_coul = 198.68857017111603
cycle= 6 E= -507.98224196309  delta_E= -9.09e-13  |g|= 5.7e-08  |ddm|= 4.4e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6708121342056  E_coul = 198.68857017111603
  HOMO = -0.243041706377848  LUMO = 1.01890165926131
  mo_energy =
[-1.20323173e+02 -1.23807739e+01 -6.67812017e+00 -6.67812017e+00
 -6.67812017e+00 -1.17940330e+00 -2.43041706e-01 -2.43041706e-01
 -2.43041706e-01  1.01890166e+00  8.75289774e+00  3.97132779e+01
  1.61606847e+02  6.63548276e+02  2.80376815e+03  1.22769527e+04
  4.08940057e+04  1.04935210e+05  2.30117136e+05  4.55931037e+05
  8.44882533e+05  1.52805908e+06  2.85032560e+06  5.80821178e+06]
E1 = -706.670812006064  E_coul = 198.68857004297465
Extra cycle  E= -507.982241963089  delta_E= 2.27e-13  |g|= 7.24e-09  |ddm|= 1.13e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.42583000e-01 6.36452601e-01 1.17616814e+05 2.76388814e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314016e+03 1.83757988e+04
 1.44909291e+03 3.76236304e+02 1.15055469e+02 4.04848413e+01
 1.30345570e+01 6.39020619e+00 8.60501938e+00 4.92737628e-01]
E = -507.98224196308934
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:11:28 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.242583000445       1
[INPUT] 0    0    [1    /1   ]  0.636452600877       1
[INPUT] 0    0    [1    /1   ]  117616.813851        1
[INPUT] 0    0    [1    /1   ]  2.76388813507        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991909        1
[INPUT] 0    0    [1    /1   ]  73510.4199795        1
[INPUT] 0    0    [1    /1   ]  36754.7147053        1
[INPUT] 0    0    [1    /1   ]  7303.14015894        1
[INPUT] 0    0    [1    /1   ]  18375.7987697        1
[INPUT] 0    0    [1    /1   ]  1449.09290733        1
[INPUT] 0    0    [1    /1   ]  376.236303906        1
[INPUT] 0    0    [1    /1   ]  115.055468604        1
[INPUT] 0    0    [1    /1   ]  40.4848413456        1
[INPUT] 0    0    [1    /1   ]  13.0345570222        1
[INPUT] 0    0    [1    /1   ]  6.39020618745        1
[INPUT] 1    0    [1    /1   ]  8.60501938041        1
[INPUT] 1    0    [1    /1   ]  0.492737627776       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24258300044494832, 1.0]], [0, [0.6364526008766634, 1.0]], [0, [117616.81385074377, 1.0]], [0, [2.7638881350669897, 1.0]], [0, [1176168.14261716, 1.0]], [0, [588084.0699820393, 1.0]], [0, [294042.03107103583, 1.0]], [0, [147020.9919092018, 1.0]], [0, [73510.41997952093, 1.0]], [0, [36754.7147052878, 1.0]], [0, [7303.140158938482, 1.0]], [0, [18375.798769733778, 1.0]], [0, [1449.0929073270665, 1.0]], [0, [376.2363039057658, 1.0]], [0, [115.05546860390005, 1.0]], [0, [40.48484134555746, 1.0]], [0, [13.034557022167105, 1.0]], [0, [6.3902061874467275, 1.0]], [1, [8.605019380410093, 1.0]], [1, [0.49273762777617014, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.242583]
bas 1, expnt(s) = [0.6364526]
bas 2, expnt(s) = [117616.81385074]
bas 3, expnt(s) = [2.76388814]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998204]
bas 6, expnt(s) = [294042.03107104]
bas 7, expnt(s) = [147020.9919092]
bas 8, expnt(s) = [73510.41997952]
bas 9, expnt(s) = [36754.71470529]
bas 10, expnt(s) = [7303.14015894]
bas 11, expnt(s) = [18375.79876973]
bas 12, expnt(s) = [1449.09290733]
bas 13, expnt(s) = [376.23630391]
bas 14, expnt(s) = [115.0554686]
bas 15, expnt(s) = [40.48484135]
bas 16, expnt(s) = [13.03455702]
bas 17, expnt(s) = [6.39020619]
bas 18, expnt(s) = [8.60501938]
bas 19, expnt(s) = [0.49273763]
CPU time:       560.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.42583000e-01 8.73293639e-01 6.36452601e-01 1.80027800e+00
 1.17616814e+05 1.60460109e+04 2.76388814e+00 5.41570962e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314016e+03 1.99593894e+03 1.83757988e+04 3.98749080e+03
 1.44909291e+03 5.93385866e+02 3.76236304e+02 2.15829373e+02
 1.15055469e+02 8.87555406e+01 4.04848413e+01 4.05493928e+01
 1.30345570e+01 1.73315431e+01 6.39020619e+00 1.01543278e+01
 8.60501938e+00 4.29956193e+01 4.92737628e-01 1.20435370e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335990815080766
cond(S) = 908495.8668981576
E1 = -689.589232234217  E_coul = 184.9720311558172
init E= -504.6172010784
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672251899845705  LUMO = 0.647265584683832
  mo_energy =
[-1.21705717e+02 -1.33859300e+01 -7.62356937e+00 -7.62356937e+00
 -7.62356937e+00 -1.65737315e+00 -6.72251900e-01 -6.72251900e-01
 -6.72251900e-01  6.47265585e-01  8.02196149e+00  3.86675930e+01
  1.60309257e+02  6.62187752e+02  2.80248397e+03  1.22757883e+04
  4.08929120e+04  1.04934155e+05  2.30116106e+05  4.55930025e+05
  8.44881534e+05  1.52805809e+06  2.85032463e+06  5.80821081e+06]
E1 = -707.7396091535369  E_coul = 199.77526030018635
cycle= 1 E= -507.964348853351  delta_E= -3.35  |g|= 0.451  |ddm|=  0.5
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.688639
diis-c [-0.47422325  1.        ]
  HOMO = -0.217778213133791  LUMO = 1.02518269943481
  mo_energy =
[-1.20197281e+02 -1.23049019e+01 -6.59455933e+00 -6.59455933e+00
 -6.59455933e+00 -1.16327339e+00 -2.17778213e-01 -2.17778213e-01
 -2.17778213e-01  1.02518270e+00  8.79863591e+00  3.97923892e+01
  1.61715025e+02  6.63678103e+02  2.80391492e+03  1.22771102e+04
  4.08941672e+04  1.04935373e+05  2.30117300e+05  4.55931202e+05
  8.44882698e+05  1.52805924e+06  2.85032577e+06  5.80821195e+06]
E1 = -706.7938051292394  E_coul = 198.8118264929189
cycle= 2 E= -507.981978636321  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.426
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0301209
diis-c [-9.05023168e-04 -2.18190057e-03  1.00218190e+00]
  HOMO = -0.239785074578739  LUMO = 1.01993206921098
  mo_energy =
[-1.20311125e+02 -1.23719336e+01 -6.66879863e+00 -6.66879863e+00
 -6.66879863e+00 -1.17743363e+00 -2.39785075e-01 -2.39785075e-01
 -2.39785075e-01  1.01993207e+00  8.75876340e+00  3.97221790e+01
  1.61617793e+02  6.63560464e+02  2.80378115e+03  1.22769662e+04
  4.08940194e+04  1.04935224e+05  2.30117150e+05  4.55931051e+05
  8.44882547e+05  1.52805909e+06  2.85032562e+06  5.80821179e+06]
E1 = -706.6865222462794  E_coul = 198.70428507312096
cycle= 3 E= -507.982237173158  delta_E= -0.000259  |g|= 0.00433  |ddm|= 0.0602
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00325268
diis-c [-2.38161457e-06  7.04883218e-05 -1.05342849e-01  1.10527236e+00]
  HOMO = -0.242898171762748  LUMO = 1.01895395121931
  mo_energy =
[-1.20322818e+02 -1.23804327e+01 -6.67778152e+00 -6.67778152e+00
 -6.67778152e+00 -1.17931718e+00 -2.42898172e-01 -2.42898172e-01
 -2.42898172e-01  1.01895395e+00  8.75315130e+00  3.97136054e+01
  1.61607196e+02  6.63548632e+02  2.80376851e+03  1.22769531e+04
  4.08940061e+04  1.04935211e+05  2.30117137e+05  4.55931038e+05
  8.44882533e+05  1.52805908e+06  2.85032560e+06  5.80821178e+06]
E1 = -706.6714970182085  E_coul = 198.68925506599845
cycle= 4 E= -507.98224195221  delta_E= -4.78e-06  |g|= 0.000211  |ddm|= 0.00946
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000148158
diis-c [-1.65678847e-10 -7.39303261e-06  6.84171994e-03 -9.85884168e-02
  1.09175409e+00]
  HOMO = -0.243040627206837  LUMO = 1.0189019172133
  mo_energy =
[-1.20323170e+02 -1.23807715e+01 -6.67811770e+00 -6.67811770e+00
 -6.67811770e+00 -1.17940251e+00 -2.43040627e-01 -2.43040627e-01
 -2.43040627e-01  1.01890192e+00  8.75289961e+00  3.97132803e+01
  1.61606850e+02  6.63548279e+02  2.80376815e+03  1.22769527e+04
  4.08940057e+04  1.04935210e+05  2.30117136e+05  4.55931037e+05
  8.44882533e+05  1.52805908e+06  2.85032560e+06  5.80821178e+06]
E1 = -706.670817481285  E_coul = 198.68857551819633
cycle= 5 E= -507.982241963089  delta_E= -1.09e-08  |g|= 1.92e-06  |ddm|= 0.000499
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.51001e-07
diis-c [-1.83380950e-13  3.21171246e-07 -2.54883827e-04  3.43368056e-03
 -4.03702167e-02  1.03719110e+00]
  HOMO = -0.243041677984788  LUMO = 1.01890167386472
  mo_energy =
[-1.20323173e+02 -1.23807739e+01 -6.67812011e+00 -6.67812011e+00
 -6.67812011e+00 -1.17940329e+00 -2.43041678e-01 -2.43041678e-01
 -2.43041678e-01  1.01890167e+00  8.75289779e+00  3.97132779e+01
  1.61606847e+02  6.63548276e+02  2.80376815e+03  1.22769527e+04
  4.08940057e+04  1.04935210e+05  2.30117136e+05  4.55931037e+05
  8.44882533e+05  1.52805908e+06  2.85032560e+06  5.80821178e+06]
E1 = -706.6708121342056  E_coul = 198.68857017111603
cycle= 6 E= -507.98224196309  delta_E= -9.09e-13  |g|= 5.7e-08  |ddm|= 4.4e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6708121342056  E_coul = 198.68857017111603
  HOMO = -0.243041706377848  LUMO = 1.01890165926131
  mo_energy =
[-1.20323173e+02 -1.23807739e+01 -6.67812017e+00 -6.67812017e+00
 -6.67812017e+00 -1.17940330e+00 -2.43041706e-01 -2.43041706e-01
 -2.43041706e-01  1.01890166e+00  8.75289774e+00  3.97132779e+01
  1.61606847e+02  6.63548276e+02  2.80376815e+03  1.22769527e+04
  4.08940057e+04  1.04935210e+05  2.30117136e+05  4.55931037e+05
  8.44882533e+05  1.52805908e+06  2.85032560e+06  5.80821178e+06]
E1 = -706.670812006064  E_coul = 198.68857004297465
Extra cycle  E= -507.982241963089  delta_E= 2.27e-13  |g|= 7.24e-09  |ddm|= 1.13e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908495.8668981576
E1 = -706.670812006064  E_coul = 198.68857004297465
init E= -507.982241963089
    CPU time for initialize scf      3.31 sec, wall time      0.21 sec
  HOMO = -0.243041710360505  LUMO = 1.01890165395316
  mo_energy =
[-1.20323173e+02 -1.23807739e+01 -6.67812018e+00 -6.67812018e+00
 -6.67812018e+00 -1.17940330e+00 -2.43041710e-01 -2.43041710e-01
 -2.43041710e-01  1.01890165e+00  8.75289773e+00  3.97132779e+01
  1.61606847e+02  6.63548276e+02  2.80376815e+03  1.22769527e+04
  4.08940057e+04  1.04935210e+05  2.30117136e+05  4.55931037e+05
  8.44882533e+05  1.52805908e+06  2.85032560e+06  5.80821178e+06]
E1 = -706.6708119880691  E_coul = 198.68857002497938
cycle= 1 E= -507.98224196309  delta_E= -3.41e-13  |g|= 2.82e-09  |ddm|= 1.34e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6708119880691  E_coul = 198.68857002497938
  HOMO = -0.243041710870421  LUMO = 1.01890165568882
  mo_energy =
[-1.20323173e+02 -1.23807739e+01 -6.67812018e+00 -6.67812018e+00
 -6.67812018e+00 -1.17940330e+00 -2.43041711e-01 -2.43041711e-01
 -2.43041711e-01  1.01890166e+00  8.75289773e+00  3.97132779e+01
  1.61606847e+02  6.63548276e+02  2.80376815e+03  1.22769527e+04
  4.08940057e+04  1.04935210e+05  2.30117136e+05  4.55931037e+05
  8.44882533e+05  1.52805908e+06  2.85032560e+06  5.80821178e+06]
E1 = -706.670811981551  E_coul = 198.68857001846098
Extra cycle  E= -507.98224196309  delta_E= -3.41e-13  |g|= 3.12e-09  |ddm|= 4.39e-09
    CPU time for scf_cycle      3.76 sec, wall time      0.38 sec
exp = [2.42583000e-01 6.36452601e-01 1.17616814e+05 2.76388814e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314016e+03 1.83757988e+04
 1.44909291e+03 3.76236304e+02 1.15055469e+02 4.04848413e+01
 1.30345570e+01 6.39020619e+00 8.60501938e+00 4.92737628e-01]
grad_E = [-7.17611811e-04 -3.93573000e-04  4.49263720e-09  4.66550820e-04
  2.24352311e-11  1.22857921e-10  6.98709175e-10  2.74366663e-09
  1.14103333e-08  6.10090349e-08  3.86287853e-06  1.34798882e-07
 -8.05444334e-06  1.30997399e-04 -7.46929346e-04 -2.35210060e-04
 -6.81103555e-05  1.33906604e-04  6.63980506e-04 -7.21734067e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:11:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.24183342605        1
[INPUT] 0    0    [1    /1   ]  0.635295582321       1
[INPUT] 0    0    [1    /1   ]  117616.813851        1
[INPUT] 0    0    [1    /1   ]  2.76339102169        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991909        1
[INPUT] 0    0    [1    /1   ]  73510.4199795        1
[INPUT] 0    0    [1    /1   ]  36754.7147053        1
[INPUT] 0    0    [1    /1   ]  7303.14015955        1
[INPUT] 0    0    [1    /1   ]  18375.7987697        1
[INPUT] 0    0    [1    /1   ]  1449.09303072        1
[INPUT] 0    0    [1    /1   ]  376.234473949        1
[INPUT] 0    0    [1    /1   ]  115.067124245        1
[INPUT] 0    0    [1    /1   ]  40.4646896278        1
[INPUT] 0    0    [1    /1   ]  13.0255493156        1
[INPUT] 0    0    [1    /1   ]  6.38727604363        1
[INPUT] 1    0    [1    /1   ]  8.60456337627        1
[INPUT] 1    0    [1    /1   ]  0.492737101345       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24183342605033917, 1.0]], [0, [0.6352955823211305, 1.0]], [0, [117616.81385074461, 1.0]], [0, [2.763391021690002, 1.0]], [0, [1176168.14261716, 1.0]], [0, [588084.0699820393, 1.0]], [0, [294042.03107103595, 1.0]], [0, [147020.9919092023, 1.0]], [0, [73510.4199795229, 1.0]], [0, [36754.714705301194, 1.0]], [0, [7303.140159548064, 1.0]], [0, [18375.79876973594, 1.0]], [0, [1449.0930307169976, 1.0]], [0, [376.2344739485557, 1.0]], [0, [115.06712424538675, 1.0]], [0, [40.4646896278304, 1.0]], [0, [13.025549315619317, 1.0]], [0, [6.387276043632908, 1.0]], [1, [8.604563376268162, 1.0]], [1, [0.4927371013450779, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24183343]
bas 1, expnt(s) = [0.63529558]
bas 2, expnt(s) = [117616.81385074]
bas 3, expnt(s) = [2.76339102]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998204]
bas 6, expnt(s) = [294042.03107104]
bas 7, expnt(s) = [147020.9919092]
bas 8, expnt(s) = [73510.41997952]
bas 9, expnt(s) = [36754.7147053]
bas 10, expnt(s) = [7303.14015955]
bas 11, expnt(s) = [18375.79876974]
bas 12, expnt(s) = [1449.09303072]
bas 13, expnt(s) = [376.23447395]
bas 14, expnt(s) = [115.06712425]
bas 15, expnt(s) = [40.46468963]
bas 16, expnt(s) = [13.02554932]
bas 17, expnt(s) = [6.38727604]
bas 18, expnt(s) = [8.60456338]
bas 19, expnt(s) = [0.4927371]
CPU time:       572.56
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.41833426e-01 8.71269017e-01 6.35295582e-01 1.79782287e+00
 1.17616814e+05 1.60460109e+04 2.76339102e+00 5.41497905e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314016e+03 1.99593894e+03 1.83757988e+04 3.98749080e+03
 1.44909303e+03 5.93385904e+02 3.76234474e+02 2.15828586e+02
 1.15067124e+02 8.87622840e+01 4.04646896e+01 4.05342540e+01
 1.30255493e+01 1.73225594e+01 6.38727604e+00 1.01508355e+01
 8.60456338e+00 4.29927712e+01 4.92737101e-01 1.20435210e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336001417385823
cond(S) = 908494.6030133998
E1 = -689.5876147424129  E_coul = 184.97009280170903
init E= -504.617521940704
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672243267194439  LUMO = 0.643927727545872
  mo_energy =
[-1.21706140e+02 -1.33860800e+01 -7.62370646e+00 -7.62370646e+00
 -7.62370646e+00 -1.65737449e+00 -6.72243267e-01 -6.72243267e-01
 -6.72243267e-01  6.43927728e-01  8.00982885e+00  3.86328473e+01
  1.60221305e+02  6.62086542e+02  2.80239676e+03  1.22757123e+04
  4.08928416e+04  1.04934088e+05  2.30116040e+05  4.55929960e+05
  8.44881471e+05  1.52805803e+06  2.85032456e+06  5.80821075e+06]
E1 = -707.7371601247781  E_coul = 199.77281345935438
cycle= 1 E= -507.964346665424  delta_E= -3.35  |g|= 0.451  |ddm|= 0.499
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.688692
diis-c [-0.47429611  1.        ]
  HOMO = -0.21778573365137  LUMO = 1.02128565376398
  mo_energy =
[-1.20197758e+02 -1.23050842e+01 -6.59473484e+00 -6.59473484e+00
 -6.59473484e+00 -1.16328821e+00 -2.17785734e-01 -2.17785734e-01
 -2.17785734e-01  1.02128565e+00  8.78631269e+00  3.97574356e+01
  1.61626978e+02  6.63576839e+02  2.80382767e+03  1.22770342e+04
  4.08940968e+04  1.04935306e+05  2.30117234e+05  4.55931137e+05
  8.44882634e+05  1.52805918e+06  2.85032571e+06  5.80821189e+06]
E1 = -706.7911193686018  E_coul = 198.809138600642
cycle= 2 E= -507.98198076796  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.426
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0301482
diis-c [-9.06613009e-04 -2.21077798e-03  1.00221078e+00]
  HOMO = -0.239805498804513  LUMO = 1.01605311228015
  mo_energy =
[-1.20311619e+02 -1.23721343e+01 -6.66899147e+00 -6.66899147e+00
 -6.66899147e+00 -1.17745831e+00 -2.39805499e-01 -2.39805499e-01
 -2.39805499e-01  1.01605311e+00  8.74644615e+00  3.96872220e+01
  1.61529735e+02  6.63459182e+02  2.80369388e+03  1.22768902e+04
  4.08939490e+04  1.04935157e+05  2.30117084e+05  4.55930987e+05
  8.44882483e+05  1.52805903e+06  2.85032556e+06  5.80821174e+06]
E1 = -706.6837234201471  E_coul = 198.70148364503663
cycle= 3 E= -507.98223977511  delta_E= -0.000259  |g|= 0.00433  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00325825
diis-c [-2.38845548e-06  7.00337830e-05 -1.05446194e-01  1.10537616e+00]
  HOMO = -0.242923056881983  LUMO = 1.01507659596446
  mo_energy =
[-1.20323320e+02 -1.23806411e+01 -6.67798195e+00 -6.67798195e+00
 -6.67798195e+00 -1.17934479e+00 -2.42923057e-01 -2.42923057e-01
 -2.42923057e-01  1.01507660e+00  8.74082973e+00  3.96786420e+01
  1.61519130e+02  6.63447343e+02  2.80368123e+03  1.22768770e+04
  4.08939357e+04  1.04935143e+05  2.30117071e+05  4.55930973e+05
  8.44882470e+05  1.52805902e+06  2.85032554e+06  5.80821172e+06]
E1 = -706.6686702164712  E_coul = 198.6864256457379
cycle= 4 E= -507.982244570733  delta_E= -4.8e-06  |g|= 0.000211  |ddm|= 0.00948
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000148457
diis-c [-1.67388690e-10 -7.40656379e-06  6.84666546e-03 -9.86134868e-02
  1.09177423e+00]
  HOMO = -0.243065810946131  LUMO = 1.0150245844916
  mo_energy =
[-1.20323672e+02 -1.23809804e+01 -6.67831854e+00 -6.67831854e+00
 -6.67831854e+00 -1.17943030e+00 -2.43065811e-01 -2.43065811e-01
 -2.43065811e-01  1.01502458e+00  8.74057765e+00  3.96783165e+01
  1.61518784e+02  6.63446990e+02  2.80368088e+03  1.22768767e+04
  4.08939353e+04  1.04935143e+05  2.30117071e+05  4.55930973e+05
  8.44882470e+05  1.52805902e+06  2.85032554e+06  5.80821172e+06]
E1 = -706.6679889142263  E_coul = 198.68574433255583
cycle= 5 E= -507.98224458167  delta_E= -1.09e-08  |g|= 1.93e-06  |ddm|= 0.0005
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.60745e-07
diis-c [-1.85561336e-13  3.30657948e-07 -2.58290951e-04  3.47812457e-03
 -4.08553493e-02  1.03763519e+00]
  HOMO = -0.243066870109377  LUMO = 1.01502433818016
  mo_energy =
[-1.20323675e+02 -1.23809827e+01 -6.67832096e+00 -6.67832096e+00
 -6.67832096e+00 -1.17943109e+00 -2.43066870e-01 -2.43066870e-01
 -2.43066870e-01  1.01502434e+00  8.74057582e+00  3.96783142e+01
  1.61518781e+02  6.63446987e+02  2.80368087e+03  1.22768767e+04
  4.08939353e+04  1.04935143e+05  2.30117071e+05  4.55930973e+05
  8.44882470e+05  1.52805902e+06  2.85032554e+06  5.80821172e+06]
E1 = -706.6679835175585  E_coul = 198.6857389358881
cycle= 6 E= -507.98224458167  delta_E= 1.14e-13  |g|= 5.71e-08  |ddm|= 4.44e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6679835175585  E_coul = 198.6857389358881
  HOMO = -0.243066898591296  LUMO = 1.01502432222773
  mo_energy =
[-1.20323675e+02 -1.23809828e+01 -6.67832102e+00 -6.67832102e+00
 -6.67832102e+00 -1.17943111e+00 -2.43066899e-01 -2.43066899e-01
 -2.43066899e-01  1.01502432e+00  8.74057577e+00  3.96783141e+01
  1.61518781e+02  6.63446987e+02  2.80368087e+03  1.22768767e+04
  4.08939353e+04  1.04935143e+05  2.30117071e+05  4.55930973e+05
  8.44882470e+05  1.52805902e+06  2.85032554e+06  5.80821172e+06]
E1 = -706.6679833890254  E_coul = 198.68573880735485
Extra cycle  E= -507.982244581671  delta_E= -2.27e-13  |g|= 6.99e-09  |ddm|= 1.13e-07
    CPU time for scf_cycle      1.10 sec, wall time      0.28 sec
exp = [2.41833426e-01 6.35295582e-01 1.17616814e+05 2.76339102e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314016e+03 1.83757988e+04
 1.44909303e+03 3.76234474e+02 1.15067124e+02 4.04646896e+01
 1.30255493e+01 6.38727604e+00 8.60456338e+00 4.92737101e-01]
E = -507.98224458167056
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:11:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.24183342605        1
[INPUT] 0    0    [1    /1   ]  0.635295582321       1
[INPUT] 0    0    [1    /1   ]  117616.813851        1
[INPUT] 0    0    [1    /1   ]  2.76339102169        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991909        1
[INPUT] 0    0    [1    /1   ]  73510.4199795        1
[INPUT] 0    0    [1    /1   ]  36754.7147053        1
[INPUT] 0    0    [1    /1   ]  7303.14015955        1
[INPUT] 0    0    [1    /1   ]  18375.7987697        1
[INPUT] 0    0    [1    /1   ]  1449.09303072        1
[INPUT] 0    0    [1    /1   ]  376.234473949        1
[INPUT] 0    0    [1    /1   ]  115.067124245        1
[INPUT] 0    0    [1    /1   ]  40.4646896278        1
[INPUT] 0    0    [1    /1   ]  13.0255493156        1
[INPUT] 0    0    [1    /1   ]  6.38727604363        1
[INPUT] 1    0    [1    /1   ]  8.60456337627        1
[INPUT] 1    0    [1    /1   ]  0.492737101345       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24183342605033917, 1.0]], [0, [0.6352955823211305, 1.0]], [0, [117616.81385074461, 1.0]], [0, [2.763391021690002, 1.0]], [0, [1176168.14261716, 1.0]], [0, [588084.0699820393, 1.0]], [0, [294042.03107103595, 1.0]], [0, [147020.9919092023, 1.0]], [0, [73510.4199795229, 1.0]], [0, [36754.714705301194, 1.0]], [0, [7303.140159548064, 1.0]], [0, [18375.79876973594, 1.0]], [0, [1449.0930307169976, 1.0]], [0, [376.2344739485557, 1.0]], [0, [115.06712424538675, 1.0]], [0, [40.4646896278304, 1.0]], [0, [13.025549315619317, 1.0]], [0, [6.387276043632908, 1.0]], [1, [8.604563376268162, 1.0]], [1, [0.4927371013450779, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24183343]
bas 1, expnt(s) = [0.63529558]
bas 2, expnt(s) = [117616.81385074]
bas 3, expnt(s) = [2.76339102]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998204]
bas 6, expnt(s) = [294042.03107104]
bas 7, expnt(s) = [147020.9919092]
bas 8, expnt(s) = [73510.41997952]
bas 9, expnt(s) = [36754.7147053]
bas 10, expnt(s) = [7303.14015955]
bas 11, expnt(s) = [18375.79876974]
bas 12, expnt(s) = [1449.09303072]
bas 13, expnt(s) = [376.23447395]
bas 14, expnt(s) = [115.06712425]
bas 15, expnt(s) = [40.46468963]
bas 16, expnt(s) = [13.02554932]
bas 17, expnt(s) = [6.38727604]
bas 18, expnt(s) = [8.60456338]
bas 19, expnt(s) = [0.4927371]
CPU time:       573.95
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.41833426e-01 8.71269017e-01 6.35295582e-01 1.79782287e+00
 1.17616814e+05 1.60460109e+04 2.76339102e+00 5.41497905e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314016e+03 1.99593894e+03 1.83757988e+04 3.98749080e+03
 1.44909303e+03 5.93385904e+02 3.76234474e+02 2.15828586e+02
 1.15067124e+02 8.87622840e+01 4.04646896e+01 4.05342540e+01
 1.30255493e+01 1.73225594e+01 6.38727604e+00 1.01508355e+01
 8.60456338e+00 4.29927712e+01 4.92737101e-01 1.20435210e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336001417385823
cond(S) = 908494.6030133998
E1 = -689.5876147424129  E_coul = 184.97009280170903
init E= -504.617521940704
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672243267194439  LUMO = 0.643927727545872
  mo_energy =
[-1.21706140e+02 -1.33860800e+01 -7.62370646e+00 -7.62370646e+00
 -7.62370646e+00 -1.65737449e+00 -6.72243267e-01 -6.72243267e-01
 -6.72243267e-01  6.43927728e-01  8.00982885e+00  3.86328473e+01
  1.60221305e+02  6.62086542e+02  2.80239676e+03  1.22757123e+04
  4.08928416e+04  1.04934088e+05  2.30116040e+05  4.55929960e+05
  8.44881471e+05  1.52805803e+06  2.85032456e+06  5.80821075e+06]
E1 = -707.7371601247781  E_coul = 199.77281345935438
cycle= 1 E= -507.964346665424  delta_E= -3.35  |g|= 0.451  |ddm|= 0.499
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.688692
diis-c [-0.47429611  1.        ]
  HOMO = -0.21778573365137  LUMO = 1.02128565376398
  mo_energy =
[-1.20197758e+02 -1.23050842e+01 -6.59473484e+00 -6.59473484e+00
 -6.59473484e+00 -1.16328821e+00 -2.17785734e-01 -2.17785734e-01
 -2.17785734e-01  1.02128565e+00  8.78631269e+00  3.97574356e+01
  1.61626978e+02  6.63576839e+02  2.80382767e+03  1.22770342e+04
  4.08940968e+04  1.04935306e+05  2.30117234e+05  4.55931137e+05
  8.44882634e+05  1.52805918e+06  2.85032571e+06  5.80821189e+06]
E1 = -706.7911193686018  E_coul = 198.809138600642
cycle= 2 E= -507.98198076796  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.426
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0301482
diis-c [-9.06613009e-04 -2.21077798e-03  1.00221078e+00]
  HOMO = -0.239805498804513  LUMO = 1.01605311228015
  mo_energy =
[-1.20311619e+02 -1.23721343e+01 -6.66899147e+00 -6.66899147e+00
 -6.66899147e+00 -1.17745831e+00 -2.39805499e-01 -2.39805499e-01
 -2.39805499e-01  1.01605311e+00  8.74644615e+00  3.96872220e+01
  1.61529735e+02  6.63459182e+02  2.80369388e+03  1.22768902e+04
  4.08939490e+04  1.04935157e+05  2.30117084e+05  4.55930987e+05
  8.44882483e+05  1.52805903e+06  2.85032556e+06  5.80821174e+06]
E1 = -706.6837234201471  E_coul = 198.70148364503663
cycle= 3 E= -507.98223977511  delta_E= -0.000259  |g|= 0.00433  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00325825
diis-c [-2.38845548e-06  7.00337830e-05 -1.05446194e-01  1.10537616e+00]
  HOMO = -0.242923056881983  LUMO = 1.01507659596446
  mo_energy =
[-1.20323320e+02 -1.23806411e+01 -6.67798195e+00 -6.67798195e+00
 -6.67798195e+00 -1.17934479e+00 -2.42923057e-01 -2.42923057e-01
 -2.42923057e-01  1.01507660e+00  8.74082973e+00  3.96786420e+01
  1.61519130e+02  6.63447343e+02  2.80368123e+03  1.22768770e+04
  4.08939357e+04  1.04935143e+05  2.30117071e+05  4.55930973e+05
  8.44882470e+05  1.52805902e+06  2.85032554e+06  5.80821172e+06]
E1 = -706.6686702164712  E_coul = 198.6864256457379
cycle= 4 E= -507.982244570733  delta_E= -4.8e-06  |g|= 0.000211  |ddm|= 0.00948
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000148457
diis-c [-1.67388690e-10 -7.40656379e-06  6.84666546e-03 -9.86134868e-02
  1.09177423e+00]
  HOMO = -0.243065810946131  LUMO = 1.0150245844916
  mo_energy =
[-1.20323672e+02 -1.23809804e+01 -6.67831854e+00 -6.67831854e+00
 -6.67831854e+00 -1.17943030e+00 -2.43065811e-01 -2.43065811e-01
 -2.43065811e-01  1.01502458e+00  8.74057765e+00  3.96783165e+01
  1.61518784e+02  6.63446990e+02  2.80368088e+03  1.22768767e+04
  4.08939353e+04  1.04935143e+05  2.30117071e+05  4.55930973e+05
  8.44882470e+05  1.52805902e+06  2.85032554e+06  5.80821172e+06]
E1 = -706.6679889142263  E_coul = 198.68574433255583
cycle= 5 E= -507.98224458167  delta_E= -1.09e-08  |g|= 1.93e-06  |ddm|= 0.0005
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.60745e-07
diis-c [-1.85561336e-13  3.30657948e-07 -2.58290951e-04  3.47812457e-03
 -4.08553493e-02  1.03763519e+00]
  HOMO = -0.243066870109377  LUMO = 1.01502433818016
  mo_energy =
[-1.20323675e+02 -1.23809827e+01 -6.67832096e+00 -6.67832096e+00
 -6.67832096e+00 -1.17943109e+00 -2.43066870e-01 -2.43066870e-01
 -2.43066870e-01  1.01502434e+00  8.74057582e+00  3.96783142e+01
  1.61518781e+02  6.63446987e+02  2.80368087e+03  1.22768767e+04
  4.08939353e+04  1.04935143e+05  2.30117071e+05  4.55930973e+05
  8.44882470e+05  1.52805902e+06  2.85032554e+06  5.80821172e+06]
E1 = -706.6679835175585  E_coul = 198.6857389358881
cycle= 6 E= -507.98224458167  delta_E= 1.14e-13  |g|= 5.71e-08  |ddm|= 4.44e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6679835175585  E_coul = 198.6857389358881
  HOMO = -0.243066898591296  LUMO = 1.01502432222773
  mo_energy =
[-1.20323675e+02 -1.23809828e+01 -6.67832102e+00 -6.67832102e+00
 -6.67832102e+00 -1.17943111e+00 -2.43066899e-01 -2.43066899e-01
 -2.43066899e-01  1.01502432e+00  8.74057577e+00  3.96783141e+01
  1.61518781e+02  6.63446987e+02  2.80368087e+03  1.22768767e+04
  4.08939353e+04  1.04935143e+05  2.30117071e+05  4.55930973e+05
  8.44882470e+05  1.52805902e+06  2.85032554e+06  5.80821172e+06]
E1 = -706.6679833890254  E_coul = 198.68573880735485
Extra cycle  E= -507.982244581671  delta_E= -2.27e-13  |g|= 6.99e-09  |ddm|= 1.13e-07
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908494.6030133998
E1 = -706.6679833890254  E_coul = 198.68573880735485
init E= -507.982244581671
    CPU time for initialize scf      3.28 sec, wall time      0.21 sec
  HOMO = -0.243066902575796  LUMO = 1.01502432155298
  mo_energy =
[-1.20323675e+02 -1.23809828e+01 -6.67832103e+00 -6.67832103e+00
 -6.67832103e+00 -1.17943111e+00 -2.43066903e-01 -2.43066903e-01
 -2.43066903e-01  1.01502432e+00  8.74057576e+00  3.96783141e+01
  1.61518781e+02  6.63446987e+02  2.80368087e+03  1.22768767e+04
  4.08939353e+04  1.04935143e+05  2.30117071e+05  4.55930973e+05
  8.44882470e+05  1.52805902e+06  2.85032554e+06  5.80821172e+06]
E1 = -706.6679833686032  E_coul = 198.68573878693277
cycle= 1 E= -507.98224458167  delta_E= 1.14e-13  |g|= 1.43e-09  |ddm|= 1.52e-08
    CPU time for cycle= 1      0.32 sec, wall time      0.03 sec
E1 = -706.6679833686032  E_coul = 198.68573878693277
  HOMO = -0.24306690317985  LUMO = 1.01502432163454
  mo_energy =
[-1.20323675e+02 -1.23809828e+01 -6.67832103e+00 -6.67832103e+00
 -6.67832103e+00 -1.17943111e+00 -2.43066903e-01 -2.43066903e-01
 -2.43066903e-01  1.01502432e+00  8.74057576e+00  3.96783141e+01
  1.61518781e+02  6.63446987e+02  2.80368087e+03  1.22768767e+04
  4.08939353e+04  1.04935143e+05  2.30117071e+05  4.55930973e+05
  8.44882470e+05  1.52805902e+06  2.85032554e+06  5.80821172e+06]
E1 = -706.6679833655671  E_coul = 198.68573878389626
Extra cycle  E= -507.982244581671  delta_E= -4.55e-13  |g|= 8.93e-10  |ddm|= 2.1e-09
    CPU time for scf_cycle      3.74 sec, wall time      0.37 sec
exp = [2.41833426e-01 6.35295582e-01 1.17616814e+05 2.76339102e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314016e+03 1.83757988e+04
 1.44909303e+03 3.76234474e+02 1.15067124e+02 4.04646896e+01
 1.30255493e+01 6.38727604e+00 8.60456338e+00 4.92737101e-01]
grad_E = [-1.78328949e-03 -1.38699203e-04  4.48521359e-09  4.74321002e-04
  2.23480285e-11  1.22616389e-10  6.97562258e-10  2.73907673e-09
  1.13909707e-08  6.09139650e-08  3.85621579e-06  1.34505460e-07
 -7.68767689e-06  1.25974964e-04 -7.20577991e-04 -2.80754419e-04
 -6.10736548e-05  1.43915924e-04  2.80725903e-04 -3.78921219e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:11:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.24125791388        1
[INPUT] 0    0    [1    /1   ]  0.634214857175       1
[INPUT] 0    0    [1    /1   ]  117616.813851        1
[INPUT] 0    0    [1    /1   ]  2.76349706979        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991909        1
[INPUT] 0    0    [1    /1   ]  73510.4199794        1
[INPUT] 0    0    [1    /1   ]  36754.7147049        1
[INPUT] 0    0    [1    /1   ]  7303.14013323        1
[INPUT] 0    0    [1    /1   ]  18375.7987688        1
[INPUT] 0    0    [1    /1   ]  1449.09318372        1
[INPUT] 0    0    [1    /1   ]  376.232158011        1
[INPUT] 0    0    [1    /1   ]  115.081180605        1
[INPUT] 0    0    [1    /1   ]  40.4483931439        1
[INPUT] 0    0    [1    /1   ]  13.0218008305        1
[INPUT] 0    0    [1    /1   ]  6.38679642623        1
[INPUT] 1    0    [1    /1   ]  8.6038317194         1
[INPUT] 1    0    [1    /1   ]  0.492732273284       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24125791387999782, 1.0]], [0, [0.634214857174885, 1.0]], [0, [117616.81385071411, 1.0]], [0, [2.763497069787589, 1.0]], [0, [1176168.1426171598, 1.0]], [0, [588084.0699820385, 1.0]], [0, [294042.03107103123, 1.0]], [0, [147020.99190918365, 1.0]], [0, [73510.4199794453, 1.0]], [0, [36754.71470488852, 1.0]], [0, [7303.140133233916, 1.0]], [0, [18375.79876880206, 1.0]], [0, [1449.093183716284, 1.0]], [0, [376.2321580109682, 1.0]], [0, [115.08118060454132, 1.0]], [0, [40.44839314389183, 1.0]], [0, [13.021800830547406, 1.0]], [0, [6.386796426234294, 1.0]], [1, [8.603831719401324, 1.0]], [1, [0.4927322732842889, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24125791]
bas 1, expnt(s) = [0.63421486]
bas 2, expnt(s) = [117616.81385071]
bas 3, expnt(s) = [2.76349707]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998204]
bas 6, expnt(s) = [294042.03107103]
bas 7, expnt(s) = [147020.99190918]
bas 8, expnt(s) = [73510.41997945]
bas 9, expnt(s) = [36754.71470489]
bas 10, expnt(s) = [7303.14013323]
bas 11, expnt(s) = [18375.7987688]
bas 12, expnt(s) = [1449.09318372]
bas 13, expnt(s) = [376.23215801]
bas 14, expnt(s) = [115.0811806]
bas 15, expnt(s) = [40.44839314]
bas 16, expnt(s) = [13.02180083]
bas 17, expnt(s) = [6.38679643]
bas 18, expnt(s) = [8.60383172]
bas 19, expnt(s) = [0.49273227]
CPU time:       585.51
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.41257914e-01 8.69713478e-01 6.34214857e-01 1.79552862e+00
 1.17616814e+05 1.60460109e+04 2.76349707e+00 5.41513491e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314013e+03 1.99593893e+03 1.83757988e+04 3.98749080e+03
 1.44909318e+03 5.93385951e+02 3.76232158e+02 2.15827589e+02
 1.15081181e+02 8.87704161e+01 4.04483931e+01 4.05220100e+01
 1.30218008e+01 1.73188205e+01 6.38679643e+00 1.01502638e+01
 8.60383172e+00 4.29882016e+01 4.92732273e-01 1.20433735e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33601600244735
cond(S) = 908494.006869613
E1 = -689.5845340544445  E_coul = 184.96673227089525
init E= -504.617801783549
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672238892424427  LUMO = 0.641194062804012
  mo_energy =
[-1.21706841e+02 -1.33863418e+01 -7.62394319e+00 -7.62394319e+00
 -7.62394319e+00 -1.65738749e+00 -6.72238892e-01 -6.72238892e-01
 -6.72238892e-01  6.41194063e-01  8.00170070e+00  3.86161443e+01
  1.60174199e+02  6.62038098e+02  2.80236067e+03  1.22756816e+04
  4.08928132e+04  1.04934060e+05  2.30116014e+05  4.55929934e+05
  8.44881445e+05  1.52805800e+06  2.85032454e+06  5.80821073e+06]
E1 = -707.7331637455671  E_coul = 199.76881382633889
cycle= 1 E= -507.964349919228  delta_E= -3.35  |g|= 0.451  |ddm|= 0.499
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.688725
diis-c [-0.47434278  1.        ]
  HOMO = -0.217800569027572  LUMO = 1.01808859696589
  mo_energy =
[-1.20198528e+02 -1.23053859e+01 -6.59502090e+00 -6.59502090e+00
 -6.59502090e+00 -1.16331481e+00 -2.17800569e-01 -2.17800569e-01
 -2.17800569e-01  1.01808860e+00  8.77811075e+00  3.97406246e+01
  1.61579781e+02  6.63528324e+02  2.80379152e+03  1.22770034e+04
  4.08940684e+04  1.04935279e+05  2.30117208e+05  4.55931111e+05
  8.44882609e+05  1.52805916e+06  2.85032568e+06  5.80821186e+06]
E1 = -706.7870643808341  E_coul = 198.80508017962106
cycle= 2 E= -507.981984201213  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.426
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0301661
diis-c [-9.07645896e-04 -2.23091863e-03  1.00223092e+00]
  HOMO = -0.239826644368125  LUMO = 1.01287204677688
  mo_energy =
[-1.20312389e+02 -1.23724413e+01 -6.66928092e+00 -6.66928092e+00
 -6.66928092e+00 -1.17749033e+00 -2.39826644e-01 -2.39826644e-01
 -2.39826644e-01  1.01287205e+00  8.73825033e+00  3.96704121e+01
  1.61482540e+02  6.63410668e+02  2.80365773e+03  1.22768594e+04
  4.08939205e+04  1.04935129e+05  2.30117058e+05  4.55930961e+05
  8.44882458e+05  1.52805900e+06  2.85032553e+06  5.80821171e+06]
E1 = -706.6795899706698  E_coul = 198.6973464153069
cycle= 3 E= -507.982243555363  delta_E= -0.000259  |g|= 0.00433  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00326223
diis-c [-2.39334974e-06  6.95759108e-05 -1.05525970e-01  1.10545639e+00]
  HOMO = -0.242947440584523  LUMO = 1.0118970218912
  mo_energy =
[-1.20324095e+02 -1.23809535e+01 -6.67827668e+00 -6.67827668e+00
 -6.67827668e+00 -1.17937899e+00 -2.42947441e-01 -2.42947441e-01
 -2.42947441e-01  1.01189702e+00  8.73263036e+00  3.96618273e+01
  1.61471930e+02  6.63398823e+02  2.80364508e+03  1.22768463e+04
  4.08939073e+04  1.04935116e+05  2.30117044e+05  4.55930947e+05
  8.44882444e+05  1.52805899e+06  2.85032552e+06  5.80821170e+06]
E1 = -706.6645148079225  E_coul = 198.68226644333646
cycle= 4 E= -507.982248364586  delta_E= -4.81e-06  |g|= 0.000212  |ddm|= 0.00949
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000148705
diis-c [-1.68815562e-10 -7.41716401e-06  6.85159064e-03 -9.86521836e-02
  1.09180801e+00]
  HOMO = -0.243090466185516  LUMO = 1.01184502195862
  mo_energy =
[-1.20324448e+02 -1.23812933e+01 -6.67861369e+00 -6.67861369e+00
 -6.67861369e+00 -1.17946468e+00 -2.43090466e-01 -2.43090466e-01
 -2.43090466e-01  1.01184502e+00  8.73237789e+00  3.96615013e+01
  1.61471583e+02  6.63398470e+02  2.80364472e+03  1.22768459e+04
  4.08939069e+04  1.04935116e+05  2.30117044e+05  4.55930947e+05
  8.44882444e+05  1.52805899e+06  2.85032552e+06  5.80821170e+06]
E1 = -706.6638318762293  E_coul = 198.68158350065312
cycle= 5 E= -507.982248375576  delta_E= -1.1e-08  |g|= 1.95e-06  |ddm|= 0.000501
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.68175e-07
diis-c [-1.87680463e-13  3.34726401e-07 -2.60147200e-04  3.50218879e-03
 -4.11233004e-02  1.03788092e+00]
  HOMO = -0.24309153236357  LUMO = 1.01184477411597
  mo_energy =
[-1.20324451e+02 -1.23812956e+01 -6.67861613e+00 -6.67861613e+00
 -6.67861613e+00 -1.17946547e+00 -2.43091532e-01 -2.43091532e-01
 -2.43091532e-01  1.01184477e+00  8.73237605e+00  3.96614990e+01
  1.61471581e+02  6.63398466e+02  2.80364471e+03  1.22768459e+04
  4.08939069e+04  1.04935116e+05  2.30117044e+05  4.55930947e+05
  8.44882444e+05  1.52805899e+06  2.85032552e+06  5.80821170e+06]
E1 = -706.663826441151  E_coul = 198.681578065574
cycle= 6 E= -507.982248375577  delta_E= -7.39e-13  |g|= 5.71e-08  |ddm|= 4.47e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.663826441151  E_coul = 198.681578065574
  HOMO = -0.243091560842612  LUMO = 1.01184475764714
  mo_energy =
[-1.20324451e+02 -1.23812957e+01 -6.67861619e+00 -6.67861619e+00
 -6.67861619e+00 -1.17946548e+00 -2.43091561e-01 -2.43091561e-01
 -2.43091561e-01  1.01184476e+00  8.73237600e+00  3.96614989e+01
  1.61471580e+02  6.63398466e+02  2.80364471e+03  1.22768459e+04
  4.08939069e+04  1.04935116e+05  2.30117044e+05  4.55930947e+05
  8.44882444e+05  1.52805899e+06  2.85032552e+06  5.80821170e+06]
E1 = -706.6638263129919  E_coul = 198.68157793741446
Extra cycle  E= -507.982248375577  delta_E= -5.12e-13  |g|= 7.17e-09  |ddm|= 1.13e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.41257914e-01 6.34214857e-01 1.17616814e+05 2.76349707e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314013e+03 1.83757988e+04
 1.44909318e+03 3.76232158e+02 1.15081181e+02 4.04483931e+01
 1.30218008e+01 6.38679643e+00 8.60383172e+00 4.92732273e-01]
E = -507.98224837557746
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:11:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.24125791388        1
[INPUT] 0    0    [1    /1   ]  0.634214857175       1
[INPUT] 0    0    [1    /1   ]  117616.813851        1
[INPUT] 0    0    [1    /1   ]  2.76349706979        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991909        1
[INPUT] 0    0    [1    /1   ]  73510.4199794        1
[INPUT] 0    0    [1    /1   ]  36754.7147049        1
[INPUT] 0    0    [1    /1   ]  7303.14013323        1
[INPUT] 0    0    [1    /1   ]  18375.7987688        1
[INPUT] 0    0    [1    /1   ]  1449.09318372        1
[INPUT] 0    0    [1    /1   ]  376.232158011        1
[INPUT] 0    0    [1    /1   ]  115.081180605        1
[INPUT] 0    0    [1    /1   ]  40.4483931439        1
[INPUT] 0    0    [1    /1   ]  13.0218008305        1
[INPUT] 0    0    [1    /1   ]  6.38679642623        1
[INPUT] 1    0    [1    /1   ]  8.6038317194         1
[INPUT] 1    0    [1    /1   ]  0.492732273284       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24125791387999782, 1.0]], [0, [0.634214857174885, 1.0]], [0, [117616.81385071411, 1.0]], [0, [2.763497069787589, 1.0]], [0, [1176168.1426171598, 1.0]], [0, [588084.0699820385, 1.0]], [0, [294042.03107103123, 1.0]], [0, [147020.99190918365, 1.0]], [0, [73510.4199794453, 1.0]], [0, [36754.71470488852, 1.0]], [0, [7303.140133233916, 1.0]], [0, [18375.79876880206, 1.0]], [0, [1449.093183716284, 1.0]], [0, [376.2321580109682, 1.0]], [0, [115.08118060454132, 1.0]], [0, [40.44839314389183, 1.0]], [0, [13.021800830547406, 1.0]], [0, [6.386796426234294, 1.0]], [1, [8.603831719401324, 1.0]], [1, [0.4927322732842889, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24125791]
bas 1, expnt(s) = [0.63421486]
bas 2, expnt(s) = [117616.81385071]
bas 3, expnt(s) = [2.76349707]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998204]
bas 6, expnt(s) = [294042.03107103]
bas 7, expnt(s) = [147020.99190918]
bas 8, expnt(s) = [73510.41997945]
bas 9, expnt(s) = [36754.71470489]
bas 10, expnt(s) = [7303.14013323]
bas 11, expnt(s) = [18375.7987688]
bas 12, expnt(s) = [1449.09318372]
bas 13, expnt(s) = [376.23215801]
bas 14, expnt(s) = [115.0811806]
bas 15, expnt(s) = [40.44839314]
bas 16, expnt(s) = [13.02180083]
bas 17, expnt(s) = [6.38679643]
bas 18, expnt(s) = [8.60383172]
bas 19, expnt(s) = [0.49273227]
CPU time:       586.90
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.41257914e-01 8.69713478e-01 6.34214857e-01 1.79552862e+00
 1.17616814e+05 1.60460109e+04 2.76349707e+00 5.41513491e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314013e+03 1.99593893e+03 1.83757988e+04 3.98749080e+03
 1.44909318e+03 5.93385951e+02 3.76232158e+02 2.15827589e+02
 1.15081181e+02 8.87704161e+01 4.04483931e+01 4.05220100e+01
 1.30218008e+01 1.73188205e+01 6.38679643e+00 1.01502638e+01
 8.60383172e+00 4.29882016e+01 4.92732273e-01 1.20433735e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33601600244735
cond(S) = 908494.006869613
E1 = -689.5845340544445  E_coul = 184.96673227089525
init E= -504.617801783549
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672238892424427  LUMO = 0.641194062804012
  mo_energy =
[-1.21706841e+02 -1.33863418e+01 -7.62394319e+00 -7.62394319e+00
 -7.62394319e+00 -1.65738749e+00 -6.72238892e-01 -6.72238892e-01
 -6.72238892e-01  6.41194063e-01  8.00170070e+00  3.86161443e+01
  1.60174199e+02  6.62038098e+02  2.80236067e+03  1.22756816e+04
  4.08928132e+04  1.04934060e+05  2.30116014e+05  4.55929934e+05
  8.44881445e+05  1.52805800e+06  2.85032454e+06  5.80821073e+06]
E1 = -707.7331637455671  E_coul = 199.76881382633889
cycle= 1 E= -507.964349919228  delta_E= -3.35  |g|= 0.451  |ddm|= 0.499
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.688725
diis-c [-0.47434278  1.        ]
  HOMO = -0.217800569027572  LUMO = 1.01808859696589
  mo_energy =
[-1.20198528e+02 -1.23053859e+01 -6.59502090e+00 -6.59502090e+00
 -6.59502090e+00 -1.16331481e+00 -2.17800569e-01 -2.17800569e-01
 -2.17800569e-01  1.01808860e+00  8.77811075e+00  3.97406246e+01
  1.61579781e+02  6.63528324e+02  2.80379152e+03  1.22770034e+04
  4.08940684e+04  1.04935279e+05  2.30117208e+05  4.55931111e+05
  8.44882609e+05  1.52805916e+06  2.85032568e+06  5.80821186e+06]
E1 = -706.7870643808341  E_coul = 198.80508017962106
cycle= 2 E= -507.981984201213  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.426
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0301661
diis-c [-9.07645896e-04 -2.23091863e-03  1.00223092e+00]
  HOMO = -0.239826644368125  LUMO = 1.01287204677688
  mo_energy =
[-1.20312389e+02 -1.23724413e+01 -6.66928092e+00 -6.66928092e+00
 -6.66928092e+00 -1.17749033e+00 -2.39826644e-01 -2.39826644e-01
 -2.39826644e-01  1.01287205e+00  8.73825033e+00  3.96704121e+01
  1.61482540e+02  6.63410668e+02  2.80365773e+03  1.22768594e+04
  4.08939205e+04  1.04935129e+05  2.30117058e+05  4.55930961e+05
  8.44882458e+05  1.52805900e+06  2.85032553e+06  5.80821171e+06]
E1 = -706.6795899706698  E_coul = 198.6973464153069
cycle= 3 E= -507.982243555363  delta_E= -0.000259  |g|= 0.00433  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00326223
diis-c [-2.39334974e-06  6.95759108e-05 -1.05525970e-01  1.10545639e+00]
  HOMO = -0.242947440584523  LUMO = 1.0118970218912
  mo_energy =
[-1.20324095e+02 -1.23809535e+01 -6.67827668e+00 -6.67827668e+00
 -6.67827668e+00 -1.17937899e+00 -2.42947441e-01 -2.42947441e-01
 -2.42947441e-01  1.01189702e+00  8.73263036e+00  3.96618273e+01
  1.61471930e+02  6.63398823e+02  2.80364508e+03  1.22768463e+04
  4.08939073e+04  1.04935116e+05  2.30117044e+05  4.55930947e+05
  8.44882444e+05  1.52805899e+06  2.85032552e+06  5.80821170e+06]
E1 = -706.6645148079225  E_coul = 198.68226644333646
cycle= 4 E= -507.982248364586  delta_E= -4.81e-06  |g|= 0.000212  |ddm|= 0.00949
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000148705
diis-c [-1.68815562e-10 -7.41716401e-06  6.85159064e-03 -9.86521836e-02
  1.09180801e+00]
  HOMO = -0.243090466185516  LUMO = 1.01184502195862
  mo_energy =
[-1.20324448e+02 -1.23812933e+01 -6.67861369e+00 -6.67861369e+00
 -6.67861369e+00 -1.17946468e+00 -2.43090466e-01 -2.43090466e-01
 -2.43090466e-01  1.01184502e+00  8.73237789e+00  3.96615013e+01
  1.61471583e+02  6.63398470e+02  2.80364472e+03  1.22768459e+04
  4.08939069e+04  1.04935116e+05  2.30117044e+05  4.55930947e+05
  8.44882444e+05  1.52805899e+06  2.85032552e+06  5.80821170e+06]
E1 = -706.6638318762293  E_coul = 198.68158350065312
cycle= 5 E= -507.982248375576  delta_E= -1.1e-08  |g|= 1.95e-06  |ddm|= 0.000501
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.68175e-07
diis-c [-1.87680463e-13  3.34726401e-07 -2.60147200e-04  3.50218879e-03
 -4.11233004e-02  1.03788092e+00]
  HOMO = -0.24309153236357  LUMO = 1.01184477411597
  mo_energy =
[-1.20324451e+02 -1.23812956e+01 -6.67861613e+00 -6.67861613e+00
 -6.67861613e+00 -1.17946547e+00 -2.43091532e-01 -2.43091532e-01
 -2.43091532e-01  1.01184477e+00  8.73237605e+00  3.96614990e+01
  1.61471581e+02  6.63398466e+02  2.80364471e+03  1.22768459e+04
  4.08939069e+04  1.04935116e+05  2.30117044e+05  4.55930947e+05
  8.44882444e+05  1.52805899e+06  2.85032552e+06  5.80821170e+06]
E1 = -706.663826441151  E_coul = 198.681578065574
cycle= 6 E= -507.982248375577  delta_E= -7.39e-13  |g|= 5.71e-08  |ddm|= 4.47e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.663826441151  E_coul = 198.681578065574
  HOMO = -0.243091560842612  LUMO = 1.01184475764714
  mo_energy =
[-1.20324451e+02 -1.23812957e+01 -6.67861619e+00 -6.67861619e+00
 -6.67861619e+00 -1.17946548e+00 -2.43091561e-01 -2.43091561e-01
 -2.43091561e-01  1.01184476e+00  8.73237600e+00  3.96614989e+01
  1.61471580e+02  6.63398466e+02  2.80364471e+03  1.22768459e+04
  4.08939069e+04  1.04935116e+05  2.30117044e+05  4.55930947e+05
  8.44882444e+05  1.52805899e+06  2.85032552e+06  5.80821170e+06]
E1 = -706.6638263129919  E_coul = 198.68157793741446
Extra cycle  E= -507.982248375577  delta_E= -5.12e-13  |g|= 7.17e-09  |ddm|= 1.13e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908494.006869613
E1 = -706.6638263129919  E_coul = 198.68157793741446
init E= -507.982248375577
    CPU time for initialize scf      3.30 sec, wall time      0.21 sec
  HOMO = -0.243091564814319  LUMO = 1.0118447570092
  mo_energy =
[-1.20324451e+02 -1.23812957e+01 -6.67861620e+00 -6.67861620e+00
 -6.67861620e+00 -1.17946549e+00 -2.43091565e-01 -2.43091565e-01
 -2.43091565e-01  1.01184476e+00  8.73237599e+00  3.96614989e+01
  1.61471580e+02  6.63398466e+02  2.80364471e+03  1.22768459e+04
  4.08939069e+04  1.04935116e+05  2.30117044e+05  4.55930947e+05
  8.44882444e+05  1.52805899e+06  2.85032552e+06  5.80821170e+06]
E1 = -706.6638262934623  E_coul = 198.68157791788502
cycle= 1 E= -507.982248375577  delta_E= 1.71e-13  |g|= 1.44e-09  |ddm|= 1.47e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6638262934623  E_coul = 198.68157791788502
  HOMO = -0.243091565397599  LUMO = 1.0118447562823
  mo_energy =
[-1.20324451e+02 -1.23812957e+01 -6.67861620e+00 -6.67861620e+00
 -6.67861620e+00 -1.17946549e+00 -2.43091565e-01 -2.43091565e-01
 -2.43091565e-01  1.01184476e+00  8.73237599e+00  3.96614989e+01
  1.61471580e+02  6.63398466e+02  2.80364471e+03  1.22768459e+04
  4.08939069e+04  1.04935116e+05  2.30117044e+05  4.55930947e+05
  8.44882444e+05  1.52805899e+06  2.85032552e+06  5.80821170e+06]
E1 = -706.6638262895308  E_coul = 198.681577913953
Extra cycle  E= -507.982248375578  delta_E= -5.12e-13  |g|= 1.23e-09  |ddm|= 2.66e-09
    CPU time for scf_cycle      3.76 sec, wall time      0.38 sec
exp = [2.41257914e-01 6.34214857e-01 1.17616814e+05 2.76349707e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314013e+03 1.83757988e+04
 1.44909318e+03 3.76232158e+02 1.15081181e+02 4.04483931e+01
 1.30218008e+01 6.38679643e+00 8.60383172e+00 4.92732273e-01]
grad_E = [-2.40237084e-03 -2.79557534e-05  4.47772353e-09  4.66040358e-04
  2.22600037e-11  1.22372692e-10  6.96405027e-10  2.73444577e-09
  1.13714351e-08  6.08180420e-08  3.84949416e-06  1.34209465e-07
 -7.31879028e-06  1.20985730e-04 -6.94878435e-04 -3.24931003e-04
 -5.42804811e-05  1.59265914e-04 -3.28918988e-04  1.01664984e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:11:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.240498333488       1
[INPUT] 0    0    [1    /1   ]  0.632998651158       1
[INPUT] 0    0    [1    /1   ]  117616.813851        1
[INPUT] 0    0    [1    /1   ]  2.76503680783        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991909        1
[INPUT] 0    0    [1    /1   ]  73510.4199791        1
[INPUT] 0    0    [1    /1   ]  36754.7147031        1
[INPUT] 0    0    [1    /1   ]  7303.14001787        1
[INPUT] 0    0    [1    /1   ]  18375.7987648        1
[INPUT] 0    0    [1    /1   ]  1449.09352981        1
[INPUT] 0    0    [1    /1   ]  376.226816709        1
[INPUT] 0    0    [1    /1   ]  115.112222746        1
[INPUT] 0    0    [1    /1   ]  40.4296709939        1
[INPUT] 0    0    [1    /1   ]  13.0279750921        1
[INPUT] 0    0    [1    /1   ]  6.39200709543        1
[INPUT] 1    0    [1    /1   ]  8.60246487275        1
[INPUT] 1    0    [1    /1   ]  0.492720865824       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24049833348811414, 1.0]], [0, [0.6329986511578598, 1.0]], [0, [117616.81385058003, 1.0]], [0, [2.7650368078326255, 1.0]], [0, [1176168.142617159, 1.0]], [0, [588084.0699820347, 1.0]], [0, [294042.0310710104, 1.0]], [0, [147020.99190910175, 1.0]], [0, [73510.41997910463, 1.0]], [0, [36754.71470306955, 1.0]], [0, [7303.140017872008, 1.0]], [0, [18375.79876475781, 1.0]], [0, [1449.0935298125125, 1.0]], [0, [376.22681670910583, 1.0]], [0, [115.11222274635092, 1.0]], [0, [40.42967099387382, 1.0]], [0, [13.027975092058137, 1.0]], [0, [6.392007095430391, 1.0]], [1, [8.602464872751614, 1.0]], [1, [0.4927208658237368, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24049833]
bas 1, expnt(s) = [0.63299865]
bas 2, expnt(s) = [117616.81385058]
bas 3, expnt(s) = [2.76503681]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998203]
bas 6, expnt(s) = [294042.03107101]
bas 7, expnt(s) = [147020.9919091]
bas 8, expnt(s) = [73510.4199791]
bas 9, expnt(s) = [36754.71470307]
bas 10, expnt(s) = [7303.14001787]
bas 11, expnt(s) = [18375.79876476]
bas 12, expnt(s) = [1449.09352981]
bas 13, expnt(s) = [376.22681671]
bas 14, expnt(s) = [115.11222275]
bas 15, expnt(s) = [40.42967099]
bas 16, expnt(s) = [13.02797509]
bas 17, expnt(s) = [6.3920071]
bas 18, expnt(s) = [8.60246487]
bas 19, expnt(s) = [0.49272087]
CPU time:       598.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.40498333e-01 8.67659004e-01 6.32998651e-01 1.79294560e+00
 1.17616814e+05 1.60460109e+04 2.76503681e+00 5.41739761e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314002e+03 1.99593891e+03 1.83757988e+04 3.98749080e+03
 1.44909353e+03 5.93386057e+02 3.76226817e+02 2.15825291e+02
 1.15112223e+02 8.87883743e+01 4.04296710e+01 4.05079420e+01
 1.30279751e+01 1.73249789e+01 6.39200710e+00 1.01564740e+01
 8.60246487e+00 4.29796651e+01 4.92720866e-01 1.20430249e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336043567724722
cond(S) = 908494.6445810263
E1 = -689.578691048801  E_coul = 184.96040196284378
init E= -504.618289085957
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672232401377369  LUMO = 0.637827608591934
  mo_energy =
[-1.21708157e+02 -1.33868361e+01 -7.62438810e+00 -7.62438810e+00
 -7.62438810e+00 -1.65741540e+00 -6.72232401e-01 -6.72232401e-01
 -6.72232401e-01  6.37827609e-01  7.99842304e+00  3.86322733e+01
  1.60193671e+02  6.62086022e+02  2.80242657e+03  1.22757423e+04
  4.08928697e+04  1.04934114e+05  2.30116066e+05  4.55929986e+05
  8.44881496e+05  1.52805805e+06  2.85032459e+06  5.80821077e+06]
E1 = -707.7257138132836  E_coul = 199.7613546483555
cycle= 1 E= -507.964359164928  delta_E= -3.35  |g|= 0.451  |ddm|= 0.498
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.688805
diis-c [-0.47445276  1.        ]
  HOMO = -0.217831614576751  LUMO = 1.01417048390383
  mo_energy =
[-1.20199963e+02 -1.23059490e+01 -6.59555122e+00 -6.59555122e+00
 -6.59555122e+00 -1.16336710e+00 -2.17831615e-01 -2.17831615e-01
 -2.17831615e-01  1.01417048e+00  8.77500436e+00  3.97568287e+01
  1.61599140e+02  6.63576126e+02  2.80385732e+03  1.22770640e+04
  4.08941247e+04  1.04935333e+05  2.30117260e+05  4.55931163e+05
  8.44882659e+05  1.52805921e+06  2.85032573e+06  5.80821191e+06]
E1 = -706.7795217231734  E_coul = 198.79752787300146
cycle= 2 E= -507.981993850172  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.426
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0301908
diis-c [-9.09088937e-04 -2.25430751e-03  1.00225431e+00]
  HOMO = -0.239867006304507  LUMO = 1.00897118309496
  mo_energy =
[-1.20313823e+02 -1.23730127e+01 -6.66981624e+00 -6.66981624e+00
 -6.66981624e+00 -1.17755081e+00 -2.39867006e-01 -2.39867006e-01
 -2.39867006e-01  1.00897118e+00  8.73512840e+00  3.96865974e+01
  1.61501897e+02  6.63458470e+02  2.80372353e+03  1.22769200e+04
  4.08939769e+04  1.04935183e+05  2.30117110e+05  4.55931012e+05
  8.44882508e+05  1.52805905e+06  2.85032558e+06  5.80821176e+06]
E1 = -706.671943758694  E_coul = 198.68969010603797
cycle= 3 E= -507.982253652656  delta_E= -0.00026  |g|= 0.00434  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00326758
diis-c [-2.39953528e-06  6.87999592e-05 -1.05632588e-01  1.10556379e+00]
  HOMO = -0.242992127737482  LUMO = 1.00799759305535
  mo_energy =
[-1.20325536e+02 -1.23815324e+01 -6.67881925e+00 -6.67881925e+00
 -6.67881925e+00 -1.17944241e+00 -2.42992128e-01 -2.42992128e-01
 -2.42992128e-01  1.00799759e+00  8.72950102e+00  3.96780042e+01
  1.61491280e+02  6.63446618e+02  2.80371087e+03  1.22769068e+04
  4.08939636e+04  1.04935170e+05  2.30117097e+05  4.55930999e+05
  8.44882495e+05  1.52805904e+06  2.85032557e+06  5.80821174e+06]
E1 = -706.6568402442934  E_coul = 198.67458176546558
cycle= 4 E= -507.982258478828  delta_E= -4.83e-06  |g|= 0.000212  |ddm|= 0.0095
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000149005
diis-c [-1.70283829e-10 -7.44214824e-06  6.85806672e-03 -9.86928635e-02
  1.09184224e+00]
  HOMO = -0.243135463635964  LUMO = 1.00794560580512
  mo_energy =
[-1.20325889e+02 -1.23818726e+01 -6.67915672e+00 -6.67915672e+00
 -6.67915672e+00 -1.17952829e+00 -2.43135464e-01 -2.43135464e-01
 -2.43135464e-01  1.00794561e+00  8.72924802e+00  3.96776778e+01
  1.61490933e+02  6.63446264e+02  2.80371052e+03  1.22769065e+04
  4.08939632e+04  1.04935170e+05  2.30117096e+05  4.55930998e+05
  8.44882494e+05  1.52805904e+06  2.85032557e+06  5.80821174e+06]
E1 = -706.6561554373219  E_coul = 198.67389694744497
cycle= 5 E= -507.982258489877  delta_E= -1.1e-08  |g|= 1.96e-06  |ddm|= 0.000502
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.73605e-07
diis-c [-1.89880346e-13  3.27223767e-07 -2.61481427e-04  3.52079245e-03
 -4.13487055e-02  1.03808907e+00]
  HOMO = -0.243136535904895  LUMO = 1.00794535902823
  mo_energy =
[-1.20325892e+02 -1.23818750e+01 -6.67915917e+00 -6.67915917e+00
 -6.67915917e+00 -1.17952909e+00 -2.43136536e-01 -2.43136536e-01
 -2.43136536e-01  1.00794536e+00  8.72924617e+00  3.96776754e+01
  1.61490930e+02  6.63446261e+02  2.80371051e+03  1.22769065e+04
  4.08939632e+04  1.04935170e+05  2.30117096e+05  4.55930998e+05
  8.44882494e+05  1.52805904e+06  2.85032557e+06  5.80821174e+06]
E1 = -706.6561499631151  E_coul = 198.67389147323735
cycle= 6 E= -507.982258489878  delta_E= -8.53e-13  |g|= 5.7e-08  |ddm|= 4.49e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6561499631151  E_coul = 198.67389147323735
  HOMO = -0.243136564391151  LUMO = 1.00794534117498
  mo_energy =
[-1.20325892e+02 -1.23818751e+01 -6.67915923e+00 -6.67915923e+00
 -6.67915923e+00 -1.17952910e+00 -2.43136564e-01 -2.43136564e-01
 -2.43136564e-01  1.00794534e+00  8.72924611e+00  3.96776754e+01
  1.61490930e+02  6.63446261e+02  2.80371051e+03  1.22769065e+04
  4.08939632e+04  1.04935170e+05  2.30117096e+05  4.55930998e+05
  8.44882494e+05  1.52805904e+06  2.85032557e+06  5.80821174e+06]
E1 = -706.6561498372232  E_coul = 198.67389134734503
Extra cycle  E= -507.982258489878  delta_E= -3.98e-13  |g|= 7.76e-09  |ddm|= 1.11e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.40498333e-01 6.32998651e-01 1.17616814e+05 2.76503681e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314002e+03 1.83757988e+04
 1.44909353e+03 3.76226817e+02 1.15112223e+02 4.04296710e+01
 1.30279751e+01 6.39200710e+00 8.60246487e+00 4.92720866e-01]
E = -507.9822584898782
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:11:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.240498333488       1
[INPUT] 0    0    [1    /1   ]  0.632998651158       1
[INPUT] 0    0    [1    /1   ]  117616.813851        1
[INPUT] 0    0    [1    /1   ]  2.76503680783        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991909        1
[INPUT] 0    0    [1    /1   ]  73510.4199791        1
[INPUT] 0    0    [1    /1   ]  36754.7147031        1
[INPUT] 0    0    [1    /1   ]  7303.14001787        1
[INPUT] 0    0    [1    /1   ]  18375.7987648        1
[INPUT] 0    0    [1    /1   ]  1449.09352981        1
[INPUT] 0    0    [1    /1   ]  376.226816709        1
[INPUT] 0    0    [1    /1   ]  115.112222746        1
[INPUT] 0    0    [1    /1   ]  40.4296709939        1
[INPUT] 0    0    [1    /1   ]  13.0279750921        1
[INPUT] 0    0    [1    /1   ]  6.39200709543        1
[INPUT] 1    0    [1    /1   ]  8.60246487275        1
[INPUT] 1    0    [1    /1   ]  0.492720865824       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24049833348811414, 1.0]], [0, [0.6329986511578598, 1.0]], [0, [117616.81385058003, 1.0]], [0, [2.7650368078326255, 1.0]], [0, [1176168.142617159, 1.0]], [0, [588084.0699820347, 1.0]], [0, [294042.0310710104, 1.0]], [0, [147020.99190910175, 1.0]], [0, [73510.41997910463, 1.0]], [0, [36754.71470306955, 1.0]], [0, [7303.140017872008, 1.0]], [0, [18375.79876475781, 1.0]], [0, [1449.0935298125125, 1.0]], [0, [376.22681670910583, 1.0]], [0, [115.11222274635092, 1.0]], [0, [40.42967099387382, 1.0]], [0, [13.027975092058137, 1.0]], [0, [6.392007095430391, 1.0]], [1, [8.602464872751614, 1.0]], [1, [0.4927208658237368, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24049833]
bas 1, expnt(s) = [0.63299865]
bas 2, expnt(s) = [117616.81385058]
bas 3, expnt(s) = [2.76503681]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998203]
bas 6, expnt(s) = [294042.03107101]
bas 7, expnt(s) = [147020.9919091]
bas 8, expnt(s) = [73510.4199791]
bas 9, expnt(s) = [36754.71470307]
bas 10, expnt(s) = [7303.14001787]
bas 11, expnt(s) = [18375.79876476]
bas 12, expnt(s) = [1449.09352981]
bas 13, expnt(s) = [376.22681671]
bas 14, expnt(s) = [115.11222275]
bas 15, expnt(s) = [40.42967099]
bas 16, expnt(s) = [13.02797509]
bas 17, expnt(s) = [6.3920071]
bas 18, expnt(s) = [8.60246487]
bas 19, expnt(s) = [0.49272087]
CPU time:       599.92
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.40498333e-01 8.67659004e-01 6.32998651e-01 1.79294560e+00
 1.17616814e+05 1.60460109e+04 2.76503681e+00 5.41739761e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30314002e+03 1.99593891e+03 1.83757988e+04 3.98749080e+03
 1.44909353e+03 5.93386057e+02 3.76226817e+02 2.15825291e+02
 1.15112223e+02 8.87883743e+01 4.04296710e+01 4.05079420e+01
 1.30279751e+01 1.73249789e+01 6.39200710e+00 1.01564740e+01
 8.60246487e+00 4.29796651e+01 4.92720866e-01 1.20430249e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336043567724722
cond(S) = 908494.6445810263
E1 = -689.578691048801  E_coul = 184.96040196284378
init E= -504.618289085957
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672232401377369  LUMO = 0.637827608591934
  mo_energy =
[-1.21708157e+02 -1.33868361e+01 -7.62438810e+00 -7.62438810e+00
 -7.62438810e+00 -1.65741540e+00 -6.72232401e-01 -6.72232401e-01
 -6.72232401e-01  6.37827609e-01  7.99842304e+00  3.86322733e+01
  1.60193671e+02  6.62086022e+02  2.80242657e+03  1.22757423e+04
  4.08928697e+04  1.04934114e+05  2.30116066e+05  4.55929986e+05
  8.44881496e+05  1.52805805e+06  2.85032459e+06  5.80821077e+06]
E1 = -707.7257138132836  E_coul = 199.7613546483555
cycle= 1 E= -507.964359164928  delta_E= -3.35  |g|= 0.451  |ddm|= 0.498
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.688805
diis-c [-0.47445276  1.        ]
  HOMO = -0.217831614576751  LUMO = 1.01417048390383
  mo_energy =
[-1.20199963e+02 -1.23059490e+01 -6.59555122e+00 -6.59555122e+00
 -6.59555122e+00 -1.16336710e+00 -2.17831615e-01 -2.17831615e-01
 -2.17831615e-01  1.01417048e+00  8.77500436e+00  3.97568287e+01
  1.61599140e+02  6.63576126e+02  2.80385732e+03  1.22770640e+04
  4.08941247e+04  1.04935333e+05  2.30117260e+05  4.55931163e+05
  8.44882659e+05  1.52805921e+06  2.85032573e+06  5.80821191e+06]
E1 = -706.7795217231734  E_coul = 198.79752787300146
cycle= 2 E= -507.981993850172  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.426
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0301908
diis-c [-9.09088937e-04 -2.25430751e-03  1.00225431e+00]
  HOMO = -0.239867006304507  LUMO = 1.00897118309496
  mo_energy =
[-1.20313823e+02 -1.23730127e+01 -6.66981624e+00 -6.66981624e+00
 -6.66981624e+00 -1.17755081e+00 -2.39867006e-01 -2.39867006e-01
 -2.39867006e-01  1.00897118e+00  8.73512840e+00  3.96865974e+01
  1.61501897e+02  6.63458470e+02  2.80372353e+03  1.22769200e+04
  4.08939769e+04  1.04935183e+05  2.30117110e+05  4.55931012e+05
  8.44882508e+05  1.52805905e+06  2.85032558e+06  5.80821176e+06]
E1 = -706.671943758694  E_coul = 198.68969010603797
cycle= 3 E= -507.982253652656  delta_E= -0.00026  |g|= 0.00434  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00326758
diis-c [-2.39953528e-06  6.87999592e-05 -1.05632588e-01  1.10556379e+00]
  HOMO = -0.242992127737482  LUMO = 1.00799759305535
  mo_energy =
[-1.20325536e+02 -1.23815324e+01 -6.67881925e+00 -6.67881925e+00
 -6.67881925e+00 -1.17944241e+00 -2.42992128e-01 -2.42992128e-01
 -2.42992128e-01  1.00799759e+00  8.72950102e+00  3.96780042e+01
  1.61491280e+02  6.63446618e+02  2.80371087e+03  1.22769068e+04
  4.08939636e+04  1.04935170e+05  2.30117097e+05  4.55930999e+05
  8.44882495e+05  1.52805904e+06  2.85032557e+06  5.80821174e+06]
E1 = -706.6568402442934  E_coul = 198.67458176546558
cycle= 4 E= -507.982258478828  delta_E= -4.83e-06  |g|= 0.000212  |ddm|= 0.0095
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000149005
diis-c [-1.70283829e-10 -7.44214824e-06  6.85806672e-03 -9.86928635e-02
  1.09184224e+00]
  HOMO = -0.243135463635964  LUMO = 1.00794560580512
  mo_energy =
[-1.20325889e+02 -1.23818726e+01 -6.67915672e+00 -6.67915672e+00
 -6.67915672e+00 -1.17952829e+00 -2.43135464e-01 -2.43135464e-01
 -2.43135464e-01  1.00794561e+00  8.72924802e+00  3.96776778e+01
  1.61490933e+02  6.63446264e+02  2.80371052e+03  1.22769065e+04
  4.08939632e+04  1.04935170e+05  2.30117096e+05  4.55930998e+05
  8.44882494e+05  1.52805904e+06  2.85032557e+06  5.80821174e+06]
E1 = -706.6561554373219  E_coul = 198.67389694744497
cycle= 5 E= -507.982258489877  delta_E= -1.1e-08  |g|= 1.96e-06  |ddm|= 0.000502
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.73605e-07
diis-c [-1.89880346e-13  3.27223767e-07 -2.61481427e-04  3.52079245e-03
 -4.13487055e-02  1.03808907e+00]
  HOMO = -0.243136535904895  LUMO = 1.00794535902823
  mo_energy =
[-1.20325892e+02 -1.23818750e+01 -6.67915917e+00 -6.67915917e+00
 -6.67915917e+00 -1.17952909e+00 -2.43136536e-01 -2.43136536e-01
 -2.43136536e-01  1.00794536e+00  8.72924617e+00  3.96776754e+01
  1.61490930e+02  6.63446261e+02  2.80371051e+03  1.22769065e+04
  4.08939632e+04  1.04935170e+05  2.30117096e+05  4.55930998e+05
  8.44882494e+05  1.52805904e+06  2.85032557e+06  5.80821174e+06]
E1 = -706.6561499631151  E_coul = 198.67389147323735
cycle= 6 E= -507.982258489878  delta_E= -8.53e-13  |g|= 5.7e-08  |ddm|= 4.49e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6561499631151  E_coul = 198.67389147323735
  HOMO = -0.243136564391151  LUMO = 1.00794534117498
  mo_energy =
[-1.20325892e+02 -1.23818751e+01 -6.67915923e+00 -6.67915923e+00
 -6.67915923e+00 -1.17952910e+00 -2.43136564e-01 -2.43136564e-01
 -2.43136564e-01  1.00794534e+00  8.72924611e+00  3.96776754e+01
  1.61490930e+02  6.63446261e+02  2.80371051e+03  1.22769065e+04
  4.08939632e+04  1.04935170e+05  2.30117096e+05  4.55930998e+05
  8.44882494e+05  1.52805904e+06  2.85032557e+06  5.80821174e+06]
E1 = -706.6561498372232  E_coul = 198.67389134734503
Extra cycle  E= -507.982258489878  delta_E= -3.98e-13  |g|= 7.76e-09  |ddm|= 1.11e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908494.6445810263
E1 = -706.6561498372232  E_coul = 198.67389134734503
init E= -507.982258489878
    CPU time for initialize scf      3.38 sec, wall time      0.21 sec
  HOMO = -0.243136568301166  LUMO = 1.00794534197285
  mo_energy =
[-1.20325892e+02 -1.23818751e+01 -6.67915924e+00 -6.67915924e+00
 -6.67915924e+00 -1.17952910e+00 -2.43136568e-01 -2.43136568e-01
 -2.43136568e-01  1.00794534e+00  8.72924611e+00  3.96776754e+01
  1.61490930e+02  6.63446261e+02  2.80371051e+03  1.22769065e+04
  4.08939632e+04  1.04935170e+05  2.30117096e+05  4.55930998e+05
  8.44882494e+05  1.52805904e+06  2.85032557e+06  5.80821174e+06]
E1 = -706.6561498141979  E_coul = 198.67389132432004
cycle= 1 E= -507.982258489878  delta_E= 3.41e-13  |g|= 2.15e-09  |ddm|= 1.68e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6561498141979  E_coul = 198.67389132432004
  HOMO = -0.243136568975712  LUMO = 1.00794534085935
  mo_energy =
[-1.20325892e+02 -1.23818751e+01 -6.67915924e+00 -6.67915924e+00
 -6.67915924e+00 -1.17952910e+00 -2.43136569e-01 -2.43136569e-01
 -2.43136569e-01  1.00794534e+00  8.72924611e+00  3.96776754e+01
  1.61490930e+02  6.63446261e+02  2.80371051e+03  1.22769065e+04
  4.08939632e+04  1.04935170e+05  2.30117096e+05  4.55930998e+05
  8.44882494e+05  1.52805904e+06  2.85032557e+06  5.80821174e+06]
E1 = -706.6561498097603  E_coul = 198.67389131988296
Extra cycle  E= -507.982258489877  delta_E= 4.55e-13  |g|= 1.2e-09  |ddm|= 3.09e-09
    CPU time for scf_cycle      3.84 sec, wall time      0.38 sec
exp = [2.40498333e-01 6.32998651e-01 1.17616814e+05 2.76503681e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30314002e+03 1.83757988e+04
 1.44909353e+03 3.76226817e+02 1.15112223e+02 4.04296710e+01
 1.30279751e+01 6.39200710e+00 8.60246487e+00 4.92720866e-01]
grad_E = [-3.44097071e-03  2.14903179e-04  4.46439776e-09  4.37344431e-04
  2.21033328e-11  1.21939143e-10  6.94346041e-10  2.72620679e-09
  1.13366802e-08  6.06473738e-08  3.83753857e-06  1.33683030e-07
 -6.66600034e-06  1.12323975e-04 -6.51652079e-04 -3.98191611e-04
 -4.31011755e-05  1.94231157e-04 -1.46500495e-03  9.58261405e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:11:58 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.239562525538       1
[INPUT] 0    0    [1    /1   ]  0.631491632342       1
[INPUT] 0    0    [1    /1   ]  117616.81385         1
[INPUT] 0    0    [1    /1   ]  2.77145898822        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991909        1
[INPUT] 0    0    [1    /1   ]  73510.419978         1
[INPUT] 0    0    [1    /1   ]  36754.7146974        1
[INPUT] 0    0    [1    /1   ]  7303.13965801        1
[INPUT] 0    0    [1    /1   ]  18375.7987522        1
[INPUT] 0    0    [1    /1   ]  1449.09429104        1
[INPUT] 0    0    [1    /1   ]  376.214886407        1
[INPUT] 0    0    [1    /1   ]  115.178929838        1
[INPUT] 0    0    [1    /1   ]  40.4225149466        1
[INPUT] 0    0    [1    /1   ]  13.0709274626        1
[INPUT] 0    0    [1    /1   ]  6.41571087185        1
[INPUT] 1    0    [1    /1   ]  8.60036384785        1
[INPUT] 1    0    [1    /1   ]  0.492702207793       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.23956252553840765, 1.0]], [0, [0.6314916323420634, 1.0]], [0, [117616.81385016144, 1.0]], [0, [2.771458988217731, 1.0]], [0, [1176168.142617157, 1.0]], [0, [588084.0699820233, 1.0]], [0, [294042.0310709453, 1.0]], [0, [147020.9919088461, 1.0]], [0, [73510.41997804145, 1.0]], [0, [36754.71469738583, 1.0]], [0, [7303.139658013208, 1.0]], [0, [18375.798752190938, 1.0]], [0, [1449.0942910368494, 1.0]], [0, [376.21488640734543, 1.0]], [0, [115.17892983811257, 1.0]], [0, [40.42251494663105, 1.0]], [0, [13.070927462554211, 1.0]], [0, [6.415710871853566, 1.0]], [1, [8.600363847845301, 1.0]], [1, [0.49270220779280083, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23956253]
bas 1, expnt(s) = [0.63149163]
bas 2, expnt(s) = [117616.81385016]
bas 3, expnt(s) = [2.77145899]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998202]
bas 6, expnt(s) = [294042.03107095]
bas 7, expnt(s) = [147020.99190885]
bas 8, expnt(s) = [73510.41997804]
bas 9, expnt(s) = [36754.71469739]
bas 10, expnt(s) = [7303.13965801]
bas 11, expnt(s) = [18375.79875219]
bas 12, expnt(s) = [1449.09429104]
bas 13, expnt(s) = [376.21488641]
bas 14, expnt(s) = [115.17892984]
bas 15, expnt(s) = [40.42251495]
bas 16, expnt(s) = [13.07092746]
bas 17, expnt(s) = [6.41571087]
bas 18, expnt(s) = [8.60036385]
bas 19, expnt(s) = [0.49270221]
CPU time:       611.66
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.39562526e-01 8.65125646e-01 6.31491632e-01 1.78974321e+00
 1.17616814e+05 1.60460109e+04 2.77145899e+00 5.42683187e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30313966e+03 1.99593884e+03 1.83757988e+04 3.98749080e+03
 1.44909429e+03 5.93386291e+02 3.76214886e+02 2.15820158e+02
 1.15178930e+02 8.88269609e+01 4.04225149e+01 4.05025645e+01
 1.30709275e+01 1.73678007e+01 6.41571087e+00 1.01847087e+01
 8.60036385e+00 4.29665441e+01 4.92702208e-01 1.20424549e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336084316851057
cond(S) = 908499.7564209547
E1 = -689.569646912277  E_coul = 184.95059990376973
init E= -504.619047008507
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.67222479479932  LUMO = 0.633815537780112
  mo_energy =
[-1.21710193e+02 -1.33876015e+01 -7.62507641e+00 -7.62507641e+00
 -7.62507641e+00 -1.65746041e+00 -6.72224795e-01 -6.72224795e-01
 -6.72224795e-01  6.33815538e-01  8.01462677e+00  3.87686861e+01
  1.60478359e+02  6.62493269e+02  2.80285401e+03  1.22761249e+04
  4.08932247e+04  1.04934455e+05  2.30116397e+05  4.55930309e+05
  8.44881814e+05  1.52805837e+06  2.85032490e+06  5.80821107e+06]
E1 = -707.7142130717896  E_coul = 199.74982763590955
cycle= 1 E= -507.96438543588  delta_E= -3.35  |g|= 0.451  |ddm|= 0.498
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.689005
diis-c [-0.47472793  1.        ]
  HOMO = -0.217880322778155  LUMO = 1.00955177723529
  mo_energy =
[-1.20202181e+02 -1.23068198e+01 -6.59637084e+00 -6.59637084e+00
 -6.59637084e+00 -1.16344780e+00 -2.17880323e-01 -2.17880323e-01
 -2.17880323e-01  1.00955178e+00  8.79225634e+00  3.98940605e+01
  1.61883767e+02  6.63983179e+02  2.80428461e+03  1.22774465e+04
  4.08944796e+04  1.04935673e+05  2.30117591e+05  4.55931486e+05
  8.44882977e+05  1.52805952e+06  2.85032604e+06  5.80821221e+06]
E1 = -706.7680212350895  E_coul = 198.78600343436113
cycle= 2 E= -507.982017800728  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.426
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.030219
diis-c [-9.10759950e-04 -2.26902806e-03  1.00226903e+00]
  HOMO = -0.239925264808391  LUMO = 1.00436911235184
  mo_energy =
[-1.20316024e+02 -1.23738842e+01 -6.67063088e+00 -6.67063088e+00
 -6.67063088e+00 -1.17764078e+00 -2.39925265e-01 -2.39925265e-01
 -2.39925265e-01  1.00436911e+00  8.75230399e+00  3.98237554e+01
  1.61786521e+02  6.63865540e+02  2.80415085e+03  1.22773025e+04
  4.08943318e+04  1.04935524e+05  2.30117441e+05  4.55931336e+05
  8.44882826e+05  1.52805937e+06  2.85032589e+06  5.80821206e+06]
E1 = -706.6603193510958  E_coul = 198.6780411892637
cycle= 3 E= -507.982278161832  delta_E= -0.00026  |g|= 0.00434  |ddm|= 0.0604
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00327385
diis-c [-2.40607157e-06  6.71941121e-05 -1.05764072e-01  1.10569688e+00]
  HOMO = -0.243056010552641  LUMO = 1.00339651484272
  mo_energy =
[-1.20327747e+02 -1.23824139e+01 -6.67964357e+00 -6.67964357e+00
 -6.67964357e+00 -1.17953624e+00 -2.43056011e-01 -2.43056011e-01
 -2.43056011e-01  1.00339651e+00  8.74665966e+00  3.98151460e+01
  1.61775893e+02  6.63853679e+02  2.80413818e+03  1.22772894e+04
  4.08943185e+04  1.04935510e+05  2.30117427e+05  4.55931322e+05
  8.44882813e+05  1.52805935e+06  2.85032587e+06  5.80821204e+06]
E1 = -706.6451788179687  E_coul = 198.66289580812614
cycle= 4 E= -507.982283009843  delta_E= -4.85e-06  |g|= 0.000213  |ddm|= 0.00952
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000149372
diis-c [-1.71444759e-10 -7.46135772e-06  6.86778992e-03 -9.87647581e-02
  1.09190443e+00]
  HOMO = -0.243199761669539  LUMO = 1.00334450663773
  mo_energy =
[-1.20328101e+02 -1.23827549e+01 -6.67998180e+00 -6.67998180e+00
 -6.67998180e+00 -1.17962238e+00 -2.43199762e-01 -2.43199762e-01
 -2.43199762e-01  1.00334451e+00  8.74640567e+00  3.98148187e+01
  1.61775545e+02  6.63853324e+02  2.80413782e+03  1.22772890e+04
  4.08943182e+04  1.04935510e+05  2.30117427e+05  4.55931322e+05
  8.44882813e+05  1.52805935e+06  2.85032587e+06  5.80821204e+06]
E1 = -706.6444915010928  E_coul = 198.66220848012907
cycle= 5 E= -507.982283020964  delta_E= -1.11e-08  |g|= 1.96e-06  |ddm|= 0.000503
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.7858e-07
diis-c [-1.89666969e-13  3.37555290e-07 -2.62025706e-04  3.52389032e-03
 -4.13597063e-02  1.03809750e+00]
  HOMO = -0.243200835634278  LUMO = 1.00334426175275
  mo_energy =
[-1.20328104e+02 -1.23827573e+01 -6.67998426e+00 -6.67998426e+00
 -6.67998426e+00 -1.17962318e+00 -2.43200836e-01 -2.43200836e-01
 -2.43200836e-01  1.00334426e+00  8.74640382e+00  3.98148163e+01
  1.61775542e+02  6.63853321e+02  2.80413781e+03  1.22772890e+04
  4.08943182e+04  1.04935510e+05  2.30117427e+05  4.55931322e+05
  8.44882813e+05  1.52805935e+06  2.85032587e+06  5.80821204e+06]
E1 = -706.6444860101757  E_coul = 198.66220298921155
cycle= 6 E= -507.982283020964  delta_E= -3.41e-13  |g|= 5.66e-08  |ddm|= 4.49e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6444860101757  E_coul = 198.66220298921155
  HOMO = -0.243200863936867  LUMO = 1.00334424649566
  mo_energy =
[-1.20328104e+02 -1.23827573e+01 -6.67998432e+00 -6.67998432e+00
 -6.67998432e+00 -1.17962319e+00 -2.43200864e-01 -2.43200864e-01
 -2.43200864e-01  1.00334425e+00  8.74640376e+00  3.98148163e+01
  1.61775542e+02  6.63853321e+02  2.80413781e+03  1.22772890e+04
  4.08943182e+04  1.04935510e+05  2.30117427e+05  4.55931322e+05
  8.44882813e+05  1.52805935e+06  2.85032587e+06  5.80821204e+06]
E1 = -706.6444858801315  E_coul = 198.66220285916782
Extra cycle  E= -507.982283020964  delta_E= 4.55e-13  |g|= 6.34e-09  |ddm|= 1.13e-07
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
exp = [2.39562526e-01 6.31491632e-01 1.17616814e+05 2.77145899e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30313966e+03 1.83757988e+04
 1.44909429e+03 3.76214886e+02 1.15178930e+02 4.04225149e+01
 1.30709275e+01 6.41571087e+00 8.60036385e+00 4.92702208e-01]
E = -507.9822830209637
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:11:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.239562525538       1
[INPUT] 0    0    [1    /1   ]  0.631491632342       1
[INPUT] 0    0    [1    /1   ]  117616.81385         1
[INPUT] 0    0    [1    /1   ]  2.77145898822        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991909        1
[INPUT] 0    0    [1    /1   ]  73510.419978         1
[INPUT] 0    0    [1    /1   ]  36754.7146974        1
[INPUT] 0    0    [1    /1   ]  7303.13965801        1
[INPUT] 0    0    [1    /1   ]  18375.7987522        1
[INPUT] 0    0    [1    /1   ]  1449.09429104        1
[INPUT] 0    0    [1    /1   ]  376.214886407        1
[INPUT] 0    0    [1    /1   ]  115.178929838        1
[INPUT] 0    0    [1    /1   ]  40.4225149466        1
[INPUT] 0    0    [1    /1   ]  13.0709274626        1
[INPUT] 0    0    [1    /1   ]  6.41571087185        1
[INPUT] 1    0    [1    /1   ]  8.60036384785        1
[INPUT] 1    0    [1    /1   ]  0.492702207793       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.23956252553840765, 1.0]], [0, [0.6314916323420634, 1.0]], [0, [117616.81385016144, 1.0]], [0, [2.771458988217731, 1.0]], [0, [1176168.142617157, 1.0]], [0, [588084.0699820233, 1.0]], [0, [294042.0310709453, 1.0]], [0, [147020.9919088461, 1.0]], [0, [73510.41997804145, 1.0]], [0, [36754.71469738583, 1.0]], [0, [7303.139658013208, 1.0]], [0, [18375.798752190938, 1.0]], [0, [1449.0942910368494, 1.0]], [0, [376.21488640734543, 1.0]], [0, [115.17892983811257, 1.0]], [0, [40.42251494663105, 1.0]], [0, [13.070927462554211, 1.0]], [0, [6.415710871853566, 1.0]], [1, [8.600363847845301, 1.0]], [1, [0.49270220779280083, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23956253]
bas 1, expnt(s) = [0.63149163]
bas 2, expnt(s) = [117616.81385016]
bas 3, expnt(s) = [2.77145899]
bas 4, expnt(s) = [1176168.14261716]
bas 5, expnt(s) = [588084.06998202]
bas 6, expnt(s) = [294042.03107095]
bas 7, expnt(s) = [147020.99190885]
bas 8, expnt(s) = [73510.41997804]
bas 9, expnt(s) = [36754.71469739]
bas 10, expnt(s) = [7303.13965801]
bas 11, expnt(s) = [18375.79875219]
bas 12, expnt(s) = [1449.09429104]
bas 13, expnt(s) = [376.21488641]
bas 14, expnt(s) = [115.17892984]
bas 15, expnt(s) = [40.42251495]
bas 16, expnt(s) = [13.07092746]
bas 17, expnt(s) = [6.41571087]
bas 18, expnt(s) = [8.60036385]
bas 19, expnt(s) = [0.49270221]
CPU time:       613.05
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.39562526e-01 8.65125646e-01 6.31491632e-01 1.78974321e+00
 1.17616814e+05 1.60460109e+04 2.77145899e+00 5.42683187e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30313966e+03 1.99593884e+03 1.83757988e+04 3.98749080e+03
 1.44909429e+03 5.93386291e+02 3.76214886e+02 2.15820158e+02
 1.15178930e+02 8.88269609e+01 4.04225149e+01 4.05025645e+01
 1.30709275e+01 1.73678007e+01 6.41571087e+00 1.01847087e+01
 8.60036385e+00 4.29665441e+01 4.92702208e-01 1.20424549e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336084316851057
cond(S) = 908499.7564209547
E1 = -689.569646912277  E_coul = 184.95059990376973
init E= -504.619047008507
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.67222479479932  LUMO = 0.633815537780112
  mo_energy =
[-1.21710193e+02 -1.33876015e+01 -7.62507641e+00 -7.62507641e+00
 -7.62507641e+00 -1.65746041e+00 -6.72224795e-01 -6.72224795e-01
 -6.72224795e-01  6.33815538e-01  8.01462677e+00  3.87686861e+01
  1.60478359e+02  6.62493269e+02  2.80285401e+03  1.22761249e+04
  4.08932247e+04  1.04934455e+05  2.30116397e+05  4.55930309e+05
  8.44881814e+05  1.52805837e+06  2.85032490e+06  5.80821107e+06]
E1 = -707.7142130717896  E_coul = 199.74982763590955
cycle= 1 E= -507.96438543588  delta_E= -3.35  |g|= 0.451  |ddm|= 0.498
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.689005
diis-c [-0.47472793  1.        ]
  HOMO = -0.217880322778155  LUMO = 1.00955177723529
  mo_energy =
[-1.20202181e+02 -1.23068198e+01 -6.59637084e+00 -6.59637084e+00
 -6.59637084e+00 -1.16344780e+00 -2.17880323e-01 -2.17880323e-01
 -2.17880323e-01  1.00955178e+00  8.79225634e+00  3.98940605e+01
  1.61883767e+02  6.63983179e+02  2.80428461e+03  1.22774465e+04
  4.08944796e+04  1.04935673e+05  2.30117591e+05  4.55931486e+05
  8.44882977e+05  1.52805952e+06  2.85032604e+06  5.80821221e+06]
E1 = -706.7680212350895  E_coul = 198.78600343436113
cycle= 2 E= -507.982017800728  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.426
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.030219
diis-c [-9.10759950e-04 -2.26902806e-03  1.00226903e+00]
  HOMO = -0.239925264808391  LUMO = 1.00436911235184
  mo_energy =
[-1.20316024e+02 -1.23738842e+01 -6.67063088e+00 -6.67063088e+00
 -6.67063088e+00 -1.17764078e+00 -2.39925265e-01 -2.39925265e-01
 -2.39925265e-01  1.00436911e+00  8.75230399e+00  3.98237554e+01
  1.61786521e+02  6.63865540e+02  2.80415085e+03  1.22773025e+04
  4.08943318e+04  1.04935524e+05  2.30117441e+05  4.55931336e+05
  8.44882826e+05  1.52805937e+06  2.85032589e+06  5.80821206e+06]
E1 = -706.6603193510958  E_coul = 198.6780411892637
cycle= 3 E= -507.982278161832  delta_E= -0.00026  |g|= 0.00434  |ddm|= 0.0604
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00327385
diis-c [-2.40607157e-06  6.71941121e-05 -1.05764072e-01  1.10569688e+00]
  HOMO = -0.243056010552641  LUMO = 1.00339651484272
  mo_energy =
[-1.20327747e+02 -1.23824139e+01 -6.67964357e+00 -6.67964357e+00
 -6.67964357e+00 -1.17953624e+00 -2.43056011e-01 -2.43056011e-01
 -2.43056011e-01  1.00339651e+00  8.74665966e+00  3.98151460e+01
  1.61775893e+02  6.63853679e+02  2.80413818e+03  1.22772894e+04
  4.08943185e+04  1.04935510e+05  2.30117427e+05  4.55931322e+05
  8.44882813e+05  1.52805935e+06  2.85032587e+06  5.80821204e+06]
E1 = -706.6451788179687  E_coul = 198.66289580812614
cycle= 4 E= -507.982283009843  delta_E= -4.85e-06  |g|= 0.000213  |ddm|= 0.00952
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000149372
diis-c [-1.71444759e-10 -7.46135772e-06  6.86778992e-03 -9.87647581e-02
  1.09190443e+00]
  HOMO = -0.243199761669539  LUMO = 1.00334450663773
  mo_energy =
[-1.20328101e+02 -1.23827549e+01 -6.67998180e+00 -6.67998180e+00
 -6.67998180e+00 -1.17962238e+00 -2.43199762e-01 -2.43199762e-01
 -2.43199762e-01  1.00334451e+00  8.74640567e+00  3.98148187e+01
  1.61775545e+02  6.63853324e+02  2.80413782e+03  1.22772890e+04
  4.08943182e+04  1.04935510e+05  2.30117427e+05  4.55931322e+05
  8.44882813e+05  1.52805935e+06  2.85032587e+06  5.80821204e+06]
E1 = -706.6444915010928  E_coul = 198.66220848012907
cycle= 5 E= -507.982283020964  delta_E= -1.11e-08  |g|= 1.96e-06  |ddm|= 0.000503
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.7858e-07
diis-c [-1.89666969e-13  3.37555290e-07 -2.62025706e-04  3.52389032e-03
 -4.13597063e-02  1.03809750e+00]
  HOMO = -0.243200835634278  LUMO = 1.00334426175275
  mo_energy =
[-1.20328104e+02 -1.23827573e+01 -6.67998426e+00 -6.67998426e+00
 -6.67998426e+00 -1.17962318e+00 -2.43200836e-01 -2.43200836e-01
 -2.43200836e-01  1.00334426e+00  8.74640382e+00  3.98148163e+01
  1.61775542e+02  6.63853321e+02  2.80413781e+03  1.22772890e+04
  4.08943182e+04  1.04935510e+05  2.30117427e+05  4.55931322e+05
  8.44882813e+05  1.52805935e+06  2.85032587e+06  5.80821204e+06]
E1 = -706.6444860101757  E_coul = 198.66220298921155
cycle= 6 E= -507.982283020964  delta_E= -3.41e-13  |g|= 5.66e-08  |ddm|= 4.49e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6444860101757  E_coul = 198.66220298921155
  HOMO = -0.243200863936867  LUMO = 1.00334424649566
  mo_energy =
[-1.20328104e+02 -1.23827573e+01 -6.67998432e+00 -6.67998432e+00
 -6.67998432e+00 -1.17962319e+00 -2.43200864e-01 -2.43200864e-01
 -2.43200864e-01  1.00334425e+00  8.74640376e+00  3.98148163e+01
  1.61775542e+02  6.63853321e+02  2.80413781e+03  1.22772890e+04
  4.08943182e+04  1.04935510e+05  2.30117427e+05  4.55931322e+05
  8.44882813e+05  1.52805935e+06  2.85032587e+06  5.80821204e+06]
E1 = -706.6444858801315  E_coul = 198.66220285916782
Extra cycle  E= -507.982283020964  delta_E= 4.55e-13  |g|= 6.34e-09  |ddm|= 1.13e-07
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908499.7564209547
E1 = -706.6444858801315  E_coul = 198.66220285916782
init E= -507.982283020964
    CPU time for initialize scf      3.28 sec, wall time      0.21 sec
  HOMO = -0.243200867961457  LUMO = 1.00334424433293
  mo_energy =
[-1.20328104e+02 -1.23827574e+01 -6.67998433e+00 -6.67998433e+00
 -6.67998433e+00 -1.17962319e+00 -2.43200868e-01 -2.43200868e-01
 -2.43200868e-01  1.00334424e+00  8.74640376e+00  3.98148162e+01
  1.61775542e+02  6.63853321e+02  2.80413781e+03  1.22772890e+04
  4.08943182e+04  1.04935510e+05  2.30117427e+05  4.55931322e+05
  8.44882813e+05  1.52805935e+06  2.85032587e+06  5.80821204e+06]
E1 = -706.6444858635595  E_coul = 198.66220284259546
cycle= 1 E= -507.982283020964  delta_E= -3.41e-13  |g|= 1.8e-09  |ddm|= 1.27e-08
    CPU time for cycle= 1      0.32 sec, wall time      0.03 sec
E1 = -706.6444858635595  E_coul = 198.66220284259546
  HOMO = -0.24320086846251  LUMO = 1.00334424350366
  mo_energy =
[-1.20328104e+02 -1.23827574e+01 -6.67998433e+00 -6.67998433e+00
 -6.67998433e+00 -1.17962319e+00 -2.43200868e-01 -2.43200868e-01
 -2.43200868e-01  1.00334424e+00  8.74640376e+00  3.98148162e+01
  1.61775542e+02  6.63853321e+02  2.80413781e+03  1.22772890e+04
  4.08943182e+04  1.04935510e+05  2.30117427e+05  4.55931322e+05
  8.44882813e+05  1.52805935e+06  2.85032587e+06  5.80821204e+06]
E1 = -706.6444858602431  E_coul = 198.66220283927908
Extra cycle  E= -507.982283020964  delta_E=    0  |g|= 7.73e-10  |ddm|= 2.28e-09
    CPU time for scf_cycle      3.74 sec, wall time      0.37 sec
exp = [2.39562526e-01 6.31491632e-01 1.17616814e+05 2.77145899e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30313966e+03 1.83757988e+04
 1.44909429e+03 3.76214886e+02 1.15178930e+02 4.04225149e+01
 1.30709275e+01 6.41571087e+00 8.60036385e+00 4.92702208e-01]
grad_E = [-4.77974202e-03  5.33521658e-04  4.44195226e-09  3.64449204e-04
  2.18392904e-11  1.21208973e-10  6.90877590e-10  2.71232963e-09
  1.12781440e-08  6.03598730e-08  3.81740478e-06  1.32796889e-07
 -5.57466299e-06  9.82549286e-05 -5.84983364e-04 -5.08080391e-04
 -2.55243752e-05  2.66570000e-04 -3.21058814e-03  2.26473601e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:12:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.238627413602       1
[INPUT] 0    0    [1    /1   ]  0.630248395197       1
[INPUT] 0    0    [1    /1   ]  117616.813849        1
[INPUT] 0    0    [1    /1   ]  2.78999279648        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991908        1
[INPUT] 0    0    [1    /1   ]  73510.4199751        1
[INPUT] 0    0    [1    /1   ]  36754.7146816        1
[INPUT] 0    0    [1    /1   ]  7303.13866111        1
[INPUT] 0    0    [1    /1   ]  18375.7987174        1
[INPUT] 0    0    [1    /1   ]  1449.09603791        1
[INPUT] 0    0    [1    /1   ]  376.187195467        1
[INPUT] 0    0    [1    /1   ]  115.329660014        1
[INPUT] 0    0    [1    /1   ]  40.4620377866        1
[INPUT] 0    0    [1    /1   ]  13.2156545368        1
[INPUT] 0    0    [1    /1   ]  6.48749267614        1
[INPUT] 1    0    [1    /1   ]  8.59731119512        1
[INPUT] 1    0    [1    /1   ]  0.492673249875       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.23862741360218864, 1.0]], [0, [0.6302483951972173, 1.0]], [0, [117616.81384900144, 1.0]], [0, [2.78999279647518, 1.0]], [0, [1176168.1426171511, 1.0]], [0, [588084.0699819917, 1.0]], [0, [294042.03107076493, 1.0]], [0, [147020.99190813772, 1.0]], [0, [73510.41997509563, 1.0]], [0, [36754.71468162947, 1.0]], [0, [7303.138661106256, 1.0]], [0, [18375.798717432972, 1.0]], [0, [1449.096037907735, 1.0]], [0, [376.1871954672421, 1.0]], [0, [115.32966001427857, 1.0]], [0, [40.462037786616214, 1.0]], [0, [13.21565453677579, 1.0]], [0, [6.487492676144691, 1.0]], [1, [8.597311195117527, 1.0]], [1, [0.49267324987538225, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23862741]
bas 1, expnt(s) = [0.6302484]
bas 2, expnt(s) = [117616.813849]
bas 3, expnt(s) = [2.7899928]
bas 4, expnt(s) = [1176168.14261715]
bas 5, expnt(s) = [588084.06998199]
bas 6, expnt(s) = [294042.03107076]
bas 7, expnt(s) = [147020.99190814]
bas 8, expnt(s) = [73510.4199751]
bas 9, expnt(s) = [36754.71468163]
bas 10, expnt(s) = [7303.13866111]
bas 11, expnt(s) = [18375.79871743]
bas 12, expnt(s) = [1449.09603791]
bas 13, expnt(s) = [376.18719547]
bas 14, expnt(s) = [115.32966001]
bas 15, expnt(s) = [40.46203779]
bas 16, expnt(s) = [13.21565454]
bas 17, expnt(s) = [6.48749268]
bas 18, expnt(s) = [8.5973112]
bas 19, expnt(s) = [0.49267325]
CPU time:       624.68
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.38627414e-01 8.62591700e-01 6.30248395e-01 1.78709992e+00
 1.17616814e+05 1.60460109e+04 2.78999280e+00 5.45402765e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30313866e+03 1.99593863e+03 1.83757987e+04 3.98749079e+03
 1.44909604e+03 5.93386827e+02 3.76187195e+02 2.15808244e+02
 1.15329660e+02 8.89141299e+01 4.04620378e+01 4.05322617e+01
 1.32156545e+01 1.75118300e+01 6.48749268e+00 1.02700530e+01
 8.59731120e+00 4.29474815e+01 4.92673250e-01 1.20415702e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336141206017892
cond(S) = 908517.3017507385
E1 = -689.5565785816787  E_coul = 184.9362997509999
init E= -504.620278830679
    CPU time for initialize scf      0.42 sec, wall time      0.06 sec
  HOMO = -0.672215157497331  LUMO = 0.63042584493627
  mo_energy =
[-1.21713178e+02 -1.33887165e+01 -7.62607915e+00 -7.62607915e+00
 -7.62607915e+00 -1.65752736e+00 -6.72215157e-01 -6.72215157e-01
 -6.72215157e-01  6.30425845e-01  8.08819379e+00  3.92341306e+01
  1.61505938e+02  6.63902217e+02  2.80428078e+03  1.22773969e+04
  4.08944046e+04  1.04935586e+05  2.30117496e+05  4.55931386e+05
  8.44882872e+05  1.52805941e+06  2.85032592e+06  5.80821207e+06]
E1 = -707.6974437168218  E_coul = 199.73299253024467
cycle= 1 E= -507.964451186577  delta_E= -3.34  |g|= 0.451  |ddm|= 0.497
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.689518
diis-c [-0.47543462  1.        ]
  HOMO = -0.217953570223783  LUMO = 1.00581134113005
  mo_energy =
[-1.20205430e+02 -1.23080907e+01 -6.59756709e+00 -6.59756709e+00
 -6.59756709e+00 -1.16356573e+00 -2.17953570e-01 -2.17953570e-01
 -2.17953570e-01  1.00581134e+00  8.86919004e+00  4.03623621e+01
  1.62911526e+02  6.65391832e+02  2.80571117e+03  1.22787182e+04
  4.08956593e+04  1.04936804e+05  2.30118690e+05  4.55932562e+05
  8.44884036e+05  1.52806056e+06  2.85032706e+06  5.80821320e+06]
E1 = -706.7514185744948  E_coul = 198.76934146089638
cycle= 2 E= -507.982077113598  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.427
    CPU time for cycle= 2      0.10 sec, wall time      0.03 sec
diis-norm(errvec)=0.0302455
diis-c [-9.12410432e-04 -2.24454559e-03  1.00224455e+00]
  HOMO = -0.24000738439321  LUMO = 1.0006290542737
  mo_energy =
[-1.20319226e+02 -1.23751404e+01 -6.67180293e+00 -6.67180293e+00
 -6.67180293e+00 -1.17776879e+00 -2.40007384e-01 -2.40007384e-01
 -2.40007384e-01  1.00062905e+00  8.82899357e+00  4.02918306e+01
  1.62814262e+02  6.65274241e+02  2.80557747e+03  1.22785743e+04
  4.08955116e+04  1.04936655e+05  2.30118540e+05  4.55932411e+05
  8.44883885e+05  1.52806041e+06  2.85032691e+06  5.80821305e+06]
E1 = -706.6435924037047  E_coul = 198.6612543381111
cycle= 3 E= -507.982338065594  delta_E= -0.000261  |g|= 0.00435  |ddm|= 0.0604
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00327977
diis-c [-2.40990653e-06  6.37935585e-05 -1.05899145e-01  1.10583535e+00]
  HOMO = -0.243144878602392  LUMO = 0.999654821185597
  mo_energy =
[-1.20330963e+02 -1.23836830e+01 -6.68082836e+00 -6.68082836e+00
 -6.68082836e+00 -1.17966893e+00 -2.43144879e-01 -2.43144879e-01
 -2.43144879e-01  9.99654821e-01  8.82331000e+00  4.02831873e+01
  1.62803616e+02  6.65262365e+02  2.80556478e+03  1.22785611e+04
  4.08954982e+04  1.04936641e+05  2.30118526e+05  4.55932398e+05
  8.44883871e+05  1.52806039e+06  2.85032689e+06  5.80821304e+06]
E1 = -706.6284095322935  E_coul = 198.6460665955124
cycle= 4 E= -507.982342936781  delta_E= -4.87e-06  |g|= 0.000213  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000149698
diis-c [-1.70364177e-10 -7.48912516e-06  6.88240011e-03 -9.88761515e-02
  1.09200124e+00]
  HOMO = -0.243289065100918  LUMO = 0.999602702999279
  mo_energy =
[-1.20331318e+02 -1.23840251e+01 -6.68116765e+00 -6.68116765e+00
 -6.68116765e+00 -1.17975533e+00 -2.43289065e-01 -2.43289065e-01
 -2.43289065e-01  9.99602703e-01  8.82305421e+00  4.02828587e+01
  1.62803267e+02  6.65262010e+02  2.80556442e+03  1.22785608e+04
  4.08954979e+04  1.04936641e+05  2.30118526e+05  4.55932398e+05
  8.44883871e+05  1.52806039e+06  2.85032689e+06  5.80821304e+06]
E1 = -706.6277196121666  E_coul = 198.6453766642139
cycle= 5 E= -507.982342947953  delta_E= -1.12e-08  |g|= 1.92e-06  |ddm|= 0.000503
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.66331e-07
diis-c [-1.84434273e-13  3.32664013e-07 -2.57062622e-04  3.44984049e-03
 -4.04544243e-02  1.03726131e+00]
  HOMO = -0.24329012218897  LUMO = 0.999602465240224
  mo_energy =
[-1.20331321e+02 -1.23840274e+01 -6.68117008e+00 -6.68117008e+00
 -6.68117008e+00 -1.17975612e+00 -2.43290122e-01 -2.43290122e-01
 -2.43290122e-01  9.99602465e-01  8.82305238e+00  4.02828563e+01
  1.62803264e+02  6.65262006e+02  2.80556442e+03  1.22785608e+04
  4.08954979e+04  1.04936641e+05  2.30118526e+05  4.55932398e+05
  8.44883871e+05  1.52806039e+06  2.85032689e+06  5.80821304e+06]
E1 = -706.6277141936491  E_coul = 198.6453712456955
cycle= 6 E= -507.982342947954  delta_E= -9.09e-13  |g|= 5.63e-08  |ddm|= 4.39e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6277141936491  E_coul = 198.6453712456955
  HOMO = -0.243290150185314  LUMO = 0.999602449820641
  mo_energy =
[-1.20331321e+02 -1.23840275e+01 -6.68117014e+00 -6.68117014e+00
 -6.68117014e+00 -1.17975614e+00 -2.43290150e-01 -2.43290150e-01
 -2.43290150e-01  9.99602450e-01  8.82305233e+00  4.02828563e+01
  1.62803264e+02  6.65262006e+02  2.80556442e+03  1.22785608e+04
  4.08954979e+04  1.04936641e+05  2.30118526e+05  4.55932398e+05
  8.44883871e+05  1.52806039e+06  2.85032689e+06  5.80821304e+06]
E1 = -706.6277140649518  E_coul = 198.64537111699883
Extra cycle  E= -507.982342947953  delta_E= 6.82e-13  |g|= 6.84e-09  |ddm|= 1.12e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.38627414e-01 6.30248395e-01 1.17616814e+05 2.78999280e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30313866e+03 1.83757987e+04
 1.44909604e+03 3.76187195e+02 1.15329660e+02 4.04620378e+01
 1.32156545e+01 6.48749268e+00 8.59731120e+00 4.92673250e-01]
E = -507.98234294795293
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:12:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.238627413602       1
[INPUT] 0    0    [1    /1   ]  0.630248395197       1
[INPUT] 0    0    [1    /1   ]  117616.813849        1
[INPUT] 0    0    [1    /1   ]  2.78999279648        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031071        1
[INPUT] 0    0    [1    /1   ]  147020.991908        1
[INPUT] 0    0    [1    /1   ]  73510.4199751        1
[INPUT] 0    0    [1    /1   ]  36754.7146816        1
[INPUT] 0    0    [1    /1   ]  7303.13866111        1
[INPUT] 0    0    [1    /1   ]  18375.7987174        1
[INPUT] 0    0    [1    /1   ]  1449.09603791        1
[INPUT] 0    0    [1    /1   ]  376.187195467        1
[INPUT] 0    0    [1    /1   ]  115.329660014        1
[INPUT] 0    0    [1    /1   ]  40.4620377866        1
[INPUT] 0    0    [1    /1   ]  13.2156545368        1
[INPUT] 0    0    [1    /1   ]  6.48749267614        1
[INPUT] 1    0    [1    /1   ]  8.59731119512        1
[INPUT] 1    0    [1    /1   ]  0.492673249875       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.23862741360218864, 1.0]], [0, [0.6302483951972173, 1.0]], [0, [117616.81384900144, 1.0]], [0, [2.78999279647518, 1.0]], [0, [1176168.1426171511, 1.0]], [0, [588084.0699819917, 1.0]], [0, [294042.03107076493, 1.0]], [0, [147020.99190813772, 1.0]], [0, [73510.41997509563, 1.0]], [0, [36754.71468162947, 1.0]], [0, [7303.138661106256, 1.0]], [0, [18375.798717432972, 1.0]], [0, [1449.096037907735, 1.0]], [0, [376.1871954672421, 1.0]], [0, [115.32966001427857, 1.0]], [0, [40.462037786616214, 1.0]], [0, [13.21565453677579, 1.0]], [0, [6.487492676144691, 1.0]], [1, [8.597311195117527, 1.0]], [1, [0.49267324987538225, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23862741]
bas 1, expnt(s) = [0.6302484]
bas 2, expnt(s) = [117616.813849]
bas 3, expnt(s) = [2.7899928]
bas 4, expnt(s) = [1176168.14261715]
bas 5, expnt(s) = [588084.06998199]
bas 6, expnt(s) = [294042.03107076]
bas 7, expnt(s) = [147020.99190814]
bas 8, expnt(s) = [73510.4199751]
bas 9, expnt(s) = [36754.71468163]
bas 10, expnt(s) = [7303.13866111]
bas 11, expnt(s) = [18375.79871743]
bas 12, expnt(s) = [1449.09603791]
bas 13, expnt(s) = [376.18719547]
bas 14, expnt(s) = [115.32966001]
bas 15, expnt(s) = [40.46203779]
bas 16, expnt(s) = [13.21565454]
bas 17, expnt(s) = [6.48749268]
bas 18, expnt(s) = [8.5973112]
bas 19, expnt(s) = [0.49267325]
CPU time:       626.08
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.38627414e-01 8.62591700e-01 6.30248395e-01 1.78709992e+00
 1.17616814e+05 1.60460109e+04 2.78999280e+00 5.45402765e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547147e+04 6.70656003e+03
 7.30313866e+03 1.99593863e+03 1.83757987e+04 3.98749079e+03
 1.44909604e+03 5.93386827e+02 3.76187195e+02 2.15808244e+02
 1.15329660e+02 8.89141299e+01 4.04620378e+01 4.05322617e+01
 1.32156545e+01 1.75118300e+01 6.48749268e+00 1.02700530e+01
 8.59731120e+00 4.29474815e+01 4.92673250e-01 1.20415702e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336141206017892
cond(S) = 908517.3017507385
E1 = -689.5565785816787  E_coul = 184.9362997509999
init E= -504.620278830679
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672215157497331  LUMO = 0.63042584493627
  mo_energy =
[-1.21713178e+02 -1.33887165e+01 -7.62607915e+00 -7.62607915e+00
 -7.62607915e+00 -1.65752736e+00 -6.72215157e-01 -6.72215157e-01
 -6.72215157e-01  6.30425845e-01  8.08819379e+00  3.92341306e+01
  1.61505938e+02  6.63902217e+02  2.80428078e+03  1.22773969e+04
  4.08944046e+04  1.04935586e+05  2.30117496e+05  4.55931386e+05
  8.44882872e+05  1.52805941e+06  2.85032592e+06  5.80821207e+06]
E1 = -707.6974437168218  E_coul = 199.73299253024467
cycle= 1 E= -507.964451186577  delta_E= -3.34  |g|= 0.451  |ddm|= 0.497
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.689518
diis-c [-0.47543462  1.        ]
  HOMO = -0.217953570223783  LUMO = 1.00581134113005
  mo_energy =
[-1.20205430e+02 -1.23080907e+01 -6.59756709e+00 -6.59756709e+00
 -6.59756709e+00 -1.16356573e+00 -2.17953570e-01 -2.17953570e-01
 -2.17953570e-01  1.00581134e+00  8.86919004e+00  4.03623621e+01
  1.62911526e+02  6.65391832e+02  2.80571117e+03  1.22787182e+04
  4.08956593e+04  1.04936804e+05  2.30118690e+05  4.55932562e+05
  8.44884036e+05  1.52806056e+06  2.85032706e+06  5.80821320e+06]
E1 = -706.7514185744948  E_coul = 198.76934146089638
cycle= 2 E= -507.982077113598  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.427
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0302455
diis-c [-9.12410432e-04 -2.24454559e-03  1.00224455e+00]
  HOMO = -0.24000738439321  LUMO = 1.0006290542737
  mo_energy =
[-1.20319226e+02 -1.23751404e+01 -6.67180293e+00 -6.67180293e+00
 -6.67180293e+00 -1.17776879e+00 -2.40007384e-01 -2.40007384e-01
 -2.40007384e-01  1.00062905e+00  8.82899357e+00  4.02918306e+01
  1.62814262e+02  6.65274241e+02  2.80557747e+03  1.22785743e+04
  4.08955116e+04  1.04936655e+05  2.30118540e+05  4.55932411e+05
  8.44883885e+05  1.52806041e+06  2.85032691e+06  5.80821305e+06]
E1 = -706.6435924037047  E_coul = 198.6612543381111
cycle= 3 E= -507.982338065594  delta_E= -0.000261  |g|= 0.00435  |ddm|= 0.0604
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00327977
diis-c [-2.40990653e-06  6.37935585e-05 -1.05899145e-01  1.10583535e+00]
  HOMO = -0.243144878602392  LUMO = 0.999654821185597
  mo_energy =
[-1.20330963e+02 -1.23836830e+01 -6.68082836e+00 -6.68082836e+00
 -6.68082836e+00 -1.17966893e+00 -2.43144879e-01 -2.43144879e-01
 -2.43144879e-01  9.99654821e-01  8.82331000e+00  4.02831873e+01
  1.62803616e+02  6.65262365e+02  2.80556478e+03  1.22785611e+04
  4.08954982e+04  1.04936641e+05  2.30118526e+05  4.55932398e+05
  8.44883871e+05  1.52806039e+06  2.85032689e+06  5.80821304e+06]
E1 = -706.6284095322935  E_coul = 198.6460665955124
cycle= 4 E= -507.982342936781  delta_E= -4.87e-06  |g|= 0.000213  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000149698
diis-c [-1.70364177e-10 -7.48912516e-06  6.88240011e-03 -9.88761515e-02
  1.09200124e+00]
  HOMO = -0.243289065100918  LUMO = 0.999602702999279
  mo_energy =
[-1.20331318e+02 -1.23840251e+01 -6.68116765e+00 -6.68116765e+00
 -6.68116765e+00 -1.17975533e+00 -2.43289065e-01 -2.43289065e-01
 -2.43289065e-01  9.99602703e-01  8.82305421e+00  4.02828587e+01
  1.62803267e+02  6.65262010e+02  2.80556442e+03  1.22785608e+04
  4.08954979e+04  1.04936641e+05  2.30118526e+05  4.55932398e+05
  8.44883871e+05  1.52806039e+06  2.85032689e+06  5.80821304e+06]
E1 = -706.6277196121666  E_coul = 198.6453766642139
cycle= 5 E= -507.982342947953  delta_E= -1.12e-08  |g|= 1.92e-06  |ddm|= 0.000503
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.66331e-07
diis-c [-1.84434273e-13  3.32664013e-07 -2.57062622e-04  3.44984049e-03
 -4.04544243e-02  1.03726131e+00]
  HOMO = -0.24329012218897  LUMO = 0.999602465240224
  mo_energy =
[-1.20331321e+02 -1.23840274e+01 -6.68117008e+00 -6.68117008e+00
 -6.68117008e+00 -1.17975612e+00 -2.43290122e-01 -2.43290122e-01
 -2.43290122e-01  9.99602465e-01  8.82305238e+00  4.02828563e+01
  1.62803264e+02  6.65262006e+02  2.80556442e+03  1.22785608e+04
  4.08954979e+04  1.04936641e+05  2.30118526e+05  4.55932398e+05
  8.44883871e+05  1.52806039e+06  2.85032689e+06  5.80821304e+06]
E1 = -706.6277141936491  E_coul = 198.6453712456955
cycle= 6 E= -507.982342947954  delta_E= -9.09e-13  |g|= 5.63e-08  |ddm|= 4.39e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6277141936491  E_coul = 198.6453712456955
  HOMO = -0.243290150185314  LUMO = 0.999602449820641
  mo_energy =
[-1.20331321e+02 -1.23840275e+01 -6.68117014e+00 -6.68117014e+00
 -6.68117014e+00 -1.17975614e+00 -2.43290150e-01 -2.43290150e-01
 -2.43290150e-01  9.99602450e-01  8.82305233e+00  4.02828563e+01
  1.62803264e+02  6.65262006e+02  2.80556442e+03  1.22785608e+04
  4.08954979e+04  1.04936641e+05  2.30118526e+05  4.55932398e+05
  8.44883871e+05  1.52806039e+06  2.85032689e+06  5.80821304e+06]
E1 = -706.6277140649518  E_coul = 198.64537111699883
Extra cycle  E= -507.982342947953  delta_E= 6.82e-13  |g|= 6.84e-09  |ddm|= 1.12e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908517.3017507385
E1 = -706.6277140649518  E_coul = 198.64537111699883
init E= -507.982342947953
    CPU time for initialize scf      3.36 sec, wall time      0.21 sec
  HOMO = -0.243290154163737  LUMO = 0.99960244880889
  mo_energy =
[-1.20331321e+02 -1.23840275e+01 -6.68117015e+00 -6.68117015e+00
 -6.68117015e+00 -1.17975614e+00 -2.43290154e-01 -2.43290154e-01
 -2.43290154e-01  9.99602449e-01  8.82305232e+00  4.02828563e+01
  1.62803264e+02  6.65262006e+02  2.80556442e+03  1.22785608e+04
  4.08954979e+04  1.04936641e+05  2.30118526e+05  4.55932398e+05
  8.44883871e+05  1.52806039e+06  2.85032689e+06  5.80821304e+06]
E1 = -706.6277140454988  E_coul = 198.6453710975455
cycle= 1 E= -507.982342947953  delta_E= -3.41e-13  |g|= 1.24e-09  |ddm|= 1.45e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6277140454988  E_coul = 198.6453710975455
  HOMO = -0.243290154741971  LUMO = 0.9996024481559
  mo_energy =
[-1.20331321e+02 -1.23840275e+01 -6.68117015e+00 -6.68117015e+00
 -6.68117015e+00 -1.17975614e+00 -2.43290155e-01 -2.43290155e-01
 -2.43290155e-01  9.99602448e-01  8.82305232e+00  4.02828562e+01
  1.62803264e+02  6.65262006e+02  2.80556442e+03  1.22785608e+04
  4.08954979e+04  1.04936641e+05  2.30118526e+05  4.55932398e+05
  8.44883871e+05  1.52806039e+06  2.85032689e+06  5.80821304e+06]
E1 = -706.6277140437472  E_coul = 198.64537109579373
Extra cycle  E= -507.982342947953  delta_E= -2.27e-13  |g|= 8.47e-10  |ddm|= 1.33e-09
    CPU time for scf_cycle      3.82 sec, wall time      0.38 sec
exp = [2.38627414e-01 6.30248395e-01 1.17616814e+05 2.78999280e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547147e+04 7.30313866e+03 1.83757987e+04
 1.44909604e+03 3.76187195e+02 1.15329660e+02 4.04620378e+01
 1.32156545e+01 6.48749268e+00 8.59731120e+00 4.92673250e-01]
grad_E = [-6.59917523e-03  1.03928656e-03  4.40203793e-09  1.82000409e-04
  2.13692783e-11  1.19910801e-10  6.84708595e-10  2.68765321e-09
  1.11740630e-08  5.98485015e-08  3.78159038e-06  1.31222884e-07
 -3.65003524e-06  7.44063270e-05 -4.80652514e-04 -6.70718151e-04
  3.50593319e-06  4.19950948e-04 -5.74620638e-03  4.15573349e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:12:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.238546789115       1
[INPUT] 0    0    [1    /1   ]  0.630756178665       1
[INPUT] 0    0    [1    /1   ]  117616.813846        1
[INPUT] 0    0    [1    /1   ]  2.83362516513        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.03107         1
[INPUT] 0    0    [1    /1   ]  147020.991906        1
[INPUT] 0    0    [1    /1   ]  73510.4199682        1
[INPUT] 0    0    [1    /1   ]  36754.7146448        1
[INPUT] 0    0    [1    /1   ]  7303.13632873        1
[INPUT] 0    0    [1    /1   ]  18375.7986362        1
[INPUT] 0    0    [1    /1   ]  1449.09967682        1
[INPUT] 0    0    [1    /1   ]  376.129025256        1
[INPUT] 0    0    [1    /1   ]  115.640309223        1
[INPUT] 0    0    [1    /1   ]  40.6291125547        1
[INPUT] 0    0    [1    /1   ]  13.5857807597        1
[INPUT] 0    0    [1    /1   ]  6.65915659719        1
[INPUT] 1    0    [1    /1   ]  8.59391147321        1
[INPUT] 1    0    [1    /1   ]  0.492637741967       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.23854678911495977, 1.0]], [0, [0.6307561786647155, 1.0]], [0, [117616.813846287, 1.0]], [0, [2.8336251651266235, 1.0]], [0, [1176168.1426171376, 1.0]], [0, [588084.0699819175, 1.0]], [0, [294042.03107034275, 1.0]], [0, [147020.99190648017, 1.0]], [0, [73510.41996820293, 1.0]], [0, [36754.714644752225, 1.0]], [0, [7303.1363287335535, 1.0]], [0, [18375.798636182135, 1.0]], [0, [1449.0996768160476, 1.0]], [0, [376.1290252555517, 1.0]], [0, [115.64030922318638, 1.0]], [0, [40.62911255469149, 1.0]], [0, [13.585780759663846, 1.0]], [0, [6.659156597190598, 1.0]], [1, [8.59391147320903, 1.0]], [1, [0.49263774196712723, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23854679]
bas 1, expnt(s) = [0.63075618]
bas 2, expnt(s) = [117616.81384629]
bas 3, expnt(s) = [2.83362517]
bas 4, expnt(s) = [1176168.14261714]
bas 5, expnt(s) = [588084.06998192]
bas 6, expnt(s) = [294042.03107034]
bas 7, expnt(s) = [147020.99190648]
bas 8, expnt(s) = [73510.4199682]
bas 9, expnt(s) = [36754.71464475]
bas 10, expnt(s) = [7303.13632873]
bas 11, expnt(s) = [18375.79863618]
bas 12, expnt(s) = [1449.09967682]
bas 13, expnt(s) = [376.12902526]
bas 14, expnt(s) = [115.64030922]
bas 15, expnt(s) = [40.62911255]
bas 16, expnt(s) = [13.58578076]
bas 17, expnt(s) = [6.6591566]
bas 18, expnt(s) = [8.59391147]
bas 19, expnt(s) = [0.49263774]
CPU time:       637.76
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.38546789e-01 8.62373109e-01 6.30756179e-01 1.78817970e+00
 1.17616814e+05 1.60460109e+04 2.83362517e+00 5.51787458e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547146e+04 6.70656002e+03
 7.30313633e+03 1.99593815e+03 1.83757986e+04 3.98749078e+03
 1.44909968e+03 5.93387945e+02 3.76129025e+02 2.15783216e+02
 1.15640309e+02 8.90936922e+01 4.06291126e+01 4.06577205e+01
 1.35857808e+01 1.78783928e+01 6.65915660e+00 1.04732012e+01
 8.59391147e+00 4.29262536e+01 4.92637742e-01 1.20404854e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336198667539612
cond(S) = 908562.4214829721
E1 = -689.542296276311  E_coul = 184.92027502282858
init E= -504.622021253482
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.672207233434622  LUMO = 0.631993549311943
  mo_energy =
[-1.21716562e+02 -1.33899560e+01 -7.62720041e+00 -7.62720041e+00
 -7.62720041e+00 -1.65760648e+00 -6.72207233e-01 -6.72207233e-01
 -6.72207233e-01  6.31993549e-01  8.29388911e+00  4.04187118e+01
  1.64182702e+02  6.67531095e+02  2.80790972e+03  1.22806274e+04
  4.08974011e+04  1.04938459e+05  2.30120288e+05  4.55934119e+05
  8.44885561e+05  1.52806205e+06  2.85032851e+06  5.80821459e+06]
E1 = -707.6786884397811  E_coul = 199.71409464020772
cycle= 1 E= -507.964593799573  delta_E= -3.34  |g|= 0.45  |ddm|= 0.497
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.690632
diis-c [-0.47697273  1.        ]
  HOMO = -0.218038311176092  LUMO = 1.00818147650262
  mo_energy =
[-1.20209107e+02 -1.23095096e+01 -6.59891040e+00 -6.59891040e+00
 -6.59891040e+00 -1.16369816e+00 -2.18038311e-01 -2.18038311e-01
 -2.18038311e-01  1.00818148e+00  9.08314077e+00  4.15541295e+01
  1.65589168e+02  6.69020352e+02  2.80933988e+03  1.22819486e+04
  4.08986556e+04  1.04939676e+05  2.30121482e+05  4.55935295e+05
  8.44886724e+05  1.52806320e+06  2.85032965e+06  5.80821572e+06]
E1 = -706.7332574266621  E_coul = 198.75105261695694
cycle= 2 E= -507.982204809705  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.428
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0302374
diis-c [-9.12214686e-04 -2.09848138e-03  1.00209848e+00]
  HOMO = -0.240090634405334  LUMO = 1.00294567370812
  mo_energy =
[-1.20322794e+02 -1.23765036e+01 -6.67307659e+00 -6.67307659e+00
 -6.67307659e+00 -1.17790487e+00 -2.40090634e-01 -2.40090634e-01
 -2.40090634e-01  1.00294567e+00  9.04235106e+00  4.14830614e+01
  1.65491849e+02  6.68902873e+02  2.80920631e+03  1.22818048e+04
  4.08985080e+04  1.04939527e+05  2.30121332e+05  4.55935145e+05
  8.44886573e+05  1.52806305e+06  2.85032950e+06  5.80821557e+06]
E1 = -706.6254145986724  E_coul = 198.6429486504182
cycle= 3 E= -507.982465948254  delta_E= -0.000261  |g|= 0.00435  |ddm|= 0.0605
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00327887
diis-c [-2.40015772e-06  5.71228574e-05 -1.05939018e-01  1.10588190e+00]
  HOMO = -0.243233013122968  LUMO = 1.0019624595545
  mo_energy =
[-1.20334548e+02 -1.23850586e+01 -6.68211481e+00 -6.68211481e+00
 -6.68211481e+00 -1.17980852e+00 -2.43233013e-01 -2.43233013e-01
 -2.43233013e-01  1.00196246e+00  9.03658720e+00  4.14743543e+01
  1.65481177e+02  6.68890979e+02  2.80919361e+03  1.22817916e+04
  4.08984947e+04  1.04939514e+05  2.30121318e+05  4.55935131e+05
  8.44886560e+05  1.52806304e+06  2.85032948e+06  5.80821556e+06]
E1 = -706.6102069607699  E_coul = 198.6277361331018
cycle= 4 E= -507.982470827668  delta_E= -4.88e-06  |g|= 0.000213  |ddm|= 0.00952
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000149572
diis-c [-1.63115338e-10 -7.50367712e-06  6.90126142e-03 -9.90231721e-02
  1.09212941e+00]
  HOMO = -0.243377329637334  LUMO = 1.00191003010891
  mo_energy =
[-1.20334904e+02 -1.23854017e+01 -6.68245529e+00 -6.68245529e+00
 -6.68245529e+00 -1.17989497e+00 -2.43377330e-01 -2.43377330e-01
 -2.43377330e-01  1.00191003e+00  9.03632844e+00  4.14740236e+01
  1.65480827e+02  6.68890622e+02  2.80919325e+03  1.22817912e+04
  4.08984943e+04  1.04939514e+05  2.30121318e+05  4.55935131e+05
  8.44886559e+05  1.52806304e+06  2.85032948e+06  5.80821556e+06]
E1 = -706.6095163163257  E_coul = 198.6270454775447
cycle= 5 E= -507.982470838781  delta_E= -1.11e-08  |g|= 1.78e-06  |ddm|= 0.000499
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.12453e-07
diis-c [-1.63876510e-13  3.15438209e-07 -2.38179487e-04  3.18124815e-03
 -3.72879479e-02  1.03434456e+00]
  HOMO = -0.243378323993665  LUMO = 1.0019098161412
  mo_energy =
[-1.20334907e+02 -1.23854040e+01 -6.68245761e+00 -6.68245761e+00
 -6.68245761e+00 -1.17989571e+00 -2.43378324e-01 -2.43378324e-01
 -2.43378324e-01  1.00190982e+00  9.03632670e+00  4.14740214e+01
  1.65480824e+02  6.68890619e+02  2.80919324e+03  1.22817912e+04
  4.08984943e+04  1.04939514e+05  2.30121318e+05  4.55935131e+05
  8.44886559e+05  1.52806304e+06  2.85032948e+06  5.80821556e+06]
E1 = -706.6095112037849  E_coul = 198.6270403650038
cycle= 6 E= -507.982470838781  delta_E= -1.14e-13  |g|= 5.4e-08  |ddm|= 4.07e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6095112037849  E_coul = 198.6270403650038
  HOMO = -0.243378351112415  LUMO = 1.00190980118204
  mo_energy =
[-1.20334907e+02 -1.23854040e+01 -6.68245766e+00 -6.68245766e+00
 -6.68245766e+00 -1.17989573e+00 -2.43378351e-01 -2.43378351e-01
 -2.43378351e-01  1.00190980e+00  9.03632665e+00  4.14740213e+01
  1.65480824e+02  6.68890619e+02  2.80919324e+03  1.22817912e+04
  4.08984943e+04  1.04939514e+05  2.30121318e+05  4.55935131e+05
  8.44886559e+05  1.52806304e+06  2.85032948e+06  5.80821556e+06]
E1 = -706.6095110782716  E_coul = 198.62704023949038
Extra cycle  E= -507.982470838781  delta_E= -1.14e-13  |g|= 6.47e-09  |ddm|= 1.07e-07
    CPU time for scf_cycle      1.08 sec, wall time      0.28 sec
exp = [2.38546789e-01 6.30756179e-01 1.17616814e+05 2.83362517e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547146e+04 7.30313633e+03 1.83757986e+04
 1.44909968e+03 3.76129025e+02 1.15640309e+02 4.06291126e+01
 1.35857808e+01 6.65915660e+00 8.59391147e+00 4.92637742e-01]
E = -507.9824708387812
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:12:14 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.238546789115       1
[INPUT] 0    0    [1    /1   ]  0.630756178665       1
[INPUT] 0    0    [1    /1   ]  117616.813846        1
[INPUT] 0    0    [1    /1   ]  2.83362516513        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.03107         1
[INPUT] 0    0    [1    /1   ]  147020.991906        1
[INPUT] 0    0    [1    /1   ]  73510.4199682        1
[INPUT] 0    0    [1    /1   ]  36754.7146448        1
[INPUT] 0    0    [1    /1   ]  7303.13632873        1
[INPUT] 0    0    [1    /1   ]  18375.7986362        1
[INPUT] 0    0    [1    /1   ]  1449.09967682        1
[INPUT] 0    0    [1    /1   ]  376.129025256        1
[INPUT] 0    0    [1    /1   ]  115.640309223        1
[INPUT] 0    0    [1    /1   ]  40.6291125547        1
[INPUT] 0    0    [1    /1   ]  13.5857807597        1
[INPUT] 0    0    [1    /1   ]  6.65915659719        1
[INPUT] 1    0    [1    /1   ]  8.59391147321        1
[INPUT] 1    0    [1    /1   ]  0.492637741967       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.23854678911495977, 1.0]], [0, [0.6307561786647155, 1.0]], [0, [117616.813846287, 1.0]], [0, [2.8336251651266235, 1.0]], [0, [1176168.1426171376, 1.0]], [0, [588084.0699819175, 1.0]], [0, [294042.03107034275, 1.0]], [0, [147020.99190648017, 1.0]], [0, [73510.41996820293, 1.0]], [0, [36754.714644752225, 1.0]], [0, [7303.1363287335535, 1.0]], [0, [18375.798636182135, 1.0]], [0, [1449.0996768160476, 1.0]], [0, [376.1290252555517, 1.0]], [0, [115.64030922318638, 1.0]], [0, [40.62911255469149, 1.0]], [0, [13.585780759663846, 1.0]], [0, [6.659156597190598, 1.0]], [1, [8.59391147320903, 1.0]], [1, [0.49263774196712723, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23854679]
bas 1, expnt(s) = [0.63075618]
bas 2, expnt(s) = [117616.81384629]
bas 3, expnt(s) = [2.83362517]
bas 4, expnt(s) = [1176168.14261714]
bas 5, expnt(s) = [588084.06998192]
bas 6, expnt(s) = [294042.03107034]
bas 7, expnt(s) = [147020.99190648]
bas 8, expnt(s) = [73510.4199682]
bas 9, expnt(s) = [36754.71464475]
bas 10, expnt(s) = [7303.13632873]
bas 11, expnt(s) = [18375.79863618]
bas 12, expnt(s) = [1449.09967682]
bas 13, expnt(s) = [376.12902526]
bas 14, expnt(s) = [115.64030922]
bas 15, expnt(s) = [40.62911255]
bas 16, expnt(s) = [13.58578076]
bas 17, expnt(s) = [6.6591566]
bas 18, expnt(s) = [8.59391147]
bas 19, expnt(s) = [0.49263774]
CPU time:       639.16
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.38546789e-01 8.62373109e-01 6.30756179e-01 1.78817970e+00
 1.17616814e+05 1.60460109e+04 2.83362517e+00 5.51787458e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547146e+04 6.70656002e+03
 7.30313633e+03 1.99593815e+03 1.83757986e+04 3.98749078e+03
 1.44909968e+03 5.93387945e+02 3.76129025e+02 2.15783216e+02
 1.15640309e+02 8.90936922e+01 4.06291126e+01 4.06577205e+01
 1.35857808e+01 1.78783928e+01 6.65915660e+00 1.04732012e+01
 8.59391147e+00 4.29262536e+01 4.92637742e-01 1.20404854e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336198667539612
cond(S) = 908562.4214829721
E1 = -689.542296276311  E_coul = 184.92027502282858
init E= -504.622021253482
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672207233434622  LUMO = 0.631993549311943
  mo_energy =
[-1.21716562e+02 -1.33899560e+01 -7.62720041e+00 -7.62720041e+00
 -7.62720041e+00 -1.65760648e+00 -6.72207233e-01 -6.72207233e-01
 -6.72207233e-01  6.31993549e-01  8.29388911e+00  4.04187118e+01
  1.64182702e+02  6.67531095e+02  2.80790972e+03  1.22806274e+04
  4.08974011e+04  1.04938459e+05  2.30120288e+05  4.55934119e+05
  8.44885561e+05  1.52806205e+06  2.85032851e+06  5.80821459e+06]
E1 = -707.6786884397811  E_coul = 199.71409464020772
cycle= 1 E= -507.964593799573  delta_E= -3.34  |g|= 0.45  |ddm|= 0.497
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.690632
diis-c [-0.47697273  1.        ]
  HOMO = -0.218038311176092  LUMO = 1.00818147650262
  mo_energy =
[-1.20209107e+02 -1.23095096e+01 -6.59891040e+00 -6.59891040e+00
 -6.59891040e+00 -1.16369816e+00 -2.18038311e-01 -2.18038311e-01
 -2.18038311e-01  1.00818148e+00  9.08314077e+00  4.15541295e+01
  1.65589168e+02  6.69020352e+02  2.80933988e+03  1.22819486e+04
  4.08986556e+04  1.04939676e+05  2.30121482e+05  4.55935295e+05
  8.44886724e+05  1.52806320e+06  2.85032965e+06  5.80821572e+06]
E1 = -706.7332574266621  E_coul = 198.75105261695694
cycle= 2 E= -507.982204809705  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.428
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0302374
diis-c [-9.12214686e-04 -2.09848138e-03  1.00209848e+00]
  HOMO = -0.240090634405334  LUMO = 1.00294567370812
  mo_energy =
[-1.20322794e+02 -1.23765036e+01 -6.67307659e+00 -6.67307659e+00
 -6.67307659e+00 -1.17790487e+00 -2.40090634e-01 -2.40090634e-01
 -2.40090634e-01  1.00294567e+00  9.04235106e+00  4.14830614e+01
  1.65491849e+02  6.68902873e+02  2.80920631e+03  1.22818048e+04
  4.08985080e+04  1.04939527e+05  2.30121332e+05  4.55935145e+05
  8.44886573e+05  1.52806305e+06  2.85032950e+06  5.80821557e+06]
E1 = -706.6254145986724  E_coul = 198.6429486504182
cycle= 3 E= -507.982465948254  delta_E= -0.000261  |g|= 0.00435  |ddm|= 0.0605
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00327887
diis-c [-2.40015772e-06  5.71228574e-05 -1.05939018e-01  1.10588190e+00]
  HOMO = -0.243233013122968  LUMO = 1.0019624595545
  mo_energy =
[-1.20334548e+02 -1.23850586e+01 -6.68211481e+00 -6.68211481e+00
 -6.68211481e+00 -1.17980852e+00 -2.43233013e-01 -2.43233013e-01
 -2.43233013e-01  1.00196246e+00  9.03658720e+00  4.14743543e+01
  1.65481177e+02  6.68890979e+02  2.80919361e+03  1.22817916e+04
  4.08984947e+04  1.04939514e+05  2.30121318e+05  4.55935131e+05
  8.44886560e+05  1.52806304e+06  2.85032948e+06  5.80821556e+06]
E1 = -706.6102069607699  E_coul = 198.6277361331018
cycle= 4 E= -507.982470827668  delta_E= -4.88e-06  |g|= 0.000213  |ddm|= 0.00952
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000149572
diis-c [-1.63115338e-10 -7.50367712e-06  6.90126142e-03 -9.90231721e-02
  1.09212941e+00]
  HOMO = -0.243377329637334  LUMO = 1.00191003010891
  mo_energy =
[-1.20334904e+02 -1.23854017e+01 -6.68245529e+00 -6.68245529e+00
 -6.68245529e+00 -1.17989497e+00 -2.43377330e-01 -2.43377330e-01
 -2.43377330e-01  1.00191003e+00  9.03632844e+00  4.14740236e+01
  1.65480827e+02  6.68890622e+02  2.80919325e+03  1.22817912e+04
  4.08984943e+04  1.04939514e+05  2.30121318e+05  4.55935131e+05
  8.44886559e+05  1.52806304e+06  2.85032948e+06  5.80821556e+06]
E1 = -706.6095163163257  E_coul = 198.6270454775447
cycle= 5 E= -507.982470838781  delta_E= -1.11e-08  |g|= 1.78e-06  |ddm|= 0.000499
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.12453e-07
diis-c [-1.63876510e-13  3.15438209e-07 -2.38179487e-04  3.18124815e-03
 -3.72879479e-02  1.03434456e+00]
  HOMO = -0.243378323993665  LUMO = 1.0019098161412
  mo_energy =
[-1.20334907e+02 -1.23854040e+01 -6.68245761e+00 -6.68245761e+00
 -6.68245761e+00 -1.17989571e+00 -2.43378324e-01 -2.43378324e-01
 -2.43378324e-01  1.00190982e+00  9.03632670e+00  4.14740214e+01
  1.65480824e+02  6.68890619e+02  2.80919324e+03  1.22817912e+04
  4.08984943e+04  1.04939514e+05  2.30121318e+05  4.55935131e+05
  8.44886559e+05  1.52806304e+06  2.85032948e+06  5.80821556e+06]
E1 = -706.6095112037849  E_coul = 198.6270403650038
cycle= 6 E= -507.982470838781  delta_E= -1.14e-13  |g|= 5.4e-08  |ddm|= 4.07e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6095112037849  E_coul = 198.6270403650038
  HOMO = -0.243378351112415  LUMO = 1.00190980118204
  mo_energy =
[-1.20334907e+02 -1.23854040e+01 -6.68245766e+00 -6.68245766e+00
 -6.68245766e+00 -1.17989573e+00 -2.43378351e-01 -2.43378351e-01
 -2.43378351e-01  1.00190980e+00  9.03632665e+00  4.14740213e+01
  1.65480824e+02  6.68890619e+02  2.80919324e+03  1.22817912e+04
  4.08984943e+04  1.04939514e+05  2.30121318e+05  4.55935131e+05
  8.44886559e+05  1.52806304e+06  2.85032948e+06  5.80821556e+06]
E1 = -706.6095110782716  E_coul = 198.62704023949038
Extra cycle  E= -507.982470838781  delta_E= -1.14e-13  |g|= 6.47e-09  |ddm|= 1.07e-07
    CPU time for scf_cycle      1.08 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908562.4214829721
E1 = -706.6095110782716  E_coul = 198.62704023949038
init E= -507.982470838781
    CPU time for initialize scf      3.35 sec, wall time      0.21 sec
  HOMO = -0.243378354973979  LUMO = 1.00190980070002
  mo_energy =
[-1.20334907e+02 -1.23854040e+01 -6.68245767e+00 -6.68245767e+00
 -6.68245767e+00 -1.17989573e+00 -2.43378355e-01 -2.43378355e-01
 -2.43378355e-01  1.00190980e+00  9.03632664e+00  4.14740213e+01
  1.65480824e+02  6.68890619e+02  2.80919324e+03  1.22817912e+04
  4.08984943e+04  1.04939514e+05  2.30121318e+05  4.55935131e+05
  8.44886559e+05  1.52806304e+06  2.85032948e+06  5.80821556e+06]
E1 = -706.6095110579964  E_coul = 198.62704021921508
cycle= 1 E= -507.982470838781  delta_E= -1.71e-13  |g|= 1.29e-09  |ddm|= 1.48e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6095110579964  E_coul = 198.62704021921508
  HOMO = -0.243378355571622  LUMO = 1.00190979942399
  mo_energy =
[-1.20334907e+02 -1.23854040e+01 -6.68245767e+00 -6.68245767e+00
 -6.68245767e+00 -1.17989573e+00 -2.43378356e-01 -2.43378356e-01
 -2.43378356e-01  1.00190980e+00  9.03632664e+00  4.14740213e+01
  1.65480824e+02  6.68890619e+02  2.80919324e+03  1.22817912e+04
  4.08984943e+04  1.04939514e+05  2.30121318e+05  4.55935131e+05
  8.44886559e+05  1.52806304e+06  2.85032948e+06  5.80821556e+06]
E1 = -706.609511057698  E_coul = 198.62704021891696
Extra cycle  E= -507.982470838781  delta_E= 2.84e-13  |g|= 1.05e-09  |ddm|= 3.01e-10
    CPU time for scf_cycle      3.80 sec, wall time      0.38 sec
exp = [2.38546789e-01 6.30756179e-01 1.17616814e+05 2.83362517e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547146e+04 7.30313633e+03 1.83757986e+04
 1.44909968e+03 3.76129025e+02 1.15640309e+02 4.06291126e+01
 1.35857808e+01 6.65915660e+00 8.59391147e+00 4.92637742e-01]
grad_E = [-8.30470499e-03  1.66197738e-03  4.33707231e-09 -1.94188312e-04
  2.06029325e-11  1.17798604e-10  6.74664636e-10  2.64749203e-09
  1.10046924e-08  5.90158356e-08  3.72322414e-06  1.28665998e-07
 -5.43903499e-07  3.79665416e-05 -3.40524833e-04 -8.63756997e-04
  5.01774815e-05  6.96962671e-04 -8.56764307e-03  6.29144838e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:12:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.24108121028        1
[INPUT] 0    0    [1    /1   ]  0.635974247775       1
[INPUT] 0    0    [1    /1   ]  117616.813841        1
[INPUT] 0    0    [1    /1   ]  2.9092657957         1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.03107         1
[INPUT] 0    0    [1    /1   ]  147020.991903        1
[INPUT] 0    0    [1    /1   ]  73510.4199557        1
[INPUT] 0    0    [1    /1   ]  36754.714578         1
[INPUT] 0    0    [1    /1   ]  7303.13211044        1
[INPUT] 0    0    [1    /1   ]  18375.7984893        1
[INPUT] 0    0    [1    /1   ]  1449.10576253        1
[INPUT] 0    0    [1    /1   ]  376.03106317         1
[INPUT] 0    0    [1    /1   ]  116.156382511        1
[INPUT] 0    0    [1    /1   ]  41.0178347648        1
[INPUT] 0    0    [1    /1   ]  14.2866165713        1
[INPUT] 0    0    [1    /1   ]  6.96318020383        1
[INPUT] 1    0    [1    /1   ]  8.59251455919        1
[INPUT] 1    0    [1    /1   ]  0.49261350091        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2410812102801665, 1.0]], [0, [0.6359742477746756, 1.0]], [0, [117616.81384137715, 1.0]], [0, [2.9092657956985795, 1.0]], [0, [1176168.1426171134, 1.0]], [0, [588084.0699817835, 1.0]], [0, [294042.0310695791, 1.0]], [0, [147020.99190348206, 1.0]], [0, [73510.4199557362, 1.0]], [0, [36754.71457804177, 1.0]], [0, [7303.132110442404, 1.0]], [0, [18375.798489310844, 1.0]], [0, [1449.1057625329345, 1.0]], [0, [376.0310631699302, 1.0]], [0, [116.15638251106931, 1.0]], [0, [41.017834764825764, 1.0]], [0, [14.286616571333983, 1.0]], [0, [6.96318020382637, 1.0]], [1, [8.59251455919185, 1.0]], [1, [0.4926135009095687, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24108121]
bas 1, expnt(s) = [0.63597425]
bas 2, expnt(s) = [117616.81384138]
bas 3, expnt(s) = [2.9092658]
bas 4, expnt(s) = [1176168.14261711]
bas 5, expnt(s) = [588084.06998178]
bas 6, expnt(s) = [294042.03106958]
bas 7, expnt(s) = [147020.99190348]
bas 8, expnt(s) = [73510.41995574]
bas 9, expnt(s) = [36754.71457804]
bas 10, expnt(s) = [7303.13211044]
bas 11, expnt(s) = [18375.79848931]
bas 12, expnt(s) = [1449.10576253]
bas 13, expnt(s) = [376.03106317]
bas 14, expnt(s) = [116.15638251]
bas 15, expnt(s) = [41.01783476]
bas 16, expnt(s) = [14.28661657]
bas 17, expnt(s) = [6.9631802]
bas 18, expnt(s) = [8.59251456]
bas 19, expnt(s) = [0.4926135]
CPU time:       650.83
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.41081210e-01 8.69235684e-01 6.35974248e-01 1.79926309e+00
 1.17616814e+05 1.60460109e+04 2.90926580e+00 5.62798038e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547146e+04 6.70656001e+03
 7.30313211e+03 1.99593729e+03 1.83757985e+04 3.98749075e+03
 1.44910576e+03 5.93389814e+02 3.76031063e+02 2.15741064e+02
 1.16156383e+02 8.93917281e+01 4.10178348e+01 4.09491200e+01
 1.42866166e+01 1.85657315e+01 6.96318020e+00 1.08298078e+01
 8.59251456e+00 4.29175319e+01 4.92613501e-01 1.20397448e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336208640160756
cond(S) = 908648.2079540337
E1 = -689.5374056864291  E_coul = 184.91347395378793
init E= -504.623931732641
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672211991237953  LUMO = 0.646922936190853
  mo_energy =
[-1.21718101e+02 -1.33904417e+01 -7.62767211e+00 -7.62767211e+00
 -7.62767211e+00 -1.65765490e+00 -6.72211991e-01 -6.72211991e-01
 -6.72211991e-01  6.46922936e-01  8.70062440e+00  4.26280486e+01
  1.69249854e+02  6.74410985e+02  2.81476238e+03  1.22867268e+04
  4.09030589e+04  1.04943883e+05  2.30125560e+05  4.55939280e+05
  8.44890638e+05  1.52806705e+06  2.85033340e+06  5.80821935e+06]
E1 = -707.6709279940205  E_coul = 199.70609800630328
cycle= 1 E= -507.964829987717  delta_E= -3.34  |g|= 0.45  |ddm|= 0.498
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.692444
diis-c [-0.47947849  1.        ]
  HOMO = -0.21808255368918  LUMO = 1.02657452477883
  mo_energy =
[-1.20210754e+02 -1.23100733e+01 -6.59947867e+00 -6.59947867e+00
 -6.59947867e+00 -1.16375698e+00 -2.18082554e-01 -2.18082554e-01
 -2.18082554e-01  1.02657452e+00  9.50457091e+00  4.37763164e+01
  1.70658427e+02  6.75900039e+02  2.81619251e+03  1.22880479e+04
  4.09043133e+04  1.04945101e+05  2.30126754e+05  4.55940457e+05
  8.44891801e+05  1.52806820e+06  2.85033454e+06  5.80822049e+06]
E1 = -706.7266687400946  E_coul = 198.74425097541618
cycle= 2 E= -507.982417764678  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.431
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0301321
diis-c [-9.06539152e-04 -1.71418708e-03  1.00171419e+00]
  HOMO = -0.240106338455715  LUMO = 1.02117516728733
  mo_energy =
[-1.20324258e+02 -1.23769526e+01 -6.67351601e+00 -6.67351601e+00
 -6.67351601e+00 -1.17794647e+00 -2.40106338e-01 -2.40106338e-01
 -2.40106338e-01  1.02117517e+00  9.46273002e+00  4.37043190e+01
  1.70560988e+02  6.75782744e+02  2.81605917e+03  1.22879043e+04
  4.09041660e+04  1.04944952e+05  2.30126604e+05  4.55940306e+05
  8.44891650e+05  1.52806805e+06  2.85033439e+06  5.80822033e+06]
E1 = -706.6191472256784  E_coul = 198.63646955582573
cycle= 3 E= -507.982677669853  delta_E= -0.00026  |g|= 0.00435  |ddm|= 0.0605
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0032593
diis-c [-2.35895283e-06  4.69376005e-05 -1.05706017e-01  1.10565908e+00]
  HOMO = -0.243243576277461  LUMO = 1.02016973312732
  mo_energy =
[-1.20336025e+02 -1.23855081e+01 -6.68255641e+00 -6.68255641e+00
 -6.68255641e+00 -1.17984690e+00 -2.43243576e-01 -2.43243576e-01
 -2.43243576e-01  1.02016973e+00  9.45684267e+00  4.36955207e+01
  1.70550288e+02  6.75770836e+02  2.81604645e+03  1.22878911e+04
  4.09041526e+04  1.04944939e+05  2.30126590e+05  4.55940293e+05
  8.44891637e+05  1.52806803e+06  2.85033438e+06  5.80822032e+06]
E1 = -706.6039911722844  E_coul = 198.62130866790253
cycle= 4 E= -507.982682504382  delta_E= -4.83e-06  |g|= 0.00021  |ddm|= 0.00946
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000148138
diis-c [-1.47161856e-10 -7.44958729e-06  6.91656069e-03 -9.90949490e-02
  1.09218584e+00]
  HOMO = -0.243386817249979  LUMO = 1.02011674208486
  mo_energy =
[-1.20336382e+02 -1.23858509e+01 -6.68289687e+00 -6.68289687e+00
 -6.68289687e+00 -1.17993259e+00 -2.43386817e-01 -2.43386817e-01
 -2.43386817e-01  1.02011674e+00  9.45658078e+00  4.36951887e+01
  1.70549937e+02  6.75770478e+02  2.81604608e+03  1.22878908e+04
  4.09041522e+04  1.04944938e+05  2.30126590e+05  4.55940293e+05
  8.44891636e+05  1.52806803e+06  2.85033438e+06  5.80822032e+06]
E1 = -706.6033069734146  E_coul = 198.62062445826425
cycle= 5 E= -507.98268251515  delta_E= -1.08e-08  |g|= 1.51e-06  |ddm|= 0.000488
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.96005e-07
diis-c [-1.21747228e-13  2.83572432e-07 -1.98615777e-04  2.62299039e-03
 -3.07509136e-02  1.02832626e+00]
  HOMO = -0.243387676430218  LUMO = 1.02011657338197
  mo_energy =
[-1.20336385e+02 -1.23858529e+01 -6.68289891e+00 -6.68289891e+00
 -6.68289891e+00 -1.17993325e+00 -2.43387676e-01 -2.43387676e-01
 -2.43387676e-01  1.02011657e+00  9.45657924e+00  4.36951867e+01
  1.70549934e+02  6.75770475e+02  2.81604608e+03  1.22878908e+04
  4.09041522e+04  1.04944938e+05  2.30126590e+05  4.55940293e+05
  8.44891636e+05  1.52806803e+06  2.85033438e+06  5.80822032e+06]
E1 = -706.6033025466372  E_coul = 198.6206200314858
cycle= 6 E= -507.982682515151  delta_E= -1.02e-12  |g|= 4.9e-08  |ddm|= 3.41e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6033025466372  E_coul = 198.6206200314858
  HOMO = -0.243387701249784  LUMO = 1.02011656061811
  mo_energy =
[-1.20336385e+02 -1.23858530e+01 -6.68289897e+00 -6.68289897e+00
 -6.68289897e+00 -1.17993326e+00 -2.43387701e-01 -2.43387701e-01
 -2.43387701e-01  1.02011656e+00  9.45657919e+00  4.36951866e+01
  1.70549934e+02  6.75770475e+02  2.81604608e+03  1.22878908e+04
  4.09041522e+04  1.04944938e+05  2.30126590e+05  4.55940293e+05
  8.44891636e+05  1.52806803e+06  2.85033438e+06  5.80822032e+06]
E1 = -706.6033024316932  E_coul = 198.62061991654224
Extra cycle  E= -507.982682515151  delta_E= 3.98e-13  |g|= 5.85e-09  |ddm|= 9.6e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.41081210e-01 6.35974248e-01 1.17616814e+05 2.90926580e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547146e+04 7.30313211e+03 1.83757985e+04
 1.44910576e+03 3.76031063e+02 1.16156383e+02 4.10178348e+01
 1.42866166e+01 6.96318020e+00 8.59251456e+00 4.92613501e-01]
E = -507.982682515151
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:12:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.24108121028        1
[INPUT] 0    0    [1    /1   ]  0.635974247775       1
[INPUT] 0    0    [1    /1   ]  117616.813841        1
[INPUT] 0    0    [1    /1   ]  2.9092657957         1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.03107         1
[INPUT] 0    0    [1    /1   ]  147020.991903        1
[INPUT] 0    0    [1    /1   ]  73510.4199557        1
[INPUT] 0    0    [1    /1   ]  36754.714578         1
[INPUT] 0    0    [1    /1   ]  7303.13211044        1
[INPUT] 0    0    [1    /1   ]  18375.7984893        1
[INPUT] 0    0    [1    /1   ]  1449.10576253        1
[INPUT] 0    0    [1    /1   ]  376.03106317         1
[INPUT] 0    0    [1    /1   ]  116.156382511        1
[INPUT] 0    0    [1    /1   ]  41.0178347648        1
[INPUT] 0    0    [1    /1   ]  14.2866165713        1
[INPUT] 0    0    [1    /1   ]  6.96318020383        1
[INPUT] 1    0    [1    /1   ]  8.59251455919        1
[INPUT] 1    0    [1    /1   ]  0.49261350091        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2410812102801665, 1.0]], [0, [0.6359742477746756, 1.0]], [0, [117616.81384137715, 1.0]], [0, [2.9092657956985795, 1.0]], [0, [1176168.1426171134, 1.0]], [0, [588084.0699817835, 1.0]], [0, [294042.0310695791, 1.0]], [0, [147020.99190348206, 1.0]], [0, [73510.4199557362, 1.0]], [0, [36754.71457804177, 1.0]], [0, [7303.132110442404, 1.0]], [0, [18375.798489310844, 1.0]], [0, [1449.1057625329345, 1.0]], [0, [376.0310631699302, 1.0]], [0, [116.15638251106931, 1.0]], [0, [41.017834764825764, 1.0]], [0, [14.286616571333983, 1.0]], [0, [6.96318020382637, 1.0]], [1, [8.59251455919185, 1.0]], [1, [0.4926135009095687, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24108121]
bas 1, expnt(s) = [0.63597425]
bas 2, expnt(s) = [117616.81384138]
bas 3, expnt(s) = [2.9092658]
bas 4, expnt(s) = [1176168.14261711]
bas 5, expnt(s) = [588084.06998178]
bas 6, expnt(s) = [294042.03106958]
bas 7, expnt(s) = [147020.99190348]
bas 8, expnt(s) = [73510.41995574]
bas 9, expnt(s) = [36754.71457804]
bas 10, expnt(s) = [7303.13211044]
bas 11, expnt(s) = [18375.79848931]
bas 12, expnt(s) = [1449.10576253]
bas 13, expnt(s) = [376.03106317]
bas 14, expnt(s) = [116.15638251]
bas 15, expnt(s) = [41.01783476]
bas 16, expnt(s) = [14.28661657]
bas 17, expnt(s) = [6.9631802]
bas 18, expnt(s) = [8.59251456]
bas 19, expnt(s) = [0.4926135]
CPU time:       652.24
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.41081210e-01 8.69235684e-01 6.35974248e-01 1.79926309e+00
 1.17616814e+05 1.60460109e+04 2.90926580e+00 5.62798038e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104200e+04 1.12791586e+04 3.67547146e+04 6.70656001e+03
 7.30313211e+03 1.99593729e+03 1.83757985e+04 3.98749075e+03
 1.44910576e+03 5.93389814e+02 3.76031063e+02 2.15741064e+02
 1.16156383e+02 8.93917281e+01 4.10178348e+01 4.09491200e+01
 1.42866166e+01 1.85657315e+01 6.96318020e+00 1.08298078e+01
 8.59251456e+00 4.29175319e+01 4.92613501e-01 1.20397448e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336208640160756
cond(S) = 908648.2079540337
E1 = -689.5374056864291  E_coul = 184.91347395378793
init E= -504.623931732641
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672211991237953  LUMO = 0.646922936190853
  mo_energy =
[-1.21718101e+02 -1.33904417e+01 -7.62767211e+00 -7.62767211e+00
 -7.62767211e+00 -1.65765490e+00 -6.72211991e-01 -6.72211991e-01
 -6.72211991e-01  6.46922936e-01  8.70062440e+00  4.26280486e+01
  1.69249854e+02  6.74410985e+02  2.81476238e+03  1.22867268e+04
  4.09030589e+04  1.04943883e+05  2.30125560e+05  4.55939280e+05
  8.44890638e+05  1.52806705e+06  2.85033340e+06  5.80821935e+06]
E1 = -707.6709279940205  E_coul = 199.70609800630328
cycle= 1 E= -507.964829987717  delta_E= -3.34  |g|= 0.45  |ddm|= 0.498
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.692444
diis-c [-0.47947849  1.        ]
  HOMO = -0.21808255368918  LUMO = 1.02657452477883
  mo_energy =
[-1.20210754e+02 -1.23100733e+01 -6.59947867e+00 -6.59947867e+00
 -6.59947867e+00 -1.16375698e+00 -2.18082554e-01 -2.18082554e-01
 -2.18082554e-01  1.02657452e+00  9.50457091e+00  4.37763164e+01
  1.70658427e+02  6.75900039e+02  2.81619251e+03  1.22880479e+04
  4.09043133e+04  1.04945101e+05  2.30126754e+05  4.55940457e+05
  8.44891801e+05  1.52806820e+06  2.85033454e+06  5.80822049e+06]
E1 = -706.7266687400946  E_coul = 198.74425097541618
cycle= 2 E= -507.982417764678  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.431
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0301321
diis-c [-9.06539152e-04 -1.71418708e-03  1.00171419e+00]
  HOMO = -0.240106338455715  LUMO = 1.02117516728733
  mo_energy =
[-1.20324258e+02 -1.23769526e+01 -6.67351601e+00 -6.67351601e+00
 -6.67351601e+00 -1.17794647e+00 -2.40106338e-01 -2.40106338e-01
 -2.40106338e-01  1.02117517e+00  9.46273002e+00  4.37043190e+01
  1.70560988e+02  6.75782744e+02  2.81605917e+03  1.22879043e+04
  4.09041660e+04  1.04944952e+05  2.30126604e+05  4.55940306e+05
  8.44891650e+05  1.52806805e+06  2.85033439e+06  5.80822033e+06]
E1 = -706.6191472256784  E_coul = 198.63646955582573
cycle= 3 E= -507.982677669853  delta_E= -0.00026  |g|= 0.00435  |ddm|= 0.0605
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0032593
diis-c [-2.35895283e-06  4.69376005e-05 -1.05706017e-01  1.10565908e+00]
  HOMO = -0.243243576277461  LUMO = 1.02016973312732
  mo_energy =
[-1.20336025e+02 -1.23855081e+01 -6.68255641e+00 -6.68255641e+00
 -6.68255641e+00 -1.17984690e+00 -2.43243576e-01 -2.43243576e-01
 -2.43243576e-01  1.02016973e+00  9.45684267e+00  4.36955207e+01
  1.70550288e+02  6.75770836e+02  2.81604645e+03  1.22878911e+04
  4.09041526e+04  1.04944939e+05  2.30126590e+05  4.55940293e+05
  8.44891637e+05  1.52806803e+06  2.85033438e+06  5.80822032e+06]
E1 = -706.6039911722844  E_coul = 198.62130866790253
cycle= 4 E= -507.982682504382  delta_E= -4.83e-06  |g|= 0.00021  |ddm|= 0.00946
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000148138
diis-c [-1.47161856e-10 -7.44958729e-06  6.91656069e-03 -9.90949490e-02
  1.09218584e+00]
  HOMO = -0.243386817249979  LUMO = 1.02011674208486
  mo_energy =
[-1.20336382e+02 -1.23858509e+01 -6.68289687e+00 -6.68289687e+00
 -6.68289687e+00 -1.17993259e+00 -2.43386817e-01 -2.43386817e-01
 -2.43386817e-01  1.02011674e+00  9.45658078e+00  4.36951887e+01
  1.70549937e+02  6.75770478e+02  2.81604608e+03  1.22878908e+04
  4.09041522e+04  1.04944938e+05  2.30126590e+05  4.55940293e+05
  8.44891636e+05  1.52806803e+06  2.85033438e+06  5.80822032e+06]
E1 = -706.6033069734146  E_coul = 198.62062445826425
cycle= 5 E= -507.98268251515  delta_E= -1.08e-08  |g|= 1.51e-06  |ddm|= 0.000488
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.96005e-07
diis-c [-1.21747228e-13  2.83572432e-07 -1.98615777e-04  2.62299039e-03
 -3.07509136e-02  1.02832626e+00]
  HOMO = -0.243387676430218  LUMO = 1.02011657338197
  mo_energy =
[-1.20336385e+02 -1.23858529e+01 -6.68289891e+00 -6.68289891e+00
 -6.68289891e+00 -1.17993325e+00 -2.43387676e-01 -2.43387676e-01
 -2.43387676e-01  1.02011657e+00  9.45657924e+00  4.36951867e+01
  1.70549934e+02  6.75770475e+02  2.81604608e+03  1.22878908e+04
  4.09041522e+04  1.04944938e+05  2.30126590e+05  4.55940293e+05
  8.44891636e+05  1.52806803e+06  2.85033438e+06  5.80822032e+06]
E1 = -706.6033025466372  E_coul = 198.6206200314858
cycle= 6 E= -507.982682515151  delta_E= -1.02e-12  |g|= 4.9e-08  |ddm|= 3.41e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6033025466372  E_coul = 198.6206200314858
  HOMO = -0.243387701249784  LUMO = 1.02011656061811
  mo_energy =
[-1.20336385e+02 -1.23858530e+01 -6.68289897e+00 -6.68289897e+00
 -6.68289897e+00 -1.17993326e+00 -2.43387701e-01 -2.43387701e-01
 -2.43387701e-01  1.02011656e+00  9.45657919e+00  4.36951866e+01
  1.70549934e+02  6.75770475e+02  2.81604608e+03  1.22878908e+04
  4.09041522e+04  1.04944938e+05  2.30126590e+05  4.55940293e+05
  8.44891636e+05  1.52806803e+06  2.85033438e+06  5.80822032e+06]
E1 = -706.6033024316932  E_coul = 198.62061991654224
Extra cycle  E= -507.982682515151  delta_E= 3.98e-13  |g|= 5.85e-09  |ddm|= 9.6e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908648.2079540337
E1 = -706.6033024316932  E_coul = 198.62061991654224
init E= -507.982682515151
    CPU time for initialize scf      3.31 sec, wall time      0.21 sec
  HOMO = -0.243387704772881  LUMO = 1.02011655831954
  mo_energy =
[-1.20336385e+02 -1.23858530e+01 -6.68289898e+00 -6.68289898e+00
 -6.68289898e+00 -1.17993326e+00 -2.43387705e-01 -2.43387705e-01
 -2.43387705e-01  1.02011656e+00  9.45657919e+00  4.36951866e+01
  1.70549934e+02  6.75770475e+02  2.81604608e+03  1.22878908e+04
  4.09041522e+04  1.04944938e+05  2.30126590e+05  4.55940293e+05
  8.44891636e+05  1.52806803e+06  2.85033438e+06  5.80822032e+06]
E1 = -706.6033024151963  E_coul = 198.62061990004534
cycle= 1 E= -507.982682515151  delta_E= 5.68e-14  |g|= 1.27e-09  |ddm|= 1.19e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6033024151963  E_coul = 198.62061990004534
  HOMO = -0.243387705252578  LUMO = 1.02011655802417
  mo_energy =
[-1.20336385e+02 -1.23858530e+01 -6.68289898e+00 -6.68289898e+00
 -6.68289898e+00 -1.17993326e+00 -2.43387705e-01 -2.43387705e-01
 -2.43387705e-01  1.02011656e+00  9.45657919e+00  4.36951866e+01
  1.70549934e+02  6.75770475e+02  2.81604608e+03  1.22878908e+04
  4.09041522e+04  1.04944938e+05  2.30126590e+05  4.55940293e+05
  8.44891636e+05  1.52806803e+06  2.85033438e+06  5.80822032e+06]
E1 = -706.6033024121633  E_coul = 198.62061989701243
Extra cycle  E= -507.982682515151  delta_E= 5.68e-14  |g|= 1.48e-09  |ddm|= 1.95e-09
    CPU time for scf_cycle      3.77 sec, wall time      0.38 sec
exp = [2.41081210e-01 6.35974248e-01 1.17616814e+05 2.90926580e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104200e+04 3.67547146e+04 7.30313211e+03 1.83757985e+04
 1.44910576e+03 3.76031063e+02 1.16156383e+02 4.10178348e+01
 1.42866166e+01 6.96318020e+00 8.59251456e+00 4.92613501e-01]
grad_E = [-8.18455649e-03  2.09138603e-03  4.25192025e-09 -8.11977755e-04
  1.95958691e-11  1.15031535e-10  6.61493720e-10  2.59485727e-09
  1.07827603e-08  5.79237567e-08  3.64654600e-06  1.25324300e-07
  3.49059275e-06 -5.93187182e-06 -2.05050281e-04 -9.97302388e-04
  1.15609270e-04  1.08281850e-03 -9.71588658e-03  7.23749765e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:12:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.246753735793       1
[INPUT] 0    0    [1    /1   ]  0.646109726913       1
[INPUT] 0    0    [1    /1   ]  117616.813836        1
[INPUT] 0    0    [1    /1   ]  2.98855780927        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031069        1
[INPUT] 0    0    [1    /1   ]  147020.9919          1
[INPUT] 0    0    [1    /1   ]  73510.4199414        1
[INPUT] 0    0    [1    /1   ]  36754.7145011        1
[INPUT] 0    0    [1    /1   ]  7303.127247          1
[INPUT] 0    0    [1    /1   ]  18375.7983201        1
[INPUT] 0    0    [1    /1   ]  1449.11228395        1
[INPUT] 0    0    [1    /1   ]  375.925252071        1
[INPUT] 0    0    [1    /1   ]  116.706641497        1
[INPUT] 0    0    [1    /1   ]  41.5580782168        1
[INPUT] 0    0    [1    /1   ]  15.1221895094        1
[INPUT] 0    0    [1    /1   ]  7.2912232101         1
[INPUT] 1    0    [1    /1   ]  8.59586630188        1
[INPUT] 1    0    [1    /1   ]  0.492627751636       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24675373579293156, 1.0]], [0, [0.6461097269134548, 1.0]], [0, [117616.81383571588, 1.0]], [0, [2.9885578092718212, 1.0]], [0, [1176168.1426170857, 1.0]], [0, [588084.069981629, 1.0]], [0, [294042.0310686986, 1.0]], [0, [147020.9919000252, 1.0]], [0, [73510.41994136217, 1.0]], [0, [36754.71450111383, 1.0]], [0, [7303.127247003773, 1.0]], [0, [18375.798320056012, 1.0]], [0, [1449.112283948172, 1.0]], [0, [375.92525207139045, 1.0]], [0, [116.70664149721605, 1.0]], [0, [41.55807821675285, 1.0]], [0, [15.122189509374955, 1.0]], [0, [7.29122321009803, 1.0]], [1, [8.595866301877555, 1.0]], [1, [0.49262775163598405, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24675374]
bas 1, expnt(s) = [0.64610973]
bas 2, expnt(s) = [117616.81383572]
bas 3, expnt(s) = [2.98855781]
bas 4, expnt(s) = [1176168.14261709]
bas 5, expnt(s) = [588084.06998163]
bas 6, expnt(s) = [294042.0310687]
bas 7, expnt(s) = [147020.99190003]
bas 8, expnt(s) = [73510.41994136]
bas 9, expnt(s) = [36754.71450111]
bas 10, expnt(s) = [7303.127247]
bas 11, expnt(s) = [18375.79832006]
bas 12, expnt(s) = [1449.11228395]
bas 13, expnt(s) = [375.92525207]
bas 14, expnt(s) = [116.7066415]
bas 15, expnt(s) = [41.55807822]
bas 16, expnt(s) = [15.12218951]
bas 17, expnt(s) = [7.29122321]
bas 18, expnt(s) = [8.5958663]
bas 19, expnt(s) = [0.49262775]
CPU time:       664.01
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.46753736e-01 8.84530528e-01 6.46109727e-01 1.82072659e+00
 1.17616814e+05 1.60460109e+04 2.98855781e+00 5.74263575e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104199e+04 1.12791586e+04 3.67547145e+04 6.70656000e+03
 7.30312725e+03 1.99593629e+03 1.83757983e+04 3.98749073e+03
 1.44911228e+03 5.93391817e+02 3.75925252e+02 2.15695532e+02
 1.16706641e+02 8.97091420e+01 4.15580782e+01 4.13529614e+01
 1.51221895e+01 1.93743005e+01 7.29122321e+00 1.12102506e+01
 8.59586630e+00 4.29384593e+01 4.92627752e-01 1.20401801e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33611335662949
cond(S) = 908750.4245603256
E1 = -689.5538007293312  E_coul = 184.92864961002755
init E= -504.625151119304
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672243400667863  LUMO = 0.676624064887625
  mo_energy =
[-1.21715108e+02 -1.33891776e+01 -7.62660441e+00 -7.62660441e+00
 -7.62660441e+00 -1.65761069e+00 -6.72243401e-01 -6.72243401e-01
 -6.72243401e-01  6.76624065e-01  9.18995016e+00  4.51786633e+01
  1.75215078e+02  6.82582037e+02  2.82289780e+03  1.22939707e+04
  4.09097793e+04  1.04950327e+05  2.30131823e+05  4.55945412e+05
  8.44896669e+05  1.52807298e+06  2.85033921e+06  5.80822501e+06]
E1 = -707.6893275181584  E_coul = 199.72423521999494
cycle= 1 E= -507.965092298163  delta_E= -3.34  |g|= 0.45  |ddm|= 0.501
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.694231
diis-c [-0.48195673  1.        ]
  HOMO = -0.218015911369613  LUMO = 1.06222398225286
  mo_energy =
[-1.20207444e+02 -1.23086288e+01 -6.59819103e+00 -6.59819103e+00
 -6.59819103e+00 -1.16362645e+00 -2.18015911e-01 -2.18015911e-01
 -2.18015911e-01  1.06222398e+00  1.00098211e+01  4.63410184e+01
  1.76626578e+02  6.84071323e+02  2.82432827e+03  1.22952922e+04
  4.09110341e+04  1.04951545e+05  2.30133017e+05  4.55946589e+05
  8.44897833e+05  1.52807413e+06  2.85034036e+06  5.80822614e+06]
E1 = -706.7467759793616  E_coul = 198.76412470086797
cycle= 2 E= -507.982651278494  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.434
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0299136
diis-c [-8.94193199e-04 -1.14565170e-03  1.00114565e+00]
  HOMO = -0.239966913396685  LUMO = 1.05657655345235
  mo_energy =
[-1.20320741e+02 -1.23753438e+01 -6.67206015e+00 -6.67206015e+00
 -6.67206015e+00 -1.17776188e+00 -2.39966913e-01 -2.39966913e-01
 -2.39966913e-01  1.05657655e+00  9.96687323e+00  4.62680561e+01
  1.76529003e+02  6.83954233e+02  2.82419517e+03  1.22951488e+04
  4.09108869e+04  1.04951397e+05  2.30132867e+05  4.55946439e+05
  8.44897682e+05  1.52807398e+06  2.85034020e+06  5.80822599e+06]
E1 = -706.6400435261424  E_coul = 198.65713555704735
cycle= 3 E= -507.982907969095  delta_E= -0.000257  |g|= 0.00433  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00321888
diis-c [-2.28960260e-06  3.77510954e-05 -1.05150305e-01  1.10511255e+00]
  HOMO = -0.243081809660714  LUMO = 1.05554121748694
  mo_energy =
[-1.20332498e+02 -1.23838726e+01 -6.68107717e+00 -6.68107717e+00
 -6.68107717e+00 -1.17964749e+00 -2.43081810e-01 -2.43081810e-01
 -2.43081810e-01  1.05554122e+00  9.96087751e+00  4.62591860e+01
  1.76518295e+02  6.83942333e+02  2.82418245e+03  1.22951356e+04
  4.09108736e+04  1.04951383e+05  2.30132854e+05  4.55946425e+05
  8.44897669e+05  1.52807397e+06  2.85034019e+06  5.80822598e+06]
E1 = -706.6250529741255  E_coul = 198.64214028316124
cycle= 4 E= -507.982912690964  delta_E= -4.72e-06  |g|= 0.000206  |ddm|= 0.00934
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000145352
diis-c [-1.30711824e-10 -7.34978863e-06  6.91942811e-03 -9.90132256e-02
  1.09210115e+00]
  HOMO = -0.243222419383712  LUMO = 1.0554876600141
  mo_energy =
[-1.20332854e+02 -1.23842125e+01 -6.68141499e+00 -6.68141499e+00
 -6.68141499e+00 -1.17973144e+00 -2.43222419e-01 -2.43222419e-01
 -2.43222419e-01  1.05548766e+00  9.96061476e+00  4.62588552e+01
  1.76517946e+02  6.83941975e+02  2.82418208e+03  1.22951353e+04
  4.09108732e+04  1.04951383e+05  2.30132854e+05  4.55946425e+05
  8.44897668e+05  1.52807397e+06  2.85034019e+06  5.80822598e+06]
E1 = -706.6243841078746  E_coul = 198.64147140673882
cycle= 5 E= -507.982912701136  delta_E= -1.02e-08  |g|= 1.2e-06  |ddm|= 0.000471
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.59815e-07
diis-c [-7.62770347e-14  2.46384013e-07 -1.54468949e-04  2.00601843e-03
 -2.35338855e-02  1.02168209e+00]
  HOMO = -0.243223116497841  LUMO = 1.05548754534226
  mo_energy =
[-1.20332857e+02 -1.23842142e+01 -6.68141671e+00 -6.68141671e+00
 -6.68141671e+00 -1.17973199e+00 -2.43223116e-01 -2.43223116e-01
 -2.43223116e-01  1.05548755e+00  9.96061349e+00  4.62588535e+01
  1.76517944e+02  6.83941973e+02  2.82418208e+03  1.22951353e+04
  4.09108732e+04  1.04951383e+05  2.30132854e+05  4.55946425e+05
  8.44897668e+05  1.52807397e+06  2.85034019e+06  5.80822598e+06]
E1 = -706.6243805142085  E_coul = 198.64146781307298
cycle= 6 E= -507.982912701136  delta_E= 2.27e-13  |g|= 4.04e-08  |ddm|= 2.68e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6243805142085  E_coul = 198.64146781307298
  HOMO = -0.24322313734309  LUMO = 1.05548753167526
  mo_energy =
[-1.20332857e+02 -1.23842142e+01 -6.68141675e+00 -6.68141675e+00
 -6.68141675e+00 -1.17973201e+00 -2.43223137e-01 -2.43223137e-01
 -2.43223137e-01  1.05548753e+00  9.96061345e+00  4.62588535e+01
  1.76517944e+02  6.83941973e+02  2.82418208e+03  1.22951353e+04
  4.09108732e+04  1.04951383e+05  2.30132854e+05  4.55946425e+05
  8.44897668e+05  1.52807397e+06  2.85034019e+06  5.80822598e+06]
E1 = -706.624380421051  E_coul = 198.6414677199157
Extra cycle  E= -507.982912701135  delta_E= 2.27e-13  |g|= 5.51e-09  |ddm|= 7.68e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.46753736e-01 6.46109727e-01 1.17616814e+05 2.98855781e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104199e+04 3.67547145e+04 7.30312725e+03 1.83757983e+04
 1.44911228e+03 3.75925252e+02 1.16706641e+02 4.15580782e+01
 1.51221895e+01 7.29122321e+00 8.59586630e+00 4.92627752e-01]
E = -507.9829127011353
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:12:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.246753735793       1
[INPUT] 0    0    [1    /1   ]  0.646109726913       1
[INPUT] 0    0    [1    /1   ]  117616.813836        1
[INPUT] 0    0    [1    /1   ]  2.98855780927        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031069        1
[INPUT] 0    0    [1    /1   ]  147020.9919          1
[INPUT] 0    0    [1    /1   ]  73510.4199414        1
[INPUT] 0    0    [1    /1   ]  36754.7145011        1
[INPUT] 0    0    [1    /1   ]  7303.127247          1
[INPUT] 0    0    [1    /1   ]  18375.7983201        1
[INPUT] 0    0    [1    /1   ]  1449.11228395        1
[INPUT] 0    0    [1    /1   ]  375.925252071        1
[INPUT] 0    0    [1    /1   ]  116.706641497        1
[INPUT] 0    0    [1    /1   ]  41.5580782168        1
[INPUT] 0    0    [1    /1   ]  15.1221895094        1
[INPUT] 0    0    [1    /1   ]  7.2912232101         1
[INPUT] 1    0    [1    /1   ]  8.59586630188        1
[INPUT] 1    0    [1    /1   ]  0.492627751636       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24675373579293156, 1.0]], [0, [0.6461097269134548, 1.0]], [0, [117616.81383571588, 1.0]], [0, [2.9885578092718212, 1.0]], [0, [1176168.1426170857, 1.0]], [0, [588084.069981629, 1.0]], [0, [294042.0310686986, 1.0]], [0, [147020.9919000252, 1.0]], [0, [73510.41994136217, 1.0]], [0, [36754.71450111383, 1.0]], [0, [7303.127247003773, 1.0]], [0, [18375.798320056012, 1.0]], [0, [1449.112283948172, 1.0]], [0, [375.92525207139045, 1.0]], [0, [116.70664149721605, 1.0]], [0, [41.55807821675285, 1.0]], [0, [15.122189509374955, 1.0]], [0, [7.29122321009803, 1.0]], [1, [8.595866301877555, 1.0]], [1, [0.49262775163598405, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24675374]
bas 1, expnt(s) = [0.64610973]
bas 2, expnt(s) = [117616.81383572]
bas 3, expnt(s) = [2.98855781]
bas 4, expnt(s) = [1176168.14261709]
bas 5, expnt(s) = [588084.06998163]
bas 6, expnt(s) = [294042.0310687]
bas 7, expnt(s) = [147020.99190003]
bas 8, expnt(s) = [73510.41994136]
bas 9, expnt(s) = [36754.71450111]
bas 10, expnt(s) = [7303.127247]
bas 11, expnt(s) = [18375.79832006]
bas 12, expnt(s) = [1449.11228395]
bas 13, expnt(s) = [375.92525207]
bas 14, expnt(s) = [116.7066415]
bas 15, expnt(s) = [41.55807822]
bas 16, expnt(s) = [15.12218951]
bas 17, expnt(s) = [7.29122321]
bas 18, expnt(s) = [8.5958663]
bas 19, expnt(s) = [0.49262775]
CPU time:       665.45
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.46753736e-01 8.84530528e-01 6.46109727e-01 1.82072659e+00
 1.17616814e+05 1.60460109e+04 2.98855781e+00 5.74263575e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104199e+04 1.12791586e+04 3.67547145e+04 6.70656000e+03
 7.30312725e+03 1.99593629e+03 1.83757983e+04 3.98749073e+03
 1.44911228e+03 5.93391817e+02 3.75925252e+02 2.15695532e+02
 1.16706641e+02 8.97091420e+01 4.15580782e+01 4.13529614e+01
 1.51221895e+01 1.93743005e+01 7.29122321e+00 1.12102506e+01
 8.59586630e+00 4.29384593e+01 4.92627752e-01 1.20401801e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33611335662949
cond(S) = 908750.4245603256
E1 = -689.5538007293312  E_coul = 184.92864961002755
init E= -504.625151119304
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672243400667863  LUMO = 0.676624064887625
  mo_energy =
[-1.21715108e+02 -1.33891776e+01 -7.62660441e+00 -7.62660441e+00
 -7.62660441e+00 -1.65761069e+00 -6.72243401e-01 -6.72243401e-01
 -6.72243401e-01  6.76624065e-01  9.18995016e+00  4.51786633e+01
  1.75215078e+02  6.82582037e+02  2.82289780e+03  1.22939707e+04
  4.09097793e+04  1.04950327e+05  2.30131823e+05  4.55945412e+05
  8.44896669e+05  1.52807298e+06  2.85033921e+06  5.80822501e+06]
E1 = -707.6893275181584  E_coul = 199.72423521999494
cycle= 1 E= -507.965092298163  delta_E= -3.34  |g|= 0.45  |ddm|= 0.501
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.694231
diis-c [-0.48195673  1.        ]
  HOMO = -0.218015911369613  LUMO = 1.06222398225286
  mo_energy =
[-1.20207444e+02 -1.23086288e+01 -6.59819103e+00 -6.59819103e+00
 -6.59819103e+00 -1.16362645e+00 -2.18015911e-01 -2.18015911e-01
 -2.18015911e-01  1.06222398e+00  1.00098211e+01  4.63410184e+01
  1.76626578e+02  6.84071323e+02  2.82432827e+03  1.22952922e+04
  4.09110341e+04  1.04951545e+05  2.30133017e+05  4.55946589e+05
  8.44897833e+05  1.52807413e+06  2.85034036e+06  5.80822614e+06]
E1 = -706.7467759793616  E_coul = 198.76412470086797
cycle= 2 E= -507.982651278494  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.434
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0299136
diis-c [-8.94193199e-04 -1.14565170e-03  1.00114565e+00]
  HOMO = -0.239966913396685  LUMO = 1.05657655345235
  mo_energy =
[-1.20320741e+02 -1.23753438e+01 -6.67206015e+00 -6.67206015e+00
 -6.67206015e+00 -1.17776188e+00 -2.39966913e-01 -2.39966913e-01
 -2.39966913e-01  1.05657655e+00  9.96687323e+00  4.62680561e+01
  1.76529003e+02  6.83954233e+02  2.82419517e+03  1.22951488e+04
  4.09108869e+04  1.04951397e+05  2.30132867e+05  4.55946439e+05
  8.44897682e+05  1.52807398e+06  2.85034020e+06  5.80822599e+06]
E1 = -706.6400435261424  E_coul = 198.65713555704735
cycle= 3 E= -507.982907969095  delta_E= -0.000257  |g|= 0.00433  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00321888
diis-c [-2.28960260e-06  3.77510954e-05 -1.05150305e-01  1.10511255e+00]
  HOMO = -0.243081809660714  LUMO = 1.05554121748694
  mo_energy =
[-1.20332498e+02 -1.23838726e+01 -6.68107717e+00 -6.68107717e+00
 -6.68107717e+00 -1.17964749e+00 -2.43081810e-01 -2.43081810e-01
 -2.43081810e-01  1.05554122e+00  9.96087751e+00  4.62591860e+01
  1.76518295e+02  6.83942333e+02  2.82418245e+03  1.22951356e+04
  4.09108736e+04  1.04951383e+05  2.30132854e+05  4.55946425e+05
  8.44897669e+05  1.52807397e+06  2.85034019e+06  5.80822598e+06]
E1 = -706.6250529741255  E_coul = 198.64214028316124
cycle= 4 E= -507.982912690964  delta_E= -4.72e-06  |g|= 0.000206  |ddm|= 0.00934
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000145352
diis-c [-1.30711824e-10 -7.34978863e-06  6.91942811e-03 -9.90132256e-02
  1.09210115e+00]
  HOMO = -0.243222419383712  LUMO = 1.0554876600141
  mo_energy =
[-1.20332854e+02 -1.23842125e+01 -6.68141499e+00 -6.68141499e+00
 -6.68141499e+00 -1.17973144e+00 -2.43222419e-01 -2.43222419e-01
 -2.43222419e-01  1.05548766e+00  9.96061476e+00  4.62588552e+01
  1.76517946e+02  6.83941975e+02  2.82418208e+03  1.22951353e+04
  4.09108732e+04  1.04951383e+05  2.30132854e+05  4.55946425e+05
  8.44897668e+05  1.52807397e+06  2.85034019e+06  5.80822598e+06]
E1 = -706.6243841078746  E_coul = 198.64147140673882
cycle= 5 E= -507.982912701136  delta_E= -1.02e-08  |g|= 1.2e-06  |ddm|= 0.000471
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.59815e-07
diis-c [-7.62770347e-14  2.46384013e-07 -1.54468949e-04  2.00601843e-03
 -2.35338855e-02  1.02168209e+00]
  HOMO = -0.243223116497841  LUMO = 1.05548754534226
  mo_energy =
[-1.20332857e+02 -1.23842142e+01 -6.68141671e+00 -6.68141671e+00
 -6.68141671e+00 -1.17973199e+00 -2.43223116e-01 -2.43223116e-01
 -2.43223116e-01  1.05548755e+00  9.96061349e+00  4.62588535e+01
  1.76517944e+02  6.83941973e+02  2.82418208e+03  1.22951353e+04
  4.09108732e+04  1.04951383e+05  2.30132854e+05  4.55946425e+05
  8.44897668e+05  1.52807397e+06  2.85034019e+06  5.80822598e+06]
E1 = -706.6243805142085  E_coul = 198.64146781307298
cycle= 6 E= -507.982912701136  delta_E= 2.27e-13  |g|= 4.04e-08  |ddm|= 2.68e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6243805142085  E_coul = 198.64146781307298
  HOMO = -0.24322313734309  LUMO = 1.05548753167526
  mo_energy =
[-1.20332857e+02 -1.23842142e+01 -6.68141675e+00 -6.68141675e+00
 -6.68141675e+00 -1.17973201e+00 -2.43223137e-01 -2.43223137e-01
 -2.43223137e-01  1.05548753e+00  9.96061345e+00  4.62588535e+01
  1.76517944e+02  6.83941973e+02  2.82418208e+03  1.22951353e+04
  4.09108732e+04  1.04951383e+05  2.30132854e+05  4.55946425e+05
  8.44897668e+05  1.52807397e+06  2.85034019e+06  5.80822598e+06]
E1 = -706.624380421051  E_coul = 198.6414677199157
Extra cycle  E= -507.982912701135  delta_E= 2.27e-13  |g|= 5.51e-09  |ddm|= 7.68e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908750.4245603256
E1 = -706.624380421051  E_coul = 198.6414677199157
init E= -507.982912701135
    CPU time for initialize scf      3.34 sec, wall time      0.21 sec
  HOMO = -0.243223140176482  LUMO = 1.05548753348692
  mo_energy =
[-1.20332857e+02 -1.23842142e+01 -6.68141676e+00 -6.68141676e+00
 -6.68141676e+00 -1.17973201e+00 -2.43223140e-01 -2.43223140e-01
 -2.43223140e-01  1.05548753e+00  9.96061344e+00  4.62588535e+01
  1.76517943e+02  6.83941973e+02  2.82418208e+03  1.22951353e+04
  4.09108732e+04  1.04951383e+05  2.30132854e+05  4.55946425e+05
  8.44897668e+05  1.52807397e+06  2.85034019e+06  5.80822598e+06]
E1 = -706.6243804027799  E_coul = 198.64146770164442
cycle= 1 E= -507.982912701136  delta_E= -2.27e-13  |g|= 1.17e-09  |ddm|= 1.28e-08
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.6243804027799  E_coul = 198.64146770164442
  HOMO = -0.243223140706121  LUMO = 1.0554875317495
  mo_energy =
[-1.20332857e+02 -1.23842142e+01 -6.68141676e+00 -6.68141676e+00
 -6.68141676e+00 -1.17973201e+00 -2.43223141e-01 -2.43223141e-01
 -2.43223141e-01  1.05548753e+00  9.96061344e+00  4.62588535e+01
  1.76517943e+02  6.83941973e+02  2.82418208e+03  1.22951353e+04
  4.09108732e+04  1.04951383e+05  2.30132854e+05  4.55946425e+05
  8.44897668e+05  1.52807397e+06  2.85034019e+06  5.80822598e+06]
E1 = -706.6243804007073  E_coul = 198.64146769957176
Extra cycle  E= -507.982912701136  delta_E=    0  |g|= 2.01e-09  |ddm|= 1.36e-09
    CPU time for scf_cycle      3.78 sec, wall time      0.38 sec
exp = [2.46753736e-01 6.46109727e-01 1.17616814e+05 2.98855781e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104199e+04 3.67547145e+04 7.30312725e+03 1.83757983e+04
 1.44911228e+03 3.75925252e+02 1.16706641e+02 4.15580782e+01
 1.51221895e+01 7.29122321e+00 8.59586630e+00 4.92627752e-01]
grad_E = [-3.89868923e-03  1.58274559e-03  4.18425198e-09 -1.47667668e-03
  1.87935433e-11  1.12833884e-10  6.51022063e-10  2.55303431e-09
  1.06064526e-08  5.70553739e-08  3.58554733e-06  1.22676867e-07
  6.63112843e-06 -3.60157850e-05 -1.54017940e-04 -9.66078222e-04
  1.71933160e-04  1.41748612e-03 -6.91192197e-03  5.28755797e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:12:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.252394340251       1
[INPUT] 0    0    [1    /1   ]  0.655973846131       1
[INPUT] 0    0    [1    /1   ]  117616.813832        1
[INPUT] 0    0    [1    /1   ]  3.0323329927         1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031068        1
[INPUT] 0    0    [1    /1   ]  147020.991898        1
[INPUT] 0    0    [1    /1   ]  73510.4199313        1
[INPUT] 0    0    [1    /1   ]  36754.7144471        1
[INPUT] 0    0    [1    /1   ]  7303.12383561        1
[INPUT] 0    0    [1    /1   ]  18375.7982014        1
[INPUT] 0    0    [1    /1   ]  1449.11633302        1
[INPUT] 0    0    [1    /1   ]  375.858515527        1
[INPUT] 0    0    [1    /1   ]  117.045945998        1
[INPUT] 0    0    [1    /1   ]  42.0393369332        1
[INPUT] 0    0    [1    /1   ]  15.7357038218        1
[INPUT] 0    0    [1    /1   ]  7.48252223268        1
[INPUT] 1    0    [1    /1   ]  8.60211368041        1
[INPUT] 1    0    [1    /1   ]  0.492675222729       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.25239434025141255, 1.0]], [0, [0.6559738461307365, 1.0]], [0, [117616.81383174431, 1.0]], [0, [3.0323329927039104, 1.0]], [0, [1176168.1426170664, 1.0]], [0, [588084.0699815208, 1.0]], [0, [294042.0310680809, 1.0]], [0, [147020.99189760018, 1.0]], [0, [73510.41993127903, 1.0]], [0, [36754.714447138125, 1.0]], [0, [7303.123835607481, 1.0]], [0, [18375.798201419388, 1.0]], [0, [1449.1163330180034, 1.0]], [0, [375.8585155274671, 1.0]], [0, [117.04594599828455, 1.0]], [0, [42.03933693317833, 1.0]], [0, [15.735703821822504, 1.0]], [0, [7.482522232677982, 1.0]], [1, [8.602113680407388, 1.0]], [1, [0.4926752227285975, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25239434]
bas 1, expnt(s) = [0.65597385]
bas 2, expnt(s) = [117616.81383174]
bas 3, expnt(s) = [3.03233299]
bas 4, expnt(s) = [1176168.14261707]
bas 5, expnt(s) = [588084.06998152]
bas 6, expnt(s) = [294042.03106808]
bas 7, expnt(s) = [147020.9918976]
bas 8, expnt(s) = [73510.41993128]
bas 9, expnt(s) = [36754.71444714]
bas 10, expnt(s) = [7303.12383561]
bas 11, expnt(s) = [18375.79820142]
bas 12, expnt(s) = [1449.11633302]
bas 13, expnt(s) = [375.85851553]
bas 14, expnt(s) = [117.045946]
bas 15, expnt(s) = [42.03933693]
bas 16, expnt(s) = [15.73570382]
bas 17, expnt(s) = [7.48252223]
bas 18, expnt(s) = [8.60211368]
bas 19, expnt(s) = [0.49267522]
CPU time:       677.23
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.52394340e-01 8.99652380e-01 6.55973846e-01 1.84153475e+00
 1.17616814e+05 1.60460109e+04 3.03233299e+00 5.80560779e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104199e+04 1.12791586e+04 3.67547144e+04 6.70655999e+03
 7.30312384e+03 1.99593559e+03 1.83757982e+04 3.98749071e+03
 1.44911633e+03 5.93393060e+02 3.75858516e+02 2.15666813e+02
 1.17045946e+02 8.99046814e+01 4.20393369e+01 4.17116066e+01
 1.57357038e+01 1.99608786e+01 7.48252223e+00 1.14301265e+01
 8.60211368e+00 4.29774719e+01 4.92675223e-01 1.20416304e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33595299682556
cond(S) = 908823.7620272014
E1 = -689.5827222217462  E_coul = 184.95739947568833
init E= -504.625322746058
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672281018683285  LUMO = 0.705395277422658
  mo_energy =
[-1.21709277e+02 -1.33868833e+01 -7.62458735e+00 -7.62458735e+00
 -7.62458735e+00 -1.65748570e+00 -6.72281019e-01 -6.72281019e-01
 -6.72281019e-01  7.05395277e-01  9.51810623e+00  4.68990184e+01
  1.79459579e+02  6.88495099e+02  2.82878565e+03  1.22992160e+04
  4.09146464e+04  1.04954994e+05  2.30136359e+05  4.55949854e+05
  8.44901038e+05  1.52807728e+06  2.85034342e+06  5.80822911e+06]
E1 = -707.7237072073568  E_coul = 199.75840583230757
cycle= 1 E= -507.965301375049  delta_E= -3.34  |g|= 0.451  |ddm|= 0.504
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.695366
diis-c [-0.48353358  1.        ]
  HOMO = -0.217868126961281  LUMO = 1.09629718599599
  mo_energy =
[-1.20201061e+02 -1.23060018e+01 -6.59576719e+00 -6.59576719e+00
 -6.59576719e+00 -1.16336373e+00 -2.17868127e-01 -2.17868127e-01
 -2.17868127e-01  1.09629719e+00  1.03477521e+01  4.80707971e+01
  1.80873578e+02  6.89984900e+02  2.83021664e+03  1.23005380e+04
  4.09159015e+04  1.04956213e+05  2.30137554e+05  4.55951031e+05
  8.44902202e+05  1.52807843e+06  2.85034457e+06  5.80823024e+06]
E1 = -706.7827464958679  E_coul = 198.79991077652724
cycle= 2 E= -507.982835719341  delta_E= -0.0175  |g|= 0.0347  |ddm|= 0.436
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297084
diis-c [-8.82371544e-04 -6.75015201e-04  1.00067502e+00]
  HOMO = -0.239733676454393  LUMO = 1.09044710011856
  mo_energy =
[-1.20314209e+02 -1.23725684e+01 -6.66949590e+00 -6.66949590e+00
 -6.66949590e+00 -1.17743235e+00 -2.39733676e-01 -2.39733676e-01
 -2.39733676e-01  1.09044710e+00  1.03041676e+01  4.79972433e+01
  1.80775906e+02  6.89867953e+02  2.83008369e+03  1.23003948e+04
  4.09157546e+04  1.04956064e+05  2.30137404e+05  4.55950881e+05
  8.44902052e+05  1.52807828e+06  2.85034442e+06  5.80823009e+06]
E1 = -706.676867021766  E_coul = 198.69377807729387
cycle= 3 E= -507.983088944472  delta_E= -0.000253  |g|= 0.00431  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00318075
diis-c [-2.23126556e-06  3.36017132e-05 -1.04582602e-01  1.10454900e+00]
  HOMO = -0.24282128500054  LUMO = 1.089389690508
  mo_energy =
[-1.20325940e+02 -1.23810580e+01 -6.67847660e+00 -6.67847660e+00
 -6.67847660e+00 -1.17929971e+00 -2.42821285e-01 -2.42821285e-01
 -2.42821285e-01  1.08938969e+00  1.02981271e+01  4.79883484e+01
  1.80765212e+02  6.89856077e+02  2.83007099e+03  1.23003816e+04
  4.09157412e+04  1.04956051e+05  2.30137391e+05  4.55950867e+05
  8.44902038e+05  1.52807827e+06  2.85034440e+06  5.80823008e+06]
E1 = -706.6620632741308  E_coul = 198.67896972335274
cycle= 4 E= -507.983093550778  delta_E= -4.61e-06  |g|= 0.000202  |ddm|= 0.00923
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000142862
diis-c [-1.21987069e-10 -7.23839508e-06  6.91366547e-03 -9.88866659e-02
  1.09198024e+00]
  HOMO = -0.242959234706355  LUMO = 1.08933583367555
  mo_energy =
[-1.20326293e+02 -1.23813941e+01 -6.67881087e+00 -6.67881087e+00
 -6.67881087e+00 -1.17938194e+00 -2.42959235e-01 -2.42959235e-01
 -2.42959235e-01  1.08933583e+00  1.02978657e+01  4.79880202e+01
  1.80764865e+02  6.89855723e+02  2.83007063e+03  1.23003813e+04
  4.09157409e+04  1.04956050e+05  2.30137390e+05  4.55950867e+05
  8.44902038e+05  1.52807827e+06  2.85034440e+06  5.80823008e+06]
E1 = -706.6614096841735  E_coul = 198.67831612373308
cycle= 5 E= -507.98309356044  delta_E= -9.66e-09  |g|= 1.01e-06  |ddm|= 0.000458
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.7191e-07
diis-c [-5.16707273e-14  2.16747115e-07 -1.28139334e-04  1.64262526e-03
 -1.92639280e-02  1.01774923e+00]
  HOMO = -0.24295982419229  LUMO = 1.08933575260012
  mo_energy =
[-1.20326296e+02 -1.23813955e+01 -6.67881236e+00 -6.67881236e+00
 -6.67881236e+00 -1.17938243e+00 -2.42959824e-01 -2.42959824e-01
 -2.42959824e-01  1.08933575e+00  1.02978646e+01  4.79880187e+01
  1.80764863e+02  6.89855721e+02  2.83007063e+03  1.23003813e+04
  4.09157409e+04  1.04956050e+05  2.30137390e+05  4.55950867e+05
  8.44902038e+05  1.52807827e+06  2.85034440e+06  5.80823008e+06]
E1 = -706.661406648209  E_coul = 198.6783130877686
cycle= 6 E= -507.98309356044  delta_E=    0  |g|= 3.37e-08  |ddm|= 2.22e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.661406648209  E_coul = 198.6783130877686
  HOMO = -0.242959841547757  LUMO = 1.08933574305983
  mo_energy =
[-1.20326296e+02 -1.23813955e+01 -6.67881239e+00 -6.67881239e+00
 -6.67881239e+00 -1.17938244e+00 -2.42959842e-01 -2.42959842e-01
 -2.42959842e-01  1.08933574e+00  1.02978646e+01  4.79880187e+01
  1.80764863e+02  6.89855721e+02  2.83007063e+03  1.23003813e+04
  4.09157409e+04  1.04956050e+05  2.30137390e+05  4.55950867e+05
  8.44902038e+05  1.52807827e+06  2.85034440e+06  5.80823008e+06]
E1 = -706.6614065700901  E_coul = 198.67831300964932
Extra cycle  E= -507.983093560441  delta_E= -4.55e-13  |g|= 4.28e-09  |ddm|= 6.42e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.52394340e-01 6.55973846e-01 1.17616814e+05 3.03233299e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104199e+04 3.67547144e+04 7.30312384e+03 1.83757982e+04
 1.44911633e+03 3.75858516e+02 1.17045946e+02 4.20393369e+01
 1.57357038e+01 7.48252223e+00 8.60211368e+00 4.92675223e-01]
E = -507.9830935604408
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:12:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.252394340251       1
[INPUT] 0    0    [1    /1   ]  0.655973846131       1
[INPUT] 0    0    [1    /1   ]  117616.813832        1
[INPUT] 0    0    [1    /1   ]  3.0323329927         1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069982        1
[INPUT] 0    0    [1    /1   ]  294042.031068        1
[INPUT] 0    0    [1    /1   ]  147020.991898        1
[INPUT] 0    0    [1    /1   ]  73510.4199313        1
[INPUT] 0    0    [1    /1   ]  36754.7144471        1
[INPUT] 0    0    [1    /1   ]  7303.12383561        1
[INPUT] 0    0    [1    /1   ]  18375.7982014        1
[INPUT] 0    0    [1    /1   ]  1449.11633302        1
[INPUT] 0    0    [1    /1   ]  375.858515527        1
[INPUT] 0    0    [1    /1   ]  117.045945998        1
[INPUT] 0    0    [1    /1   ]  42.0393369332        1
[INPUT] 0    0    [1    /1   ]  15.7357038218        1
[INPUT] 0    0    [1    /1   ]  7.48252223268        1
[INPUT] 1    0    [1    /1   ]  8.60211368041        1
[INPUT] 1    0    [1    /1   ]  0.492675222729       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.25239434025141255, 1.0]], [0, [0.6559738461307365, 1.0]], [0, [117616.81383174431, 1.0]], [0, [3.0323329927039104, 1.0]], [0, [1176168.1426170664, 1.0]], [0, [588084.0699815208, 1.0]], [0, [294042.0310680809, 1.0]], [0, [147020.99189760018, 1.0]], [0, [73510.41993127903, 1.0]], [0, [36754.714447138125, 1.0]], [0, [7303.123835607481, 1.0]], [0, [18375.798201419388, 1.0]], [0, [1449.1163330180034, 1.0]], [0, [375.8585155274671, 1.0]], [0, [117.04594599828455, 1.0]], [0, [42.03933693317833, 1.0]], [0, [15.735703821822504, 1.0]], [0, [7.482522232677982, 1.0]], [1, [8.602113680407388, 1.0]], [1, [0.4926752227285975, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25239434]
bas 1, expnt(s) = [0.65597385]
bas 2, expnt(s) = [117616.81383174]
bas 3, expnt(s) = [3.03233299]
bas 4, expnt(s) = [1176168.14261707]
bas 5, expnt(s) = [588084.06998152]
bas 6, expnt(s) = [294042.03106808]
bas 7, expnt(s) = [147020.9918976]
bas 8, expnt(s) = [73510.41993128]
bas 9, expnt(s) = [36754.71444714]
bas 10, expnt(s) = [7303.12383561]
bas 11, expnt(s) = [18375.79820142]
bas 12, expnt(s) = [1449.11633302]
bas 13, expnt(s) = [375.85851553]
bas 14, expnt(s) = [117.045946]
bas 15, expnt(s) = [42.03933693]
bas 16, expnt(s) = [15.73570382]
bas 17, expnt(s) = [7.48252223]
bas 18, expnt(s) = [8.60211368]
bas 19, expnt(s) = [0.49267522]
CPU time:       678.67
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.52394340e-01 8.99652380e-01 6.55973846e-01 1.84153475e+00
 1.17616814e+05 1.60460109e+04 3.03233299e+00 5.80560779e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104199e+04 1.12791586e+04 3.67547144e+04 6.70655999e+03
 7.30312384e+03 1.99593559e+03 1.83757982e+04 3.98749071e+03
 1.44911633e+03 5.93393060e+02 3.75858516e+02 2.15666813e+02
 1.17045946e+02 8.99046814e+01 4.20393369e+01 4.17116066e+01
 1.57357038e+01 1.99608786e+01 7.48252223e+00 1.14301265e+01
 8.60211368e+00 4.29774719e+01 4.92675223e-01 1.20416304e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33595299682556
cond(S) = 908823.7620272014
E1 = -689.5827222217462  E_coul = 184.95739947568833
init E= -504.625322746058
    CPU time for initialize scf      0.42 sec, wall time      0.06 sec
  HOMO = -0.672281018683285  LUMO = 0.705395277422658
  mo_energy =
[-1.21709277e+02 -1.33868833e+01 -7.62458735e+00 -7.62458735e+00
 -7.62458735e+00 -1.65748570e+00 -6.72281019e-01 -6.72281019e-01
 -6.72281019e-01  7.05395277e-01  9.51810623e+00  4.68990184e+01
  1.79459579e+02  6.88495099e+02  2.82878565e+03  1.22992160e+04
  4.09146464e+04  1.04954994e+05  2.30136359e+05  4.55949854e+05
  8.44901038e+05  1.52807728e+06  2.85034342e+06  5.80822911e+06]
E1 = -707.7237072073568  E_coul = 199.75840583230757
cycle= 1 E= -507.965301375049  delta_E= -3.34  |g|= 0.451  |ddm|= 0.504
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.695366
diis-c [-0.48353358  1.        ]
  HOMO = -0.217868126961281  LUMO = 1.09629718599599
  mo_energy =
[-1.20201061e+02 -1.23060018e+01 -6.59576719e+00 -6.59576719e+00
 -6.59576719e+00 -1.16336373e+00 -2.17868127e-01 -2.17868127e-01
 -2.17868127e-01  1.09629719e+00  1.03477521e+01  4.80707971e+01
  1.80873578e+02  6.89984900e+02  2.83021664e+03  1.23005380e+04
  4.09159015e+04  1.04956213e+05  2.30137554e+05  4.55951031e+05
  8.44902202e+05  1.52807843e+06  2.85034457e+06  5.80823024e+06]
E1 = -706.7827464958679  E_coul = 198.79991077652724
cycle= 2 E= -507.982835719341  delta_E= -0.0175  |g|= 0.0347  |ddm|= 0.436
    CPU time for cycle= 2      0.10 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297084
diis-c [-8.82371544e-04 -6.75015201e-04  1.00067502e+00]
  HOMO = -0.239733676454393  LUMO = 1.09044710011856
  mo_energy =
[-1.20314209e+02 -1.23725684e+01 -6.66949590e+00 -6.66949590e+00
 -6.66949590e+00 -1.17743235e+00 -2.39733676e-01 -2.39733676e-01
 -2.39733676e-01  1.09044710e+00  1.03041676e+01  4.79972433e+01
  1.80775906e+02  6.89867953e+02  2.83008369e+03  1.23003948e+04
  4.09157546e+04  1.04956064e+05  2.30137404e+05  4.55950881e+05
  8.44902052e+05  1.52807828e+06  2.85034442e+06  5.80823009e+06]
E1 = -706.676867021766  E_coul = 198.69377807729387
cycle= 3 E= -507.983088944472  delta_E= -0.000253  |g|= 0.00431  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00318075
diis-c [-2.23126556e-06  3.36017132e-05 -1.04582602e-01  1.10454900e+00]
  HOMO = -0.24282128500054  LUMO = 1.089389690508
  mo_energy =
[-1.20325940e+02 -1.23810580e+01 -6.67847660e+00 -6.67847660e+00
 -6.67847660e+00 -1.17929971e+00 -2.42821285e-01 -2.42821285e-01
 -2.42821285e-01  1.08938969e+00  1.02981271e+01  4.79883484e+01
  1.80765212e+02  6.89856077e+02  2.83007099e+03  1.23003816e+04
  4.09157412e+04  1.04956051e+05  2.30137391e+05  4.55950867e+05
  8.44902038e+05  1.52807827e+06  2.85034440e+06  5.80823008e+06]
E1 = -706.6620632741308  E_coul = 198.67896972335274
cycle= 4 E= -507.983093550778  delta_E= -4.61e-06  |g|= 0.000202  |ddm|= 0.00923
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000142862
diis-c [-1.21987069e-10 -7.23839508e-06  6.91366547e-03 -9.88866659e-02
  1.09198024e+00]
  HOMO = -0.242959234706355  LUMO = 1.08933583367555
  mo_energy =
[-1.20326293e+02 -1.23813941e+01 -6.67881087e+00 -6.67881087e+00
 -6.67881087e+00 -1.17938194e+00 -2.42959235e-01 -2.42959235e-01
 -2.42959235e-01  1.08933583e+00  1.02978657e+01  4.79880202e+01
  1.80764865e+02  6.89855723e+02  2.83007063e+03  1.23003813e+04
  4.09157409e+04  1.04956050e+05  2.30137390e+05  4.55950867e+05
  8.44902038e+05  1.52807827e+06  2.85034440e+06  5.80823008e+06]
E1 = -706.6614096841735  E_coul = 198.67831612373308
cycle= 5 E= -507.98309356044  delta_E= -9.66e-09  |g|= 1.01e-06  |ddm|= 0.000458
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.7191e-07
diis-c [-5.16707273e-14  2.16747115e-07 -1.28139334e-04  1.64262526e-03
 -1.92639280e-02  1.01774923e+00]
  HOMO = -0.24295982419229  LUMO = 1.08933575260012
  mo_energy =
[-1.20326296e+02 -1.23813955e+01 -6.67881236e+00 -6.67881236e+00
 -6.67881236e+00 -1.17938243e+00 -2.42959824e-01 -2.42959824e-01
 -2.42959824e-01  1.08933575e+00  1.02978646e+01  4.79880187e+01
  1.80764863e+02  6.89855721e+02  2.83007063e+03  1.23003813e+04
  4.09157409e+04  1.04956050e+05  2.30137390e+05  4.55950867e+05
  8.44902038e+05  1.52807827e+06  2.85034440e+06  5.80823008e+06]
E1 = -706.661406648209  E_coul = 198.6783130877686
cycle= 6 E= -507.98309356044  delta_E=    0  |g|= 3.37e-08  |ddm|= 2.22e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.661406648209  E_coul = 198.6783130877686
  HOMO = -0.242959841547757  LUMO = 1.08933574305983
  mo_energy =
[-1.20326296e+02 -1.23813955e+01 -6.67881239e+00 -6.67881239e+00
 -6.67881239e+00 -1.17938244e+00 -2.42959842e-01 -2.42959842e-01
 -2.42959842e-01  1.08933574e+00  1.02978646e+01  4.79880187e+01
  1.80764863e+02  6.89855721e+02  2.83007063e+03  1.23003813e+04
  4.09157409e+04  1.04956050e+05  2.30137390e+05  4.55950867e+05
  8.44902038e+05  1.52807827e+06  2.85034440e+06  5.80823008e+06]
E1 = -706.6614065700901  E_coul = 198.67831300964932
Extra cycle  E= -507.983093560441  delta_E= -4.55e-13  |g|= 4.28e-09  |ddm|= 6.42e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908823.7620272014
E1 = -706.6614065700901  E_coul = 198.67831300964932
init E= -507.983093560441
    CPU time for initialize scf      3.38 sec, wall time      0.21 sec
  HOMO = -0.242959843924827  LUMO = 1.08933574122605
  mo_energy =
[-1.20326296e+02 -1.23813956e+01 -6.67881240e+00 -6.67881240e+00
 -6.67881240e+00 -1.17938244e+00 -2.42959844e-01 -2.42959844e-01
 -2.42959844e-01  1.08933574e+00  1.02978646e+01  4.79880187e+01
  1.80764863e+02  6.89855721e+02  2.83007063e+03  1.23003813e+04
  4.09157409e+04  1.04956050e+05  2.30137390e+05  4.55950867e+05
  8.44902038e+05  1.52807827e+06  2.85034440e+06  5.80823008e+06]
E1 = -706.6614065586517  E_coul = 198.67831299821114
cycle= 1 E= -507.983093560441  delta_E= 2.27e-13  |g|= 1.04e-09  |ddm|= 8.11e-09
    CPU time for cycle= 1      0.29 sec, wall time      0.03 sec
E1 = -706.6614065586517  E_coul = 198.67831299821114
  HOMO = -0.242959844250989  LUMO = 1.08933574163852
  mo_energy =
[-1.20326296e+02 -1.23813956e+01 -6.67881240e+00 -6.67881240e+00
 -6.67881240e+00 -1.17938244e+00 -2.42959844e-01 -2.42959844e-01
 -2.42959844e-01  1.08933574e+00  1.02978646e+01  4.79880187e+01
  1.80764863e+02  6.89855721e+02  2.83007063e+03  1.23003813e+04
  4.09157409e+04  1.04956050e+05  2.30137390e+05  4.55950867e+05
  8.44902038e+05  1.52807827e+06  2.85034440e+06  5.80823008e+06]
E1 = -706.6614065579404  E_coul = 198.6783129975
Extra cycle  E= -507.98309356044  delta_E= 2.27e-13  |g|= 1.34e-09  |ddm|= 6.27e-10
    CPU time for scf_cycle      3.82 sec, wall time      0.38 sec
exp = [2.52394340e-01 6.55973846e-01 1.17616814e+05 3.03233299e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104199e+04 3.67547144e+04 7.30312384e+03 1.83757982e+04
 1.44911633e+03 3.75858516e+02 1.17045946e+02 4.20393369e+01
 1.57357038e+01 7.48252223e+00 8.60211368e+00 4.92675223e-01]
grad_E = [ 2.22997555e-03  5.16342057e-04  4.16599345e-09 -1.92143584e-03
  1.85770679e-11  1.12241234e-10  6.48195808e-10  2.54175004e-09
  1.05588914e-08  5.68211274e-08  3.56937351e-06  1.21963783e-07
  7.34435421e-06 -3.76128087e-05 -2.13198891e-04 -7.88181250e-04
  1.83546296e-04  1.58033406e-03 -1.71651289e-03  1.59493583e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:12:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.255439508003       1
[INPUT] 0    0    [1    /1   ]  0.661125440488       1
[INPUT] 0    0    [1    /1   ]  117616.813829        1
[INPUT] 0    0    [1    /1   ]  3.04455506263        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031068        1
[INPUT] 0    0    [1    /1   ]  147020.991896        1
[INPUT] 0    0    [1    /1   ]  73510.4199253        1
[INPUT] 0    0    [1    /1   ]  36754.7144154        1
[INPUT] 0    0    [1    /1   ]  7303.12182836        1
[INPUT] 0    0    [1    /1   ]  18375.7981317        1
[INPUT] 0    0    [1    /1   ]  1449.11819183        1
[INPUT] 0    0    [1    /1   ]  375.826620091        1
[INPUT] 0    0    [1    /1   ]  117.199890093        1
[INPUT] 0    0    [1    /1   ]  42.4292073691        1
[INPUT] 0    0    [1    /1   ]  16.1250302451        1
[INPUT] 0    0    [1    /1   ]  7.53632514468        1
[INPUT] 1    0    [1    /1   ]  8.607922974          1
[INPUT] 1    0    [1    /1   ]  0.492730137595       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2554395080030184, 1.0]], [0, [0.6611254404877359, 1.0]], [0, [117616.81382940694, 1.0]], [0, [3.044555062632579, 1.0]], [0, [1176168.142617055, 1.0]], [0, [588084.0699814571, 1.0]], [0, [294042.03106771735, 1.0]], [0, [147020.99189617307, 1.0]], [0, [73510.41992534556, 1.0]], [0, [36754.714415363705, 1.0]], [0, [7303.121828364849, 1.0]], [0, [18375.7981317002, 1.0]], [0, [1449.118191827521, 1.0]], [0, [375.82662009092377, 1.0]], [0, [117.19989009315417, 1.0]], [0, [42.42920736913452, 1.0]], [0, [16.12503024511139, 1.0]], [0, [7.5363251446770185, 1.0]], [1, [8.607922973995803, 1.0]], [1, [0.49273013759546, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25543951]
bas 1, expnt(s) = [0.66112544]
bas 2, expnt(s) = [117616.81382941]
bas 3, expnt(s) = [3.04455506]
bas 4, expnt(s) = [1176168.14261705]
bas 5, expnt(s) = [588084.06998146]
bas 6, expnt(s) = [294042.03106772]
bas 7, expnt(s) = [147020.99189617]
bas 8, expnt(s) = [73510.41992535]
bas 9, expnt(s) = [36754.71441536]
bas 10, expnt(s) = [7303.12182836]
bas 11, expnt(s) = [18375.7981317]
bas 12, expnt(s) = [1449.11819183]
bas 13, expnt(s) = [375.82662009]
bas 14, expnt(s) = [117.19989009]
bas 15, expnt(s) = [42.42920737]
bas 16, expnt(s) = [16.12503025]
bas 17, expnt(s) = [7.53632514]
bas 18, expnt(s) = [8.60792297]
bas 19, expnt(s) = [0.49273014]
CPU time:       690.41
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.55439508e-01 9.07780974e-01 6.61125440e-01 1.85237080e+00
 1.17616814e+05 1.60460109e+04 3.04455506e+00 5.82314895e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104199e+04 1.12791586e+04 3.67547144e+04 6.70655999e+03
 7.30312183e+03 1.99593518e+03 1.83757981e+04 3.98749070e+03
 1.44911819e+03 5.93393631e+02 3.75826620e+02 2.15653086e+02
 1.17199890e+02 8.99933518e+01 4.24292074e+01 4.20013948e+01
 1.61250302e+01 2.03301427e+01 7.53632514e+00 1.14917123e+01
 8.60792297e+00 4.30137551e+01 4.92730138e-01 1.20433082e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335812497212718
cond(S) = 908866.3220533035
E1 = -689.6092124205628  E_coul = 184.9844491715498
init E= -504.624763249013
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.67230140127474  LUMO = 0.720637902426135
  mo_energy =
[-1.21703786e+02 -1.33847768e+01 -7.62268872e+00 -7.62268872e+00
 -7.62268872e+00 -1.65734966e+00 -6.72301401e-01 -6.72301401e-01
 -6.72301401e-01  7.20637902e-01  9.64933164e+00  4.77548582e+01
  1.81931536e+02  6.92073401e+02  2.83235441e+03  1.23023978e+04
  4.09175992e+04  1.04957826e+05  2.30139112e+05  4.55952549e+05
  8.44903689e+05  1.52807989e+06  2.85034598e+06  5.80823160e+06]
E1 = -707.7558426387076  E_coul = 199.7903740063397
cycle= 1 E= -507.965468632368  delta_E= -3.34  |g|= 0.451  |ddm|= 0.506
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.696128
diis-c [-0.48459461  1.        ]
  HOMO = -0.217718488928083  LUMO = 1.11422274797119
  mo_energy =
[-1.20195055e+02 -1.23035983e+01 -6.59350218e+00 -6.59350218e+00
 -6.59350218e+00 -1.16311418e+00 -2.17718489e-01 -2.17718489e-01
 -2.17718489e-01  1.11422275e+00  1.04829320e+01  4.89318922e+01
  1.83347369e+02  6.93563728e+02  2.83378585e+03  1.23037202e+04
  4.09188548e+04  1.04959045e+05  2.30140306e+05  4.55953726e+05
  8.44904853e+05  1.52808104e+06  2.85034712e+06  5.80823273e+06]
E1 = -706.8157054218816  E_coul = 198.8327136155347
cycle= 2 E= -507.982991806347  delta_E= -0.0175  |g|= 0.0347  |ddm|= 0.437
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0295969
diis-c [-8.75900230e-04 -3.92708784e-04  1.00039271e+00]
  HOMO = -0.239533107868582  LUMO = 1.10827779622886
  mo_energy =
[-1.20308138e+02 -1.23700828e+01 -6.66715900e+00 -6.66715900e+00
 -6.66715900e+00 -1.17714121e+00 -2.39533108e-01 -2.39533108e-01
 -2.39533108e-01  1.10827780e+00  1.04391204e+01  4.88580255e+01
  1.83249606e+02  6.93446840e+02  2.83365297e+03  1.23035770e+04
  4.09187079e+04  1.04958896e+05  2.30140157e+05  4.55953576e+05
  8.44904703e+05  1.52808089e+06  2.85034697e+06  5.80823258e+06]
E1 = -706.7103058334827  E_coul = 198.7270626988794
cycle= 3 E= -507.983243134603  delta_E= -0.000251  |g|= 0.00431  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00316118
diis-c [-2.20138002e-06  3.16018582e-05 -1.04314518e-01  1.10428292e+00]
  HOMO = -0.242606096922469  LUMO = 1.10721045158424
  mo_energy =
[-1.20319857e+02 -1.23785513e+01 -6.67612081e+00 -6.67612081e+00
 -6.67612081e+00 -1.17899862e+00 -2.42606097e-01 -2.42606097e-01
 -2.42606097e-01  1.10721045e+00  1.04330688e+01  4.88491175e+01
  1.83238915e+02  6.93434974e+02  2.83364028e+03  1.23035638e+04
  4.09186946e+04  1.04958883e+05  2.30140144e+05  4.55953563e+05
  8.44904690e+05  1.52808088e+06  2.85034696e+06  5.80823257e+06]
E1 = -706.6956008503096  E_coul = 198.7123531672239
cycle= 4 E= -507.983247683086  delta_E= -4.55e-06  |g|= 0.0002  |ddm|= 0.00919
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141591
diis-c [-1.19239969e-10 -7.18895819e-06  6.91548332e-03 -9.88443433e-02
  1.09193605e+00]
  HOMO = -0.242742698278326  LUMO = 1.10715648061747
  mo_energy =
[-1.20320209e+02 -1.23788853e+01 -6.67645313e+00 -6.67645313e+00
 -6.67645313e+00 -1.17907998e+00 -2.42742698e-01 -2.42742698e-01
 -2.42742698e-01  1.10715648e+00  1.04328085e+01  4.88487908e+01
  1.83238570e+02  6.93434622e+02  2.83363992e+03  1.23035635e+04
  4.09186942e+04  1.04958883e+05  2.30140143e+05  4.55953562e+05
  8.44904689e+05  1.52808088e+06  2.85034696e+06  5.80823257e+06]
E1 = -706.6949549866334  E_coul = 198.71170729412228
cycle= 5 E= -507.983247692511  delta_E= -9.43e-09  |g|= 9.33e-07  |ddm|= 0.000452
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.37792e-07
diis-c [-4.30847061e-14  2.04285176e-07 -1.18738016e-04  1.51329788e-03
 -1.77382166e-02  1.01634345e+00]
  HOMO = -0.242743245808533  LUMO = 1.10715641151418
  mo_energy =
[-1.20320211e+02 -1.23788867e+01 -6.67645452e+00 -6.67645452e+00
 -6.67645452e+00 -1.17908043e+00 -2.42743246e-01 -2.42743246e-01
 -2.42743246e-01  1.10715641e+00  1.04328075e+01  4.88487894e+01
  1.83238568e+02  6.93434620e+02  2.83363992e+03  1.23035635e+04
  4.09186942e+04  1.04958883e+05  2.30140143e+05  4.55953562e+05
  8.44904689e+05  1.52808088e+06  2.85034696e+06  5.80823257e+06]
E1 = -706.6949521725653  E_coul = 198.71170448005367
cycle= 6 E= -507.983247692512  delta_E= -5.12e-13  |g|= 3.05e-08  |ddm|= 2.05e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6949521725653  E_coul = 198.71170448005367
  HOMO = -0.242743261503313  LUMO = 1.10715640369864
  mo_energy =
[-1.20320211e+02 -1.23788867e+01 -6.67645455e+00 -6.67645455e+00
 -6.67645455e+00 -1.17908044e+00 -2.42743262e-01 -2.42743262e-01
 -2.42743262e-01  1.10715640e+00  1.04328075e+01  4.88487894e+01
  1.83238568e+02  6.93434620e+02  2.83363992e+03  1.23035635e+04
  4.09186942e+04  1.04958883e+05  2.30140143e+05  4.55953562e+05
  8.44904689e+05  1.52808088e+06  2.85034696e+06  5.80823257e+06]
E1 = -706.6949521008304  E_coul = 198.71170440831855
Extra cycle  E= -507.983247692512  delta_E= -1.71e-13  |g|= 3.4e-09  |ddm|= 5.88e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.55439508e-01 6.61125440e-01 1.17616814e+05 3.04455506e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104199e+04 3.67547144e+04 7.30312183e+03 1.83757981e+04
 1.44911819e+03 3.75826620e+02 1.17199890e+02 4.24292074e+01
 1.61250302e+01 7.53632514e+00 8.60792297e+00 4.92730138e-01]
E = -507.98324769251184
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:12:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.255439508003       1
[INPUT] 0    0    [1    /1   ]  0.661125440488       1
[INPUT] 0    0    [1    /1   ]  117616.813829        1
[INPUT] 0    0    [1    /1   ]  3.04455506263        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031068        1
[INPUT] 0    0    [1    /1   ]  147020.991896        1
[INPUT] 0    0    [1    /1   ]  73510.4199253        1
[INPUT] 0    0    [1    /1   ]  36754.7144154        1
[INPUT] 0    0    [1    /1   ]  7303.12182836        1
[INPUT] 0    0    [1    /1   ]  18375.7981317        1
[INPUT] 0    0    [1    /1   ]  1449.11819183        1
[INPUT] 0    0    [1    /1   ]  375.826620091        1
[INPUT] 0    0    [1    /1   ]  117.199890093        1
[INPUT] 0    0    [1    /1   ]  42.4292073691        1
[INPUT] 0    0    [1    /1   ]  16.1250302451        1
[INPUT] 0    0    [1    /1   ]  7.53632514468        1
[INPUT] 1    0    [1    /1   ]  8.607922974          1
[INPUT] 1    0    [1    /1   ]  0.492730137595       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2554395080030184, 1.0]], [0, [0.6611254404877359, 1.0]], [0, [117616.81382940694, 1.0]], [0, [3.044555062632579, 1.0]], [0, [1176168.142617055, 1.0]], [0, [588084.0699814571, 1.0]], [0, [294042.03106771735, 1.0]], [0, [147020.99189617307, 1.0]], [0, [73510.41992534556, 1.0]], [0, [36754.714415363705, 1.0]], [0, [7303.121828364849, 1.0]], [0, [18375.7981317002, 1.0]], [0, [1449.118191827521, 1.0]], [0, [375.82662009092377, 1.0]], [0, [117.19989009315417, 1.0]], [0, [42.42920736913452, 1.0]], [0, [16.12503024511139, 1.0]], [0, [7.5363251446770185, 1.0]], [1, [8.607922973995803, 1.0]], [1, [0.49273013759546, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25543951]
bas 1, expnt(s) = [0.66112544]
bas 2, expnt(s) = [117616.81382941]
bas 3, expnt(s) = [3.04455506]
bas 4, expnt(s) = [1176168.14261705]
bas 5, expnt(s) = [588084.06998146]
bas 6, expnt(s) = [294042.03106772]
bas 7, expnt(s) = [147020.99189617]
bas 8, expnt(s) = [73510.41992535]
bas 9, expnt(s) = [36754.71441536]
bas 10, expnt(s) = [7303.12182836]
bas 11, expnt(s) = [18375.7981317]
bas 12, expnt(s) = [1449.11819183]
bas 13, expnt(s) = [375.82662009]
bas 14, expnt(s) = [117.19989009]
bas 15, expnt(s) = [42.42920737]
bas 16, expnt(s) = [16.12503025]
bas 17, expnt(s) = [7.53632514]
bas 18, expnt(s) = [8.60792297]
bas 19, expnt(s) = [0.49273014]
CPU time:       691.82
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.55439508e-01 9.07780974e-01 6.61125440e-01 1.85237080e+00
 1.17616814e+05 1.60460109e+04 3.04455506e+00 5.82314895e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104199e+04 1.12791586e+04 3.67547144e+04 6.70655999e+03
 7.30312183e+03 1.99593518e+03 1.83757981e+04 3.98749070e+03
 1.44911819e+03 5.93393631e+02 3.75826620e+02 2.15653086e+02
 1.17199890e+02 8.99933518e+01 4.24292074e+01 4.20013948e+01
 1.61250302e+01 2.03301427e+01 7.53632514e+00 1.14917123e+01
 8.60792297e+00 4.30137551e+01 4.92730138e-01 1.20433082e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335812497212718
cond(S) = 908866.3220533035
E1 = -689.6092124205628  E_coul = 184.9844491715498
init E= -504.624763249013
    CPU time for initialize scf      0.39 sec, wall time      0.06 sec
  HOMO = -0.67230140127474  LUMO = 0.720637902426135
  mo_energy =
[-1.21703786e+02 -1.33847768e+01 -7.62268872e+00 -7.62268872e+00
 -7.62268872e+00 -1.65734966e+00 -6.72301401e-01 -6.72301401e-01
 -6.72301401e-01  7.20637902e-01  9.64933164e+00  4.77548582e+01
  1.81931536e+02  6.92073401e+02  2.83235441e+03  1.23023978e+04
  4.09175992e+04  1.04957826e+05  2.30139112e+05  4.55952549e+05
  8.44903689e+05  1.52807989e+06  2.85034598e+06  5.80823160e+06]
E1 = -707.7558426387076  E_coul = 199.7903740063397
cycle= 1 E= -507.965468632368  delta_E= -3.34  |g|= 0.451  |ddm|= 0.506
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.696128
diis-c [-0.48459461  1.        ]
  HOMO = -0.217718488928083  LUMO = 1.11422274797119
  mo_energy =
[-1.20195055e+02 -1.23035983e+01 -6.59350218e+00 -6.59350218e+00
 -6.59350218e+00 -1.16311418e+00 -2.17718489e-01 -2.17718489e-01
 -2.17718489e-01  1.11422275e+00  1.04829320e+01  4.89318922e+01
  1.83347369e+02  6.93563728e+02  2.83378585e+03  1.23037202e+04
  4.09188548e+04  1.04959045e+05  2.30140306e+05  4.55953726e+05
  8.44904853e+05  1.52808104e+06  2.85034712e+06  5.80823273e+06]
E1 = -706.8157054218816  E_coul = 198.8327136155347
cycle= 2 E= -507.982991806347  delta_E= -0.0175  |g|= 0.0347  |ddm|= 0.437
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0295969
diis-c [-8.75900230e-04 -3.92708784e-04  1.00039271e+00]
  HOMO = -0.239533107868582  LUMO = 1.10827779622886
  mo_energy =
[-1.20308138e+02 -1.23700828e+01 -6.66715900e+00 -6.66715900e+00
 -6.66715900e+00 -1.17714121e+00 -2.39533108e-01 -2.39533108e-01
 -2.39533108e-01  1.10827780e+00  1.04391204e+01  4.88580255e+01
  1.83249606e+02  6.93446840e+02  2.83365297e+03  1.23035770e+04
  4.09187079e+04  1.04958896e+05  2.30140157e+05  4.55953576e+05
  8.44904703e+05  1.52808089e+06  2.85034697e+06  5.80823258e+06]
E1 = -706.7103058334827  E_coul = 198.7270626988794
cycle= 3 E= -507.983243134603  delta_E= -0.000251  |g|= 0.00431  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00316118
diis-c [-2.20138002e-06  3.16018582e-05 -1.04314518e-01  1.10428292e+00]
  HOMO = -0.242606096922469  LUMO = 1.10721045158424
  mo_energy =
[-1.20319857e+02 -1.23785513e+01 -6.67612081e+00 -6.67612081e+00
 -6.67612081e+00 -1.17899862e+00 -2.42606097e-01 -2.42606097e-01
 -2.42606097e-01  1.10721045e+00  1.04330688e+01  4.88491175e+01
  1.83238915e+02  6.93434974e+02  2.83364028e+03  1.23035638e+04
  4.09186946e+04  1.04958883e+05  2.30140144e+05  4.55953563e+05
  8.44904690e+05  1.52808088e+06  2.85034696e+06  5.80823257e+06]
E1 = -706.6956008503096  E_coul = 198.7123531672239
cycle= 4 E= -507.983247683086  delta_E= -4.55e-06  |g|= 0.0002  |ddm|= 0.00919
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141591
diis-c [-1.19239969e-10 -7.18895819e-06  6.91548332e-03 -9.88443433e-02
  1.09193605e+00]
  HOMO = -0.242742698278326  LUMO = 1.10715648061747
  mo_energy =
[-1.20320209e+02 -1.23788853e+01 -6.67645313e+00 -6.67645313e+00
 -6.67645313e+00 -1.17907998e+00 -2.42742698e-01 -2.42742698e-01
 -2.42742698e-01  1.10715648e+00  1.04328085e+01  4.88487908e+01
  1.83238570e+02  6.93434622e+02  2.83363992e+03  1.23035635e+04
  4.09186942e+04  1.04958883e+05  2.30140143e+05  4.55953562e+05
  8.44904689e+05  1.52808088e+06  2.85034696e+06  5.80823257e+06]
E1 = -706.6949549866334  E_coul = 198.71170729412228
cycle= 5 E= -507.983247692511  delta_E= -9.43e-09  |g|= 9.33e-07  |ddm|= 0.000452
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.37792e-07
diis-c [-4.30847061e-14  2.04285176e-07 -1.18738016e-04  1.51329788e-03
 -1.77382166e-02  1.01634345e+00]
  HOMO = -0.242743245808533  LUMO = 1.10715641151418
  mo_energy =
[-1.20320211e+02 -1.23788867e+01 -6.67645452e+00 -6.67645452e+00
 -6.67645452e+00 -1.17908043e+00 -2.42743246e-01 -2.42743246e-01
 -2.42743246e-01  1.10715641e+00  1.04328075e+01  4.88487894e+01
  1.83238568e+02  6.93434620e+02  2.83363992e+03  1.23035635e+04
  4.09186942e+04  1.04958883e+05  2.30140143e+05  4.55953562e+05
  8.44904689e+05  1.52808088e+06  2.85034696e+06  5.80823257e+06]
E1 = -706.6949521725653  E_coul = 198.71170448005367
cycle= 6 E= -507.983247692512  delta_E= -5.12e-13  |g|= 3.05e-08  |ddm|= 2.05e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6949521725653  E_coul = 198.71170448005367
  HOMO = -0.242743261503313  LUMO = 1.10715640369864
  mo_energy =
[-1.20320211e+02 -1.23788867e+01 -6.67645455e+00 -6.67645455e+00
 -6.67645455e+00 -1.17908044e+00 -2.42743262e-01 -2.42743262e-01
 -2.42743262e-01  1.10715640e+00  1.04328075e+01  4.88487894e+01
  1.83238568e+02  6.93434620e+02  2.83363992e+03  1.23035635e+04
  4.09186942e+04  1.04958883e+05  2.30140143e+05  4.55953562e+05
  8.44904689e+05  1.52808088e+06  2.85034696e+06  5.80823257e+06]
E1 = -706.6949521008304  E_coul = 198.71170440831855
Extra cycle  E= -507.983247692512  delta_E= -1.71e-13  |g|= 3.4e-09  |ddm|= 5.88e-08
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908866.3220533035
E1 = -706.6949521008304  E_coul = 198.71170440831855
init E= -507.983247692512
    CPU time for initialize scf      3.56 sec, wall time      0.23 sec
  HOMO = -0.242743263681359  LUMO = 1.1071564013142
  mo_energy =
[-1.20320211e+02 -1.23788867e+01 -6.67645456e+00 -6.67645456e+00
 -6.67645456e+00 -1.17908044e+00 -2.42743264e-01 -2.42743264e-01
 -2.42743264e-01  1.10715640e+00  1.04328075e+01  4.88487894e+01
  1.83238568e+02  6.93434620e+02  2.83363992e+03  1.23035635e+04
  4.09186942e+04  1.04958883e+05  2.30140143e+05  4.55953562e+05
  8.44904689e+05  1.52808088e+06  2.85034696e+06  5.80823257e+06]
E1 = -706.6949520905197  E_coul = 198.71170439800844
cycle= 1 E= -507.983247692511  delta_E= 6.25e-13  |g|= 1.81e-09  |ddm|= 7.23e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6949520905197  E_coul = 198.71170439800844
  HOMO = -0.242743263969856  LUMO = 1.10715640075547
  mo_energy =
[-1.20320211e+02 -1.23788867e+01 -6.67645456e+00 -6.67645456e+00
 -6.67645456e+00 -1.17908044e+00 -2.42743264e-01 -2.42743264e-01
 -2.42743264e-01  1.10715640e+00  1.04328075e+01  4.88487894e+01
  1.83238568e+02  6.93434620e+02  2.83363992e+03  1.23035635e+04
  4.09186942e+04  1.04958883e+05  2.30140143e+05  4.55953562e+05
  8.44904689e+05  1.52808088e+06  2.85034696e+06  5.80823257e+06]
E1 = -706.6949520912592  E_coul = 198.71170439874766
Extra cycle  E= -507.983247692512  delta_E= -3.41e-13  |g|= 9.42e-10  |ddm|= 4.81e-10
    CPU time for scf_cycle      4.01 sec, wall time      0.39 sec
exp = [2.55439508e-01 6.61125440e-01 1.17616814e+05 3.04455506e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104199e+04 3.67547144e+04 7.30312183e+03 1.83757981e+04
 1.44911819e+03 3.75826620e+02 1.17199890e+02 4.24292074e+01
 1.61250302e+01 7.53632514e+00 8.60792297e+00 4.92730138e-01]
grad_E = [ 6.30763129e-03 -2.90509675e-04  4.18404431e-09 -1.90621033e-03
  1.87919678e-11  1.12827414e-10  6.50990140e-10  2.55290532e-09
  1.06059156e-08  5.70531630e-08  3.58622476e-06  1.22668408e-07
  6.27986081e-06 -1.92817120e-05 -3.40978835e-04 -5.30681455e-04
  1.51876904e-04  1.55204037e-03  3.10345367e-03 -1.77233229e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:12:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.256400503807       1
[INPUT] 0    0    [1    /1   ]  0.663162499866       1
[INPUT] 0    0    [1    /1   ]  117616.813827        1
[INPUT] 0    0    [1    /1   ]  3.01787870994        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031067        1
[INPUT] 0    0    [1    /1   ]  147020.991895        1
[INPUT] 0    0    [1    /1   ]  73510.4199203        1
[INPUT] 0    0    [1    /1   ]  36754.7143882        1
[INPUT] 0    0    [1    /1   ]  7303.12011521        1
[INPUT] 0    0    [1    /1   ]  18375.7980722        1
[INPUT] 0    0    [1    /1   ]  1449.1196155         1
[INPUT] 0    0    [1    /1   ]  375.801047411        1
[INPUT] 0    0    [1    /1   ]  117.323073152        1
[INPUT] 0    0    [1    /1   ]  42.8312229614        1
[INPUT] 0    0    [1    /1   ]  16.4400250798        1
[INPUT] 0    0    [1    /1   ]  7.46755987581        1
[INPUT] 1    0    [1    /1   ]  8.61265224274        1
[INPUT] 1    0    [1    /1   ]  0.492775175188       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2564005038070986, 1.0]], [0, [0.6631624998663169, 1.0]], [0, [117616.81382741194, 1.0]], [0, [3.017878709940708, 1.0]], [0, [1176168.1426170452, 1.0]], [0, [588084.0699814027, 1.0]], [0, [294042.03106740705, 1.0]], [0, [147020.99189495505, 1.0]], [0, [73510.41992028152, 1.0]], [0, [36754.71438824053, 1.0]], [0, [7303.120115212726, 1.0]], [0, [18375.798072232108, 1.0]], [0, [1449.119615501475, 1.0]], [0, [375.8010474113751, 1.0]], [0, [117.32307315162643, 1.0]], [0, [42.83122296142594, 1.0]], [0, [16.4400250797646, 1.0]], [0, [7.467559875806998, 1.0]], [1, [8.61265224273528, 1.0]], [1, [0.4927751751882557, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2564005]
bas 1, expnt(s) = [0.6631625]
bas 2, expnt(s) = [117616.81382741]
bas 3, expnt(s) = [3.01787871]
bas 4, expnt(s) = [1176168.14261705]
bas 5, expnt(s) = [588084.0699814]
bas 6, expnt(s) = [294042.03106741]
bas 7, expnt(s) = [147020.99189496]
bas 8, expnt(s) = [73510.41992028]
bas 9, expnt(s) = [36754.71438824]
bas 10, expnt(s) = [7303.12011521]
bas 11, expnt(s) = [18375.79807223]
bas 12, expnt(s) = [1449.1196155]
bas 13, expnt(s) = [375.80104741]
bas 14, expnt(s) = [117.32307315]
bas 15, expnt(s) = [42.83122296]
bas 16, expnt(s) = [16.44002508]
bas 17, expnt(s) = [7.46755988]
bas 18, expnt(s) = [8.61265224]
bas 19, expnt(s) = [0.49277518]
CPU time:       703.61
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.56400504e-01 9.10341161e-01 6.63162500e-01 1.85664980e+00
 1.17616814e+05 1.60460109e+04 3.01787871e+00 5.78484012e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104199e+04 1.12791586e+04 3.67547144e+04 6.70655999e+03
 7.30312012e+03 1.99593483e+03 1.83757981e+04 3.98749069e+03
 1.44911962e+03 5.93394068e+02 3.75801047e+02 2.15642081e+02
 1.17323073e+02 9.00642832e+01 4.28312230e+01 4.22995143e+01
 1.64400251e+01 2.06272761e+01 7.46755988e+00 1.14129801e+01
 8.61265224e+00 4.30432973e+01 4.92775175e-01 1.20446842e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335723498267477
cond(S) = 908893.5865991957
E1 = -689.6302087062024  E_coul = 185.0063924930162
init E= -504.623816213186
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672316397676027  LUMO = 0.724954743733004
  mo_energy =
[-1.21699314e+02 -1.33831158e+01 -7.62114800e+00 -7.62114800e+00
 -7.62114800e+00 -1.65722047e+00 -6.72316398e-01 -6.72316398e-01
 -6.72316398e-01  7.24954744e-01  9.59545085e+00  4.79875470e+01
  1.83465949e+02  6.94676201e+02  2.83503300e+03  1.23047985e+04
  4.09198290e+04  1.04959965e+05  2.30141191e+05  4.55954584e+05
  8.44905691e+05  1.52808186e+06  2.85034791e+06  5.80823348e+06]
E1 = -707.7809755654919  E_coul = 199.81532086655804
cycle= 1 E= -507.965654698934  delta_E= -3.34  |g|= 0.451  |ddm|= 0.507
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.697015
diis-c [-0.48582934  1.        ]
  HOMO = -0.217614424714886  LUMO = 1.11907127642675
  mo_energy =
[-1.20190262e+02 -1.23017766e+01 -6.59174806e+00 -6.59174806e+00
 -6.59174806e+00 -1.16292458e+00 -2.17614425e-01 -2.17614425e-01
 -2.17614425e-01  1.11907128e+00  1.04278690e+01  4.91675507e+01
  1.84883355e+02  6.96166918e+02  2.83646471e+03  1.23061212e+04
  4.09210849e+04  1.04961184e+05  2.30142386e+05  4.55955762e+05
  8.44906856e+05  1.52808301e+06  2.85034905e+06  5.80823461e+06]
E1 = -706.8409657396077  E_coul = 198.8577866375866
cycle= 2 E= -507.983179102021  delta_E= -0.0175  |g|= 0.0347  |ddm|= 0.436
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0295786
diis-c [-8.74869525e-04 -2.35519415e-04  1.00023552e+00]
  HOMO = -0.239403896614909  LUMO = 1.11312206081204
  mo_energy =
[-1.20303363e+02 -1.23682354e+01 -6.66539358e+00 -6.66539358e+00
 -6.66539358e+00 -1.17692865e+00 -2.39403897e-01 -2.39403897e-01
 -2.39403897e-01  1.11312206e+00  1.03841931e+01  4.90935056e+01
  1.84785443e+02  6.96049998e+02  2.83633180e+03  1.23059780e+04
  4.09209379e+04  1.04961035e+05  2.30142236e+05  4.55955612e+05
  8.44906706e+05  1.52808286e+06  2.85034890e+06  5.80823446e+06]
E1 = -706.735759116637  E_coul = 198.75232938148454
cycle= 3 E= -507.983429735153  delta_E= -0.000251  |g|= 0.00431  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00315884
diis-c [-2.19619178e-06  3.07419136e-05 -1.04310511e-01  1.10427977e+00]
  HOMO = -0.242472555198166  LUMO = 1.1120547649921
  mo_energy =
[-1.20315084e+02 -1.23766986e+01 -6.67435168e+00 -6.67435168e+00
 -6.67435168e+00 -1.17878283e+00 -2.42472555e-01 -2.42472555e-01
 -2.42472555e-01  1.11205476e+00  1.03781609e+01  4.90845861e+01
  1.84774743e+02  6.96038130e+02  2.83631910e+03  1.23059648e+04
  4.09209246e+04  1.04961022e+05  2.30142223e+05  4.55955599e+05
  8.44906692e+05  1.52808285e+06  2.85034889e+06  5.80823445e+06]
E1 = -706.721082729012  E_coul = 198.7376484576916
cycle= 4 E= -507.98343427132  delta_E= -4.54e-06  |g|= 0.0002  |ddm|= 0.00919
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141319
diis-c [-1.20400836e-10 -7.20409085e-06  6.92554971e-03 -9.88513176e-02
  1.09193297e+00]
  HOMO = -0.242608812498529  LUMO = 1.11200082649297
  mo_energy =
[-1.20315435e+02 -1.23770318e+01 -6.67468315e+00 -6.67468315e+00
 -6.67468315e+00 -1.17886397e+00 -2.42608812e-01 -2.42608812e-01
 -2.42608812e-01  1.11200083e+00  1.03779017e+01  4.90842600e+01
  1.84774399e+02  6.96037778e+02  2.83631875e+03  1.23059644e+04
  4.09209242e+04  1.04961022e+05  2.30142222e+05  4.55955598e+05
  8.44906692e+05  1.52808285e+06  2.85034889e+06  5.80823445e+06]
E1 = -706.7204389120866  E_coul = 198.73700463137334
cycle= 5 E= -507.983434280713  delta_E= -9.39e-09  |g|= 9.55e-07  |ddm|= 0.000452
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.46974e-07
diis-c [-4.50597264e-14  2.04789706e-07 -1.20898328e-04  1.54082716e-03
 -1.80925205e-02  1.01667239e+00]
  HOMO = -0.242609373042045  LUMO = 1.11200075228222
  mo_energy =
[-1.20315437e+02 -1.23770331e+01 -6.67468457e+00 -6.67468457e+00
 -6.67468457e+00 -1.17886443e+00 -2.42609373e-01 -2.42609373e-01
 -2.42609373e-01  1.11200075e+00  1.03779007e+01  4.90842586e+01
  1.84774397e+02  6.96037776e+02  2.83631874e+03  1.23059644e+04
  4.09209242e+04  1.04961022e+05  2.30142222e+05  4.55955598e+05
  8.44906692e+05  1.52808285e+06  2.85034889e+06  5.80823445e+06]
E1 = -706.7204360422988  E_coul = 198.7370017615853
cycle= 6 E= -507.983434280714  delta_E= -2.84e-13  |g|= 3.14e-08  |ddm|= 2.1e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7204360422988  E_coul = 198.7370017615853
  HOMO = -0.242609388984324  LUMO = 1.11200074244792
  mo_energy =
[-1.20315437e+02 -1.23770332e+01 -6.67468461e+00 -6.67468461e+00
 -6.67468461e+00 -1.17886444e+00 -2.42609389e-01 -2.42609389e-01
 -2.42609389e-01  1.11200074e+00  1.03779007e+01  4.90842586e+01
  1.84774397e+02  6.96037776e+02  2.83631874e+03  1.23059644e+04
  4.09209242e+04  1.04961022e+05  2.30142222e+05  4.55955598e+05
  8.44906692e+05  1.52808285e+06  2.85034889e+06  5.80823445e+06]
E1 = -706.7204359705878  E_coul = 198.7370016898747
Extra cycle  E= -507.983434280713  delta_E= 3.98e-13  |g|= 4.11e-09  |ddm|= 5.93e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.56400504e-01 6.63162500e-01 1.17616814e+05 3.01787871e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104199e+04 3.67547144e+04 7.30312012e+03 1.83757981e+04
 1.44911962e+03 3.75801047e+02 1.17323073e+02 4.28312230e+01
 1.64400251e+01 7.46755988e+00 8.61265224e+00 4.92775175e-01]
E = -507.98343428071314
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:12:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.256400503807       1
[INPUT] 0    0    [1    /1   ]  0.663162499866       1
[INPUT] 0    0    [1    /1   ]  117616.813827        1
[INPUT] 0    0    [1    /1   ]  3.01787870994        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031067        1
[INPUT] 0    0    [1    /1   ]  147020.991895        1
[INPUT] 0    0    [1    /1   ]  73510.4199203        1
[INPUT] 0    0    [1    /1   ]  36754.7143882        1
[INPUT] 0    0    [1    /1   ]  7303.12011521        1
[INPUT] 0    0    [1    /1   ]  18375.7980722        1
[INPUT] 0    0    [1    /1   ]  1449.1196155         1
[INPUT] 0    0    [1    /1   ]  375.801047411        1
[INPUT] 0    0    [1    /1   ]  117.323073152        1
[INPUT] 0    0    [1    /1   ]  42.8312229614        1
[INPUT] 0    0    [1    /1   ]  16.4400250798        1
[INPUT] 0    0    [1    /1   ]  7.46755987581        1
[INPUT] 1    0    [1    /1   ]  8.61265224274        1
[INPUT] 1    0    [1    /1   ]  0.492775175188       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2564005038070986, 1.0]], [0, [0.6631624998663169, 1.0]], [0, [117616.81382741194, 1.0]], [0, [3.017878709940708, 1.0]], [0, [1176168.1426170452, 1.0]], [0, [588084.0699814027, 1.0]], [0, [294042.03106740705, 1.0]], [0, [147020.99189495505, 1.0]], [0, [73510.41992028152, 1.0]], [0, [36754.71438824053, 1.0]], [0, [7303.120115212726, 1.0]], [0, [18375.798072232108, 1.0]], [0, [1449.119615501475, 1.0]], [0, [375.8010474113751, 1.0]], [0, [117.32307315162643, 1.0]], [0, [42.83122296142594, 1.0]], [0, [16.4400250797646, 1.0]], [0, [7.467559875806998, 1.0]], [1, [8.61265224273528, 1.0]], [1, [0.4927751751882557, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2564005]
bas 1, expnt(s) = [0.6631625]
bas 2, expnt(s) = [117616.81382741]
bas 3, expnt(s) = [3.01787871]
bas 4, expnt(s) = [1176168.14261705]
bas 5, expnt(s) = [588084.0699814]
bas 6, expnt(s) = [294042.03106741]
bas 7, expnt(s) = [147020.99189496]
bas 8, expnt(s) = [73510.41992028]
bas 9, expnt(s) = [36754.71438824]
bas 10, expnt(s) = [7303.12011521]
bas 11, expnt(s) = [18375.79807223]
bas 12, expnt(s) = [1449.1196155]
bas 13, expnt(s) = [375.80104741]
bas 14, expnt(s) = [117.32307315]
bas 15, expnt(s) = [42.83122296]
bas 16, expnt(s) = [16.44002508]
bas 17, expnt(s) = [7.46755988]
bas 18, expnt(s) = [8.61265224]
bas 19, expnt(s) = [0.49277518]
CPU time:       705.06
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.56400504e-01 9.10341161e-01 6.63162500e-01 1.85664980e+00
 1.17616814e+05 1.60460109e+04 3.01787871e+00 5.78484012e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104199e+04 1.12791586e+04 3.67547144e+04 6.70655999e+03
 7.30312012e+03 1.99593483e+03 1.83757981e+04 3.98749069e+03
 1.44911962e+03 5.93394068e+02 3.75801047e+02 2.15642081e+02
 1.17323073e+02 9.00642832e+01 4.28312230e+01 4.22995143e+01
 1.64400251e+01 2.06272761e+01 7.46755988e+00 1.14129801e+01
 8.61265224e+00 4.30432973e+01 4.92775175e-01 1.20446842e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335723498267477
cond(S) = 908893.5865991957
E1 = -689.6302087062024  E_coul = 185.0063924930162
init E= -504.623816213186
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672316397676027  LUMO = 0.724954743733004
  mo_energy =
[-1.21699314e+02 -1.33831158e+01 -7.62114800e+00 -7.62114800e+00
 -7.62114800e+00 -1.65722047e+00 -6.72316398e-01 -6.72316398e-01
 -6.72316398e-01  7.24954744e-01  9.59545085e+00  4.79875470e+01
  1.83465949e+02  6.94676201e+02  2.83503300e+03  1.23047985e+04
  4.09198290e+04  1.04959965e+05  2.30141191e+05  4.55954584e+05
  8.44905691e+05  1.52808186e+06  2.85034791e+06  5.80823348e+06]
E1 = -707.7809755654919  E_coul = 199.81532086655804
cycle= 1 E= -507.965654698934  delta_E= -3.34  |g|= 0.451  |ddm|= 0.507
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.697015
diis-c [-0.48582934  1.        ]
  HOMO = -0.217614424714886  LUMO = 1.11907127642675
  mo_energy =
[-1.20190262e+02 -1.23017766e+01 -6.59174806e+00 -6.59174806e+00
 -6.59174806e+00 -1.16292458e+00 -2.17614425e-01 -2.17614425e-01
 -2.17614425e-01  1.11907128e+00  1.04278690e+01  4.91675507e+01
  1.84883355e+02  6.96166918e+02  2.83646471e+03  1.23061212e+04
  4.09210849e+04  1.04961184e+05  2.30142386e+05  4.55955762e+05
  8.44906856e+05  1.52808301e+06  2.85034905e+06  5.80823461e+06]
E1 = -706.8409657396077  E_coul = 198.8577866375866
cycle= 2 E= -507.983179102021  delta_E= -0.0175  |g|= 0.0347  |ddm|= 0.436
    CPU time for cycle= 2      0.10 sec, wall time      0.03 sec
diis-norm(errvec)=0.0295786
diis-c [-8.74869525e-04 -2.35519415e-04  1.00023552e+00]
  HOMO = -0.239403896614909  LUMO = 1.11312206081204
  mo_energy =
[-1.20303363e+02 -1.23682354e+01 -6.66539358e+00 -6.66539358e+00
 -6.66539358e+00 -1.17692865e+00 -2.39403897e-01 -2.39403897e-01
 -2.39403897e-01  1.11312206e+00  1.03841931e+01  4.90935056e+01
  1.84785443e+02  6.96049998e+02  2.83633180e+03  1.23059780e+04
  4.09209379e+04  1.04961035e+05  2.30142236e+05  4.55955612e+05
  8.44906706e+05  1.52808286e+06  2.85034890e+06  5.80823446e+06]
E1 = -706.735759116637  E_coul = 198.75232938148454
cycle= 3 E= -507.983429735153  delta_E= -0.000251  |g|= 0.00431  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00315884
diis-c [-2.19619178e-06  3.07419136e-05 -1.04310511e-01  1.10427977e+00]
  HOMO = -0.242472555198166  LUMO = 1.1120547649921
  mo_energy =
[-1.20315084e+02 -1.23766986e+01 -6.67435168e+00 -6.67435168e+00
 -6.67435168e+00 -1.17878283e+00 -2.42472555e-01 -2.42472555e-01
 -2.42472555e-01  1.11205476e+00  1.03781609e+01  4.90845861e+01
  1.84774743e+02  6.96038130e+02  2.83631910e+03  1.23059648e+04
  4.09209246e+04  1.04961022e+05  2.30142223e+05  4.55955599e+05
  8.44906692e+05  1.52808285e+06  2.85034889e+06  5.80823445e+06]
E1 = -706.721082729012  E_coul = 198.7376484576916
cycle= 4 E= -507.98343427132  delta_E= -4.54e-06  |g|= 0.0002  |ddm|= 0.00919
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141319
diis-c [-1.20400836e-10 -7.20409085e-06  6.92554971e-03 -9.88513176e-02
  1.09193297e+00]
  HOMO = -0.242608812498529  LUMO = 1.11200082649297
  mo_energy =
[-1.20315435e+02 -1.23770318e+01 -6.67468315e+00 -6.67468315e+00
 -6.67468315e+00 -1.17886397e+00 -2.42608812e-01 -2.42608812e-01
 -2.42608812e-01  1.11200083e+00  1.03779017e+01  4.90842600e+01
  1.84774399e+02  6.96037778e+02  2.83631875e+03  1.23059644e+04
  4.09209242e+04  1.04961022e+05  2.30142222e+05  4.55955598e+05
  8.44906692e+05  1.52808285e+06  2.85034889e+06  5.80823445e+06]
E1 = -706.7204389120866  E_coul = 198.73700463137334
cycle= 5 E= -507.983434280713  delta_E= -9.39e-09  |g|= 9.55e-07  |ddm|= 0.000452
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.46974e-07
diis-c [-4.50597264e-14  2.04789706e-07 -1.20898328e-04  1.54082716e-03
 -1.80925205e-02  1.01667239e+00]
  HOMO = -0.242609373042045  LUMO = 1.11200075228222
  mo_energy =
[-1.20315437e+02 -1.23770331e+01 -6.67468457e+00 -6.67468457e+00
 -6.67468457e+00 -1.17886443e+00 -2.42609373e-01 -2.42609373e-01
 -2.42609373e-01  1.11200075e+00  1.03779007e+01  4.90842586e+01
  1.84774397e+02  6.96037776e+02  2.83631874e+03  1.23059644e+04
  4.09209242e+04  1.04961022e+05  2.30142222e+05  4.55955598e+05
  8.44906692e+05  1.52808285e+06  2.85034889e+06  5.80823445e+06]
E1 = -706.7204360422988  E_coul = 198.7370017615853
cycle= 6 E= -507.983434280714  delta_E= -2.84e-13  |g|= 3.14e-08  |ddm|= 2.1e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7204360422988  E_coul = 198.7370017615853
  HOMO = -0.242609388984324  LUMO = 1.11200074244792
  mo_energy =
[-1.20315437e+02 -1.23770332e+01 -6.67468461e+00 -6.67468461e+00
 -6.67468461e+00 -1.17886444e+00 -2.42609389e-01 -2.42609389e-01
 -2.42609389e-01  1.11200074e+00  1.03779007e+01  4.90842586e+01
  1.84774397e+02  6.96037776e+02  2.83631874e+03  1.23059644e+04
  4.09209242e+04  1.04961022e+05  2.30142222e+05  4.55955598e+05
  8.44906692e+05  1.52808285e+06  2.85034889e+06  5.80823445e+06]
E1 = -706.7204359705878  E_coul = 198.7370016898747
Extra cycle  E= -507.983434280713  delta_E= 3.98e-13  |g|= 4.11e-09  |ddm|= 5.93e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908893.5865991957
E1 = -706.7204359705878  E_coul = 198.7370016898747
init E= -507.983434280713
    CPU time for initialize scf      3.61 sec, wall time      0.23 sec
  HOMO = -0.242609391158719  LUMO = 1.1120007411625
  mo_energy =
[-1.20315437e+02 -1.23770332e+01 -6.67468461e+00 -6.67468461e+00
 -6.67468461e+00 -1.17886444e+00 -2.42609391e-01 -2.42609391e-01
 -2.42609391e-01  1.11200074e+00  1.03779007e+01  4.90842585e+01
  1.84774397e+02  6.96037776e+02  2.83631874e+03  1.23059644e+04
  4.09209242e+04  1.04961022e+05  2.30142222e+05  4.55955598e+05
  8.44906692e+05  1.52808285e+06  2.85034889e+06  5.80823445e+06]
E1 = -706.7204359611657  E_coul = 198.73700168045247
cycle= 1 E= -507.983434280713  delta_E= -5.68e-14  |g|= 1.71e-09  |ddm|= 6.78e-09
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.7204359611657  E_coul = 198.73700168045247
  HOMO = -0.242609391434017  LUMO = 1.1120007418388
  mo_energy =
[-1.20315437e+02 -1.23770332e+01 -6.67468461e+00 -6.67468461e+00
 -6.67468461e+00 -1.17886444e+00 -2.42609391e-01 -2.42609391e-01
 -2.42609391e-01  1.11200074e+00  1.03779007e+01  4.90842585e+01
  1.84774397e+02  6.96037776e+02  2.83631874e+03  1.23059644e+04
  4.09209242e+04  1.04961022e+05  2.30142222e+05  4.55955598e+05
  8.44906692e+05  1.52808285e+06  2.85034889e+06  5.80823445e+06]
E1 = -706.7204359580641  E_coul = 198.7370016773504
Extra cycle  E= -507.983434280714  delta_E= -4.55e-13  |g|= 1.55e-09  |ddm|= 2.06e-09
    CPU time for scf_cycle      4.05 sec, wall time      0.40 sec
exp = [2.56400504e-01 6.63162500e-01 1.17616814e+05 3.01787871e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104199e+04 3.67547144e+04 7.30312012e+03 1.83757981e+04
 1.44911962e+03 3.75801047e+02 1.17323073e+02 4.28312230e+01
 1.64400251e+01 7.46755988e+00 8.61265224e+00 4.92775175e-01]
grad_E = [ 9.08914293e-03 -9.97732758e-04  4.21370996e-09 -2.15222244e-03
  1.91445763e-11  1.13790815e-10  6.55581783e-10  2.57123917e-09
  1.06832029e-08  5.74342994e-08  3.61364505e-06  1.23827505e-07
  4.63322515e-06  6.27286352e-06 -4.98735530e-04 -2.25501142e-04
  8.90638390e-05  1.52491938e-03  7.00686298e-03 -4.90795197e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:13:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.256003385533       1
[INPUT] 0    0    [1    /1   ]  0.661643965093       1
[INPUT] 0    0    [1    /1   ]  117616.813823        1
[INPUT] 0    0    [1    /1   ]  3.00209287355        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031067        1
[INPUT] 0    0    [1    /1   ]  147020.991892        1
[INPUT] 0    0    [1    /1   ]  73510.4199094        1
[INPUT] 0    0    [1    /1   ]  36754.71433          1
[INPUT] 0    0    [1    /1   ]  7303.11643329        1
[INPUT] 0    0    [1    /1   ]  18375.7979443        1
[INPUT] 0    0    [1    /1   ]  1449.12360156        1
[INPUT] 0    0    [1    /1   ]  375.732807221        1
[INPUT] 0    0    [1    /1   ]  117.671201423        1
[INPUT] 0    0    [1    /1   ]  43.513585492         1
[INPUT] 0    0    [1    /1   ]  17.0846974291        1
[INPUT] 0    0    [1    /1   ]  7.34478799766        1
[INPUT] 1    0    [1    /1   ]  8.61621468808        1
[INPUT] 1    0    [1    /1   ]  0.492820540728       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2560033855330211, 1.0]], [0, [0.6616439650930117, 1.0]], [0, [117616.81382312524, 1.0]], [0, [3.002092873551931, 1.0]], [0, [1176168.1426170242, 1.0]], [0, [588084.0699812858, 1.0]], [0, [294042.0310667403, 1.0]], [0, [147020.99189233768, 1.0]], [0, [73510.41990939897, 1.0]], [0, [36754.714329974595, 1.0]], [0, [7303.116433291439, 1.0]], [0, [18375.79794427285, 1.0]], [0, [1449.1236015614068, 1.0]], [0, [375.73280722138725, 1.0]], [0, [117.6712014232487, 1.0]], [0, [43.51358549199935, 1.0]], [0, [17.084697429081082, 1.0]], [0, [7.344787997664214, 1.0]], [1, [8.616214688082144, 1.0]], [1, [0.49282054072817705, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25600339]
bas 1, expnt(s) = [0.66164397]
bas 2, expnt(s) = [117616.81382313]
bas 3, expnt(s) = [3.00209287]
bas 4, expnt(s) = [1176168.14261702]
bas 5, expnt(s) = [588084.06998129]
bas 6, expnt(s) = [294042.03106674]
bas 7, expnt(s) = [147020.99189234]
bas 8, expnt(s) = [73510.4199094]
bas 9, expnt(s) = [36754.71432997]
bas 10, expnt(s) = [7303.11643329]
bas 11, expnt(s) = [18375.79794427]
bas 12, expnt(s) = [1449.12360156]
bas 13, expnt(s) = [375.73280722]
bas 14, expnt(s) = [117.67120142]
bas 15, expnt(s) = [43.51358549]
bas 16, expnt(s) = [17.08469743]
bas 17, expnt(s) = [7.344788]
bas 18, expnt(s) = [8.61621469]
bas 19, expnt(s) = [0.49282054]
CPU time:       716.95
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.56003386e-01 9.09283490e-01 6.61643965e-01 1.85346031e+00
 1.17616814e+05 1.60460109e+04 3.00209287e+00 5.76213086e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104199e+04 1.12791586e+04 3.67547143e+04 6.70655998e+03
 7.30311643e+03 1.99593408e+03 1.83757979e+04 3.98749067e+03
 1.44912360e+03 5.93395292e+02 3.75732807e+02 2.15612712e+02
 1.17671201e+02 9.02646422e+01 4.35135855e+01 4.28039331e+01
 1.70846974e+01 2.12310021e+01 7.34478800e+00 1.12719609e+01
 8.61621469e+00 4.30655534e+01 4.92820541e-01 1.20460703e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.3356533104171
cond(S) = 908950.1793010682
E1 = -689.6460317301638  E_coul = 185.0233984234678
init E= -504.622633306696
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672311641687764  LUMO = 0.722015772775382
  mo_energy =
[-1.21695935e+02 -1.33818711e+01 -7.61995142e+00 -7.61995142e+00
 -7.61995142e+00 -1.65714438e+00 -6.72311642e-01 -6.72311642e-01
 -6.72311642e-01  7.22015773e-01  9.53135245e+00  4.85833444e+01
  1.86567606e+02  6.99903832e+02  2.84046550e+03  1.23096737e+04
  4.09243576e+04  1.04964308e+05  2.30145412e+05  4.55958718e+05
  8.44909757e+05  1.52808586e+06  2.85035183e+06  5.80823729e+06]
E1 = -707.8024296544762  E_coul = 199.8364931917381
cycle= 1 E= -507.965936462738  delta_E= -3.34  |g|= 0.451  |ddm|= 0.508
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.698434
diis-c [-0.48781004  1.        ]
  HOMO = -0.217503519553095  LUMO = 1.11556998137585
  mo_energy =
[-1.20186340e+02 -1.23002689e+01 -6.59023490e+00 -6.59023490e+00
 -6.59023490e+00 -1.16278617e+00 -2.17503520e-01 -2.17503520e-01
 -2.17503520e-01  1.11556998e+00  1.03633109e+01  4.97693559e+01
  1.87987812e+02  7.01395238e+02  2.84189775e+03  1.23109970e+04
  4.09256140e+04  1.04965528e+05  2.30146608e+05  4.55959896e+05
  8.44910922e+05  1.52808701e+06  2.85035297e+06  5.80823843e+06]
E1 = -706.8618583460103  E_coul = 198.87838497363148
cycle= 2 E= -507.983473372379  delta_E= -0.0175  |g|= 0.0347  |ddm|= 0.435
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0295405
diis-c [-8.72640838e-04  6.36617388e-05  9.99936338e-01]
  HOMO = -0.239302036597759  LUMO = 1.10964820904453
  mo_energy =
[-1.20299474e+02 -1.23667452e+01 -6.66390159e+00 -6.66390159e+00
 -6.66390159e+00 -1.17679441e+00 -2.39302037e-01 -2.39302037e-01
 -2.39302037e-01  1.10964821e+00  1.03197016e+01  4.96948858e+01
  1.87889606e+02  7.01278262e+02  2.84176482e+03  1.23108537e+04
  4.09254670e+04  1.04965379e+05  2.30146458e+05  4.55959746e+05
  8.44910772e+05  1.52808686e+06  2.85035282e+06  5.80823828e+06]
E1 = -706.7565815667748  E_coul = 198.77285717308487
cycle= 3 E= -507.98372439369  delta_E= -0.000251  |g|= 0.00432  |ddm|= 0.0599
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00316246
diis-c [-2.18668287e-06  2.46395251e-05 -1.04688470e-01  1.10466383e+00]
  HOMO = -0.242381547697574  LUMO = 1.10858175276917
  mo_energy =
[-1.20311239e+02 -1.23752367e+01 -6.67289077e+00 -6.67289077e+00
 -6.67289077e+00 -1.17865534e+00 -2.42381548e-01 -2.42381548e-01
 -2.42381548e-01  1.10858175e+00  1.03136596e+01  4.96859022e+01
  1.87878848e+02  7.01266347e+02  2.84175207e+03  1.23108405e+04
  4.09254536e+04  1.04965366e+05  2.30146445e+05  4.55959732e+05
  8.44910758e+05  1.52808685e+06  2.85035281e+06  5.80823826e+06]
E1 = -706.7418486554224  E_coul = 198.75811969258876
cycle= 4 E= -507.983728962834  delta_E= -4.57e-06  |g|= 0.000201  |ddm|= 0.00921
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141028
diis-c [-1.23376516e-10 -7.27952042e-06  6.96429959e-03 -9.89012646e-02
  1.09194424e+00]
  HOMO = -0.242518090998471  LUMO = 1.10852783196699
  mo_energy =
[-1.20311590e+02 -1.23755702e+01 -6.67322246e+00 -6.67322246e+00
 -6.67322246e+00 -1.17873664e+00 -2.42518091e-01 -2.42518091e-01
 -2.42518091e-01  1.10852783e+00  1.03134005e+01  4.96855755e+01
  1.87878503e+02  7.01265995e+02  2.84175171e+03  1.23108401e+04
  4.09254532e+04  1.04965365e+05  2.30146444e+05  4.55959732e+05
  8.44910758e+05  1.52808685e+06  2.85035281e+06  5.80823826e+06]
E1 = -706.7412033080745  E_coul = 198.75747433578894
cycle= 5 E= -507.983728972286  delta_E= -9.45e-09  |g|= 9.98e-07  |ddm|= 0.000454
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.65049e-07
diis-c [-4.89840888e-14  2.03744700e-07 -1.25612707e-04  1.59721415e-03
 -1.87973669e-02  1.01732556e+00]
  HOMO = -0.242518677116716  LUMO = 1.10852774999467
  mo_energy =
[-1.20311592e+02 -1.23755716e+01 -6.67322394e+00 -6.67322394e+00
 -6.67322394e+00 -1.17873712e+00 -2.42518677e-01 -2.42518677e-01
 -2.42518677e-01  1.10852775e+00  1.03133994e+01  4.96855741e+01
  1.87878502e+02  7.01265993e+02  2.84175171e+03  1.23108401e+04
  4.09254532e+04  1.04965365e+05  2.30146444e+05  4.55959732e+05
  8.44910758e+05  1.52808685e+06  2.85035281e+06  5.80823826e+06]
E1 = -706.7412003097264  E_coul = 198.7574713374406
cycle= 6 E= -507.983728972286  delta_E= -2.27e-13  |g|= 3.27e-08  |ddm|= 2.19e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7412003097264  E_coul = 198.7574713374406
  HOMO = -0.242518693666893  LUMO = 1.10852774053985
  mo_energy =
[-1.20311592e+02 -1.23755717e+01 -6.67322397e+00 -6.67322397e+00
 -6.67322397e+00 -1.17873713e+00 -2.42518694e-01 -2.42518694e-01
 -2.42518694e-01  1.10852774e+00  1.03133994e+01  4.96855740e+01
  1.87878502e+02  7.01265993e+02  2.84175171e+03  1.23108401e+04
  4.09254532e+04  1.04965365e+05  2.30146444e+05  4.55959732e+05
  8.44910758e+05  1.52808685e+06  2.85035281e+06  5.80823826e+06]
E1 = -706.741200233541  E_coul = 198.7574712612548
Extra cycle  E= -507.983728972286  delta_E= -3.98e-13  |g|= 4.32e-09  |ddm|= 6.27e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.56003386e-01 6.61643965e-01 1.17616814e+05 3.00209287e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104199e+04 3.67547143e+04 7.30311643e+03 1.83757979e+04
 1.44912360e+03 3.75732807e+02 1.17671201e+02 4.35135855e+01
 1.70846974e+01 7.34478800e+00 8.61621469e+00 4.92820541e-01]
E = -507.9837289722862
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:13:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.256003385533       1
[INPUT] 0    0    [1    /1   ]  0.661643965093       1
[INPUT] 0    0    [1    /1   ]  117616.813823        1
[INPUT] 0    0    [1    /1   ]  3.00209287355        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031067        1
[INPUT] 0    0    [1    /1   ]  147020.991892        1
[INPUT] 0    0    [1    /1   ]  73510.4199094        1
[INPUT] 0    0    [1    /1   ]  36754.71433          1
[INPUT] 0    0    [1    /1   ]  7303.11643329        1
[INPUT] 0    0    [1    /1   ]  18375.7979443        1
[INPUT] 0    0    [1    /1   ]  1449.12360156        1
[INPUT] 0    0    [1    /1   ]  375.732807221        1
[INPUT] 0    0    [1    /1   ]  117.671201423        1
[INPUT] 0    0    [1    /1   ]  43.513585492         1
[INPUT] 0    0    [1    /1   ]  17.0846974291        1
[INPUT] 0    0    [1    /1   ]  7.34478799766        1
[INPUT] 1    0    [1    /1   ]  8.61621468808        1
[INPUT] 1    0    [1    /1   ]  0.492820540728       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2560033855330211, 1.0]], [0, [0.6616439650930117, 1.0]], [0, [117616.81382312524, 1.0]], [0, [3.002092873551931, 1.0]], [0, [1176168.1426170242, 1.0]], [0, [588084.0699812858, 1.0]], [0, [294042.0310667403, 1.0]], [0, [147020.99189233768, 1.0]], [0, [73510.41990939897, 1.0]], [0, [36754.714329974595, 1.0]], [0, [7303.116433291439, 1.0]], [0, [18375.79794427285, 1.0]], [0, [1449.1236015614068, 1.0]], [0, [375.73280722138725, 1.0]], [0, [117.6712014232487, 1.0]], [0, [43.51358549199935, 1.0]], [0, [17.084697429081082, 1.0]], [0, [7.344787997664214, 1.0]], [1, [8.616214688082144, 1.0]], [1, [0.49282054072817705, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25600339]
bas 1, expnt(s) = [0.66164397]
bas 2, expnt(s) = [117616.81382313]
bas 3, expnt(s) = [3.00209287]
bas 4, expnt(s) = [1176168.14261702]
bas 5, expnt(s) = [588084.06998129]
bas 6, expnt(s) = [294042.03106674]
bas 7, expnt(s) = [147020.99189234]
bas 8, expnt(s) = [73510.4199094]
bas 9, expnt(s) = [36754.71432997]
bas 10, expnt(s) = [7303.11643329]
bas 11, expnt(s) = [18375.79794427]
bas 12, expnt(s) = [1449.12360156]
bas 13, expnt(s) = [375.73280722]
bas 14, expnt(s) = [117.67120142]
bas 15, expnt(s) = [43.51358549]
bas 16, expnt(s) = [17.08469743]
bas 17, expnt(s) = [7.344788]
bas 18, expnt(s) = [8.61621469]
bas 19, expnt(s) = [0.49282054]
CPU time:       718.38
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.56003386e-01 9.09283490e-01 6.61643965e-01 1.85346031e+00
 1.17616814e+05 1.60460109e+04 3.00209287e+00 5.76213086e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104199e+04 1.12791586e+04 3.67547143e+04 6.70655998e+03
 7.30311643e+03 1.99593408e+03 1.83757979e+04 3.98749067e+03
 1.44912360e+03 5.93395292e+02 3.75732807e+02 2.15612712e+02
 1.17671201e+02 9.02646422e+01 4.35135855e+01 4.28039331e+01
 1.70846974e+01 2.12310021e+01 7.34478800e+00 1.12719609e+01
 8.61621469e+00 4.30655534e+01 4.92820541e-01 1.20460703e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.3356533104171
cond(S) = 908950.1793010682
E1 = -689.6460317301638  E_coul = 185.0233984234678
init E= -504.622633306696
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672311641687764  LUMO = 0.722015772775382
  mo_energy =
[-1.21695935e+02 -1.33818711e+01 -7.61995142e+00 -7.61995142e+00
 -7.61995142e+00 -1.65714438e+00 -6.72311642e-01 -6.72311642e-01
 -6.72311642e-01  7.22015773e-01  9.53135245e+00  4.85833444e+01
  1.86567606e+02  6.99903832e+02  2.84046550e+03  1.23096737e+04
  4.09243576e+04  1.04964308e+05  2.30145412e+05  4.55958718e+05
  8.44909757e+05  1.52808586e+06  2.85035183e+06  5.80823729e+06]
E1 = -707.8024296544762  E_coul = 199.8364931917381
cycle= 1 E= -507.965936462738  delta_E= -3.34  |g|= 0.451  |ddm|= 0.508
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.698434
diis-c [-0.48781004  1.        ]
  HOMO = -0.217503519553095  LUMO = 1.11556998137585
  mo_energy =
[-1.20186340e+02 -1.23002689e+01 -6.59023490e+00 -6.59023490e+00
 -6.59023490e+00 -1.16278617e+00 -2.17503520e-01 -2.17503520e-01
 -2.17503520e-01  1.11556998e+00  1.03633109e+01  4.97693559e+01
  1.87987812e+02  7.01395238e+02  2.84189775e+03  1.23109970e+04
  4.09256140e+04  1.04965528e+05  2.30146608e+05  4.55959896e+05
  8.44910922e+05  1.52808701e+06  2.85035297e+06  5.80823843e+06]
E1 = -706.8618583460103  E_coul = 198.87838497363148
cycle= 2 E= -507.983473372379  delta_E= -0.0175  |g|= 0.0347  |ddm|= 0.435
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0295405
diis-c [-8.72640838e-04  6.36617388e-05  9.99936338e-01]
  HOMO = -0.239302036597759  LUMO = 1.10964820904453
  mo_energy =
[-1.20299474e+02 -1.23667452e+01 -6.66390159e+00 -6.66390159e+00
 -6.66390159e+00 -1.17679441e+00 -2.39302037e-01 -2.39302037e-01
 -2.39302037e-01  1.10964821e+00  1.03197016e+01  4.96948858e+01
  1.87889606e+02  7.01278262e+02  2.84176482e+03  1.23108537e+04
  4.09254670e+04  1.04965379e+05  2.30146458e+05  4.55959746e+05
  8.44910772e+05  1.52808686e+06  2.85035282e+06  5.80823828e+06]
E1 = -706.7565815667748  E_coul = 198.77285717308487
cycle= 3 E= -507.98372439369  delta_E= -0.000251  |g|= 0.00432  |ddm|= 0.0599
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00316246
diis-c [-2.18668287e-06  2.46395251e-05 -1.04688470e-01  1.10466383e+00]
  HOMO = -0.242381547697574  LUMO = 1.10858175276917
  mo_energy =
[-1.20311239e+02 -1.23752367e+01 -6.67289077e+00 -6.67289077e+00
 -6.67289077e+00 -1.17865534e+00 -2.42381548e-01 -2.42381548e-01
 -2.42381548e-01  1.10858175e+00  1.03136596e+01  4.96859022e+01
  1.87878848e+02  7.01266347e+02  2.84175207e+03  1.23108405e+04
  4.09254536e+04  1.04965366e+05  2.30146445e+05  4.55959732e+05
  8.44910758e+05  1.52808685e+06  2.85035281e+06  5.80823826e+06]
E1 = -706.7418486554224  E_coul = 198.75811969258876
cycle= 4 E= -507.983728962834  delta_E= -4.57e-06  |g|= 0.000201  |ddm|= 0.00921
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141028
diis-c [-1.23376516e-10 -7.27952042e-06  6.96429959e-03 -9.89012646e-02
  1.09194424e+00]
  HOMO = -0.242518090998471  LUMO = 1.10852783196699
  mo_energy =
[-1.20311590e+02 -1.23755702e+01 -6.67322246e+00 -6.67322246e+00
 -6.67322246e+00 -1.17873664e+00 -2.42518091e-01 -2.42518091e-01
 -2.42518091e-01  1.10852783e+00  1.03134005e+01  4.96855755e+01
  1.87878503e+02  7.01265995e+02  2.84175171e+03  1.23108401e+04
  4.09254532e+04  1.04965365e+05  2.30146444e+05  4.55959732e+05
  8.44910758e+05  1.52808685e+06  2.85035281e+06  5.80823826e+06]
E1 = -706.7412033080745  E_coul = 198.75747433578894
cycle= 5 E= -507.983728972286  delta_E= -9.45e-09  |g|= 9.98e-07  |ddm|= 0.000454
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.65049e-07
diis-c [-4.89840888e-14  2.03744700e-07 -1.25612707e-04  1.59721415e-03
 -1.87973669e-02  1.01732556e+00]
  HOMO = -0.242518677116716  LUMO = 1.10852774999467
  mo_energy =
[-1.20311592e+02 -1.23755716e+01 -6.67322394e+00 -6.67322394e+00
 -6.67322394e+00 -1.17873712e+00 -2.42518677e-01 -2.42518677e-01
 -2.42518677e-01  1.10852775e+00  1.03133994e+01  4.96855741e+01
  1.87878502e+02  7.01265993e+02  2.84175171e+03  1.23108401e+04
  4.09254532e+04  1.04965365e+05  2.30146444e+05  4.55959732e+05
  8.44910758e+05  1.52808685e+06  2.85035281e+06  5.80823826e+06]
E1 = -706.7412003097264  E_coul = 198.7574713374406
cycle= 6 E= -507.983728972286  delta_E= -2.27e-13  |g|= 3.27e-08  |ddm|= 2.19e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7412003097264  E_coul = 198.7574713374406
  HOMO = -0.242518693666893  LUMO = 1.10852774053985
  mo_energy =
[-1.20311592e+02 -1.23755717e+01 -6.67322397e+00 -6.67322397e+00
 -6.67322397e+00 -1.17873713e+00 -2.42518694e-01 -2.42518694e-01
 -2.42518694e-01  1.10852774e+00  1.03133994e+01  4.96855740e+01
  1.87878502e+02  7.01265993e+02  2.84175171e+03  1.23108401e+04
  4.09254532e+04  1.04965365e+05  2.30146444e+05  4.55959732e+05
  8.44910758e+05  1.52808685e+06  2.85035281e+06  5.80823826e+06]
E1 = -706.741200233541  E_coul = 198.7574712612548
Extra cycle  E= -507.983728972286  delta_E= -3.98e-13  |g|= 4.32e-09  |ddm|= 6.27e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908950.1793010682
E1 = -706.741200233541  E_coul = 198.7574712612548
init E= -507.983728972286
    CPU time for initialize scf      3.57 sec, wall time      0.23 sec
  HOMO = -0.242518695973291  LUMO = 1.10852774004202
  mo_energy =
[-1.20311592e+02 -1.23755717e+01 -6.67322398e+00 -6.67322398e+00
 -6.67322398e+00 -1.17873713e+00 -2.42518696e-01 -2.42518696e-01
 -2.42518696e-01  1.10852774e+00  1.03133993e+01  4.96855740e+01
  1.87878502e+02  7.01265993e+02  2.84175171e+03  1.23108401e+04
  4.09254532e+04  1.04965365e+05  2.30146444e+05  4.55959732e+05
  8.44910758e+05  1.52808685e+06  2.85035281e+06  5.80823826e+06]
E1 = -706.7412002215685  E_coul = 198.75747124928282
cycle= 1 E= -507.983728972286  delta_E= 5.12e-13  |g|= 9.88e-10  |ddm|= 8.5e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.7412002215685  E_coul = 198.75747124928282
  HOMO = -0.242518696318202  LUMO = 1.10852773835705
  mo_energy =
[-1.20311592e+02 -1.23755717e+01 -6.67322398e+00 -6.67322398e+00
 -6.67322398e+00 -1.17873713e+00 -2.42518696e-01 -2.42518696e-01
 -2.42518696e-01  1.10852774e+00  1.03133993e+01  4.96855740e+01
  1.87878502e+02  7.01265993e+02  2.84175171e+03  1.23108401e+04
  4.09254532e+04  1.04965365e+05  2.30146444e+05  4.55959732e+05
  8.44910758e+05  1.52808685e+06  2.85035281e+06  5.80823826e+06]
E1 = -706.7412002229487  E_coul = 198.75747125066303
Extra cycle  E= -507.983728972286  delta_E=    0  |g|= 1.35e-09  |ddm|= 9.01e-10
    CPU time for scf_cycle      4.02 sec, wall time      0.39 sec
exp = [2.56003386e-01 6.61643965e-01 1.17616814e+05 3.00209287e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104199e+04 3.67547143e+04 7.30311643e+03 1.83757979e+04
 1.44912360e+03 3.75732807e+02 1.17671201e+02 4.35135855e+01
 1.70846974e+01 7.34478800e+00 8.61621469e+00 4.92820541e-01]
grad_E = [ 8.87519870e-03 -1.22091868e-03  4.22550238e-09 -3.63914534e-04
  1.92849237e-11  1.14173550e-10  6.57407429e-10  2.57852600e-09
  1.07139210e-08  5.75861497e-08  3.62506041e-06  1.24287090e-07
  3.76996535e-06  2.60777495e-05 -6.62114945e-04  1.60835159e-04
 -9.02222723e-06  8.27661360e-04  9.99711636e-03 -6.69877687e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:13:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.253935128986       1
[INPUT] 0    0    [1    /1   ]  0.662255839006       1
[INPUT] 0    0    [1    /1   ]  117616.813813        1
[INPUT] 0    0    [1    /1   ]  2.85843535028        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031065        1
[INPUT] 0    0    [1    /1   ]  147020.991886        1
[INPUT] 0    0    [1    /1   ]  73510.4198848        1
[INPUT] 0    0    [1    /1   ]  36754.7141985        1
[INPUT] 0    0    [1    /1   ]  7303.10812327        1
[INPUT] 0    0    [1    /1   ]  18375.7976552        1
[INPUT] 0    0    [1    /1   ]  1449.13459534        1
[INPUT] 0    0    [1    /1   ]  375.54832606         1
[INPUT] 0    0    [1    /1   ]  118.652980769        1
[INPUT] 0    0    [1    /1   ]  44.782829538         1
[INPUT] 0    0    [1    /1   ]  18.2983255194        1
[INPUT] 0    0    [1    /1   ]  7.00892140058        1
[INPUT] 1    0    [1    /1   ]  8.61813631587        1
[INPUT] 1    0    [1    /1   ]  0.492824339788       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2539351289859783, 1.0]], [0, [0.6622558390057329, 1.0]], [0, [117616.81381345261, 1.0]], [0, [2.8584353502790236, 1.0]], [0, [1176168.1426169768, 1.0]], [0, [588084.0699810219, 1.0]], [0, [294042.03106523585, 1.0]], [0, [147020.9918864315, 1.0]], [0, [73510.41988484071, 1.0]], [0, [36754.714198531045, 1.0]], [0, [7303.10812326543, 1.0]], [0, [18375.797655180577, 1.0]], [0, [1449.1345953399348, 1.0]], [0, [375.5483260595194, 1.0]], [0, [118.65298076906579, 1.0]], [0, [44.782829537998495, 1.0]], [0, [18.29832551942074, 1.0]], [0, [7.008921400577191, 1.0]], [1, [8.61813631587077, 1.0]], [1, [0.49282433978796925, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25393513]
bas 1, expnt(s) = [0.66225584]
bas 2, expnt(s) = [117616.81381345]
bas 3, expnt(s) = [2.85843535]
bas 4, expnt(s) = [1176168.14261698]
bas 5, expnt(s) = [588084.06998102]
bas 6, expnt(s) = [294042.03106524]
bas 7, expnt(s) = [147020.99188643]
bas 8, expnt(s) = [73510.41988484]
bas 9, expnt(s) = [36754.71419853]
bas 10, expnt(s) = [7303.10812327]
bas 11, expnt(s) = [18375.79765518]
bas 12, expnt(s) = [1449.13459534]
bas 13, expnt(s) = [375.54832606]
bas 14, expnt(s) = [118.65298077]
bas 15, expnt(s) = [44.78282954]
bas 16, expnt(s) = [18.29832552]
bas 17, expnt(s) = [7.0089214]
bas 18, expnt(s) = [8.61813632]
bas 19, expnt(s) = [0.49282434]
CPU time:       730.19
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.53935129e-01 9.03768318e-01 6.62255839e-01 1.85474569e+00
 1.17616814e+05 1.60460109e+04 2.85843535e+00 5.55406944e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104199e+04 1.12791586e+04 3.67547142e+04 6.70655996e+03
 7.30310812e+03 1.99593237e+03 1.83757977e+04 3.98749062e+03
 1.44913460e+03 5.93398669e+02 3.75548326e+02 2.15533309e+02
 1.18652981e+02 9.08288915e+01 4.47828295e+01 4.37369679e+01
 1.82983255e+01 2.23523679e+01 7.00892140e+00 1.08831200e+01
 8.61813632e+00 4.30775596e+01 4.92824340e-01 1.20461864e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335693155914193
cond(S) = 909049.5478070051
E1 = -689.655076519319  E_coul = 185.03184240660786
init E= -504.623234112711
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672331482729262  LUMO = 0.711696584093462
  mo_energy =
[-1.21694303e+02 -1.33812620e+01 -7.61935674e+00 -7.61935674e+00
 -7.61935674e+00 -1.65703830e+00 -6.72331483e-01 -6.72331483e-01
 -6.72331483e-01  7.11696584e-01  9.09348007e+00  4.88661488e+01
  1.91579712e+02  7.09578117e+02  2.85092718e+03  1.23191203e+04
  4.09331397e+04  1.04972732e+05  2.30153600e+05  4.55966734e+05
  8.44917643e+05  1.52809362e+06  2.85035943e+06  5.80824469e+06]
E1 = -707.8089055996777  E_coul = 199.84256878598043
cycle= 1 E= -507.966336813697  delta_E= -3.34  |g|= 0.452  |ddm|= 0.506
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.701786
diis-c [-0.49250404  1.        ]
  HOMO = -0.217551743028824  LUMO = 1.10248631975293
  mo_energy =
[-1.20184947e+02 -1.22998759e+01 -6.58985241e+00 -6.58985241e+00
 -6.58985241e+00 -1.16275380e+00 -2.17551743e-01 -2.17551743e-01
 -2.17551743e-01  1.10248632e+00  9.91444176e+00  5.00608075e+01
  1.93004241e+02  7.11069615e+02  2.85235924e+03  1.23204432e+04
  4.09343958e+04  1.04973951e+05  2.30154795e+05  4.55967912e+05
  8.44918807e+05  1.52809477e+06  2.85036057e+06  5.80824582e+06]
E1 = -706.8668730271455  E_coul = 198.8829662448724
cycle= 2 E= -507.983906782273  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.432
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0296998
diis-c [-8.81984186e-04  4.37169155e-04  9.99562831e-01]
  HOMO = -0.239350415773685  LUMO = 1.09671026752345
  mo_energy =
[-1.20298276e+02 -1.23664264e+01 -6.66362063e+00 -6.66362063e+00
 -6.66362063e+00 -1.17675573e+00 -2.39350416e-01 -2.39350416e-01
 -2.39350416e-01  1.09671027e+00  9.87170363e+00  4.99856683e+01
  1.92905360e+02  7.10952374e+02  2.85222609e+03  1.23202998e+04
  4.09342486e+04  1.04973802e+05  2.30154645e+05  4.55967762e+05
  8.44918657e+05  1.52809462e+06  2.85036042e+06  5.80824567e+06]
E1 = -706.7615025711593  E_coul = 198.77734418529243
cycle= 3 E= -507.984158385867  delta_E= -0.000252  |g|= 0.00434  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00320235
diis-c [-2.21365791e-06  1.32881302e-05 -1.05714517e-01  1.10570123e+00]
  HOMO = -0.242446182020558  LUMO = 1.09565914647466
  mo_energy =
[-1.20310104e+02 -1.23749574e+01 -6.67265349e+00 -6.67265349e+00
 -6.67265349e+00 -1.17862678e+00 -2.42446182e-01 -2.42446182e-01
 -2.42446182e-01  1.09565915e+00  9.86574019e+00  4.99765961e+01
  1.92894511e+02  7.10940390e+02  2.85221327e+03  1.23202865e+04
  4.09342351e+04  1.04973789e+05  2.30154632e+05  4.55967748e+05
  8.44918643e+05  1.52809460e+06  2.85036041e+06  5.80824566e+06]
E1 = -706.7466775896228  E_coul = 198.7625145699616
cycle= 4 E= -507.984163019661  delta_E= -4.63e-06  |g|= 0.000202  |ddm|= 0.00932
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00014145
diis-c [-1.36981628e-10 -7.50261617e-06  7.03200610e-03 -9.86362204e-02
  1.09161172e+00]
  HOMO = -0.242582498845776  LUMO = 1.09560594484379
  mo_energy =
[-1.20310448e+02 -1.23752878e+01 -6.67298153e+00 -6.67298153e+00
 -6.67298153e+00 -1.17870800e+00 -2.42582499e-01 -2.42582499e-01
 -2.42582499e-01  1.09560594e+00  9.86548597e+00  4.99762727e+01
  1.92894171e+02  7.10940045e+02  2.85221292e+03  1.23202861e+04
  4.09342347e+04  1.04973788e+05  2.30154632e+05  4.55967748e+05
  8.44918643e+05  1.52809460e+06  2.85036041e+06  5.80824566e+06]
E1 = -706.7460329831774  E_coul = 198.7618699539455
cycle= 5 E= -507.984163029232  delta_E= -9.57e-09  |g|= 1.23e-06  |ddm|= 0.00046
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.69231e-07
diis-c [-7.57279164e-14  2.29282051e-07 -1.57193054e-04  2.00388100e-03
 -2.37227011e-02  1.02187578e+00]
  HOMO = -0.24258321638999  LUMO = 1.09560581304411
  mo_energy =
[-1.20310450e+02 -1.23752895e+01 -6.67298329e+00 -6.67298329e+00
 -6.67298329e+00 -1.17870856e+00 -2.42583216e-01 -2.42583216e-01
 -2.42583216e-01  1.09560581e+00  9.86548466e+00  4.99762709e+01
  1.92894169e+02  7.10940042e+02  2.85221292e+03  1.23202861e+04
  4.09342347e+04  1.04973788e+05  2.30154632e+05  4.55967748e+05
  8.44918643e+05  1.52809460e+06  2.85036041e+06  5.80824566e+06]
E1 = -706.7460293425138  E_coul = 198.7618663132816
cycle= 6 E= -507.984163029232  delta_E= -2.84e-13  |g|= 4.08e-08  |ddm|= 2.74e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7460293425138  E_coul = 198.7618663132816
  HOMO = -0.24258323660384  LUMO = 1.0956058018262
  mo_energy =
[-1.20310451e+02 -1.23752895e+01 -6.67298333e+00 -6.67298333e+00
 -6.67298333e+00 -1.17870857e+00 -2.42583237e-01 -2.42583237e-01
 -2.42583237e-01  1.09560580e+00  9.86548462e+00  4.99762709e+01
  1.92894169e+02  7.10940042e+02  2.85221292e+03  1.23202861e+04
  4.09342347e+04  1.04973788e+05  2.30154632e+05  4.55967748e+05
  8.44918643e+05  1.52809460e+06  2.85036041e+06  5.80824566e+06]
E1 = -706.7460292500158  E_coul = 198.76186622078367
Extra cycle  E= -507.984163029232  delta_E= 5.68e-14  |g|= 5.36e-09  |ddm|= 7.77e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.53935129e-01 6.62255839e-01 1.17616814e+05 2.85843535e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104199e+04 3.67547142e+04 7.30310812e+03 1.83757977e+04
 1.44913460e+03 3.75548326e+02 1.18652981e+02 4.47828295e+01
 1.82983255e+01 7.00892140e+00 8.61813632e+00 4.92824340e-01]
E = -507.98416302923215
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:13:09 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.253935128986       1
[INPUT] 0    0    [1    /1   ]  0.662255839006       1
[INPUT] 0    0    [1    /1   ]  117616.813813        1
[INPUT] 0    0    [1    /1   ]  2.85843535028        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031065        1
[INPUT] 0    0    [1    /1   ]  147020.991886        1
[INPUT] 0    0    [1    /1   ]  73510.4198848        1
[INPUT] 0    0    [1    /1   ]  36754.7141985        1
[INPUT] 0    0    [1    /1   ]  7303.10812327        1
[INPUT] 0    0    [1    /1   ]  18375.7976552        1
[INPUT] 0    0    [1    /1   ]  1449.13459534        1
[INPUT] 0    0    [1    /1   ]  375.54832606         1
[INPUT] 0    0    [1    /1   ]  118.652980769        1
[INPUT] 0    0    [1    /1   ]  44.782829538         1
[INPUT] 0    0    [1    /1   ]  18.2983255194        1
[INPUT] 0    0    [1    /1   ]  7.00892140058        1
[INPUT] 1    0    [1    /1   ]  8.61813631587        1
[INPUT] 1    0    [1    /1   ]  0.492824339788       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2539351289859783, 1.0]], [0, [0.6622558390057329, 1.0]], [0, [117616.81381345261, 1.0]], [0, [2.8584353502790236, 1.0]], [0, [1176168.1426169768, 1.0]], [0, [588084.0699810219, 1.0]], [0, [294042.03106523585, 1.0]], [0, [147020.9918864315, 1.0]], [0, [73510.41988484071, 1.0]], [0, [36754.714198531045, 1.0]], [0, [7303.10812326543, 1.0]], [0, [18375.797655180577, 1.0]], [0, [1449.1345953399348, 1.0]], [0, [375.5483260595194, 1.0]], [0, [118.65298076906579, 1.0]], [0, [44.782829537998495, 1.0]], [0, [18.29832551942074, 1.0]], [0, [7.008921400577191, 1.0]], [1, [8.61813631587077, 1.0]], [1, [0.49282433978796925, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25393513]
bas 1, expnt(s) = [0.66225584]
bas 2, expnt(s) = [117616.81381345]
bas 3, expnt(s) = [2.85843535]
bas 4, expnt(s) = [1176168.14261698]
bas 5, expnt(s) = [588084.06998102]
bas 6, expnt(s) = [294042.03106524]
bas 7, expnt(s) = [147020.99188643]
bas 8, expnt(s) = [73510.41988484]
bas 9, expnt(s) = [36754.71419853]
bas 10, expnt(s) = [7303.10812327]
bas 11, expnt(s) = [18375.79765518]
bas 12, expnt(s) = [1449.13459534]
bas 13, expnt(s) = [375.54832606]
bas 14, expnt(s) = [118.65298077]
bas 15, expnt(s) = [44.78282954]
bas 16, expnt(s) = [18.29832552]
bas 17, expnt(s) = [7.0089214]
bas 18, expnt(s) = [8.61813632]
bas 19, expnt(s) = [0.49282434]
CPU time:       731.63
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.53935129e-01 9.03768318e-01 6.62255839e-01 1.85474569e+00
 1.17616814e+05 1.60460109e+04 2.85843535e+00 5.55406944e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104199e+04 1.12791586e+04 3.67547142e+04 6.70655996e+03
 7.30310812e+03 1.99593237e+03 1.83757977e+04 3.98749062e+03
 1.44913460e+03 5.93398669e+02 3.75548326e+02 2.15533309e+02
 1.18652981e+02 9.08288915e+01 4.47828295e+01 4.37369679e+01
 1.82983255e+01 2.23523679e+01 7.00892140e+00 1.08831200e+01
 8.61813632e+00 4.30775596e+01 4.92824340e-01 1.20461864e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335693155914193
cond(S) = 909049.5478070051
E1 = -689.655076519319  E_coul = 185.03184240660786
init E= -504.623234112711
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672331482729262  LUMO = 0.711696584093462
  mo_energy =
[-1.21694303e+02 -1.33812620e+01 -7.61935674e+00 -7.61935674e+00
 -7.61935674e+00 -1.65703830e+00 -6.72331483e-01 -6.72331483e-01
 -6.72331483e-01  7.11696584e-01  9.09348007e+00  4.88661488e+01
  1.91579712e+02  7.09578117e+02  2.85092718e+03  1.23191203e+04
  4.09331397e+04  1.04972732e+05  2.30153600e+05  4.55966734e+05
  8.44917643e+05  1.52809362e+06  2.85035943e+06  5.80824469e+06]
E1 = -707.8089055996777  E_coul = 199.84256878598043
cycle= 1 E= -507.966336813697  delta_E= -3.34  |g|= 0.452  |ddm|= 0.506
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.701786
diis-c [-0.49250404  1.        ]
  HOMO = -0.217551743028824  LUMO = 1.10248631975293
  mo_energy =
[-1.20184947e+02 -1.22998759e+01 -6.58985241e+00 -6.58985241e+00
 -6.58985241e+00 -1.16275380e+00 -2.17551743e-01 -2.17551743e-01
 -2.17551743e-01  1.10248632e+00  9.91444176e+00  5.00608075e+01
  1.93004241e+02  7.11069615e+02  2.85235924e+03  1.23204432e+04
  4.09343958e+04  1.04973951e+05  2.30154795e+05  4.55967912e+05
  8.44918807e+05  1.52809477e+06  2.85036057e+06  5.80824582e+06]
E1 = -706.8668730271455  E_coul = 198.8829662448724
cycle= 2 E= -507.983906782273  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.432
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0296998
diis-c [-8.81984186e-04  4.37169155e-04  9.99562831e-01]
  HOMO = -0.239350415773685  LUMO = 1.09671026752345
  mo_energy =
[-1.20298276e+02 -1.23664264e+01 -6.66362063e+00 -6.66362063e+00
 -6.66362063e+00 -1.17675573e+00 -2.39350416e-01 -2.39350416e-01
 -2.39350416e-01  1.09671027e+00  9.87170363e+00  4.99856683e+01
  1.92905360e+02  7.10952374e+02  2.85222609e+03  1.23202998e+04
  4.09342486e+04  1.04973802e+05  2.30154645e+05  4.55967762e+05
  8.44918657e+05  1.52809462e+06  2.85036042e+06  5.80824567e+06]
E1 = -706.7615025711593  E_coul = 198.77734418529243
cycle= 3 E= -507.984158385867  delta_E= -0.000252  |g|= 0.00434  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00320235
diis-c [-2.21365791e-06  1.32881302e-05 -1.05714517e-01  1.10570123e+00]
  HOMO = -0.242446182020558  LUMO = 1.09565914647466
  mo_energy =
[-1.20310104e+02 -1.23749574e+01 -6.67265349e+00 -6.67265349e+00
 -6.67265349e+00 -1.17862678e+00 -2.42446182e-01 -2.42446182e-01
 -2.42446182e-01  1.09565915e+00  9.86574019e+00  4.99765961e+01
  1.92894511e+02  7.10940390e+02  2.85221327e+03  1.23202865e+04
  4.09342351e+04  1.04973789e+05  2.30154632e+05  4.55967748e+05
  8.44918643e+05  1.52809460e+06  2.85036041e+06  5.80824566e+06]
E1 = -706.7466775896228  E_coul = 198.7625145699616
cycle= 4 E= -507.984163019661  delta_E= -4.63e-06  |g|= 0.000202  |ddm|= 0.00932
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00014145
diis-c [-1.36981628e-10 -7.50261617e-06  7.03200610e-03 -9.86362204e-02
  1.09161172e+00]
  HOMO = -0.242582498845776  LUMO = 1.09560594484379
  mo_energy =
[-1.20310448e+02 -1.23752878e+01 -6.67298153e+00 -6.67298153e+00
 -6.67298153e+00 -1.17870800e+00 -2.42582499e-01 -2.42582499e-01
 -2.42582499e-01  1.09560594e+00  9.86548597e+00  4.99762727e+01
  1.92894171e+02  7.10940045e+02  2.85221292e+03  1.23202861e+04
  4.09342347e+04  1.04973788e+05  2.30154632e+05  4.55967748e+05
  8.44918643e+05  1.52809460e+06  2.85036041e+06  5.80824566e+06]
E1 = -706.7460329831774  E_coul = 198.7618699539455
cycle= 5 E= -507.984163029232  delta_E= -9.57e-09  |g|= 1.23e-06  |ddm|= 0.00046
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.69231e-07
diis-c [-7.57279164e-14  2.29282051e-07 -1.57193054e-04  2.00388100e-03
 -2.37227011e-02  1.02187578e+00]
  HOMO = -0.24258321638999  LUMO = 1.09560581304411
  mo_energy =
[-1.20310450e+02 -1.23752895e+01 -6.67298329e+00 -6.67298329e+00
 -6.67298329e+00 -1.17870856e+00 -2.42583216e-01 -2.42583216e-01
 -2.42583216e-01  1.09560581e+00  9.86548466e+00  4.99762709e+01
  1.92894169e+02  7.10940042e+02  2.85221292e+03  1.23202861e+04
  4.09342347e+04  1.04973788e+05  2.30154632e+05  4.55967748e+05
  8.44918643e+05  1.52809460e+06  2.85036041e+06  5.80824566e+06]
E1 = -706.7460293425138  E_coul = 198.7618663132816
cycle= 6 E= -507.984163029232  delta_E= -2.84e-13  |g|= 4.08e-08  |ddm|= 2.74e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7460293425138  E_coul = 198.7618663132816
  HOMO = -0.24258323660384  LUMO = 1.0956058018262
  mo_energy =
[-1.20310451e+02 -1.23752895e+01 -6.67298333e+00 -6.67298333e+00
 -6.67298333e+00 -1.17870857e+00 -2.42583237e-01 -2.42583237e-01
 -2.42583237e-01  1.09560580e+00  9.86548462e+00  4.99762709e+01
  1.92894169e+02  7.10940042e+02  2.85221292e+03  1.23202861e+04
  4.09342347e+04  1.04973788e+05  2.30154632e+05  4.55967748e+05
  8.44918643e+05  1.52809460e+06  2.85036041e+06  5.80824566e+06]
E1 = -706.7460292500158  E_coul = 198.76186622078367
Extra cycle  E= -507.984163029232  delta_E= 5.68e-14  |g|= 5.36e-09  |ddm|= 7.77e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909049.5478070051
E1 = -706.7460292500158  E_coul = 198.76186622078367
init E= -507.984163029232
    CPU time for initialize scf      3.58 sec, wall time      0.23 sec
  HOMO = -0.242583239422596  LUMO = 1.09560579985144
  mo_energy =
[-1.20310451e+02 -1.23752895e+01 -6.67298334e+00 -6.67298334e+00
 -6.67298334e+00 -1.17870857e+00 -2.42583239e-01 -2.42583239e-01
 -2.42583239e-01  1.09560580e+00  9.86548462e+00  4.99762709e+01
  1.92894169e+02  7.10940042e+02  2.85221292e+03  1.23202861e+04
  4.09342347e+04  1.04973788e+05  2.30154632e+05  4.55967748e+05
  8.44918643e+05  1.52809460e+06  2.85036041e+06  5.80824566e+06]
E1 = -706.7460292362704  E_coul = 198.7618662070384
cycle= 1 E= -507.984163029232  delta_E= 1.71e-13  |g|= 1.26e-09  |ddm|= 9.89e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.7460292362704  E_coul = 198.7618662070384
  HOMO = -0.242583239815488  LUMO = 1.09560580214927
  mo_energy =
[-1.20310451e+02 -1.23752895e+01 -6.67298334e+00 -6.67298334e+00
 -6.67298334e+00 -1.17870857e+00 -2.42583240e-01 -2.42583240e-01
 -2.42583240e-01  1.09560580e+00  9.86548462e+00  4.99762709e+01
  1.92894169e+02  7.10940042e+02  2.85221292e+03  1.23202861e+04
  4.09342347e+04  1.04973788e+05  2.30154632e+05  4.55967748e+05
  8.44918643e+05  1.52809460e+06  2.85036041e+06  5.80824566e+06]
E1 = -706.7460292320964  E_coul = 198.761866202864
Extra cycle  E= -507.984163029232  delta_E= -3.98e-13  |g|= 1.21e-09  |ddm|= 2.86e-09
    CPU time for scf_cycle      4.03 sec, wall time      0.39 sec
exp = [2.53935129e-01 6.62255839e-01 1.17616814e+05 2.85843535e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104199e+04 3.67547142e+04 7.30310812e+03 1.83757977e+04
 1.44913460e+03 3.75548326e+02 1.18652981e+02 4.47828295e+01
 1.82983255e+01 7.00892140e+00 8.61813632e+00 4.92824340e-01]
grad_E = [ 1.02877476e-02 -2.00916031e-03  4.15671155e-09 -1.67534390e-03
  1.84688158e-11  1.11939898e-10  6.46760323e-10  2.53601030e-09
  1.05347097e-08  5.67034705e-08  3.56356263e-06  1.21598227e-07
  6.71635623e-06  7.00356649e-06 -7.10351357e-04  4.71721328e-04
 -9.63988963e-05  6.23913563e-04  1.15333597e-02 -9.59205745e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:13:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.251034378255       1
[INPUT] 0    0    [1    /1   ]  0.656312742641       1
[INPUT] 0    0    [1    /1   ]  117616.813798        1
[INPUT] 0    0    [1    /1   ]  2.89504902181        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031063        1
[INPUT] 0    0    [1    /1   ]  147020.991877        1
[INPUT] 0    0    [1    /1   ]  73510.4198453        1
[INPUT] 0    0    [1    /1   ]  36754.713987         1
[INPUT] 0    0    [1    /1   ]  7303.09474699        1
[INPUT] 0    0    [1    /1   ]  18375.7971896        1
[INPUT] 0    0    [1    /1   ]  1449.15309048        1
[INPUT] 0    0    [1    /1   ]  375.244042895        1
[INPUT] 0    0    [1    /1   ]  120.267041108        1
[INPUT] 0    0    [1    /1   ]  46.4304750165        1
[INPUT] 0    0    [1    /1   ]  20.4192961412        1
[INPUT] 0    0    [1    /1   ]  7.07723889023        1
[INPUT] 1    0    [1    /1   ]  8.61329298652        1
[INPUT] 1    0    [1    /1   ]  0.492805250203       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2510343782549029, 1.0]], [0, [0.6563127426405705, 1.0]], [0, [117616.81379788324, 1.0]], [0, [2.8950490218054252, 1.0]], [0, [1176168.1426169001, 1.0]], [0, [588084.069980597, 1.0]], [0, [294042.0310628143, 1.0]], [0, [147020.99187692453, 1.0]], [0, [73510.41984530952, 1.0]], [0, [36754.71398697169, 1.0]], [0, [7303.094746992056, 1.0]], [0, [18375.797189649424, 1.0]], [0, [1449.153090480303, 1.0]], [0, [375.2440428951753, 1.0]], [0, [120.26704110761254, 1.0]], [0, [46.4304750164797, 1.0]], [0, [20.419296141232614, 1.0]], [0, [7.07723889023481, 1.0]], [1, [8.613292986522438, 1.0]], [1, [0.49280525020271054, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25103438]
bas 1, expnt(s) = [0.65631274]
bas 2, expnt(s) = [117616.81379788]
bas 3, expnt(s) = [2.89504902]
bas 4, expnt(s) = [1176168.1426169]
bas 5, expnt(s) = [588084.0699806]
bas 6, expnt(s) = [294042.03106281]
bas 7, expnt(s) = [147020.99187692]
bas 8, expnt(s) = [73510.41984531]
bas 9, expnt(s) = [36754.71398697]
bas 10, expnt(s) = [7303.09474699]
bas 11, expnt(s) = [18375.79718965]
bas 12, expnt(s) = [1449.15309048]
bas 13, expnt(s) = [375.2440429]
bas 14, expnt(s) = [120.26704111]
bas 15, expnt(s) = [46.43047502]
bas 16, expnt(s) = [20.41929614]
bas 17, expnt(s) = [7.07723889]
bas 18, expnt(s) = [8.61329299]
bas 19, expnt(s) = [0.49280525]
CPU time:       743.44
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.51034378e-01 8.96014267e-01 6.56312743e-01 1.84224825e+00
 1.17616814e+05 1.60460109e+04 2.89504902e+00 5.60734097e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791586e+04 3.67547140e+04 6.70655993e+03
 7.30309475e+03 1.99592963e+03 1.83757972e+04 3.98749054e+03
 1.44915309e+03 5.93404349e+02 3.75244043e+02 2.15402321e+02
 1.20267041e+02 9.17539974e+01 4.64304750e+01 4.49383756e+01
 2.04192961e+01 2.42686490e+01 7.07723889e+00 1.09625835e+01
 8.61329299e+00 4.30473001e+01 4.92805250e-01 1.20456031e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335776995904357
cond(S) = 909264.2434747337
E1 = -689.6371949623408  E_coul = 185.01016986138578
init E= -504.627025100955
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672278909541963  LUMO = 0.698675816855161
  mo_energy =
[-1.21699082e+02 -1.33829411e+01 -7.62089545e+00 -7.62089545e+00
 -7.62089545e+00 -1.65713965e+00 -6.72278910e-01 -6.72278910e-01
 -6.72278910e-01  6.98675817e-01  9.28419974e+00  5.22451870e+01
  2.02941086e+02  7.27800609e+02  2.87005011e+03  1.23363198e+04
  4.09491202e+04  1.04988059e+05  2.30168498e+05  4.55981320e+05
  8.44931990e+05  1.52810773e+06  2.85037326e+06  5.80825815e+06]
E1 = -707.7847488717102  E_coul = 199.81796092674375
cycle= 1 E= -507.966787944966  delta_E= -3.34  |g|= 0.451  |ddm|= 0.504
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.704847
diis-c [-0.4968093  1.       ]
  HOMO = -0.217614600457821  LUMO = 1.08791077286879
  mo_energy =
[-1.20189975e+02 -1.23017241e+01 -6.59161459e+00 -6.59161459e+00
 -6.59161459e+00 -1.16293018e+00 -2.17614600e-01 -2.17614600e-01
 -2.17614600e-01  1.08791077e+00  1.01158227e+01  5.34600860e+01
  2.04371433e+02  7.29292103e+02  2.87148217e+03  1.23376427e+04
  4.09503763e+04  1.04989278e+05  2.30169693e+05  4.55982498e+05
  8.44933154e+05  1.52810888e+06  2.85037440e+06  5.80825929e+06]
E1 = -706.8421416202625  E_coul = 198.85777872189382
cycle= 2 E= -507.984362898369  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.432
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0295865
diis-c [-8.74451852e-04  1.35033391e-03  9.98649666e-01]
  HOMO = -0.239452971828386  LUMO = 1.0821626365597
  mo_energy =
[-1.20303185e+02 -1.23682499e+01 -6.66533051e+00 -6.66533051e+00
 -6.66533051e+00 -1.17696866e+00 -2.39452972e-01 -2.39452972e-01
 -2.39452972e-01  1.08216264e+00  1.00723797e+01  5.33833836e+01
  2.04271909e+02  7.29174922e+02  2.87134920e+03  1.23374994e+04
  4.09502292e+04  1.04989129e+05  2.30169543e+05  4.55982348e+05
  8.44933004e+05  1.52810873e+06  2.85037425e+06  5.80825913e+06]
E1 = -706.7363523230225  E_coul = 198.75173568263287
cycle= 3 E= -507.98461664039  delta_E= -0.000254  |g|= 0.00438  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322403
diis-c [-2.17529312e-06 -2.24469241e-05 -1.07438751e-01  1.10746120e+00]
  HOMO = -0.242593723500236  LUMO = 1.08110353889336
  mo_energy =
[-1.20315172e+02 -1.23768910e+01 -6.67447992e+00 -6.67447992e+00
 -6.67447992e+00 -1.17886929e+00 -2.42593724e-01 -2.42593724e-01
 -2.42593724e-01  1.08110354e+00  1.00662584e+01  5.33740590e+01
  2.04260863e+02  7.29162770e+02  2.87133621e+03  1.23374859e+04
  4.09502155e+04  1.04989116e+05  2.30169529e+05  4.55982334e+05
  8.44932990e+05  1.52810872e+06  2.85037424e+06  5.80825912e+06]
E1 = -706.7212816272352  E_coul = 198.73666022248793
cycle= 4 E= -507.984621404747  delta_E= -4.76e-06  |g|= 0.000201  |ddm|= 0.00941
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000140141
diis-c [-1.38995783e-10 -7.60694256e-06  7.18585356e-03 -9.86652101e-02
  1.09148696e+00]
  HOMO = -0.242729970354874  LUMO = 1.08105050926833
  mo_energy =
[-1.20315513e+02 -1.23772203e+01 -6.67480651e+00 -6.67480651e+00
 -6.67480651e+00 -1.17895040e+00 -2.42729970e-01 -2.42729970e-01
 -2.42729970e-01  1.08105051e+00  1.00660021e+01  5.33737356e+01
  2.04260526e+02  7.29162429e+02  2.87133586e+03  1.23374856e+04
  4.09502152e+04  1.04989115e+05  2.30169529e+05  4.55982334e+05
  8.44932990e+05  1.52810872e+06  2.85037424e+06  5.80825912e+06]
E1 = -706.7206359638394  E_coul = 198.73601454953192
cycle= 5 E= -507.984621414308  delta_E= -9.56e-09  |g|= 1.18e-06  |ddm|= 0.000457
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.57635e-07
diis-c [-6.52690229e-14  2.21819164e-07 -1.52732810e-04  1.89835153e-03
 -2.25276762e-02  1.02078184e+00]
  HOMO = -0.242730667744239  LUMO = 1.08105039420862
  mo_energy =
[-1.20315515e+02 -1.23772220e+01 -6.67480825e+00 -6.67480825e+00
 -6.67480825e+00 -1.17895096e+00 -2.42730668e-01 -2.42730668e-01
 -2.42730668e-01  1.08105039e+00  1.00660008e+01  5.33737338e+01
  2.04260524e+02  7.29162426e+02  2.87133586e+03  1.23374856e+04
  4.09502152e+04  1.04989115e+05  2.30169529e+05  4.55982334e+05
  8.44932990e+05  1.52810872e+06  2.85037424e+06  5.80825912e+06]
E1 = -706.7206323922176  E_coul = 198.73601097791
cycle= 6 E= -507.984621414308  delta_E=    0  |g|= 3.68e-08  |ddm|= 2.63e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7206323922176  E_coul = 198.73601097791
  HOMO = -0.242730686082821  LUMO = 1.08105038358816
  mo_energy =
[-1.20315515e+02 -1.23772220e+01 -6.67480829e+00 -6.67480829e+00
 -6.67480829e+00 -1.17895097e+00 -2.42730686e-01 -2.42730686e-01
 -2.42730686e-01  1.08105038e+00  1.00660008e+01  5.33737338e+01
  2.04260524e+02  7.29162426e+02  2.87133586e+03  1.23374856e+04
  4.09502152e+04  1.04989115e+05  2.30169529e+05  4.55982334e+05
  8.44932990e+05  1.52810872e+06  2.85037424e+06  5.80825912e+06]
E1 = -706.720632306822  E_coul = 198.73601089251397
Extra cycle  E= -507.984621414308  delta_E= -5.68e-13  |g|= 4.75e-09  |ddm|= 7.05e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.51034378e-01 6.56312743e-01 1.17616814e+05 2.89504902e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547140e+04 7.30309475e+03 1.83757972e+04
 1.44915309e+03 3.75244043e+02 1.20267041e+02 4.64304750e+01
 2.04192961e+01 7.07723889e+00 8.61329299e+00 4.92805250e-01]
E = -507.9846214143081
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:13:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.251034378255       1
[INPUT] 0    0    [1    /1   ]  0.656312742641       1
[INPUT] 0    0    [1    /1   ]  117616.813798        1
[INPUT] 0    0    [1    /1   ]  2.89504902181        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031063        1
[INPUT] 0    0    [1    /1   ]  147020.991877        1
[INPUT] 0    0    [1    /1   ]  73510.4198453        1
[INPUT] 0    0    [1    /1   ]  36754.713987         1
[INPUT] 0    0    [1    /1   ]  7303.09474699        1
[INPUT] 0    0    [1    /1   ]  18375.7971896        1
[INPUT] 0    0    [1    /1   ]  1449.15309048        1
[INPUT] 0    0    [1    /1   ]  375.244042895        1
[INPUT] 0    0    [1    /1   ]  120.267041108        1
[INPUT] 0    0    [1    /1   ]  46.4304750165        1
[INPUT] 0    0    [1    /1   ]  20.4192961412        1
[INPUT] 0    0    [1    /1   ]  7.07723889023        1
[INPUT] 1    0    [1    /1   ]  8.61329298652        1
[INPUT] 1    0    [1    /1   ]  0.492805250203       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2510343782549029, 1.0]], [0, [0.6563127426405705, 1.0]], [0, [117616.81379788324, 1.0]], [0, [2.8950490218054252, 1.0]], [0, [1176168.1426169001, 1.0]], [0, [588084.069980597, 1.0]], [0, [294042.0310628143, 1.0]], [0, [147020.99187692453, 1.0]], [0, [73510.41984530952, 1.0]], [0, [36754.71398697169, 1.0]], [0, [7303.094746992056, 1.0]], [0, [18375.797189649424, 1.0]], [0, [1449.153090480303, 1.0]], [0, [375.2440428951753, 1.0]], [0, [120.26704110761254, 1.0]], [0, [46.4304750164797, 1.0]], [0, [20.419296141232614, 1.0]], [0, [7.07723889023481, 1.0]], [1, [8.613292986522438, 1.0]], [1, [0.49280525020271054, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25103438]
bas 1, expnt(s) = [0.65631274]
bas 2, expnt(s) = [117616.81379788]
bas 3, expnt(s) = [2.89504902]
bas 4, expnt(s) = [1176168.1426169]
bas 5, expnt(s) = [588084.0699806]
bas 6, expnt(s) = [294042.03106281]
bas 7, expnt(s) = [147020.99187692]
bas 8, expnt(s) = [73510.41984531]
bas 9, expnt(s) = [36754.71398697]
bas 10, expnt(s) = [7303.09474699]
bas 11, expnt(s) = [18375.79718965]
bas 12, expnt(s) = [1449.15309048]
bas 13, expnt(s) = [375.2440429]
bas 14, expnt(s) = [120.26704111]
bas 15, expnt(s) = [46.43047502]
bas 16, expnt(s) = [20.41929614]
bas 17, expnt(s) = [7.07723889]
bas 18, expnt(s) = [8.61329299]
bas 19, expnt(s) = [0.49280525]
CPU time:       744.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.51034378e-01 8.96014267e-01 6.56312743e-01 1.84224825e+00
 1.17616814e+05 1.60460109e+04 2.89504902e+00 5.60734097e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791586e+04 3.67547140e+04 6.70655993e+03
 7.30309475e+03 1.99592963e+03 1.83757972e+04 3.98749054e+03
 1.44915309e+03 5.93404349e+02 3.75244043e+02 2.15402321e+02
 1.20267041e+02 9.17539974e+01 4.64304750e+01 4.49383756e+01
 2.04192961e+01 2.42686490e+01 7.07723889e+00 1.09625835e+01
 8.61329299e+00 4.30473001e+01 4.92805250e-01 1.20456031e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335776995904357
cond(S) = 909264.2434747337
E1 = -689.6371949623408  E_coul = 185.01016986138578
init E= -504.627025100955
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672278909541963  LUMO = 0.698675816855161
  mo_energy =
[-1.21699082e+02 -1.33829411e+01 -7.62089545e+00 -7.62089545e+00
 -7.62089545e+00 -1.65713965e+00 -6.72278910e-01 -6.72278910e-01
 -6.72278910e-01  6.98675817e-01  9.28419974e+00  5.22451870e+01
  2.02941086e+02  7.27800609e+02  2.87005011e+03  1.23363198e+04
  4.09491202e+04  1.04988059e+05  2.30168498e+05  4.55981320e+05
  8.44931990e+05  1.52810773e+06  2.85037326e+06  5.80825815e+06]
E1 = -707.7847488717102  E_coul = 199.81796092674375
cycle= 1 E= -507.966787944966  delta_E= -3.34  |g|= 0.451  |ddm|= 0.504
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.704847
diis-c [-0.4968093  1.       ]
  HOMO = -0.217614600457821  LUMO = 1.08791077286879
  mo_energy =
[-1.20189975e+02 -1.23017241e+01 -6.59161459e+00 -6.59161459e+00
 -6.59161459e+00 -1.16293018e+00 -2.17614600e-01 -2.17614600e-01
 -2.17614600e-01  1.08791077e+00  1.01158227e+01  5.34600860e+01
  2.04371433e+02  7.29292103e+02  2.87148217e+03  1.23376427e+04
  4.09503763e+04  1.04989278e+05  2.30169693e+05  4.55982498e+05
  8.44933154e+05  1.52810888e+06  2.85037440e+06  5.80825929e+06]
E1 = -706.8421416202625  E_coul = 198.85777872189382
cycle= 2 E= -507.984362898369  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.432
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0295865
diis-c [-8.74451852e-04  1.35033391e-03  9.98649666e-01]
  HOMO = -0.239452971828386  LUMO = 1.0821626365597
  mo_energy =
[-1.20303185e+02 -1.23682499e+01 -6.66533051e+00 -6.66533051e+00
 -6.66533051e+00 -1.17696866e+00 -2.39452972e-01 -2.39452972e-01
 -2.39452972e-01  1.08216264e+00  1.00723797e+01  5.33833836e+01
  2.04271909e+02  7.29174922e+02  2.87134920e+03  1.23374994e+04
  4.09502292e+04  1.04989129e+05  2.30169543e+05  4.55982348e+05
  8.44933004e+05  1.52810873e+06  2.85037425e+06  5.80825913e+06]
E1 = -706.7363523230225  E_coul = 198.75173568263287
cycle= 3 E= -507.98461664039  delta_E= -0.000254  |g|= 0.00438  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322403
diis-c [-2.17529312e-06 -2.24469241e-05 -1.07438751e-01  1.10746120e+00]
  HOMO = -0.242593723500236  LUMO = 1.08110353889336
  mo_energy =
[-1.20315172e+02 -1.23768910e+01 -6.67447992e+00 -6.67447992e+00
 -6.67447992e+00 -1.17886929e+00 -2.42593724e-01 -2.42593724e-01
 -2.42593724e-01  1.08110354e+00  1.00662584e+01  5.33740590e+01
  2.04260863e+02  7.29162770e+02  2.87133621e+03  1.23374859e+04
  4.09502155e+04  1.04989116e+05  2.30169529e+05  4.55982334e+05
  8.44932990e+05  1.52810872e+06  2.85037424e+06  5.80825912e+06]
E1 = -706.7212816272352  E_coul = 198.73666022248793
cycle= 4 E= -507.984621404747  delta_E= -4.76e-06  |g|= 0.000201  |ddm|= 0.00941
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000140141
diis-c [-1.38995783e-10 -7.60694256e-06  7.18585356e-03 -9.86652101e-02
  1.09148696e+00]
  HOMO = -0.242729970354874  LUMO = 1.08105050926833
  mo_energy =
[-1.20315513e+02 -1.23772203e+01 -6.67480651e+00 -6.67480651e+00
 -6.67480651e+00 -1.17895040e+00 -2.42729970e-01 -2.42729970e-01
 -2.42729970e-01  1.08105051e+00  1.00660021e+01  5.33737356e+01
  2.04260526e+02  7.29162429e+02  2.87133586e+03  1.23374856e+04
  4.09502152e+04  1.04989115e+05  2.30169529e+05  4.55982334e+05
  8.44932990e+05  1.52810872e+06  2.85037424e+06  5.80825912e+06]
E1 = -706.7206359638394  E_coul = 198.73601454953192
cycle= 5 E= -507.984621414308  delta_E= -9.56e-09  |g|= 1.18e-06  |ddm|= 0.000457
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.57635e-07
diis-c [-6.52690229e-14  2.21819164e-07 -1.52732810e-04  1.89835153e-03
 -2.25276762e-02  1.02078184e+00]
  HOMO = -0.242730667744239  LUMO = 1.08105039420862
  mo_energy =
[-1.20315515e+02 -1.23772220e+01 -6.67480825e+00 -6.67480825e+00
 -6.67480825e+00 -1.17895096e+00 -2.42730668e-01 -2.42730668e-01
 -2.42730668e-01  1.08105039e+00  1.00660008e+01  5.33737338e+01
  2.04260524e+02  7.29162426e+02  2.87133586e+03  1.23374856e+04
  4.09502152e+04  1.04989115e+05  2.30169529e+05  4.55982334e+05
  8.44932990e+05  1.52810872e+06  2.85037424e+06  5.80825912e+06]
E1 = -706.7206323922176  E_coul = 198.73601097791
cycle= 6 E= -507.984621414308  delta_E=    0  |g|= 3.68e-08  |ddm|= 2.63e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7206323922176  E_coul = 198.73601097791
  HOMO = -0.242730686082821  LUMO = 1.08105038358816
  mo_energy =
[-1.20315515e+02 -1.23772220e+01 -6.67480829e+00 -6.67480829e+00
 -6.67480829e+00 -1.17895097e+00 -2.42730686e-01 -2.42730686e-01
 -2.42730686e-01  1.08105038e+00  1.00660008e+01  5.33737338e+01
  2.04260524e+02  7.29162426e+02  2.87133586e+03  1.23374856e+04
  4.09502152e+04  1.04989115e+05  2.30169529e+05  4.55982334e+05
  8.44932990e+05  1.52810872e+06  2.85037424e+06  5.80825912e+06]
E1 = -706.720632306822  E_coul = 198.73601089251397
Extra cycle  E= -507.984621414308  delta_E= -5.68e-13  |g|= 4.75e-09  |ddm|= 7.05e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909264.2434747337
E1 = -706.720632306822  E_coul = 198.73601089251397
init E= -507.984621414308
    CPU time for initialize scf      3.56 sec, wall time      0.23 sec
  HOMO = -0.242730688675068  LUMO = 1.08105038174433
  mo_energy =
[-1.20315515e+02 -1.23772220e+01 -6.67480829e+00 -6.67480829e+00
 -6.67480829e+00 -1.17895097e+00 -2.42730689e-01 -2.42730689e-01
 -2.42730689e-01  1.08105038e+00  1.00660008e+01  5.33737338e+01
  2.04260524e+02  7.29162426e+02  2.87133586e+03  1.23374856e+04
  4.09502152e+04  1.04989115e+05  2.30169529e+05  4.55982334e+05
  8.44932990e+05  1.52810872e+06  2.85037424e+06  5.80825912e+06]
E1 = -706.7206322974336  E_coul = 198.73601088312563
cycle= 1 E= -507.984621414308  delta_E= 1.71e-13  |g|= 1.51e-09  |ddm|= 7e-09
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.7206322974336  E_coul = 198.73601088312563
  HOMO = -0.242730688959346  LUMO = 1.08105038151948
  mo_energy =
[-1.20315515e+02 -1.23772220e+01 -6.67480829e+00 -6.67480829e+00
 -6.67480829e+00 -1.17895097e+00 -2.42730689e-01 -2.42730689e-01
 -2.42730689e-01  1.08105038e+00  1.00660008e+01  5.33737338e+01
  2.04260524e+02  7.29162426e+02  2.87133586e+03  1.23374856e+04
  4.09502152e+04  1.04989115e+05  2.30169529e+05  4.55982334e+05
  8.44932990e+05  1.52810872e+06  2.85037424e+06  5.80825912e+06]
E1 = -706.7206322956581  E_coul = 198.73601088135027
Extra cycle  E= -507.984621414308  delta_E= 5.68e-14  |g|= 1.3e-09  |ddm|= 1.2e-09
    CPU time for scf_cycle      4.01 sec, wall time      0.39 sec
exp = [2.51034378e-01 6.56312743e-01 1.17616814e+05 2.89504902e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547140e+04 7.30309475e+03 1.83757972e+04
 1.44915309e+03 3.75244043e+02 1.20267041e+02 4.64304750e+01
 2.04192961e+01 7.07723889e+00 8.61329299e+00 4.92805250e-01]
grad_E = [ 4.54700489e-03 -8.38260465e-04  3.94917099e-09 -3.16755009e-04
  1.59915794e-11  1.05207062e-10  6.14608999e-10  2.40776991e-09
  9.99433177e-09  5.40355150e-08  3.37400947e-06  1.13533015e-07
  1.67659480e-05 -9.48085048e-05 -4.10868861e-04  2.16184113e-04
  4.25669977e-05  4.26621573e-05  7.54555565e-03 -5.56549467e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:13:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249094375716       1
[INPUT] 0    0    [1    /1   ]  0.652851123284       1
[INPUT] 0    0    [1    /1   ]  117616.81379         1
[INPUT] 0    0    [1    /1   ]  2.91634738756        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031062        1
[INPUT] 0    0    [1    /1   ]  147020.991872        1
[INPUT] 0    0    [1    /1   ]  73510.4198254        1
[INPUT] 0    0    [1    /1   ]  36754.7138802        1
[INPUT] 0    0    [1    /1   ]  7303.08799325        1
[INPUT] 0    0    [1    /1   ]  18375.7969545        1
[INPUT] 0    0    [1    /1   ]  1449.16279039        1
[INPUT] 0    0    [1    /1   ]  375.085117323        1
[INPUT] 0    0    [1    /1   ]  121.116159748        1
[INPUT] 0    0    [1    /1   ]  47.1862224764        1
[INPUT] 0    0    [1    /1   ]  21.4632636057        1
[INPUT] 0    0    [1    /1   ]  7.15455961656        1
[INPUT] 1    0    [1    /1   ]  8.60638171326        1
[INPUT] 1    0    [1    /1   ]  0.492740274296       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2490943757156488, 1.0]], [0, [0.6528511232837321, 1.0]], [0, [117616.81379002257, 1.0]], [0, [2.916347387557002, 1.0]], [0, [1176168.1426168615, 1.0]], [0, [588084.0699803825, 1.0]], [0, [294042.0310615917, 1.0]], [0, [147020.9918721246, 1.0]], [0, [73510.4198253505, 1.0]], [0, [36754.713880165174, 1.0]], [0, [7303.087993254981, 1.0]], [0, [18375.796954542682, 1.0]], [0, [1449.1627903902368, 1.0]], [0, [375.0851173233019, 1.0]], [0, [121.1161597480041, 1.0]], [0, [47.186222476410144, 1.0]], [0, [21.463263605743787, 1.0]], [0, [7.154559616564736, 1.0]], [1, [8.60638171325668, 1.0]], [1, [0.49274027429589806, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24909438]
bas 1, expnt(s) = [0.65285112]
bas 2, expnt(s) = [117616.81379002]
bas 3, expnt(s) = [2.91634739]
bas 4, expnt(s) = [1176168.14261686]
bas 5, expnt(s) = [588084.06998038]
bas 6, expnt(s) = [294042.03106159]
bas 7, expnt(s) = [147020.99187212]
bas 8, expnt(s) = [73510.41982535]
bas 9, expnt(s) = [36754.71388017]
bas 10, expnt(s) = [7303.08799325]
bas 11, expnt(s) = [18375.79695454]
bas 12, expnt(s) = [1449.16279039]
bas 13, expnt(s) = [375.08511732]
bas 14, expnt(s) = [121.11615975]
bas 15, expnt(s) = [47.18622248]
bas 16, expnt(s) = [21.46326361]
bas 17, expnt(s) = [7.15455962]
bas 18, expnt(s) = [8.60638171]
bas 19, expnt(s) = [0.49274027]
CPU time:       756.65
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49094376e-01 8.90815911e-01 6.52851123e-01 1.83495594e+00
 1.17616814e+05 1.60460109e+04 2.91634739e+00 5.63825177e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547139e+04 6.70655992e+03
 7.30308799e+03 1.99592825e+03 1.83757970e+04 3.98749050e+03
 1.44916279e+03 5.93407328e+02 3.75085117e+02 2.15333896e+02
 1.21116160e+02 9.22394263e+01 4.71862225e+01 4.54858623e+01
 2.14632636e+01 2.51934036e+01 7.15455962e+00 1.10522883e+01
 8.60638171e+00 4.30041282e+01 4.92740274e-01 1.20436179e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335913850709115
cond(S) = 909373.0992771754
E1 = -689.606844670823  E_coul = 184.97786906805098
init E= -504.628975602772
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672260516239139  LUMO = 0.690035633544386
  mo_energy =
[-1.21705737e+02 -1.33854794e+01 -7.62316739e+00 -7.62316739e+00
 -7.62316739e+00 -1.65730365e+00 -6.72260516e-01 -6.72260516e-01
 -6.72260516e-01  6.90035634e-01  9.40555832e+00  5.40235318e+01
  2.08586400e+02  7.36844794e+02  2.87960333e+03  1.23449261e+04
  4.09571184e+04  1.04995730e+05  2.30175954e+05  4.55988620e+05
  8.44939171e+05  1.52811480e+06  2.85038018e+06  5.80826489e+06]
E1 = -707.7471926341015  E_coul = 199.7803067004738
cycle= 1 E= -507.966885933628  delta_E= -3.34  |g|= 0.451  |ddm|= 0.502
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.706097
diis-c [-0.4985728  1.       ]
  HOMO = -0.217776491427127  LUMO = 1.07813145379304
  mo_energy =
[-1.20197117e+02 -1.23046051e+01 -6.59430971e+00 -6.59430971e+00
 -6.59430971e+00 -1.16320556e+00 -2.17776491e-01 -2.17776491e-01
 -2.17776491e-01  1.07813145e+00  1.02431961e+01  5.52475577e+01
  2.10018997e+02  7.38335941e+02  2.88103514e+03  1.23462488e+04
  4.09583742e+04  1.04996949e+05  2.30177149e+05  4.55989798e+05
  8.44940335e+05  1.52811595e+06  2.85038132e+06  5.80826602e+06]
E1 = -706.804786943128  E_coul = 198.82033751617473
cycle= 2 E= -507.984449426953  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.432
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0295452
diis-c [-8.71377598e-04  1.75790358e-03  9.98242096e-01]
  HOMO = -0.239626427642386  LUMO = 1.0724089774734
  mo_energy =
[-1.20310214e+02 -1.23710869e+01 -6.66796070e+00 -6.66796070e+00
 -6.66796070e+00 -1.17726040e+00 -2.39626428e-01 -2.39626428e-01
 -2.39626428e-01  1.07240898e+00  1.01993654e+01  5.51701436e+01
  2.09919231e+02  7.38218845e+02  2.88090233e+03  1.23461057e+04
  4.09582273e+04  1.04996801e+05  2.30177000e+05  4.55989648e+05
  8.44940185e+05  1.52811580e+06  2.85038117e+06  5.80826587e+06]
E1 = -706.69876700982  E_coul = 198.7140626181862
cycle= 3 E= -507.984704391634  delta_E= -0.000255  |g|= 0.0044  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00323888
diis-c [-2.15972202e-06 -4.23658584e-05 -1.08415248e-01  1.10845761e+00]
  HOMO = -0.242790503989288  LUMO = 1.07134711483646
  mo_energy =
[-1.20322276e+02 -1.23797826e+01 -6.67716707e+00 -6.67716707e+00
 -6.67716707e+00 -1.17917681e+00 -2.42790504e-01 -2.42790504e-01
 -2.42790504e-01  1.07134711e+00  1.01931572e+01  5.51606961e+01
  2.09908091e+02  7.38206614e+02  2.88088925e+03  1.23460921e+04
  4.09582135e+04  1.04996787e+05  2.30176986e+05  4.55989634e+05
  8.44940171e+05  1.52811578e+06  2.85038116e+06  5.80826586e+06]
E1 = -706.683561360695  E_coul = 198.6988521313695
cycle= 4 E= -507.984709229325  delta_E= -4.84e-06  |g|= 0.000201  |ddm|= 0.00947
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000139612
diis-c [-1.39044646e-10 -7.61554302e-06  7.26783433e-03 -9.86684649e-02
  1.09140825e+00]
  HOMO = -0.242926632293967  LUMO = 1.07129426028752
  mo_energy =
[-1.20322615e+02 -1.23801110e+01 -6.67749253e+00 -6.67749253e+00
 -6.67749253e+00 -1.17925783e+00 -2.42926632e-01 -2.42926632e-01
 -2.42926632e-01  1.07129426e+00  1.01928998e+01  5.51603732e+01
  2.09907756e+02  7.38206275e+02  2.88088890e+03  1.23460917e+04
  4.09582131e+04  1.04996787e+05  2.30176985e+05  4.55989634e+05
  8.44940171e+05  1.52811578e+06  2.85038116e+06  5.80826586e+06]
E1 = -706.6829152229535  E_coul = 198.6982059840764
cycle= 5 E= -507.984709238877  delta_E= -9.55e-09  |g|= 1.15e-06  |ddm|= 0.000455
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.46428e-07
diis-c [-5.98385333e-14  2.03844001e-07 -1.47624832e-04  1.80822493e-03
 -2.15107280e-02  1.01984992e+00]
  HOMO = -0.24292731452818  LUMO = 1.07129415779478
  mo_energy =
[-1.20322617e+02 -1.23801126e+01 -6.67749424e+00 -6.67749424e+00
 -6.67749424e+00 -1.17925838e+00 -2.42927315e-01 -2.42927315e-01
 -2.42927315e-01  1.07129416e+00  1.01928986e+01  5.51603715e+01
  2.09907754e+02  7.38206272e+02  2.88088890e+03  1.23460917e+04
  4.09582131e+04  1.04996787e+05  2.30176985e+05  4.55989634e+05
  8.44940171e+05  1.52811578e+06  2.85038116e+06  5.80826586e+06]
E1 = -706.6829117029007  E_coul = 198.6982024640238
cycle= 6 E= -507.984709238877  delta_E= 2.27e-13  |g|= 3.45e-08  |ddm|= 2.55e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6829117029007  E_coul = 198.6982024640238
  HOMO = -0.242927331892187  LUMO = 1.07129414917515
  mo_energy =
[-1.20322618e+02 -1.23801126e+01 -6.67749428e+00 -6.67749428e+00
 -6.67749428e+00 -1.17925839e+00 -2.42927332e-01 -2.42927332e-01
 -2.42927332e-01  1.07129415e+00  1.01928985e+01  5.51603714e+01
  2.09907754e+02  7.38206272e+02  2.88088890e+03  1.23460917e+04
  4.09582131e+04  1.04996787e+05  2.30176985e+05  4.55989634e+05
  8.44940171e+05  1.52811578e+06  2.85038116e+06  5.80826586e+06]
E1 = -706.682911622134  E_coul = 198.6982023832571
Extra cycle  E= -507.984709238877  delta_E=    0  |g|= 3.73e-09  |ddm|= 6.65e-08
    CPU time for scf_cycle      1.08 sec, wall time      0.28 sec
exp = [2.49094376e-01 6.52851123e-01 1.17616814e+05 2.91634739e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547139e+04 7.30308799e+03 1.83757970e+04
 1.44916279e+03 3.75085117e+02 1.21116160e+02 4.71862225e+01
 2.14632636e+01 7.15455962e+00 8.60638171e+00 4.92740274e-01]
E = -507.9847092388769
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:13:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249094375716       1
[INPUT] 0    0    [1    /1   ]  0.652851123284       1
[INPUT] 0    0    [1    /1   ]  117616.81379         1
[INPUT] 0    0    [1    /1   ]  2.91634738756        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031062        1
[INPUT] 0    0    [1    /1   ]  147020.991872        1
[INPUT] 0    0    [1    /1   ]  73510.4198254        1
[INPUT] 0    0    [1    /1   ]  36754.7138802        1
[INPUT] 0    0    [1    /1   ]  7303.08799325        1
[INPUT] 0    0    [1    /1   ]  18375.7969545        1
[INPUT] 0    0    [1    /1   ]  1449.16279039        1
[INPUT] 0    0    [1    /1   ]  375.085117323        1
[INPUT] 0    0    [1    /1   ]  121.116159748        1
[INPUT] 0    0    [1    /1   ]  47.1862224764        1
[INPUT] 0    0    [1    /1   ]  21.4632636057        1
[INPUT] 0    0    [1    /1   ]  7.15455961656        1
[INPUT] 1    0    [1    /1   ]  8.60638171326        1
[INPUT] 1    0    [1    /1   ]  0.492740274296       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2490943757156488, 1.0]], [0, [0.6528511232837321, 1.0]], [0, [117616.81379002257, 1.0]], [0, [2.916347387557002, 1.0]], [0, [1176168.1426168615, 1.0]], [0, [588084.0699803825, 1.0]], [0, [294042.0310615917, 1.0]], [0, [147020.9918721246, 1.0]], [0, [73510.4198253505, 1.0]], [0, [36754.713880165174, 1.0]], [0, [7303.087993254981, 1.0]], [0, [18375.796954542682, 1.0]], [0, [1449.1627903902368, 1.0]], [0, [375.0851173233019, 1.0]], [0, [121.1161597480041, 1.0]], [0, [47.186222476410144, 1.0]], [0, [21.463263605743787, 1.0]], [0, [7.154559616564736, 1.0]], [1, [8.60638171325668, 1.0]], [1, [0.49274027429589806, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24909438]
bas 1, expnt(s) = [0.65285112]
bas 2, expnt(s) = [117616.81379002]
bas 3, expnt(s) = [2.91634739]
bas 4, expnt(s) = [1176168.14261686]
bas 5, expnt(s) = [588084.06998038]
bas 6, expnt(s) = [294042.03106159]
bas 7, expnt(s) = [147020.99187212]
bas 8, expnt(s) = [73510.41982535]
bas 9, expnt(s) = [36754.71388017]
bas 10, expnt(s) = [7303.08799325]
bas 11, expnt(s) = [18375.79695454]
bas 12, expnt(s) = [1449.16279039]
bas 13, expnt(s) = [375.08511732]
bas 14, expnt(s) = [121.11615975]
bas 15, expnt(s) = [47.18622248]
bas 16, expnt(s) = [21.46326361]
bas 17, expnt(s) = [7.15455962]
bas 18, expnt(s) = [8.60638171]
bas 19, expnt(s) = [0.49274027]
CPU time:       758.10
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49094376e-01 8.90815911e-01 6.52851123e-01 1.83495594e+00
 1.17616814e+05 1.60460109e+04 2.91634739e+00 5.63825177e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547139e+04 6.70655992e+03
 7.30308799e+03 1.99592825e+03 1.83757970e+04 3.98749050e+03
 1.44916279e+03 5.93407328e+02 3.75085117e+02 2.15333896e+02
 1.21116160e+02 9.22394263e+01 4.71862225e+01 4.54858623e+01
 2.14632636e+01 2.51934036e+01 7.15455962e+00 1.10522883e+01
 8.60638171e+00 4.30041282e+01 4.92740274e-01 1.20436179e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335913850709115
cond(S) = 909373.0992771754
E1 = -689.606844670823  E_coul = 184.97786906805098
init E= -504.628975602772
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672260516239139  LUMO = 0.690035633544386
  mo_energy =
[-1.21705737e+02 -1.33854794e+01 -7.62316739e+00 -7.62316739e+00
 -7.62316739e+00 -1.65730365e+00 -6.72260516e-01 -6.72260516e-01
 -6.72260516e-01  6.90035634e-01  9.40555832e+00  5.40235318e+01
  2.08586400e+02  7.36844794e+02  2.87960333e+03  1.23449261e+04
  4.09571184e+04  1.04995730e+05  2.30175954e+05  4.55988620e+05
  8.44939171e+05  1.52811480e+06  2.85038018e+06  5.80826489e+06]
E1 = -707.7471926341015  E_coul = 199.7803067004738
cycle= 1 E= -507.966885933628  delta_E= -3.34  |g|= 0.451  |ddm|= 0.502
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.706097
diis-c [-0.4985728  1.       ]
  HOMO = -0.217776491427127  LUMO = 1.07813145379304
  mo_energy =
[-1.20197117e+02 -1.23046051e+01 -6.59430971e+00 -6.59430971e+00
 -6.59430971e+00 -1.16320556e+00 -2.17776491e-01 -2.17776491e-01
 -2.17776491e-01  1.07813145e+00  1.02431961e+01  5.52475577e+01
  2.10018997e+02  7.38335941e+02  2.88103514e+03  1.23462488e+04
  4.09583742e+04  1.04996949e+05  2.30177149e+05  4.55989798e+05
  8.44940335e+05  1.52811595e+06  2.85038132e+06  5.80826602e+06]
E1 = -706.804786943128  E_coul = 198.82033751617473
cycle= 2 E= -507.984449426953  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.432
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0295452
diis-c [-8.71377598e-04  1.75790358e-03  9.98242096e-01]
  HOMO = -0.239626427642386  LUMO = 1.0724089774734
  mo_energy =
[-1.20310214e+02 -1.23710869e+01 -6.66796070e+00 -6.66796070e+00
 -6.66796070e+00 -1.17726040e+00 -2.39626428e-01 -2.39626428e-01
 -2.39626428e-01  1.07240898e+00  1.01993654e+01  5.51701436e+01
  2.09919231e+02  7.38218845e+02  2.88090233e+03  1.23461057e+04
  4.09582273e+04  1.04996801e+05  2.30177000e+05  4.55989648e+05
  8.44940185e+05  1.52811580e+06  2.85038117e+06  5.80826587e+06]
E1 = -706.69876700982  E_coul = 198.7140626181862
cycle= 3 E= -507.984704391634  delta_E= -0.000255  |g|= 0.0044  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00323888
diis-c [-2.15972202e-06 -4.23658584e-05 -1.08415248e-01  1.10845761e+00]
  HOMO = -0.242790503989288  LUMO = 1.07134711483646
  mo_energy =
[-1.20322276e+02 -1.23797826e+01 -6.67716707e+00 -6.67716707e+00
 -6.67716707e+00 -1.17917681e+00 -2.42790504e-01 -2.42790504e-01
 -2.42790504e-01  1.07134711e+00  1.01931572e+01  5.51606961e+01
  2.09908091e+02  7.38206614e+02  2.88088925e+03  1.23460921e+04
  4.09582135e+04  1.04996787e+05  2.30176986e+05  4.55989634e+05
  8.44940171e+05  1.52811578e+06  2.85038116e+06  5.80826586e+06]
E1 = -706.683561360695  E_coul = 198.6988521313695
cycle= 4 E= -507.984709229325  delta_E= -4.84e-06  |g|= 0.000201  |ddm|= 0.00947
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000139612
diis-c [-1.39044646e-10 -7.61554302e-06  7.26783433e-03 -9.86684649e-02
  1.09140825e+00]
  HOMO = -0.242926632293967  LUMO = 1.07129426028752
  mo_energy =
[-1.20322615e+02 -1.23801110e+01 -6.67749253e+00 -6.67749253e+00
 -6.67749253e+00 -1.17925783e+00 -2.42926632e-01 -2.42926632e-01
 -2.42926632e-01  1.07129426e+00  1.01928998e+01  5.51603732e+01
  2.09907756e+02  7.38206275e+02  2.88088890e+03  1.23460917e+04
  4.09582131e+04  1.04996787e+05  2.30176985e+05  4.55989634e+05
  8.44940171e+05  1.52811578e+06  2.85038116e+06  5.80826586e+06]
E1 = -706.6829152229535  E_coul = 198.6982059840764
cycle= 5 E= -507.984709238877  delta_E= -9.55e-09  |g|= 1.15e-06  |ddm|= 0.000455
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.46428e-07
diis-c [-5.98385333e-14  2.03844001e-07 -1.47624832e-04  1.80822493e-03
 -2.15107280e-02  1.01984992e+00]
  HOMO = -0.24292731452818  LUMO = 1.07129415779478
  mo_energy =
[-1.20322617e+02 -1.23801126e+01 -6.67749424e+00 -6.67749424e+00
 -6.67749424e+00 -1.17925838e+00 -2.42927315e-01 -2.42927315e-01
 -2.42927315e-01  1.07129416e+00  1.01928986e+01  5.51603715e+01
  2.09907754e+02  7.38206272e+02  2.88088890e+03  1.23460917e+04
  4.09582131e+04  1.04996787e+05  2.30176985e+05  4.55989634e+05
  8.44940171e+05  1.52811578e+06  2.85038116e+06  5.80826586e+06]
E1 = -706.6829117029007  E_coul = 198.6982024640238
cycle= 6 E= -507.984709238877  delta_E= 2.27e-13  |g|= 3.45e-08  |ddm|= 2.55e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6829117029007  E_coul = 198.6982024640238
  HOMO = -0.242927331892187  LUMO = 1.07129414917515
  mo_energy =
[-1.20322618e+02 -1.23801126e+01 -6.67749428e+00 -6.67749428e+00
 -6.67749428e+00 -1.17925839e+00 -2.42927332e-01 -2.42927332e-01
 -2.42927332e-01  1.07129415e+00  1.01928985e+01  5.51603714e+01
  2.09907754e+02  7.38206272e+02  2.88088890e+03  1.23460917e+04
  4.09582131e+04  1.04996787e+05  2.30176985e+05  4.55989634e+05
  8.44940171e+05  1.52811578e+06  2.85038116e+06  5.80826586e+06]
E1 = -706.682911622134  E_coul = 198.6982023832571
Extra cycle  E= -507.984709238877  delta_E=    0  |g|= 3.73e-09  |ddm|= 6.65e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909373.0992771754
E1 = -706.682911622134  E_coul = 198.6982023832571
init E= -507.984709238877
    CPU time for initialize scf      3.57 sec, wall time      0.23 sec
  HOMO = -0.242927334358462  LUMO = 1.07129414815913
  mo_energy =
[-1.20322618e+02 -1.23801127e+01 -6.67749429e+00 -6.67749429e+00
 -6.67749429e+00 -1.17925839e+00 -2.42927334e-01 -2.42927334e-01
 -2.42927334e-01  1.07129415e+00  1.01928985e+01  5.51603714e+01
  2.09907754e+02  7.38206272e+02  2.88088890e+03  1.23460917e+04
  4.09582131e+04  1.04996787e+05  2.30176985e+05  4.55989634e+05
  8.44940171e+05  1.52811578e+06  2.85038116e+06  5.80826586e+06]
E1 = -706.6829116126538  E_coul = 198.6982023737766
cycle= 1 E= -507.984709238877  delta_E= -2.84e-13  |g|= 1.27e-09  |ddm|= 7.04e-09
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.6829116126538  E_coul = 198.6982023737766
  HOMO = -0.242927334648439  LUMO = 1.07129414712458
  mo_energy =
[-1.20322618e+02 -1.23801127e+01 -6.67749429e+00 -6.67749429e+00
 -6.67749429e+00 -1.17925839e+00 -2.42927335e-01 -2.42927335e-01
 -2.42927335e-01  1.07129415e+00  1.01928985e+01  5.51603714e+01
  2.09907754e+02  7.38206272e+02  2.88088890e+03  1.23460917e+04
  4.09582131e+04  1.04996787e+05  2.30176985e+05  4.55989634e+05
  8.44940171e+05  1.52811578e+06  2.85038116e+06  5.80826586e+06]
E1 = -706.6829116125856  E_coul = 198.69820237370857
Extra cycle  E= -507.984709238877  delta_E= 1.71e-13  |g|= 9.8e-10  |ddm|= 9.43e-11
    CPU time for scf_cycle      4.01 sec, wall time      0.39 sec
exp = [2.49094376e-01 6.52851123e-01 1.17616814e+05 2.91634739e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547139e+04 7.30308799e+03 1.83757970e+04
 1.44916279e+03 3.75085117e+02 1.21116160e+02 4.71862225e+01
 2.14632636e+01 7.15455962e+00 8.60638171e+00 4.92740274e-01]
grad_E = [ 1.32191398e-03 -1.70613105e-04  3.82590530e-09 -8.24710122e-04
  1.45102207e-11  1.01212778e-10  5.95492063e-10  2.33162293e-09
  9.67360552e-09  5.24481164e-08  3.25994409e-06  1.08776368e-07
  2.29733336e-05 -1.59130823e-04 -2.03154186e-04 -2.30494382e-05
  1.77900183e-04  3.30715361e-04  1.83750406e-03 -1.28118443e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:13:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249017776094       1
[INPUT] 0    0    [1    /1   ]  0.653652652228       1
[INPUT] 0    0    [1    /1   ]  117616.813792        1
[INPUT] 0    0    [1    /1   ]  2.89827170082        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031062        1
[INPUT] 0    0    [1    /1   ]  147020.991873        1
[INPUT] 0    0    [1    /1   ]  73510.4198302        1
[INPUT] 0    0    [1    /1   ]  36754.7139062        1
[INPUT] 0    0    [1    /1   ]  7303.08964133        1
[INPUT] 0    0    [1    /1   ]  18375.7970118        1
[INPUT] 0    0    [1    /1   ]  1449.16101683        1
[INPUT] 0    0    [1    /1   ]  375.114432157        1
[INPUT] 0    0    [1    /1   ]  120.972486154        1
[INPUT] 0    0    [1    /1   ]  46.9182388988        1
[INPUT] 0    0    [1    /1   ]  21.1472709072        1
[INPUT] 0    0    [1    /1   ]  7.05579180431        1
[INPUT] 1    0    [1    /1   ]  8.6038759677         1
[INPUT] 1    0    [1    /1   ]  0.492709928318       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24901777609361223, 1.0]], [0, [0.6536526522278376, 1.0]], [0, [117616.81379194149, 1.0]], [0, [2.8982717008213577, 1.0]], [0, [1176168.1426168708, 1.0]], [0, [588084.0699804347, 1.0]], [0, [294042.0310618902, 1.0]], [0, [147020.99187329627, 1.0]], [0, [73510.41983022205, 1.0]], [0, [36754.713906246834, 1.0]], [0, [7303.089641333012, 1.0]], [0, [18375.79701183006, 1.0]], [0, [1449.1610168344773, 1.0]], [0, [375.11443215712893, 1.0]], [0, [120.97248615400609, 1.0]], [0, [46.91823889879564, 1.0]], [0, [21.147270907246114, 1.0]], [0, [7.055791804313483, 1.0]], [1, [8.60387596769654, 1.0]], [1, [0.4927099283177299, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24901778]
bas 1, expnt(s) = [0.65365265]
bas 2, expnt(s) = [117616.81379194]
bas 3, expnt(s) = [2.8982717]
bas 4, expnt(s) = [1176168.14261687]
bas 5, expnt(s) = [588084.06998043]
bas 6, expnt(s) = [294042.03106189]
bas 7, expnt(s) = [147020.9918733]
bas 8, expnt(s) = [73510.41983022]
bas 9, expnt(s) = [36754.71390625]
bas 10, expnt(s) = [7303.08964133]
bas 11, expnt(s) = [18375.79701183]
bas 12, expnt(s) = [1449.16101683]
bas 13, expnt(s) = [375.11443216]
bas 14, expnt(s) = [120.97248615]
bas 15, expnt(s) = [46.9182389]
bas 16, expnt(s) = [21.14727091]
bas 17, expnt(s) = [7.0557918]
bas 18, expnt(s) = [8.60387597]
bas 19, expnt(s) = [0.49270993]
CPU time:       769.86
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49017776e-01 8.90610451e-01 6.53652652e-01 1.83664531e+00
 1.17616814e+05 1.60460109e+04 2.89827170e+00 5.61202176e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791586e+04 3.67547139e+04 6.70655992e+03
 7.30308964e+03 1.99592858e+03 1.83757970e+04 3.98749051e+03
 1.44916102e+03 5.93406783e+02 3.75114432e+02 2.15346518e+02
 1.20972486e+02 9.21573502e+01 4.69182389e+01 4.52919794e+01
 2.11472709e+01 2.49147062e+01 7.05579180e+00 1.09376581e+01
 8.60387597e+00 4.29884780e+01 4.92709928e-01 1.20426908e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335967164605897
cond(S) = 909335.7928091355
E1 = -689.5942908593507  E_coul = 184.96596712789744
init E= -504.628323731453
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672256298194341  LUMO = 0.690030281591659
  mo_energy =
[-1.21708175e+02 -1.33864120e+01 -7.62400216e+00 -7.62400216e+00
 -7.62400216e+00 -1.65739949e+00 -6.72256298e-01 -6.72256298e-01
 -6.72256298e-01  6.90030282e-01  9.28686841e+00  5.31817706e+01
  2.06499513e+02  7.33884563e+02  2.87661035e+03  1.23422472e+04
  4.09546307e+04  1.04993344e+05  2.30173635e+05  4.55986349e+05
  8.44936937e+05  1.52811260e+06  2.85037803e+06  5.80826279e+06]
E1 = -707.7349356052059  E_coul = 199.76803731575893
cycle= 1 E= -507.966898289447  delta_E= -3.34  |g|= 0.451  |ddm|= 0.502
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.70567
diis-c [-0.49797054  1.        ]
  HOMO = -0.217835425808662  LUMO = 1.07788634210881
  mo_energy =
[-1.20199573e+02 -1.23055154e+01 -6.59513841e+00 -6.59513841e+00
 -6.59513841e+00 -1.16332235e+00 -2.17835426e-01 -2.17835426e-01
 -2.17835426e-01  1.07788634e+00  1.01200062e+01  5.44022437e+01
  2.07931310e+02  7.35375702e+02  2.87804215e+03  1.23435699e+04
  4.09558865e+04  1.04994563e+05  2.30174830e+05  4.55987527e+05
  8.44938101e+05  1.52811375e+06  2.85037917e+06  5.80826393e+06]
E1 = -706.7919116783062  E_coul = 198.80743825073483
cycle= 2 E= -507.984473427571  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.431
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0295725
diis-c [-8.73235500e-04  1.61125310e-03  9.98388747e-01]
  HOMO = -0.239699938004055  LUMO = 1.07217433207894
  mo_energy =
[-1.20312744e+02 -1.23720640e+01 -6.66885286e+00 -6.66885286e+00
 -6.66885286e+00 -1.17738832e+00 -2.39699938e-01 -2.39699938e-01
 -2.39699938e-01  1.07217433e+00  1.00764414e+01  5.43250757e+01
  2.07831574e+02  7.35258537e+02  2.87790925e+03  1.23434267e+04
  4.09557395e+04  1.04994415e+05  2.30174680e+05  4.55987377e+05
  8.44937951e+05  1.52811360e+06  2.85037902e+06  5.80826378e+06]
E1 = -706.685867061899  E_coul = 198.7011387972203
cycle= 3 E= -507.984728264679  delta_E= -0.000255  |g|= 0.0044  |ddm|= 0.0599
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00323895
diis-c [-2.16784263e-06 -3.56866292e-05 -1.08247051e-01  1.10828274e+00]
  HOMO = -0.242860225676348  LUMO = 1.07111545039518
  mo_energy =
[-1.20324790e+02 -1.23807508e+01 -6.67804902e+00 -6.67804902e+00
 -6.67804902e+00 -1.17930246e+00 -2.42860226e-01 -2.42860226e-01
 -2.42860226e-01  1.07111545e+00  1.00702754e+01  5.43156647e+01
  2.07820455e+02  7.35246323e+02  2.87789619e+03  1.23434131e+04
  4.09557258e+04  1.04994401e+05  2.30174666e+05  4.55987363e+05
  8.44937937e+05  1.52811359e+06  2.85037900e+06  5.80826376e+06]
E1 = -706.6706868375596  E_coul = 198.68595375097942
cycle= 4 E= -507.98473308658  delta_E= -4.82e-06  |g|= 0.000201  |ddm|= 0.00944
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000139704
diis-c [-1.41075872e-10 -7.66654922e-06  7.23920279e-03 -9.85108258e-02
  1.09127929e+00]
  HOMO = -0.242996269695213  LUMO = 1.07106268728022
  mo_energy =
[-1.20325129e+02 -1.23810788e+01 -6.67837409e+00 -6.67837409e+00
 -6.67837409e+00 -1.17938346e+00 -2.42996270e-01 -2.42996270e-01
 -2.42996270e-01  1.07106269e+00  1.00700195e+01  5.43153425e+01
  2.07820120e+02  7.35245984e+02  2.87789585e+03  1.23434128e+04
  4.09557254e+04  1.04994401e+05  2.30174666e+05  4.55987363e+05
  8.44937937e+05  1.52811359e+06  2.85037900e+06  5.80826376e+06]
E1 = -706.6700415066632  E_coul = 198.68530841053422
cycle= 5 E= -507.984733096129  delta_E= -9.55e-09  |g|= 1.19e-06  |ddm|= 0.000455
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.67406e-07
diis-c [-6.63365613e-14  2.20546406e-07 -1.55367751e-04  1.91479443e-03
 -2.27819440e-02  1.02102230e+00]
  HOMO = -0.242996976774442  LUMO = 1.07106257310891
  mo_energy =
[-1.20325131e+02 -1.23810805e+01 -6.67837584e+00 -6.67837584e+00
 -6.67837584e+00 -1.17938403e+00 -2.42996977e-01 -2.42996977e-01
 -2.42996977e-01  1.07106257e+00  1.00700181e+01  5.43153407e+01
  2.07820118e+02  7.35245981e+02  2.87789585e+03  1.23434128e+04
  4.09557254e+04  1.04994400e+05  2.30174666e+05  4.55987363e+05
  8.44937937e+05  1.52811359e+06  2.85037900e+06  5.80826376e+06]
E1 = -706.6700378745642  E_coul = 198.68530477843535
cycle= 6 E= -507.984733096129  delta_E= 1.71e-13  |g|= 3.68e-08  |ddm|= 2.66e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6700378745642  E_coul = 198.68530477843535
  HOMO = -0.242996994946477  LUMO = 1.07106256305368
  mo_energy =
[-1.20325131e+02 -1.23810805e+01 -6.67837588e+00 -6.67837588e+00
 -6.67837588e+00 -1.17938404e+00 -2.42996995e-01 -2.42996995e-01
 -2.42996995e-01  1.07106256e+00  1.00700181e+01  5.43153407e+01
  2.07820118e+02  7.35245981e+02  2.87789585e+03  1.23434128e+04
  4.09557254e+04  1.04994400e+05  2.30174666e+05  4.55987363e+05
  8.44937937e+05  1.52811359e+06  2.85037900e+06  5.80826376e+06]
E1 = -706.6700377926262  E_coul = 198.6853046964978
Extra cycle  E= -507.984733096128  delta_E= 4.55e-13  |g|= 5.08e-09  |ddm|= 6.82e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.49017776e-01 6.53652652e-01 1.17616814e+05 2.89827170e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547139e+04 7.30308964e+03 1.83757970e+04
 1.44916102e+03 3.75114432e+02 1.20972486e+02 4.69182389e+01
 2.11472709e+01 7.05579180e+00 8.60387597e+00 4.92709928e-01]
E = -507.98473309612837
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:13:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249017776094       1
[INPUT] 0    0    [1    /1   ]  0.653652652228       1
[INPUT] 0    0    [1    /1   ]  117616.813792        1
[INPUT] 0    0    [1    /1   ]  2.89827170082        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031062        1
[INPUT] 0    0    [1    /1   ]  147020.991873        1
[INPUT] 0    0    [1    /1   ]  73510.4198302        1
[INPUT] 0    0    [1    /1   ]  36754.7139062        1
[INPUT] 0    0    [1    /1   ]  7303.08964133        1
[INPUT] 0    0    [1    /1   ]  18375.7970118        1
[INPUT] 0    0    [1    /1   ]  1449.16101683        1
[INPUT] 0    0    [1    /1   ]  375.114432157        1
[INPUT] 0    0    [1    /1   ]  120.972486154        1
[INPUT] 0    0    [1    /1   ]  46.9182388988        1
[INPUT] 0    0    [1    /1   ]  21.1472709072        1
[INPUT] 0    0    [1    /1   ]  7.05579180431        1
[INPUT] 1    0    [1    /1   ]  8.6038759677         1
[INPUT] 1    0    [1    /1   ]  0.492709928318       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24901777609361223, 1.0]], [0, [0.6536526522278376, 1.0]], [0, [117616.81379194149, 1.0]], [0, [2.8982717008213577, 1.0]], [0, [1176168.1426168708, 1.0]], [0, [588084.0699804347, 1.0]], [0, [294042.0310618902, 1.0]], [0, [147020.99187329627, 1.0]], [0, [73510.41983022205, 1.0]], [0, [36754.713906246834, 1.0]], [0, [7303.089641333012, 1.0]], [0, [18375.79701183006, 1.0]], [0, [1449.1610168344773, 1.0]], [0, [375.11443215712893, 1.0]], [0, [120.97248615400609, 1.0]], [0, [46.91823889879564, 1.0]], [0, [21.147270907246114, 1.0]], [0, [7.055791804313483, 1.0]], [1, [8.60387596769654, 1.0]], [1, [0.4927099283177299, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24901778]
bas 1, expnt(s) = [0.65365265]
bas 2, expnt(s) = [117616.81379194]
bas 3, expnt(s) = [2.8982717]
bas 4, expnt(s) = [1176168.14261687]
bas 5, expnt(s) = [588084.06998043]
bas 6, expnt(s) = [294042.03106189]
bas 7, expnt(s) = [147020.9918733]
bas 8, expnt(s) = [73510.41983022]
bas 9, expnt(s) = [36754.71390625]
bas 10, expnt(s) = [7303.08964133]
bas 11, expnt(s) = [18375.79701183]
bas 12, expnt(s) = [1449.16101683]
bas 13, expnt(s) = [375.11443216]
bas 14, expnt(s) = [120.97248615]
bas 15, expnt(s) = [46.9182389]
bas 16, expnt(s) = [21.14727091]
bas 17, expnt(s) = [7.0557918]
bas 18, expnt(s) = [8.60387597]
bas 19, expnt(s) = [0.49270993]
CPU time:       771.37
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49017776e-01 8.90610451e-01 6.53652652e-01 1.83664531e+00
 1.17616814e+05 1.60460109e+04 2.89827170e+00 5.61202176e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791586e+04 3.67547139e+04 6.70655992e+03
 7.30308964e+03 1.99592858e+03 1.83757970e+04 3.98749051e+03
 1.44916102e+03 5.93406783e+02 3.75114432e+02 2.15346518e+02
 1.20972486e+02 9.21573502e+01 4.69182389e+01 4.52919794e+01
 2.11472709e+01 2.49147062e+01 7.05579180e+00 1.09376581e+01
 8.60387597e+00 4.29884780e+01 4.92709928e-01 1.20426908e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335967164605897
cond(S) = 909335.7928091355
E1 = -689.5942908593507  E_coul = 184.96596712789744
init E= -504.628323731453
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672256298194341  LUMO = 0.690030281591659
  mo_energy =
[-1.21708175e+02 -1.33864120e+01 -7.62400216e+00 -7.62400216e+00
 -7.62400216e+00 -1.65739949e+00 -6.72256298e-01 -6.72256298e-01
 -6.72256298e-01  6.90030282e-01  9.28686841e+00  5.31817706e+01
  2.06499513e+02  7.33884563e+02  2.87661035e+03  1.23422472e+04
  4.09546307e+04  1.04993344e+05  2.30173635e+05  4.55986349e+05
  8.44936937e+05  1.52811260e+06  2.85037803e+06  5.80826279e+06]
E1 = -707.7349356052059  E_coul = 199.76803731575893
cycle= 1 E= -507.966898289447  delta_E= -3.34  |g|= 0.451  |ddm|= 0.502
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.70567
diis-c [-0.49797054  1.        ]
  HOMO = -0.217835425808662  LUMO = 1.07788634210881
  mo_energy =
[-1.20199573e+02 -1.23055154e+01 -6.59513841e+00 -6.59513841e+00
 -6.59513841e+00 -1.16332235e+00 -2.17835426e-01 -2.17835426e-01
 -2.17835426e-01  1.07788634e+00  1.01200062e+01  5.44022437e+01
  2.07931310e+02  7.35375702e+02  2.87804215e+03  1.23435699e+04
  4.09558865e+04  1.04994563e+05  2.30174830e+05  4.55987527e+05
  8.44938101e+05  1.52811375e+06  2.85037917e+06  5.80826393e+06]
E1 = -706.7919116783062  E_coul = 198.80743825073483
cycle= 2 E= -507.984473427571  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.431
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0295725
diis-c [-8.73235500e-04  1.61125310e-03  9.98388747e-01]
  HOMO = -0.239699938004055  LUMO = 1.07217433207894
  mo_energy =
[-1.20312744e+02 -1.23720640e+01 -6.66885286e+00 -6.66885286e+00
 -6.66885286e+00 -1.17738832e+00 -2.39699938e-01 -2.39699938e-01
 -2.39699938e-01  1.07217433e+00  1.00764414e+01  5.43250757e+01
  2.07831574e+02  7.35258537e+02  2.87790925e+03  1.23434267e+04
  4.09557395e+04  1.04994415e+05  2.30174680e+05  4.55987377e+05
  8.44937951e+05  1.52811360e+06  2.85037902e+06  5.80826378e+06]
E1 = -706.685867061899  E_coul = 198.7011387972203
cycle= 3 E= -507.984728264679  delta_E= -0.000255  |g|= 0.0044  |ddm|= 0.0599
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00323895
diis-c [-2.16784263e-06 -3.56866292e-05 -1.08247051e-01  1.10828274e+00]
  HOMO = -0.242860225676348  LUMO = 1.07111545039518
  mo_energy =
[-1.20324790e+02 -1.23807508e+01 -6.67804902e+00 -6.67804902e+00
 -6.67804902e+00 -1.17930246e+00 -2.42860226e-01 -2.42860226e-01
 -2.42860226e-01  1.07111545e+00  1.00702754e+01  5.43156647e+01
  2.07820455e+02  7.35246323e+02  2.87789619e+03  1.23434131e+04
  4.09557258e+04  1.04994401e+05  2.30174666e+05  4.55987363e+05
  8.44937937e+05  1.52811359e+06  2.85037900e+06  5.80826376e+06]
E1 = -706.6706868375596  E_coul = 198.68595375097942
cycle= 4 E= -507.98473308658  delta_E= -4.82e-06  |g|= 0.000201  |ddm|= 0.00944
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000139704
diis-c [-1.41075872e-10 -7.66654922e-06  7.23920279e-03 -9.85108258e-02
  1.09127929e+00]
  HOMO = -0.242996269695213  LUMO = 1.07106268728022
  mo_energy =
[-1.20325129e+02 -1.23810788e+01 -6.67837409e+00 -6.67837409e+00
 -6.67837409e+00 -1.17938346e+00 -2.42996270e-01 -2.42996270e-01
 -2.42996270e-01  1.07106269e+00  1.00700195e+01  5.43153425e+01
  2.07820120e+02  7.35245984e+02  2.87789585e+03  1.23434128e+04
  4.09557254e+04  1.04994401e+05  2.30174666e+05  4.55987363e+05
  8.44937937e+05  1.52811359e+06  2.85037900e+06  5.80826376e+06]
E1 = -706.6700415066632  E_coul = 198.68530841053422
cycle= 5 E= -507.984733096129  delta_E= -9.55e-09  |g|= 1.19e-06  |ddm|= 0.000455
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.67406e-07
diis-c [-6.63365613e-14  2.20546406e-07 -1.55367751e-04  1.91479443e-03
 -2.27819440e-02  1.02102230e+00]
  HOMO = -0.242996976774442  LUMO = 1.07106257310891
  mo_energy =
[-1.20325131e+02 -1.23810805e+01 -6.67837584e+00 -6.67837584e+00
 -6.67837584e+00 -1.17938403e+00 -2.42996977e-01 -2.42996977e-01
 -2.42996977e-01  1.07106257e+00  1.00700181e+01  5.43153407e+01
  2.07820118e+02  7.35245981e+02  2.87789585e+03  1.23434128e+04
  4.09557254e+04  1.04994400e+05  2.30174666e+05  4.55987363e+05
  8.44937937e+05  1.52811359e+06  2.85037900e+06  5.80826376e+06]
E1 = -706.6700378745642  E_coul = 198.68530477843535
cycle= 6 E= -507.984733096129  delta_E= 1.71e-13  |g|= 3.68e-08  |ddm|= 2.66e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6700378745642  E_coul = 198.68530477843535
  HOMO = -0.242996994946477  LUMO = 1.07106256305368
  mo_energy =
[-1.20325131e+02 -1.23810805e+01 -6.67837588e+00 -6.67837588e+00
 -6.67837588e+00 -1.17938404e+00 -2.42996995e-01 -2.42996995e-01
 -2.42996995e-01  1.07106256e+00  1.00700181e+01  5.43153407e+01
  2.07820118e+02  7.35245981e+02  2.87789585e+03  1.23434128e+04
  4.09557254e+04  1.04994400e+05  2.30174666e+05  4.55987363e+05
  8.44937937e+05  1.52811359e+06  2.85037900e+06  5.80826376e+06]
E1 = -706.6700377926262  E_coul = 198.6853046964978
Extra cycle  E= -507.984733096128  delta_E= 4.55e-13  |g|= 5.08e-09  |ddm|= 6.82e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909335.7928091355
E1 = -706.6700377926262  E_coul = 198.6853046964978
init E= -507.984733096128
    CPU time for initialize scf      3.59 sec, wall time      0.23 sec
  HOMO = -0.242996997460864  LUMO = 1.07106256195955
  mo_energy =
[-1.20325131e+02 -1.23810805e+01 -6.67837589e+00 -6.67837589e+00
 -6.67837589e+00 -1.17938404e+00 -2.42996997e-01 -2.42996997e-01
 -2.42996997e-01  1.07106256e+00  1.00700181e+01  5.43153406e+01
  2.07820118e+02  7.35245981e+02  2.87789585e+03  1.23434128e+04
  4.09557254e+04  1.04994400e+05  2.30174666e+05  4.55987363e+05
  8.44937937e+05  1.52811359e+06  2.85037900e+06  5.80826376e+06]
E1 = -706.6700377778457  E_coul = 198.6853046817171
cycle= 1 E= -507.984733096129  delta_E= -2.27e-13  |g|= 1.31e-09  |ddm|= 1.03e-08
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.6700377778457  E_coul = 198.6853046817171
  HOMO = -0.242996997875903  LUMO = 1.07106256223259
  mo_energy =
[-1.20325131e+02 -1.23810805e+01 -6.67837589e+00 -6.67837589e+00
 -6.67837589e+00 -1.17938404e+00 -2.42996998e-01 -2.42996998e-01
 -2.42996998e-01  1.07106256e+00  1.00700181e+01  5.43153406e+01
  2.07820118e+02  7.35245981e+02  2.87789585e+03  1.23434128e+04
  4.09557254e+04  1.04994400e+05  2.30174666e+05  4.55987363e+05
  8.44937937e+05  1.52811359e+06  2.85037900e+06  5.80826376e+06]
E1 = -706.6700377751189  E_coul = 198.6853046789901
Extra cycle  E= -507.984733096129  delta_E= -2.27e-13  |g|= 1.14e-09  |ddm|= 1.81e-09
    CPU time for scf_cycle      4.03 sec, wall time      0.40 sec
exp = [2.49017776e-01 6.53652652e-01 1.17616814e+05 2.89827170e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547139e+04 7.30308964e+03 1.83757970e+04
 1.44916102e+03 3.75114432e+02 1.20972486e+02 4.69182389e+01
 2.11472709e+01 7.05579180e+00 8.60387597e+00 4.92709928e-01]
grad_E = [ 4.74886338e-05  2.74258298e-04  3.83824972e-09  5.28074319e-04
  1.46584948e-11  1.01612607e-10  5.97406790e-10  2.33924832e-09
  9.70572021e-09  5.26070963e-08  3.27130960e-06  1.09252179e-07
  2.23787726e-05 -1.53707518e-04 -2.19696547e-04  1.35798175e-05
  1.58572515e-04 -3.66667043e-04 -2.04938070e-04  3.04260445e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:13:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248653256128       1
[INPUT] 0    0    [1    /1   ]  0.653328973862       1
[INPUT] 0    0    [1    /1   ]  117616.813795        1
[INPUT] 0    0    [1    /1   ]  2.88785945445        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031062        1
[INPUT] 0    0    [1    /1   ]  147020.991875        1
[INPUT] 0    0    [1    /1   ]  73510.4198381        1
[INPUT] 0    0    [1    /1   ]  36754.7139485        1
[INPUT] 0    0    [1    /1   ]  7303.09230941        1
[INPUT] 0    0    [1    /1   ]  18375.7971046        1
[INPUT] 0    0    [1    /1   ]  1449.15801683        1
[INPUT] 0    0    [1    /1   ]  375.164610446        1
[INPUT] 0    0    [1    /1   ]  120.719724372        1
[INPUT] 0    0    [1    /1   ]  46.4680163461        1
[INPUT] 0    0    [1    /1   ]  20.6653814526        1
[INPUT] 0    0    [1    /1   ]  7.03592985389        1
[INPUT] 1    0    [1    /1   ]  8.60289961659        1
[INPUT] 1    0    [1    /1   ]  0.492693659331       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.248653256128026, 1.0]], [0, [0.6533289738622383, 1.0]], [0, [117616.81379504777, 1.0]], [0, [2.887859454446438, 1.0]], [0, [1176168.142616886, 1.0]], [0, [588084.0699805195, 1.0]], [0, [294042.0310623733, 1.0]], [0, [147020.99187519294, 1.0]], [0, [73510.4198381081, 1.0]], [0, [36754.71394846589, 1.0]], [0, [7303.092309408131, 1.0]], [0, [18375.7971045816, 1.0]], [0, [1449.1580168319756, 1.0]], [0, [375.1646104455028, 1.0]], [0, [120.71972437242658, 1.0]], [0, [46.46801634614873, 1.0]], [0, [20.66538145260258, 1.0]], [0, [7.035929853893472, 1.0]], [1, [8.602899616588061, 1.0]], [1, [0.4926936593311601, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24865326]
bas 1, expnt(s) = [0.65332897]
bas 2, expnt(s) = [117616.81379505]
bas 3, expnt(s) = [2.88785945]
bas 4, expnt(s) = [1176168.14261689]
bas 5, expnt(s) = [588084.06998052]
bas 6, expnt(s) = [294042.03106237]
bas 7, expnt(s) = [147020.99187519]
bas 8, expnt(s) = [73510.41983811]
bas 9, expnt(s) = [36754.71394847]
bas 10, expnt(s) = [7303.09230941]
bas 11, expnt(s) = [18375.79710458]
bas 12, expnt(s) = [1449.15801683]
bas 13, expnt(s) = [375.16461045]
bas 14, expnt(s) = [120.71972437]
bas 15, expnt(s) = [46.46801635]
bas 16, expnt(s) = [20.66538145]
bas 17, expnt(s) = [7.03592985]
bas 18, expnt(s) = [8.60289962]
bas 19, expnt(s) = [0.49269366]
CPU time:       783.27
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48653256e-01 8.89632494e-01 6.53328974e-01 1.83596316e+00
 1.17616814e+05 1.60460109e+04 2.88785945e+00 5.59689377e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791586e+04 3.67547139e+04 6.70655993e+03
 7.30309231e+03 1.99592913e+03 1.83757971e+04 3.98749053e+03
 1.44915802e+03 5.93405862e+02 3.75164610e+02 2.15368123e+02
 1.20719724e+02 9.20128962e+01 4.64680163e+01 4.49656240e+01
 2.06653815e+01 2.44876773e+01 7.03592985e+00 1.09145579e+01
 8.60289962e+00 4.29823802e+01 4.92693659e-01 1.20421937e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33599842268235
cond(S) = 909286.2427281659
E1 = -689.5896885884409  E_coul = 184.96121850500097
init E= -504.62847008344
    CPU time for initialize scf      0.42 sec, wall time      0.06 sec
  HOMO = -0.672262179236775  LUMO = 0.688125669805197
  mo_energy =
[-1.21709120e+02 -1.33868031e+01 -7.62433226e+00 -7.62433226e+00
 -7.62433226e+00 -1.65742449e+00 -6.72262179e-01 -6.72262179e-01
 -6.72262179e-01  6.88125670e-01  9.22541952e+00  5.23675068e+01
  2.03816398e+02  7.29718380e+02  2.87230129e+03  1.23383766e+04
  4.09510347e+04  1.04989895e+05  2.30170282e+05  4.55983067e+05
  8.44933708e+05  1.52810942e+06  2.85037491e+06  5.80825976e+06]
E1 = -707.7291034552683  E_coul = 199.76218140313398
cycle= 1 E= -507.966922052134  delta_E= -3.34  |g|= 0.451  |ddm|= 0.502
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.70521
diis-c [-0.4973216  1.       ]
  HOMO = -0.217877004449413  LUMO = 1.07552607377271
  mo_energy =
[-1.20200624e+02 -1.23059804e+01 -6.59555499e+00 -6.59555499e+00
 -6.59555499e+00 -1.16337243e+00 -2.17877004e-01 -2.17877004e-01
 -2.17877004e-01  1.07552607e+00  1.00559532e+01  5.35834585e+01
  2.05246758e+02  7.31209363e+02  2.87373298e+03  1.23396992e+04
  4.09522904e+04  1.04991114e+05  2.30171477e+05  4.55984244e+05
  8.44934872e+05  1.52811057e+06  2.85037606e+06  5.80826090e+06]
E1 = -706.7859658283043  E_coul = 198.80146690084317
cycle= 2 E= -507.984498927461  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.431
    CPU time for cycle= 2      0.10 sec, wall time      0.03 sec
diis-norm(errvec)=0.0296356
diis-c [-8.77328909e-04  1.37611482e-03  9.98623885e-01]
  HOMO = -0.23974767644999  LUMO = 1.06983408889458
  mo_energy =
[-1.20313835e+02 -1.23725543e+01 -6.66929704e+00 -6.66929704e+00
 -6.66929704e+00 -1.17744293e+00 -2.39747676e-01 -2.39747676e-01
 -2.39747676e-01  1.06983409e+00  1.00125526e+01  5.35066191e+01
  2.05147149e+02  7.31092169e+02  2.87360004e+03  1.23395560e+04
  4.09521434e+04  1.04990965e+05  2.30171327e+05  4.55984094e+05
  8.44934722e+05  1.52811042e+06  2.85037591e+06  5.80826075e+06]
E1 = -706.6798658926465  E_coul = 198.69511198584738
cycle= 3 E= -507.984753906799  delta_E= -0.000255  |g|= 0.00439  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324166
diis-c [-2.18618487e-06 -2.80181061e-05 -1.07983087e-01  1.10801111e+00]
  HOMO = -0.242903959666699  LUMO = 1.06877927922388
  mo_energy =
[-1.20325856e+02 -1.23812272e+01 -6.67847752e+00 -6.67847752e+00
 -6.67847752e+00 -1.17935456e+00 -2.42903960e-01 -2.42903960e-01
 -2.42903960e-01  1.06877928e+00  1.00064153e+01  5.34972541e+01
  2.05136063e+02  7.31079982e+02  2.87358701e+03  1.23395424e+04
  4.09521297e+04  1.04990952e+05  2.30171313e+05  4.55984080e+05
  8.44934708e+05  1.52811041e+06  2.85037589e+06  5.80826073e+06]
E1 = -706.6647018276065  E_coul = 198.6799431053585
cycle= 4 E= -507.984758722248  delta_E= -4.82e-06  |g|= 0.000201  |ddm|= 0.00944
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000140453
diis-c [-1.42375020e-10 -7.69058692e-06  7.21146010e-03 -9.85606045e-02
  1.09135684e+00]
  HOMO = -0.243040524365377  LUMO = 1.06872647095132
  mo_energy =
[-1.20326196e+02 -1.23815563e+01 -6.67880378e+00 -6.67880378e+00
 -6.67880378e+00 -1.17943591e+00 -2.43040524e-01 -2.43040524e-01
 -2.43040524e-01  1.06872647e+00  1.00061590e+01  5.34969310e+01
  2.05135727e+02  7.31079641e+02  2.87358666e+03  1.23395421e+04
  4.09521293e+04  1.04990951e+05  2.30171313e+05  4.55984080e+05
  8.44934708e+05  1.52811041e+06  2.85037589e+06  5.80826073e+06]
E1 = -706.6640538639864  E_coul = 198.67929513210368
cycle= 5 E= -507.984758731883  delta_E= -9.63e-09  |g|= 1.22e-06  |ddm|= 0.000458
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.78637e-07
diis-c [-7.11017064e-14  2.22139780e-07 -1.58914132e-04  1.97100493e-03
 -2.34263193e-02  1.02161401e+00]
  HOMO = -0.243041246412349  LUMO = 1.06872634963586
  mo_energy =
[-1.20326198e+02 -1.23815580e+01 -6.67880557e+00 -6.67880557e+00
 -6.67880557e+00 -1.17943648e+00 -2.43041246e-01 -2.43041246e-01
 -2.43041246e-01  1.06872635e+00  1.00061577e+01  5.34969291e+01
  2.05135725e+02  7.31079639e+02  2.87358666e+03  1.23395421e+04
  4.09521293e+04  1.04990951e+05  2.30171313e+05  4.55984080e+05
  8.44934708e+05  1.52811041e+06  2.85037589e+06  5.80826073e+06]
E1 = -706.6640501551682  E_coul = 198.67929142328572
cycle= 6 E= -507.984758731882  delta_E= 2.27e-13  |g|= 3.78e-08  |ddm|= 2.73e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6640501551682  E_coul = 198.67929142328572
  HOMO = -0.243041265373181  LUMO = 1.06872634057256
  mo_energy =
[-1.20326198e+02 -1.23815581e+01 -6.67880561e+00 -6.67880561e+00
 -6.67880561e+00 -1.17943649e+00 -2.43041265e-01 -2.43041265e-01
 -2.43041265e-01  1.06872634e+00  1.00061577e+01  5.34969291e+01
  2.05135725e+02  7.31079639e+02  2.87358666e+03  1.23395421e+04
  4.09521293e+04  1.04990951e+05  2.30171313e+05  4.55984080e+05
  8.44934708e+05  1.52811041e+06  2.85037589e+06  5.80826073e+06]
E1 = -706.6640500669887  E_coul = 198.6792913351061
Extra cycle  E= -507.984758731883  delta_E= -1.14e-13  |g|= 4.08e-09  |ddm|= 7.3e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.48653256e-01 6.53328974e-01 1.17616814e+05 2.88785945e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547139e+04 7.30309231e+03 1.83757971e+04
 1.44915802e+03 3.75164610e+02 1.20719724e+02 4.64680163e+01
 2.06653815e+01 7.03592985e+00 8.60289962e+00 4.92693659e-01]
E = -507.9847587318826
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:13:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248653256128       1
[INPUT] 0    0    [1    /1   ]  0.653328973862       1
[INPUT] 0    0    [1    /1   ]  117616.813795        1
[INPUT] 0    0    [1    /1   ]  2.88785945445        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031062        1
[INPUT] 0    0    [1    /1   ]  147020.991875        1
[INPUT] 0    0    [1    /1   ]  73510.4198381        1
[INPUT] 0    0    [1    /1   ]  36754.7139485        1
[INPUT] 0    0    [1    /1   ]  7303.09230941        1
[INPUT] 0    0    [1    /1   ]  18375.7971046        1
[INPUT] 0    0    [1    /1   ]  1449.15801683        1
[INPUT] 0    0    [1    /1   ]  375.164610446        1
[INPUT] 0    0    [1    /1   ]  120.719724372        1
[INPUT] 0    0    [1    /1   ]  46.4680163461        1
[INPUT] 0    0    [1    /1   ]  20.6653814526        1
[INPUT] 0    0    [1    /1   ]  7.03592985389        1
[INPUT] 1    0    [1    /1   ]  8.60289961659        1
[INPUT] 1    0    [1    /1   ]  0.492693659331       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.248653256128026, 1.0]], [0, [0.6533289738622383, 1.0]], [0, [117616.81379504777, 1.0]], [0, [2.887859454446438, 1.0]], [0, [1176168.142616886, 1.0]], [0, [588084.0699805195, 1.0]], [0, [294042.0310623733, 1.0]], [0, [147020.99187519294, 1.0]], [0, [73510.4198381081, 1.0]], [0, [36754.71394846589, 1.0]], [0, [7303.092309408131, 1.0]], [0, [18375.7971045816, 1.0]], [0, [1449.1580168319756, 1.0]], [0, [375.1646104455028, 1.0]], [0, [120.71972437242658, 1.0]], [0, [46.46801634614873, 1.0]], [0, [20.66538145260258, 1.0]], [0, [7.035929853893472, 1.0]], [1, [8.602899616588061, 1.0]], [1, [0.4926936593311601, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24865326]
bas 1, expnt(s) = [0.65332897]
bas 2, expnt(s) = [117616.81379505]
bas 3, expnt(s) = [2.88785945]
bas 4, expnt(s) = [1176168.14261689]
bas 5, expnt(s) = [588084.06998052]
bas 6, expnt(s) = [294042.03106237]
bas 7, expnt(s) = [147020.99187519]
bas 8, expnt(s) = [73510.41983811]
bas 9, expnt(s) = [36754.71394847]
bas 10, expnt(s) = [7303.09230941]
bas 11, expnt(s) = [18375.79710458]
bas 12, expnt(s) = [1449.15801683]
bas 13, expnt(s) = [375.16461045]
bas 14, expnt(s) = [120.71972437]
bas 15, expnt(s) = [46.46801635]
bas 16, expnt(s) = [20.66538145]
bas 17, expnt(s) = [7.03592985]
bas 18, expnt(s) = [8.60289962]
bas 19, expnt(s) = [0.49269366]
CPU time:       784.74
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48653256e-01 8.89632494e-01 6.53328974e-01 1.83596316e+00
 1.17616814e+05 1.60460109e+04 2.88785945e+00 5.59689377e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791586e+04 3.67547139e+04 6.70655993e+03
 7.30309231e+03 1.99592913e+03 1.83757971e+04 3.98749053e+03
 1.44915802e+03 5.93405862e+02 3.75164610e+02 2.15368123e+02
 1.20719724e+02 9.20128962e+01 4.64680163e+01 4.49656240e+01
 2.06653815e+01 2.44876773e+01 7.03592985e+00 1.09145579e+01
 8.60289962e+00 4.29823802e+01 4.92693659e-01 1.20421937e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33599842268235
cond(S) = 909286.2427281659
E1 = -689.5896885884409  E_coul = 184.96121850500097
init E= -504.62847008344
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672262179236775  LUMO = 0.688125669805197
  mo_energy =
[-1.21709120e+02 -1.33868031e+01 -7.62433226e+00 -7.62433226e+00
 -7.62433226e+00 -1.65742449e+00 -6.72262179e-01 -6.72262179e-01
 -6.72262179e-01  6.88125670e-01  9.22541952e+00  5.23675068e+01
  2.03816398e+02  7.29718380e+02  2.87230129e+03  1.23383766e+04
  4.09510347e+04  1.04989895e+05  2.30170282e+05  4.55983067e+05
  8.44933708e+05  1.52810942e+06  2.85037491e+06  5.80825976e+06]
E1 = -707.7291034552683  E_coul = 199.76218140313398
cycle= 1 E= -507.966922052134  delta_E= -3.34  |g|= 0.451  |ddm|= 0.502
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.70521
diis-c [-0.4973216  1.       ]
  HOMO = -0.217877004449413  LUMO = 1.07552607377271
  mo_energy =
[-1.20200624e+02 -1.23059804e+01 -6.59555499e+00 -6.59555499e+00
 -6.59555499e+00 -1.16337243e+00 -2.17877004e-01 -2.17877004e-01
 -2.17877004e-01  1.07552607e+00  1.00559532e+01  5.35834585e+01
  2.05246758e+02  7.31209363e+02  2.87373298e+03  1.23396992e+04
  4.09522904e+04  1.04991114e+05  2.30171477e+05  4.55984244e+05
  8.44934872e+05  1.52811057e+06  2.85037606e+06  5.80826090e+06]
E1 = -706.7859658283043  E_coul = 198.80146690084317
cycle= 2 E= -507.984498927461  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.431
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0296356
diis-c [-8.77328909e-04  1.37611482e-03  9.98623885e-01]
  HOMO = -0.23974767644999  LUMO = 1.06983408889458
  mo_energy =
[-1.20313835e+02 -1.23725543e+01 -6.66929704e+00 -6.66929704e+00
 -6.66929704e+00 -1.17744293e+00 -2.39747676e-01 -2.39747676e-01
 -2.39747676e-01  1.06983409e+00  1.00125526e+01  5.35066191e+01
  2.05147149e+02  7.31092169e+02  2.87360004e+03  1.23395560e+04
  4.09521434e+04  1.04990965e+05  2.30171327e+05  4.55984094e+05
  8.44934722e+05  1.52811042e+06  2.85037591e+06  5.80826075e+06]
E1 = -706.6798658926465  E_coul = 198.69511198584738
cycle= 3 E= -507.984753906799  delta_E= -0.000255  |g|= 0.00439  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324166
diis-c [-2.18618487e-06 -2.80181061e-05 -1.07983087e-01  1.10801111e+00]
  HOMO = -0.242903959666699  LUMO = 1.06877927922388
  mo_energy =
[-1.20325856e+02 -1.23812272e+01 -6.67847752e+00 -6.67847752e+00
 -6.67847752e+00 -1.17935456e+00 -2.42903960e-01 -2.42903960e-01
 -2.42903960e-01  1.06877928e+00  1.00064153e+01  5.34972541e+01
  2.05136063e+02  7.31079982e+02  2.87358701e+03  1.23395424e+04
  4.09521297e+04  1.04990952e+05  2.30171313e+05  4.55984080e+05
  8.44934708e+05  1.52811041e+06  2.85037589e+06  5.80826073e+06]
E1 = -706.6647018276065  E_coul = 198.6799431053585
cycle= 4 E= -507.984758722248  delta_E= -4.82e-06  |g|= 0.000201  |ddm|= 0.00944
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000140453
diis-c [-1.42375020e-10 -7.69058692e-06  7.21146010e-03 -9.85606045e-02
  1.09135684e+00]
  HOMO = -0.243040524365377  LUMO = 1.06872647095132
  mo_energy =
[-1.20326196e+02 -1.23815563e+01 -6.67880378e+00 -6.67880378e+00
 -6.67880378e+00 -1.17943591e+00 -2.43040524e-01 -2.43040524e-01
 -2.43040524e-01  1.06872647e+00  1.00061590e+01  5.34969310e+01
  2.05135727e+02  7.31079641e+02  2.87358666e+03  1.23395421e+04
  4.09521293e+04  1.04990951e+05  2.30171313e+05  4.55984080e+05
  8.44934708e+05  1.52811041e+06  2.85037589e+06  5.80826073e+06]
E1 = -706.6640538639864  E_coul = 198.67929513210368
cycle= 5 E= -507.984758731883  delta_E= -9.63e-09  |g|= 1.22e-06  |ddm|= 0.000458
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.78637e-07
diis-c [-7.11017064e-14  2.22139780e-07 -1.58914132e-04  1.97100493e-03
 -2.34263193e-02  1.02161401e+00]
  HOMO = -0.243041246412349  LUMO = 1.06872634963586
  mo_energy =
[-1.20326198e+02 -1.23815580e+01 -6.67880557e+00 -6.67880557e+00
 -6.67880557e+00 -1.17943648e+00 -2.43041246e-01 -2.43041246e-01
 -2.43041246e-01  1.06872635e+00  1.00061577e+01  5.34969291e+01
  2.05135725e+02  7.31079639e+02  2.87358666e+03  1.23395421e+04
  4.09521293e+04  1.04990951e+05  2.30171313e+05  4.55984080e+05
  8.44934708e+05  1.52811041e+06  2.85037589e+06  5.80826073e+06]
E1 = -706.6640501551682  E_coul = 198.67929142328572
cycle= 6 E= -507.984758731882  delta_E= 2.27e-13  |g|= 3.78e-08  |ddm|= 2.73e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6640501551682  E_coul = 198.67929142328572
  HOMO = -0.243041265373181  LUMO = 1.06872634057256
  mo_energy =
[-1.20326198e+02 -1.23815581e+01 -6.67880561e+00 -6.67880561e+00
 -6.67880561e+00 -1.17943649e+00 -2.43041265e-01 -2.43041265e-01
 -2.43041265e-01  1.06872634e+00  1.00061577e+01  5.34969291e+01
  2.05135725e+02  7.31079639e+02  2.87358666e+03  1.23395421e+04
  4.09521293e+04  1.04990951e+05  2.30171313e+05  4.55984080e+05
  8.44934708e+05  1.52811041e+06  2.85037589e+06  5.80826073e+06]
E1 = -706.6640500669887  E_coul = 198.6792913351061
Extra cycle  E= -507.984758731883  delta_E= -1.14e-13  |g|= 4.08e-09  |ddm|= 7.3e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909286.2427281659
E1 = -706.6640500669887  E_coul = 198.6792913351061
init E= -507.984758731883
    CPU time for initialize scf      3.57 sec, wall time      0.23 sec
  HOMO = -0.243041268070451  LUMO = 1.06872633845109
  mo_energy =
[-1.20326198e+02 -1.23815581e+01 -6.67880562e+00 -6.67880562e+00
 -6.67880562e+00 -1.17943649e+00 -2.43041268e-01 -2.43041268e-01
 -2.43041268e-01  1.06872634e+00  1.00061577e+01  5.34969291e+01
  2.05135725e+02  7.31079639e+02  2.87358666e+03  1.23395421e+04
  4.09521293e+04  1.04990951e+05  2.30171313e+05  4.55984080e+05
  8.44934708e+05  1.52811041e+06  2.85037589e+06  5.80826073e+06]
E1 = -706.6640500559956  E_coul = 198.6792913241132
cycle= 1 E= -507.984758731882  delta_E= 1.71e-13  |g|= 1.2e-09  |ddm|= 7.94e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6640500559956  E_coul = 198.6792913241132
  HOMO = -0.243041268393764  LUMO = 1.06872633929146
  mo_energy =
[-1.20326198e+02 -1.23815581e+01 -6.67880562e+00 -6.67880562e+00
 -6.67880562e+00 -1.17943649e+00 -2.43041268e-01 -2.43041268e-01
 -2.43041268e-01  1.06872634e+00  1.00061577e+01  5.34969291e+01
  2.05135725e+02  7.31079639e+02  2.87358666e+03  1.23395421e+04
  4.09521293e+04  1.04990951e+05  2.30171313e+05  4.55984080e+05
  8.44934708e+05  1.52811041e+06  2.85037589e+06  5.80826073e+06]
E1 = -706.6640500523948  E_coul = 198.6792913205119
Extra cycle  E= -507.984758731883  delta_E= -5.12e-13  |g|= 9.91e-10  |ddm|= 2.33e-09
    CPU time for scf_cycle      4.02 sec, wall time      0.39 sec
exp = [2.48653256e-01 6.53328974e-01 1.17616814e+05 2.88785945e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547139e+04 7.30309231e+03 1.83757971e+04
 1.44915802e+03 3.75164610e+02 1.20719724e+02 4.64680163e+01
 2.06653815e+01 7.03592985e+00 8.60289962e+00 4.92693659e-01]
grad_E = [-7.49273372e-05  2.91917334e-04  3.85198613e-09  1.38910511e-04
  1.48239095e-11  1.02057414e-10  5.99538228e-10  2.34773308e-09
  9.74144808e-09  5.27840176e-08  3.28386364e-06  1.09780569e-07
  2.17705215e-05 -1.50384416e-04 -2.12599757e-04 -2.31845070e-05
  1.60779667e-04 -1.74695772e-04 -1.01474160e-03  5.54612847e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:13:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248041990313       1
[INPUT] 0    0    [1    /1   ]  0.65275034011        1
[INPUT] 0    0    [1    /1   ]  117616.813799        1
[INPUT] 0    0    [1    /1   ]  2.86492192869        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031063        1
[INPUT] 0    0    [1    /1   ]  147020.991877        1
[INPUT] 0    0    [1    /1   ]  73510.4198473        1
[INPUT] 0    0    [1    /1   ]  36754.7139975        1
[INPUT] 0    0    [1    /1   ]  7303.09540504        1
[INPUT] 0    0    [1    /1   ]  18375.7972121        1
[INPUT] 0    0    [1    /1   ]  1449.15507863        1
[INPUT] 0    0    [1    /1   ]  375.214268933        1
[INPUT] 0    0    [1    /1   ]  120.484057294        1
[INPUT] 0    0    [1    /1   ]  45.8571017014        1
[INPUT] 0    0    [1    /1   ]  20.0502028848        1
[INPUT] 0    0    [1    /1   ]  6.98050974968        1
[INPUT] 1    0    [1    /1   ]  8.60287669143        1
[INPUT] 1    0    [1    /1   ]  0.49269501361        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24804199031302485, 1.0]], [0, [0.652750340110195, 1.0]], [0, [117616.81379865245, 1.0]], [0, [2.864921928691254, 1.0]], [0, [1176168.1426169034, 1.0]], [0, [588084.0699806177, 1.0]], [0, [294042.03106293397, 1.0]], [0, [147020.99187739383, 1.0]], [0, [73510.41984725874, 1.0]], [0, [36754.71399746697, 1.0]], [0, [7303.09540503793, 1.0]], [0, [18375.797212116908, 1.0]], [0, [1449.155078629025, 1.0]], [0, [375.2142689327894, 1.0]], [0, [120.4840572940525, 1.0]], [0, [45.85710170141879, 1.0]], [0, [20.050202884804335, 1.0]], [0, [6.980509749678293, 1.0]], [1, [8.602876691426284, 1.0]], [1, [0.49269501360992657, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24804199]
bas 1, expnt(s) = [0.65275034]
bas 2, expnt(s) = [117616.81379865]
bas 3, expnt(s) = [2.86492193]
bas 4, expnt(s) = [1176168.1426169]
bas 5, expnt(s) = [588084.06998062]
bas 6, expnt(s) = [294042.03106293]
bas 7, expnt(s) = [147020.99187739]
bas 8, expnt(s) = [73510.41984726]
bas 9, expnt(s) = [36754.71399747]
bas 10, expnt(s) = [7303.09540504]
bas 11, expnt(s) = [18375.79721212]
bas 12, expnt(s) = [1449.15507863]
bas 13, expnt(s) = [375.21426893]
bas 14, expnt(s) = [120.48405729]
bas 15, expnt(s) = [45.8571017]
bas 16, expnt(s) = [20.05020288]
bas 17, expnt(s) = [6.98050975]
bas 18, expnt(s) = [8.60287669]
bas 19, expnt(s) = [0.49269501]
CPU time:       796.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48041990e-01 8.87991748e-01 6.52750340e-01 1.83474349e+00
 1.17616814e+05 1.60460109e+04 2.86492193e+00 5.56351954e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791586e+04 3.67547140e+04 6.70655993e+03
 7.30309541e+03 1.99592977e+03 1.83757972e+04 3.98749055e+03
 1.44915508e+03 5.93404959e+02 3.75214269e+02 2.15389503e+02
 1.20484057e+02 9.18781437e+01 4.58571017e+01 4.45215193e+01
 2.00502029e+01 2.39388952e+01 6.98050975e+00 1.08500160e+01
 8.60287669e+00 4.29822371e+01 4.92695014e-01 1.20422351e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336007030556715
cond(S) = 909221.4807596665
E1 = -689.5902885480901  E_coul = 184.961255609083
init E= -504.629032939007
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672259164845515  LUMO = 0.684797715275339
  mo_energy =
[-1.21709107e+02 -1.33868233e+01 -7.62432939e+00 -7.62432939e+00
 -7.62432939e+00 -1.65741052e+00 -6.72259165e-01 -6.72259165e-01
 -6.72259165e-01  6.84797715e-01  9.10469798e+00  5.11821918e+01
  2.00188814e+02  7.24310749e+02  2.86680641e+03  1.23334557e+04
  4.09464648e+04  1.04985512e+05  2.30166022e+05  4.55978895e+05
  8.44929605e+05  1.52810538e+06  2.85037096e+06  5.80825591e+06]
E1 = -707.7285803420027  E_coul = 199.76165046343732
cycle= 1 E= -507.966929878565  delta_E= -3.34  |g|= 0.451  |ddm|= 0.501
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.704639
diis-c [-0.49651596  1.        ]
  HOMO = -0.217883404788857  LUMO = 1.07138408674203
  mo_energy =
[-1.20200679e+02 -1.23060451e+01 -6.59559978e+00 -6.59559978e+00
 -6.59559978e+00 -1.16337268e+00 -2.17883405e-01 -2.17883405e-01
 -2.17883405e-01  1.07138409e+00  9.93055451e+00  5.23919005e+01
  2.01617361e+02  7.25801611e+02  2.86823803e+03  1.23347782e+04
  4.09477205e+04  1.04986731e+05  2.30167216e+05  4.55980073e+05
  8.44930769e+05  1.52810654e+06  2.85037210e+06  5.80825705e+06]
E1 = -706.7850658483584  E_coul = 198.80055079291282
cycle= 2 E= -507.984515055446  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.43
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297321
diis-c [-8.83445420e-04  1.05500076e-03  9.98944999e-01]
  HOMO = -0.239766599314612  LUMO = 1.06573020566533
  mo_energy =
[-1.20313973e+02 -1.23726684e+01 -6.66939835e+00 -6.66939835e+00
 -6.66939835e+00 -1.17745073e+00 -2.39766599e-01 -2.39766599e-01
 -2.39766599e-01  1.06573021e+00  9.88745855e+00  5.23155093e+01
  2.01517891e+02  7.25684343e+02  2.86810498e+03  1.23346349e+04
  4.09475734e+04  1.04986582e+05  2.30167067e+05  4.55979923e+05
  8.44930619e+05  1.52810639e+06  2.85037195e+06  5.80825690e+06]
E1 = -706.6788696570719  E_coul = 198.69409934618105
cycle= 3 E= -507.984770310891  delta_E= -0.000255  |g|= 0.00439  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324749
diis-c [-2.21365451e-06 -1.76481376e-05 -1.07669412e-01  1.10768706e+00]
  HOMO = -0.242918370551065  LUMO = 1.06468229616364
  mo_energy =
[-1.20325963e+02 -1.23813241e+01 -6.67855952e+00 -6.67855952e+00
 -6.67855952e+00 -1.17935939e+00 -2.42918371e-01 -2.42918371e-01
 -2.42918371e-01  1.06468230e+00  9.88136955e+00  5.23062064e+01
  2.01506848e+02  7.25672189e+02  2.86809199e+03  1.23346214e+04
  4.09475597e+04  1.04986568e+05  2.30167053e+05  4.55979909e+05
  8.44930605e+05  1.52810637e+06  2.85037194e+06  5.80825688e+06]
E1 = -706.6637227006956  E_coul = 198.67894757936529
cycle= 4 E= -507.98477512133  delta_E= -4.81e-06  |g|= 0.000202  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141518
diis-c [-1.45344267e-10 -7.74448733e-06  7.17497988e-03 -9.86028332e-02
  1.09143560e+00]
  HOMO = -0.243055649926327  LUMO = 1.06462947502996
  mo_energy =
[-1.20326304e+02 -1.23816546e+01 -6.67888718e+00 -6.67888718e+00
 -6.67888718e+00 -1.17944120e+00 -2.43055650e-01 -2.43055650e-01
 -2.43055650e-01  1.06462948e+00  9.88111326e+00  5.23058824e+01
  2.01506511e+02  7.25671847e+02  2.86809164e+03  1.23346210e+04
  4.09475593e+04  1.04986568e+05  2.30167053e+05  4.55979909e+05
  8.44930605e+05  1.52810637e+06  2.85037194e+06  5.80825688e+06]
E1 = -706.6630711184524  E_coul = 198.67829598735656
cycle= 5 E= -507.984775131096  delta_E= -9.77e-09  |g|= 1.29e-06  |ddm|= 0.000462
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.05892e-07
diis-c [-8.00181514e-14  2.38945519e-07 -1.67193404e-04  2.09191519e-03
 -2.48286485e-02  1.02290369e+00]
  HOMO = -0.243056403395106  LUMO = 1.06462934163763
  mo_energy =
[-1.20326307e+02 -1.23816564e+01 -6.67888903e+00 -6.67888903e+00
 -6.67888903e+00 -1.17944180e+00 -2.43056403e-01 -2.43056403e-01
 -2.43056403e-01  1.06462934e+00  9.88111188e+00  5.23058805e+01
  2.01506509e+02  7.25671844e+02  2.86809164e+03  1.23346210e+04
  4.09475593e+04  1.04986568e+05  2.30167053e+05  4.55979909e+05
  8.44930605e+05  1.52810637e+06  2.85037194e+06  5.80825688e+06]
E1 = -706.663067257055  E_coul = 198.6782921259593
cycle= 6 E= -507.984775131096  delta_E= 1.14e-13  |g|= 4.03e-08  |ddm|= 2.87e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.663067257055  E_coul = 198.6782921259593
  HOMO = -0.243056423453628  LUMO = 1.0646293309892
  mo_energy =
[-1.20326307e+02 -1.23816564e+01 -6.67888907e+00 -6.67888907e+00
 -6.67888907e+00 -1.17944181e+00 -2.43056423e-01 -2.43056423e-01
 -2.43056423e-01  1.06462933e+00  9.88111184e+00  5.23058805e+01
  2.01506508e+02  7.25671844e+02  2.86809164e+03  1.23346210e+04
  4.09475593e+04  1.04986568e+05  2.30167053e+05  4.55979909e+05
  8.44930605e+05  1.52810637e+06  2.85037194e+06  5.80825688e+06]
E1 = -706.6630671656234  E_coul = 198.67829203452757
Extra cycle  E= -507.984775131096  delta_E= -1.14e-13  |g|= 4.99e-09  |ddm|= 7.62e-08
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
exp = [2.48041990e-01 6.52750340e-01 1.17616814e+05 2.86492193e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547140e+04 7.30309541e+03 1.83757972e+04
 1.44915508e+03 3.75214269e+02 1.20484057e+02 4.58571017e+01
 2.00502029e+01 6.98050975e+00 8.60287669e+00 4.92695014e-01]
E = -507.98477513109583
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:13:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248041990313       1
[INPUT] 0    0    [1    /1   ]  0.65275034011        1
[INPUT] 0    0    [1    /1   ]  117616.813799        1
[INPUT] 0    0    [1    /1   ]  2.86492192869        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031063        1
[INPUT] 0    0    [1    /1   ]  147020.991877        1
[INPUT] 0    0    [1    /1   ]  73510.4198473        1
[INPUT] 0    0    [1    /1   ]  36754.7139975        1
[INPUT] 0    0    [1    /1   ]  7303.09540504        1
[INPUT] 0    0    [1    /1   ]  18375.7972121        1
[INPUT] 0    0    [1    /1   ]  1449.15507863        1
[INPUT] 0    0    [1    /1   ]  375.214268933        1
[INPUT] 0    0    [1    /1   ]  120.484057294        1
[INPUT] 0    0    [1    /1   ]  45.8571017014        1
[INPUT] 0    0    [1    /1   ]  20.0502028848        1
[INPUT] 0    0    [1    /1   ]  6.98050974968        1
[INPUT] 1    0    [1    /1   ]  8.60287669143        1
[INPUT] 1    0    [1    /1   ]  0.49269501361        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24804199031302485, 1.0]], [0, [0.652750340110195, 1.0]], [0, [117616.81379865245, 1.0]], [0, [2.864921928691254, 1.0]], [0, [1176168.1426169034, 1.0]], [0, [588084.0699806177, 1.0]], [0, [294042.03106293397, 1.0]], [0, [147020.99187739383, 1.0]], [0, [73510.41984725874, 1.0]], [0, [36754.71399746697, 1.0]], [0, [7303.09540503793, 1.0]], [0, [18375.797212116908, 1.0]], [0, [1449.155078629025, 1.0]], [0, [375.2142689327894, 1.0]], [0, [120.4840572940525, 1.0]], [0, [45.85710170141879, 1.0]], [0, [20.050202884804335, 1.0]], [0, [6.980509749678293, 1.0]], [1, [8.602876691426284, 1.0]], [1, [0.49269501360992657, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24804199]
bas 1, expnt(s) = [0.65275034]
bas 2, expnt(s) = [117616.81379865]
bas 3, expnt(s) = [2.86492193]
bas 4, expnt(s) = [1176168.1426169]
bas 5, expnt(s) = [588084.06998062]
bas 6, expnt(s) = [294042.03106293]
bas 7, expnt(s) = [147020.99187739]
bas 8, expnt(s) = [73510.41984726]
bas 9, expnt(s) = [36754.71399747]
bas 10, expnt(s) = [7303.09540504]
bas 11, expnt(s) = [18375.79721212]
bas 12, expnt(s) = [1449.15507863]
bas 13, expnt(s) = [375.21426893]
bas 14, expnt(s) = [120.48405729]
bas 15, expnt(s) = [45.8571017]
bas 16, expnt(s) = [20.05020288]
bas 17, expnt(s) = [6.98050975]
bas 18, expnt(s) = [8.60287669]
bas 19, expnt(s) = [0.49269501]
CPU time:       797.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48041990e-01 8.87991748e-01 6.52750340e-01 1.83474349e+00
 1.17616814e+05 1.60460109e+04 2.86492193e+00 5.56351954e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791586e+04 3.67547140e+04 6.70655993e+03
 7.30309541e+03 1.99592977e+03 1.83757972e+04 3.98749055e+03
 1.44915508e+03 5.93404959e+02 3.75214269e+02 2.15389503e+02
 1.20484057e+02 9.18781437e+01 4.58571017e+01 4.45215193e+01
 2.00502029e+01 2.39388952e+01 6.98050975e+00 1.08500160e+01
 8.60287669e+00 4.29822371e+01 4.92695014e-01 1.20422351e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336007030556715
cond(S) = 909221.4807596665
E1 = -689.5902885480901  E_coul = 184.961255609083
init E= -504.629032939007
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672259164845515  LUMO = 0.684797715275339
  mo_energy =
[-1.21709107e+02 -1.33868233e+01 -7.62432939e+00 -7.62432939e+00
 -7.62432939e+00 -1.65741052e+00 -6.72259165e-01 -6.72259165e-01
 -6.72259165e-01  6.84797715e-01  9.10469798e+00  5.11821918e+01
  2.00188814e+02  7.24310749e+02  2.86680641e+03  1.23334557e+04
  4.09464648e+04  1.04985512e+05  2.30166022e+05  4.55978895e+05
  8.44929605e+05  1.52810538e+06  2.85037096e+06  5.80825591e+06]
E1 = -707.7285803420027  E_coul = 199.76165046343732
cycle= 1 E= -507.966929878565  delta_E= -3.34  |g|= 0.451  |ddm|= 0.501
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.704639
diis-c [-0.49651596  1.        ]
  HOMO = -0.217883404788857  LUMO = 1.07138408674203
  mo_energy =
[-1.20200679e+02 -1.23060451e+01 -6.59559978e+00 -6.59559978e+00
 -6.59559978e+00 -1.16337268e+00 -2.17883405e-01 -2.17883405e-01
 -2.17883405e-01  1.07138409e+00  9.93055451e+00  5.23919005e+01
  2.01617361e+02  7.25801611e+02  2.86823803e+03  1.23347782e+04
  4.09477205e+04  1.04986731e+05  2.30167216e+05  4.55980073e+05
  8.44930769e+05  1.52810654e+06  2.85037210e+06  5.80825705e+06]
E1 = -706.7850658483584  E_coul = 198.80055079291282
cycle= 2 E= -507.984515055446  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.43
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297321
diis-c [-8.83445420e-04  1.05500076e-03  9.98944999e-01]
  HOMO = -0.239766599314612  LUMO = 1.06573020566533
  mo_energy =
[-1.20313973e+02 -1.23726684e+01 -6.66939835e+00 -6.66939835e+00
 -6.66939835e+00 -1.17745073e+00 -2.39766599e-01 -2.39766599e-01
 -2.39766599e-01  1.06573021e+00  9.88745855e+00  5.23155093e+01
  2.01517891e+02  7.25684343e+02  2.86810498e+03  1.23346349e+04
  4.09475734e+04  1.04986582e+05  2.30167067e+05  4.55979923e+05
  8.44930619e+05  1.52810639e+06  2.85037195e+06  5.80825690e+06]
E1 = -706.6788696570719  E_coul = 198.69409934618105
cycle= 3 E= -507.984770310891  delta_E= -0.000255  |g|= 0.00439  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324749
diis-c [-2.21365451e-06 -1.76481376e-05 -1.07669412e-01  1.10768706e+00]
  HOMO = -0.242918370551065  LUMO = 1.06468229616364
  mo_energy =
[-1.20325963e+02 -1.23813241e+01 -6.67855952e+00 -6.67855952e+00
 -6.67855952e+00 -1.17935939e+00 -2.42918371e-01 -2.42918371e-01
 -2.42918371e-01  1.06468230e+00  9.88136955e+00  5.23062064e+01
  2.01506848e+02  7.25672189e+02  2.86809199e+03  1.23346214e+04
  4.09475597e+04  1.04986568e+05  2.30167053e+05  4.55979909e+05
  8.44930605e+05  1.52810637e+06  2.85037194e+06  5.80825688e+06]
E1 = -706.6637227006956  E_coul = 198.67894757936529
cycle= 4 E= -507.98477512133  delta_E= -4.81e-06  |g|= 0.000202  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141518
diis-c [-1.45344267e-10 -7.74448733e-06  7.17497988e-03 -9.86028332e-02
  1.09143560e+00]
  HOMO = -0.243055649926327  LUMO = 1.06462947502996
  mo_energy =
[-1.20326304e+02 -1.23816546e+01 -6.67888718e+00 -6.67888718e+00
 -6.67888718e+00 -1.17944120e+00 -2.43055650e-01 -2.43055650e-01
 -2.43055650e-01  1.06462948e+00  9.88111326e+00  5.23058824e+01
  2.01506511e+02  7.25671847e+02  2.86809164e+03  1.23346210e+04
  4.09475593e+04  1.04986568e+05  2.30167053e+05  4.55979909e+05
  8.44930605e+05  1.52810637e+06  2.85037194e+06  5.80825688e+06]
E1 = -706.6630711184524  E_coul = 198.67829598735656
cycle= 5 E= -507.984775131096  delta_E= -9.77e-09  |g|= 1.29e-06  |ddm|= 0.000462
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.05892e-07
diis-c [-8.00181514e-14  2.38945519e-07 -1.67193404e-04  2.09191519e-03
 -2.48286485e-02  1.02290369e+00]
  HOMO = -0.243056403395106  LUMO = 1.06462934163763
  mo_energy =
[-1.20326307e+02 -1.23816564e+01 -6.67888903e+00 -6.67888903e+00
 -6.67888903e+00 -1.17944180e+00 -2.43056403e-01 -2.43056403e-01
 -2.43056403e-01  1.06462934e+00  9.88111188e+00  5.23058805e+01
  2.01506509e+02  7.25671844e+02  2.86809164e+03  1.23346210e+04
  4.09475593e+04  1.04986568e+05  2.30167053e+05  4.55979909e+05
  8.44930605e+05  1.52810637e+06  2.85037194e+06  5.80825688e+06]
E1 = -706.663067257055  E_coul = 198.6782921259593
cycle= 6 E= -507.984775131096  delta_E= 1.14e-13  |g|= 4.03e-08  |ddm|= 2.87e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.663067257055  E_coul = 198.6782921259593
  HOMO = -0.243056423453628  LUMO = 1.0646293309892
  mo_energy =
[-1.20326307e+02 -1.23816564e+01 -6.67888907e+00 -6.67888907e+00
 -6.67888907e+00 -1.17944181e+00 -2.43056423e-01 -2.43056423e-01
 -2.43056423e-01  1.06462933e+00  9.88111184e+00  5.23058805e+01
  2.01506508e+02  7.25671844e+02  2.86809164e+03  1.23346210e+04
  4.09475593e+04  1.04986568e+05  2.30167053e+05  4.55979909e+05
  8.44930605e+05  1.52810637e+06  2.85037194e+06  5.80825688e+06]
E1 = -706.6630671656234  E_coul = 198.67829203452757
Extra cycle  E= -507.984775131096  delta_E= -1.14e-13  |g|= 4.99e-09  |ddm|= 7.62e-08
    CPU time for scf_cycle      1.08 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909221.4807596665
E1 = -706.6630671656234  E_coul = 198.67829203452757
init E= -507.984775131096
    CPU time for initialize scf      3.56 sec, wall time      0.23 sec
  HOMO = -0.243056426256445  LUMO = 1.06462932960516
  mo_energy =
[-1.20326307e+02 -1.23816564e+01 -6.67888908e+00 -6.67888908e+00
 -6.67888908e+00 -1.17944181e+00 -2.43056426e-01 -2.43056426e-01
 -2.43056426e-01  1.06462933e+00  9.88111184e+00  5.23058805e+01
  2.01506508e+02  7.25671844e+02  2.86809164e+03  1.23346210e+04
  4.09475593e+04  1.04986568e+05  2.30167053e+05  4.55979909e+05
  8.44930605e+05  1.52810637e+06  2.85037194e+06  5.80825688e+06]
E1 = -706.6630671523598  E_coul = 198.67829202126362
cycle= 1 E= -507.984775131096  delta_E= -3.41e-13  |g|= 1.37e-09  |ddm|= 9.53e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6630671523598  E_coul = 198.67829202126362
  HOMO = -0.243056426643367  LUMO = 1.0646293297945
  mo_energy =
[-1.20326307e+02 -1.23816564e+01 -6.67888908e+00 -6.67888908e+00
 -6.67888908e+00 -1.17944181e+00 -2.43056427e-01 -2.43056427e-01
 -2.43056427e-01  1.06462933e+00  9.88111183e+00  5.23058805e+01
  2.01506508e+02  7.25671844e+02  2.86809164e+03  1.23346210e+04
  4.09475593e+04  1.04986568e+05  2.30167053e+05  4.55979909e+05
  8.44930605e+05  1.52810637e+06  2.85037194e+06  5.80825688e+06]
E1 = -706.6630671514486  E_coul = 198.67829202035244
Extra cycle  E= -507.984775131096  delta_E= 5.68e-14  |g|= 1.89e-09  |ddm|= 7.71e-10
    CPU time for scf_cycle      4.02 sec, wall time      0.40 sec
exp = [2.48041990e-01 6.52750340e-01 1.17616814e+05 2.86492193e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547140e+04 7.30309541e+03 1.83757972e+04
 1.44915508e+03 3.75214269e+02 1.20484057e+02 4.58571017e+01
 2.00502029e+01 6.98050975e+00 8.60287669e+00 4.92695014e-01]
grad_E = [-1.24593746e-04  2.31860475e-04  3.84447563e-09 -3.45392170e-04
  1.47337367e-11  1.01814115e-10  5.98373615e-10  2.34309391e-09
  9.72190467e-09  5.26870781e-08  3.27651349e-06  1.09490955e-07
  2.23151978e-05 -1.61477685e-04 -1.41988053e-04 -1.54406119e-04
  1.96915107e-04  2.03885409e-05 -1.04758392e-03  3.98191733e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:13:55 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248131188663       1
[INPUT] 0    0    [1    /1   ]  0.652914492948       1
[INPUT] 0    0    [1    /1   ]  117616.813798        1
[INPUT] 0    0    [1    /1   ]  2.86630490019        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031063        1
[INPUT] 0    0    [1    /1   ]  147020.991877        1
[INPUT] 0    0    [1    /1   ]  73510.4198446        1
[INPUT] 0    0    [1    /1   ]  36754.7139835        1
[INPUT] 0    0    [1    /1   ]  7303.09452123        1
[INPUT] 0    0    [1    /1   ]  18375.7971814        1
[INPUT] 0    0    [1    /1   ]  1449.15614767        1
[INPUT] 0    0    [1    /1   ]  375.196326146        1
[INPUT] 0    0    [1    /1   ]  120.57764966         1
[INPUT] 0    0    [1    /1   ]  45.9901048957        1
[INPUT] 0    0    [1    /1   ]  20.1991363476        1
[INPUT] 0    0    [1    /1   ]  6.9837936956         1
[INPUT] 1    0    [1    /1   ]  8.60376009419        1
[INPUT] 1    0    [1    /1   ]  0.492711815009       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2481311886632039, 1.0]], [0, [0.6529144929484946, 1.0]], [0, [117616.81379762357, 1.0]], [0, [2.866304900192073, 1.0]], [0, [1176168.1426168983, 1.0]], [0, [588084.0699805897, 1.0]], [0, [294042.03106277395, 1.0]], [0, [147020.9918767656, 1.0]], [0, [73510.41984464657, 1.0]], [0, [36754.713983483955, 1.0]], [0, [7303.094521225741, 1.0]], [0, [18375.797181381848, 1.0]], [0, [1449.1561476671816, 1.0]], [0, [375.1963261464229, 1.0]], [0, [120.57764965995833, 1.0]], [0, [45.990104895719185, 1.0]], [0, [20.19913634760818, 1.0]], [0, [6.983793695596483, 1.0]], [1, [8.603760094190608, 1.0]], [1, [0.4927118150089563, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24813119]
bas 1, expnt(s) = [0.65291449]
bas 2, expnt(s) = [117616.81379762]
bas 3, expnt(s) = [2.8663049]
bas 4, expnt(s) = [1176168.1426169]
bas 5, expnt(s) = [588084.06998059]
bas 6, expnt(s) = [294042.03106277]
bas 7, expnt(s) = [147020.99187677]
bas 8, expnt(s) = [73510.41984465]
bas 9, expnt(s) = [36754.71398348]
bas 10, expnt(s) = [7303.09452123]
bas 11, expnt(s) = [18375.79718138]
bas 12, expnt(s) = [1449.15614767]
bas 13, expnt(s) = [375.19632615]
bas 14, expnt(s) = [120.57764966]
bas 15, expnt(s) = [45.9901049]
bas 16, expnt(s) = [20.19913635]
bas 17, expnt(s) = [6.9837937]
bas 18, expnt(s) = [8.60376009]
bas 19, expnt(s) = [0.49271182]
CPU time:       809.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48131189e-01 8.88231235e-01 6.52914493e-01 1.83508952e+00
 1.17616814e+05 1.60460109e+04 2.86630490e+00 5.56553366e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791586e+04 3.67547140e+04 6.70655993e+03
 7.30309452e+03 1.99592958e+03 1.83757972e+04 3.98749054e+03
 1.44915615e+03 5.93405288e+02 3.75196326e+02 2.15381778e+02
 1.20577650e+02 9.19316669e+01 4.59901049e+01 4.46183313e+01
 2.01991363e+01 2.40721358e+01 6.98379370e+00 1.08538440e+01
 8.60376009e+00 4.29877543e+01 4.92711815e-01 1.20427484e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33598059249514
cond(S) = 909236.606350026
E1 = -689.5947758629239  E_coul = 184.9656891997647
init E= -504.629086663159
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672250042699275  LUMO = 0.685329741113907
  mo_energy =
[-1.21708238e+02 -1.33864698e+01 -7.62402111e+00 -7.62402111e+00
 -7.62402111e+00 -1.65737876e+00 -6.72250043e-01 -6.72250043e-01
 -6.72250043e-01  6.85329741e-01  9.11819911e+00  5.14164574e+01
  2.00999798e+02  7.25597528e+02  2.86814748e+03  1.23346615e+04
  4.09475852e+04  1.04986587e+05  2.30167066e+05  4.55979918e+05
  8.44930611e+05  1.52810637e+06  2.85037193e+06  5.80825686e+06]
E1 = -707.7337193488974  E_coul = 199.76678980263512
cycle= 1 E= -507.966929546262  delta_E= -3.34  |g|= 0.451  |ddm|= 0.501
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.70483
diis-c [-0.49678539  1.        ]
  HOMO = -0.217845959635037  LUMO = 1.07204380243101
  mo_energy =
[-1.20199746e+02 -1.23056492e+01 -6.59523993e+00 -6.59523993e+00
 -6.59523993e+00 -1.16332482e+00 -2.17845960e-01 -2.17845960e-01
 -2.17845960e-01  1.07204380e+00  9.94471924e+00  5.26276075e+01
  2.02428836e+02  7.27088468e+02  2.86957916e+03  1.23359841e+04
  4.09488409e+04  1.04987806e+05  2.30168261e+05  4.55981096e+05
  8.44931775e+05  1.52810753e+06  2.85037307e+06  5.80825799e+06]
E1 = -706.790150138532  E_coul = 198.80563335107507
cycle= 2 E= -507.984516787457  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.43
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297184
diis-c [-8.82555432e-04  1.12605439e-03  9.98873946e-01]
  HOMO = -0.239729486457118  LUMO = 1.066384598721
  mo_energy =
[-1.20313038e+02 -1.23722705e+01 -6.66903739e+00 -6.66903739e+00
 -6.66903739e+00 -1.17740236e+00 -2.39729486e-01 -2.39729486e-01
 -2.39729486e-01  1.06638460e+00  9.90158083e+00  5.25511077e+01
  2.02329315e+02  7.26971197e+02  2.86944611e+03  1.23358407e+04
  4.09486938e+04  1.04987657e+05  2.30168111e+05  4.55980946e+05
  8.44931625e+05  1.52810738e+06  2.85037292e+06  5.80825784e+06]
E1 = -706.6839633159047  E_coul = 198.69919128804523
cycle= 3 E= -507.98477202786  delta_E= -0.000255  |g|= 0.00439  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324737
diis-c [-2.20915485e-06 -1.99167724e-05 -1.07750624e-01  1.10777054e+00]
  HOMO = -0.242882760329755  LUMO = 1.0653355414553
  mo_energy =
[-1.20325037e+02 -1.23809309e+01 -6.67820393e+00 -6.67820393e+00
 -6.67820393e+00 -1.17931188e+00 -2.42882760e-01 -2.42882760e-01
 -2.42882760e-01  1.06533554e+00  9.89548405e+00  5.25417902e+01
  2.02318261e+02  7.26959034e+02  2.86943311e+03  1.23358272e+04
  4.09486801e+04  1.04987643e+05  2.30168098e+05  4.55980932e+05
  8.44931611e+05  1.52810736e+06  2.85037291e+06  5.80825783e+06]
E1 = -706.668810479193  E_coul = 198.6840336382757
cycle= 4 E= -507.984776840917  delta_E= -4.81e-06  |g|= 0.000202  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141322
diis-c [-1.45176472e-10 -7.73994218e-06  7.18328878e-03 -9.85856489e-02
  1.09141010e+00]
  HOMO = -0.243019896964665  LUMO = 1.06528273398077
  mo_energy =
[-1.20325378e+02 -1.23812611e+01 -6.67853123e+00 -6.67853123e+00
 -6.67853123e+00 -1.17939361e+00 -2.43019897e-01 -2.43019897e-01
 -2.43019897e-01  1.06528273e+00  9.89522789e+00  5.25414664e+01
  2.02317924e+02  7.26958693e+02  2.86943276e+03  1.23358269e+04
  4.09486798e+04  1.04987643e+05  2.30168097e+05  4.55980932e+05
  8.44931611e+05  1.52810736e+06  2.85037291e+06  5.80825783e+06]
E1 = -706.6681596396234  E_coul = 198.6833827889651
cycle= 5 E= -507.984776850658  delta_E= -9.74e-09  |g|= 1.28e-06  |ddm|= 0.000461
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.02748e-07
diis-c [-7.86471173e-14  2.36533697e-07 -1.66263362e-04  2.07687216e-03
 -2.46622078e-02  1.02275136e+00]
  HOMO = -0.243020647283004  LUMO = 1.06528260215353
  mo_energy =
[-1.20325380e+02 -1.23812628e+01 -6.67853308e+00 -6.67853308e+00
 -6.67853308e+00 -1.17939420e+00 -2.43020647e-01 -2.43020647e-01
 -2.43020647e-01  1.06528260e+00  9.89522651e+00  5.25414646e+01
  2.02317922e+02  7.26958690e+02  2.86943276e+03  1.23358268e+04
  4.09486798e+04  1.04987643e+05  2.30168097e+05  4.55980932e+05
  8.44931611e+05  1.52810736e+06  2.85037291e+06  5.80825783e+06]
E1 = -706.6681557942022  E_coul = 198.68337894354403
cycle= 6 E= -507.984776850658  delta_E= 5.68e-14  |g|= 3.95e-08  |ddm|= 2.85e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6681557942022  E_coul = 198.68337894354403
  HOMO = -0.243020667195412  LUMO = 1.06528258934952
  mo_energy =
[-1.20325381e+02 -1.23812629e+01 -6.67853312e+00 -6.67853312e+00
 -6.67853312e+00 -1.17939421e+00 -2.43020667e-01 -2.43020667e-01
 -2.43020667e-01  1.06528259e+00  9.89522647e+00  5.25414645e+01
  2.02317922e+02  7.26958690e+02  2.86943276e+03  1.23358268e+04
  4.09486798e+04  1.04987643e+05  2.30168097e+05  4.55980932e+05
  8.44931611e+05  1.52810736e+06  2.85037291e+06  5.80825783e+06]
E1 = -706.6681557064041  E_coul = 198.6833788557452
Extra cycle  E= -507.984776850659  delta_E= -7.39e-13  |g|= 5.28e-09  |ddm|= 7.37e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.48131189e-01 6.52914493e-01 1.17616814e+05 2.86630490e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547140e+04 7.30309452e+03 1.83757972e+04
 1.44915615e+03 3.75196326e+02 1.20577650e+02 4.59901049e+01
 2.01991363e+01 6.98379370e+00 8.60376009e+00 4.92711815e-01]
E = -507.98477685065893
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:13:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248131188663       1
[INPUT] 0    0    [1    /1   ]  0.652914492948       1
[INPUT] 0    0    [1    /1   ]  117616.813798        1
[INPUT] 0    0    [1    /1   ]  2.86630490019        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031063        1
[INPUT] 0    0    [1    /1   ]  147020.991877        1
[INPUT] 0    0    [1    /1   ]  73510.4198446        1
[INPUT] 0    0    [1    /1   ]  36754.7139835        1
[INPUT] 0    0    [1    /1   ]  7303.09452123        1
[INPUT] 0    0    [1    /1   ]  18375.7971814        1
[INPUT] 0    0    [1    /1   ]  1449.15614767        1
[INPUT] 0    0    [1    /1   ]  375.196326146        1
[INPUT] 0    0    [1    /1   ]  120.57764966         1
[INPUT] 0    0    [1    /1   ]  45.9901048957        1
[INPUT] 0    0    [1    /1   ]  20.1991363476        1
[INPUT] 0    0    [1    /1   ]  6.9837936956         1
[INPUT] 1    0    [1    /1   ]  8.60376009419        1
[INPUT] 1    0    [1    /1   ]  0.492711815009       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2481311886632039, 1.0]], [0, [0.6529144929484946, 1.0]], [0, [117616.81379762357, 1.0]], [0, [2.866304900192073, 1.0]], [0, [1176168.1426168983, 1.0]], [0, [588084.0699805897, 1.0]], [0, [294042.03106277395, 1.0]], [0, [147020.9918767656, 1.0]], [0, [73510.41984464657, 1.0]], [0, [36754.713983483955, 1.0]], [0, [7303.094521225741, 1.0]], [0, [18375.797181381848, 1.0]], [0, [1449.1561476671816, 1.0]], [0, [375.1963261464229, 1.0]], [0, [120.57764965995833, 1.0]], [0, [45.990104895719185, 1.0]], [0, [20.19913634760818, 1.0]], [0, [6.983793695596483, 1.0]], [1, [8.603760094190608, 1.0]], [1, [0.4927118150089563, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24813119]
bas 1, expnt(s) = [0.65291449]
bas 2, expnt(s) = [117616.81379762]
bas 3, expnt(s) = [2.8663049]
bas 4, expnt(s) = [1176168.1426169]
bas 5, expnt(s) = [588084.06998059]
bas 6, expnt(s) = [294042.03106277]
bas 7, expnt(s) = [147020.99187677]
bas 8, expnt(s) = [73510.41984465]
bas 9, expnt(s) = [36754.71398348]
bas 10, expnt(s) = [7303.09452123]
bas 11, expnt(s) = [18375.79718138]
bas 12, expnt(s) = [1449.15614767]
bas 13, expnt(s) = [375.19632615]
bas 14, expnt(s) = [120.57764966]
bas 15, expnt(s) = [45.9901049]
bas 16, expnt(s) = [20.19913635]
bas 17, expnt(s) = [6.9837937]
bas 18, expnt(s) = [8.60376009]
bas 19, expnt(s) = [0.49271182]
CPU time:       811.24
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48131189e-01 8.88231235e-01 6.52914493e-01 1.83508952e+00
 1.17616814e+05 1.60460109e+04 2.86630490e+00 5.56553366e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791586e+04 3.67547140e+04 6.70655993e+03
 7.30309452e+03 1.99592958e+03 1.83757972e+04 3.98749054e+03
 1.44915615e+03 5.93405288e+02 3.75196326e+02 2.15381778e+02
 1.20577650e+02 9.19316669e+01 4.59901049e+01 4.46183313e+01
 2.01991363e+01 2.40721358e+01 6.98379370e+00 1.08538440e+01
 8.60376009e+00 4.29877543e+01 4.92711815e-01 1.20427484e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33598059249514
cond(S) = 909236.606350026
E1 = -689.5947758629239  E_coul = 184.9656891997647
init E= -504.629086663159
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672250042699275  LUMO = 0.685329741113907
  mo_energy =
[-1.21708238e+02 -1.33864698e+01 -7.62402111e+00 -7.62402111e+00
 -7.62402111e+00 -1.65737876e+00 -6.72250043e-01 -6.72250043e-01
 -6.72250043e-01  6.85329741e-01  9.11819911e+00  5.14164574e+01
  2.00999798e+02  7.25597528e+02  2.86814748e+03  1.23346615e+04
  4.09475852e+04  1.04986587e+05  2.30167066e+05  4.55979918e+05
  8.44930611e+05  1.52810637e+06  2.85037193e+06  5.80825686e+06]
E1 = -707.7337193488974  E_coul = 199.76678980263512
cycle= 1 E= -507.966929546262  delta_E= -3.34  |g|= 0.451  |ddm|= 0.501
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.70483
diis-c [-0.49678539  1.        ]
  HOMO = -0.217845959635037  LUMO = 1.07204380243101
  mo_energy =
[-1.20199746e+02 -1.23056492e+01 -6.59523993e+00 -6.59523993e+00
 -6.59523993e+00 -1.16332482e+00 -2.17845960e-01 -2.17845960e-01
 -2.17845960e-01  1.07204380e+00  9.94471924e+00  5.26276075e+01
  2.02428836e+02  7.27088468e+02  2.86957916e+03  1.23359841e+04
  4.09488409e+04  1.04987806e+05  2.30168261e+05  4.55981096e+05
  8.44931775e+05  1.52810753e+06  2.85037307e+06  5.80825799e+06]
E1 = -706.790150138532  E_coul = 198.80563335107507
cycle= 2 E= -507.984516787457  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.43
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297184
diis-c [-8.82555432e-04  1.12605439e-03  9.98873946e-01]
  HOMO = -0.239729486457118  LUMO = 1.066384598721
  mo_energy =
[-1.20313038e+02 -1.23722705e+01 -6.66903739e+00 -6.66903739e+00
 -6.66903739e+00 -1.17740236e+00 -2.39729486e-01 -2.39729486e-01
 -2.39729486e-01  1.06638460e+00  9.90158083e+00  5.25511077e+01
  2.02329315e+02  7.26971197e+02  2.86944611e+03  1.23358407e+04
  4.09486938e+04  1.04987657e+05  2.30168111e+05  4.55980946e+05
  8.44931625e+05  1.52810738e+06  2.85037292e+06  5.80825784e+06]
E1 = -706.6839633159047  E_coul = 198.69919128804523
cycle= 3 E= -507.98477202786  delta_E= -0.000255  |g|= 0.00439  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324737
diis-c [-2.20915485e-06 -1.99167724e-05 -1.07750624e-01  1.10777054e+00]
  HOMO = -0.242882760329755  LUMO = 1.0653355414553
  mo_energy =
[-1.20325037e+02 -1.23809309e+01 -6.67820393e+00 -6.67820393e+00
 -6.67820393e+00 -1.17931188e+00 -2.42882760e-01 -2.42882760e-01
 -2.42882760e-01  1.06533554e+00  9.89548405e+00  5.25417902e+01
  2.02318261e+02  7.26959034e+02  2.86943311e+03  1.23358272e+04
  4.09486801e+04  1.04987643e+05  2.30168098e+05  4.55980932e+05
  8.44931611e+05  1.52810736e+06  2.85037291e+06  5.80825783e+06]
E1 = -706.668810479193  E_coul = 198.6840336382757
cycle= 4 E= -507.984776840917  delta_E= -4.81e-06  |g|= 0.000202  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141322
diis-c [-1.45176472e-10 -7.73994218e-06  7.18328878e-03 -9.85856489e-02
  1.09141010e+00]
  HOMO = -0.243019896964665  LUMO = 1.06528273398077
  mo_energy =
[-1.20325378e+02 -1.23812611e+01 -6.67853123e+00 -6.67853123e+00
 -6.67853123e+00 -1.17939361e+00 -2.43019897e-01 -2.43019897e-01
 -2.43019897e-01  1.06528273e+00  9.89522789e+00  5.25414664e+01
  2.02317924e+02  7.26958693e+02  2.86943276e+03  1.23358269e+04
  4.09486798e+04  1.04987643e+05  2.30168097e+05  4.55980932e+05
  8.44931611e+05  1.52810736e+06  2.85037291e+06  5.80825783e+06]
E1 = -706.6681596396234  E_coul = 198.6833827889651
cycle= 5 E= -507.984776850658  delta_E= -9.74e-09  |g|= 1.28e-06  |ddm|= 0.000461
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.02748e-07
diis-c [-7.86471173e-14  2.36533697e-07 -1.66263362e-04  2.07687216e-03
 -2.46622078e-02  1.02275136e+00]
  HOMO = -0.243020647283004  LUMO = 1.06528260215353
  mo_energy =
[-1.20325380e+02 -1.23812628e+01 -6.67853308e+00 -6.67853308e+00
 -6.67853308e+00 -1.17939420e+00 -2.43020647e-01 -2.43020647e-01
 -2.43020647e-01  1.06528260e+00  9.89522651e+00  5.25414646e+01
  2.02317922e+02  7.26958690e+02  2.86943276e+03  1.23358268e+04
  4.09486798e+04  1.04987643e+05  2.30168097e+05  4.55980932e+05
  8.44931611e+05  1.52810736e+06  2.85037291e+06  5.80825783e+06]
E1 = -706.6681557942022  E_coul = 198.68337894354403
cycle= 6 E= -507.984776850658  delta_E= 5.68e-14  |g|= 3.95e-08  |ddm|= 2.85e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6681557942022  E_coul = 198.68337894354403
  HOMO = -0.243020667195412  LUMO = 1.06528258934952
  mo_energy =
[-1.20325381e+02 -1.23812629e+01 -6.67853312e+00 -6.67853312e+00
 -6.67853312e+00 -1.17939421e+00 -2.43020667e-01 -2.43020667e-01
 -2.43020667e-01  1.06528259e+00  9.89522647e+00  5.25414645e+01
  2.02317922e+02  7.26958690e+02  2.86943276e+03  1.23358268e+04
  4.09486798e+04  1.04987643e+05  2.30168097e+05  4.55980932e+05
  8.44931611e+05  1.52810736e+06  2.85037291e+06  5.80825783e+06]
E1 = -706.6681557064041  E_coul = 198.6833788557452
Extra cycle  E= -507.984776850659  delta_E= -7.39e-13  |g|= 5.28e-09  |ddm|= 7.37e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909236.606350026
E1 = -706.6681557064041  E_coul = 198.6833788557452
init E= -507.984776850659
    CPU time for initialize scf      3.57 sec, wall time      0.23 sec
  HOMO = -0.243020669890431  LUMO = 1.06528258844653
  mo_energy =
[-1.20325381e+02 -1.23812629e+01 -6.67853312e+00 -6.67853312e+00
 -6.67853312e+00 -1.17939421e+00 -2.43020670e-01 -2.43020670e-01
 -2.43020670e-01  1.06528259e+00  9.89522647e+00  5.25414645e+01
  2.02317922e+02  7.26958690e+02  2.86943276e+03  1.23358268e+04
  4.09486798e+04  1.04987643e+05  2.30168097e+05  4.55980932e+05
  8.44931611e+05  1.52810736e+06  2.85037291e+06  5.80825783e+06]
E1 = -706.6681556935165  E_coul = 198.6833788428579
cycle= 1 E= -507.984776850659  delta_E= 3.41e-13  |g|= 1.9e-09  |ddm|= 9.25e-09
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.6681556935165  E_coul = 198.6833788428579
  HOMO = -0.243020670268179  LUMO = 1.06528258845566
  mo_energy =
[-1.20325381e+02 -1.23812629e+01 -6.67853312e+00 -6.67853312e+00
 -6.67853312e+00 -1.17939421e+00 -2.43020670e-01 -2.43020670e-01
 -2.43020670e-01  1.06528259e+00  9.89522647e+00  5.25414645e+01
  2.02317922e+02  7.26958690e+02  2.86943276e+03  1.23358268e+04
  4.09486798e+04  1.04987643e+05  2.30168097e+05  4.55980932e+05
  8.44931611e+05  1.52810736e+06  2.85037291e+06  5.80825783e+06]
E1 = -706.6681556892295  E_coul = 198.6833788385714
Extra cycle  E= -507.984776850658  delta_E= 5.12e-13  |g|= 1.58e-09  |ddm|= 2.83e-09
    CPU time for scf_cycle      4.01 sec, wall time      0.39 sec
exp = [2.48131189e-01 6.52914493e-01 1.17616814e+05 2.86630490e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547140e+04 7.30309452e+03 1.83757972e+04
 1.44915615e+03 3.75196326e+02 1.20577650e+02 4.59901049e+01
 2.01991363e+01 6.98379370e+00 8.60376009e+00 4.92711815e-01]
grad_E = [-9.18866762e-05  2.30543992e-04  3.83730498e-09 -2.72469003e-04
  1.46474495e-11  1.01581931e-10  5.97261046e-10  2.33866473e-09
  9.70325348e-09  5.25946999e-08  3.26991416e-06  1.09215092e-07
  2.26524129e-05 -1.64038984e-04 -1.40141249e-04 -1.45514253e-04
  1.99193036e-04 -2.93237315e-05 -3.23785297e-04  1.46276561e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:14:03 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248180132581       1
[INPUT] 0    0    [1    /1   ]  0.652978459139       1
[INPUT] 0    0    [1    /1   ]  117616.813797        1
[INPUT] 0    0    [1    /1   ]  2.86697499866        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031063        1
[INPUT] 0    0    [1    /1   ]  147020.991877        1
[INPUT] 0    0    [1    /1   ]  73510.4198442        1
[INPUT] 0    0    [1    /1   ]  36754.713981         1
[INPUT] 0    0    [1    /1   ]  7303.09436459        1
[INPUT] 0    0    [1    /1   ]  18375.7971759        1
[INPUT] 0    0    [1    /1   ]  1449.15636788        1
[INPUT] 0    0    [1    /1   ]  375.19246589         1
[INPUT] 0    0    [1    /1   ]  120.600308535        1
[INPUT] 0    0    [1    /1   ]  46.0018551713        1
[INPUT] 0    0    [1    /1   ]  20.219415019         1
[INPUT] 0    0    [1    /1   ]  6.98402131655        1
[INPUT] 1    0    [1    /1   ]  8.60421139721        1
[INPUT] 1    0    [1    /1   ]  0.492720937146       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24818013258077698, 1.0]], [0, [0.6529784591394968, 1.0]], [0, [117616.81379744127, 1.0]], [0, [2.866974998661799, 1.0]], [0, [1176168.1426168974, 1.0]], [0, [588084.0699805847, 1.0]], [0, [294042.0310627456, 1.0]], [0, [147020.99187665427, 1.0]], [0, [73510.41984418369, 1.0]], [0, [36754.7139810067, 1.0]], [0, [7303.094364594449, 1.0]], [0, [18375.797175930722, 1.0]], [0, [1449.1563678753882, 1.0]], [0, [375.19246588990325, 1.0]], [0, [120.60030853546714, 1.0]], [0, [46.00185517126284, 1.0]], [0, [20.21941501897158, 1.0]], [0, [6.984021316552535, 1.0]], [1, [8.604211397205995, 1.0]], [1, [0.49272093714560133, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24818013]
bas 1, expnt(s) = [0.65297846]
bas 2, expnt(s) = [117616.81379744]
bas 3, expnt(s) = [2.866975]
bas 4, expnt(s) = [1176168.1426169]
bas 5, expnt(s) = [588084.06998058]
bas 6, expnt(s) = [294042.03106275]
bas 7, expnt(s) = [147020.99187665]
bas 8, expnt(s) = [73510.41984418]
bas 9, expnt(s) = [36754.71398101]
bas 10, expnt(s) = [7303.09436459]
bas 11, expnt(s) = [18375.79717593]
bas 12, expnt(s) = [1449.15636788]
bas 13, expnt(s) = [375.19246589]
bas 14, expnt(s) = [120.60030854]
bas 15, expnt(s) = [46.00185517]
bas 16, expnt(s) = [20.21941502]
bas 17, expnt(s) = [6.98402132]
bas 18, expnt(s) = [8.6042114]
bas 19, expnt(s) = [0.49272094]
CPU time:       823.02
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48180133e-01 8.88362635e-01 6.52978459e-01 1.83522436e+00
 1.17616814e+05 1.60460109e+04 2.86697500e+00 5.56650949e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791586e+04 3.67547140e+04 6.70655993e+03
 7.30309436e+03 1.99592955e+03 1.83757972e+04 3.98749054e+03
 1.44915637e+03 5.93405355e+02 3.75192466e+02 2.15380116e+02
 1.20600309e+02 9.19446234e+01 4.60018552e+01 4.46268809e+01
 2.02194150e+01 2.40902587e+01 6.98402132e+00 1.08541093e+01
 8.60421140e+00 4.29905729e+01 4.92720937e-01 1.20430271e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335966268567624
cond(S) = 909238.749389142
E1 = -689.5971229809716  E_coul = 184.967974838435
init E= -504.629148142537
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672244730705477  LUMO = 0.685579556786476
  mo_energy =
[-1.21707790e+02 -1.33862895e+01 -7.62386226e+00 -7.62386226e+00
 -7.62386226e+00 -1.65736262e+00 -6.72244731e-01 -6.72244731e-01
 -6.72244731e-01  6.85579557e-01  9.12136530e+00  5.14485716e+01
  2.01104687e+02  7.25774860e+02  2.86833966e+03  1.23348354e+04
  4.09477470e+04  1.04986742e+05  2.30167217e+05  4.55980066e+05
  8.44930756e+05  1.52810652e+06  2.85037207e+06  5.80825699e+06]
E1 = -707.7364057059413  E_coul = 199.76947695818245
cycle= 1 E= -507.966928747759  delta_E= -3.34  |g|= 0.451  |ddm|= 0.501
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.704857
diis-c [-0.49682269  1.        ]
  HOMO = -0.217825180272302  LUMO = 1.07234789982676
  mo_energy =
[-1.20199260e+02 -1.23054443e+01 -6.59505148e+00 -6.59505148e+00
 -6.59505148e+00 -1.16329952e+00 -2.17825180e-01 -2.17825180e-01
 -2.17825180e-01  1.07234790e+00  9.94801153e+00  5.26599261e+01
  2.02533812e+02  7.27265838e+02  2.86977138e+03  1.23361580e+04
  4.09490027e+04  1.04987961e+05  2.30168412e+05  4.55981243e+05
  8.44931920e+05  1.52810767e+06  2.85037321e+06  5.80825813e+06]
E1 = -706.7928035398269  E_coul = 198.8082863827507
cycle= 2 E= -507.984517157076  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.43
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297152
diis-c [-8.82351476e-04  1.13662077e-03  9.98863379e-01]
  HOMO = -0.23970941275512  LUMO = 1.06668659071113
  mo_energy =
[-1.20312556e+02 -1.23720668e+01 -6.66885083e+00 -6.66885083e+00
 -6.66885083e+00 -1.17737713e+00 -2.39709413e-01 -2.39709413e-01
 -2.39709413e-01  1.06668659e+00  9.90486394e+00  5.25834105e+01
  2.02434282e+02  7.27148563e+02  2.86963833e+03  1.23360147e+04
  4.09488556e+04  1.04987812e+05  2.30168262e+05  4.55981093e+05
  8.44931770e+05  1.52810752e+06  2.85037306e+06  5.80825798e+06]
E1 = -706.68661901121  E_coul = 198.70184662239654
cycle= 3 E= -507.984772388813  delta_E= -0.000255  |g|= 0.00439  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.003247
diis-c [-2.20827445e-06 -2.01046809e-05 -1.07752931e-01  1.10777304e+00]
  HOMO = -0.242862817046161  LUMO = 1.06563722271227
  mo_energy =
[-1.20324555e+02 -1.23807278e+01 -6.67801803e+00 -6.67801803e+00
 -6.67801803e+00 -1.17928668e+00 -2.42862817e-01 -2.42862817e-01
 -2.42862817e-01  1.06563722e+00  9.89876596e+00  5.25740912e+01
  2.02423226e+02  7.27136399e+02  2.86962532e+03  1.23360012e+04
  4.09488419e+04  1.04987798e+05  2.30168249e+05  4.55981080e+05
  8.44931756e+05  1.52810751e+06  2.85037305e+06  5.80825796e+06]
E1 = -706.6714662785273  E_coul = 198.68668907690304
cycle= 4 E= -507.984777201624  delta_E= -4.81e-06  |g|= 0.000202  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141287
diis-c [-1.45088449e-10 -7.73916367e-06  7.18390710e-03 -9.85838400e-02
  1.09140767e+00]
  HOMO = -0.24299993499791  LUMO = 1.06558440892864
  mo_energy =
[-1.20324897e+02 -1.23810579e+01 -6.67834531e+00 -6.67834531e+00
 -6.67834531e+00 -1.17936839e+00 -2.42999935e-01 -2.42999935e-01
 -2.42999935e-01  1.06558441e+00  9.89850980e+00  5.25737674e+01
  2.02422889e+02  7.27136057e+02  2.86962498e+03  1.23360008e+04
  4.09488416e+04  1.04987798e+05  2.30168248e+05  4.55981079e+05
  8.44931756e+05  1.52810750e+06  2.85037305e+06  5.80825796e+06]
E1 = -706.6708155629159  E_coul = 198.68603835155486
cycle= 5 E= -507.984777211361  delta_E= -9.74e-09  |g|= 1.28e-06  |ddm|= 0.000461
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.01011e-07
diis-c [-7.86923661e-14  2.31788875e-07 -1.65594732e-04  2.06822412e-03
 -2.45671156e-02  1.02266425e+00]
  HOMO = -0.243000684215382  LUMO = 1.0655842773526
  mo_energy =
[-1.20324899e+02 -1.23810597e+01 -6.67834715e+00 -6.67834715e+00
 -6.67834715e+00 -1.17936898e+00 -2.43000684e-01 -2.43000684e-01
 -2.43000684e-01  1.06558428e+00  9.89850842e+00  5.25737656e+01
  2.02422887e+02  7.27136055e+02  2.86962498e+03  1.23360008e+04
  4.09488416e+04  1.04987798e+05  2.30168248e+05  4.55981079e+05
  8.44931756e+05  1.52810750e+06  2.85037305e+06  5.80825796e+06]
E1 = -706.6708117244634  E_coul = 198.68603451310182
cycle= 6 E= -507.984777211362  delta_E= -5.68e-13  |g|= 4.03e-08  |ddm|= 2.85e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6708117244634  E_coul = 198.68603451310182
  HOMO = -0.243000704076705  LUMO = 1.06558426609525
  mo_energy =
[-1.20324899e+02 -1.23810597e+01 -6.67834719e+00 -6.67834719e+00
 -6.67834719e+00 -1.17936899e+00 -2.43000704e-01 -2.43000704e-01
 -2.43000704e-01  1.06558427e+00  9.89850838e+00  5.25737655e+01
  2.02422887e+02  7.27136055e+02  2.86962498e+03  1.23360008e+04
  4.09488416e+04  1.04987798e+05  2.30168248e+05  4.55981079e+05
  8.44931756e+05  1.52810750e+06  2.85037305e+06  5.80825796e+06]
E1 = -706.6708116317135  E_coul = 198.68603442035226
Extra cycle  E= -507.984777211361  delta_E= 3.41e-13  |g|= 4.83e-09  |ddm|= 7.67e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.48180133e-01 6.52978459e-01 1.17616814e+05 2.86697500e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547140e+04 7.30309436e+03 1.83757972e+04
 1.44915637e+03 3.75192466e+02 1.20600309e+02 4.60018552e+01
 2.02194150e+01 6.98402132e+00 8.60421140e+00 4.92720937e-01]
E = -507.98477721136123
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:14:04 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248180132581       1
[INPUT] 0    0    [1    /1   ]  0.652978459139       1
[INPUT] 0    0    [1    /1   ]  117616.813797        1
[INPUT] 0    0    [1    /1   ]  2.86697499866        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031063        1
[INPUT] 0    0    [1    /1   ]  147020.991877        1
[INPUT] 0    0    [1    /1   ]  73510.4198442        1
[INPUT] 0    0    [1    /1   ]  36754.713981         1
[INPUT] 0    0    [1    /1   ]  7303.09436459        1
[INPUT] 0    0    [1    /1   ]  18375.7971759        1
[INPUT] 0    0    [1    /1   ]  1449.15636788        1
[INPUT] 0    0    [1    /1   ]  375.19246589         1
[INPUT] 0    0    [1    /1   ]  120.600308535        1
[INPUT] 0    0    [1    /1   ]  46.0018551713        1
[INPUT] 0    0    [1    /1   ]  20.219415019         1
[INPUT] 0    0    [1    /1   ]  6.98402131655        1
[INPUT] 1    0    [1    /1   ]  8.60421139721        1
[INPUT] 1    0    [1    /1   ]  0.492720937146       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24818013258077698, 1.0]], [0, [0.6529784591394968, 1.0]], [0, [117616.81379744127, 1.0]], [0, [2.866974998661799, 1.0]], [0, [1176168.1426168974, 1.0]], [0, [588084.0699805847, 1.0]], [0, [294042.0310627456, 1.0]], [0, [147020.99187665427, 1.0]], [0, [73510.41984418369, 1.0]], [0, [36754.7139810067, 1.0]], [0, [7303.094364594449, 1.0]], [0, [18375.797175930722, 1.0]], [0, [1449.1563678753882, 1.0]], [0, [375.19246588990325, 1.0]], [0, [120.60030853546714, 1.0]], [0, [46.00185517126284, 1.0]], [0, [20.21941501897158, 1.0]], [0, [6.984021316552535, 1.0]], [1, [8.604211397205995, 1.0]], [1, [0.49272093714560133, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24818013]
bas 1, expnt(s) = [0.65297846]
bas 2, expnt(s) = [117616.81379744]
bas 3, expnt(s) = [2.866975]
bas 4, expnt(s) = [1176168.1426169]
bas 5, expnt(s) = [588084.06998058]
bas 6, expnt(s) = [294042.03106275]
bas 7, expnt(s) = [147020.99187665]
bas 8, expnt(s) = [73510.41984418]
bas 9, expnt(s) = [36754.71398101]
bas 10, expnt(s) = [7303.09436459]
bas 11, expnt(s) = [18375.79717593]
bas 12, expnt(s) = [1449.15636788]
bas 13, expnt(s) = [375.19246589]
bas 14, expnt(s) = [120.60030854]
bas 15, expnt(s) = [46.00185517]
bas 16, expnt(s) = [20.21941502]
bas 17, expnt(s) = [6.98402132]
bas 18, expnt(s) = [8.6042114]
bas 19, expnt(s) = [0.49272094]
CPU time:       824.51
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48180133e-01 8.88362635e-01 6.52978459e-01 1.83522436e+00
 1.17616814e+05 1.60460109e+04 2.86697500e+00 5.56650949e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791586e+04 3.67547140e+04 6.70655993e+03
 7.30309436e+03 1.99592955e+03 1.83757972e+04 3.98749054e+03
 1.44915637e+03 5.93405355e+02 3.75192466e+02 2.15380116e+02
 1.20600309e+02 9.19446234e+01 4.60018552e+01 4.46268809e+01
 2.02194150e+01 2.40902587e+01 6.98402132e+00 1.08541093e+01
 8.60421140e+00 4.29905729e+01 4.92720937e-01 1.20430271e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335966268567624
cond(S) = 909238.749389142
E1 = -689.5971229809716  E_coul = 184.967974838435
init E= -504.629148142537
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672244730705477  LUMO = 0.685579556786476
  mo_energy =
[-1.21707790e+02 -1.33862895e+01 -7.62386226e+00 -7.62386226e+00
 -7.62386226e+00 -1.65736262e+00 -6.72244731e-01 -6.72244731e-01
 -6.72244731e-01  6.85579557e-01  9.12136530e+00  5.14485716e+01
  2.01104687e+02  7.25774860e+02  2.86833966e+03  1.23348354e+04
  4.09477470e+04  1.04986742e+05  2.30167217e+05  4.55980066e+05
  8.44930756e+05  1.52810652e+06  2.85037207e+06  5.80825699e+06]
E1 = -707.7364057059413  E_coul = 199.76947695818245
cycle= 1 E= -507.966928747759  delta_E= -3.34  |g|= 0.451  |ddm|= 0.501
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.704857
diis-c [-0.49682269  1.        ]
  HOMO = -0.217825180272302  LUMO = 1.07234789982676
  mo_energy =
[-1.20199260e+02 -1.23054443e+01 -6.59505148e+00 -6.59505148e+00
 -6.59505148e+00 -1.16329952e+00 -2.17825180e-01 -2.17825180e-01
 -2.17825180e-01  1.07234790e+00  9.94801153e+00  5.26599261e+01
  2.02533812e+02  7.27265838e+02  2.86977138e+03  1.23361580e+04
  4.09490027e+04  1.04987961e+05  2.30168412e+05  4.55981243e+05
  8.44931920e+05  1.52810767e+06  2.85037321e+06  5.80825813e+06]
E1 = -706.7928035398269  E_coul = 198.8082863827507
cycle= 2 E= -507.984517157076  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.43
    CPU time for cycle= 2      0.14 sec, wall time      0.04 sec
diis-norm(errvec)=0.0297152
diis-c [-8.82351476e-04  1.13662077e-03  9.98863379e-01]
  HOMO = -0.23970941275512  LUMO = 1.06668659071113
  mo_energy =
[-1.20312556e+02 -1.23720668e+01 -6.66885083e+00 -6.66885083e+00
 -6.66885083e+00 -1.17737713e+00 -2.39709413e-01 -2.39709413e-01
 -2.39709413e-01  1.06668659e+00  9.90486394e+00  5.25834105e+01
  2.02434282e+02  7.27148563e+02  2.86963833e+03  1.23360147e+04
  4.09488556e+04  1.04987812e+05  2.30168262e+05  4.55981093e+05
  8.44931770e+05  1.52810752e+06  2.85037306e+06  5.80825798e+06]
E1 = -706.68661901121  E_coul = 198.70184662239654
cycle= 3 E= -507.984772388813  delta_E= -0.000255  |g|= 0.00439  |ddm|= 0.06
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.003247
diis-c [-2.20827445e-06 -2.01046809e-05 -1.07752931e-01  1.10777304e+00]
  HOMO = -0.242862817046161  LUMO = 1.06563722271227
  mo_energy =
[-1.20324555e+02 -1.23807278e+01 -6.67801803e+00 -6.67801803e+00
 -6.67801803e+00 -1.17928668e+00 -2.42862817e-01 -2.42862817e-01
 -2.42862817e-01  1.06563722e+00  9.89876596e+00  5.25740912e+01
  2.02423226e+02  7.27136399e+02  2.86962532e+03  1.23360012e+04
  4.09488419e+04  1.04987798e+05  2.30168249e+05  4.55981080e+05
  8.44931756e+05  1.52810751e+06  2.85037305e+06  5.80825796e+06]
E1 = -706.6714662785273  E_coul = 198.68668907690304
cycle= 4 E= -507.984777201624  delta_E= -4.81e-06  |g|= 0.000202  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141287
diis-c [-1.45088449e-10 -7.73916367e-06  7.18390710e-03 -9.85838400e-02
  1.09140767e+00]
  HOMO = -0.24299993499791  LUMO = 1.06558440892864
  mo_energy =
[-1.20324897e+02 -1.23810579e+01 -6.67834531e+00 -6.67834531e+00
 -6.67834531e+00 -1.17936839e+00 -2.42999935e-01 -2.42999935e-01
 -2.42999935e-01  1.06558441e+00  9.89850980e+00  5.25737674e+01
  2.02422889e+02  7.27136057e+02  2.86962498e+03  1.23360008e+04
  4.09488416e+04  1.04987798e+05  2.30168248e+05  4.55981079e+05
  8.44931756e+05  1.52810750e+06  2.85037305e+06  5.80825796e+06]
E1 = -706.6708155629159  E_coul = 198.68603835155486
cycle= 5 E= -507.984777211361  delta_E= -9.74e-09  |g|= 1.28e-06  |ddm|= 0.000461
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.01011e-07
diis-c [-7.86923661e-14  2.31788875e-07 -1.65594732e-04  2.06822412e-03
 -2.45671156e-02  1.02266425e+00]
  HOMO = -0.243000684215382  LUMO = 1.0655842773526
  mo_energy =
[-1.20324899e+02 -1.23810597e+01 -6.67834715e+00 -6.67834715e+00
 -6.67834715e+00 -1.17936898e+00 -2.43000684e-01 -2.43000684e-01
 -2.43000684e-01  1.06558428e+00  9.89850842e+00  5.25737656e+01
  2.02422887e+02  7.27136055e+02  2.86962498e+03  1.23360008e+04
  4.09488416e+04  1.04987798e+05  2.30168248e+05  4.55981079e+05
  8.44931756e+05  1.52810750e+06  2.85037305e+06  5.80825796e+06]
E1 = -706.6708117244634  E_coul = 198.68603451310182
cycle= 6 E= -507.984777211362  delta_E= -5.68e-13  |g|= 4.03e-08  |ddm|= 2.85e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6708117244634  E_coul = 198.68603451310182
  HOMO = -0.243000704076705  LUMO = 1.06558426609525
  mo_energy =
[-1.20324899e+02 -1.23810597e+01 -6.67834719e+00 -6.67834719e+00
 -6.67834719e+00 -1.17936899e+00 -2.43000704e-01 -2.43000704e-01
 -2.43000704e-01  1.06558427e+00  9.89850838e+00  5.25737655e+01
  2.02422887e+02  7.27136055e+02  2.86962498e+03  1.23360008e+04
  4.09488416e+04  1.04987798e+05  2.30168248e+05  4.55981079e+05
  8.44931756e+05  1.52810750e+06  2.85037305e+06  5.80825796e+06]
E1 = -706.6708116317135  E_coul = 198.68603442035226
Extra cycle  E= -507.984777211361  delta_E= 3.41e-13  |g|= 4.83e-09  |ddm|= 7.67e-08
    CPU time for scf_cycle      1.11 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909238.749389142
E1 = -706.6708116317135  E_coul = 198.68603442035226
init E= -507.984777211361
    CPU time for initialize scf      3.72 sec, wall time      0.24 sec
  HOMO = -0.243000706898672  LUMO = 1.06558426601684
  mo_energy =
[-1.20324899e+02 -1.23810597e+01 -6.67834719e+00 -6.67834719e+00
 -6.67834719e+00 -1.17936899e+00 -2.43000707e-01 -2.43000707e-01
 -2.43000707e-01  1.06558427e+00  9.89850838e+00  5.25737655e+01
  2.02422887e+02  7.27136055e+02  2.86962498e+03  1.23360008e+04
  4.09488416e+04  1.04987798e+05  2.30168248e+05  4.55981079e+05
  8.44931756e+05  1.52810750e+06  2.85037305e+06  5.80825796e+06]
E1 = -706.6708116178575  E_coul = 198.686034406496
cycle= 1 E= -507.984777211361  delta_E= -2.27e-13  |g|= 1.55e-09  |ddm|= 1e-08
    CPU time for cycle= 1      0.29 sec, wall time      0.03 sec
E1 = -706.6708116178575  E_coul = 198.686034406496
  HOMO = -0.243000707309288  LUMO = 1.06558426520815
  mo_energy =
[-1.20324899e+02 -1.23810597e+01 -6.67834720e+00 -6.67834720e+00
 -6.67834720e+00 -1.17936899e+00 -2.43000707e-01 -2.43000707e-01
 -2.43000707e-01  1.06558427e+00  9.89850838e+00  5.25737655e+01
  2.02422887e+02  7.27136055e+02  2.86962498e+03  1.23360008e+04
  4.09488416e+04  1.04987798e+05  2.30168248e+05  4.55981079e+05
  8.44931756e+05  1.52810750e+06  2.85037305e+06  5.80825796e+06]
E1 = -706.6708116165786  E_coul = 198.68603440521733
Extra cycle  E= -507.984777211361  delta_E= 2.27e-13  |g|= 9.94e-10  |ddm|= 9.11e-10
    CPU time for scf_cycle      4.16 sec, wall time      0.41 sec
exp = [2.48180133e-01 6.52978459e-01 1.17616814e+05 2.86697500e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547140e+04 7.30309436e+03 1.83757972e+04
 1.44915637e+03 3.75192466e+02 1.20600309e+02 4.60018552e+01
 2.02194150e+01 6.98402132e+00 8.60421140e+00 4.92720937e-01]
grad_E = [-6.15031612e-05  2.28178761e-04  3.83347716e-09 -2.36032896e-04
  1.46013926e-11  1.01457984e-10  5.96667167e-10  2.33630038e-09
  9.69329670e-09  5.25453679e-08  3.26635286e-06  1.09067814e-07
  2.28487712e-05 -1.66120529e-04 -1.33169266e-04 -1.53283540e-04
  2.03119596e-04 -4.44169143e-05  4.58597519e-05  4.02018952e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:14:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248204219024       1
[INPUT] 0    0    [1    /1   ]  0.652987767014       1
[INPUT] 0    0    [1    /1   ]  117616.813797        1
[INPUT] 0    0    [1    /1   ]  2.86740259679        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031063        1
[INPUT] 0    0    [1    /1   ]  147020.991877        1
[INPUT] 0    0    [1    /1   ]  73510.419844         1
[INPUT] 0    0    [1    /1   ]  36754.7139798        1
[INPUT] 0    0    [1    /1   ]  7303.09428591        1
[INPUT] 0    0    [1    /1   ]  18375.7971732        1
[INPUT] 0    0    [1    /1   ]  1449.15644134        1
[INPUT] 0    0    [1    /1   ]  375.190795689        1
[INPUT] 0    0    [1    /1   ]  120.612138652        1
[INPUT] 0    0    [1    /1   ]  46.005875478         1
[INPUT] 0    0    [1    /1   ]  20.2274618584        1
[INPUT] 0    0    [1    /1   ]  6.98414216211        1
[INPUT] 1    0    [1    /1   ]  8.60445257169        1
[INPUT] 1    0    [1    /1   ]  0.492725775974       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2482042190240845, 1.0]], [0, [0.6529877670137604, 1.0]], [0, [117616.81379734965, 1.0]], [0, [2.8674025967936174, 1.0]], [0, [1176168.142616897, 1.0]], [0, [588084.0699805822, 1.0]], [0, [294042.03106273134, 1.0]], [0, [147020.99187659833, 1.0]], [0, [73510.41984395111, 1.0]], [0, [36754.71397976107, 1.0]], [0, [7303.0942859132, 1.0]], [0, [18375.797173198865, 1.0]], [0, [1449.156441341833, 1.0]], [0, [375.1907956893383, 1.0]], [0, [120.6121386519956, 1.0]], [0, [46.005875477960444, 1.0]], [0, [20.227461858448205, 1.0]], [0, [6.984142162105325, 1.0]], [1, [8.604452571694113, 1.0]], [1, [0.4927257759738049, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24820422]
bas 1, expnt(s) = [0.65298777]
bas 2, expnt(s) = [117616.81379735]
bas 3, expnt(s) = [2.8674026]
bas 4, expnt(s) = [1176168.1426169]
bas 5, expnt(s) = [588084.06998058]
bas 6, expnt(s) = [294042.03106273]
bas 7, expnt(s) = [147020.9918766]
bas 8, expnt(s) = [73510.41984395]
bas 9, expnt(s) = [36754.71397976]
bas 10, expnt(s) = [7303.09428591]
bas 11, expnt(s) = [18375.7971732]
bas 12, expnt(s) = [1449.15644134]
bas 13, expnt(s) = [375.19079569]
bas 14, expnt(s) = [120.61213865]
bas 15, expnt(s) = [46.00587548]
bas 16, expnt(s) = [20.22746186]
bas 17, expnt(s) = [6.98414216]
bas 18, expnt(s) = [8.60445257]
bas 19, expnt(s) = [0.49272578]
CPU time:       836.60
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48204219e-01 8.88427297e-01 6.52987767e-01 1.83524398e+00
 1.17616814e+05 1.60460109e+04 2.86740260e+00 5.56713214e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791586e+04 3.67547140e+04 6.70655993e+03
 7.30309429e+03 1.99592954e+03 1.83757972e+04 3.98749054e+03
 1.44915644e+03 5.93405378e+02 3.75190796e+02 2.15379397e+02
 1.20612139e+02 9.19513877e+01 4.60058755e+01 4.46298060e+01
 2.02274619e+01 2.40974489e+01 6.98414216e+00 1.08542502e+01
 8.60445257e+00 4.29920792e+01 4.92725776e-01 1.20431749e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335958618280742
cond(S) = 909239.6803494168
E1 = -689.5983719385422  E_coul = 184.96919143603003
init E= -504.629180502512
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.67224207109539  LUMO = 0.685683917710044
  mo_energy =
[-1.21707551e+02 -1.33861937e+01 -7.62377771e+00 -7.62377771e+00
 -7.62377771e+00 -1.65735419e+00 -6.72242071e-01 -6.72242071e-01
 -6.72242071e-01  6.85683918e-01  9.12295440e+00  5.14619122e+01
  2.01147337e+02  7.25850521e+02  2.86842402e+03  1.23349123e+04
  4.09478185e+04  1.04986810e+05  2.30167284e+05  4.55980131e+05
  8.44930820e+05  1.52810658e+06  2.85037213e+06  5.80825705e+06]
E1 = -707.737840299613  E_coul = 199.77091170173478
cycle= 1 E= -507.966928597878  delta_E= -3.34  |g|= 0.451  |ddm|= 0.501
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.704866
diis-c [-0.49683641  1.        ]
  HOMO = -0.217814055086144  LUMO = 1.07247610160817
  mo_energy =
[-1.20199001e+02 -1.23053351e+01 -6.59495087e+00 -6.59495087e+00
 -6.59495087e+00 -1.16328605e+00 -2.17814055e-01 -2.17814055e-01
 -2.17814055e-01  1.07247610e+00  9.94966340e+00  5.26733519e+01
  2.02576501e+02  7.27341519e+02  2.86985575e+03  1.23362349e+04
  4.09490743e+04  1.04988029e+05  2.30168479e+05  4.55981309e+05
  8.44931985e+05  1.52810773e+06  2.85037327e+06  5.80825819e+06]
E1 = -706.7942265186084  E_coul = 198.80970903927218
cycle= 2 E= -507.984517479336  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.43
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297134
diis-c [-8.82239841e-04  1.14110831e-03  9.98858892e-01]
  HOMO = -0.239698553044598  LUMO = 1.0668139291678
  mo_energy =
[-1.20312297e+02 -1.23719578e+01 -6.66875084e+00 -6.66875084e+00
 -6.66875084e+00 -1.17736363e+00 -2.39698553e-01 -2.39698553e-01
 -2.39698553e-01  1.06681393e+00  9.90651157e+00  5.25968302e+01
  2.02476967e+02  7.27224243e+02  2.86972270e+03  1.23360915e+04
  4.09489271e+04  1.04987881e+05  2.30168329e+05  4.55981159e+05
  8.44931834e+05  1.52810758e+06  2.85037312e+06  5.80825804e+06]
E1 = -706.6880428969756  E_coul = 198.7032701883044
cycle= 3 E= -507.984772708671  delta_E= -0.000255  |g|= 0.00439  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324678
diis-c [-2.20786365e-06 -2.01637745e-05 -1.07752536e-01  1.10777270e+00]
  HOMO = -0.242852013855432  LUMO = 1.06576442988119
  mo_energy =
[-1.20324298e+02 -1.23806190e+01 -6.67791831e+00 -6.67791831e+00
 -6.67791831e+00 -1.17927319e+00 -2.42852014e-01 -2.42852014e-01
 -2.42852014e-01  1.06576443e+00  9.90041302e+00  5.25875102e+01
  2.02465912e+02  7.27212078e+02  2.86970969e+03  1.23360780e+04
  4.09489134e+04  1.04987867e+05  2.30168315e+05  4.55981145e+05
  8.44931821e+05  1.52810757e+06  2.85037311e+06  5.80825802e+06]
E1 = -706.672890164436  E_coul = 198.6881126430015
cycle= 4 E= -507.984777521435  delta_E= -4.81e-06  |g|= 0.000202  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141274
diis-c [-1.45018435e-10 -7.74341394e-06  7.18429592e-03 -9.85861367e-02
  1.09140958e+00]
  HOMO = -0.242989130309496  LUMO = 1.06571161289244
  mo_energy =
[-1.20324639e+02 -1.23809491e+01 -6.67824559e+00 -6.67824559e+00
 -6.67824559e+00 -1.17935490e+00 -2.42989130e-01 -2.42989130e-01
 -2.42989130e-01  1.06571161e+00  9.90015684e+00  5.25871864e+01
  2.02465575e+02  7.27211737e+02  2.86970935e+03  1.23360777e+04
  4.09489131e+04  1.04987867e+05  2.30168315e+05  4.55981145e+05
  8.44931820e+05  1.52810757e+06  2.85037311e+06  5.80825802e+06]
E1 = -706.6722394647306  E_coul = 198.6874619335603
cycle= 5 E= -507.98477753117  delta_E= -9.74e-09  |g|= 1.28e-06  |ddm|= 0.000461
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.01041e-07
diis-c [-7.84446285e-14  2.32806551e-07 -1.65363453e-04  2.06496380e-03
 -2.45339978e-02  1.02263416e+00]
  HOMO = -0.242989879043138  LUMO = 1.06571148454025
  mo_energy =
[-1.20324641e+02 -1.23809509e+01 -6.67824743e+00 -6.67824743e+00
 -6.67824743e+00 -1.17935549e+00 -2.42989879e-01 -2.42989879e-01
 -2.42989879e-01  1.06571148e+00  9.90015546e+00  5.25871845e+01
  2.02465572e+02  7.27211734e+02  2.86970934e+03  1.23360776e+04
  4.09489131e+04  1.04987867e+05  2.30168315e+05  4.55981145e+05
  8.44931820e+05  1.52810757e+06  2.85037311e+06  5.80825802e+06]
E1 = -706.6722356244478  E_coul = 198.68745809327723
cycle= 6 E= -507.984777531171  delta_E= -2.27e-13  |g|= 3.92e-08  |ddm|= 2.85e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6722356244478  E_coul = 198.68745809327723
  HOMO = -0.242989898945237  LUMO = 1.06571147195571
  mo_energy =
[-1.20324641e+02 -1.23809510e+01 -6.67824747e+00 -6.67824747e+00
 -6.67824747e+00 -1.17935550e+00 -2.42989899e-01 -2.42989899e-01
 -2.42989899e-01  1.06571147e+00  9.90015543e+00  5.25871845e+01
  2.02465572e+02  7.27211734e+02  2.86970934e+03  1.23360776e+04
  4.09489131e+04  1.04987867e+05  2.30168315e+05  4.55981145e+05
  8.44931820e+05  1.52810757e+06  2.85037311e+06  5.80825802e+06]
E1 = -706.6722355354091  E_coul = 198.6874580042384
Extra cycle  E= -507.984777531171  delta_E= -5.68e-14  |g|= 4.57e-09  |ddm|= 7.45e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.48204219e-01 6.52987767e-01 1.17616814e+05 2.86740260e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547140e+04 7.30309429e+03 1.83757972e+04
 1.44915644e+03 3.75190796e+02 1.20612139e+02 4.60058755e+01
 2.02274619e+01 6.98414216e+00 8.60445257e+00 4.92725776e-01]
E = -507.98477753117066
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:14:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248204219024       1
[INPUT] 0    0    [1    /1   ]  0.652987767014       1
[INPUT] 0    0    [1    /1   ]  117616.813797        1
[INPUT] 0    0    [1    /1   ]  2.86740259679        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031063        1
[INPUT] 0    0    [1    /1   ]  147020.991877        1
[INPUT] 0    0    [1    /1   ]  73510.419844         1
[INPUT] 0    0    [1    /1   ]  36754.7139798        1
[INPUT] 0    0    [1    /1   ]  7303.09428591        1
[INPUT] 0    0    [1    /1   ]  18375.7971732        1
[INPUT] 0    0    [1    /1   ]  1449.15644134        1
[INPUT] 0    0    [1    /1   ]  375.190795689        1
[INPUT] 0    0    [1    /1   ]  120.612138652        1
[INPUT] 0    0    [1    /1   ]  46.005875478         1
[INPUT] 0    0    [1    /1   ]  20.2274618584        1
[INPUT] 0    0    [1    /1   ]  6.98414216211        1
[INPUT] 1    0    [1    /1   ]  8.60445257169        1
[INPUT] 1    0    [1    /1   ]  0.492725775974       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2482042190240845, 1.0]], [0, [0.6529877670137604, 1.0]], [0, [117616.81379734965, 1.0]], [0, [2.8674025967936174, 1.0]], [0, [1176168.142616897, 1.0]], [0, [588084.0699805822, 1.0]], [0, [294042.03106273134, 1.0]], [0, [147020.99187659833, 1.0]], [0, [73510.41984395111, 1.0]], [0, [36754.71397976107, 1.0]], [0, [7303.0942859132, 1.0]], [0, [18375.797173198865, 1.0]], [0, [1449.156441341833, 1.0]], [0, [375.1907956893383, 1.0]], [0, [120.6121386519956, 1.0]], [0, [46.005875477960444, 1.0]], [0, [20.227461858448205, 1.0]], [0, [6.984142162105325, 1.0]], [1, [8.604452571694113, 1.0]], [1, [0.4927257759738049, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24820422]
bas 1, expnt(s) = [0.65298777]
bas 2, expnt(s) = [117616.81379735]
bas 3, expnt(s) = [2.8674026]
bas 4, expnt(s) = [1176168.1426169]
bas 5, expnt(s) = [588084.06998058]
bas 6, expnt(s) = [294042.03106273]
bas 7, expnt(s) = [147020.9918766]
bas 8, expnt(s) = [73510.41984395]
bas 9, expnt(s) = [36754.71397976]
bas 10, expnt(s) = [7303.09428591]
bas 11, expnt(s) = [18375.7971732]
bas 12, expnt(s) = [1449.15644134]
bas 13, expnt(s) = [375.19079569]
bas 14, expnt(s) = [120.61213865]
bas 15, expnt(s) = [46.00587548]
bas 16, expnt(s) = [20.22746186]
bas 17, expnt(s) = [6.98414216]
bas 18, expnt(s) = [8.60445257]
bas 19, expnt(s) = [0.49272578]
CPU time:       838.09
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48204219e-01 8.88427297e-01 6.52987767e-01 1.83524398e+00
 1.17616814e+05 1.60460109e+04 2.86740260e+00 5.56713214e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791586e+04 3.67547140e+04 6.70655993e+03
 7.30309429e+03 1.99592954e+03 1.83757972e+04 3.98749054e+03
 1.44915644e+03 5.93405378e+02 3.75190796e+02 2.15379397e+02
 1.20612139e+02 9.19513877e+01 4.60058755e+01 4.46298060e+01
 2.02274619e+01 2.40974489e+01 6.98414216e+00 1.08542502e+01
 8.60445257e+00 4.29920792e+01 4.92725776e-01 1.20431749e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335958618280742
cond(S) = 909239.6803494168
E1 = -689.5983719385422  E_coul = 184.96919143603003
init E= -504.629180502512
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.67224207109539  LUMO = 0.685683917710044
  mo_energy =
[-1.21707551e+02 -1.33861937e+01 -7.62377771e+00 -7.62377771e+00
 -7.62377771e+00 -1.65735419e+00 -6.72242071e-01 -6.72242071e-01
 -6.72242071e-01  6.85683918e-01  9.12295440e+00  5.14619122e+01
  2.01147337e+02  7.25850521e+02  2.86842402e+03  1.23349123e+04
  4.09478185e+04  1.04986810e+05  2.30167284e+05  4.55980131e+05
  8.44930820e+05  1.52810658e+06  2.85037213e+06  5.80825705e+06]
E1 = -707.737840299613  E_coul = 199.77091170173478
cycle= 1 E= -507.966928597878  delta_E= -3.34  |g|= 0.451  |ddm|= 0.501
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.704866
diis-c [-0.49683641  1.        ]
  HOMO = -0.217814055086144  LUMO = 1.07247610160817
  mo_energy =
[-1.20199001e+02 -1.23053351e+01 -6.59495087e+00 -6.59495087e+00
 -6.59495087e+00 -1.16328605e+00 -2.17814055e-01 -2.17814055e-01
 -2.17814055e-01  1.07247610e+00  9.94966340e+00  5.26733519e+01
  2.02576501e+02  7.27341519e+02  2.86985575e+03  1.23362349e+04
  4.09490743e+04  1.04988029e+05  2.30168479e+05  4.55981309e+05
  8.44931985e+05  1.52810773e+06  2.85037327e+06  5.80825819e+06]
E1 = -706.7942265186084  E_coul = 198.80970903927218
cycle= 2 E= -507.984517479336  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.43
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297134
diis-c [-8.82239841e-04  1.14110831e-03  9.98858892e-01]
  HOMO = -0.239698553044598  LUMO = 1.0668139291678
  mo_energy =
[-1.20312297e+02 -1.23719578e+01 -6.66875084e+00 -6.66875084e+00
 -6.66875084e+00 -1.17736363e+00 -2.39698553e-01 -2.39698553e-01
 -2.39698553e-01  1.06681393e+00  9.90651157e+00  5.25968302e+01
  2.02476967e+02  7.27224243e+02  2.86972270e+03  1.23360915e+04
  4.09489271e+04  1.04987881e+05  2.30168329e+05  4.55981159e+05
  8.44931834e+05  1.52810758e+06  2.85037312e+06  5.80825804e+06]
E1 = -706.6880428969756  E_coul = 198.7032701883044
cycle= 3 E= -507.984772708671  delta_E= -0.000255  |g|= 0.00439  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324678
diis-c [-2.20786365e-06 -2.01637745e-05 -1.07752536e-01  1.10777270e+00]
  HOMO = -0.242852013855432  LUMO = 1.06576442988119
  mo_energy =
[-1.20324298e+02 -1.23806190e+01 -6.67791831e+00 -6.67791831e+00
 -6.67791831e+00 -1.17927319e+00 -2.42852014e-01 -2.42852014e-01
 -2.42852014e-01  1.06576443e+00  9.90041302e+00  5.25875102e+01
  2.02465912e+02  7.27212078e+02  2.86970969e+03  1.23360780e+04
  4.09489134e+04  1.04987867e+05  2.30168315e+05  4.55981145e+05
  8.44931821e+05  1.52810757e+06  2.85037311e+06  5.80825802e+06]
E1 = -706.672890164436  E_coul = 198.6881126430015
cycle= 4 E= -507.984777521435  delta_E= -4.81e-06  |g|= 0.000202  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141274
diis-c [-1.45018435e-10 -7.74341394e-06  7.18429592e-03 -9.85861367e-02
  1.09140958e+00]
  HOMO = -0.242989130309496  LUMO = 1.06571161289244
  mo_energy =
[-1.20324639e+02 -1.23809491e+01 -6.67824559e+00 -6.67824559e+00
 -6.67824559e+00 -1.17935490e+00 -2.42989130e-01 -2.42989130e-01
 -2.42989130e-01  1.06571161e+00  9.90015684e+00  5.25871864e+01
  2.02465575e+02  7.27211737e+02  2.86970935e+03  1.23360777e+04
  4.09489131e+04  1.04987867e+05  2.30168315e+05  4.55981145e+05
  8.44931820e+05  1.52810757e+06  2.85037311e+06  5.80825802e+06]
E1 = -706.6722394647306  E_coul = 198.6874619335603
cycle= 5 E= -507.98477753117  delta_E= -9.74e-09  |g|= 1.28e-06  |ddm|= 0.000461
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.01041e-07
diis-c [-7.84446285e-14  2.32806551e-07 -1.65363453e-04  2.06496380e-03
 -2.45339978e-02  1.02263416e+00]
  HOMO = -0.242989879043138  LUMO = 1.06571148454025
  mo_energy =
[-1.20324641e+02 -1.23809509e+01 -6.67824743e+00 -6.67824743e+00
 -6.67824743e+00 -1.17935549e+00 -2.42989879e-01 -2.42989879e-01
 -2.42989879e-01  1.06571148e+00  9.90015546e+00  5.25871845e+01
  2.02465572e+02  7.27211734e+02  2.86970934e+03  1.23360776e+04
  4.09489131e+04  1.04987867e+05  2.30168315e+05  4.55981145e+05
  8.44931820e+05  1.52810757e+06  2.85037311e+06  5.80825802e+06]
E1 = -706.6722356244478  E_coul = 198.68745809327723
cycle= 6 E= -507.984777531171  delta_E= -2.27e-13  |g|= 3.92e-08  |ddm|= 2.85e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6722356244478  E_coul = 198.68745809327723
  HOMO = -0.242989898945237  LUMO = 1.06571147195571
  mo_energy =
[-1.20324641e+02 -1.23809510e+01 -6.67824747e+00 -6.67824747e+00
 -6.67824747e+00 -1.17935550e+00 -2.42989899e-01 -2.42989899e-01
 -2.42989899e-01  1.06571147e+00  9.90015543e+00  5.25871845e+01
  2.02465572e+02  7.27211734e+02  2.86970934e+03  1.23360776e+04
  4.09489131e+04  1.04987867e+05  2.30168315e+05  4.55981145e+05
  8.44931820e+05  1.52810757e+06  2.85037311e+06  5.80825802e+06]
E1 = -706.6722355354091  E_coul = 198.6874580042384
Extra cycle  E= -507.984777531171  delta_E= -5.68e-14  |g|= 4.57e-09  |ddm|= 7.45e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909239.6803494168
E1 = -706.6722355354091  E_coul = 198.6874580042384
init E= -507.984777531171
    CPU time for initialize scf      3.59 sec, wall time      0.23 sec
  HOMO = -0.242989901672351  LUMO = 1.06571147061933
  mo_energy =
[-1.20324641e+02 -1.23809510e+01 -6.67824748e+00 -6.67824748e+00
 -6.67824748e+00 -1.17935550e+00 -2.42989902e-01 -2.42989902e-01
 -2.42989902e-01  1.06571147e+00  9.90015542e+00  5.25871845e+01
  2.02465572e+02  7.27211734e+02  2.86970934e+03  1.23360776e+04
  4.09489131e+04  1.04987867e+05  2.30168315e+05  4.55981145e+05
  8.44931820e+05  1.52810757e+06  2.85037311e+06  5.80825802e+06]
E1 = -706.6722355244491  E_coul = 198.68745799327803
cycle= 1 E= -507.984777531171  delta_E= -3.98e-13  |g|= 2.06e-09  |ddm|= 8.13e-09
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.6722355244491  E_coul = 198.68745799327803
  HOMO = -0.242989902003238  LUMO = 1.06571147110144
  mo_energy =
[-1.20324641e+02 -1.23809510e+01 -6.67824748e+00 -6.67824748e+00
 -6.67824748e+00 -1.17935550e+00 -2.42989902e-01 -2.42989902e-01
 -2.42989902e-01  1.06571147e+00  9.90015542e+00  5.25871844e+01
  2.02465572e+02  7.27211734e+02  2.86970934e+03  1.23360776e+04
  4.09489131e+04  1.04987867e+05  2.30168315e+05  4.55981145e+05
  8.44931820e+05  1.52810757e+06  2.85037311e+06  5.80825802e+06]
E1 = -706.6722355198204  E_coul = 198.68745798865018
Extra cycle  E= -507.98477753117  delta_E= 7.96e-13  |g|= 1.06e-09  |ddm|= 2.99e-09
    CPU time for scf_cycle      4.04 sec, wall time      0.39 sec
exp = [2.48204219e-01 6.52987767e-01 1.17616814e+05 2.86740260e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547140e+04 7.30309429e+03 1.83757972e+04
 1.44915644e+03 3.75190796e+02 1.20612139e+02 4.60058755e+01
 2.02274619e+01 6.98414216e+00 8.60445257e+00 4.92725776e-01]
grad_E = [-3.30966387e-05  2.21134398e-04  3.83134635e-09 -2.13771857e-04
  1.45757513e-11  1.01388987e-10  5.96336573e-10  2.33498423e-09
  9.68775419e-09  5.25179049e-08  3.26436794e-06  1.08985839e-07
  2.29589731e-05 -1.67311847e-04 -1.29059439e-04 -1.58010989e-04
  2.05318217e-04 -5.30687802e-05  2.43516379e-04 -1.75092051e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:14:19 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248261401655       1
[INPUT] 0    0    [1    /1   ]  0.653004408298       1
[INPUT] 0    0    [1    /1   ]  117616.813797        1
[INPUT] 0    0    [1    /1   ]  2.8684914728         1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031063        1
[INPUT] 0    0    [1    /1   ]  147020.991876        1
[INPUT] 0    0    [1    /1   ]  73510.4198433        1
[INPUT] 0    0    [1    /1   ]  36754.7139763        1
[INPUT] 0    0    [1    /1   ]  7303.0940683         1
[INPUT] 0    0    [1    /1   ]  18375.7971657        1
[INPUT] 0    0    [1    /1   ]  1449.15650656        1
[INPUT] 0    0    [1    /1   ]  375.187370347        1
[INPUT] 0    0    [1    /1   ]  120.643760732        1
[INPUT] 0    0    [1    /1   ]  46.0159404225        1
[INPUT] 0    0    [1    /1   ]  20.2449315082        1
[INPUT] 0    0    [1    /1   ]  6.9844733986         1
[INPUT] 1    0    [1    /1   ]  8.60505898139        1
[INPUT] 1    0    [1    /1   ]  0.492737895012       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24826140165503963, 1.0]], [0, [0.6530044082983002, 1.0]], [0, [117616.81379709608, 1.0]], [0, [2.868491472797705, 1.0]], [0, [1176168.1426168957, 1.0]], [0, [588084.0699805754, 1.0]], [0, [294042.0310626919, 1.0]], [0, [147020.99187644353, 1.0]], [0, [73510.41984330765, 1.0]], [0, [36754.71397631152, 1.0]], [0, [7303.094068300288, 1.0]], [0, [18375.79716566666, 1.0]], [0, [1449.1565065600807, 1.0]], [0, [375.1873703467987, 1.0]], [0, [120.64376073166217, 1.0]], [0, [46.015940422512315, 1.0]], [0, [20.244931508197492, 1.0]], [0, [6.984473398599998, 1.0]], [1, [8.605058981389458, 1.0]], [1, [0.4927378950120409, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2482614]
bas 1, expnt(s) = [0.65300441]
bas 2, expnt(s) = [117616.8137971]
bas 3, expnt(s) = [2.86849147]
bas 4, expnt(s) = [1176168.1426169]
bas 5, expnt(s) = [588084.06998058]
bas 6, expnt(s) = [294042.03106269]
bas 7, expnt(s) = [147020.99187644]
bas 8, expnt(s) = [73510.41984331]
bas 9, expnt(s) = [36754.71397631]
bas 10, expnt(s) = [7303.0940683]
bas 11, expnt(s) = [18375.79716567]
bas 12, expnt(s) = [1449.15650656]
bas 13, expnt(s) = [375.18737035]
bas 14, expnt(s) = [120.64376073]
bas 15, expnt(s) = [46.01594042]
bas 16, expnt(s) = [20.24493151]
bas 17, expnt(s) = [6.9844734]
bas 18, expnt(s) = [8.60505898]
bas 19, expnt(s) = [0.4927379]
CPU time:       850.08
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48261402e-01 8.88580803e-01 6.53004408e-01 1.83527906e+00
 1.17616814e+05 1.60460109e+04 2.86849147e+00 5.56871763e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791586e+04 3.67547140e+04 6.70655993e+03
 7.30309407e+03 1.99592949e+03 1.83757972e+04 3.98749054e+03
 1.44915651e+03 5.93405398e+02 3.75187370e+02 2.15377922e+02
 1.20643761e+02 9.19694680e+01 4.60159404e+01 4.46371287e+01
 2.02449315e+01 2.41130562e+01 6.98447340e+00 1.08546363e+01
 8.60505898e+00 4.29958666e+01 4.92737895e-01 1.20435452e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335939466874354
cond(S) = 909241.9756320984
E1 = -689.6015107565307  E_coul = 184.9722487799458
init E= -504.629261976585
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.67223543480559  LUMO = 0.68592940998885
  mo_energy =
[-1.21706950e+02 -1.33859528e+01 -7.62356518e+00 -7.62356518e+00
 -7.62356518e+00 -1.65733305e+00 -6.72235435e-01 -6.72235435e-01
 -6.72235435e-01  6.85929410e-01  9.12683258e+00  5.14921931e+01
  2.01246596e+02  7.26035095e+02  2.86863476e+03  1.23351054e+04
  4.09479984e+04  1.04986983e+05  2.30167452e+05  4.55980295e+05
  8.44930982e+05  1.52810674e+06  2.85037229e+06  5.80825720e+06]
E1 = -707.7414455073095  E_coul = 199.77451684149298
cycle= 1 E= -507.966928665817  delta_E= -3.34  |g|= 0.451  |ddm|= 0.501
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.704888
diis-c [-0.49686711  1.        ]
  HOMO = -0.217786206928712  LUMO = 1.0727786713053
  mo_energy =
[-1.20198349e+02 -1.23050606e+01 -6.59469802e+00 -6.59469802e+00
 -6.59469802e+00 -1.16325228e+00 -2.17786207e-01 -2.17786207e-01
 -2.17786207e-01  1.07277867e+00  9.95369320e+00  5.27038274e+01
  2.02675857e+02  7.27526144e+02  2.87006655e+03  1.23364280e+04
  4.09492542e+04  1.04988202e+05  2.30168646e+05  4.55981473e+05
  8.44932146e+05  1.52810789e+06  2.85037343e+06  5.80825834e+06]
E1 = -706.7978012776326  E_coul = 198.81328251970933
cycle= 2 E= -507.984518757923  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.43
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297092
diis-c [-8.81976889e-04  1.15118938e-03  9.98848811e-01]
  HOMO = -0.239671465223191  LUMO = 1.06711441269361
  mo_energy =
[-1.20311649e+02 -1.23716842e+01 -6.66849968e+00 -6.66849968e+00
 -6.66849968e+00 -1.17732985e+00 -2.39671465e-01 -2.39671465e-01
 -2.39671465e-01  1.06711441e+00  9.91053098e+00  5.26272917e+01
  2.02576315e+02  7.27408863e+02  2.86993349e+03  1.23362847e+04
  4.09491070e+04  1.04988053e+05  2.30168497e+05  4.55981323e+05
  8.44931996e+05  1.52810774e+06  2.85037328e+06  5.80825819e+06]
E1 = -706.691619246759  E_coul = 198.706845263114
cycle= 3 E= -507.984773983645  delta_E= -0.000255  |g|= 0.00439  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324622
diis-c [-2.20690980e-06 -2.02904789e-05 -1.07750394e-01  1.10777068e+00]
  HOMO = -0.242825065623858  LUMO = 1.06606460518644
  mo_energy =
[-1.20323650e+02 -1.23803459e+01 -6.67766779e+00 -6.67766779e+00
 -6.67766779e+00 -1.17923944e+00 -2.42825066e-01 -2.42825066e-01
 -2.42825066e-01  1.06606461e+00  9.90443106e+00  5.26179700e+01
  2.02565257e+02  7.27396698e+02  2.86992048e+03  1.23362712e+04
  4.09490933e+04  1.04988040e+05  2.30168483e+05  4.55981309e+05
  8.44931982e+05  1.52810773e+06  2.85037326e+06  5.80825817e+06]
E1 = -706.6764664792677  E_coul = 198.69168768295722
cycle= 4 E= -507.98477879631  delta_E= -4.81e-06  |g|= 0.000202  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141244
diis-c [-1.44943451e-10 -7.73814430e-06  7.18480925e-03 -9.85895608e-02
  1.09141249e+00]
  HOMO = -0.242962181723416  LUMO = 1.06601177720391
  mo_energy =
[-1.20323991e+02 -1.23806760e+01 -6.67799510e+00 -6.67799510e+00
 -6.67799510e+00 -1.17932114e+00 -2.42962182e-01 -2.42962182e-01
 -2.42962182e-01  1.06601178e+00  9.90417484e+00  5.26176461e+01
  2.02564920e+02  7.27396356e+02  2.86992014e+03  1.23362708e+04
  4.09490930e+04  1.04988039e+05  2.30168483e+05  4.55981309e+05
  8.44931982e+05  1.52810773e+06  2.85037326e+06  5.80825817e+06]
E1 = -706.6758158076357  E_coul = 198.69103700159135
cycle= 5 E= -507.984778806044  delta_E= -9.73e-09  |g|= 1.27e-06  |ddm|= 0.000461
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.98989e-07
diis-c [-7.82996442e-14  2.28631393e-07 -1.64621832e-04  2.05563118e-03
 -2.44317881e-02  1.02254055e+00]
  HOMO = -0.242962929310442  LUMO = 1.06601164798632
  mo_energy =
[-1.20323993e+02 -1.23806778e+01 -6.67799693e+00 -6.67799693e+00
 -6.67799693e+00 -1.17932173e+00 -2.42962929e-01 -2.42962929e-01
 -2.42962929e-01  1.06601165e+00  9.90417347e+00  5.26176442e+01
  2.02564918e+02  7.27396353e+02  2.86992013e+03  1.23362708e+04
  4.09490930e+04  1.04988039e+05  2.30168483e+05  4.55981309e+05
  8.44931982e+05  1.52810773e+06  2.85037326e+06  5.80825817e+06]
E1 = -706.6758119760452  E_coul = 198.6910331700003
cycle= 6 E= -507.984778806045  delta_E= -5.68e-13  |g|= 3.97e-08  |ddm|= 2.84e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6758119760452  E_coul = 198.6910331700003
  HOMO = -0.242962949142138  LUMO = 1.06601163627028
  mo_energy =
[-1.20323993e+02 -1.23806778e+01 -6.67799698e+00 -6.67799698e+00
 -6.67799698e+00 -1.17932174e+00 -2.42962949e-01 -2.42962949e-01
 -2.42962949e-01  1.06601164e+00  9.90417343e+00  5.26176442e+01
  2.02564918e+02  7.27396353e+02  2.86992013e+03  1.23362708e+04
  4.09490930e+04  1.04988039e+05  2.30168483e+05  4.55981309e+05
  8.44931982e+05  1.52810773e+06  2.85037326e+06  5.80825817e+06]
E1 = -706.6758118856488  E_coul = 198.6910330796043
Extra cycle  E= -507.984778806045  delta_E= 3.41e-13  |g|= 4.97e-09  |ddm|= 7.52e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.29 sec
exp = [2.48261402e-01 6.53004408e-01 1.17616814e+05 2.86849147e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547140e+04 7.30309407e+03 1.83757972e+04
 1.44915651e+03 3.75187370e+02 1.20643761e+02 4.60159404e+01
 2.02449315e+01 6.98447340e+00 8.60505898e+00 4.92737895e-01]
E = -507.9847788060446
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:14:20 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248261401655       1
[INPUT] 0    0    [1    /1   ]  0.653004408298       1
[INPUT] 0    0    [1    /1   ]  117616.813797        1
[INPUT] 0    0    [1    /1   ]  2.8684914728         1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031063        1
[INPUT] 0    0    [1    /1   ]  147020.991876        1
[INPUT] 0    0    [1    /1   ]  73510.4198433        1
[INPUT] 0    0    [1    /1   ]  36754.7139763        1
[INPUT] 0    0    [1    /1   ]  7303.0940683         1
[INPUT] 0    0    [1    /1   ]  18375.7971657        1
[INPUT] 0    0    [1    /1   ]  1449.15650656        1
[INPUT] 0    0    [1    /1   ]  375.187370347        1
[INPUT] 0    0    [1    /1   ]  120.643760732        1
[INPUT] 0    0    [1    /1   ]  46.0159404225        1
[INPUT] 0    0    [1    /1   ]  20.2449315082        1
[INPUT] 0    0    [1    /1   ]  6.9844733986         1
[INPUT] 1    0    [1    /1   ]  8.60505898139        1
[INPUT] 1    0    [1    /1   ]  0.492737895012       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24826140165503963, 1.0]], [0, [0.6530044082983002, 1.0]], [0, [117616.81379709608, 1.0]], [0, [2.868491472797705, 1.0]], [0, [1176168.1426168957, 1.0]], [0, [588084.0699805754, 1.0]], [0, [294042.0310626919, 1.0]], [0, [147020.99187644353, 1.0]], [0, [73510.41984330765, 1.0]], [0, [36754.71397631152, 1.0]], [0, [7303.094068300288, 1.0]], [0, [18375.79716566666, 1.0]], [0, [1449.1565065600807, 1.0]], [0, [375.1873703467987, 1.0]], [0, [120.64376073166217, 1.0]], [0, [46.015940422512315, 1.0]], [0, [20.244931508197492, 1.0]], [0, [6.984473398599998, 1.0]], [1, [8.605058981389458, 1.0]], [1, [0.4927378950120409, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2482614]
bas 1, expnt(s) = [0.65300441]
bas 2, expnt(s) = [117616.8137971]
bas 3, expnt(s) = [2.86849147]
bas 4, expnt(s) = [1176168.1426169]
bas 5, expnt(s) = [588084.06998058]
bas 6, expnt(s) = [294042.03106269]
bas 7, expnt(s) = [147020.99187644]
bas 8, expnt(s) = [73510.41984331]
bas 9, expnt(s) = [36754.71397631]
bas 10, expnt(s) = [7303.0940683]
bas 11, expnt(s) = [18375.79716567]
bas 12, expnt(s) = [1449.15650656]
bas 13, expnt(s) = [375.18737035]
bas 14, expnt(s) = [120.64376073]
bas 15, expnt(s) = [46.01594042]
bas 16, expnt(s) = [20.24493151]
bas 17, expnt(s) = [6.9844734]
bas 18, expnt(s) = [8.60505898]
bas 19, expnt(s) = [0.4927379]
CPU time:       851.65
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48261402e-01 8.88580803e-01 6.53004408e-01 1.83527906e+00
 1.17616814e+05 1.60460109e+04 2.86849147e+00 5.56871763e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791586e+04 3.67547140e+04 6.70655993e+03
 7.30309407e+03 1.99592949e+03 1.83757972e+04 3.98749054e+03
 1.44915651e+03 5.93405398e+02 3.75187370e+02 2.15377922e+02
 1.20643761e+02 9.19694680e+01 4.60159404e+01 4.46371287e+01
 2.02449315e+01 2.41130562e+01 6.98447340e+00 1.08546363e+01
 8.60505898e+00 4.29958666e+01 4.92737895e-01 1.20435452e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335939466874354
cond(S) = 909241.9756320984
E1 = -689.6015107565307  E_coul = 184.9722487799458
init E= -504.629261976585
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.67223543480559  LUMO = 0.68592940998885
  mo_energy =
[-1.21706950e+02 -1.33859528e+01 -7.62356518e+00 -7.62356518e+00
 -7.62356518e+00 -1.65733305e+00 -6.72235435e-01 -6.72235435e-01
 -6.72235435e-01  6.85929410e-01  9.12683258e+00  5.14921931e+01
  2.01246596e+02  7.26035095e+02  2.86863476e+03  1.23351054e+04
  4.09479984e+04  1.04986983e+05  2.30167452e+05  4.55980295e+05
  8.44930982e+05  1.52810674e+06  2.85037229e+06  5.80825720e+06]
E1 = -707.7414455073095  E_coul = 199.77451684149298
cycle= 1 E= -507.966928665817  delta_E= -3.34  |g|= 0.451  |ddm|= 0.501
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.704888
diis-c [-0.49686711  1.        ]
  HOMO = -0.217786206928712  LUMO = 1.0727786713053
  mo_energy =
[-1.20198349e+02 -1.23050606e+01 -6.59469802e+00 -6.59469802e+00
 -6.59469802e+00 -1.16325228e+00 -2.17786207e-01 -2.17786207e-01
 -2.17786207e-01  1.07277867e+00  9.95369320e+00  5.27038274e+01
  2.02675857e+02  7.27526144e+02  2.87006655e+03  1.23364280e+04
  4.09492542e+04  1.04988202e+05  2.30168646e+05  4.55981473e+05
  8.44932146e+05  1.52810789e+06  2.85037343e+06  5.80825834e+06]
E1 = -706.7978012776326  E_coul = 198.81328251970933
cycle= 2 E= -507.984518757923  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.43
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297092
diis-c [-8.81976889e-04  1.15118938e-03  9.98848811e-01]
  HOMO = -0.239671465223191  LUMO = 1.06711441269361
  mo_energy =
[-1.20311649e+02 -1.23716842e+01 -6.66849968e+00 -6.66849968e+00
 -6.66849968e+00 -1.17732985e+00 -2.39671465e-01 -2.39671465e-01
 -2.39671465e-01  1.06711441e+00  9.91053098e+00  5.26272917e+01
  2.02576315e+02  7.27408863e+02  2.86993349e+03  1.23362847e+04
  4.09491070e+04  1.04988053e+05  2.30168497e+05  4.55981323e+05
  8.44931996e+05  1.52810774e+06  2.85037328e+06  5.80825819e+06]
E1 = -706.691619246759  E_coul = 198.706845263114
cycle= 3 E= -507.984773983645  delta_E= -0.000255  |g|= 0.00439  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324622
diis-c [-2.20690980e-06 -2.02904789e-05 -1.07750394e-01  1.10777068e+00]
  HOMO = -0.242825065623858  LUMO = 1.06606460518644
  mo_energy =
[-1.20323650e+02 -1.23803459e+01 -6.67766779e+00 -6.67766779e+00
 -6.67766779e+00 -1.17923944e+00 -2.42825066e-01 -2.42825066e-01
 -2.42825066e-01  1.06606461e+00  9.90443106e+00  5.26179700e+01
  2.02565257e+02  7.27396698e+02  2.86992048e+03  1.23362712e+04
  4.09490933e+04  1.04988040e+05  2.30168483e+05  4.55981309e+05
  8.44931982e+05  1.52810773e+06  2.85037326e+06  5.80825817e+06]
E1 = -706.6764664792677  E_coul = 198.69168768295722
cycle= 4 E= -507.98477879631  delta_E= -4.81e-06  |g|= 0.000202  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141244
diis-c [-1.44943451e-10 -7.73814430e-06  7.18480925e-03 -9.85895608e-02
  1.09141249e+00]
  HOMO = -0.242962181723416  LUMO = 1.06601177720391
  mo_energy =
[-1.20323991e+02 -1.23806760e+01 -6.67799510e+00 -6.67799510e+00
 -6.67799510e+00 -1.17932114e+00 -2.42962182e-01 -2.42962182e-01
 -2.42962182e-01  1.06601178e+00  9.90417484e+00  5.26176461e+01
  2.02564920e+02  7.27396356e+02  2.86992014e+03  1.23362708e+04
  4.09490930e+04  1.04988039e+05  2.30168483e+05  4.55981309e+05
  8.44931982e+05  1.52810773e+06  2.85037326e+06  5.80825817e+06]
E1 = -706.6758158076357  E_coul = 198.69103700159135
cycle= 5 E= -507.984778806044  delta_E= -9.73e-09  |g|= 1.27e-06  |ddm|= 0.000461
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.98989e-07
diis-c [-7.82996442e-14  2.28631393e-07 -1.64621832e-04  2.05563118e-03
 -2.44317881e-02  1.02254055e+00]
  HOMO = -0.242962929310442  LUMO = 1.06601164798632
  mo_energy =
[-1.20323993e+02 -1.23806778e+01 -6.67799693e+00 -6.67799693e+00
 -6.67799693e+00 -1.17932173e+00 -2.42962929e-01 -2.42962929e-01
 -2.42962929e-01  1.06601165e+00  9.90417347e+00  5.26176442e+01
  2.02564918e+02  7.27396353e+02  2.86992013e+03  1.23362708e+04
  4.09490930e+04  1.04988039e+05  2.30168483e+05  4.55981309e+05
  8.44931982e+05  1.52810773e+06  2.85037326e+06  5.80825817e+06]
E1 = -706.6758119760452  E_coul = 198.6910331700003
cycle= 6 E= -507.984778806045  delta_E= -5.68e-13  |g|= 3.97e-08  |ddm|= 2.84e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6758119760452  E_coul = 198.6910331700003
  HOMO = -0.242962949142138  LUMO = 1.06601163627028
  mo_energy =
[-1.20323993e+02 -1.23806778e+01 -6.67799698e+00 -6.67799698e+00
 -6.67799698e+00 -1.17932174e+00 -2.42962949e-01 -2.42962949e-01
 -2.42962949e-01  1.06601164e+00  9.90417343e+00  5.26176442e+01
  2.02564918e+02  7.27396353e+02  2.86992013e+03  1.23362708e+04
  4.09490930e+04  1.04988039e+05  2.30168483e+05  4.55981309e+05
  8.44931982e+05  1.52810773e+06  2.85037326e+06  5.80825817e+06]
E1 = -706.6758118856488  E_coul = 198.6910330796043
Extra cycle  E= -507.984778806045  delta_E= 3.41e-13  |g|= 4.97e-09  |ddm|= 7.52e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909241.9756320984
E1 = -706.6758118856488  E_coul = 198.6910330796043
init E= -507.984778806045
    CPU time for initialize scf      3.59 sec, wall time      0.23 sec
  HOMO = -0.242962951903927  LUMO = 1.0660116362386
  mo_energy =
[-1.20323993e+02 -1.23806778e+01 -6.67799698e+00 -6.67799698e+00
 -6.67799698e+00 -1.17932175e+00 -2.42962952e-01 -2.42962952e-01
 -2.42962952e-01  1.06601164e+00  9.90417343e+00  5.26176442e+01
  2.02564918e+02  7.27396353e+02  2.86992013e+03  1.23362708e+04
  4.09490930e+04  1.04988039e+05  2.30168483e+05  4.55981309e+05
  8.44931982e+05  1.52810773e+06  2.85037326e+06  5.80825817e+06]
E1 = -706.6758118742896  E_coul = 198.69103306824522
cycle= 1 E= -507.984778806044  delta_E= 2.27e-13  |g|= 4.33e-09  |ddm|= 8.52e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6758118742896  E_coul = 198.69103306824522
  HOMO = -0.242962952255467  LUMO = 1.06601163432252
  mo_energy =
[-1.20323993e+02 -1.23806778e+01 -6.67799698e+00 -6.67799698e+00
 -6.67799698e+00 -1.17932175e+00 -2.42962952e-01 -2.42962952e-01
 -2.42962952e-01  1.06601163e+00  9.90417343e+00  5.26176442e+01
  2.02564918e+02  7.27396353e+02  2.86992013e+03  1.23362708e+04
  4.09490930e+04  1.04988039e+05  2.30168483e+05  4.55981309e+05
  8.44931982e+05  1.52810773e+06  2.85037326e+06  5.80825817e+06]
E1 = -706.6758118711042  E_coul = 198.69103306505954
Extra cycle  E= -507.984778806045  delta_E= -3.41e-13  |g|= 7.54e-10  |ddm|= 2.08e-09
    CPU time for scf_cycle      4.04 sec, wall time      0.39 sec
exp = [2.48261402e-01 6.53004408e-01 1.17616814e+05 2.86849147e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547140e+04 7.30309407e+03 1.83757972e+04
 1.44915651e+03 3.75187370e+02 1.20643761e+02 4.60159404e+01
 2.02449315e+01 6.98447340e+00 8.60505898e+00 4.92737895e-01]
grad_E = [ 3.29020495e-05  2.04706890e-04  3.82587519e-09 -1.56966819e-04
  1.45099027e-11  1.01211834e-10  5.95487702e-10  2.33160486e-09
  9.67352316e-09  5.24473857e-08  3.25926814e-06  1.08775390e-07
  2.32427160e-05 -1.70381843e-04 -1.18564195e-04 -1.69813497e-04
  2.10614991e-04 -7.48865742e-05  7.40514954e-04 -1.64579658e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:14:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.24833731279        1
[INPUT] 0    0    [1    /1   ]  0.653014235978       1
[INPUT] 0    0    [1    /1   ]  117616.813797        1
[INPUT] 0    0    [1    /1   ]  2.87003588673        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031063        1
[INPUT] 0    0    [1    /1   ]  147020.991876        1
[INPUT] 0    0    [1    /1   ]  73510.4198423        1
[INPUT] 0    0    [1    /1   ]  36754.7139707        1
[INPUT] 0    0    [1    /1   ]  7303.093712          1
[INPUT] 0    0    [1    /1   ]  18375.7971534        1
[INPUT] 0    0    [1    /1   ]  1449.15631947        1
[INPUT] 0    0    [1    /1   ]  375.184340029        1
[INPUT] 0    0    [1    /1   ]  120.69270913         1
[INPUT] 0    0    [1    /1   ]  46.0311820181        1
[INPUT] 0    0    [1    /1   ]  20.2639394822        1
[INPUT] 0    0    [1    /1   ]  6.98507183246        1
[INPUT] 1    0    [1    /1   ]  8.60589835205        1
[INPUT] 1    0    [1    /1   ]  0.492754662683       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24833731279032395, 1.0]], [0, [0.6530142359780523, 1.0]], [0, [117616.81379668058, 1.0]], [0, [2.870035886731855, 1.0]], [0, [1176168.1426168939, 1.0]], [0, [588084.0699805641, 1.0]], [0, [294042.03106262727, 1.0]], [0, [147020.99187618992, 1.0]], [0, [73510.41984225369, 1.0]], [0, [36754.71397065402, 1.0]], [0, [7303.093711997113, 1.0]], [0, [18375.79715338381, 1.0]], [0, [1449.1563194749835, 1.0]], [0, [375.1843400287271, 1.0]], [0, [120.69270913001488, 1.0]], [0, [46.03118201807114, 1.0]], [0, [20.26393948216115, 1.0]], [0, [6.9850718324574155, 1.0]], [1, [8.605898352052765, 1.0]], [1, [0.492754662682773, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24833731]
bas 1, expnt(s) = [0.65301424]
bas 2, expnt(s) = [117616.81379668]
bas 3, expnt(s) = [2.87003589]
bas 4, expnt(s) = [1176168.14261689]
bas 5, expnt(s) = [588084.06998056]
bas 6, expnt(s) = [294042.03106263]
bas 7, expnt(s) = [147020.99187619]
bas 8, expnt(s) = [73510.41984225]
bas 9, expnt(s) = [36754.71397065]
bas 10, expnt(s) = [7303.093712]
bas 11, expnt(s) = [18375.79715338]
bas 12, expnt(s) = [1449.15631947]
bas 13, expnt(s) = [375.18434003]
bas 14, expnt(s) = [120.69270913]
bas 15, expnt(s) = [46.03118202]
bas 16, expnt(s) = [20.26393948]
bas 17, expnt(s) = [6.98507183]
bas 18, expnt(s) = [8.60589835]
bas 19, expnt(s) = [0.49275466]
CPU time:       863.63
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48337313e-01 8.88784572e-01 6.53014236e-01 1.83529977e+00
 1.17616814e+05 1.60460109e+04 2.87003589e+00 5.57096615e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791586e+04 3.67547140e+04 6.70655993e+03
 7.30309371e+03 1.99592942e+03 1.83757972e+04 3.98749054e+03
 1.44915632e+03 5.93405340e+02 3.75184340e+02 2.15376617e+02
 1.20692709e+02 9.19974524e+01 4.60311820e+01 4.46482169e+01
 2.02639395e+01 2.41300340e+01 6.98507183e+00 1.08553338e+01
 8.60589835e+00 4.30011092e+01 4.92754663e-01 1.20440575e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335912943179792
cond(S) = 909245.1911873285
E1 = -689.605852740816  E_coul = 184.97647824494996
init E= -504.629374495866
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672226314370202  LUMO = 0.686246718044297
  mo_energy =
[-1.21706119e+02 -1.33856196e+01 -7.62327111e+00 -7.62327111e+00
 -7.62327111e+00 -1.65730385e+00 -6.72226314e-01 -6.72226314e-01
 -6.72226314e-01  6.86246718e-01  9.13208476e+00  5.15287177e+01
  2.01373029e+02  7.26289539e+02  2.86893612e+03  1.23353841e+04
  4.09482583e+04  1.04987232e+05  2.30167694e+05  4.55980533e+05
  8.44931216e+05  1.52810697e+06  2.85037251e+06  5.80825742e+06]
E1 = -707.7464352028618  E_coul = 199.77950528559307
cycle= 1 E= -507.966929917269  delta_E= -3.34  |g|= 0.451  |ddm|= 0.501
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.704913
diis-c [-0.49690221  1.        ]
  HOMO = -0.217747660830422  LUMO = 1.07317113570474
  mo_energy =
[-1.20197448e+02 -1.23046808e+01 -6.59434812e+00 -6.59434812e+00
 -6.59434812e+00 -1.16320556e+00 -2.17747661e-01 -2.17747661e-01
 -2.17747661e-01  1.07317114e+00  9.95914733e+00  5.27405890e+01
  2.02802419e+02  7.27780659e+02  2.87036797e+03  1.23367069e+04
  4.09495141e+04  1.04988451e+05  2.30168889e+05  4.55981710e+05
  8.44932380e+05  1.52810812e+06  2.85037365e+06  5.80825856e+06]
E1 = -706.802750230255  E_coul = 198.8182285828382
cycle= 2 E= -507.984521647417  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.43
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297037
diis-c [-8.81634917e-04  1.16303279e-03  9.98836967e-01]
  HOMO = -0.239634016179036  LUMO = 1.06750414801585
  mo_energy =
[-1.20310752e+02 -1.23713055e+01 -6.66815217e+00 -6.66815217e+00
 -6.66815217e+00 -1.17728316e+00 -2.39634016e-01 -2.39634016e-01
 -2.39634016e-01  1.06750415e+00  9.91597125e+00  5.26640363e+01
  2.02702864e+02  7.27663373e+02  2.87023490e+03  1.23365635e+04
  4.09493670e+04  1.04988303e+05  2.30168739e+05  4.55981560e+05
  8.44932230e+05  1.52810797e+06  2.85037350e+06  5.80825841e+06]
E1 = -706.6965696802483  E_coul = 198.7117928094049
cycle= 3 E= -507.984776870843  delta_E= -0.000255  |g|= 0.00439  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324544
diis-c [-2.20570901e-06 -2.04054556e-05 -1.07745144e-01  1.10776555e+00]
  HOMO = -0.242787785439952  LUMO = 1.06645394083322
  mo_energy =
[-1.20322754e+02 -1.23799678e+01 -6.67732103e+00 -6.67732103e+00
 -6.67732103e+00 -1.17919276e+00 -2.42787785e-01 -2.42787785e-01
 -2.42787785e-01  1.06645394e+00  9.90986954e+00  5.26547126e+01
  2.02691806e+02  7.27651205e+02  2.87022189e+03  1.23365500e+04
  4.09493533e+04  1.04988289e+05  2.30168725e+05  4.55981547e+05
  8.44932216e+05  1.52810796e+06  2.85037349e+06  5.80825839e+06]
E1 = -706.6814169190033  E_coul = 198.69663523563702
cycle= 4 E= -507.984781683366  delta_E= -4.81e-06  |g|= 0.000202  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141209
diis-c [-1.44800154e-10 -7.73758630e-06  7.18549518e-03 -9.85965801e-02
  1.09141882e+00]
  HOMO = -0.242924907172496  LUMO = 1.06640109786313
  mo_energy =
[-1.20323095e+02 -1.23802980e+01 -6.67764839e+00 -6.67764839e+00
 -6.67764839e+00 -1.17927446e+00 -2.42924907e-01 -2.42924907e-01
 -2.42924907e-01  1.06640110e+00  9.90961326e+00  5.26543886e+01
  2.02691468e+02  7.27650864e+02  2.87022155e+03  1.23365496e+04
  4.09493529e+04  1.04988289e+05  2.30168725e+05  4.55981546e+05
  8.44932215e+05  1.52810796e+06  2.85037349e+06  5.80825839e+06]
E1 = -706.6807662531993  E_coul = 198.6959845601007
cycle= 5 E= -507.984781693099  delta_E= -9.73e-09  |g|= 1.27e-06  |ddm|= 0.000461
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.97999e-07
diis-c [-7.75035568e-14  2.32393779e-07 -1.64968140e-04  2.06000913e-03
 -2.44668525e-02  1.02257158e+00]
  HOMO = -0.242925653163941  LUMO = 1.0664009677523
  mo_energy =
[-1.20323098e+02 -1.23802998e+01 -6.67765022e+00 -6.67765022e+00
 -6.67765022e+00 -1.17927506e+00 -2.42925653e-01 -2.42925653e-01
 -2.42925653e-01  1.06640097e+00  9.90961189e+00  5.26543868e+01
  2.02691466e+02  7.27650861e+02  2.87022155e+03  1.23365496e+04
  4.09493529e+04  1.04988289e+05  2.30168725e+05  4.55981546e+05
  8.44932215e+05  1.52810796e+06  2.85037349e+06  5.80825839e+06]
E1 = -706.6807624297674  E_coul = 198.69598073666882
cycle= 6 E= -507.984781693099  delta_E= 1.14e-13  |g|= 3.92e-08  |ddm|= 2.83e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6807624297674  E_coul = 198.69598073666882
  HOMO = -0.242925672976258  LUMO = 1.06640095511576
  mo_energy =
[-1.20323098e+02 -1.23802998e+01 -6.67765027e+00 -6.67765027e+00
 -6.67765027e+00 -1.17927507e+00 -2.42925673e-01 -2.42925673e-01
 -2.42925673e-01  1.06640096e+00  9.90961185e+00  5.26543868e+01
  2.02691466e+02  7.27650861e+02  2.87022155e+03  1.23365496e+04
  4.09493529e+04  1.04988289e+05  2.30168725e+05  4.55981546e+05
  8.44932215e+05  1.52810796e+06  2.85037349e+06  5.80825839e+06]
E1 = -706.6807623413615  E_coul = 198.69598064826255
Extra cycle  E= -507.984781693099  delta_E= -4.55e-13  |g|= 4.81e-09  |ddm|= 7.39e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.48337313e-01 6.53014236e-01 1.17616814e+05 2.87003589e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547140e+04 7.30309371e+03 1.83757972e+04
 1.44915632e+03 3.75184340e+02 1.20692709e+02 4.60311820e+01
 2.02639395e+01 6.98507183e+00 8.60589835e+00 4.92754663e-01]
E = -507.98478169309897
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:14:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.24833731279        1
[INPUT] 0    0    [1    /1   ]  0.653014235978       1
[INPUT] 0    0    [1    /1   ]  117616.813797        1
[INPUT] 0    0    [1    /1   ]  2.87003588673        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031063        1
[INPUT] 0    0    [1    /1   ]  147020.991876        1
[INPUT] 0    0    [1    /1   ]  73510.4198423        1
[INPUT] 0    0    [1    /1   ]  36754.7139707        1
[INPUT] 0    0    [1    /1   ]  7303.093712          1
[INPUT] 0    0    [1    /1   ]  18375.7971534        1
[INPUT] 0    0    [1    /1   ]  1449.15631947        1
[INPUT] 0    0    [1    /1   ]  375.184340029        1
[INPUT] 0    0    [1    /1   ]  120.69270913         1
[INPUT] 0    0    [1    /1   ]  46.0311820181        1
[INPUT] 0    0    [1    /1   ]  20.2639394822        1
[INPUT] 0    0    [1    /1   ]  6.98507183246        1
[INPUT] 1    0    [1    /1   ]  8.60589835205        1
[INPUT] 1    0    [1    /1   ]  0.492754662683       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24833731279032395, 1.0]], [0, [0.6530142359780523, 1.0]], [0, [117616.81379668058, 1.0]], [0, [2.870035886731855, 1.0]], [0, [1176168.1426168939, 1.0]], [0, [588084.0699805641, 1.0]], [0, [294042.03106262727, 1.0]], [0, [147020.99187618992, 1.0]], [0, [73510.41984225369, 1.0]], [0, [36754.71397065402, 1.0]], [0, [7303.093711997113, 1.0]], [0, [18375.79715338381, 1.0]], [0, [1449.1563194749835, 1.0]], [0, [375.1843400287271, 1.0]], [0, [120.69270913001488, 1.0]], [0, [46.03118201807114, 1.0]], [0, [20.26393948216115, 1.0]], [0, [6.9850718324574155, 1.0]], [1, [8.605898352052765, 1.0]], [1, [0.492754662682773, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24833731]
bas 1, expnt(s) = [0.65301424]
bas 2, expnt(s) = [117616.81379668]
bas 3, expnt(s) = [2.87003589]
bas 4, expnt(s) = [1176168.14261689]
bas 5, expnt(s) = [588084.06998056]
bas 6, expnt(s) = [294042.03106263]
bas 7, expnt(s) = [147020.99187619]
bas 8, expnt(s) = [73510.41984225]
bas 9, expnt(s) = [36754.71397065]
bas 10, expnt(s) = [7303.093712]
bas 11, expnt(s) = [18375.79715338]
bas 12, expnt(s) = [1449.15631947]
bas 13, expnt(s) = [375.18434003]
bas 14, expnt(s) = [120.69270913]
bas 15, expnt(s) = [46.03118202]
bas 16, expnt(s) = [20.26393948]
bas 17, expnt(s) = [6.98507183]
bas 18, expnt(s) = [8.60589835]
bas 19, expnt(s) = [0.49275466]
CPU time:       865.12
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48337313e-01 8.88784572e-01 6.53014236e-01 1.83529977e+00
 1.17616814e+05 1.60460109e+04 2.87003589e+00 5.57096615e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791586e+04 3.67547140e+04 6.70655993e+03
 7.30309371e+03 1.99592942e+03 1.83757972e+04 3.98749054e+03
 1.44915632e+03 5.93405340e+02 3.75184340e+02 2.15376617e+02
 1.20692709e+02 9.19974524e+01 4.60311820e+01 4.46482169e+01
 2.02639395e+01 2.41300340e+01 6.98507183e+00 1.08553338e+01
 8.60589835e+00 4.30011092e+01 4.92754663e-01 1.20440575e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335912943179792
cond(S) = 909245.1911873285
E1 = -689.605852740816  E_coul = 184.97647824494996
init E= -504.629374495866
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672226314370202  LUMO = 0.686246718044297
  mo_energy =
[-1.21706119e+02 -1.33856196e+01 -7.62327111e+00 -7.62327111e+00
 -7.62327111e+00 -1.65730385e+00 -6.72226314e-01 -6.72226314e-01
 -6.72226314e-01  6.86246718e-01  9.13208476e+00  5.15287177e+01
  2.01373029e+02  7.26289539e+02  2.86893612e+03  1.23353841e+04
  4.09482583e+04  1.04987232e+05  2.30167694e+05  4.55980533e+05
  8.44931216e+05  1.52810697e+06  2.85037251e+06  5.80825742e+06]
E1 = -707.7464352028618  E_coul = 199.77950528559307
cycle= 1 E= -507.966929917269  delta_E= -3.34  |g|= 0.451  |ddm|= 0.501
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.704913
diis-c [-0.49690221  1.        ]
  HOMO = -0.217747660830422  LUMO = 1.07317113570474
  mo_energy =
[-1.20197448e+02 -1.23046808e+01 -6.59434812e+00 -6.59434812e+00
 -6.59434812e+00 -1.16320556e+00 -2.17747661e-01 -2.17747661e-01
 -2.17747661e-01  1.07317114e+00  9.95914733e+00  5.27405890e+01
  2.02802419e+02  7.27780659e+02  2.87036797e+03  1.23367069e+04
  4.09495141e+04  1.04988451e+05  2.30168889e+05  4.55981710e+05
  8.44932380e+05  1.52810812e+06  2.85037365e+06  5.80825856e+06]
E1 = -706.802750230255  E_coul = 198.8182285828382
cycle= 2 E= -507.984521647417  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.43
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297037
diis-c [-8.81634917e-04  1.16303279e-03  9.98836967e-01]
  HOMO = -0.239634016179036  LUMO = 1.06750414801585
  mo_energy =
[-1.20310752e+02 -1.23713055e+01 -6.66815217e+00 -6.66815217e+00
 -6.66815217e+00 -1.17728316e+00 -2.39634016e-01 -2.39634016e-01
 -2.39634016e-01  1.06750415e+00  9.91597125e+00  5.26640363e+01
  2.02702864e+02  7.27663373e+02  2.87023490e+03  1.23365635e+04
  4.09493670e+04  1.04988303e+05  2.30168739e+05  4.55981560e+05
  8.44932230e+05  1.52810797e+06  2.85037350e+06  5.80825841e+06]
E1 = -706.6965696802483  E_coul = 198.7117928094049
cycle= 3 E= -507.984776870843  delta_E= -0.000255  |g|= 0.00439  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324544
diis-c [-2.20570901e-06 -2.04054556e-05 -1.07745144e-01  1.10776555e+00]
  HOMO = -0.242787785439952  LUMO = 1.06645394083322
  mo_energy =
[-1.20322754e+02 -1.23799678e+01 -6.67732103e+00 -6.67732103e+00
 -6.67732103e+00 -1.17919276e+00 -2.42787785e-01 -2.42787785e-01
 -2.42787785e-01  1.06645394e+00  9.90986954e+00  5.26547126e+01
  2.02691806e+02  7.27651205e+02  2.87022189e+03  1.23365500e+04
  4.09493533e+04  1.04988289e+05  2.30168725e+05  4.55981547e+05
  8.44932216e+05  1.52810796e+06  2.85037349e+06  5.80825839e+06]
E1 = -706.6814169190033  E_coul = 198.69663523563702
cycle= 4 E= -507.984781683366  delta_E= -4.81e-06  |g|= 0.000202  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141209
diis-c [-1.44800154e-10 -7.73758630e-06  7.18549518e-03 -9.85965801e-02
  1.09141882e+00]
  HOMO = -0.242924907172496  LUMO = 1.06640109786313
  mo_energy =
[-1.20323095e+02 -1.23802980e+01 -6.67764839e+00 -6.67764839e+00
 -6.67764839e+00 -1.17927446e+00 -2.42924907e-01 -2.42924907e-01
 -2.42924907e-01  1.06640110e+00  9.90961326e+00  5.26543886e+01
  2.02691468e+02  7.27650864e+02  2.87022155e+03  1.23365496e+04
  4.09493529e+04  1.04988289e+05  2.30168725e+05  4.55981546e+05
  8.44932215e+05  1.52810796e+06  2.85037349e+06  5.80825839e+06]
E1 = -706.6807662531993  E_coul = 198.6959845601007
cycle= 5 E= -507.984781693099  delta_E= -9.73e-09  |g|= 1.27e-06  |ddm|= 0.000461
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.97999e-07
diis-c [-7.75035568e-14  2.32393779e-07 -1.64968140e-04  2.06000913e-03
 -2.44668525e-02  1.02257158e+00]
  HOMO = -0.242925653163941  LUMO = 1.0664009677523
  mo_energy =
[-1.20323098e+02 -1.23802998e+01 -6.67765022e+00 -6.67765022e+00
 -6.67765022e+00 -1.17927506e+00 -2.42925653e-01 -2.42925653e-01
 -2.42925653e-01  1.06640097e+00  9.90961189e+00  5.26543868e+01
  2.02691466e+02  7.27650861e+02  2.87022155e+03  1.23365496e+04
  4.09493529e+04  1.04988289e+05  2.30168725e+05  4.55981546e+05
  8.44932215e+05  1.52810796e+06  2.85037349e+06  5.80825839e+06]
E1 = -706.6807624297674  E_coul = 198.69598073666882
cycle= 6 E= -507.984781693099  delta_E= 1.14e-13  |g|= 3.92e-08  |ddm|= 2.83e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6807624297674  E_coul = 198.69598073666882
  HOMO = -0.242925672976258  LUMO = 1.06640095511576
  mo_energy =
[-1.20323098e+02 -1.23802998e+01 -6.67765027e+00 -6.67765027e+00
 -6.67765027e+00 -1.17927507e+00 -2.42925673e-01 -2.42925673e-01
 -2.42925673e-01  1.06640096e+00  9.90961185e+00  5.26543868e+01
  2.02691466e+02  7.27650861e+02  2.87022155e+03  1.23365496e+04
  4.09493529e+04  1.04988289e+05  2.30168725e+05  4.55981546e+05
  8.44932215e+05  1.52810796e+06  2.85037349e+06  5.80825839e+06]
E1 = -706.6807623413615  E_coul = 198.69598064826255
Extra cycle  E= -507.984781693099  delta_E= -4.55e-13  |g|= 4.81e-09  |ddm|= 7.39e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909245.1911873285
E1 = -706.6807623413615  E_coul = 198.69598064826255
init E= -507.984781693099
    CPU time for initialize scf      3.57 sec, wall time      0.23 sec
  HOMO = -0.242925675682751  LUMO = 1.06640095393735
  mo_energy =
[-1.20323098e+02 -1.23802998e+01 -6.67765027e+00 -6.67765027e+00
 -6.67765027e+00 -1.17927507e+00 -2.42925676e-01 -2.42925676e-01
 -2.42925676e-01  1.06640095e+00  9.90961184e+00  5.26543867e+01
  2.02691466e+02  7.27650861e+02  2.87022155e+03  1.23365496e+04
  4.09493529e+04  1.04988289e+05  2.30168725e+05  4.55981546e+05
  8.44932215e+05  1.52810796e+06  2.85037349e+06  5.80825839e+06]
E1 = -706.6807623287017  E_coul = 198.69598063560292
cycle= 1 E= -507.984781693099  delta_E= 2.27e-13  |g|= 1.31e-09  |ddm|= 9.11e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6807623287017  E_coul = 198.69598063560292
  HOMO = -0.242925676053588  LUMO = 1.06640095449127
  mo_energy =
[-1.20323098e+02 -1.23802998e+01 -6.67765027e+00 -6.67765027e+00
 -6.67765027e+00 -1.17927507e+00 -2.42925676e-01 -2.42925676e-01
 -2.42925676e-01  1.06640095e+00  9.90961184e+00  5.26543867e+01
  2.02691466e+02  7.27650861e+02  2.87022155e+03  1.23365496e+04
  4.09493529e+04  1.04988289e+05  2.30168725e+05  4.55981546e+05
  8.44932215e+05  1.52810796e+06  2.85037349e+06  5.80825839e+06]
E1 = -706.6807623258452  E_coul = 198.69598063274637
Extra cycle  E= -507.984781693099  delta_E= -1.14e-13  |g|= 1.35e-09  |ddm|= 1.95e-09
    CPU time for scf_cycle      4.01 sec, wall time      0.39 sec
exp = [2.48337313e-01 6.53014236e-01 1.17616814e+05 2.87003589e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547140e+04 7.30309371e+03 1.83757972e+04
 1.44915632e+03 3.75184340e+02 1.20692709e+02 4.60311820e+01
 2.02639395e+01 6.98507183e+00 8.60589835e+00 4.92754663e-01]
grad_E = [ 1.24884780e-04  1.80839069e-04  3.81802124e-09 -7.75897917e-05
  1.44153484e-11  1.00957539e-10  5.94269077e-10  2.32675377e-09
  9.65309484e-09  5.23461450e-08  3.25194037e-06  1.08473377e-07
  2.36515221e-05 -1.74798398e-04 -1.03764556e-04 -1.85725532e-04
  2.17352857e-04 -1.04963122e-04  1.42833117e-03 -3.68648124e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:14:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248458421676       1
[INPUT] 0    0    [1    /1   ]  0.653004233749       1
[INPUT] 0    0    [1    /1   ]  117616.813796        1
[INPUT] 0    0    [1    /1   ]  2.87273055484        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031062        1
[INPUT] 0    0    [1    /1   ]  147020.991876        1
[INPUT] 0    0    [1    /1   ]  73510.41984          1
[INPUT] 0    0    [1    /1   ]  36754.7139587        1
[INPUT] 0    0    [1    /1   ]  7303.09296033        1
[INPUT] 0    0    [1    /1   ]  18375.7971276        1
[INPUT] 0    0    [1    /1   ]  1449.15525619        1
[INPUT] 0    0    [1    /1   ]  375.18382406         1
[INPUT] 0    0    [1    /1   ]  120.789381463        1
[INPUT] 0    0    [1    /1   ]  46.0608543375        1
[INPUT] 0    0    [1    /1   ]  20.2823918631        1
[INPUT] 0    0    [1    /1   ]  6.9864677228         1
[INPUT] 1    0    [1    /1   ]  8.60730962843        1
[INPUT] 1    0    [1    /1   ]  0.492782850931       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24845842167568188, 1.0]], [0, [0.653004233748733, 1.0]], [0, [117616.81379580326, 1.0]], [0, [2.8727305548377537, 1.0]], [0, [1176168.14261689, 1.0]], [0, [588084.0699805403, 1.0]], [0, [294042.0310624908, 1.0]], [0, [147020.99187565455, 1.0]], [0, [73510.41984002925, 1.0]], [0, [36754.713958697226, 1.0]], [0, [7303.092960328332, 1.0]], [0, [18375.79712758483, 1.0]], [0, [1449.1552561874564, 1.0]], [0, [375.18382405991855, 1.0]], [0, [120.78938146253118, 1.0]], [0, [46.06085433754133, 1.0]], [0, [20.282391863129703, 1.0]], [0, [6.986467722798404, 1.0]], [1, [8.607309628429933, 1.0]], [1, [0.4927828509313848, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24845842]
bas 1, expnt(s) = [0.65300423]
bas 2, expnt(s) = [117616.8137958]
bas 3, expnt(s) = [2.87273055]
bas 4, expnt(s) = [1176168.14261689]
bas 5, expnt(s) = [588084.06998054]
bas 6, expnt(s) = [294042.03106249]
bas 7, expnt(s) = [147020.99187565]
bas 8, expnt(s) = [73510.41984003]
bas 9, expnt(s) = [36754.7139587]
bas 10, expnt(s) = [7303.09296033]
bas 11, expnt(s) = [18375.79712758]
bas 12, expnt(s) = [1449.15525619]
bas 13, expnt(s) = [375.18382406]
bas 14, expnt(s) = [120.78938146]
bas 15, expnt(s) = [46.06085434]
bas 16, expnt(s) = [20.28239186]
bas 17, expnt(s) = [6.98646772]
bas 18, expnt(s) = [8.60730963]
bas 19, expnt(s) = [0.49278285]
CPU time:       877.11
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48458422e-01 8.89109633e-01 6.53004234e-01 1.83527869e+00
 1.17616814e+05 1.60460109e+04 2.87273055e+00 5.57488861e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791586e+04 3.67547140e+04 6.70655993e+03
 7.30309296e+03 1.99592926e+03 1.83757971e+04 3.98749053e+03
 1.44915526e+03 5.93405014e+02 3.75183824e+02 2.15376395e+02
 1.20789381e+02 9.20527129e+01 4.60608543e+01 4.46698008e+01
 2.02823919e+01 2.41465118e+01 6.98646772e+00 1.08569607e+01
 8.60730963e+00 4.30099240e+01 4.92782851e-01 1.20449187e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33586827882402
cond(S) = 909250.7568181268
E1 = -689.6131482674768  E_coul = 184.98358449974302
init E= -504.629563767734
    CPU time for initialize scf      0.43 sec, wall time      0.07 sec
  HOMO = -0.672211102630871  LUMO = 0.686735280242326
  mo_energy =
[-1.21704725e+02 -1.33850596e+01 -7.62277685e+00 -7.62277685e+00
 -7.62277685e+00 -1.65725487e+00 -6.72211103e-01 -6.72211103e-01
 -6.72211103e-01  6.86735280e-01  9.14068230e+00  5.15763685e+01
  2.01558808e+02  7.26719140e+02  2.86947376e+03  1.23358882e+04
  4.09487289e+04  1.04987684e+05  2.30168133e+05  4.55980963e+05
  8.44931638e+05  1.52810738e+06  2.85037292e+06  5.80825782e+06]
E1 = -707.7548253868889  E_coul = 199.78789026887208
cycle= 1 E= -507.966935118017  delta_E= -3.34  |g|= 0.451  |ddm|= 0.501
    CPU time for cycle= 1      0.43 sec, wall time      0.03 sec
diis-norm(errvec)=0.704941
diis-c [-0.49694224  1.        ]
  HOMO = -0.217682820486651  LUMO = 1.07377847106413
  mo_energy =
[-1.20195936e+02 -1.23040423e+01 -6.59375990e+00 -6.59375990e+00
 -6.59375990e+00 -1.16312703e+00 -2.17682820e-01 -2.17682820e-01
 -2.17682820e-01  1.07377847e+00  9.96806497e+00  5.27885552e+01
  2.02988408e+02  7.28210381e+02  2.87090572e+03  1.23372111e+04
  4.09499849e+04  1.04988903e+05  2.30169328e+05  4.55982140e+05
  8.44932803e+05  1.52810854e+06  2.85037406e+06  5.80825895e+06]
E1 = -706.811074496149  E_coul = 198.82654496281495
cycle= 2 E= -507.984529533334  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.431
    CPU time for cycle= 2      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.0296952
diis-c [-8.81117105e-04  1.17753789e-03  9.98822462e-01]
  HOMO = -0.239571151676119  LUMO = 1.06810718620037
  mo_energy =
[-1.20309246e+02 -1.23706692e+01 -6.66756811e+00 -6.66756811e+00
 -6.66756811e+00 -1.17720478e+00 -2.39571152e-01 -2.39571152e-01
 -2.39571152e-01  1.06810719e+00  9.92486670e+00  5.27119802e+01
  2.02888834e+02  7.28093083e+02  2.87077265e+03  1.23370677e+04
  4.09498377e+04  1.04988754e+05  2.30169178e+05  4.55981990e+05
  8.44932652e+05  1.52810839e+06  2.85037391e+06  5.80825880e+06]
E1 = -706.7048948188991  E_coul = 198.72011006036803
cycle= 3 E= -507.984784758531  delta_E= -0.000255  |g|= 0.00439  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324412
diis-c [-2.20398919e-06 -2.04431175e-05 -1.07730101e-01  1.10775054e+00]
  HOMO = -0.242725130093299  LUMO = 1.06705636769176
  mo_energy =
[-1.20321250e+02 -1.23793322e+01 -6.67673791e+00 -6.67673791e+00
 -6.67673791e+00 -1.17911436e+00 -2.42725130e-01 -2.42725130e-01
 -2.42725130e-01  1.06705637e+00  9.91876229e+00  5.27026540e+01
  2.02877773e+02  7.28080914e+02  2.87075964e+03  1.23370542e+04
  4.09498240e+04  1.04988741e+05  2.30169165e+05  4.55981976e+05
  8.44932639e+05  1.52810837e+06  2.85037390e+06  5.80825879e+06]
E1 = -706.6897423086455  E_coul = 198.70495273791505
cycle= 4 E= -507.98478957073  delta_E= -4.81e-06  |g|= 0.000202  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141164
diis-c [-1.44581028e-10 -7.73021019e-06  7.18577827e-03 -9.86087812e-02
  1.09143073e+00]
  HOMO = -0.242862275054964  LUMO = 1.06700349769344
  mo_energy =
[-1.20321591e+02 -1.23796625e+01 -6.67706540e+00 -6.67706540e+00
 -6.67706540e+00 -1.17919607e+00 -2.42862275e-01 -2.42862275e-01
 -2.42862275e-01  1.06700350e+00  9.91850587e+00  5.27023299e+01
  2.02877436e+02  7.28080572e+02  2.87075929e+03  1.23370538e+04
  4.09498237e+04  1.04988740e+05  2.30169164e+05  4.55981976e+05
  8.44932638e+05  1.52810837e+06  2.85037390e+06  5.80825879e+06]
E1 = -706.6890915757768  E_coul = 198.7043019953151
cycle= 5 E= -507.984789580462  delta_E= -9.73e-09  |g|= 1.27e-06  |ddm|= 0.000461
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.94741e-07
diis-c [-7.69857816e-14  2.27451017e-07 -1.63892451e-04  2.04647770e-03
 -2.43115115e-02  1.02242870e+00]
  HOMO = -0.242863018587766  LUMO = 1.06700336790841
  mo_energy =
[-1.20321594e+02 -1.23796643e+01 -6.67706722e+00 -6.67706722e+00
 -6.67706722e+00 -1.17919666e+00 -2.42863019e-01 -2.42863019e-01
 -2.42863019e-01  1.06700337e+00  9.91850451e+00  5.27023280e+01
  2.02877434e+02  7.28080569e+02  2.87075929e+03  1.23370538e+04
  4.09498237e+04  1.04988740e+05  2.30169164e+05  4.55981976e+05
  8.44932638e+05  1.52810837e+06  2.85037390e+06  5.80825879e+06]
E1 = -706.6890877645254  E_coul = 198.70429818406367
cycle= 6 E= -507.984789580462  delta_E=    0  |g|= 3.92e-08  |ddm|= 2.82e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6890877645254  E_coul = 198.70429818406367
  HOMO = -0.242863038368051  LUMO = 1.06700335519213
  mo_energy =
[-1.20321594e+02 -1.23796643e+01 -6.67706727e+00 -6.67706727e+00
 -6.67706727e+00 -1.17919667e+00 -2.42863038e-01 -2.42863038e-01
 -2.42863038e-01  1.06700336e+00  9.91850447e+00  5.27023280e+01
  2.02877433e+02  7.28080569e+02  2.87075929e+03  1.23370538e+04
  4.09498237e+04  1.04988740e+05  2.30169164e+05  4.55981976e+05
  8.44932638e+05  1.52810837e+06  2.85037390e+06  5.80825879e+06]
E1 = -706.6890876766582  E_coul = 198.70429809619642
Extra cycle  E= -507.984789580462  delta_E=    0  |g|= 5.14e-09  |ddm|= 7.36e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.28 sec
exp = [2.48458422e-01 6.53004234e-01 1.17616814e+05 2.87273055e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547140e+04 7.30309296e+03 1.83757971e+04
 1.44915526e+03 3.75183824e+02 1.20789381e+02 4.60608543e+01
 2.02823919e+01 6.98646772e+00 8.60730963e+00 4.92782851e-01]
E = -507.9847895804618
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:14:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248458421676       1
[INPUT] 0    0    [1    /1   ]  0.653004233749       1
[INPUT] 0    0    [1    /1   ]  117616.813796        1
[INPUT] 0    0    [1    /1   ]  2.87273055484        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069981        1
[INPUT] 0    0    [1    /1   ]  294042.031062        1
[INPUT] 0    0    [1    /1   ]  147020.991876        1
[INPUT] 0    0    [1    /1   ]  73510.41984          1
[INPUT] 0    0    [1    /1   ]  36754.7139587        1
[INPUT] 0    0    [1    /1   ]  7303.09296033        1
[INPUT] 0    0    [1    /1   ]  18375.7971276        1
[INPUT] 0    0    [1    /1   ]  1449.15525619        1
[INPUT] 0    0    [1    /1   ]  375.18382406         1
[INPUT] 0    0    [1    /1   ]  120.789381463        1
[INPUT] 0    0    [1    /1   ]  46.0608543375        1
[INPUT] 0    0    [1    /1   ]  20.2823918631        1
[INPUT] 0    0    [1    /1   ]  6.9864677228         1
[INPUT] 1    0    [1    /1   ]  8.60730962843        1
[INPUT] 1    0    [1    /1   ]  0.492782850931       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24845842167568188, 1.0]], [0, [0.653004233748733, 1.0]], [0, [117616.81379580326, 1.0]], [0, [2.8727305548377537, 1.0]], [0, [1176168.14261689, 1.0]], [0, [588084.0699805403, 1.0]], [0, [294042.0310624908, 1.0]], [0, [147020.99187565455, 1.0]], [0, [73510.41984002925, 1.0]], [0, [36754.713958697226, 1.0]], [0, [7303.092960328332, 1.0]], [0, [18375.79712758483, 1.0]], [0, [1449.1552561874564, 1.0]], [0, [375.18382405991855, 1.0]], [0, [120.78938146253118, 1.0]], [0, [46.06085433754133, 1.0]], [0, [20.282391863129703, 1.0]], [0, [6.986467722798404, 1.0]], [1, [8.607309628429933, 1.0]], [1, [0.4927828509313848, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24845842]
bas 1, expnt(s) = [0.65300423]
bas 2, expnt(s) = [117616.8137958]
bas 3, expnt(s) = [2.87273055]
bas 4, expnt(s) = [1176168.14261689]
bas 5, expnt(s) = [588084.06998054]
bas 6, expnt(s) = [294042.03106249]
bas 7, expnt(s) = [147020.99187565]
bas 8, expnt(s) = [73510.41984003]
bas 9, expnt(s) = [36754.7139587]
bas 10, expnt(s) = [7303.09296033]
bas 11, expnt(s) = [18375.79712758]
bas 12, expnt(s) = [1449.15525619]
bas 13, expnt(s) = [375.18382406]
bas 14, expnt(s) = [120.78938146]
bas 15, expnt(s) = [46.06085434]
bas 16, expnt(s) = [20.28239186]
bas 17, expnt(s) = [6.98646772]
bas 18, expnt(s) = [8.60730963]
bas 19, expnt(s) = [0.49278285]
CPU time:       878.64
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48458422e-01 8.89109633e-01 6.53004234e-01 1.83527869e+00
 1.17616814e+05 1.60460109e+04 2.87273055e+00 5.57488861e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791586e+04 3.67547140e+04 6.70655993e+03
 7.30309296e+03 1.99592926e+03 1.83757971e+04 3.98749053e+03
 1.44915526e+03 5.93405014e+02 3.75183824e+02 2.15376395e+02
 1.20789381e+02 9.20527129e+01 4.60608543e+01 4.46698008e+01
 2.02823919e+01 2.41465118e+01 6.98646772e+00 1.08569607e+01
 8.60730963e+00 4.30099240e+01 4.92782851e-01 1.20449187e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33586827882402
cond(S) = 909250.7568181268
E1 = -689.6131482674768  E_coul = 184.98358449974302
init E= -504.629563767734
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672211102630871  LUMO = 0.686735280242326
  mo_energy =
[-1.21704725e+02 -1.33850596e+01 -7.62277685e+00 -7.62277685e+00
 -7.62277685e+00 -1.65725487e+00 -6.72211103e-01 -6.72211103e-01
 -6.72211103e-01  6.86735280e-01  9.14068230e+00  5.15763685e+01
  2.01558808e+02  7.26719140e+02  2.86947376e+03  1.23358882e+04
  4.09487289e+04  1.04987684e+05  2.30168133e+05  4.55980963e+05
  8.44931638e+05  1.52810738e+06  2.85037292e+06  5.80825782e+06]
E1 = -707.7548253868889  E_coul = 199.78789026887208
cycle= 1 E= -507.966935118017  delta_E= -3.34  |g|= 0.451  |ddm|= 0.501
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.704941
diis-c [-0.49694224  1.        ]
  HOMO = -0.217682820486651  LUMO = 1.07377847106413
  mo_energy =
[-1.20195936e+02 -1.23040423e+01 -6.59375990e+00 -6.59375990e+00
 -6.59375990e+00 -1.16312703e+00 -2.17682820e-01 -2.17682820e-01
 -2.17682820e-01  1.07377847e+00  9.96806497e+00  5.27885552e+01
  2.02988408e+02  7.28210381e+02  2.87090572e+03  1.23372111e+04
  4.09499849e+04  1.04988903e+05  2.30169328e+05  4.55982140e+05
  8.44932803e+05  1.52810854e+06  2.85037406e+06  5.80825895e+06]
E1 = -706.811074496149  E_coul = 198.82654496281495
cycle= 2 E= -507.984529533334  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.431
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0296952
diis-c [-8.81117105e-04  1.17753789e-03  9.98822462e-01]
  HOMO = -0.239571151676119  LUMO = 1.06810718620037
  mo_energy =
[-1.20309246e+02 -1.23706692e+01 -6.66756811e+00 -6.66756811e+00
 -6.66756811e+00 -1.17720478e+00 -2.39571152e-01 -2.39571152e-01
 -2.39571152e-01  1.06810719e+00  9.92486670e+00  5.27119802e+01
  2.02888834e+02  7.28093083e+02  2.87077265e+03  1.23370677e+04
  4.09498377e+04  1.04988754e+05  2.30169178e+05  4.55981990e+05
  8.44932652e+05  1.52810839e+06  2.85037391e+06  5.80825880e+06]
E1 = -706.7048948188991  E_coul = 198.72011006036803
cycle= 3 E= -507.984784758531  delta_E= -0.000255  |g|= 0.00439  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324412
diis-c [-2.20398919e-06 -2.04431175e-05 -1.07730101e-01  1.10775054e+00]
  HOMO = -0.242725130093299  LUMO = 1.06705636769176
  mo_energy =
[-1.20321250e+02 -1.23793322e+01 -6.67673791e+00 -6.67673791e+00
 -6.67673791e+00 -1.17911436e+00 -2.42725130e-01 -2.42725130e-01
 -2.42725130e-01  1.06705637e+00  9.91876229e+00  5.27026540e+01
  2.02877773e+02  7.28080914e+02  2.87075964e+03  1.23370542e+04
  4.09498240e+04  1.04988741e+05  2.30169165e+05  4.55981976e+05
  8.44932639e+05  1.52810837e+06  2.85037390e+06  5.80825879e+06]
E1 = -706.6897423086455  E_coul = 198.70495273791505
cycle= 4 E= -507.98478957073  delta_E= -4.81e-06  |g|= 0.000202  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141164
diis-c [-1.44581028e-10 -7.73021019e-06  7.18577827e-03 -9.86087812e-02
  1.09143073e+00]
  HOMO = -0.242862275054964  LUMO = 1.06700349769344
  mo_energy =
[-1.20321591e+02 -1.23796625e+01 -6.67706540e+00 -6.67706540e+00
 -6.67706540e+00 -1.17919607e+00 -2.42862275e-01 -2.42862275e-01
 -2.42862275e-01  1.06700350e+00  9.91850587e+00  5.27023299e+01
  2.02877436e+02  7.28080572e+02  2.87075929e+03  1.23370538e+04
  4.09498237e+04  1.04988740e+05  2.30169164e+05  4.55981976e+05
  8.44932638e+05  1.52810837e+06  2.85037390e+06  5.80825879e+06]
E1 = -706.6890915757768  E_coul = 198.7043019953151
cycle= 5 E= -507.984789580462  delta_E= -9.73e-09  |g|= 1.27e-06  |ddm|= 0.000461
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.94741e-07
diis-c [-7.69857816e-14  2.27451017e-07 -1.63892451e-04  2.04647770e-03
 -2.43115115e-02  1.02242870e+00]
  HOMO = -0.242863018587766  LUMO = 1.06700336790841
  mo_energy =
[-1.20321594e+02 -1.23796643e+01 -6.67706722e+00 -6.67706722e+00
 -6.67706722e+00 -1.17919666e+00 -2.42863019e-01 -2.42863019e-01
 -2.42863019e-01  1.06700337e+00  9.91850451e+00  5.27023280e+01
  2.02877434e+02  7.28080569e+02  2.87075929e+03  1.23370538e+04
  4.09498237e+04  1.04988740e+05  2.30169164e+05  4.55981976e+05
  8.44932638e+05  1.52810837e+06  2.85037390e+06  5.80825879e+06]
E1 = -706.6890877645254  E_coul = 198.70429818406367
cycle= 6 E= -507.984789580462  delta_E=    0  |g|= 3.92e-08  |ddm|= 2.82e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6890877645254  E_coul = 198.70429818406367
  HOMO = -0.242863038368051  LUMO = 1.06700335519213
  mo_energy =
[-1.20321594e+02 -1.23796643e+01 -6.67706727e+00 -6.67706727e+00
 -6.67706727e+00 -1.17919667e+00 -2.42863038e-01 -2.42863038e-01
 -2.42863038e-01  1.06700336e+00  9.91850447e+00  5.27023280e+01
  2.02877433e+02  7.28080569e+02  2.87075929e+03  1.23370538e+04
  4.09498237e+04  1.04988740e+05  2.30169164e+05  4.55981976e+05
  8.44932638e+05  1.52810837e+06  2.85037390e+06  5.80825879e+06]
E1 = -706.6890876766582  E_coul = 198.70429809619642
Extra cycle  E= -507.984789580462  delta_E=    0  |g|= 5.14e-09  |ddm|= 7.36e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909250.7568181268
E1 = -706.6890876766582  E_coul = 198.70429809619642
init E= -507.984789580462
    CPU time for initialize scf      3.59 sec, wall time      0.23 sec
  HOMO = -0.242863041060745  LUMO = 1.06700335392718
  mo_energy =
[-1.20321594e+02 -1.23796643e+01 -6.67706727e+00 -6.67706727e+00
 -6.67706727e+00 -1.17919667e+00 -2.42863041e-01 -2.42863041e-01
 -2.42863041e-01  1.06700335e+00  9.91850446e+00  5.27023280e+01
  2.02877433e+02  7.28080569e+02  2.87075929e+03  1.23370538e+04
  4.09498237e+04  1.04988740e+05  2.30169164e+05  4.55981976e+05
  8.44932638e+05  1.52810837e+06  2.85037390e+06  5.80825879e+06]
E1 = -706.6890876643039  E_coul = 198.70429808384182
cycle= 1 E= -507.984789580462  delta_E= -2.84e-13  |g|= 1.54e-09  |ddm|= 8.94e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6890876643039  E_coul = 198.70429808384182
  HOMO = -0.242863041423686  LUMO = 1.06700335486479
  mo_energy =
[-1.20321594e+02 -1.23796643e+01 -6.67706727e+00 -6.67706727e+00
 -6.67706727e+00 -1.17919667e+00 -2.42863041e-01 -2.42863041e-01
 -2.42863041e-01  1.06700335e+00  9.91850446e+00  5.27023280e+01
  2.02877433e+02  7.28080569e+02  2.87075929e+03  1.23370538e+04
  4.09498237e+04  1.04988740e+05  2.30169164e+05  4.55981976e+05
  8.44932638e+05  1.52810837e+06  2.85037390e+06  5.80825879e+06]
E1 = -706.6890876588727  E_coul = 198.7042980784107
Extra cycle  E= -507.984789580462  delta_E= 5.68e-14  |g|= 1.44e-09  |ddm|= 3.59e-09
    CPU time for scf_cycle      4.04 sec, wall time      0.40 sec
exp = [2.48458422e-01 6.53004234e-01 1.17616814e+05 2.87273055e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547140e+04 7.30309296e+03 1.83757971e+04
 1.44915526e+03 3.75183824e+02 1.20789381e+02 4.60608543e+01
 2.02823919e+01 6.98646772e+00 8.60730963e+00 4.92782851e-01]
grad_E = [ 2.79410440e-04  1.39069077e-04  3.80403978e-09  5.78235663e-05
  1.42469443e-11  1.00504882e-10  5.92099541e-10  2.31811810e-09
  9.61673041e-09  5.21658923e-08  3.23887681e-06  1.07936004e-07
  2.43831326e-05 -1.82678149e-04 -7.81604678e-05 -2.11333737e-04
  2.27082560e-04 -1.55140008e-04  2.58447913e-03 -7.12216288e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:14:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248623621133       1
[INPUT] 0    0    [1    /1   ]  0.652923162515       1
[INPUT] 0    0    [1    /1   ]  117616.813794        1
[INPUT] 0    0    [1    /1   ]  2.87700438458        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031062        1
[INPUT] 0    0    [1    /1   ]  147020.991875        1
[INPUT] 0    0    [1    /1   ]  73510.4198355        1
[INPUT] 0    0    [1    /1   ]  36754.7139344        1
[INPUT] 0    0    [1    /1   ]  7303.09143394        1
[INPUT] 0    0    [1    /1   ]  18375.7970754        1
[INPUT] 0    0    [1    /1   ]  1449.15174704        1
[INPUT] 0    0    [1    /1   ]  375.194672345        1
[INPUT] 0    0    [1    /1   ]  120.971958949        1
[INPUT] 0    0    [1    /1   ]  46.1169986654        1
[INPUT] 0    0    [1    /1   ]  20.2766645945        1
[INPUT] 0    0    [1    /1   ]  6.9895676017         1
[INPUT] 1    0    [1    /1   ]  8.60942071438        1
[INPUT] 1    0    [1    /1   ]  0.49282501442        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24862362113268727, 1.0]], [0, [0.6529231625150028, 1.0]], [0, [117616.81379402017, 1.0]], [0, [2.8770043845764093, 1.0]], [0, [1176168.142616882, 1.0]], [0, [588084.0699804923, 1.0]], [0, [294042.03106221335, 1.0]], [0, [147020.9918745667, 1.0]], [0, [73510.41983551024, 1.0]], [0, [36754.71393437347, 1.0]], [0, [7303.091433938735, 1.0]], [0, [18375.797075424398, 1.0]], [0, [1449.1517470376161, 1.0]], [0, [375.1946723450292, 1.0]], [0, [120.97195894911005, 1.0]], [0, [46.11699866540953, 1.0]], [0, [20.276664594548325, 1.0]], [0, [6.989567601701073, 1.0]], [1, [8.609420714377855, 1.0]], [1, [0.4928250144203313, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24862362]
bas 1, expnt(s) = [0.65292316]
bas 2, expnt(s) = [117616.81379402]
bas 3, expnt(s) = [2.87700438]
bas 4, expnt(s) = [1176168.14261688]
bas 5, expnt(s) = [588084.06998049]
bas 6, expnt(s) = [294042.03106221]
bas 7, expnt(s) = [147020.99187457]
bas 8, expnt(s) = [73510.41983551]
bas 9, expnt(s) = [36754.71393437]
bas 10, expnt(s) = [7303.09143394]
bas 11, expnt(s) = [18375.79707542]
bas 12, expnt(s) = [1449.15174704]
bas 13, expnt(s) = [375.19467235]
bas 14, expnt(s) = [120.97195895]
bas 15, expnt(s) = [46.11699867]
bas 16, expnt(s) = [20.27666459]
bas 17, expnt(s) = [6.9895676]
bas 18, expnt(s) = [8.60942071]
bas 19, expnt(s) = [0.49282501]
CPU time:       890.69
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48623621e-01 8.89552972e-01 6.52923163e-01 1.83510780e+00
 1.17616814e+05 1.60460109e+04 2.87700438e+00 5.58110788e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791586e+04 3.67547139e+04 6.70655992e+03
 7.30309143e+03 1.99592895e+03 1.83757971e+04 3.98749052e+03
 1.44915175e+03 5.93403936e+02 3.75194672e+02 2.15381066e+02
 1.20971959e+02 9.21570489e+01 4.61169987e+01 4.47106312e+01
 2.02766646e+01 2.41413978e+01 6.98956760e+00 1.08605734e+01
 8.60942071e+00 4.30231105e+01 4.92825014e-01 1.20462070e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335801298451695
cond(S) = 909259.6393005376
E1 = -689.6240512146146  E_coul = 184.99420284969202
init E= -504.629848364923
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672188647645866  LUMO = 0.687354902121313
  mo_energy =
[-1.21702647e+02 -1.33842227e+01 -7.62203793e+00 -7.62203793e+00
 -7.62203793e+00 -1.65718192e+00 -6.72188648e-01 -6.72188648e-01
 -6.72188648e-01  6.87354902e-01  9.15300933e+00  5.16143211e+01
  2.01775505e+02  7.27378932e+02  2.87037092e+03  1.23367453e+04
  4.09495308e+04  1.04988453e+05  2.30168881e+05  4.55981695e+05
  8.44932359e+05  1.52810809e+06  2.85037361e+06  5.80825850e+06]
E1 = -707.7673776570067  E_coul = 199.80042684059393
cycle= 1 E= -507.966950816413  delta_E= -3.34  |g|= 0.451  |ddm|= 0.501
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.704951
diis-c [-0.49695583  1.        ]
  HOMO = -0.217585740421487  LUMO = 1.07455704891482
  mo_energy =
[-1.20193679e+02 -1.23030875e+01 -6.59288028e+00 -6.59288028e+00
 -6.59288028e+00 -1.16300959e+00 -2.17585740e-01 -2.17585740e-01
 -2.17585740e-01  1.07455705e+00  9.98082504e+00  5.28267797e+01
  2.03205403e+02  7.28870358e+02  2.87180306e+03  1.23380683e+04
  4.09507868e+04  1.04989673e+05  2.30170076e+05  4.55982873e+05
  8.44933523e+05  1.52810925e+06  2.85037476e+06  5.80825963e+06]
E1 = -706.8235352138284  E_coul = 198.83898615139583
cycle= 2 E= -507.984549062433  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.431
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0296847
diis-c [-8.80481727e-04  1.18595730e-03  9.98814043e-01]
  HOMO = -0.239477333734443  LUMO = 1.06888005133777
  mo_energy =
[-1.20307000e+02 -1.23697180e+01 -6.66669504e+00 -6.66669504e+00
 -6.66669504e+00 -1.17708780e+00 -2.39477334e-01 -2.39477334e-01
 -2.39477334e-01  1.06888005e+00  9.93759628e+00  5.27501862e+01
  2.03105802e+02  7.28753041e+02  2.87166997e+03  1.23379249e+04
  4.09506397e+04  1.04989524e+05  2.30169926e+05  4.55982723e+05
  8.44933373e+05  1.52810910e+06  2.85037461e+06  5.80825948e+06]
E1 = -706.7173529023729  E_coul = 198.73254859822688
cycle= 3 E= -507.984804304146  delta_E= -0.000255  |g|= 0.00439  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324211
diis-c [-2.20215414e-06 -2.01670143e-05 -1.07692120e-01  1.10771229e+00]
  HOMO = -0.24263144143699  LUMO = 1.0678284825994
  mo_energy =
[-1.20319005e+02 -1.23783813e+01 -6.67586542e+00 -6.67586542e+00
 -6.67586542e+00 -1.17899723e+00 -2.42631441e-01 -2.42631441e-01
 -2.42631441e-01  1.06782848e+00  9.93148853e+00  5.27408584e+01
  2.03094739e+02  7.28740871e+02  2.87165696e+03  1.23379114e+04
  4.09506260e+04  1.04989510e+05  2.30169913e+05  4.55982709e+05
  8.44933359e+05  1.52810908e+06  2.85037459e+06  5.80825947e+06]
E1 = -706.7022013108891  E_coul = 198.7173921952204
cycle= 4 E= -507.984809115669  delta_E= -4.81e-06  |g|= 0.000202  |ddm|= 0.00944
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141135
diis-c [-1.44239088e-10 -7.71599157e-06  7.18490641e-03 -9.86335135e-02
  1.09145632e+00]
  HOMO = -0.24276865566827  LUMO = 1.06777555886153
  mo_energy =
[-1.20319347e+02 -1.23787118e+01 -6.67619319e+00 -6.67619319e+00
 -6.67619319e+00 -1.17907897e+00 -2.42768656e-01 -2.42768656e-01
 -2.42768656e-01  1.06777556e+00  9.93123185e+00  5.27405340e+01
  2.03094401e+02  7.28740528e+02  2.87165661e+03  1.23379110e+04
  4.09506256e+04  1.04989510e+05  2.30169912e+05  4.55982708e+05
  8.44933359e+05  1.52810908e+06  2.85037459e+06  5.80825947e+06]
E1 = -706.7015503053399  E_coul = 198.71674117993638
cycle= 5 E= -507.984809125404  delta_E= -9.73e-09  |g|= 1.26e-06  |ddm|= 0.000461
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.92804e-07
diis-c [-7.62872108e-14  2.27439118e-07 -1.62611456e-04  2.02953238e-03
 -2.41110115e-02  1.02224386e+00]
  HOMO = -0.242769395664283  LUMO = 1.06777543122927
  mo_energy =
[-1.20319349e+02 -1.23787136e+01 -6.67619501e+00 -6.67619501e+00
 -6.67619501e+00 -1.17907956e+00 -2.42769396e-01 -2.42769396e-01
 -2.42769396e-01  1.06777543e+00  9.93123050e+00  5.27405322e+01
  2.03094399e+02  7.28740526e+02  2.87165661e+03  1.23379110e+04
  4.09506256e+04  1.04989510e+05  2.30169912e+05  4.55982708e+05
  8.44933359e+05  1.52810908e+06  2.85037459e+06  5.80825947e+06]
E1 = -706.701546510774  E_coul = 198.71673738537046
cycle= 6 E= -507.984809125404  delta_E= -5.68e-14  |g|= 3.93e-08  |ddm|= 2.81e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.701546510774  E_coul = 198.71673738537046
  HOMO = -0.242769415265499  LUMO = 1.06777542109383
  mo_energy =
[-1.20319349e+02 -1.23787136e+01 -6.67619505e+00 -6.67619505e+00
 -6.67619505e+00 -1.17907957e+00 -2.42769415e-01 -2.42769415e-01
 -2.42769415e-01  1.06777542e+00  9.93123046e+00  5.27405321e+01
  2.03094399e+02  7.28740526e+02  2.87165661e+03  1.23379110e+04
  4.09506256e+04  1.04989510e+05  2.30169912e+05  4.55982708e+05
  8.44933359e+05  1.52810908e+06  2.85037459e+06  5.80825947e+06]
E1 = -706.7015464222884  E_coul = 198.71673729688493
Extra cycle  E= -507.984809125403  delta_E= 1.14e-13  |g|= 5e-09  |ddm|= 7.39e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.48623621e-01 6.52923163e-01 1.17616814e+05 2.87700438e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547139e+04 7.30309143e+03 1.83757971e+04
 1.44915175e+03 3.75194672e+02 1.20971959e+02 4.61169987e+01
 2.02766646e+01 6.98956760e+00 8.60942071e+00 4.92825014e-01]
E = -507.98480912540344
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:14:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248623621133       1
[INPUT] 0    0    [1    /1   ]  0.652923162515       1
[INPUT] 0    0    [1    /1   ]  117616.813794        1
[INPUT] 0    0    [1    /1   ]  2.87700438458        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031062        1
[INPUT] 0    0    [1    /1   ]  147020.991875        1
[INPUT] 0    0    [1    /1   ]  73510.4198355        1
[INPUT] 0    0    [1    /1   ]  36754.7139344        1
[INPUT] 0    0    [1    /1   ]  7303.09143394        1
[INPUT] 0    0    [1    /1   ]  18375.7970754        1
[INPUT] 0    0    [1    /1   ]  1449.15174704        1
[INPUT] 0    0    [1    /1   ]  375.194672345        1
[INPUT] 0    0    [1    /1   ]  120.971958949        1
[INPUT] 0    0    [1    /1   ]  46.1169986654        1
[INPUT] 0    0    [1    /1   ]  20.2766645945        1
[INPUT] 0    0    [1    /1   ]  6.9895676017         1
[INPUT] 1    0    [1    /1   ]  8.60942071438        1
[INPUT] 1    0    [1    /1   ]  0.49282501442        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24862362113268727, 1.0]], [0, [0.6529231625150028, 1.0]], [0, [117616.81379402017, 1.0]], [0, [2.8770043845764093, 1.0]], [0, [1176168.142616882, 1.0]], [0, [588084.0699804923, 1.0]], [0, [294042.03106221335, 1.0]], [0, [147020.9918745667, 1.0]], [0, [73510.41983551024, 1.0]], [0, [36754.71393437347, 1.0]], [0, [7303.091433938735, 1.0]], [0, [18375.797075424398, 1.0]], [0, [1449.1517470376161, 1.0]], [0, [375.1946723450292, 1.0]], [0, [120.97195894911005, 1.0]], [0, [46.11699866540953, 1.0]], [0, [20.276664594548325, 1.0]], [0, [6.989567601701073, 1.0]], [1, [8.609420714377855, 1.0]], [1, [0.4928250144203313, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24862362]
bas 1, expnt(s) = [0.65292316]
bas 2, expnt(s) = [117616.81379402]
bas 3, expnt(s) = [2.87700438]
bas 4, expnt(s) = [1176168.14261688]
bas 5, expnt(s) = [588084.06998049]
bas 6, expnt(s) = [294042.03106221]
bas 7, expnt(s) = [147020.99187457]
bas 8, expnt(s) = [73510.41983551]
bas 9, expnt(s) = [36754.71393437]
bas 10, expnt(s) = [7303.09143394]
bas 11, expnt(s) = [18375.79707542]
bas 12, expnt(s) = [1449.15174704]
bas 13, expnt(s) = [375.19467235]
bas 14, expnt(s) = [120.97195895]
bas 15, expnt(s) = [46.11699867]
bas 16, expnt(s) = [20.27666459]
bas 17, expnt(s) = [6.9895676]
bas 18, expnt(s) = [8.60942071]
bas 19, expnt(s) = [0.49282501]
CPU time:       892.24
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48623621e-01 8.89552972e-01 6.52923163e-01 1.83510780e+00
 1.17616814e+05 1.60460109e+04 2.87700438e+00 5.58110788e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791586e+04 3.67547139e+04 6.70655992e+03
 7.30309143e+03 1.99592895e+03 1.83757971e+04 3.98749052e+03
 1.44915175e+03 5.93403936e+02 3.75194672e+02 2.15381066e+02
 1.20971959e+02 9.21570489e+01 4.61169987e+01 4.47106312e+01
 2.02766646e+01 2.41413978e+01 6.98956760e+00 1.08605734e+01
 8.60942071e+00 4.30231105e+01 4.92825014e-01 1.20462070e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335801298451695
cond(S) = 909259.6393005376
E1 = -689.6240512146146  E_coul = 184.99420284969202
init E= -504.629848364923
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672188647645866  LUMO = 0.687354902121313
  mo_energy =
[-1.21702647e+02 -1.33842227e+01 -7.62203793e+00 -7.62203793e+00
 -7.62203793e+00 -1.65718192e+00 -6.72188648e-01 -6.72188648e-01
 -6.72188648e-01  6.87354902e-01  9.15300933e+00  5.16143211e+01
  2.01775505e+02  7.27378932e+02  2.87037092e+03  1.23367453e+04
  4.09495308e+04  1.04988453e+05  2.30168881e+05  4.55981695e+05
  8.44932359e+05  1.52810809e+06  2.85037361e+06  5.80825850e+06]
E1 = -707.7673776570067  E_coul = 199.80042684059393
cycle= 1 E= -507.966950816413  delta_E= -3.34  |g|= 0.451  |ddm|= 0.501
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.704951
diis-c [-0.49695583  1.        ]
  HOMO = -0.217585740421487  LUMO = 1.07455704891482
  mo_energy =
[-1.20193679e+02 -1.23030875e+01 -6.59288028e+00 -6.59288028e+00
 -6.59288028e+00 -1.16300959e+00 -2.17585740e-01 -2.17585740e-01
 -2.17585740e-01  1.07455705e+00  9.98082504e+00  5.28267797e+01
  2.03205403e+02  7.28870358e+02  2.87180306e+03  1.23380683e+04
  4.09507868e+04  1.04989673e+05  2.30170076e+05  4.55982873e+05
  8.44933523e+05  1.52810925e+06  2.85037476e+06  5.80825963e+06]
E1 = -706.8235352138284  E_coul = 198.83898615139583
cycle= 2 E= -507.984549062433  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.431
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0296847
diis-c [-8.80481727e-04  1.18595730e-03  9.98814043e-01]
  HOMO = -0.239477333734443  LUMO = 1.06888005133777
  mo_energy =
[-1.20307000e+02 -1.23697180e+01 -6.66669504e+00 -6.66669504e+00
 -6.66669504e+00 -1.17708780e+00 -2.39477334e-01 -2.39477334e-01
 -2.39477334e-01  1.06888005e+00  9.93759628e+00  5.27501862e+01
  2.03105802e+02  7.28753041e+02  2.87166997e+03  1.23379249e+04
  4.09506397e+04  1.04989524e+05  2.30169926e+05  4.55982723e+05
  8.44933373e+05  1.52810910e+06  2.85037461e+06  5.80825948e+06]
E1 = -706.7173529023729  E_coul = 198.73254859822688
cycle= 3 E= -507.984804304146  delta_E= -0.000255  |g|= 0.00439  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324211
diis-c [-2.20215414e-06 -2.01670143e-05 -1.07692120e-01  1.10771229e+00]
  HOMO = -0.24263144143699  LUMO = 1.0678284825994
  mo_energy =
[-1.20319005e+02 -1.23783813e+01 -6.67586542e+00 -6.67586542e+00
 -6.67586542e+00 -1.17899723e+00 -2.42631441e-01 -2.42631441e-01
 -2.42631441e-01  1.06782848e+00  9.93148853e+00  5.27408584e+01
  2.03094739e+02  7.28740871e+02  2.87165696e+03  1.23379114e+04
  4.09506260e+04  1.04989510e+05  2.30169913e+05  4.55982709e+05
  8.44933359e+05  1.52810908e+06  2.85037459e+06  5.80825947e+06]
E1 = -706.7022013108891  E_coul = 198.7173921952204
cycle= 4 E= -507.984809115669  delta_E= -4.81e-06  |g|= 0.000202  |ddm|= 0.00944
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141135
diis-c [-1.44239088e-10 -7.71599157e-06  7.18490641e-03 -9.86335135e-02
  1.09145632e+00]
  HOMO = -0.24276865566827  LUMO = 1.06777555886153
  mo_energy =
[-1.20319347e+02 -1.23787118e+01 -6.67619319e+00 -6.67619319e+00
 -6.67619319e+00 -1.17907897e+00 -2.42768656e-01 -2.42768656e-01
 -2.42768656e-01  1.06777556e+00  9.93123185e+00  5.27405340e+01
  2.03094401e+02  7.28740528e+02  2.87165661e+03  1.23379110e+04
  4.09506256e+04  1.04989510e+05  2.30169912e+05  4.55982708e+05
  8.44933359e+05  1.52810908e+06  2.85037459e+06  5.80825947e+06]
E1 = -706.7015503053399  E_coul = 198.71674117993638
cycle= 5 E= -507.984809125404  delta_E= -9.73e-09  |g|= 1.26e-06  |ddm|= 0.000461
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.92804e-07
diis-c [-7.62872108e-14  2.27439118e-07 -1.62611456e-04  2.02953238e-03
 -2.41110115e-02  1.02224386e+00]
  HOMO = -0.242769395664283  LUMO = 1.06777543122927
  mo_energy =
[-1.20319349e+02 -1.23787136e+01 -6.67619501e+00 -6.67619501e+00
 -6.67619501e+00 -1.17907956e+00 -2.42769396e-01 -2.42769396e-01
 -2.42769396e-01  1.06777543e+00  9.93123050e+00  5.27405322e+01
  2.03094399e+02  7.28740526e+02  2.87165661e+03  1.23379110e+04
  4.09506256e+04  1.04989510e+05  2.30169912e+05  4.55982708e+05
  8.44933359e+05  1.52810908e+06  2.85037459e+06  5.80825947e+06]
E1 = -706.701546510774  E_coul = 198.71673738537046
cycle= 6 E= -507.984809125404  delta_E= -5.68e-14  |g|= 3.93e-08  |ddm|= 2.81e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.701546510774  E_coul = 198.71673738537046
  HOMO = -0.242769415265499  LUMO = 1.06777542109383
  mo_energy =
[-1.20319349e+02 -1.23787136e+01 -6.67619505e+00 -6.67619505e+00
 -6.67619505e+00 -1.17907957e+00 -2.42769415e-01 -2.42769415e-01
 -2.42769415e-01  1.06777542e+00  9.93123046e+00  5.27405321e+01
  2.03094399e+02  7.28740526e+02  2.87165661e+03  1.23379110e+04
  4.09506256e+04  1.04989510e+05  2.30169912e+05  4.55982708e+05
  8.44933359e+05  1.52810908e+06  2.85037459e+06  5.80825947e+06]
E1 = -706.7015464222884  E_coul = 198.71673729688493
Extra cycle  E= -507.984809125403  delta_E= 1.14e-13  |g|= 5e-09  |ddm|= 7.39e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909259.6393005376
E1 = -706.7015464222884  E_coul = 198.71673729688493
init E= -507.984809125403
    CPU time for initialize scf      3.33 sec, wall time      0.21 sec
  HOMO = -0.242769417985294  LUMO = 1.06777542042887
  mo_energy =
[-1.20319349e+02 -1.23787136e+01 -6.67619506e+00 -6.67619506e+00
 -6.67619506e+00 -1.17907957e+00 -2.42769418e-01 -2.42769418e-01
 -2.42769418e-01  1.06777542e+00  9.93123046e+00  5.27405321e+01
  2.03094399e+02  7.28740525e+02  2.87165661e+03  1.23379110e+04
  4.09506256e+04  1.04989510e+05  2.30169912e+05  4.55982708e+05
  8.44933359e+05  1.52810908e+06  2.85037459e+06  5.80825947e+06]
E1 = -706.7015464078747  E_coul = 198.71673728247112
cycle= 1 E= -507.984809125404  delta_E= -1.71e-13  |g|= 1.09e-09  |ddm|= 1.03e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.7015464078747  E_coul = 198.71673728247112
  HOMO = -0.242769418402965  LUMO = 1.06777541969477
  mo_energy =
[-1.20319349e+02 -1.23787136e+01 -6.67619506e+00 -6.67619506e+00
 -6.67619506e+00 -1.17907957e+00 -2.42769418e-01 -2.42769418e-01
 -2.42769418e-01  1.06777542e+00  9.93123046e+00  5.27405321e+01
  2.03094399e+02  7.28740525e+02  2.87165661e+03  1.23379110e+04
  4.09506256e+04  1.04989510e+05  2.30169912e+05  4.55982708e+05
  8.44933359e+05  1.52810908e+06  2.85037459e+06  5.80825947e+06]
E1 = -706.7015464060337  E_coul = 198.71673728063
Extra cycle  E= -507.984809125404  delta_E= -5.68e-14  |g|= 1.23e-09  |ddm|= 1.26e-09
    CPU time for scf_cycle      3.78 sec, wall time      0.38 sec
exp = [2.48623621e-01 6.52923163e-01 1.17616814e+05 2.87700438e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547139e+04 7.30309143e+03 1.83757971e+04
 1.44915175e+03 3.75194672e+02 1.20971959e+02 4.61169987e+01
 2.02766646e+01 6.98956760e+00 8.60942071e+00 4.92825014e-01]
grad_E = [ 5.11701794e-04  7.20318724e-05  3.78109106e-09  2.65496832e-04
  1.39703077e-11  9.97620067e-11  5.88538075e-10  2.30394423e-09
  9.55704781e-09  5.18699606e-08  3.21738641e-06  1.07054722e-07
  2.55932933e-05 -1.95629850e-04 -3.80748169e-05 -2.46687685e-04
  2.37513749e-04 -2.29252420e-04  4.31315354e-03 -1.22706466e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:14:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248814061357       1
[INPUT] 0    0    [1    /1   ]  0.652639411281       1
[INPUT] 0    0    [1    /1   ]  117616.81379         1
[INPUT] 0    0    [1    /1   ]  2.88365109913        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031062        1
[INPUT] 0    0    [1    /1   ]  147020.991872        1
[INPUT] 0    0    [1    /1   ]  73510.4198259        1
[INPUT] 0    0    [1    /1   ]  36754.7138828        1
[INPUT] 0    0    [1    /1   ]  7303.08820345        1
[INPUT] 0    0    [1    /1   ]  18375.7969655        1
[INPUT] 0    0    [1    /1   ]  1449.14182788        1
[INPUT] 0    0    [1    /1   ]  375.239710361        1
[INPUT] 0    0    [1    /1   ]  121.331389168        1
[INPUT] 0    0    [1    /1   ]  46.2316324383        1
[INPUT] 0    0    [1    /1   ]  20.1867663799        1
[INPUT] 0    0    [1    /1   ]  6.996727362          1
[INPUT] 1    0    [1    /1   ]  8.61238124931        1
[INPUT] 1    0    [1    /1   ]  0.492884146916       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24881406135667172, 1.0]], [0, [0.6526394112813826, 1.0]], [0, [117616.81379024356, 1.0]], [0, [2.883651099128874, 1.0]], [0, [1176168.1426168657, 1.0]], [0, [588084.069980391, 1.0]], [0, [294042.03106162575, 1.0]], [0, [147020.99187226302, 1.0]], [0, [73510.41982594253, 1.0]], [0, [36754.713882813885, 1.0]], [0, [7303.0882034533315, 1.0]], [0, [18375.79696545285, 1.0]], [0, [1449.1418278752703, 1.0]], [0, [375.23971036086687, 1.0]], [0, [121.331389168374, 1.0]], [0, [46.231632438309575, 1.0]], [0, [20.18676637990444, 1.0]], [0, [6.996727362002618, 1.0]], [1, [8.612381249310452, 1.0]], [1, [0.4928841469160382, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24881406]
bas 1, expnt(s) = [0.65263941]
bas 2, expnt(s) = [117616.81379024]
bas 3, expnt(s) = [2.8836511]
bas 4, expnt(s) = [1176168.14261687]
bas 5, expnt(s) = [588084.06998039]
bas 6, expnt(s) = [294042.03106163]
bas 7, expnt(s) = [147020.99187226]
bas 8, expnt(s) = [73510.41982594]
bas 9, expnt(s) = [36754.71388281]
bas 10, expnt(s) = [7303.08820345]
bas 11, expnt(s) = [18375.79696545]
bas 12, expnt(s) = [1449.14182788]
bas 13, expnt(s) = [375.23971036]
bas 14, expnt(s) = [121.33138917]
bas 15, expnt(s) = [46.23163244]
bas 16, expnt(s) = [20.18676638]
bas 17, expnt(s) = [6.99672736]
bas 18, expnt(s) = [8.61238125]
bas 19, expnt(s) = [0.49288415]
CPU time:       903.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48814061e-01 8.90063956e-01 6.52639411e-01 1.83450963e+00
 1.17616814e+05 1.60460109e+04 2.88365110e+00 5.59077557e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547139e+04 6.70655992e+03
 7.30308820e+03 1.99592829e+03 1.83757970e+04 3.98749051e+03
 1.44914183e+03 5.93400890e+02 3.75239710e+02 2.15400456e+02
 1.21331389e+02 9.23623346e+01 4.62316324e+01 4.47939587e+01
 2.01867664e+01 2.40610786e+01 6.99672736e+00 1.08689161e+01
 8.61238125e+00 4.30416043e+01 4.92884147e-01 1.20480138e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335707067611054
cond(S) = 909274.1309280335
E1 = -689.6393258141132  E_coul = 185.0090685665137
init E= -504.6302572476
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672157858019458  LUMO = 0.687938480136278
  mo_energy =
[-1.21699748e+02 -1.33830500e+01 -7.62100269e+00 -7.62100269e+00
 -7.62100269e+00 -1.65708025e+00 -6.72157858e-01 -6.72157858e-01
 -6.72157858e-01  6.87938480e-01  9.16925916e+00  5.15882671e+01
  2.01948695e+02  7.28397911e+02  2.87192425e+03  1.23382641e+04
  4.09509550e+04  1.04989820e+05  2.30170209e+05  4.55982995e+05
  8.44933638e+05  1.52810935e+06  2.85037485e+06  5.80825970e+06]
E1 = -707.7849837374613  E_coul = 199.8179905213166
cycle= 1 E= -507.966993216145  delta_E= -3.34  |g|= 0.451  |ddm|= 0.501
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.704883
diis-c [-0.49686056  1.        ]
  HOMO = -0.217449418507919  LUMO = 1.07531619967891
  mo_energy =
[-1.20190530e+02 -1.23017491e+01 -6.59164779e+00 -6.59164779e+00
 -6.59164779e+00 -1.16284498e+00 -2.17449419e-01 -2.17449419e-01
 -2.17449419e-01  1.07531620e+00  9.99758155e+00  5.28006316e+01
  2.03378987e+02  7.29889606e+02  2.87335661e+03  1.23395873e+04
  4.09522112e+04  1.04991040e+05  2.30171404e+05  4.55984173e+05
  8.44934803e+05  1.52811050e+06  2.85037599e+06  5.80826083e+06]
E1 = -706.8410321064722  E_coul = 198.85643577803296
cycle= 2 E= -507.984596328439  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.431
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0296749
diis-c [-8.79926372e-04  1.16541796e-03  9.98834582e-01]
  HOMO = -0.23934633538884  LUMO = 1.06963299599475
  mo_energy =
[-1.20303866e+02 -1.23683852e+01 -6.66547235e+00 -6.66547235e+00
 -6.66547235e+00 -1.17692443e+00 -2.39346335e-01 -2.39346335e-01
 -2.39346335e-01  1.06963300e+00  9.95431592e+00  5.27240478e+01
  2.03279347e+02  7.29772256e+02  2.87322351e+03  1.23394438e+04
  4.09520640e+04  1.04990891e+05  2.30171255e+05  4.55984023e+05
  8.44934652e+05  1.52811035e+06  2.85037584e+06  5.80826068e+06]
E1 = -706.7348360793848  E_coul = 198.74998445004542
cycle= 3 E= -507.984851629339  delta_E= -0.000255  |g|= 0.00439  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0032392
diis-c [-2.20133399e-06 -1.89619666e-05 -1.07602313e-01  1.10762128e+00]
  HOMO = -0.2425002002485  LUMO = 1.06858075464424
  mo_energy =
[-1.20315869e+02 -1.23770472e+01 -6.67464158e+00 -6.67464158e+00
 -6.67464158e+00 -1.17883339e+00 -2.42500200e-01 -2.42500200e-01
 -2.42500200e-01  1.06858075e+00  9.94820511e+00  5.27147228e+01
  2.03268283e+02  7.29760086e+02  2.87321050e+03  1.23394303e+04
  4.09520503e+04  1.04990877e+05  2.30171241e+05  4.55984010e+05
  8.44934638e+05  1.52811034e+06  2.85037583e+06  5.80826067e+06]
E1 = -706.7196869755818  E_coul = 198.73483053605307
cycle= 4 E= -507.984856439529  delta_E= -4.81e-06  |g|= 0.000202  |ddm|= 0.00944
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141183
diis-c [-1.43685962e-10 -7.69943761e-06  7.18041599e-03 -9.86827056e-02
  1.09150999e+00]
  HOMO = -0.242637595270709  LUMO = 1.0685277493348
  mo_energy =
[-1.20316212e+02 -1.23773783e+01 -6.67496996e+00 -6.67496996e+00
 -6.67496996e+00 -1.17891522e+00 -2.42637595e-01 -2.42637595e-01
 -2.42637595e-01  1.06852775e+00  9.94794794e+00  5.27143978e+01
  2.03267945e+02  7.29759743e+02  2.87321015e+03  1.23394300e+04
  4.09520500e+04  1.04990877e+05  2.30171241e+05  4.55984009e+05
  8.44934638e+05  1.52811034e+06  2.85037582e+06  5.80826067e+06]
E1 = -706.7190351296016  E_coul = 198.73417868032047
cycle= 5 E= -507.984856449281  delta_E= -9.75e-09  |g|= 1.25e-06  |ddm|= 0.000461
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.88719e-07
diis-c [-7.48988568e-14  2.29039260e-07 -1.61949157e-04  2.02310735e-03
 -2.40082149e-02  1.02214683e+00]
  HOMO = -0.242638330749149  LUMO = 1.06852762118357
  mo_energy =
[-1.20316214e+02 -1.23773801e+01 -6.67497177e+00 -6.67497177e+00
 -6.67497177e+00 -1.17891580e+00 -2.42638331e-01 -2.42638331e-01
 -2.42638331e-01  1.06852762e+00  9.94794659e+00  5.27143960e+01
  2.03267942e+02  7.29759740e+02  2.87321015e+03  1.23394300e+04
  4.09520500e+04  1.04990877e+05  2.30171241e+05  4.55984009e+05
  8.44934638e+05  1.52811034e+06  2.85037582e+06  5.80826067e+06]
E1 = -706.7190313591922  E_coul = 198.73417490991065
cycle= 6 E= -507.984856449282  delta_E= -4.55e-13  |g|= 3.91e-08  |ddm|= 2.79e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7190313591922  E_coul = 198.73417490991065
  HOMO = -0.242638350267105  LUMO = 1.06852761110942
  mo_energy =
[-1.20316214e+02 -1.23773801e+01 -6.67497181e+00 -6.67497181e+00
 -6.67497181e+00 -1.17891581e+00 -2.42638350e-01 -2.42638350e-01
 -2.42638350e-01  1.06852761e+00  9.94794655e+00  5.27143959e+01
  2.03267942e+02  7.29759740e+02  2.87321015e+03  1.23394300e+04
  4.09520500e+04  1.04990877e+05  2.30171241e+05  4.55984009e+05
  8.44934638e+05  1.52811034e+06  2.85037582e+06  5.80826067e+06]
E1 = -706.7190312675657  E_coul = 198.73417481828392
Extra cycle  E= -507.984856449282  delta_E= -2.27e-13  |g|= 4.67e-09  |ddm|= 7.56e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.48814061e-01 6.52639411e-01 1.17616814e+05 2.88365110e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547139e+04 7.30308820e+03 1.83757970e+04
 1.44914183e+03 3.75239710e+02 1.21331389e+02 4.62316324e+01
 2.01867664e+01 6.99672736e+00 8.61238125e+00 4.92884147e-01]
E = -507.9848564492818
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:14:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248814061357       1
[INPUT] 0    0    [1    /1   ]  0.652639411281       1
[INPUT] 0    0    [1    /1   ]  117616.81379         1
[INPUT] 0    0    [1    /1   ]  2.88365109913        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031062        1
[INPUT] 0    0    [1    /1   ]  147020.991872        1
[INPUT] 0    0    [1    /1   ]  73510.4198259        1
[INPUT] 0    0    [1    /1   ]  36754.7138828        1
[INPUT] 0    0    [1    /1   ]  7303.08820345        1
[INPUT] 0    0    [1    /1   ]  18375.7969655        1
[INPUT] 0    0    [1    /1   ]  1449.14182788        1
[INPUT] 0    0    [1    /1   ]  375.239710361        1
[INPUT] 0    0    [1    /1   ]  121.331389168        1
[INPUT] 0    0    [1    /1   ]  46.2316324383        1
[INPUT] 0    0    [1    /1   ]  20.1867663799        1
[INPUT] 0    0    [1    /1   ]  6.996727362          1
[INPUT] 1    0    [1    /1   ]  8.61238124931        1
[INPUT] 1    0    [1    /1   ]  0.492884146916       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24881406135667172, 1.0]], [0, [0.6526394112813826, 1.0]], [0, [117616.81379024356, 1.0]], [0, [2.883651099128874, 1.0]], [0, [1176168.1426168657, 1.0]], [0, [588084.069980391, 1.0]], [0, [294042.03106162575, 1.0]], [0, [147020.99187226302, 1.0]], [0, [73510.41982594253, 1.0]], [0, [36754.713882813885, 1.0]], [0, [7303.0882034533315, 1.0]], [0, [18375.79696545285, 1.0]], [0, [1449.1418278752703, 1.0]], [0, [375.23971036086687, 1.0]], [0, [121.331389168374, 1.0]], [0, [46.231632438309575, 1.0]], [0, [20.18676637990444, 1.0]], [0, [6.996727362002618, 1.0]], [1, [8.612381249310452, 1.0]], [1, [0.4928841469160382, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24881406]
bas 1, expnt(s) = [0.65263941]
bas 2, expnt(s) = [117616.81379024]
bas 3, expnt(s) = [2.8836511]
bas 4, expnt(s) = [1176168.14261687]
bas 5, expnt(s) = [588084.06998039]
bas 6, expnt(s) = [294042.03106163]
bas 7, expnt(s) = [147020.99187226]
bas 8, expnt(s) = [73510.41982594]
bas 9, expnt(s) = [36754.71388281]
bas 10, expnt(s) = [7303.08820345]
bas 11, expnt(s) = [18375.79696545]
bas 12, expnt(s) = [1449.14182788]
bas 13, expnt(s) = [375.23971036]
bas 14, expnt(s) = [121.33138917]
bas 15, expnt(s) = [46.23163244]
bas 16, expnt(s) = [20.18676638]
bas 17, expnt(s) = [6.99672736]
bas 18, expnt(s) = [8.61238125]
bas 19, expnt(s) = [0.49288415]
CPU time:       905.39
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48814061e-01 8.90063956e-01 6.52639411e-01 1.83450963e+00
 1.17616814e+05 1.60460109e+04 2.88365110e+00 5.59077557e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547139e+04 6.70655992e+03
 7.30308820e+03 1.99592829e+03 1.83757970e+04 3.98749051e+03
 1.44914183e+03 5.93400890e+02 3.75239710e+02 2.15400456e+02
 1.21331389e+02 9.23623346e+01 4.62316324e+01 4.47939587e+01
 2.01867664e+01 2.40610786e+01 6.99672736e+00 1.08689161e+01
 8.61238125e+00 4.30416043e+01 4.92884147e-01 1.20480138e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335707067611054
cond(S) = 909274.1309280335
E1 = -689.6393258141132  E_coul = 185.0090685665137
init E= -504.6302572476
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672157858019458  LUMO = 0.687938480136278
  mo_energy =
[-1.21699748e+02 -1.33830500e+01 -7.62100269e+00 -7.62100269e+00
 -7.62100269e+00 -1.65708025e+00 -6.72157858e-01 -6.72157858e-01
 -6.72157858e-01  6.87938480e-01  9.16925916e+00  5.15882671e+01
  2.01948695e+02  7.28397911e+02  2.87192425e+03  1.23382641e+04
  4.09509550e+04  1.04989820e+05  2.30170209e+05  4.55982995e+05
  8.44933638e+05  1.52810935e+06  2.85037485e+06  5.80825970e+06]
E1 = -707.7849837374613  E_coul = 199.8179905213166
cycle= 1 E= -507.966993216145  delta_E= -3.34  |g|= 0.451  |ddm|= 0.501
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.704883
diis-c [-0.49686056  1.        ]
  HOMO = -0.217449418507919  LUMO = 1.07531619967891
  mo_energy =
[-1.20190530e+02 -1.23017491e+01 -6.59164779e+00 -6.59164779e+00
 -6.59164779e+00 -1.16284498e+00 -2.17449419e-01 -2.17449419e-01
 -2.17449419e-01  1.07531620e+00  9.99758155e+00  5.28006316e+01
  2.03378987e+02  7.29889606e+02  2.87335661e+03  1.23395873e+04
  4.09522112e+04  1.04991040e+05  2.30171404e+05  4.55984173e+05
  8.44934803e+05  1.52811050e+06  2.85037599e+06  5.80826083e+06]
E1 = -706.8410321064722  E_coul = 198.85643577803296
cycle= 2 E= -507.984596328439  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.431
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0296749
diis-c [-8.79926372e-04  1.16541796e-03  9.98834582e-01]
  HOMO = -0.23934633538884  LUMO = 1.06963299599475
  mo_energy =
[-1.20303866e+02 -1.23683852e+01 -6.66547235e+00 -6.66547235e+00
 -6.66547235e+00 -1.17692443e+00 -2.39346335e-01 -2.39346335e-01
 -2.39346335e-01  1.06963300e+00  9.95431592e+00  5.27240478e+01
  2.03279347e+02  7.29772256e+02  2.87322351e+03  1.23394438e+04
  4.09520640e+04  1.04990891e+05  2.30171255e+05  4.55984023e+05
  8.44934652e+05  1.52811035e+06  2.85037584e+06  5.80826068e+06]
E1 = -706.7348360793848  E_coul = 198.74998445004542
cycle= 3 E= -507.984851629339  delta_E= -0.000255  |g|= 0.00439  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0032392
diis-c [-2.20133399e-06 -1.89619666e-05 -1.07602313e-01  1.10762128e+00]
  HOMO = -0.2425002002485  LUMO = 1.06858075464424
  mo_energy =
[-1.20315869e+02 -1.23770472e+01 -6.67464158e+00 -6.67464158e+00
 -6.67464158e+00 -1.17883339e+00 -2.42500200e-01 -2.42500200e-01
 -2.42500200e-01  1.06858075e+00  9.94820511e+00  5.27147228e+01
  2.03268283e+02  7.29760086e+02  2.87321050e+03  1.23394303e+04
  4.09520503e+04  1.04990877e+05  2.30171241e+05  4.55984010e+05
  8.44934638e+05  1.52811034e+06  2.85037583e+06  5.80826067e+06]
E1 = -706.7196869755818  E_coul = 198.73483053605307
cycle= 4 E= -507.984856439529  delta_E= -4.81e-06  |g|= 0.000202  |ddm|= 0.00944
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141183
diis-c [-1.43685962e-10 -7.69943761e-06  7.18041599e-03 -9.86827056e-02
  1.09150999e+00]
  HOMO = -0.242637595270709  LUMO = 1.0685277493348
  mo_energy =
[-1.20316212e+02 -1.23773783e+01 -6.67496996e+00 -6.67496996e+00
 -6.67496996e+00 -1.17891522e+00 -2.42637595e-01 -2.42637595e-01
 -2.42637595e-01  1.06852775e+00  9.94794794e+00  5.27143978e+01
  2.03267945e+02  7.29759743e+02  2.87321015e+03  1.23394300e+04
  4.09520500e+04  1.04990877e+05  2.30171241e+05  4.55984009e+05
  8.44934638e+05  1.52811034e+06  2.85037582e+06  5.80826067e+06]
E1 = -706.7190351296016  E_coul = 198.73417868032047
cycle= 5 E= -507.984856449281  delta_E= -9.75e-09  |g|= 1.25e-06  |ddm|= 0.000461
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.88719e-07
diis-c [-7.48988568e-14  2.29039260e-07 -1.61949157e-04  2.02310735e-03
 -2.40082149e-02  1.02214683e+00]
  HOMO = -0.242638330749149  LUMO = 1.06852762118357
  mo_energy =
[-1.20316214e+02 -1.23773801e+01 -6.67497177e+00 -6.67497177e+00
 -6.67497177e+00 -1.17891580e+00 -2.42638331e-01 -2.42638331e-01
 -2.42638331e-01  1.06852762e+00  9.94794659e+00  5.27143960e+01
  2.03267942e+02  7.29759740e+02  2.87321015e+03  1.23394300e+04
  4.09520500e+04  1.04990877e+05  2.30171241e+05  4.55984009e+05
  8.44934638e+05  1.52811034e+06  2.85037582e+06  5.80826067e+06]
E1 = -706.7190313591922  E_coul = 198.73417490991065
cycle= 6 E= -507.984856449282  delta_E= -4.55e-13  |g|= 3.91e-08  |ddm|= 2.79e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7190313591922  E_coul = 198.73417490991065
  HOMO = -0.242638350267105  LUMO = 1.06852761110942
  mo_energy =
[-1.20316214e+02 -1.23773801e+01 -6.67497181e+00 -6.67497181e+00
 -6.67497181e+00 -1.17891581e+00 -2.42638350e-01 -2.42638350e-01
 -2.42638350e-01  1.06852761e+00  9.94794655e+00  5.27143959e+01
  2.03267942e+02  7.29759740e+02  2.87321015e+03  1.23394300e+04
  4.09520500e+04  1.04990877e+05  2.30171241e+05  4.55984009e+05
  8.44934638e+05  1.52811034e+06  2.85037582e+06  5.80826067e+06]
E1 = -706.7190312675657  E_coul = 198.73417481828392
Extra cycle  E= -507.984856449282  delta_E= -2.27e-13  |g|= 4.67e-09  |ddm|= 7.56e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909274.1309280335
E1 = -706.7190312675657  E_coul = 198.73417481828392
init E= -507.984856449282
    CPU time for initialize scf      3.57 sec, wall time      0.23 sec
  HOMO = -0.242638353057422  LUMO = 1.06852761085381
  mo_energy =
[-1.20316214e+02 -1.23773801e+01 -6.67497182e+00 -6.67497182e+00
 -6.67497182e+00 -1.17891582e+00 -2.42638353e-01 -2.42638353e-01
 -2.42638353e-01  1.06852761e+00  9.94794655e+00  5.27143959e+01
  2.03267942e+02  7.29759740e+02  2.87321015e+03  1.23394300e+04
  4.09520500e+04  1.04990877e+05  2.30171241e+05  4.55984009e+05
  8.44934638e+05  1.52811034e+06  2.85037582e+06  5.80826067e+06]
E1 = -706.719031255168  E_coul = 198.73417480588665
cycle= 1 E= -507.984856449281  delta_E= 3.98e-13  |g|= 1.51e-09  |ddm|= 9.03e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.719031255168  E_coul = 198.73417480588665
  HOMO = -0.242638353430957  LUMO = 1.06852760998561
  mo_energy =
[-1.20316214e+02 -1.23773801e+01 -6.67497182e+00 -6.67497182e+00
 -6.67497182e+00 -1.17891582e+00 -2.42638353e-01 -2.42638353e-01
 -2.42638353e-01  1.06852761e+00  9.94794654e+00  5.27143959e+01
  2.03267942e+02  7.29759740e+02  2.87321015e+03  1.23394300e+04
  4.09520500e+04  1.04990877e+05  2.30171241e+05  4.55984009e+05
  8.44934638e+05  1.52811034e+06  2.85037582e+06  5.80826067e+06]
E1 = -706.7190312545066  E_coul = 198.73417480522494
Extra cycle  E= -507.984856449282  delta_E= -2.84e-13  |g|= 8.95e-10  |ddm|= 5.03e-10
    CPU time for scf_cycle      4.02 sec, wall time      0.39 sec
exp = [2.48814061e-01 6.52639411e-01 1.17616814e+05 2.88365110e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547139e+04 7.30308820e+03 1.83757970e+04
 1.44914183e+03 3.75239710e+02 1.21331389e+02 4.62316324e+01
 2.01867664e+01 6.99672736e+00 8.61238125e+00 4.92884147e-01]
grad_E = [ 8.39747669e-04 -3.35138600e-05  3.74344422e-09  5.71596845e-04
  1.35158836e-11  9.85436114e-11  5.82694313e-10  2.28069353e-09
  9.45915314e-09  5.13843050e-08  3.18201199e-06  1.05611035e-07
  2.75997386e-05 -2.16817207e-04  2.24661511e-05 -2.87957320e-04
  2.40929461e-04 -3.31726588e-04  6.73568281e-03 -1.95119337e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:14:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248904144328       1
[INPUT] 0    0    [1    /1   ]  0.651894621732       1
[INPUT] 0    0    [1    /1   ]  117616.813783        1
[INPUT] 0    0    [1    /1   ]  2.89257097035        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.03106         1
[INPUT] 0    0    [1    /1   ]  147020.991868        1
[INPUT] 0    0    [1    /1   ]  73510.4198072        1
[INPUT] 0    0    [1    /1   ]  36754.7137817        1
[INPUT] 0    0    [1    /1   ]  7303.08187562        1
[INPUT] 0    0    [1    /1   ]  18375.7967507        1
[INPUT] 0    0    [1    /1   ]  1449.11857957        1
[INPUT] 0    0    [1    /1   ]  375.362169717        1
[INPUT] 0    0    [1    /1   ]  121.988344165        1
[INPUT] 0    0    [1    /1   ]  46.4613956481        1
[INPUT] 0    0    [1    /1   ]  19.8986112447        1
[INPUT] 0    0    [1    /1   ]  7.01279212791        1
[INPUT] 1    0    [1    /1   ]  8.61544009908        1
[INPUT] 1    0    [1    /1   ]  0.492945258412       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24890414432769545, 1.0]], [0, [0.6518946217319795, 1.0]], [0, [117616.8137828416, 1.0]], [0, [2.892570970353362, 1.0]], [0, [1176168.1426168343, 1.0]], [0, [588084.0699801927, 1.0]], [0, [294042.031060474, 1.0]], [0, [147020.99186774855, 1.0]], [0, [73510.41980719594, 1.0]], [0, [36754.71378169678, 1.0]], [0, [7303.081875616665, 1.0]], [0, [18375.79675068729, 1.0]], [0, [1449.1185795685885, 1.0]], [0, [375.3621697174207, 1.0]], [0, [121.98834416479396, 1.0]], [0, [46.461395648101146, 1.0]], [0, [19.89861124473617, 1.0]], [0, [7.012792127910288, 1.0]], [1, [8.615440099076075, 1.0]], [1, [0.4929452584115319, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24890414]
bas 1, expnt(s) = [0.65189462]
bas 2, expnt(s) = [117616.81378284]
bas 3, expnt(s) = [2.89257097]
bas 4, expnt(s) = [1176168.14261683]
bas 5, expnt(s) = [588084.06998019]
bas 6, expnt(s) = [294042.03106047]
bas 7, expnt(s) = [147020.99186775]
bas 8, expnt(s) = [73510.4198072]
bas 9, expnt(s) = [36754.7137817]
bas 10, expnt(s) = [7303.08187562]
bas 11, expnt(s) = [18375.79675069]
bas 12, expnt(s) = [1449.11857957]
bas 13, expnt(s) = [375.36216972]
bas 14, expnt(s) = [121.98834416]
bas 15, expnt(s) = [46.46139565]
bas 16, expnt(s) = [19.89861124]
bas 17, expnt(s) = [7.01279213]
bas 18, expnt(s) = [8.6154401]
bas 19, expnt(s) = [0.49294526]
CPU time:       917.25
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48904144e-01 8.90305631e-01 6.51894622e-01 1.83293926e+00
 1.17616814e+05 1.60460109e+04 2.89257097e+00 5.60374084e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547138e+04 6.70655990e+03
 7.30308188e+03 1.99592699e+03 1.83757968e+04 3.98749047e+03
 1.44911858e+03 5.93393750e+02 3.75362170e+02 2.15453176e+02
 1.21988344e+02 9.27371567e+01 4.64613956e+01 4.49608189e+01
 1.98986112e+01 2.38030221e+01 7.01279213e+00 1.08876274e+01
 8.61544010e+00 4.30607140e+01 4.92945258e-01 1.20498810e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33560956022181
cond(S) = 909296.5299488124
E1 = -689.6551102611713  E_coul = 185.0243820389595
init E= -504.630728222212
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672127595006693  LUMO = 0.687805598790944
  mo_energy =
[-1.21696787e+02 -1.33818389e+01 -7.61993564e+00 -7.61993564e+00
 -7.61993564e+00 -1.65697647e+00 -6.72127595e-01 -6.72127595e-01
 -6.72127595e-01  6.87805599e-01  9.18541364e+00  5.13832838e+01
  2.01890455e+02  7.29871295e+02  2.87448906e+03  1.23408324e+04
  4.09533690e+04  1.04992137e+05  2.30172461e+05  4.55985200e+05
  8.44935806e+05  1.52811148e+06  2.85037694e+06  5.80826173e+06]
E1 = -707.803182702338  E_coul = 199.83609441703285
cycle= 1 E= -507.967088285305  delta_E= -3.34  |g|= 0.452  |ddm|= 0.502
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.70461
diis-c [-0.4964752  1.       ]
  HOMO = -0.217308303903262  LUMO = 1.07524692696389
  mo_energy =
[-1.20187311e+02 -1.23003666e+01 -6.59037848e+00 -6.59037848e+00
 -6.59037848e+00 -1.16267525e+00 -2.17308304e-01 -2.17308304e-01
 -2.17308304e-01  1.07524693e+00  1.00140883e+01  5.25944663e+01
  2.03321144e+02  7.31363294e+02  2.87592168e+03  1.23421557e+04
  4.09546255e+04  1.04993357e+05  2.30173657e+05  4.55986378e+05
  8.44936971e+05  1.52811264e+06  2.85037808e+06  5.80826287e+06]
E1 = -706.8591766634249  E_coul = 198.87448176294714
cycle= 2 E= -507.984694900478  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.431
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0296758
diis-c [-8.80088980e-04  1.06781348e-03  9.98932187e-01]
  HOMO = -0.239212454477405  LUMO = 1.06956166961084
  mo_energy =
[-1.20300660e+02 -1.23670092e+01 -6.66421342e+00 -6.66421342e+00
 -6.66421342e+00 -1.17675739e+00 -2.39212454e-01 -2.39212454e-01
 -2.39212454e-01  1.06956167e+00  9.97079428e+00  5.25179739e+01
  2.03221460e+02  7.31245896e+02  2.87578855e+03  1.23420123e+04
  4.09544782e+04  1.04993208e+05  2.30173507e+05  4.55986228e+05
  8.44936821e+05  1.52811249e+06  2.85037793e+06  5.80826272e+06]
E1 = -706.7529409859518  E_coul = 198.76799062814928
cycle= 3 E= -507.984950357803  delta_E= -0.000255  |g|= 0.00439  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.003236
diis-c [-2.20440585e-06 -1.59635127e-05 -1.07427684e-01  1.10744365e+00]
  HOMO = -0.242365172437888  LUMO = 1.06850961604485
  mo_energy =
[-1.20312655e+02 -1.23756660e+01 -6.67337701e+00 -6.67337701e+00
 -6.67337701e+00 -1.17866529e+00 -2.42365172e-01 -2.42365172e-01
 -2.42365172e-01  1.06850962e+00  9.96468341e+00  5.25086632e+01
  2.03210402e+02  7.31233734e+02  2.87577555e+03  1.23419988e+04
  4.09544646e+04  1.04993195e+05  2.30173493e+05  4.55986214e+05
  8.44936807e+05  1.52811247e+06  2.85037792e+06  5.80826270e+06]
E1 = -706.7377964904986  E_coul = 198.75284132437358
cycle= 4 E= -507.984955166125  delta_E= -4.81e-06  |g|= 0.000203  |ddm|= 0.00944
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141441
diis-c [-1.42926314e-10 -7.65307885e-06  7.16803188e-03 -9.87674642e-02
  1.09160709e+00]
  HOMO = -0.242502951656678  LUMO = 1.06845649465709
  mo_energy =
[-1.20312999e+02 -1.23759982e+01 -6.67370654e+00 -6.67370654e+00
 -6.67370654e+00 -1.17874735e+00 -2.42502952e-01 -2.42502952e-01
 -2.42502952e-01  1.06845649e+00  9.96442537e+00  5.25083372e+01
  2.03210062e+02  7.31233389e+02  2.87577520e+03  1.23419984e+04
  4.09544642e+04  1.04993194e+05  2.30173493e+05  4.55986214e+05
  8.44936807e+05  1.52811247e+06  2.85037792e+06  5.80826270e+06]
E1 = -706.7371427119306  E_coul = 198.75218753600555
cycle= 5 E= -507.984955175925  delta_E= -9.8e-09  |g|= 1.24e-06  |ddm|= 0.000462
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.84622e-07
diis-c [-7.39253923e-14  2.29779689e-07 -1.60708926e-04  2.01226738e-03
 -2.38570105e-02  1.02200522e+00]
  HOMO = -0.242503682806944  LUMO = 1.06845636849354
  mo_energy =
[-1.20313002e+02 -1.23759999e+01 -6.67370834e+00 -6.67370834e+00
 -6.67370834e+00 -1.17874793e+00 -2.42503683e-01 -2.42503683e-01
 -2.42503683e-01  1.06845637e+00  9.96442403e+00  5.25083353e+01
  2.03210060e+02  7.31233387e+02  2.87577520e+03  1.23419984e+04
  4.09544642e+04  1.04993194e+05  2.30173493e+05  4.55986214e+05
  8.44936807e+05  1.52811247e+06  2.85037792e+06  5.80826270e+06]
E1 = -706.7371389636818  E_coul = 198.75218378775622
cycle= 6 E= -507.984955175926  delta_E= -5.12e-13  |g|= 3.86e-08  |ddm|= 2.77e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7371389636818  E_coul = 198.75218378775622
  HOMO = -0.242503702295429  LUMO = 1.06845635692929
  mo_energy =
[-1.20313002e+02 -1.23759999e+01 -6.67370838e+00 -6.67370838e+00
 -6.67370838e+00 -1.17874794e+00 -2.42503702e-01 -2.42503702e-01
 -2.42503702e-01  1.06845636e+00  9.96442399e+00  5.25083353e+01
  2.03210060e+02  7.31233387e+02  2.87577520e+03  1.23419984e+04
  4.09544642e+04  1.04993194e+05  2.30173493e+05  4.55986214e+05
  8.44936807e+05  1.52811247e+06  2.85037792e+06  5.80826270e+06]
E1 = -706.7371388751387  E_coul = 198.75218369921328
Extra cycle  E= -507.984955175925  delta_E= 1.14e-13  |g|= 4.65e-09  |ddm|= 7.35e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.48904144e-01 6.51894622e-01 1.17616814e+05 2.89257097e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547138e+04 7.30308188e+03 1.83757968e+04
 1.44911858e+03 3.75362170e+02 1.21988344e+02 4.64613956e+01
 1.98986112e+01 7.01279213e+00 8.61544010e+00 4.92945258e-01]
E = -507.98495517592545
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:14:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248904144328       1
[INPUT] 0    0    [1    /1   ]  0.651894621732       1
[INPUT] 0    0    [1    /1   ]  117616.813783        1
[INPUT] 0    0    [1    /1   ]  2.89257097035        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.03106         1
[INPUT] 0    0    [1    /1   ]  147020.991868        1
[INPUT] 0    0    [1    /1   ]  73510.4198072        1
[INPUT] 0    0    [1    /1   ]  36754.7137817        1
[INPUT] 0    0    [1    /1   ]  7303.08187562        1
[INPUT] 0    0    [1    /1   ]  18375.7967507        1
[INPUT] 0    0    [1    /1   ]  1449.11857957        1
[INPUT] 0    0    [1    /1   ]  375.362169717        1
[INPUT] 0    0    [1    /1   ]  121.988344165        1
[INPUT] 0    0    [1    /1   ]  46.4613956481        1
[INPUT] 0    0    [1    /1   ]  19.8986112447        1
[INPUT] 0    0    [1    /1   ]  7.01279212791        1
[INPUT] 1    0    [1    /1   ]  8.61544009908        1
[INPUT] 1    0    [1    /1   ]  0.492945258412       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24890414432769545, 1.0]], [0, [0.6518946217319795, 1.0]], [0, [117616.8137828416, 1.0]], [0, [2.892570970353362, 1.0]], [0, [1176168.1426168343, 1.0]], [0, [588084.0699801927, 1.0]], [0, [294042.031060474, 1.0]], [0, [147020.99186774855, 1.0]], [0, [73510.41980719594, 1.0]], [0, [36754.71378169678, 1.0]], [0, [7303.081875616665, 1.0]], [0, [18375.79675068729, 1.0]], [0, [1449.1185795685885, 1.0]], [0, [375.3621697174207, 1.0]], [0, [121.98834416479396, 1.0]], [0, [46.461395648101146, 1.0]], [0, [19.89861124473617, 1.0]], [0, [7.012792127910288, 1.0]], [1, [8.615440099076075, 1.0]], [1, [0.4929452584115319, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24890414]
bas 1, expnt(s) = [0.65189462]
bas 2, expnt(s) = [117616.81378284]
bas 3, expnt(s) = [2.89257097]
bas 4, expnt(s) = [1176168.14261683]
bas 5, expnt(s) = [588084.06998019]
bas 6, expnt(s) = [294042.03106047]
bas 7, expnt(s) = [147020.99186775]
bas 8, expnt(s) = [73510.4198072]
bas 9, expnt(s) = [36754.7137817]
bas 10, expnt(s) = [7303.08187562]
bas 11, expnt(s) = [18375.79675069]
bas 12, expnt(s) = [1449.11857957]
bas 13, expnt(s) = [375.36216972]
bas 14, expnt(s) = [121.98834416]
bas 15, expnt(s) = [46.46139565]
bas 16, expnt(s) = [19.89861124]
bas 17, expnt(s) = [7.01279213]
bas 18, expnt(s) = [8.6154401]
bas 19, expnt(s) = [0.49294526]
CPU time:       918.78
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48904144e-01 8.90305631e-01 6.51894622e-01 1.83293926e+00
 1.17616814e+05 1.60460109e+04 2.89257097e+00 5.60374084e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547138e+04 6.70655990e+03
 7.30308188e+03 1.99592699e+03 1.83757968e+04 3.98749047e+03
 1.44911858e+03 5.93393750e+02 3.75362170e+02 2.15453176e+02
 1.21988344e+02 9.27371567e+01 4.64613956e+01 4.49608189e+01
 1.98986112e+01 2.38030221e+01 7.01279213e+00 1.08876274e+01
 8.61544010e+00 4.30607140e+01 4.92945258e-01 1.20498810e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33560956022181
cond(S) = 909296.5299488124
E1 = -689.6551102611713  E_coul = 185.0243820389595
init E= -504.630728222212
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672127595006693  LUMO = 0.687805598790944
  mo_energy =
[-1.21696787e+02 -1.33818389e+01 -7.61993564e+00 -7.61993564e+00
 -7.61993564e+00 -1.65697647e+00 -6.72127595e-01 -6.72127595e-01
 -6.72127595e-01  6.87805599e-01  9.18541364e+00  5.13832838e+01
  2.01890455e+02  7.29871295e+02  2.87448906e+03  1.23408324e+04
  4.09533690e+04  1.04992137e+05  2.30172461e+05  4.55985200e+05
  8.44935806e+05  1.52811148e+06  2.85037694e+06  5.80826173e+06]
E1 = -707.803182702338  E_coul = 199.83609441703285
cycle= 1 E= -507.967088285305  delta_E= -3.34  |g|= 0.452  |ddm|= 0.502
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.70461
diis-c [-0.4964752  1.       ]
  HOMO = -0.217308303903262  LUMO = 1.07524692696389
  mo_energy =
[-1.20187311e+02 -1.23003666e+01 -6.59037848e+00 -6.59037848e+00
 -6.59037848e+00 -1.16267525e+00 -2.17308304e-01 -2.17308304e-01
 -2.17308304e-01  1.07524693e+00  1.00140883e+01  5.25944663e+01
  2.03321144e+02  7.31363294e+02  2.87592168e+03  1.23421557e+04
  4.09546255e+04  1.04993357e+05  2.30173657e+05  4.55986378e+05
  8.44936971e+05  1.52811264e+06  2.85037808e+06  5.80826287e+06]
E1 = -706.8591766634249  E_coul = 198.87448176294714
cycle= 2 E= -507.984694900478  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.431
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0296758
diis-c [-8.80088980e-04  1.06781348e-03  9.98932187e-01]
  HOMO = -0.239212454477405  LUMO = 1.06956166961084
  mo_energy =
[-1.20300660e+02 -1.23670092e+01 -6.66421342e+00 -6.66421342e+00
 -6.66421342e+00 -1.17675739e+00 -2.39212454e-01 -2.39212454e-01
 -2.39212454e-01  1.06956167e+00  9.97079428e+00  5.25179739e+01
  2.03221460e+02  7.31245896e+02  2.87578855e+03  1.23420123e+04
  4.09544782e+04  1.04993208e+05  2.30173507e+05  4.55986228e+05
  8.44936821e+05  1.52811249e+06  2.85037793e+06  5.80826272e+06]
E1 = -706.7529409859518  E_coul = 198.76799062814928
cycle= 3 E= -507.984950357803  delta_E= -0.000255  |g|= 0.00439  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.003236
diis-c [-2.20440585e-06 -1.59635127e-05 -1.07427684e-01  1.10744365e+00]
  HOMO = -0.242365172437888  LUMO = 1.06850961604485
  mo_energy =
[-1.20312655e+02 -1.23756660e+01 -6.67337701e+00 -6.67337701e+00
 -6.67337701e+00 -1.17866529e+00 -2.42365172e-01 -2.42365172e-01
 -2.42365172e-01  1.06850962e+00  9.96468341e+00  5.25086632e+01
  2.03210402e+02  7.31233734e+02  2.87577555e+03  1.23419988e+04
  4.09544646e+04  1.04993195e+05  2.30173493e+05  4.55986214e+05
  8.44936807e+05  1.52811247e+06  2.85037792e+06  5.80826270e+06]
E1 = -706.7377964904986  E_coul = 198.75284132437358
cycle= 4 E= -507.984955166125  delta_E= -4.81e-06  |g|= 0.000203  |ddm|= 0.00944
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141441
diis-c [-1.42926314e-10 -7.65307885e-06  7.16803188e-03 -9.87674642e-02
  1.09160709e+00]
  HOMO = -0.242502951656678  LUMO = 1.06845649465709
  mo_energy =
[-1.20312999e+02 -1.23759982e+01 -6.67370654e+00 -6.67370654e+00
 -6.67370654e+00 -1.17874735e+00 -2.42502952e-01 -2.42502952e-01
 -2.42502952e-01  1.06845649e+00  9.96442537e+00  5.25083372e+01
  2.03210062e+02  7.31233389e+02  2.87577520e+03  1.23419984e+04
  4.09544642e+04  1.04993194e+05  2.30173493e+05  4.55986214e+05
  8.44936807e+05  1.52811247e+06  2.85037792e+06  5.80826270e+06]
E1 = -706.7371427119306  E_coul = 198.75218753600555
cycle= 5 E= -507.984955175925  delta_E= -9.8e-09  |g|= 1.24e-06  |ddm|= 0.000462
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.84622e-07
diis-c [-7.39253923e-14  2.29779689e-07 -1.60708926e-04  2.01226738e-03
 -2.38570105e-02  1.02200522e+00]
  HOMO = -0.242503682806944  LUMO = 1.06845636849354
  mo_energy =
[-1.20313002e+02 -1.23759999e+01 -6.67370834e+00 -6.67370834e+00
 -6.67370834e+00 -1.17874793e+00 -2.42503683e-01 -2.42503683e-01
 -2.42503683e-01  1.06845637e+00  9.96442403e+00  5.25083353e+01
  2.03210060e+02  7.31233387e+02  2.87577520e+03  1.23419984e+04
  4.09544642e+04  1.04993194e+05  2.30173493e+05  4.55986214e+05
  8.44936807e+05  1.52811247e+06  2.85037792e+06  5.80826270e+06]
E1 = -706.7371389636818  E_coul = 198.75218378775622
cycle= 6 E= -507.984955175926  delta_E= -5.12e-13  |g|= 3.86e-08  |ddm|= 2.77e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7371389636818  E_coul = 198.75218378775622
  HOMO = -0.242503702295429  LUMO = 1.06845635692929
  mo_energy =
[-1.20313002e+02 -1.23759999e+01 -6.67370838e+00 -6.67370838e+00
 -6.67370838e+00 -1.17874794e+00 -2.42503702e-01 -2.42503702e-01
 -2.42503702e-01  1.06845636e+00  9.96442399e+00  5.25083353e+01
  2.03210060e+02  7.31233387e+02  2.87577520e+03  1.23419984e+04
  4.09544642e+04  1.04993194e+05  2.30173493e+05  4.55986214e+05
  8.44936807e+05  1.52811247e+06  2.85037792e+06  5.80826270e+06]
E1 = -706.7371388751387  E_coul = 198.75218369921328
Extra cycle  E= -507.984955175925  delta_E= 1.14e-13  |g|= 4.65e-09  |ddm|= 7.35e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909296.5299488124
E1 = -706.7371388751387  E_coul = 198.75218369921328
init E= -507.984955175925
    CPU time for initialize scf      3.57 sec, wall time      0.23 sec
  HOMO = -0.24250370499972  LUMO = 1.06845635747786
  mo_energy =
[-1.20313002e+02 -1.23759999e+01 -6.67370839e+00 -6.67370839e+00
 -6.67370839e+00 -1.17874794e+00 -2.42503705e-01 -2.42503705e-01
 -2.42503705e-01  1.06845636e+00  9.96442399e+00  5.25083353e+01
  2.03210060e+02  7.31233387e+02  2.87577520e+03  1.23419984e+04
  4.09544642e+04  1.04993194e+05  2.30173493e+05  4.55986214e+05
  8.44936807e+05  1.52811247e+06  2.85037792e+06  5.80826270e+06]
E1 = -706.7371388611547  E_coul = 198.75218368522877
cycle= 1 E= -507.984955175926  delta_E= -4.55e-13  |g|= 1.1e-09  |ddm|= 1e-08
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.7371388611547  E_coul = 198.75218368522877
  HOMO = -0.24250370541474  LUMO = 1.06845635692556
  mo_energy =
[-1.20313002e+02 -1.23759999e+01 -6.67370839e+00 -6.67370839e+00
 -6.67370839e+00 -1.17874794e+00 -2.42503705e-01 -2.42503705e-01
 -2.42503705e-01  1.06845636e+00  9.96442398e+00  5.25083353e+01
  2.03210060e+02  7.31233387e+02  2.87577520e+03  1.23419984e+04
  4.09544642e+04  1.04993194e+05  2.30173493e+05  4.55986214e+05
  8.44936807e+05  1.52811247e+06  2.85037792e+06  5.80826270e+06]
E1 = -706.737138860791  E_coul = 198.7521836848658
Extra cycle  E= -507.984955175925  delta_E= 7.39e-13  |g|= 1.72e-09  |ddm|= 3.7e-10
    CPU time for scf_cycle      4.02 sec, wall time      0.39 sec
exp = [2.48904144e-01 6.51894622e-01 1.17616814e+05 2.89257097e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547138e+04 7.30308188e+03 1.83757968e+04
 1.44911858e+03 3.75362170e+02 1.21988344e+02 4.64613956e+01
 1.98986112e+01 7.01279213e+00 8.61544010e+00 4.92945258e-01]
grad_E = [ 1.18056690e-03 -1.72448420e-04  3.68963325e-09  9.34644029e-04
  1.28649984e-11  9.68026799e-11  5.74338684e-10  2.24746248e-09
  9.31925537e-09  5.06897279e-08  3.13120360e-06  1.03551949e-07
  3.05064799e-05 -2.46599526e-04  9.51606750e-05 -3.04147261e-04
  2.11921325e-04 -4.40458944e-04  9.23586197e-03 -2.70353521e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:15:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248618303181       1
[INPUT] 0    0    [1    /1   ]  0.650464769896       1
[INPUT] 0    0    [1    /1   ]  117616.813772        1
[INPUT] 0    0    [1    /1   ]  2.90156024387        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031059        1
[INPUT] 0    0    [1    /1   ]  147020.991861        1
[INPUT] 0    0    [1    /1   ]  73510.4197792        1
[INPUT] 0    0    [1    /1   ]  36754.7136306        1
[INPUT] 0    0    [1    /1   ]  7303.07242564        1
[INPUT] 0    0    [1    /1   ]  18375.7964307        1
[INPUT] 0    0    [1    /1   ]  1449.07961768        1
[INPUT] 0    0    [1    /1   ]  375.584111183        1
[INPUT] 0    0    [1    /1   ]  122.902963938        1
[INPUT] 0    0    [1    /1   ]  46.8369561515        1
[INPUT] 0    0    [1    /1   ]  19.3620872947        1
[INPUT] 0    0    [1    /1   ]  7.04585680014        1
[INPUT] 1    0    [1    /1   ]  8.61574571753        1
[INPUT] 1    0    [1    /1   ]  0.492951261853       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24861830318053052, 1.0]], [0, [0.650464769896493, 1.0]], [0, [117616.81377178268, 1.0]], [0, [2.9015602438672636, 1.0]], [0, [1176168.142616788, 1.0]], [0, [588084.069979897, 1.0]], [0, [294042.03105875314, 1.0]], [0, [147020.99186100438, 1.0]], [0, [73510.4197791937, 1.0]], [0, [36754.713630552505, 1.0]], [0, [7303.072425635347, 1.0]], [0, [18375.79643067068, 1.0]], [0, [1449.079617675711, 1.0]], [0, [375.58411118266844, 1.0]], [0, [122.90296393800666, 1.0]], [0, [46.83695615150646, 1.0]], [0, [19.36208729474589, 1.0]], [0, [7.045856800138817, 1.0]], [1, [8.615745717527965, 1.0]], [1, [0.4929512618531166, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2486183]
bas 1, expnt(s) = [0.65046477]
bas 2, expnt(s) = [117616.81377178]
bas 3, expnt(s) = [2.90156024]
bas 4, expnt(s) = [1176168.14261679]
bas 5, expnt(s) = [588084.0699799]
bas 6, expnt(s) = [294042.03105875]
bas 7, expnt(s) = [147020.991861]
bas 8, expnt(s) = [73510.41977919]
bas 9, expnt(s) = [36754.71363055]
bas 10, expnt(s) = [7303.07242564]
bas 11, expnt(s) = [18375.79643067]
bas 12, expnt(s) = [1449.07961768]
bas 13, expnt(s) = [375.58411118]
bas 14, expnt(s) = [122.90296394]
bas 15, expnt(s) = [46.83695615]
bas 16, expnt(s) = [19.36208729]
bas 17, expnt(s) = [7.0458568]
bas 18, expnt(s) = [8.61574572]
bas 19, expnt(s) = [0.49295126]
CPU time:       930.76
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48618303e-01 8.89538701e-01 6.50464770e-01 1.82992318e+00
 1.17616814e+05 1.60460109e+04 2.90156024e+00 5.61679687e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547136e+04 6.70655988e+03
 7.30307243e+03 1.99592506e+03 1.83757964e+04 3.98749042e+03
 1.44907962e+03 5.93381784e+02 3.75584111e+02 2.15548712e+02
 1.22902964e+02 9.32581491e+01 4.68369562e+01 4.52331176e+01
 1.93620873e+01 2.33200327e+01 7.04585680e+00 1.09261053e+01
 8.61574572e+00 4.30626234e+01 4.92951262e-01 1.20500645e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335600739217867
cond(S) = 909325.144835402
E1 = -689.6567800379132  E_coul = 185.0258131890022
init E= -504.630966848911
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672128703757477  LUMO = 0.685738593090752
  mo_energy =
[-1.21696568e+02 -1.33817173e+01 -7.61983748e+00 -7.61983748e+00
 -7.61983748e+00 -1.65696954e+00 -6.72128704e-01 -6.72128704e-01
 -6.72128704e-01  6.85738593e-01  9.19537270e+00  5.09436813e+01
  2.01477572e+02  7.31644893e+02  2.87792948e+03  1.23443405e+04
  4.09566723e+04  1.04995308e+05  2.30175543e+05  4.55988217e+05
  8.44938773e+05  1.52811440e+06  2.85037980e+06  5.80826451e+06]
E1 = -707.8050377726565  E_coul = 199.83780208403715
cycle= 1 E= -507.967235688619  delta_E= -3.34  |g|= 0.452  |ddm|= 0.502
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.704016
diis-c [-0.49563909  1.        ]
  HOMO = -0.217293875725493  LUMO = 1.07287942820813
  mo_energy =
[-1.20187062e+02 -1.23002292e+01 -6.59026595e+00 -6.59026595e+00
 -6.59026595e+00 -1.16265975e+00 -2.17293876e-01 -2.17293876e-01
 -2.17293876e-01  1.07287943e+00  1.00239848e+01  5.21520713e+01
  2.02908406e+02  7.33137009e+02  2.87936214e+03  1.23456639e+04
  4.09579288e+04  1.04996528e+05  2.30176738e+05  4.55989395e+05
  8.44939938e+05  1.52811556e+06  2.85038094e+06  5.80826565e+06]
E1 = -706.8612388495043  E_coul = 198.87640163949547
cycle= 2 E= -507.984837210009  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.432
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0296997
diis-c [-8.81705920e-04  8.62347204e-04  9.99137653e-01]
  HOMO = -0.23920281625468  LUMO = 1.06720465381734
  mo_energy =
[-1.20300401e+02 -1.23668690e+01 -6.66409690e+00 -6.66409690e+00
 -6.66409690e+00 -1.17674576e+00 -2.39202816e-01 -2.39202816e-01
 -2.39202816e-01  1.06720465e+00  9.98069060e+00  5.20757907e+01
  2.02808695e+02  7.33019575e+02  2.87922903e+03  1.23455204e+04
  4.09577816e+04  1.04996379e+05  2.30176588e+05  4.55989245e+05
  8.44939788e+05  1.52811541e+06  2.85038079e+06  5.80826550e+06]
E1 = -706.7549285898741  E_coul = 198.76983562945665
cycle= 3 E= -507.985092960417  delta_E= -0.000256  |g|= 0.00438  |ddm|= 0.0602
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0032348
diis-c [-2.21377962e-06 -1.16147664e-05 -1.07209316e-01  1.10722093e+00]
  HOMO = -0.242353438434837  LUMO = 1.06615471168858
  mo_energy =
[-1.20312376e+02 -1.23755159e+01 -6.67324901e+00 -6.67324901e+00
 -6.67324901e+00 -1.17865234e+00 -2.42353438e-01 -2.42353438e-01
 -2.42353438e-01  1.06615471e+00  9.97458422e+00  5.20665093e+01
  2.02797652e+02  7.33007431e+02  2.87921605e+03  1.23455070e+04
  4.09577679e+04  1.04996366e+05  2.30176575e+05  4.55989231e+05
  8.44939774e+05  1.52811539e+06  2.85038078e+06  5.80826549e+06]
E1 = -706.739787309215  E_coul = 198.7546895406066
cycle= 4 E= -507.985097768608  delta_E= -4.81e-06  |g|= 0.000204  |ddm|= 0.00944
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141981
diis-c [-1.42056408e-10 -7.57396051e-06  7.14822225e-03 -9.88710859e-02
  1.09173044e+00]
  HOMO = -0.242491776337633  LUMO = 1.06610148528789
  mo_energy =
[-1.20312722e+02 -1.23758495e+01 -6.67358003e+00 -6.67358003e+00
 -6.67358003e+00 -1.17873474e+00 -2.42491776e-01 -2.42491776e-01
 -2.42491776e-01  1.06610149e+00  9.97432507e+00  5.20661820e+01
  2.02797311e+02  7.33007084e+02  2.87921570e+03  1.23455066e+04
  4.09577676e+04  1.04996365e+05  2.30176574e+05  4.55989231e+05
  8.44939774e+05  1.52811539e+06  2.85038078e+06  5.80826549e+06]
E1 = -706.7391304931309  E_coul = 198.75403271464228
cycle= 5 E= -507.985097778489  delta_E= -9.88e-09  |g|= 1.24e-06  |ddm|= 0.000464
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.83458e-07
diis-c [-7.44968225e-14  2.27995066e-07 -1.59492892e-04  2.00340733e-03
 -2.37249161e-02  1.02188077e+00]
  HOMO = -0.242492505845789  LUMO = 1.06610136166495
  mo_energy =
[-1.20312725e+02 -1.23758513e+01 -6.67358183e+00 -6.67358183e+00
 -6.67358183e+00 -1.17873532e+00 -2.42492506e-01 -2.42492506e-01
 -2.42492506e-01  1.06610136e+00  9.97432372e+00  5.20661801e+01
  2.02797308e+02  7.33007081e+02  2.87921570e+03  1.23455066e+04
  4.09577676e+04  1.04996365e+05  2.30176574e+05  4.55989231e+05
  8.44939774e+05  1.52811539e+06  2.85038078e+06  5.80826549e+06]
E1 = -706.7391267482192  E_coul = 198.75402896973048
cycle= 6 E= -507.985097778489  delta_E= -5.68e-14  |g|= 3.89e-08  |ddm|= 2.76e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7391267482192  E_coul = 198.75402896973048
  HOMO = -0.242492525488048  LUMO = 1.06610134923117
  mo_energy =
[-1.20312725e+02 -1.23758513e+01 -6.67358187e+00 -6.67358187e+00
 -6.67358187e+00 -1.17873533e+00 -2.42492525e-01 -2.42492525e-01
 -2.42492525e-01  1.06610135e+00  9.97432369e+00  5.20661801e+01
  2.02797308e+02  7.33007081e+02  2.87921570e+03  1.23455066e+04
  4.09577676e+04  1.04996365e+05  2.30176574e+05  4.55989231e+05
  8.44939774e+05  1.52811539e+06  2.85038078e+06  5.80826549e+06]
E1 = -706.7391266599857  E_coul = 198.7540288814967
Extra cycle  E= -507.985097778489  delta_E= -2.84e-13  |g|= 5.1e-09  |ddm|= 7.33e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.48618303e-01 6.50464770e-01 1.17616814e+05 2.90156024e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547136e+04 7.30307243e+03 1.83757964e+04
 1.44907962e+03 3.75584111e+02 1.22902964e+02 4.68369562e+01
 1.93620873e+01 7.04585680e+00 8.61574572e+00 4.92951262e-01]
E = -507.985097778489
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:15:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248618303181       1
[INPUT] 0    0    [1    /1   ]  0.650464769896       1
[INPUT] 0    0    [1    /1   ]  117616.813772        1
[INPUT] 0    0    [1    /1   ]  2.90156024387        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031059        1
[INPUT] 0    0    [1    /1   ]  147020.991861        1
[INPUT] 0    0    [1    /1   ]  73510.4197792        1
[INPUT] 0    0    [1    /1   ]  36754.7136306        1
[INPUT] 0    0    [1    /1   ]  7303.07242564        1
[INPUT] 0    0    [1    /1   ]  18375.7964307        1
[INPUT] 0    0    [1    /1   ]  1449.07961768        1
[INPUT] 0    0    [1    /1   ]  375.584111183        1
[INPUT] 0    0    [1    /1   ]  122.902963938        1
[INPUT] 0    0    [1    /1   ]  46.8369561515        1
[INPUT] 0    0    [1    /1   ]  19.3620872947        1
[INPUT] 0    0    [1    /1   ]  7.04585680014        1
[INPUT] 1    0    [1    /1   ]  8.61574571753        1
[INPUT] 1    0    [1    /1   ]  0.492951261853       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24861830318053052, 1.0]], [0, [0.650464769896493, 1.0]], [0, [117616.81377178268, 1.0]], [0, [2.9015602438672636, 1.0]], [0, [1176168.142616788, 1.0]], [0, [588084.069979897, 1.0]], [0, [294042.03105875314, 1.0]], [0, [147020.99186100438, 1.0]], [0, [73510.4197791937, 1.0]], [0, [36754.713630552505, 1.0]], [0, [7303.072425635347, 1.0]], [0, [18375.79643067068, 1.0]], [0, [1449.079617675711, 1.0]], [0, [375.58411118266844, 1.0]], [0, [122.90296393800666, 1.0]], [0, [46.83695615150646, 1.0]], [0, [19.36208729474589, 1.0]], [0, [7.045856800138817, 1.0]], [1, [8.615745717527965, 1.0]], [1, [0.4929512618531166, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2486183]
bas 1, expnt(s) = [0.65046477]
bas 2, expnt(s) = [117616.81377178]
bas 3, expnt(s) = [2.90156024]
bas 4, expnt(s) = [1176168.14261679]
bas 5, expnt(s) = [588084.0699799]
bas 6, expnt(s) = [294042.03105875]
bas 7, expnt(s) = [147020.991861]
bas 8, expnt(s) = [73510.41977919]
bas 9, expnt(s) = [36754.71363055]
bas 10, expnt(s) = [7303.07242564]
bas 11, expnt(s) = [18375.79643067]
bas 12, expnt(s) = [1449.07961768]
bas 13, expnt(s) = [375.58411118]
bas 14, expnt(s) = [122.90296394]
bas 15, expnt(s) = [46.83695615]
bas 16, expnt(s) = [19.36208729]
bas 17, expnt(s) = [7.0458568]
bas 18, expnt(s) = [8.61574572]
bas 19, expnt(s) = [0.49295126]
CPU time:       932.29
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48618303e-01 8.89538701e-01 6.50464770e-01 1.82992318e+00
 1.17616814e+05 1.60460109e+04 2.90156024e+00 5.61679687e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547136e+04 6.70655988e+03
 7.30307243e+03 1.99592506e+03 1.83757964e+04 3.98749042e+03
 1.44907962e+03 5.93381784e+02 3.75584111e+02 2.15548712e+02
 1.22902964e+02 9.32581491e+01 4.68369562e+01 4.52331176e+01
 1.93620873e+01 2.33200327e+01 7.04585680e+00 1.09261053e+01
 8.61574572e+00 4.30626234e+01 4.92951262e-01 1.20500645e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335600739217867
cond(S) = 909325.144835402
E1 = -689.6567800379132  E_coul = 185.0258131890022
init E= -504.630966848911
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672128703757477  LUMO = 0.685738593090752
  mo_energy =
[-1.21696568e+02 -1.33817173e+01 -7.61983748e+00 -7.61983748e+00
 -7.61983748e+00 -1.65696954e+00 -6.72128704e-01 -6.72128704e-01
 -6.72128704e-01  6.85738593e-01  9.19537270e+00  5.09436813e+01
  2.01477572e+02  7.31644893e+02  2.87792948e+03  1.23443405e+04
  4.09566723e+04  1.04995308e+05  2.30175543e+05  4.55988217e+05
  8.44938773e+05  1.52811440e+06  2.85037980e+06  5.80826451e+06]
E1 = -707.8050377726565  E_coul = 199.83780208403715
cycle= 1 E= -507.967235688619  delta_E= -3.34  |g|= 0.452  |ddm|= 0.502
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.704016
diis-c [-0.49563909  1.        ]
  HOMO = -0.217293875725493  LUMO = 1.07287942820813
  mo_energy =
[-1.20187062e+02 -1.23002292e+01 -6.59026595e+00 -6.59026595e+00
 -6.59026595e+00 -1.16265975e+00 -2.17293876e-01 -2.17293876e-01
 -2.17293876e-01  1.07287943e+00  1.00239848e+01  5.21520713e+01
  2.02908406e+02  7.33137009e+02  2.87936214e+03  1.23456639e+04
  4.09579288e+04  1.04996528e+05  2.30176738e+05  4.55989395e+05
  8.44939938e+05  1.52811556e+06  2.85038094e+06  5.80826565e+06]
E1 = -706.8612388495043  E_coul = 198.87640163949547
cycle= 2 E= -507.984837210009  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.432
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0296997
diis-c [-8.81705920e-04  8.62347204e-04  9.99137653e-01]
  HOMO = -0.23920281625468  LUMO = 1.06720465381734
  mo_energy =
[-1.20300401e+02 -1.23668690e+01 -6.66409690e+00 -6.66409690e+00
 -6.66409690e+00 -1.17674576e+00 -2.39202816e-01 -2.39202816e-01
 -2.39202816e-01  1.06720465e+00  9.98069060e+00  5.20757907e+01
  2.02808695e+02  7.33019575e+02  2.87922903e+03  1.23455204e+04
  4.09577816e+04  1.04996379e+05  2.30176588e+05  4.55989245e+05
  8.44939788e+05  1.52811541e+06  2.85038079e+06  5.80826550e+06]
E1 = -706.7549285898741  E_coul = 198.76983562945665
cycle= 3 E= -507.985092960417  delta_E= -0.000256  |g|= 0.00438  |ddm|= 0.0602
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0032348
diis-c [-2.21377962e-06 -1.16147664e-05 -1.07209316e-01  1.10722093e+00]
  HOMO = -0.242353438434837  LUMO = 1.06615471168858
  mo_energy =
[-1.20312376e+02 -1.23755159e+01 -6.67324901e+00 -6.67324901e+00
 -6.67324901e+00 -1.17865234e+00 -2.42353438e-01 -2.42353438e-01
 -2.42353438e-01  1.06615471e+00  9.97458422e+00  5.20665093e+01
  2.02797652e+02  7.33007431e+02  2.87921605e+03  1.23455070e+04
  4.09577679e+04  1.04996366e+05  2.30176575e+05  4.55989231e+05
  8.44939774e+05  1.52811539e+06  2.85038078e+06  5.80826549e+06]
E1 = -706.739787309215  E_coul = 198.7546895406066
cycle= 4 E= -507.985097768608  delta_E= -4.81e-06  |g|= 0.000204  |ddm|= 0.00944
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000141981
diis-c [-1.42056408e-10 -7.57396051e-06  7.14822225e-03 -9.88710859e-02
  1.09173044e+00]
  HOMO = -0.242491776337633  LUMO = 1.06610148528789
  mo_energy =
[-1.20312722e+02 -1.23758495e+01 -6.67358003e+00 -6.67358003e+00
 -6.67358003e+00 -1.17873474e+00 -2.42491776e-01 -2.42491776e-01
 -2.42491776e-01  1.06610149e+00  9.97432507e+00  5.20661820e+01
  2.02797311e+02  7.33007084e+02  2.87921570e+03  1.23455066e+04
  4.09577676e+04  1.04996365e+05  2.30176574e+05  4.55989231e+05
  8.44939774e+05  1.52811539e+06  2.85038078e+06  5.80826549e+06]
E1 = -706.7391304931309  E_coul = 198.75403271464228
cycle= 5 E= -507.985097778489  delta_E= -9.88e-09  |g|= 1.24e-06  |ddm|= 0.000464
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.83458e-07
diis-c [-7.44968225e-14  2.27995066e-07 -1.59492892e-04  2.00340733e-03
 -2.37249161e-02  1.02188077e+00]
  HOMO = -0.242492505845789  LUMO = 1.06610136166495
  mo_energy =
[-1.20312725e+02 -1.23758513e+01 -6.67358183e+00 -6.67358183e+00
 -6.67358183e+00 -1.17873532e+00 -2.42492506e-01 -2.42492506e-01
 -2.42492506e-01  1.06610136e+00  9.97432372e+00  5.20661801e+01
  2.02797308e+02  7.33007081e+02  2.87921570e+03  1.23455066e+04
  4.09577676e+04  1.04996365e+05  2.30176574e+05  4.55989231e+05
  8.44939774e+05  1.52811539e+06  2.85038078e+06  5.80826549e+06]
E1 = -706.7391267482192  E_coul = 198.75402896973048
cycle= 6 E= -507.985097778489  delta_E= -5.68e-14  |g|= 3.89e-08  |ddm|= 2.76e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7391267482192  E_coul = 198.75402896973048
  HOMO = -0.242492525488048  LUMO = 1.06610134923117
  mo_energy =
[-1.20312725e+02 -1.23758513e+01 -6.67358187e+00 -6.67358187e+00
 -6.67358187e+00 -1.17873533e+00 -2.42492525e-01 -2.42492525e-01
 -2.42492525e-01  1.06610135e+00  9.97432369e+00  5.20661801e+01
  2.02797308e+02  7.33007081e+02  2.87921570e+03  1.23455066e+04
  4.09577676e+04  1.04996365e+05  2.30176574e+05  4.55989231e+05
  8.44939774e+05  1.52811539e+06  2.85038078e+06  5.80826549e+06]
E1 = -706.7391266599857  E_coul = 198.7540288814967
Extra cycle  E= -507.985097778489  delta_E= -2.84e-13  |g|= 5.1e-09  |ddm|= 7.33e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909325.144835402
E1 = -706.7391266599857  E_coul = 198.7540288814967
init E= -507.985097778489
    CPU time for initialize scf      4.34 sec, wall time      0.28 sec
  HOMO = -0.242492528183289  LUMO = 1.06610134818997
  mo_energy =
[-1.20312725e+02 -1.23758513e+01 -6.67358188e+00 -6.67358188e+00
 -6.67358188e+00 -1.17873533e+00 -2.42492528e-01 -2.42492528e-01
 -2.42492528e-01  1.06610135e+00  9.97432368e+00  5.20661801e+01
  2.02797308e+02  7.33007081e+02  2.87921570e+03  1.23455066e+04
  4.09577676e+04  1.04996365e+05  2.30176574e+05  4.55989231e+05
  8.44939774e+05  1.52811539e+06  2.85038078e+06  5.80826549e+06]
E1 = -706.7391266478502  E_coul = 198.7540288693615
cycle= 1 E= -507.985097778489  delta_E= 2.84e-13  |g|= 1.86e-09  |ddm|= 8.76e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.7391266478502  E_coul = 198.7540288693615
  HOMO = -0.242492528542136  LUMO = 1.06610134924381
  mo_energy =
[-1.20312725e+02 -1.23758513e+01 -6.67358188e+00 -6.67358188e+00
 -6.67358188e+00 -1.17873533e+00 -2.42492529e-01 -2.42492529e-01
 -2.42492529e-01  1.06610135e+00  9.97432368e+00  5.20661801e+01
  2.02797308e+02  7.33007081e+02  2.87921570e+03  1.23455066e+04
  4.09577676e+04  1.04996365e+05  2.30176574e+05  4.55989231e+05
  8.44939774e+05  1.52811539e+06  2.85038078e+06  5.80826549e+06]
E1 = -706.7391266436048  E_coul = 198.75402886511546
Extra cycle  E= -507.985097778489  delta_E= -6.25e-13  |g|= 1.06e-09  |ddm|= 2.84e-09
    CPU time for scf_cycle      4.79 sec, wall time      0.44 sec
exp = [2.48618303e-01 6.50464770e-01 1.17616814e+05 2.90156024e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547136e+04 7.30307243e+03 1.83757964e+04
 1.44907962e+03 3.75584111e+02 1.22902964e+02 4.68369562e+01
 1.93620873e+01 7.04585680e+00 8.61574572e+00 4.92951262e-01]
grad_E = [ 1.20819676e-03 -2.75141111e-04  3.63896325e-09  1.12371202e-03
  1.22505212e-11  9.51639343e-11  5.66467771e-10  2.21617389e-09
  9.18755408e-09  5.00352552e-08  3.08306914e-06  1.01617793e-07
  3.32852936e-05 -2.72992793e-04  1.32429358e-04 -2.17598214e-04
  1.07153372e-04 -4.77547779e-04  9.48298732e-03 -2.78581228e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:15:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247974902206       1
[INPUT] 0    0    [1    /1   ]  0.648976390119       1
[INPUT] 0    0    [1    /1   ]  117616.813765        1
[INPUT] 0    0    [1    /1   ]  2.9085618781         1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031058        1
[INPUT] 0    0    [1    /1   ]  147020.991857        1
[INPUT] 0    0    [1    /1   ]  73510.4197609        1
[INPUT] 0    0    [1    /1   ]  36754.7135319        1
[INPUT] 0    0    [1    /1   ]  7303.06626365        1
[INPUT] 0    0    [1    /1   ]  18375.7962226        1
[INPUT] 0    0    [1    /1   ]  1449.05044538        1
[INPUT] 0    0    [1    /1   ]  375.76422573         1
[INPUT] 0    0    [1    /1   ]  123.430836422        1
[INPUT] 0    0    [1    /1   ]  47.1209285555        1
[INPUT] 0    0    [1    /1   ]  18.933584373         1
[INPUT] 0    0    [1    /1   ]  7.09493052554        1
[INPUT] 1    0    [1    /1   ]  8.61091600194        1
[INPUT] 1    0    [1    /1   ]  0.492853822315       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2479749022058364, 1.0]], [0, [0.6489763901186425, 1.0]], [0, [117616.81376456724, 1.0]], [0, [2.9085618780956928, 1.0]], [0, [1176168.1426167584, 1.0]], [0, [588084.0699797045, 1.0]], [0, [294042.0310576303, 1.0]], [0, [147020.99185660473, 1.0]], [0, [73510.41976092898, 1.0]], [0, [36754.71353187601, 1.0]], [0, [7303.06626364664, 1.0]], [0, [18375.79622262969, 1.0]], [0, [1449.0504453807796, 1.0]], [0, [375.7642257300908, 1.0]], [0, [123.4308364215679, 1.0]], [0, [47.120928555477555, 1.0]], [0, [18.933584372951774, 1.0]], [0, [7.094930525541522, 1.0]], [1, [8.610916001936328, 1.0]], [1, [0.492853822315067, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2479749]
bas 1, expnt(s) = [0.64897639]
bas 2, expnt(s) = [117616.81376457]
bas 3, expnt(s) = [2.90856188]
bas 4, expnt(s) = [1176168.14261676]
bas 5, expnt(s) = [588084.0699797]
bas 6, expnt(s) = [294042.03105763]
bas 7, expnt(s) = [147020.9918566]
bas 8, expnt(s) = [73510.41976093]
bas 9, expnt(s) = [36754.71353188]
bas 10, expnt(s) = [7303.06626365]
bas 11, expnt(s) = [18375.79622263]
bas 12, expnt(s) = [1449.05044538]
bas 13, expnt(s) = [375.76422573]
bas 14, expnt(s) = [123.43083642]
bas 15, expnt(s) = [47.12092856]
bas 16, expnt(s) = [18.93358437]
bas 17, expnt(s) = [7.09493053]
bas 18, expnt(s) = [8.610916]
bas 19, expnt(s) = [0.49285382]
CPU time:       945.03
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47974902e-01 8.87811610e-01 6.48976390e-01 1.82678189e+00
 1.17616814e+05 1.60460109e+04 2.90856188e+00 5.62695905e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547135e+04 6.70655987e+03
 7.30306626e+03 1.99592379e+03 1.83757962e+04 3.98749038e+03
 1.44905045e+03 5.93372825e+02 3.75764226e+02 2.15626234e+02
 1.23430836e+02 9.35583983e+01 4.71209286e+01 4.54386484e+01
 1.89335844e+01 2.29318796e+01 7.09493053e+00 1.09831303e+01
 8.61091600e+00 4.30324511e+01 4.92853822e-01 1.20470872e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335755685840475
cond(S) = 909341.9393528773
E1 = -689.6320650421726  E_coul = 185.00139522775652
init E= -504.630669814416
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672185794319211  LUMO = 0.682336335737873
  mo_energy =
[-1.21701391e+02 -1.33836379e+01 -7.62154140e+00 -7.62154140e+00
 -7.62154140e+00 -1.65714244e+00 -6.72185794e-01 -6.72185794e-01
 -6.72185794e-01  6.82336336e-01  9.21100681e+00  5.06361415e+01
  2.01081505e+02  7.32592237e+02  2.87997310e+03  1.23464634e+04
  4.09586746e+04  1.04997230e+05  2.30177410e+05  4.55990045e+05
  8.44940571e+05  1.52811617e+06  2.85038153e+06  5.80826620e+06]
E1 = -707.7763808858989  E_coul = 199.80902927356254
cycle= 1 E= -507.967351612336  delta_E= -3.34  |g|= 0.451  |ddm|= 0.503
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.703453
diis-c [-0.49484587  1.        ]
  HOMO = -0.217516240752183  LUMO = 1.0688961437155
  mo_energy =
[-1.20192274e+02 -1.23024203e+01 -6.59229687e+00 -6.59229687e+00
 -6.59229687e+00 -1.16293147e+00 -2.17516241e-01 -2.17516241e-01
 -2.17516241e-01  1.06889614e+00  1.00397954e+01  5.18420418e+01
  2.02511972e+02  7.34084044e+02  2.88140544e+03  1.23477865e+04
  4.09599308e+04  1.04998450e+05  2.30178605e+05  4.55991223e+05
  8.44941736e+05  1.52811733e+06  2.85038267e+06  5.80826734e+06]
E1 = -706.8331788760132  E_coul = 198.84824403619936
cycle= 2 E= -507.984934839814  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.432
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297298
diis-c [-8.83628380e-04  6.83580981e-04  9.99316419e-01]
  HOMO = -0.239419270043888  LUMO = 1.06323957471168
  mo_energy =
[-1.20305551e+02 -1.23690326e+01 -6.66608957e+00 -6.66608957e+00
 -6.66608957e+00 -1.17701886e+00 -2.39419270e-01 -2.39419270e-01
 -2.39419270e-01  1.06323957e+00  9.99649140e+00  5.17659531e+01
  2.02412302e+02  7.33966647e+02  2.88127240e+03  1.23476432e+04
  4.09597837e+04  1.04998301e+05  2.30178456e+05  4.55991073e+05
  8.44941586e+05  1.52811718e+06  2.85038252e+06  5.80826719e+06]
E1 = -706.7268059286109  E_coul = 198.74161506726833
cycle= 3 E= -507.985190861343  delta_E= -0.000256  |g|= 0.00438  |ddm|= 0.0602
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00323706
diis-c [-2.22285373e-06 -9.68346321e-06 -1.07129781e-01  1.10713946e+00]
  HOMO = -0.242568638225119  LUMO = 1.06219230064924
  mo_energy =
[-1.20317509e+02 -1.23776720e+01 -6.67523228e+00 -6.67523228e+00
 -6.67523228e+00 -1.17892523e+00 -2.42568638e-01 -2.42568638e-01
 -2.42568638e-01  1.06219230e+00  9.99038465e+00  5.17566943e+01
  2.02401273e+02  7.33954518e+02  2.88125945e+03  1.23476297e+04
  4.09597700e+04  1.04998288e+05  2.30178442e+05  4.55991059e+05
  8.44941572e+05  1.52811716e+06  2.85038251e+06  5.80826717e+06]
E1 = -706.7116589775203  E_coul = 198.72646330328496
cycle= 4 E= -507.985195674235  delta_E= -4.81e-06  |g|= 0.000204  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000142465
diis-c [-1.41190579e-10 -7.51172934e-06  7.13728708e-03 -9.89397781e-02
  1.09181000e+00]
  HOMO = -0.242707350272686  LUMO = 1.06213906704275
  mo_energy =
[-1.20317856e+02 -1.23780065e+01 -6.67556419e+00 -6.67556419e+00
 -6.67556419e+00 -1.17900789e+00 -2.42707350e-01 -2.42707350e-01
 -2.42707350e-01  1.06213907e+00  9.99012463e+00  5.17563662e+01
  2.02400930e+02  7.33954170e+02  2.88125909e+03  1.23476294e+04
  4.09597697e+04  1.04998287e+05  2.30178442e+05  4.55991059e+05
  8.44941572e+05  1.52811716e+06  2.85038251e+06  5.80826717e+06]
E1 = -706.7109998020304  E_coul = 198.72580411785185
cycle= 5 E= -507.985195684179  delta_E= -9.94e-09  |g|= 1.24e-06  |ddm|= 0.000466
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.84517e-07
diis-c [-7.42477700e-14  2.35655157e-07 -1.60171205e-04  2.01566954e-03
 -2.38178313e-02  1.02196210e+00]
  HOMO = -0.242708078177872  LUMO = 1.06213894439371
  mo_energy =
[-1.20317859e+02 -1.23780082e+01 -6.67556598e+00 -6.67556598e+00
 -6.67556598e+00 -1.17900847e+00 -2.42708078e-01 -2.42708078e-01
 -2.42708078e-01  1.06213894e+00  9.99012329e+00  5.17563644e+01
  2.02400928e+02  7.33954168e+02  2.88125909e+03  1.23476294e+04
  4.09597697e+04  1.04998287e+05  2.30178442e+05  4.55991059e+05
  8.44941572e+05  1.52811716e+06  2.85038251e+06  5.80826717e+06]
E1 = -706.7109960602813  E_coul = 198.7258003761023
cycle= 6 E= -507.985195684179  delta_E= -4.55e-13  |g|= 3.91e-08  |ddm|= 2.76e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7109960602813  E_coul = 198.7258003761023
  HOMO = -0.242708097883734  LUMO = 1.06213893316899
  mo_energy =
[-1.20317859e+02 -1.23780082e+01 -6.67556603e+00 -6.67556603e+00
 -6.67556603e+00 -1.17900848e+00 -2.42708098e-01 -2.42708098e-01
 -2.42708098e-01  1.06213893e+00  9.99012325e+00  5.17563643e+01
  2.02400928e+02  7.33954168e+02  2.88125909e+03  1.23476294e+04
  4.09597697e+04  1.04998287e+05  2.30178442e+05  4.55991059e+05
  8.44941572e+05  1.52811716e+06  2.85038251e+06  5.80826717e+06]
E1 = -706.7109959704482  E_coul = 198.72580028626908
Extra cycle  E= -507.985195684179  delta_E= -5.68e-14  |g|= 5.02e-09  |ddm|= 7.41e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.47974902e-01 6.48976390e-01 1.17616814e+05 2.90856188e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547135e+04 7.30306626e+03 1.83757962e+04
 1.44905045e+03 3.75764226e+02 1.23430836e+02 4.71209286e+01
 1.89335844e+01 7.09493053e+00 8.61091600e+00 4.92853822e-01]
E = -507.9851956841791
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:15:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247974902206       1
[INPUT] 0    0    [1    /1   ]  0.648976390119       1
[INPUT] 0    0    [1    /1   ]  117616.813765        1
[INPUT] 0    0    [1    /1   ]  2.9085618781         1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031058        1
[INPUT] 0    0    [1    /1   ]  147020.991857        1
[INPUT] 0    0    [1    /1   ]  73510.4197609        1
[INPUT] 0    0    [1    /1   ]  36754.7135319        1
[INPUT] 0    0    [1    /1   ]  7303.06626365        1
[INPUT] 0    0    [1    /1   ]  18375.7962226        1
[INPUT] 0    0    [1    /1   ]  1449.05044538        1
[INPUT] 0    0    [1    /1   ]  375.76422573         1
[INPUT] 0    0    [1    /1   ]  123.430836422        1
[INPUT] 0    0    [1    /1   ]  47.1209285555        1
[INPUT] 0    0    [1    /1   ]  18.933584373         1
[INPUT] 0    0    [1    /1   ]  7.09493052554        1
[INPUT] 1    0    [1    /1   ]  8.61091600194        1
[INPUT] 1    0    [1    /1   ]  0.492853822315       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2479749022058364, 1.0]], [0, [0.6489763901186425, 1.0]], [0, [117616.81376456724, 1.0]], [0, [2.9085618780956928, 1.0]], [0, [1176168.1426167584, 1.0]], [0, [588084.0699797045, 1.0]], [0, [294042.0310576303, 1.0]], [0, [147020.99185660473, 1.0]], [0, [73510.41976092898, 1.0]], [0, [36754.71353187601, 1.0]], [0, [7303.06626364664, 1.0]], [0, [18375.79622262969, 1.0]], [0, [1449.0504453807796, 1.0]], [0, [375.7642257300908, 1.0]], [0, [123.4308364215679, 1.0]], [0, [47.120928555477555, 1.0]], [0, [18.933584372951774, 1.0]], [0, [7.094930525541522, 1.0]], [1, [8.610916001936328, 1.0]], [1, [0.492853822315067, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2479749]
bas 1, expnt(s) = [0.64897639]
bas 2, expnt(s) = [117616.81376457]
bas 3, expnt(s) = [2.90856188]
bas 4, expnt(s) = [1176168.14261676]
bas 5, expnt(s) = [588084.0699797]
bas 6, expnt(s) = [294042.03105763]
bas 7, expnt(s) = [147020.9918566]
bas 8, expnt(s) = [73510.41976093]
bas 9, expnt(s) = [36754.71353188]
bas 10, expnt(s) = [7303.06626365]
bas 11, expnt(s) = [18375.79622263]
bas 12, expnt(s) = [1449.05044538]
bas 13, expnt(s) = [375.76422573]
bas 14, expnt(s) = [123.43083642]
bas 15, expnt(s) = [47.12092856]
bas 16, expnt(s) = [18.93358437]
bas 17, expnt(s) = [7.09493053]
bas 18, expnt(s) = [8.610916]
bas 19, expnt(s) = [0.49285382]
CPU time:       946.59
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47974902e-01 8.87811610e-01 6.48976390e-01 1.82678189e+00
 1.17616814e+05 1.60460109e+04 2.90856188e+00 5.62695905e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547135e+04 6.70655987e+03
 7.30306626e+03 1.99592379e+03 1.83757962e+04 3.98749038e+03
 1.44905045e+03 5.93372825e+02 3.75764226e+02 2.15626234e+02
 1.23430836e+02 9.35583983e+01 4.71209286e+01 4.54386484e+01
 1.89335844e+01 2.29318796e+01 7.09493053e+00 1.09831303e+01
 8.61091600e+00 4.30324511e+01 4.92853822e-01 1.20470872e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335755685840475
cond(S) = 909341.9393528773
E1 = -689.6320650421726  E_coul = 185.00139522775652
init E= -504.630669814416
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672185794319211  LUMO = 0.682336335737873
  mo_energy =
[-1.21701391e+02 -1.33836379e+01 -7.62154140e+00 -7.62154140e+00
 -7.62154140e+00 -1.65714244e+00 -6.72185794e-01 -6.72185794e-01
 -6.72185794e-01  6.82336336e-01  9.21100681e+00  5.06361415e+01
  2.01081505e+02  7.32592237e+02  2.87997310e+03  1.23464634e+04
  4.09586746e+04  1.04997230e+05  2.30177410e+05  4.55990045e+05
  8.44940571e+05  1.52811617e+06  2.85038153e+06  5.80826620e+06]
E1 = -707.7763808858989  E_coul = 199.80902927356254
cycle= 1 E= -507.967351612336  delta_E= -3.34  |g|= 0.451  |ddm|= 0.503
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.703453
diis-c [-0.49484587  1.        ]
  HOMO = -0.217516240752183  LUMO = 1.0688961437155
  mo_energy =
[-1.20192274e+02 -1.23024203e+01 -6.59229687e+00 -6.59229687e+00
 -6.59229687e+00 -1.16293147e+00 -2.17516241e-01 -2.17516241e-01
 -2.17516241e-01  1.06889614e+00  1.00397954e+01  5.18420418e+01
  2.02511972e+02  7.34084044e+02  2.88140544e+03  1.23477865e+04
  4.09599308e+04  1.04998450e+05  2.30178605e+05  4.55991223e+05
  8.44941736e+05  1.52811733e+06  2.85038267e+06  5.80826734e+06]
E1 = -706.8331788760132  E_coul = 198.84824403619936
cycle= 2 E= -507.984934839814  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.432
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297298
diis-c [-8.83628380e-04  6.83580981e-04  9.99316419e-01]
  HOMO = -0.239419270043888  LUMO = 1.06323957471168
  mo_energy =
[-1.20305551e+02 -1.23690326e+01 -6.66608957e+00 -6.66608957e+00
 -6.66608957e+00 -1.17701886e+00 -2.39419270e-01 -2.39419270e-01
 -2.39419270e-01  1.06323957e+00  9.99649140e+00  5.17659531e+01
  2.02412302e+02  7.33966647e+02  2.88127240e+03  1.23476432e+04
  4.09597837e+04  1.04998301e+05  2.30178456e+05  4.55991073e+05
  8.44941586e+05  1.52811718e+06  2.85038252e+06  5.80826719e+06]
E1 = -706.7268059286109  E_coul = 198.74161506726833
cycle= 3 E= -507.985190861343  delta_E= -0.000256  |g|= 0.00438  |ddm|= 0.0602
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00323706
diis-c [-2.22285373e-06 -9.68346321e-06 -1.07129781e-01  1.10713946e+00]
  HOMO = -0.242568638225119  LUMO = 1.06219230064924
  mo_energy =
[-1.20317509e+02 -1.23776720e+01 -6.67523228e+00 -6.67523228e+00
 -6.67523228e+00 -1.17892523e+00 -2.42568638e-01 -2.42568638e-01
 -2.42568638e-01  1.06219230e+00  9.99038465e+00  5.17566943e+01
  2.02401273e+02  7.33954518e+02  2.88125945e+03  1.23476297e+04
  4.09597700e+04  1.04998288e+05  2.30178442e+05  4.55991059e+05
  8.44941572e+05  1.52811716e+06  2.85038251e+06  5.80826717e+06]
E1 = -706.7116589775203  E_coul = 198.72646330328496
cycle= 4 E= -507.985195674235  delta_E= -4.81e-06  |g|= 0.000204  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000142465
diis-c [-1.41190579e-10 -7.51172934e-06  7.13728708e-03 -9.89397781e-02
  1.09181000e+00]
  HOMO = -0.242707350272686  LUMO = 1.06213906704275
  mo_energy =
[-1.20317856e+02 -1.23780065e+01 -6.67556419e+00 -6.67556419e+00
 -6.67556419e+00 -1.17900789e+00 -2.42707350e-01 -2.42707350e-01
 -2.42707350e-01  1.06213907e+00  9.99012463e+00  5.17563662e+01
  2.02400930e+02  7.33954170e+02  2.88125909e+03  1.23476294e+04
  4.09597697e+04  1.04998287e+05  2.30178442e+05  4.55991059e+05
  8.44941572e+05  1.52811716e+06  2.85038251e+06  5.80826717e+06]
E1 = -706.7109998020304  E_coul = 198.72580411785185
cycle= 5 E= -507.985195684179  delta_E= -9.94e-09  |g|= 1.24e-06  |ddm|= 0.000466
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.84517e-07
diis-c [-7.42477700e-14  2.35655157e-07 -1.60171205e-04  2.01566954e-03
 -2.38178313e-02  1.02196210e+00]
  HOMO = -0.242708078177872  LUMO = 1.06213894439371
  mo_energy =
[-1.20317859e+02 -1.23780082e+01 -6.67556598e+00 -6.67556598e+00
 -6.67556598e+00 -1.17900847e+00 -2.42708078e-01 -2.42708078e-01
 -2.42708078e-01  1.06213894e+00  9.99012329e+00  5.17563644e+01
  2.02400928e+02  7.33954168e+02  2.88125909e+03  1.23476294e+04
  4.09597697e+04  1.04998287e+05  2.30178442e+05  4.55991059e+05
  8.44941572e+05  1.52811716e+06  2.85038251e+06  5.80826717e+06]
E1 = -706.7109960602813  E_coul = 198.7258003761023
cycle= 6 E= -507.985195684179  delta_E= -4.55e-13  |g|= 3.91e-08  |ddm|= 2.76e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7109960602813  E_coul = 198.7258003761023
  HOMO = -0.242708097883734  LUMO = 1.06213893316899
  mo_energy =
[-1.20317859e+02 -1.23780082e+01 -6.67556603e+00 -6.67556603e+00
 -6.67556603e+00 -1.17900848e+00 -2.42708098e-01 -2.42708098e-01
 -2.42708098e-01  1.06213893e+00  9.99012325e+00  5.17563643e+01
  2.02400928e+02  7.33954168e+02  2.88125909e+03  1.23476294e+04
  4.09597697e+04  1.04998287e+05  2.30178442e+05  4.55991059e+05
  8.44941572e+05  1.52811716e+06  2.85038251e+06  5.80826717e+06]
E1 = -706.7109959704482  E_coul = 198.72580028626908
Extra cycle  E= -507.985195684179  delta_E= -5.68e-14  |g|= 5.02e-09  |ddm|= 7.41e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909341.9393528773
E1 = -706.7109959704482  E_coul = 198.72580028626908
init E= -507.985195684179
    CPU time for initialize scf      3.58 sec, wall time      0.23 sec
  HOMO = -0.242708100625163  LUMO = 1.06213893215908
  mo_energy =
[-1.20317859e+02 -1.23780082e+01 -6.67556603e+00 -6.67556603e+00
 -6.67556603e+00 -1.17900848e+00 -2.42708101e-01 -2.42708101e-01
 -2.42708101e-01  1.06213893e+00  9.99012325e+00  5.17563643e+01
  2.02400928e+02  7.33954168e+02  2.88125909e+03  1.23476294e+04
  4.09597697e+04  1.04998287e+05  2.30178442e+05  4.55991059e+05
  8.44941572e+05  1.52811716e+06  2.85038251e+06  5.80826717e+06]
E1 = -706.7109959553361  E_coul = 198.72580027115674
cycle= 1 E= -507.985195684179  delta_E= -2.84e-13  |g|= 1.14e-09  |ddm|= 1.06e-08
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.7109959553361  E_coul = 198.72580027115674
  HOMO = -0.242708101056419  LUMO = 1.06213893212831
  mo_energy =
[-1.20317859e+02 -1.23780082e+01 -6.67556603e+00 -6.67556603e+00
 -6.67556603e+00 -1.17900848e+00 -2.42708101e-01 -2.42708101e-01
 -2.42708101e-01  1.06213893e+00  9.99012325e+00  5.17563643e+01
  2.02400928e+02  7.33954168e+02  2.88125909e+03  1.23476294e+04
  4.09597697e+04  1.04998287e+05  2.30178442e+05  4.55991059e+05
  8.44941572e+05  1.52811716e+06  2.85038251e+06  5.80826717e+06]
E1 = -706.7109959531799  E_coul = 198.72580026900096
Extra cycle  E= -507.985195684179  delta_E= 3.98e-13  |g|= 1.06e-09  |ddm|= 1.46e-09
    CPU time for scf_cycle      4.02 sec, wall time      0.39 sec
exp = [2.47974902e-01 6.48976390e-01 1.17616814e+05 2.90856188e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547135e+04 7.30306626e+03 1.83757962e+04
 1.44905045e+03 3.75764226e+02 1.23430836e+02 4.71209286e+01
 1.89335844e+01 7.09493053e+00 8.61091600e+00 4.92853822e-01]
grad_E = [ 6.76334198e-04 -2.29292083e-04  3.63355668e-09  8.14291611e-04
  1.21845519e-11  9.49888075e-11  5.65628005e-10  2.21283513e-09
  9.17349715e-09  4.99653612e-08  3.07776544e-06  1.01411066e-07
  3.36160402e-05 -2.73711328e-04  9.24363197e-05 -5.44897441e-05
 -2.10862706e-05 -3.26204825e-04  5.53339307e-03 -1.61163515e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:15:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247505968787       1
[INPUT] 0    0    [1    /1   ]  0.648282046522       1
[INPUT] 0    0    [1    /1   ]  117616.813765        1
[INPUT] 0    0    [1    /1   ]  2.91266162842        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031058        1
[INPUT] 0    0    [1    /1   ]  147020.991857        1
[INPUT] 0    0    [1    /1   ]  73510.4197625        1
[INPUT] 0    0    [1    /1   ]  36754.7135405        1
[INPUT] 0    0    [1    /1   ]  7303.06681275        1
[INPUT] 0    0    [1    /1   ]  18375.7962423        1
[INPUT] 0    0    [1    /1   ]  1449.04628187        1
[INPUT] 0    0    [1    /1   ]  375.809117433        1
[INPUT] 0    0    [1    /1   ]  123.297389646        1
[INPUT] 0    0    [1    /1   ]  47.0915573336        1
[INPUT] 0    0    [1    /1   ]  18.7857605507        1
[INPUT] 0    0    [1    /1   ]  7.13242870421        1
[INPUT] 1    0    [1    /1   ]  8.60561322273        1
[INPUT] 1    0    [1    /1   ]  0.492745963623       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24750596878668502, 1.0]], [0, [0.6482820465222343, 1.0]], [0, [117616.81376520245, 1.0]], [0, [2.912661628418532, 1.0]], [0, [1176168.142616762, 1.0]], [0, [588084.0699797221, 1.0]], [0, [294042.03105772904, 1.0]], [0, [147020.99185699315, 1.0]], [0, [73510.41976254674, 1.0]], [0, [36754.713540451354, 1.0]], [0, [7303.066812746312, 1.0]], [0, [18375.796242306707, 1.0]], [0, [1449.0462818727008, 1.0]], [0, [375.8091174332441, 1.0]], [0, [123.29738964561558, 1.0]], [0, [47.091557333642456, 1.0]], [0, [18.785760550688085, 1.0]], [0, [7.132428704214814, 1.0]], [1, [8.60561322272905, 1.0]], [1, [0.49274596362334394, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24750597]
bas 1, expnt(s) = [0.64828205]
bas 2, expnt(s) = [117616.8137652]
bas 3, expnt(s) = [2.91266163]
bas 4, expnt(s) = [1176168.14261676]
bas 5, expnt(s) = [588084.06997972]
bas 6, expnt(s) = [294042.03105773]
bas 7, expnt(s) = [147020.99185699]
bas 8, expnt(s) = [73510.41976255]
bas 9, expnt(s) = [36754.71354045]
bas 10, expnt(s) = [7303.06681275]
bas 11, expnt(s) = [18375.79624231]
bas 12, expnt(s) = [1449.04628187]
bas 13, expnt(s) = [375.80911743]
bas 14, expnt(s) = [123.29738965]
bas 15, expnt(s) = [47.09155733]
bas 16, expnt(s) = [18.78576055]
bas 17, expnt(s) = [7.1324287]
bas 18, expnt(s) = [8.60561322]
bas 19, expnt(s) = [0.49274596]
CPU time:       958.76
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47505969e-01 8.86552139e-01 6.48282047e-01 1.82531583e+00
 1.17616814e+05 1.60460109e+04 2.91266163e+00 5.63290660e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547135e+04 6.70655987e+03
 7.30306681e+03 1.99592390e+03 1.83757962e+04 3.98749039e+03
 1.44904628e+03 5.93371546e+02 3.75809117e+02 2.15645554e+02
 1.23297390e+02 9.34825253e+01 4.70915573e+01 4.54174047e+01
 1.87857606e+01 2.27974678e+01 7.13242870e+00 1.10266377e+01
 8.60561322e+00 4.29993283e+01 4.92745964e-01 1.20437917e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335924143201634
cond(S) = 909333.1525183107
E1 = -689.6048310574733  E_coul = 184.9745766764138
init E= -504.63025438106
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672247505083566  LUMO = 0.68017552600883
  mo_energy =
[-1.21706662e+02 -1.33857571e+01 -7.62340765e+00 -7.62340765e+00
 -7.62340765e+00 -1.65733180e+00 -6.72247505e-01 -6.72247505e-01
 -6.72247505e-01  6.80175526e-01  9.22932853e+00  5.05615123e+01
  2.00624543e+02  7.31775174e+02  2.87910499e+03  1.23456896e+04
  4.09579557e+04  1.04996541e+05  2.30176740e+05  4.55989388e+05
  8.44939925e+05  1.52811554e+06  2.85038091e+06  5.80826559e+06]
E1 = -707.7448283920804  E_coul = 199.77742313783895
cycle= 1 E= -507.967405254241  delta_E= -3.34  |g|= 0.451  |ddm|= 0.503
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.703197
diis-c [-0.49448582  1.        ]
  HOMO = -0.217761809267652  LUMO = 1.06634983788599
  mo_energy =
[-1.20197979e+02 -1.23048367e+01 -6.59451875e+00 -6.59451875e+00
 -6.59451875e+00 -1.16322975e+00 -2.17761809e-01 -2.17761809e-01
 -2.17761809e-01  1.06634984e+00  1.00585393e+01  5.17662279e+01
  2.02054304e+02  7.33266553e+02  2.88053697e+03  1.23470124e+04
  4.09592116e+04  1.04997760e+05  2.30177934e+05  4.55990566e+05
  8.44941090e+05  1.52811669e+06  2.85038205e+06  5.80826673e+06]
E1 = -706.8021721352563  E_coul = 198.81720072442647
cycle= 2 E= -507.98497141083  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.432
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297468
diis-c [-8.84686464e-04  6.10691119e-04  9.99389309e-01]
  HOMO = -0.239654993558915  LUMO = 1.06070396917681
  mo_energy =
[-1.20311193e+02 -1.23714187e+01 -6.66827074e+00 -6.66827074e+00
 -6.66827074e+00 -1.17731584e+00 -2.39654994e-01 -2.39654994e-01
 -2.39654994e-01  1.06070397e+00  1.00152109e+01  5.16902339e+01
  2.01954724e+02  7.33149227e+02  2.88040400e+03  1.23468692e+04
  4.09590646e+04  1.04997611e+05  2.30177785e+05  4.55990416e+05
  8.44940939e+05  1.52811654e+06  2.85038190e+06  5.80826658e+06]
E1 = -706.6957822087376  E_coul = 198.71055468318804
cycle= 3 E= -507.98522752555  delta_E= -0.000256  |g|= 0.00438  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00323953
diis-c [-2.22713174e-06 -9.66190922e-06 -1.07145704e-01  1.10715537e+00]
  HOMO = -0.242803852615274  LUMO = 1.05965804266863
  mo_energy =
[-1.20323142e+02 -1.23800551e+01 -6.67740921e+00 -6.67740921e+00
 -6.67740921e+00 -1.17922253e+00 -2.42803853e-01 -2.42803853e-01
 -2.42803853e-01  1.05965804e+00  1.00090999e+01  5.16809839e+01
  2.01943704e+02  7.33137107e+02  2.88039106e+03  1.23468557e+04
  4.09590509e+04  1.04997598e+05  2.30177771e+05  4.55990402e+05
  8.44940926e+05  1.52811653e+06  2.85038188e+06  5.80826657e+06]
E1 = -706.6806296152424  E_coul = 198.69539727301787
cycle= 4 E= -507.985232342225  delta_E= -4.82e-06  |g|= 0.000204  |ddm|= 0.00946
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000142688
diis-c [-1.40615145e-10 -7.49638243e-06  7.13613495e-03 -9.89683389e-02
  1.09183970e+00]
  HOMO = -0.242942672939585  LUMO = 1.05960483429638
  mo_energy =
[-1.20323490e+02 -1.23803898e+01 -6.67774134e+00 -6.67774134e+00
 -6.67774134e+00 -1.17930528e+00 -2.42942673e-01 -2.42942673e-01
 -2.42942673e-01  1.05960483e+00  1.00088395e+01  5.16806556e+01
  2.01943361e+02  7.33136759e+02  2.88039070e+03  1.23468554e+04
  4.09590506e+04  1.04997597e+05  2.30177771e+05  4.55990402e+05
  8.44940925e+05  1.52811653e+06  2.85038188e+06  5.80826656e+06]
E1 = -706.6799695501169  E_coul = 198.69473719792782
cycle= 5 E= -507.985232352189  delta_E= -9.96e-09  |g|= 1.23e-06  |ddm|= 0.000466
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.81607e-07
diis-c [-7.43836133e-14  2.25694307e-07 -1.58234012e-04  1.99072477e-03
 -2.35330689e-02  1.02170035e+00]
  HOMO = -0.242943397726958  LUMO = 1.05960471511081
  mo_energy =
[-1.20323492e+02 -1.23803915e+01 -6.67774313e+00 -6.67774313e+00
 -6.67774313e+00 -1.17930585e+00 -2.42943398e-01 -2.42943398e-01
 -2.42943398e-01  1.05960472e+00  1.00088381e+01  5.16806538e+01
  2.01943359e+02  7.33136757e+02  2.88039070e+03  1.23468554e+04
  4.09590506e+04  1.04997597e+05  2.30177771e+05  4.55990402e+05
  8.44940925e+05  1.52811653e+06  2.85038188e+06  5.80826656e+06]
E1 = -706.6799658143979  E_coul = 198.69473346220778
cycle= 6 E= -507.98523235219  delta_E= -1.02e-12  |g|= 3.89e-08  |ddm|= 2.75e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6799658143979  E_coul = 198.69473346220778
  HOMO = -0.242943417473226  LUMO = 1.05960470428268
  mo_energy =
[-1.20323492e+02 -1.23803915e+01 -6.67774318e+00 -6.67774318e+00
 -6.67774318e+00 -1.17930586e+00 -2.42943417e-01 -2.42943417e-01
 -2.42943417e-01  1.05960470e+00  1.00088381e+01  5.16806538e+01
  2.01943359e+02  7.33136757e+02  2.88039070e+03  1.23468554e+04
  4.09590506e+04  1.04997597e+05  2.30177771e+05  4.55990402e+05
  8.44940925e+05  1.52811653e+06  2.85038188e+06  5.80826656e+06]
E1 = -706.6799657239638  E_coul = 198.69473337177456
Extra cycle  E= -507.985232352189  delta_E= 7.96e-13  |g|= 4.75e-09  |ddm|= 7.44e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.47505969e-01 6.48282047e-01 1.17616814e+05 2.91266163e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547135e+04 7.30306681e+03 1.83757962e+04
 1.44904628e+03 3.75809117e+02 1.23297390e+02 4.70915573e+01
 1.87857606e+01 7.13242870e+00 8.60561322e+00 4.92745964e-01]
E = -507.9852323521893
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:15:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247505968787       1
[INPUT] 0    0    [1    /1   ]  0.648282046522       1
[INPUT] 0    0    [1    /1   ]  117616.813765        1
[INPUT] 0    0    [1    /1   ]  2.91266162842        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031058        1
[INPUT] 0    0    [1    /1   ]  147020.991857        1
[INPUT] 0    0    [1    /1   ]  73510.4197625        1
[INPUT] 0    0    [1    /1   ]  36754.7135405        1
[INPUT] 0    0    [1    /1   ]  7303.06681275        1
[INPUT] 0    0    [1    /1   ]  18375.7962423        1
[INPUT] 0    0    [1    /1   ]  1449.04628187        1
[INPUT] 0    0    [1    /1   ]  375.809117433        1
[INPUT] 0    0    [1    /1   ]  123.297389646        1
[INPUT] 0    0    [1    /1   ]  47.0915573336        1
[INPUT] 0    0    [1    /1   ]  18.7857605507        1
[INPUT] 0    0    [1    /1   ]  7.13242870421        1
[INPUT] 1    0    [1    /1   ]  8.60561322273        1
[INPUT] 1    0    [1    /1   ]  0.492745963623       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24750596878668502, 1.0]], [0, [0.6482820465222343, 1.0]], [0, [117616.81376520245, 1.0]], [0, [2.912661628418532, 1.0]], [0, [1176168.142616762, 1.0]], [0, [588084.0699797221, 1.0]], [0, [294042.03105772904, 1.0]], [0, [147020.99185699315, 1.0]], [0, [73510.41976254674, 1.0]], [0, [36754.713540451354, 1.0]], [0, [7303.066812746312, 1.0]], [0, [18375.796242306707, 1.0]], [0, [1449.0462818727008, 1.0]], [0, [375.8091174332441, 1.0]], [0, [123.29738964561558, 1.0]], [0, [47.091557333642456, 1.0]], [0, [18.785760550688085, 1.0]], [0, [7.132428704214814, 1.0]], [1, [8.60561322272905, 1.0]], [1, [0.49274596362334394, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24750597]
bas 1, expnt(s) = [0.64828205]
bas 2, expnt(s) = [117616.8137652]
bas 3, expnt(s) = [2.91266163]
bas 4, expnt(s) = [1176168.14261676]
bas 5, expnt(s) = [588084.06997972]
bas 6, expnt(s) = [294042.03105773]
bas 7, expnt(s) = [147020.99185699]
bas 8, expnt(s) = [73510.41976255]
bas 9, expnt(s) = [36754.71354045]
bas 10, expnt(s) = [7303.06681275]
bas 11, expnt(s) = [18375.79624231]
bas 12, expnt(s) = [1449.04628187]
bas 13, expnt(s) = [375.80911743]
bas 14, expnt(s) = [123.29738965]
bas 15, expnt(s) = [47.09155733]
bas 16, expnt(s) = [18.78576055]
bas 17, expnt(s) = [7.1324287]
bas 18, expnt(s) = [8.60561322]
bas 19, expnt(s) = [0.49274596]
CPU time:       960.30
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47505969e-01 8.86552139e-01 6.48282047e-01 1.82531583e+00
 1.17616814e+05 1.60460109e+04 2.91266163e+00 5.63290660e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547135e+04 6.70655987e+03
 7.30306681e+03 1.99592390e+03 1.83757962e+04 3.98749039e+03
 1.44904628e+03 5.93371546e+02 3.75809117e+02 2.15645554e+02
 1.23297390e+02 9.34825253e+01 4.70915573e+01 4.54174047e+01
 1.87857606e+01 2.27974678e+01 7.13242870e+00 1.10266377e+01
 8.60561322e+00 4.29993283e+01 4.92745964e-01 1.20437917e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335924143201634
cond(S) = 909333.1525183107
E1 = -689.6048310574733  E_coul = 184.9745766764138
init E= -504.63025438106
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672247505083566  LUMO = 0.68017552600883
  mo_energy =
[-1.21706662e+02 -1.33857571e+01 -7.62340765e+00 -7.62340765e+00
 -7.62340765e+00 -1.65733180e+00 -6.72247505e-01 -6.72247505e-01
 -6.72247505e-01  6.80175526e-01  9.22932853e+00  5.05615123e+01
  2.00624543e+02  7.31775174e+02  2.87910499e+03  1.23456896e+04
  4.09579557e+04  1.04996541e+05  2.30176740e+05  4.55989388e+05
  8.44939925e+05  1.52811554e+06  2.85038091e+06  5.80826559e+06]
E1 = -707.7448283920804  E_coul = 199.77742313783895
cycle= 1 E= -507.967405254241  delta_E= -3.34  |g|= 0.451  |ddm|= 0.503
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.703197
diis-c [-0.49448582  1.        ]
  HOMO = -0.217761809267652  LUMO = 1.06634983788599
  mo_energy =
[-1.20197979e+02 -1.23048367e+01 -6.59451875e+00 -6.59451875e+00
 -6.59451875e+00 -1.16322975e+00 -2.17761809e-01 -2.17761809e-01
 -2.17761809e-01  1.06634984e+00  1.00585393e+01  5.17662279e+01
  2.02054304e+02  7.33266553e+02  2.88053697e+03  1.23470124e+04
  4.09592116e+04  1.04997760e+05  2.30177934e+05  4.55990566e+05
  8.44941090e+05  1.52811669e+06  2.85038205e+06  5.80826673e+06]
E1 = -706.8021721352563  E_coul = 198.81720072442647
cycle= 2 E= -507.98497141083  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.432
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297468
diis-c [-8.84686464e-04  6.10691119e-04  9.99389309e-01]
  HOMO = -0.239654993558915  LUMO = 1.06070396917681
  mo_energy =
[-1.20311193e+02 -1.23714187e+01 -6.66827074e+00 -6.66827074e+00
 -6.66827074e+00 -1.17731584e+00 -2.39654994e-01 -2.39654994e-01
 -2.39654994e-01  1.06070397e+00  1.00152109e+01  5.16902339e+01
  2.01954724e+02  7.33149227e+02  2.88040400e+03  1.23468692e+04
  4.09590646e+04  1.04997611e+05  2.30177785e+05  4.55990416e+05
  8.44940939e+05  1.52811654e+06  2.85038190e+06  5.80826658e+06]
E1 = -706.6957822087376  E_coul = 198.71055468318804
cycle= 3 E= -507.98522752555  delta_E= -0.000256  |g|= 0.00438  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00323953
diis-c [-2.22713174e-06 -9.66190922e-06 -1.07145704e-01  1.10715537e+00]
  HOMO = -0.242803852615274  LUMO = 1.05965804266863
  mo_energy =
[-1.20323142e+02 -1.23800551e+01 -6.67740921e+00 -6.67740921e+00
 -6.67740921e+00 -1.17922253e+00 -2.42803853e-01 -2.42803853e-01
 -2.42803853e-01  1.05965804e+00  1.00090999e+01  5.16809839e+01
  2.01943704e+02  7.33137107e+02  2.88039106e+03  1.23468557e+04
  4.09590509e+04  1.04997598e+05  2.30177771e+05  4.55990402e+05
  8.44940926e+05  1.52811653e+06  2.85038188e+06  5.80826657e+06]
E1 = -706.6806296152424  E_coul = 198.69539727301787
cycle= 4 E= -507.985232342225  delta_E= -4.82e-06  |g|= 0.000204  |ddm|= 0.00946
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000142688
diis-c [-1.40615145e-10 -7.49638243e-06  7.13613495e-03 -9.89683389e-02
  1.09183970e+00]
  HOMO = -0.242942672939585  LUMO = 1.05960483429638
  mo_energy =
[-1.20323490e+02 -1.23803898e+01 -6.67774134e+00 -6.67774134e+00
 -6.67774134e+00 -1.17930528e+00 -2.42942673e-01 -2.42942673e-01
 -2.42942673e-01  1.05960483e+00  1.00088395e+01  5.16806556e+01
  2.01943361e+02  7.33136759e+02  2.88039070e+03  1.23468554e+04
  4.09590506e+04  1.04997597e+05  2.30177771e+05  4.55990402e+05
  8.44940925e+05  1.52811653e+06  2.85038188e+06  5.80826656e+06]
E1 = -706.6799695501169  E_coul = 198.69473719792782
cycle= 5 E= -507.985232352189  delta_E= -9.96e-09  |g|= 1.23e-06  |ddm|= 0.000466
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.81607e-07
diis-c [-7.43836133e-14  2.25694307e-07 -1.58234012e-04  1.99072477e-03
 -2.35330689e-02  1.02170035e+00]
  HOMO = -0.242943397726958  LUMO = 1.05960471511081
  mo_energy =
[-1.20323492e+02 -1.23803915e+01 -6.67774313e+00 -6.67774313e+00
 -6.67774313e+00 -1.17930585e+00 -2.42943398e-01 -2.42943398e-01
 -2.42943398e-01  1.05960472e+00  1.00088381e+01  5.16806538e+01
  2.01943359e+02  7.33136757e+02  2.88039070e+03  1.23468554e+04
  4.09590506e+04  1.04997597e+05  2.30177771e+05  4.55990402e+05
  8.44940925e+05  1.52811653e+06  2.85038188e+06  5.80826656e+06]
E1 = -706.6799658143979  E_coul = 198.69473346220778
cycle= 6 E= -507.98523235219  delta_E= -1.02e-12  |g|= 3.89e-08  |ddm|= 2.75e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6799658143979  E_coul = 198.69473346220778
  HOMO = -0.242943417473226  LUMO = 1.05960470428268
  mo_energy =
[-1.20323492e+02 -1.23803915e+01 -6.67774318e+00 -6.67774318e+00
 -6.67774318e+00 -1.17930586e+00 -2.42943417e-01 -2.42943417e-01
 -2.42943417e-01  1.05960470e+00  1.00088381e+01  5.16806538e+01
  2.01943359e+02  7.33136757e+02  2.88039070e+03  1.23468554e+04
  4.09590506e+04  1.04997597e+05  2.30177771e+05  4.55990402e+05
  8.44940925e+05  1.52811653e+06  2.85038188e+06  5.80826656e+06]
E1 = -706.6799657239638  E_coul = 198.69473337177456
Extra cycle  E= -507.985232352189  delta_E= 7.96e-13  |g|= 4.75e-09  |ddm|= 7.44e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909333.1525183107
E1 = -706.6799657239638  E_coul = 198.69473337177456
init E= -507.985232352189
    CPU time for initialize scf      3.59 sec, wall time      0.23 sec
  HOMO = -0.242943420231334  LUMO = 1.05960470241684
  mo_energy =
[-1.20323492e+02 -1.23803915e+01 -6.67774318e+00 -6.67774318e+00
 -6.67774318e+00 -1.17930587e+00 -2.42943420e-01 -2.42943420e-01
 -2.42943420e-01  1.05960470e+00  1.00088381e+01  5.16806538e+01
  2.01943359e+02  7.33136757e+02  2.88039070e+03  1.23468554e+04
  4.09590506e+04  1.04997597e+05  2.30177771e+05  4.55990402e+05
  8.44940925e+05  1.52811653e+06  2.85038188e+06  5.80826656e+06]
E1 = -706.6799657109871  E_coul = 198.6947333587974
cycle= 1 E= -507.98523235219  delta_E= -3.41e-13  |g|= 1.24e-09  |ddm|= 9.37e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6799657109871  E_coul = 198.6947333587974
  HOMO = -0.242943420607646  LUMO = 1.05960470471956
  mo_energy =
[-1.20323492e+02 -1.23803915e+01 -6.67774318e+00 -6.67774318e+00
 -6.67774318e+00 -1.17930587e+00 -2.42943421e-01 -2.42943421e-01
 -2.42943421e-01  1.05960470e+00  1.00088381e+01  5.16806538e+01
  2.01943359e+02  7.33136757e+02  2.88039070e+03  1.23468554e+04
  4.09590506e+04  1.04997597e+05  2.30177771e+05  4.55990402e+05
  8.44940925e+05  1.52811653e+06  2.85038188e+06  5.80826656e+06]
E1 = -706.6799657079958  E_coul = 198.69473335580656
Extra cycle  E= -507.985232352189  delta_E= 3.41e-13  |g|= 2.21e-09  |ddm|= 2.2e-09
    CPU time for scf_cycle      4.03 sec, wall time      0.39 sec
exp = [2.47505969e-01 6.48282047e-01 1.17616814e+05 2.91266163e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547135e+04 7.30306681e+03 1.83757962e+04
 1.44904628e+03 3.75809117e+02 1.23297390e+02 4.70915573e+01
 1.87857606e+01 7.13242870e+00 8.60561322e+00 4.92745964e-01]
grad_E = [ 1.41971509e-04 -1.15084397e-04  3.66339335e-09  2.84434057e-04
  1.25463593e-11  9.59533193e-11  5.70263671e-10  2.23125829e-09
  9.25103495e-09  5.03507397e-08  3.10590174e-06  1.02548335e-07
  3.20439130e-05 -2.57453610e-04  3.41799244e-05  2.85049850e-05
 -6.68100096e-05 -7.57850006e-05  1.19502122e-03 -3.47662500e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:15:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247368680214       1
[INPUT] 0    0    [1    /1   ]  0.648235843718       1
[INPUT] 0    0    [1    /1   ]  117616.813768        1
[INPUT] 0    0    [1    /1   ]  2.91057573516        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031058        1
[INPUT] 0    0    [1    /1   ]  147020.991859        1
[INPUT] 0    0    [1    /1   ]  73510.4197696        1
[INPUT] 0    0    [1    /1   ]  36754.7135784        1
[INPUT] 0    0    [1    /1   ]  7303.06919785        1
[INPUT] 0    0    [1    /1   ]  18375.7963242        1
[INPUT] 0    0    [1    /1   ]  1449.04947089        1
[INPUT] 0    0    [1    /1   ]  375.810035119        1
[INPUT] 0    0    [1    /1   ]  123.022215436        1
[INPUT] 0    0    [1    /1   ]  46.9219623357        1
[INPUT] 0    0    [1    /1   ]  18.6840905128        1
[INPUT] 0    0    [1    /1   ]  7.13413112612        1
[INPUT] 1    0    [1    /1   ]  8.60399931541        1
[INPUT] 1    0    [1    /1   ]  0.492712823337       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24736868021427588, 1.0]], [0, [0.6482358437182715, 1.0]], [0, [117616.81376798602, 1.0]], [0, [2.910575735164907, 1.0]], [0, [1176168.1426167747, 1.0]], [0, [588084.0699797974, 1.0]], [0, [294042.0310581621, 1.0]], [0, [147020.99185869176, 1.0]], [0, [73510.41976960472, 1.0]], [0, [36754.71357838432, 1.0]], [0, [7303.069197853596, 1.0]], [0, [18375.796324204595, 1.0]], [0, [1449.0494708941426, 1.0]], [0, [375.81003511862235, 1.0]], [0, [123.02221543610277, 1.0]], [0, [46.921962335713935, 1.0]], [0, [18.684090512792004, 1.0]], [0, [7.1341311261247595, 1.0]], [1, [8.603999315409894, 1.0]], [1, [0.4927128233366814, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24736868]
bas 1, expnt(s) = [0.64823584]
bas 2, expnt(s) = [117616.81376799]
bas 3, expnt(s) = [2.91057574]
bas 4, expnt(s) = [1176168.14261677]
bas 5, expnt(s) = [588084.0699798]
bas 6, expnt(s) = [294042.03105816]
bas 7, expnt(s) = [147020.99185869]
bas 8, expnt(s) = [73510.4197696]
bas 9, expnt(s) = [36754.71357838]
bas 10, expnt(s) = [7303.06919785]
bas 11, expnt(s) = [18375.7963242]
bas 12, expnt(s) = [1449.04947089]
bas 13, expnt(s) = [375.81003512]
bas 14, expnt(s) = [123.02221544]
bas 15, expnt(s) = [46.92196234]
bas 16, expnt(s) = [18.68409051]
bas 17, expnt(s) = [7.13413113]
bas 18, expnt(s) = [8.60399932]
bas 19, expnt(s) = [0.49271282]
CPU time:       972.35
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47368680e-01 8.86183293e-01 6.48235844e-01 1.82521826e+00
 1.17616814e+05 1.60460109e+04 2.91057574e+00 5.62988084e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547136e+04 6.70655988e+03
 7.30306920e+03 1.99592439e+03 1.83757963e+04 3.98749040e+03
 1.44904947e+03 5.93372526e+02 3.75810035e+02 2.15645949e+02
 1.23022215e+02 9.33260064e+01 4.69219623e+01 4.52946751e+01
 1.86840905e+01 2.27048688e+01 7.13413113e+00 1.10286115e+01
 8.60399932e+00 4.29892483e+01 4.92712823e-01 1.20427792e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335976118934575
cond(S) = 909312.5151355551
E1 = -689.5964631289188  E_coul = 184.96641738626678
init E= -504.630045742652
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672266155134502  LUMO = 0.679571681489998
  mo_energy =
[-1.21708263e+02 -1.33864057e+01 -7.62397421e+00 -7.62397421e+00
 -7.62397421e+00 -1.65738838e+00 -6.72266155e-01 -6.72266155e-01
 -6.72266155e-01  6.79571681e-01  9.21840057e+00  5.03830845e+01
  1.99815443e+02  7.30109913e+02  2.87712215e+03  1.23438461e+04
  4.09562361e+04  1.04994891e+05  2.30175136e+05  4.55987818e+05
  8.44938381e+05  1.52811402e+06  2.85037942e+06  5.80826414e+06]
E1 = -707.7351683304008  E_coul = 199.76775370416743
cycle= 1 E= -507.967414626233  delta_E= -3.34  |g|= 0.451  |ddm|= 0.503
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.70302
diis-c [-0.49423775  1.        ]
  HOMO = -0.217837902018231  LUMO = 1.06560001495129
  mo_energy =
[-1.20199720e+02 -1.23055795e+01 -6.59519714e+00 -6.59519714e+00
 -6.59519714e+00 -1.16332082e+00 -2.17837902e-01 -2.17837902e-01
 -2.17837902e-01  1.06560001e+00  1.00470588e+01  5.15865465e+01
  2.01244595e+02  7.31601129e+02  2.87855399e+03  1.23451689e+04
  4.09574920e+04  1.04996110e+05  2.30176331e+05  4.55988995e+05
  8.44939545e+05  1.52811517e+06  2.85038056e+06  5.80826528e+06]
E1 = -706.7926139358372  E_coul = 198.80763677475522
cycle= 2 E= -507.984977161082  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.432
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297615
diis-c [-8.85593695e-04  5.56117655e-04  9.99443882e-01]
  HOMO = -0.23972892900878  LUMO = 1.05995954232575
  mo_energy =
[-1.20312927e+02 -1.23721597e+01 -6.66894524e+00 -6.66894524e+00
 -6.66894524e+00 -1.17740682e+00 -2.39728929e-01 -2.39728929e-01
 -2.39728929e-01  1.05995954e+00  1.00037658e+01  5.15106453e+01
  2.01145081e+02  7.31483822e+02  2.87842103e+03  1.23450256e+04
  4.09573449e+04  1.04995961e+05  2.30176181e+05  4.55988845e+05
  8.44939395e+05  1.52811502e+06  2.85038041e+06  5.80826513e+06]
E1 = -706.6862201275763  E_coul = 198.70098685181193
cycle= 3 E= -507.985233275764  delta_E= -0.000256  |g|= 0.00438  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324056
diis-c [-2.23095801e-06 -8.36150587e-06 -1.07108015e-01  1.10711638e+00]
  HOMO = -0.242876622813936  LUMO = 1.05891463234059
  mo_energy =
[-1.20324870e+02 -1.23807924e+01 -6.67807952e+00 -6.67807952e+00
 -6.67807952e+00 -1.17931294e+00 -2.42876623e-01 -2.42876623e-01
 -2.42876623e-01  1.05891463e+00  9.99766083e+00  5.15014069e+01
  2.01134071e+02  7.31471710e+02  2.87840809e+03  1.23450122e+04
  4.09573313e+04  1.04995948e+05  2.30176168e+05  4.55988832e+05
  8.44939381e+05  1.52811501e+06  2.85038040e+06  5.80826512e+06]
E1 = -706.6710714472124  E_coul = 198.6858333564881
cycle= 4 E= -507.985238090724  delta_E= -4.81e-06  |g|= 0.000204  |ddm|= 0.00946
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000142833
diis-c [-1.40718618e-10 -7.49907277e-06  7.13097155e-03 -9.89691785e-02
  1.09184571e+00]
  HOMO = -0.243015495162217  LUMO = 1.05886144046876
  mo_energy =
[-1.20325217e+02 -1.23811272e+01 -6.67841175e+00 -6.67841175e+00
 -6.67841175e+00 -1.17939573e+00 -2.43015495e-01 -2.43015495e-01
 -2.43015495e-01  1.05886144e+00  9.99740043e+00  5.15010786e+01
  2.01133728e+02  7.31471362e+02  2.87840774e+03  1.23450118e+04
  4.09573310e+04  1.04995947e+05  2.30176167e+05  4.55988831e+05
  8.44939381e+05  1.52811501e+06  2.85038040e+06  5.80826512e+06]
E1 = -706.6704110556052  E_coul = 198.68517295490452
cycle= 5 E= -507.985238100701  delta_E= -9.98e-09  |g|= 1.24e-06  |ddm|= 0.000467
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.83383e-07
diis-c [-7.49087874e-14  2.27776943e-07 -1.59119897e-04  2.00449036e-03
 -2.36905833e-02  1.02184499e+00]
  HOMO = -0.243016222660665  LUMO = 1.05886131655438
  mo_energy =
[-1.20325220e+02 -1.23811289e+01 -6.67841355e+00 -6.67841355e+00
 -6.67841355e+00 -1.17939631e+00 -2.43016223e-01 -2.43016223e-01
 -2.43016223e-01  1.05886132e+00  9.99739910e+00  5.15010768e+01
  2.01133726e+02  7.31471359e+02  2.87840774e+03  1.23450118e+04
  4.09573310e+04  1.04995947e+05  2.30176167e+05  4.55988831e+05
  8.44939381e+05  1.52811501e+06  2.85038040e+06  5.80826512e+06]
E1 = -706.6704073113697  E_coul = 198.68516921066868
cycle= 6 E= -507.985238100701  delta_E= -2.84e-13  |g|= 3.94e-08  |ddm|= 2.76e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6704073113697  E_coul = 198.68516921066868
  HOMO = -0.243016242440836  LUMO = 1.05886130768357
  mo_energy =
[-1.20325220e+02 -1.23811290e+01 -6.67841359e+00 -6.67841359e+00
 -6.67841359e+00 -1.17939632e+00 -2.43016242e-01 -2.43016242e-01
 -2.43016242e-01  1.05886131e+00  9.99739906e+00  5.15010768e+01
  2.01133726e+02  7.31471359e+02  2.87840774e+03  1.23450118e+04
  4.09573310e+04  1.04995947e+05  2.30176167e+05  4.55988831e+05
  8.44939381e+05  1.52811501e+06  2.85038040e+06  5.80826512e+06]
E1 = -706.6704072180239  E_coul = 198.68516911732297
Extra cycle  E= -507.985238100701  delta_E= 5.68e-14  |g|= 4.52e-09  |ddm|= 7.65e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.47368680e-01 6.48235844e-01 1.17616814e+05 2.91057574e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547136e+04 7.30306920e+03 1.83757963e+04
 1.44904947e+03 3.75810035e+02 1.23022215e+02 4.69219623e+01
 1.86840905e+01 7.13413113e+00 8.60399932e+00 4.92712823e-01]
E = -507.98523810070094
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:15:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247368680214       1
[INPUT] 0    0    [1    /1   ]  0.648235843718       1
[INPUT] 0    0    [1    /1   ]  117616.813768        1
[INPUT] 0    0    [1    /1   ]  2.91057573516        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031058        1
[INPUT] 0    0    [1    /1   ]  147020.991859        1
[INPUT] 0    0    [1    /1   ]  73510.4197696        1
[INPUT] 0    0    [1    /1   ]  36754.7135784        1
[INPUT] 0    0    [1    /1   ]  7303.06919785        1
[INPUT] 0    0    [1    /1   ]  18375.7963242        1
[INPUT] 0    0    [1    /1   ]  1449.04947089        1
[INPUT] 0    0    [1    /1   ]  375.810035119        1
[INPUT] 0    0    [1    /1   ]  123.022215436        1
[INPUT] 0    0    [1    /1   ]  46.9219623357        1
[INPUT] 0    0    [1    /1   ]  18.6840905128        1
[INPUT] 0    0    [1    /1   ]  7.13413112612        1
[INPUT] 1    0    [1    /1   ]  8.60399931541        1
[INPUT] 1    0    [1    /1   ]  0.492712823337       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24736868021427588, 1.0]], [0, [0.6482358437182715, 1.0]], [0, [117616.81376798602, 1.0]], [0, [2.910575735164907, 1.0]], [0, [1176168.1426167747, 1.0]], [0, [588084.0699797974, 1.0]], [0, [294042.0310581621, 1.0]], [0, [147020.99185869176, 1.0]], [0, [73510.41976960472, 1.0]], [0, [36754.71357838432, 1.0]], [0, [7303.069197853596, 1.0]], [0, [18375.796324204595, 1.0]], [0, [1449.0494708941426, 1.0]], [0, [375.81003511862235, 1.0]], [0, [123.02221543610277, 1.0]], [0, [46.921962335713935, 1.0]], [0, [18.684090512792004, 1.0]], [0, [7.1341311261247595, 1.0]], [1, [8.603999315409894, 1.0]], [1, [0.4927128233366814, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24736868]
bas 1, expnt(s) = [0.64823584]
bas 2, expnt(s) = [117616.81376799]
bas 3, expnt(s) = [2.91057574]
bas 4, expnt(s) = [1176168.14261677]
bas 5, expnt(s) = [588084.0699798]
bas 6, expnt(s) = [294042.03105816]
bas 7, expnt(s) = [147020.99185869]
bas 8, expnt(s) = [73510.4197696]
bas 9, expnt(s) = [36754.71357838]
bas 10, expnt(s) = [7303.06919785]
bas 11, expnt(s) = [18375.7963242]
bas 12, expnt(s) = [1449.04947089]
bas 13, expnt(s) = [375.81003512]
bas 14, expnt(s) = [123.02221544]
bas 15, expnt(s) = [46.92196234]
bas 16, expnt(s) = [18.68409051]
bas 17, expnt(s) = [7.13413113]
bas 18, expnt(s) = [8.60399932]
bas 19, expnt(s) = [0.49271282]
CPU time:       973.90
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47368680e-01 8.86183293e-01 6.48235844e-01 1.82521826e+00
 1.17616814e+05 1.60460109e+04 2.91057574e+00 5.62988084e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547136e+04 6.70655988e+03
 7.30306920e+03 1.99592439e+03 1.83757963e+04 3.98749040e+03
 1.44904947e+03 5.93372526e+02 3.75810035e+02 2.15645949e+02
 1.23022215e+02 9.33260064e+01 4.69219623e+01 4.52946751e+01
 1.86840905e+01 2.27048688e+01 7.13413113e+00 1.10286115e+01
 8.60399932e+00 4.29892483e+01 4.92712823e-01 1.20427792e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335976118934575
cond(S) = 909312.5151355551
E1 = -689.5964631289188  E_coul = 184.96641738626678
init E= -504.630045742652
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672266155134502  LUMO = 0.679571681489998
  mo_energy =
[-1.21708263e+02 -1.33864057e+01 -7.62397421e+00 -7.62397421e+00
 -7.62397421e+00 -1.65738838e+00 -6.72266155e-01 -6.72266155e-01
 -6.72266155e-01  6.79571681e-01  9.21840057e+00  5.03830845e+01
  1.99815443e+02  7.30109913e+02  2.87712215e+03  1.23438461e+04
  4.09562361e+04  1.04994891e+05  2.30175136e+05  4.55987818e+05
  8.44938381e+05  1.52811402e+06  2.85037942e+06  5.80826414e+06]
E1 = -707.7351683304008  E_coul = 199.76775370416743
cycle= 1 E= -507.967414626233  delta_E= -3.34  |g|= 0.451  |ddm|= 0.503
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.70302
diis-c [-0.49423775  1.        ]
  HOMO = -0.217837902018231  LUMO = 1.06560001495129
  mo_energy =
[-1.20199720e+02 -1.23055795e+01 -6.59519714e+00 -6.59519714e+00
 -6.59519714e+00 -1.16332082e+00 -2.17837902e-01 -2.17837902e-01
 -2.17837902e-01  1.06560001e+00  1.00470588e+01  5.15865465e+01
  2.01244595e+02  7.31601129e+02  2.87855399e+03  1.23451689e+04
  4.09574920e+04  1.04996110e+05  2.30176331e+05  4.55988995e+05
  8.44939545e+05  1.52811517e+06  2.85038056e+06  5.80826528e+06]
E1 = -706.7926139358372  E_coul = 198.80763677475522
cycle= 2 E= -507.984977161082  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.432
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297615
diis-c [-8.85593695e-04  5.56117655e-04  9.99443882e-01]
  HOMO = -0.23972892900878  LUMO = 1.05995954232575
  mo_energy =
[-1.20312927e+02 -1.23721597e+01 -6.66894524e+00 -6.66894524e+00
 -6.66894524e+00 -1.17740682e+00 -2.39728929e-01 -2.39728929e-01
 -2.39728929e-01  1.05995954e+00  1.00037658e+01  5.15106453e+01
  2.01145081e+02  7.31483822e+02  2.87842103e+03  1.23450256e+04
  4.09573449e+04  1.04995961e+05  2.30176181e+05  4.55988845e+05
  8.44939395e+05  1.52811502e+06  2.85038041e+06  5.80826513e+06]
E1 = -706.6862201275763  E_coul = 198.70098685181193
cycle= 3 E= -507.985233275764  delta_E= -0.000256  |g|= 0.00438  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324056
diis-c [-2.23095801e-06 -8.36150587e-06 -1.07108015e-01  1.10711638e+00]
  HOMO = -0.242876622813936  LUMO = 1.05891463234059
  mo_energy =
[-1.20324870e+02 -1.23807924e+01 -6.67807952e+00 -6.67807952e+00
 -6.67807952e+00 -1.17931294e+00 -2.42876623e-01 -2.42876623e-01
 -2.42876623e-01  1.05891463e+00  9.99766083e+00  5.15014069e+01
  2.01134071e+02  7.31471710e+02  2.87840809e+03  1.23450122e+04
  4.09573313e+04  1.04995948e+05  2.30176168e+05  4.55988832e+05
  8.44939381e+05  1.52811501e+06  2.85038040e+06  5.80826512e+06]
E1 = -706.6710714472124  E_coul = 198.6858333564881
cycle= 4 E= -507.985238090724  delta_E= -4.81e-06  |g|= 0.000204  |ddm|= 0.00946
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000142833
diis-c [-1.40718618e-10 -7.49907277e-06  7.13097155e-03 -9.89691785e-02
  1.09184571e+00]
  HOMO = -0.243015495162217  LUMO = 1.05886144046876
  mo_energy =
[-1.20325217e+02 -1.23811272e+01 -6.67841175e+00 -6.67841175e+00
 -6.67841175e+00 -1.17939573e+00 -2.43015495e-01 -2.43015495e-01
 -2.43015495e-01  1.05886144e+00  9.99740043e+00  5.15010786e+01
  2.01133728e+02  7.31471362e+02  2.87840774e+03  1.23450118e+04
  4.09573310e+04  1.04995947e+05  2.30176167e+05  4.55988831e+05
  8.44939381e+05  1.52811501e+06  2.85038040e+06  5.80826512e+06]
E1 = -706.6704110556052  E_coul = 198.68517295490452
cycle= 5 E= -507.985238100701  delta_E= -9.98e-09  |g|= 1.24e-06  |ddm|= 0.000467
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.83383e-07
diis-c [-7.49087874e-14  2.27776943e-07 -1.59119897e-04  2.00449036e-03
 -2.36905833e-02  1.02184499e+00]
  HOMO = -0.243016222660665  LUMO = 1.05886131655438
  mo_energy =
[-1.20325220e+02 -1.23811289e+01 -6.67841355e+00 -6.67841355e+00
 -6.67841355e+00 -1.17939631e+00 -2.43016223e-01 -2.43016223e-01
 -2.43016223e-01  1.05886132e+00  9.99739910e+00  5.15010768e+01
  2.01133726e+02  7.31471359e+02  2.87840774e+03  1.23450118e+04
  4.09573310e+04  1.04995947e+05  2.30176167e+05  4.55988831e+05
  8.44939381e+05  1.52811501e+06  2.85038040e+06  5.80826512e+06]
E1 = -706.6704073113697  E_coul = 198.68516921066868
cycle= 6 E= -507.985238100701  delta_E= -2.84e-13  |g|= 3.94e-08  |ddm|= 2.76e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6704073113697  E_coul = 198.68516921066868
  HOMO = -0.243016242440836  LUMO = 1.05886130768357
  mo_energy =
[-1.20325220e+02 -1.23811290e+01 -6.67841359e+00 -6.67841359e+00
 -6.67841359e+00 -1.17939632e+00 -2.43016242e-01 -2.43016242e-01
 -2.43016242e-01  1.05886131e+00  9.99739906e+00  5.15010768e+01
  2.01133726e+02  7.31471359e+02  2.87840774e+03  1.23450118e+04
  4.09573310e+04  1.04995947e+05  2.30176167e+05  4.55988831e+05
  8.44939381e+05  1.52811501e+06  2.85038040e+06  5.80826512e+06]
E1 = -706.6704072180239  E_coul = 198.68516911732297
Extra cycle  E= -507.985238100701  delta_E= 5.68e-14  |g|= 4.52e-09  |ddm|= 7.65e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909312.5151355551
E1 = -706.6704072180239  E_coul = 198.68516911732297
init E= -507.985238100701
    CPU time for initialize scf      3.61 sec, wall time      0.23 sec
  HOMO = -0.243016245286723  LUMO = 1.05886130559409
  mo_energy =
[-1.20325220e+02 -1.23811290e+01 -6.67841360e+00 -6.67841360e+00
 -6.67841360e+00 -1.17939632e+00 -2.43016245e-01 -2.43016245e-01
 -2.43016245e-01  1.05886131e+00  9.99739905e+00  5.15010768e+01
  2.01133726e+02  7.31471359e+02  2.87840774e+03  1.23450118e+04
  4.09573310e+04  1.04995947e+05  2.30176167e+05  4.55988831e+05
  8.44939381e+05  1.52811501e+06  2.85038040e+06  5.80826512e+06]
E1 = -706.6704072075805  E_coul = 198.6851691068793
cycle= 1 E= -507.985238100701  delta_E= -2.84e-13  |g|= 1.6e-09  |ddm|= 7.75e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6704072075805  E_coul = 198.6851691068793
  HOMO = -0.243016245602519  LUMO = 1.05886130420598
  mo_energy =
[-1.20325220e+02 -1.23811290e+01 -6.67841360e+00 -6.67841360e+00
 -6.67841360e+00 -1.17939632e+00 -2.43016246e-01 -2.43016246e-01
 -2.43016246e-01  1.05886130e+00  9.99739905e+00  5.15010768e+01
  2.01133726e+02  7.31471359e+02  2.87840774e+03  1.23450118e+04
  4.09573310e+04  1.04995947e+05  2.30176167e+05  4.55988831e+05
  8.44939381e+05  1.52811501e+06  2.85038040e+06  5.80826512e+06]
E1 = -706.6704072067469  E_coul = 198.6851691060457
Extra cycle  E= -507.985238100701  delta_E= 5.68e-14  |g|= 1.17e-09  |ddm|= 5.43e-10
    CPU time for scf_cycle      4.06 sec, wall time      0.40 sec
exp = [2.47368680e-01 6.48235844e-01 1.17616814e+05 2.91057574e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547136e+04 7.30306920e+03 1.83757963e+04
 1.44904947e+03 3.75810035e+02 1.23022215e+02 4.69219623e+01
 1.86840905e+01 7.13413113e+00 8.60399932e+00 4.92712823e-01]
grad_E = [ 1.72706079e-05 -7.65239676e-05  3.68935133e-09  3.45853616e-05
  1.28609480e-11  9.67928341e-11  5.74295762e-10  2.24728760e-09
  9.31850526e-09  5.06858790e-08  3.13032715e-06  1.03539544e-07
  3.06910485e-05 -2.44669407e-04  1.58878945e-06  4.75028363e-05
 -7.06095460e-05  3.60706422e-05 -1.27754141e-04  5.99484326e-06]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:15:39 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247355376637       1
[INPUT] 0    0    [1    /1   ]  0.648229812811       1
[INPUT] 0    0    [1    /1   ]  117616.813769        1
[INPUT] 0    0    [1    /1   ]  2.9091370271         1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031058        1
[INPUT] 0    0    [1    /1   ]  147020.991859        1
[INPUT] 0    0    [1    /1   ]  73510.4197718        1
[INPUT] 0    0    [1    /1   ]  36754.7135903        1
[INPUT] 0    0    [1    /1   ]  7303.06994807        1
[INPUT] 0    0    [1    /1   ]  18375.7963501        1
[INPUT] 0    0    [1    /1   ]  1449.04997964        1
[INPUT] 0    0    [1    /1   ]  375.814032617        1
[INPUT] 0    0    [1    /1   ]  122.939650587        1
[INPUT] 0    0    [1    /1   ]  46.8505896163        1
[INPUT] 0    0    [1    /1   ]  18.6252419162        1
[INPUT] 0    0    [1    /1   ]  7.12812683292        1
[INPUT] 1    0    [1    /1   ]  8.6040457187         1
[INPUT] 1    0    [1    /1   ]  0.492714091709       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2473553766369313, 1.0]], [0, [0.6482298128106163, 1.0]], [0, [117616.813768861, 1.0]], [0, [2.9091370271031014, 1.0]], [0, [1176168.1426167786, 1.0]], [0, [588084.0699798211, 1.0]], [0, [294042.0310582982, 1.0]], [0, [147020.9918592258, 1.0]], [0, [73510.41977182403, 1.0]], [0, [36754.71359029964, 1.0]], [0, [7303.069948066666, 1.0]], [0, [18375.796350050216, 1.0]], [0, [1449.0499796368388, 1.0]], [0, [375.8140326172985, 1.0]], [0, [122.93965058722199, 1.0]], [0, [46.85058961625079, 1.0]], [0, [18.62524191623989, 1.0]], [0, [7.128126832917619, 1.0]], [1, [8.604045718695147, 1.0]], [1, [0.49271409170918434, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24735538]
bas 1, expnt(s) = [0.64822981]
bas 2, expnt(s) = [117616.81376886]
bas 3, expnt(s) = [2.90913703]
bas 4, expnt(s) = [1176168.14261678]
bas 5, expnt(s) = [588084.06997982]
bas 6, expnt(s) = [294042.0310583]
bas 7, expnt(s) = [147020.99185923]
bas 8, expnt(s) = [73510.41977182]
bas 9, expnt(s) = [36754.7135903]
bas 10, expnt(s) = [7303.06994807]
bas 11, expnt(s) = [18375.79635005]
bas 12, expnt(s) = [1449.04997964]
bas 13, expnt(s) = [375.81403262]
bas 14, expnt(s) = [122.93965059]
bas 15, expnt(s) = [46.85058962]
bas 16, expnt(s) = [18.62524192]
bas 17, expnt(s) = [7.12812683]
bas 18, expnt(s) = [8.60404572]
bas 19, expnt(s) = [0.49271409]
CPU time:       985.99
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47355377e-01 8.86147549e-01 6.48229813e-01 1.82520553e+00
 1.17616814e+05 1.60460109e+04 2.90913703e+00 5.62779355e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547136e+04 6.70655988e+03
 7.30306995e+03 1.99592455e+03 1.83757964e+04 3.98749041e+03
 1.44904998e+03 5.93372682e+02 3.75814033e+02 2.15647669e+02
 1.22939651e+02 9.32790265e+01 4.68505896e+01 4.52429922e+01
 1.86252419e+01 2.26512131e+01 7.12812683e+00 1.10216493e+01
 8.60404572e+00 4.29895381e+01 4.92714092e-01 1.20428180e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335974581205225
cond(S) = 909303.8195894404
E1 = -689.5966659312585  E_coul = 184.96667040076244
init E= -504.629995530496
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.67226504194339  LUMO = 0.67946896085344
  mo_energy =
[-1.21708213e+02 -1.33863874e+01 -7.62395660e+00 -7.62395660e+00
 -7.62395660e+00 -1.65738678e+00 -6.72265042e-01 -6.72265042e-01
 -6.72265042e-01  6.79468961e-01  9.20785966e+00  5.02650879e+01
  1.99408665e+02  7.29401508e+02  2.87633333e+03  1.23431237e+04
  4.09555635e+04  1.04994246e+05  2.30174509e+05  4.55987204e+05
  8.44937777e+05  1.52811342e+06  2.85037884e+06  5.80826358e+06]
E1 = -707.7354926360945  E_coul = 199.76807853206296
cycle= 1 E= -507.967414104031  delta_E= -3.34  |g|= 0.451  |ddm|= 0.503
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.702924
diis-c [-0.49410221  1.        ]
  HOMO = -0.217834920375398  LUMO = 1.06545920508053
  mo_energy =
[-1.20199663e+02 -1.23055561e+01 -6.59517365e+00 -6.59517365e+00
 -6.59517365e+00 -1.16331795e+00 -2.17834920e-01 -2.17834920e-01
 -2.17834920e-01  1.06545921e+00  1.00360712e+01  5.14678805e+01
  2.00837613e+02  7.30892723e+02  2.87776517e+03  1.23444465e+04
  4.09568193e+04  1.04995465e+05  2.30175704e+05  4.55988381e+05
  8.44938941e+05  1.52811458e+06  2.85037998e+06  5.80826471e+06]
E1 = -706.792899272359  E_coul = 198.8079217256481
cycle= 2 E= -507.984977546711  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.432
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297671
diis-c [-8.85942698e-04  5.27736208e-04  9.99472264e-01]
  HOMO = -0.239727083645258  LUMO = 1.05982077014837
  mo_energy =
[-1.20312878e+02 -1.23721412e+01 -6.66892736e+00 -6.66892736e+00
 -6.66892736e+00 -1.17740458e+00 -2.39727084e-01 -2.39727084e-01
 -2.39727084e-01  1.05982077e+00  9.99280612e+00  5.13920280e+01
  2.00738118e+02  7.30775412e+02  2.87763220e+03  1.23443032e+04
  4.09566723e+04  1.04995316e+05  2.30175554e+05  4.55988231e+05
  8.44938791e+05  1.52811443e+06  2.85037983e+06  5.80826456e+06]
E1 = -706.6865006980232  E_coul = 198.70126703324675
cycle= 3 E= -507.985233664777  delta_E= -0.000256  |g|= 0.00438  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324057
diis-c [-2.23269278e-06 -7.39627579e-06 -1.07074394e-01  1.10708179e+00]
  HOMO = -0.242874168831856  LUMO = 1.05877634782983
  mo_energy =
[-1.20324818e+02 -1.23807721e+01 -6.67805961e+00 -6.67805961e+00
 -6.67805961e+00 -1.17931030e+00 -2.42874169e-01 -2.42874169e-01
 -2.42874169e-01  1.05877635e+00  9.98670580e+00  5.13827963e+01
  2.00727113e+02  7.30763303e+02  2.87761927e+03  1.23442898e+04
  4.09566587e+04  1.04995302e+05  2.30175540e+05  4.55988218e+05
  8.44938777e+05  1.52811441e+06  2.85037981e+06  5.80826455e+06]
E1 = -706.671355080633  E_coul = 198.68611660239955
cycle= 4 E= -507.985238478233  delta_E= -4.81e-06  |g|= 0.000204  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000142895
diis-c [-1.40859467e-10 -7.50476614e-06  7.12727312e-03 -9.89679095e-02
  1.09184814e+00]
  HOMO = -0.24301308034173  LUMO = 1.05872315199906
  mo_energy =
[-1.20325165e+02 -1.23811070e+01 -6.67839191e+00 -6.67839191e+00
 -6.67839191e+00 -1.17939311e+00 -2.43013080e-01 -2.43013080e-01
 -2.43013080e-01  1.05872315e+00  9.98644545e+00  5.13824679e+01
  2.00726770e+02  7.30762954e+02  2.87761891e+03  1.23442894e+04
  4.09566583e+04  1.04995302e+05  2.30175540e+05  4.55988217e+05
  8.44938777e+05  1.52811441e+06  2.85037981e+06  5.80826455e+06]
E1 = -706.6706945111449  E_coul = 198.6854560229281
cycle= 5 E= -507.985238488217  delta_E= -9.98e-09  |g|= 1.24e-06  |ddm|= 0.000467
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.87449e-07
diis-c [-7.54927170e-14  2.36701420e-07 -1.60476993e-04  2.02265367e-03
 -2.38889948e-02  1.02202658e+00]
  HOMO = -0.243013810296825  LUMO = 1.0587230290959
  mo_energy =
[-1.20325168e+02 -1.23811087e+01 -6.67839372e+00 -6.67839372e+00
 -6.67839372e+00 -1.17939370e+00 -2.43013810e-01 -2.43013810e-01
 -2.43013810e-01  1.05872303e+00  9.98644411e+00  5.13824661e+01
  2.00726768e+02  7.30762952e+02  2.87761891e+03  1.23442894e+04
  4.09566583e+04  1.04995302e+05  2.30175540e+05  4.55988217e+05
  8.44938777e+05  1.52811441e+06  2.85037981e+06  5.80826455e+06]
E1 = -706.6706907558328  E_coul = 198.68545226761506
cycle= 6 E= -507.985238488218  delta_E= -8.53e-13  |g|= 3.97e-08  |ddm|= 2.77e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6706907558328  E_coul = 198.68545226761506
  HOMO = -0.243013830109392  LUMO = 1.05872301997928
  mo_energy =
[-1.20325168e+02 -1.23811088e+01 -6.67839376e+00 -6.67839376e+00
 -6.67839376e+00 -1.17939370e+00 -2.43013830e-01 -2.43013830e-01
 -2.43013830e-01  1.05872302e+00  9.98644407e+00  5.13824661e+01
  2.00726768e+02  7.30762952e+02  2.87761891e+03  1.23442894e+04
  4.09566583e+04  1.04995302e+05  2.30175540e+05  4.55988217e+05
  8.44938777e+05  1.52811441e+06  2.85037981e+06  5.80826455e+06]
E1 = -706.6706906606134  E_coul = 198.68545217239605
Extra cycle  E= -507.985238488217  delta_E= 2.84e-13  |g|= 4.26e-09  |ddm|= 7.77e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.47355377e-01 6.48229813e-01 1.17616814e+05 2.90913703e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547136e+04 7.30306995e+03 1.83757964e+04
 1.44904998e+03 3.75814033e+02 1.22939651e+02 4.68505896e+01
 1.86252419e+01 7.12812683e+00 8.60404572e+00 4.92714092e-01]
E = -507.9852384882174
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:15:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247355376637       1
[INPUT] 0    0    [1    /1   ]  0.648229812811       1
[INPUT] 0    0    [1    /1   ]  117616.813769        1
[INPUT] 0    0    [1    /1   ]  2.9091370271         1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031058        1
[INPUT] 0    0    [1    /1   ]  147020.991859        1
[INPUT] 0    0    [1    /1   ]  73510.4197718        1
[INPUT] 0    0    [1    /1   ]  36754.7135903        1
[INPUT] 0    0    [1    /1   ]  7303.06994807        1
[INPUT] 0    0    [1    /1   ]  18375.7963501        1
[INPUT] 0    0    [1    /1   ]  1449.04997964        1
[INPUT] 0    0    [1    /1   ]  375.814032617        1
[INPUT] 0    0    [1    /1   ]  122.939650587        1
[INPUT] 0    0    [1    /1   ]  46.8505896163        1
[INPUT] 0    0    [1    /1   ]  18.6252419162        1
[INPUT] 0    0    [1    /1   ]  7.12812683292        1
[INPUT] 1    0    [1    /1   ]  8.6040457187         1
[INPUT] 1    0    [1    /1   ]  0.492714091709       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2473553766369313, 1.0]], [0, [0.6482298128106163, 1.0]], [0, [117616.813768861, 1.0]], [0, [2.9091370271031014, 1.0]], [0, [1176168.1426167786, 1.0]], [0, [588084.0699798211, 1.0]], [0, [294042.0310582982, 1.0]], [0, [147020.9918592258, 1.0]], [0, [73510.41977182403, 1.0]], [0, [36754.71359029964, 1.0]], [0, [7303.069948066666, 1.0]], [0, [18375.796350050216, 1.0]], [0, [1449.0499796368388, 1.0]], [0, [375.8140326172985, 1.0]], [0, [122.93965058722199, 1.0]], [0, [46.85058961625079, 1.0]], [0, [18.62524191623989, 1.0]], [0, [7.128126832917619, 1.0]], [1, [8.604045718695147, 1.0]], [1, [0.49271409170918434, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24735538]
bas 1, expnt(s) = [0.64822981]
bas 2, expnt(s) = [117616.81376886]
bas 3, expnt(s) = [2.90913703]
bas 4, expnt(s) = [1176168.14261678]
bas 5, expnt(s) = [588084.06997982]
bas 6, expnt(s) = [294042.0310583]
bas 7, expnt(s) = [147020.99185923]
bas 8, expnt(s) = [73510.41977182]
bas 9, expnt(s) = [36754.7135903]
bas 10, expnt(s) = [7303.06994807]
bas 11, expnt(s) = [18375.79635005]
bas 12, expnt(s) = [1449.04997964]
bas 13, expnt(s) = [375.81403262]
bas 14, expnt(s) = [122.93965059]
bas 15, expnt(s) = [46.85058962]
bas 16, expnt(s) = [18.62524192]
bas 17, expnt(s) = [7.12812683]
bas 18, expnt(s) = [8.60404572]
bas 19, expnt(s) = [0.49271409]
CPU time:       987.54
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47355377e-01 8.86147549e-01 6.48229813e-01 1.82520553e+00
 1.17616814e+05 1.60460109e+04 2.90913703e+00 5.62779355e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547136e+04 6.70655988e+03
 7.30306995e+03 1.99592455e+03 1.83757964e+04 3.98749041e+03
 1.44904998e+03 5.93372682e+02 3.75814033e+02 2.15647669e+02
 1.22939651e+02 9.32790265e+01 4.68505896e+01 4.52429922e+01
 1.86252419e+01 2.26512131e+01 7.12812683e+00 1.10216493e+01
 8.60404572e+00 4.29895381e+01 4.92714092e-01 1.20428180e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335974581205225
cond(S) = 909303.8195894404
E1 = -689.5966659312585  E_coul = 184.96667040076244
init E= -504.629995530496
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.67226504194339  LUMO = 0.67946896085344
  mo_energy =
[-1.21708213e+02 -1.33863874e+01 -7.62395660e+00 -7.62395660e+00
 -7.62395660e+00 -1.65738678e+00 -6.72265042e-01 -6.72265042e-01
 -6.72265042e-01  6.79468961e-01  9.20785966e+00  5.02650879e+01
  1.99408665e+02  7.29401508e+02  2.87633333e+03  1.23431237e+04
  4.09555635e+04  1.04994246e+05  2.30174509e+05  4.55987204e+05
  8.44937777e+05  1.52811342e+06  2.85037884e+06  5.80826358e+06]
E1 = -707.7354926360945  E_coul = 199.76807853206296
cycle= 1 E= -507.967414104031  delta_E= -3.34  |g|= 0.451  |ddm|= 0.503
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.702924
diis-c [-0.49410221  1.        ]
  HOMO = -0.217834920375398  LUMO = 1.06545920508053
  mo_energy =
[-1.20199663e+02 -1.23055561e+01 -6.59517365e+00 -6.59517365e+00
 -6.59517365e+00 -1.16331795e+00 -2.17834920e-01 -2.17834920e-01
 -2.17834920e-01  1.06545921e+00  1.00360712e+01  5.14678805e+01
  2.00837613e+02  7.30892723e+02  2.87776517e+03  1.23444465e+04
  4.09568193e+04  1.04995465e+05  2.30175704e+05  4.55988381e+05
  8.44938941e+05  1.52811458e+06  2.85037998e+06  5.80826471e+06]
E1 = -706.792899272359  E_coul = 198.8079217256481
cycle= 2 E= -507.984977546711  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.432
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297671
diis-c [-8.85942698e-04  5.27736208e-04  9.99472264e-01]
  HOMO = -0.239727083645258  LUMO = 1.05982077014837
  mo_energy =
[-1.20312878e+02 -1.23721412e+01 -6.66892736e+00 -6.66892736e+00
 -6.66892736e+00 -1.17740458e+00 -2.39727084e-01 -2.39727084e-01
 -2.39727084e-01  1.05982077e+00  9.99280612e+00  5.13920280e+01
  2.00738118e+02  7.30775412e+02  2.87763220e+03  1.23443032e+04
  4.09566723e+04  1.04995316e+05  2.30175554e+05  4.55988231e+05
  8.44938791e+05  1.52811443e+06  2.85037983e+06  5.80826456e+06]
E1 = -706.6865006980232  E_coul = 198.70126703324675
cycle= 3 E= -507.985233664777  delta_E= -0.000256  |g|= 0.00438  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324057
diis-c [-2.23269278e-06 -7.39627579e-06 -1.07074394e-01  1.10708179e+00]
  HOMO = -0.242874168831856  LUMO = 1.05877634782983
  mo_energy =
[-1.20324818e+02 -1.23807721e+01 -6.67805961e+00 -6.67805961e+00
 -6.67805961e+00 -1.17931030e+00 -2.42874169e-01 -2.42874169e-01
 -2.42874169e-01  1.05877635e+00  9.98670580e+00  5.13827963e+01
  2.00727113e+02  7.30763303e+02  2.87761927e+03  1.23442898e+04
  4.09566587e+04  1.04995302e+05  2.30175540e+05  4.55988218e+05
  8.44938777e+05  1.52811441e+06  2.85037981e+06  5.80826455e+06]
E1 = -706.671355080633  E_coul = 198.68611660239955
cycle= 4 E= -507.985238478233  delta_E= -4.81e-06  |g|= 0.000204  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000142895
diis-c [-1.40859467e-10 -7.50476614e-06  7.12727312e-03 -9.89679095e-02
  1.09184814e+00]
  HOMO = -0.24301308034173  LUMO = 1.05872315199906
  mo_energy =
[-1.20325165e+02 -1.23811070e+01 -6.67839191e+00 -6.67839191e+00
 -6.67839191e+00 -1.17939311e+00 -2.43013080e-01 -2.43013080e-01
 -2.43013080e-01  1.05872315e+00  9.98644545e+00  5.13824679e+01
  2.00726770e+02  7.30762954e+02  2.87761891e+03  1.23442894e+04
  4.09566583e+04  1.04995302e+05  2.30175540e+05  4.55988217e+05
  8.44938777e+05  1.52811441e+06  2.85037981e+06  5.80826455e+06]
E1 = -706.6706945111449  E_coul = 198.6854560229281
cycle= 5 E= -507.985238488217  delta_E= -9.98e-09  |g|= 1.24e-06  |ddm|= 0.000467
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.87449e-07
diis-c [-7.54927170e-14  2.36701420e-07 -1.60476993e-04  2.02265367e-03
 -2.38889948e-02  1.02202658e+00]
  HOMO = -0.243013810296825  LUMO = 1.0587230290959
  mo_energy =
[-1.20325168e+02 -1.23811087e+01 -6.67839372e+00 -6.67839372e+00
 -6.67839372e+00 -1.17939370e+00 -2.43013810e-01 -2.43013810e-01
 -2.43013810e-01  1.05872303e+00  9.98644411e+00  5.13824661e+01
  2.00726768e+02  7.30762952e+02  2.87761891e+03  1.23442894e+04
  4.09566583e+04  1.04995302e+05  2.30175540e+05  4.55988217e+05
  8.44938777e+05  1.52811441e+06  2.85037981e+06  5.80826455e+06]
E1 = -706.6706907558328  E_coul = 198.68545226761506
cycle= 6 E= -507.985238488218  delta_E= -8.53e-13  |g|= 3.97e-08  |ddm|= 2.77e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6706907558328  E_coul = 198.68545226761506
  HOMO = -0.243013830109392  LUMO = 1.05872301997928
  mo_energy =
[-1.20325168e+02 -1.23811088e+01 -6.67839376e+00 -6.67839376e+00
 -6.67839376e+00 -1.17939370e+00 -2.43013830e-01 -2.43013830e-01
 -2.43013830e-01  1.05872302e+00  9.98644407e+00  5.13824661e+01
  2.00726768e+02  7.30762952e+02  2.87761891e+03  1.23442894e+04
  4.09566583e+04  1.04995302e+05  2.30175540e+05  4.55988217e+05
  8.44938777e+05  1.52811441e+06  2.85037981e+06  5.80826455e+06]
E1 = -706.6706906606134  E_coul = 198.68545217239605
Extra cycle  E= -507.985238488217  delta_E= 2.84e-13  |g|= 4.26e-09  |ddm|= 7.77e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909303.8195894404
E1 = -706.6706906606134  E_coul = 198.68545217239605
init E= -507.985238488217
    CPU time for initialize scf      3.51 sec, wall time      0.22 sec
  HOMO = -0.24301383299899  LUMO = 1.05872301749008
  mo_energy =
[-1.20325168e+02 -1.23811088e+01 -6.67839377e+00 -6.67839377e+00
 -6.67839377e+00 -1.17939371e+00 -2.43013833e-01 -2.43013833e-01
 -2.43013833e-01  1.05872302e+00  9.98644406e+00  5.13824661e+01
  2.00726768e+02  7.30762952e+02  2.87761891e+03  1.23442894e+04
  4.09566583e+04  1.04995302e+05  2.30175540e+05  4.55988217e+05
  8.44938777e+05  1.52811441e+06  2.85037981e+06  5.80826455e+06]
E1 = -706.6706906485089  E_coul = 198.68545216029108
cycle= 1 E= -507.985238488218  delta_E= -3.41e-13  |g|= 9.8e-10  |ddm|= 8.63e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6706906485089  E_coul = 198.68545216029108
  HOMO = -0.243013833350374  LUMO = 1.05872301663297
  mo_energy =
[-1.20325168e+02 -1.23811088e+01 -6.67839377e+00 -6.67839377e+00
 -6.67839377e+00 -1.17939371e+00 -2.43013833e-01 -2.43013833e-01
 -2.43013833e-01  1.05872302e+00  9.98644406e+00  5.13824661e+01
  2.00726768e+02  7.30762952e+02  2.87761891e+03  1.23442894e+04
  4.09566583e+04  1.04995302e+05  2.30175540e+05  4.55988217e+05
  8.44938777e+05  1.52811441e+06  2.85037981e+06  5.80826455e+06]
E1 = -706.6706906486941  E_coul = 198.68545216047664
Extra cycle  E= -507.985238488217  delta_E= 3.41e-13  |g|= 1.41e-09  |ddm|= 1.48e-10
    CPU time for scf_cycle      3.96 sec, wall time      0.39 sec
exp = [2.47355377e-01 6.48229813e-01 1.17616814e+05 2.90913703e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547136e+04 7.30306995e+03 1.83757964e+04
 1.44904998e+03 3.75814033e+02 1.22939651e+02 4.68505896e+01
 1.86252419e+01 7.12812683e+00 8.60404572e+00 4.92714092e-01]
grad_E = [ 1.69901128e-05 -7.60668146e-05  3.69609109e-09  5.06661738e-05
  1.29425972e-11  9.70108633e-11  5.75342524e-10  2.25144965e-09
  9.33602501e-09  5.07728632e-08  3.13664155e-06  1.03797176e-07
  3.03482814e-05 -2.41642900e-04 -4.96106919e-06  5.09117294e-05
 -7.21388361e-05  2.86853013e-05 -8.98721741e-05  4.08633537e-06]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:15:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247346926528       1
[INPUT] 0    0    [1    /1   ]  0.648212797697       1
[INPUT] 0    0    [1    /1   ]  117616.813769        1
[INPUT] 0    0    [1    /1   ]  2.90824372777        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031058        1
[INPUT] 0    0    [1    /1   ]  147020.991859        1
[INPUT] 0    0    [1    /1   ]  73510.4197727        1
[INPUT] 0    0    [1    /1   ]  36754.713595         1
[INPUT] 0    0    [1    /1   ]  7303.07024271        1
[INPUT] 0    0    [1    /1   ]  18375.7963602        1
[INPUT] 0    0    [1    /1   ]  1449.0499773         1
[INPUT] 0    0    [1    /1   ]  375.817215521        1
[INPUT] 0    0    [1    /1   ]  122.907589413        1
[INPUT] 0    0    [1    /1   ]  46.8172072077        1
[INPUT] 0    0    [1    /1   ]  18.5933594008        1
[INPUT] 0    0    [1    /1   ]  7.12376811811        1
[INPUT] 1    0    [1    /1   ]  8.60414215845        1
[INPUT] 1    0    [1    /1   ]  0.492716240861       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24734692652773965, 1.0]], [0, [0.6482127976971176, 1.0]], [0, [117616.81376920441, 1.0]], [0, [2.908243727765667, 1.0]], [0, [1176168.1426167802, 1.0]], [0, [588084.0699798304, 1.0]], [0, [294042.0310583516, 1.0]], [0, [147020.99185943542, 1.0]], [0, [73510.41977269536, 1.0]], [0, [36754.71359497274, 1.0]], [0, [7303.070242711081, 1.0]], [0, [18375.79636023523, 1.0]], [0, [1449.0499772995781, 1.0]], [0, [375.8172155210862, 1.0]], [0, [122.90758941344832, 1.0]], [0, [46.81720720767593, 1.0]], [0, [18.593359400835343, 1.0]], [0, [7.123768118109197, 1.0]], [1, [8.604142158454529, 1.0]], [1, [0.49271624086133237, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24734693]
bas 1, expnt(s) = [0.6482128]
bas 2, expnt(s) = [117616.8137692]
bas 3, expnt(s) = [2.90824373]
bas 4, expnt(s) = [1176168.14261678]
bas 5, expnt(s) = [588084.06997983]
bas 6, expnt(s) = [294042.03105835]
bas 7, expnt(s) = [147020.99185944]
bas 8, expnt(s) = [73510.4197727]
bas 9, expnt(s) = [36754.71359497]
bas 10, expnt(s) = [7303.07024271]
bas 11, expnt(s) = [18375.79636024]
bas 12, expnt(s) = [1449.0499773]
bas 13, expnt(s) = [375.81721552]
bas 14, expnt(s) = [122.90758941]
bas 15, expnt(s) = [46.81720721]
bas 16, expnt(s) = [18.5933594]
bas 17, expnt(s) = [7.12376812]
bas 18, expnt(s) = [8.60414216]
bas 19, expnt(s) = [0.49271624]
CPU time:       999.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47346927e-01 8.86124844e-01 6.48212798e-01 1.82516959e+00
 1.17616814e+05 1.60460109e+04 2.90824373e+00 5.62649742e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547136e+04 6.70655988e+03
 7.30307024e+03 1.99592461e+03 1.83757964e+04 3.98749041e+03
 1.44904998e+03 5.93372681e+02 3.75817216e+02 2.15649039e+02
 1.22907589e+02 9.32607814e+01 4.68172072e+01 4.52188123e+01
 1.85933594e+01 2.26221263e+01 7.12376812e+00 1.10165943e+01
 8.60414216e+00 4.29901405e+01 4.92716241e-01 1.20428836e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335971543322025
cond(S) = 909299.6840737625
E1 = -689.5971424417925  E_coul = 184.96716784786773
init E= -504.629974593925
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672263615958601  LUMO = 0.679395479717628
  mo_energy =
[-1.21708116e+02 -1.33863488e+01 -7.62392205e+00 -7.62392205e+00
 -7.62392205e+00 -1.65738356e+00 -6.72263616e-01 -6.72263616e-01
 -6.72263616e-01  6.79395480e-01  9.20117276e+00  5.01985951e+01
  1.99199749e+02  7.29063011e+02  2.87596936e+03  1.23427933e+04
  4.09552562e+04  1.04993951e+05  2.30174222e+05  4.55986923e+05
  8.44937501e+05  1.52811315e+06  2.85037857e+06  5.80826332e+06]
E1 = -707.7361025770987  E_coul = 199.76868909374122
cycle= 1 E= -507.967413483357  delta_E= -3.34  |g|= 0.451  |ddm|= 0.503
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.702873
diis-c [-0.49403004  1.        ]
  HOMO = -0.217829919613918  LUMO = 1.0653612767292
  mo_energy =
[-1.20199555e+02 -1.23055099e+01 -6.59513027e+00 -6.59513027e+00
 -6.59513027e+00 -1.16331247e+00 -2.17829920e-01 -2.17829920e-01
 -2.17829920e-01  1.06536128e+00  1.00291144e+01  5.14010302e+01
  2.00628605e+02  7.30554234e+02  2.87740121e+03  1.23441161e+04
  4.09565120e+04  1.04995170e+05  2.30175417e+05  4.55988101e+05
  8.44938665e+05  1.52811430e+06  2.85037971e+06  5.80826445e+06]
E1 = -706.7934783159798  E_coul = 198.80850063648882
cycle= 2 E= -507.984977679491  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.432
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.02977
diis-c [-8.86121816e-04  5.12522756e-04  9.99487477e-01]
  HOMO = -0.239722966889219  LUMO = 1.05972416987442
  mo_energy =
[-1.20312774e+02 -1.23720985e+01 -6.66888779e+00 -6.66888779e+00
 -6.66888779e+00 -1.17739957e+00 -2.39722967e-01 -2.39722967e-01
 -2.39722967e-01  1.05972417e+00  9.98586628e+00  5.13252036e+01
  2.00529119e+02  7.30436919e+02  2.87726824e+03  1.23439728e+04
  4.09563650e+04  1.04995021e+05  2.30175268e+05  4.55987951e+05
  8.44938515e+05  1.52811415e+06  2.85037956e+06  5.80826430e+06]
E1 = -706.6870760398134  E_coul = 198.70184223635408
cycle= 3 E= -507.985233803459  delta_E= -0.000256  |g|= 0.00438  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324057
diis-c [-2.23362482e-06 -6.85846963e-06 -1.07056645e-01  1.10706350e+00]
  HOMO = -0.242869768500473  LUMO = 1.05868003160084
  mo_energy =
[-1.20324713e+02 -1.23807285e+01 -6.67801904e+00 -6.67801904e+00
 -6.67801904e+00 -1.17930509e+00 -2.42869769e-01 -2.42869769e-01
 -2.42869769e-01  1.05868003e+00  9.97976871e+00  5.13159753e+01
  2.00518116e+02  7.30424812e+02  2.87725530e+03  1.23439594e+04
  4.09563514e+04  1.04995008e+05  2.30175254e+05  4.55987937e+05
  8.44938501e+05  1.52811414e+06  2.85037955e+06  5.80826429e+06]
E1 = -706.6719318750651  E_coul = 198.68669325883275
cycle= 4 E= -507.985238616232  delta_E= -4.81e-06  |g|= 0.000204  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00014293
diis-c [-1.40946044e-10 -7.50311942e-06  7.12520592e-03 -9.89674328e-02
  1.09184973e+00]
  HOMO = -0.243008704693552  LUMO = 1.05862683844631
  mo_energy =
[-1.20325061e+02 -1.23810634e+01 -6.67835140e+00 -6.67835140e+00
 -6.67835140e+00 -1.17938792e+00 -2.43008705e-01 -2.43008705e-01
 -2.43008705e-01  1.05862684e+00  9.97950838e+00  5.13156470e+01
  2.00517773e+02  7.30424463e+02  2.87725495e+03  1.23439590e+04
  4.09563510e+04  1.04995007e+05  2.30175254e+05  4.55987937e+05
  8.44938501e+05  1.52811414e+06  2.85037955e+06  5.80826429e+06]
E1 = -706.6712711935746  E_coul = 198.6860325673544
cycle= 5 E= -507.98523862622  delta_E= -9.99e-09  |g|= 1.25e-06  |ddm|= 0.000467
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.86295e-07
diis-c [-7.65498466e-14  2.25714257e-07 -1.59726444e-04  2.01440540e-03
 -2.38113291e-02  1.02195642e+00]
  HOMO = -0.243009435965348  LUMO = 1.05862671604698
  mo_energy =
[-1.20325063e+02 -1.23810651e+01 -6.67835320e+00 -6.67835320e+00
 -6.67835320e+00 -1.17938850e+00 -2.43009436e-01 -2.43009436e-01
 -2.43009436e-01  1.05862672e+00  9.97950704e+00  5.13156452e+01
  2.00517770e+02  7.30424461e+02  2.87725495e+03  1.23439590e+04
  4.09563510e+04  1.04995007e+05  2.30175254e+05  4.55987937e+05
  8.44938501e+05  1.52811414e+06  2.85037955e+06  5.80826429e+06]
E1 = -706.6712674272561  E_coul = 198.68602880103532
cycle= 6 E= -507.985238626221  delta_E= -5.68e-13  |g|= 3.94e-08  |ddm|= 2.78e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6712674272561  E_coul = 198.68602880103532
  HOMO = -0.243009455981026  LUMO = 1.05862670564349
  mo_energy =
[-1.20325063e+02 -1.23810652e+01 -6.67835324e+00 -6.67835324e+00
 -6.67835324e+00 -1.17938851e+00 -2.43009456e-01 -2.43009456e-01
 -2.43009456e-01  1.05862671e+00  9.97950700e+00  5.13156451e+01
  2.00517770e+02  7.30424461e+02  2.87725495e+03  1.23439590e+04
  4.09563510e+04  1.04995007e+05  2.30175254e+05  4.55987937e+05
  8.44938501e+05  1.52811414e+06  2.85037955e+06  5.80826429e+06]
E1 = -706.6712673360495  E_coul = 198.6860287098289
Extra cycle  E= -507.985238626221  delta_E= 1.71e-13  |g|= 4.96e-09  |ddm|= 7.54e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.47346927e-01 6.48212798e-01 1.17616814e+05 2.90824373e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547136e+04 7.30307024e+03 1.83757964e+04
 1.44904998e+03 3.75817216e+02 1.22907589e+02 4.68172072e+01
 1.85933594e+01 7.12376812e+00 8.60414216e+00 4.92716241e-01]
E = -507.9852386262206
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:15:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247346926528       1
[INPUT] 0    0    [1    /1   ]  0.648212797697       1
[INPUT] 0    0    [1    /1   ]  117616.813769        1
[INPUT] 0    0    [1    /1   ]  2.90824372777        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031058        1
[INPUT] 0    0    [1    /1   ]  147020.991859        1
[INPUT] 0    0    [1    /1   ]  73510.4197727        1
[INPUT] 0    0    [1    /1   ]  36754.713595         1
[INPUT] 0    0    [1    /1   ]  7303.07024271        1
[INPUT] 0    0    [1    /1   ]  18375.7963602        1
[INPUT] 0    0    [1    /1   ]  1449.0499773         1
[INPUT] 0    0    [1    /1   ]  375.817215521        1
[INPUT] 0    0    [1    /1   ]  122.907589413        1
[INPUT] 0    0    [1    /1   ]  46.8172072077        1
[INPUT] 0    0    [1    /1   ]  18.5933594008        1
[INPUT] 0    0    [1    /1   ]  7.12376811811        1
[INPUT] 1    0    [1    /1   ]  8.60414215845        1
[INPUT] 1    0    [1    /1   ]  0.492716240861       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24734692652773965, 1.0]], [0, [0.6482127976971176, 1.0]], [0, [117616.81376920441, 1.0]], [0, [2.908243727765667, 1.0]], [0, [1176168.1426167802, 1.0]], [0, [588084.0699798304, 1.0]], [0, [294042.0310583516, 1.0]], [0, [147020.99185943542, 1.0]], [0, [73510.41977269536, 1.0]], [0, [36754.71359497274, 1.0]], [0, [7303.070242711081, 1.0]], [0, [18375.79636023523, 1.0]], [0, [1449.0499772995781, 1.0]], [0, [375.8172155210862, 1.0]], [0, [122.90758941344832, 1.0]], [0, [46.81720720767593, 1.0]], [0, [18.593359400835343, 1.0]], [0, [7.123768118109197, 1.0]], [1, [8.604142158454529, 1.0]], [1, [0.49271624086133237, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24734693]
bas 1, expnt(s) = [0.6482128]
bas 2, expnt(s) = [117616.8137692]
bas 3, expnt(s) = [2.90824373]
bas 4, expnt(s) = [1176168.14261678]
bas 5, expnt(s) = [588084.06997983]
bas 6, expnt(s) = [294042.03105835]
bas 7, expnt(s) = [147020.99185944]
bas 8, expnt(s) = [73510.4197727]
bas 9, expnt(s) = [36754.71359497]
bas 10, expnt(s) = [7303.07024271]
bas 11, expnt(s) = [18375.79636024]
bas 12, expnt(s) = [1449.0499773]
bas 13, expnt(s) = [375.81721552]
bas 14, expnt(s) = [122.90758941]
bas 15, expnt(s) = [46.81720721]
bas 16, expnt(s) = [18.5933594]
bas 17, expnt(s) = [7.12376812]
bas 18, expnt(s) = [8.60414216]
bas 19, expnt(s) = [0.49271624]
CPU time:      1001.09
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47346927e-01 8.86124844e-01 6.48212798e-01 1.82516959e+00
 1.17616814e+05 1.60460109e+04 2.90824373e+00 5.62649742e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547136e+04 6.70655988e+03
 7.30307024e+03 1.99592461e+03 1.83757964e+04 3.98749041e+03
 1.44904998e+03 5.93372681e+02 3.75817216e+02 2.15649039e+02
 1.22907589e+02 9.32607814e+01 4.68172072e+01 4.52188123e+01
 1.85933594e+01 2.26221263e+01 7.12376812e+00 1.10165943e+01
 8.60414216e+00 4.29901405e+01 4.92716241e-01 1.20428836e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335971543322025
cond(S) = 909299.6840737625
E1 = -689.5971424417925  E_coul = 184.96716784786773
init E= -504.629974593925
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672263615958601  LUMO = 0.679395479717628
  mo_energy =
[-1.21708116e+02 -1.33863488e+01 -7.62392205e+00 -7.62392205e+00
 -7.62392205e+00 -1.65738356e+00 -6.72263616e-01 -6.72263616e-01
 -6.72263616e-01  6.79395480e-01  9.20117276e+00  5.01985951e+01
  1.99199749e+02  7.29063011e+02  2.87596936e+03  1.23427933e+04
  4.09552562e+04  1.04993951e+05  2.30174222e+05  4.55986923e+05
  8.44937501e+05  1.52811315e+06  2.85037857e+06  5.80826332e+06]
E1 = -707.7361025770987  E_coul = 199.76868909374122
cycle= 1 E= -507.967413483357  delta_E= -3.34  |g|= 0.451  |ddm|= 0.503
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.702873
diis-c [-0.49403004  1.        ]
  HOMO = -0.217829919613918  LUMO = 1.0653612767292
  mo_energy =
[-1.20199555e+02 -1.23055099e+01 -6.59513027e+00 -6.59513027e+00
 -6.59513027e+00 -1.16331247e+00 -2.17829920e-01 -2.17829920e-01
 -2.17829920e-01  1.06536128e+00  1.00291144e+01  5.14010302e+01
  2.00628605e+02  7.30554234e+02  2.87740121e+03  1.23441161e+04
  4.09565120e+04  1.04995170e+05  2.30175417e+05  4.55988101e+05
  8.44938665e+05  1.52811430e+06  2.85037971e+06  5.80826445e+06]
E1 = -706.7934783159798  E_coul = 198.80850063648882
cycle= 2 E= -507.984977679491  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.432
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.02977
diis-c [-8.86121816e-04  5.12522756e-04  9.99487477e-01]
  HOMO = -0.239722966889219  LUMO = 1.05972416987442
  mo_energy =
[-1.20312774e+02 -1.23720985e+01 -6.66888779e+00 -6.66888779e+00
 -6.66888779e+00 -1.17739957e+00 -2.39722967e-01 -2.39722967e-01
 -2.39722967e-01  1.05972417e+00  9.98586628e+00  5.13252036e+01
  2.00529119e+02  7.30436919e+02  2.87726824e+03  1.23439728e+04
  4.09563650e+04  1.04995021e+05  2.30175268e+05  4.55987951e+05
  8.44938515e+05  1.52811415e+06  2.85037956e+06  5.80826430e+06]
E1 = -706.6870760398134  E_coul = 198.70184223635408
cycle= 3 E= -507.985233803459  delta_E= -0.000256  |g|= 0.00438  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324057
diis-c [-2.23362482e-06 -6.85846963e-06 -1.07056645e-01  1.10706350e+00]
  HOMO = -0.242869768500473  LUMO = 1.05868003160084
  mo_energy =
[-1.20324713e+02 -1.23807285e+01 -6.67801904e+00 -6.67801904e+00
 -6.67801904e+00 -1.17930509e+00 -2.42869769e-01 -2.42869769e-01
 -2.42869769e-01  1.05868003e+00  9.97976871e+00  5.13159753e+01
  2.00518116e+02  7.30424812e+02  2.87725530e+03  1.23439594e+04
  4.09563514e+04  1.04995008e+05  2.30175254e+05  4.55987937e+05
  8.44938501e+05  1.52811414e+06  2.85037955e+06  5.80826429e+06]
E1 = -706.6719318750651  E_coul = 198.68669325883275
cycle= 4 E= -507.985238616232  delta_E= -4.81e-06  |g|= 0.000204  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00014293
diis-c [-1.40946044e-10 -7.50311942e-06  7.12520592e-03 -9.89674328e-02
  1.09184973e+00]
  HOMO = -0.243008704693552  LUMO = 1.05862683844631
  mo_energy =
[-1.20325061e+02 -1.23810634e+01 -6.67835140e+00 -6.67835140e+00
 -6.67835140e+00 -1.17938792e+00 -2.43008705e-01 -2.43008705e-01
 -2.43008705e-01  1.05862684e+00  9.97950838e+00  5.13156470e+01
  2.00517773e+02  7.30424463e+02  2.87725495e+03  1.23439590e+04
  4.09563510e+04  1.04995007e+05  2.30175254e+05  4.55987937e+05
  8.44938501e+05  1.52811414e+06  2.85037955e+06  5.80826429e+06]
E1 = -706.6712711935746  E_coul = 198.6860325673544
cycle= 5 E= -507.98523862622  delta_E= -9.99e-09  |g|= 1.25e-06  |ddm|= 0.000467
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.86295e-07
diis-c [-7.65498466e-14  2.25714257e-07 -1.59726444e-04  2.01440540e-03
 -2.38113291e-02  1.02195642e+00]
  HOMO = -0.243009435965348  LUMO = 1.05862671604698
  mo_energy =
[-1.20325063e+02 -1.23810651e+01 -6.67835320e+00 -6.67835320e+00
 -6.67835320e+00 -1.17938850e+00 -2.43009436e-01 -2.43009436e-01
 -2.43009436e-01  1.05862672e+00  9.97950704e+00  5.13156452e+01
  2.00517770e+02  7.30424461e+02  2.87725495e+03  1.23439590e+04
  4.09563510e+04  1.04995007e+05  2.30175254e+05  4.55987937e+05
  8.44938501e+05  1.52811414e+06  2.85037955e+06  5.80826429e+06]
E1 = -706.6712674272561  E_coul = 198.68602880103532
cycle= 6 E= -507.985238626221  delta_E= -5.68e-13  |g|= 3.94e-08  |ddm|= 2.78e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6712674272561  E_coul = 198.68602880103532
  HOMO = -0.243009455981026  LUMO = 1.05862670564349
  mo_energy =
[-1.20325063e+02 -1.23810652e+01 -6.67835324e+00 -6.67835324e+00
 -6.67835324e+00 -1.17938851e+00 -2.43009456e-01 -2.43009456e-01
 -2.43009456e-01  1.05862671e+00  9.97950700e+00  5.13156451e+01
  2.00517770e+02  7.30424461e+02  2.87725495e+03  1.23439590e+04
  4.09563510e+04  1.04995007e+05  2.30175254e+05  4.55987937e+05
  8.44938501e+05  1.52811414e+06  2.85037955e+06  5.80826429e+06]
E1 = -706.6712673360495  E_coul = 198.6860287098289
Extra cycle  E= -507.985238626221  delta_E= 1.71e-13  |g|= 4.96e-09  |ddm|= 7.54e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909299.6840737625
E1 = -706.6712673360495  E_coul = 198.6860287098289
init E= -507.985238626221
    CPU time for initialize scf      3.49 sec, wall time      0.22 sec
  HOMO = -0.243009458772779  LUMO = 1.05862670433219
  mo_energy =
[-1.20325063e+02 -1.23810652e+01 -6.67835325e+00 -6.67835325e+00
 -6.67835325e+00 -1.17938852e+00 -2.43009459e-01 -2.43009459e-01
 -2.43009459e-01  1.05862670e+00  9.97950699e+00  5.13156451e+01
  2.00517770e+02  7.30424461e+02  2.87725495e+03  1.23439590e+04
  4.09563510e+04  1.04995007e+05  2.30175254e+05  4.55987937e+05
  8.44938501e+05  1.52811414e+06  2.85037955e+06  5.80826429e+06]
E1 = -706.6712673222114  E_coul = 198.68602869599093
cycle= 1 E= -507.985238626221  delta_E= 1.14e-13  |g|= 1.6e-09  |ddm|= 9.81e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6712673222114  E_coul = 198.68602869599093
  HOMO = -0.243009459172793  LUMO = 1.05862670357639
  mo_energy =
[-1.20325063e+02 -1.23810652e+01 -6.67835325e+00 -6.67835325e+00
 -6.67835325e+00 -1.17938852e+00 -2.43009459e-01 -2.43009459e-01
 -2.43009459e-01  1.05862670e+00  9.97950699e+00  5.13156451e+01
  2.00517770e+02  7.30424461e+02  2.87725495e+03  1.23439590e+04
  4.09563510e+04  1.04995007e+05  2.30175254e+05  4.55987937e+05
  8.44938501e+05  1.52811414e+06  2.85037955e+06  5.80826429e+06]
E1 = -706.6712673210834  E_coul = 198.68602869486264
Extra cycle  E= -507.985238626221  delta_E= -2.27e-13  |g|= 1.25e-09  |ddm|= 7.83e-10
    CPU time for scf_cycle      3.94 sec, wall time      0.39 sec
exp = [2.47346927e-01 6.48212798e-01 1.17616814e+05 2.90824373e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547136e+04 7.30307024e+03 1.83757964e+04
 1.44904998e+03 3.75817216e+02 1.22907589e+02 4.68172072e+01
 1.85933594e+01 7.12376812e+00 8.60414216e+00 4.92716241e-01]
grad_E = [ 1.61289886e-05 -7.73012429e-05  3.69853764e-09  8.04904375e-05
  1.29722340e-11  9.70900165e-11  5.75722486e-10  2.25296050e-09
  9.34238491e-09  5.08044323e-08  3.13892597e-06  1.03890732e-07
  3.02265450e-05 -2.40633385e-04 -6.85488449e-06  5.21727216e-05
 -7.31666279e-05  1.45580726e-05 -1.07004658e-05 -1.25842417e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:15:55 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247336755364       1
[INPUT] 0    0    [1    /1   ]  0.648191694499       1
[INPUT] 0    0    [1    /1   ]  117616.813769        1
[INPUT] 0    0    [1    /1   ]  2.90737086284        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031058        1
[INPUT] 0    0    [1    /1   ]  147020.99186         1
[INPUT] 0    0    [1    /1   ]  73510.4197734        1
[INPUT] 0    0    [1    /1   ]  36754.7135986        1
[INPUT] 0    0    [1    /1   ]  7303.07047448        1
[INPUT] 0    0    [1    /1   ]  18375.7963683        1
[INPUT] 0    0    [1    /1   ]  1449.04984508        1
[INPUT] 0    0    [1    /1   ]  375.82083424         1
[INPUT] 0    0    [1    /1   ]  122.881696772        1
[INPUT] 0    0    [1    /1   ]  46.7885917924        1
[INPUT] 0    0    [1    /1   ]  18.5648931084        1
[INPUT] 0    0    [1    /1   ]  7.119376797          1
[INPUT] 1    0    [1    /1   ]  8.60423751397        1
[INPUT] 1    0    [1    /1   ]  0.492718335759       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24733675536425098, 1.0]], [0, [0.6481916944988387, 1.0]], [0, [117616.81376947438, 1.0]], [0, [2.907370862839866, 1.0]], [0, [1176168.1426167816, 1.0]], [0, [588084.0699798377, 1.0]], [0, [294042.0310583936, 1.0]], [0, [147020.99185960024, 1.0]], [0, [73510.41977338052, 1.0]], [0, [36754.71359864428, 1.0]], [0, [7303.070474478437, 1.0]], [0, [18375.796368267842, 1.0]], [0, [1449.0498450790349, 1.0]], [0, [375.820834240145, 1.0]], [0, [122.881696771919, 1.0]], [0, [46.78859179242762, 1.0]], [0, [18.564893108390372, 1.0]], [0, [7.119376796997452, 1.0]], [1, [8.604237513968432, 1.0]], [1, [0.49271833575909535, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24733676]
bas 1, expnt(s) = [0.64819169]
bas 2, expnt(s) = [117616.81376947]
bas 3, expnt(s) = [2.90737086]
bas 4, expnt(s) = [1176168.14261678]
bas 5, expnt(s) = [588084.06997984]
bas 6, expnt(s) = [294042.03105839]
bas 7, expnt(s) = [147020.9918596]
bas 8, expnt(s) = [73510.41977338]
bas 9, expnt(s) = [36754.71359864]
bas 10, expnt(s) = [7303.07047448]
bas 11, expnt(s) = [18375.79636827]
bas 12, expnt(s) = [1449.04984508]
bas 13, expnt(s) = [375.82083424]
bas 14, expnt(s) = [122.88169677]
bas 15, expnt(s) = [46.78859179]
bas 16, expnt(s) = [18.56489311]
bas 17, expnt(s) = [7.1193768]
bas 18, expnt(s) = [8.60423751]
bas 19, expnt(s) = [0.49271834]
CPU time:      1013.06
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47336755e-01 8.86097515e-01 6.48191694e-01 1.82512503e+00
 1.17616814e+05 1.60460109e+04 2.90737086e+00 5.62523085e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547136e+04 6.70655988e+03
 7.30307047e+03 1.99592466e+03 1.83757964e+04 3.98749041e+03
 1.44904985e+03 5.93372641e+02 3.75820834e+02 2.15650596e+02
 1.22881697e+02 9.32460457e+01 4.67885918e+01 4.51980819e+01
 1.85648931e+01 2.25961456e+01 7.11937680e+00 1.10115006e+01
 8.60423751e+00 4.29907360e+01 4.92718336e-01 1.20429476e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33596859307002
cond(S) = 909296.1122600668
E1 = -689.5976136137654  E_coul = 184.96765847422822
init E= -504.629955139537
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672262239693782  LUMO = 0.679314438972838
  mo_energy =
[-1.21708019e+02 -1.33863107e+01 -7.62388798e+00 -7.62388798e+00
 -7.62388798e+00 -1.65738045e+00 -6.72262240e-01 -6.72262240e-01
 -6.72262240e-01  6.79314439e-01  9.19469106e+00  5.01376569e+01
  1.99014459e+02  7.28769899e+02  2.87565864e+03  1.23425124e+04
  4.09549950e+04  1.04993700e+05  2.30173979e+05  4.55986685e+05
  8.44937266e+05  1.52811292e+06  2.85037834e+06  5.80826310e+06]
E1 = -707.7367063474375  E_coul = 199.76929342561016
cycle= 1 E= -507.967412921827  delta_E= -3.34  |g|= 0.451  |ddm|= 0.503
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.702827
diis-c [-0.49396566  1.        ]
  HOMO = -0.217825034993513  LUMO = 1.06525502360101
  mo_energy =
[-1.20199447e+02 -1.23054641e+01 -6.59508728e+00 -6.59508728e+00
 -6.59508728e+00 -1.16330713e+00 -2.17825035e-01 -2.17825035e-01
 -2.17825035e-01  1.06525502e+00  1.00223762e+01  5.13397708e+01
  2.00443237e+02  7.30261131e+02  2.87709050e+03  1.23438352e+04
  4.09562509e+04  1.04994919e+05  2.30175174e+05  4.55987862e+05
  8.44938431e+05  1.52811407e+06  2.85037949e+06  5.80826423e+06]
E1 = -706.7940508735369  E_coul = 198.8090730023366
cycle= 2 E= -507.9849778712  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.432
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297726
diis-c [-8.86283838e-04  4.98899763e-04  9.99501100e-01]
  HOMO = -0.239718973142824  LUMO = 1.05961925273199
  mo_energy =
[-1.20312672e+02 -1.23720560e+01 -6.66884848e+00 -6.66884848e+00
 -6.66884848e+00 -1.17739471e+00 -2.39718973e-01 -2.39718973e-01
 -2.39718973e-01  1.05961925e+00  9.97914418e+00  5.12639675e+01
  2.00343757e+02  7.30143811e+02  2.87695752e+03  1.23436919e+04
  4.09561038e+04  1.04994771e+05  2.30175024e+05  4.55987713e+05
  8.44938281e+05  1.52811392e+06  2.85037934e+06  5.80826408e+06]
E1 = -706.6876447280417  E_coul = 198.7024107256459
cycle= 3 E= -507.985234002396  delta_E= -0.000256  |g|= 0.00438  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324059
diis-c [-2.23448122e-06 -6.37893120e-06 -1.07041279e-01  1.10704766e+00]
  HOMO = -0.242865543604814  LUMO = 1.05857539025895
  mo_energy =
[-1.20324609e+02 -1.23806852e+01 -6.67797890e+00 -6.67797890e+00
 -6.67797890e+00 -1.17930007e+00 -2.42865544e-01 -2.42865544e-01
 -2.42865544e-01  1.05857539e+00  9.97304916e+00  5.12547423e+01
  2.00332756e+02  7.30131706e+02  2.87694459e+03  1.23436785e+04
  4.09560902e+04  1.04994757e+05  2.30175010e+05  4.55987699e+05
  8.44938267e+05  1.52811391e+06  2.85037932e+06  5.80826407e+06]
E1 = -706.6725017457541  E_coul = 198.68726293112655
cycle= 4 E= -507.985238814628  delta_E= -4.81e-06  |g|= 0.000204  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000142959
diis-c [-1.41040653e-10 -7.51228437e-06  7.12352619e-03 -9.89667371e-02
  1.09185072e+00]
  HOMO = -0.243004502679384  LUMO = 1.05852219512225
  mo_energy =
[-1.20324957e+02 -1.23810202e+01 -6.67831129e+00 -6.67831129e+00
 -6.67831129e+00 -1.17938292e+00 -2.43004503e-01 -2.43004503e-01
 -2.43004503e-01  1.05852220e+00  9.97278886e+00  5.12544139e+01
  2.00332413e+02  7.30131357e+02  2.87694424e+03  1.23436781e+04
  4.09560899e+04  1.04994757e+05  2.30175010e+05  4.55987698e+05
  8.44938266e+05  1.52811391e+06  2.85037932e+06  5.80826407e+06]
E1 = -706.6718409562521  E_coul = 198.6866021316316
cycle= 5 E= -507.985238824621  delta_E= -9.99e-09  |g|= 1.25e-06  |ddm|= 0.000467
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.87551e-07
diis-c [-7.70221606e-14  2.25693699e-07 -1.59467850e-04  2.01141618e-03
 -2.37911308e-02  1.02193896e+00]
  HOMO = -0.243005235654786  LUMO = 1.05852207354504
  mo_energy =
[-1.20324960e+02 -1.23810219e+01 -6.67831310e+00 -6.67831310e+00
 -6.67831310e+00 -1.17938350e+00 -2.43005236e-01 -2.43005236e-01
 -2.43005236e-01  1.05852207e+00  9.97278752e+00  5.12544121e+01
  2.00332411e+02  7.30131355e+02  2.87694423e+03  1.23436781e+04
  4.09560899e+04  1.04994757e+05  2.30175010e+05  4.55987698e+05
  8.44938266e+05  1.52811391e+06  2.85037932e+06  5.80826407e+06]
E1 = -706.6718371849181  E_coul = 198.6865983602975
cycle= 6 E= -507.985238824621  delta_E= -1.14e-13  |g|= 3.97e-08  |ddm|= 2.78e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6718371849181  E_coul = 198.6865983602975
  HOMO = -0.243005255632612  LUMO = 1.05852206099968
  mo_energy =
[-1.20324960e+02 -1.23810219e+01 -6.67831314e+00 -6.67831314e+00
 -6.67831314e+00 -1.17938351e+00 -2.43005256e-01 -2.43005256e-01
 -2.43005256e-01  1.05852206e+00  9.97278748e+00  5.12544121e+01
  2.00332411e+02  7.30131355e+02  2.87694423e+03  1.23436781e+04
  4.09560899e+04  1.04994757e+05  2.30175010e+05  4.55987698e+05
  8.44938266e+05  1.52811391e+06  2.85037932e+06  5.80826407e+06]
E1 = -706.6718370926869  E_coul = 198.68659826806635
Extra cycle  E= -507.985238824621  delta_E= 5.68e-14  |g|= 4.81e-09  |ddm|= 7.58e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.47336755e-01 6.48191694e-01 1.17616814e+05 2.90737086e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547136e+04 7.30307047e+03 1.83757964e+04
 1.44904985e+03 3.75820834e+02 1.22881697e+02 4.67885918e+01
 1.85648931e+01 7.11937680e+00 8.60423751e+00 4.92718336e-01]
E = -507.9852388246206
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:15:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247336755364       1
[INPUT] 0    0    [1    /1   ]  0.648191694499       1
[INPUT] 0    0    [1    /1   ]  117616.813769        1
[INPUT] 0    0    [1    /1   ]  2.90737086284        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031058        1
[INPUT] 0    0    [1    /1   ]  147020.99186         1
[INPUT] 0    0    [1    /1   ]  73510.4197734        1
[INPUT] 0    0    [1    /1   ]  36754.7135986        1
[INPUT] 0    0    [1    /1   ]  7303.07047448        1
[INPUT] 0    0    [1    /1   ]  18375.7963683        1
[INPUT] 0    0    [1    /1   ]  1449.04984508        1
[INPUT] 0    0    [1    /1   ]  375.82083424         1
[INPUT] 0    0    [1    /1   ]  122.881696772        1
[INPUT] 0    0    [1    /1   ]  46.7885917924        1
[INPUT] 0    0    [1    /1   ]  18.5648931084        1
[INPUT] 0    0    [1    /1   ]  7.119376797          1
[INPUT] 1    0    [1    /1   ]  8.60423751397        1
[INPUT] 1    0    [1    /1   ]  0.492718335759       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24733675536425098, 1.0]], [0, [0.6481916944988387, 1.0]], [0, [117616.81376947438, 1.0]], [0, [2.907370862839866, 1.0]], [0, [1176168.1426167816, 1.0]], [0, [588084.0699798377, 1.0]], [0, [294042.0310583936, 1.0]], [0, [147020.99185960024, 1.0]], [0, [73510.41977338052, 1.0]], [0, [36754.71359864428, 1.0]], [0, [7303.070474478437, 1.0]], [0, [18375.796368267842, 1.0]], [0, [1449.0498450790349, 1.0]], [0, [375.820834240145, 1.0]], [0, [122.881696771919, 1.0]], [0, [46.78859179242762, 1.0]], [0, [18.564893108390372, 1.0]], [0, [7.119376796997452, 1.0]], [1, [8.604237513968432, 1.0]], [1, [0.49271833575909535, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24733676]
bas 1, expnt(s) = [0.64819169]
bas 2, expnt(s) = [117616.81376947]
bas 3, expnt(s) = [2.90737086]
bas 4, expnt(s) = [1176168.14261678]
bas 5, expnt(s) = [588084.06997984]
bas 6, expnt(s) = [294042.03105839]
bas 7, expnt(s) = [147020.9918596]
bas 8, expnt(s) = [73510.41977338]
bas 9, expnt(s) = [36754.71359864]
bas 10, expnt(s) = [7303.07047448]
bas 11, expnt(s) = [18375.79636827]
bas 12, expnt(s) = [1449.04984508]
bas 13, expnt(s) = [375.82083424]
bas 14, expnt(s) = [122.88169677]
bas 15, expnt(s) = [46.78859179]
bas 16, expnt(s) = [18.56489311]
bas 17, expnt(s) = [7.1193768]
bas 18, expnt(s) = [8.60423751]
bas 19, expnt(s) = [0.49271834]
CPU time:      1014.62
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47336755e-01 8.86097515e-01 6.48191694e-01 1.82512503e+00
 1.17616814e+05 1.60460109e+04 2.90737086e+00 5.62523085e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547136e+04 6.70655988e+03
 7.30307047e+03 1.99592466e+03 1.83757964e+04 3.98749041e+03
 1.44904985e+03 5.93372641e+02 3.75820834e+02 2.15650596e+02
 1.22881697e+02 9.32460457e+01 4.67885918e+01 4.51980819e+01
 1.85648931e+01 2.25961456e+01 7.11937680e+00 1.10115006e+01
 8.60423751e+00 4.29907360e+01 4.92718336e-01 1.20429476e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33596859307002
cond(S) = 909296.1122600668
E1 = -689.5976136137654  E_coul = 184.96765847422822
init E= -504.629955139537
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672262239693782  LUMO = 0.679314438972838
  mo_energy =
[-1.21708019e+02 -1.33863107e+01 -7.62388798e+00 -7.62388798e+00
 -7.62388798e+00 -1.65738045e+00 -6.72262240e-01 -6.72262240e-01
 -6.72262240e-01  6.79314439e-01  9.19469106e+00  5.01376569e+01
  1.99014459e+02  7.28769899e+02  2.87565864e+03  1.23425124e+04
  4.09549950e+04  1.04993700e+05  2.30173979e+05  4.55986685e+05
  8.44937266e+05  1.52811292e+06  2.85037834e+06  5.80826310e+06]
E1 = -707.7367063474375  E_coul = 199.76929342561016
cycle= 1 E= -507.967412921827  delta_E= -3.34  |g|= 0.451  |ddm|= 0.503
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.702827
diis-c [-0.49396566  1.        ]
  HOMO = -0.217825034993513  LUMO = 1.06525502360101
  mo_energy =
[-1.20199447e+02 -1.23054641e+01 -6.59508728e+00 -6.59508728e+00
 -6.59508728e+00 -1.16330713e+00 -2.17825035e-01 -2.17825035e-01
 -2.17825035e-01  1.06525502e+00  1.00223762e+01  5.13397708e+01
  2.00443237e+02  7.30261131e+02  2.87709050e+03  1.23438352e+04
  4.09562509e+04  1.04994919e+05  2.30175174e+05  4.55987862e+05
  8.44938431e+05  1.52811407e+06  2.85037949e+06  5.80826423e+06]
E1 = -706.7940508735369  E_coul = 198.8090730023366
cycle= 2 E= -507.9849778712  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.432
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297726
diis-c [-8.86283838e-04  4.98899763e-04  9.99501100e-01]
  HOMO = -0.239718973142824  LUMO = 1.05961925273199
  mo_energy =
[-1.20312672e+02 -1.23720560e+01 -6.66884848e+00 -6.66884848e+00
 -6.66884848e+00 -1.17739471e+00 -2.39718973e-01 -2.39718973e-01
 -2.39718973e-01  1.05961925e+00  9.97914418e+00  5.12639675e+01
  2.00343757e+02  7.30143811e+02  2.87695752e+03  1.23436919e+04
  4.09561038e+04  1.04994771e+05  2.30175024e+05  4.55987713e+05
  8.44938281e+05  1.52811392e+06  2.85037934e+06  5.80826408e+06]
E1 = -706.6876447280417  E_coul = 198.7024107256459
cycle= 3 E= -507.985234002396  delta_E= -0.000256  |g|= 0.00438  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324059
diis-c [-2.23448122e-06 -6.37893120e-06 -1.07041279e-01  1.10704766e+00]
  HOMO = -0.242865543604814  LUMO = 1.05857539025895
  mo_energy =
[-1.20324609e+02 -1.23806852e+01 -6.67797890e+00 -6.67797890e+00
 -6.67797890e+00 -1.17930007e+00 -2.42865544e-01 -2.42865544e-01
 -2.42865544e-01  1.05857539e+00  9.97304916e+00  5.12547423e+01
  2.00332756e+02  7.30131706e+02  2.87694459e+03  1.23436785e+04
  4.09560902e+04  1.04994757e+05  2.30175010e+05  4.55987699e+05
  8.44938267e+05  1.52811391e+06  2.85037932e+06  5.80826407e+06]
E1 = -706.6725017457541  E_coul = 198.68726293112655
cycle= 4 E= -507.985238814628  delta_E= -4.81e-06  |g|= 0.000204  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000142959
diis-c [-1.41040653e-10 -7.51228437e-06  7.12352619e-03 -9.89667371e-02
  1.09185072e+00]
  HOMO = -0.243004502679384  LUMO = 1.05852219512225
  mo_energy =
[-1.20324957e+02 -1.23810202e+01 -6.67831129e+00 -6.67831129e+00
 -6.67831129e+00 -1.17938292e+00 -2.43004503e-01 -2.43004503e-01
 -2.43004503e-01  1.05852220e+00  9.97278886e+00  5.12544139e+01
  2.00332413e+02  7.30131357e+02  2.87694424e+03  1.23436781e+04
  4.09560899e+04  1.04994757e+05  2.30175010e+05  4.55987698e+05
  8.44938266e+05  1.52811391e+06  2.85037932e+06  5.80826407e+06]
E1 = -706.6718409562521  E_coul = 198.6866021316316
cycle= 5 E= -507.985238824621  delta_E= -9.99e-09  |g|= 1.25e-06  |ddm|= 0.000467
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.87551e-07
diis-c [-7.70221606e-14  2.25693699e-07 -1.59467850e-04  2.01141618e-03
 -2.37911308e-02  1.02193896e+00]
  HOMO = -0.243005235654786  LUMO = 1.05852207354504
  mo_energy =
[-1.20324960e+02 -1.23810219e+01 -6.67831310e+00 -6.67831310e+00
 -6.67831310e+00 -1.17938350e+00 -2.43005236e-01 -2.43005236e-01
 -2.43005236e-01  1.05852207e+00  9.97278752e+00  5.12544121e+01
  2.00332411e+02  7.30131355e+02  2.87694423e+03  1.23436781e+04
  4.09560899e+04  1.04994757e+05  2.30175010e+05  4.55987698e+05
  8.44938266e+05  1.52811391e+06  2.85037932e+06  5.80826407e+06]
E1 = -706.6718371849181  E_coul = 198.6865983602975
cycle= 6 E= -507.985238824621  delta_E= -1.14e-13  |g|= 3.97e-08  |ddm|= 2.78e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6718371849181  E_coul = 198.6865983602975
  HOMO = -0.243005255632612  LUMO = 1.05852206099968
  mo_energy =
[-1.20324960e+02 -1.23810219e+01 -6.67831314e+00 -6.67831314e+00
 -6.67831314e+00 -1.17938351e+00 -2.43005256e-01 -2.43005256e-01
 -2.43005256e-01  1.05852206e+00  9.97278748e+00  5.12544121e+01
  2.00332411e+02  7.30131355e+02  2.87694423e+03  1.23436781e+04
  4.09560899e+04  1.04994757e+05  2.30175010e+05  4.55987698e+05
  8.44938266e+05  1.52811391e+06  2.85037932e+06  5.80826407e+06]
E1 = -706.6718370926869  E_coul = 198.68659826806635
Extra cycle  E= -507.985238824621  delta_E= 5.68e-14  |g|= 4.81e-09  |ddm|= 7.58e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909296.1122600668
E1 = -706.6718370926869  E_coul = 198.68659826806635
init E= -507.985238824621
    CPU time for initialize scf      3.49 sec, wall time      0.22 sec
  HOMO = -0.243005258431996  LUMO = 1.05852205986997
  mo_energy =
[-1.20324960e+02 -1.23810219e+01 -6.67831315e+00 -6.67831315e+00
 -6.67831315e+00 -1.17938351e+00 -2.43005258e-01 -2.43005258e-01
 -2.43005258e-01  1.05852206e+00  9.97278748e+00  5.12544121e+01
  2.00332410e+02  7.30131355e+02  2.87694423e+03  1.23436781e+04
  4.09560899e+04  1.04994757e+05  2.30175010e+05  4.55987698e+05
  8.44938266e+05  1.52811391e+06  2.85037932e+06  5.80826407e+06]
E1 = -706.6718370789366  E_coul = 198.68659825431558
cycle= 1 E= -507.985238824621  delta_E= -4.55e-13  |g|= 1.33e-09  |ddm|= 9.84e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6718370789366  E_coul = 198.68659825431558
  HOMO = -0.243005258831569  LUMO = 1.05852206099026
  mo_energy =
[-1.20324960e+02 -1.23810220e+01 -6.67831315e+00 -6.67831315e+00
 -6.67831315e+00 -1.17938351e+00 -2.43005259e-01 -2.43005259e-01
 -2.43005259e-01  1.05852206e+00  9.97278747e+00  5.12544121e+01
  2.00332410e+02  7.30131355e+02  2.87694423e+03  1.23436781e+04
  4.09560899e+04  1.04994757e+05  2.30175010e+05  4.55987698e+05
  8.44938266e+05  1.52811391e+06  2.85037932e+06  5.80826407e+06]
E1 = -706.671837076064  E_coul = 198.68659825144277
Extra cycle  E= -507.985238824621  delta_E= -1.71e-13  |g|= 1.2e-09  |ddm|= 1.99e-09
    CPU time for scf_cycle      3.94 sec, wall time      0.39 sec
exp = [2.47336755e-01 6.48191694e-01 1.17616814e+05 2.90737086e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547136e+04 7.30307047e+03 1.83757964e+04
 1.44904985e+03 3.75820834e+02 1.22881697e+02 4.67885918e+01
 1.85648931e+01 7.11937680e+00 8.60423751e+00 4.92718336e-01]
grad_E = [ 1.08277653e-05 -7.77123568e-05  3.70054719e-09  1.14507827e-04
  1.29965749e-11  9.71550341e-11  5.76034575e-10  2.25420151e-09
  9.34760889e-09  5.08303600e-08  3.14079904e-06  1.03967592e-07
  3.01276439e-05 -2.39833542e-04 -8.30120192e-06  5.34054783e-05
 -7.42055400e-05 -1.76340977e-06  6.77061818e-05 -2.97334737e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:16:03 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247315780884       1
[INPUT] 0    0    [1    /1   ]  0.648149959497       1
[INPUT] 0    0    [1    /1   ]  117616.81377         1
[INPUT] 0    0    [1    /1   ]  2.90569826733        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031058        1
[INPUT] 0    0    [1    /1   ]  147020.99186         1
[INPUT] 0    0    [1    /1   ]  73510.4197745        1
[INPUT] 0    0    [1    /1   ]  36754.7136047        1
[INPUT] 0    0    [1    /1   ]  7303.07085974        1
[INPUT] 0    0    [1    /1   ]  18375.7963817        1
[INPUT] 0    0    [1    /1   ]  1449.04935516        1
[INPUT] 0    0    [1    /1   ]  375.829250922        1
[INPUT] 0    0    [1    /1   ]  122.836165139        1
[INPUT] 0    0    [1    /1   ]  46.7372430809        1
[INPUT] 0    0    [1    /1   ]  18.5133398606        1
[INPUT] 0    0    [1    /1   ]  7.11100052198        1
[INPUT] 1    0    [1    /1   ]  8.60441068905        1
[INPUT] 1    0    [1    /1   ]  0.492722129856       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2473157808842273, 1.0]], [0, [0.6481499594974169, 1.0]], [0, [117616.8137699228, 1.0]], [0, [2.905698267328869, 1.0]], [0, [1176168.1426167837, 1.0]], [0, [588084.06997985, 1.0]], [0, [294042.0310584633, 1.0]], [0, [147020.99185987405, 1.0]], [0, [73510.41977451896, 1.0]], [0, [36754.71360473841, 1.0]], [0, [7303.0708597422545, 1.0]], [0, [18375.796381662785, 1.0]], [0, [1449.0493551616883, 1.0]], [0, [375.82925092187963, 1.0]], [0, [122.83616513867234, 1.0]], [0, [46.73724308086762, 1.0]], [0, [18.513339860569655, 1.0]], [0, [7.111000521977007, 1.0]], [1, [8.604410689051798, 1.0]], [1, [0.4927221298564858, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24731578]
bas 1, expnt(s) = [0.64814996]
bas 2, expnt(s) = [117616.81376992]
bas 3, expnt(s) = [2.90569827]
bas 4, expnt(s) = [1176168.14261678]
bas 5, expnt(s) = [588084.06997985]
bas 6, expnt(s) = [294042.03105846]
bas 7, expnt(s) = [147020.99185987]
bas 8, expnt(s) = [73510.41977452]
bas 9, expnt(s) = [36754.71360474]
bas 10, expnt(s) = [7303.07085974]
bas 11, expnt(s) = [18375.79638166]
bas 12, expnt(s) = [1449.04935516]
bas 13, expnt(s) = [375.82925092]
bas 14, expnt(s) = [122.83616514]
bas 15, expnt(s) = [46.73724308]
bas 16, expnt(s) = [18.51333986]
bas 17, expnt(s) = [7.11100052]
bas 18, expnt(s) = [8.60441069]
bas 19, expnt(s) = [0.49272213]
CPU time:      1026.65
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47315781e-01 8.86041158e-01 6.48149959e-01 1.82503689e+00
 1.17616814e+05 1.60460109e+04 2.90569827e+00 5.62280355e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547136e+04 6.70655988e+03
 7.30307086e+03 1.99592473e+03 1.83757964e+04 3.98749041e+03
 1.44904936e+03 5.93372490e+02 3.75829251e+02 2.15654219e+02
 1.22836165e+02 9.32201315e+01 4.67372431e+01 4.51608744e+01
 1.85133399e+01 2.25490684e+01 7.11100052e+00 1.10017826e+01
 8.60441069e+00 4.29918176e+01 4.92722130e-01 1.20430635e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335963281739264
cond(S) = 909289.7260945743
E1 = -689.5984675148941  E_coul = 184.96854931129494
init E= -504.629918203599
    CPU time for initialize scf      0.42 sec, wall time      0.06 sec
  HOMO = -0.672259742740865  LUMO = 0.679153820171868
  mo_energy =
[-1.21707845e+02 -1.33862413e+01 -7.62382611e+00 -7.62382611e+00
 -7.62382611e+00 -1.65737484e+00 -6.72259743e-01 -6.72259743e-01
 -6.72259743e-01  6.79153820e-01  9.18246525e+00  5.00257349e+01
  1.98678281e+02  7.28243361e+02  2.87510573e+03  1.23420143e+04
  4.09545321e+04  1.04993256e+05  2.30173547e+05  4.55986262e+05
  8.44936851e+05  1.52811251e+06  2.85037794e+06  5.80826271e+06]
E1 = -707.7378047493854  E_coul = 199.77039267050532
cycle= 1 E= -507.96741207888  delta_E= -3.34  |g|= 0.451  |ddm|= 0.503
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.702744
diis-c [-0.49384869  1.        ]
  HOMO = -0.217816187722179  LUMO = 1.06504544804897
  mo_energy =
[-1.20199252e+02 -1.23053806e+01 -6.59500900e+00 -6.59500900e+00
 -6.59500900e+00 -1.16329749e+00 -2.17816188e-01 -2.17816188e-01
 -2.17816188e-01  1.06504545e+00  1.00096701e+01  5.12272624e+01
  2.00106919e+02  7.29734609e+02  2.87653761e+03  1.23433371e+04
  4.09557880e+04  1.04994475e+05  2.30174742e+05  4.55987440e+05
  8.44938015e+05  1.52811367e+06  2.85037909e+06  5.80826384e+06]
E1 = -706.7950901604005  E_coul = 198.8101117146604
cycle= 2 E= -507.98497844574  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.432
    CPU time for cycle= 2      0.10 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297774
diis-c [-8.86582469e-04  4.74099462e-04  9.99525901e-01]
  HOMO = -0.239711802375633  LUMO = 1.05941224109018
  mo_energy =
[-1.20312487e+02 -1.23719787e+01 -6.66877711e+00 -6.66877711e+00
 -6.66877711e+00 -1.17738598e+00 -2.39711802e-01 -2.39711802e-01
 -2.39711802e-01  1.05941224e+00  9.96646840e+00  5.11515015e+01
  2.00007450e+02  7.29617281e+02  2.87640462e+03  1.23431938e+04
  4.09556410e+04  1.04994327e+05  2.30174593e+05  4.55987290e+05
  8.44937865e+05  1.52811351e+06  2.85037894e+06  5.80826369e+06]
E1 = -706.6886766175278  E_coul = 198.70344202619552
cycle= 3 E= -507.985234591332  delta_E= -0.000256  |g|= 0.00438  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324065
diis-c [-2.23605542e-06 -5.49665285e-06 -1.07014096e-01  1.10701959e+00]
  HOMO = -0.242857967757862  LUMO = 1.05836889351956
  mo_energy =
[-1.20324421e+02 -1.23806066e+01 -6.67790603e+00 -6.67790603e+00
 -6.67790603e+00 -1.17929106e+00 -2.42857968e-01 -2.42857968e-01
 -2.42857968e-01  1.05836889e+00  9.96037812e+00  5.11422819e+01
  1.99996453e+02  7.29605178e+02  2.87639169e+03  1.23431804e+04
  4.09556274e+04  1.04994313e+05  2.30174579e+05  4.55987276e+05
  8.44937851e+05  1.52811350e+06  2.85037892e+06  5.80826368e+06]
E1 = -706.6735356980345  E_coul = 198.68829629539763
cycle= 4 E= -507.985239402637  delta_E= -4.81e-06  |g|= 0.000204  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000143015
diis-c [-1.41281490e-10 -7.50620208e-06  7.11997819e-03 -9.89629010e-02
  1.09185043e+00]
  HOMO = -0.242996968752097  LUMO = 1.05831570294238
  mo_energy =
[-1.20324769e+02 -1.23809416e+01 -6.67823850e+00 -6.67823850e+00
 -6.67823850e+00 -1.17937393e+00 -2.42996969e-01 -2.42996969e-01
 -2.42996969e-01  1.05831570e+00  9.96011788e+00  5.11419536e+01
  1.99996109e+02  7.29604830e+02  2.87639134e+03  1.23431800e+04
  4.09556270e+04  1.04994313e+05  2.30174579e+05  4.55987276e+05
  8.44937851e+05  1.52811350e+06  2.85037892e+06  5.80826368e+06]
E1 = -706.6728747118399  E_coul = 198.68763529920287
cycle= 5 E= -507.985239412637  delta_E= -1e-08  |g|= 1.25e-06  |ddm|= 0.000467
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.90291e-07
diis-c [-7.73721965e-14  2.31357331e-07 -1.61317484e-04  2.03723640e-03
 -2.40757587e-02  1.02219961e+00]
  HOMO = -0.242997704722352  LUMO = 1.05831557655751
  mo_energy =
[-1.20324772e+02 -1.23809434e+01 -6.67824031e+00 -6.67824031e+00
 -6.67824031e+00 -1.17937452e+00 -2.42997705e-01 -2.42997705e-01
 -2.42997705e-01  1.05831558e+00  9.96011653e+00  5.11419517e+01
  1.99996107e+02  7.29604827e+02  2.87639133e+03  1.23431800e+04
  4.09556270e+04  1.04994313e+05  2.30174579e+05  4.55987276e+05
  8.44937851e+05  1.52811350e+06  2.85037892e+06  5.80826368e+06]
E1 = -706.6728709279753  E_coul = 198.687631515338
cycle= 6 E= -507.985239412637  delta_E= -2.27e-13  |g|= 4.01e-08  |ddm|= 2.8e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6728709279753  E_coul = 198.687631515338
  HOMO = -0.242997724772857  LUMO = 1.05831556631414
  mo_energy =
[-1.20324772e+02 -1.23809434e+01 -6.67824036e+00 -6.67824036e+00
 -6.67824036e+00 -1.17937452e+00 -2.42997725e-01 -2.42997725e-01
 -2.42997725e-01  1.05831557e+00  9.96011649e+00  5.11419517e+01
  1.99996107e+02  7.29604827e+02  2.87639133e+03  1.23431800e+04
  4.09556270e+04  1.04994313e+05  2.30174579e+05  4.55987276e+05
  8.44937851e+05  1.52811350e+06  2.85037892e+06  5.80826368e+06]
E1 = -706.6728708344702  E_coul = 198.68763142183272
Extra cycle  E= -507.985239412637  delta_E= -2.27e-13  |g|= 4.83e-09  |ddm|= 7.69e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.47315781e-01 6.48149959e-01 1.17616814e+05 2.90569827e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547136e+04 7.30307086e+03 1.83757964e+04
 1.44904936e+03 3.75829251e+02 1.22836165e+02 4.67372431e+01
 1.85133399e+01 7.11100052e+00 8.60441069e+00 4.92722130e-01]
E = -507.9852394126375
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:16:04 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247315780884       1
[INPUT] 0    0    [1    /1   ]  0.648149959497       1
[INPUT] 0    0    [1    /1   ]  117616.81377         1
[INPUT] 0    0    [1    /1   ]  2.90569826733        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031058        1
[INPUT] 0    0    [1    /1   ]  147020.99186         1
[INPUT] 0    0    [1    /1   ]  73510.4197745        1
[INPUT] 0    0    [1    /1   ]  36754.7136047        1
[INPUT] 0    0    [1    /1   ]  7303.07085974        1
[INPUT] 0    0    [1    /1   ]  18375.7963817        1
[INPUT] 0    0    [1    /1   ]  1449.04935516        1
[INPUT] 0    0    [1    /1   ]  375.829250922        1
[INPUT] 0    0    [1    /1   ]  122.836165139        1
[INPUT] 0    0    [1    /1   ]  46.7372430809        1
[INPUT] 0    0    [1    /1   ]  18.5133398606        1
[INPUT] 0    0    [1    /1   ]  7.11100052198        1
[INPUT] 1    0    [1    /1   ]  8.60441068905        1
[INPUT] 1    0    [1    /1   ]  0.492722129856       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2473157808842273, 1.0]], [0, [0.6481499594974169, 1.0]], [0, [117616.8137699228, 1.0]], [0, [2.905698267328869, 1.0]], [0, [1176168.1426167837, 1.0]], [0, [588084.06997985, 1.0]], [0, [294042.0310584633, 1.0]], [0, [147020.99185987405, 1.0]], [0, [73510.41977451896, 1.0]], [0, [36754.71360473841, 1.0]], [0, [7303.0708597422545, 1.0]], [0, [18375.796381662785, 1.0]], [0, [1449.0493551616883, 1.0]], [0, [375.82925092187963, 1.0]], [0, [122.83616513867234, 1.0]], [0, [46.73724308086762, 1.0]], [0, [18.513339860569655, 1.0]], [0, [7.111000521977007, 1.0]], [1, [8.604410689051798, 1.0]], [1, [0.4927221298564858, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24731578]
bas 1, expnt(s) = [0.64814996]
bas 2, expnt(s) = [117616.81376992]
bas 3, expnt(s) = [2.90569827]
bas 4, expnt(s) = [1176168.14261678]
bas 5, expnt(s) = [588084.06997985]
bas 6, expnt(s) = [294042.03105846]
bas 7, expnt(s) = [147020.99185987]
bas 8, expnt(s) = [73510.41977452]
bas 9, expnt(s) = [36754.71360474]
bas 10, expnt(s) = [7303.07085974]
bas 11, expnt(s) = [18375.79638166]
bas 12, expnt(s) = [1449.04935516]
bas 13, expnt(s) = [375.82925092]
bas 14, expnt(s) = [122.83616514]
bas 15, expnt(s) = [46.73724308]
bas 16, expnt(s) = [18.51333986]
bas 17, expnt(s) = [7.11100052]
bas 18, expnt(s) = [8.60441069]
bas 19, expnt(s) = [0.49272213]
CPU time:      1028.23
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47315781e-01 8.86041158e-01 6.48149959e-01 1.82503689e+00
 1.17616814e+05 1.60460109e+04 2.90569827e+00 5.62280355e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547136e+04 6.70655988e+03
 7.30307086e+03 1.99592473e+03 1.83757964e+04 3.98749041e+03
 1.44904936e+03 5.93372490e+02 3.75829251e+02 2.15654219e+02
 1.22836165e+02 9.32201315e+01 4.67372431e+01 4.51608744e+01
 1.85133399e+01 2.25490684e+01 7.11100052e+00 1.10017826e+01
 8.60441069e+00 4.29918176e+01 4.92722130e-01 1.20430635e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335963281739264
cond(S) = 909289.7260945743
E1 = -689.5984675148941  E_coul = 184.96854931129494
init E= -504.629918203599
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672259742740865  LUMO = 0.679153820171868
  mo_energy =
[-1.21707845e+02 -1.33862413e+01 -7.62382611e+00 -7.62382611e+00
 -7.62382611e+00 -1.65737484e+00 -6.72259743e-01 -6.72259743e-01
 -6.72259743e-01  6.79153820e-01  9.18246525e+00  5.00257349e+01
  1.98678281e+02  7.28243361e+02  2.87510573e+03  1.23420143e+04
  4.09545321e+04  1.04993256e+05  2.30173547e+05  4.55986262e+05
  8.44936851e+05  1.52811251e+06  2.85037794e+06  5.80826271e+06]
E1 = -707.7378047493854  E_coul = 199.77039267050532
cycle= 1 E= -507.96741207888  delta_E= -3.34  |g|= 0.451  |ddm|= 0.503
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.702744
diis-c [-0.49384869  1.        ]
  HOMO = -0.217816187722179  LUMO = 1.06504544804897
  mo_energy =
[-1.20199252e+02 -1.23053806e+01 -6.59500900e+00 -6.59500900e+00
 -6.59500900e+00 -1.16329749e+00 -2.17816188e-01 -2.17816188e-01
 -2.17816188e-01  1.06504545e+00  1.00096701e+01  5.12272624e+01
  2.00106919e+02  7.29734609e+02  2.87653761e+03  1.23433371e+04
  4.09557880e+04  1.04994475e+05  2.30174742e+05  4.55987440e+05
  8.44938015e+05  1.52811367e+06  2.85037909e+06  5.80826384e+06]
E1 = -706.7950901604005  E_coul = 198.8101117146604
cycle= 2 E= -507.98497844574  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.432
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297774
diis-c [-8.86582469e-04  4.74099462e-04  9.99525901e-01]
  HOMO = -0.239711802375633  LUMO = 1.05941224109018
  mo_energy =
[-1.20312487e+02 -1.23719787e+01 -6.66877711e+00 -6.66877711e+00
 -6.66877711e+00 -1.17738598e+00 -2.39711802e-01 -2.39711802e-01
 -2.39711802e-01  1.05941224e+00  9.96646840e+00  5.11515015e+01
  2.00007450e+02  7.29617281e+02  2.87640462e+03  1.23431938e+04
  4.09556410e+04  1.04994327e+05  2.30174593e+05  4.55987290e+05
  8.44937865e+05  1.52811351e+06  2.85037894e+06  5.80826369e+06]
E1 = -706.6886766175278  E_coul = 198.70344202619552
cycle= 3 E= -507.985234591332  delta_E= -0.000256  |g|= 0.00438  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324065
diis-c [-2.23605542e-06 -5.49665285e-06 -1.07014096e-01  1.10701959e+00]
  HOMO = -0.242857967757862  LUMO = 1.05836889351956
  mo_energy =
[-1.20324421e+02 -1.23806066e+01 -6.67790603e+00 -6.67790603e+00
 -6.67790603e+00 -1.17929106e+00 -2.42857968e-01 -2.42857968e-01
 -2.42857968e-01  1.05836889e+00  9.96037812e+00  5.11422819e+01
  1.99996453e+02  7.29605178e+02  2.87639169e+03  1.23431804e+04
  4.09556274e+04  1.04994313e+05  2.30174579e+05  4.55987276e+05
  8.44937851e+05  1.52811350e+06  2.85037892e+06  5.80826368e+06]
E1 = -706.6735356980345  E_coul = 198.68829629539763
cycle= 4 E= -507.985239402637  delta_E= -4.81e-06  |g|= 0.000204  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000143015
diis-c [-1.41281490e-10 -7.50620208e-06  7.11997819e-03 -9.89629010e-02
  1.09185043e+00]
  HOMO = -0.242996968752097  LUMO = 1.05831570294238
  mo_energy =
[-1.20324769e+02 -1.23809416e+01 -6.67823850e+00 -6.67823850e+00
 -6.67823850e+00 -1.17937393e+00 -2.42996969e-01 -2.42996969e-01
 -2.42996969e-01  1.05831570e+00  9.96011788e+00  5.11419536e+01
  1.99996109e+02  7.29604830e+02  2.87639134e+03  1.23431800e+04
  4.09556270e+04  1.04994313e+05  2.30174579e+05  4.55987276e+05
  8.44937851e+05  1.52811350e+06  2.85037892e+06  5.80826368e+06]
E1 = -706.6728747118399  E_coul = 198.68763529920287
cycle= 5 E= -507.985239412637  delta_E= -1e-08  |g|= 1.25e-06  |ddm|= 0.000467
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.90291e-07
diis-c [-7.73721965e-14  2.31357331e-07 -1.61317484e-04  2.03723640e-03
 -2.40757587e-02  1.02219961e+00]
  HOMO = -0.242997704722352  LUMO = 1.05831557655751
  mo_energy =
[-1.20324772e+02 -1.23809434e+01 -6.67824031e+00 -6.67824031e+00
 -6.67824031e+00 -1.17937452e+00 -2.42997705e-01 -2.42997705e-01
 -2.42997705e-01  1.05831558e+00  9.96011653e+00  5.11419517e+01
  1.99996107e+02  7.29604827e+02  2.87639133e+03  1.23431800e+04
  4.09556270e+04  1.04994313e+05  2.30174579e+05  4.55987276e+05
  8.44937851e+05  1.52811350e+06  2.85037892e+06  5.80826368e+06]
E1 = -706.6728709279753  E_coul = 198.687631515338
cycle= 6 E= -507.985239412637  delta_E= -2.27e-13  |g|= 4.01e-08  |ddm|= 2.8e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6728709279753  E_coul = 198.687631515338
  HOMO = -0.242997724772857  LUMO = 1.05831556631414
  mo_energy =
[-1.20324772e+02 -1.23809434e+01 -6.67824036e+00 -6.67824036e+00
 -6.67824036e+00 -1.17937452e+00 -2.42997725e-01 -2.42997725e-01
 -2.42997725e-01  1.05831557e+00  9.96011649e+00  5.11419517e+01
  1.99996107e+02  7.29604827e+02  2.87639133e+03  1.23431800e+04
  4.09556270e+04  1.04994313e+05  2.30174579e+05  4.55987276e+05
  8.44937851e+05  1.52811350e+06  2.85037892e+06  5.80826368e+06]
E1 = -706.6728708344702  E_coul = 198.68763142183272
Extra cycle  E= -507.985239412637  delta_E= -2.27e-13  |g|= 4.83e-09  |ddm|= 7.69e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909289.7260945743
E1 = -706.6728708344702  E_coul = 198.68763142183272
init E= -507.985239412637
    CPU time for initialize scf      3.49 sec, wall time      0.22 sec
  HOMO = -0.242997727621726  LUMO = 1.05831556414344
  mo_energy =
[-1.20324772e+02 -1.23809434e+01 -6.67824036e+00 -6.67824036e+00
 -6.67824036e+00 -1.17937453e+00 -2.42997728e-01 -2.42997728e-01
 -2.42997728e-01  1.05831556e+00  9.96011648e+00  5.11419517e+01
  1.99996107e+02  7.29604827e+02  2.87639133e+03  1.23431800e+04
  4.09556270e+04  1.04994313e+05  2.30174579e+05  4.55987276e+05
  8.44937851e+05  1.52811350e+06  2.85037892e+06  5.80826368e+06]
E1 = -706.6728708218657  E_coul = 198.68763140922795
cycle= 1 E= -507.985239412638  delta_E= -2.27e-13  |g|= 1.66e-09  |ddm|= 9.06e-09
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.6728708218657  E_coul = 198.68763140922795
  HOMO = -0.242997727987923  LUMO = 1.05831556535032
  mo_energy =
[-1.20324772e+02 -1.23809434e+01 -6.67824036e+00 -6.67824036e+00
 -6.67824036e+00 -1.17937453e+00 -2.42997728e-01 -2.42997728e-01
 -2.42997728e-01  1.05831557e+00  9.96011648e+00  5.11419517e+01
  1.99996107e+02  7.29604827e+02  2.87639133e+03  1.23431800e+04
  4.09556270e+04  1.04994313e+05  2.30174579e+05  4.55987276e+05
  8.44937851e+05  1.52811350e+06  2.85037892e+06  5.80826368e+06]
E1 = -706.6728708166057  E_coul = 198.6876314039679
Extra cycle  E= -507.985239412638  delta_E= -1.14e-13  |g|= 2.32e-09  |ddm|= 3.4e-09
    CPU time for scf_cycle      3.94 sec, wall time      0.39 sec
exp = [2.47315781e-01 6.48149959e-01 1.17616814e+05 2.90569827e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547136e+04 7.30307086e+03 1.83757964e+04
 1.44904936e+03 3.75829251e+02 1.22836165e+02 4.67372431e+01
 1.85133399e+01 7.11100052e+00 8.60441069e+00 4.92722130e-01]
grad_E = [-2.19031693e-06 -7.78727974e-05  3.70426755e-09  1.79697374e-04
  1.30416317e-11  9.72754069e-11  5.76612343e-10  2.25649904e-09
  9.35728037e-09  5.08783568e-08  3.14426178e-06  1.04109909e-07
  2.99460616e-05 -2.38386283e-04 -1.08762078e-05  5.57300423e-05
 -7.61163697e-05 -3.34474587e-05  2.10175367e-04 -6.12708719e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:16:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247283063433       1
[INPUT] 0    0    [1    /1   ]  0.648084451672       1
[INPUT] 0    0    [1    /1   ]  117616.813771        1
[INPUT] 0    0    [1    /1   ]  2.90315549287        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031059        1
[INPUT] 0    0    [1    /1   ]  147020.99186         1
[INPUT] 0    0    [1    /1   ]  73510.419776         1
[INPUT] 0    0    [1    /1   ]  36754.7136126        1
[INPUT] 0    0    [1    /1   ]  7303.07135865        1
[INPUT] 0    0    [1    /1   ]  18375.7963991        1
[INPUT] 0    0    [1    /1   ]  1449.04799792        1
[INPUT] 0    0    [1    /1   ]  375.846610952        1
[INPUT] 0    0    [1    /1   ]  122.770084557        1
[INPUT] 0    0    [1    /1   ]  46.6610832449        1
[INPUT] 0    0    [1    /1   ]  18.4360564785        1
[INPUT] 0    0    [1    /1   ]  7.09819702739        1
[INPUT] 1    0    [1    /1   ]  8.60466964816        1
[INPUT] 1    0    [1    /1   ]  0.492727799575       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24728306343341536, 1.0]], [0, [0.6480844516716597, 1.0]], [0, [117616.81377050254, 1.0]], [0, [2.9031554928653884, 1.0]], [0, [1176168.1426167868, 1.0]], [0, [588084.0699798659, 1.0]], [0, [294042.0310585535, 1.0]], [0, [147020.99186022815, 1.0]], [0, [73510.41977599188, 1.0]], [0, [36754.71361260602, 1.0]], [0, [7303.071358649184, 1.0]], [0, [18375.79639912222, 1.0]], [0, [1449.0479979173374, 1.0]], [0, [375.8466109520867, 1.0]], [0, [122.77008455739944, 1.0]], [0, [46.661083244909456, 1.0]], [0, [18.436056478469887, 1.0]], [0, [7.098197027394738, 1.0]], [1, [8.604669648160106, 1.0]], [1, [0.49272779957479135, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24728306]
bas 1, expnt(s) = [0.64808445]
bas 2, expnt(s) = [117616.8137705]
bas 3, expnt(s) = [2.90315549]
bas 4, expnt(s) = [1176168.14261679]
bas 5, expnt(s) = [588084.06997987]
bas 6, expnt(s) = [294042.03105855]
bas 7, expnt(s) = [147020.99186023]
bas 8, expnt(s) = [73510.41977599]
bas 9, expnt(s) = [36754.71361261]
bas 10, expnt(s) = [7303.07135865]
bas 11, expnt(s) = [18375.79639912]
bas 12, expnt(s) = [1449.04799792]
bas 13, expnt(s) = [375.84661095]
bas 14, expnt(s) = [122.77008456]
bas 15, expnt(s) = [46.66108324]
bas 16, expnt(s) = [18.43605648]
bas 17, expnt(s) = [7.09819703]
bas 18, expnt(s) = [8.60466965]
bas 19, expnt(s) = [0.4927278]
CPU time:      1040.22
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47283063e-01 8.85953246e-01 6.48084452e-01 1.82489855e+00
 1.17616814e+05 1.60460109e+04 2.90315549e+00 5.61911276e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547136e+04 6.70655988e+03
 7.30307136e+03 1.99592484e+03 1.83757964e+04 3.98749041e+03
 1.44904800e+03 5.93372073e+02 3.75846611e+02 2.15661689e+02
 1.22770085e+02 9.31825177e+01 4.66610832e+01 4.51056699e+01
 1.84360565e+01 2.24784337e+01 7.09819703e+00 1.09869225e+01
 8.60466965e+00 4.29934350e+01 4.92727800e-01 1.20432368e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335955351739123
cond(S) = 909280.3748327814
E1 = -689.5997413365287  E_coul = 184.96988147718915
init E= -504.62985985934
    CPU time for initialize scf      0.47 sec, wall time      0.07 sec
  HOMO = -0.672256007852522  LUMO = 0.678905252080421
  mo_energy =
[-1.21707584e+02 -1.33861376e+01 -7.62373359e+00 -7.62373359e+00
 -7.62373359e+00 -1.65736653e+00 -6.72256008e-01 -6.72256008e-01
 -6.72256008e-01  6.78905252e-01  9.16390432e+00  4.98572853e+01
  1.98175658e+02  7.27464533e+02  2.87429938e+03  1.23412921e+04
  4.09538614e+04  1.04992613e+05  2.30172922e+05  4.55985650e+05
  8.44936249e+05  1.52811192e+06  2.85037736e+06  5.80826214e+06]
E1 = -707.7394504574412  E_coul = 199.77203909768363
cycle= 1 E= -507.967411359758  delta_E= -3.34  |g|= 0.451  |ddm|= 0.503
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.702618
diis-c [-0.49367135  1.        ]
  HOMO = -0.217802945740557  LUMO = 1.06472164089934
  mo_energy =
[-1.20198961e+02 -1.23052555e+01 -6.59489171e+00 -6.59489171e+00
 -6.59489171e+00 -1.16328309e+00 -2.17802946e-01 -2.17802946e-01
 -2.17802946e-01  1.06472164e+00  9.99038049e+00  5.10579296e+01
  1.99604088e+02  7.28955807e+02  2.87573128e+03  1.23426149e+04
  4.09551173e+04  1.04993832e+05  2.30174117e+05  4.55986828e+05
  8.44937413e+05  1.52811307e+06  2.85037851e+06  5.80826328e+06]
E1 = -706.7966459045192  E_coul = 198.81166602688734
cycle= 2 E= -507.984979877632  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.432
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297846
diis-c [-8.87028044e-04  4.36861199e-04  9.99563139e-01]
  HOMO = -0.239701112646151  LUMO = 1.05909236176035
  mo_energy =
[-1.20312209e+02 -1.23718631e+01 -6.66867028e+00 -6.66867028e+00
 -6.66867028e+00 -1.17737299e+00 -2.39701113e-01 -2.39701113e-01
 -2.39701113e-01  1.05909236e+00  9.94722483e+00  5.09822325e+01
  1.99504636e+02  7.28838467e+02  2.87559827e+03  1.23424716e+04
  4.09549702e+04  1.04993683e+05  2.30173967e+05  4.55986678e+05
  8.44937263e+05  1.52811292e+06  2.85037835e+06  5.80826313e+06]
E1 = -706.6902210483137  E_coul = 198.7049850027853
cycle= 3 E= -507.985236045528  delta_E= -0.000256  |g|= 0.00438  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324074
diis-c [-2.23842394e-06 -4.19374801e-06 -1.06973538e-01  1.10697773e+00]
  HOMO = -0.242846678943918  LUMO = 1.05804979864017
  mo_energy =
[-1.20324140e+02 -1.23804889e+01 -6.67779697e+00 -6.67779697e+00
 -6.67779697e+00 -1.17927764e+00 -2.42846679e-01 -2.42846679e-01
 -2.42846679e-01  1.05804980e+00  9.94114171e+00  5.09730214e+01
  1.99493643e+02  7.28826367e+02  2.87558535e+03  1.23424582e+04
  4.09549566e+04  1.04993670e+05  2.30173954e+05  4.55986664e+05
  8.44937249e+05  1.52811291e+06  2.85037834e+06  5.80826312e+06]
E1 = -706.6750831687617  E_coul = 198.68984231329208
cycle= 4 E= -507.98524085547  delta_E= -4.81e-06  |g|= 0.000205  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000143099
diis-c [-1.41588178e-10 -7.51296707e-06  7.11521727e-03 -9.89603263e-02
  1.09185262e+00]
  HOMO = -0.242985742961537  LUMO = 1.05799660979817
  mo_energy =
[-1.20324489e+02 -1.23808241e+01 -6.67812955e+00 -6.67812955e+00
 -6.67812955e+00 -1.17936056e+00 -2.42985743e-01 -2.42985743e-01
 -2.42985743e-01  1.05799661e+00  9.94088156e+00  5.09726930e+01
  1.99493300e+02  7.28826019e+02  2.87558500e+03  1.23424579e+04
  4.09549563e+04  1.04993669e+05  2.30173953e+05  4.55986664e+05
  8.44937249e+05  1.52811291e+06  2.85037834e+06  5.80826312e+06]
E1 = -706.6744218942179  E_coul = 198.68918102873474
cycle= 5 E= -507.985240865483  delta_E= -1e-08  |g|= 1.26e-06  |ddm|= 0.000468
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.93985e-07
diis-c [-7.88965609e-14  2.32373751e-07 -1.62329293e-04  2.05208051e-03
 -2.42494884e-02  1.02235950e+00]
  HOMO = -0.242986483280172  LUMO = 1.05799648267718
  mo_energy =
[-1.20324491e+02 -1.23808258e+01 -6.67813137e+00 -6.67813137e+00
 -6.67813137e+00 -1.17936114e+00 -2.42986483e-01 -2.42986483e-01
 -2.42986483e-01  1.05799648e+00  9.94088020e+00  5.09726911e+01
  1.99493298e+02  7.28826016e+02  2.87558499e+03  1.23424579e+04
  4.09549563e+04  1.04993669e+05  2.30173953e+05  4.55986664e+05
  8.44937249e+05  1.52811291e+06  2.85037834e+06  5.80826312e+06]
E1 = -706.6744180882125  E_coul = 198.68917722272923
cycle= 6 E= -507.985240865483  delta_E= -2.27e-13  |g|= 4.04e-08  |ddm|= 2.82e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6744180882125  E_coul = 198.68917722272923
  HOMO = -0.242986503516153  LUMO = 1.05799647120984
  mo_energy =
[-1.20324491e+02 -1.23808259e+01 -6.67813142e+00 -6.67813142e+00
 -6.67813142e+00 -1.17936115e+00 -2.42986504e-01 -2.42986504e-01
 -2.42986504e-01  1.05799647e+00  9.94088017e+00  5.09726911e+01
  1.99493298e+02  7.28826016e+02  2.87558499e+03  1.23424579e+04
  4.09549563e+04  1.04993669e+05  2.30173953e+05  4.55986664e+05
  8.44937249e+05  1.52811291e+06  2.85037834e+06  5.80826312e+06]
E1 = -706.674417992638  E_coul = 198.6891771271543
Extra cycle  E= -507.985240865484  delta_E= -4.55e-13  |g|= 5e-09  |ddm|= 7.83e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.47283063e-01 6.48084452e-01 1.17616814e+05 2.90315549e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547136e+04 7.30307136e+03 1.83757964e+04
 1.44904800e+03 3.75846611e+02 1.22770085e+02 4.66610832e+01
 1.84360565e+01 7.09819703e+00 8.60466965e+00 4.92727800e-01]
E = -507.9852408654838
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:16:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247283063433       1
[INPUT] 0    0    [1    /1   ]  0.648084451672       1
[INPUT] 0    0    [1    /1   ]  117616.813771        1
[INPUT] 0    0    [1    /1   ]  2.90315549287        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031059        1
[INPUT] 0    0    [1    /1   ]  147020.99186         1
[INPUT] 0    0    [1    /1   ]  73510.419776         1
[INPUT] 0    0    [1    /1   ]  36754.7136126        1
[INPUT] 0    0    [1    /1   ]  7303.07135865        1
[INPUT] 0    0    [1    /1   ]  18375.7963991        1
[INPUT] 0    0    [1    /1   ]  1449.04799792        1
[INPUT] 0    0    [1    /1   ]  375.846610952        1
[INPUT] 0    0    [1    /1   ]  122.770084557        1
[INPUT] 0    0    [1    /1   ]  46.6610832449        1
[INPUT] 0    0    [1    /1   ]  18.4360564785        1
[INPUT] 0    0    [1    /1   ]  7.09819702739        1
[INPUT] 1    0    [1    /1   ]  8.60466964816        1
[INPUT] 1    0    [1    /1   ]  0.492727799575       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24728306343341536, 1.0]], [0, [0.6480844516716597, 1.0]], [0, [117616.81377050254, 1.0]], [0, [2.9031554928653884, 1.0]], [0, [1176168.1426167868, 1.0]], [0, [588084.0699798659, 1.0]], [0, [294042.0310585535, 1.0]], [0, [147020.99186022815, 1.0]], [0, [73510.41977599188, 1.0]], [0, [36754.71361260602, 1.0]], [0, [7303.071358649184, 1.0]], [0, [18375.79639912222, 1.0]], [0, [1449.0479979173374, 1.0]], [0, [375.8466109520867, 1.0]], [0, [122.77008455739944, 1.0]], [0, [46.661083244909456, 1.0]], [0, [18.436056478469887, 1.0]], [0, [7.098197027394738, 1.0]], [1, [8.604669648160106, 1.0]], [1, [0.49272779957479135, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24728306]
bas 1, expnt(s) = [0.64808445]
bas 2, expnt(s) = [117616.8137705]
bas 3, expnt(s) = [2.90315549]
bas 4, expnt(s) = [1176168.14261679]
bas 5, expnt(s) = [588084.06997987]
bas 6, expnt(s) = [294042.03105855]
bas 7, expnt(s) = [147020.99186023]
bas 8, expnt(s) = [73510.41977599]
bas 9, expnt(s) = [36754.71361261]
bas 10, expnt(s) = [7303.07135865]
bas 11, expnt(s) = [18375.79639912]
bas 12, expnt(s) = [1449.04799792]
bas 13, expnt(s) = [375.84661095]
bas 14, expnt(s) = [122.77008456]
bas 15, expnt(s) = [46.66108324]
bas 16, expnt(s) = [18.43605648]
bas 17, expnt(s) = [7.09819703]
bas 18, expnt(s) = [8.60466965]
bas 19, expnt(s) = [0.4927278]
CPU time:      1041.80
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47283063e-01 8.85953246e-01 6.48084452e-01 1.82489855e+00
 1.17616814e+05 1.60460109e+04 2.90315549e+00 5.61911276e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547136e+04 6.70655988e+03
 7.30307136e+03 1.99592484e+03 1.83757964e+04 3.98749041e+03
 1.44904800e+03 5.93372073e+02 3.75846611e+02 2.15661689e+02
 1.22770085e+02 9.31825177e+01 4.66610832e+01 4.51056699e+01
 1.84360565e+01 2.24784337e+01 7.09819703e+00 1.09869225e+01
 8.60466965e+00 4.29934350e+01 4.92727800e-01 1.20432368e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335955351739123
cond(S) = 909280.3748327814
E1 = -689.5997413365287  E_coul = 184.96988147718915
init E= -504.62985985934
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672256007852522  LUMO = 0.678905252080421
  mo_energy =
[-1.21707584e+02 -1.33861376e+01 -7.62373359e+00 -7.62373359e+00
 -7.62373359e+00 -1.65736653e+00 -6.72256008e-01 -6.72256008e-01
 -6.72256008e-01  6.78905252e-01  9.16390432e+00  4.98572853e+01
  1.98175658e+02  7.27464533e+02  2.87429938e+03  1.23412921e+04
  4.09538614e+04  1.04992613e+05  2.30172922e+05  4.55985650e+05
  8.44936249e+05  1.52811192e+06  2.85037736e+06  5.80826214e+06]
E1 = -707.7394504574412  E_coul = 199.77203909768363
cycle= 1 E= -507.967411359758  delta_E= -3.34  |g|= 0.451  |ddm|= 0.503
    CPU time for cycle= 1      0.43 sec, wall time      0.03 sec
diis-norm(errvec)=0.702618
diis-c [-0.49367135  1.        ]
  HOMO = -0.217802945740557  LUMO = 1.06472164089934
  mo_energy =
[-1.20198961e+02 -1.23052555e+01 -6.59489171e+00 -6.59489171e+00
 -6.59489171e+00 -1.16328309e+00 -2.17802946e-01 -2.17802946e-01
 -2.17802946e-01  1.06472164e+00  9.99038049e+00  5.10579296e+01
  1.99604088e+02  7.28955807e+02  2.87573128e+03  1.23426149e+04
  4.09551173e+04  1.04993832e+05  2.30174117e+05  4.55986828e+05
  8.44937413e+05  1.52811307e+06  2.85037851e+06  5.80826328e+06]
E1 = -706.7966459045192  E_coul = 198.81166602688734
cycle= 2 E= -507.984979877632  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.432
    CPU time for cycle= 2      0.10 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297846
diis-c [-8.87028044e-04  4.36861199e-04  9.99563139e-01]
  HOMO = -0.239701112646151  LUMO = 1.05909236176035
  mo_energy =
[-1.20312209e+02 -1.23718631e+01 -6.66867028e+00 -6.66867028e+00
 -6.66867028e+00 -1.17737299e+00 -2.39701113e-01 -2.39701113e-01
 -2.39701113e-01  1.05909236e+00  9.94722483e+00  5.09822325e+01
  1.99504636e+02  7.28838467e+02  2.87559827e+03  1.23424716e+04
  4.09549702e+04  1.04993683e+05  2.30173967e+05  4.55986678e+05
  8.44937263e+05  1.52811292e+06  2.85037835e+06  5.80826313e+06]
E1 = -706.6902210483137  E_coul = 198.7049850027853
cycle= 3 E= -507.985236045528  delta_E= -0.000256  |g|= 0.00438  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324074
diis-c [-2.23842394e-06 -4.19374801e-06 -1.06973538e-01  1.10697773e+00]
  HOMO = -0.242846678943918  LUMO = 1.05804979864017
  mo_energy =
[-1.20324140e+02 -1.23804889e+01 -6.67779697e+00 -6.67779697e+00
 -6.67779697e+00 -1.17927764e+00 -2.42846679e-01 -2.42846679e-01
 -2.42846679e-01  1.05804980e+00  9.94114171e+00  5.09730214e+01
  1.99493643e+02  7.28826367e+02  2.87558535e+03  1.23424582e+04
  4.09549566e+04  1.04993670e+05  2.30173954e+05  4.55986664e+05
  8.44937249e+05  1.52811291e+06  2.85037834e+06  5.80826312e+06]
E1 = -706.6750831687617  E_coul = 198.68984231329208
cycle= 4 E= -507.98524085547  delta_E= -4.81e-06  |g|= 0.000205  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000143099
diis-c [-1.41588178e-10 -7.51296707e-06  7.11521727e-03 -9.89603263e-02
  1.09185262e+00]
  HOMO = -0.242985742961537  LUMO = 1.05799660979817
  mo_energy =
[-1.20324489e+02 -1.23808241e+01 -6.67812955e+00 -6.67812955e+00
 -6.67812955e+00 -1.17936056e+00 -2.42985743e-01 -2.42985743e-01
 -2.42985743e-01  1.05799661e+00  9.94088156e+00  5.09726930e+01
  1.99493300e+02  7.28826019e+02  2.87558500e+03  1.23424579e+04
  4.09549563e+04  1.04993669e+05  2.30173953e+05  4.55986664e+05
  8.44937249e+05  1.52811291e+06  2.85037834e+06  5.80826312e+06]
E1 = -706.6744218942179  E_coul = 198.68918102873474
cycle= 5 E= -507.985240865483  delta_E= -1e-08  |g|= 1.26e-06  |ddm|= 0.000468
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.93985e-07
diis-c [-7.88965609e-14  2.32373751e-07 -1.62329293e-04  2.05208051e-03
 -2.42494884e-02  1.02235950e+00]
  HOMO = -0.242986483280172  LUMO = 1.05799648267718
  mo_energy =
[-1.20324491e+02 -1.23808258e+01 -6.67813137e+00 -6.67813137e+00
 -6.67813137e+00 -1.17936114e+00 -2.42986483e-01 -2.42986483e-01
 -2.42986483e-01  1.05799648e+00  9.94088020e+00  5.09726911e+01
  1.99493298e+02  7.28826016e+02  2.87558499e+03  1.23424579e+04
  4.09549563e+04  1.04993669e+05  2.30173953e+05  4.55986664e+05
  8.44937249e+05  1.52811291e+06  2.85037834e+06  5.80826312e+06]
E1 = -706.6744180882125  E_coul = 198.68917722272923
cycle= 6 E= -507.985240865483  delta_E= -2.27e-13  |g|= 4.04e-08  |ddm|= 2.82e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6744180882125  E_coul = 198.68917722272923
  HOMO = -0.242986503516153  LUMO = 1.05799647120984
  mo_energy =
[-1.20324491e+02 -1.23808259e+01 -6.67813142e+00 -6.67813142e+00
 -6.67813142e+00 -1.17936115e+00 -2.42986504e-01 -2.42986504e-01
 -2.42986504e-01  1.05799647e+00  9.94088017e+00  5.09726911e+01
  1.99493298e+02  7.28826016e+02  2.87558499e+03  1.23424579e+04
  4.09549563e+04  1.04993669e+05  2.30173953e+05  4.55986664e+05
  8.44937249e+05  1.52811291e+06  2.85037834e+06  5.80826312e+06]
E1 = -706.674417992638  E_coul = 198.6891771271543
Extra cycle  E= -507.985240865484  delta_E= -4.55e-13  |g|= 5e-09  |ddm|= 7.83e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909280.3748327814
E1 = -706.674417992638  E_coul = 198.6891771271543
init E= -507.985240865484
    CPU time for initialize scf      3.37 sec, wall time      0.21 sec
  HOMO = -0.242986506412154  LUMO = 1.0579964699824
  mo_energy =
[-1.20324491e+02 -1.23808259e+01 -6.67813142e+00 -6.67813142e+00
 -6.67813142e+00 -1.17936115e+00 -2.42986506e-01 -2.42986506e-01
 -2.42986506e-01  1.05799647e+00  9.94088016e+00  5.09726911e+01
  1.99493298e+02  7.28826016e+02  2.87558499e+03  1.23424579e+04
  4.09549563e+04  1.04993669e+05  2.30173953e+05  4.55986664e+05
  8.44937249e+05  1.52811291e+06  2.85037834e+06  5.80826312e+06]
E1 = -706.6744179824941  E_coul = 198.6891771170104
cycle= 1 E= -507.985240865484  delta_E= 5.68e-14  |g|= 1.72e-09  |ddm|= 7.68e-09
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.6744179824941  E_coul = 198.6891771170104
  HOMO = -0.242986506728434  LUMO = 1.05799646978929
  mo_energy =
[-1.20324491e+02 -1.23808259e+01 -6.67813142e+00 -6.67813142e+00
 -6.67813142e+00 -1.17936115e+00 -2.42986507e-01 -2.42986507e-01
 -2.42986507e-01  1.05799647e+00  9.94088016e+00  5.09726911e+01
  1.99493298e+02  7.28826016e+02  2.87558499e+03  1.23424579e+04
  4.09549563e+04  1.04993669e+05  2.30173953e+05  4.55986664e+05
  8.44937249e+05  1.52811291e+06  2.85037834e+06  5.80826312e+06]
E1 = -706.6744179794916  E_coul = 198.6891771140085
Extra cycle  E= -507.985240865483  delta_E= 5.68e-13  |g|= 1.02e-09  |ddm|= 2.01e-09
    CPU time for scf_cycle      3.82 sec, wall time      0.38 sec
exp = [2.47283063e-01 6.48084452e-01 1.17616814e+05 2.90315549e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547136e+04 7.30307136e+03 1.83757964e+04
 1.44904800e+03 3.75846611e+02 1.22770085e+02 4.66610832e+01
 1.84360565e+01 7.09819703e+00 8.60466965e+00 4.92727800e-01]
grad_E = [-2.43442749e-05 -7.75180914e-05  3.71018860e-09  2.79942447e-04
  1.31133244e-11  9.74669917e-11  5.77531845e-10  2.26015567e-09
  9.37267310e-09  5.09547354e-08  3.14976172e-06  1.04336469e-07
  2.96604107e-05 -2.36152388e-04 -1.47744916e-05  5.93078941e-05
 -7.89830108e-05 -8.24125717e-05  4.23293012e-04 -1.08221538e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:16:19 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247229567031       1
[INPUT] 0    0    [1    /1   ]  0.647972488814       1
[INPUT] 0    0    [1    /1   ]  117616.813771        1
[INPUT] 0    0    [1    /1   ]  2.89905251383        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031059        1
[INPUT] 0    0    [1    /1   ]  147020.991861        1
[INPUT] 0    0    [1    /1   ]  73510.4197778        1
[INPUT] 0    0    [1    /1   ]  36754.713622         1
[INPUT] 0    0    [1    /1   ]  7303.07195755        1
[INPUT] 0    0    [1    /1   ]  18375.7964204        1
[INPUT] 0    0    [1    /1   ]  1449.04412162        1
[INPUT] 0    0    [1    /1   ]  375.8875309          1
[INPUT] 0    0    [1    /1   ]  122.668653326        1
[INPUT] 0    0    [1    /1   ]  46.5395624864        1
[INPUT] 0    0    [1    /1   ]  18.3102126245        1
[INPUT] 0    0    [1    /1   ]  7.07729254599        1
[INPUT] 1    0    [1    /1   ]  8.60509046224        1
[INPUT] 1    0    [1    /1   ]  0.492736991747       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24722956703079543, 1.0]], [0, [0.6479724888139702, 1.0]], [0, [117616.81377119561, 1.0]], [0, [2.8990525138287433, 1.0]], [0, [1176168.1426167907, 1.0]], [0, [588084.0699798851, 1.0]], [0, [294042.03105866123, 1.0]], [0, [147020.99186065182, 1.0]], [0, [73510.41977775584, 1.0]], [0, [36754.713621975425, 1.0]], [0, [7303.071957546378, 1.0]], [0, [18375.796420433384, 1.0]], [0, [1449.0441216180518, 1.0]], [0, [375.88753089979434, 1.0]], [0, [122.66865332599382, 1.0]], [0, [46.53956248635637, 1.0]], [0, [18.31021262451593, 1.0]], [0, [7.0772925459881, 1.0]], [1, [8.605090462241954, 1.0]], [1, [0.4927369917468601, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24722957]
bas 1, expnt(s) = [0.64797249]
bas 2, expnt(s) = [117616.8137712]
bas 3, expnt(s) = [2.89905251]
bas 4, expnt(s) = [1176168.14261679]
bas 5, expnt(s) = [588084.06997989]
bas 6, expnt(s) = [294042.03105866]
bas 7, expnt(s) = [147020.99186065]
bas 8, expnt(s) = [73510.41977776]
bas 9, expnt(s) = [36754.71362198]
bas 10, expnt(s) = [7303.07195755]
bas 11, expnt(s) = [18375.79642043]
bas 12, expnt(s) = [1449.04412162]
bas 13, expnt(s) = [375.8875309]
bas 14, expnt(s) = [122.66865333]
bas 15, expnt(s) = [46.53956249]
bas 16, expnt(s) = [18.31021262]
bas 17, expnt(s) = [7.07729255]
bas 18, expnt(s) = [8.60509046]
bas 19, expnt(s) = [0.49273699]
CPU time:      1053.79
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47229567e-01 8.85809494e-01 6.47972489e-01 1.82466209e+00
 1.17616814e+05 1.60460109e+04 2.89905251e+00 5.61315566e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547136e+04 6.70655988e+03
 7.30307196e+03 1.99592496e+03 1.83757964e+04 3.98749042e+03
 1.44904412e+03 5.93370883e+02 3.75887531e+02 2.15679299e+02
 1.22668653e+02 9.31247720e+01 4.65395625e+01 4.50175387e+01
 1.83102126e+01 2.23632575e+01 7.07729255e+00 1.09626459e+01
 8.60509046e+00 4.29960632e+01 4.92736992e-01 1.20435176e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335942459967466
cond(S) = 909265.813809311
E1 = -689.601804430373  E_coul = 184.97204552822487
init E= -504.629758902148
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672249976402785  LUMO = 0.678495668133774
  mo_energy =
[-1.21707162e+02 -1.33859689e+01 -7.62358326e+00 -7.62358326e+00
 -7.62358326e+00 -1.65735313e+00 -6.72249976e-01 -6.72249976e-01
 -6.72249976e-01  6.78495668e-01  9.13375290e+00  4.95836796e+01
  1.97364631e+02  7.26229266e+02  2.87305146e+03  1.23401859e+04
  4.09528351e+04  1.04991629e+05  2.30171965e+05  4.55984713e+05
  8.44935327e+05  1.52811101e+06  2.85037647e+06  5.80826128e+06]
E1 = -707.742128556888  E_coul = 199.7747168560844
cycle= 1 E= -507.967411700804  delta_E= -3.34  |g|= 0.451  |ddm|= 0.503
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.702408
diis-c [-0.49337717  1.        ]
  HOMO = -0.2177814215703  LUMO = 1.064188645062
  mo_energy =
[-1.20198488e+02 -1.23050518e+01 -6.59470092e+00 -6.59470092e+00
 -6.59470092e+00 -1.16325975e+00 -2.17781422e-01 -2.17781422e-01
 -2.17781422e-01  1.06418865e+00  9.95904166e+00  5.07828815e+01
  1.98792726e+02  7.27720582e+02  2.87448341e+03  1.23415087e+04
  4.09540911e+04  1.04992848e+05  2.30173160e+05  4.55985891e+05
  8.44936491e+05  1.52811217e+06  2.85037762e+06  5.80826242e+06]
E1 = -706.7991779031619  E_coul = 198.81419419440866
cycle= 2 E= -507.984983708753  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.432
    CPU time for cycle= 2      0.10 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297961
diis-c [-8.87737933e-04  3.76239413e-04  9.99623761e-01]
  HOMO = -0.239683756077277  LUMO = 1.05856579699163
  mo_energy =
[-1.20311759e+02 -1.23716747e+01 -6.66849648e+00 -6.66849648e+00
 -6.66849648e+00 -1.17735193e+00 -2.39683756e-01 -2.39683756e-01
 -2.39683756e-01  1.05856580e+00  9.91596104e+00  5.07072885e+01
  1.98693301e+02  7.27603222e+02  2.87435037e+03  1.23413654e+04
  4.09539440e+04  1.04992699e+05  2.30173011e+05  4.55985741e+05
  8.44936341e+05  1.52811202e+06  2.85037747e+06  5.80826226e+06]
E1 = -706.6927345002546  E_coul = 198.70749458678836
cycle= 3 E= -507.985239913466  delta_E= -0.000256  |g|= 0.00438  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324086
diis-c [-2.24222898e-06 -2.06335629e-06 -1.06908211e-01  1.10691027e+00]
  HOMO = -0.24282835398532  LUMO = 1.05752450812708
  mo_energy =
[-1.20323685e+02 -1.23802973e+01 -6.67761954e+00 -6.67761954e+00
 -6.67761954e+00 -1.17925590e+00 -2.42828354e-01 -2.42828354e-01
 -2.42828354e-01  1.05752451e+00  9.90988959e+00  5.06980912e+01
  1.98682317e+02  7.27591129e+02  2.87433745e+03  1.23413520e+04
  4.09539304e+04  1.04992686e+05  2.30172997e+05  4.55985727e+05
  8.44936328e+05  1.52811200e+06  2.85037745e+06  5.80826225e+06]
E1 = -706.6776015330446  E_coul = 198.69235681183855
cycle= 4 E= -507.985244721206  delta_E= -4.81e-06  |g|= 0.000205  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000143234
diis-c [-1.42096936e-10 -7.51455182e-06  7.10720719e-03 -9.89543365e-02
  1.09185464e+00]
  HOMO = -0.24296751946607  LUMO = 1.05747132461647
  mo_energy =
[-1.20324033e+02 -1.23806326e+01 -6.67795231e+00 -6.67795231e+00
 -6.67795231e+00 -1.17933889e+00 -2.42967519e-01 -2.42967519e-01
 -2.42967519e-01  1.05747132e+00  9.90962958e+00  5.06977627e+01
  1.98681973e+02  7.27590780e+02  2.87433710e+03  1.23413516e+04
  4.09539300e+04  1.04992685e+05  2.30172997e+05  4.55985727e+05
  8.44936327e+05  1.52811200e+06  2.85037745e+06  5.80826225e+06]
E1 = -706.6769397910399  E_coul = 198.69169505980076
cycle= 5 E= -507.985244731239  delta_E= -1e-08  |g|= 1.28e-06  |ddm|= 0.000468
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.00173e-07
diis-c [-8.13813039e-14  2.33562236e-07 -1.63797891e-04  2.07395687e-03
 -2.45128973e-02  1.02260250e+00]
  HOMO = -0.242968266966704  LUMO = 1.0574711971738
  mo_energy =
[-1.20324035e+02 -1.23806344e+01 -6.67795414e+00 -6.67795414e+00
 -6.67795414e+00 -1.17933948e+00 -2.42968267e-01 -2.42968267e-01
 -2.42968267e-01  1.05747120e+00  9.90962821e+00  5.06977609e+01
  1.98681971e+02  7.27590777e+02  2.87433710e+03  1.23413516e+04
  4.09539300e+04  1.04992685e+05  2.30172996e+05  4.55985727e+05
  8.44936327e+05  1.52811200e+06  2.85037745e+06  5.80826225e+06]
E1 = -706.676935946774  E_coul = 198.69169121553506
cycle= 6 E= -507.985244731239  delta_E= 1.71e-13  |g|= 4.06e-08  |ddm|= 2.85e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.676935946774  E_coul = 198.69169121553506
  HOMO = -0.242968287499385  LUMO = 1.05747118472911
  mo_energy =
[-1.20324035e+02 -1.23806344e+01 -6.67795419e+00 -6.67795419e+00
 -6.67795419e+00 -1.17933949e+00 -2.42968287e-01 -2.42968287e-01
 -2.42968287e-01  1.05747118e+00  9.90962818e+00  5.06977608e+01
  1.98681971e+02  7.27590777e+02  2.87433710e+03  1.23413516e+04
  4.09539300e+04  1.04992685e+05  2.30172996e+05  4.55985727e+05
  8.44936327e+05  1.52811200e+06  2.85037745e+06  5.80826225e+06]
E1 = -706.6769358551621  E_coul = 198.691691123923
Extra cycle  E= -507.985244731239  delta_E= -1.71e-13  |g|= 5.55e-09  |ddm|= 7.63e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.28 sec
exp = [2.47229567e-01 6.47972489e-01 1.17616814e+05 2.89905251e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547136e+04 7.30307196e+03 1.83757964e+04
 1.44904412e+03 3.75887531e+02 1.22668653e+02 4.65395625e+01
 1.83102126e+01 7.07729255e+00 8.60509046e+00 4.92736992e-01]
E = -507.98524473123916
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:16:20 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247229567031       1
[INPUT] 0    0    [1    /1   ]  0.647972488814       1
[INPUT] 0    0    [1    /1   ]  117616.813771        1
[INPUT] 0    0    [1    /1   ]  2.89905251383        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031059        1
[INPUT] 0    0    [1    /1   ]  147020.991861        1
[INPUT] 0    0    [1    /1   ]  73510.4197778        1
[INPUT] 0    0    [1    /1   ]  36754.713622         1
[INPUT] 0    0    [1    /1   ]  7303.07195755        1
[INPUT] 0    0    [1    /1   ]  18375.7964204        1
[INPUT] 0    0    [1    /1   ]  1449.04412162        1
[INPUT] 0    0    [1    /1   ]  375.8875309          1
[INPUT] 0    0    [1    /1   ]  122.668653326        1
[INPUT] 0    0    [1    /1   ]  46.5395624864        1
[INPUT] 0    0    [1    /1   ]  18.3102126245        1
[INPUT] 0    0    [1    /1   ]  7.07729254599        1
[INPUT] 1    0    [1    /1   ]  8.60509046224        1
[INPUT] 1    0    [1    /1   ]  0.492736991747       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24722956703079543, 1.0]], [0, [0.6479724888139702, 1.0]], [0, [117616.81377119561, 1.0]], [0, [2.8990525138287433, 1.0]], [0, [1176168.1426167907, 1.0]], [0, [588084.0699798851, 1.0]], [0, [294042.03105866123, 1.0]], [0, [147020.99186065182, 1.0]], [0, [73510.41977775584, 1.0]], [0, [36754.713621975425, 1.0]], [0, [7303.071957546378, 1.0]], [0, [18375.796420433384, 1.0]], [0, [1449.0441216180518, 1.0]], [0, [375.88753089979434, 1.0]], [0, [122.66865332599382, 1.0]], [0, [46.53956248635637, 1.0]], [0, [18.31021262451593, 1.0]], [0, [7.0772925459881, 1.0]], [1, [8.605090462241954, 1.0]], [1, [0.4927369917468601, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24722957]
bas 1, expnt(s) = [0.64797249]
bas 2, expnt(s) = [117616.8137712]
bas 3, expnt(s) = [2.89905251]
bas 4, expnt(s) = [1176168.14261679]
bas 5, expnt(s) = [588084.06997989]
bas 6, expnt(s) = [294042.03105866]
bas 7, expnt(s) = [147020.99186065]
bas 8, expnt(s) = [73510.41977776]
bas 9, expnt(s) = [36754.71362198]
bas 10, expnt(s) = [7303.07195755]
bas 11, expnt(s) = [18375.79642043]
bas 12, expnt(s) = [1449.04412162]
bas 13, expnt(s) = [375.8875309]
bas 14, expnt(s) = [122.66865333]
bas 15, expnt(s) = [46.53956249]
bas 16, expnt(s) = [18.31021262]
bas 17, expnt(s) = [7.07729255]
bas 18, expnt(s) = [8.60509046]
bas 19, expnt(s) = [0.49273699]
CPU time:      1055.45
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47229567e-01 8.85809494e-01 6.47972489e-01 1.82466209e+00
 1.17616814e+05 1.60460109e+04 2.89905251e+00 5.61315566e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547136e+04 6.70655988e+03
 7.30307196e+03 1.99592496e+03 1.83757964e+04 3.98749042e+03
 1.44904412e+03 5.93370883e+02 3.75887531e+02 2.15679299e+02
 1.22668653e+02 9.31247720e+01 4.65395625e+01 4.50175387e+01
 1.83102126e+01 2.23632575e+01 7.07729255e+00 1.09626459e+01
 8.60509046e+00 4.29960632e+01 4.92736992e-01 1.20435176e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335942459967466
cond(S) = 909265.813809311
E1 = -689.601804430373  E_coul = 184.97204552822487
init E= -504.629758902148
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672249976402785  LUMO = 0.678495668133774
  mo_energy =
[-1.21707162e+02 -1.33859689e+01 -7.62358326e+00 -7.62358326e+00
 -7.62358326e+00 -1.65735313e+00 -6.72249976e-01 -6.72249976e-01
 -6.72249976e-01  6.78495668e-01  9.13375290e+00  4.95836796e+01
  1.97364631e+02  7.26229266e+02  2.87305146e+03  1.23401859e+04
  4.09528351e+04  1.04991629e+05  2.30171965e+05  4.55984713e+05
  8.44935327e+05  1.52811101e+06  2.85037647e+06  5.80826128e+06]
E1 = -707.742128556888  E_coul = 199.7747168560844
cycle= 1 E= -507.967411700804  delta_E= -3.34  |g|= 0.451  |ddm|= 0.503
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.702408
diis-c [-0.49337717  1.        ]
  HOMO = -0.2177814215703  LUMO = 1.064188645062
  mo_energy =
[-1.20198488e+02 -1.23050518e+01 -6.59470092e+00 -6.59470092e+00
 -6.59470092e+00 -1.16325975e+00 -2.17781422e-01 -2.17781422e-01
 -2.17781422e-01  1.06418865e+00  9.95904166e+00  5.07828815e+01
  1.98792726e+02  7.27720582e+02  2.87448341e+03  1.23415087e+04
  4.09540911e+04  1.04992848e+05  2.30173160e+05  4.55985891e+05
  8.44936491e+05  1.52811217e+06  2.85037762e+06  5.80826242e+06]
E1 = -706.7991779031619  E_coul = 198.81419419440866
cycle= 2 E= -507.984983708753  delta_E= -0.0176  |g|= 0.0347  |ddm|= 0.432
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0297961
diis-c [-8.87737933e-04  3.76239413e-04  9.99623761e-01]
  HOMO = -0.239683756077277  LUMO = 1.05856579699163
  mo_energy =
[-1.20311759e+02 -1.23716747e+01 -6.66849648e+00 -6.66849648e+00
 -6.66849648e+00 -1.17735193e+00 -2.39683756e-01 -2.39683756e-01
 -2.39683756e-01  1.05856580e+00  9.91596104e+00  5.07072885e+01
  1.98693301e+02  7.27603222e+02  2.87435037e+03  1.23413654e+04
  4.09539440e+04  1.04992699e+05  2.30173011e+05  4.55985741e+05
  8.44936341e+05  1.52811202e+06  2.85037747e+06  5.80826226e+06]
E1 = -706.6927345002546  E_coul = 198.70749458678836
cycle= 3 E= -507.985239913466  delta_E= -0.000256  |g|= 0.00438  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324086
diis-c [-2.24222898e-06 -2.06335629e-06 -1.06908211e-01  1.10691027e+00]
  HOMO = -0.24282835398532  LUMO = 1.05752450812708
  mo_energy =
[-1.20323685e+02 -1.23802973e+01 -6.67761954e+00 -6.67761954e+00
 -6.67761954e+00 -1.17925590e+00 -2.42828354e-01 -2.42828354e-01
 -2.42828354e-01  1.05752451e+00  9.90988959e+00  5.06980912e+01
  1.98682317e+02  7.27591129e+02  2.87433745e+03  1.23413520e+04
  4.09539304e+04  1.04992686e+05  2.30172997e+05  4.55985727e+05
  8.44936328e+05  1.52811200e+06  2.85037745e+06  5.80826225e+06]
E1 = -706.6776015330446  E_coul = 198.69235681183855
cycle= 4 E= -507.985244721206  delta_E= -4.81e-06  |g|= 0.000205  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000143234
diis-c [-1.42096936e-10 -7.51455182e-06  7.10720719e-03 -9.89543365e-02
  1.09185464e+00]
  HOMO = -0.24296751946607  LUMO = 1.05747132461647
  mo_energy =
[-1.20324033e+02 -1.23806326e+01 -6.67795231e+00 -6.67795231e+00
 -6.67795231e+00 -1.17933889e+00 -2.42967519e-01 -2.42967519e-01
 -2.42967519e-01  1.05747132e+00  9.90962958e+00  5.06977627e+01
  1.98681973e+02  7.27590780e+02  2.87433710e+03  1.23413516e+04
  4.09539300e+04  1.04992685e+05  2.30172997e+05  4.55985727e+05
  8.44936327e+05  1.52811200e+06  2.85037745e+06  5.80826225e+06]
E1 = -706.6769397910399  E_coul = 198.69169505980076
cycle= 5 E= -507.985244731239  delta_E= -1e-08  |g|= 1.28e-06  |ddm|= 0.000468
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.00173e-07
diis-c [-8.13813039e-14  2.33562236e-07 -1.63797891e-04  2.07395687e-03
 -2.45128973e-02  1.02260250e+00]
  HOMO = -0.242968266966704  LUMO = 1.0574711971738
  mo_energy =
[-1.20324035e+02 -1.23806344e+01 -6.67795414e+00 -6.67795414e+00
 -6.67795414e+00 -1.17933948e+00 -2.42968267e-01 -2.42968267e-01
 -2.42968267e-01  1.05747120e+00  9.90962821e+00  5.06977609e+01
  1.98681971e+02  7.27590777e+02  2.87433710e+03  1.23413516e+04
  4.09539300e+04  1.04992685e+05  2.30172996e+05  4.55985727e+05
  8.44936327e+05  1.52811200e+06  2.85037745e+06  5.80826225e+06]
E1 = -706.676935946774  E_coul = 198.69169121553506
cycle= 6 E= -507.985244731239  delta_E= 1.71e-13  |g|= 4.06e-08  |ddm|= 2.85e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.676935946774  E_coul = 198.69169121553506
  HOMO = -0.242968287499385  LUMO = 1.05747118472911
  mo_energy =
[-1.20324035e+02 -1.23806344e+01 -6.67795419e+00 -6.67795419e+00
 -6.67795419e+00 -1.17933949e+00 -2.42968287e-01 -2.42968287e-01
 -2.42968287e-01  1.05747118e+00  9.90962818e+00  5.06977608e+01
  1.98681971e+02  7.27590777e+02  2.87433710e+03  1.23413516e+04
  4.09539300e+04  1.04992685e+05  2.30172996e+05  4.55985727e+05
  8.44936327e+05  1.52811200e+06  2.85037745e+06  5.80826225e+06]
E1 = -706.6769358551621  E_coul = 198.691691123923
Extra cycle  E= -507.985244731239  delta_E= -1.71e-13  |g|= 5.55e-09  |ddm|= 7.63e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909265.813809311
E1 = -706.6769358551621  E_coul = 198.691691123923
init E= -507.985244731239
    CPU time for initialize scf      3.65 sec, wall time      0.23 sec
  HOMO = -0.242968290306741  LUMO = 1.05747118425263
  mo_energy =
[-1.20324035e+02 -1.23806345e+01 -6.67795419e+00 -6.67795419e+00
 -6.67795419e+00 -1.17933949e+00 -2.42968290e-01 -2.42968290e-01
 -2.42968290e-01  1.05747118e+00  9.90962817e+00  5.06977608e+01
  1.98681971e+02  7.27590777e+02  2.87433710e+03  1.23413516e+04
  4.09539300e+04  1.04992685e+05  2.30172996e+05  4.55985727e+05
  8.44936327e+05  1.52811200e+06  2.85037745e+06  5.80826225e+06]
E1 = -706.6769358390583  E_coul = 198.69169110781854
cycle= 1 E= -507.98524473124  delta_E= -5.68e-13  |g|= 1.1e-09  |ddm|= 1.13e-08
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.6769358390583  E_coul = 198.69169110781854
  HOMO = -0.242968290766696  LUMO = 1.05747118425551
  mo_energy =
[-1.20324035e+02 -1.23806345e+01 -6.67795419e+00 -6.67795419e+00
 -6.67795419e+00 -1.17933949e+00 -2.42968291e-01 -2.42968291e-01
 -2.42968291e-01  1.05747118e+00  9.90962817e+00  5.06977608e+01
  1.98681971e+02  7.27590777e+02  2.87433710e+03  1.23413516e+04
  4.09539300e+04  1.04992685e+05  2.30172996e+05  4.55985727e+05
  8.44936327e+05  1.52811200e+06  2.85037745e+06  5.80826225e+06]
E1 = -706.6769358355842  E_coul = 198.69169110434478
Extra cycle  E= -507.985244731239  delta_E= 2.84e-13  |g|= 1.45e-09  |ddm|= 2.33e-09
    CPU time for scf_cycle      4.09 sec, wall time      0.40 sec
exp = [2.47229567e-01 6.47972489e-01 1.17616814e+05 2.89905251e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547136e+04 7.30307196e+03 1.83757964e+04
 1.44904412e+03 3.75887531e+02 1.22668653e+02 4.65395625e+01
 1.83102126e+01 7.07729255e+00 8.60509046e+00 4.92736992e-01]
grad_E = [-6.19866466e-05 -7.65903991e-05  3.72071404e-09  4.44637991e-04
  1.32407192e-11  9.78075825e-11  5.79166289e-10  2.26665592e-09
  9.40003667e-09  5.10904825e-08  3.15950928e-06  1.04739377e-07
  2.91613092e-05 -2.32362725e-04 -2.11574147e-05  6.51898737e-05
 -8.36279663e-05 -1.63117176e-04  7.69718830e-04 -1.84416722e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:16:28 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247147379119       1
[INPUT] 0    0    [1    /1   ]  0.64778419762        1
[INPUT] 0    0    [1    /1   ]  117616.813772        1
[INPUT] 0    0    [1    /1   ]  2.89282185682        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031059        1
[INPUT] 0    0    [1    /1   ]  147020.991861        1
[INPUT] 0    0    [1    /1   ]  73510.4197789        1
[INPUT] 0    0    [1    /1   ]  36754.7136277        1
[INPUT] 0    0    [1    /1   ]  7303.07233755        1
[INPUT] 0    0    [1    /1   ]  18375.7964352        1
[INPUT] 0    0    [1    /1   ]  1449.033677          1
[INPUT] 0    0    [1    /1   ]  375.984851709        1
[INPUT] 0    0    [1    /1   ]  122.52574664         1
[INPUT] 0    0    [1    /1   ]  46.3554440709        1
[INPUT] 0    0    [1    /1   ]  18.1126292772        1
[INPUT] 0    0    [1    /1   ]  7.0447527375         1
[INPUT] 1    0    [1    /1   ]  8.60575106938        1
[INPUT] 1    0    [1    /1   ]  0.49275135758        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24714737911859877, 1.0]], [0, [0.6477841976203558, 1.0]], [0, [117616.81377162514, 1.0]], [0, [2.8928218568150967, 1.0]], [0, [1176168.1426167944, 1.0]], [0, [588084.0699798979, 1.0]], [0, [294042.0310587279, 1.0]], [0, [147020.99186091567, 1.0]], [0, [73510.41977886038, 1.0]], [0, [36754.71362765384, 1.0]], [0, [7303.072337553148, 1.0]], [0, [18375.796435208456, 1.0]], [0, [1449.0336769952405, 1.0]], [0, [375.9848517093737, 1.0]], [0, [122.52574664043298, 1.0]], [0, [46.35544407085494, 1.0]], [0, [18.11262927724159, 1.0]], [0, [7.044752737501729, 1.0]], [1, [8.605751069380482, 1.0]], [1, [0.49275135757986804, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24714738]
bas 1, expnt(s) = [0.6477842]
bas 2, expnt(s) = [117616.81377163]
bas 3, expnt(s) = [2.89282186]
bas 4, expnt(s) = [1176168.14261679]
bas 5, expnt(s) = [588084.0699799]
bas 6, expnt(s) = [294042.03105873]
bas 7, expnt(s) = [147020.99186092]
bas 8, expnt(s) = [73510.41977886]
bas 9, expnt(s) = [36754.71362765]
bas 10, expnt(s) = [7303.07233755]
bas 11, expnt(s) = [18375.79643521]
bas 12, expnt(s) = [1449.033677]
bas 13, expnt(s) = [375.98485171]
bas 14, expnt(s) = [122.52574664]
bas 15, expnt(s) = [46.35544407]
bas 16, expnt(s) = [18.11262928]
bas 17, expnt(s) = [7.04475274]
bas 18, expnt(s) = [8.60575107]
bas 19, expnt(s) = [0.49275136]
CPU time:      1067.66
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47147379e-01 8.85588628e-01 6.47784198e-01 1.82426441e+00
 1.17616814e+05 1.60460109e+04 2.89282186e+00 5.60410536e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547136e+04 6.70655988e+03
 7.30307234e+03 1.99592504e+03 1.83757964e+04 3.98749042e+03
 1.44903368e+03 5.93367675e+02 3.75984852e+02 2.15721179e+02
 1.22525747e+02 9.30433937e+01 4.63554441e+01 4.48838997e+01
 1.81126293e+01 2.21820228e+01 7.04475274e+00 1.09248213e+01
 8.60575107e+00 4.30001892e+01 4.92751358e-01 1.20439565e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335922176109516
cond(S) = 909244.741438055
E1 = -689.6050256722962  E_coul = 184.97544012796348
init E= -504.629585544333
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672240636100853  LUMO = 0.677851933395897
  mo_energy =
[-1.21706501e+02 -1.33857038e+01 -7.62334737e+00 -7.62334737e+00
 -7.62334737e+00 -1.65733239e+00 -6.72240636e-01 -6.72240636e-01
 -6.72240636e-01  6.77851933e-01  9.08712339e+00  4.91576654e+01
  1.96113297e+02  7.24379188e+02  2.87126555e+03  1.23386343e+04
  4.09513988e+04  1.04990251e+05  2.30170626e+05  4.55983402e+05
  8.44934037e+05  1.52810974e+06  2.85037523e+06  5.80826007e+06]
E1 = -707.746339938253  E_coul = 199.77892372486693
cycle= 1 E= -507.967416213386  delta_E= -3.34  |g|= 0.451  |ddm|= 0.503
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.702069
diis-c [-0.4929007  1.       ]
  HOMO = -0.217747630522561  LUMO = 1.06335192961768
  mo_energy =
[-1.20197747e+02 -1.23047313e+01 -6.59440115e+00 -6.59440115e+00
 -6.59440115e+00 -1.16322318e+00 -2.17747631e-01 -2.17747631e-01
 -2.17747631e-01  1.06335193e+00  9.91056268e+00  5.03545973e+01
  1.97540879e+02  7.25870572e+02  2.87269756e+03  1.23399572e+04
  4.09526549e+04  1.04991471e+05  2.30171821e+05  4.55984580e+05
  8.44935202e+05  1.52811090e+06  2.85037637e+06  5.80826121e+06]
E1 = -706.803163541089  E_coul = 198.81816992627634
cycle= 2 E= -507.984993614813  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.432
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0298134
diis-c [-8.88801611e-04  2.81269016e-04  9.99718731e-01]
  HOMO = -0.239656483367005  LUMO = 1.05773913100744
  mo_energy =
[-1.20311054e+02 -1.23713781e+01 -6.66822303e+00 -6.66822303e+00
 -6.66822303e+00 -1.17731897e+00 -2.39656483e-01 -2.39656483e-01
 -2.39656483e-01  1.05773913e+00  9.86759900e+00  5.02791683e+01
  1.97441494e+02  7.25753179e+02  2.87256447e+03  1.23398138e+04
  4.09525077e+04  1.04991322e+05  2.30171672e+05  4.55984430e+05
  8.44935052e+05  1.52811075e+06  2.85037622e+06  5.80826105e+06]
E1 = -706.6966910015179  E_coul = 198.7114411237492
cycle= 3 E= -507.985249877769  delta_E= -0.000256  |g|= 0.00437  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.003241
diis-c [-2.24806810e-06  1.24262872e-06 -1.06806578e-01  1.10680534e+00]
  HOMO = -0.242799570768025  LUMO = 1.05669983920738
  mo_energy =
[-1.20322970e+02 -1.23799956e+01 -6.67734044e+00 -6.67734044e+00
 -6.67734044e+00 -1.17922187e+00 -2.42799571e-01 -2.42799571e-01
 -2.42799571e-01  1.05669984e+00  9.86154571e+00  5.02699925e+01
  1.97430523e+02  7.25741096e+02  2.87255157e+03  1.23398004e+04
  4.09524941e+04  1.04991308e+05  2.30171658e+05  4.55984416e+05
  8.44935038e+05  1.52811073e+06  2.85037621e+06  5.80826104e+06]
E1 = -706.6815656796845  E_coul = 198.6963109976119
cycle= 4 E= -507.985254682073  delta_E= -4.8e-06  |g|= 0.000205  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000143439
diis-c [-1.42940376e-10 -7.51585657e-06  7.09450068e-03 -9.89424285e-02
  1.09185544e+00]
  HOMO = -0.242938892654195  LUMO = 1.05664666673682
  mo_energy =
[-1.20323319e+02 -1.23803312e+01 -6.67767348e+00 -6.67767348e+00
 -6.67767348e+00 -1.17930496e+00 -2.42938893e-01 -2.42938893e-01
 -2.42938893e-01  1.05664667e+00  9.86128594e+00  5.02696639e+01
  1.97430179e+02  7.25740746e+02  2.87255122e+03  1.23398001e+04
  4.09524938e+04  1.04991308e+05  2.30171658e+05  4.55984416e+05
  8.44935038e+05  1.52811073e+06  2.85037621e+06  5.80826104e+06]
E1 = -706.6809032122098  E_coul = 198.69564852007287
cycle= 5 E= -507.985254692137  delta_E= -1.01e-08  |g|= 1.3e-06  |ddm|= 0.000469
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.08525e-07
diis-c [-8.45560441e-14  2.38848345e-07 -1.67579879e-04  2.12918567e-03
 -2.51430145e-02  1.02318117e+00]
  HOMO = -0.242939651438065  LUMO = 1.05664653194744
  mo_energy =
[-1.20323321e+02 -1.23803330e+01 -6.67767534e+00 -6.67767534e+00
 -6.67767534e+00 -1.17930556e+00 -2.42939651e-01 -2.42939651e-01
 -2.42939651e-01  1.05664653e+00  9.86128455e+00  5.02696620e+01
  1.97430176e+02  7.25740744e+02  2.87255121e+03  1.23398001e+04
  4.09524938e+04  1.04991308e+05  2.30171658e+05  4.55984416e+05
  8.44935038e+05  1.52811073e+06  2.85037621e+06  5.80826104e+06]
E1 = -706.680899315263  E_coul = 198.69564462312593
cycle= 6 E= -507.985254692137  delta_E= -5.68e-14  |g|= 4.16e-08  |ddm|= 2.9e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.680899315263  E_coul = 198.69564462312593
  HOMO = -0.242939672439596  LUMO = 1.05664651905918
  mo_energy =
[-1.20323321e+02 -1.23803330e+01 -6.67767538e+00 -6.67767538e+00
 -6.67767538e+00 -1.17930557e+00 -2.42939672e-01 -2.42939672e-01
 -2.42939672e-01  1.05664652e+00  9.86128451e+00  5.02696620e+01
  1.97430176e+02  7.25740744e+02  2.87255121e+03  1.23398001e+04
  4.09524938e+04  1.04991308e+05  2.30171658e+05  4.55984416e+05
  8.44935038e+05  1.52811073e+06  2.85037621e+06  5.80826104e+06]
E1 = -706.6808992188286  E_coul = 198.69564452669107
Extra cycle  E= -507.985254692138  delta_E= -4.55e-13  |g|= 5.2e-09  |ddm|= 7.97e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.47147379e-01 6.47784198e-01 1.17616814e+05 2.89282186e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547136e+04 7.30307234e+03 1.83757964e+04
 1.44903368e+03 3.75984852e+02 1.22525747e+02 4.63554441e+01
 1.81126293e+01 7.04475274e+00 8.60575107e+00 4.92751358e-01]
E = -507.9852546921375
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:16:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247147379119       1
[INPUT] 0    0    [1    /1   ]  0.64778419762        1
[INPUT] 0    0    [1    /1   ]  117616.813772        1
[INPUT] 0    0    [1    /1   ]  2.89282185682        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031059        1
[INPUT] 0    0    [1    /1   ]  147020.991861        1
[INPUT] 0    0    [1    /1   ]  73510.4197789        1
[INPUT] 0    0    [1    /1   ]  36754.7136277        1
[INPUT] 0    0    [1    /1   ]  7303.07233755        1
[INPUT] 0    0    [1    /1   ]  18375.7964352        1
[INPUT] 0    0    [1    /1   ]  1449.033677          1
[INPUT] 0    0    [1    /1   ]  375.984851709        1
[INPUT] 0    0    [1    /1   ]  122.52574664         1
[INPUT] 0    0    [1    /1   ]  46.3554440709        1
[INPUT] 0    0    [1    /1   ]  18.1126292772        1
[INPUT] 0    0    [1    /1   ]  7.0447527375         1
[INPUT] 1    0    [1    /1   ]  8.60575106938        1
[INPUT] 1    0    [1    /1   ]  0.49275135758        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24714737911859877, 1.0]], [0, [0.6477841976203558, 1.0]], [0, [117616.81377162514, 1.0]], [0, [2.8928218568150967, 1.0]], [0, [1176168.1426167944, 1.0]], [0, [588084.0699798979, 1.0]], [0, [294042.0310587279, 1.0]], [0, [147020.99186091567, 1.0]], [0, [73510.41977886038, 1.0]], [0, [36754.71362765384, 1.0]], [0, [7303.072337553148, 1.0]], [0, [18375.796435208456, 1.0]], [0, [1449.0336769952405, 1.0]], [0, [375.9848517093737, 1.0]], [0, [122.52574664043298, 1.0]], [0, [46.35544407085494, 1.0]], [0, [18.11262927724159, 1.0]], [0, [7.044752737501729, 1.0]], [1, [8.605751069380482, 1.0]], [1, [0.49275135757986804, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24714738]
bas 1, expnt(s) = [0.6477842]
bas 2, expnt(s) = [117616.81377163]
bas 3, expnt(s) = [2.89282186]
bas 4, expnt(s) = [1176168.14261679]
bas 5, expnt(s) = [588084.0699799]
bas 6, expnt(s) = [294042.03105873]
bas 7, expnt(s) = [147020.99186092]
bas 8, expnt(s) = [73510.41977886]
bas 9, expnt(s) = [36754.71362765]
bas 10, expnt(s) = [7303.07233755]
bas 11, expnt(s) = [18375.79643521]
bas 12, expnt(s) = [1449.033677]
bas 13, expnt(s) = [375.98485171]
bas 14, expnt(s) = [122.52574664]
bas 15, expnt(s) = [46.35544407]
bas 16, expnt(s) = [18.11262928]
bas 17, expnt(s) = [7.04475274]
bas 18, expnt(s) = [8.60575107]
bas 19, expnt(s) = [0.49275136]
CPU time:      1069.23
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47147379e-01 8.85588628e-01 6.47784198e-01 1.82426441e+00
 1.17616814e+05 1.60460109e+04 2.89282186e+00 5.60410536e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547136e+04 6.70655988e+03
 7.30307234e+03 1.99592504e+03 1.83757964e+04 3.98749042e+03
 1.44903368e+03 5.93367675e+02 3.75984852e+02 2.15721179e+02
 1.22525747e+02 9.30433937e+01 4.63554441e+01 4.48838997e+01
 1.81126293e+01 2.21820228e+01 7.04475274e+00 1.09248213e+01
 8.60575107e+00 4.30001892e+01 4.92751358e-01 1.20439565e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335922176109516
cond(S) = 909244.741438055
E1 = -689.6050256722962  E_coul = 184.97544012796348
init E= -504.629585544333
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672240636100853  LUMO = 0.677851933395897
  mo_energy =
[-1.21706501e+02 -1.33857038e+01 -7.62334737e+00 -7.62334737e+00
 -7.62334737e+00 -1.65733239e+00 -6.72240636e-01 -6.72240636e-01
 -6.72240636e-01  6.77851933e-01  9.08712339e+00  4.91576654e+01
  1.96113297e+02  7.24379188e+02  2.87126555e+03  1.23386343e+04
  4.09513988e+04  1.04990251e+05  2.30170626e+05  4.55983402e+05
  8.44934037e+05  1.52810974e+06  2.85037523e+06  5.80826007e+06]
E1 = -707.746339938253  E_coul = 199.77892372486693
cycle= 1 E= -507.967416213386  delta_E= -3.34  |g|= 0.451  |ddm|= 0.503
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.702069
diis-c [-0.4929007  1.       ]
  HOMO = -0.217747630522561  LUMO = 1.06335192961768
  mo_energy =
[-1.20197747e+02 -1.23047313e+01 -6.59440115e+00 -6.59440115e+00
 -6.59440115e+00 -1.16322318e+00 -2.17747631e-01 -2.17747631e-01
 -2.17747631e-01  1.06335193e+00  9.91056268e+00  5.03545973e+01
  1.97540879e+02  7.25870572e+02  2.87269756e+03  1.23399572e+04
  4.09526549e+04  1.04991471e+05  2.30171821e+05  4.55984580e+05
  8.44935202e+05  1.52811090e+06  2.85037637e+06  5.80826121e+06]
E1 = -706.803163541089  E_coul = 198.81816992627634
cycle= 2 E= -507.984993614813  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.432
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0298134
diis-c [-8.88801611e-04  2.81269016e-04  9.99718731e-01]
  HOMO = -0.239656483367005  LUMO = 1.05773913100744
  mo_energy =
[-1.20311054e+02 -1.23713781e+01 -6.66822303e+00 -6.66822303e+00
 -6.66822303e+00 -1.17731897e+00 -2.39656483e-01 -2.39656483e-01
 -2.39656483e-01  1.05773913e+00  9.86759900e+00  5.02791683e+01
  1.97441494e+02  7.25753179e+02  2.87256447e+03  1.23398138e+04
  4.09525077e+04  1.04991322e+05  2.30171672e+05  4.55984430e+05
  8.44935052e+05  1.52811075e+06  2.85037622e+06  5.80826105e+06]
E1 = -706.6966910015179  E_coul = 198.7114411237492
cycle= 3 E= -507.985249877769  delta_E= -0.000256  |g|= 0.00437  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.003241
diis-c [-2.24806810e-06  1.24262872e-06 -1.06806578e-01  1.10680534e+00]
  HOMO = -0.242799570768025  LUMO = 1.05669983920738
  mo_energy =
[-1.20322970e+02 -1.23799956e+01 -6.67734044e+00 -6.67734044e+00
 -6.67734044e+00 -1.17922187e+00 -2.42799571e-01 -2.42799571e-01
 -2.42799571e-01  1.05669984e+00  9.86154571e+00  5.02699925e+01
  1.97430523e+02  7.25741096e+02  2.87255157e+03  1.23398004e+04
  4.09524941e+04  1.04991308e+05  2.30171658e+05  4.55984416e+05
  8.44935038e+05  1.52811073e+06  2.85037621e+06  5.80826104e+06]
E1 = -706.6815656796845  E_coul = 198.6963109976119
cycle= 4 E= -507.985254682073  delta_E= -4.8e-06  |g|= 0.000205  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000143439
diis-c [-1.42940376e-10 -7.51585657e-06  7.09450068e-03 -9.89424285e-02
  1.09185544e+00]
  HOMO = -0.242938892654195  LUMO = 1.05664666673682
  mo_energy =
[-1.20323319e+02 -1.23803312e+01 -6.67767348e+00 -6.67767348e+00
 -6.67767348e+00 -1.17930496e+00 -2.42938893e-01 -2.42938893e-01
 -2.42938893e-01  1.05664667e+00  9.86128594e+00  5.02696639e+01
  1.97430179e+02  7.25740746e+02  2.87255122e+03  1.23398001e+04
  4.09524938e+04  1.04991308e+05  2.30171658e+05  4.55984416e+05
  8.44935038e+05  1.52811073e+06  2.85037621e+06  5.80826104e+06]
E1 = -706.6809032122098  E_coul = 198.69564852007287
cycle= 5 E= -507.985254692137  delta_E= -1.01e-08  |g|= 1.3e-06  |ddm|= 0.000469
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.08525e-07
diis-c [-8.45560441e-14  2.38848345e-07 -1.67579879e-04  2.12918567e-03
 -2.51430145e-02  1.02318117e+00]
  HOMO = -0.242939651438065  LUMO = 1.05664653194744
  mo_energy =
[-1.20323321e+02 -1.23803330e+01 -6.67767534e+00 -6.67767534e+00
 -6.67767534e+00 -1.17930556e+00 -2.42939651e-01 -2.42939651e-01
 -2.42939651e-01  1.05664653e+00  9.86128455e+00  5.02696620e+01
  1.97430176e+02  7.25740744e+02  2.87255121e+03  1.23398001e+04
  4.09524938e+04  1.04991308e+05  2.30171658e+05  4.55984416e+05
  8.44935038e+05  1.52811073e+06  2.85037621e+06  5.80826104e+06]
E1 = -706.680899315263  E_coul = 198.69564462312593
cycle= 6 E= -507.985254692137  delta_E= -5.68e-14  |g|= 4.16e-08  |ddm|= 2.9e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.680899315263  E_coul = 198.69564462312593
  HOMO = -0.242939672439596  LUMO = 1.05664651905918
  mo_energy =
[-1.20323321e+02 -1.23803330e+01 -6.67767538e+00 -6.67767538e+00
 -6.67767538e+00 -1.17930557e+00 -2.42939672e-01 -2.42939672e-01
 -2.42939672e-01  1.05664652e+00  9.86128451e+00  5.02696620e+01
  1.97430176e+02  7.25740744e+02  2.87255121e+03  1.23398001e+04
  4.09524938e+04  1.04991308e+05  2.30171658e+05  4.55984416e+05
  8.44935038e+05  1.52811073e+06  2.85037621e+06  5.80826104e+06]
E1 = -706.6808992188286  E_coul = 198.69564452669107
Extra cycle  E= -507.985254692138  delta_E= -4.55e-13  |g|= 5.2e-09  |ddm|= 7.97e-08
    CPU time for scf_cycle      1.08 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909244.741438055
E1 = -706.6808992188286  E_coul = 198.69564452669107
init E= -507.985254692138
    CPU time for initialize scf      3.51 sec, wall time      0.22 sec
  HOMO = -0.242939675372835  LUMO = 1.05664651867457
  mo_energy =
[-1.20323321e+02 -1.23803330e+01 -6.67767539e+00 -6.67767539e+00
 -6.67767539e+00 -1.17930557e+00 -2.42939675e-01 -2.42939675e-01
 -2.42939675e-01  1.05664652e+00  9.86128451e+00  5.02696620e+01
  1.97430176e+02  7.25740744e+02  2.87255121e+03  1.23398001e+04
  4.09524938e+04  1.04991308e+05  2.30171658e+05  4.55984416e+05
  8.44935038e+05  1.52811073e+06  2.85037621e+06  5.80826104e+06]
E1 = -706.68089920438  E_coul = 198.69564451224352
cycle= 1 E= -507.985254692136  delta_E= 1.02e-12  |g|= 8.65e-10  |ddm|= 1.04e-08
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.68089920438  E_coul = 198.69564451224352
  HOMO = -0.242939675798754  LUMO = 1.05664651734603
  mo_energy =
[-1.20323321e+02 -1.23803330e+01 -6.67767539e+00 -6.67767539e+00
 -6.67767539e+00 -1.17930557e+00 -2.42939676e-01 -2.42939676e-01
 -2.42939676e-01  1.05664652e+00  9.86128451e+00  5.02696620e+01
  1.97430176e+02  7.25740744e+02  2.87255121e+03  1.23398001e+04
  4.09524938e+04  1.04991308e+05  2.30171658e+05  4.55984416e+05
  8.44935038e+05  1.52811073e+06  2.85037621e+06  5.80826104e+06]
E1 = -706.6808992042086  E_coul = 198.69564451207174
Extra cycle  E= -507.985254692137  delta_E= -3.41e-13  |g|= 1.08e-09  |ddm|= 2.22e-10
    CPU time for scf_cycle      3.95 sec, wall time      0.39 sec
exp = [2.47147379e-01 6.47784198e-01 1.17616814e+05 2.89282186e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547136e+04 7.30307234e+03 1.83757964e+04
 1.44903368e+03 3.75984852e+02 1.22525747e+02 4.63554441e+01
 1.81126293e+01 7.04475274e+00 8.60575107e+00 4.92751358e-01]
grad_E = [-1.22045289e-04 -7.49320955e-05  3.73952822e-09  7.04611668e-04
  1.34682853e-11  9.84164616e-11  5.82087546e-10  2.27827543e-09
  9.44895204e-09  5.13330568e-08  3.17685748e-06  1.05460104e-07
  2.82907617e-05 -2.26034700e-04 -3.12189531e-05  7.44752176e-05
 -9.08842939e-05 -2.90696777e-04  1.31377944e-03 -3.03912089e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:16:36 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247025605565       1
[INPUT] 0    0    [1    /1   ]  0.647460425248       1
[INPUT] 0    0    [1    /1   ]  117616.813771        1
[INPUT] 0    0    [1    /1   ]  2.8837118751         1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031059        1
[INPUT] 0    0    [1    /1   ]  147020.99186         1
[INPUT] 0    0    [1    /1   ]  73510.4197762        1
[INPUT] 0    0    [1    /1   ]  36754.7136127        1
[INPUT] 0    0    [1    /1   ]  7303.07145591        1
[INPUT] 0    0    [1    /1   ]  18375.7964091        1
[INPUT] 0    0    [1    /1   ]  1449.00590604        1
[INPUT] 0    0    [1    /1   ]  376.223790269        1
[INPUT] 0    0    [1    /1   ]  122.345598418        1
[INPUT] 0    0    [1    /1   ]  46.0857030158        1
[INPUT] 0    0    [1    /1   ]  17.8048325605        1
[INPUT] 0    0    [1    /1   ]  6.99494948084        1
[INPUT] 1    0    [1    /1   ]  8.60678384956        1
[INPUT] 1    0    [1    /1   ]  0.49277363901        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24702560556518824, 1.0]], [0, [0.6474604252480634, 1.0]], [0, [117616.81377056199, 1.0]], [0, [2.8837118751001403, 1.0]], [0, [1176168.1426167935, 1.0]], [0, [588084.0699798722, 1.0]], [0, [294042.0310585621, 1.0]], [0, [147020.99186027108, 1.0]], [0, [73510.4197762019, 1.0]], [0, [36754.71361274346, 1.0]], [0, [7303.071455913961, 1.0]], [0, [18375.796409088704, 1.0]], [0, [1449.0059060389299, 1.0]], [0, [376.22379026919776, 1.0]], [0, [122.34559841798304, 1.0]], [0, [46.08570301583592, 1.0]], [0, [17.804832560510416, 1.0]], [0, [6.994949480836695, 1.0]], [1, [8.606783849559104, 1.0]], [1, [0.49277363900959353, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24702561]
bas 1, expnt(s) = [0.64746043]
bas 2, expnt(s) = [117616.81377056]
bas 3, expnt(s) = [2.88371188]
bas 4, expnt(s) = [1176168.14261679]
bas 5, expnt(s) = [588084.06997987]
bas 6, expnt(s) = [294042.03105856]
bas 7, expnt(s) = [147020.99186027]
bas 8, expnt(s) = [73510.4197762]
bas 9, expnt(s) = [36754.71361274]
bas 10, expnt(s) = [7303.07145591]
bas 11, expnt(s) = [18375.79640909]
bas 12, expnt(s) = [1449.00590604]
bas 13, expnt(s) = [376.22379027]
bas 14, expnt(s) = [122.34559842]
bas 15, expnt(s) = [46.08570302]
bas 16, expnt(s) = [17.80483256]
bas 17, expnt(s) = [6.99494948]
bas 18, expnt(s) = [8.60678385]
bas 19, expnt(s) = [0.49277364]
CPU time:      1081.34
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47025606e-01 8.85261350e-01 6.47460425e-01 1.82358052e+00
 1.17616814e+05 1.60460109e+04 2.88371188e+00 5.59086394e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547136e+04 6.70655988e+03
 7.30307146e+03 1.99592486e+03 1.83757964e+04 3.98749042e+03
 1.44900591e+03 5.93359146e+02 3.76223790e+02 2.15823989e+02
 1.22345598e+02 9.29407743e+01 4.60857030e+01 4.46878733e+01
 1.78048326e+01 2.18987056e+01 6.99494948e+00 1.08668447e+01
 8.60678385e+00 4.30066399e+01 4.92773639e-01 1.20446373e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335890337409268
cond(S) = 909216.5971416212
E1 = -689.6100141016381  E_coul = 184.98073978458916
init E= -504.629274317049
    CPU time for initialize scf      0.45 sec, wall time      0.07 sec
  HOMO = -0.672226393542913  LUMO = 0.676855740934668
  mo_energy =
[-1.21705475e+02 -1.33852887e+01 -7.62297894e+00 -7.62297894e+00
 -7.62297894e+00 -1.65730067e+00 -6.72226394e-01 -6.72226394e-01
 -6.72226394e-01  6.76855741e-01  9.01649468e+00  4.85036624e+01
  1.94221472e+02  7.21730506e+02  2.86893729e+03  1.23367023e+04
  4.09496198e+04  1.04988546e+05  2.30168968e+05  4.55981778e+05
  8.44932440e+05  1.52810817e+06  2.85037369e+06  5.80825857e+06]
E1 = -707.7529400750084  E_coul = 199.78550638500838
cycle= 1 E= -507.96743369  delta_E= -3.34  |g|= 0.451  |ddm|= 0.503
    CPU time for cycle= 1      0.43 sec, wall time      0.03 sec
diis-norm(errvec)=0.701513
diis-c [-0.49212044  1.        ]
  HOMO = -0.217694833589625  LUMO = 1.06205914188582
  mo_energy =
[-1.20196593e+02 -1.23042290e+01 -6.59393210e+00 -6.59393210e+00
 -6.59393210e+00 -1.16316622e+00 -2.17694834e-01 -2.17694834e-01
 -2.17694834e-01  1.06205914e+00  9.83709878e+00  4.96970493e+01
  1.95648287e+02  7.23222004e+02  2.87036941e+03  1.23380254e+04
  4.09508760e+04  1.04989765e+05  2.30170163e+05  4.55982956e+05
  8.44933605e+05  1.52810933e+06  2.85037483e+06  5.80825971e+06]
E1 = -706.809422416316  E_coul = 198.82440316325102
cycle= 2 E= -507.985019253065  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.431
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0298384
diis-c [-8.90319772e-04  1.34168828e-04  9.99865831e-01]
  HOMO = -0.239613739397374  LUMO = 1.05646178254788
  mo_energy =
[-1.20309954e+02 -1.23709120e+01 -6.66779399e+00 -6.66779399e+00
 -6.66779399e+00 -1.17726759e+00 -2.39613739e-01 -2.39613739e-01
 -2.39613739e-01  1.05646178e+00  9.79431449e+00  4.96218763e+01
  1.95548962e+02  7.23104557e+02  2.87023626e+03  1.23378819e+04
  4.09507288e+04  1.04989616e+05  2.30170013e+05  4.55982806e+05
  8.44933454e+05  1.52810918e+06  2.85037468e+06  5.80825956e+06]
E1 = -706.702904694144  E_coul = 198.71762908703377
cycle= 3 E= -507.98527560711  delta_E= -0.000256  |g|= 0.00437  |ddm|= 0.0602
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.003241
diis-c [-2.25674504e-06  6.29788303e-06 -1.06650694e-01  1.10664440e+00]
  HOMO = -0.242754496481274  LUMO = 1.0554255567602
  mo_energy =
[-1.20321856e+02 -1.23795217e+01 -6.67690265e+00 -6.67690265e+00
 -6.67690265e+00 -1.17916885e+00 -2.42754496e-01 -2.42754496e-01
 -2.42754496e-01  1.05542556e+00  9.78828905e+00  4.96127340e+01
  1.95538010e+02  7.23092489e+02  2.87022337e+03  1.23378685e+04
  4.09507152e+04  1.04989603e+05  2.30170000e+05  4.55982793e+05
  8.44933441e+05  1.52810916e+06  2.85037467e+06  5.80825954e+06]
E1 = -706.6877911217318  E_coul = 198.70251071562788
cycle= 4 E= -507.985280406104  delta_E= -4.8e-06  |g|= 0.000205  |ddm|= 0.00944
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000143744
diis-c [-1.44129898e-10 -7.52386601e-06  7.07530253e-03 -9.89263360e-02
  1.09185856e+00]
  HOMO = -0.242894055235417  LUMO = 1.05537239954715
  mo_energy =
[-1.20322205e+02 -1.23798576e+01 -6.67723611e+00 -6.67723611e+00
 -6.67723611e+00 -1.17925210e+00 -2.42894055e-01 -2.42894055e-01
 -2.42894055e-01  1.05537240e+00  9.78802965e+00  4.96124054e+01
  1.95537666e+02  7.23092139e+02  2.87022301e+03  1.23378682e+04
  4.09507149e+04  1.04989602e+05  2.30169999e+05  4.55982792e+05
  8.44933440e+05  1.52810916e+06  2.85037467e+06  5.80825954e+06]
E1 = -706.6871275564315  E_coul = 198.70184714021642
cycle= 5 E= -507.985280416215  delta_E= -1.01e-08  |g|= 1.34e-06  |ddm|= 0.000471
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.22837e-07
diis-c [-9.00773726e-14  2.44936050e-07 -1.72212147e-04  2.19762945e-03
 -2.59442441e-02  1.02391858e+00]
  HOMO = -0.242894831166618  LUMO = 1.0553722578801
  mo_energy =
[-1.20322208e+02 -1.23798595e+01 -6.67723800e+00 -6.67723800e+00
 -6.67723800e+00 -1.17925270e+00 -2.42894831e-01 -2.42894831e-01
 -2.42894831e-01  1.05537226e+00  9.78802824e+00  4.96124035e+01
  1.95537664e+02  7.23092136e+02  2.87022301e+03  1.23378682e+04
  4.09507149e+04  1.04989602e+05  2.30169999e+05  4.55982792e+05
  8.44933440e+05  1.52810916e+06  2.85037467e+06  5.80825954e+06]
E1 = -706.6871235740923  E_coul = 198.7018431578769
cycle= 6 E= -507.985280416215  delta_E= -2.84e-13  |g|= 4.3e-08  |ddm|= 2.98e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6871235740923  E_coul = 198.7018431578769
  HOMO = -0.242894852759466  LUMO = 1.05537224636496
  mo_energy =
[-1.20322208e+02 -1.23798595e+01 -6.67723804e+00 -6.67723804e+00
 -6.67723804e+00 -1.17925271e+00 -2.42894853e-01 -2.42894853e-01
 -2.42894853e-01  1.05537225e+00  9.78802820e+00  4.96124034e+01
  1.95537664e+02  7.23092136e+02  2.87022301e+03  1.23378682e+04
  4.09507149e+04  1.04989602e+05  2.30169999e+05  4.55982792e+05
  8.44933440e+05  1.52810916e+06  2.85037467e+06  5.80825954e+06]
E1 = -706.687123476081  E_coul = 198.70184305986558
Extra cycle  E= -507.985280416215  delta_E= 5.68e-14  |g|= 5.65e-09  |ddm|= 8.16e-08
    CPU time for scf_cycle      1.11 sec, wall time      0.29 sec
exp = [2.47025606e-01 6.47460425e-01 1.17616814e+05 2.88371188e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547136e+04 7.30307146e+03 1.83757964e+04
 1.44900591e+03 3.76223790e+02 1.22345598e+02 4.60857030e+01
 1.78048326e+01 6.99494948e+00 8.60678385e+00 4.92773639e-01]
E = -507.98528041621535
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:16:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247025605565       1
[INPUT] 0    0    [1    /1   ]  0.647460425248       1
[INPUT] 0    0    [1    /1   ]  117616.813771        1
[INPUT] 0    0    [1    /1   ]  2.8837118751         1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031059        1
[INPUT] 0    0    [1    /1   ]  147020.99186         1
[INPUT] 0    0    [1    /1   ]  73510.4197762        1
[INPUT] 0    0    [1    /1   ]  36754.7136127        1
[INPUT] 0    0    [1    /1   ]  7303.07145591        1
[INPUT] 0    0    [1    /1   ]  18375.7964091        1
[INPUT] 0    0    [1    /1   ]  1449.00590604        1
[INPUT] 0    0    [1    /1   ]  376.223790269        1
[INPUT] 0    0    [1    /1   ]  122.345598418        1
[INPUT] 0    0    [1    /1   ]  46.0857030158        1
[INPUT] 0    0    [1    /1   ]  17.8048325605        1
[INPUT] 0    0    [1    /1   ]  6.99494948084        1
[INPUT] 1    0    [1    /1   ]  8.60678384956        1
[INPUT] 1    0    [1    /1   ]  0.49277363901        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24702560556518824, 1.0]], [0, [0.6474604252480634, 1.0]], [0, [117616.81377056199, 1.0]], [0, [2.8837118751001403, 1.0]], [0, [1176168.1426167935, 1.0]], [0, [588084.0699798722, 1.0]], [0, [294042.0310585621, 1.0]], [0, [147020.99186027108, 1.0]], [0, [73510.4197762019, 1.0]], [0, [36754.71361274346, 1.0]], [0, [7303.071455913961, 1.0]], [0, [18375.796409088704, 1.0]], [0, [1449.0059060389299, 1.0]], [0, [376.22379026919776, 1.0]], [0, [122.34559841798304, 1.0]], [0, [46.08570301583592, 1.0]], [0, [17.804832560510416, 1.0]], [0, [6.994949480836695, 1.0]], [1, [8.606783849559104, 1.0]], [1, [0.49277363900959353, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24702561]
bas 1, expnt(s) = [0.64746043]
bas 2, expnt(s) = [117616.81377056]
bas 3, expnt(s) = [2.88371188]
bas 4, expnt(s) = [1176168.14261679]
bas 5, expnt(s) = [588084.06997987]
bas 6, expnt(s) = [294042.03105856]
bas 7, expnt(s) = [147020.99186027]
bas 8, expnt(s) = [73510.4197762]
bas 9, expnt(s) = [36754.71361274]
bas 10, expnt(s) = [7303.07145591]
bas 11, expnt(s) = [18375.79640909]
bas 12, expnt(s) = [1449.00590604]
bas 13, expnt(s) = [376.22379027]
bas 14, expnt(s) = [122.34559842]
bas 15, expnt(s) = [46.08570302]
bas 16, expnt(s) = [17.80483256]
bas 17, expnt(s) = [6.99494948]
bas 18, expnt(s) = [8.60678385]
bas 19, expnt(s) = [0.49277364]
CPU time:      1083.01
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47025606e-01 8.85261350e-01 6.47460425e-01 1.82358052e+00
 1.17616814e+05 1.60460109e+04 2.88371188e+00 5.59086394e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547136e+04 6.70655988e+03
 7.30307146e+03 1.99592486e+03 1.83757964e+04 3.98749042e+03
 1.44900591e+03 5.93359146e+02 3.76223790e+02 2.15823989e+02
 1.22345598e+02 9.29407743e+01 4.60857030e+01 4.46878733e+01
 1.78048326e+01 2.18987056e+01 6.99494948e+00 1.08668447e+01
 8.60678385e+00 4.30066399e+01 4.92773639e-01 1.20446373e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335890337409268
cond(S) = 909216.5971416212
E1 = -689.6100141016381  E_coul = 184.98073978458916
init E= -504.629274317049
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672226393542913  LUMO = 0.676855740934668
  mo_energy =
[-1.21705475e+02 -1.33852887e+01 -7.62297894e+00 -7.62297894e+00
 -7.62297894e+00 -1.65730067e+00 -6.72226394e-01 -6.72226394e-01
 -6.72226394e-01  6.76855741e-01  9.01649468e+00  4.85036624e+01
  1.94221472e+02  7.21730506e+02  2.86893729e+03  1.23367023e+04
  4.09496198e+04  1.04988546e+05  2.30168968e+05  4.55981778e+05
  8.44932440e+05  1.52810817e+06  2.85037369e+06  5.80825857e+06]
E1 = -707.7529400750084  E_coul = 199.78550638500838
cycle= 1 E= -507.96743369  delta_E= -3.34  |g|= 0.451  |ddm|= 0.503
    CPU time for cycle= 1      0.43 sec, wall time      0.03 sec
diis-norm(errvec)=0.701513
diis-c [-0.49212044  1.        ]
  HOMO = -0.217694833589625  LUMO = 1.06205914188582
  mo_energy =
[-1.20196593e+02 -1.23042290e+01 -6.59393210e+00 -6.59393210e+00
 -6.59393210e+00 -1.16316622e+00 -2.17694834e-01 -2.17694834e-01
 -2.17694834e-01  1.06205914e+00  9.83709878e+00  4.96970493e+01
  1.95648287e+02  7.23222004e+02  2.87036941e+03  1.23380254e+04
  4.09508760e+04  1.04989765e+05  2.30170163e+05  4.55982956e+05
  8.44933605e+05  1.52810933e+06  2.85037483e+06  5.80825971e+06]
E1 = -706.809422416316  E_coul = 198.82440316325102
cycle= 2 E= -507.985019253065  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.431
    CPU time for cycle= 2      0.10 sec, wall time      0.03 sec
diis-norm(errvec)=0.0298384
diis-c [-8.90319772e-04  1.34168828e-04  9.99865831e-01]
  HOMO = -0.239613739397374  LUMO = 1.05646178254788
  mo_energy =
[-1.20309954e+02 -1.23709120e+01 -6.66779399e+00 -6.66779399e+00
 -6.66779399e+00 -1.17726759e+00 -2.39613739e-01 -2.39613739e-01
 -2.39613739e-01  1.05646178e+00  9.79431449e+00  4.96218763e+01
  1.95548962e+02  7.23104557e+02  2.87023626e+03  1.23378819e+04
  4.09507288e+04  1.04989616e+05  2.30170013e+05  4.55982806e+05
  8.44933454e+05  1.52810918e+06  2.85037468e+06  5.80825956e+06]
E1 = -706.702904694144  E_coul = 198.71762908703377
cycle= 3 E= -507.98527560711  delta_E= -0.000256  |g|= 0.00437  |ddm|= 0.0602
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.003241
diis-c [-2.25674504e-06  6.29788303e-06 -1.06650694e-01  1.10664440e+00]
  HOMO = -0.242754496481274  LUMO = 1.0554255567602
  mo_energy =
[-1.20321856e+02 -1.23795217e+01 -6.67690265e+00 -6.67690265e+00
 -6.67690265e+00 -1.17916885e+00 -2.42754496e-01 -2.42754496e-01
 -2.42754496e-01  1.05542556e+00  9.78828905e+00  4.96127340e+01
  1.95538010e+02  7.23092489e+02  2.87022337e+03  1.23378685e+04
  4.09507152e+04  1.04989603e+05  2.30170000e+05  4.55982793e+05
  8.44933441e+05  1.52810916e+06  2.85037467e+06  5.80825954e+06]
E1 = -706.6877911217318  E_coul = 198.70251071562788
cycle= 4 E= -507.985280406104  delta_E= -4.8e-06  |g|= 0.000205  |ddm|= 0.00944
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000143744
diis-c [-1.44129898e-10 -7.52386601e-06  7.07530253e-03 -9.89263360e-02
  1.09185856e+00]
  HOMO = -0.242894055235417  LUMO = 1.05537239954715
  mo_energy =
[-1.20322205e+02 -1.23798576e+01 -6.67723611e+00 -6.67723611e+00
 -6.67723611e+00 -1.17925210e+00 -2.42894055e-01 -2.42894055e-01
 -2.42894055e-01  1.05537240e+00  9.78802965e+00  4.96124054e+01
  1.95537666e+02  7.23092139e+02  2.87022301e+03  1.23378682e+04
  4.09507149e+04  1.04989602e+05  2.30169999e+05  4.55982792e+05
  8.44933440e+05  1.52810916e+06  2.85037467e+06  5.80825954e+06]
E1 = -706.6871275564315  E_coul = 198.70184714021642
cycle= 5 E= -507.985280416215  delta_E= -1.01e-08  |g|= 1.34e-06  |ddm|= 0.000471
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.22837e-07
diis-c [-9.00773726e-14  2.44936050e-07 -1.72212147e-04  2.19762945e-03
 -2.59442441e-02  1.02391858e+00]
  HOMO = -0.242894831166618  LUMO = 1.0553722578801
  mo_energy =
[-1.20322208e+02 -1.23798595e+01 -6.67723800e+00 -6.67723800e+00
 -6.67723800e+00 -1.17925270e+00 -2.42894831e-01 -2.42894831e-01
 -2.42894831e-01  1.05537226e+00  9.78802824e+00  4.96124035e+01
  1.95537664e+02  7.23092136e+02  2.87022301e+03  1.23378682e+04
  4.09507149e+04  1.04989602e+05  2.30169999e+05  4.55982792e+05
  8.44933440e+05  1.52810916e+06  2.85037467e+06  5.80825954e+06]
E1 = -706.6871235740923  E_coul = 198.7018431578769
cycle= 6 E= -507.985280416215  delta_E= -2.84e-13  |g|= 4.3e-08  |ddm|= 2.98e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6871235740923  E_coul = 198.7018431578769
  HOMO = -0.242894852759466  LUMO = 1.05537224636496
  mo_energy =
[-1.20322208e+02 -1.23798595e+01 -6.67723804e+00 -6.67723804e+00
 -6.67723804e+00 -1.17925271e+00 -2.42894853e-01 -2.42894853e-01
 -2.42894853e-01  1.05537225e+00  9.78802820e+00  4.96124034e+01
  1.95537664e+02  7.23092136e+02  2.87022301e+03  1.23378682e+04
  4.09507149e+04  1.04989602e+05  2.30169999e+05  4.55982792e+05
  8.44933440e+05  1.52810916e+06  2.85037467e+06  5.80825954e+06]
E1 = -706.687123476081  E_coul = 198.70184305986558
Extra cycle  E= -507.985280416215  delta_E= 5.68e-14  |g|= 5.65e-09  |ddm|= 8.16e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909216.5971416212
E1 = -706.687123476081  E_coul = 198.70184305986558
init E= -507.985280416215
    CPU time for initialize scf      3.46 sec, wall time      0.22 sec
  HOMO = -0.242894855762933  LUMO = 1.05537224571138
  mo_energy =
[-1.20322208e+02 -1.23798595e+01 -6.67723805e+00 -6.67723805e+00
 -6.67723805e+00 -1.17925272e+00 -2.42894856e-01 -2.42894856e-01
 -2.42894856e-01  1.05537225e+00  9.78802819e+00  4.96124034e+01
  1.95537664e+02  7.23092136e+02  2.87022301e+03  1.23378682e+04
  4.09507149e+04  1.04989602e+05  2.30169999e+05  4.55982792e+05
  8.44933440e+05  1.52810916e+06  2.85037467e+06  5.80825954e+06]
E1 = -706.6871234616046  E_coul = 198.701843045389
cycle= 1 E= -507.985280416216  delta_E= -2.84e-13  |g|= 1.67e-09  |ddm|= 1.05e-08
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.6871234616046  E_coul = 198.701843045389
  HOMO = -0.242894856190901  LUMO = 1.05537224623891
  mo_energy =
[-1.20322208e+02 -1.23798595e+01 -6.67723805e+00 -6.67723805e+00
 -6.67723805e+00 -1.17925272e+00 -2.42894856e-01 -2.42894856e-01
 -2.42894856e-01  1.05537225e+00  9.78802819e+00  4.96124034e+01
  1.95537664e+02  7.23092136e+02  2.87022301e+03  1.23378682e+04
  4.09507149e+04  1.04989602e+05  2.30169999e+05  4.55982792e+05
  8.44933440e+05  1.52810916e+06  2.85037467e+06  5.80825954e+06]
E1 = -706.6871234592526  E_coul = 198.70184304303675
Extra cycle  E= -507.985280416216  delta_E= -1.71e-13  |g|= 1.7e-09  |ddm|= 1.67e-09
    CPU time for scf_cycle      3.90 sec, wall time      0.39 sec
exp = [2.47025606e-01 6.47460425e-01 1.17616814e+05 2.88371188e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547136e+04 7.30307146e+03 1.83757964e+04
 1.44900591e+03 3.76223790e+02 1.22345598e+02 4.60857030e+01
 1.78048326e+01 6.99494948e+00 8.60678385e+00 4.92773639e-01]
grad_E = [-2.15387556e-04 -7.27660128e-05  3.77492988e-09  1.11251296e-03
  1.38959674e-11  9.95624145e-11  5.87583259e-10  2.30014042e-09
  9.54100472e-09  5.17892796e-08  3.20930277e-06  1.06818071e-07
  2.67057217e-05 -2.15188944e-04 -4.70141386e-05  8.91796345e-05
 -1.02253064e-04 -4.91034062e-04  2.16491356e-03 -4.90967530e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:16:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.24686366886        1
[INPUT] 0    0    [1    /1   ]  0.646912023176       1
[INPUT] 0    0    [1    /1   ]  117616.813764        1
[INPUT] 0    0    [1    /1   ]  2.87172871781        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031058        1
[INPUT] 0    0    [1    /1   ]  147020.991857        1
[INPUT] 0    0    [1    /1   ]  73510.4197607        1
[INPUT] 0    0    [1    /1   ]  36754.7135282        1
[INPUT] 0    0    [1    /1   ]  7303.06627387        1
[INPUT] 0    0    [1    /1   ]  18375.7962412        1
[INPUT] 0    0    [1    /1   ]  1448.9343521         1
[INPUT] 0    0    [1    /1   ]  376.809030425        1
[INPUT] 0    0    [1    /1   ]  122.187857638        1
[INPUT] 0    0    [1    /1   ]  45.7291274915        1
[INPUT] 0    0    [1    /1   ]  17.3502797918        1
[INPUT] 0    0    [1    /1   ]  6.92323982723        1
[INPUT] 1    0    [1    /1   ]  8.60833087201        1
[INPUT] 1    0    [1    /1   ]  0.492806561751       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2468636688598532, 1.0]], [0, [0.6469120231759448, 1.0]], [0, [117616.81376443048, 1.0]], [0, [2.871728717813586, 1.0]], [0, [1176168.1426167754, 1.0]], [0, [588084.0699797136, 1.0]], [0, [294042.0310576073, 1.0]], [0, [147020.9918565396, 1.0]], [0, [73510.41976074506, 1.0]], [0, [36754.7135281646, 1.0]], [0, [7303.0662738703195, 1.0]], [0, [18375.79624117739, 1.0]], [0, [1448.9343520974903, 1.0]], [0, [376.8090304250561, 1.0]], [0, [122.18785763839901, 1.0]], [0, [45.72912749152657, 1.0]], [0, [17.35027979180674, 1.0]], [0, [6.923239827231053, 1.0]], [1, [8.608330872005023, 1.0]], [1, [0.49280656175059545, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24686367]
bas 1, expnt(s) = [0.64691202]
bas 2, expnt(s) = [117616.81376443]
bas 3, expnt(s) = [2.87172872]
bas 4, expnt(s) = [1176168.14261678]
bas 5, expnt(s) = [588084.06997971]
bas 6, expnt(s) = [294042.03105761]
bas 7, expnt(s) = [147020.99185654]
bas 8, expnt(s) = [73510.41976075]
bas 9, expnt(s) = [36754.71352816]
bas 10, expnt(s) = [7303.06627387]
bas 11, expnt(s) = [18375.79624118]
bas 12, expnt(s) = [1448.9343521]
bas 13, expnt(s) = [376.80903043]
bas 14, expnt(s) = [122.18785764]
bas 15, expnt(s) = [45.72912749]
bas 16, expnt(s) = [17.35027979]
bas 17, expnt(s) = [6.92323983]
bas 18, expnt(s) = [8.60833087]
bas 19, expnt(s) = [0.49280656]
CPU time:      1095.08
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.46863669e-01 8.84826067e-01 6.46912023e-01 1.82242197e+00
 1.17616814e+05 1.60460109e+04 2.87172872e+00 5.57343041e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547135e+04 6.70655987e+03
 7.30306627e+03 1.99592379e+03 1.83757962e+04 3.98749039e+03
 1.44893435e+03 5.93337170e+02 3.76809030e+02 2.16075736e+02
 1.22187858e+02 9.28508881e+01 4.57291275e+01 4.44283015e+01
 1.73502798e+01 2.14780518e+01 6.92323983e+00 1.07831850e+01
 8.60833087e+00 4.30163029e+01 4.92806562e-01 1.20456432e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335842321405693
cond(S) = 909187.1103325728
E1 = -689.6173504508539  E_coul = 184.98865910308976
init E= -504.628691347764
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672205978706172  LUMO = 0.675414191715
  mo_energy =
[-1.21703955e+02 -1.33846657e+01 -7.62242799e+00 -7.62242799e+00
 -7.62242799e+00 -1.65725491e+00 -6.72205979e-01 -6.72205979e-01
 -6.72205979e-01  6.75414192e-01  8.91679126e+00  4.75597022e+01
  1.91569008e+02  7.18414307e+02  2.86667312e+03  1.23351086e+04
  4.09481831e+04  1.04987169e+05  2.30167629e+05  4.55980467e+05
  8.44931150e+05  1.52810690e+06  2.85037245e+06  5.80825736e+06]
E1 = -707.7628688718606  E_coul = 199.79538197519383
cycle= 1 E= -507.967486896667  delta_E= -3.34  |g|= 0.451  |ddm|= 0.504
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.700623
diis-c [-0.4908728  1.       ]
  HOMO = -0.21761585953873  LUMO = 1.06019196783818
  mo_energy =
[-1.20194876e+02 -1.23034730e+01 -6.59322843e+00 -6.59322843e+00
 -6.59322843e+00 -1.16308142e+00 -2.17615860e-01 -2.17615860e-01
 -2.17615860e-01  1.06019197e+00  9.73331684e+00  4.87478427e+01
  1.92994782e+02  7.19905990e+02  2.86810541e+03  1.23364318e+04
  4.09494395e+04  1.04988389e+05  2.30168824e+05  4.55981645e+05
  8.44932315e+05  1.52810806e+06  2.85037359e+06  5.80825850e+06]
E1 = -706.8188704918944  E_coul = 198.8337865105753
cycle= 2 E= -507.985083981319  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.431
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0298698
diis-c [-8.92204378e-04 -8.01857624e-05  1.00008019e+00]
  HOMO = -0.23954936633473  LUMO = 1.05461680080863
  mo_energy =
[-1.20308312e+02 -1.23702077e+01 -6.66714712e+00 -6.66714712e+00
 -6.66714712e+00 -1.17719093e+00 -2.39549366e-01 -2.39549366e-01
 -2.39549366e-01  1.05461680e+00  9.69079082e+00  4.86730493e+01
  1.92895536e+02  7.19788458e+02  2.86797216e+03  1.23362883e+04
  4.09492922e+04  1.04988240e+05  2.30168675e+05  4.55981495e+05
  8.44932164e+05  1.52810791e+06  2.85037344e+06  5.80825835e+06]
E1 = -706.7122867732629  E_coul = 198.72694630357762
cycle= 3 E= -507.985340469685  delta_E= -0.000256  |g|= 0.00436  |ddm|= 0.0602
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324047
diis-c [-2.26847322e-06  1.35259892e-05 -1.06426498e-01  1.10641297e+00]
  HOMO = -0.24268674416639  LUMO = 1.05358499294095
  mo_energy =
[-1.20320194e+02 -1.23788059e+01 -6.67624304e+00 -6.67624304e+00
 -6.67624304e+00 -1.17908982e+00 -2.42686744e-01 -2.42686744e-01
 -2.42686744e-01  1.05358499e+00  9.68480541e+00  4.86639561e+01
  1.92884613e+02  7.19776410e+02  2.86795930e+03  1.23362749e+04
  4.09492786e+04  1.04988226e+05  2.30168661e+05  4.55981482e+05
  8.44932151e+05  1.52810789e+06  2.85037343e+06  5.80825833e+06]
E1 = -706.6971901678713  E_coul = 198.7118449069493
cycle= 4 E= -507.985345260922  delta_E= -4.79e-06  |g|= 0.000206  |ddm|= 0.00943
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000144158
diis-c [-1.45827083e-10 -7.50408336e-06  7.04700150e-03 -9.88985964e-02
  1.09185910e+00]
  HOMO = -0.24282663518185  LUMO = 1.05353186365121
  mo_energy =
[-1.20320544e+02 -1.23791424e+01 -6.67657708e+00 -6.67657708e+00
 -6.67657708e+00 -1.17917329e+00 -2.42826635e-01 -2.42826635e-01
 -2.42826635e-01  1.05353186e+00  9.68454656e+00  4.86636273e+01
  1.92884268e+02  7.19776059e+02  2.86795894e+03  1.23362746e+04
  4.09492783e+04  1.04988226e+05  2.30168661e+05  4.55981481e+05
  8.44932150e+05  1.52810789e+06  2.85037343e+06  5.80825833e+06]
E1 = -706.6965250593206  E_coul = 198.71117978822053
cycle= 5 E= -507.9853452711  delta_E= -1.02e-08  |g|= 1.38e-06  |ddm|= 0.000473
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.41954e-07
diis-c [-9.78491097e-14  2.52135334e-07 -1.78850657e-04  2.29728909e-03
 -2.71118723e-02  1.02499318e+00]
  HOMO = -0.242827435458621  LUMO = 1.05353171346506
  mo_energy =
[-1.20320547e+02 -1.23791443e+01 -6.67657902e+00 -6.67657902e+00
 -6.67657902e+00 -1.17917391e+00 -2.42827435e-01 -2.42827435e-01
 -2.42827435e-01  1.05353171e+00  9.68454511e+00  4.86636254e+01
  1.92884265e+02  7.19776056e+02  2.86795894e+03  1.23362746e+04
  4.09492783e+04  1.04988226e+05  2.30168661e+05  4.55981481e+05
  8.44932150e+05  1.52810789e+06  2.85037343e+06  5.80825833e+06]
E1 = -706.6965209603268  E_coul = 198.7111756892263
cycle= 6 E= -507.9853452711  delta_E= -3.98e-13  |g|= 4.43e-08  |ddm|= 3.1e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6965209603268  E_coul = 198.7111756892263
  HOMO = -0.242827457881458  LUMO = 1.05353170090688
  mo_energy =
[-1.20320547e+02 -1.23791443e+01 -6.67657907e+00 -6.67657907e+00
 -6.67657907e+00 -1.17917392e+00 -2.42827458e-01 -2.42827458e-01
 -2.42827458e-01  1.05353170e+00  9.68454507e+00  4.86636254e+01
  1.92884265e+02  7.19776056e+02  2.86795894e+03  1.23362746e+04
  4.09492783e+04  1.04988226e+05  2.30168661e+05  4.55981481e+05
  8.44932150e+05  1.52810789e+06  2.85037343e+06  5.80825833e+06]
E1 = -706.6965208582268  E_coul = 198.71117558712675
Extra cycle  E= -507.9853452711  delta_E= 3.98e-13  |g|= 5.3e-09  |ddm|= 8.53e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.46863669e-01 6.46912023e-01 1.17616814e+05 2.87172872e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547135e+04 7.30306627e+03 1.83757962e+04
 1.44893435e+03 3.76809030e+02 1.22187858e+02 4.57291275e+01
 1.73502798e+01 6.92323983e+00 8.60833087e+00 4.92806562e-01]
E = -507.9853452711001
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:16:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.24686366886        1
[INPUT] 0    0    [1    /1   ]  0.646912023176       1
[INPUT] 0    0    [1    /1   ]  117616.813764        1
[INPUT] 0    0    [1    /1   ]  2.87172871781        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06998         1
[INPUT] 0    0    [1    /1   ]  294042.031058        1
[INPUT] 0    0    [1    /1   ]  147020.991857        1
[INPUT] 0    0    [1    /1   ]  73510.4197607        1
[INPUT] 0    0    [1    /1   ]  36754.7135282        1
[INPUT] 0    0    [1    /1   ]  7303.06627387        1
[INPUT] 0    0    [1    /1   ]  18375.7962412        1
[INPUT] 0    0    [1    /1   ]  1448.9343521         1
[INPUT] 0    0    [1    /1   ]  376.809030425        1
[INPUT] 0    0    [1    /1   ]  122.187857638        1
[INPUT] 0    0    [1    /1   ]  45.7291274915        1
[INPUT] 0    0    [1    /1   ]  17.3502797918        1
[INPUT] 0    0    [1    /1   ]  6.92323982723        1
[INPUT] 1    0    [1    /1   ]  8.60833087201        1
[INPUT] 1    0    [1    /1   ]  0.492806561751       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2468636688598532, 1.0]], [0, [0.6469120231759448, 1.0]], [0, [117616.81376443048, 1.0]], [0, [2.871728717813586, 1.0]], [0, [1176168.1426167754, 1.0]], [0, [588084.0699797136, 1.0]], [0, [294042.0310576073, 1.0]], [0, [147020.9918565396, 1.0]], [0, [73510.41976074506, 1.0]], [0, [36754.7135281646, 1.0]], [0, [7303.0662738703195, 1.0]], [0, [18375.79624117739, 1.0]], [0, [1448.9343520974903, 1.0]], [0, [376.8090304250561, 1.0]], [0, [122.18785763839901, 1.0]], [0, [45.72912749152657, 1.0]], [0, [17.35027979180674, 1.0]], [0, [6.923239827231053, 1.0]], [1, [8.608330872005023, 1.0]], [1, [0.49280656175059545, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24686367]
bas 1, expnt(s) = [0.64691202]
bas 2, expnt(s) = [117616.81376443]
bas 3, expnt(s) = [2.87172872]
bas 4, expnt(s) = [1176168.14261678]
bas 5, expnt(s) = [588084.06997971]
bas 6, expnt(s) = [294042.03105761]
bas 7, expnt(s) = [147020.99185654]
bas 8, expnt(s) = [73510.41976075]
bas 9, expnt(s) = [36754.71352816]
bas 10, expnt(s) = [7303.06627387]
bas 11, expnt(s) = [18375.79624118]
bas 12, expnt(s) = [1448.9343521]
bas 13, expnt(s) = [376.80903043]
bas 14, expnt(s) = [122.18785764]
bas 15, expnt(s) = [45.72912749]
bas 16, expnt(s) = [17.35027979]
bas 17, expnt(s) = [6.92323983]
bas 18, expnt(s) = [8.60833087]
bas 19, expnt(s) = [0.49280656]
CPU time:      1096.71
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.46863669e-01 8.84826067e-01 6.46912023e-01 1.82242197e+00
 1.17616814e+05 1.60460109e+04 2.87172872e+00 5.57343041e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104198e+04 1.12791585e+04 3.67547135e+04 6.70655987e+03
 7.30306627e+03 1.99592379e+03 1.83757962e+04 3.98749039e+03
 1.44893435e+03 5.93337170e+02 3.76809030e+02 2.16075736e+02
 1.22187858e+02 9.28508881e+01 4.57291275e+01 4.44283015e+01
 1.73502798e+01 2.14780518e+01 6.92323983e+00 1.07831850e+01
 8.60833087e+00 4.30163029e+01 4.92806562e-01 1.20456432e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335842321405693
cond(S) = 909187.1103325728
E1 = -689.6173504508539  E_coul = 184.98865910308976
init E= -504.628691347764
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672205978706172  LUMO = 0.675414191715
  mo_energy =
[-1.21703955e+02 -1.33846657e+01 -7.62242799e+00 -7.62242799e+00
 -7.62242799e+00 -1.65725491e+00 -6.72205979e-01 -6.72205979e-01
 -6.72205979e-01  6.75414192e-01  8.91679126e+00  4.75597022e+01
  1.91569008e+02  7.18414307e+02  2.86667312e+03  1.23351086e+04
  4.09481831e+04  1.04987169e+05  2.30167629e+05  4.55980467e+05
  8.44931150e+05  1.52810690e+06  2.85037245e+06  5.80825736e+06]
E1 = -707.7628688718606  E_coul = 199.79538197519383
cycle= 1 E= -507.967486896667  delta_E= -3.34  |g|= 0.451  |ddm|= 0.504
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.700623
diis-c [-0.4908728  1.       ]
  HOMO = -0.21761585953873  LUMO = 1.06019196783818
  mo_energy =
[-1.20194876e+02 -1.23034730e+01 -6.59322843e+00 -6.59322843e+00
 -6.59322843e+00 -1.16308142e+00 -2.17615860e-01 -2.17615860e-01
 -2.17615860e-01  1.06019197e+00  9.73331684e+00  4.87478427e+01
  1.92994782e+02  7.19905990e+02  2.86810541e+03  1.23364318e+04
  4.09494395e+04  1.04988389e+05  2.30168824e+05  4.55981645e+05
  8.44932315e+05  1.52810806e+06  2.85037359e+06  5.80825850e+06]
E1 = -706.8188704918944  E_coul = 198.8337865105753
cycle= 2 E= -507.985083981319  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.431
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0298698
diis-c [-8.92204378e-04 -8.01857624e-05  1.00008019e+00]
  HOMO = -0.23954936633473  LUMO = 1.05461680080863
  mo_energy =
[-1.20308312e+02 -1.23702077e+01 -6.66714712e+00 -6.66714712e+00
 -6.66714712e+00 -1.17719093e+00 -2.39549366e-01 -2.39549366e-01
 -2.39549366e-01  1.05461680e+00  9.69079082e+00  4.86730493e+01
  1.92895536e+02  7.19788458e+02  2.86797216e+03  1.23362883e+04
  4.09492922e+04  1.04988240e+05  2.30168675e+05  4.55981495e+05
  8.44932164e+05  1.52810791e+06  2.85037344e+06  5.80825835e+06]
E1 = -706.7122867732629  E_coul = 198.72694630357762
cycle= 3 E= -507.985340469685  delta_E= -0.000256  |g|= 0.00436  |ddm|= 0.0602
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00324047
diis-c [-2.26847322e-06  1.35259892e-05 -1.06426498e-01  1.10641297e+00]
  HOMO = -0.24268674416639  LUMO = 1.05358499294095
  mo_energy =
[-1.20320194e+02 -1.23788059e+01 -6.67624304e+00 -6.67624304e+00
 -6.67624304e+00 -1.17908982e+00 -2.42686744e-01 -2.42686744e-01
 -2.42686744e-01  1.05358499e+00  9.68480541e+00  4.86639561e+01
  1.92884613e+02  7.19776410e+02  2.86795930e+03  1.23362749e+04
  4.09492786e+04  1.04988226e+05  2.30168661e+05  4.55981482e+05
  8.44932151e+05  1.52810789e+06  2.85037343e+06  5.80825833e+06]
E1 = -706.6971901678713  E_coul = 198.7118449069493
cycle= 4 E= -507.985345260922  delta_E= -4.79e-06  |g|= 0.000206  |ddm|= 0.00943
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000144158
diis-c [-1.45827083e-10 -7.50408336e-06  7.04700150e-03 -9.88985964e-02
  1.09185910e+00]
  HOMO = -0.24282663518185  LUMO = 1.05353186365121
  mo_energy =
[-1.20320544e+02 -1.23791424e+01 -6.67657708e+00 -6.67657708e+00
 -6.67657708e+00 -1.17917329e+00 -2.42826635e-01 -2.42826635e-01
 -2.42826635e-01  1.05353186e+00  9.68454656e+00  4.86636273e+01
  1.92884268e+02  7.19776059e+02  2.86795894e+03  1.23362746e+04
  4.09492783e+04  1.04988226e+05  2.30168661e+05  4.55981481e+05
  8.44932150e+05  1.52810789e+06  2.85037343e+06  5.80825833e+06]
E1 = -706.6965250593206  E_coul = 198.71117978822053
cycle= 5 E= -507.9853452711  delta_E= -1.02e-08  |g|= 1.38e-06  |ddm|= 0.000473
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.41954e-07
diis-c [-9.78491097e-14  2.52135334e-07 -1.78850657e-04  2.29728909e-03
 -2.71118723e-02  1.02499318e+00]
  HOMO = -0.242827435458621  LUMO = 1.05353171346506
  mo_energy =
[-1.20320547e+02 -1.23791443e+01 -6.67657902e+00 -6.67657902e+00
 -6.67657902e+00 -1.17917391e+00 -2.42827435e-01 -2.42827435e-01
 -2.42827435e-01  1.05353171e+00  9.68454511e+00  4.86636254e+01
  1.92884265e+02  7.19776056e+02  2.86795894e+03  1.23362746e+04
  4.09492783e+04  1.04988226e+05  2.30168661e+05  4.55981481e+05
  8.44932150e+05  1.52810789e+06  2.85037343e+06  5.80825833e+06]
E1 = -706.6965209603268  E_coul = 198.7111756892263
cycle= 6 E= -507.9853452711  delta_E= -3.98e-13  |g|= 4.43e-08  |ddm|= 3.1e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6965209603268  E_coul = 198.7111756892263
  HOMO = -0.242827457881458  LUMO = 1.05353170090688
  mo_energy =
[-1.20320547e+02 -1.23791443e+01 -6.67657907e+00 -6.67657907e+00
 -6.67657907e+00 -1.17917392e+00 -2.42827458e-01 -2.42827458e-01
 -2.42827458e-01  1.05353170e+00  9.68454507e+00  4.86636254e+01
  1.92884265e+02  7.19776056e+02  2.86795894e+03  1.23362746e+04
  4.09492783e+04  1.04988226e+05  2.30168661e+05  4.55981481e+05
  8.44932150e+05  1.52810789e+06  2.85037343e+06  5.80825833e+06]
E1 = -706.6965208582268  E_coul = 198.71117558712675
Extra cycle  E= -507.9853452711  delta_E= 3.98e-13  |g|= 5.3e-09  |ddm|= 8.53e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909187.1103325728
E1 = -706.6965208582268  E_coul = 198.71117558712675
init E= -507.9853452711
    CPU time for initialize scf      3.40 sec, wall time      0.22 sec
  HOMO = -0.242827461006746  LUMO = 1.05353170007012
  mo_energy =
[-1.20320547e+02 -1.23791443e+01 -6.67657907e+00 -6.67657907e+00
 -6.67657907e+00 -1.17917393e+00 -2.42827461e-01 -2.42827461e-01
 -2.42827461e-01  1.05353170e+00  9.68454507e+00  4.86636254e+01
  1.92884265e+02  7.19776056e+02  2.86795894e+03  1.23362746e+04
  4.09492783e+04  1.04988226e+05  2.30168661e+05  4.55981481e+05
  8.44932150e+05  1.52810789e+06  2.85037343e+06  5.80825833e+06]
E1 = -706.696520843291  E_coul = 198.71117557219083
cycle= 1 E= -507.9853452711  delta_E= -5.68e-14  |g|= 1.4e-09  |ddm|= 1.08e-08
    CPU time for cycle= 1      0.29 sec, wall time      0.03 sec
E1 = -706.696520843291  E_coul = 198.71117557219083
  HOMO = -0.242827461447606  LUMO = 1.05353169963808
  mo_energy =
[-1.20320547e+02 -1.23791443e+01 -6.67657908e+00 -6.67657908e+00
 -6.67657908e+00 -1.17917393e+00 -2.42827461e-01 -2.42827461e-01
 -2.42827461e-01  1.05353170e+00  9.68454507e+00  4.86636254e+01
  1.92884265e+02  7.19776056e+02  2.86795894e+03  1.23362746e+04
  4.09492783e+04  1.04988226e+05  2.30168661e+05  4.55981481e+05
  8.44932150e+05  1.52810789e+06  2.85037343e+06  5.80825833e+06]
E1 = -706.696520842059  E_coul = 198.71117557095823
Extra cycle  E= -507.985345271101  delta_E= -6.82e-13  |g|= 1.87e-09  |ddm|= 9.26e-10
    CPU time for scf_cycle      3.84 sec, wall time      0.39 sec
exp = [2.46863669e-01 6.46912023e-01 1.17616814e+05 2.87172872e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104198e+04 3.67547135e+04 7.30306627e+03 1.83757962e+04
 1.44893435e+03 3.76809030e+02 1.22187858e+02 4.57291275e+01
 1.73502798e+01 6.92323983e+00 8.60833087e+00 4.92806562e-01]
grad_E = [-3.51505275e-04 -7.21016127e-05  3.84382006e-09  1.72998081e-03
  1.47263275e-11  1.01793335e-10  5.98273696e-10  2.34269286e-09
  9.72017769e-09  5.26763801e-08  3.27190588e-06  1.09467234e-07
  2.37495350e-05 -1.96480206e-04 -7.11449265e-05  1.12684324e-04
 -1.19985587e-04 -7.94274286e-04  3.44130640e-03 -7.72025055e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:16:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.246703119435       1
[INPUT] 0    0    [1    /1   ]  0.646055760762       1
[INPUT] 0    0    [1    /1   ]  117616.813744        1
[INPUT] 0    0    [1    /1   ]  2.85943910149        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069979        1
[INPUT] 0    0    [1    /1   ]  294042.031054        1
[INPUT] 0    0    [1    /1   ]  147020.991844        1
[INPUT] 0    0    [1    /1   ]  73510.4197097        1
[INPUT] 0    0    [1    /1   ]  36754.7132504        1
[INPUT] 0    0    [1    /1   ]  7303.04912881        1
[INPUT] 0    0    [1    /1   ]  18375.7956761        1
[INPUT] 0    0    [1    /1   ]  1448.75818655        1
[INPUT] 0    0    [1    /1   ]  378.204418833        1
[INPUT] 0    0    [1    /1   ]  122.257892583        1
[INPUT] 0    0    [1    /1   ]  45.3615433184        1
[INPUT] 0    0    [1    /1   ]  16.7572824044        1
[INPUT] 0    0    [1    /1   ]  6.83230484651        1
[INPUT] 1    0    [1    /1   ]  8.61044201694        1
[INPUT] 1    0    [1    /1   ]  0.492850390005       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24670311943481285, 1.0]], [0, [0.6460557607616794, 1.0]], [0, [117616.81374422154, 1.0]], [0, [2.859439101487759, 1.0]], [0, [1176168.1426167064, 1.0]], [0, [588084.0699791845, 1.0]], [0, [294042.0310544613, 1.0]], [0, [147020.99184423144, 1.0]], [0, [73510.41970971665, 1.0]], [0, [36754.71325035249, 1.0]], [0, [7303.049128808792, 1.0]], [0, [18375.795676119233, 1.0]], [0, [1448.7581865538536, 1.0]], [0, [378.2044188330282, 1.0]], [0, [122.25789258343423, 1.0]], [0, [45.36154331843542, 1.0]], [0, [16.757282404390043, 1.0]], [0, [6.832304846508715, 1.0]], [1, [8.610442016937451, 1.0]], [1, [0.49285039000484004, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24670312]
bas 1, expnt(s) = [0.64605576]
bas 2, expnt(s) = [117616.81374422]
bas 3, expnt(s) = [2.8594391]
bas 4, expnt(s) = [1176168.14261671]
bas 5, expnt(s) = [588084.06997918]
bas 6, expnt(s) = [294042.03105446]
bas 7, expnt(s) = [147020.99184423]
bas 8, expnt(s) = [73510.41970972]
bas 9, expnt(s) = [36754.71325035]
bas 10, expnt(s) = [7303.04912881]
bas 11, expnt(s) = [18375.79567612]
bas 12, expnt(s) = [1448.75818655]
bas 13, expnt(s) = [378.20441883]
bas 14, expnt(s) = [122.25789258]
bas 15, expnt(s) = [45.36154332]
bas 16, expnt(s) = [16.7572824]
bas 17, expnt(s) = [6.83230485]
bas 18, expnt(s) = [8.61044202]
bas 19, expnt(s) = [0.49285039]
CPU time:      1108.81
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.46703119e-01 8.84394443e-01 6.46055761e-01 1.82061253e+00
 1.17616814e+05 1.60460109e+04 2.85943910e+00 5.55553212e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104197e+04 1.12791585e+04 3.67547133e+04 6.70655983e+03
 7.30304913e+03 1.99592028e+03 1.83757957e+04 3.98749030e+03
 1.44875819e+03 5.93283065e+02 3.78204419e+02 2.16675583e+02
 1.22257893e+02 9.28908000e+01 4.53615433e+01 4.41601857e+01
 1.67572824e+01 2.09251084e+01 6.83230485e+00 1.06767839e+01
 8.61044202e+00 4.30294902e+01 4.92850390e-01 1.20469823e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335776033386992
cond(S) = 909179.8946210108
E1 = -689.626953649103  E_coul = 184.99941855407891
init E= -504.627535095024
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672180315876539  LUMO = 0.673655338407883
  mo_energy =
[-1.21701925e+02 -1.33838129e+01 -7.62167880e+00 -7.62167880e+00
 -7.62167880e+00 -1.65719667e+00 -6.72180316e-01 -6.72180316e-01
 -6.72180316e-01  6.73655338e-01  8.79583447e+00  4.63717058e+01
  1.88444560e+02  7.15597879e+02  2.86677127e+03  1.23363226e+04
  4.09494238e+04  1.04988364e+05  2.30168788e+05  4.55981600e+05
  8.44932264e+05  1.52810800e+06  2.85037352e+06  5.80825841e+06]
E1 = -707.7765407395656  E_coul = 199.80891188523586
cycle= 1 E= -507.96762885433  delta_E= -3.34  |g|= 0.451  |ddm|= 0.505
    CPU time for cycle= 1      0.39 sec, wall time      0.03 sec
diis-norm(errvec)=0.699306
diis-c [-0.4890287  1.       ]
  HOMO = -0.217508404499238  LUMO = 1.05791607356987
  mo_energy =
[-1.20192559e+02 -1.23024319e+01 -6.59226414e+00 -6.59226414e+00
 -6.59226414e+00 -1.16296697e+00 -2.17508404e-01 -2.17508404e-01
 -2.17508404e-01  1.05791607e+00  9.60726873e+00  4.75530381e+01
  1.89869236e+02  7.17089851e+02  2.86820382e+03  1.23376462e+04
  4.09506806e+04  1.04989584e+05  2.30169983e+05  4.55982779e+05
  8.44933429e+05  1.52810915e+06  2.85037467e+06  5.80825954e+06]
E1 = -706.8319563906663  E_coul = 198.84671635187354
cycle= 2 E= -507.985240038793  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.43
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0298977
diis-c [-8.93814439e-04 -3.51038148e-04  1.00035104e+00]
  HOMO = -0.239460545757227  LUMO = 1.05236806326971
  mo_energy =
[-1.20306088e+02 -1.23692303e+01 -6.66625256e+00 -6.66625256e+00
 -6.66625256e+00 -1.17708699e+00 -2.39460546e-01 -2.39460546e-01
 -2.39460546e-01  1.05236806e+00  9.56506495e+00  4.74787383e+01
  1.89770066e+02  7.16972191e+02  2.86807045e+03  1.23375026e+04
  4.09505331e+04  1.04989435e+05  2.30169834e+05  4.55982628e+05
  8.44933279e+05  1.52810900e+06  2.85037451e+06  5.80825939e+06]
E1 = -706.7252888621574  E_coul = 198.73979216458412
cycle= 3 E= -507.985496697573  delta_E= -0.000257  |g|= 0.00436  |ddm|= 0.0602
    CPU time for cycle= 3      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.00323844
diis-c [-2.28108627e-06  2.24374106e-05 -1.06145065e-01  1.10612263e+00]
  HOMO = -0.242593658065777  LUMO = 1.05134171218213
  mo_energy =
[-1.20317944e+02 -1.23778141e+01 -6.67533244e+00 -6.67533244e+00
 -6.67533244e+00 -1.17898287e+00 -2.42593658e-01 -2.42593658e-01
 -2.42593658e-01  1.05134171e+00  9.55912943e+00  4.74697082e+01
  1.89759177e+02  7.16960168e+02  2.86805761e+03  1.23374893e+04
  4.09505196e+04  1.04989421e+05  2.30169820e+05  4.55982615e+05
  8.44933265e+05  1.52810899e+06  2.85037450e+06  5.80825938e+06]
E1 = -706.7102137010929  E_coul = 198.72471222233943
cycle= 4 E= -507.985501478753  delta_E= -4.78e-06  |g|= 0.000207  |ddm|= 0.00942
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000144606
diis-c [-1.47586801e-10 -7.48209098e-06  7.01168478e-03 -9.88627194e-02
  1.09185852e+00]
  HOMO = -0.242733946147763  LUMO = 1.05128862494885
  mo_energy =
[-1.20318295e+02 -1.23781513e+01 -6.67566719e+00 -6.67566719e+00
 -6.67566719e+00 -1.17906661e+00 -2.42733946e-01 -2.42733946e-01
 -2.42733946e-01  1.05128862e+00  9.55887129e+00  4.74693794e+01
  1.89758831e+02  7.16959816e+02  2.86805726e+03  1.23374889e+04
  4.09505193e+04  1.04989421e+05  2.30169820e+05  4.55982614e+05
  8.44933265e+05  1.52810899e+06  2.85037450e+06  5.80825938e+06]
E1 = -706.7095467437258  E_coul = 198.72404525471458
cycle= 5 E= -507.985501489011  delta_E= -1.03e-08  |g|= 1.45e-06  |ddm|= 0.000476
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.63613e-07
diis-c [-1.07941528e-13  2.55262637e-07 -1.86729550e-04  2.41815960e-03
 -2.85312686e-02  1.02629958e+00]
  HOMO = -0.242734775785691  LUMO = 1.05128846217932
  mo_energy =
[-1.20318298e+02 -1.23781532e+01 -6.67566918e+00 -6.67566918e+00
 -6.67566918e+00 -1.17906725e+00 -2.42734776e-01 -2.42734776e-01
 -2.42734776e-01  1.05128846e+00  9.55886980e+00  4.74693774e+01
  1.89758829e+02  7.16959814e+02  2.86805725e+03  1.23374889e+04
  4.09505193e+04  1.04989421e+05  2.30169820e+05  4.55982614e+05
  8.44933265e+05  1.52810899e+06  2.85037450e+06  5.80825938e+06]
E1 = -706.709542504518  E_coul = 198.72404101550654
cycle= 6 E= -507.985501489011  delta_E= -2.84e-13  |g|= 4.63e-08  |ddm|= 3.23e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.709542504518  E_coul = 198.72404101550654
  HOMO = -0.242734799206348  LUMO = 1.05128844677473
  mo_energy =
[-1.20318298e+02 -1.23781532e+01 -6.67566923e+00 -6.67566923e+00
 -6.67566923e+00 -1.17906726e+00 -2.42734799e-01 -2.42734799e-01
 -2.42734799e-01  1.05128845e+00  9.55886976e+00  4.74693773e+01
  1.89758829e+02  7.16959814e+02  2.86805725e+03  1.23374889e+04
  4.09505193e+04  1.04989421e+05  2.30169820e+05  4.55982614e+05
  8.44933265e+05  1.52810899e+06  2.85037450e+06  5.80825938e+06]
E1 = -706.709542399775  E_coul = 198.72404091076353
Extra cycle  E= -507.985501489012  delta_E= -5.68e-14  |g|= 6.17e-09  |ddm|= 8.83e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.28 sec
exp = [2.46703119e-01 6.46055761e-01 1.17616814e+05 2.85943910e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104197e+04 3.67547133e+04 7.30304913e+03 1.83757957e+04
 1.44875819e+03 3.78204419e+02 1.22257893e+02 4.53615433e+01
 1.67572824e+01 6.83230485e+00 8.61044202e+00 4.92850390e-01]
E = -507.98550148901154
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:16:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.246703119435       1
[INPUT] 0    0    [1    /1   ]  0.646055760762       1
[INPUT] 0    0    [1    /1   ]  117616.813744        1
[INPUT] 0    0    [1    /1   ]  2.85943910149        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069979        1
[INPUT] 0    0    [1    /1   ]  294042.031054        1
[INPUT] 0    0    [1    /1   ]  147020.991844        1
[INPUT] 0    0    [1    /1   ]  73510.4197097        1
[INPUT] 0    0    [1    /1   ]  36754.7132504        1
[INPUT] 0    0    [1    /1   ]  7303.04912881        1
[INPUT] 0    0    [1    /1   ]  18375.7956761        1
[INPUT] 0    0    [1    /1   ]  1448.75818655        1
[INPUT] 0    0    [1    /1   ]  378.204418833        1
[INPUT] 0    0    [1    /1   ]  122.257892583        1
[INPUT] 0    0    [1    /1   ]  45.3615433184        1
[INPUT] 0    0    [1    /1   ]  16.7572824044        1
[INPUT] 0    0    [1    /1   ]  6.83230484651        1
[INPUT] 1    0    [1    /1   ]  8.61044201694        1
[INPUT] 1    0    [1    /1   ]  0.492850390005       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24670311943481285, 1.0]], [0, [0.6460557607616794, 1.0]], [0, [117616.81374422154, 1.0]], [0, [2.859439101487759, 1.0]], [0, [1176168.1426167064, 1.0]], [0, [588084.0699791845, 1.0]], [0, [294042.0310544613, 1.0]], [0, [147020.99184423144, 1.0]], [0, [73510.41970971665, 1.0]], [0, [36754.71325035249, 1.0]], [0, [7303.049128808792, 1.0]], [0, [18375.795676119233, 1.0]], [0, [1448.7581865538536, 1.0]], [0, [378.2044188330282, 1.0]], [0, [122.25789258343423, 1.0]], [0, [45.36154331843542, 1.0]], [0, [16.757282404390043, 1.0]], [0, [6.832304846508715, 1.0]], [1, [8.610442016937451, 1.0]], [1, [0.49285039000484004, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24670312]
bas 1, expnt(s) = [0.64605576]
bas 2, expnt(s) = [117616.81374422]
bas 3, expnt(s) = [2.8594391]
bas 4, expnt(s) = [1176168.14261671]
bas 5, expnt(s) = [588084.06997918]
bas 6, expnt(s) = [294042.03105446]
bas 7, expnt(s) = [147020.99184423]
bas 8, expnt(s) = [73510.41970972]
bas 9, expnt(s) = [36754.71325035]
bas 10, expnt(s) = [7303.04912881]
bas 11, expnt(s) = [18375.79567612]
bas 12, expnt(s) = [1448.75818655]
bas 13, expnt(s) = [378.20441883]
bas 14, expnt(s) = [122.25789258]
bas 15, expnt(s) = [45.36154332]
bas 16, expnt(s) = [16.7572824]
bas 17, expnt(s) = [6.83230485]
bas 18, expnt(s) = [8.61044202]
bas 19, expnt(s) = [0.49285039]
CPU time:      1110.44
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.46703119e-01 8.84394443e-01 6.46055761e-01 1.82061253e+00
 1.17616814e+05 1.60460109e+04 2.85943910e+00 5.55553212e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104197e+04 1.12791585e+04 3.67547133e+04 6.70655983e+03
 7.30304913e+03 1.99592028e+03 1.83757957e+04 3.98749030e+03
 1.44875819e+03 5.93283065e+02 3.78204419e+02 2.16675583e+02
 1.22257893e+02 9.28908000e+01 4.53615433e+01 4.41601857e+01
 1.67572824e+01 2.09251084e+01 6.83230485e+00 1.06767839e+01
 8.61044202e+00 4.30294902e+01 4.92850390e-01 1.20469823e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335776033386992
cond(S) = 909179.8946210108
E1 = -689.626953649103  E_coul = 184.99941855407891
init E= -504.627535095024
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672180315876539  LUMO = 0.673655338407883
  mo_energy =
[-1.21701925e+02 -1.33838129e+01 -7.62167880e+00 -7.62167880e+00
 -7.62167880e+00 -1.65719667e+00 -6.72180316e-01 -6.72180316e-01
 -6.72180316e-01  6.73655338e-01  8.79583447e+00  4.63717058e+01
  1.88444560e+02  7.15597879e+02  2.86677127e+03  1.23363226e+04
  4.09494238e+04  1.04988364e+05  2.30168788e+05  4.55981600e+05
  8.44932264e+05  1.52810800e+06  2.85037352e+06  5.80825841e+06]
E1 = -707.7765407395656  E_coul = 199.80891188523586
cycle= 1 E= -507.96762885433  delta_E= -3.34  |g|= 0.451  |ddm|= 0.505
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.699306
diis-c [-0.4890287  1.       ]
  HOMO = -0.217508404499238  LUMO = 1.05791607356987
  mo_energy =
[-1.20192559e+02 -1.23024319e+01 -6.59226414e+00 -6.59226414e+00
 -6.59226414e+00 -1.16296697e+00 -2.17508404e-01 -2.17508404e-01
 -2.17508404e-01  1.05791607e+00  9.60726873e+00  4.75530381e+01
  1.89869236e+02  7.17089851e+02  2.86820382e+03  1.23376462e+04
  4.09506806e+04  1.04989584e+05  2.30169983e+05  4.55982779e+05
  8.44933429e+05  1.52810915e+06  2.85037467e+06  5.80825954e+06]
E1 = -706.8319563906663  E_coul = 198.84671635187354
cycle= 2 E= -507.985240038793  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.43
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0298977
diis-c [-8.93814439e-04 -3.51038148e-04  1.00035104e+00]
  HOMO = -0.239460545757227  LUMO = 1.05236806326971
  mo_energy =
[-1.20306088e+02 -1.23692303e+01 -6.66625256e+00 -6.66625256e+00
 -6.66625256e+00 -1.17708699e+00 -2.39460546e-01 -2.39460546e-01
 -2.39460546e-01  1.05236806e+00  9.56506495e+00  4.74787383e+01
  1.89770066e+02  7.16972191e+02  2.86807045e+03  1.23375026e+04
  4.09505331e+04  1.04989435e+05  2.30169834e+05  4.55982628e+05
  8.44933279e+05  1.52810900e+06  2.85037451e+06  5.80825939e+06]
E1 = -706.7252888621574  E_coul = 198.73979216458412
cycle= 3 E= -507.985496697573  delta_E= -0.000257  |g|= 0.00436  |ddm|= 0.0602
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00323844
diis-c [-2.28108627e-06  2.24374106e-05 -1.06145065e-01  1.10612263e+00]
  HOMO = -0.242593658065777  LUMO = 1.05134171218213
  mo_energy =
[-1.20317944e+02 -1.23778141e+01 -6.67533244e+00 -6.67533244e+00
 -6.67533244e+00 -1.17898287e+00 -2.42593658e-01 -2.42593658e-01
 -2.42593658e-01  1.05134171e+00  9.55912943e+00  4.74697082e+01
  1.89759177e+02  7.16960168e+02  2.86805761e+03  1.23374893e+04
  4.09505196e+04  1.04989421e+05  2.30169820e+05  4.55982615e+05
  8.44933265e+05  1.52810899e+06  2.85037450e+06  5.80825938e+06]
E1 = -706.7102137010929  E_coul = 198.72471222233943
cycle= 4 E= -507.985501478753  delta_E= -4.78e-06  |g|= 0.000207  |ddm|= 0.00942
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000144606
diis-c [-1.47586801e-10 -7.48209098e-06  7.01168478e-03 -9.88627194e-02
  1.09185852e+00]
  HOMO = -0.242733946147763  LUMO = 1.05128862494885
  mo_energy =
[-1.20318295e+02 -1.23781513e+01 -6.67566719e+00 -6.67566719e+00
 -6.67566719e+00 -1.17906661e+00 -2.42733946e-01 -2.42733946e-01
 -2.42733946e-01  1.05128862e+00  9.55887129e+00  4.74693794e+01
  1.89758831e+02  7.16959816e+02  2.86805726e+03  1.23374889e+04
  4.09505193e+04  1.04989421e+05  2.30169820e+05  4.55982614e+05
  8.44933265e+05  1.52810899e+06  2.85037450e+06  5.80825938e+06]
E1 = -706.7095467437258  E_coul = 198.72404525471458
cycle= 5 E= -507.985501489011  delta_E= -1.03e-08  |g|= 1.45e-06  |ddm|= 0.000476
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.63613e-07
diis-c [-1.07941528e-13  2.55262637e-07 -1.86729550e-04  2.41815960e-03
 -2.85312686e-02  1.02629958e+00]
  HOMO = -0.242734775785691  LUMO = 1.05128846217932
  mo_energy =
[-1.20318298e+02 -1.23781532e+01 -6.67566918e+00 -6.67566918e+00
 -6.67566918e+00 -1.17906725e+00 -2.42734776e-01 -2.42734776e-01
 -2.42734776e-01  1.05128846e+00  9.55886980e+00  4.74693774e+01
  1.89758829e+02  7.16959814e+02  2.86805725e+03  1.23374889e+04
  4.09505193e+04  1.04989421e+05  2.30169820e+05  4.55982614e+05
  8.44933265e+05  1.52810899e+06  2.85037450e+06  5.80825938e+06]
E1 = -706.709542504518  E_coul = 198.72404101550654
cycle= 6 E= -507.985501489011  delta_E= -2.84e-13  |g|= 4.63e-08  |ddm|= 3.23e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.709542504518  E_coul = 198.72404101550654
  HOMO = -0.242734799206348  LUMO = 1.05128844677473
  mo_energy =
[-1.20318298e+02 -1.23781532e+01 -6.67566923e+00 -6.67566923e+00
 -6.67566923e+00 -1.17906726e+00 -2.42734799e-01 -2.42734799e-01
 -2.42734799e-01  1.05128845e+00  9.55886976e+00  4.74693773e+01
  1.89758829e+02  7.16959814e+02  2.86805725e+03  1.23374889e+04
  4.09505193e+04  1.04989421e+05  2.30169820e+05  4.55982614e+05
  8.44933265e+05  1.52810899e+06  2.85037450e+06  5.80825938e+06]
E1 = -706.709542399775  E_coul = 198.72404091076353
Extra cycle  E= -507.985501489012  delta_E= -5.68e-14  |g|= 6.17e-09  |ddm|= 8.83e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909179.8946210108
E1 = -706.709542399775  E_coul = 198.72404091076353
init E= -507.985501489012
    CPU time for initialize scf      3.40 sec, wall time      0.22 sec
  HOMO = -0.242734802412064  LUMO = 1.05128844679912
  mo_energy =
[-1.20318298e+02 -1.23781532e+01 -6.67566924e+00 -6.67566924e+00
 -6.67566924e+00 -1.17906726e+00 -2.42734802e-01 -2.42734802e-01
 -2.42734802e-01  1.05128845e+00  9.55886975e+00  4.74693773e+01
  1.89758829e+02  7.16959814e+02  2.86805725e+03  1.23374889e+04
  4.09505193e+04  1.04989421e+05  2.30169820e+05  4.55982614e+05
  8.44933265e+05  1.52810899e+06  2.85037450e+06  5.80825938e+06]
E1 = -706.7095423842288  E_coul = 198.72404089521723
cycle= 1 E= -507.985501489012  delta_E= -5.68e-14  |g|= 2.24e-09  |ddm|= 1.14e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.7095423842288  E_coul = 198.72404089521723
  HOMO = -0.242734802876821  LUMO = 1.0512884474889
  mo_energy =
[-1.20318298e+02 -1.23781532e+01 -6.67566924e+00 -6.67566924e+00
 -6.67566924e+00 -1.17906726e+00 -2.42734803e-01 -2.42734803e-01
 -2.42734803e-01  1.05128845e+00  9.55886975e+00  4.74693773e+01
  1.89758829e+02  7.16959814e+02  2.86805725e+03  1.23374889e+04
  4.09505193e+04  1.04989421e+05  2.30169820e+05  4.55982614e+05
  8.44933265e+05  1.52810899e+06  2.85037450e+06  5.80825938e+06]
E1 = -706.7095423806236  E_coul = 198.7240408916117
Extra cycle  E= -507.985501489012  delta_E= -2.84e-13  |g|= 1.15e-09  |ddm|= 2.39e-09
    CPU time for scf_cycle      3.85 sec, wall time      0.38 sec
exp = [2.46703119e-01 6.46055761e-01 1.17616814e+05 2.85943910e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104197e+04 3.67547133e+04 7.30304913e+03 1.83757957e+04
 1.44875819e+03 3.78204419e+02 1.22257893e+02 4.53615433e+01
 1.67572824e+01 6.83230485e+00 8.61044202e+00 4.92850390e-01]
grad_E = [-5.32084385e-04 -8.00086439e-05  3.98042085e-09  2.61569516e-03
  1.63656987e-11  1.06220542e-10  6.19456195e-10  2.42708414e-09
  1.00756188e-08  5.44330564e-08  3.39452398e-06  1.14745123e-07
  1.81983523e-05 -1.64457672e-04 -1.07266342e-04  1.53597154e-04
 -1.48563549e-04 -1.22863861e-03  5.18723937e-03 -1.15650230e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:17:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.246709853515       1
[INPUT] 0    0    [1    /1   ]  0.645089282576       1
[INPUT] 0    0    [1    /1   ]  117616.813692        1
[INPUT] 0    0    [1    /1   ]  2.85548737666        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069978        1
[INPUT] 0    0    [1    /1   ]  294042.031046        1
[INPUT] 0    0    [1    /1   ]  147020.991812        1
[INPUT] 0    0    [1    /1   ]  73510.4195776        1
[INPUT] 0    0    [1    /1   ]  36754.7125325        1
[INPUT] 0    0    [1    /1   ]  7303.00469728        1
[INPUT] 0    0    [1    /1   ]  18375.7942019        1
[INPUT] 0    0    [1    /1   ]  1448.36438833        1
[INPUT] 0    0    [1    /1   ]  381.261430988        1
[INPUT] 0    0    [1    /1   ]  123.042868477        1
[INPUT] 0    0    [1    /1   ]  45.2442378796        1
[INPUT] 0    0    [1    /1   ]  16.2171165908        1
[INPUT] 0    0    [1    /1   ]  6.75121172669        1
[INPUT] 1    0    [1    /1   ]  8.61268500129        1
[INPUT] 1    0    [1    /1   ]  0.492894442284       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24670985351472222, 1.0]], [0, [0.6450892825758918, 1.0]], [0, [117616.81369192986, 1.0]], [0, [2.8554873766618, 1.0]], [0, [1176168.1426165185, 1.0]], [0, [588084.0699778086, 1.0]], [0, [294042.03104632173, 1.0]], [0, [147020.99181237357, 1.0]], [0, [73510.41957759051, 1.0]], [0, [36754.71253249178, 1.0]], [0, [7303.004697283639, 1.0]], [0, [18375.794201880715, 1.0]], [0, [1448.3643883289942, 1.0]], [0, [381.2614309875244, 1.0]], [0, [123.04286847697415, 1.0]], [0, [45.244237879615284, 1.0]], [0, [16.217116590778087, 1.0]], [0, [6.751211726685607, 1.0]], [1, [8.61268500129108, 1.0]], [1, [0.4928944422840085, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24670985]
bas 1, expnt(s) = [0.64508928]
bas 2, expnt(s) = [117616.81369193]
bas 3, expnt(s) = [2.85548738]
bas 4, expnt(s) = [1176168.14261652]
bas 5, expnt(s) = [588084.06997781]
bas 6, expnt(s) = [294042.03104632]
bas 7, expnt(s) = [147020.99181237]
bas 8, expnt(s) = [73510.41957759]
bas 9, expnt(s) = [36754.71253249]
bas 10, expnt(s) = [7303.00469728]
bas 11, expnt(s) = [18375.79420188]
bas 12, expnt(s) = [1448.36438833]
bas 13, expnt(s) = [381.26143099]
bas 14, expnt(s) = [123.04286848]
bas 15, expnt(s) = [45.24423788]
bas 16, expnt(s) = [16.21711659]
bas 17, expnt(s) = [6.75121173]
bas 18, expnt(s) = [8.612685]
bas 19, expnt(s) = [0.49289444]
CPU time:      1122.39
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.46709854e-01 8.84412548e-01 6.45089283e-01 1.81856946e+00
 1.17616814e+05 1.60460109e+04 2.85548738e+00 5.54977285e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104196e+04 1.12791585e+04 3.67547125e+04 6.70655973e+03
 7.30300470e+03 1.99591117e+03 1.83757942e+04 3.98749006e+03
 1.44836439e+03 5.93162112e+02 3.81261431e+02 2.17987796e+02
 1.23042868e+02 9.33377569e+01 4.52442379e+01 4.40745089e+01
 1.62171166e+01 2.04171563e+01 6.75121173e+00 1.05815995e+01
 8.61268500e+00 4.30435019e+01 4.92894442e-01 1.20483283e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.3357039755744
cond(S) = 909256.6118261898
E1 = -689.635939344619  E_coul = 185.01073849031883
init E= -504.6252008543
    CPU time for initialize scf      0.44 sec, wall time      0.07 sec
  HOMO = -0.67215769403295  LUMO = 0.672587098734444
  mo_energy =
[-1.21699876e+02 -1.33829013e+01 -7.62089017e+00 -7.62089017e+00
 -7.62089017e+00 -1.65714463e+00 -6.72157694e-01 -6.72157694e-01
 -6.72157694e-01  6.72587099e-01  8.70270621e+00  4.53712505e+01
  1.86397609e+02  7.16932906e+02  2.87501521e+03  1.23463056e+04
  4.09589594e+04  1.04997521e+05  2.30177683e+05  4.55990306e+05
  8.44940827e+05  1.52811642e+06  2.85038177e+06  5.80826644e+06]
E1 = -707.791440359257  E_coul = 199.8234839154907
cycle= 1 E= -507.967956443766  delta_E= -3.34  |g|= 0.451  |ddm|= 0.507
    CPU time for cycle= 1      0.43 sec, wall time      0.03 sec
diis-norm(errvec)=0.697814
diis-c [-0.48694452  1.        ]
  HOMO = -0.21739500359101  LUMO = 1.05651163350466
  mo_energy =
[-1.20190158e+02 -1.23012975e+01 -6.59122336e+00 -6.59122336e+00
 -6.59122336e+00 -1.16284861e+00 -2.17395004e-01 -2.17395004e-01
 -2.17395004e-01  1.05651163e+00  9.51000924e+00  4.65467657e+01
  1.87822011e+02  7.18425276e+02  2.87644807e+03  1.23476298e+04
  4.09602168e+04  1.04998741e+05  2.30178879e+05  4.55991486e+05
  8.44941993e+05  1.52811758e+06  2.85038292e+06  5.80826758e+06]
E1 = -706.8463667995516  E_coul = 198.86078730181893
cycle= 2 E= -507.985579497733  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.43
    CPU time for cycle= 2      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.0298953
diis-c [-8.93569111e-04 -5.76885802e-04  1.00057689e+00]
  HOMO = -0.239364067761379  LUMO = 1.05098210089548
  mo_energy =
[-1.20303759e+02 -1.23681496e+01 -6.66526942e+00 -6.66526942e+00
 -6.66526942e+00 -1.17697834e+00 -2.39364068e-01 -2.39364068e-01
 -2.39364068e-01  1.05098210e+00  9.46806298e+00  4.64728908e+01
  1.87722831e+02  7.18307443e+02  2.87631460e+03  1.23474860e+04
  4.09600693e+04  1.04998592e+05  2.30178729e+05  4.55991335e+05
  8.44941842e+05  1.52811743e+06  2.85038277e+06  5.80826743e+06]
E1 = -706.7396302313648  E_coul = 198.75379395097437
cycle= 3 E= -507.98583628039  delta_E= -0.000257  |g|= 0.00435  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00323329
diis-c [-2.28679145e-06  2.97921699e-05 -1.05887528e-01  1.10585774e+00]
  HOMO = -0.242493403065507  LUMO = 1.04995981416287
  mo_energy =
[-1.20315594e+02 -1.23767212e+01 -6.67433569e+00 -6.67433569e+00
 -6.67433569e+00 -1.17887155e+00 -2.42493403e-01 -2.42493403e-01
 -2.42493403e-01  1.04995981e+00  9.46216801e+00  4.64639146e+01
  1.87711965e+02  7.18295437e+02  2.87630179e+03  1.23474727e+04
  4.09600558e+04  1.04998579e+05  2.30178716e+05  4.55991322e+05
  8.44941828e+05  1.52811741e+06  2.85038275e+06  5.80826741e+06]
E1 = -706.724574990156  E_coul = 198.7387339388914
cycle= 4 E= -507.985841051265  delta_E= -4.77e-06  |g|= 0.000207  |ddm|= 0.00941
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000144823
diis-c [-1.48333909e-10 -7.41416487e-06  6.98029575e-03 -9.88288958e-02
  1.09185601e+00]
  HOMO = -0.242634001290926  LUMO = 1.04990675052259
  mo_energy =
[-1.20315946e+02 -1.23770590e+01 -6.67467108e+00 -6.67467108e+00
 -6.67467108e+00 -1.17895550e+00 -2.42634001e-01 -2.42634001e-01
 -2.42634001e-01  1.04990675e+00  9.46191045e+00  4.64635857e+01
  1.87711619e+02  7.18295084e+02  2.87630143e+03  1.23474724e+04
  4.09600555e+04  1.04998578e+05  2.30178715e+05  4.55991321e+05
  8.44941828e+05  1.52811741e+06  2.85038275e+06  5.80826741e+06]
E1 = -706.7239066344234  E_coul = 198.73806557284183
cycle= 5 E= -507.985841061582  delta_E= -1.03e-08  |g|= 1.49e-06  |ddm|= 0.000478
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.7984e-07
diis-c [-1.15657549e-13  2.61789506e-07 -1.93218141e-04  2.51851955e-03
 -2.96917735e-02  1.02736621e+00]
  HOMO = -0.242634852019759  LUMO = 1.04990657686168
  mo_energy =
[-1.20315949e+02 -1.23770609e+01 -6.67467311e+00 -6.67467311e+00
 -6.67467311e+00 -1.17895616e+00 -2.42634852e-01 -2.42634852e-01
 -2.42634852e-01  1.04990658e+00  9.46190893e+00  4.64635837e+01
  1.87711616e+02  7.18295082e+02  2.87630143e+03  1.23474724e+04
  4.09600554e+04  1.04998578e+05  2.30178715e+05  4.55991321e+05
  8.44941828e+05  1.52811741e+06  2.85038275e+06  5.80826741e+06]
E1 = -706.7239022962659  E_coul = 198.738061234684
cycle= 6 E= -507.985841061582  delta_E= -3.41e-13  |g|= 4.82e-08  |ddm|= 3.34e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7239022962659  E_coul = 198.738061234684
  HOMO = -0.242634876124314  LUMO = 1.04990656398801
  mo_energy =
[-1.20315949e+02 -1.23770610e+01 -6.67467316e+00 -6.67467316e+00
 -6.67467316e+00 -1.17895617e+00 -2.42634876e-01 -2.42634876e-01
 -2.42634876e-01  1.04990656e+00  9.46190889e+00  4.64635836e+01
  1.87711616e+02  7.18295082e+02  2.87630143e+03  1.23474724e+04
  4.09600554e+04  1.04998578e+05  2.30178715e+05  4.55991321e+05
  8.44941828e+05  1.52811741e+06  2.85038275e+06  5.80826741e+06]
E1 = -706.723902186287  E_coul = 198.7380611247049
Extra cycle  E= -507.985841061582  delta_E= -1.14e-13  |g|= 6.1e-09  |ddm|= 9.27e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.29 sec
exp = [2.46709854e-01 6.45089283e-01 1.17616814e+05 2.85548738e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104196e+04 3.67547125e+04 7.30300470e+03 1.83757942e+04
 1.44836439e+03 3.81261431e+02 1.23042868e+02 4.52442379e+01
 1.62171166e+01 6.75121173e+00 8.61268500e+00 4.92894442e-01]
E = -507.98584106158205
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:17:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.246709853515       1
[INPUT] 0    0    [1    /1   ]  0.645089282576       1
[INPUT] 0    0    [1    /1   ]  117616.813692        1
[INPUT] 0    0    [1    /1   ]  2.85548737666        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069978        1
[INPUT] 0    0    [1    /1   ]  294042.031046        1
[INPUT] 0    0    [1    /1   ]  147020.991812        1
[INPUT] 0    0    [1    /1   ]  73510.4195776        1
[INPUT] 0    0    [1    /1   ]  36754.7125325        1
[INPUT] 0    0    [1    /1   ]  7303.00469728        1
[INPUT] 0    0    [1    /1   ]  18375.7942019        1
[INPUT] 0    0    [1    /1   ]  1448.36438833        1
[INPUT] 0    0    [1    /1   ]  381.261430988        1
[INPUT] 0    0    [1    /1   ]  123.042868477        1
[INPUT] 0    0    [1    /1   ]  45.2442378796        1
[INPUT] 0    0    [1    /1   ]  16.2171165908        1
[INPUT] 0    0    [1    /1   ]  6.75121172669        1
[INPUT] 1    0    [1    /1   ]  8.61268500129        1
[INPUT] 1    0    [1    /1   ]  0.492894442284       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24670985351472222, 1.0]], [0, [0.6450892825758918, 1.0]], [0, [117616.81369192986, 1.0]], [0, [2.8554873766618, 1.0]], [0, [1176168.1426165185, 1.0]], [0, [588084.0699778086, 1.0]], [0, [294042.03104632173, 1.0]], [0, [147020.99181237357, 1.0]], [0, [73510.41957759051, 1.0]], [0, [36754.71253249178, 1.0]], [0, [7303.004697283639, 1.0]], [0, [18375.794201880715, 1.0]], [0, [1448.3643883289942, 1.0]], [0, [381.2614309875244, 1.0]], [0, [123.04286847697415, 1.0]], [0, [45.244237879615284, 1.0]], [0, [16.217116590778087, 1.0]], [0, [6.751211726685607, 1.0]], [1, [8.61268500129108, 1.0]], [1, [0.4928944422840085, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24670985]
bas 1, expnt(s) = [0.64508928]
bas 2, expnt(s) = [117616.81369193]
bas 3, expnt(s) = [2.85548738]
bas 4, expnt(s) = [1176168.14261652]
bas 5, expnt(s) = [588084.06997781]
bas 6, expnt(s) = [294042.03104632]
bas 7, expnt(s) = [147020.99181237]
bas 8, expnt(s) = [73510.41957759]
bas 9, expnt(s) = [36754.71253249]
bas 10, expnt(s) = [7303.00469728]
bas 11, expnt(s) = [18375.79420188]
bas 12, expnt(s) = [1448.36438833]
bas 13, expnt(s) = [381.26143099]
bas 14, expnt(s) = [123.04286848]
bas 15, expnt(s) = [45.24423788]
bas 16, expnt(s) = [16.21711659]
bas 17, expnt(s) = [6.75121173]
bas 18, expnt(s) = [8.612685]
bas 19, expnt(s) = [0.49289444]
CPU time:      1124.03
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.46709854e-01 8.84412548e-01 6.45089283e-01 1.81856946e+00
 1.17616814e+05 1.60460109e+04 2.85548738e+00 5.54977285e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104196e+04 1.12791585e+04 3.67547125e+04 6.70655973e+03
 7.30300470e+03 1.99591117e+03 1.83757942e+04 3.98749006e+03
 1.44836439e+03 5.93162112e+02 3.81261431e+02 2.17987796e+02
 1.23042868e+02 9.33377569e+01 4.52442379e+01 4.40745089e+01
 1.62171166e+01 2.04171563e+01 6.75121173e+00 1.05815995e+01
 8.61268500e+00 4.30435019e+01 4.92894442e-01 1.20483283e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.3357039755744
cond(S) = 909256.6118261898
E1 = -689.635939344619  E_coul = 185.01073849031883
init E= -504.6252008543
    CPU time for initialize scf      0.42 sec, wall time      0.06 sec
  HOMO = -0.67215769403295  LUMO = 0.672587098734444
  mo_energy =
[-1.21699876e+02 -1.33829013e+01 -7.62089017e+00 -7.62089017e+00
 -7.62089017e+00 -1.65714463e+00 -6.72157694e-01 -6.72157694e-01
 -6.72157694e-01  6.72587099e-01  8.70270621e+00  4.53712505e+01
  1.86397609e+02  7.16932906e+02  2.87501521e+03  1.23463056e+04
  4.09589594e+04  1.04997521e+05  2.30177683e+05  4.55990306e+05
  8.44940827e+05  1.52811642e+06  2.85038177e+06  5.80826644e+06]
E1 = -707.791440359257  E_coul = 199.8234839154907
cycle= 1 E= -507.967956443766  delta_E= -3.34  |g|= 0.451  |ddm|= 0.507
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.697814
diis-c [-0.48694452  1.        ]
  HOMO = -0.21739500359101  LUMO = 1.05651163350466
  mo_energy =
[-1.20190158e+02 -1.23012975e+01 -6.59122336e+00 -6.59122336e+00
 -6.59122336e+00 -1.16284861e+00 -2.17395004e-01 -2.17395004e-01
 -2.17395004e-01  1.05651163e+00  9.51000924e+00  4.65467657e+01
  1.87822011e+02  7.18425276e+02  2.87644807e+03  1.23476298e+04
  4.09602168e+04  1.04998741e+05  2.30178879e+05  4.55991486e+05
  8.44941993e+05  1.52811758e+06  2.85038292e+06  5.80826758e+06]
E1 = -706.8463667995516  E_coul = 198.86078730181893
cycle= 2 E= -507.985579497733  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.43
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0298953
diis-c [-8.93569111e-04 -5.76885802e-04  1.00057689e+00]
  HOMO = -0.239364067761379  LUMO = 1.05098210089548
  mo_energy =
[-1.20303759e+02 -1.23681496e+01 -6.66526942e+00 -6.66526942e+00
 -6.66526942e+00 -1.17697834e+00 -2.39364068e-01 -2.39364068e-01
 -2.39364068e-01  1.05098210e+00  9.46806298e+00  4.64728908e+01
  1.87722831e+02  7.18307443e+02  2.87631460e+03  1.23474860e+04
  4.09600693e+04  1.04998592e+05  2.30178729e+05  4.55991335e+05
  8.44941842e+05  1.52811743e+06  2.85038277e+06  5.80826743e+06]
E1 = -706.7396302313648  E_coul = 198.75379395097437
cycle= 3 E= -507.98583628039  delta_E= -0.000257  |g|= 0.00435  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00323329
diis-c [-2.28679145e-06  2.97921699e-05 -1.05887528e-01  1.10585774e+00]
  HOMO = -0.242493403065507  LUMO = 1.04995981416287
  mo_energy =
[-1.20315594e+02 -1.23767212e+01 -6.67433569e+00 -6.67433569e+00
 -6.67433569e+00 -1.17887155e+00 -2.42493403e-01 -2.42493403e-01
 -2.42493403e-01  1.04995981e+00  9.46216801e+00  4.64639146e+01
  1.87711965e+02  7.18295437e+02  2.87630179e+03  1.23474727e+04
  4.09600558e+04  1.04998579e+05  2.30178716e+05  4.55991322e+05
  8.44941828e+05  1.52811741e+06  2.85038275e+06  5.80826741e+06]
E1 = -706.724574990156  E_coul = 198.7387339388914
cycle= 4 E= -507.985841051265  delta_E= -4.77e-06  |g|= 0.000207  |ddm|= 0.00941
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000144823
diis-c [-1.48333909e-10 -7.41416487e-06  6.98029575e-03 -9.88288958e-02
  1.09185601e+00]
  HOMO = -0.242634001290926  LUMO = 1.04990675052259
  mo_energy =
[-1.20315946e+02 -1.23770590e+01 -6.67467108e+00 -6.67467108e+00
 -6.67467108e+00 -1.17895550e+00 -2.42634001e-01 -2.42634001e-01
 -2.42634001e-01  1.04990675e+00  9.46191045e+00  4.64635857e+01
  1.87711619e+02  7.18295084e+02  2.87630143e+03  1.23474724e+04
  4.09600555e+04  1.04998578e+05  2.30178715e+05  4.55991321e+05
  8.44941828e+05  1.52811741e+06  2.85038275e+06  5.80826741e+06]
E1 = -706.7239066344234  E_coul = 198.73806557284183
cycle= 5 E= -507.985841061582  delta_E= -1.03e-08  |g|= 1.49e-06  |ddm|= 0.000478
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.7984e-07
diis-c [-1.15657549e-13  2.61789506e-07 -1.93218141e-04  2.51851955e-03
 -2.96917735e-02  1.02736621e+00]
  HOMO = -0.242634852019759  LUMO = 1.04990657686168
  mo_energy =
[-1.20315949e+02 -1.23770609e+01 -6.67467311e+00 -6.67467311e+00
 -6.67467311e+00 -1.17895616e+00 -2.42634852e-01 -2.42634852e-01
 -2.42634852e-01  1.04990658e+00  9.46190893e+00  4.64635837e+01
  1.87711616e+02  7.18295082e+02  2.87630143e+03  1.23474724e+04
  4.09600554e+04  1.04998578e+05  2.30178715e+05  4.55991321e+05
  8.44941828e+05  1.52811741e+06  2.85038275e+06  5.80826741e+06]
E1 = -706.7239022962659  E_coul = 198.738061234684
cycle= 6 E= -507.985841061582  delta_E= -3.41e-13  |g|= 4.82e-08  |ddm|= 3.34e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7239022962659  E_coul = 198.738061234684
  HOMO = -0.242634876124314  LUMO = 1.04990656398801
  mo_energy =
[-1.20315949e+02 -1.23770610e+01 -6.67467316e+00 -6.67467316e+00
 -6.67467316e+00 -1.17895617e+00 -2.42634876e-01 -2.42634876e-01
 -2.42634876e-01  1.04990656e+00  9.46190889e+00  4.64635836e+01
  1.87711616e+02  7.18295082e+02  2.87630143e+03  1.23474724e+04
  4.09600554e+04  1.04998578e+05  2.30178715e+05  4.55991321e+05
  8.44941828e+05  1.52811741e+06  2.85038275e+06  5.80826741e+06]
E1 = -706.723902186287  E_coul = 198.7380611247049
Extra cycle  E= -507.985841061582  delta_E= -1.14e-13  |g|= 6.1e-09  |ddm|= 9.27e-08
    CPU time for scf_cycle      1.11 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909256.6118261898
E1 = -706.723902186287  E_coul = 198.7380611247049
init E= -507.985841061582
    CPU time for initialize scf      3.45 sec, wall time      0.22 sec
  HOMO = -0.242634879500605  LUMO = 1.04990656320287
  mo_energy =
[-1.20315949e+02 -1.23770610e+01 -6.67467317e+00 -6.67467317e+00
 -6.67467317e+00 -1.17895617e+00 -2.42634880e-01 -2.42634880e-01
 -2.42634880e-01  1.04990656e+00  9.46190888e+00  4.64635836e+01
  1.87711616e+02  7.18295082e+02  2.87630143e+03  1.23474724e+04
  4.09600554e+04  1.04998578e+05  2.30178715e+05  4.55991321e+05
  8.44941828e+05  1.52811741e+06  2.85038275e+06  5.80826741e+06]
E1 = -706.7239021705685  E_coul = 198.73806110898659
cycle= 1 E= -507.985841061582  delta_E= 1.14e-13  |g|= 1.9e-09  |ddm|= 1.16e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.7239021705685  E_coul = 198.73806110898659
  HOMO = -0.242634879970386  LUMO = 1.04990656237722
  mo_energy =
[-1.20315949e+02 -1.23770610e+01 -6.67467317e+00 -6.67467317e+00
 -6.67467317e+00 -1.17895617e+00 -2.42634880e-01 -2.42634880e-01
 -2.42634880e-01  1.04990656e+00  9.46190888e+00  4.64635836e+01
  1.87711616e+02  7.18295082e+02  2.87630143e+03  1.23474724e+04
  4.09600554e+04  1.04998578e+05  2.30178715e+05  4.55991321e+05
  8.44941828e+05  1.52811741e+06  2.85038275e+06  5.80826741e+06]
E1 = -706.7239021682491  E_coul = 198.73806110666658
Extra cycle  E= -507.985841061583  delta_E= -5.68e-13  |g|= 1.38e-09  |ddm|= 1.54e-09
    CPU time for scf_cycle      3.90 sec, wall time      0.39 sec
exp = [2.46709854e-01 6.45089283e-01 1.17616814e+05 2.85548738e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104196e+04 3.67547125e+04 7.30300470e+03 1.83757942e+04
 1.44836439e+03 3.81261431e+02 1.23042868e+02 4.52442379e+01
 1.62171166e+01 6.75121173e+00 8.61268500e+00 4.92894442e-01]
grad_E = [-7.59829667e-04 -1.01865759e-04  4.24077096e-09  3.77538643e-03
  1.94655099e-11  1.14670830e-10  6.59774714e-10  2.58797845e-09
  1.07536332e-08  5.77735531e-08  3.62391860e-06  1.24890639e-07
  8.36372357e-06 -1.13393264e-04 -1.59076632e-04  2.29736815e-04
 -1.95133881e-04 -1.79292576e-03  7.05409472e-03 -1.55762048e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:17:09 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247243777325       1
[INPUT] 0    0    [1    /1   ]  0.645128041907       1
[INPUT] 0    0    [1    /1   ]  117616.813584        1
[INPUT] 0    0    [1    /1   ]  2.87410372926        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069975        1
[INPUT] 0    0    [1    /1   ]  294042.031029        1
[INPUT] 0    0    [1    /1   ]  147020.991746        1
[INPUT] 0    0    [1    /1   ]  73510.4193039        1
[INPUT] 0    0    [1    /1   ]  36754.7110472        1
[INPUT] 0    0    [1    /1   ]  7302.91263219        1
[INPUT] 0    0    [1    /1   ]  18375.7911368        1
[INPUT] 0    0    [1    /1   ]  1447.61359927        1
[INPUT] 0    0    [1    /1   ]  387.017172716        1
[INPUT] 0    0    [1    /1   ]  125.276970025        1
[INPUT] 0    0    [1    /1   ]  45.8412844157        1
[INPUT] 0    0    [1    /1   ]  16.2658296614        1
[INPUT] 0    0    [1    /1   ]  6.75494129967        1
[INPUT] 1    0    [1    /1   ]  8.61382134124        1
[INPUT] 1    0    [1    /1   ]  0.492911186294       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24724377732512764, 1.0]], [0, [0.6451280419066072, 1.0]], [0, [117616.81358366013, 1.0]], [0, [2.8741037292604696, 1.0]], [0, [1176168.1426161197, 1.0]], [0, [588084.0699749526, 1.0]], [0, [294042.0310294696, 1.0]], [0, [147020.9917464017, 1.0]], [0, [73510.41930393242, 1.0]], [0, [36754.711047201825, 1.0]], [0, [7302.912632187673, 1.0]], [0, [18375.791136800464, 1.0]], [0, [1447.6135992686268, 1.0]], [0, [387.01717271604565, 1.0]], [0, [125.2769700254946, 1.0]], [0, [45.84128441571269, 1.0]], [0, [16.26582966138326, 1.0]], [0, [6.754941299673664, 1.0]], [1, [8.613821341237806, 1.0]], [1, [0.4929111862944377, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24724378]
bas 1, expnt(s) = [0.64512804]
bas 2, expnt(s) = [117616.81358366]
bas 3, expnt(s) = [2.87410373]
bas 4, expnt(s) = [1176168.14261612]
bas 5, expnt(s) = [588084.06997495]
bas 6, expnt(s) = [294042.03102947]
bas 7, expnt(s) = [147020.9917464]
bas 8, expnt(s) = [73510.41930393]
bas 9, expnt(s) = [36754.7110472]
bas 10, expnt(s) = [7302.91263219]
bas 11, expnt(s) = [18375.7911368]
bas 12, expnt(s) = [1447.61359927]
bas 13, expnt(s) = [387.01717272]
bas 14, expnt(s) = [125.27697003]
bas 15, expnt(s) = [45.84128442]
bas 16, expnt(s) = [16.26582966]
bas 17, expnt(s) = [6.7549413]
bas 18, expnt(s) = [8.61382134]
bas 19, expnt(s) = [0.49291119]
CPU time:      1136.10
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47243777e-01 8.85847679e-01 6.45128042e-01 1.81865141e+00
 1.17616814e+05 1.60460108e+04 2.87410373e+00 5.57688710e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104193e+04 1.12791585e+04 3.67547110e+04 6.70655953e+03
 7.30291263e+03 1.99589230e+03 1.83757911e+04 3.98748956e+03
 1.44761360e+03 5.92931489e+02 3.87017173e+02 2.20451319e+02
 1.25276970e+02 9.46059508e+01 4.58412844e+01 4.45100013e+01
 1.62658297e+01 2.04631359e+01 6.75494130e+00 1.05859834e+01
 8.61382134e+00 4.30506009e+01 4.92911186e-01 1.20488399e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335664112350425
cond(S) = 909519.896727222
E1 = -689.6373932286745  E_coul = 185.01621902691278
init E= -504.621174201762
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672154761057027  LUMO = 0.674965339681717
  mo_energy =
[-1.21699117e+02 -1.33824322e+01 -7.62050997e+00 -7.62050997e+00
 -7.62050997e+00 -1.65713868e+00 -6.72154761e-01 -6.72154761e-01
 -6.72154761e-01  6.74965340e-01  8.75220067e+00  4.56663350e+01
  1.88937858e+02  7.29093241e+02  2.90068652e+03  1.23743867e+04
  4.09855685e+04  1.05023067e+05  2.30202505e+05  4.56014605e+05
  8.44964726e+05  1.52813994e+06  2.85040481e+06  5.80828886e+06]
E1 = -707.7999529488519  E_coul = 199.83135875274206
cycle= 1 E= -507.96859419611  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.697326
diis-c [-0.48626408  1.        ]
  HOMO = -0.21734030502681  LUMO = 1.05943873458725
  mo_energy =
[-1.20189116e+02 -1.23006560e+01 -6.59065048e+00 -6.59065048e+00
 -6.59065048e+00 -1.16279623e+00 -2.17340305e-01 -2.17340305e-01
 -2.17340305e-01  1.05943873e+00  9.56125693e+00  4.68441492e+01
  1.90364529e+02  7.30585974e+02  2.90211961e+03  1.23757115e+04
  4.09868265e+04  1.05024289e+05  2.30203702e+05  4.56015784e+05
  8.44965892e+05  1.52814109e+06  2.85040595e+06  5.80829000e+06]
E1 = -706.8548867223623  E_coul = 198.86866927810667
cycle= 2 E= -507.986217444256  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.43
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0298334
diis-c [-8.89901584e-04 -5.14203134e-04  1.00051420e+00]
  HOMO = -0.239311459444077  LUMO = 1.05388350429383
  mo_energy =
[-1.20302700e+02 -1.23675051e+01 -6.66468955e+00 -6.66468955e+00
 -6.66468955e+00 -1.17692747e+00 -2.39311459e-01 -2.39311459e-01
 -2.39311459e-01  1.05388350e+00  9.51917869e+00  4.67701127e+01
  1.90265086e+02  7.30467956e+02  2.90198613e+03  1.23755678e+04
  4.09866790e+04  1.05024140e+05  2.30203552e+05  4.56015634e+05
  8.44965742e+05  1.52814094e+06  2.85040580e+06  5.80828985e+06]
E1 = -706.7481806314098  E_coul = 198.76170656176228
cycle= 3 E= -507.986474069648  delta_E= -0.000257  |g|= 0.00435  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322447
diis-c [-2.27278778e-06  2.87226694e-05 -1.05818925e-01  1.10579020e+00]
  HOMO = -0.242440421334674  LUMO = 1.05285781838481
  mo_energy =
[-1.20314539e+02 -1.23760783e+01 -6.67375776e+00 -6.67375776e+00
 -6.67375776e+00 -1.17882039e+00 -2.42440421e-01 -2.42440421e-01
 -2.42440421e-01  1.05285782e+00  9.51326847e+00  4.67611208e+01
  1.90254198e+02  7.30455935e+02  2.90197331e+03  1.23755545e+04
  4.09866656e+04  1.05024126e+05  2.30203539e+05  4.56015621e+05
  8.44965728e+05  1.52814093e+06  2.85040579e+06  5.80828983e+06]
E1 = -706.73313268811  E_coul = 198.74665385492082
cycle= 4 E= -507.986478833189  delta_E= -4.76e-06  |g|= 0.000207  |ddm|= 0.00939
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000144361
diis-c [-1.45930369e-10 -7.35361731e-06  6.97928269e-03 -9.88347888e-02
  1.09186286e+00]
  HOMO = -0.242580916906553  LUMO = 1.05280465483532
  mo_energy =
[-1.20314891e+02 -1.23764162e+01 -6.67409336e+00 -6.67409336e+00
 -6.67409336e+00 -1.17890426e+00 -2.42580917e-01 -2.42580917e-01
 -2.42580917e-01  1.05280465e+00  9.51301047e+00  4.67607915e+01
  1.90253851e+02  7.30455581e+02  2.90197295e+03  1.23755541e+04
  4.09866652e+04  1.05024126e+05  2.30203539e+05  4.56015620e+05
  8.44965728e+05  1.52814093e+06  2.85040579e+06  5.80828983e+06]
E1 = -706.7324650664154  E_coul = 198.74598622295258
cycle= 5 E= -507.986478843463  delta_E= -1.03e-08  |g|= 1.46e-06  |ddm|= 0.000476
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.64062e-07
diis-c [-1.10652736e-13  2.56202472e-07 -1.88861635e-04  2.45964555e-03
 -2.89945349e-02  1.02672349e+00]
  HOMO = -0.242581750142905  LUMO = 1.05280448867858
  mo_energy =
[-1.20314894e+02 -1.23764181e+01 -6.67409535e+00 -6.67409535e+00
 -6.67409535e+00 -1.17890491e+00 -2.42581750e-01 -2.42581750e-01
 -2.42581750e-01  1.05280449e+00  9.51300898e+00  4.67607895e+01
  1.90253849e+02  7.30455578e+02  2.90197295e+03  1.23755541e+04
  4.09866652e+04  1.05024126e+05  2.30203539e+05  4.56015620e+05
  8.44965728e+05  1.52814093e+06  2.85040579e+06  5.80828983e+06]
E1 = -706.7324608158195  E_coul = 198.74598197235642
cycle= 6 E= -507.986478843463  delta_E= -2.84e-13  |g|= 4.68e-08  |ddm|= 3.26e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7324608158195  E_coul = 198.74598197235642
  HOMO = -0.242581773873829  LUMO = 1.05280447406677
  mo_energy =
[-1.20314894e+02 -1.23764181e+01 -6.67409540e+00 -6.67409540e+00
 -6.67409540e+00 -1.17890492e+00 -2.42581774e-01 -2.42581774e-01
 -2.42581774e-01  1.05280447e+00  9.51300893e+00  4.67607895e+01
  1.90253848e+02  7.30455578e+02  2.90197295e+03  1.23755541e+04
  4.09866652e+04  1.05024126e+05  2.30203539e+05  4.56015620e+05
  8.44965728e+05  1.52814093e+06  2.85040579e+06  5.80828983e+06]
E1 = -706.7324607098241  E_coul = 198.74598186636126
Extra cycle  E= -507.986478843463  delta_E= 3.41e-13  |g|= 5.98e-09  |ddm|= 8.96e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.47243777e-01 6.45128042e-01 1.17616814e+05 2.87410373e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104193e+04 3.67547110e+04 7.30291263e+03 1.83757911e+04
 1.44761360e+03 3.87017173e+02 1.25276970e+02 4.58412844e+01
 1.62658297e+01 6.75494130e+00 8.61382134e+00 4.92911186e-01]
E = -507.9864788434628
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:17:10 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.247243777325       1
[INPUT] 0    0    [1    /1   ]  0.645128041907       1
[INPUT] 0    0    [1    /1   ]  117616.813584        1
[INPUT] 0    0    [1    /1   ]  2.87410372926        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069975        1
[INPUT] 0    0    [1    /1   ]  294042.031029        1
[INPUT] 0    0    [1    /1   ]  147020.991746        1
[INPUT] 0    0    [1    /1   ]  73510.4193039        1
[INPUT] 0    0    [1    /1   ]  36754.7110472        1
[INPUT] 0    0    [1    /1   ]  7302.91263219        1
[INPUT] 0    0    [1    /1   ]  18375.7911368        1
[INPUT] 0    0    [1    /1   ]  1447.61359927        1
[INPUT] 0    0    [1    /1   ]  387.017172716        1
[INPUT] 0    0    [1    /1   ]  125.276970025        1
[INPUT] 0    0    [1    /1   ]  45.8412844157        1
[INPUT] 0    0    [1    /1   ]  16.2658296614        1
[INPUT] 0    0    [1    /1   ]  6.75494129967        1
[INPUT] 1    0    [1    /1   ]  8.61382134124        1
[INPUT] 1    0    [1    /1   ]  0.492911186294       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24724377732512764, 1.0]], [0, [0.6451280419066072, 1.0]], [0, [117616.81358366013, 1.0]], [0, [2.8741037292604696, 1.0]], [0, [1176168.1426161197, 1.0]], [0, [588084.0699749526, 1.0]], [0, [294042.0310294696, 1.0]], [0, [147020.9917464017, 1.0]], [0, [73510.41930393242, 1.0]], [0, [36754.711047201825, 1.0]], [0, [7302.912632187673, 1.0]], [0, [18375.791136800464, 1.0]], [0, [1447.6135992686268, 1.0]], [0, [387.01717271604565, 1.0]], [0, [125.2769700254946, 1.0]], [0, [45.84128441571269, 1.0]], [0, [16.26582966138326, 1.0]], [0, [6.754941299673664, 1.0]], [1, [8.613821341237806, 1.0]], [1, [0.4929111862944377, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24724378]
bas 1, expnt(s) = [0.64512804]
bas 2, expnt(s) = [117616.81358366]
bas 3, expnt(s) = [2.87410373]
bas 4, expnt(s) = [1176168.14261612]
bas 5, expnt(s) = [588084.06997495]
bas 6, expnt(s) = [294042.03102947]
bas 7, expnt(s) = [147020.9917464]
bas 8, expnt(s) = [73510.41930393]
bas 9, expnt(s) = [36754.7110472]
bas 10, expnt(s) = [7302.91263219]
bas 11, expnt(s) = [18375.7911368]
bas 12, expnt(s) = [1447.61359927]
bas 13, expnt(s) = [387.01717272]
bas 14, expnt(s) = [125.27697003]
bas 15, expnt(s) = [45.84128442]
bas 16, expnt(s) = [16.26582966]
bas 17, expnt(s) = [6.7549413]
bas 18, expnt(s) = [8.61382134]
bas 19, expnt(s) = [0.49291119]
CPU time:      1137.72
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47243777e-01 8.85847679e-01 6.45128042e-01 1.81865141e+00
 1.17616814e+05 1.60460108e+04 2.87410373e+00 5.57688710e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104193e+04 1.12791585e+04 3.67547110e+04 6.70655953e+03
 7.30291263e+03 1.99589230e+03 1.83757911e+04 3.98748956e+03
 1.44761360e+03 5.92931489e+02 3.87017173e+02 2.20451319e+02
 1.25276970e+02 9.46059508e+01 4.58412844e+01 4.45100013e+01
 1.62658297e+01 2.04631359e+01 6.75494130e+00 1.05859834e+01
 8.61382134e+00 4.30506009e+01 4.92911186e-01 1.20488399e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335664112350425
cond(S) = 909519.896727222
E1 = -689.6373932286745  E_coul = 185.01621902691278
init E= -504.621174201762
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672154761057027  LUMO = 0.674965339681717
  mo_energy =
[-1.21699117e+02 -1.33824322e+01 -7.62050997e+00 -7.62050997e+00
 -7.62050997e+00 -1.65713868e+00 -6.72154761e-01 -6.72154761e-01
 -6.72154761e-01  6.74965340e-01  8.75220067e+00  4.56663350e+01
  1.88937858e+02  7.29093241e+02  2.90068652e+03  1.23743867e+04
  4.09855685e+04  1.05023067e+05  2.30202505e+05  4.56014605e+05
  8.44964726e+05  1.52813994e+06  2.85040481e+06  5.80828886e+06]
E1 = -707.7999529488519  E_coul = 199.83135875274206
cycle= 1 E= -507.96859419611  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.697326
diis-c [-0.48626408  1.        ]
  HOMO = -0.21734030502681  LUMO = 1.05943873458725
  mo_energy =
[-1.20189116e+02 -1.23006560e+01 -6.59065048e+00 -6.59065048e+00
 -6.59065048e+00 -1.16279623e+00 -2.17340305e-01 -2.17340305e-01
 -2.17340305e-01  1.05943873e+00  9.56125693e+00  4.68441492e+01
  1.90364529e+02  7.30585974e+02  2.90211961e+03  1.23757115e+04
  4.09868265e+04  1.05024289e+05  2.30203702e+05  4.56015784e+05
  8.44965892e+05  1.52814109e+06  2.85040595e+06  5.80829000e+06]
E1 = -706.8548867223623  E_coul = 198.86866927810667
cycle= 2 E= -507.986217444256  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.43
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0298334
diis-c [-8.89901584e-04 -5.14203134e-04  1.00051420e+00]
  HOMO = -0.239311459444077  LUMO = 1.05388350429383
  mo_energy =
[-1.20302700e+02 -1.23675051e+01 -6.66468955e+00 -6.66468955e+00
 -6.66468955e+00 -1.17692747e+00 -2.39311459e-01 -2.39311459e-01
 -2.39311459e-01  1.05388350e+00  9.51917869e+00  4.67701127e+01
  1.90265086e+02  7.30467956e+02  2.90198613e+03  1.23755678e+04
  4.09866790e+04  1.05024140e+05  2.30203552e+05  4.56015634e+05
  8.44965742e+05  1.52814094e+06  2.85040580e+06  5.80828985e+06]
E1 = -706.7481806314098  E_coul = 198.76170656176228
cycle= 3 E= -507.986474069648  delta_E= -0.000257  |g|= 0.00435  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322447
diis-c [-2.27278778e-06  2.87226694e-05 -1.05818925e-01  1.10579020e+00]
  HOMO = -0.242440421334674  LUMO = 1.05285781838481
  mo_energy =
[-1.20314539e+02 -1.23760783e+01 -6.67375776e+00 -6.67375776e+00
 -6.67375776e+00 -1.17882039e+00 -2.42440421e-01 -2.42440421e-01
 -2.42440421e-01  1.05285782e+00  9.51326847e+00  4.67611208e+01
  1.90254198e+02  7.30455935e+02  2.90197331e+03  1.23755545e+04
  4.09866656e+04  1.05024126e+05  2.30203539e+05  4.56015621e+05
  8.44965728e+05  1.52814093e+06  2.85040579e+06  5.80828983e+06]
E1 = -706.73313268811  E_coul = 198.74665385492082
cycle= 4 E= -507.986478833189  delta_E= -4.76e-06  |g|= 0.000207  |ddm|= 0.00939
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000144361
diis-c [-1.45930369e-10 -7.35361731e-06  6.97928269e-03 -9.88347888e-02
  1.09186286e+00]
  HOMO = -0.242580916906553  LUMO = 1.05280465483532
  mo_energy =
[-1.20314891e+02 -1.23764162e+01 -6.67409336e+00 -6.67409336e+00
 -6.67409336e+00 -1.17890426e+00 -2.42580917e-01 -2.42580917e-01
 -2.42580917e-01  1.05280465e+00  9.51301047e+00  4.67607915e+01
  1.90253851e+02  7.30455581e+02  2.90197295e+03  1.23755541e+04
  4.09866652e+04  1.05024126e+05  2.30203539e+05  4.56015620e+05
  8.44965728e+05  1.52814093e+06  2.85040579e+06  5.80828983e+06]
E1 = -706.7324650664154  E_coul = 198.74598622295258
cycle= 5 E= -507.986478843463  delta_E= -1.03e-08  |g|= 1.46e-06  |ddm|= 0.000476
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.64062e-07
diis-c [-1.10652736e-13  2.56202472e-07 -1.88861635e-04  2.45964555e-03
 -2.89945349e-02  1.02672349e+00]
  HOMO = -0.242581750142905  LUMO = 1.05280448867858
  mo_energy =
[-1.20314894e+02 -1.23764181e+01 -6.67409535e+00 -6.67409535e+00
 -6.67409535e+00 -1.17890491e+00 -2.42581750e-01 -2.42581750e-01
 -2.42581750e-01  1.05280449e+00  9.51300898e+00  4.67607895e+01
  1.90253849e+02  7.30455578e+02  2.90197295e+03  1.23755541e+04
  4.09866652e+04  1.05024126e+05  2.30203539e+05  4.56015620e+05
  8.44965728e+05  1.52814093e+06  2.85040579e+06  5.80828983e+06]
E1 = -706.7324608158195  E_coul = 198.74598197235642
cycle= 6 E= -507.986478843463  delta_E= -2.84e-13  |g|= 4.68e-08  |ddm|= 3.26e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7324608158195  E_coul = 198.74598197235642
  HOMO = -0.242581773873829  LUMO = 1.05280447406677
  mo_energy =
[-1.20314894e+02 -1.23764181e+01 -6.67409540e+00 -6.67409540e+00
 -6.67409540e+00 -1.17890492e+00 -2.42581774e-01 -2.42581774e-01
 -2.42581774e-01  1.05280447e+00  9.51300893e+00  4.67607895e+01
  1.90253848e+02  7.30455578e+02  2.90197295e+03  1.23755541e+04
  4.09866652e+04  1.05024126e+05  2.30203539e+05  4.56015620e+05
  8.44965728e+05  1.52814093e+06  2.85040579e+06  5.80828983e+06]
E1 = -706.7324607098241  E_coul = 198.74598186636126
Extra cycle  E= -507.986478843463  delta_E= 3.41e-13  |g|= 5.98e-09  |ddm|= 8.96e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 909519.896727222
E1 = -706.7324607098241  E_coul = 198.74598186636126
init E= -507.986478843463
    CPU time for initialize scf      3.47 sec, wall time      0.22 sec
  HOMO = -0.242581777127824  LUMO = 1.05280447296228
  mo_energy =
[-1.20314894e+02 -1.23764182e+01 -6.67409541e+00 -6.67409541e+00
 -6.67409541e+00 -1.17890492e+00 -2.42581777e-01 -2.42581777e-01
 -2.42581777e-01  1.05280447e+00  9.51300893e+00  4.67607894e+01
  1.90253848e+02  7.30455578e+02  2.90197295e+03  1.23755541e+04
  4.09866652e+04  1.05024126e+05  2.30203539e+05  4.56015620e+05
  8.44965728e+05  1.52814093e+06  2.85040579e+06  5.80828983e+06]
E1 = -706.7324606936031  E_coul = 198.7459818501403
cycle= 1 E= -507.986478843463  delta_E=    0  |g|= 1.31e-09  |ddm|= 1.17e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.7324606936031  E_coul = 198.7459818501403
  HOMO = -0.242581777600763  LUMO = 1.05280447363499
  mo_energy =
[-1.20314894e+02 -1.23764182e+01 -6.67409541e+00 -6.67409541e+00
 -6.67409541e+00 -1.17890492e+00 -2.42581778e-01 -2.42581778e-01
 -2.42581778e-01  1.05280447e+00  9.51300893e+00  4.67607894e+01
  1.90253848e+02  7.30455578e+02  2.90197295e+03  1.23755541e+04
  4.09866652e+04  1.05024126e+05  2.30203539e+05  4.56015620e+05
  8.44965728e+05  1.52814093e+06  2.85040579e+06  5.80828983e+06]
E1 = -706.7324606909484  E_coul = 198.74598184748567
Extra cycle  E= -507.986478843463  delta_E= 5.68e-14  |g|= 1.72e-09  |ddm|= 1.88e-09
    CPU time for scf_cycle      3.92 sec, wall time      0.39 sec
exp = [2.47243777e-01 6.45128042e-01 1.17616814e+05 2.87410373e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104193e+04 3.67547110e+04 7.30291263e+03 1.83757911e+04
 1.44761360e+03 3.87017173e+02 1.25276970e+02 4.58412844e+01
 1.62658297e+01 6.75494130e+00 8.61382134e+00 4.92911186e-01]
grad_E = [-1.08785938e-03 -7.82754883e-05  4.67897586e-09  5.04691041e-03
  2.46167870e-11  1.28927160e-10  7.27491981e-10  2.85892265e-09
  1.18963669e-08  6.33762345e-08  3.99948605e-06  1.42198224e-07
 -6.54655858e-06 -4.60416123e-05 -2.13735592e-04  3.18177726e-04
 -2.49856300e-04 -2.37492896e-03  8.02742967e-03 -1.72719408e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:17:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248760347763       1
[INPUT] 0    0    [1    /1   ]  0.648065644849       1
[INPUT] 0    0    [1    /1   ]  117616.813383        1
[INPUT] 0    0    [1    /1   ]  2.93022570203        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06997         1
[INPUT] 0    0    [1    /1   ]  294042.030998        1
[INPUT] 0    0    [1    /1   ]  147020.991624        1
[INPUT] 0    0    [1    /1   ]  73510.4187958        1
[INPUT] 0    0    [1    /1   ]  36754.7082916        1
[INPUT] 0    0    [1    /1   ]  7302.74164715        1
[INPUT] 0    0    [1    /1   ]  18375.7854302        1
[INPUT] 0    0    [1    /1   ]  1446.3074052         1
[INPUT] 0    0    [1    /1   ]  396.926688893        1
[INPUT] 0    0    [1    /1   ]  130.223806597        1
[INPUT] 0    0    [1    /1   ]  48.0955682433        1
[INPUT] 0    0    [1    /1   ]  18.0559281631        1
[INPUT] 0    0    [1    /1   ]  6.9643319854         1
[INPUT] 1    0    [1    /1   ]  8.61344690649        1
[INPUT] 1    0    [1    /1   ]  0.492892937346       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24876034776319914, 1.0]], [0, [0.6480656448491674, 1.0]], [0, [117616.81338268987, 1.0]], [0, [2.930225702026574, 1.0]], [0, [1176168.142615366, 1.0]], [0, [588084.0699696414, 1.0]], [0, [294042.03099819005, 1.0]], [0, [147020.99162393078, 1.0]], [0, [73510.41879584413, 1.0]], [0, [36754.70829161677, 1.0]], [0, [7302.741647154909, 1.0]], [0, [18375.785430185326, 1.0]], [0, [1446.3074052023114, 1.0]], [0, [396.9266888933982, 1.0]], [0, [130.22380659688233, 1.0]], [0, [48.095568243253176, 1.0]], [0, [18.055928163146845, 1.0]], [0, [6.964331985404053, 1.0]], [1, [8.613446906485184, 1.0]], [1, [0.49289293734565587, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24876035]
bas 1, expnt(s) = [0.64806564]
bas 2, expnt(s) = [117616.81338269]
bas 3, expnt(s) = [2.9302257]
bas 4, expnt(s) = [1176168.14261537]
bas 5, expnt(s) = [588084.06996964]
bas 6, expnt(s) = [294042.03099819]
bas 7, expnt(s) = [147020.99162393]
bas 8, expnt(s) = [73510.41879584]
bas 9, expnt(s) = [36754.70829162]
bas 10, expnt(s) = [7302.74164715]
bas 11, expnt(s) = [18375.78543019]
bas 12, expnt(s) = [1446.3074052]
bas 13, expnt(s) = [396.92668889]
bas 14, expnt(s) = [130.2238066]
bas 15, expnt(s) = [48.09556824]
bas 16, expnt(s) = [18.05592816]
bas 17, expnt(s) = [6.96433199]
bas 18, expnt(s) = [8.61344691]
bas 19, expnt(s) = [0.49289294]
CPU time:      1149.78
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48760348e-01 8.89919843e-01 6.48065645e-01 1.82485883e+00
 1.17616813e+05 1.60460108e+04 2.93022570e+00 5.65836331e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104188e+04 1.12791584e+04 3.67547083e+04 6.70655915e+03
 7.30274165e+03 1.99585725e+03 1.83757854e+04 3.98748863e+03
 1.44630741e+03 5.92530188e+02 3.96926689e+02 2.24671379e+02
 1.30223807e+02 9.73941370e+01 4.80955682e+01 4.61417242e+01
 1.80559282e+01 2.21299222e+01 6.96433199e+00 1.08311513e+01
 8.61344691e+00 4.30482617e+01 4.92892937e-01 1.20482823e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33566771388846
cond(S) = 910155.5769866224
E1 = -689.6301786397859  E_coul = 185.01372089807379
init E= -504.616457741712
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672172552644218  LUMO = 0.684771901923849
  mo_energy =
[-1.21700159e+02 -1.33826098e+01 -7.62068990e+00 -7.62068990e+00
 -7.62068990e+00 -1.65716901e+00 -6.72172553e-01 -6.72172553e-01
 -6.72172553e-01  6.84771902e-01  9.13523897e+00  4.94926280e+01
  2.03144933e+02  7.64607068e+02  2.96012479e+03  1.24368340e+04
  4.10445660e+04  1.05079713e+05  2.30257554e+05  4.56068496e+05
  8.45017733e+05  1.52819209e+06  2.85045590e+06  5.80833860e+06]
E1 = -707.7986910750292  E_coul = 199.828913789049
cycle= 1 E= -507.96977728598  delta_E= -3.35  |g|= 0.451  |ddm|= 0.514
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.700012
diis-c [-0.4900163  1.       ]
  HOMO = -0.217373591380976  LUMO = 1.07171615547839
  mo_energy =
[-1.20190164e+02 -1.23008166e+01 -6.59080552e+00 -6.59080552e+00
 -6.59080552e+00 -1.16282720e+00 -2.17373591e-01 -2.17373591e-01
 -2.17373591e-01  1.07171616e+00  9.96017949e+00  5.06939947e+01
  2.04579338e+02  7.66099859e+02  2.96155767e+03  1.24381592e+04
  4.10458243e+04  1.05080934e+05  2.30258751e+05  4.56069676e+05
  8.45018900e+05  1.52819324e+06  2.85045705e+06  5.80833973e+06]
E1 = -706.8546240265731  E_coul = 198.86724507506477
cycle= 2 E= -507.987378951508  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.432
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0296662
diis-c [-8.80029566e-04  3.34335096e-04  9.99665665e-01]
  HOMO = -0.239312522671504  LUMO = 1.06604013250516
  mo_energy =
[-1.20303532e+02 -1.23675310e+01 -6.66469283e+00 -6.66469283e+00
 -6.66469283e+00 -1.17693912e+00 -2.39312523e-01 -2.39312523e-01
 -2.39312523e-01  1.06604013e+00  9.91705443e+00  5.06182335e+01
  2.04479076e+02  7.65981694e+02  2.96142442e+03  1.24380157e+04
  4.10456770e+04  1.05080785e+05  2.30258602e+05  4.56069526e+05
  8.45018749e+05  1.52819309e+06  2.85045690e+06  5.80833958e+06]
E1 = -706.7481780857015  E_coul = 198.76054323993014
cycle= 3 E= -507.987634845771  delta_E= -0.000256  |g|= 0.00437  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0032156
diis-c [-2.21640602e-06  4.24597063e-06 -1.06439358e-01  1.10643511e+00]
  HOMO = -0.242452757722811  LUMO = 1.06499369159154
  mo_energy =
[-1.20315451e+02 -1.23761476e+01 -6.67380993e+00 -6.67380993e+00
 -6.67380993e+00 -1.17883947e+00 -2.42452758e-01 -2.42452758e-01
 -2.42452758e-01  1.06499369e+00  9.91099196e+00  5.06090369e+01
  2.04468049e+02  7.65969568e+02  2.96141150e+03  1.24380023e+04
  4.10456635e+04  1.05080772e+05  2.30258588e+05  4.56069512e+05
  8.45018736e+05  1.52819308e+06  2.85045688e+06  5.80833957e+06]
E1 = -706.7330896031326  E_coul = 198.74544998295931
cycle= 4 E= -507.987639620173  delta_E= -4.77e-06  |g|= 0.000204  |ddm|= 0.00938
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000142295
diis-c [-1.39010527e-10 -7.33414015e-06  7.06747974e-03 -9.88683173e-02
  1.09180817e+00]
  HOMO = -0.242591908298605  LUMO = 1.06494026495117
  mo_energy =
[-1.20315802e+02 -1.23764836e+01 -6.67414367e+00 -6.67414367e+00
 -6.67414367e+00 -1.17892242e+00 -2.42591908e-01 -2.42591908e-01
 -2.42591908e-01  1.06494026e+00  9.91073186e+00  5.06087074e+01
  2.04467704e+02  7.65969216e+02  2.96141115e+03  1.24380020e+04
  4.10456631e+04  1.05080771e+05  2.30258588e+05  4.56069512e+05
  8.45018735e+05  1.52819308e+06  2.85045688e+06  5.80833957e+06]
E1 = -706.7324289990988  E_coul = 198.7447893689543
cycle= 5 E= -507.987639630145  delta_E= -9.97e-09  |g|= 1.26e-06  |ddm|= 0.000465
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.87144e-07
diis-c [-7.93927066e-14  2.35048598e-07 -1.62072703e-04  2.06175735e-03
 -2.43485634e-02  1.02244864e+00]
  HOMO = -0.242592643088582  LUMO = 1.06494013834631
  mo_energy =
[-1.20315804e+02 -1.23764854e+01 -6.67414548e+00 -6.67414548e+00
 -6.67414548e+00 -1.17892300e+00 -2.42592643e-01 -2.42592643e-01
 -2.42592643e-01  1.06494014e+00  9.91073051e+00  5.06087055e+01
  2.04467702e+02  7.65969214e+02  2.96141114e+03  1.24380020e+04
  4.10456631e+04  1.05080771e+05  2.30258588e+05  4.56069512e+05
  8.45018735e+05  1.52819308e+06  2.85045688e+06  5.80833957e+06]
E1 = -706.7324252305431  E_coul = 198.7447856003982
cycle= 6 E= -507.987639630145  delta_E= -3.41e-13  |g|= 3.96e-08  |ddm|= 2.79e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7324252305431  E_coul = 198.7447856003982
  HOMO = -0.24259266343299  LUMO = 1.06494012499389
  mo_energy =
[-1.20315804e+02 -1.23764854e+01 -6.67414552e+00 -6.67414552e+00
 -6.67414552e+00 -1.17892301e+00 -2.42592663e-01 -2.42592663e-01
 -2.42592663e-01  1.06494012e+00  9.91073047e+00  5.06087055e+01
  2.04467702e+02  7.65969214e+02  2.96141114e+03  1.24380020e+04
  4.10456631e+04  1.05080771e+05  2.30258588e+05  4.56069512e+05
  8.45018735e+05  1.52819308e+06  2.85045688e+06  5.80833957e+06]
E1 = -706.7324251405433  E_coul = 198.74478551039815
Extra cycle  E= -507.987639630145  delta_E= -2.84e-13  |g|= 4.94e-09  |ddm|= 7.49e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.48760348e-01 6.48065645e-01 1.17616813e+05 2.93022570e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104188e+04 3.67547083e+04 7.30274165e+03 1.83757854e+04
 1.44630741e+03 3.96926689e+02 1.30223807e+02 4.80955682e+01
 1.80559282e+01 6.96433199e+00 8.61344691e+00 4.92892937e-01]
E = -507.98763963014517
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:17:18 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.248760347763       1
[INPUT] 0    0    [1    /1   ]  0.648065644849       1
[INPUT] 0    0    [1    /1   ]  117616.813383        1
[INPUT] 0    0    [1    /1   ]  2.93022570203        1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.06997         1
[INPUT] 0    0    [1    /1   ]  294042.030998        1
[INPUT] 0    0    [1    /1   ]  147020.991624        1
[INPUT] 0    0    [1    /1   ]  73510.4187958        1
[INPUT] 0    0    [1    /1   ]  36754.7082916        1
[INPUT] 0    0    [1    /1   ]  7302.74164715        1
[INPUT] 0    0    [1    /1   ]  18375.7854302        1
[INPUT] 0    0    [1    /1   ]  1446.3074052         1
[INPUT] 0    0    [1    /1   ]  396.926688893        1
[INPUT] 0    0    [1    /1   ]  130.223806597        1
[INPUT] 0    0    [1    /1   ]  48.0955682433        1
[INPUT] 0    0    [1    /1   ]  18.0559281631        1
[INPUT] 0    0    [1    /1   ]  6.9643319854         1
[INPUT] 1    0    [1    /1   ]  8.61344690649        1
[INPUT] 1    0    [1    /1   ]  0.492892937346       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24876034776319914, 1.0]], [0, [0.6480656448491674, 1.0]], [0, [117616.81338268987, 1.0]], [0, [2.930225702026574, 1.0]], [0, [1176168.142615366, 1.0]], [0, [588084.0699696414, 1.0]], [0, [294042.03099819005, 1.0]], [0, [147020.99162393078, 1.0]], [0, [73510.41879584413, 1.0]], [0, [36754.70829161677, 1.0]], [0, [7302.741647154909, 1.0]], [0, [18375.785430185326, 1.0]], [0, [1446.3074052023114, 1.0]], [0, [396.9266888933982, 1.0]], [0, [130.22380659688233, 1.0]], [0, [48.095568243253176, 1.0]], [0, [18.055928163146845, 1.0]], [0, [6.964331985404053, 1.0]], [1, [8.613446906485184, 1.0]], [1, [0.49289293734565587, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24876035]
bas 1, expnt(s) = [0.64806564]
bas 2, expnt(s) = [117616.81338269]
bas 3, expnt(s) = [2.9302257]
bas 4, expnt(s) = [1176168.14261537]
bas 5, expnt(s) = [588084.06996964]
bas 6, expnt(s) = [294042.03099819]
bas 7, expnt(s) = [147020.99162393]
bas 8, expnt(s) = [73510.41879584]
bas 9, expnt(s) = [36754.70829162]
bas 10, expnt(s) = [7302.74164715]
bas 11, expnt(s) = [18375.78543019]
bas 12, expnt(s) = [1446.3074052]
bas 13, expnt(s) = [396.92668889]
bas 14, expnt(s) = [130.2238066]
bas 15, expnt(s) = [48.09556824]
bas 16, expnt(s) = [18.05592816]
bas 17, expnt(s) = [6.96433199]
bas 18, expnt(s) = [8.61344691]
bas 19, expnt(s) = [0.49289294]
CPU time:      1151.40
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.48760348e-01 8.89919843e-01 6.48065645e-01 1.82485883e+00
 1.17616813e+05 1.60460108e+04 2.93022570e+00 5.65836331e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020992e+05 1.89692227e+04
 7.35104188e+04 1.12791584e+04 3.67547083e+04 6.70655915e+03
 7.30274165e+03 1.99585725e+03 1.83757854e+04 3.98748863e+03
 1.44630741e+03 5.92530188e+02 3.96926689e+02 2.24671379e+02
 1.30223807e+02 9.73941370e+01 4.80955682e+01 4.61417242e+01
 1.80559282e+01 2.21299222e+01 6.96433199e+00 1.08311513e+01
 8.61344691e+00 4.30482617e+01 4.92892937e-01 1.20482823e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33566771388846
cond(S) = 910155.5769866224
E1 = -689.6301786397859  E_coul = 185.01372089807379
init E= -504.616457741712
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672172552644218  LUMO = 0.684771901923849
  mo_energy =
[-1.21700159e+02 -1.33826098e+01 -7.62068990e+00 -7.62068990e+00
 -7.62068990e+00 -1.65716901e+00 -6.72172553e-01 -6.72172553e-01
 -6.72172553e-01  6.84771902e-01  9.13523897e+00  4.94926280e+01
  2.03144933e+02  7.64607068e+02  2.96012479e+03  1.24368340e+04
  4.10445660e+04  1.05079713e+05  2.30257554e+05  4.56068496e+05
  8.45017733e+05  1.52819209e+06  2.85045590e+06  5.80833860e+06]
E1 = -707.7986910750292  E_coul = 199.828913789049
cycle= 1 E= -507.96977728598  delta_E= -3.35  |g|= 0.451  |ddm|= 0.514
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.700012
diis-c [-0.4900163  1.       ]
  HOMO = -0.217373591380976  LUMO = 1.07171615547839
  mo_energy =
[-1.20190164e+02 -1.23008166e+01 -6.59080552e+00 -6.59080552e+00
 -6.59080552e+00 -1.16282720e+00 -2.17373591e-01 -2.17373591e-01
 -2.17373591e-01  1.07171616e+00  9.96017949e+00  5.06939947e+01
  2.04579338e+02  7.66099859e+02  2.96155767e+03  1.24381592e+04
  4.10458243e+04  1.05080934e+05  2.30258751e+05  4.56069676e+05
  8.45018900e+05  1.52819324e+06  2.85045705e+06  5.80833973e+06]
E1 = -706.8546240265731  E_coul = 198.86724507506477
cycle= 2 E= -507.987378951508  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.432
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0296662
diis-c [-8.80029566e-04  3.34335096e-04  9.99665665e-01]
  HOMO = -0.239312522671504  LUMO = 1.06604013250516
  mo_energy =
[-1.20303532e+02 -1.23675310e+01 -6.66469283e+00 -6.66469283e+00
 -6.66469283e+00 -1.17693912e+00 -2.39312523e-01 -2.39312523e-01
 -2.39312523e-01  1.06604013e+00  9.91705443e+00  5.06182335e+01
  2.04479076e+02  7.65981694e+02  2.96142442e+03  1.24380157e+04
  4.10456770e+04  1.05080785e+05  2.30258602e+05  4.56069526e+05
  8.45018749e+05  1.52819309e+06  2.85045690e+06  5.80833958e+06]
E1 = -706.7481780857015  E_coul = 198.76054323993014
cycle= 3 E= -507.987634845771  delta_E= -0.000256  |g|= 0.00437  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0032156
diis-c [-2.21640602e-06  4.24597063e-06 -1.06439358e-01  1.10643511e+00]
  HOMO = -0.242452757722811  LUMO = 1.06499369159154
  mo_energy =
[-1.20315451e+02 -1.23761476e+01 -6.67380993e+00 -6.67380993e+00
 -6.67380993e+00 -1.17883947e+00 -2.42452758e-01 -2.42452758e-01
 -2.42452758e-01  1.06499369e+00  9.91099196e+00  5.06090369e+01
  2.04468049e+02  7.65969568e+02  2.96141150e+03  1.24380023e+04
  4.10456635e+04  1.05080772e+05  2.30258588e+05  4.56069512e+05
  8.45018736e+05  1.52819308e+06  2.85045688e+06  5.80833957e+06]
E1 = -706.7330896031326  E_coul = 198.74544998295931
cycle= 4 E= -507.987639620173  delta_E= -4.77e-06  |g|= 0.000204  |ddm|= 0.00938
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000142295
diis-c [-1.39010527e-10 -7.33414015e-06  7.06747974e-03 -9.88683173e-02
  1.09180817e+00]
  HOMO = -0.242591908298605  LUMO = 1.06494026495117
  mo_energy =
[-1.20315802e+02 -1.23764836e+01 -6.67414367e+00 -6.67414367e+00
 -6.67414367e+00 -1.17892242e+00 -2.42591908e-01 -2.42591908e-01
 -2.42591908e-01  1.06494026e+00  9.91073186e+00  5.06087074e+01
  2.04467704e+02  7.65969216e+02  2.96141115e+03  1.24380020e+04
  4.10456631e+04  1.05080771e+05  2.30258588e+05  4.56069512e+05
  8.45018735e+05  1.52819308e+06  2.85045688e+06  5.80833957e+06]
E1 = -706.7324289990988  E_coul = 198.7447893689543
cycle= 5 E= -507.987639630145  delta_E= -9.97e-09  |g|= 1.26e-06  |ddm|= 0.000465
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.87144e-07
diis-c [-7.93927066e-14  2.35048598e-07 -1.62072703e-04  2.06175735e-03
 -2.43485634e-02  1.02244864e+00]
  HOMO = -0.242592643088582  LUMO = 1.06494013834631
  mo_energy =
[-1.20315804e+02 -1.23764854e+01 -6.67414548e+00 -6.67414548e+00
 -6.67414548e+00 -1.17892300e+00 -2.42592643e-01 -2.42592643e-01
 -2.42592643e-01  1.06494014e+00  9.91073051e+00  5.06087055e+01
  2.04467702e+02  7.65969214e+02  2.96141114e+03  1.24380020e+04
  4.10456631e+04  1.05080771e+05  2.30258588e+05  4.56069512e+05
  8.45018735e+05  1.52819308e+06  2.85045688e+06  5.80833957e+06]
E1 = -706.7324252305431  E_coul = 198.7447856003982
cycle= 6 E= -507.987639630145  delta_E= -3.41e-13  |g|= 3.96e-08  |ddm|= 2.79e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7324252305431  E_coul = 198.7447856003982
  HOMO = -0.24259266343299  LUMO = 1.06494012499389
  mo_energy =
[-1.20315804e+02 -1.23764854e+01 -6.67414552e+00 -6.67414552e+00
 -6.67414552e+00 -1.17892301e+00 -2.42592663e-01 -2.42592663e-01
 -2.42592663e-01  1.06494012e+00  9.91073047e+00  5.06087055e+01
  2.04467702e+02  7.65969214e+02  2.96141114e+03  1.24380020e+04
  4.10456631e+04  1.05080771e+05  2.30258588e+05  4.56069512e+05
  8.45018735e+05  1.52819308e+06  2.85045688e+06  5.80833957e+06]
E1 = -706.7324251405433  E_coul = 198.74478551039815
Extra cycle  E= -507.987639630145  delta_E= -2.84e-13  |g|= 4.94e-09  |ddm|= 7.49e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 910155.5769866224
E1 = -706.7324251405433  E_coul = 198.74478551039815
init E= -507.987639630145
    CPU time for initialize scf      3.40 sec, wall time      0.22 sec
  HOMO = -0.242592666187446  LUMO = 1.06494012559993
  mo_energy =
[-1.20315804e+02 -1.23764854e+01 -6.67414553e+00 -6.67414553e+00
 -6.67414553e+00 -1.17892301e+00 -2.42592666e-01 -2.42592666e-01
 -2.42592666e-01  1.06494013e+00  9.91073047e+00  5.06087055e+01
  2.04467702e+02  7.65969214e+02  2.96141114e+03  1.24380020e+04
  4.10456631e+04  1.05080771e+05  2.30258588e+05  4.56069512e+05
  8.45018735e+05  1.52819308e+06  2.85045688e+06  5.80833957e+06]
E1 = -706.7324251250184  E_coul = 198.7447854948733
cycle= 1 E= -507.987639630145  delta_E= 1.14e-13  |g|= 1.35e-09  |ddm|= 1.1e-08
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.7324251250184  E_coul = 198.7447854948733
  HOMO = -0.242592666640604  LUMO = 1.06494012523508
  mo_energy =
[-1.20315804e+02 -1.23764854e+01 -6.67414553e+00 -6.67414553e+00
 -6.67414553e+00 -1.17892301e+00 -2.42592667e-01 -2.42592667e-01
 -2.42592667e-01  1.06494013e+00  9.91073047e+00  5.06087055e+01
  2.04467702e+02  7.65969214e+02  2.96141114e+03  1.24380020e+04
  4.10456631e+04  1.05080771e+05  2.30258588e+05  4.56069512e+05
  8.45018735e+05  1.52819308e+06  2.85045688e+06  5.80833957e+06]
E1 = -706.7324251231363  E_coul = 198.7447854929909
Extra cycle  E= -507.987639630145  delta_E= -3.41e-13  |g|= 1.08e-09  |ddm|= 1.33e-09
    CPU time for scf_cycle      3.86 sec, wall time      0.38 sec
exp = [2.48760348e-01 6.48065645e-01 1.17616813e+05 2.93022570e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020992e+05
 7.35104188e+04 3.67547083e+04 7.30274165e+03 1.83757854e+04
 1.44630741e+03 3.96926689e+02 1.30223807e+02 4.80955682e+01
 1.80559282e+01 6.96433199e+00 8.61344691e+00 4.92892937e-01]
grad_E = [-1.33813458e-03  1.24031503e-04  5.34462036e-09  5.73901037e-03
  3.23050564e-11  1.50652322e-10  8.30057054e-10  3.27077826e-09
  1.36354089e-08  7.18458413e-08  4.54852908e-06  1.68967814e-07
 -2.59676706e-05  2.45730268e-05 -2.38812756e-04  2.97047449e-04
 -2.45268465e-04 -2.55198354e-03  7.74156997e-03 -1.64742043e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:17:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.251071089968       1
[INPUT] 0    0    [1    /1   ]  0.654675435727       1
[INPUT] 0    0    [1    /1   ]  117616.812984        1
[INPUT] 0    0    [1    /1   ]  3.03035878688        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069959        1
[INPUT] 0    0    [1    /1   ]  294042.030936        1
[INPUT] 0    0    [1    /1   ]  147020.991381        1
[INPUT] 0    0    [1    /1   ]  73510.417787         1
[INPUT] 0    0    [1    /1   ]  36754.7028242        1
[INPUT] 0    0    [1    /1   ]  7302.40204121        1
[INPUT] 0    0    [1    /1   ]  18375.774069         1
[INPUT] 0    0    [1    /1   ]  1443.884005          1
[INPUT] 0    0    [1    /1   ]  415.07953868         1
[INPUT] 0    0    [1    /1   ]  141.766526705        1
[INPUT] 0    0    [1    /1   ]  54.8357679102        1
[INPUT] 0    0    [1    /1   ]  24.1600209803        1
[INPUT] 0    0    [1    /1   ]  7.55326334473        1
[INPUT] 1    0    [1    /1   ]  8.61235389685        1
[INPUT] 1    0    [1    /1   ]  0.492865129201       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.25107108996800487, 1.0]], [0, [0.6546754357269907, 1.0]], [0, [117616.81298374601, 1.0]], [0, [3.0303587868807718, 1.0]], [0, [1176168.1426138442, 1.0]], [0, [588084.0699590791, 1.0]], [0, [294042.0309360997, 1.0]], [0, [147020.99138078824, 1.0]], [0, [73510.4177870049, 1.0]], [0, [36754.70282424412, 1.0]], [0, [7302.402041211559, 1.0]], [0, [18375.77406895701, 1.0]], [0, [1443.8840049998785, 1.0]], [0, [415.07953868002323, 1.0]], [0, [141.76652670531237, 1.0]], [0, [54.83576791022503, 1.0]], [0, [24.160020980258302, 1.0]], [0, [7.5532633447312305, 1.0]], [1, [8.61235389685355, 1.0]], [1, [0.49286512920103337, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25107109]
bas 1, expnt(s) = [0.65467544]
bas 2, expnt(s) = [117616.81298375]
bas 3, expnt(s) = [3.03035879]
bas 4, expnt(s) = [1176168.14261384]
bas 5, expnt(s) = [588084.06995908]
bas 6, expnt(s) = [294042.0309361]
bas 7, expnt(s) = [147020.99138079]
bas 8, expnt(s) = [73510.417787]
bas 9, expnt(s) = [36754.70282424]
bas 10, expnt(s) = [7302.40204121]
bas 11, expnt(s) = [18375.77406896]
bas 12, expnt(s) = [1443.884005]
bas 13, expnt(s) = [415.07953868]
bas 14, expnt(s) = [141.76652671]
bas 15, expnt(s) = [54.83576791]
bas 16, expnt(s) = [24.16002098]
bas 17, expnt(s) = [7.55326334]
bas 18, expnt(s) = [8.6123539]
bas 19, expnt(s) = [0.49286513]
CPU time:      1163.45
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.51071090e-01 8.96112541e-01 6.54675436e-01 1.83880027e+00
 1.17616813e+05 1.60460108e+04 3.03035879e+00 5.80277274e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104178e+04 1.12791583e+04 3.67547028e+04 6.70655840e+03
 7.30240204e+03 1.99578764e+03 1.83757741e+04 3.98748678e+03
 1.44388400e+03 5.91785409e+02 4.15079539e+02 2.32334401e+02
 1.41766527e+02 1.03799509e+02 5.48357679e+01 5.09111575e+01
 2.41600210e+01 2.75320154e+01 7.55326334e+00 1.15110779e+01
 8.61235390e+00 4.30414335e+01 4.92865129e-01 1.20474327e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.3356855599171
cond(S) = 911678.9356624809
E1 = -689.6300972379662  E_coul = 185.00832923927808
init E= -504.621767998688
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672187645138336  LUMO = 0.702237241456313
  mo_energy =
[-1.21701737e+02 -1.33831372e+01 -7.62104970e+00 -7.62104970e+00
 -7.62104970e+00 -1.65709392e+00 -6.72187645e-01 -6.72187645e-01
 -6.72187645e-01  7.02237241e-01  1.01345206e+01  6.17233623e+01
  2.45838181e+02  8.56251348e+02  3.09804723e+03  1.25789589e+04
  4.11787452e+04  1.05208585e+05  2.30382821e+05  4.56191141e+05
  8.45138374e+05  1.52831078e+06  2.85057219e+06  5.80845179e+06]
E1 = -707.7868785328706  E_coul = 199.81592956932624
cycle= 1 E= -507.970948963544  delta_E= -3.35  |g|= 0.451  |ddm|= 0.507
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.706317
diis-c [-0.49888345  1.        ]
  HOMO = -0.217481534721186  LUMO = 1.09386547748958
  mo_energy =
[-1.20192518e+02 -1.23019932e+01 -6.59186178e+00 -6.59186178e+00
 -6.59186178e+00 -1.16285417e+00 -2.17481535e-01 -2.17481535e-01
 -2.17481535e-01  1.09386548e+00  1.09995404e+01  6.29849313e+01
  2.47289923e+02  8.57743580e+02  3.09947923e+03  1.25802841e+04
  4.11800032e+04  1.05209806e+05  2.30384018e+05  4.56192321e+05
  8.45139540e+05  1.52831193e+06  2.85057333e+06  5.80845293e+06]
E1 = -706.8458288649214  E_coul = 198.8573391498606
cycle= 2 E= -507.988489715061  delta_E= -0.0175  |g|= 0.0347  |ddm|= 0.436
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0292327
diis-c [-8.50490361e-04  2.84724379e-03  9.97152756e-01]
  HOMO = -0.239308979565362  LUMO = 1.087965606728
  mo_energy =
[-1.20305320e+02 -1.23682777e+01 -6.66530045e+00 -6.66530045e+00
 -6.66530045e+00 -1.17689375e+00 -2.39308980e-01 -2.39308980e-01
 -2.39308980e-01  1.08796561e+00  1.09539178e+01  6.29045715e+01
  2.47187727e+02  8.57625290e+02  3.09934660e+03  1.25801414e+04
  4.11798567e+04  1.05209658e+05  2.30383869e+05  4.56192171e+05
  8.45139390e+05  1.52831178e+06  2.85057318e+06  5.80845278e+06]
E1 = -706.7400387701456  E_coul = 198.75129448364123
cycle= 3 E= -507.988744286504  delta_E= -0.000255  |g|= 0.00443  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0032209
diis-c [-2.06061090e-06 -8.83956223e-05 -1.09626131e-01  1.10971453e+00]
  HOMO = -0.242493828863129  LUMO = 1.08687222804327
  mo_energy =
[-1.20317500e+02 -1.23770402e+01 -6.67458143e+00 -6.67458143e+00
 -6.67458143e+00 -1.17882307e+00 -2.42493829e-01 -2.42493829e-01
 -2.42493829e-01  1.08687223e+00  1.09474496e+01  6.28947855e+01
  2.47176296e+02  8.57612848e+02  3.09933337e+03  1.25801277e+04
  4.11798428e+04  1.05209644e+05  2.30383855e+05  4.56192157e+05
  8.45139376e+05  1.52831177e+06  2.85057317e+06  5.80845276e+06]
E1 = -706.724748292496  E_coul = 198.73599914106094
cycle= 4 E= -507.988749151435  delta_E= -4.86e-06  |g|= 0.000196  |ddm|= 0.00947
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135772
diis-c [-1.25007893e-10 -6.99028523e-06  7.40411335e-03 -9.85154720e-02
  1.09111835e+00]
  HOMO = -0.242627110149858  LUMO = 1.08681939973176
  mo_energy =
[-1.20317832e+02 -1.23773633e+01 -6.67490146e+00 -6.67490146e+00
 -6.67490146e+00 -1.17890217e+00 -2.42627110e-01 -2.42627110e-01
 -2.42627110e-01  1.08681940e+00  1.09471907e+01  6.28944659e+01
  2.47175967e+02  8.57612515e+02  3.09933304e+03  1.25801273e+04
  4.11798424e+04  1.05209644e+05  2.30383854e+05  4.56192157e+05
  8.45139376e+05  1.52831177e+06  2.85057317e+06  5.80845276e+06]
E1 = -706.7241161794756  E_coul = 198.73536701901872
cycle= 5 E= -507.988749160457  delta_E= -9.02e-09  |g|= 8.41e-07  |ddm|= 0.000438
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.33631e-07
diis-c [-2.54715521e-14  1.85754836e-07 -1.16582984e-04  1.36712762e-03
 -1.61238586e-02  1.01487313e+00]
  HOMO = -0.242627629629079  LUMO = 1.08681936340481
  mo_energy =
[-1.20317834e+02 -1.23773647e+01 -6.67490284e+00 -6.67490284e+00
 -6.67490284e+00 -1.17890262e+00 -2.42627630e-01 -2.42627630e-01
 -2.42627630e-01  1.08681936e+00  1.09471897e+01  6.28944644e+01
  2.47175965e+02  8.57612513e+02  3.09933303e+03  1.25801273e+04
  4.11798424e+04  1.05209644e+05  2.30383854e+05  4.56192157e+05
  8.45139376e+05  1.52831177e+06  2.85057317e+06  5.80845276e+06]
E1 = -706.7241134514237  E_coul = 198.73536429096714
cycle= 6 E= -507.988749160457  delta_E= 2.84e-13  |g|= 2.09e-08  |ddm|= 1.86e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7241134514237  E_coul = 198.73536429096714
  HOMO = -0.242627640296568  LUMO = 1.08681935711551
  mo_energy =
[-1.20317834e+02 -1.23773647e+01 -6.67490287e+00 -6.67490287e+00
 -6.67490287e+00 -1.17890262e+00 -2.42627640e-01 -2.42627640e-01
 -2.42627640e-01  1.08681936e+00  1.09471897e+01  6.28944644e+01
  2.47175965e+02  8.57612513e+02  3.09933303e+03  1.25801273e+04
  4.11798424e+04  1.05209644e+05  2.30383854e+05  4.56192157e+05
  8.45139376e+05  1.52831177e+06  2.85057317e+06  5.80845276e+06]
E1 = -706.724113402436  E_coul = 198.7353642419795
Extra cycle  E= -507.988749160457  delta_E=    0  |g|= 2.73e-09  |ddm|= 3.96e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.28 sec
exp = [2.51071090e-01 6.54675436e-01 1.17616813e+05 3.03035879e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104178e+04 3.67547028e+04 7.30240204e+03 1.83757741e+04
 1.44388400e+03 4.15079539e+02 1.41766527e+02 5.48357679e+01
 2.41600210e+01 7.55326334e+00 8.61235390e+00 4.92865129e-01]
E = -507.98874916045656
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:17:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.251071089968       1
[INPUT] 0    0    [1    /1   ]  0.654675435727       1
[INPUT] 0    0    [1    /1   ]  117616.812984        1
[INPUT] 0    0    [1    /1   ]  3.03035878688        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069959        1
[INPUT] 0    0    [1    /1   ]  294042.030936        1
[INPUT] 0    0    [1    /1   ]  147020.991381        1
[INPUT] 0    0    [1    /1   ]  73510.417787         1
[INPUT] 0    0    [1    /1   ]  36754.7028242        1
[INPUT] 0    0    [1    /1   ]  7302.40204121        1
[INPUT] 0    0    [1    /1   ]  18375.774069         1
[INPUT] 0    0    [1    /1   ]  1443.884005          1
[INPUT] 0    0    [1    /1   ]  415.07953868         1
[INPUT] 0    0    [1    /1   ]  141.766526705        1
[INPUT] 0    0    [1    /1   ]  54.8357679102        1
[INPUT] 0    0    [1    /1   ]  24.1600209803        1
[INPUT] 0    0    [1    /1   ]  7.55326334473        1
[INPUT] 1    0    [1    /1   ]  8.61235389685        1
[INPUT] 1    0    [1    /1   ]  0.492865129201       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.25107108996800487, 1.0]], [0, [0.6546754357269907, 1.0]], [0, [117616.81298374601, 1.0]], [0, [3.0303587868807718, 1.0]], [0, [1176168.1426138442, 1.0]], [0, [588084.0699590791, 1.0]], [0, [294042.0309360997, 1.0]], [0, [147020.99138078824, 1.0]], [0, [73510.4177870049, 1.0]], [0, [36754.70282424412, 1.0]], [0, [7302.402041211559, 1.0]], [0, [18375.77406895701, 1.0]], [0, [1443.8840049998785, 1.0]], [0, [415.07953868002323, 1.0]], [0, [141.76652670531237, 1.0]], [0, [54.83576791022503, 1.0]], [0, [24.160020980258302, 1.0]], [0, [7.5532633447312305, 1.0]], [1, [8.61235389685355, 1.0]], [1, [0.49286512920103337, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.25107109]
bas 1, expnt(s) = [0.65467544]
bas 2, expnt(s) = [117616.81298375]
bas 3, expnt(s) = [3.03035879]
bas 4, expnt(s) = [1176168.14261384]
bas 5, expnt(s) = [588084.06995908]
bas 6, expnt(s) = [294042.0309361]
bas 7, expnt(s) = [147020.99138079]
bas 8, expnt(s) = [73510.417787]
bas 9, expnt(s) = [36754.70282424]
bas 10, expnt(s) = [7302.40204121]
bas 11, expnt(s) = [18375.77406896]
bas 12, expnt(s) = [1443.884005]
bas 13, expnt(s) = [415.07953868]
bas 14, expnt(s) = [141.76652671]
bas 15, expnt(s) = [54.83576791]
bas 16, expnt(s) = [24.16002098]
bas 17, expnt(s) = [7.55326334]
bas 18, expnt(s) = [8.6123539]
bas 19, expnt(s) = [0.49286513]
CPU time:      1165.11
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.51071090e-01 8.96112541e-01 6.54675436e-01 1.83880027e+00
 1.17616813e+05 1.60460108e+04 3.03035879e+00 5.80277274e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104178e+04 1.12791583e+04 3.67547028e+04 6.70655840e+03
 7.30240204e+03 1.99578764e+03 1.83757741e+04 3.98748678e+03
 1.44388400e+03 5.91785409e+02 4.15079539e+02 2.32334401e+02
 1.41766527e+02 1.03799509e+02 5.48357679e+01 5.09111575e+01
 2.41600210e+01 2.75320154e+01 7.55326334e+00 1.15110779e+01
 8.61235390e+00 4.30414335e+01 4.92865129e-01 1.20474327e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.3356855599171
cond(S) = 911678.9356624809
E1 = -689.6300972379662  E_coul = 185.00832923927808
init E= -504.621767998688
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672187645138336  LUMO = 0.702237241456313
  mo_energy =
[-1.21701737e+02 -1.33831372e+01 -7.62104970e+00 -7.62104970e+00
 -7.62104970e+00 -1.65709392e+00 -6.72187645e-01 -6.72187645e-01
 -6.72187645e-01  7.02237241e-01  1.01345206e+01  6.17233623e+01
  2.45838181e+02  8.56251348e+02  3.09804723e+03  1.25789589e+04
  4.11787452e+04  1.05208585e+05  2.30382821e+05  4.56191141e+05
  8.45138374e+05  1.52831078e+06  2.85057219e+06  5.80845179e+06]
E1 = -707.7868785328706  E_coul = 199.81592956932624
cycle= 1 E= -507.970948963544  delta_E= -3.35  |g|= 0.451  |ddm|= 0.507
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.706317
diis-c [-0.49888345  1.        ]
  HOMO = -0.217481534721186  LUMO = 1.09386547748958
  mo_energy =
[-1.20192518e+02 -1.23019932e+01 -6.59186178e+00 -6.59186178e+00
 -6.59186178e+00 -1.16285417e+00 -2.17481535e-01 -2.17481535e-01
 -2.17481535e-01  1.09386548e+00  1.09995404e+01  6.29849313e+01
  2.47289923e+02  8.57743580e+02  3.09947923e+03  1.25802841e+04
  4.11800032e+04  1.05209806e+05  2.30384018e+05  4.56192321e+05
  8.45139540e+05  1.52831193e+06  2.85057333e+06  5.80845293e+06]
E1 = -706.8458288649214  E_coul = 198.8573391498606
cycle= 2 E= -507.988489715061  delta_E= -0.0175  |g|= 0.0347  |ddm|= 0.436
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0292327
diis-c [-8.50490361e-04  2.84724379e-03  9.97152756e-01]
  HOMO = -0.239308979565362  LUMO = 1.087965606728
  mo_energy =
[-1.20305320e+02 -1.23682777e+01 -6.66530045e+00 -6.66530045e+00
 -6.66530045e+00 -1.17689375e+00 -2.39308980e-01 -2.39308980e-01
 -2.39308980e-01  1.08796561e+00  1.09539178e+01  6.29045715e+01
  2.47187727e+02  8.57625290e+02  3.09934660e+03  1.25801414e+04
  4.11798567e+04  1.05209658e+05  2.30383869e+05  4.56192171e+05
  8.45139390e+05  1.52831178e+06  2.85057318e+06  5.80845278e+06]
E1 = -706.7400387701456  E_coul = 198.75129448364123
cycle= 3 E= -507.988744286504  delta_E= -0.000255  |g|= 0.00443  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0032209
diis-c [-2.06061090e-06 -8.83956223e-05 -1.09626131e-01  1.10971453e+00]
  HOMO = -0.242493828863129  LUMO = 1.08687222804327
  mo_energy =
[-1.20317500e+02 -1.23770402e+01 -6.67458143e+00 -6.67458143e+00
 -6.67458143e+00 -1.17882307e+00 -2.42493829e-01 -2.42493829e-01
 -2.42493829e-01  1.08687223e+00  1.09474496e+01  6.28947855e+01
  2.47176296e+02  8.57612848e+02  3.09933337e+03  1.25801277e+04
  4.11798428e+04  1.05209644e+05  2.30383855e+05  4.56192157e+05
  8.45139376e+05  1.52831177e+06  2.85057317e+06  5.80845276e+06]
E1 = -706.724748292496  E_coul = 198.73599914106094
cycle= 4 E= -507.988749151435  delta_E= -4.86e-06  |g|= 0.000196  |ddm|= 0.00947
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135772
diis-c [-1.25007893e-10 -6.99028523e-06  7.40411335e-03 -9.85154720e-02
  1.09111835e+00]
  HOMO = -0.242627110149858  LUMO = 1.08681939973176
  mo_energy =
[-1.20317832e+02 -1.23773633e+01 -6.67490146e+00 -6.67490146e+00
 -6.67490146e+00 -1.17890217e+00 -2.42627110e-01 -2.42627110e-01
 -2.42627110e-01  1.08681940e+00  1.09471907e+01  6.28944659e+01
  2.47175967e+02  8.57612515e+02  3.09933304e+03  1.25801273e+04
  4.11798424e+04  1.05209644e+05  2.30383854e+05  4.56192157e+05
  8.45139376e+05  1.52831177e+06  2.85057317e+06  5.80845276e+06]
E1 = -706.7241161794756  E_coul = 198.73536701901872
cycle= 5 E= -507.988749160457  delta_E= -9.02e-09  |g|= 8.41e-07  |ddm|= 0.000438
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.33631e-07
diis-c [-2.54715521e-14  1.85754836e-07 -1.16582984e-04  1.36712762e-03
 -1.61238586e-02  1.01487313e+00]
  HOMO = -0.242627629629079  LUMO = 1.08681936340481
  mo_energy =
[-1.20317834e+02 -1.23773647e+01 -6.67490284e+00 -6.67490284e+00
 -6.67490284e+00 -1.17890262e+00 -2.42627630e-01 -2.42627630e-01
 -2.42627630e-01  1.08681936e+00  1.09471897e+01  6.28944644e+01
  2.47175965e+02  8.57612513e+02  3.09933303e+03  1.25801273e+04
  4.11798424e+04  1.05209644e+05  2.30383854e+05  4.56192157e+05
  8.45139376e+05  1.52831177e+06  2.85057317e+06  5.80845276e+06]
E1 = -706.7241134514237  E_coul = 198.73536429096714
cycle= 6 E= -507.988749160457  delta_E= 2.84e-13  |g|= 2.09e-08  |ddm|= 1.86e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7241134514237  E_coul = 198.73536429096714
  HOMO = -0.242627640296568  LUMO = 1.08681935711551
  mo_energy =
[-1.20317834e+02 -1.23773647e+01 -6.67490287e+00 -6.67490287e+00
 -6.67490287e+00 -1.17890262e+00 -2.42627640e-01 -2.42627640e-01
 -2.42627640e-01  1.08681936e+00  1.09471897e+01  6.28944644e+01
  2.47175965e+02  8.57612513e+02  3.09933303e+03  1.25801273e+04
  4.11798424e+04  1.05209644e+05  2.30383854e+05  4.56192157e+05
  8.45139376e+05  1.52831177e+06  2.85057317e+06  5.80845276e+06]
E1 = -706.724113402436  E_coul = 198.7353642419795
Extra cycle  E= -507.988749160457  delta_E=    0  |g|= 2.73e-09  |ddm|= 3.96e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 911678.9356624809
E1 = -706.724113402436  E_coul = 198.7353642419795
init E= -507.988749160457
    CPU time for initialize scf      3.53 sec, wall time      0.22 sec
  HOMO = -0.242627641788373  LUMO = 1.0868193560385
  mo_energy =
[-1.20317834e+02 -1.23773647e+01 -6.67490287e+00 -6.67490287e+00
 -6.67490287e+00 -1.17890262e+00 -2.42627642e-01 -2.42627642e-01
 -2.42627642e-01  1.08681936e+00  1.09471897e+01  6.28944644e+01
  2.47175965e+02  8.57612513e+02  3.09933303e+03  1.25801273e+04
  4.11798424e+04  1.05209644e+05  2.30383854e+05  4.56192157e+05
  8.45139376e+05  1.52831177e+06  2.85057317e+06  5.80845276e+06]
E1 = -706.7241133977178  E_coul = 198.73536423726117
cycle= 1 E= -507.988749160457  delta_E= -1.14e-13  |g|= 8.49e-10  |ddm|= 3.52e-09
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.7241133977178  E_coul = 198.73536423726117
  HOMO = -0.242627641935528  LUMO = 1.08681935657562
  mo_energy =
[-1.20317834e+02 -1.23773647e+01 -6.67490287e+00 -6.67490287e+00
 -6.67490287e+00 -1.17890262e+00 -2.42627642e-01 -2.42627642e-01
 -2.42627642e-01  1.08681936e+00  1.09471897e+01  6.28944644e+01
  2.47175965e+02  8.57612513e+02  3.09933303e+03  1.25801273e+04
  4.11798424e+04  1.05209644e+05  2.30383854e+05  4.56192157e+05
  8.45139376e+05  1.52831177e+06  2.85057317e+06  5.80845276e+06]
E1 = -706.7241133963119  E_coul = 198.73536423585554
Extra cycle  E= -507.988749160456  delta_E= 3.41e-13  |g|= 8.11e-10  |ddm|= 9.45e-10
    CPU time for scf_cycle      3.98 sec, wall time      0.39 sec
exp = [2.51071090e-01 6.54675436e-01 1.17616813e+05 3.03035879e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104178e+04 3.67547028e+04 7.30240204e+03 1.83757741e+04
 1.44388400e+03 4.15079539e+02 1.41766527e+02 5.48357679e+01
 2.41600210e+01 7.55326334e+00 8.61235390e+00 4.92865129e-01]
grad_E = [ 8.40070362e-04  2.81625610e-04  6.22442665e-09 -1.61807508e-03
  4.22588320e-11  1.79473516e-10  9.65169040e-10  3.81558325e-09
  1.59387765e-08  8.29737157e-08  5.23457752e-06  2.05076579e-07
 -4.45543422e-05  3.53671664e-05  2.79534350e-05 -4.67415574e-04
  5.20027705e-04  8.85363161e-04  6.74898138e-03 -2.11857337e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:17:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249282004255       1
[INPUT] 0    0    [1    /1   ]  0.651551245616       1
[INPUT] 0    0    [1    /1   ]  117616.813032        1
[INPUT] 0    0    [1    /1   ]  2.97910056279        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.06996         1
[INPUT] 0    0    [1    /1   ]  294042.030944        1
[INPUT] 0    0    [1    /1   ]  147020.99141         1
[INPUT] 0    0    [1    /1   ]  73510.41791          1
[INPUT] 0    0    [1    /1   ]  36754.7034909        1
[INPUT] 0    0    [1    /1   ]  7302.44341833        1
[INPUT] 0    0    [1    /1   ]  18375.7754523        1
[INPUT] 0    0    [1    /1   ]  1444.19169094        1
[INPUT] 0    0    [1    /1   ]  412.705103245        1
[INPUT] 0    0    [1    /1   ]  141.056147924        1
[INPUT] 0    0    [1    /1   ]  53.7944966372        1
[INPUT] 0    0    [1    /1   ]  21.5862619151        1
[INPUT] 0    0    [1    /1   ]  7.42645405782        1
[INPUT] 1    0    [1    /1   ]  8.60527123887        1
[INPUT] 1    0    [1    /1   ]  0.49272449648        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24928200425490774, 1.0]], [0, [0.6515512456161516, 1.0]], [0, [117616.81303237849, 1.0]], [0, [2.979100562785599, 1.0]], [0, [1176168.1426140284, 1.0]], [0, [588084.0699603657, 1.0]], [0, [294042.03094366874, 1.0]], [0, [147020.99141042668, 1.0]], [0, [73510.41790997334, 1.0]], [0, [36754.70349086673, 1.0]], [0, [7302.443418326278, 1.0]], [0, [18375.7754522608, 1.0]], [0, [1444.1916909384654, 1.0]], [0, [412.7051032453587, 1.0]], [0, [141.05614792360328, 1.0]], [0, [53.79449663721272, 1.0]], [0, [21.586261915113987, 1.0]], [0, [7.426454057823727, 1.0]], [1, [8.605271238871572, 1.0]], [1, [0.4927244964796408, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.249282]
bas 1, expnt(s) = [0.65155125]
bas 2, expnt(s) = [117616.81303238]
bas 3, expnt(s) = [2.97910056]
bas 4, expnt(s) = [1176168.14261403]
bas 5, expnt(s) = [588084.06996037]
bas 6, expnt(s) = [294042.03094367]
bas 7, expnt(s) = [147020.99141043]
bas 8, expnt(s) = [73510.41790997]
bas 9, expnt(s) = [36754.70349087]
bas 10, expnt(s) = [7302.44341833]
bas 11, expnt(s) = [18375.77545226]
bas 12, expnt(s) = [1444.19169094]
bas 13, expnt(s) = [412.70510325]
bas 14, expnt(s) = [141.05614792]
bas 15, expnt(s) = [53.79449664]
bas 16, expnt(s) = [21.58626192]
bas 17, expnt(s) = [7.42645406]
bas 18, expnt(s) = [8.60527124]
bas 19, expnt(s) = [0.4927245]
CPU time:      1177.29
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49282004e-01 8.91319114e-01 6.51551246e-01 1.83221510e+00
 1.17616813e+05 1.60460108e+04 2.97910056e+00 5.72900098e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104179e+04 1.12791583e+04 3.67547035e+04 6.70655850e+03
 7.30244342e+03 1.99579612e+03 1.83757755e+04 3.98748700e+03
 1.44419169e+03 5.91879987e+02 4.12705103e+02 2.31336896e+02
 1.41056148e+02 1.03409167e+02 5.37944966e+01 5.01843624e+01
 2.15862619e+01 2.53016070e+01 7.42645406e+00 1.13658298e+01
 8.60527124e+00 4.29971923e+01 4.92724496e-01 1.20431359e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335926588927865
cond(S) = 911403.9743618513
E1 = -689.5887007132053  E_coul = 184.97216481369966
init E= -504.616535899506
    CPU time for initialize scf      0.42 sec, wall time      0.06 sec
  HOMO = -0.672273146681677  LUMO = 0.691574546447337
  mo_energy =
[-1.21708957e+02 -1.33859574e+01 -7.62358514e+00 -7.62358514e+00
 -7.62358514e+00 -1.65735809e+00 -6.72273147e-01 -6.72273147e-01
 -6.72273147e-01  6.91574546e-01  9.77938320e+00  5.73926800e+01
  2.34106447e+02  8.38405440e+02  3.07544951e+03  1.25564723e+04
  4.11575884e+04  1.05188268e+05  2.30363071e+05  4.56171803e+05
  8.45119351e+05  1.52829206e+06  2.85055385e+06  5.80843394e+06]
E1 = -707.7451258287135  E_coul = 199.77382936870677
cycle= 1 E= -507.971296460007  delta_E= -3.35  |g|= 0.451  |ddm|= 0.511
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.704428
diis-c [-0.49621894  1.        ]
  HOMO = -0.217807504021432  LUMO = 1.08069480980208
  mo_energy =
[-1.20200397e+02 -1.23051268e+01 -6.59480118e+00 -6.59480118e+00
 -6.59480118e+00 -1.16326402e+00 -2.17807504e-01 -2.17807504e-01
 -2.17807504e-01  1.08069481e+00  1.06310986e+01  5.86351431e+01
  2.35553912e+02  8.39897031e+02  3.07688081e+03  1.25577967e+04
  4.11588457e+04  1.05189489e+05  2.30364267e+05  4.56172982e+05
  8.45120517e+05  1.52829322e+06  2.85055500e+06  5.80843508e+06]
E1 = -706.8040963685257  E_coul = 198.81526852123625
cycle= 2 E= -507.988827847289  delta_E= -0.0175  |g|= 0.0347  |ddm|= 0.435
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.029476
diis-c [-8.67239604e-04  1.79212125e-03  9.98207879e-01]
  HOMO = -0.239650752660594  LUMO = 1.07490632285614
  mo_energy =
[-1.20313296e+02 -1.23714985e+01 -6.66832158e+00 -6.66832158e+00
 -6.66832158e+00 -1.17731956e+00 -2.39650753e-01 -2.39650753e-01
 -2.39650753e-01  1.07490632e+00  1.05863429e+01  5.85562685e+01
  2.35452105e+02  8.39778694e+02  3.07674806e+03  1.25576539e+04
  4.11586991e+04  1.05189341e+05  2.30364118e+05  4.56172832e+05
  8.45120367e+05  1.52829307e+06  2.85055485e+06  5.80843493e+06]
E1 = -706.6980524653306  E_coul = 198.70896936206756
cycle= 3 E= -507.989083103263  delta_E= -0.000255  |g|= 0.00441  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322958
diis-c [-2.13672556e-06 -5.40698137e-05 -1.08427047e-01  1.10848112e+00]
  HOMO = -0.242817906162125  LUMO = 1.07383393188438
  mo_energy =
[-1.20325363e+02 -1.23801997e+01 -6.67753269e+00 -6.67753269e+00
 -6.67753269e+00 -1.17923826e+00 -2.42817906e-01 -2.42817906e-01
 -2.42817906e-01  1.07383393e+00  1.05800170e+01  5.85466879e+01
  2.35440809e+02  8.39766374e+02  3.07673497e+03  1.25576403e+04
  4.11586853e+04  1.05189327e+05  2.30364104e+05  4.56172818e+05
  8.45120353e+05  1.52829305e+06  2.85055483e+06  5.80843491e+06]
E1 = -706.6828245638281  E_coul = 198.6937366174187
cycle= 4 E= -507.989087946409  delta_E= -4.84e-06  |g|= 0.0002  |ddm|= 0.00947
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000139089
diis-c [-1.30776154e-10 -7.10772915e-06  7.27825778e-03 -9.87878608e-02
  1.09151671e+00]
  HOMO = -0.242953894367503  LUMO = 1.07378082559917
  mo_energy =
[-1.20325703e+02 -1.23805288e+01 -6.67785898e+00 -6.67785898e+00
 -6.67785898e+00 -1.17931913e+00 -2.42953894e-01 -2.42953894e-01
 -2.42953894e-01  1.07378083e+00  1.05797561e+01  5.85463630e+01
  2.35440473e+02  8.39766033e+02  3.07673463e+03  1.25576400e+04
  4.11586850e+04  1.05189326e+05  2.30364104e+05  4.56172818e+05
  8.45120353e+05  1.52829305e+06  2.85055483e+06  5.80843491e+06]
E1 = -706.6821785517948  E_coul = 198.6930905959248
cycle= 5 E= -507.98908795587  delta_E= -9.46e-09  |g|= 9.87e-07  |ddm|= 0.000451
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.8853e-07
diis-c [-4.13491009e-14  1.97312749e-07 -1.30236558e-04  1.57511197e-03
 -1.86174562e-02  1.01717238e+00]
  HOMO = -0.242954492563106  LUMO = 1.07378075804537
  mo_energy =
[-1.20325705e+02 -1.23805302e+01 -6.67786053e+00 -6.67786053e+00
 -6.67786053e+00 -1.17931963e+00 -2.42954493e-01 -2.42954493e-01
 -2.42954493e-01  1.07378076e+00  1.05797550e+01  5.85463614e+01
  2.35440471e+02  8.39766031e+02  3.07673463e+03  1.25576400e+04
  4.11586850e+04  1.05189326e+05  2.30364104e+05  4.56172818e+05
  8.45120353e+05  1.52829305e+06  2.85055483e+06  5.80843491e+06]
E1 = -706.6821754357169  E_coul = 198.69308747984687
cycle= 6 E= -507.98908795587  delta_E=    0  |g|= 2.81e-08  |ddm|= 2.19e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6821754357169  E_coul = 198.69308747984687
  HOMO = -0.242954506931433  LUMO = 1.07378074860684
  mo_energy =
[-1.20325705e+02 -1.23805303e+01 -6.67786056e+00 -6.67786056e+00
 -6.67786056e+00 -1.17931964e+00 -2.42954507e-01 -2.42954507e-01
 -2.42954507e-01  1.07378075e+00  1.05797550e+01  5.85463614e+01
  2.35440471e+02  8.39766030e+02  3.07673463e+03  1.25576400e+04
  4.11586850e+04  1.05189326e+05  2.30364104e+05  4.56172818e+05
  8.45120353e+05  1.52829305e+06  2.85055483e+06  5.80843491e+06]
E1 = -706.6821753716346  E_coul = 198.69308741576467
Extra cycle  E= -507.98908795587  delta_E= 1.14e-13  |g|= 3.55e-09  |ddm|= 5.22e-08
    CPU time for scf_cycle      1.11 sec, wall time      0.28 sec
exp = [2.49282004e-01 6.51551246e-01 1.17616813e+05 2.97910056e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104179e+04 3.67547035e+04 7.30244342e+03 1.83757755e+04
 1.44419169e+03 4.12705103e+02 1.41056148e+02 5.37944966e+01
 2.15862619e+01 7.42645406e+00 8.60527124e+00 4.92724496e-01]
E = -507.9890879558699
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:17:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249282004255       1
[INPUT] 0    0    [1    /1   ]  0.651551245616       1
[INPUT] 0    0    [1    /1   ]  117616.813032        1
[INPUT] 0    0    [1    /1   ]  2.97910056279        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.06996         1
[INPUT] 0    0    [1    /1   ]  294042.030944        1
[INPUT] 0    0    [1    /1   ]  147020.99141         1
[INPUT] 0    0    [1    /1   ]  73510.41791          1
[INPUT] 0    0    [1    /1   ]  36754.7034909        1
[INPUT] 0    0    [1    /1   ]  7302.44341833        1
[INPUT] 0    0    [1    /1   ]  18375.7754523        1
[INPUT] 0    0    [1    /1   ]  1444.19169094        1
[INPUT] 0    0    [1    /1   ]  412.705103245        1
[INPUT] 0    0    [1    /1   ]  141.056147924        1
[INPUT] 0    0    [1    /1   ]  53.7944966372        1
[INPUT] 0    0    [1    /1   ]  21.5862619151        1
[INPUT] 0    0    [1    /1   ]  7.42645405782        1
[INPUT] 1    0    [1    /1   ]  8.60527123887        1
[INPUT] 1    0    [1    /1   ]  0.49272449648        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24928200425490774, 1.0]], [0, [0.6515512456161516, 1.0]], [0, [117616.81303237849, 1.0]], [0, [2.979100562785599, 1.0]], [0, [1176168.1426140284, 1.0]], [0, [588084.0699603657, 1.0]], [0, [294042.03094366874, 1.0]], [0, [147020.99141042668, 1.0]], [0, [73510.41790997334, 1.0]], [0, [36754.70349086673, 1.0]], [0, [7302.443418326278, 1.0]], [0, [18375.7754522608, 1.0]], [0, [1444.1916909384654, 1.0]], [0, [412.7051032453587, 1.0]], [0, [141.05614792360328, 1.0]], [0, [53.79449663721272, 1.0]], [0, [21.586261915113987, 1.0]], [0, [7.426454057823727, 1.0]], [1, [8.605271238871572, 1.0]], [1, [0.4927244964796408, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.249282]
bas 1, expnt(s) = [0.65155125]
bas 2, expnt(s) = [117616.81303238]
bas 3, expnt(s) = [2.97910056]
bas 4, expnt(s) = [1176168.14261403]
bas 5, expnt(s) = [588084.06996037]
bas 6, expnt(s) = [294042.03094367]
bas 7, expnt(s) = [147020.99141043]
bas 8, expnt(s) = [73510.41790997]
bas 9, expnt(s) = [36754.70349087]
bas 10, expnt(s) = [7302.44341833]
bas 11, expnt(s) = [18375.77545226]
bas 12, expnt(s) = [1444.19169094]
bas 13, expnt(s) = [412.70510325]
bas 14, expnt(s) = [141.05614792]
bas 15, expnt(s) = [53.79449664]
bas 16, expnt(s) = [21.58626192]
bas 17, expnt(s) = [7.42645406]
bas 18, expnt(s) = [8.60527124]
bas 19, expnt(s) = [0.4927245]
CPU time:      1178.96
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49282004e-01 8.91319114e-01 6.51551246e-01 1.83221510e+00
 1.17616813e+05 1.60460108e+04 2.97910056e+00 5.72900098e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104179e+04 1.12791583e+04 3.67547035e+04 6.70655850e+03
 7.30244342e+03 1.99579612e+03 1.83757755e+04 3.98748700e+03
 1.44419169e+03 5.91879987e+02 4.12705103e+02 2.31336896e+02
 1.41056148e+02 1.03409167e+02 5.37944966e+01 5.01843624e+01
 2.15862619e+01 2.53016070e+01 7.42645406e+00 1.13658298e+01
 8.60527124e+00 4.29971923e+01 4.92724496e-01 1.20431359e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335926588927865
cond(S) = 911403.9743618513
E1 = -689.5887007132053  E_coul = 184.97216481369966
init E= -504.616535899506
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672273146681677  LUMO = 0.691574546447337
  mo_energy =
[-1.21708957e+02 -1.33859574e+01 -7.62358514e+00 -7.62358514e+00
 -7.62358514e+00 -1.65735809e+00 -6.72273147e-01 -6.72273147e-01
 -6.72273147e-01  6.91574546e-01  9.77938320e+00  5.73926800e+01
  2.34106447e+02  8.38405440e+02  3.07544951e+03  1.25564723e+04
  4.11575884e+04  1.05188268e+05  2.30363071e+05  4.56171803e+05
  8.45119351e+05  1.52829206e+06  2.85055385e+06  5.80843394e+06]
E1 = -707.7451258287135  E_coul = 199.77382936870677
cycle= 1 E= -507.971296460007  delta_E= -3.35  |g|= 0.451  |ddm|= 0.511
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.704428
diis-c [-0.49621894  1.        ]
  HOMO = -0.217807504021432  LUMO = 1.08069480980208
  mo_energy =
[-1.20200397e+02 -1.23051268e+01 -6.59480118e+00 -6.59480118e+00
 -6.59480118e+00 -1.16326402e+00 -2.17807504e-01 -2.17807504e-01
 -2.17807504e-01  1.08069481e+00  1.06310986e+01  5.86351431e+01
  2.35553912e+02  8.39897031e+02  3.07688081e+03  1.25577967e+04
  4.11588457e+04  1.05189489e+05  2.30364267e+05  4.56172982e+05
  8.45120517e+05  1.52829322e+06  2.85055500e+06  5.80843508e+06]
E1 = -706.8040963685257  E_coul = 198.81526852123625
cycle= 2 E= -507.988827847289  delta_E= -0.0175  |g|= 0.0347  |ddm|= 0.435
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.029476
diis-c [-8.67239604e-04  1.79212125e-03  9.98207879e-01]
  HOMO = -0.239650752660594  LUMO = 1.07490632285614
  mo_energy =
[-1.20313296e+02 -1.23714985e+01 -6.66832158e+00 -6.66832158e+00
 -6.66832158e+00 -1.17731956e+00 -2.39650753e-01 -2.39650753e-01
 -2.39650753e-01  1.07490632e+00  1.05863429e+01  5.85562685e+01
  2.35452105e+02  8.39778694e+02  3.07674806e+03  1.25576539e+04
  4.11586991e+04  1.05189341e+05  2.30364118e+05  4.56172832e+05
  8.45120367e+05  1.52829307e+06  2.85055485e+06  5.80843493e+06]
E1 = -706.6980524653306  E_coul = 198.70896936206756
cycle= 3 E= -507.989083103263  delta_E= -0.000255  |g|= 0.00441  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322958
diis-c [-2.13672556e-06 -5.40698137e-05 -1.08427047e-01  1.10848112e+00]
  HOMO = -0.242817906162125  LUMO = 1.07383393188438
  mo_energy =
[-1.20325363e+02 -1.23801997e+01 -6.67753269e+00 -6.67753269e+00
 -6.67753269e+00 -1.17923826e+00 -2.42817906e-01 -2.42817906e-01
 -2.42817906e-01  1.07383393e+00  1.05800170e+01  5.85466879e+01
  2.35440809e+02  8.39766374e+02  3.07673497e+03  1.25576403e+04
  4.11586853e+04  1.05189327e+05  2.30364104e+05  4.56172818e+05
  8.45120353e+05  1.52829305e+06  2.85055483e+06  5.80843491e+06]
E1 = -706.6828245638281  E_coul = 198.6937366174187
cycle= 4 E= -507.989087946409  delta_E= -4.84e-06  |g|= 0.0002  |ddm|= 0.00947
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000139089
diis-c [-1.30776154e-10 -7.10772915e-06  7.27825778e-03 -9.87878608e-02
  1.09151671e+00]
  HOMO = -0.242953894367503  LUMO = 1.07378082559917
  mo_energy =
[-1.20325703e+02 -1.23805288e+01 -6.67785898e+00 -6.67785898e+00
 -6.67785898e+00 -1.17931913e+00 -2.42953894e-01 -2.42953894e-01
 -2.42953894e-01  1.07378083e+00  1.05797561e+01  5.85463630e+01
  2.35440473e+02  8.39766033e+02  3.07673463e+03  1.25576400e+04
  4.11586850e+04  1.05189326e+05  2.30364104e+05  4.56172818e+05
  8.45120353e+05  1.52829305e+06  2.85055483e+06  5.80843491e+06]
E1 = -706.6821785517948  E_coul = 198.6930905959248
cycle= 5 E= -507.98908795587  delta_E= -9.46e-09  |g|= 9.87e-07  |ddm|= 0.000451
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.8853e-07
diis-c [-4.13491009e-14  1.97312749e-07 -1.30236558e-04  1.57511197e-03
 -1.86174562e-02  1.01717238e+00]
  HOMO = -0.242954492563106  LUMO = 1.07378075804537
  mo_energy =
[-1.20325705e+02 -1.23805302e+01 -6.67786053e+00 -6.67786053e+00
 -6.67786053e+00 -1.17931963e+00 -2.42954493e-01 -2.42954493e-01
 -2.42954493e-01  1.07378076e+00  1.05797550e+01  5.85463614e+01
  2.35440471e+02  8.39766031e+02  3.07673463e+03  1.25576400e+04
  4.11586850e+04  1.05189326e+05  2.30364104e+05  4.56172818e+05
  8.45120353e+05  1.52829305e+06  2.85055483e+06  5.80843491e+06]
E1 = -706.6821754357169  E_coul = 198.69308747984687
cycle= 6 E= -507.98908795587  delta_E=    0  |g|= 2.81e-08  |ddm|= 2.19e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6821754357169  E_coul = 198.69308747984687
  HOMO = -0.242954506931433  LUMO = 1.07378074860684
  mo_energy =
[-1.20325705e+02 -1.23805303e+01 -6.67786056e+00 -6.67786056e+00
 -6.67786056e+00 -1.17931964e+00 -2.42954507e-01 -2.42954507e-01
 -2.42954507e-01  1.07378075e+00  1.05797550e+01  5.85463614e+01
  2.35440471e+02  8.39766030e+02  3.07673463e+03  1.25576400e+04
  4.11586850e+04  1.05189326e+05  2.30364104e+05  4.56172818e+05
  8.45120353e+05  1.52829305e+06  2.85055483e+06  5.80843491e+06]
E1 = -706.6821753716346  E_coul = 198.69308741576467
Extra cycle  E= -507.98908795587  delta_E= 1.14e-13  |g|= 3.55e-09  |ddm|= 5.22e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 911403.9743618513
E1 = -706.6821753716346  E_coul = 198.69308741576467
init E= -507.98908795587
    CPU time for initialize scf      3.44 sec, wall time      0.22 sec
  HOMO = -0.24295450888438  LUMO = 1.07378074852962
  mo_energy =
[-1.20325705e+02 -1.23805303e+01 -6.67786056e+00 -6.67786056e+00
 -6.67786056e+00 -1.17931964e+00 -2.42954509e-01 -2.42954509e-01
 -2.42954509e-01  1.07378075e+00  1.05797550e+01  5.85463614e+01
  2.35440471e+02  8.39766030e+02  3.07673463e+03  1.25576400e+04
  4.11586850e+04  1.05189326e+05  2.30364104e+05  4.56172818e+05
  8.45120353e+05  1.52829305e+06  2.85055483e+06  5.80843491e+06]
E1 = -706.6821753623276  E_coul = 198.69308740645747
cycle= 1 E= -507.98908795587  delta_E= -2.27e-13  |g|= 1.38e-09  |ddm|= 6.64e-09
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.6821753623276  E_coul = 198.69308740645747
  HOMO = -0.242954509161052  LUMO = 1.07378074856011
  mo_energy =
[-1.20325705e+02 -1.23805303e+01 -6.67786056e+00 -6.67786056e+00
 -6.67786056e+00 -1.17931964e+00 -2.42954509e-01 -2.42954509e-01
 -2.42954509e-01  1.07378075e+00  1.05797550e+01  5.85463614e+01
  2.35440471e+02  8.39766030e+02  3.07673463e+03  1.25576400e+04
  4.11586850e+04  1.05189326e+05  2.30364104e+05  4.56172818e+05
  8.45120353e+05  1.52829305e+06  2.85055483e+06  5.80843491e+06]
E1 = -706.6821753599678  E_coul = 198.69308740409747
Extra cycle  E= -507.98908795587  delta_E= -2.27e-13  |g|= 8.33e-10  |ddm|= 1.51e-09
    CPU time for scf_cycle      3.89 sec, wall time      0.39 sec
exp = [2.49282004e-01 6.51551246e-01 1.17616813e+05 2.97910056e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104179e+04 3.67547035e+04 7.30244342e+03 1.83757755e+04
 1.44419169e+03 4.12705103e+02 1.41056148e+02 5.37944966e+01
 2.15862619e+01 7.42645406e+00 8.60527124e+00 4.92724496e-01]
grad_E = [ 4.40793325e-04  4.45380347e-05  6.10657615e-09 -5.59707471e-05
  4.09372947e-11  1.75606640e-10  9.47096728e-10  3.74258080e-09
  1.56299614e-08  8.14869792e-08  5.14496602e-06  2.00198216e-07
 -4.25321979e-05  4.43527402e-05 -1.45428501e-04  1.93335836e-04
 -2.29169176e-04 -9.35304479e-05  9.08788711e-04 -4.59622255e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:17:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.24908229812        1
[INPUT] 0    0    [1    /1   ]  0.648964078552       1
[INPUT] 0    0    [1    /1   ]  117616.812989        1
[INPUT] 0    0    [1    /1   ]  3.02081205033        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069959        1
[INPUT] 0    0    [1    /1   ]  294042.030937        1
[INPUT] 0    0    [1    /1   ]  147020.991384        1
[INPUT] 0    0    [1    /1   ]  73510.4177992        1
[INPUT] 0    0    [1    /1   ]  36754.7028917        1
[INPUT] 0    0    [1    /1   ]  7302.40607562        1
[INPUT] 0    0    [1    /1   ]  18375.7741937        1
[INPUT] 0    0    [1    /1   ]  1443.98502181        1
[INPUT] 0    0    [1    /1   ]  414.160249579        1
[INPUT] 0    0    [1    /1   ]  142.991795232        1
[INPUT] 0    0    [1    /1   ]  55.2751358995        1
[INPUT] 0    0    [1    /1   ]  22.9260329777        1
[INPUT] 0    0    [1    /1   ]  7.53222967974        1
[INPUT] 1    0    [1    /1   ]  8.60441290909        1
[INPUT] 1    0    [1    /1   ]  0.49271159986        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24908229812035812, 1.0]], [0, [0.6489640785524271, 1.0]], [0, [117616.81298858848, 1.0]], [0, [3.02081205033016, 1.0]], [0, [1176168.1426138524, 1.0]], [0, [588084.0699591998, 1.0]], [0, [294042.03093685425, 1.0]], [0, [147020.99138372886, 1.0]], [0, [73510.41779915533, 1.0]], [0, [36754.70289168239, 1.0]], [0, [7302.406075621726, 1.0]], [0, [18375.774193702055, 1.0]], [0, [1443.9850218055374, 1.0]], [0, [414.16024957945336, 1.0]], [0, [142.99179523170537, 1.0]], [0, [55.27513589947735, 1.0]], [0, [22.92603297766641, 1.0]], [0, [7.5322296797383705, 1.0]], [1, [8.604412909091677, 1.0]], [1, [0.4927115998599066, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2490823]
bas 1, expnt(s) = [0.64896408]
bas 2, expnt(s) = [117616.81298859]
bas 3, expnt(s) = [3.02081205]
bas 4, expnt(s) = [1176168.14261385]
bas 5, expnt(s) = [588084.0699592]
bas 6, expnt(s) = [294042.03093685]
bas 7, expnt(s) = [147020.99138373]
bas 8, expnt(s) = [73510.41779916]
bas 9, expnt(s) = [36754.70289168]
bas 10, expnt(s) = [7302.40607562]
bas 11, expnt(s) = [18375.7741937]
bas 12, expnt(s) = [1443.98502181]
bas 13, expnt(s) = [414.16024958]
bas 14, expnt(s) = [142.99179523]
bas 15, expnt(s) = [55.2751359]
bas 16, expnt(s) = [22.92603298]
bas 17, expnt(s) = [7.53222968]
bas 18, expnt(s) = [8.60441291]
bas 19, expnt(s) = [0.4927116]
CPU time:      1191.18
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49082298e-01 8.90783517e-01 6.48964079e-01 1.82675590e+00
 1.17616813e+05 1.60460108e+04 3.02081205e+00 5.78905670e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104178e+04 1.12791583e+04 3.67547029e+04 6.70655841e+03
 7.30240608e+03 1.99578847e+03 1.83757742e+04 3.98748680e+03
 1.44398502e+03 5.91816461e+02 4.14160250e+02 2.31948375e+02
 1.42991795e+02 1.04471628e+02 5.52751359e+01 5.12167939e+01
 2.29260330e+01 2.64704734e+01 7.53222968e+00 1.14870283e+01
 8.60441291e+00 4.29918315e+01 4.92711600e-01 1.20427418e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335938764854973
cond(S) = 911648.5536663472
E1 = -689.5866306199283  E_coul = 184.96773366321116
init E= -504.618896956717
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672287077390428  LUMO = 0.689808574646625
  mo_energy =
[-1.21709924e+02 -1.33862966e+01 -7.62389201e+00 -7.62389201e+00
 -7.62389201e+00 -1.65739978e+00 -6.72287077e-01 -6.72287077e-01
 -6.72287077e-01  6.89808575e-01  1.00059155e+01  6.01006082e+01
  2.43116084e+02  8.55059793e+02  3.09698495e+03  1.25776619e+04
  4.11775017e+04  1.05207391e+05  2.30381661e+05  4.56190005e+05
  8.45137256e+05  1.52830968e+06  2.85057111e+06  5.80845074e+06]
E1 = -707.7405953810078  E_coul = 199.7690999418322
cycle= 1 E= -507.971495439176  delta_E= -3.35  |g|= 0.451  |ddm|= 0.511
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.705455
diis-c [-0.49766706  1.        ]
  HOMO = -0.217826633733432  LUMO = 1.07906139895543
  mo_energy =
[-1.20201370e+02 -1.23054936e+01 -6.59513938e+00 -6.59513938e+00
 -6.59513938e+00 -1.16330373e+00 -2.17826634e-01 -2.17826634e-01
 -2.17826634e-01  1.07906140e+00  1.08666657e+01  6.13551457e+01
  2.44566780e+02  8.56551453e+02  3.09841630e+03  1.25789865e+04
  4.11787591e+04  1.05208611e+05  2.30382857e+05  4.56191184e+05
  8.45138422e+05  1.52831083e+06  2.85057226e+06  5.80845188e+06]
E1 = -706.8005818085436  E_coul = 198.81158009759886
cycle= 2 E= -507.989001710945  delta_E= -0.0175  |g|= 0.0347  |ddm|= 0.436
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0293284
diis-c [-8.57425824e-04  2.33894980e-03  9.97661050e-01]
  HOMO = -0.239651003070602  LUMO = 1.07325806731604
  mo_energy =
[-1.20314075e+02 -1.23717469e+01 -6.66852518e+00 -6.66852518e+00
 -6.66852518e+00 -1.17735084e+00 -2.39651003e-01 -2.39651003e-01
 -2.39651003e-01  1.07325807e+00  1.08213695e+01  6.12753910e+01
  2.44464698e+02  8.56433231e+02  3.09828379e+03  1.25788439e+04
  4.11786127e+04  1.05208463e+05  2.30382708e+05  4.56191034e+05
  8.45138272e+05  1.52831068e+06  2.85057211e+06  5.80845173e+06]
E1 = -706.694538105583  E_coul = 198.705280744537
cycle= 3 E= -507.989257361046  delta_E= -0.000256  |g|= 0.00443  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0032278
diis-c [-2.09799822e-06 -7.51842403e-05 -1.09251928e-01  1.10932711e+00]
  HOMO = -0.242834699042544  LUMO = 1.07217837008769
  mo_energy =
[-1.20326211e+02 -1.23804920e+01 -6.67778384e+00 -6.67778384e+00
 -6.67778384e+00 -1.17928056e+00 -2.42834699e-01 -2.42834699e-01
 -2.42834699e-01  1.07217837e+00  1.08149426e+01  6.12656759e+01
  2.44453308e+02  8.56420833e+02  3.09827062e+03  1.25788302e+04
  4.11785989e+04  1.05208449e+05  2.30382694e+05  4.56191020e+05
  8.45138258e+05  1.52831067e+06  2.85057209e+06  5.80845172e+06]
E1 = -706.6792171078544  E_coul = 198.68995485403056
cycle= 4 E= -507.989262253824  delta_E= -4.89e-06  |g|= 0.000199  |ddm|= 0.00951
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000137782
diis-c [-1.28238195e-10 -7.02624222e-06  7.36298061e-03 -9.88497612e-02
  1.09149381e+00]
  HOMO = -0.242970159244952  LUMO = 1.07212533734517
  mo_energy =
[-1.20326549e+02 -1.23808200e+01 -6.67810887e+00 -6.67810887e+00
 -6.67810887e+00 -1.17936106e+00 -2.42970159e-01 -2.42970159e-01
 -2.42970159e-01  1.07212534e+00  1.08146806e+01  6.12653515e+01
  2.44452973e+02  8.56420494e+02  3.09827027e+03  1.25788299e+04
  4.11785985e+04  1.05208449e+05  2.30382694e+05  4.56191020e+05
  8.45138258e+05  1.52831067e+06  2.85057209e+06  5.80845171e+06]
E1 = -706.6785729659334  E_coul = 198.6893107027393
cycle= 5 E= -507.989262263194  delta_E= -9.37e-09  |g|= 9.09e-07  |ddm|= 0.000447
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.59755e-07
diis-c [-3.20758196e-14  1.86741336e-07 -1.22308516e-04  1.45338549e-03
 -1.71424228e-02  1.01581116e+00]
  HOMO = -0.24297071694583  LUMO = 1.07212528806136
  mo_energy =
[-1.20326551e+02 -1.23808214e+01 -6.67811033e+00 -6.67811033e+00
 -6.67811033e+00 -1.17936154e+00 -2.42970717e-01 -2.42970717e-01
 -2.42970717e-01  1.07212529e+00  1.08146795e+01  6.12653500e+01
  2.44452971e+02  8.56420492e+02  3.09827027e+03  1.25788299e+04
  4.11785985e+04  1.05208449e+05  2.30382694e+05  4.56191020e+05
  8.45138258e+05  1.52831067e+06  2.85057209e+06  5.80845171e+06]
E1 = -706.6785700392917  E_coul = 198.68930777609805
cycle= 6 E= -507.989262263194  delta_E= 5.12e-13  |g|= 2.48e-08  |ddm|= 2.02e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6785700392917  E_coul = 198.68930777609805
  HOMO = -0.242970729309292  LUMO = 1.07212528021971
  mo_energy =
[-1.20326551e+02 -1.23808214e+01 -6.67811035e+00 -6.67811035e+00
 -6.67811035e+00 -1.17936154e+00 -2.42970729e-01 -2.42970729e-01
 -2.42970729e-01  1.07212528e+00  1.08146795e+01  6.12653500e+01
  2.44452971e+02  8.56420492e+02  3.09827027e+03  1.25788299e+04
  4.11785985e+04  1.05208449e+05  2.30382694e+05  4.56191020e+05
  8.45138258e+05  1.52831067e+06  2.85057209e+06  5.80845171e+06]
E1 = -706.6785699829903  E_coul = 198.68930771979612
Extra cycle  E= -507.989262263194  delta_E= -5.68e-13  |g|= 3.53e-09  |ddm|= 4.54e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.49082298e-01 6.48964079e-01 1.17616813e+05 3.02081205e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104178e+04 3.67547029e+04 7.30240608e+03 1.83757742e+04
 1.44398502e+03 4.14160250e+02 1.42991795e+02 5.52751359e+01
 2.29260330e+01 7.53222968e+00 8.60441291e+00 4.92711600e-01]
E = -507.9892622631942
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:17:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.24908229812        1
[INPUT] 0    0    [1    /1   ]  0.648964078552       1
[INPUT] 0    0    [1    /1   ]  117616.812989        1
[INPUT] 0    0    [1    /1   ]  3.02081205033        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069959        1
[INPUT] 0    0    [1    /1   ]  294042.030937        1
[INPUT] 0    0    [1    /1   ]  147020.991384        1
[INPUT] 0    0    [1    /1   ]  73510.4177992        1
[INPUT] 0    0    [1    /1   ]  36754.7028917        1
[INPUT] 0    0    [1    /1   ]  7302.40607562        1
[INPUT] 0    0    [1    /1   ]  18375.7741937        1
[INPUT] 0    0    [1    /1   ]  1443.98502181        1
[INPUT] 0    0    [1    /1   ]  414.160249579        1
[INPUT] 0    0    [1    /1   ]  142.991795232        1
[INPUT] 0    0    [1    /1   ]  55.2751358995        1
[INPUT] 0    0    [1    /1   ]  22.9260329777        1
[INPUT] 0    0    [1    /1   ]  7.53222967974        1
[INPUT] 1    0    [1    /1   ]  8.60441290909        1
[INPUT] 1    0    [1    /1   ]  0.49271159986        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24908229812035812, 1.0]], [0, [0.6489640785524271, 1.0]], [0, [117616.81298858848, 1.0]], [0, [3.02081205033016, 1.0]], [0, [1176168.1426138524, 1.0]], [0, [588084.0699591998, 1.0]], [0, [294042.03093685425, 1.0]], [0, [147020.99138372886, 1.0]], [0, [73510.41779915533, 1.0]], [0, [36754.70289168239, 1.0]], [0, [7302.406075621726, 1.0]], [0, [18375.774193702055, 1.0]], [0, [1443.9850218055374, 1.0]], [0, [414.16024957945336, 1.0]], [0, [142.99179523170537, 1.0]], [0, [55.27513589947735, 1.0]], [0, [22.92603297766641, 1.0]], [0, [7.5322296797383705, 1.0]], [1, [8.604412909091677, 1.0]], [1, [0.4927115998599066, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2490823]
bas 1, expnt(s) = [0.64896408]
bas 2, expnt(s) = [117616.81298859]
bas 3, expnt(s) = [3.02081205]
bas 4, expnt(s) = [1176168.14261385]
bas 5, expnt(s) = [588084.0699592]
bas 6, expnt(s) = [294042.03093685]
bas 7, expnt(s) = [147020.99138373]
bas 8, expnt(s) = [73510.41779916]
bas 9, expnt(s) = [36754.70289168]
bas 10, expnt(s) = [7302.40607562]
bas 11, expnt(s) = [18375.7741937]
bas 12, expnt(s) = [1443.98502181]
bas 13, expnt(s) = [414.16024958]
bas 14, expnt(s) = [142.99179523]
bas 15, expnt(s) = [55.2751359]
bas 16, expnt(s) = [22.92603298]
bas 17, expnt(s) = [7.53222968]
bas 18, expnt(s) = [8.60441291]
bas 19, expnt(s) = [0.4927116]
CPU time:      1192.84
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49082298e-01 8.90783517e-01 6.48964079e-01 1.82675590e+00
 1.17616813e+05 1.60460108e+04 3.02081205e+00 5.78905670e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104178e+04 1.12791583e+04 3.67547029e+04 6.70655841e+03
 7.30240608e+03 1.99578847e+03 1.83757742e+04 3.98748680e+03
 1.44398502e+03 5.91816461e+02 4.14160250e+02 2.31948375e+02
 1.42991795e+02 1.04471628e+02 5.52751359e+01 5.12167939e+01
 2.29260330e+01 2.64704734e+01 7.53222968e+00 1.14870283e+01
 8.60441291e+00 4.29918315e+01 4.92711600e-01 1.20427418e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335938764854973
cond(S) = 911648.5536663472
E1 = -689.5866306199283  E_coul = 184.96773366321116
init E= -504.618896956717
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672287077390428  LUMO = 0.689808574646625
  mo_energy =
[-1.21709924e+02 -1.33862966e+01 -7.62389201e+00 -7.62389201e+00
 -7.62389201e+00 -1.65739978e+00 -6.72287077e-01 -6.72287077e-01
 -6.72287077e-01  6.89808575e-01  1.00059155e+01  6.01006082e+01
  2.43116084e+02  8.55059793e+02  3.09698495e+03  1.25776619e+04
  4.11775017e+04  1.05207391e+05  2.30381661e+05  4.56190005e+05
  8.45137256e+05  1.52830968e+06  2.85057111e+06  5.80845074e+06]
E1 = -707.7405953810078  E_coul = 199.7690999418322
cycle= 1 E= -507.971495439176  delta_E= -3.35  |g|= 0.451  |ddm|= 0.511
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
diis-norm(errvec)=0.705455
diis-c [-0.49766706  1.        ]
  HOMO = -0.217826633733432  LUMO = 1.07906139895543
  mo_energy =
[-1.20201370e+02 -1.23054936e+01 -6.59513938e+00 -6.59513938e+00
 -6.59513938e+00 -1.16330373e+00 -2.17826634e-01 -2.17826634e-01
 -2.17826634e-01  1.07906140e+00  1.08666657e+01  6.13551457e+01
  2.44566780e+02  8.56551453e+02  3.09841630e+03  1.25789865e+04
  4.11787591e+04  1.05208611e+05  2.30382857e+05  4.56191184e+05
  8.45138422e+05  1.52831083e+06  2.85057226e+06  5.80845188e+06]
E1 = -706.8005818085436  E_coul = 198.81158009759886
cycle= 2 E= -507.989001710945  delta_E= -0.0175  |g|= 0.0347  |ddm|= 0.436
    CPU time for cycle= 2      0.13 sec, wall time      0.03 sec
diis-norm(errvec)=0.0293284
diis-c [-8.57425824e-04  2.33894980e-03  9.97661050e-01]
  HOMO = -0.239651003070602  LUMO = 1.07325806731604
  mo_energy =
[-1.20314075e+02 -1.23717469e+01 -6.66852518e+00 -6.66852518e+00
 -6.66852518e+00 -1.17735084e+00 -2.39651003e-01 -2.39651003e-01
 -2.39651003e-01  1.07325807e+00  1.08213695e+01  6.12753910e+01
  2.44464698e+02  8.56433231e+02  3.09828379e+03  1.25788439e+04
  4.11786127e+04  1.05208463e+05  2.30382708e+05  4.56191034e+05
  8.45138272e+05  1.52831068e+06  2.85057211e+06  5.80845173e+06]
E1 = -706.694538105583  E_coul = 198.705280744537
cycle= 3 E= -507.989257361046  delta_E= -0.000256  |g|= 0.00443  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0032278
diis-c [-2.09799822e-06 -7.51842403e-05 -1.09251928e-01  1.10932711e+00]
  HOMO = -0.242834699042544  LUMO = 1.07217837008769
  mo_energy =
[-1.20326211e+02 -1.23804920e+01 -6.67778384e+00 -6.67778384e+00
 -6.67778384e+00 -1.17928056e+00 -2.42834699e-01 -2.42834699e-01
 -2.42834699e-01  1.07217837e+00  1.08149426e+01  6.12656759e+01
  2.44453308e+02  8.56420833e+02  3.09827062e+03  1.25788302e+04
  4.11785989e+04  1.05208449e+05  2.30382694e+05  4.56191020e+05
  8.45138258e+05  1.52831067e+06  2.85057209e+06  5.80845172e+06]
E1 = -706.6792171078544  E_coul = 198.68995485403056
cycle= 4 E= -507.989262253824  delta_E= -4.89e-06  |g|= 0.000199  |ddm|= 0.00951
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000137782
diis-c [-1.28238195e-10 -7.02624222e-06  7.36298061e-03 -9.88497612e-02
  1.09149381e+00]
  HOMO = -0.242970159244952  LUMO = 1.07212533734517
  mo_energy =
[-1.20326549e+02 -1.23808200e+01 -6.67810887e+00 -6.67810887e+00
 -6.67810887e+00 -1.17936106e+00 -2.42970159e-01 -2.42970159e-01
 -2.42970159e-01  1.07212534e+00  1.08146806e+01  6.12653515e+01
  2.44452973e+02  8.56420494e+02  3.09827027e+03  1.25788299e+04
  4.11785985e+04  1.05208449e+05  2.30382694e+05  4.56191020e+05
  8.45138258e+05  1.52831067e+06  2.85057209e+06  5.80845171e+06]
E1 = -706.6785729659334  E_coul = 198.6893107027393
cycle= 5 E= -507.989262263194  delta_E= -9.37e-09  |g|= 9.09e-07  |ddm|= 0.000447
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.59755e-07
diis-c [-3.20758196e-14  1.86741336e-07 -1.22308516e-04  1.45338549e-03
 -1.71424228e-02  1.01581116e+00]
  HOMO = -0.24297071694583  LUMO = 1.07212528806136
  mo_energy =
[-1.20326551e+02 -1.23808214e+01 -6.67811033e+00 -6.67811033e+00
 -6.67811033e+00 -1.17936154e+00 -2.42970717e-01 -2.42970717e-01
 -2.42970717e-01  1.07212529e+00  1.08146795e+01  6.12653500e+01
  2.44452971e+02  8.56420492e+02  3.09827027e+03  1.25788299e+04
  4.11785985e+04  1.05208449e+05  2.30382694e+05  4.56191020e+05
  8.45138258e+05  1.52831067e+06  2.85057209e+06  5.80845171e+06]
E1 = -706.6785700392917  E_coul = 198.68930777609805
cycle= 6 E= -507.989262263194  delta_E= 5.12e-13  |g|= 2.48e-08  |ddm|= 2.02e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6785700392917  E_coul = 198.68930777609805
  HOMO = -0.242970729309292  LUMO = 1.07212528021971
  mo_energy =
[-1.20326551e+02 -1.23808214e+01 -6.67811035e+00 -6.67811035e+00
 -6.67811035e+00 -1.17936154e+00 -2.42970729e-01 -2.42970729e-01
 -2.42970729e-01  1.07212528e+00  1.08146795e+01  6.12653500e+01
  2.44452971e+02  8.56420492e+02  3.09827027e+03  1.25788299e+04
  4.11785985e+04  1.05208449e+05  2.30382694e+05  4.56191020e+05
  8.45138258e+05  1.52831067e+06  2.85057209e+06  5.80845171e+06]
E1 = -706.6785699829903  E_coul = 198.68930771979612
Extra cycle  E= -507.989262263194  delta_E= -5.68e-13  |g|= 3.53e-09  |ddm|= 4.54e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 911648.5536663472
E1 = -706.6785699829903  E_coul = 198.68930771979612
init E= -507.989262263194
    CPU time for initialize scf      3.42 sec, wall time      0.22 sec
  HOMO = -0.24297073101985  LUMO = 1.07212527825829
  mo_energy =
[-1.20326551e+02 -1.23808214e+01 -6.67811036e+00 -6.67811036e+00
 -6.67811036e+00 -1.17936154e+00 -2.42970731e-01 -2.42970731e-01
 -2.42970731e-01  1.07212528e+00  1.08146795e+01  6.12653500e+01
  2.44452971e+02  8.56420492e+02  3.09827027e+03  1.25788299e+04
  4.11785985e+04  1.05208449e+05  2.30382694e+05  4.56191020e+05
  8.45138258e+05  1.52831067e+06  2.85057209e+06  5.80845171e+06]
E1 = -706.6785699756234  E_coul = 198.68930771242896
cycle= 1 E= -507.989262263194  delta_E= -2.84e-13  |g|= 1.35e-09  |ddm|= 5.19e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6785699756234  E_coul = 198.68930771242896
  HOMO = -0.242970731229298  LUMO = 1.07212527856909
  mo_energy =
[-1.20326551e+02 -1.23808214e+01 -6.67811036e+00 -6.67811036e+00
 -6.67811036e+00 -1.17936154e+00 -2.42970731e-01 -2.42970731e-01
 -2.42970731e-01  1.07212528e+00  1.08146795e+01  6.12653500e+01
  2.44452971e+02  8.56420492e+02  3.09827027e+03  1.25788299e+04
  4.11785985e+04  1.05208449e+05  2.30382694e+05  4.56191020e+05
  8.45138258e+05  1.52831067e+06  2.85057209e+06  5.80845171e+06]
E1 = -706.6785699735466  E_coul = 198.68930771035204
Extra cycle  E= -507.989262263195  delta_E= -5.68e-14  |g|= 7.35e-10  |ddm|= 1.31e-09
    CPU time for scf_cycle      3.87 sec, wall time      0.38 sec
exp = [2.49082298e-01 6.48964079e-01 1.17616813e+05 3.02081205e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104178e+04 3.67547029e+04 7.30240608e+03 1.83757742e+04
 1.44398502e+03 4.14160250e+02 1.42991795e+02 5.52751359e+01
 2.29260330e+01 7.53222968e+00 8.60441291e+00 4.92711600e-01]
grad_E = [ 2.24250151e-04 -9.86802771e-05  6.08928936e-09  4.62109863e-05
  4.07432102e-11  1.75040136e-10  9.44446455e-10  3.73187765e-09
  1.55846497e-08  8.12664885e-08  5.12796102e-06  1.99484368e-07
 -4.10083634e-05  2.35411128e-05 -6.22675539e-05 -2.21159317e-07
 -2.27719103e-05  9.19442241e-05  2.33161988e-04  8.43163283e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:17:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.24900438893        1
[INPUT] 0    0    [1    /1   ]  0.64892558822        1
[INPUT] 0    0    [1    /1   ]  117616.812919        1
[INPUT] 0    0    [1    /1   ]  3.02871569405        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030926        1
[INPUT] 0    0    [1    /1   ]  147020.991341        1
[INPUT] 0    0    [1    /1   ]  73510.4176227        1
[INPUT] 0    0    [1    /1   ]  36754.7019373        1
[INPUT] 0    0    [1    /1   ]  7302.34660315        1
[INPUT] 0    0    [1    /1   ]  18375.7721903        1
[INPUT] 0    0    [1    /1   ]  1443.65175685        1
[INPUT] 0    0    [1    /1   ]  416.497383995        1
[INPUT] 0    0    [1    /1   ]  146.228405779        1
[INPUT] 0    0    [1    /1   ]  57.4667441991        1
[INPUT] 0    0    [1    /1   ]  24.3328027443        1
[INPUT] 0    0    [1    /1   ]  7.58477931393        1
[INPUT] 1    0    [1    /1   ]  8.60377613558        1
[INPUT] 1    0    [1    /1   ]  0.492694776969       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24900438893014482, 1.0]], [0, [0.6489255882195549, 1.0]], [0, [117616.81291884565, 1.0]], [0, [3.028715694053832, 1.0]], [0, [1176168.1426135728, 1.0]], [0, [588084.0699573434, 1.0]], [0, [294042.0309260009, 1.0]], [0, [147020.99134120898, 1.0]], [0, [73510.41762266665, 1.0]], [0, [36754.70193729719, 1.0]], [0, [7302.346603149035, 1.0]], [0, [18375.772190263968, 1.0]], [0, [1443.6517568497568, 1.0]], [0, [416.49738399458965, 1.0]], [0, [146.22840577941142, 1.0]], [0, [57.46674419906575, 1.0]], [0, [24.33280274434872, 1.0]], [0, [7.584779313928227, 1.0]], [1, [8.603776135583702, 1.0]], [1, [0.4926947769691071, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24900439]
bas 1, expnt(s) = [0.64892559]
bas 2, expnt(s) = [117616.81291885]
bas 3, expnt(s) = [3.02871569]
bas 4, expnt(s) = [1176168.14261357]
bas 5, expnt(s) = [588084.06995734]
bas 6, expnt(s) = [294042.030926]
bas 7, expnt(s) = [147020.99134121]
bas 8, expnt(s) = [73510.41762267]
bas 9, expnt(s) = [36754.7019373]
bas 10, expnt(s) = [7302.34660315]
bas 11, expnt(s) = [18375.77219026]
bas 12, expnt(s) = [1443.65175685]
bas 13, expnt(s) = [416.49738399]
bas 14, expnt(s) = [146.22840578]
bas 15, expnt(s) = [57.4667442]
bas 16, expnt(s) = [24.33280274]
bas 17, expnt(s) = [7.58477931]
bas 18, expnt(s) = [8.60377614]
bas 19, expnt(s) = [0.49269478]
CPU time:      1204.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49004389e-01 8.90574541e-01 6.48925588e-01 1.82667464e+00
 1.17616813e+05 1.60460108e+04 3.02871569e+00 5.80041284e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104176e+04 1.12791583e+04 3.67547019e+04 6.70655828e+03
 7.30234660e+03 1.99577628e+03 1.83757722e+04 3.98748647e+03
 1.44365176e+03 5.91714017e+02 4.16497384e+02 2.32929360e+02
 1.46228406e+02 1.06240189e+02 5.74667442e+01 5.27323916e+01
 2.43328027e+01 2.76795564e+01 7.58477931e+00 1.15470816e+01
 8.60377614e+00 4.29878545e+01 4.92694777e-01 1.20422279e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33596366716624
cond(S) = 911991.221626502
E1 = -689.5857935698144  E_coul = 184.9643683098379
init E= -504.621425259976
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672301576155054  LUMO = 0.689869617910404
  mo_energy =
[-1.21710636e+02 -1.33865386e+01 -7.62412232e+00 -7.62412232e+00
 -7.62412232e+00 -1.65740396e+00 -6.72301576e-01 -6.72301576e-01
 -6.72301576e-01  6.89869618e-01  1.01331158e+01  6.28160125e+01
  2.54065283e+02  8.77827267e+02  3.12800329e+03  1.26086098e+04
  4.12066393e+04  1.05235378e+05  2.30408869e+05  4.56216646e+05
  8.45163463e+05  1.52833546e+06  2.85059637e+06  5.80847533e+06]
E1 = -707.7353975788263  E_coul = 199.76381511881775
cycle= 1 E= -507.971582460009  delta_E= -3.35  |g|= 0.451  |ddm|= 0.509
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.706546
diis-c [-0.49920793  1.        ]
  HOMO = -0.217875336046496  LUMO = 1.07931885020616
  mo_energy =
[-1.20202273e+02 -1.23058881e+01 -6.59553996e+00 -6.59553996e+00
 -6.59553996e+00 -1.16333915e+00 -2.17875336e-01 -2.17875336e-01
 -2.17875336e-01  1.07931885e+00  1.09997350e+01  6.40828581e+01
  2.55519879e+02  8.79318894e+02  3.12943452e+03  1.26099343e+04
  4.12078966e+04  1.05236598e+05  2.30410065e+05  4.56217825e+05
  8.45164629e+05  1.52833662e+06  2.85059752e+06  5.80847647e+06]
E1 = -706.7958706934724  E_coul = 198.80679306550172
cycle= 2 E= -507.989077627971  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0292295
diis-c [-8.50344320e-04  2.83232149e-03  9.97167679e-01]
  HOMO = -0.239680778326667  LUMO = 1.07350476914104
  mo_energy =
[-1.20314879e+02 -1.23720649e+01 -6.66884531e+00 -6.66884531e+00
 -6.66884531e+00 -1.17737474e+00 -2.39680778e-01 -2.39680778e-01
 -2.39680778e-01  1.07350477e+00  1.09541032e+01  6.40021305e+01
  2.55417301e+02  8.79200625e+02  3.12930212e+03  1.26097919e+04
  4.12077503e+04  1.05236450e+05  2.30409916e+05  4.56217676e+05
  8.45164479e+05  1.52833647e+06  2.85059737e+06  5.80847632e+06]
E1 = -706.6898909861055  E_coul = 198.70055767312567
cycle= 3 E= -507.98933331298  delta_E= -0.000256  |g|= 0.00444  |ddm|= 0.0604
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00323164
diis-c [-2.06654771e-06 -9.62644001e-05 -1.10104025e-01  1.11020029e+00]
  HOMO = -0.242876827809347  LUMO = 1.07241951343391
  mo_energy =
[-1.20327074e+02 -1.23808454e+01 -6.67814300e+00 -6.67814300e+00
 -6.67814300e+00 -1.17931257e+00 -2.42876828e-01 -2.42876828e-01
 -2.42876828e-01  1.07241951e+00  1.09476089e+01  6.39922870e+01
  2.55405816e+02  8.79188156e+02  3.12928888e+03  1.26097781e+04
  4.12077363e+04  1.05236436e+05  2.30409902e+05  4.56217662e+05
  8.45164465e+05  1.52833645e+06  2.85059735e+06  5.80847631e+06]
E1 = -706.6745058265717  E_coul = 198.68516758707247
cycle= 4 E= -507.989338239499  delta_E= -4.93e-06  |g|= 0.000197  |ddm|= 0.00955
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000136378
diis-c [-1.26638416e-10 -6.91353597e-06  7.43857556e-03 -9.87000375e-02
  1.09126838e+00]
  HOMO = -0.24301104909725  LUMO = 1.0723667909258
  mo_energy =
[-1.20327407e+02 -1.23811701e+01 -6.67846448e+00 -6.67846448e+00
 -6.67846448e+00 -1.17939227e+00 -2.43011049e-01 -2.43011049e-01
 -2.43011049e-01  1.07236679e+00  1.09473481e+01  6.39919656e+01
  2.55405485e+02  8.79187823e+02  3.12928855e+03  1.26097778e+04
  4.12077360e+04  1.05236436e+05  2.30409902e+05  4.56217661e+05
  8.45164465e+05  1.52833645e+06  2.85059735e+06  5.80847631e+06]
E1 = -706.6738674385674  E_coul = 198.6845291898643
cycle= 5 E= -507.989338248703  delta_E= -9.2e-09  |g|= 8.68e-07  |ddm|= 0.000443
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.48681e-07
diis-c [-2.70303126e-14  1.87642193e-07 -1.20184227e-04  1.40661714e-03
 -1.65709362e-02  1.01528432e+00]
  HOMO = -0.243011585461214  LUMO = 1.07236675110729
  mo_energy =
[-1.20327409e+02 -1.23811714e+01 -6.67846590e+00 -6.67846590e+00
 -6.67846590e+00 -1.17939274e+00 -2.43011585e-01 -2.43011585e-01
 -2.43011585e-01  1.07236675e+00  1.09473471e+01  6.39919641e+01
  2.55405483e+02  8.79187821e+02  3.12928854e+03  1.26097778e+04
  4.12077360e+04  1.05236436e+05  2.30409902e+05  4.56217661e+05
  8.45164465e+05  1.52833645e+06  2.85059735e+06  5.80847631e+06]
E1 = -706.6738646087524  E_coul = 198.68452636004875
cycle= 6 E= -507.989338248704  delta_E= -5.68e-13  |g|= 2.23e-08  |ddm|= 1.93e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6738646087524  E_coul = 198.68452636004875
  HOMO = -0.243011596557022  LUMO = 1.07236674208945
  mo_energy =
[-1.20327409e+02 -1.23811715e+01 -6.67846593e+00 -6.67846593e+00
 -6.67846593e+00 -1.17939274e+00 -2.43011597e-01 -2.43011597e-01
 -2.43011597e-01  1.07236674e+00  1.09473471e+01  6.39919641e+01
  2.55405483e+02  8.79187821e+02  3.12928854e+03  1.26097778e+04
  4.12077360e+04  1.05236436e+05  2.30409902e+05  4.56217661e+05
  8.45164465e+05  1.52833645e+06  2.85059735e+06  5.80847631e+06]
E1 = -706.6738645590801  E_coul = 198.68452631037673
Extra cycle  E= -507.989338248703  delta_E= 2.84e-13  |g|= 4.65e-09  |ddm|= 4.02e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.28 sec
exp = [2.49004389e-01 6.48925588e-01 1.17616813e+05 3.02871569e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104176e+04 3.67547019e+04 7.30234660e+03 1.83757722e+04
 1.44365176e+03 4.16497384e+02 1.46228406e+02 5.74667442e+01
 2.43328027e+01 7.58477931e+00 8.60377614e+00 4.92694777e-01]
E = -507.9893382487034
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:17:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.24900438893        1
[INPUT] 0    0    [1    /1   ]  0.64892558822        1
[INPUT] 0    0    [1    /1   ]  117616.812919        1
[INPUT] 0    0    [1    /1   ]  3.02871569405        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030926        1
[INPUT] 0    0    [1    /1   ]  147020.991341        1
[INPUT] 0    0    [1    /1   ]  73510.4176227        1
[INPUT] 0    0    [1    /1   ]  36754.7019373        1
[INPUT] 0    0    [1    /1   ]  7302.34660315        1
[INPUT] 0    0    [1    /1   ]  18375.7721903        1
[INPUT] 0    0    [1    /1   ]  1443.65175685        1
[INPUT] 0    0    [1    /1   ]  416.497383995        1
[INPUT] 0    0    [1    /1   ]  146.228405779        1
[INPUT] 0    0    [1    /1   ]  57.4667441991        1
[INPUT] 0    0    [1    /1   ]  24.3328027443        1
[INPUT] 0    0    [1    /1   ]  7.58477931393        1
[INPUT] 1    0    [1    /1   ]  8.60377613558        1
[INPUT] 1    0    [1    /1   ]  0.492694776969       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24900438893014482, 1.0]], [0, [0.6489255882195549, 1.0]], [0, [117616.81291884565, 1.0]], [0, [3.028715694053832, 1.0]], [0, [1176168.1426135728, 1.0]], [0, [588084.0699573434, 1.0]], [0, [294042.0309260009, 1.0]], [0, [147020.99134120898, 1.0]], [0, [73510.41762266665, 1.0]], [0, [36754.70193729719, 1.0]], [0, [7302.346603149035, 1.0]], [0, [18375.772190263968, 1.0]], [0, [1443.6517568497568, 1.0]], [0, [416.49738399458965, 1.0]], [0, [146.22840577941142, 1.0]], [0, [57.46674419906575, 1.0]], [0, [24.33280274434872, 1.0]], [0, [7.584779313928227, 1.0]], [1, [8.603776135583702, 1.0]], [1, [0.4926947769691071, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24900439]
bas 1, expnt(s) = [0.64892559]
bas 2, expnt(s) = [117616.81291885]
bas 3, expnt(s) = [3.02871569]
bas 4, expnt(s) = [1176168.14261357]
bas 5, expnt(s) = [588084.06995734]
bas 6, expnt(s) = [294042.030926]
bas 7, expnt(s) = [147020.99134121]
bas 8, expnt(s) = [73510.41762267]
bas 9, expnt(s) = [36754.7019373]
bas 10, expnt(s) = [7302.34660315]
bas 11, expnt(s) = [18375.77219026]
bas 12, expnt(s) = [1443.65175685]
bas 13, expnt(s) = [416.49738399]
bas 14, expnt(s) = [146.22840578]
bas 15, expnt(s) = [57.4667442]
bas 16, expnt(s) = [24.33280274]
bas 17, expnt(s) = [7.58477931]
bas 18, expnt(s) = [8.60377614]
bas 19, expnt(s) = [0.49269478]
CPU time:      1206.65
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49004389e-01 8.90574541e-01 6.48925588e-01 1.82667464e+00
 1.17616813e+05 1.60460108e+04 3.02871569e+00 5.80041284e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104176e+04 1.12791583e+04 3.67547019e+04 6.70655828e+03
 7.30234660e+03 1.99577628e+03 1.83757722e+04 3.98748647e+03
 1.44365176e+03 5.91714017e+02 4.16497384e+02 2.32929360e+02
 1.46228406e+02 1.06240189e+02 5.74667442e+01 5.27323916e+01
 2.43328027e+01 2.76795564e+01 7.58477931e+00 1.15470816e+01
 8.60377614e+00 4.29878545e+01 4.92694777e-01 1.20422279e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33596366716624
cond(S) = 911991.221626502
E1 = -689.5857935698144  E_coul = 184.9643683098379
init E= -504.621425259976
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672301576155054  LUMO = 0.689869617910404
  mo_energy =
[-1.21710636e+02 -1.33865386e+01 -7.62412232e+00 -7.62412232e+00
 -7.62412232e+00 -1.65740396e+00 -6.72301576e-01 -6.72301576e-01
 -6.72301576e-01  6.89869618e-01  1.01331158e+01  6.28160125e+01
  2.54065283e+02  8.77827267e+02  3.12800329e+03  1.26086098e+04
  4.12066393e+04  1.05235378e+05  2.30408869e+05  4.56216646e+05
  8.45163463e+05  1.52833546e+06  2.85059637e+06  5.80847533e+06]
E1 = -707.7353975788263  E_coul = 199.76381511881775
cycle= 1 E= -507.971582460009  delta_E= -3.35  |g|= 0.451  |ddm|= 0.509
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.706546
diis-c [-0.49920793  1.        ]
  HOMO = -0.217875336046496  LUMO = 1.07931885020616
  mo_energy =
[-1.20202273e+02 -1.23058881e+01 -6.59553996e+00 -6.59553996e+00
 -6.59553996e+00 -1.16333915e+00 -2.17875336e-01 -2.17875336e-01
 -2.17875336e-01  1.07931885e+00  1.09997350e+01  6.40828581e+01
  2.55519879e+02  8.79318894e+02  3.12943452e+03  1.26099343e+04
  4.12078966e+04  1.05236598e+05  2.30410065e+05  4.56217825e+05
  8.45164629e+05  1.52833662e+06  2.85059752e+06  5.80847647e+06]
E1 = -706.7958706934724  E_coul = 198.80679306550172
cycle= 2 E= -507.989077627971  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0292295
diis-c [-8.50344320e-04  2.83232149e-03  9.97167679e-01]
  HOMO = -0.239680778326667  LUMO = 1.07350476914104
  mo_energy =
[-1.20314879e+02 -1.23720649e+01 -6.66884531e+00 -6.66884531e+00
 -6.66884531e+00 -1.17737474e+00 -2.39680778e-01 -2.39680778e-01
 -2.39680778e-01  1.07350477e+00  1.09541032e+01  6.40021305e+01
  2.55417301e+02  8.79200625e+02  3.12930212e+03  1.26097919e+04
  4.12077503e+04  1.05236450e+05  2.30409916e+05  4.56217676e+05
  8.45164479e+05  1.52833647e+06  2.85059737e+06  5.80847632e+06]
E1 = -706.6898909861055  E_coul = 198.70055767312567
cycle= 3 E= -507.98933331298  delta_E= -0.000256  |g|= 0.00444  |ddm|= 0.0604
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00323164
diis-c [-2.06654771e-06 -9.62644001e-05 -1.10104025e-01  1.11020029e+00]
  HOMO = -0.242876827809347  LUMO = 1.07241951343391
  mo_energy =
[-1.20327074e+02 -1.23808454e+01 -6.67814300e+00 -6.67814300e+00
 -6.67814300e+00 -1.17931257e+00 -2.42876828e-01 -2.42876828e-01
 -2.42876828e-01  1.07241951e+00  1.09476089e+01  6.39922870e+01
  2.55405816e+02  8.79188156e+02  3.12928888e+03  1.26097781e+04
  4.12077363e+04  1.05236436e+05  2.30409902e+05  4.56217662e+05
  8.45164465e+05  1.52833645e+06  2.85059735e+06  5.80847631e+06]
E1 = -706.6745058265717  E_coul = 198.68516758707247
cycle= 4 E= -507.989338239499  delta_E= -4.93e-06  |g|= 0.000197  |ddm|= 0.00955
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000136378
diis-c [-1.26638416e-10 -6.91353597e-06  7.43857556e-03 -9.87000375e-02
  1.09126838e+00]
  HOMO = -0.24301104909725  LUMO = 1.0723667909258
  mo_energy =
[-1.20327407e+02 -1.23811701e+01 -6.67846448e+00 -6.67846448e+00
 -6.67846448e+00 -1.17939227e+00 -2.43011049e-01 -2.43011049e-01
 -2.43011049e-01  1.07236679e+00  1.09473481e+01  6.39919656e+01
  2.55405485e+02  8.79187823e+02  3.12928855e+03  1.26097778e+04
  4.12077360e+04  1.05236436e+05  2.30409902e+05  4.56217661e+05
  8.45164465e+05  1.52833645e+06  2.85059735e+06  5.80847631e+06]
E1 = -706.6738674385674  E_coul = 198.6845291898643
cycle= 5 E= -507.989338248703  delta_E= -9.2e-09  |g|= 8.68e-07  |ddm|= 0.000443
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.48681e-07
diis-c [-2.70303126e-14  1.87642193e-07 -1.20184227e-04  1.40661714e-03
 -1.65709362e-02  1.01528432e+00]
  HOMO = -0.243011585461214  LUMO = 1.07236675110729
  mo_energy =
[-1.20327409e+02 -1.23811714e+01 -6.67846590e+00 -6.67846590e+00
 -6.67846590e+00 -1.17939274e+00 -2.43011585e-01 -2.43011585e-01
 -2.43011585e-01  1.07236675e+00  1.09473471e+01  6.39919641e+01
  2.55405483e+02  8.79187821e+02  3.12928854e+03  1.26097778e+04
  4.12077360e+04  1.05236436e+05  2.30409902e+05  4.56217661e+05
  8.45164465e+05  1.52833645e+06  2.85059735e+06  5.80847631e+06]
E1 = -706.6738646087524  E_coul = 198.68452636004875
cycle= 6 E= -507.989338248704  delta_E= -5.68e-13  |g|= 2.23e-08  |ddm|= 1.93e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6738646087524  E_coul = 198.68452636004875
  HOMO = -0.243011596557022  LUMO = 1.07236674208945
  mo_energy =
[-1.20327409e+02 -1.23811715e+01 -6.67846593e+00 -6.67846593e+00
 -6.67846593e+00 -1.17939274e+00 -2.43011597e-01 -2.43011597e-01
 -2.43011597e-01  1.07236674e+00  1.09473471e+01  6.39919641e+01
  2.55405483e+02  8.79187821e+02  3.12928854e+03  1.26097778e+04
  4.12077360e+04  1.05236436e+05  2.30409902e+05  4.56217661e+05
  8.45164465e+05  1.52833645e+06  2.85059735e+06  5.80847631e+06]
E1 = -706.6738645590801  E_coul = 198.68452631037673
Extra cycle  E= -507.989338248703  delta_E= 2.84e-13  |g|= 4.65e-09  |ddm|= 4.02e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 911991.221626502
E1 = -706.6738645590801  E_coul = 198.68452631037673
init E= -507.989338248703
    CPU time for initialize scf      3.47 sec, wall time      0.22 sec
  HOMO = -0.243011598059871  LUMO = 1.07236674621556
  mo_energy =
[-1.20327409e+02 -1.23811715e+01 -6.67846593e+00 -6.67846593e+00
 -6.67846593e+00 -1.17939274e+00 -2.43011598e-01 -2.43011598e-01
 -2.43011598e-01  1.07236675e+00  1.09473471e+01  6.39919641e+01
  2.55405483e+02  8.79187821e+02  3.12928854e+03  1.26097778e+04
  4.12077360e+04  1.05236436e+05  2.30409902e+05  4.56217661e+05
  8.45164465e+05  1.52833645e+06  2.85059735e+06  5.80847631e+06]
E1 = -706.6738645484616  E_coul = 198.68452629975798
cycle= 1 E= -507.989338248704  delta_E= -1.71e-13  |g|= 1.14e-09  |ddm|= 7.43e-09
    CPU time for cycle= 1      0.29 sec, wall time      0.03 sec
E1 = -706.6738645484616  E_coul = 198.68452629975798
  HOMO = -0.243011598384278  LUMO = 1.07236674385499
  mo_energy =
[-1.20327409e+02 -1.23811715e+01 -6.67846593e+00 -6.67846593e+00
 -6.67846593e+00 -1.17939274e+00 -2.43011598e-01 -2.43011598e-01
 -2.43011598e-01  1.07236674e+00  1.09473471e+01  6.39919641e+01
  2.55405483e+02  8.79187821e+02  3.12928854e+03  1.26097778e+04
  4.12077360e+04  1.05236436e+05  2.30409902e+05  4.56217661e+05
  8.45164465e+05  1.52833645e+06  2.85059735e+06  5.80847631e+06]
E1 = -706.6738645506183  E_coul = 198.68452630191442
Extra cycle  E= -507.989338248704  delta_E= -3.41e-13  |g|= 1.17e-09  |ddm|= 1.34e-09
    CPU time for scf_cycle      3.91 sec, wall time      0.39 sec
exp = [2.49004389e-01 6.48925588e-01 1.17616813e+05 3.02871569e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104176e+04 3.67547019e+04 7.30234660e+03 1.83757722e+04
 1.44365176e+03 4.16497384e+02 1.46228406e+02 5.74667442e+01
 2.43328027e+01 7.58477931e+00 8.60377614e+00 4.92694777e-01]
grad_E = [ 4.67321680e-04 -1.87247242e-04  6.06774538e-09 -1.16046604e-03
  4.05012278e-11  1.74334371e-10  9.41143331e-10  3.71853998e-09
  1.55281808e-08  8.09911992e-08  5.10604521e-06  1.98595746e-07
 -3.89206476e-05 -2.77674815e-06  2.16323130e-05 -1.30362460e-04
  1.47503258e-04  5.13930568e-04 -2.97871261e-04 -5.89807605e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:17:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249159145164       1
[INPUT] 0    0    [1    /1   ]  0.64881082077        1
[INPUT] 0    0    [1    /1   ]  117616.812916        1
[INPUT] 0    0    [1    /1   ]  3.03957133351        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030926        1
[INPUT] 0    0    [1    /1   ]  147020.99134         1
[INPUT] 0    0    [1    /1   ]  73510.4176166        1
[INPUT] 0    0    [1    /1   ]  36754.7019049        1
[INPUT] 0    0    [1    /1   ]  7302.34453793        1
[INPUT] 0    0    [1    /1   ]  18375.7721173        1
[INPUT] 0    0    [1    /1   ]  1443.66302616        1
[INPUT] 0    0    [1    /1   ]  416.362469944        1
[INPUT] 0    0    [1    /1   ]  146.703596086        1
[INPUT] 0    0    [1    /1   ]  57.7447682303        1
[INPUT] 0    0    [1    /1   ]  24.2596867718        1
[INPUT] 0    0    [1    /1   ]  7.5898789083         1
[INPUT] 1    0    [1    /1   ]  8.60358787144        1
[INPUT] 1    0    [1    /1   ]  0.492690730798       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24915914516375912, 1.0]], [0, [0.6488108207704536, 1.0]], [0, [117616.81291645508, 1.0]], [0, [3.0395713335089614, 1.0]], [0, [1176168.1426135597, 1.0]], [0, [588084.0699572773, 1.0]], [0, [294042.0309256292, 1.0]], [0, [147020.99133974806, 1.0]], [0, [73510.41761658632, 1.0]], [0, [36754.70190493254, 1.0]], [0, [7302.3445379317445, 1.0]], [0, [18375.772117323817, 1.0]], [0, [1443.663026164118, 1.0]], [0, [416.36246994413887, 1.0]], [0, [146.7035960859256, 1.0]], [0, [57.744768230251026, 1.0]], [0, [24.259686771831998, 1.0]], [0, [7.589878908295605, 1.0]], [1, [8.603587871436009, 1.0]], [1, [0.4926907307984522, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24915915]
bas 1, expnt(s) = [0.64881082]
bas 2, expnt(s) = [117616.81291646]
bas 3, expnt(s) = [3.03957133]
bas 4, expnt(s) = [1176168.14261356]
bas 5, expnt(s) = [588084.06995728]
bas 6, expnt(s) = [294042.03092563]
bas 7, expnt(s) = [147020.99133975]
bas 8, expnt(s) = [73510.41761659]
bas 9, expnt(s) = [36754.70190493]
bas 10, expnt(s) = [7302.34453793]
bas 11, expnt(s) = [18375.77211732]
bas 12, expnt(s) = [1443.66302616]
bas 13, expnt(s) = [416.36246994]
bas 14, expnt(s) = [146.70359609]
bas 15, expnt(s) = [57.74476823]
bas 16, expnt(s) = [24.25968677]
bas 17, expnt(s) = [7.58987891]
bas 18, expnt(s) = [8.60358787]
bas 19, expnt(s) = [0.49269073]
CPU time:      1218.80
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49159145e-01 8.90989628e-01 6.48810821e-01 1.82643234e+00
 1.17616813e+05 1.60460108e+04 3.03957133e+00 5.81599841e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104176e+04 1.12791583e+04 3.67547019e+04 6.70655828e+03
 7.30234454e+03 1.99577585e+03 1.83757721e+04 3.98748646e+03
 1.44366303e+03 5.91717481e+02 4.16362470e+02 2.32872769e+02
 1.46703596e+02 1.06499016e+02 5.77447682e+01 5.29236156e+01
 2.42596868e+01 2.76171536e+01 7.58987891e+00 1.15529039e+01
 8.60358787e+00 4.29866787e+01 4.92690731e-01 1.20421042e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335964970553245
cond(S) = 912012.9097204615
E1 = -689.5840714404254  E_coul = 184.9633601823751
init E= -504.62071125805
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672302698123663  LUMO = 0.6906339236725
  mo_energy =
[-1.21710862e+02 -1.33865999e+01 -7.62419467e+00 -7.62419467e+00
 -7.62419467e+00 -1.65743338e+00 -6.72302698e-01 -6.72302698e-01
 -6.72302698e-01  6.90633924e-01  1.01601659e+01  6.28660177e+01
  2.54685252e+02  8.79584962e+02  3.13015702e+03  1.26106019e+04
  4.12084987e+04  1.05237163e+05  2.30410605e+05  4.56218346e+05
  8.45165135e+05  1.52833711e+06  2.85059798e+06  5.80847690e+06]
E1 = -707.7354950102979  E_coul = 199.7638854632554
cycle= 1 E= -507.971609547042  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.706415
diis-c [-0.49902208  1.        ]
  HOMO = -0.217873017186972  LUMO = 1.08028857765495
  mo_energy =
[-1.20202380e+02 -1.23058528e+01 -6.59550646e+00 -6.59550646e+00
 -6.59550646e+00 -1.16335369e+00 -2.17873017e-01 -2.17873017e-01
 -2.17873017e-01  1.08028858e+00  1.10274831e+01  6.41330766e+01
  2.56140230e+02  8.81076732e+02  3.13158837e+03  1.26119265e+04
  4.12097561e+04  1.05238383e+05  2.30411801e+05  4.56219525e+05
  8.45166301e+05  1.52833826e+06  2.85059913e+06  5.80847804e+06]
E1 = -706.7958998236453  E_coul = 198.8067943467017
cycle= 2 E= -507.989105476944  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0292084
diis-c [-8.49153469e-04  2.81703660e-03  9.97182963e-01]
  HOMO = -0.239685166800722  LUMO = 1.07446172580001
  mo_energy =
[-1.20314977e+02 -1.23720397e+01 -6.66881656e+00 -6.66881656e+00
 -6.66881656e+00 -1.17739498e+00 -2.39685167e-01 -2.39685167e-01
 -2.39685167e-01  1.07446173e+00  1.09817858e+01  6.40523344e+01
  2.56037612e+02  8.80958459e+02  3.13145599e+03  1.26117841e+04
  4.12096098e+04  1.05238236e+05  2.30411652e+05  4.56219376e+05
  8.45166151e+05  1.52833811e+06  2.85059898e+06  5.80847789e+06]
E1 = -706.6899062729237  E_coul = 198.7005451210188
cycle= 3 E= -507.989361151905  delta_E= -0.000256  |g|= 0.00444  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322776
diis-c [-2.06244490e-06 -9.51155548e-05 -1.10038503e-01  1.11013362e+00]
  HOMO = -0.242880884125334  LUMO = 1.07337495319326
  mo_energy =
[-1.20327172e+02 -1.23808201e+01 -6.67811385e+00 -6.67811385e+00
 -6.67811385e+00 -1.17933266e+00 -2.42880884e-01 -2.42880884e-01
 -2.42880884e-01  1.07337495e+00  1.09752852e+01  6.40424904e+01
  2.56026124e+02  8.80945990e+02  3.13144275e+03  1.26117703e+04
  4.12095959e+04  1.05238222e+05  2.30411638e+05  4.56219362e+05
  8.45166137e+05  1.52833810e+06  2.85059897e+06  5.80847788e+06]
E1 = -706.6745256459252  E_coul = 198.6851595727179
cycle= 4 E= -507.989366073207  delta_E= -4.92e-06  |g|= 0.000197  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000136219
diis-c [-1.26046969e-10 -6.89074550e-06  7.43104173e-03 -9.86717613e-02
  1.09124761e+00]
  HOMO = -0.243015077830267  LUMO = 1.07332219218062
  mo_energy =
[-1.20327505e+02 -1.23811449e+01 -6.67843551e+00 -6.67843551e+00
 -6.67843551e+00 -1.17941234e+00 -2.43015078e-01 -2.43015078e-01
 -2.43015078e-01  1.07332219e+00  1.09750243e+01  6.40421688e+01
  2.56025793e+02  8.80945656e+02  3.13144241e+03  1.26117700e+04
  4.12095955e+04  1.05238221e+05  2.30411638e+05  4.56219361e+05
  8.45166137e+05  1.52833810e+06  2.85059896e+06  5.80847787e+06]
E1 = -706.6738875045997  E_coul = 198.684521422207
cycle= 5 E= -507.989366082393  delta_E= -9.19e-09  |g|= 8.56e-07  |ddm|= 0.000442
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.39715e-07
diis-c [-2.61486170e-14  1.77940371e-07 -1.17577556e-04  1.37609427e-03
 -1.62325842e-02  1.01497389e+00]
  HOMO = -0.243015607225284  LUMO = 1.07332215537059
  mo_energy =
[-1.20327507e+02 -1.23811462e+01 -6.67843692e+00 -6.67843692e+00
 -6.67843692e+00 -1.17941280e+00 -2.43015607e-01 -2.43015607e-01
 -2.43015607e-01  1.07332216e+00  1.09750232e+01  6.40421673e+01
  2.56025791e+02  8.80945654e+02  3.13144241e+03  1.26117700e+04
  4.12095955e+04  1.05238221e+05  2.30411638e+05  4.56219361e+05
  8.45166137e+05  1.52833810e+06  2.85059896e+06  5.80847787e+06]
E1 = -706.6738847099784  E_coul = 198.6845186275856
cycle= 6 E= -507.989366082393  delta_E= -1.14e-13  |g|= 2.14e-08  |ddm|= 1.9e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6738847099784  E_coul = 198.6845186275856
  HOMO = -0.24301561818193  LUMO = 1.07332214927206
  mo_energy =
[-1.20327507e+02 -1.23811463e+01 -6.67843694e+00 -6.67843694e+00
 -6.67843694e+00 -1.17941280e+00 -2.43015618e-01 -2.43015618e-01
 -2.43015618e-01  1.07332215e+00  1.09750232e+01  6.40421673e+01
  2.56025791e+02  8.80945654e+02  3.13144241e+03  1.26117700e+04
  4.12095955e+04  1.05238221e+05  2.30411638e+05  4.56219361e+05
  8.45166137e+05  1.52833810e+06  2.85059896e+06  5.80847787e+06]
E1 = -706.6738846605223  E_coul = 198.68451857812914
Extra cycle  E= -507.989366082393  delta_E= -2.84e-13  |g|= 2.74e-09  |ddm|= 3.99e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.28 sec
exp = [2.49159145e-01 6.48810821e-01 1.17616813e+05 3.03957133e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104176e+04 3.67547019e+04 7.30234454e+03 1.83757721e+04
 1.44366303e+03 4.16362470e+02 1.46703596e+02 5.77447682e+01
 2.42596868e+01 7.58987891e+00 8.60358787e+00 4.92690731e-01]
E = -507.98936608239313
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:18:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249159145164       1
[INPUT] 0    0    [1    /1   ]  0.64881082077        1
[INPUT] 0    0    [1    /1   ]  117616.812916        1
[INPUT] 0    0    [1    /1   ]  3.03957133351        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030926        1
[INPUT] 0    0    [1    /1   ]  147020.99134         1
[INPUT] 0    0    [1    /1   ]  73510.4176166        1
[INPUT] 0    0    [1    /1   ]  36754.7019049        1
[INPUT] 0    0    [1    /1   ]  7302.34453793        1
[INPUT] 0    0    [1    /1   ]  18375.7721173        1
[INPUT] 0    0    [1    /1   ]  1443.66302616        1
[INPUT] 0    0    [1    /1   ]  416.362469944        1
[INPUT] 0    0    [1    /1   ]  146.703596086        1
[INPUT] 0    0    [1    /1   ]  57.7447682303        1
[INPUT] 0    0    [1    /1   ]  24.2596867718        1
[INPUT] 0    0    [1    /1   ]  7.5898789083         1
[INPUT] 1    0    [1    /1   ]  8.60358787144        1
[INPUT] 1    0    [1    /1   ]  0.492690730798       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24915914516375912, 1.0]], [0, [0.6488108207704536, 1.0]], [0, [117616.81291645508, 1.0]], [0, [3.0395713335089614, 1.0]], [0, [1176168.1426135597, 1.0]], [0, [588084.0699572773, 1.0]], [0, [294042.0309256292, 1.0]], [0, [147020.99133974806, 1.0]], [0, [73510.41761658632, 1.0]], [0, [36754.70190493254, 1.0]], [0, [7302.3445379317445, 1.0]], [0, [18375.772117323817, 1.0]], [0, [1443.663026164118, 1.0]], [0, [416.36246994413887, 1.0]], [0, [146.7035960859256, 1.0]], [0, [57.744768230251026, 1.0]], [0, [24.259686771831998, 1.0]], [0, [7.589878908295605, 1.0]], [1, [8.603587871436009, 1.0]], [1, [0.4926907307984522, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24915915]
bas 1, expnt(s) = [0.64881082]
bas 2, expnt(s) = [117616.81291646]
bas 3, expnt(s) = [3.03957133]
bas 4, expnt(s) = [1176168.14261356]
bas 5, expnt(s) = [588084.06995728]
bas 6, expnt(s) = [294042.03092563]
bas 7, expnt(s) = [147020.99133975]
bas 8, expnt(s) = [73510.41761659]
bas 9, expnt(s) = [36754.70190493]
bas 10, expnt(s) = [7302.34453793]
bas 11, expnt(s) = [18375.77211732]
bas 12, expnt(s) = [1443.66302616]
bas 13, expnt(s) = [416.36246994]
bas 14, expnt(s) = [146.70359609]
bas 15, expnt(s) = [57.74476823]
bas 16, expnt(s) = [24.25968677]
bas 17, expnt(s) = [7.58987891]
bas 18, expnt(s) = [8.60358787]
bas 19, expnt(s) = [0.49269073]
CPU time:      1220.48
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49159145e-01 8.90989628e-01 6.48810821e-01 1.82643234e+00
 1.17616813e+05 1.60460108e+04 3.03957133e+00 5.81599841e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104176e+04 1.12791583e+04 3.67547019e+04 6.70655828e+03
 7.30234454e+03 1.99577585e+03 1.83757721e+04 3.98748646e+03
 1.44366303e+03 5.91717481e+02 4.16362470e+02 2.32872769e+02
 1.46703596e+02 1.06499016e+02 5.77447682e+01 5.29236156e+01
 2.42596868e+01 2.76171536e+01 7.58987891e+00 1.15529039e+01
 8.60358787e+00 4.29866787e+01 4.92690731e-01 1.20421042e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335964970553245
cond(S) = 912012.9097204615
E1 = -689.5840714404254  E_coul = 184.9633601823751
init E= -504.62071125805
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672302698123663  LUMO = 0.6906339236725
  mo_energy =
[-1.21710862e+02 -1.33865999e+01 -7.62419467e+00 -7.62419467e+00
 -7.62419467e+00 -1.65743338e+00 -6.72302698e-01 -6.72302698e-01
 -6.72302698e-01  6.90633924e-01  1.01601659e+01  6.28660177e+01
  2.54685252e+02  8.79584962e+02  3.13015702e+03  1.26106019e+04
  4.12084987e+04  1.05237163e+05  2.30410605e+05  4.56218346e+05
  8.45165135e+05  1.52833711e+06  2.85059798e+06  5.80847690e+06]
E1 = -707.7354950102979  E_coul = 199.7638854632554
cycle= 1 E= -507.971609547042  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.706415
diis-c [-0.49902208  1.        ]
  HOMO = -0.217873017186972  LUMO = 1.08028857765495
  mo_energy =
[-1.20202380e+02 -1.23058528e+01 -6.59550646e+00 -6.59550646e+00
 -6.59550646e+00 -1.16335369e+00 -2.17873017e-01 -2.17873017e-01
 -2.17873017e-01  1.08028858e+00  1.10274831e+01  6.41330766e+01
  2.56140230e+02  8.81076732e+02  3.13158837e+03  1.26119265e+04
  4.12097561e+04  1.05238383e+05  2.30411801e+05  4.56219525e+05
  8.45166301e+05  1.52833826e+06  2.85059913e+06  5.80847804e+06]
E1 = -706.7958998236453  E_coul = 198.8067943467017
cycle= 2 E= -507.989105476944  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0292084
diis-c [-8.49153469e-04  2.81703660e-03  9.97182963e-01]
  HOMO = -0.239685166800722  LUMO = 1.07446172580001
  mo_energy =
[-1.20314977e+02 -1.23720397e+01 -6.66881656e+00 -6.66881656e+00
 -6.66881656e+00 -1.17739498e+00 -2.39685167e-01 -2.39685167e-01
 -2.39685167e-01  1.07446173e+00  1.09817858e+01  6.40523344e+01
  2.56037612e+02  8.80958459e+02  3.13145599e+03  1.26117841e+04
  4.12096098e+04  1.05238236e+05  2.30411652e+05  4.56219376e+05
  8.45166151e+05  1.52833811e+06  2.85059898e+06  5.80847789e+06]
E1 = -706.6899062729237  E_coul = 198.7005451210188
cycle= 3 E= -507.989361151905  delta_E= -0.000256  |g|= 0.00444  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322776
diis-c [-2.06244490e-06 -9.51155548e-05 -1.10038503e-01  1.11013362e+00]
  HOMO = -0.242880884125334  LUMO = 1.07337495319326
  mo_energy =
[-1.20327172e+02 -1.23808201e+01 -6.67811385e+00 -6.67811385e+00
 -6.67811385e+00 -1.17933266e+00 -2.42880884e-01 -2.42880884e-01
 -2.42880884e-01  1.07337495e+00  1.09752852e+01  6.40424904e+01
  2.56026124e+02  8.80945990e+02  3.13144275e+03  1.26117703e+04
  4.12095959e+04  1.05238222e+05  2.30411638e+05  4.56219362e+05
  8.45166137e+05  1.52833810e+06  2.85059897e+06  5.80847788e+06]
E1 = -706.6745256459252  E_coul = 198.6851595727179
cycle= 4 E= -507.989366073207  delta_E= -4.92e-06  |g|= 0.000197  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000136219
diis-c [-1.26046969e-10 -6.89074550e-06  7.43104173e-03 -9.86717613e-02
  1.09124761e+00]
  HOMO = -0.243015077830267  LUMO = 1.07332219218062
  mo_energy =
[-1.20327505e+02 -1.23811449e+01 -6.67843551e+00 -6.67843551e+00
 -6.67843551e+00 -1.17941234e+00 -2.43015078e-01 -2.43015078e-01
 -2.43015078e-01  1.07332219e+00  1.09750243e+01  6.40421688e+01
  2.56025793e+02  8.80945656e+02  3.13144241e+03  1.26117700e+04
  4.12095955e+04  1.05238221e+05  2.30411638e+05  4.56219361e+05
  8.45166137e+05  1.52833810e+06  2.85059896e+06  5.80847787e+06]
E1 = -706.6738875045997  E_coul = 198.684521422207
cycle= 5 E= -507.989366082393  delta_E= -9.19e-09  |g|= 8.56e-07  |ddm|= 0.000442
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.39715e-07
diis-c [-2.61486170e-14  1.77940371e-07 -1.17577556e-04  1.37609427e-03
 -1.62325842e-02  1.01497389e+00]
  HOMO = -0.243015607225284  LUMO = 1.07332215537059
  mo_energy =
[-1.20327507e+02 -1.23811462e+01 -6.67843692e+00 -6.67843692e+00
 -6.67843692e+00 -1.17941280e+00 -2.43015607e-01 -2.43015607e-01
 -2.43015607e-01  1.07332216e+00  1.09750232e+01  6.40421673e+01
  2.56025791e+02  8.80945654e+02  3.13144241e+03  1.26117700e+04
  4.12095955e+04  1.05238221e+05  2.30411638e+05  4.56219361e+05
  8.45166137e+05  1.52833810e+06  2.85059896e+06  5.80847787e+06]
E1 = -706.6738847099784  E_coul = 198.6845186275856
cycle= 6 E= -507.989366082393  delta_E= -1.14e-13  |g|= 2.14e-08  |ddm|= 1.9e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6738847099784  E_coul = 198.6845186275856
  HOMO = -0.24301561818193  LUMO = 1.07332214927206
  mo_energy =
[-1.20327507e+02 -1.23811463e+01 -6.67843694e+00 -6.67843694e+00
 -6.67843694e+00 -1.17941280e+00 -2.43015618e-01 -2.43015618e-01
 -2.43015618e-01  1.07332215e+00  1.09750232e+01  6.40421673e+01
  2.56025791e+02  8.80945654e+02  3.13144241e+03  1.26117700e+04
  4.12095955e+04  1.05238221e+05  2.30411638e+05  4.56219361e+05
  8.45166137e+05  1.52833810e+06  2.85059896e+06  5.80847787e+06]
E1 = -706.6738846605223  E_coul = 198.68451857812914
Extra cycle  E= -507.989366082393  delta_E= -2.84e-13  |g|= 2.74e-09  |ddm|= 3.99e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912012.9097204615
E1 = -706.6738846605223  E_coul = 198.68451857812914
init E= -507.989366082393
    CPU time for initialize scf      3.42 sec, wall time      0.22 sec
  HOMO = -0.243015619693834  LUMO = 1.0733221477215
  mo_energy =
[-1.20327507e+02 -1.23811463e+01 -6.67843695e+00 -6.67843695e+00
 -6.67843695e+00 -1.17941280e+00 -2.43015620e-01 -2.43015620e-01
 -2.43015620e-01  1.07332215e+00  1.09750232e+01  6.40421673e+01
  2.56025791e+02  8.80945654e+02  3.13144241e+03  1.26117700e+04
  4.12095955e+04  1.05238221e+05  2.30411638e+05  4.56219361e+05
  8.45166137e+05  1.52833810e+06  2.85059896e+06  5.80847787e+06]
E1 = -706.6738846530344  E_coul = 198.684518570642
cycle= 1 E= -507.989366082392  delta_E= 7.39e-13  |g|= 1.57e-09  |ddm|= 5.18e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6738846530344  E_coul = 198.684518570642
  HOMO = -0.243015619903572  LUMO = 1.07332214492959
  mo_energy =
[-1.20327507e+02 -1.23811463e+01 -6.67843695e+00 -6.67843695e+00
 -6.67843695e+00 -1.17941280e+00 -2.43015620e-01 -2.43015620e-01
 -2.43015620e-01  1.07332214e+00  1.09750232e+01  6.40421673e+01
  2.56025791e+02  8.80945654e+02  3.13144241e+03  1.26117700e+04
  4.12095955e+04  1.05238221e+05  2.30411638e+05  4.56219361e+05
  8.45166137e+05  1.52833810e+06  2.85059896e+06  5.80847787e+06]
E1 = -706.6738846558113  E_coul = 198.68451857341813
Extra cycle  E= -507.989366082393  delta_E= -7.96e-13  |g|= 1.15e-09  |ddm|= 1.79e-09
    CPU time for scf_cycle      3.87 sec, wall time      0.39 sec
exp = [2.49159145e-01 6.48810821e-01 1.17616813e+05 3.03957133e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104176e+04 3.67547019e+04 7.30234454e+03 1.83757721e+04
 1.44366303e+03 4.16362470e+02 1.46703596e+02 5.77447682e+01
 2.42596868e+01 7.58987891e+00 8.60358787e+00 4.92690731e-01]
grad_E = [-2.56403734e-04  2.06452168e-05  6.03321428e-09  2.71943436e-05
  4.01129801e-11  1.73202127e-10  9.35845946e-10  3.69715344e-09
  1.54377162e-08  8.05545403e-08  5.07847475e-06  1.97170550e-07
 -3.79380312e-05 -6.96861711e-06  1.04087117e-05 -4.48957928e-05
  3.55305559e-05  8.27523339e-05 -4.33496665e-04  2.28270049e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:18:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249354429484       1
[INPUT] 0    0    [1    /1   ]  0.649708102719       1
[INPUT] 0    0    [1    /1   ]  117616.812901        1
[INPUT] 0    0    [1    /1   ]  3.03042386453        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030923        1
[INPUT] 0    0    [1    /1   ]  147020.99133         1
[INPUT] 0    0    [1    /1   ]  73510.4175777        1
[INPUT] 0    0    [1    /1   ]  36754.7016945        1
[INPUT] 0    0    [1    /1   ]  7302.33143281        1
[INPUT] 0    0    [1    /1   ]  18375.7716765        1
[INPUT] 0    0    [1    /1   ]  1443.58584027        1
[INPUT] 0    0    [1    /1   ]  416.907995367        1
[INPUT] 0    0    [1    /1   ]  147.416916145        1
[INPUT] 0    0    [1    /1   ]  58.158649538         1
[INPUT] 0    0    [1    /1   ]  24.3745970712        1
[INPUT] 0    0    [1    /1   ]  7.57222619507        1
[INPUT] 1    0    [1    /1   ]  8.60400347755        1
[INPUT] 1    0    [1    /1   ]  0.492696577443       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24935442948352876, 1.0]], [0, [0.6497081027187238, 1.0]], [0, [117616.81290108248, 1.0]], [0, [3.0304238645345887, 1.0]], [0, [1176168.1426134987, 1.0]], [0, [588084.0699568685, 1.0]], [0, [294042.03092323686, 1.0]], [0, [147020.9913303765, 1.0]], [0, [73510.41757769047, 1.0]], [0, [36754.701694505995, 1.0]], [0, [7302.331432805432, 1.0]], [0, [18375.77167649184, 1.0]], [0, [1443.5858402745164, 1.0]], [0, [416.90799536721113, 1.0]], [0, [147.41691614472543, 1.0]], [0, [58.15864953803322, 1.0]], [0, [24.374597071156927, 1.0]], [0, [7.57222619507056, 1.0]], [1, [8.604003477547524, 1.0]], [1, [0.49269657744279477, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24935443]
bas 1, expnt(s) = [0.6497081]
bas 2, expnt(s) = [117616.81290108]
bas 3, expnt(s) = [3.03042386]
bas 4, expnt(s) = [1176168.1426135]
bas 5, expnt(s) = [588084.06995687]
bas 6, expnt(s) = [294042.03092324]
bas 7, expnt(s) = [147020.99133038]
bas 8, expnt(s) = [73510.41757769]
bas 9, expnt(s) = [36754.70169451]
bas 10, expnt(s) = [7302.33143281]
bas 11, expnt(s) = [18375.77167649]
bas 12, expnt(s) = [1443.58584027]
bas 13, expnt(s) = [416.90799537]
bas 14, expnt(s) = [147.41691614]
bas 15, expnt(s) = [58.15864954]
bas 16, expnt(s) = [24.37459707]
bas 17, expnt(s) = [7.5722262]
bas 18, expnt(s) = [8.60400348]
bas 19, expnt(s) = [0.49269658]
CPU time:      1232.61
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49354429e-01 8.91513327e-01 6.49708103e-01 1.82832643e+00
 1.17616813e+05 1.60460108e+04 3.03042386e+00 5.80286621e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104176e+04 1.12791583e+04 3.67547017e+04 6.70655825e+03
 7.30233143e+03 1.99577317e+03 1.83757717e+04 3.98748639e+03
 1.44358584e+03 5.91693753e+02 4.16907995e+02 2.33101567e+02
 1.47416916e+02 1.06887154e+02 5.81586495e+01 5.32078560e+01
 2.43745971e+01 2.77152058e+01 7.57222620e+00 1.15327455e+01
 8.60400348e+00 4.29892743e+01 4.92696577e-01 1.20422829e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335956023751137
cond(S) = 912074.2052406896
E1 = -689.5859477050758  E_coul = 184.96537955922403
init E= -504.620568145852
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672300216331544  LUMO = 0.691884339440474
  mo_energy =
[-1.21710469e+02 -1.33864299e+01 -7.62405496e+00 -7.62405496e+00
 -7.62405496e+00 -1.65741250e+00 -6.72300216e-01 -6.72300216e-01
 -6.72300216e-01  6.91884339e-01  1.01371339e+01  6.30514443e+01
  2.56159579e+02  8.83467068e+02  3.13595806e+03  1.26165307e+04
  4.12140974e+04  1.05242542e+05  2.30415835e+05  4.56223467e+05
  8.45170173e+05  1.52834206e+06  2.85060284e+06  5.80848163e+06]
E1 = -707.737454643882  E_coul = 199.76584322935008
cycle= 1 E= -507.971611414532  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.706513
diis-c [-0.49916043  1.        ]
  HOMO = -0.2178638277937  LUMO = 1.08169331228464
  mo_energy =
[-1.20202021e+02 -1.23056879e+01 -6.59537236e+00 -6.59537236e+00
 -6.59537236e+00 -1.16333197e+00 -2.17863828e-01 -2.17863828e-01
 -2.17863828e-01  1.08169331e+00  1.10038927e+01  6.43197164e+01
  2.57615172e+02  8.84958831e+02  3.13738936e+03  1.26178553e+04
  4.12153547e+04  1.05243763e+05  2.30417031e+05  4.56224646e+05
  8.45171338e+05  1.52834322e+06  2.85060399e+06  5.80848277e+06]
E1 = -706.7977398315271  E_coul = 198.8086289312491
cycle= 2 E= -507.989110900278  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0292071
diis-c [-8.48991206e-04  2.84780762e-03  9.97152192e-01]
  HOMO = -0.239673078739476  LUMO = 1.07586304890229
  mo_energy =
[-1.20314638e+02 -1.23718817e+01 -6.66869273e+00 -6.66869273e+00
 -6.66869273e+00 -1.17736999e+00 -2.39673079e-01 -2.39673079e-01
 -2.39673079e-01  1.07586305e+00  1.09582352e+01  6.42388629e+01
  2.57512439e+02  8.84840502e+02  3.13725695e+03  1.26177128e+04
  4.12152084e+04  1.05243615e+05  2.30416882e+05  4.56224497e+05
  8.45171189e+05  1.52834307e+06  2.85060384e+06  5.80848262e+06]
E1 = -706.6917893808085  E_coul = 198.70242299748458
cycle= 3 E= -507.989366383324  delta_E= -0.000255  |g|= 0.00444  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322814
diis-c [-2.06053430e-06 -9.62243111e-05 -1.10077802e-01  1.11017403e+00]
  HOMO = -0.242867681552947  LUMO = 1.07477603324749
  mo_energy =
[-1.20326834e+02 -1.23806610e+01 -6.67798938e+00 -6.67798938e+00
 -6.67798938e+00 -1.17930684e+00 -2.42867682e-01 -2.42867682e-01
 -2.42867682e-01  1.07477603e+00  1.09517413e+01  6.42290113e+01
  2.57500944e+02  8.84828030e+02  3.13724371e+03  1.26176991e+04
  4.12151945e+04  1.05243601e+05  2.30416868e+05  4.56224483e+05
  8.45171175e+05  1.52834305e+06  2.85060382e+06  5.80848260e+06]
E1 = -706.6764179652811  E_coul = 198.68704666607397
cycle= 4 E= -507.989371299207  delta_E= -4.92e-06  |g|= 0.000197  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000136029
diis-c [-1.26222510e-10 -6.88135137e-06  7.43254338e-03 -9.86013780e-02
  1.09117572e+00]
  HOMO = -0.243001561306628  LUMO = 1.0747233452697
  mo_energy =
[-1.20327166e+02 -1.23809850e+01 -6.67831016e+00 -6.67831016e+00
 -6.67831016e+00 -1.17938633e+00 -2.43001561e-01 -2.43001561e-01
 -2.43001561e-01  1.07472335e+00  1.09514812e+01  6.42286906e+01
  2.57500614e+02  8.84827698e+02  3.13724338e+03  1.26176987e+04
  4.12151942e+04  1.05243601e+05  2.30416868e+05  4.56224482e+05
  8.45171175e+05  1.52834305e+06  2.85060382e+06  5.80848260e+06]
E1 = -706.6757815213589  E_coul = 198.68641021300482
cycle= 5 E= -507.989371308354  delta_E= -9.15e-09  |g|= 8.63e-07  |ddm|= 0.000441
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.44315e-07
diis-c [-2.67305114e-14  1.82495747e-07 -1.18677923e-04  1.38800181e-03
 -1.63837370e-02  1.01511423e+00]
  HOMO = -0.243002094685902  LUMO = 1.07472330597726
  mo_energy =
[-1.20327168e+02 -1.23809863e+01 -6.67831157e+00 -6.67831157e+00
 -6.67831157e+00 -1.17938680e+00 -2.43002095e-01 -2.43002095e-01
 -2.43002095e-01  1.07472331e+00  1.09514802e+01  6.42286891e+01
  2.57500612e+02  8.84827696e+02  3.13724338e+03  1.26176987e+04
  4.12151942e+04  1.05243601e+05  2.30416868e+05  4.56224482e+05
  8.45171175e+05  1.52834305e+06  2.85060382e+06  5.80848260e+06]
E1 = -706.6757787083853  E_coul = 198.68640740003127
cycle= 6 E= -507.989371308354  delta_E=    0  |g|= 2.16e-08  |ddm|= 1.92e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6757787083853  E_coul = 198.68640740003127
  HOMO = -0.243002105720183  LUMO = 1.07472330133309
  mo_energy =
[-1.20327168e+02 -1.23809864e+01 -6.67831160e+00 -6.67831160e+00
 -6.67831160e+00 -1.17938680e+00 -2.43002106e-01 -2.43002106e-01
 -2.43002106e-01  1.07472330e+00  1.09514801e+01  6.42286891e+01
  2.57500612e+02  8.84827696e+02  3.13724338e+03  1.26176987e+04
  4.12151942e+04  1.05243601e+05  2.30416868e+05  4.56224482e+05
  8.45171175e+05  1.52834305e+06  2.85060382e+06  5.80848260e+06]
E1 = -706.675778660196  E_coul = 198.68640735184147
Extra cycle  E= -507.989371308355  delta_E= -4.55e-13  |g|= 3.26e-09  |ddm|= 3.94e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.49354429e-01 6.49708103e-01 1.17616813e+05 3.03042386e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104176e+04 3.67547017e+04 7.30233143e+03 1.83757717e+04
 1.44358584e+03 4.16907995e+02 1.47416916e+02 5.81586495e+01
 2.43745971e+01 7.57222620e+00 8.60400348e+00 4.92696577e-01]
E = -507.9893713083545
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:18:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249354429484       1
[INPUT] 0    0    [1    /1   ]  0.649708102719       1
[INPUT] 0    0    [1    /1   ]  117616.812901        1
[INPUT] 0    0    [1    /1   ]  3.03042386453        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030923        1
[INPUT] 0    0    [1    /1   ]  147020.99133         1
[INPUT] 0    0    [1    /1   ]  73510.4175777        1
[INPUT] 0    0    [1    /1   ]  36754.7016945        1
[INPUT] 0    0    [1    /1   ]  7302.33143281        1
[INPUT] 0    0    [1    /1   ]  18375.7716765        1
[INPUT] 0    0    [1    /1   ]  1443.58584027        1
[INPUT] 0    0    [1    /1   ]  416.907995367        1
[INPUT] 0    0    [1    /1   ]  147.416916145        1
[INPUT] 0    0    [1    /1   ]  58.158649538         1
[INPUT] 0    0    [1    /1   ]  24.3745970712        1
[INPUT] 0    0    [1    /1   ]  7.57222619507        1
[INPUT] 1    0    [1    /1   ]  8.60400347755        1
[INPUT] 1    0    [1    /1   ]  0.492696577443       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24935442948352876, 1.0]], [0, [0.6497081027187238, 1.0]], [0, [117616.81290108248, 1.0]], [0, [3.0304238645345887, 1.0]], [0, [1176168.1426134987, 1.0]], [0, [588084.0699568685, 1.0]], [0, [294042.03092323686, 1.0]], [0, [147020.9913303765, 1.0]], [0, [73510.41757769047, 1.0]], [0, [36754.701694505995, 1.0]], [0, [7302.331432805432, 1.0]], [0, [18375.77167649184, 1.0]], [0, [1443.5858402745164, 1.0]], [0, [416.90799536721113, 1.0]], [0, [147.41691614472543, 1.0]], [0, [58.15864953803322, 1.0]], [0, [24.374597071156927, 1.0]], [0, [7.57222619507056, 1.0]], [1, [8.604003477547524, 1.0]], [1, [0.49269657744279477, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24935443]
bas 1, expnt(s) = [0.6497081]
bas 2, expnt(s) = [117616.81290108]
bas 3, expnt(s) = [3.03042386]
bas 4, expnt(s) = [1176168.1426135]
bas 5, expnt(s) = [588084.06995687]
bas 6, expnt(s) = [294042.03092324]
bas 7, expnt(s) = [147020.99133038]
bas 8, expnt(s) = [73510.41757769]
bas 9, expnt(s) = [36754.70169451]
bas 10, expnt(s) = [7302.33143281]
bas 11, expnt(s) = [18375.77167649]
bas 12, expnt(s) = [1443.58584027]
bas 13, expnt(s) = [416.90799537]
bas 14, expnt(s) = [147.41691614]
bas 15, expnt(s) = [58.15864954]
bas 16, expnt(s) = [24.37459707]
bas 17, expnt(s) = [7.5722262]
bas 18, expnt(s) = [8.60400348]
bas 19, expnt(s) = [0.49269658]
CPU time:      1234.29
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49354429e-01 8.91513327e-01 6.49708103e-01 1.82832643e+00
 1.17616813e+05 1.60460108e+04 3.03042386e+00 5.80286621e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104176e+04 1.12791583e+04 3.67547017e+04 6.70655825e+03
 7.30233143e+03 1.99577317e+03 1.83757717e+04 3.98748639e+03
 1.44358584e+03 5.91693753e+02 4.16907995e+02 2.33101567e+02
 1.47416916e+02 1.06887154e+02 5.81586495e+01 5.32078560e+01
 2.43745971e+01 2.77152058e+01 7.57222620e+00 1.15327455e+01
 8.60400348e+00 4.29892743e+01 4.92696577e-01 1.20422829e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335956023751137
cond(S) = 912074.2052406896
E1 = -689.5859477050758  E_coul = 184.96537955922403
init E= -504.620568145852
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672300216331544  LUMO = 0.691884339440474
  mo_energy =
[-1.21710469e+02 -1.33864299e+01 -7.62405496e+00 -7.62405496e+00
 -7.62405496e+00 -1.65741250e+00 -6.72300216e-01 -6.72300216e-01
 -6.72300216e-01  6.91884339e-01  1.01371339e+01  6.30514443e+01
  2.56159579e+02  8.83467068e+02  3.13595806e+03  1.26165307e+04
  4.12140974e+04  1.05242542e+05  2.30415835e+05  4.56223467e+05
  8.45170173e+05  1.52834206e+06  2.85060284e+06  5.80848163e+06]
E1 = -707.737454643882  E_coul = 199.76584322935008
cycle= 1 E= -507.971611414532  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.706513
diis-c [-0.49916043  1.        ]
  HOMO = -0.2178638277937  LUMO = 1.08169331228464
  mo_energy =
[-1.20202021e+02 -1.23056879e+01 -6.59537236e+00 -6.59537236e+00
 -6.59537236e+00 -1.16333197e+00 -2.17863828e-01 -2.17863828e-01
 -2.17863828e-01  1.08169331e+00  1.10038927e+01  6.43197164e+01
  2.57615172e+02  8.84958831e+02  3.13738936e+03  1.26178553e+04
  4.12153547e+04  1.05243763e+05  2.30417031e+05  4.56224646e+05
  8.45171338e+05  1.52834322e+06  2.85060399e+06  5.80848277e+06]
E1 = -706.7977398315271  E_coul = 198.8086289312491
cycle= 2 E= -507.989110900278  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0292071
diis-c [-8.48991206e-04  2.84780762e-03  9.97152192e-01]
  HOMO = -0.239673078739476  LUMO = 1.07586304890229
  mo_energy =
[-1.20314638e+02 -1.23718817e+01 -6.66869273e+00 -6.66869273e+00
 -6.66869273e+00 -1.17736999e+00 -2.39673079e-01 -2.39673079e-01
 -2.39673079e-01  1.07586305e+00  1.09582352e+01  6.42388629e+01
  2.57512439e+02  8.84840502e+02  3.13725695e+03  1.26177128e+04
  4.12152084e+04  1.05243615e+05  2.30416882e+05  4.56224497e+05
  8.45171189e+05  1.52834307e+06  2.85060384e+06  5.80848262e+06]
E1 = -706.6917893808085  E_coul = 198.70242299748458
cycle= 3 E= -507.989366383324  delta_E= -0.000255  |g|= 0.00444  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322814
diis-c [-2.06053430e-06 -9.62243111e-05 -1.10077802e-01  1.11017403e+00]
  HOMO = -0.242867681552947  LUMO = 1.07477603324749
  mo_energy =
[-1.20326834e+02 -1.23806610e+01 -6.67798938e+00 -6.67798938e+00
 -6.67798938e+00 -1.17930684e+00 -2.42867682e-01 -2.42867682e-01
 -2.42867682e-01  1.07477603e+00  1.09517413e+01  6.42290113e+01
  2.57500944e+02  8.84828030e+02  3.13724371e+03  1.26176991e+04
  4.12151945e+04  1.05243601e+05  2.30416868e+05  4.56224483e+05
  8.45171175e+05  1.52834305e+06  2.85060382e+06  5.80848260e+06]
E1 = -706.6764179652811  E_coul = 198.68704666607397
cycle= 4 E= -507.989371299207  delta_E= -4.92e-06  |g|= 0.000197  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000136029
diis-c [-1.26222510e-10 -6.88135137e-06  7.43254338e-03 -9.86013780e-02
  1.09117572e+00]
  HOMO = -0.243001561306628  LUMO = 1.0747233452697
  mo_energy =
[-1.20327166e+02 -1.23809850e+01 -6.67831016e+00 -6.67831016e+00
 -6.67831016e+00 -1.17938633e+00 -2.43001561e-01 -2.43001561e-01
 -2.43001561e-01  1.07472335e+00  1.09514812e+01  6.42286906e+01
  2.57500614e+02  8.84827698e+02  3.13724338e+03  1.26176987e+04
  4.12151942e+04  1.05243601e+05  2.30416868e+05  4.56224482e+05
  8.45171175e+05  1.52834305e+06  2.85060382e+06  5.80848260e+06]
E1 = -706.6757815213589  E_coul = 198.68641021300482
cycle= 5 E= -507.989371308354  delta_E= -9.15e-09  |g|= 8.63e-07  |ddm|= 0.000441
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.44315e-07
diis-c [-2.67305114e-14  1.82495747e-07 -1.18677923e-04  1.38800181e-03
 -1.63837370e-02  1.01511423e+00]
  HOMO = -0.243002094685902  LUMO = 1.07472330597726
  mo_energy =
[-1.20327168e+02 -1.23809863e+01 -6.67831157e+00 -6.67831157e+00
 -6.67831157e+00 -1.17938680e+00 -2.43002095e-01 -2.43002095e-01
 -2.43002095e-01  1.07472331e+00  1.09514802e+01  6.42286891e+01
  2.57500612e+02  8.84827696e+02  3.13724338e+03  1.26176987e+04
  4.12151942e+04  1.05243601e+05  2.30416868e+05  4.56224482e+05
  8.45171175e+05  1.52834305e+06  2.85060382e+06  5.80848260e+06]
E1 = -706.6757787083853  E_coul = 198.68640740003127
cycle= 6 E= -507.989371308354  delta_E=    0  |g|= 2.16e-08  |ddm|= 1.92e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6757787083853  E_coul = 198.68640740003127
  HOMO = -0.243002105720183  LUMO = 1.07472330133309
  mo_energy =
[-1.20327168e+02 -1.23809864e+01 -6.67831160e+00 -6.67831160e+00
 -6.67831160e+00 -1.17938680e+00 -2.43002106e-01 -2.43002106e-01
 -2.43002106e-01  1.07472330e+00  1.09514801e+01  6.42286891e+01
  2.57500612e+02  8.84827696e+02  3.13724338e+03  1.26176987e+04
  4.12151942e+04  1.05243601e+05  2.30416868e+05  4.56224482e+05
  8.45171175e+05  1.52834305e+06  2.85060382e+06  5.80848260e+06]
E1 = -706.675778660196  E_coul = 198.68640735184147
Extra cycle  E= -507.989371308355  delta_E= -4.55e-13  |g|= 3.26e-09  |ddm|= 3.94e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912074.2052406896
E1 = -706.675778660196  E_coul = 198.68640735184147
init E= -507.989371308355
    CPU time for initialize scf      3.41 sec, wall time      0.22 sec
  HOMO = -0.243002107217251  LUMO = 1.07472329915435
  mo_energy =
[-1.20327168e+02 -1.23809864e+01 -6.67831160e+00 -6.67831160e+00
 -6.67831160e+00 -1.17938680e+00 -2.43002107e-01 -2.43002107e-01
 -2.43002107e-01  1.07472330e+00  1.09514801e+01  6.42286891e+01
  2.57500612e+02  8.84827696e+02  3.13724338e+03  1.26176987e+04
  4.12151942e+04  1.05243601e+05  2.30416868e+05  4.56224482e+05
  8.45171175e+05  1.52834305e+06  2.85060382e+06  5.80848260e+06]
E1 = -706.6757786532895  E_coul = 198.6864073449356
cycle= 1 E= -507.989371308354  delta_E= 5.68e-13  |g|= 1.21e-09  |ddm|= 4.77e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6757786532895  E_coul = 198.6864073449356
  HOMO = -0.243002107408485  LUMO = 1.07472329911534
  mo_energy =
[-1.20327168e+02 -1.23809864e+01 -6.67831160e+00 -6.67831160e+00
 -6.67831160e+00 -1.17938680e+00 -2.43002107e-01 -2.43002107e-01
 -2.43002107e-01  1.07472330e+00  1.09514801e+01  6.42286891e+01
  2.57500612e+02  8.84827696e+02  3.13724338e+03  1.26176987e+04
  4.12151942e+04  1.05243601e+05  2.30416868e+05  4.56224482e+05
  8.45171175e+05  1.52834305e+06  2.85060382e+06  5.80848260e+06]
E1 = -706.675778651831  E_coul = 198.68640734347701
Extra cycle  E= -507.989371308354  delta_E= -5.68e-14  |g|= 1.4e-09  |ddm|= 9.86e-10
    CPU time for scf_cycle      3.86 sec, wall time      0.39 sec
exp = [2.49354429e-01 6.49708103e-01 1.17616813e+05 3.03042386e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104176e+04 3.67547017e+04 7.30233143e+03 1.83757717e+04
 1.44358584e+03 4.16907995e+02 1.47416916e+02 5.81586495e+01
 2.43745971e+01 7.57222620e+00 8.60400348e+00 4.92696577e-01]
grad_E = [ 1.18732587e-04 -2.54231097e-05  6.04246584e-09 -1.56092621e-04
  4.02169667e-11  1.73505740e-10  9.37265151e-10  3.70288465e-09
  1.54619538e-08  8.06710012e-08  5.08507945e-06  1.97553254e-07
 -3.79809987e-05 -7.92571862e-06  6.46945351e-06 -8.91691005e-06
 -3.68050285e-06  5.60446664e-05 -1.06901748e-04 -3.02251070e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:18:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249424452985       1
[INPUT] 0    0    [1    /1   ]  0.649715333347       1
[INPUT] 0    0    [1    /1   ]  117616.812892        1
[INPUT] 0    0    [1    /1   ]  3.03479376337        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030922        1
[INPUT] 0    0    [1    /1   ]  147020.991325        1
[INPUT] 0    0    [1    /1   ]  73510.4175552        1
[INPUT] 0    0    [1    /1   ]  36754.7015729        1
[INPUT] 0    0    [1    /1   ]  7302.32386629        1
[INPUT] 0    0    [1    /1   ]  18375.7714223        1
[INPUT] 0    0    [1    /1   ]  1443.53881271        1
[INPUT] 0    0    [1    /1   ]  417.248420135        1
[INPUT] 0    0    [1    /1   ]  147.765508489        1
[INPUT] 0    0    [1    /1   ]  58.3985032132        1
[INPUT] 0    0    [1    /1   ]  24.5127495365        1
[INPUT] 0    0    [1    /1   ]  7.58041410058        1
[INPUT] 1    0    [1    /1   ]  8.60413250185        1
[INPUT] 1    0    [1    /1   ]  0.492699434358       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24942445298483104, 1.0]], [0, [0.6497153333468045, 1.0]], [0, [117616.81289220313, 1.0]], [0, [3.0347937633720936, 1.0]], [0, [1176168.1426134638, 1.0]], [0, [588084.0699566327, 1.0]], [0, [294042.030921855, 1.0]], [0, [147020.99132496378, 1.0]], [0, [73510.41755522705, 1.0]], [0, [36754.701572926235, 1.0]], [0, [7302.323866289191, 1.0]], [0, [18375.77142229989, 1.0]], [0, [1443.5388127134725, 1.0]], [0, [417.24842013455526, 1.0]], [0, [147.76550848894598, 1.0]], [0, [58.398503213226846, 1.0]], [0, [24.512749536466757, 1.0]], [0, [7.580414100582035, 1.0]], [1, [8.604132501847646, 1.0]], [1, [0.49269943435803015, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24942445]
bas 1, expnt(s) = [0.64971533]
bas 2, expnt(s) = [117616.8128922]
bas 3, expnt(s) = [3.03479376]
bas 4, expnt(s) = [1176168.14261346]
bas 5, expnt(s) = [588084.06995663]
bas 6, expnt(s) = [294042.03092186]
bas 7, expnt(s) = [147020.99132496]
bas 8, expnt(s) = [73510.41755523]
bas 9, expnt(s) = [36754.70157293]
bas 10, expnt(s) = [7302.32386629]
bas 11, expnt(s) = [18375.7714223]
bas 12, expnt(s) = [1443.53881271]
bas 13, expnt(s) = [417.24842013]
bas 14, expnt(s) = [147.76550849]
bas 15, expnt(s) = [58.39850321]
bas 16, expnt(s) = [24.51274954]
bas 17, expnt(s) = [7.5804141]
bas 18, expnt(s) = [8.6041325]
bas 19, expnt(s) = [0.49269943]
CPU time:      1246.45
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49424453e-01 8.91701086e-01 6.49715333e-01 1.82834169e+00
 1.17616813e+05 1.60460108e+04 3.03479376e+00 5.80914091e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104176e+04 1.12791583e+04 3.67547016e+04 6.70655823e+03
 7.30232387e+03 1.99577162e+03 1.83757714e+04 3.98748635e+03
 1.44353881e+03 5.91679297e+02 4.17248420e+02 2.33244306e+02
 1.47765508e+02 1.07076663e+02 5.83985032e+01 5.33723483e+01
 2.45127495e+01 2.78329375e+01 7.58041410e+00 1.15420971e+01
 8.60413250e+00 4.29900801e+01 4.92699434e-01 1.20423702e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335949991044966
cond(S) = 912113.8269121174
E1 = -689.5865408117414  E_coul = 184.9660386338018
init E= -504.62050217794
    CPU time for initialize scf      0.43 sec, wall time      0.07 sec
  HOMO = -0.672298300089259  LUMO = 0.692270586197556
  mo_energy =
[-1.21710347e+02 -1.33863734e+01 -7.62400901e+00 -7.62400901e+00
 -7.62400901e+00 -1.65741074e+00 -6.72298300e-01 -6.72298300e-01
 -6.72298300e-01  6.92270586e-01  1.01606066e+01  6.33542077e+01
  2.57328947e+02  8.85964817e+02  3.13951172e+03  1.26201371e+04
  4.12175000e+04  1.05245811e+05  2.30419013e+05  4.56226579e+05
  8.45173234e+05  1.52834508e+06  2.85060579e+06  5.80848450e+06]
E1 = -707.7384103098261  E_coul = 199.76679748421975
cycle= 1 E= -507.971612825606  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.43 sec, wall time      0.03 sec
diis-norm(errvec)=0.706575
diis-c [-0.49924835  1.        ]
  HOMO = -0.217855301751816  LUMO = 1.08219198331595
  mo_energy =
[-1.20201864e+02 -1.23056109e+01 -6.59530241e+00 -6.59530241e+00
 -6.59530241e+00 -1.16332416e+00 -2.17855302e-01 -2.17855302e-01
 -2.17855302e-01  1.08219198e+00  1.10282321e+01  6.46237480e+01
  2.58784969e+02  8.87456625e+02  3.14094305e+03  1.26214617e+04
  4.12187574e+04  1.05247032e+05  2.30420209e+05  4.56227758e+05
  8.45174400e+05  1.52834623e+06  2.85060694e+06  5.80848564e+06]
E1 = -706.7987196673436  E_coul = 198.80960783259985
cycle= 2 E= -507.989111834744  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.0291902
diis-c [-8.47857120e-04  2.89866308e-03  9.97101337e-01]
  HOMO = -0.239664398196658  LUMO = 1.07635586286671
  mo_energy =
[-1.20314471e+02 -1.23717993e+01 -6.66861619e+00 -6.66861619e+00
 -6.66861619e+00 -1.17736225e+00 -2.39664398e-01 -2.39664398e-01
 -2.39664398e-01  1.07635586e+00  1.09825173e+01  6.45427945e+01
  2.58682186e+02  8.87338291e+02  3.14081066e+03  1.26213193e+04
  4.12186111e+04  1.05246884e+05  2.30420060e+05  4.56227609e+05
  8.45174250e+05  1.52834608e+06  2.85060679e+06  5.80848549e+06]
E1 = -706.6927753620316  E_coul = 198.70340805462504
cycle= 3 E= -507.989367307407  delta_E= -0.000255  |g|= 0.00444  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322727
diis-c [-2.05582350e-06 -9.81537060e-05 -1.10145795e-01  1.11024395e+00]
  HOMO = -0.242860134639615  LUMO = 1.07526769603134
  mo_energy =
[-1.20326672e+02 -1.23805823e+01 -6.67791678e+00 -6.67791678e+00
 -6.67791678e+00 -1.17929983e+00 -2.42860135e-01 -2.42860135e-01
 -2.42860135e-01  1.07526770e+00  1.09760142e+01  6.45329298e+01
  2.58670682e+02  8.87325812e+02  3.14079741e+03  1.26213055e+04
  4.12185972e+04  1.05246870e+05  2.30420046e+05  4.56227595e+05
  8.45174236e+05  1.52834607e+06  2.85060677e+06  5.80848547e+06]
E1 = -706.6773991999697  E_coul = 198.6880269750069
cycle= 4 E= -507.989372224963  delta_E= -4.92e-06  |g|= 0.000197  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135828
diis-c [-1.25827599e-10 -6.85979381e-06  7.43857502e-03 -9.85800858e-02
  1.09114837e+00]
  HOMO = -0.242993869496057  LUMO = 1.07521502171966
  mo_energy =
[-1.20327004e+02 -1.23809059e+01 -6.67823723e+00 -6.67823723e+00
 -6.67823723e+00 -1.17937923e+00 -2.42993869e-01 -2.42993869e-01
 -2.42993869e-01  1.07521502e+00  1.09757541e+01  6.45326094e+01
  2.58670352e+02  8.87325479e+02  3.14079708e+03  1.26213052e+04
  4.12185969e+04  1.05246870e+05  2.30420046e+05  4.56227594e+05
  8.45174236e+05  1.52834607e+06  2.85060677e+06  5.80848547e+06]
E1 = -706.6767634818384  E_coul = 198.68739124775266
cycle= 5 E= -507.989372234086  delta_E= -9.12e-09  |g|= 8.55e-07  |ddm|= 0.00044
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.41473e-07
diis-c [-2.61657034e-14  1.79527608e-07 -1.17342710e-04  1.36907875e-03
 -1.61665868e-02  1.01491467e+00]
  HOMO = -0.242994398092263  LUMO = 1.07521498687788
  mo_energy =
[-1.20327006e+02 -1.23809073e+01 -6.67823864e+00 -6.67823864e+00
 -6.67823864e+00 -1.17937969e+00 -2.42994398e-01 -2.42994398e-01
 -2.42994398e-01  1.07521499e+00  1.09757531e+01  6.45326079e+01
  2.58670351e+02  8.87325477e+02  3.14079708e+03  1.26213052e+04
  4.12185969e+04  1.05246870e+05  2.30420046e+05  4.56227594e+05
  8.45174236e+05  1.52834607e+06  2.85060677e+06  5.80848547e+06]
E1 = -706.6767606900061  E_coul = 198.68738845592057
cycle= 6 E= -507.989372234086  delta_E= 2.27e-13  |g|= 2.14e-08  |ddm|= 1.9e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6767606900061  E_coul = 198.68738845592057
  HOMO = -0.242994408863413  LUMO = 1.07521498200239
  mo_energy =
[-1.20327006e+02 -1.23809073e+01 -6.67823866e+00 -6.67823866e+00
 -6.67823866e+00 -1.17937970e+00 -2.42994409e-01 -2.42994409e-01
 -2.42994409e-01  1.07521498e+00  1.09757530e+01  6.45326079e+01
  2.58670351e+02  8.87325477e+02  3.14079708e+03  1.26213052e+04
  4.12185969e+04  1.05246870e+05  2.30420046e+05  4.56227594e+05
  8.45174236e+05  1.52834607e+06  2.85060677e+06  5.80848547e+06]
E1 = -706.6767606400763  E_coul = 198.68738840599025
Extra cycle  E= -507.989372234086  delta_E= -5.12e-13  |g|= 2.32e-09  |ddm|= 4.03e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.29 sec
exp = [2.49424453e-01 6.49715333e-01 1.17616813e+05 3.03479376e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104176e+04 3.67547016e+04 7.30232387e+03 1.83757714e+04
 1.44353881e+03 4.17248420e+02 1.47765508e+02 5.83985032e+01
 2.45127495e+01 7.58041410e+00 8.60413250e+00 4.92699434e-01]
E = -507.98937223408603
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:18:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249424452985       1
[INPUT] 0    0    [1    /1   ]  0.649715333347       1
[INPUT] 0    0    [1    /1   ]  117616.812892        1
[INPUT] 0    0    [1    /1   ]  3.03479376337        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030922        1
[INPUT] 0    0    [1    /1   ]  147020.991325        1
[INPUT] 0    0    [1    /1   ]  73510.4175552        1
[INPUT] 0    0    [1    /1   ]  36754.7015729        1
[INPUT] 0    0    [1    /1   ]  7302.32386629        1
[INPUT] 0    0    [1    /1   ]  18375.7714223        1
[INPUT] 0    0    [1    /1   ]  1443.53881271        1
[INPUT] 0    0    [1    /1   ]  417.248420135        1
[INPUT] 0    0    [1    /1   ]  147.765508489        1
[INPUT] 0    0    [1    /1   ]  58.3985032132        1
[INPUT] 0    0    [1    /1   ]  24.5127495365        1
[INPUT] 0    0    [1    /1   ]  7.58041410058        1
[INPUT] 1    0    [1    /1   ]  8.60413250185        1
[INPUT] 1    0    [1    /1   ]  0.492699434358       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24942445298483104, 1.0]], [0, [0.6497153333468045, 1.0]], [0, [117616.81289220313, 1.0]], [0, [3.0347937633720936, 1.0]], [0, [1176168.1426134638, 1.0]], [0, [588084.0699566327, 1.0]], [0, [294042.030921855, 1.0]], [0, [147020.99132496378, 1.0]], [0, [73510.41755522705, 1.0]], [0, [36754.701572926235, 1.0]], [0, [7302.323866289191, 1.0]], [0, [18375.77142229989, 1.0]], [0, [1443.5388127134725, 1.0]], [0, [417.24842013455526, 1.0]], [0, [147.76550848894598, 1.0]], [0, [58.398503213226846, 1.0]], [0, [24.512749536466757, 1.0]], [0, [7.580414100582035, 1.0]], [1, [8.604132501847646, 1.0]], [1, [0.49269943435803015, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24942445]
bas 1, expnt(s) = [0.64971533]
bas 2, expnt(s) = [117616.8128922]
bas 3, expnt(s) = [3.03479376]
bas 4, expnt(s) = [1176168.14261346]
bas 5, expnt(s) = [588084.06995663]
bas 6, expnt(s) = [294042.03092186]
bas 7, expnt(s) = [147020.99132496]
bas 8, expnt(s) = [73510.41755523]
bas 9, expnt(s) = [36754.70157293]
bas 10, expnt(s) = [7302.32386629]
bas 11, expnt(s) = [18375.7714223]
bas 12, expnt(s) = [1443.53881271]
bas 13, expnt(s) = [417.24842013]
bas 14, expnt(s) = [147.76550849]
bas 15, expnt(s) = [58.39850321]
bas 16, expnt(s) = [24.51274954]
bas 17, expnt(s) = [7.5804141]
bas 18, expnt(s) = [8.6041325]
bas 19, expnt(s) = [0.49269943]
CPU time:      1248.14
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49424453e-01 8.91701086e-01 6.49715333e-01 1.82834169e+00
 1.17616813e+05 1.60460108e+04 3.03479376e+00 5.80914091e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104176e+04 1.12791583e+04 3.67547016e+04 6.70655823e+03
 7.30232387e+03 1.99577162e+03 1.83757714e+04 3.98748635e+03
 1.44353881e+03 5.91679297e+02 4.17248420e+02 2.33244306e+02
 1.47765508e+02 1.07076663e+02 5.83985032e+01 5.33723483e+01
 2.45127495e+01 2.78329375e+01 7.58041410e+00 1.15420971e+01
 8.60413250e+00 4.29900801e+01 4.92699434e-01 1.20423702e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335949991044966
cond(S) = 912113.8269121174
E1 = -689.5865408117414  E_coul = 184.9660386338018
init E= -504.62050217794
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672298300089259  LUMO = 0.692270586197556
  mo_energy =
[-1.21710347e+02 -1.33863734e+01 -7.62400901e+00 -7.62400901e+00
 -7.62400901e+00 -1.65741074e+00 -6.72298300e-01 -6.72298300e-01
 -6.72298300e-01  6.92270586e-01  1.01606066e+01  6.33542077e+01
  2.57328947e+02  8.85964817e+02  3.13951172e+03  1.26201371e+04
  4.12175000e+04  1.05245811e+05  2.30419013e+05  4.56226579e+05
  8.45173234e+05  1.52834508e+06  2.85060579e+06  5.80848450e+06]
E1 = -707.7384103098261  E_coul = 199.76679748421975
cycle= 1 E= -507.971612825606  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.706575
diis-c [-0.49924835  1.        ]
  HOMO = -0.217855301751816  LUMO = 1.08219198331595
  mo_energy =
[-1.20201864e+02 -1.23056109e+01 -6.59530241e+00 -6.59530241e+00
 -6.59530241e+00 -1.16332416e+00 -2.17855302e-01 -2.17855302e-01
 -2.17855302e-01  1.08219198e+00  1.10282321e+01  6.46237480e+01
  2.58784969e+02  8.87456625e+02  3.14094305e+03  1.26214617e+04
  4.12187574e+04  1.05247032e+05  2.30420209e+05  4.56227758e+05
  8.45174400e+05  1.52834623e+06  2.85060694e+06  5.80848564e+06]
E1 = -706.7987196673436  E_coul = 198.80960783259985
cycle= 2 E= -507.989111834744  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0291902
diis-c [-8.47857120e-04  2.89866308e-03  9.97101337e-01]
  HOMO = -0.239664398196658  LUMO = 1.07635586286671
  mo_energy =
[-1.20314471e+02 -1.23717993e+01 -6.66861619e+00 -6.66861619e+00
 -6.66861619e+00 -1.17736225e+00 -2.39664398e-01 -2.39664398e-01
 -2.39664398e-01  1.07635586e+00  1.09825173e+01  6.45427945e+01
  2.58682186e+02  8.87338291e+02  3.14081066e+03  1.26213193e+04
  4.12186111e+04  1.05246884e+05  2.30420060e+05  4.56227609e+05
  8.45174250e+05  1.52834608e+06  2.85060679e+06  5.80848549e+06]
E1 = -706.6927753620316  E_coul = 198.70340805462504
cycle= 3 E= -507.989367307407  delta_E= -0.000255  |g|= 0.00444  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322727
diis-c [-2.05582350e-06 -9.81537060e-05 -1.10145795e-01  1.11024395e+00]
  HOMO = -0.242860134639615  LUMO = 1.07526769603134
  mo_energy =
[-1.20326672e+02 -1.23805823e+01 -6.67791678e+00 -6.67791678e+00
 -6.67791678e+00 -1.17929983e+00 -2.42860135e-01 -2.42860135e-01
 -2.42860135e-01  1.07526770e+00  1.09760142e+01  6.45329298e+01
  2.58670682e+02  8.87325812e+02  3.14079741e+03  1.26213055e+04
  4.12185972e+04  1.05246870e+05  2.30420046e+05  4.56227595e+05
  8.45174236e+05  1.52834607e+06  2.85060677e+06  5.80848547e+06]
E1 = -706.6773991999697  E_coul = 198.6880269750069
cycle= 4 E= -507.989372224963  delta_E= -4.92e-06  |g|= 0.000197  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135828
diis-c [-1.25827599e-10 -6.85979381e-06  7.43857502e-03 -9.85800858e-02
  1.09114837e+00]
  HOMO = -0.242993869496057  LUMO = 1.07521502171966
  mo_energy =
[-1.20327004e+02 -1.23809059e+01 -6.67823723e+00 -6.67823723e+00
 -6.67823723e+00 -1.17937923e+00 -2.42993869e-01 -2.42993869e-01
 -2.42993869e-01  1.07521502e+00  1.09757541e+01  6.45326094e+01
  2.58670352e+02  8.87325479e+02  3.14079708e+03  1.26213052e+04
  4.12185969e+04  1.05246870e+05  2.30420046e+05  4.56227594e+05
  8.45174236e+05  1.52834607e+06  2.85060677e+06  5.80848547e+06]
E1 = -706.6767634818384  E_coul = 198.68739124775266
cycle= 5 E= -507.989372234086  delta_E= -9.12e-09  |g|= 8.55e-07  |ddm|= 0.00044
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.41473e-07
diis-c [-2.61657034e-14  1.79527608e-07 -1.17342710e-04  1.36907875e-03
 -1.61665868e-02  1.01491467e+00]
  HOMO = -0.242994398092263  LUMO = 1.07521498687788
  mo_energy =
[-1.20327006e+02 -1.23809073e+01 -6.67823864e+00 -6.67823864e+00
 -6.67823864e+00 -1.17937969e+00 -2.42994398e-01 -2.42994398e-01
 -2.42994398e-01  1.07521499e+00  1.09757531e+01  6.45326079e+01
  2.58670351e+02  8.87325477e+02  3.14079708e+03  1.26213052e+04
  4.12185969e+04  1.05246870e+05  2.30420046e+05  4.56227594e+05
  8.45174236e+05  1.52834607e+06  2.85060677e+06  5.80848547e+06]
E1 = -706.6767606900061  E_coul = 198.68738845592057
cycle= 6 E= -507.989372234086  delta_E= 2.27e-13  |g|= 2.14e-08  |ddm|= 1.9e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6767606900061  E_coul = 198.68738845592057
  HOMO = -0.242994408863413  LUMO = 1.07521498200239
  mo_energy =
[-1.20327006e+02 -1.23809073e+01 -6.67823866e+00 -6.67823866e+00
 -6.67823866e+00 -1.17937970e+00 -2.42994409e-01 -2.42994409e-01
 -2.42994409e-01  1.07521498e+00  1.09757530e+01  6.45326079e+01
  2.58670351e+02  8.87325477e+02  3.14079708e+03  1.26213052e+04
  4.12185969e+04  1.05246870e+05  2.30420046e+05  4.56227594e+05
  8.45174236e+05  1.52834607e+06  2.85060677e+06  5.80848547e+06]
E1 = -706.6767606400763  E_coul = 198.68738840599025
Extra cycle  E= -507.989372234086  delta_E= -5.12e-13  |g|= 2.32e-09  |ddm|= 4.03e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912113.8269121174
E1 = -706.6767606400763  E_coul = 198.68738840599025
init E= -507.989372234086
    CPU time for initialize scf      3.42 sec, wall time      0.22 sec
  HOMO = -0.242994410392315  LUMO = 1.0752149810774
  mo_energy =
[-1.20327006e+02 -1.23809073e+01 -6.67823866e+00 -6.67823866e+00
 -6.67823866e+00 -1.17937970e+00 -2.42994410e-01 -2.42994410e-01
 -2.42994410e-01  1.07521498e+00  1.09757530e+01  6.45326079e+01
  2.58670351e+02  8.87325477e+02  3.14079708e+03  1.26213052e+04
  4.12185969e+04  1.05246870e+05  2.30420046e+05  4.56227594e+05
  8.45174236e+05  1.52834607e+06  2.85060677e+06  5.80848547e+06]
E1 = -706.6767606365518  E_coul = 198.68738840246567
cycle= 1 E= -507.989372234086  delta_E= -5.68e-14  |g|= 2.42e-09  |ddm|= 2.84e-09
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.6767606365518  E_coul = 198.68738840246567
  HOMO = -0.242994410513533  LUMO = 1.07521498021935
  mo_energy =
[-1.20327006e+02 -1.23809073e+01 -6.67823867e+00 -6.67823867e+00
 -6.67823867e+00 -1.17937970e+00 -2.42994411e-01 -2.42994411e-01
 -2.42994411e-01  1.07521498e+00  1.09757530e+01  6.45326079e+01
  2.58670351e+02  8.87325477e+02  3.14079708e+03  1.26213052e+04
  4.12185969e+04  1.05246870e+05  2.30420046e+05  4.56227594e+05
  8.45174236e+05  1.52834607e+06  2.85060677e+06  5.80848547e+06]
E1 = -706.6767606351063  E_coul = 198.68738840102054
Extra cycle  E= -507.989372234086  delta_E= 2.84e-13  |g|= 8.5e-10  |ddm|= 9.57e-10
    CPU time for scf_cycle      3.87 sec, wall time      0.39 sec
exp = [2.49424453e-01 6.49715333e-01 1.17616813e+05 3.03479376e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104176e+04 3.67547016e+04 7.30232387e+03 1.83757714e+04
 1.44353881e+03 4.17248420e+02 1.47765508e+02 5.83985032e+01
 2.45127495e+01 7.58041410e+00 8.60413250e+00 4.92699434e-01]
grad_E = [ 6.19838221e-06  9.56786923e-06  6.05339470e-09 -2.78693197e-05
  4.03397794e-11  1.73864198e-10  9.38941721e-10  3.70965406e-09
  1.54905847e-08  8.08088979e-08  5.09334633e-06  1.98004716e-07
 -3.81615626e-05 -7.88875429e-06  7.27190982e-06 -1.01902510e-05
  3.63891807e-06  2.18676301e-05  2.95362670e-06 -5.77405405e-06]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:18:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249410195088       1
[INPUT] 0    0    [1    /1   ]  0.649657502294       1
[INPUT] 0    0    [1    /1   ]  117616.812888        1
[INPUT] 0    0    [1    /1   ]  3.03465729341        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175458        1
[INPUT] 0    0    [1    /1   ]  36754.7015217        1
[INPUT] 0    0    [1    /1   ]  7302.3206877         1
[INPUT] 0    0    [1    /1   ]  18375.7713161        1
[INPUT] 0    0    [1    /1   ]  1443.51495325        1
[INPUT] 0    0    [1    /1   ]  417.429684096        1
[INPUT] 0    0    [1    /1   ]  147.856355877        1
[INPUT] 0    0    [1    /1   ]  58.4587012741        1
[INPUT] 0    0    [1    /1   ]  24.5480171941        1
[INPUT] 0    0    [1    /1   ]  7.5795958017         1
[INPUT] 1    0    [1    /1   ]  8.60415457629        1
[INPUT] 1    0    [1    /1   ]  0.492700156557       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24941019508784093, 1.0]], [0, [0.6496575022943752, 1.0]], [0, [117616.81288846747, 1.0]], [0, [3.034657293408821, 1.0]], [0, [1176168.1426134498, 1.0]], [0, [588084.0699565338, 1.0]], [0, [294042.0309212736, 1.0]], [0, [147020.9913226872, 1.0]], [0, [73510.41754578194, 1.0]], [0, [36754.70152171298, 1.0]], [0, [7302.320687700548, 1.0]], [0, [18375.77131612855, 1.0]], [0, [1443.5149532482956, 1.0]], [0, [417.4296840961355, 1.0]], [0, [147.8563558765438, 1.0]], [0, [58.4587012741196, 1.0]], [0, [24.548017194052314, 1.0]], [0, [7.579595801698271, 1.0]], [1, [8.604154576290336, 1.0]], [1, [0.49270015655650207, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2494102]
bas 1, expnt(s) = [0.6496575]
bas 2, expnt(s) = [117616.81288847]
bas 3, expnt(s) = [3.03465729]
bas 4, expnt(s) = [1176168.14261345]
bas 5, expnt(s) = [588084.06995653]
bas 6, expnt(s) = [294042.03092127]
bas 7, expnt(s) = [147020.99132269]
bas 8, expnt(s) = [73510.41754578]
bas 9, expnt(s) = [36754.70152171]
bas 10, expnt(s) = [7302.3206877]
bas 11, expnt(s) = [18375.77131613]
bas 12, expnt(s) = [1443.51495325]
bas 13, expnt(s) = [417.4296841]
bas 14, expnt(s) = [147.85635588]
bas 15, expnt(s) = [58.45870127]
bas 16, expnt(s) = [24.54801719]
bas 17, expnt(s) = [7.5795958]
bas 18, expnt(s) = [8.60415458]
bas 19, expnt(s) = [0.49270016]
CPU time:      1260.26
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49410195e-01 8.91662856e-01 6.49657502e-01 1.82821963e+00
 1.17616813e+05 1.60460108e+04 3.03465729e+00 5.80894499e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104175e+04 1.12791583e+04 3.67547015e+04 6.70655823e+03
 7.30232069e+03 1.99577097e+03 1.83757713e+04 3.98748633e+03
 1.44351495e+03 5.91671962e+02 4.17429684e+02 2.33320297e+02
 1.47856356e+02 1.07126033e+02 5.84587013e+01 5.34136057e+01
 2.45480172e+01 2.78629656e+01 7.57959580e+00 1.15411626e+01
 8.60415458e+00 4.29902180e+01 4.92700157e-01 1.20423922e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33594903658283
cond(S) = 912126.3499199047
E1 = -689.5864986945523  E_coul = 184.96614691045366
init E= -504.620351784099
    CPU time for initialize scf      0.42 sec, wall time      0.06 sec
  HOMO = -0.672298059618833  LUMO = 0.692168912493184
  mo_energy =
[-1.21710327e+02 -1.33863635e+01 -7.62400169e+00 -7.62400169e+00
 -7.62400169e+00 -1.65740955e+00 -6.72298060e-01 -6.72298060e-01
 -6.72298060e-01  6.92168912e-01  1.01610064e+01  6.34161712e+01
  2.57610919e+02  8.86659925e+02  3.14064956e+03  1.26213456e+04
  4.12186461e+04  1.05246913e+05  2.30420084e+05  4.56227628e+05
  8.45174266e+05  1.52834609e+06  2.85060679e+06  5.80848547e+06]
E1 = -707.7385275236323  E_coul = 199.76691418246014
cycle= 1 E= -507.971613341172  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.706589
diis-c [-0.49926811  1.        ]
  HOMO = -0.217853821254256  LUMO = 1.08207370000362
  mo_energy =
[-1.20201845e+02 -1.23056006e+01 -6.59529474e+00 -6.59529474e+00
 -6.59529474e+00 -1.16332245e+00 -2.17853821e-01 -2.17853821e-01
 -2.17853821e-01  1.08207370e+00  1.10287036e+01  6.46860087e+01
  2.59067045e+02  8.88151733e+02  3.14208089e+03  1.26226703e+04
  4.12199035e+04  1.05248133e+05  2.30421280e+05  4.56228806e+05
  8.45175431e+05  1.52834724e+06  2.85060793e+06  5.80848661e+06]
E1 = -706.7988478258281  E_coul = 198.80973574744112
cycle= 2 E= -507.989112078387  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0291878
diis-c [-8.47681850e-04  2.91015348e-03  9.97089847e-01]
  HOMO = -0.239662506160303  LUMO = 1.07623840566967
  mo_energy =
[-1.20314450e+02 -1.23717872e+01 -6.66860668e+00 -6.66860668e+00
 -6.66860668e+00 -1.17736027e+00 -2.39662506e-01 -2.39662506e-01
 -2.39662506e-01  1.07623841e+00  1.09829862e+01  6.46050322e+01
  2.58964249e+02  8.88033395e+02  3.14194850e+03  1.26225278e+04
  4.12197572e+04  1.05247986e+05  2.30421131e+05  4.56228657e+05
  8.45175282e+05  1.52834709e+06  2.85060778e+06  5.80848646e+06]
E1 = -706.692903054594  E_coul = 198.70353549285053
cycle= 3 E= -507.989367561744  delta_E= -0.000255  |g|= 0.00444  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322742
diis-c [-2.05511900e-06 -9.86666200e-05 -1.10168917e-01  1.11026758e+00]
  HOMO = -0.242858629663779  LUMO = 1.07515023309537
  mo_energy =
[-1.20326653e+02 -1.23805712e+01 -6.67790836e+00 -6.67790836e+00
 -6.67790836e+00 -1.17929810e+00 -2.42858630e-01 -2.42858630e-01
 -2.42858630e-01  1.07515023e+00  1.09764820e+01  6.45951644e+01
  2.58952742e+02  8.88020914e+02  3.14193525e+03  1.26225141e+04
  4.12197433e+04  1.05247972e+05  2.30421117e+05  4.56228643e+05
  8.45175268e+05  1.52834708e+06  2.85060777e+06  5.80848644e+06]
E1 = -706.6775246498537  E_coul = 198.68815216922553
cycle= 4 E= -507.989372480628  delta_E= -4.92e-06  |g|= 0.000197  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135799
diis-c [-1.25811670e-10 -6.86170069e-06  7.44066151e-03 -9.85786387e-02
  1.09114484e+00]
  HOMO = -0.242992346949289  LUMO = 1.07509756995941
  mo_energy =
[-1.20326984e+02 -1.23808948e+01 -6.67822874e+00 -6.67822874e+00
 -6.67822874e+00 -1.17937749e+00 -2.42992347e-01 -2.42992347e-01
 -2.42992347e-01  1.07509757e+00  1.09762220e+01  6.45948440e+01
  2.58952412e+02  8.88020582e+02  3.14193492e+03  1.26225137e+04
  4.12197430e+04  1.05247971e+05  2.30421117e+05  4.56228643e+05
  8.45175267e+05  1.52834708e+06  2.85060777e+06  5.80848644e+06]
E1 = -706.6768889999732  E_coul = 198.68751651022382
cycle= 5 E= -507.989372489749  delta_E= -9.12e-09  |g|= 8.55e-07  |ddm|= 0.00044
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.41962e-07
diis-c [-2.59815845e-14  1.83727795e-07 -1.18613317e-04  1.38495365e-03
 -1.63299757e-02  1.01506345e+00]
  HOMO = -0.242992875581054  LUMO = 1.07509753273526
  mo_energy =
[-1.20326986e+02 -1.23808961e+01 -6.67823015e+00 -6.67823015e+00
 -6.67823015e+00 -1.17937794e+00 -2.42992876e-01 -2.42992876e-01
 -2.42992876e-01  1.07509753e+00  1.09762210e+01  6.45948425e+01
  2.58952411e+02  8.88020580e+02  3.14193491e+03  1.26225137e+04
  4.12197430e+04  1.05247971e+05  2.30421117e+05  4.56228643e+05
  8.45175267e+05  1.52834708e+06  2.85060777e+06  5.80848644e+06]
E1 = -706.6768862070633  E_coul = 198.68751371731403
cycle= 6 E= -507.989372489749  delta_E= 1.71e-13  |g|= 2.13e-08  |ddm|= 1.9e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6768862070633  E_coul = 198.68751371731403
  HOMO = -0.242992886459295  LUMO = 1.07509752602014
  mo_energy =
[-1.20326986e+02 -1.23808961e+01 -6.67823017e+00 -6.67823017e+00
 -6.67823017e+00 -1.17937795e+00 -2.42992886e-01 -2.42992886e-01
 -2.42992886e-01  1.07509753e+00  1.09762209e+01  6.45948425e+01
  2.58952411e+02  8.88020580e+02  3.14193491e+03  1.26225137e+04
  4.12197430e+04  1.05247971e+05  2.30421117e+05  4.56228643e+05
  8.45175267e+05  1.52834708e+06  2.85060777e+06  5.80848644e+06]
E1 = -706.6768861614577  E_coul = 198.68751367170796
Extra cycle  E= -507.98937248975  delta_E= -4.55e-13  |g|= 3.05e-09  |ddm|= 3.76e-08
    CPU time for scf_cycle      1.11 sec, wall time      0.28 sec
exp = [2.49410195e-01 6.49657502e-01 1.17616813e+05 3.03465729e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104175e+04 3.67547015e+04 7.30232069e+03 1.83757713e+04
 1.44351495e+03 4.17429684e+02 1.47856356e+02 5.84587013e+01
 2.45480172e+01 7.57959580e+00 8.60415458e+00 4.92700157e-01]
E = -507.9893724897497
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:18:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249410195088       1
[INPUT] 0    0    [1    /1   ]  0.649657502294       1
[INPUT] 0    0    [1    /1   ]  117616.812888        1
[INPUT] 0    0    [1    /1   ]  3.03465729341        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175458        1
[INPUT] 0    0    [1    /1   ]  36754.7015217        1
[INPUT] 0    0    [1    /1   ]  7302.3206877         1
[INPUT] 0    0    [1    /1   ]  18375.7713161        1
[INPUT] 0    0    [1    /1   ]  1443.51495325        1
[INPUT] 0    0    [1    /1   ]  417.429684096        1
[INPUT] 0    0    [1    /1   ]  147.856355877        1
[INPUT] 0    0    [1    /1   ]  58.4587012741        1
[INPUT] 0    0    [1    /1   ]  24.5480171941        1
[INPUT] 0    0    [1    /1   ]  7.5795958017         1
[INPUT] 1    0    [1    /1   ]  8.60415457629        1
[INPUT] 1    0    [1    /1   ]  0.492700156557       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24941019508784093, 1.0]], [0, [0.6496575022943752, 1.0]], [0, [117616.81288846747, 1.0]], [0, [3.034657293408821, 1.0]], [0, [1176168.1426134498, 1.0]], [0, [588084.0699565338, 1.0]], [0, [294042.0309212736, 1.0]], [0, [147020.9913226872, 1.0]], [0, [73510.41754578194, 1.0]], [0, [36754.70152171298, 1.0]], [0, [7302.320687700548, 1.0]], [0, [18375.77131612855, 1.0]], [0, [1443.5149532482956, 1.0]], [0, [417.4296840961355, 1.0]], [0, [147.8563558765438, 1.0]], [0, [58.4587012741196, 1.0]], [0, [24.548017194052314, 1.0]], [0, [7.579595801698271, 1.0]], [1, [8.604154576290336, 1.0]], [1, [0.49270015655650207, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2494102]
bas 1, expnt(s) = [0.6496575]
bas 2, expnt(s) = [117616.81288847]
bas 3, expnt(s) = [3.03465729]
bas 4, expnt(s) = [1176168.14261345]
bas 5, expnt(s) = [588084.06995653]
bas 6, expnt(s) = [294042.03092127]
bas 7, expnt(s) = [147020.99132269]
bas 8, expnt(s) = [73510.41754578]
bas 9, expnt(s) = [36754.70152171]
bas 10, expnt(s) = [7302.3206877]
bas 11, expnt(s) = [18375.77131613]
bas 12, expnt(s) = [1443.51495325]
bas 13, expnt(s) = [417.4296841]
bas 14, expnt(s) = [147.85635588]
bas 15, expnt(s) = [58.45870127]
bas 16, expnt(s) = [24.54801719]
bas 17, expnt(s) = [7.5795958]
bas 18, expnt(s) = [8.60415458]
bas 19, expnt(s) = [0.49270016]
CPU time:      1261.96
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49410195e-01 8.91662856e-01 6.49657502e-01 1.82821963e+00
 1.17616813e+05 1.60460108e+04 3.03465729e+00 5.80894499e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104175e+04 1.12791583e+04 3.67547015e+04 6.70655823e+03
 7.30232069e+03 1.99577097e+03 1.83757713e+04 3.98748633e+03
 1.44351495e+03 5.91671962e+02 4.17429684e+02 2.33320297e+02
 1.47856356e+02 1.07126033e+02 5.84587013e+01 5.34136057e+01
 2.45480172e+01 2.78629656e+01 7.57959580e+00 1.15411626e+01
 8.60415458e+00 4.29902180e+01 4.92700157e-01 1.20423922e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33594903658283
cond(S) = 912126.3499199047
E1 = -689.5864986945523  E_coul = 184.96614691045366
init E= -504.620351784099
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672298059618833  LUMO = 0.692168912493184
  mo_energy =
[-1.21710327e+02 -1.33863635e+01 -7.62400169e+00 -7.62400169e+00
 -7.62400169e+00 -1.65740955e+00 -6.72298060e-01 -6.72298060e-01
 -6.72298060e-01  6.92168912e-01  1.01610064e+01  6.34161712e+01
  2.57610919e+02  8.86659925e+02  3.14064956e+03  1.26213456e+04
  4.12186461e+04  1.05246913e+05  2.30420084e+05  4.56227628e+05
  8.45174266e+05  1.52834609e+06  2.85060679e+06  5.80848547e+06]
E1 = -707.7385275236323  E_coul = 199.76691418246014
cycle= 1 E= -507.971613341172  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.706589
diis-c [-0.49926811  1.        ]
  HOMO = -0.217853821254256  LUMO = 1.08207370000362
  mo_energy =
[-1.20201845e+02 -1.23056006e+01 -6.59529474e+00 -6.59529474e+00
 -6.59529474e+00 -1.16332245e+00 -2.17853821e-01 -2.17853821e-01
 -2.17853821e-01  1.08207370e+00  1.10287036e+01  6.46860087e+01
  2.59067045e+02  8.88151733e+02  3.14208089e+03  1.26226703e+04
  4.12199035e+04  1.05248133e+05  2.30421280e+05  4.56228806e+05
  8.45175431e+05  1.52834724e+06  2.85060793e+06  5.80848661e+06]
E1 = -706.7988478258281  E_coul = 198.80973574744112
cycle= 2 E= -507.989112078387  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0291878
diis-c [-8.47681850e-04  2.91015348e-03  9.97089847e-01]
  HOMO = -0.239662506160303  LUMO = 1.07623840566967
  mo_energy =
[-1.20314450e+02 -1.23717872e+01 -6.66860668e+00 -6.66860668e+00
 -6.66860668e+00 -1.17736027e+00 -2.39662506e-01 -2.39662506e-01
 -2.39662506e-01  1.07623841e+00  1.09829862e+01  6.46050322e+01
  2.58964249e+02  8.88033395e+02  3.14194850e+03  1.26225278e+04
  4.12197572e+04  1.05247986e+05  2.30421131e+05  4.56228657e+05
  8.45175282e+05  1.52834709e+06  2.85060778e+06  5.80848646e+06]
E1 = -706.692903054594  E_coul = 198.70353549285053
cycle= 3 E= -507.989367561744  delta_E= -0.000255  |g|= 0.00444  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322742
diis-c [-2.05511900e-06 -9.86666200e-05 -1.10168917e-01  1.11026758e+00]
  HOMO = -0.242858629663779  LUMO = 1.07515023309537
  mo_energy =
[-1.20326653e+02 -1.23805712e+01 -6.67790836e+00 -6.67790836e+00
 -6.67790836e+00 -1.17929810e+00 -2.42858630e-01 -2.42858630e-01
 -2.42858630e-01  1.07515023e+00  1.09764820e+01  6.45951644e+01
  2.58952742e+02  8.88020914e+02  3.14193525e+03  1.26225141e+04
  4.12197433e+04  1.05247972e+05  2.30421117e+05  4.56228643e+05
  8.45175268e+05  1.52834708e+06  2.85060777e+06  5.80848644e+06]
E1 = -706.6775246498537  E_coul = 198.68815216922553
cycle= 4 E= -507.989372480628  delta_E= -4.92e-06  |g|= 0.000197  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135799
diis-c [-1.25811670e-10 -6.86170069e-06  7.44066151e-03 -9.85786387e-02
  1.09114484e+00]
  HOMO = -0.242992346949289  LUMO = 1.07509756995941
  mo_energy =
[-1.20326984e+02 -1.23808948e+01 -6.67822874e+00 -6.67822874e+00
 -6.67822874e+00 -1.17937749e+00 -2.42992347e-01 -2.42992347e-01
 -2.42992347e-01  1.07509757e+00  1.09762220e+01  6.45948440e+01
  2.58952412e+02  8.88020582e+02  3.14193492e+03  1.26225137e+04
  4.12197430e+04  1.05247971e+05  2.30421117e+05  4.56228643e+05
  8.45175267e+05  1.52834708e+06  2.85060777e+06  5.80848644e+06]
E1 = -706.6768889999732  E_coul = 198.68751651022382
cycle= 5 E= -507.989372489749  delta_E= -9.12e-09  |g|= 8.55e-07  |ddm|= 0.00044
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.41962e-07
diis-c [-2.59815845e-14  1.83727795e-07 -1.18613317e-04  1.38495365e-03
 -1.63299757e-02  1.01506345e+00]
  HOMO = -0.242992875581054  LUMO = 1.07509753273526
  mo_energy =
[-1.20326986e+02 -1.23808961e+01 -6.67823015e+00 -6.67823015e+00
 -6.67823015e+00 -1.17937794e+00 -2.42992876e-01 -2.42992876e-01
 -2.42992876e-01  1.07509753e+00  1.09762210e+01  6.45948425e+01
  2.58952411e+02  8.88020580e+02  3.14193491e+03  1.26225137e+04
  4.12197430e+04  1.05247971e+05  2.30421117e+05  4.56228643e+05
  8.45175267e+05  1.52834708e+06  2.85060777e+06  5.80848644e+06]
E1 = -706.6768862070633  E_coul = 198.68751371731403
cycle= 6 E= -507.989372489749  delta_E= 1.71e-13  |g|= 2.13e-08  |ddm|= 1.9e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6768862070633  E_coul = 198.68751371731403
  HOMO = -0.242992886459295  LUMO = 1.07509752602014
  mo_energy =
[-1.20326986e+02 -1.23808961e+01 -6.67823017e+00 -6.67823017e+00
 -6.67823017e+00 -1.17937795e+00 -2.42992886e-01 -2.42992886e-01
 -2.42992886e-01  1.07509753e+00  1.09762209e+01  6.45948425e+01
  2.58952411e+02  8.88020580e+02  3.14193491e+03  1.26225137e+04
  4.12197430e+04  1.05247971e+05  2.30421117e+05  4.56228643e+05
  8.45175267e+05  1.52834708e+06  2.85060777e+06  5.80848644e+06]
E1 = -706.6768861614577  E_coul = 198.68751367170796
Extra cycle  E= -507.98937248975  delta_E= -4.55e-13  |g|= 3.05e-09  |ddm|= 3.76e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912126.3499199047
E1 = -706.6768861614577  E_coul = 198.68751367170796
init E= -507.98937248975
    CPU time for initialize scf      3.32 sec, wall time      0.21 sec
  HOMO = -0.24299288787499  LUMO = 1.0750975270336
  mo_energy =
[-1.20326986e+02 -1.23808962e+01 -6.67823018e+00 -6.67823018e+00
 -6.67823018e+00 -1.17937795e+00 -2.42992888e-01 -2.42992888e-01
 -2.42992888e-01  1.07509753e+00  1.09762209e+01  6.45948425e+01
  2.58952411e+02  8.88020580e+02  3.14193491e+03  1.26225137e+04
  4.12197430e+04  1.05247971e+05  2.30421117e+05  4.56228643e+05
  8.45175267e+05  1.52834708e+06  2.85060777e+06  5.80848644e+06]
E1 = -706.6768861527767  E_coul = 198.68751366302726
cycle= 1 E= -507.989372489749  delta_E= 3.41e-13  |g|= 1.22e-09  |ddm|= 6.01e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6768861527767  E_coul = 198.68751366302726
  HOMO = -0.242992888129438  LUMO = 1.07509752536161
  mo_energy =
[-1.20326986e+02 -1.23808962e+01 -6.67823018e+00 -6.67823018e+00
 -6.67823018e+00 -1.17937795e+00 -2.42992888e-01 -2.42992888e-01
 -2.42992888e-01  1.07509753e+00  1.09762209e+01  6.45948425e+01
  2.58952411e+02  8.88020580e+02  3.14193491e+03  1.26225137e+04
  4.12197430e+04  1.05247971e+05  2.30421117e+05  4.56228643e+05
  8.45175267e+05  1.52834708e+06  2.85060777e+06  5.80848644e+06]
E1 = -706.6768861535799  E_coul = 198.68751366383052
Extra cycle  E= -507.989372489749  delta_E=    0  |g|= 1.01e-09  |ddm|= 5.91e-10
    CPU time for scf_cycle      3.78 sec, wall time      0.38 sec
exp = [2.49410195e-01 6.49657502e-01 1.17616813e+05 3.03465729e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104175e+04 3.67547015e+04 7.30232069e+03 1.83757713e+04
 1.44351495e+03 4.17429684e+02 1.47856356e+02 5.84587013e+01
 2.45480172e+01 7.57959580e+00 8.60415458e+00 4.92700157e-01]
grad_E = [ 2.68976493e-05 -5.53057403e-06  6.06661455e-09 -1.96093432e-05
  4.04883120e-11  1.74297748e-10  9.40969571e-10  3.71784208e-09
  1.55252200e-08  8.09759430e-08  5.10374347e-06  1.98550785e-07
 -3.85004350e-05 -6.20078311e-06  3.61343732e-06 -5.41647504e-06
  2.55571138e-06  1.29177881e-05  2.03717127e-05 -4.92474652e-06]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:18:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249393775773       1
[INPUT] 0    0    [1    /1   ]  0.649646656285       1
[INPUT] 0    0    [1    /1   ]  117616.812888        1
[INPUT] 0    0    [1    /1   ]  3.03411288163        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991322        1
[INPUT] 0    0    [1    /1   ]  73510.417544         1
[INPUT] 0    0    [1    /1   ]  36754.7015122        1
[INPUT] 0    0    [1    /1   ]  7302.32010085        1
[INPUT] 0    0    [1    /1   ]  18375.7712968        1
[INPUT] 0    0    [1    /1   ]  1443.5087924         1
[INPUT] 0    0    [1    /1   ]  417.480322785        1
[INPUT] 0    0    [1    /1   ]  147.844193031        1
[INPUT] 0    0    [1    /1   ]  58.4572537131        1
[INPUT] 0    0    [1    /1   ]  24.5521554749        1
[INPUT] 0    0    [1    /1   ]  7.57725680114        1
[INPUT] 1    0    [1    /1   ]  8.60414719679        1
[INPUT] 1    0    [1    /1   ]  0.492700044491       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24939377577330124, 1.0]], [0, [0.6496466562846736, 1.0]], [0, [117616.81288777516, 1.0]], [0, [3.034112881626109, 1.0]], [0, [1176168.1426134475, 1.0]], [0, [588084.0699565157, 1.0]], [0, [294042.0309211658, 1.0]], [0, [147020.99132226553, 1.0]], [0, [73510.41754403379, 1.0]], [0, [36754.7015121964, 1.0]], [0, [7302.320100852058, 1.0]], [0, [18375.77129676544, 1.0]], [0, [1443.5087923968442, 1.0]], [0, [417.4803227852397, 1.0]], [0, [147.8441930311881, 1.0]], [0, [58.457253713120295, 1.0]], [0, [24.55215547491401, 1.0]], [0, [7.577256801141212, 1.0]], [1, [8.60414719678841, 1.0]], [1, [0.49270004449117805, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24939378]
bas 1, expnt(s) = [0.64964666]
bas 2, expnt(s) = [117616.81288778]
bas 3, expnt(s) = [3.03411288]
bas 4, expnt(s) = [1176168.14261345]
bas 5, expnt(s) = [588084.06995652]
bas 6, expnt(s) = [294042.03092117]
bas 7, expnt(s) = [147020.99132227]
bas 8, expnt(s) = [73510.41754403]
bas 9, expnt(s) = [36754.7015122]
bas 10, expnt(s) = [7302.32010085]
bas 11, expnt(s) = [18375.77129677]
bas 12, expnt(s) = [1443.5087924]
bas 13, expnt(s) = [417.48032279]
bas 14, expnt(s) = [147.84419303]
bas 15, expnt(s) = [58.45725371]
bas 16, expnt(s) = [24.55215547]
bas 17, expnt(s) = [7.5772568]
bas 18, expnt(s) = [8.6041472]
bas 19, expnt(s) = [0.49270004]
CPU time:      1274.04
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49393776e-01 8.91618831e-01 6.49646656e-01 1.82819674e+00
 1.17616813e+05 1.60460108e+04 3.03411288e+00 5.80816339e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104175e+04 1.12791583e+04 3.67547015e+04 6.70655822e+03
 7.30232010e+03 1.99577085e+03 1.83757713e+04 3.98748633e+03
 1.44350879e+03 5.91670068e+02 4.17480323e+02 2.33341525e+02
 1.47844193e+02 1.07119424e+02 5.84572537e+01 5.34126137e+01
 2.45521555e+01 2.78664883e+01 7.57725680e+00 1.15384914e+01
 8.60414720e+00 4.29901719e+01 4.92700044e-01 1.20423888e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335949525192866
cond(S) = 912127.3141302827
E1 = -689.5863498467554  E_coul = 184.96611082727344
init E= -504.620239019482
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672297985104208  LUMO = 0.692092493710483
  mo_energy =
[-1.21710335e+02 -1.33863660e+01 -7.62400428e+00 -7.62400428e+00
 -7.62400428e+00 -1.65740976e+00 -6.72297985e-01 -6.72297985e-01
 -6.72297985e-01  6.92092494e-01  1.01579626e+01  6.34110068e+01
  2.57604215e+02  8.86670368e+02  3.14073659e+03  1.26214628e+04
  4.12187597e+04  1.05247022e+05  2.30420190e+05  4.56227732e+05
  8.45174368e+05  1.52834619e+06  2.85060688e+06  5.80848557e+06]
E1 = -707.7384888869607  E_coul = 199.76687580887494
cycle= 1 E= -507.971613078086  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.706589
diis-c [-0.49926763  1.        ]
  HOMO = -0.217854235712084  LUMO = 1.08197955840835
  mo_energy =
[-1.20201854e+02 -1.23056027e+01 -6.59529695e+00 -6.59529695e+00
 -6.59529695e+00 -1.16332302e+00 -2.17854236e-01 -2.17854236e-01
 -2.17854236e-01  1.08197956e+00  1.10255768e+01  6.46808499e+01
  2.59060343e+02  8.88162174e+02  3.14216792e+03  1.26227874e+04
  4.12200171e+04  1.05248243e+05  2.30421386e+05  4.56228911e+05
  8.45175534e+05  1.52834734e+06  2.85060803e+06  5.80848670e+06]
E1 = -706.7987933397217  E_coul = 198.80968120007898
cycle= 2 E= -507.989112139643  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0291883
diis-c [-8.47709562e-04  2.91124058e-03  9.97088759e-01]
  HOMO = -0.239663255062154  LUMO = 1.07614503246386
  mo_energy =
[-1.20314460e+02 -1.23717906e+01 -6.66861011e+00 -6.66861011e+00
 -6.66861011e+00 -1.17736106e+00 -2.39663255e-01 -2.39663255e-01
 -2.39663255e-01  1.07614503e+00  1.09798648e+01  6.45998724e+01
  2.58957546e+02  8.88043834e+02  3.14203553e+03  1.26226450e+04
  4.12198709e+04  1.05248095e+05  2.30421238e+05  4.56228761e+05
  8.45175384e+05  1.52834720e+06  2.85060788e+06  5.80848655e+06]
E1 = -706.6928464126069  E_coul = 198.70347878194397
cycle= 3 E= -507.989367630663  delta_E= -0.000255  |g|= 0.00444  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0032276
diis-c [-2.05518801e-06 -9.87334426e-05 -1.10174788e-01  1.11027352e+00]
  HOMO = -0.242859505546071  LUMO = 1.07505693832549
  mo_energy =
[-1.20326663e+02 -1.23805749e+01 -6.67791211e+00 -6.67791211e+00
 -6.67791211e+00 -1.17929898e+00 -2.42859506e-01 -2.42859506e-01
 -2.42859506e-01  1.07505694e+00  1.09733611e+01  6.45900042e+01
  2.58946038e+02  8.88031352e+02  3.14202228e+03  1.26226312e+04
  4.12198569e+04  1.05248081e+05  2.30421224e+05  4.56228747e+05
  8.45175370e+05  1.52834718e+06  2.85060787e+06  5.80848654e+06]
E1 = -706.6774673372115  E_coul = 198.6880947872629
cycle= 4 E= -507.989372549949  delta_E= -4.92e-06  |g|= 0.000197  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135798
diis-c [-1.25898230e-10 -6.85412447e-06  7.44071823e-03 -9.85746566e-02
  1.09114079e+00]
  HOMO = -0.24299322028257  LUMO = 1.0750042808184
  mo_energy =
[-1.20326995e+02 -1.23808984e+01 -6.67823246e+00 -6.67823246e+00
 -6.67823246e+00 -1.17937836e+00 -2.42993220e-01 -2.42993220e-01
 -2.42993220e-01  1.07500428e+00  1.09731011e+01  6.45896839e+01
  2.58945709e+02  8.88031020e+02  3.14202194e+03  1.26226309e+04
  4.12198566e+04  1.05248081e+05  2.30421223e+05  4.56228747e+05
  8.45175370e+05  1.52834718e+06  2.85060786e+06  5.80848654e+06]
E1 = -706.676831695801  E_coul = 198.6874591367314
cycle= 5 E= -507.98937255907  delta_E= -9.12e-09  |g|= 8.56e-07  |ddm|= 0.00044
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.42235e-07
diis-c [-2.60131878e-14  1.83138015e-07 -1.18561142e-04  1.38430565e-03
 -1.63289314e-02  1.01506300e+00]
  HOMO = -0.242993749762215  LUMO = 1.07500424261488
  mo_energy =
[-1.20326997e+02 -1.23808998e+01 -6.67823387e+00 -6.67823387e+00
 -6.67823387e+00 -1.17937882e+00 -2.42993750e-01 -2.42993750e-01
 -2.42993750e-01  1.07500424e+00  1.09731001e+01  6.45896824e+01
  2.58945707e+02  8.88031018e+02  3.14202194e+03  1.26226309e+04
  4.12198566e+04  1.05248081e+05  2.30421223e+05  4.56228747e+05
  8.45175370e+05  1.52834718e+06  2.85060786e+06  5.80848654e+06]
E1 = -706.6768289028606  E_coul = 198.68745634379005
cycle= 6 E= -507.989372559071  delta_E= -1.02e-12  |g|= 2.19e-08  |ddm|= 1.9e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6768289028606  E_coul = 198.68745634379005
  HOMO = -0.242993760566384  LUMO = 1.07500423723566
  mo_energy =
[-1.20326997e+02 -1.23808998e+01 -6.67823390e+00 -6.67823390e+00
 -6.67823390e+00 -1.17937883e+00 -2.42993761e-01 -2.42993761e-01
 -2.42993761e-01  1.07500424e+00  1.09731000e+01  6.45896824e+01
  2.58945707e+02  8.88031018e+02  3.14202194e+03  1.26226309e+04
  4.12198566e+04  1.05248081e+05  2.30421223e+05  4.56228747e+05
  8.45175370e+05  1.52834718e+06  2.85060786e+06  5.80848654e+06]
E1 = -706.6768288540821  E_coul = 198.6874562950115
Extra cycle  E= -507.989372559071  delta_E= -5.68e-14  |g|= 2.92e-09  |ddm|= 3.95e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.49393776e-01 6.49646656e-01 1.17616813e+05 3.03411288e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104175e+04 3.67547015e+04 7.30232010e+03 1.83757713e+04
 1.44350879e+03 4.17480323e+02 1.47844193e+02 5.84572537e+01
 2.45521555e+01 7.57725680e+00 8.60414720e+00 4.92700044e-01]
E = -507.98937255907066
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:18:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249393775773       1
[INPUT] 0    0    [1    /1   ]  0.649646656285       1
[INPUT] 0    0    [1    /1   ]  117616.812888        1
[INPUT] 0    0    [1    /1   ]  3.03411288163        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991322        1
[INPUT] 0    0    [1    /1   ]  73510.417544         1
[INPUT] 0    0    [1    /1   ]  36754.7015122        1
[INPUT] 0    0    [1    /1   ]  7302.32010085        1
[INPUT] 0    0    [1    /1   ]  18375.7712968        1
[INPUT] 0    0    [1    /1   ]  1443.5087924         1
[INPUT] 0    0    [1    /1   ]  417.480322785        1
[INPUT] 0    0    [1    /1   ]  147.844193031        1
[INPUT] 0    0    [1    /1   ]  58.4572537131        1
[INPUT] 0    0    [1    /1   ]  24.5521554749        1
[INPUT] 0    0    [1    /1   ]  7.57725680114        1
[INPUT] 1    0    [1    /1   ]  8.60414719679        1
[INPUT] 1    0    [1    /1   ]  0.492700044491       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24939377577330124, 1.0]], [0, [0.6496466562846736, 1.0]], [0, [117616.81288777516, 1.0]], [0, [3.034112881626109, 1.0]], [0, [1176168.1426134475, 1.0]], [0, [588084.0699565157, 1.0]], [0, [294042.0309211658, 1.0]], [0, [147020.99132226553, 1.0]], [0, [73510.41754403379, 1.0]], [0, [36754.7015121964, 1.0]], [0, [7302.320100852058, 1.0]], [0, [18375.77129676544, 1.0]], [0, [1443.5087923968442, 1.0]], [0, [417.4803227852397, 1.0]], [0, [147.8441930311881, 1.0]], [0, [58.457253713120295, 1.0]], [0, [24.55215547491401, 1.0]], [0, [7.577256801141212, 1.0]], [1, [8.60414719678841, 1.0]], [1, [0.49270004449117805, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24939378]
bas 1, expnt(s) = [0.64964666]
bas 2, expnt(s) = [117616.81288778]
bas 3, expnt(s) = [3.03411288]
bas 4, expnt(s) = [1176168.14261345]
bas 5, expnt(s) = [588084.06995652]
bas 6, expnt(s) = [294042.03092117]
bas 7, expnt(s) = [147020.99132227]
bas 8, expnt(s) = [73510.41754403]
bas 9, expnt(s) = [36754.7015122]
bas 10, expnt(s) = [7302.32010085]
bas 11, expnt(s) = [18375.77129677]
bas 12, expnt(s) = [1443.5087924]
bas 13, expnt(s) = [417.48032279]
bas 14, expnt(s) = [147.84419303]
bas 15, expnt(s) = [58.45725371]
bas 16, expnt(s) = [24.55215547]
bas 17, expnt(s) = [7.5772568]
bas 18, expnt(s) = [8.6041472]
bas 19, expnt(s) = [0.49270004]
CPU time:      1275.74
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49393776e-01 8.91618831e-01 6.49646656e-01 1.82819674e+00
 1.17616813e+05 1.60460108e+04 3.03411288e+00 5.80816339e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104175e+04 1.12791583e+04 3.67547015e+04 6.70655822e+03
 7.30232010e+03 1.99577085e+03 1.83757713e+04 3.98748633e+03
 1.44350879e+03 5.91670068e+02 4.17480323e+02 2.33341525e+02
 1.47844193e+02 1.07119424e+02 5.84572537e+01 5.34126137e+01
 2.45521555e+01 2.78664883e+01 7.57725680e+00 1.15384914e+01
 8.60414720e+00 4.29901719e+01 4.92700044e-01 1.20423888e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335949525192866
cond(S) = 912127.3141302827
E1 = -689.5863498467554  E_coul = 184.96611082727344
init E= -504.620239019482
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672297985104208  LUMO = 0.692092493710483
  mo_energy =
[-1.21710335e+02 -1.33863660e+01 -7.62400428e+00 -7.62400428e+00
 -7.62400428e+00 -1.65740976e+00 -6.72297985e-01 -6.72297985e-01
 -6.72297985e-01  6.92092494e-01  1.01579626e+01  6.34110068e+01
  2.57604215e+02  8.86670368e+02  3.14073659e+03  1.26214628e+04
  4.12187597e+04  1.05247022e+05  2.30420190e+05  4.56227732e+05
  8.45174368e+05  1.52834619e+06  2.85060688e+06  5.80848557e+06]
E1 = -707.7384888869607  E_coul = 199.76687580887494
cycle= 1 E= -507.971613078086  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.706589
diis-c [-0.49926763  1.        ]
  HOMO = -0.217854235712084  LUMO = 1.08197955840835
  mo_energy =
[-1.20201854e+02 -1.23056027e+01 -6.59529695e+00 -6.59529695e+00
 -6.59529695e+00 -1.16332302e+00 -2.17854236e-01 -2.17854236e-01
 -2.17854236e-01  1.08197956e+00  1.10255768e+01  6.46808499e+01
  2.59060343e+02  8.88162174e+02  3.14216792e+03  1.26227874e+04
  4.12200171e+04  1.05248243e+05  2.30421386e+05  4.56228911e+05
  8.45175534e+05  1.52834734e+06  2.85060803e+06  5.80848670e+06]
E1 = -706.7987933397217  E_coul = 198.80968120007898
cycle= 2 E= -507.989112139643  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0291883
diis-c [-8.47709562e-04  2.91124058e-03  9.97088759e-01]
  HOMO = -0.239663255062154  LUMO = 1.07614503246386
  mo_energy =
[-1.20314460e+02 -1.23717906e+01 -6.66861011e+00 -6.66861011e+00
 -6.66861011e+00 -1.17736106e+00 -2.39663255e-01 -2.39663255e-01
 -2.39663255e-01  1.07614503e+00  1.09798648e+01  6.45998724e+01
  2.58957546e+02  8.88043834e+02  3.14203553e+03  1.26226450e+04
  4.12198709e+04  1.05248095e+05  2.30421238e+05  4.56228761e+05
  8.45175384e+05  1.52834720e+06  2.85060788e+06  5.80848655e+06]
E1 = -706.6928464126069  E_coul = 198.70347878194397
cycle= 3 E= -507.989367630663  delta_E= -0.000255  |g|= 0.00444  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0032276
diis-c [-2.05518801e-06 -9.87334426e-05 -1.10174788e-01  1.11027352e+00]
  HOMO = -0.242859505546071  LUMO = 1.07505693832549
  mo_energy =
[-1.20326663e+02 -1.23805749e+01 -6.67791211e+00 -6.67791211e+00
 -6.67791211e+00 -1.17929898e+00 -2.42859506e-01 -2.42859506e-01
 -2.42859506e-01  1.07505694e+00  1.09733611e+01  6.45900042e+01
  2.58946038e+02  8.88031352e+02  3.14202228e+03  1.26226312e+04
  4.12198569e+04  1.05248081e+05  2.30421224e+05  4.56228747e+05
  8.45175370e+05  1.52834718e+06  2.85060787e+06  5.80848654e+06]
E1 = -706.6774673372115  E_coul = 198.6880947872629
cycle= 4 E= -507.989372549949  delta_E= -4.92e-06  |g|= 0.000197  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135798
diis-c [-1.25898230e-10 -6.85412447e-06  7.44071823e-03 -9.85746566e-02
  1.09114079e+00]
  HOMO = -0.24299322028257  LUMO = 1.0750042808184
  mo_energy =
[-1.20326995e+02 -1.23808984e+01 -6.67823246e+00 -6.67823246e+00
 -6.67823246e+00 -1.17937836e+00 -2.42993220e-01 -2.42993220e-01
 -2.42993220e-01  1.07500428e+00  1.09731011e+01  6.45896839e+01
  2.58945709e+02  8.88031020e+02  3.14202194e+03  1.26226309e+04
  4.12198566e+04  1.05248081e+05  2.30421223e+05  4.56228747e+05
  8.45175370e+05  1.52834718e+06  2.85060786e+06  5.80848654e+06]
E1 = -706.676831695801  E_coul = 198.6874591367314
cycle= 5 E= -507.98937255907  delta_E= -9.12e-09  |g|= 8.56e-07  |ddm|= 0.00044
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.42235e-07
diis-c [-2.60131878e-14  1.83138015e-07 -1.18561142e-04  1.38430565e-03
 -1.63289314e-02  1.01506300e+00]
  HOMO = -0.242993749762215  LUMO = 1.07500424261488
  mo_energy =
[-1.20326997e+02 -1.23808998e+01 -6.67823387e+00 -6.67823387e+00
 -6.67823387e+00 -1.17937882e+00 -2.42993750e-01 -2.42993750e-01
 -2.42993750e-01  1.07500424e+00  1.09731001e+01  6.45896824e+01
  2.58945707e+02  8.88031018e+02  3.14202194e+03  1.26226309e+04
  4.12198566e+04  1.05248081e+05  2.30421223e+05  4.56228747e+05
  8.45175370e+05  1.52834718e+06  2.85060786e+06  5.80848654e+06]
E1 = -706.6768289028606  E_coul = 198.68745634379005
cycle= 6 E= -507.989372559071  delta_E= -1.02e-12  |g|= 2.19e-08  |ddm|= 1.9e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6768289028606  E_coul = 198.68745634379005
  HOMO = -0.242993760566384  LUMO = 1.07500423723566
  mo_energy =
[-1.20326997e+02 -1.23808998e+01 -6.67823390e+00 -6.67823390e+00
 -6.67823390e+00 -1.17937883e+00 -2.42993761e-01 -2.42993761e-01
 -2.42993761e-01  1.07500424e+00  1.09731000e+01  6.45896824e+01
  2.58945707e+02  8.88031018e+02  3.14202194e+03  1.26226309e+04
  4.12198566e+04  1.05248081e+05  2.30421223e+05  4.56228747e+05
  8.45175370e+05  1.52834718e+06  2.85060786e+06  5.80848654e+06]
E1 = -706.6768288540821  E_coul = 198.6874562950115
Extra cycle  E= -507.989372559071  delta_E= -5.68e-14  |g|= 2.92e-09  |ddm|= 3.95e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912127.3141302827
E1 = -706.6768288540821  E_coul = 198.6874562950115
init E= -507.989372559071
    CPU time for initialize scf      3.35 sec, wall time      0.21 sec
  HOMO = -0.242993762064177  LUMO = 1.07500423750085
  mo_energy =
[-1.20326997e+02 -1.23808998e+01 -6.67823390e+00 -6.67823390e+00
 -6.67823390e+00 -1.17937883e+00 -2.42993762e-01 -2.42993762e-01
 -2.42993762e-01  1.07500424e+00  1.09731000e+01  6.45896824e+01
  2.58945707e+02  8.88031018e+02  3.14202194e+03  1.26226309e+04
  4.12198566e+04  1.05248081e+05  2.30421223e+05  4.56228747e+05
  8.45175370e+05  1.52834718e+06  2.85060786e+06  5.80848654e+06]
E1 = -706.6768288457348  E_coul = 198.68745628666434
cycle= 1 E= -507.98937255907  delta_E= 1.71e-13  |g|= 1.86e-09  |ddm|= 5.81e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6768288457348  E_coul = 198.68745628666434
  HOMO = -0.242993762307653  LUMO = 1.07500423666399
  mo_energy =
[-1.20326997e+02 -1.23808998e+01 -6.67823390e+00 -6.67823390e+00
 -6.67823390e+00 -1.17937883e+00 -2.42993762e-01 -2.42993762e-01
 -2.42993762e-01  1.07500424e+00  1.09731000e+01  6.45896824e+01
  2.58945707e+02  8.88031018e+02  3.14202194e+03  1.26226309e+04
  4.12198566e+04  1.05248081e+05  2.30421223e+05  4.56228747e+05
  8.45175370e+05  1.52834718e+06  2.85060786e+06  5.80848654e+06]
E1 = -706.6768288462836  E_coul = 198.6874562872131
Extra cycle  E= -507.98937255907  delta_E=    0  |g|= 1.7e-09  |ddm|= 3.1e-10
    CPU time for scf_cycle      3.80 sec, wall time      0.38 sec
exp = [2.49393776e-01 6.49646656e-01 1.17616813e+05 3.03411288e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104175e+04 3.67547015e+04 7.30232010e+03 1.83757713e+04
 1.44350879e+03 4.17480323e+02 1.47844193e+02 5.84572537e+01
 2.45521555e+01 7.57725680e+00 8.60414720e+00 4.92700044e-01]
grad_E = [ 3.16752920e-06 -1.12676516e-06  6.07384217e-09  1.47169435e-06
  4.05694938e-11  1.74534776e-10  9.42078170e-10  3.72231860e-09
  1.55441569e-08  8.10673188e-08  5.10951299e-06  1.98849383e-07
 -3.87121564e-05 -4.89604272e-06  4.00035887e-07 -1.31246848e-06
  6.20771020e-07 -2.39510256e-07  1.42348782e-05 -3.56854787e-06]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:18:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249390579144       1
[INPUT] 0    0    [1    /1   ]  0.649644096621       1
[INPUT] 0    0    [1    /1   ]  117616.812888        1
[INPUT] 0    0    [1    /1   ]  3.03401756022        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175451        1
[INPUT] 0    0    [1    /1   ]  36754.7015182        1
[INPUT] 0    0    [1    /1   ]  7302.32047466        1
[INPUT] 0    0    [1    /1   ]  18375.7713093        1
[INPUT] 0    0    [1    /1   ]  1443.5113083         1
[INPUT] 0    0    [1    /1   ]  417.462455329        1
[INPUT] 0    0    [1    /1   ]  147.825700082        1
[INPUT] 0    0    [1    /1   ]  58.450130325         1
[INPUT] 0    0    [1    /1   ]  24.5500200846        1
[INPUT] 0    0    [1    /1   ]  7.57690493854        1
[INPUT] 1    0    [1    /1   ]  8.604138974          1
[INPUT] 1    0    [1    /1   ]  0.492699882684       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24939057914406415, 1.0]], [0, [0.6496440966210861, 1.0]], [0, [117616.81288821386, 1.0]], [0, [3.034017560216232, 1.0]], [0, [1176168.1426134491, 1.0]], [0, [588084.0699565273, 1.0]], [0, [294042.03092123405, 1.0]], [0, [147020.9913225329, 1.0]], [0, [73510.41754514324, 1.0]], [0, [36754.70151820757, 1.0]], [0, [7302.320474663768, 1.0]], [0, [18375.771309271317, 1.0]], [0, [1443.5113083015835, 1.0]], [0, [417.4624553292532, 1.0]], [0, [147.82570008187116, 1.0]], [0, [58.450130325049294, 1.0]], [0, [24.550020084583927, 1.0]], [0, [7.57690493854081, 1.0]], [1, [8.604138973996582, 1.0]], [1, [0.4926998826844579, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24939058]
bas 1, expnt(s) = [0.6496441]
bas 2, expnt(s) = [117616.81288821]
bas 3, expnt(s) = [3.03401756]
bas 4, expnt(s) = [1176168.14261345]
bas 5, expnt(s) = [588084.06995653]
bas 6, expnt(s) = [294042.03092123]
bas 7, expnt(s) = [147020.99132253]
bas 8, expnt(s) = [73510.41754514]
bas 9, expnt(s) = [36754.70151821]
bas 10, expnt(s) = [7302.32047466]
bas 11, expnt(s) = [18375.77130927]
bas 12, expnt(s) = [1443.5113083]
bas 13, expnt(s) = [417.46245533]
bas 14, expnt(s) = [147.82570008]
bas 15, expnt(s) = [58.45013033]
bas 16, expnt(s) = [24.55002008]
bas 17, expnt(s) = [7.57690494]
bas 18, expnt(s) = [8.60413897]
bas 19, expnt(s) = [0.49269988]
CPU time:      1287.81
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49390579e-01 8.91610259e-01 6.49644097e-01 1.82819134e+00
 1.17616813e+05 1.60460108e+04 3.03401756e+00 5.80802653e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104175e+04 1.12791583e+04 3.67547015e+04 6.70655823e+03
 7.30232047e+03 1.99577092e+03 1.83757713e+04 3.98748633e+03
 1.44351131e+03 5.91670842e+02 4.17462455e+02 2.33334035e+02
 1.47825700e+02 1.07109374e+02 5.84501303e+01 5.34077322e+01
 2.45500201e+01 2.78646706e+01 7.57690494e+00 1.15380895e+01
 8.60413897e+00 4.29901206e+01 4.92699883e-01 1.20423838e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335949829003948
cond(S) = 912125.726466367
E1 = -689.5862988744462  E_coul = 184.96606970505596
init E= -504.62022916939
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.67229805406731  LUMO = 0.692076738211426
  mo_energy =
[-1.21710343e+02 -1.33863693e+01 -7.62400714e+00 -7.62400714e+00
 -7.62400714e+00 -1.65741005e+00 -6.72298054e-01 -6.72298054e-01
 -6.72298054e-01  6.92076738e-01  1.01573172e+01  6.34042430e+01
  2.57571060e+02  8.86578369e+02  3.14058938e+03  1.26213091e+04
  4.12186143e+04  1.05246883e+05  2.30420055e+05  4.56227599e+05
  8.45174237e+05  1.52834606e+06  2.85060676e+06  5.80848544e+06]
E1 = -707.7384410320442  E_coul = 199.76682798422192
cycle= 1 E= -507.971613047822  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.706588
diis-c [-0.49926716  1.        ]
  HOMO = -0.217854625219259  LUMO = 1.08196000604398
  mo_energy =
[-1.20201863e+02 -1.23056064e+01 -6.59530025e+00 -6.59530025e+00
 -6.59530025e+00 -1.16332352e+00 -2.17854625e-01 -2.17854625e-01
 -2.17854625e-01  1.08196001e+00  1.10249088e+01  6.46740582e+01
  2.59027175e+02  8.88070174e+02  3.14202070e+03  1.26226337e+04
  4.12198717e+04  1.05248103e+05  2.30421250e+05  4.56228778e+05
  8.45175403e+05  1.52834722e+06  2.85060790e+06  5.80848658e+06]
E1 = -706.7987434712788  E_coul = 198.80963132711605
cycle= 2 E= -507.989112144163  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0291886
diis-c [-8.47729026e-04  2.91057588e-03  9.97089424e-01]
  HOMO = -0.23966369468808  LUMO = 1.07612564413943
  mo_energy =
[-1.20314469e+02 -1.23717945e+01 -6.66861363e+00 -6.66861363e+00
 -6.66861363e+00 -1.17736159e+00 -2.39663695e-01 -2.39663695e-01
 -2.39663695e-01  1.07612564e+00  1.09791983e+01  6.45930829e+01
  2.58924379e+02  8.87951835e+02  3.14188831e+03  1.26224913e+04
  4.12197254e+04  1.05247955e+05  2.30421102e+05  4.56228628e+05
  8.45175253e+05  1.52834707e+06  2.85060775e+06  5.80848643e+06]
E1 = -706.692796136294  E_coul = 198.70342849989558
cycle= 3 E= -507.989367636398  delta_E= -0.000255  |g|= 0.00444  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322763
diis-c [-2.05526435e-06 -9.87094481e-05 -1.10174383e-01  1.11027309e+00]
  HOMO = -0.242859944405206  LUMO = 1.07503757528499
  mo_energy =
[-1.20326672e+02 -1.23805787e+01 -6.67791560e+00 -6.67791560e+00
 -6.67791560e+00 -1.17929951e+00 -2.42859944e-01 -2.42859944e-01
 -2.42859944e-01  1.07503758e+00  1.09726948e+01  6.45832150e+01
  2.58912872e+02  8.87939353e+02  3.14187506e+03  1.26224775e+04
  4.12197115e+04  1.05247941e+05  2.30421088e+05  4.56228614e+05
  8.45175239e+05  1.52834705e+06  2.85060774e+06  5.80848642e+06]
E1 = -706.6774170422038  E_coul = 198.6880444864966
cycle= 4 E= -507.989372555707  delta_E= -4.92e-06  |g|= 0.000197  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135801
diis-c [-1.25867907e-10 -6.86001353e-06  7.44081669e-03 -9.85758878e-02
  1.09114193e+00]
  HOMO = -0.242993661458512  LUMO = 1.07498491845298
  mo_energy =
[-1.20327003e+02 -1.23809023e+01 -6.67823597e+00 -6.67823597e+00
 -6.67823597e+00 -1.17937889e+00 -2.42993661e-01 -2.42993661e-01
 -2.42993661e-01  1.07498492e+00  1.09724348e+01  6.45828946e+01
  2.58912543e+02  8.87939021e+02  3.14187472e+03  1.26224772e+04
  4.12197111e+04  1.05247941e+05  2.30421087e+05  4.56228614e+05
  8.45175239e+05  1.52834705e+06  2.85060774e+06  5.80848642e+06]
E1 = -706.6767813891549  E_coul = 198.68740882432607
cycle= 5 E= -507.989372564829  delta_E= -9.12e-09  |g|= 8.56e-07  |ddm|= 0.00044
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.4163e-07
diis-c [-2.60245269e-14  1.81115538e-07 -1.18242925e-04  1.38049746e-03
 -1.62913032e-02  1.01502887e+00]
  HOMO = -0.242994190983657  LUMO = 1.0749848827163
  mo_energy =
[-1.20327005e+02 -1.23809036e+01 -6.67823738e+00 -6.67823738e+00
 -6.67823738e+00 -1.17937935e+00 -2.42994191e-01 -2.42994191e-01
 -2.42994191e-01  1.07498488e+00  1.09724337e+01  6.45828932e+01
  2.58912541e+02  8.87939019e+02  3.14187472e+03  1.26224772e+04
  4.12197111e+04  1.05247941e+05  2.30421087e+05  4.56228614e+05
  8.45175239e+05  1.52834705e+06  2.85060774e+06  5.80848642e+06]
E1 = -706.67677859413  E_coul = 198.68740602930114
cycle= 6 E= -507.989372564829  delta_E= -5.68e-14  |g|= 2.11e-08  |ddm|= 1.9e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.67677859413  E_coul = 198.68740602930114
  HOMO = -0.242994201842326  LUMO = 1.07498487627161
  mo_energy =
[-1.20327005e+02 -1.23809037e+01 -6.67823740e+00 -6.67823740e+00
 -6.67823740e+00 -1.17937936e+00 -2.42994202e-01 -2.42994202e-01
 -2.42994202e-01  1.07498488e+00  1.09724337e+01  6.45828931e+01
  2.58912541e+02  8.87939019e+02  3.14187472e+03  1.26224772e+04
  4.12197111e+04  1.05247941e+05  2.30421087e+05  4.56228614e+05
  8.45175239e+05  1.52834705e+06  2.85060774e+06  5.80848642e+06]
E1 = -706.6767785453219  E_coul = 198.68740598049257
Extra cycle  E= -507.989372564829  delta_E= -3.98e-13  |g|= 2.4e-09  |ddm|= 3.95e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.49390579e-01 6.49644097e-01 1.17616813e+05 3.03401756e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104175e+04 3.67547015e+04 7.30232047e+03 1.83757713e+04
 1.44351131e+03 4.17462455e+02 1.47825700e+02 5.84501303e+01
 2.45500201e+01 7.57690494e+00 8.60413897e+00 4.92699883e-01]
E = -507.9893725648293
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:18:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249390579144       1
[INPUT] 0    0    [1    /1   ]  0.649644096621       1
[INPUT] 0    0    [1    /1   ]  117616.812888        1
[INPUT] 0    0    [1    /1   ]  3.03401756022        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175451        1
[INPUT] 0    0    [1    /1   ]  36754.7015182        1
[INPUT] 0    0    [1    /1   ]  7302.32047466        1
[INPUT] 0    0    [1    /1   ]  18375.7713093        1
[INPUT] 0    0    [1    /1   ]  1443.5113083         1
[INPUT] 0    0    [1    /1   ]  417.462455329        1
[INPUT] 0    0    [1    /1   ]  147.825700082        1
[INPUT] 0    0    [1    /1   ]  58.450130325         1
[INPUT] 0    0    [1    /1   ]  24.5500200846        1
[INPUT] 0    0    [1    /1   ]  7.57690493854        1
[INPUT] 1    0    [1    /1   ]  8.604138974          1
[INPUT] 1    0    [1    /1   ]  0.492699882684       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24939057914406415, 1.0]], [0, [0.6496440966210861, 1.0]], [0, [117616.81288821386, 1.0]], [0, [3.034017560216232, 1.0]], [0, [1176168.1426134491, 1.0]], [0, [588084.0699565273, 1.0]], [0, [294042.03092123405, 1.0]], [0, [147020.9913225329, 1.0]], [0, [73510.41754514324, 1.0]], [0, [36754.70151820757, 1.0]], [0, [7302.320474663768, 1.0]], [0, [18375.771309271317, 1.0]], [0, [1443.5113083015835, 1.0]], [0, [417.4624553292532, 1.0]], [0, [147.82570008187116, 1.0]], [0, [58.450130325049294, 1.0]], [0, [24.550020084583927, 1.0]], [0, [7.57690493854081, 1.0]], [1, [8.604138973996582, 1.0]], [1, [0.4926998826844579, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24939058]
bas 1, expnt(s) = [0.6496441]
bas 2, expnt(s) = [117616.81288821]
bas 3, expnt(s) = [3.03401756]
bas 4, expnt(s) = [1176168.14261345]
bas 5, expnt(s) = [588084.06995653]
bas 6, expnt(s) = [294042.03092123]
bas 7, expnt(s) = [147020.99132253]
bas 8, expnt(s) = [73510.41754514]
bas 9, expnt(s) = [36754.70151821]
bas 10, expnt(s) = [7302.32047466]
bas 11, expnt(s) = [18375.77130927]
bas 12, expnt(s) = [1443.5113083]
bas 13, expnt(s) = [417.46245533]
bas 14, expnt(s) = [147.82570008]
bas 15, expnt(s) = [58.45013033]
bas 16, expnt(s) = [24.55002008]
bas 17, expnt(s) = [7.57690494]
bas 18, expnt(s) = [8.60413897]
bas 19, expnt(s) = [0.49269988]
CPU time:      1289.51
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49390579e-01 8.91610259e-01 6.49644097e-01 1.82819134e+00
 1.17616813e+05 1.60460108e+04 3.03401756e+00 5.80802653e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104175e+04 1.12791583e+04 3.67547015e+04 6.70655823e+03
 7.30232047e+03 1.99577092e+03 1.83757713e+04 3.98748633e+03
 1.44351131e+03 5.91670842e+02 4.17462455e+02 2.33334035e+02
 1.47825700e+02 1.07109374e+02 5.84501303e+01 5.34077322e+01
 2.45500201e+01 2.78646706e+01 7.57690494e+00 1.15380895e+01
 8.60413897e+00 4.29901206e+01 4.92699883e-01 1.20423838e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335949829003948
cond(S) = 912125.726466367
E1 = -689.5862988744462  E_coul = 184.96606970505596
init E= -504.62022916939
    CPU time for initialize scf      3.51 sec, wall time      0.27 sec
  HOMO = -0.67229805406731  LUMO = 0.692076738211426
  mo_energy =
[-1.21710343e+02 -1.33863693e+01 -7.62400714e+00 -7.62400714e+00
 -7.62400714e+00 -1.65741005e+00 -6.72298054e-01 -6.72298054e-01
 -6.72298054e-01  6.92076738e-01  1.01573172e+01  6.34042430e+01
  2.57571060e+02  8.86578369e+02  3.14058938e+03  1.26213091e+04
  4.12186143e+04  1.05246883e+05  2.30420055e+05  4.56227599e+05
  8.45174237e+05  1.52834606e+06  2.85060676e+06  5.80848544e+06]
E1 = -707.7384410320442  E_coul = 199.76682798422192
cycle= 1 E= -507.971613047822  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.706588
diis-c [-0.49926716  1.        ]
  HOMO = -0.217854625219259  LUMO = 1.08196000604398
  mo_energy =
[-1.20201863e+02 -1.23056064e+01 -6.59530025e+00 -6.59530025e+00
 -6.59530025e+00 -1.16332352e+00 -2.17854625e-01 -2.17854625e-01
 -2.17854625e-01  1.08196001e+00  1.10249088e+01  6.46740582e+01
  2.59027175e+02  8.88070174e+02  3.14202070e+03  1.26226337e+04
  4.12198717e+04  1.05248103e+05  2.30421250e+05  4.56228778e+05
  8.45175403e+05  1.52834722e+06  2.85060790e+06  5.80848658e+06]
E1 = -706.7987434712788  E_coul = 198.80963132711605
cycle= 2 E= -507.989112144163  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0291886
diis-c [-8.47729026e-04  2.91057588e-03  9.97089424e-01]
  HOMO = -0.23966369468808  LUMO = 1.07612564413943
  mo_energy =
[-1.20314469e+02 -1.23717945e+01 -6.66861363e+00 -6.66861363e+00
 -6.66861363e+00 -1.17736159e+00 -2.39663695e-01 -2.39663695e-01
 -2.39663695e-01  1.07612564e+00  1.09791983e+01  6.45930829e+01
  2.58924379e+02  8.87951835e+02  3.14188831e+03  1.26224913e+04
  4.12197254e+04  1.05247955e+05  2.30421102e+05  4.56228628e+05
  8.45175253e+05  1.52834707e+06  2.85060775e+06  5.80848643e+06]
E1 = -706.692796136294  E_coul = 198.70342849989558
cycle= 3 E= -507.989367636398  delta_E= -0.000255  |g|= 0.00444  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322763
diis-c [-2.05526435e-06 -9.87094481e-05 -1.10174383e-01  1.11027309e+00]
  HOMO = -0.242859944405206  LUMO = 1.07503757528499
  mo_energy =
[-1.20326672e+02 -1.23805787e+01 -6.67791560e+00 -6.67791560e+00
 -6.67791560e+00 -1.17929951e+00 -2.42859944e-01 -2.42859944e-01
 -2.42859944e-01  1.07503758e+00  1.09726948e+01  6.45832150e+01
  2.58912872e+02  8.87939353e+02  3.14187506e+03  1.26224775e+04
  4.12197115e+04  1.05247941e+05  2.30421088e+05  4.56228614e+05
  8.45175239e+05  1.52834705e+06  2.85060774e+06  5.80848642e+06]
E1 = -706.6774170422038  E_coul = 198.6880444864966
cycle= 4 E= -507.989372555707  delta_E= -4.92e-06  |g|= 0.000197  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135801
diis-c [-1.25867907e-10 -6.86001353e-06  7.44081669e-03 -9.85758878e-02
  1.09114193e+00]
  HOMO = -0.242993661458512  LUMO = 1.07498491845298
  mo_energy =
[-1.20327003e+02 -1.23809023e+01 -6.67823597e+00 -6.67823597e+00
 -6.67823597e+00 -1.17937889e+00 -2.42993661e-01 -2.42993661e-01
 -2.42993661e-01  1.07498492e+00  1.09724348e+01  6.45828946e+01
  2.58912543e+02  8.87939021e+02  3.14187472e+03  1.26224772e+04
  4.12197111e+04  1.05247941e+05  2.30421087e+05  4.56228614e+05
  8.45175239e+05  1.52834705e+06  2.85060774e+06  5.80848642e+06]
E1 = -706.6767813891549  E_coul = 198.68740882432607
cycle= 5 E= -507.989372564829  delta_E= -9.12e-09  |g|= 8.56e-07  |ddm|= 0.00044
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.4163e-07
diis-c [-2.60245269e-14  1.81115538e-07 -1.18242925e-04  1.38049746e-03
 -1.62913032e-02  1.01502887e+00]
  HOMO = -0.242994190983657  LUMO = 1.0749848827163
  mo_energy =
[-1.20327005e+02 -1.23809036e+01 -6.67823738e+00 -6.67823738e+00
 -6.67823738e+00 -1.17937935e+00 -2.42994191e-01 -2.42994191e-01
 -2.42994191e-01  1.07498488e+00  1.09724337e+01  6.45828932e+01
  2.58912541e+02  8.87939019e+02  3.14187472e+03  1.26224772e+04
  4.12197111e+04  1.05247941e+05  2.30421087e+05  4.56228614e+05
  8.45175239e+05  1.52834705e+06  2.85060774e+06  5.80848642e+06]
E1 = -706.67677859413  E_coul = 198.68740602930114
cycle= 6 E= -507.989372564829  delta_E= -5.68e-14  |g|= 2.11e-08  |ddm|= 1.9e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.67677859413  E_coul = 198.68740602930114
  HOMO = -0.242994201842326  LUMO = 1.07498487627161
  mo_energy =
[-1.20327005e+02 -1.23809037e+01 -6.67823740e+00 -6.67823740e+00
 -6.67823740e+00 -1.17937936e+00 -2.42994202e-01 -2.42994202e-01
 -2.42994202e-01  1.07498488e+00  1.09724337e+01  6.45828931e+01
  2.58912541e+02  8.87939019e+02  3.14187472e+03  1.26224772e+04
  4.12197111e+04  1.05247941e+05  2.30421087e+05  4.56228614e+05
  8.45175239e+05  1.52834705e+06  2.85060774e+06  5.80848642e+06]
E1 = -706.6767785453219  E_coul = 198.68740598049257
Extra cycle  E= -507.989372564829  delta_E= -3.98e-13  |g|= 2.4e-09  |ddm|= 3.95e-08
    CPU time for scf_cycle      4.20 sec, wall time      0.49 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912125.726466367
E1 = -706.6767785453219  E_coul = 198.68740598049257
init E= -507.989372564829
    CPU time for initialize scf      3.41 sec, wall time      0.22 sec
  HOMO = -0.242994203334659  LUMO = 1.07498487433484
  mo_energy =
[-1.20327005e+02 -1.23809037e+01 -6.67823740e+00 -6.67823740e+00
 -6.67823740e+00 -1.17937936e+00 -2.42994203e-01 -2.42994203e-01
 -2.42994203e-01  1.07498487e+00  1.09724337e+01  6.45828931e+01
  2.58912541e+02  8.87939019e+02  3.14187472e+03  1.26224772e+04
  4.12197111e+04  1.05247941e+05  2.30421087e+05  4.56228614e+05
  8.45175239e+05  1.52834705e+06  2.85060774e+06  5.80848642e+06]
E1 = -706.6767785398218  E_coul = 198.68740597499237
cycle= 1 E= -507.989372564829  delta_E= -1.71e-13  |g|= 6.68e-10  |ddm|= 3.94e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6767785398218  E_coul = 198.68740597499237
  HOMO = -0.242994203494261  LUMO = 1.07498487522616
  mo_energy =
[-1.20327005e+02 -1.23809037e+01 -6.67823740e+00 -6.67823740e+00
 -6.67823740e+00 -1.17937936e+00 -2.42994203e-01 -2.42994203e-01
 -2.42994203e-01  1.07498488e+00  1.09724337e+01  6.45828931e+01
  2.58912541e+02  8.87939019e+02  3.14187472e+03  1.26224772e+04
  4.12197111e+04  1.05247941e+05  2.30421087e+05  4.56228614e+05
  8.45175239e+05  1.52834705e+06  2.85060774e+06  5.80848642e+06]
E1 = -706.6767785387931  E_coul = 198.6874059739642
Extra cycle  E= -507.989372564829  delta_E= 5.68e-13  |g|= 1.8e-09  |ddm|= 7.78e-10
    CPU time for scf_cycle      3.86 sec, wall time      0.38 sec
exp = [2.49390579e-01 6.49644097e-01 1.17616813e+05 3.03401756e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104175e+04 3.67547015e+04 7.30232047e+03 1.83757713e+04
 1.44351131e+03 4.17462455e+02 1.47825700e+02 5.84501303e+01
 2.45500201e+01 7.57690494e+00 8.60413897e+00 4.92699883e-01]
grad_E = [-3.43658066e-07 -3.97897651e-07  6.07377184e-09  3.12544838e-06
  4.05687017e-11  1.74532465e-10  9.42067371e-10  3.72227501e-09
  1.55439728e-08  8.10664504e-08  5.10949066e-06  1.98846469e-07
 -3.87205503e-05 -4.74777079e-06 -1.75966129e-07 -5.30008723e-07
  1.89353846e-07 -1.26995264e-06  7.49390994e-06 -1.79972619e-06]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:18:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249388967519       1
[INPUT] 0    0    [1    /1   ]  0.649646200656       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.03393739627        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175469        1
[INPUT] 0    0    [1    /1   ]  36754.7015275        1
[INPUT] 0    0    [1    /1   ]  7302.32105174        1
[INPUT] 0    0    [1    /1   ]  18375.7713285        1
[INPUT] 0    0    [1    /1   ]  1443.51575152        1
[INPUT] 0    0    [1    /1   ]  417.43013528         1
[INPUT] 0    0    [1    /1   ]  147.803341223        1
[INPUT] 0    0    [1    /1   ]  58.4441461642        1
[INPUT] 0    0    [1    /1   ]  24.5491250742        1
[INPUT] 0    0    [1    /1   ]  7.57665994451        1
[INPUT] 1    0    [1    /1   ]  8.60412725458        1
[INPUT] 1    0    [1    /1   ]  0.492699641609       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2493889675194479, 1.0]], [0, [0.6496462006562439, 1.0]], [0, [117616.81288889167, 1.0]], [0, [3.033937396270761, 1.0]], [0, [1176168.1426134517, 1.0]], [0, [588084.0699565453, 1.0]], [0, [294042.0309213396, 1.0]], [0, [147020.99132294592, 1.0]], [0, [73510.41754685658, 1.0]], [0, [36754.70152750495, 1.0]], [0, [7302.321051743535, 1.0]], [0, [18375.77132847611, 1.0]], [0, [1443.5157515197295, 1.0]], [0, [417.43013528008186, 1.0]], [0, [147.8033412225626, 1.0]], [0, [58.444146164181305, 1.0]], [0, [24.54912507418907, 1.0]], [0, [7.576659944512116, 1.0]], [1, [8.604127254576879, 1.0]], [1, [0.4926996416089985, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24938897]
bas 1, expnt(s) = [0.6496462]
bas 2, expnt(s) = [117616.81288889]
bas 3, expnt(s) = [3.0339374]
bas 4, expnt(s) = [1176168.14261345]
bas 5, expnt(s) = [588084.06995655]
bas 6, expnt(s) = [294042.03092134]
bas 7, expnt(s) = [147020.99132295]
bas 8, expnt(s) = [73510.41754686]
bas 9, expnt(s) = [36754.7015275]
bas 10, expnt(s) = [7302.32105174]
bas 11, expnt(s) = [18375.77132848]
bas 12, expnt(s) = [1443.51575152]
bas 13, expnt(s) = [417.43013528]
bas 14, expnt(s) = [147.80334122]
bas 15, expnt(s) = [58.44414616]
bas 16, expnt(s) = [24.54912507]
bas 17, expnt(s) = [7.57665994]
bas 18, expnt(s) = [8.60412725]
bas 19, expnt(s) = [0.49269964]
CPU time:      1304.74
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49388968e-01 8.91605938e-01 6.49646201e-01 1.82819578e+00
 1.17616813e+05 1.60460108e+04 3.03393740e+00 5.80791144e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104175e+04 1.12791583e+04 3.67547015e+04 6.70655823e+03
 7.30232105e+03 1.99577104e+03 1.83757713e+04 3.98748633e+03
 1.44351575e+03 5.91672207e+02 4.17430135e+02 2.33320486e+02
 1.47803341e+02 1.07097224e+02 5.84441462e+01 5.34036312e+01
 2.45491251e+01 2.78639087e+01 7.57665994e+00 1.15378097e+01
 8.60412725e+00 4.29900474e+01 4.92699642e-01 1.20423765e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335950234724166
cond(S) = 912123.7108096604
E1 = -689.5862392117173  E_coul = 184.96601103513564
init E= -504.620228176582
    CPU time for initialize scf      0.44 sec, wall time      0.07 sec
  HOMO = -0.672298165289494  LUMO = 0.692070964109193
  mo_energy =
[-1.21710354e+02 -1.33863740e+01 -7.62401120e+00 -7.62401120e+00
 -7.62401120e+00 -1.65741045e+00 -6.72298165e-01 -6.72298165e-01
 -6.72298165e-01  6.92070964e-01  1.01568674e+01  6.33997758e+01
  2.57542319e+02  8.86475320e+02  3.14040065e+03  1.26211048e+04
  4.12184202e+04  1.05246696e+05  2.30419873e+05  4.56227421e+05
  8.45174063e+05  1.52834589e+06  2.85060659e+06  5.80848528e+06]
E1 = -707.7383713819603  E_coul = 199.76675834934824
cycle= 1 E= -507.971613032612  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.44 sec, wall time      0.03 sec
diis-norm(errvec)=0.70659
diis-c [-0.49926956  1.        ]
  HOMO = -0.217855194417886  LUMO = 1.0819523327504
  mo_energy =
[-1.20201875e+02 -1.23056118e+01 -6.59530511e+00 -6.59530511e+00
 -6.59530511e+00 -1.16332420e+00 -2.17855194e-01 -2.17855194e-01
 -2.17855194e-01  1.08195233e+00  1.10244428e+01  6.46695712e+01
  2.58998422e+02  8.87967125e+02  3.14183198e+03  1.26224295e+04
  4.12196776e+04  1.05247916e+05  2.30421069e+05  4.56228600e+05
  8.45175228e+05  1.52834704e+06  2.85060773e+06  5.80848642e+06]
E1 = -706.7986724559712  E_coul = 198.80956030588115
cycle= 2 E= -507.98911215009  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0291888
diis-c [-8.47739303e-04  2.91042812e-03  9.97089572e-01]
  HOMO = -0.239664275187426  LUMO = 1.07611805354181
  mo_energy =
[-1.20314482e+02 -1.23718000e+01 -6.66861862e+00 -6.66861862e+00
 -6.66861862e+00 -1.17736229e+00 -2.39664275e-01 -2.39664275e-01
 -2.39664275e-01  1.07611805e+00  1.09787333e+01  6.45885975e+01
  2.58895628e+02  8.87848787e+02  3.14169959e+03  1.26222870e+04
  4.12195313e+04  1.05247769e+05  2.30420920e+05  4.56228451e+05
  8.45175079e+05  1.52834689e+06  2.85060758e+06  5.80848627e+06]
E1 = -706.6927250485521  E_coul = 198.70335740628676
cycle= 3 E= -507.989367642265  delta_E= -0.000255  |g|= 0.00444  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322766
diis-c [-2.05529702e-06 -9.86971060e-05 -1.10174673e-01  1.11027337e+00]
  HOMO = -0.242860523917709  LUMO = 1.07502999992836
  mo_energy =
[-1.20326685e+02 -1.23805842e+01 -6.67792059e+00 -6.67792059e+00
 -6.67792059e+00 -1.17930020e+00 -2.42860524e-01 -2.42860524e-01
 -2.42860524e-01  1.07503000e+00  1.09722299e+01  6.45787297e+01
  2.58884121e+02  8.87836305e+02  3.14168634e+03  1.26222732e+04
  4.12195174e+04  1.05247755e+05  2.30420906e+05  4.56228437e+05
  8.45175065e+05  1.52834688e+06  2.85060757e+06  5.80848625e+06]
E1 = -706.6773459599915  E_coul = 198.6879733984184
cycle= 4 E= -507.989372561573  delta_E= -4.92e-06  |g|= 0.000197  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135801
diis-c [-1.25938694e-10 -6.84981780e-06  7.44056028e-03 -9.85737482e-02
  1.09114004e+00]
  HOMO = -0.242994240263496  LUMO = 1.07497734062002
  mo_energy =
[-1.20327016e+02 -1.23809078e+01 -6.67824095e+00 -6.67824095e+00
 -6.67824095e+00 -1.17937959e+00 -2.42994240e-01 -2.42994240e-01
 -2.42994240e-01  1.07497734e+00  1.09719699e+01  6.45784094e+01
  2.58883791e+02  8.87835973e+02  3.14168600e+03  1.26222729e+04
  4.12195171e+04  1.05247754e+05  2.30420906e+05  4.56228436e+05
  8.45175064e+05  1.52834688e+06  2.85060757e+06  5.80848625e+06]
E1 = -706.6767103136388  E_coul = 198.68733774294347
cycle= 5 E= -507.989372570695  delta_E= -9.12e-09  |g|= 8.56e-07  |ddm|= 0.00044
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.40925e-07
diis-c [-2.61123042e-14  1.77951371e-07 -1.17622587e-04  1.37287895e-03
 -1.62161012e-02  1.01496067e+00]
  HOMO = -0.24299477002518  LUMO = 1.0749773034969
  mo_energy =
[-1.20327018e+02 -1.23809091e+01 -6.67824236e+00 -6.67824236e+00
 -6.67824236e+00 -1.17938005e+00 -2.42994770e-01 -2.42994770e-01
 -2.42994770e-01  1.07497730e+00  1.09719689e+01  6.45784079e+01
  2.58883789e+02  8.87835971e+02  3.14168600e+03  1.26222729e+04
  4.12195170e+04  1.05247754e+05  2.30420906e+05  4.56228436e+05
  8.45175064e+05  1.52834688e+06  2.85060757e+06  5.80848625e+06]
E1 = -706.6767075180409  E_coul = 198.68733494734582
cycle= 6 E= -507.989372570695  delta_E= 2.27e-13  |g|= 2.15e-08  |ddm|= 1.9e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6767075180409  E_coul = 198.68733494734582
  HOMO = -0.242994780841562  LUMO = 1.07497729821287
  mo_energy =
[-1.20327018e+02 -1.23809091e+01 -6.67824238e+00 -6.67824238e+00
 -6.67824238e+00 -1.17938005e+00 -2.42994781e-01 -2.42994781e-01
 -2.42994781e-01  1.07497730e+00  1.09719689e+01  6.45784078e+01
  2.58883789e+02  8.87835971e+02  3.14168600e+03  1.26222729e+04
  4.12195170e+04  1.05247754e+05  2.30420906e+05  4.56228436e+05
  8.45175064e+05  1.52834688e+06  2.85060757e+06  5.80848625e+06]
E1 = -706.6767074688828  E_coul = 198.68733489818794
Extra cycle  E= -507.989372570695  delta_E= 2.27e-13  |g|= 2.4e-09  |ddm|= 3.98e-08
    CPU time for scf_cycle      1.11 sec, wall time      0.29 sec
exp = [2.49388968e-01 6.49646201e-01 1.17616813e+05 3.03393740e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104175e+04 3.67547015e+04 7.30232105e+03 1.83757713e+04
 1.44351575e+03 4.17430135e+02 1.47803341e+02 5.84441462e+01
 2.45491251e+01 7.57665994e+00 8.60412725e+00 4.92699642e-01]
E = -507.98937257069485
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:18:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249388967519       1
[INPUT] 0    0    [1    /1   ]  0.649646200656       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.03393739627        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175469        1
[INPUT] 0    0    [1    /1   ]  36754.7015275        1
[INPUT] 0    0    [1    /1   ]  7302.32105174        1
[INPUT] 0    0    [1    /1   ]  18375.7713285        1
[INPUT] 0    0    [1    /1   ]  1443.51575152        1
[INPUT] 0    0    [1    /1   ]  417.43013528         1
[INPUT] 0    0    [1    /1   ]  147.803341223        1
[INPUT] 0    0    [1    /1   ]  58.4441461642        1
[INPUT] 0    0    [1    /1   ]  24.5491250742        1
[INPUT] 0    0    [1    /1   ]  7.57665994451        1
[INPUT] 1    0    [1    /1   ]  8.60412725458        1
[INPUT] 1    0    [1    /1   ]  0.492699641609       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2493889675194479, 1.0]], [0, [0.6496462006562439, 1.0]], [0, [117616.81288889167, 1.0]], [0, [3.033937396270761, 1.0]], [0, [1176168.1426134517, 1.0]], [0, [588084.0699565453, 1.0]], [0, [294042.0309213396, 1.0]], [0, [147020.99132294592, 1.0]], [0, [73510.41754685658, 1.0]], [0, [36754.70152750495, 1.0]], [0, [7302.321051743535, 1.0]], [0, [18375.77132847611, 1.0]], [0, [1443.5157515197295, 1.0]], [0, [417.43013528008186, 1.0]], [0, [147.8033412225626, 1.0]], [0, [58.444146164181305, 1.0]], [0, [24.54912507418907, 1.0]], [0, [7.576659944512116, 1.0]], [1, [8.604127254576879, 1.0]], [1, [0.4926996416089985, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24938897]
bas 1, expnt(s) = [0.6496462]
bas 2, expnt(s) = [117616.81288889]
bas 3, expnt(s) = [3.0339374]
bas 4, expnt(s) = [1176168.14261345]
bas 5, expnt(s) = [588084.06995655]
bas 6, expnt(s) = [294042.03092134]
bas 7, expnt(s) = [147020.99132295]
bas 8, expnt(s) = [73510.41754686]
bas 9, expnt(s) = [36754.7015275]
bas 10, expnt(s) = [7302.32105174]
bas 11, expnt(s) = [18375.77132848]
bas 12, expnt(s) = [1443.51575152]
bas 13, expnt(s) = [417.43013528]
bas 14, expnt(s) = [147.80334122]
bas 15, expnt(s) = [58.44414616]
bas 16, expnt(s) = [24.54912507]
bas 17, expnt(s) = [7.57665994]
bas 18, expnt(s) = [8.60412725]
bas 19, expnt(s) = [0.49269964]
CPU time:      1306.47
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49388968e-01 8.91605938e-01 6.49646201e-01 1.82819578e+00
 1.17616813e+05 1.60460108e+04 3.03393740e+00 5.80791144e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104175e+04 1.12791583e+04 3.67547015e+04 6.70655823e+03
 7.30232105e+03 1.99577104e+03 1.83757713e+04 3.98748633e+03
 1.44351575e+03 5.91672207e+02 4.17430135e+02 2.33320486e+02
 1.47803341e+02 1.07097224e+02 5.84441462e+01 5.34036312e+01
 2.45491251e+01 2.78639087e+01 7.57665994e+00 1.15378097e+01
 8.60412725e+00 4.29900474e+01 4.92699642e-01 1.20423765e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335950234724166
cond(S) = 912123.7108096604
E1 = -689.5862392117173  E_coul = 184.96601103513564
init E= -504.620228176582
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672298165289494  LUMO = 0.692070964109193
  mo_energy =
[-1.21710354e+02 -1.33863740e+01 -7.62401120e+00 -7.62401120e+00
 -7.62401120e+00 -1.65741045e+00 -6.72298165e-01 -6.72298165e-01
 -6.72298165e-01  6.92070964e-01  1.01568674e+01  6.33997758e+01
  2.57542319e+02  8.86475320e+02  3.14040065e+03  1.26211048e+04
  4.12184202e+04  1.05246696e+05  2.30419873e+05  4.56227421e+05
  8.45174063e+05  1.52834589e+06  2.85060659e+06  5.80848528e+06]
E1 = -707.7383713819603  E_coul = 199.76675834934824
cycle= 1 E= -507.971613032612  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.70659
diis-c [-0.49926956  1.        ]
  HOMO = -0.217855194417886  LUMO = 1.0819523327504
  mo_energy =
[-1.20201875e+02 -1.23056118e+01 -6.59530511e+00 -6.59530511e+00
 -6.59530511e+00 -1.16332420e+00 -2.17855194e-01 -2.17855194e-01
 -2.17855194e-01  1.08195233e+00  1.10244428e+01  6.46695712e+01
  2.58998422e+02  8.87967125e+02  3.14183198e+03  1.26224295e+04
  4.12196776e+04  1.05247916e+05  2.30421069e+05  4.56228600e+05
  8.45175228e+05  1.52834704e+06  2.85060773e+06  5.80848642e+06]
E1 = -706.7986724559712  E_coul = 198.80956030588115
cycle= 2 E= -507.98911215009  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0291888
diis-c [-8.47739303e-04  2.91042812e-03  9.97089572e-01]
  HOMO = -0.239664275187426  LUMO = 1.07611805354181
  mo_energy =
[-1.20314482e+02 -1.23718000e+01 -6.66861862e+00 -6.66861862e+00
 -6.66861862e+00 -1.17736229e+00 -2.39664275e-01 -2.39664275e-01
 -2.39664275e-01  1.07611805e+00  1.09787333e+01  6.45885975e+01
  2.58895628e+02  8.87848787e+02  3.14169959e+03  1.26222870e+04
  4.12195313e+04  1.05247769e+05  2.30420920e+05  4.56228451e+05
  8.45175079e+05  1.52834689e+06  2.85060758e+06  5.80848627e+06]
E1 = -706.6927250485521  E_coul = 198.70335740628676
cycle= 3 E= -507.989367642265  delta_E= -0.000255  |g|= 0.00444  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322766
diis-c [-2.05529702e-06 -9.86971060e-05 -1.10174673e-01  1.11027337e+00]
  HOMO = -0.242860523917709  LUMO = 1.07502999992836
  mo_energy =
[-1.20326685e+02 -1.23805842e+01 -6.67792059e+00 -6.67792059e+00
 -6.67792059e+00 -1.17930020e+00 -2.42860524e-01 -2.42860524e-01
 -2.42860524e-01  1.07503000e+00  1.09722299e+01  6.45787297e+01
  2.58884121e+02  8.87836305e+02  3.14168634e+03  1.26222732e+04
  4.12195174e+04  1.05247755e+05  2.30420906e+05  4.56228437e+05
  8.45175065e+05  1.52834688e+06  2.85060757e+06  5.80848625e+06]
E1 = -706.6773459599915  E_coul = 198.6879733984184
cycle= 4 E= -507.989372561573  delta_E= -4.92e-06  |g|= 0.000197  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135801
diis-c [-1.25938694e-10 -6.84981780e-06  7.44056028e-03 -9.85737482e-02
  1.09114004e+00]
  HOMO = -0.242994240263496  LUMO = 1.07497734062002
  mo_energy =
[-1.20327016e+02 -1.23809078e+01 -6.67824095e+00 -6.67824095e+00
 -6.67824095e+00 -1.17937959e+00 -2.42994240e-01 -2.42994240e-01
 -2.42994240e-01  1.07497734e+00  1.09719699e+01  6.45784094e+01
  2.58883791e+02  8.87835973e+02  3.14168600e+03  1.26222729e+04
  4.12195171e+04  1.05247754e+05  2.30420906e+05  4.56228436e+05
  8.45175064e+05  1.52834688e+06  2.85060757e+06  5.80848625e+06]
E1 = -706.6767103136388  E_coul = 198.68733774294347
cycle= 5 E= -507.989372570695  delta_E= -9.12e-09  |g|= 8.56e-07  |ddm|= 0.00044
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.40925e-07
diis-c [-2.61123042e-14  1.77951371e-07 -1.17622587e-04  1.37287895e-03
 -1.62161012e-02  1.01496067e+00]
  HOMO = -0.24299477002518  LUMO = 1.0749773034969
  mo_energy =
[-1.20327018e+02 -1.23809091e+01 -6.67824236e+00 -6.67824236e+00
 -6.67824236e+00 -1.17938005e+00 -2.42994770e-01 -2.42994770e-01
 -2.42994770e-01  1.07497730e+00  1.09719689e+01  6.45784079e+01
  2.58883789e+02  8.87835971e+02  3.14168600e+03  1.26222729e+04
  4.12195170e+04  1.05247754e+05  2.30420906e+05  4.56228436e+05
  8.45175064e+05  1.52834688e+06  2.85060757e+06  5.80848625e+06]
E1 = -706.6767075180409  E_coul = 198.68733494734582
cycle= 6 E= -507.989372570695  delta_E= 2.27e-13  |g|= 2.15e-08  |ddm|= 1.9e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6767075180409  E_coul = 198.68733494734582
  HOMO = -0.242994780841562  LUMO = 1.07497729821287
  mo_energy =
[-1.20327018e+02 -1.23809091e+01 -6.67824238e+00 -6.67824238e+00
 -6.67824238e+00 -1.17938005e+00 -2.42994781e-01 -2.42994781e-01
 -2.42994781e-01  1.07497730e+00  1.09719689e+01  6.45784078e+01
  2.58883789e+02  8.87835971e+02  3.14168600e+03  1.26222729e+04
  4.12195170e+04  1.05247754e+05  2.30420906e+05  4.56228436e+05
  8.45175064e+05  1.52834688e+06  2.85060757e+06  5.80848625e+06]
E1 = -706.6767074688828  E_coul = 198.68733489818794
Extra cycle  E= -507.989372570695  delta_E= 2.27e-13  |g|= 2.4e-09  |ddm|= 3.98e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912123.7108096604
E1 = -706.6767074688828  E_coul = 198.68733489818794
init E= -507.989372570695
    CPU time for initialize scf      3.52 sec, wall time      0.22 sec
  HOMO = -0.242994782349667  LUMO = 1.07497729697079
  mo_energy =
[-1.20327018e+02 -1.23809092e+01 -6.67824239e+00 -6.67824239e+00
 -6.67824239e+00 -1.17938005e+00 -2.42994782e-01 -2.42994782e-01
 -2.42994782e-01  1.07497730e+00  1.09719689e+01  6.45784078e+01
  2.58883789e+02  8.87835971e+02  3.14168600e+03  1.26222729e+04
  4.12195170e+04  1.05247754e+05  2.30420906e+05  4.56228436e+05
  8.45175064e+05  1.52834688e+06  2.85060757e+06  5.80848625e+06]
E1 = -706.6767074629313  E_coul = 198.6873348922364
cycle= 1 E= -507.989372570695  delta_E=    0  |g|= 1.14e-09  |ddm|= 4.29e-09
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.6767074629313  E_coul = 198.6873348922364
  HOMO = -0.242994782526084  LUMO = 1.0749772962676
  mo_energy =
[-1.20327018e+02 -1.23809092e+01 -6.67824239e+00 -6.67824239e+00
 -6.67824239e+00 -1.17938005e+00 -2.42994783e-01 -2.42994783e-01
 -2.42994783e-01  1.07497730e+00  1.09719689e+01  6.45784078e+01
  2.58883789e+02  8.87835971e+02  3.14168600e+03  1.26222729e+04
  4.12195170e+04  1.05247754e+05  2.30420906e+05  4.56228436e+05
  8.45175064e+05  1.52834688e+06  2.85060757e+06  5.80848625e+06]
E1 = -706.6767074625621  E_coul = 198.6873348918672
Extra cycle  E= -507.989372570695  delta_E= -1.14e-13  |g|= 1.05e-09  |ddm|= 2.28e-10
    CPU time for scf_cycle      3.97 sec, wall time      0.40 sec
exp = [2.49388968e-01 6.49646201e-01 1.17616813e+05 3.03393740e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104175e+04 3.67547015e+04 7.30232105e+03 1.83757713e+04
 1.44351575e+03 4.17430135e+02 1.47803341e+02 5.84441462e+01
 2.45491251e+01 7.57665994e+00 8.60412725e+00 4.92699642e-01]
grad_E = [-2.92583569e-06  5.99517470e-07  6.07274343e-09  2.32351252e-06
  4.05571465e-11  1.74498730e-10  9.41909609e-10  3.72163799e-09
  1.55412786e-08  8.10534793e-08  5.10872049e-06  1.98803970e-07
 -3.87062359e-05 -4.68169561e-06 -7.37124273e-07  3.52185355e-07
 -2.15172338e-07 -1.24930912e-06 -2.13080015e-06  5.71214798e-07]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:18:58 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249389409702       1
[INPUT] 0    0    [1    /1   ]  0.649648754389       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.03393338549        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175477        1
[INPUT] 0    0    [1    /1   ]  36754.7015319        1
[INPUT] 0    0    [1    /1   ]  7302.32132565        1
[INPUT] 0    0    [1    /1   ]  18375.7713375        1
[INPUT] 0    0    [1    /1   ]  1443.51824681        1
[INPUT] 0    0    [1    /1   ]  417.41203693         1
[INPUT] 0    0    [1    /1   ]  147.795375401        1
[INPUT] 0    0    [1    /1   ]  58.4442439042        1
[INPUT] 0    0    [1    /1   ]  24.5502684094        1
[INPUT] 0    0    [1    /1   ]  7.57669357764        1
[INPUT] 1    0    [1    /1   ]  8.6041210752         1
[INPUT] 1    0    [1    /1   ]  0.492699514057       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2493894097015015, 1.0]], [0, [0.6496487543888143, 1.0]], [0, [117616.81288921359, 1.0]], [0, [3.033933385486887, 1.0]], [0, [1176168.1426134529, 1.0]], [0, [588084.0699565538, 1.0]], [0, [294042.0309213897, 1.0]], [0, [147020.991323142, 1.0]], [0, [73510.41754766963, 1.0]], [0, [36754.70153192849, 1.0]], [0, [7302.321325654627, 1.0]], [0, [18375.771337502367, 1.0]], [0, [1443.51824681232, 1.0]], [0, [417.4120369300692, 1.0]], [0, [147.79537540097314, 1.0]], [0, [58.444243904223605, 1.0]], [0, [24.550268409385183, 1.0]], [0, [7.576693577641461, 1.0]], [1, [8.604121075199588, 1.0]], [1, [0.49269951405748186, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24938941]
bas 1, expnt(s) = [0.64964875]
bas 2, expnt(s) = [117616.81288921]
bas 3, expnt(s) = [3.03393339]
bas 4, expnt(s) = [1176168.14261345]
bas 5, expnt(s) = [588084.06995655]
bas 6, expnt(s) = [294042.03092139]
bas 7, expnt(s) = [147020.99132314]
bas 8, expnt(s) = [73510.41754767]
bas 9, expnt(s) = [36754.70153193]
bas 10, expnt(s) = [7302.32132565]
bas 11, expnt(s) = [18375.7713375]
bas 12, expnt(s) = [1443.51824681]
bas 13, expnt(s) = [417.41203693]
bas 14, expnt(s) = [147.7953754]
bas 15, expnt(s) = [58.4442439]
bas 16, expnt(s) = [24.55026841]
bas 17, expnt(s) = [7.57669358]
bas 18, expnt(s) = [8.60412108]
bas 19, expnt(s) = [0.49269951]
CPU time:      1318.78
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49389410e-01 8.91607124e-01 6.49648754e-01 1.82820117e+00
 1.17616813e+05 1.60460108e+04 3.03393339e+00 5.80790568e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104175e+04 1.12791583e+04 3.67547015e+04 6.70655823e+03
 7.30232133e+03 1.99577110e+03 1.83757713e+04 3.98748633e+03
 1.44351825e+03 5.91672974e+02 4.17412037e+02 2.33312899e+02
 1.47795375e+02 1.07092895e+02 5.84442439e+01 5.34036982e+01
 2.45502684e+01 2.78648820e+01 7.57669358e+00 1.15378481e+01
 8.60412108e+00 4.29900088e+01 4.92699514e-01 1.20423726e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335950426212
cond(S) = 912122.9824645998
E1 = -689.5862127380301  E_coul = 184.96597998049157
init E= -504.620232757539
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672298233170167  LUMO = 0.692074628058016
  mo_energy =
[-1.21710360e+02 -1.33863764e+01 -7.62401335e+00 -7.62401335e+00
 -7.62401335e+00 -1.65741065e+00 -6.72298233e-01 -6.72298233e-01
 -6.72298233e-01  6.92074628e-01  1.01569349e+01  6.34012392e+01
  2.57541691e+02  8.86447459e+02  3.14033078e+03  1.26210244e+04
  4.12183434e+04  1.05246622e+05  2.30419801e+05  4.56227351e+05
  8.45173993e+05  1.52834582e+06  2.85060652e+06  5.80848521e+06]
E1 = -707.7383336772659  E_coul = 199.76672062409705
cycle= 1 E= -507.971613053169  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.706592
diis-c [-0.49927268  1.        ]
  HOMO = -0.217855490694832  LUMO = 1.08195659432579
  mo_energy =
[-1.20201882e+02 -1.23056146e+01 -6.59530778e+00 -6.59530778e+00
 -6.59530778e+00 -1.16332453e+00 -2.17855491e-01 -2.17855491e-01
 -2.17855491e-01  1.08195659e+00  1.10245129e+01  6.46710393e+01
  2.58997792e+02  8.87939263e+02  3.14176210e+03  1.26223490e+04
  4.12196008e+04  1.05247843e+05  2.30420997e+05  4.56228530e+05
  8.45175159e+05  1.52834698e+06  2.85060767e+06  5.80848635e+06]
E1 = -706.7986353243247  E_coul = 198.8095231697041
cycle= 2 E= -507.989112154621  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0291887
diis-c [-8.47732440e-04  2.91092600e-03  9.97089074e-01]
  HOMO = -0.239664536183033  LUMO = 1.07612229108401
  mo_energy =
[-1.20314488e+02 -1.23718028e+01 -6.66862122e+00 -6.66862122e+00
 -6.66862122e+00 -1.17736260e+00 -2.39664536e-01 -2.39664536e-01
 -2.39664536e-01  1.07612229e+00  1.09788033e+01  6.45900653e+01
  2.58894998e+02  8.87820925e+02  3.14162971e+03  1.26222066e+04
  4.12194545e+04  1.05247695e+05  2.30420849e+05  4.56228380e+05
  8.45175009e+05  1.52834683e+06  2.85060752e+06  5.80848620e+06]
E1 = -706.6926881333233  E_coul = 198.70332048724512
cycle= 3 E= -507.989367646078  delta_E= -0.000255  |g|= 0.00444  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322766
diis-c [-2.05526289e-06 -9.87219115e-05 -1.10175467e-01  1.11027419e+00]
  HOMO = -0.24286079035791  LUMO = 1.07503422941195
  mo_energy =
[-1.20326691e+02 -1.23805870e+01 -6.67792322e+00 -6.67792322e+00
 -6.67792322e+00 -1.17930052e+00 -2.42860790e-01 -2.42860790e-01
 -2.42860790e-01  1.07503423e+00  1.09722998e+01  6.45801974e+01
  2.58883491e+02  8.87808444e+02  3.14161646e+03  1.26221928e+04
  4.12194405e+04  1.05247681e+05  2.30420835e+05  4.56228366e+05
  8.45174995e+05  1.52834681e+06  2.85060750e+06  5.80848619e+06]
E1 = -706.6773090244473  E_coul = 198.68793645905507
cycle= 4 E= -507.989372565392  delta_E= -4.92e-06  |g|= 0.000197  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0001358
diis-c [-1.25864619e-10 -6.86264746e-06  7.44095480e-03 -9.85756040e-02
  1.09114151e+00]
  HOMO = -0.242994504773847  LUMO = 1.07498156968887
  mo_energy =
[-1.20327023e+02 -1.23809106e+01 -6.67824357e+00 -6.67824357e+00
 -6.67824357e+00 -1.17937991e+00 -2.42994505e-01 -2.42994505e-01
 -2.42994505e-01  1.07498157e+00  1.09720398e+01  6.45798771e+01
  2.58883162e+02  8.87808112e+02  3.14161612e+03  1.26221925e+04
  4.12194402e+04  1.05247680e+05  2.30420834e+05  4.56228366e+05
  8.45174995e+05  1.52834681e+06  2.85060750e+06  5.80848619e+06]
E1 = -706.6766733885717  E_coul = 198.6873008140577
cycle= 5 E= -507.989372574514  delta_E= -9.12e-09  |g|= 8.57e-07  |ddm|= 0.00044
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.42317e-07
diis-c [-2.63582889e-14  1.78816983e-07 -1.17361984e-04  1.36862298e-03
 -1.61661137e-02  1.01491467e+00]
  HOMO = -0.242995034405807  LUMO = 1.07498153636334
  mo_energy =
[-1.20327025e+02 -1.23809119e+01 -6.67824498e+00 -6.67824498e+00
 -6.67824498e+00 -1.17938037e+00 -2.42995034e-01 -2.42995034e-01
 -2.42995034e-01  1.07498154e+00  1.09720388e+01  6.45798756e+01
  2.58883160e+02  8.87808110e+02  3.14161612e+03  1.26221925e+04
  4.12194402e+04  1.05247680e+05  2.30420834e+05  4.56228366e+05
  8.45174995e+05  1.52834681e+06  2.85060750e+06  5.80848619e+06]
E1 = -706.6766705913167  E_coul = 198.6872980168025
cycle= 6 E= -507.989372574514  delta_E= -2.27e-13  |g|= 2.14e-08  |ddm|= 1.91e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6766705913167  E_coul = 198.6872980168025
  HOMO = -0.242995045196118  LUMO = 1.07498153137682
  mo_energy =
[-1.20327025e+02 -1.23809120e+01 -6.67824500e+00 -6.67824500e+00
 -6.67824500e+00 -1.17938037e+00 -2.42995045e-01 -2.42995045e-01
 -2.42995045e-01  1.07498153e+00  1.09720388e+01  6.45798756e+01
  2.58883160e+02  8.87808110e+02  3.14161612e+03  1.26221925e+04
  4.12194402e+04  1.05247680e+05  2.30420834e+05  4.56228366e+05
  8.45174995e+05  1.52834681e+06  2.85060750e+06  5.80848619e+06]
E1 = -706.6766705394849  E_coul = 198.68729796497095
Extra cycle  E= -507.989372574514  delta_E= 2.27e-13  |g|= 2.24e-09  |ddm|= 4.15e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.29 sec
exp = [2.49389410e-01 6.49648754e-01 1.17616813e+05 3.03393339e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104175e+04 3.67547015e+04 7.30232133e+03 1.83757713e+04
 1.44351825e+03 4.17412037e+02 1.47795375e+02 5.84442439e+01
 2.45502684e+01 7.57669358e+00 8.60412108e+00 4.92699514e-01]
E = -507.98937257451394
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:18:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249389409702       1
[INPUT] 0    0    [1    /1   ]  0.649648754389       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.03393338549        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175477        1
[INPUT] 0    0    [1    /1   ]  36754.7015319        1
[INPUT] 0    0    [1    /1   ]  7302.32132565        1
[INPUT] 0    0    [1    /1   ]  18375.7713375        1
[INPUT] 0    0    [1    /1   ]  1443.51824681        1
[INPUT] 0    0    [1    /1   ]  417.41203693         1
[INPUT] 0    0    [1    /1   ]  147.795375401        1
[INPUT] 0    0    [1    /1   ]  58.4442439042        1
[INPUT] 0    0    [1    /1   ]  24.5502684094        1
[INPUT] 0    0    [1    /1   ]  7.57669357764        1
[INPUT] 1    0    [1    /1   ]  8.6041210752         1
[INPUT] 1    0    [1    /1   ]  0.492699514057       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.2493894097015015, 1.0]], [0, [0.6496487543888143, 1.0]], [0, [117616.81288921359, 1.0]], [0, [3.033933385486887, 1.0]], [0, [1176168.1426134529, 1.0]], [0, [588084.0699565538, 1.0]], [0, [294042.0309213897, 1.0]], [0, [147020.991323142, 1.0]], [0, [73510.41754766963, 1.0]], [0, [36754.70153192849, 1.0]], [0, [7302.321325654627, 1.0]], [0, [18375.771337502367, 1.0]], [0, [1443.51824681232, 1.0]], [0, [417.4120369300692, 1.0]], [0, [147.79537540097314, 1.0]], [0, [58.444243904223605, 1.0]], [0, [24.550268409385183, 1.0]], [0, [7.576693577641461, 1.0]], [1, [8.604121075199588, 1.0]], [1, [0.49269951405748186, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.24938941]
bas 1, expnt(s) = [0.64964875]
bas 2, expnt(s) = [117616.81288921]
bas 3, expnt(s) = [3.03393339]
bas 4, expnt(s) = [1176168.14261345]
bas 5, expnt(s) = [588084.06995655]
bas 6, expnt(s) = [294042.03092139]
bas 7, expnt(s) = [147020.99132314]
bas 8, expnt(s) = [73510.41754767]
bas 9, expnt(s) = [36754.70153193]
bas 10, expnt(s) = [7302.32132565]
bas 11, expnt(s) = [18375.7713375]
bas 12, expnt(s) = [1443.51824681]
bas 13, expnt(s) = [417.41203693]
bas 14, expnt(s) = [147.7953754]
bas 15, expnt(s) = [58.4442439]
bas 16, expnt(s) = [24.55026841]
bas 17, expnt(s) = [7.57669358]
bas 18, expnt(s) = [8.60412108]
bas 19, expnt(s) = [0.49269951]
CPU time:      1320.51
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49389410e-01 8.91607124e-01 6.49648754e-01 1.82820117e+00
 1.17616813e+05 1.60460108e+04 3.03393339e+00 5.80790568e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104175e+04 1.12791583e+04 3.67547015e+04 6.70655823e+03
 7.30232133e+03 1.99577110e+03 1.83757713e+04 3.98748633e+03
 1.44351825e+03 5.91672974e+02 4.17412037e+02 2.33312899e+02
 1.47795375e+02 1.07092895e+02 5.84442439e+01 5.34036982e+01
 2.45502684e+01 2.78648820e+01 7.57669358e+00 1.15378481e+01
 8.60412108e+00 4.29900088e+01 4.92699514e-01 1.20423726e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335950426212
cond(S) = 912122.9824645998
E1 = -689.5862127380301  E_coul = 184.96597998049157
init E= -504.620232757539
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672298233170167  LUMO = 0.692074628058016
  mo_energy =
[-1.21710360e+02 -1.33863764e+01 -7.62401335e+00 -7.62401335e+00
 -7.62401335e+00 -1.65741065e+00 -6.72298233e-01 -6.72298233e-01
 -6.72298233e-01  6.92074628e-01  1.01569349e+01  6.34012392e+01
  2.57541691e+02  8.86447459e+02  3.14033078e+03  1.26210244e+04
  4.12183434e+04  1.05246622e+05  2.30419801e+05  4.56227351e+05
  8.45173993e+05  1.52834582e+06  2.85060652e+06  5.80848521e+06]
E1 = -707.7383336772659  E_coul = 199.76672062409705
cycle= 1 E= -507.971613053169  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.42 sec, wall time      0.03 sec
diis-norm(errvec)=0.706592
diis-c [-0.49927268  1.        ]
  HOMO = -0.217855490694832  LUMO = 1.08195659432579
  mo_energy =
[-1.20201882e+02 -1.23056146e+01 -6.59530778e+00 -6.59530778e+00
 -6.59530778e+00 -1.16332453e+00 -2.17855491e-01 -2.17855491e-01
 -2.17855491e-01  1.08195659e+00  1.10245129e+01  6.46710393e+01
  2.58997792e+02  8.87939263e+02  3.14176210e+03  1.26223490e+04
  4.12196008e+04  1.05247843e+05  2.30420997e+05  4.56228530e+05
  8.45175159e+05  1.52834698e+06  2.85060767e+06  5.80848635e+06]
E1 = -706.7986353243247  E_coul = 198.8095231697041
cycle= 2 E= -507.989112154621  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0291887
diis-c [-8.47732440e-04  2.91092600e-03  9.97089074e-01]
  HOMO = -0.239664536183033  LUMO = 1.07612229108401
  mo_energy =
[-1.20314488e+02 -1.23718028e+01 -6.66862122e+00 -6.66862122e+00
 -6.66862122e+00 -1.17736260e+00 -2.39664536e-01 -2.39664536e-01
 -2.39664536e-01  1.07612229e+00  1.09788033e+01  6.45900653e+01
  2.58894998e+02  8.87820925e+02  3.14162971e+03  1.26222066e+04
  4.12194545e+04  1.05247695e+05  2.30420849e+05  4.56228380e+05
  8.45175009e+05  1.52834683e+06  2.85060752e+06  5.80848620e+06]
E1 = -706.6926881333233  E_coul = 198.70332048724512
cycle= 3 E= -507.989367646078  delta_E= -0.000255  |g|= 0.00444  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322766
diis-c [-2.05526289e-06 -9.87219115e-05 -1.10175467e-01  1.11027419e+00]
  HOMO = -0.24286079035791  LUMO = 1.07503422941195
  mo_energy =
[-1.20326691e+02 -1.23805870e+01 -6.67792322e+00 -6.67792322e+00
 -6.67792322e+00 -1.17930052e+00 -2.42860790e-01 -2.42860790e-01
 -2.42860790e-01  1.07503423e+00  1.09722998e+01  6.45801974e+01
  2.58883491e+02  8.87808444e+02  3.14161646e+03  1.26221928e+04
  4.12194405e+04  1.05247681e+05  2.30420835e+05  4.56228366e+05
  8.45174995e+05  1.52834681e+06  2.85060750e+06  5.80848619e+06]
E1 = -706.6773090244473  E_coul = 198.68793645905507
cycle= 4 E= -507.989372565392  delta_E= -4.92e-06  |g|= 0.000197  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0001358
diis-c [-1.25864619e-10 -6.86264746e-06  7.44095480e-03 -9.85756040e-02
  1.09114151e+00]
  HOMO = -0.242994504773847  LUMO = 1.07498156968887
  mo_energy =
[-1.20327023e+02 -1.23809106e+01 -6.67824357e+00 -6.67824357e+00
 -6.67824357e+00 -1.17937991e+00 -2.42994505e-01 -2.42994505e-01
 -2.42994505e-01  1.07498157e+00  1.09720398e+01  6.45798771e+01
  2.58883162e+02  8.87808112e+02  3.14161612e+03  1.26221925e+04
  4.12194402e+04  1.05247680e+05  2.30420834e+05  4.56228366e+05
  8.45174995e+05  1.52834681e+06  2.85060750e+06  5.80848619e+06]
E1 = -706.6766733885717  E_coul = 198.6873008140577
cycle= 5 E= -507.989372574514  delta_E= -9.12e-09  |g|= 8.57e-07  |ddm|= 0.00044
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.42317e-07
diis-c [-2.63582889e-14  1.78816983e-07 -1.17361984e-04  1.36862298e-03
 -1.61661137e-02  1.01491467e+00]
  HOMO = -0.242995034405807  LUMO = 1.07498153636334
  mo_energy =
[-1.20327025e+02 -1.23809119e+01 -6.67824498e+00 -6.67824498e+00
 -6.67824498e+00 -1.17938037e+00 -2.42995034e-01 -2.42995034e-01
 -2.42995034e-01  1.07498154e+00  1.09720388e+01  6.45798756e+01
  2.58883160e+02  8.87808110e+02  3.14161612e+03  1.26221925e+04
  4.12194402e+04  1.05247680e+05  2.30420834e+05  4.56228366e+05
  8.45174995e+05  1.52834681e+06  2.85060750e+06  5.80848619e+06]
E1 = -706.6766705913167  E_coul = 198.6872980168025
cycle= 6 E= -507.989372574514  delta_E= -2.27e-13  |g|= 2.14e-08  |ddm|= 1.91e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6766705913167  E_coul = 198.6872980168025
  HOMO = -0.242995045196118  LUMO = 1.07498153137682
  mo_energy =
[-1.20327025e+02 -1.23809120e+01 -6.67824500e+00 -6.67824500e+00
 -6.67824500e+00 -1.17938037e+00 -2.42995045e-01 -2.42995045e-01
 -2.42995045e-01  1.07498153e+00  1.09720388e+01  6.45798756e+01
  2.58883160e+02  8.87808110e+02  3.14161612e+03  1.26221925e+04
  4.12194402e+04  1.05247680e+05  2.30420834e+05  4.56228366e+05
  8.45174995e+05  1.52834681e+06  2.85060750e+06  5.80848619e+06]
E1 = -706.6766705394849  E_coul = 198.68729796497095
Extra cycle  E= -507.989372574514  delta_E= 2.27e-13  |g|= 2.24e-09  |ddm|= 4.15e-08
    CPU time for scf_cycle      1.10 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912122.9824645998
E1 = -706.6766705394849  E_coul = 198.68729796497095
init E= -507.989372574514
    CPU time for initialize scf      3.41 sec, wall time      0.22 sec
  HOMO = -0.242995046769748  LUMO = 1.07498152790723
  mo_energy =
[-1.20327025e+02 -1.23809120e+01 -6.67824501e+00 -6.67824501e+00
 -6.67824501e+00 -1.17938037e+00 -2.42995047e-01 -2.42995047e-01
 -2.42995047e-01  1.07498153e+00  1.09720388e+01  6.45798756e+01
  2.58883160e+02  8.87808110e+02  3.14161612e+03  1.26221925e+04
  4.12194402e+04  1.05247680e+05  2.30420834e+05  4.56228366e+05
  8.45174995e+05  1.52834681e+06  2.85060750e+06  5.80848619e+06]
E1 = -706.6766705349838  E_coul = 198.68729796046966
cycle= 1 E= -507.989372574514  delta_E= -2.27e-13  |g|= 1.86e-09  |ddm|= 3.23e-09
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.6766705349838  E_coul = 198.68729796046966
  HOMO = -0.242995046895669  LUMO = 1.07498153005538
  mo_energy =
[-1.20327025e+02 -1.23809120e+01 -6.67824501e+00 -6.67824501e+00
 -6.67824501e+00 -1.17938038e+00 -2.42995047e-01 -2.42995047e-01
 -2.42995047e-01  1.07498153e+00  1.09720388e+01  6.45798756e+01
  2.58883160e+02  8.87808110e+02  3.14161612e+03  1.26221925e+04
  4.12194402e+04  1.05247680e+05  2.30420834e+05  4.56228366e+05
  8.45174995e+05  1.52834681e+06  2.85060750e+06  5.80848619e+06]
E1 = -706.6766705356448  E_coul = 198.68729796113072
Extra cycle  E= -507.989372574514  delta_E= 1.14e-13  |g|= 2.72e-09  |ddm|= 9.23e-10
    CPU time for scf_cycle      3.86 sec, wall time      0.39 sec
exp = [2.49389410e-01 6.49648754e-01 1.17616813e+05 3.03393339e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104175e+04 3.67547015e+04 7.30232133e+03 1.83757713e+04
 1.44351825e+03 4.17412037e+02 1.47795375e+02 5.84442439e+01
 2.45502684e+01 7.57669358e+00 8.60412108e+00 4.92699514e-01]
grad_E = [-2.62708259e-06  8.09492136e-07  6.07186291e-09  2.68850957e-07
  4.05472539e-11  1.74469850e-10  9.41774540e-10  3.72109260e-09
  1.55389717e-08  8.10423626e-08  5.10804323e-06  1.98767588e-07
 -3.86884927e-05 -4.70682883e-06 -9.35447729e-07  7.68331611e-07
 -3.60777020e-07 -4.75613701e-07 -7.22380642e-06  1.90288068e-06]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:19:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249390996196       1
[INPUT] 0    0    [1    /1   ]  0.649653084235       1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.03395706301        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175485        1
[INPUT] 0    0    [1    /1   ]  36754.7015366        1
[INPUT] 0    0    [1    /1   ]  7302.32161299        1
[INPUT] 0    0    [1    /1   ]  18375.7713468        1
[INPUT] 0    0    [1    /1   ]  1443.52145424        1
[INPUT] 0    0    [1    /1   ]  417.389570388        1
[INPUT] 0    0    [1    /1   ]  147.789085713        1
[INPUT] 0    0    [1    /1   ]  58.4472153738        1
[INPUT] 0    0    [1    /1   ]  24.5531029096        1
[INPUT] 0    0    [1    /1   ]  7.57685690409        1
[INPUT] 1    0    [1    /1   ]  8.60411361256        1
[INPUT] 1    0    [1    /1   ]  0.492699357903       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24939099619640664, 1.0]], [0, [0.6496530842353239, 1.0]], [0, [117616.8128895513, 1.0]], [0, [3.033957063006911, 1.0]], [0, [1176168.142613454, 1.0]], [0, [588084.0699565625, 1.0]], [0, [294042.0309214423, 1.0]], [0, [147020.99132334755, 1.0]], [0, [73510.41754852135, 1.0]], [0, [36754.701536582594, 1.0]], [0, [7302.321612988535, 1.0]], [0, [18375.771346806276, 1.0]], [0, [1443.5214542360688, 1.0]], [0, [417.38957038760276, 1.0]], [0, [147.78908571282653, 1.0]], [0, [58.44721537376956, 1.0]], [0, [24.553102909585103, 1.0]], [0, [7.576856904086253, 1.0]], [1, [8.604113612560743, 1.0]], [1, [0.49269935790299096, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.249391]
bas 1, expnt(s) = [0.64965308]
bas 2, expnt(s) = [117616.81288955]
bas 3, expnt(s) = [3.03395706]
bas 4, expnt(s) = [1176168.14261345]
bas 5, expnt(s) = [588084.06995656]
bas 6, expnt(s) = [294042.03092144]
bas 7, expnt(s) = [147020.99132335]
bas 8, expnt(s) = [73510.41754852]
bas 9, expnt(s) = [36754.70153658]
bas 10, expnt(s) = [7302.32161299]
bas 11, expnt(s) = [18375.77134681]
bas 12, expnt(s) = [1443.52145424]
bas 13, expnt(s) = [417.38957039]
bas 14, expnt(s) = [147.78908571]
bas 15, expnt(s) = [58.44721537]
bas 16, expnt(s) = [24.55310291]
bas 17, expnt(s) = [7.5768569]
bas 18, expnt(s) = [8.60411361]
bas 19, expnt(s) = [0.49269936]
CPU time:      1332.76
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49390996e-01 8.91611378e-01 6.49653084e-01 1.82821031e+00
 1.17616813e+05 1.60460108e+04 3.03395706e+00 5.80793968e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104175e+04 1.12791583e+04 3.67547015e+04 6.70655823e+03
 7.30232161e+03 1.99577116e+03 1.83757713e+04 3.98748634e+03
 1.44352145e+03 5.91673960e+02 4.17389570e+02 2.33303481e+02
 1.47789086e+02 1.07089477e+02 5.84472154e+01 5.34057345e+01
 2.45531029e+01 2.78672948e+01 7.57685690e+00 1.15380346e+01
 8.60411361e+00 4.29899622e+01 4.92699358e-01 1.20423678e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335950641913385
cond(S) = 912122.407614174
E1 = -689.586184592819  E_coul = 184.96594229912094
init E= -504.620242293698
    CPU time for initialize scf      0.41 sec, wall time      0.06 sec
  HOMO = -0.672298325121028  LUMO = 0.69208452725478
  mo_energy =
[-1.21710368e+02 -1.33863793e+01 -7.62401596e+00 -7.62401596e+00
 -7.62401596e+00 -1.65741088e+00 -6.72298325e-01 -6.72298325e-01
 -6.72298325e-01  6.92084527e-01  1.01572577e+01  6.34063163e+01
  2.57553685e+02  8.86437271e+02  3.14027325e+03  1.26209525e+04
  4.12182741e+04  1.05246556e+05  2.30419737e+05  4.56227287e+05
  8.45173931e+05  1.52834576e+06  2.85060646e+06  5.80848516e+06]
E1 = -707.7382871997445  E_coul = 199.76667409641811
cycle= 1 E= -507.971613103326  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.706596
diis-c [-0.4992781  1.       ]
  HOMO = -0.217855849923891  LUMO = 1.08196849906343
  mo_energy =
[-1.20201890e+02 -1.23056181e+01 -6.59531111e+00 -6.59531111e+00
 -6.59531111e+00 -1.16332493e+00 -2.17855850e-01 -2.17855850e-01
 -2.17855850e-01  1.08196850e+00  1.10248477e+01  6.46761357e+01
  2.59009789e+02  8.87929076e+02  3.14170458e+03  1.26222771e+04
  4.12195316e+04  1.05247776e+05  2.30420933e+05  4.56228466e+05
  8.45175097e+05  1.52834691e+06  2.85060761e+06  5.80848629e+06]
E1 = -706.7985905749605  E_coul = 198.80947841124592
cycle= 2 E= -507.989112163715  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0291884
diis-c [-8.47713643e-04  2.91205036e-03  9.97087950e-01]
  HOMO = -0.239664817383  LUMO = 1.0761341131033
  mo_energy =
[-1.20314496e+02 -1.23718061e+01 -6.66862433e+00 -6.66862433e+00
 -6.66862433e+00 -1.17736295e+00 -2.39664817e-01 -2.39664817e-01
 -2.39664817e-01  1.07613411e+00  1.09791374e+01  6.45951601e+01
  2.58906995e+02  8.87810739e+02  3.14157219e+03  1.26221346e+04
  4.12193853e+04  1.05247628e+05  2.30420784e+05  4.56228317e+05
  8.45174947e+05  1.52834677e+06  2.85060746e+06  5.80848614e+06]
E1 = -706.6926438551578  E_coul = 198.70327620141933
cycle= 3 E= -507.989367653738  delta_E= -0.000255  |g|= 0.00444  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322765
diis-c [-2.05517808e-06 -9.87722396e-05 -1.10177078e-01  1.11027585e+00]
  HOMO = -0.242861084256466  LUMO = 1.07504603098495
  mo_energy =
[-1.20326699e+02 -1.23805904e+01 -6.67792639e+00 -6.67792639e+00
 -6.67792639e+00 -1.17930088e+00 -2.42861084e-01 -2.42861084e-01
 -2.42861084e-01  1.07504603e+00  1.09726338e+01  6.45852920e+01
  2.58895488e+02  8.87798257e+02  3.14155894e+03  1.26221209e+04
  4.12193713e+04  1.05247614e+05  2.30420770e+05  4.56228303e+05
  8.45174933e+05  1.52834675e+06  2.85060744e+06  5.80848613e+06]
E1 = -706.6772646978181  E_coul = 198.68789212474954
cycle= 4 E= -507.989372573069  delta_E= -4.92e-06  |g|= 0.000197  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135796
diis-c [-1.25884176e-10 -6.85544401e-06  7.44094785e-03 -9.85742494e-02
  1.09114016e+00]
  HOMO = -0.242994794468402  LUMO = 1.07499337410335
  mo_energy =
[-1.20327031e+02 -1.23809140e+01 -6.67824673e+00 -6.67824673e+00
 -6.67824673e+00 -1.17938026e+00 -2.42994794e-01 -2.42994794e-01
 -2.42994794e-01  1.07499337e+00  1.09723738e+01  6.45849717e+01
  2.58895158e+02  8.87797925e+02  3.14155860e+03  1.26221205e+04
  4.12193710e+04  1.05247614e+05  2.30420769e+05  4.56228303e+05
  8.45174933e+05  1.52834675e+06  2.85060744e+06  5.80848613e+06]
E1 = -706.6766290819083  E_coul = 198.68725649971947
cycle= 5 E= -507.989372582189  delta_E= -9.12e-09  |g|= 8.56e-07  |ddm|= 0.00044
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.42489e-07
diis-c [-2.61156664e-14  1.81840589e-07 -1.18044227e-04  1.37740930e-03
 -1.62576561e-02  1.01499811e+00]
  HOMO = -0.242995324004352  LUMO = 1.07499333906052
  mo_energy =
[-1.20327033e+02 -1.23809153e+01 -6.67824814e+00 -6.67824814e+00
 -6.67824814e+00 -1.17938072e+00 -2.42995324e-01 -2.42995324e-01
 -2.42995324e-01  1.07499334e+00  1.09723728e+01  6.45849702e+01
  2.58895156e+02  8.87797923e+02  3.14155860e+03  1.26221205e+04
  4.12193710e+04  1.05247614e+05  2.30420769e+05  4.56228303e+05
  8.45174933e+05  1.52834675e+06  2.85060744e+06  5.80848613e+06]
E1 = -706.6766262854786  E_coul = 198.68725370328917
cycle= 6 E= -507.989372582189  delta_E= -5.68e-13  |g|= 2.14e-08  |ddm|= 1.9e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6766262854786  E_coul = 198.68725370328917
  HOMO = -0.242995334835956  LUMO = 1.07499333117145
  mo_energy =
[-1.20327033e+02 -1.23809153e+01 -6.67824816e+00 -6.67824816e+00
 -6.67824816e+00 -1.17938073e+00 -2.42995335e-01 -2.42995335e-01
 -2.42995335e-01  1.07499333e+00  1.09723727e+01  6.45849702e+01
  2.58895156e+02  8.87797923e+02  3.14155860e+03  1.26221205e+04
  4.12193710e+04  1.05247614e+05  2.30420769e+05  4.56228303e+05
  8.45174933e+05  1.52834675e+06  2.85060744e+06  5.80848613e+06]
E1 = -706.6766262394193  E_coul = 198.6872536572299
Extra cycle  E= -507.989372582189  delta_E= 5.68e-14  |g|= 3.15e-09  |ddm|= 3.78e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.49390996e-01 6.49653084e-01 1.17616813e+05 3.03395706e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104175e+04 3.67547015e+04 7.30232161e+03 1.83757713e+04
 1.44352145e+03 4.17389570e+02 1.47789086e+02 5.84472154e+01
 2.45531029e+01 7.57685690e+00 8.60411361e+00 4.92699358e-01]
E = -507.9893725821894
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:19:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.249390996196       1
[INPUT] 0    0    [1    /1   ]  0.649653084235       1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.03395706301        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175485        1
[INPUT] 0    0    [1    /1   ]  36754.7015366        1
[INPUT] 0    0    [1    /1   ]  7302.32161299        1
[INPUT] 0    0    [1    /1   ]  18375.7713468        1
[INPUT] 0    0    [1    /1   ]  1443.52145424        1
[INPUT] 0    0    [1    /1   ]  417.389570388        1
[INPUT] 0    0    [1    /1   ]  147.789085713        1
[INPUT] 0    0    [1    /1   ]  58.4472153738        1
[INPUT] 0    0    [1    /1   ]  24.5531029096        1
[INPUT] 0    0    [1    /1   ]  7.57685690409        1
[INPUT] 1    0    [1    /1   ]  8.60411361256        1
[INPUT] 1    0    [1    /1   ]  0.492699357903       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.24939099619640664, 1.0]], [0, [0.6496530842353239, 1.0]], [0, [117616.8128895513, 1.0]], [0, [3.033957063006911, 1.0]], [0, [1176168.142613454, 1.0]], [0, [588084.0699565625, 1.0]], [0, [294042.0309214423, 1.0]], [0, [147020.99132334755, 1.0]], [0, [73510.41754852135, 1.0]], [0, [36754.701536582594, 1.0]], [0, [7302.321612988535, 1.0]], [0, [18375.771346806276, 1.0]], [0, [1443.5214542360688, 1.0]], [0, [417.38957038760276, 1.0]], [0, [147.78908571282653, 1.0]], [0, [58.44721537376956, 1.0]], [0, [24.553102909585103, 1.0]], [0, [7.576856904086253, 1.0]], [1, [8.604113612560743, 1.0]], [1, [0.49269935790299096, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.249391]
bas 1, expnt(s) = [0.64965308]
bas 2, expnt(s) = [117616.81288955]
bas 3, expnt(s) = [3.03395706]
bas 4, expnt(s) = [1176168.14261345]
bas 5, expnt(s) = [588084.06995656]
bas 6, expnt(s) = [294042.03092144]
bas 7, expnt(s) = [147020.99132335]
bas 8, expnt(s) = [73510.41754852]
bas 9, expnt(s) = [36754.70153658]
bas 10, expnt(s) = [7302.32161299]
bas 11, expnt(s) = [18375.77134681]
bas 12, expnt(s) = [1443.52145424]
bas 13, expnt(s) = [417.38957039]
bas 14, expnt(s) = [147.78908571]
bas 15, expnt(s) = [58.44721537]
bas 16, expnt(s) = [24.55310291]
bas 17, expnt(s) = [7.5768569]
bas 18, expnt(s) = [8.60411361]
bas 19, expnt(s) = [0.49269936]
CPU time:      1334.47
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49390996e-01 8.91611378e-01 6.49653084e-01 1.82821031e+00
 1.17616813e+05 1.60460108e+04 3.03395706e+00 5.80793968e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104175e+04 1.12791583e+04 3.67547015e+04 6.70655823e+03
 7.30232161e+03 1.99577116e+03 1.83757713e+04 3.98748634e+03
 1.44352145e+03 5.91673960e+02 4.17389570e+02 2.33303481e+02
 1.47789086e+02 1.07089477e+02 5.84472154e+01 5.34057345e+01
 2.45531029e+01 2.78672948e+01 7.57685690e+00 1.15380346e+01
 8.60411361e+00 4.29899622e+01 4.92699358e-01 1.20423678e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335950641913385
cond(S) = 912122.407614174
E1 = -689.586184592819  E_coul = 184.96594229912094
init E= -504.620242293698
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.672298325121028  LUMO = 0.69208452725478
  mo_energy =
[-1.21710368e+02 -1.33863793e+01 -7.62401596e+00 -7.62401596e+00
 -7.62401596e+00 -1.65741088e+00 -6.72298325e-01 -6.72298325e-01
 -6.72298325e-01  6.92084527e-01  1.01572577e+01  6.34063163e+01
  2.57553685e+02  8.86437271e+02  3.14027325e+03  1.26209525e+04
  4.12182741e+04  1.05246556e+05  2.30419737e+05  4.56227287e+05
  8.45173931e+05  1.52834576e+06  2.85060646e+06  5.80848516e+06]
E1 = -707.7382871997445  E_coul = 199.76667409641811
cycle= 1 E= -507.971613103326  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.706596
diis-c [-0.4992781  1.       ]
  HOMO = -0.217855849923891  LUMO = 1.08196849906343
  mo_energy =
[-1.20201890e+02 -1.23056181e+01 -6.59531111e+00 -6.59531111e+00
 -6.59531111e+00 -1.16332493e+00 -2.17855850e-01 -2.17855850e-01
 -2.17855850e-01  1.08196850e+00  1.10248477e+01  6.46761357e+01
  2.59009789e+02  8.87929076e+02  3.14170458e+03  1.26222771e+04
  4.12195316e+04  1.05247776e+05  2.30420933e+05  4.56228466e+05
  8.45175097e+05  1.52834691e+06  2.85060761e+06  5.80848629e+06]
E1 = -706.7985905749605  E_coul = 198.80947841124592
cycle= 2 E= -507.989112163715  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0291884
diis-c [-8.47713643e-04  2.91205036e-03  9.97087950e-01]
  HOMO = -0.239664817383  LUMO = 1.0761341131033
  mo_energy =
[-1.20314496e+02 -1.23718061e+01 -6.66862433e+00 -6.66862433e+00
 -6.66862433e+00 -1.17736295e+00 -2.39664817e-01 -2.39664817e-01
 -2.39664817e-01  1.07613411e+00  1.09791374e+01  6.45951601e+01
  2.58906995e+02  8.87810739e+02  3.14157219e+03  1.26221346e+04
  4.12193853e+04  1.05247628e+05  2.30420784e+05  4.56228317e+05
  8.45174947e+05  1.52834677e+06  2.85060746e+06  5.80848614e+06]
E1 = -706.6926438551578  E_coul = 198.70327620141933
cycle= 3 E= -507.989367653738  delta_E= -0.000255  |g|= 0.00444  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322765
diis-c [-2.05517808e-06 -9.87722396e-05 -1.10177078e-01  1.11027585e+00]
  HOMO = -0.242861084256466  LUMO = 1.07504603098495
  mo_energy =
[-1.20326699e+02 -1.23805904e+01 -6.67792639e+00 -6.67792639e+00
 -6.67792639e+00 -1.17930088e+00 -2.42861084e-01 -2.42861084e-01
 -2.42861084e-01  1.07504603e+00  1.09726338e+01  6.45852920e+01
  2.58895488e+02  8.87798257e+02  3.14155894e+03  1.26221209e+04
  4.12193713e+04  1.05247614e+05  2.30420770e+05  4.56228303e+05
  8.45174933e+05  1.52834675e+06  2.85060744e+06  5.80848613e+06]
E1 = -706.6772646978181  E_coul = 198.68789212474954
cycle= 4 E= -507.989372573069  delta_E= -4.92e-06  |g|= 0.000197  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135796
diis-c [-1.25884176e-10 -6.85544401e-06  7.44094785e-03 -9.85742494e-02
  1.09114016e+00]
  HOMO = -0.242994794468402  LUMO = 1.07499337410335
  mo_energy =
[-1.20327031e+02 -1.23809140e+01 -6.67824673e+00 -6.67824673e+00
 -6.67824673e+00 -1.17938026e+00 -2.42994794e-01 -2.42994794e-01
 -2.42994794e-01  1.07499337e+00  1.09723738e+01  6.45849717e+01
  2.58895158e+02  8.87797925e+02  3.14155860e+03  1.26221205e+04
  4.12193710e+04  1.05247614e+05  2.30420769e+05  4.56228303e+05
  8.45174933e+05  1.52834675e+06  2.85060744e+06  5.80848613e+06]
E1 = -706.6766290819083  E_coul = 198.68725649971947
cycle= 5 E= -507.989372582189  delta_E= -9.12e-09  |g|= 8.56e-07  |ddm|= 0.00044
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.42489e-07
diis-c [-2.61156664e-14  1.81840589e-07 -1.18044227e-04  1.37740930e-03
 -1.62576561e-02  1.01499811e+00]
  HOMO = -0.242995324004352  LUMO = 1.07499333906052
  mo_energy =
[-1.20327033e+02 -1.23809153e+01 -6.67824814e+00 -6.67824814e+00
 -6.67824814e+00 -1.17938072e+00 -2.42995324e-01 -2.42995324e-01
 -2.42995324e-01  1.07499334e+00  1.09723728e+01  6.45849702e+01
  2.58895156e+02  8.87797923e+02  3.14155860e+03  1.26221205e+04
  4.12193710e+04  1.05247614e+05  2.30420769e+05  4.56228303e+05
  8.45174933e+05  1.52834675e+06  2.85060744e+06  5.80848613e+06]
E1 = -706.6766262854786  E_coul = 198.68725370328917
cycle= 6 E= -507.989372582189  delta_E= -5.68e-13  |g|= 2.14e-08  |ddm|= 1.9e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6766262854786  E_coul = 198.68725370328917
  HOMO = -0.242995334835956  LUMO = 1.07499333117145
  mo_energy =
[-1.20327033e+02 -1.23809153e+01 -6.67824816e+00 -6.67824816e+00
 -6.67824816e+00 -1.17938073e+00 -2.42995335e-01 -2.42995335e-01
 -2.42995335e-01  1.07499333e+00  1.09723727e+01  6.45849702e+01
  2.58895156e+02  8.87797923e+02  3.14155860e+03  1.26221205e+04
  4.12193710e+04  1.05247614e+05  2.30420769e+05  4.56228303e+05
  8.45174933e+05  1.52834675e+06  2.85060744e+06  5.80848613e+06]
E1 = -706.6766262394193  E_coul = 198.6872536572299
Extra cycle  E= -507.989372582189  delta_E= 5.68e-14  |g|= 3.15e-09  |ddm|= 3.78e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912122.407614174
E1 = -706.6766262394193  E_coul = 198.6872536572299
init E= -507.989372582189
    CPU time for initialize scf      3.34 sec, wall time      0.21 sec
  HOMO = -0.242995336252807  LUMO = 1.07499333203956
  mo_energy =
[-1.20327033e+02 -1.23809153e+01 -6.67824816e+00 -6.67824816e+00
 -6.67824816e+00 -1.17938073e+00 -2.42995336e-01 -2.42995336e-01
 -2.42995336e-01  1.07499333e+00  1.09723727e+01  6.45849702e+01
  2.58895156e+02  8.87797923e+02  3.14155860e+03  1.26221205e+04
  4.12193710e+04  1.05247614e+05  2.30420769e+05  4.56228303e+05
  8.45174933e+05  1.52834675e+06  2.85060744e+06  5.80848613e+06]
E1 = -706.6766262305455  E_coul = 198.68725364835592
cycle= 1 E= -507.98937258219  delta_E= -1.71e-13  |g|= 1.24e-09  |ddm|= 6.1e-09
    CPU time for cycle= 1      0.31 sec, wall time      0.03 sec
E1 = -706.6766262305455  E_coul = 198.68725364835592
  HOMO = -0.242995336509852  LUMO = 1.07499333154961
  mo_energy =
[-1.20327033e+02 -1.23809153e+01 -6.67824817e+00 -6.67824817e+00
 -6.67824817e+00 -1.17938073e+00 -2.42995337e-01 -2.42995337e-01
 -2.42995337e-01  1.07499333e+00  1.09723727e+01  6.45849702e+01
  2.58895156e+02  8.87797923e+02  3.14155860e+03  1.26221205e+04
  4.12193710e+04  1.05247614e+05  2.30420769e+05  4.56228303e+05
  8.45174933e+05  1.52834675e+06  2.85060744e+06  5.80848613e+06]
E1 = -706.6766262290215  E_coul = 198.68725364683144
Extra cycle  E= -507.98937258219  delta_E= -5.12e-13  |g|= 1.18e-09  |ddm|= 1.05e-09
    CPU time for scf_cycle      3.79 sec, wall time      0.38 sec
exp = [2.49390996e-01 6.49653084e-01 1.17616813e+05 3.03395706e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104175e+04 3.67547015e+04 7.30232161e+03 1.83757713e+04
 1.44352145e+03 4.17389570e+02 1.47789086e+02 5.84472154e+01
 2.45531029e+01 7.57685690e+00 8.60411361e+00 4.92699358e-01]
grad_E = [-8.44885868e-07  7.76316163e-07  6.07053424e-09 -3.51880214e-06
  4.05323264e-11  1.74426273e-10  9.41570729e-10  3.72026964e-09
  1.55354907e-08  8.10255827e-08  5.10701269e-06  1.98712691e-07
 -3.86590602e-05 -4.78434370e-06 -1.10050224e-06  1.23787612e-06
 -4.76671785e-07  1.03512276e-06 -1.33890723e-05  3.50071883e-06]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:19:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.24939369593        1
[INPUT] 0    0    [1    /1   ]  0.649659304069       1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.03400796007        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991324        1
[INPUT] 0    0    [1    /1   ]  73510.4175494        1
[INPUT] 0    0    [1    /1   ]  36754.7015412        1
[INPUT] 0    0    [1    /1   ]  7302.32189697        1
[INPUT] 0    0    [1    /1   ]  18375.7713557        1
[INPUT] 0    0    [1    /1   ]  1443.52571784        1
[INPUT] 0    0    [1    /1   ]  417.361955852        1
[INPUT] 0    0    [1    /1   ]  147.783947829        1
[INPUT] 0    0    [1    /1   ]  58.4529757123        1
[INPUT] 0    0    [1    /1   ]  24.5576391034        1
[INPUT] 0    0    [1    /1   ]  7.57714951211        1
[INPUT] 1    0    [1    /1   ]  8.60410450036        1
[INPUT] 1    0    [1    /1   ]  0.492699165905       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.249393695930298, 1.0]], [0, [0.6496593040692155, 1.0]], [0, [117616.81288988463, 1.0]], [0, [3.0340079600687115, 1.0]], [0, [1176168.142613455, 1.0]], [0, [588084.069956571, 1.0]], [0, [294042.0309214943, 1.0]], [0, [147020.9913235502, 1.0]], [0, [73510.41754935968, 1.0]], [0, [36754.70154120463, 1.0]], [0, [7302.321896969562, 1.0]], [0, [18375.771355655528, 1.0]], [0, [1443.5257178422494, 1.0]], [0, [417.3619558520113, 1.0]], [0, [147.78394782889714, 1.0]], [0, [58.452975712341704, 1.0]], [0, [24.55763910335318, 1.0]], [0, [7.577149512108849, 1.0]], [1, [8.604104500355444, 1.0]], [1, [0.4926991659049108, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2493937]
bas 1, expnt(s) = [0.6496593]
bas 2, expnt(s) = [117616.81288988]
bas 3, expnt(s) = [3.03400796]
bas 4, expnt(s) = [1176168.14261345]
bas 5, expnt(s) = [588084.06995657]
bas 6, expnt(s) = [294042.03092149]
bas 7, expnt(s) = [147020.99132355]
bas 8, expnt(s) = [73510.41754936]
bas 9, expnt(s) = [36754.7015412]
bas 10, expnt(s) = [7302.32189697]
bas 11, expnt(s) = [18375.77135566]
bas 12, expnt(s) = [1443.52571784]
bas 13, expnt(s) = [417.36195585]
bas 14, expnt(s) = [147.78394783]
bas 15, expnt(s) = [58.45297571]
bas 16, expnt(s) = [24.5576391]
bas 17, expnt(s) = [7.57714951]
bas 18, expnt(s) = [8.6041045]
bas 19, expnt(s) = [0.49269917]
CPU time:      1346.55
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49393696e-01 8.91618617e-01 6.49659304e-01 1.82822343e+00
 1.17616813e+05 1.60460108e+04 3.03400796e+00 5.80801275e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104175e+04 1.12791583e+04 3.67547015e+04 6.70655823e+03
 7.30232190e+03 1.99577121e+03 1.83757714e+04 3.98748634e+03
 1.44352572e+03 5.91675271e+02 4.17361956e+02 2.33291904e+02
 1.47783948e+02 1.07086684e+02 5.84529757e+01 5.34096821e+01
 2.45576391e+01 2.78711561e+01 7.57714951e+00 1.15383688e+01
 8.60410450e+00 4.29899053e+01 4.92699166e-01 1.20423619e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33595089370288
cond(S) = 912121.9494191336
E1 = -689.5861529309491  E_coul = 184.96589618581422
init E= -504.620256745135
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.67229844374829  LUMO = 0.692100654198124
  mo_energy =
[-1.21710377e+02 -1.33863828e+01 -7.62401914e+00 -7.62401914e+00
 -7.62401914e+00 -1.65741116e+00 -6.72298444e-01 -6.72298444e-01
 -6.72298444e-01  6.92100654e-01  1.01578343e+01  6.34149838e+01
  2.57577867e+02  8.86442669e+02  3.14022417e+03  1.26208851e+04
  4.12182090e+04  1.05246493e+05  2.30419676e+05  4.56227228e+05
  8.45173872e+05  1.52834570e+06  2.85060641e+06  5.80848510e+06]
E1 = -707.7382298061201  E_coul = 199.7666166185876
cycle= 1 E= -507.971613187533  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.706602
diis-c [-0.49928589  1.        ]
  HOMO = -0.217856289143478  LUMO = 1.08198803629638
  mo_energy =
[-1.20201900e+02 -1.23056225e+01 -6.59531525e+00 -6.59531525e+00
 -6.59531525e+00 -1.16332540e+00 -2.17856289e-01 -2.17856289e-01
 -2.17856289e-01  1.08198804e+00  1.10254457e+01  6.46848366e+01
  2.59033976e+02  8.87934473e+02  3.14165549e+03  1.26222097e+04
  4.12194664e+04  1.05247713e+05  2.30420872e+05  4.56228407e+05
  8.45175038e+05  1.52834686e+06  2.85060755e+06  5.80848624e+06]
E1 = -706.7985360273088  E_coul = 198.80942384490132
cycle= 2 E= -507.989112182408  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.029188
diis-c [-8.47682753e-04  2.91379642e-03  9.97086204e-01]
  HOMO = -0.239665136900902  LUMO = 1.07615350254763
  mo_energy =
[-1.20314506e+02 -1.23718101e+01 -6.66862811e+00 -6.66862811e+00
 -6.66862811e+00 -1.17736335e+00 -2.39665137e-01 -2.39665137e-01
 -2.39665137e-01  1.07615350e+00  1.09797340e+01  6.46038584e+01
  2.58931182e+02  8.87816137e+02  3.14152310e+03  1.26220673e+04
  4.12193202e+04  1.05247565e+05  2.30420723e+05  4.56228257e+05
  8.45174888e+05  1.52834671e+06  2.85060740e+06  5.80848609e+06]
E1 = -706.6925900386215  E_coul = 198.70322236835165
cycle= 3 E= -507.98936767027  delta_E= -0.000255  |g|= 0.00444  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322765
diis-c [-2.05504199e-06 -9.88437226e-05 -1.10179717e-01  1.11027856e+00]
  HOMO = -0.242861423925551  LUMO = 1.0750653955286
  mo_energy =
[-1.20326709e+02 -1.23805945e+01 -6.67793026e+00 -6.67793026e+00
 -6.67793026e+00 -1.17930129e+00 -2.42861424e-01 -2.42861424e-01
 -2.42861424e-01  1.07506540e+00  1.09732302e+01  6.45939900e+01
  2.58919675e+02  8.87803656e+02  3.14150985e+03  1.26220535e+04
  4.12193062e+04  1.05247551e+05  2.30420709e+05  4.56228243e+05
  8.45174874e+05  1.52834669e+06  2.85060739e+06  5.80848607e+06]
E1 = -706.677210800287  E_coul = 198.68783821065904
cycle= 4 E= -507.989372589628  delta_E= -4.92e-06  |g|= 0.000197  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135789
diis-c [-1.25868263e-10 -6.86122669e-06  7.44123857e-03 -9.85732344e-02
  1.09113886e+00]
  HOMO = -0.242995127454722  LUMO = 1.0750127408756
  mo_energy =
[-1.20327041e+02 -1.23809180e+01 -6.67825059e+00 -6.67825059e+00
 -6.67825059e+00 -1.17938067e+00 -2.42995127e-01 -2.42995127e-01
 -2.42995127e-01  1.07501274e+00  1.09729702e+01  6.45936697e+01
  2.58919345e+02  8.87803324e+02  3.14150952e+03  1.26220532e+04
  4.12193059e+04  1.05247551e+05  2.30420709e+05  4.56228243e+05
  8.45174874e+05  1.52834669e+06  2.85060739e+06  5.80848607e+06]
E1 = -706.676575214641  E_coul = 198.68720261589337
cycle= 5 E= -507.989372598748  delta_E= -9.12e-09  |g|= 8.56e-07  |ddm|= 0.00044
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.41815e-07
diis-c [-2.59860992e-14  1.81922595e-07 -1.18717535e-04  1.38645964e-03
 -1.63532074e-02  1.01508528e+00]
  HOMO = -0.242995656942567  LUMO = 1.07501270468479
  mo_energy =
[-1.20327043e+02 -1.23809193e+01 -6.67825200e+00 -6.67825200e+00
 -6.67825200e+00 -1.17938113e+00 -2.42995657e-01 -2.42995657e-01
 -2.42995657e-01  1.07501270e+00  1.09729692e+01  6.45936682e+01
  2.58919344e+02  8.87803321e+02  3.14150951e+03  1.26220532e+04
  4.12193059e+04  1.05247551e+05  2.30420709e+05  4.56228243e+05
  8.45174874e+05  1.52834669e+06  2.85060739e+06  5.80848607e+06]
E1 = -706.6765724176915  E_coul = 198.6871998189438
cycle= 6 E= -507.989372598748  delta_E= -1.14e-13  |g|= 2.1e-08  |ddm|= 1.91e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6765724176915  E_coul = 198.6871998189438
  HOMO = -0.24299566785598  LUMO = 1.07501269708691
  mo_energy =
[-1.20327043e+02 -1.23809194e+01 -6.67825202e+00 -6.67825202e+00
 -6.67825202e+00 -1.17938113e+00 -2.42995668e-01 -2.42995668e-01
 -2.42995668e-01  1.07501270e+00  1.09729692e+01  6.45936682e+01
  2.58919344e+02  8.87803321e+02  3.14150951e+03  1.26220532e+04
  4.12193059e+04  1.05247551e+05  2.30420709e+05  4.56228243e+05
  8.45174874e+05  1.52834669e+06  2.85060739e+06  5.80848607e+06]
E1 = -706.676572369695  E_coul = 198.6871997709467
Extra cycle  E= -507.989372598748  delta_E= -5.68e-13  |g|= 2.37e-09  |ddm|= 3.9e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.49393696e-01 6.49659304e-01 1.17616813e+05 3.03400796e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104175e+04 3.67547015e+04 7.30232190e+03 1.83757714e+04
 1.44352572e+03 4.17361956e+02 1.47783948e+02 5.84529757e+01
 2.45576391e+01 7.57714951e+00 8.60410450e+00 4.92699166e-01]
E = -507.98937259874833
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:19:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.24939369593        1
[INPUT] 0    0    [1    /1   ]  0.649659304069       1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.03400796007        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991324        1
[INPUT] 0    0    [1    /1   ]  73510.4175494        1
[INPUT] 0    0    [1    /1   ]  36754.7015412        1
[INPUT] 0    0    [1    /1   ]  7302.32189697        1
[INPUT] 0    0    [1    /1   ]  18375.7713557        1
[INPUT] 0    0    [1    /1   ]  1443.52571784        1
[INPUT] 0    0    [1    /1   ]  417.361955852        1
[INPUT] 0    0    [1    /1   ]  147.783947829        1
[INPUT] 0    0    [1    /1   ]  58.4529757123        1
[INPUT] 0    0    [1    /1   ]  24.5576391034        1
[INPUT] 0    0    [1    /1   ]  7.57714951211        1
[INPUT] 1    0    [1    /1   ]  8.60410450036        1
[INPUT] 1    0    [1    /1   ]  0.492699165905       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.249393695930298, 1.0]], [0, [0.6496593040692155, 1.0]], [0, [117616.81288988463, 1.0]], [0, [3.0340079600687115, 1.0]], [0, [1176168.142613455, 1.0]], [0, [588084.069956571, 1.0]], [0, [294042.0309214943, 1.0]], [0, [147020.9913235502, 1.0]], [0, [73510.41754935968, 1.0]], [0, [36754.70154120463, 1.0]], [0, [7302.321896969562, 1.0]], [0, [18375.771355655528, 1.0]], [0, [1443.5257178422494, 1.0]], [0, [417.3619558520113, 1.0]], [0, [147.78394782889714, 1.0]], [0, [58.452975712341704, 1.0]], [0, [24.55763910335318, 1.0]], [0, [7.577149512108849, 1.0]], [1, [8.604104500355444, 1.0]], [1, [0.4926991659049108, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2493937]
bas 1, expnt(s) = [0.6496593]
bas 2, expnt(s) = [117616.81288988]
bas 3, expnt(s) = [3.03400796]
bas 4, expnt(s) = [1176168.14261345]
bas 5, expnt(s) = [588084.06995657]
bas 6, expnt(s) = [294042.03092149]
bas 7, expnt(s) = [147020.99132355]
bas 8, expnt(s) = [73510.41754936]
bas 9, expnt(s) = [36754.7015412]
bas 10, expnt(s) = [7302.32189697]
bas 11, expnt(s) = [18375.77135566]
bas 12, expnt(s) = [1443.52571784]
bas 13, expnt(s) = [417.36195585]
bas 14, expnt(s) = [147.78394783]
bas 15, expnt(s) = [58.45297571]
bas 16, expnt(s) = [24.5576391]
bas 17, expnt(s) = [7.57714951]
bas 18, expnt(s) = [8.6041045]
bas 19, expnt(s) = [0.49269917]
CPU time:      1348.26
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49393696e-01 8.91618617e-01 6.49659304e-01 1.82822343e+00
 1.17616813e+05 1.60460108e+04 3.03400796e+00 5.80801275e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104175e+04 1.12791583e+04 3.67547015e+04 6.70655823e+03
 7.30232190e+03 1.99577121e+03 1.83757714e+04 3.98748634e+03
 1.44352572e+03 5.91675271e+02 4.17361956e+02 2.33291904e+02
 1.47783948e+02 1.07086684e+02 5.84529757e+01 5.34096821e+01
 2.45576391e+01 2.78711561e+01 7.57714951e+00 1.15383688e+01
 8.60410450e+00 4.29899053e+01 4.92699166e-01 1.20423619e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33595089370288
cond(S) = 912121.9494191336
E1 = -689.5861529309491  E_coul = 184.96589618581422
init E= -504.620256745135
    CPU time for initialize scf      0.40 sec, wall time      0.06 sec
  HOMO = -0.67229844374829  LUMO = 0.692100654198124
  mo_energy =
[-1.21710377e+02 -1.33863828e+01 -7.62401914e+00 -7.62401914e+00
 -7.62401914e+00 -1.65741116e+00 -6.72298444e-01 -6.72298444e-01
 -6.72298444e-01  6.92100654e-01  1.01578343e+01  6.34149838e+01
  2.57577867e+02  8.86442669e+02  3.14022417e+03  1.26208851e+04
  4.12182090e+04  1.05246493e+05  2.30419676e+05  4.56227228e+05
  8.45173872e+05  1.52834570e+06  2.85060641e+06  5.80848510e+06]
E1 = -707.7382298061201  E_coul = 199.7666166185876
cycle= 1 E= -507.971613187533  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.706602
diis-c [-0.49928589  1.        ]
  HOMO = -0.217856289143478  LUMO = 1.08198803629638
  mo_energy =
[-1.20201900e+02 -1.23056225e+01 -6.59531525e+00 -6.59531525e+00
 -6.59531525e+00 -1.16332540e+00 -2.17856289e-01 -2.17856289e-01
 -2.17856289e-01  1.08198804e+00  1.10254457e+01  6.46848366e+01
  2.59033976e+02  8.87934473e+02  3.14165549e+03  1.26222097e+04
  4.12194664e+04  1.05247713e+05  2.30420872e+05  4.56228407e+05
  8.45175038e+05  1.52834686e+06  2.85060755e+06  5.80848624e+06]
E1 = -706.7985360273088  E_coul = 198.80942384490132
cycle= 2 E= -507.989112182408  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.029188
diis-c [-8.47682753e-04  2.91379642e-03  9.97086204e-01]
  HOMO = -0.239665136900902  LUMO = 1.07615350254763
  mo_energy =
[-1.20314506e+02 -1.23718101e+01 -6.66862811e+00 -6.66862811e+00
 -6.66862811e+00 -1.17736335e+00 -2.39665137e-01 -2.39665137e-01
 -2.39665137e-01  1.07615350e+00  1.09797340e+01  6.46038584e+01
  2.58931182e+02  8.87816137e+02  3.14152310e+03  1.26220673e+04
  4.12193202e+04  1.05247565e+05  2.30420723e+05  4.56228257e+05
  8.45174888e+05  1.52834671e+06  2.85060740e+06  5.80848609e+06]
E1 = -706.6925900386215  E_coul = 198.70322236835165
cycle= 3 E= -507.98936767027  delta_E= -0.000255  |g|= 0.00444  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322765
diis-c [-2.05504199e-06 -9.88437226e-05 -1.10179717e-01  1.11027856e+00]
  HOMO = -0.242861423925551  LUMO = 1.0750653955286
  mo_energy =
[-1.20326709e+02 -1.23805945e+01 -6.67793026e+00 -6.67793026e+00
 -6.67793026e+00 -1.17930129e+00 -2.42861424e-01 -2.42861424e-01
 -2.42861424e-01  1.07506540e+00  1.09732302e+01  6.45939900e+01
  2.58919675e+02  8.87803656e+02  3.14150985e+03  1.26220535e+04
  4.12193062e+04  1.05247551e+05  2.30420709e+05  4.56228243e+05
  8.45174874e+05  1.52834669e+06  2.85060739e+06  5.80848607e+06]
E1 = -706.677210800287  E_coul = 198.68783821065904
cycle= 4 E= -507.989372589628  delta_E= -4.92e-06  |g|= 0.000197  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135789
diis-c [-1.25868263e-10 -6.86122669e-06  7.44123857e-03 -9.85732344e-02
  1.09113886e+00]
  HOMO = -0.242995127454722  LUMO = 1.0750127408756
  mo_energy =
[-1.20327041e+02 -1.23809180e+01 -6.67825059e+00 -6.67825059e+00
 -6.67825059e+00 -1.17938067e+00 -2.42995127e-01 -2.42995127e-01
 -2.42995127e-01  1.07501274e+00  1.09729702e+01  6.45936697e+01
  2.58919345e+02  8.87803324e+02  3.14150952e+03  1.26220532e+04
  4.12193059e+04  1.05247551e+05  2.30420709e+05  4.56228243e+05
  8.45174874e+05  1.52834669e+06  2.85060739e+06  5.80848607e+06]
E1 = -706.676575214641  E_coul = 198.68720261589337
cycle= 5 E= -507.989372598748  delta_E= -9.12e-09  |g|= 8.56e-07  |ddm|= 0.00044
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.41815e-07
diis-c [-2.59860992e-14  1.81922595e-07 -1.18717535e-04  1.38645964e-03
 -1.63532074e-02  1.01508528e+00]
  HOMO = -0.242995656942567  LUMO = 1.07501270468479
  mo_energy =
[-1.20327043e+02 -1.23809193e+01 -6.67825200e+00 -6.67825200e+00
 -6.67825200e+00 -1.17938113e+00 -2.42995657e-01 -2.42995657e-01
 -2.42995657e-01  1.07501270e+00  1.09729692e+01  6.45936682e+01
  2.58919344e+02  8.87803321e+02  3.14150951e+03  1.26220532e+04
  4.12193059e+04  1.05247551e+05  2.30420709e+05  4.56228243e+05
  8.45174874e+05  1.52834669e+06  2.85060739e+06  5.80848607e+06]
E1 = -706.6765724176915  E_coul = 198.6871998189438
cycle= 6 E= -507.989372598748  delta_E= -1.14e-13  |g|= 2.1e-08  |ddm|= 1.91e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6765724176915  E_coul = 198.6871998189438
  HOMO = -0.24299566785598  LUMO = 1.07501269708691
  mo_energy =
[-1.20327043e+02 -1.23809194e+01 -6.67825202e+00 -6.67825202e+00
 -6.67825202e+00 -1.17938113e+00 -2.42995668e-01 -2.42995668e-01
 -2.42995668e-01  1.07501270e+00  1.09729692e+01  6.45936682e+01
  2.58919344e+02  8.87803321e+02  3.14150951e+03  1.26220532e+04
  4.12193059e+04  1.05247551e+05  2.30420709e+05  4.56228243e+05
  8.45174874e+05  1.52834669e+06  2.85060739e+06  5.80848607e+06]
E1 = -706.676572369695  E_coul = 198.6871997709467
Extra cycle  E= -507.989372598748  delta_E= -5.68e-13  |g|= 2.37e-09  |ddm|= 3.9e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912121.9494191336
E1 = -706.676572369695  E_coul = 198.6871997709467
init E= -507.989372598748
    CPU time for initialize scf      3.49 sec, wall time      0.22 sec
  HOMO = -0.242995669322311  LUMO = 1.07501269616876
  mo_energy =
[-1.20327043e+02 -1.23809194e+01 -6.67825202e+00 -6.67825202e+00
 -6.67825202e+00 -1.17938113e+00 -2.42995669e-01 -2.42995669e-01
 -2.42995669e-01  1.07501270e+00  1.09729692e+01  6.45936682e+01
  2.58919344e+02  8.87803321e+02  3.14150951e+03  1.26220532e+04
  4.12193059e+04  1.05247551e+05  2.30420709e+05  4.56228243e+05
  8.45174874e+05  1.52834669e+06  2.85060739e+06  5.80848607e+06]
E1 = -706.6765723655873  E_coul = 198.68719976683875
cycle= 1 E= -507.989372598749  delta_E= -2.27e-13  |g|= 1.82e-09  |ddm|= 3.16e-09
    CPU time for cycle= 1      0.28 sec, wall time      0.03 sec
E1 = -706.6765723655873  E_coul = 198.68719976683875
  HOMO = -0.242995669455556  LUMO = 1.07501269518764
  mo_energy =
[-1.20327043e+02 -1.23809194e+01 -6.67825202e+00 -6.67825202e+00
 -6.67825202e+00 -1.17938113e+00 -2.42995669e-01 -2.42995669e-01
 -2.42995669e-01  1.07501270e+00  1.09729692e+01  6.45936682e+01
  2.58919344e+02  8.87803321e+02  3.14150951e+03  1.26220532e+04
  4.12193059e+04  1.05247551e+05  2.30420709e+05  4.56228243e+05
  8.45174874e+05  1.52834669e+06  2.85060739e+06  5.80848607e+06]
E1 = -706.6765723640084  E_coul = 198.6871997652605
Extra cycle  E= -507.989372598748  delta_E= 6.82e-13  |g|= 1.11e-09  |ddm|= 1.05e-09
    CPU time for scf_cycle      3.92 sec, wall time      0.40 sec
exp = [2.49393696e-01 6.49659304e-01 1.17616813e+05 3.03400796e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104175e+04 3.67547015e+04 7.30232190e+03 1.83757714e+04
 1.44352572e+03 4.17361956e+02 1.47783948e+02 5.84529757e+01
 2.45576391e+01 7.57714951e+00 8.60410450e+00 4.92699166e-01]
grad_E = [ 2.25622744e-06  5.67688986e-07  6.06872461e-09 -9.08707314e-06
  4.05119947e-11  1.74366922e-10  9.41293140e-10  3.71914878e-09
  1.55307496e-08  8.10027256e-08  5.10560474e-06  1.98637923e-07
 -3.86175475e-05 -4.91191359e-06 -1.25077248e-06  1.79192658e-06
 -5.78816370e-07  3.30296088e-06 -2.09276954e-05  5.45980953e-06]
 message: Iteration limit reached
 success: False
  status: 9
     fun: -507.98937259874833
       x: [ 2.494e-01  6.497e-01 ...  8.604e+00  4.927e-01]
     nit: 100
     jac: [ 2.256e-06  5.677e-07 ... -2.093e-05  5.460e-06]
    nfev: 109
    njev: 100
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((20, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.6453537393791565e-01,1.1761681386811525e+05,6.7213618389299667e-01,1.1761681426172440e+06,5.8808406998251204e+05,2.9404203107373771e+05,1.4702099191980762e+05,7.3510420023613915e+04,3.6754714941487342e+04,7.3031550692213132e+03,1.8375799287245609e+04,1.4490839289042649e+03,3.7637972169371852e+02,1.1455716733776340e+02,3.8288733849518216e+01,8.4259976621495678e+00,3.3823911792214205e+00,8.6035310324053569e+00,4.9256484046045590e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "18s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:19:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35634263.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.24939369593        1
[INPUT] 0    0    [1    /1   ]  0.649659304069       1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.03400796007        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991324        1
[INPUT] 0    0    [1    /1   ]  73510.4175494        1
[INPUT] 0    0    [1    /1   ]  36754.7015412        1
[INPUT] 0    0    [1    /1   ]  7302.32189697        1
[INPUT] 0    0    [1    /1   ]  18375.7713557        1
[INPUT] 0    0    [1    /1   ]  1443.52571784        1
[INPUT] 0    0    [1    /1   ]  417.361955852        1
[INPUT] 0    0    [1    /1   ]  147.783947829        1
[INPUT] 0    0    [1    /1   ]  58.4529757123        1
[INPUT] 0    0    [1    /1   ]  24.5576391034        1
[INPUT] 0    0    [1    /1   ]  7.57714951211        1
[INPUT] 1    0    [1    /1   ]  8.60410450036        1
[INPUT] 1    0    [1    /1   ]  0.492699165905       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ar': [[0, [0.249393695930298, 1.0]], [0, [0.6496593040692155, 1.0]], [0, [117616.81288988463, 1.0]], [0, [3.0340079600687115, 1.0]], [0, [1176168.142613455, 1.0]], [0, [588084.069956571, 1.0]], [0, [294042.0309214943, 1.0]], [0, [147020.9913235502, 1.0]], [0, [73510.41754935968, 1.0]], [0, [36754.70154120463, 1.0]], [0, [7302.321896969562, 1.0]], [0, [18375.771355655528, 1.0]], [0, [1443.5257178422494, 1.0]], [0, [417.3619558520113, 1.0]], [0, [147.78394782889714, 1.0]], [0, [58.452975712341704, 1.0]], [0, [24.55763910335318, 1.0]], [0, [7.577149512108849, 1.0]], [1, [8.604104500355444, 1.0]], [1, [0.4926991659049108, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2493937]
bas 1, expnt(s) = [0.6496593]
bas 2, expnt(s) = [117616.81288988]
bas 3, expnt(s) = [3.03400796]
bas 4, expnt(s) = [1176168.14261345]
bas 5, expnt(s) = [588084.06995657]
bas 6, expnt(s) = [294042.03092149]
bas 7, expnt(s) = [147020.99132355]
bas 8, expnt(s) = [73510.41754936]
bas 9, expnt(s) = [36754.7015412]
bas 10, expnt(s) = [7302.32189697]
bas 11, expnt(s) = [18375.77135566]
bas 12, expnt(s) = [1443.52571784]
bas 13, expnt(s) = [417.36195585]
bas 14, expnt(s) = [147.78394783]
bas 15, expnt(s) = [58.45297571]
bas 16, expnt(s) = [24.5576391]
bas 17, expnt(s) = [7.57714951]
bas 18, expnt(s) = [8.6041045]
bas 19, expnt(s) = [0.49269917]
CPU time:      1360.44
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49393696e-01 8.91618617e-01 6.49659304e-01 1.82822343e+00
 1.17616813e+05 1.60460108e+04 3.03400796e+00 5.80801275e+00
 1.17616814e+06 9.02333504e+04 5.88084070e+05 5.36530711e+04
 2.94042031e+05 3.19023066e+04 1.47020991e+05 1.89692227e+04
 7.35104175e+04 1.12791583e+04 3.67547015e+04 6.70655823e+03
 7.30232190e+03 1.99577121e+03 1.83757714e+04 3.98748634e+03
 1.44352572e+03 5.91675271e+02 4.17361956e+02 2.33291904e+02
 1.47783948e+02 1.07086684e+02 5.84529757e+01 5.34096821e+01
 2.45576391e+01 2.78711561e+01 7.57714951e+00 1.15383688e+01
 8.60410450e+00 4.29899053e+01 4.92699166e-01 1.20423619e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33595089370288
cond(S) = 912121.9494191336
E1 = -689.5861529309491  E_coul = 184.96589618581422
init E= -504.620256745135
    CPU time for initialize scf      0.42 sec, wall time      0.06 sec
  HOMO = -0.67229844374829  LUMO = 0.692100654198124
  mo_energy =
[-1.21710377e+02 -1.33863828e+01 -7.62401914e+00 -7.62401914e+00
 -7.62401914e+00 -1.65741116e+00 -6.72298444e-01 -6.72298444e-01
 -6.72298444e-01  6.92100654e-01  1.01578343e+01  6.34149838e+01
  2.57577867e+02  8.86442669e+02  3.14022417e+03  1.26208851e+04
  4.12182090e+04  1.05246493e+05  2.30419676e+05  4.56227228e+05
  8.45173872e+05  1.52834570e+06  2.85060641e+06  5.80848510e+06]
E1 = -707.7382298061201  E_coul = 199.7666166185876
cycle= 1 E= -507.971613187533  delta_E= -3.35  |g|= 0.451  |ddm|= 0.51
    CPU time for cycle= 1      0.41 sec, wall time      0.03 sec
diis-norm(errvec)=0.706602
diis-c [-0.49928589  1.        ]
  HOMO = -0.217856289143478  LUMO = 1.08198803629638
  mo_energy =
[-1.20201900e+02 -1.23056225e+01 -6.59531525e+00 -6.59531525e+00
 -6.59531525e+00 -1.16332540e+00 -2.17856289e-01 -2.17856289e-01
 -2.17856289e-01  1.08198804e+00  1.10254457e+01  6.46848366e+01
  2.59033976e+02  8.87934473e+02  3.14165549e+03  1.26222097e+04
  4.12194664e+04  1.05247713e+05  2.30420872e+05  4.56228407e+05
  8.45175038e+05  1.52834686e+06  2.85060755e+06  5.80848624e+06]
E1 = -706.7985360273088  E_coul = 198.80942384490132
cycle= 2 E= -507.989112182408  delta_E= -0.0175  |g|= 0.0346  |ddm|= 0.436
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.029188
diis-c [-8.47682753e-04  2.91379642e-03  9.97086204e-01]
  HOMO = -0.239665136900902  LUMO = 1.07615350254763
  mo_energy =
[-1.20314506e+02 -1.23718101e+01 -6.66862811e+00 -6.66862811e+00
 -6.66862811e+00 -1.17736335e+00 -2.39665137e-01 -2.39665137e-01
 -2.39665137e-01  1.07615350e+00  1.09797340e+01  6.46038584e+01
  2.58931182e+02  8.87816137e+02  3.14152310e+03  1.26220673e+04
  4.12193202e+04  1.05247565e+05  2.30420723e+05  4.56228257e+05
  8.45174888e+05  1.52834671e+06  2.85060740e+06  5.80848609e+06]
E1 = -706.6925900386215  E_coul = 198.70322236835165
cycle= 3 E= -507.98936767027  delta_E= -0.000255  |g|= 0.00444  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00322765
diis-c [-2.05504199e-06 -9.88437226e-05 -1.10179717e-01  1.11027856e+00]
  HOMO = -0.242861423925551  LUMO = 1.0750653955286
  mo_energy =
[-1.20326709e+02 -1.23805945e+01 -6.67793026e+00 -6.67793026e+00
 -6.67793026e+00 -1.17930129e+00 -2.42861424e-01 -2.42861424e-01
 -2.42861424e-01  1.07506540e+00  1.09732302e+01  6.45939900e+01
  2.58919675e+02  8.87803656e+02  3.14150985e+03  1.26220535e+04
  4.12193062e+04  1.05247551e+05  2.30420709e+05  4.56228243e+05
  8.45174874e+05  1.52834669e+06  2.85060739e+06  5.80848607e+06]
E1 = -706.677210800287  E_coul = 198.68783821065904
cycle= 4 E= -507.989372589628  delta_E= -4.92e-06  |g|= 0.000197  |ddm|= 0.00953
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135789
diis-c [-1.25868263e-10 -6.86122669e-06  7.44123857e-03 -9.85732344e-02
  1.09113886e+00]
  HOMO = -0.242995127454722  LUMO = 1.0750127408756
  mo_energy =
[-1.20327041e+02 -1.23809180e+01 -6.67825059e+00 -6.67825059e+00
 -6.67825059e+00 -1.17938067e+00 -2.42995127e-01 -2.42995127e-01
 -2.42995127e-01  1.07501274e+00  1.09729702e+01  6.45936697e+01
  2.58919345e+02  8.87803324e+02  3.14150952e+03  1.26220532e+04
  4.12193059e+04  1.05247551e+05  2.30420709e+05  4.56228243e+05
  8.45174874e+05  1.52834669e+06  2.85060739e+06  5.80848607e+06]
E1 = -706.676575214641  E_coul = 198.68720261589337
cycle= 5 E= -507.989372598748  delta_E= -9.12e-09  |g|= 8.56e-07  |ddm|= 0.00044
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.41815e-07
diis-c [-2.59860992e-14  1.81922595e-07 -1.18717535e-04  1.38645964e-03
 -1.63532074e-02  1.01508528e+00]
  HOMO = -0.242995656942567  LUMO = 1.07501270468479
  mo_energy =
[-1.20327043e+02 -1.23809193e+01 -6.67825200e+00 -6.67825200e+00
 -6.67825200e+00 -1.17938113e+00 -2.42995657e-01 -2.42995657e-01
 -2.42995657e-01  1.07501270e+00  1.09729692e+01  6.45936682e+01
  2.58919344e+02  8.87803321e+02  3.14150951e+03  1.26220532e+04
  4.12193059e+04  1.05247551e+05  2.30420709e+05  4.56228243e+05
  8.45174874e+05  1.52834669e+06  2.85060739e+06  5.80848607e+06]
E1 = -706.6765724176915  E_coul = 198.6871998189438
cycle= 6 E= -507.989372598748  delta_E= -1.14e-13  |g|= 2.1e-08  |ddm|= 1.91e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6765724176915  E_coul = 198.6871998189438
  HOMO = -0.24299566785598  LUMO = 1.07501269708691
  mo_energy =
[-1.20327043e+02 -1.23809194e+01 -6.67825202e+00 -6.67825202e+00
 -6.67825202e+00 -1.17938113e+00 -2.42995668e-01 -2.42995668e-01
 -2.42995668e-01  1.07501270e+00  1.09729692e+01  6.45936682e+01
  2.58919344e+02  8.87803321e+02  3.14150951e+03  1.26220532e+04
  4.12193059e+04  1.05247551e+05  2.30420709e+05  4.56228243e+05
  8.45174874e+05  1.52834669e+06  2.85060739e+06  5.80848607e+06]
E1 = -706.676572369695  E_coul = 198.6871997709467
Extra cycle  E= -507.989372598748  delta_E= -5.68e-13  |g|= 2.37e-09  |ddm|= 3.9e-08
    CPU time for scf_cycle      1.09 sec, wall time      0.28 sec
exp = [2.49393696e-01 6.49659304e-01 1.17616813e+05 3.03400796e+00
 1.17616814e+06 5.88084070e+05 2.94042031e+05 1.47020991e+05
 7.35104175e+04 3.67547015e+04 7.30232190e+03 1.83757714e+04
 1.44352572e+03 4.17361956e+02 1.47783948e+02 5.84529757e+01
 2.45576391e+01 7.57714951e+00 8.60410450e+00 4.92699166e-01]
E = -507.98937259874833
E = -507.98937259874833
exp = [2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01]
